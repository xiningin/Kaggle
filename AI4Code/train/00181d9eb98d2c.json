{"cell_type":{"cc6e1157":"code","3ef648a4":"code","1f1aa782":"code","48778ea3":"code","2e25881f":"code","c7375d07":"code","22d0985f":"code","60667602":"code","2606cd67":"code","33bad610":"code","eef96899":"code","56110301":"code","55bc1fa3":"code","44f06d01":"code","5e1f6c65":"code","303d93b0":"code","46e49fad":"code","7e644272":"markdown","d77d8383":"markdown","864238e0":"markdown","c26041a6":"markdown","7426b7ad":"markdown","62b53058":"markdown","b7744e00":"markdown","56159531":"markdown","f42a889e":"markdown","2a6fc3fa":"markdown","16502be9":"markdown","fa7d3fe3":"markdown","0e174afa":"markdown","a9f78710":"markdown","8a4cf3f3":"markdown","f2cfae51":"markdown","1b2b4df9":"markdown","c49a2183":"markdown","123a20ec":"markdown","bace8369":"markdown","57f4a9a4":"markdown"},"source":{"cc6e1157":"# Data manipulation\nimport numpy as np\nimport pandas as pd\n\n# Visualization\nimport matplotlib.pyplot as plt\nimport seaborn as sns\n\n# SQL\nimport sqlite3","3ef648a4":"# Data \npath = \"..\/input\/2016-us-election\/\" \ndatabase = path + 'database.sqlite'\nconn = sqlite3.connect(database)","1f1aa782":"pd.read_sql(\"\"\"\n\nSELECT *\nFROM sqlite_master\nWHERE type='table';\n\n\"\"\", conn)","48778ea3":"pd.read_sql(\"\"\"\n\nSELECT * \nFROM primary_results\nLIMIT 5;\n\n\"\"\", conn)","2e25881f":"pd.read_sql(\"\"\"\n\nSELECT * \nFROM county_facts\nLIMIT 5;\n\n\"\"\", conn)","c7375d07":"dictionary = pd.read_sql(\"\"\"\n\nSELECT *\nFROM county_facts_dictionary;\n\n\"\"\", conn)","22d0985f":"pd.read_sql(\"\"\"\n\nSELECT DISTINCT candidate\nFROM primary_results\nWHERE party = 'Republican';\n\n\"\"\", conn)","60667602":"df_raw = pd.read_sql(\"\"\"\n\nSELECT p.fips,\n       p.county,\n       p.candidate,\n       p.votes,\n       p.fraction_votes,\n       c.*\nFROM (\n    SELECT *\n    FROM (\n        SELECT fips,\n               county,\n               party,\n               candidate, \n               votes, \n               fraction_votes,\n               row_number() \n                   OVER (PARTITION BY county \n                         ORDER BY fraction_votes desc) as rank\n        FROM primary_results\n        WHERE party = 'Republican') \n    WHERE rank = 1) p\nJOIN county_facts c\n    ON p.fips = c.fips;\n\n\"\"\", conn)\n\ndf_raw[0:5]","2606cd67":"print(df_raw['candidate'].value_counts())","33bad610":"# Create df with social variables only\ndf = df_raw.iloc[:, 8:] \n\n# Create binary target\ndf['target'] = df_raw['candidate']!='Donald Trump'\ndf['target'] = df['target'].astype(int)\n\n# Distribution of target\ncounts = df['target'].value_counts()\nprint(counts)\n\nproportion = round(counts[0] \/ (counts[0] + counts[1]), 2)\nprint('proportion: ', proportion, '\/', 1-proportion)\n","eef96899":"X = df.drop('target', axis=1)\ny = df.target","56110301":"# Classifier\nfrom sklearn import tree\n\n# Pre-processing\nfrom imblearn.pipeline import Pipeline\nfrom imblearn.over_sampling import SMOTE\n\n# Tune and cross validation\nfrom sklearn.model_selection import GridSearchCV\nfrom sklearn.model_selection import StratifiedKFold","55bc1fa3":"# Define tools\nclf = tree.DecisionTreeClassifier(random_state=0)\nsmote = SMOTE(random_state=1) \ncv=StratifiedKFold(n_splits=10)\n\n# Pipeline\npipeline = Pipeline([ \n                    ('smote', smote),\n                    ('model', clf)\n                   ])\n\n# Tune algorithm\nparam_grid = {\n              'model__max_depth': [3, 4, 5],\n              'model__min_samples_leaf': [0.04, 0.06, 0.08]\n             }\n\ngrid = GridSearchCV(pipeline, \n                    param_grid=param_grid, \n                    cv=cv, \n                    scoring=\"accuracy\", \n                    n_jobs= -1)\n\n# Fit\ngrid.fit(X, y)\nbest_estimator = grid.best_estimator_\n\n# Print details\nprint('best params: ', grid.best_params_)\nprint('best score: ', round(grid.best_score_, 3))","44f06d01":"# Add feature importances to dictionary\nscore = pd.Series(best_estimator.named_steps['model'].feature_importances_)\ncols = pd.Series(X.columns)\nfeature_importance = pd.concat([cols, \n                               dictionary.iloc[:,1], \n                               score], \n                               axis=1)\n\n# Drop low importance features\nthreshold = 0.01\nmask = score>threshold\nimportant_features = feature_importance[mask]\nimportant_features","5e1f6c65":"# Add a new column for feature names\nnames = pd.Series(['Under 18', 'Native American', 'Pacific Islander', 'Latino', 'Multi-units density', 'Land Area'])\nnames.index = important_features.index\nimportant_features = pd.concat([names, important_features], axis=1)\n\n# Rename columns\nimportant_features.columns = ['name', 'code', 'description', 'score']\nimportant_features","303d93b0":"ax = sns.barplot(x='name', y='score', data=important_features)\nplt.xticks(rotation=70)","46e49fad":"# Replace codes with new names\ncols.update(important_features['name'])\n\n# Plot\nfig = plt.figure(figsize=(20, 10))\ntree.plot_tree(best_estimator.named_steps['model'], \n               filled=True, \n               feature_names=cols, \n               class_names=['Trump', 'Other'],\n               rounded=True)","7e644272":"# Introduction\n\nMy goal in this notebook is to practice SQL and interpretable machine learning procedures. To do this I will use the 2016 US primary dataset. I will focus on the factors that led to Trump's victory or defeat in each county. ","d77d8383":"### Candidates\n\nWe can see that a total of 11 candidates ran in the Republican Party.","864238e0":"# Load and view data\n\n","c26041a6":"Indeed, the feature that divides the sample most clearly is the percentage of Latinos. A low presence of this group will tip the balance towards Trump. This result should not surprise anyone at this point given the enormous attention the candidate dedicated to this group. If there are few Latinos in the county, the number of housing units in multi-unit structures is low, and there are few people under 18, Trump's victory was assured in most cases. \n\nSomewhat less clear was the case of counties with a high percentage of Latinos. If there was a high percentage of native-born Pacific Islanders in these counties, the balance could still tip back toward Trump. This can be explained by the high presence of the military on these islands (a collective close to Trump) and by the moment of instability that Hawaii was going through ([article](https:\/\/www.civilbeat.org\/2016\/11\/who-voted-for-donald-trump-in-hawaii\/)).\n\nFinally, Trump had a particularly difficult time in those counties where, in addition to a high presence of Latinos and a low presence of Pacific Islanders, there was a high percentage of Native Americans. Trump has a long history of confrontation with this group, for whom his public statements since the 1990s have not gone unnoticed ([article](https:\/\/www.washingtonpost.com\/national\/donald-trumps-long-history-of-clashes-with-native-americans\/2016\/07\/25\/80ea91ca-3d77-11e6-80bc-d06711fd2125_story.html)).\n\nAnd so far this little rehearsal.\n\nSee you around!","7426b7ad":"We can see it clearer with a graph:","62b53058":"The sample is unbalanced in a proportion of 75\/25, so measures must be taken.","b7744e00":"However, what I am interested in is understanding the vote for Trump, so I am not going to take into account the specificities of the vote for the other candidates. I am going to keep only one binary variable where 0 represents the vote for Trump and 1 the vote for any other candidate.","56159531":"### Libraries","f42a889e":"The `county_facts_dictionary` is an information table about the codes used to name the columns of the `county_facts` table. It should be saved for future use.","2a6fc3fa":"The accuracy achieved shows that the model cannot predict the data much better than it would by classifying everything in the majority class. Rarely is a single tree sufficient to make a good prediction. However, we can extract other information from it.\n\n\n### Feature importance\n\nTo understand the importance of the features, we have to call the `feature_importances` method. However, the trained model is inside a pipeline, so first we have to access it through the `named_steps` method. Once we have the scores, we can join them with their respective identification codes and their descriptions, which we saved in `dictionary`. ","16502be9":"### Tree plot\n\n","fa7d3fe3":"In the `county_facts` table we have 54 columns of social data associated with each county:","0e174afa":"### Database connection","a9f78710":"The percentage of the Latino population living in the county is the feature with the greatest discriminating power in the model. It is followed by the American Native and the Pacific Islander vote. However, to understand the meaning of these relationships we have to look at the tree on the inside.","8a4cf3f3":"## Decision Tree\n\nAlthough decision tree is an extremely versatile technique, handling unbalanced samples [is not among its capabilities](https:\/\/stats.stackexchange.com\/questions\/450634\/why-decision-tree-handle-unbalanced-data-well). Therefore, I will use the [smote](https:\/\/arxiv.org\/pdf\/1106.1813.pdf) algorithm to balance the data. On the other hand, I will use `GridSearchCV` to adjust the parameters of the algorithm and I will train it through a system of cross validation in stratified subsamples created by `StratifiedKFold`.","f2cfae51":"In the `primary_results` table we have the election results for each candidate in each county (number of votes and percentages). Note that the latter are the percentages in relation to the total votes obtained by each party:","1b2b4df9":"### X and y\n\nSeparate features and target:","c49a2183":"### Join winners with county facts\n\nWith the following query, the first thing I do is select the Republican candidates (`WHERE party = 'Republican'`) in the election results table. Then I sort the candidates by order of votes (`ORDER BY fraction_vote desc`) in each county (`PARTITION BY county`) and save the positions in a new column called `rank`. Then I only have to select the rows in which the \"rank\" is equal to 1 to keep the winners of each county. As I have only one row per county, we can now join this information to the one we have in the table `county_facts` and obtain the dataset we are going to work on. ","123a20ec":"Only 5 out of 11 candidates won at least one county:","bace8369":"# Modelling\n\n### Libraries","57f4a9a4":"### Understanding the database\n\nThe first step will be to view the tables we have in the database."}}