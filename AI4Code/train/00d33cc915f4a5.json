{"cell_type":{"5c440b7d":"code","7e9fc3be":"code","a7b58394":"code","971f9a38":"code","c1ca23de":"code","a4d28996":"code","26bd3ab5":"code","ff7c52c3":"code","75fbf217":"code","3a7d5cb2":"code","40a176e5":"code","b4dd5de4":"code","6cfb8515":"code","99cdeb39":"code","397896cb":"code","c83e4c23":"code","187e23ac":"code","95702738":"code","d939f96f":"code","fc672667":"code","40817279":"code","d346cbd5":"code","9e325559":"code","49c4d9e0":"code","0fdc9bf1":"code","a2e6df75":"code","3b5d9f87":"code","30481b5a":"code","44111644":"code","f36c3e63":"code","87d04547":"code","16c3de29":"code","50c49bef":"code","7076e8a5":"code","7085f970":"code","1f2ffab9":"code","c94563e2":"code","b0eb17dc":"code","84187288":"code","1bd5c370":"code","079998a3":"code","94ef2297":"code","ecad7dc1":"code","dc691bed":"code","f972a305":"code","58436f69":"code","7d470c96":"code","11be150b":"code","f01133ad":"code","7dafc3b7":"code","00195a09":"code","85f4f48a":"code","adbe7504":"code","f18921b8":"code","aa986a10":"code","425b618e":"code","69564c71":"code","2c3ab5bd":"markdown","322b4536":"markdown","a5e3adc3":"markdown","fba44d31":"markdown","476233ce":"markdown","9275684d":"markdown","eb1d1a87":"markdown","4d254b24":"markdown","feed5bd2":"markdown","d0a5c73c":"markdown","b4241a42":"markdown","21f14de8":"markdown","385cc183":"markdown","83bd3613":"markdown","7be68a5a":"markdown","45c46999":"markdown","4109771e":"markdown","8b85fb41":"markdown","3d4d9472":"markdown","5fabf24f":"markdown","bf7db2f5":"markdown","075f38b5":"markdown","deae579d":"markdown","42d0ea9c":"markdown","11e4ca22":"markdown","313a1df9":"markdown","2aaf7c94":"markdown","db838b57":"markdown"},"source":{"5c440b7d":"from scipy import ndimage\nfrom scipy import stats\nimport matplotlib.pyplot as plt\nimport matplotlib.image as mpimg\n%matplotlib inline\nfrom skimage import io\nimport seaborn as sns\nimport numpy as np\nimport pandas as pd\nimport cv2","7e9fc3be":"Labels = pd.read_csv('..\/input\/train_v2.csv')","a7b58394":"Labels.head()","971f9a38":"Labels.tail()","c1ca23de":"tagnames = list(set(\n    [tag for sublist in Labels['tags'].apply(\n        lambda tagstring: tagstring.split()) for tag in sublist]))\nprint('Tags: ' + '%s' % ', '.join(tagnames))","a4d28996":"# Useful function for encoding.\ndef containsTag(tag, taglist):\n    if tag in taglist.split():\n        return 1\n    else:\n        return 0","26bd3ab5":"for tag in tagnames:\n    Labels[tag] = Labels['tags'].apply(\n        lambda taglist: containsTag(tag, taglist))","ff7c52c3":"Labels.head()","75fbf217":"Labels.tail()","3a7d5cb2":"def load_image(ImageName):\n    \"\"\"Convert an image given by filename to a numpy array.\n\n    Note, image sizes are expected to be 256 pixels by 256 pixels\n    \"\"\"\n    try:\n        image_data = io.imread(ImageName).astype(float)\n        if image_data.shape != (256, 256, 4):\n            raise Exception('Unexpected image shape: %s' %\n                            str(image_data.shape))\n    except IOError as e:\n        print('Could not read:', image, ':', e, '.')\n    return image_data","40a176e5":"Labels['jpgFilename'] = Labels['image_name'].apply(\n    lambda name: '..\/input\/train-jpg\/' + name + '.jpg')\nLabels['tifFilename'] = Labels['image_name'].apply(\n    lambda name: '..\/input\/train-tif-v2\/' + name + '.tif')","b4dd5de4":"# Check to see if there is any duplicate or missing atmospheric conditions.\nLabels[Labels[['clear', 'haze', 'partly_cloudy', 'cloudy']].sum(axis=1) != 1]","6cfb8515":"imageplot = plt.figure(figsize=(6, 6))\naxis = imageplot.add_axes([0, 0, .9, .9])\n_image = cv2.imread('..\/input\/train-jpg\/train_24448.jpg')\naxis.imshow(cv2.cvtColor(_image, cv2.COLOR_BGR2RGB))\nimageplot.suptitle('Image Number: 24448.')","99cdeb39":"# A comparison water image with haze to see if there is haze.\nimageplot = plt.figure(figsize=(6, 6))\naxis = imageplot.add_axes([0, 0, .9, .9])\n_image = cv2.imread('..\/input\/train-jpg\/train_3561.jpg')\naxis.imshow(cv2.cvtColor(_image, cv2.COLOR_BGR2RGB))\nimageplot.suptitle('Image Number: 3561 - water under haze conditions.')","397896cb":"# A comparison water image without haze.\nimageplot = plt.figure(figsize=(6, 6))\naxis = imageplot.add_axes([0, 0, .9, .9])\n_image = cv2.imread('..\/input\/train-jpg\/train_2750.jpg')\naxis.imshow(cv2.cvtColor(_image, cv2.COLOR_BGR2RGB))\nimageplot.suptitle('Image Number: 2750 - water under clear conditions.')","c83e4c23":"Labels.loc[24448, 'clear'] = 1\nLabels.loc[24448, 'tags'] = 'clear water'","187e23ac":"# I will use an isin trick to not have to list all of the encoded tags.\nLabels[(Labels[Labels.columns[\n    Labels.columns.isin(tagnames)]].sum(axis=1) > 1) & (Labels['cloudy'] == 1)]","95702738":"Labels[(Labels[Labels.columns[\n    Labels.columns.isin(tagnames)]].sum(axis=1) == 1) & (Labels['cloudy'] == 0)]","d939f96f":"imageplot = plt.figure(figsize=(6, 6))\naxis = imageplot.add_axes([0, 0, .9, .9])\n_image = cv2.imread('..\/input\/train-jpg\/train_21276.jpg')\naxis.imshow(cv2.cvtColor(_image, cv2.COLOR_BGR2RGB))\nimageplot.suptitle('Image Number: 21276.')","fc672667":"Labels.loc[21276, 'primary'] = 1\nLabels.loc[21276, 'tags'] = 'partly_cloudy primary'","40817279":"ConditionCounts = Labels[['clear', 'haze', 'partly_cloudy', 'cloudy']].sum().sort_values(\n    ascending=False)\nConditionCounts = ConditionCounts.reset_index(name='Count')\nfig = sns.barplot(x='index', y='Count', data=ConditionCounts)\nfig.set(xlabel='Condition Type', ylabel='Count', title='Images by Condition')","d346cbd5":"typeTags = ['artisinal_mine', 'blow_down', 'water', 'cultivation', 'road', 'agriculture',\n            'bare_ground', 'blooming', 'selective_logging', 'habitation', 'conventional_mine',\n            'slash_burn', 'primary']","9e325559":"TypeCounts = Labels[Labels.columns[Labels.columns.isin(typeTags)]].sum().sort_values(\n    ascending=False)\nTypeCounts = TypeCounts.reset_index(name='Count')\nfig = plt.figure(figsize=(12, 4))\nfig = sns.barplot(x='index', y='Count', data=TypeCounts)\nfig.set(xlabel='Type', ylabel='Count', title='Images by Type')\n# Rotate the tick-labels\nfor ticklabel in fig.get_xticklabels():\n    ticklabel.set_rotation(45)","49c4d9e0":"# Focusing on the rare types:\nRareTypeCounts = Labels[['artisinal_mine', 'blow_down', 'bare_ground', 'blooming',\n                         'selective_logging', 'conventional_mine',\n                         'slash_burn']].sum().sort_values(ascending=False)\nRareTypeCounts = RareTypeCounts.reset_index(name='Count')\nfig = plt.figure(figsize=(8, 4))\nfig = sns.barplot(x='index', y='Count', data=RareTypeCounts)\nfig.set(xlabel='Type', ylabel='Count', title='Images by Less Common Types')\n# Rotate the tick-labels\nfor ticklabel in fig.get_xticklabels():\n    ticklabel.set_rotation(45)","0fdc9bf1":"for condition in ['clear', 'haze', 'partly_cloudy']:\n    _ConditionalTypeCounts = Labels[Labels.columns[\n        Labels.columns.isin(typeTags)]][Labels[condition] == 1].sum().sort_values(\n        ascending=False)\n    _ConditionalTypeCounts = _ConditionalTypeCounts.reset_index(name='Count')\n    fig = plt.figure(figsize=(12, 4))\n    fig = sns.barplot(x='index', y='Count', data=_ConditionalTypeCounts)\n    fig.set(xlabel='Type', ylabel='Count',\n            title='Images by Type for Condition %s' % condition)\n    # Rotate the tick-labels\n    for ticklabel in fig.get_xticklabels():\n        ticklabel.set_rotation(45)","a2e6df75":"def plot_image(tifImage, jpgImage, tag, imgNum):\n    imageplot = plt.figure(figsize=(10, 6))\n    # Plot Red Band\n    axis1 = imageplot.add_axes([0, .5, .2, .4])\n    axis1.imshow(tifImage[:, :, 2], cmap='Reds')\n    axis1.set_title('Red')\n    # Plot Green Band\n    axis2 = imageplot.add_axes([.25, .5, .2, .4])\n    axis2.imshow(tifImage[:, :, 1], cmap='Greens')\n    axis2.set_title('Green')\n    # Plot Blue Band\n    axis3 = imageplot.add_axes([.5, .5, .2, .4])\n    axis3.imshow(tifImage[:, :, 0], cmap='Blues')\n    axis3.set_title('Blue')\n    # Plot NIR Band\n    axis4 = imageplot.add_axes([.75, .5, .2, .4])\n    axis4.imshow(tifImage[:, :, 3], cmap='magma')\n    axis4.set_title('NIR')\n    # Plot image\n    axis5 = imageplot.add_axes([0, 0, .2, .4])\n    axis5.imshow(cv2.cvtColor(jpgImage, cv2.COLOR_BGR2RGB))\n    axis5.set_title('JPG Image')\n    # Plot color histogram\n    axis6 = imageplot.add_axes([.3, .05, .5, .3])\n    axis6.hist([tifImage[:, :, 2], tifImage[:, :, 1], tifImage[:, :, 0], tifImage[:, :, 3]],\n               bins=100, label=['r', 'g', 'b', 'nir'],\n               color=['red', 'green', 'blue', 'magenta'], histtype='step')\n    axis6.legend()\n    axis6.set_title('Color Histogram')\n    imageplot.suptitle('Image Number: %s. Tags: %s.' % (imgNum, tag))","3b5d9f87":"image_sample = Labels.sample(6)\nfor img in image_sample.index:\n    tag = image_sample.loc[img]['tags']\n    tifImage = load_image(image_sample.loc[img]['tifFilename'])\n    jpgImage = cv2.imread(image_sample.loc[img]['jpgFilename'])\n    plot_image(tifImage, jpgImage, tag, img)","30481b5a":"def get_band_information(image):\n    \"\"\"Given a single color band of an image, returns the following tuple:\n    (band_mean, band_median, band_std, band_max, band_min, band_kurtosis, band_skewness)\n    \"\"\"\n    band = image[:, :].ravel()\n    return (np.mean(band), np.median(band), np.std(band), np.max(band), np.min(band),\n            stats.kurtosis(band), stats.skew(band))","44111644":"# We will use ColorStats as an array to hold our color information and later join it to the data frame.\nn, _ = Labels.shape\nColorStats = np.zeros((n, 28))\nfor ind in Labels.index:\n    imageName = Labels['tifFilename'].loc[ind]\n    current_image = load_image(imageName)\n    r_stats = get_band_information(current_image[:, :, 2])\n    g_stats = get_band_information(current_image[:, :, 1])\n    b_stats = get_band_information(current_image[:, :, 0])\n    n_stats = get_band_information(current_image[:, :, 3])\n    ColorStats[ind, :7] = list(r_stats)  # columns 0-6 are for red\n    ColorStats[ind, 7:14] = list(g_stats)  # columns 7-13 are for green\n    ColorStats[ind, 14:21] = list(b_stats)  # columns 14-20 are for blue\n    ColorStats[ind, 21:] = list(n_stats)  # columns 21-27 are for near-ir\n    if ind % 5000 == 0:\n        print('Processed %s images.' % ind)","f36c3e63":"names = []\nfor color in ['r', 'g', 'b', 'n']:\n    for stat in ['mean', 'median', 'std', 'max', 'min', 'kurtosis', 'skewness']:\n        names.append(color + '_' + stat)","87d04547":"ColorStatsDF = pd.DataFrame(ColorStats, columns=names)","16c3de29":"ColorStatsDF.head()","50c49bef":"Labels = pd.concat([Labels, ColorStatsDF], axis=1)","7076e8a5":"Labels.head()","7085f970":"sns.distplot(Labels[Labels['cloudy'] == 1]['b_std'], kde=False)","1f2ffab9":"sns.boxplot(Labels[Labels['cloudy']==1]['b_std'])","c94563e2":"Labels[(Labels['cloudy'] == 1) & (Labels['b_std'] > 8000)]","b0eb17dc":"plot_image(\n    io.imread(Labels['tifFilename'].loc[352]), \n    cv2.imread(Labels['jpgFilename'].loc[352]), \n    Labels['tags'].loc[352], 352)","84187288":"cv2imageplot = plt.figure(figsize=(6, 6))\naxis = imageplot.add_axes([0, 0, .9, .9])\n_image = cv2.imread('..\/input\/train-jpg\/train_352.jpg')\naxis.imshow(cv2.cvtColor(_image, cv2.COLOR_BGR2RGB))\nimageplot.suptitle('Image Number: 352.')","1bd5c370":"plot_image(io.imread(Labels['tifFilename'].loc[22748]), \n           cv2.imread(Labels['jpgFilename'].loc[22748]), \n           Labels['tags'].loc[22748], 22748)","079998a3":"imageplot = plt.figure(figsize=(6, 6))\naxis = imageplot.add_axes([0, 0, .9, .9])\n_image = cv2.imread('..\/input\/train-jpg\/train_22748.jpg')\naxis.imshow(cv2.cvtColor(_image, cv2.COLOR_BGR2RGB))\nimageplot.suptitle('Image Number: 22748.')","94ef2297":"plot_image(io.imread(Labels['tifFilename'].loc[2550]), \n           cv2.imread(Labels['jpgFilename'].loc[2550]), \n           Labels['tags'].loc[2550], 2550)","ecad7dc1":"imageplot = plt.figure(figsize=(6, 6))\naxis = imageplot.add_axes([0, 0, .9, .9])\n_image = cv2.imread('..\/input\/train-jpg\/train_2550.jpg')\naxis.imshow(cv2.cvtColor(_image, cv2.COLOR_BGR2RGB))\nimageplot.suptitle('Image Number: 2550.')","dc691bed":"# Fix the miss labelling\nLabels.loc[2550, 'cloudy'] = 0\nLabels.loc[2550, 'partly_cloudy'] = 1\nLabels.loc[2550, 'primary'] = 1\nLabels.loc[2550, 'tags'] = 'partly_cloudy primary'","f972a305":"sns.distplot(Labels[Labels['partly_cloudy'] == 1]['n_min'], kde=False)","58436f69":"sns.boxplot(Labels[Labels['partly_cloudy'] == 1]['n_min'])","7d470c96":"Labels[(Labels['partly_cloudy'] == 1) & (Labels['n_min'] > 14000)]","11be150b":"plot_image(io.imread(Labels['tifFilename'].loc[35252]), \n           cv2.imread(Labels['jpgFilename'].loc[35252]), \n           Labels['tags'].loc[35252], 35252)","f01133ad":"imageplot = plt.figure(figsize=(6, 6))\naxis = imageplot.add_axes([0, 0, .9, .9])\n_image = cv2.imread('..\/input\/train-jpg\/train_35252.jpg')\naxis.imshow(_image[:, :, 0], cmap = 'Reds')\nimageplot.suptitle('Image Number: 35252.')","7dafc3b7":"# Make sure this is not an issue in the data frame\nLabels[['tifFilename', 'jpgFilename']].loc[35252]","00195a09":"# Create a list of statistics that we can log transform. We will not log transform skew or kurtosis.\nlognames = []\nfor color in ['r', 'g', 'b', 'n']:\n    for stat in ['mean', 'median', 'std', 'max', 'min']:\n        lognames.append(color + '_' + stat)\n\n\n# Helper functions for investigating band statistics.\ndef plot_band_stats(DataFrame, name='Unknown'):\n    \"\"\"Given a DataFrame as a data frame of Labels, will plot all band statistics for that data frame.\n\n    Parameters\n        DataFrame: The data frame of Labels to plot\n        name: Name for the statistics.\n\n    Example\n    plot_band_stats(Labels['primary'], 'primary') will plot all band statistics for images\n    that are tagged 'primary'\n    \"\"\"\n    for stat in names:\n        fig = plt.figure(figsize=(9, 4))\n        histogram = plt.subplot(2, 1, 1)\n        sns.distplot(DataFrame[stat], kde=False, bins=100)\n        boxplot = plt.subplot(2, 1, 2)\n        sns.boxplot(DataFrame[stat])\n        plt.suptitle(stat + ' for: ' + name)\n\n\ndef plot_logband_stats(DataFrame, name='Unknown'):\n    \"\"\"Given a DataFrame as a data frame of Labels, will plot logged band statistics for that data frame.\n    Note: skewness and kurotosis are not plotted.\n\n    Parameters\n        DataFrame: The data frame of Labels to plot\n        name: Name for the statistics.\n\n    Example\n    plot_band_stats(Labels['primary'], 'primary') will plot all logged band statistics for images\n    that are tagged 'primary'\n    \"\"\"\n    for stat in lognames:\n        fig = plt.figure(figsize=(9, 4))\n        histogram = plt.subplot(2, 1, 1)\n        sns.distplot(np.log(1 + DataFrame[stat]), kde=False, bins=100)\n        boxplot = plt.subplot(2, 1, 2)\n        sns.boxplot(np.log(1 + DataFrame[stat]))\n        plt.suptitle('logged ' + stat + ' for: ' + name)","85f4f48a":"ClearPrimary = Labels[Labels['tags'] == 'clear primary']\nplot_band_stats(ClearPrimary, name='clear primary')","adbe7504":"# You can also investigate logged statistics as follows, but the kernel is running out of memory.\n# plot_logband_stats(ClearPrimary, name='clear primary')","f18921b8":"IQR = stats.iqr(ClearPrimary['n_max'])\nLower = np.percentile(ClearPrimary['n_max'], 25) - 3*IQR\nUpper = np.percentile(ClearPrimary['n_max'], 75) + 3*IQR","aa986a10":"Candidates = ClearPrimary[(ClearPrimary['n_max'] < Lower) | (ClearPrimary['n_max'] > Upper)]","425b618e":"Candidates.shape # 70 images found.","69564c71":"for img in [221, 1270, 1652, 3518, 4639, 7112, 12645, 14687, 23638, 28381, 34729, 4978, 25513]:\n    tag = Candidates.loc[img]['tags']\n    tifImage = load_image(Candidates.loc[img]['tifFilename'])\n    jpgImage = cv2.imread(Candidates.loc[img]['jpgFilename'])\n    plot_image(tifImage, jpgImage, tag, img)","2c3ab5bd":"We will now explore the label distributions.","322b4536":"Encoding tags.","a5e3adc3":"They look like similar distributions. That is a good sign. Haze does have noticeably damped cultivation, agriculture, and road frequencies. This may be due to the difficulty of spotting these features in hazy images.","fba44d31":"## Label Analysis\nWe will first gain and understanding of the distribution of image tags.\n\nIt is worth noting we did not create one-hot encodings as there are multiple tags per image. However, there should be a one-hot encoding for the atmospheric conditions of the image. Let's investigate that first.","476233ce":"This seems to be an issue where the jpeg and tiff images are not in agreement (which has been noted by others).\n\nLet's look at the color band distributions for images just tagged 'primary' and 'clear'.","9275684d":"Let's visually inspect the high blue-band standard deviation cloudy images.","eb1d1a87":"Let's look at this image. It has no atmospheric condition listed.","4d254b24":"We will now investigate 'primary' and 'clear' images.","feed5bd2":"That looks like primary. Let's add that tag.","d0a5c73c":"Let's also check to see if any images have only one tag that is not cloudy.","b4241a42":"## Image Loading\nLet's first visualize some randomly chosen images.","21f14de8":"This would be a good time to save the data frame for future use.\n\nWe will now use the band statistics to try to find mistagged images.","385cc183":"For now, we will finish by considering n_max. Let's pull every image 3*IQR past Q1 and Q3.","83bd3613":"We were promised a noisy data set. I want to find out how bad it actually is.\n\n**Goal**: Preprocess image formats and explore the data looking for anomalies.\nThe images will include some noise. This kernel's goal is to detect outliers and mistagged images.","7be68a5a":"As loading all the images at once would overload memory, we will load each image one at a time for processing. We could batch load too.","45c46999":"Cloudy images should not have any other tags. We will check this.","4109771e":"From the list of images above:\n\n - Images 221, 1270, 1652, 3518, 4639, 7112, 12645, 14687, 23638, 28381, and 34729 have NIR resolution issues.\n - Images 4978 and 25513 have different tiff vs. jpegs","8b85fb41":"Due to kernel memory, I will skip displaying each image from this data frame. I will just display images I found with issues.","3d4d9472":"Let's get a close up of the jpg.","5fabf24f":"This does have enough ground underneath to be partly cloudy. The ground seems to be primary.","bf7db2f5":"That looks be primary or bare-ground underneath. You could use NDVI to confirm this. For example below is partly cloudy with primary. However, it does seem to be more than 90% cloudy. We will keep it as cloudy.","075f38b5":"Let's try another example using near-ir.","deae579d":"## Loading Data and Encoding Tags","42d0ea9c":"## Finding Mistagged Images\nNow we will attempt to find mistagged images. The main technique is to investigate the distributions of numerical measures on the bands for each type of tag.","11e4ca22":"Now we explore what image types we have in each of the atmospheric conditions (excluding cloudy).","313a1df9":"Let's look at this image.","2aaf7c94":"Our image seems to be under clear conditions. I will fix that in the dataset. Alternately, one could remove this image from the training set altogether.","db838b57":"## Final thoughts\nAs promised, there is noise in the data, but I was impressed by how few mistagged images I found in this precursory glance. It may be worth visually inspecting each outlier (I suggest 3 times IQR past the quartiles), dropping the outliers, or just using the jpeg version of the outliers.\n\nUpdate:  After visually inspecting major outliers (8 IQR from the first and third quartiles), the proportion of clearly mistagged images is under 1%."}}