{"cell_type":{"5874279c":"code","acfb07f2":"code","0b6b6619":"code","1b6db4b4":"code","c513f738":"code","d21a989c":"code","ddad50d0":"code","7a8ae7f9":"code","a7ac9ed4":"code","a984c468":"code","d2e580a6":"code","0a1281ca":"code","d8ea94a6":"code","42dd2b5d":"code","adffd1e8":"code","00cfa034":"code","3ac48d7d":"code","de625629":"code","24861e4e":"code","b516c57c":"code","8230efd6":"code","74118d24":"code","89bd62c2":"code","05992252":"code","0fca6b64":"code","976c0383":"code","4c60787c":"markdown","900ac88b":"markdown","b35100e1":"markdown","340e7dd0":"markdown","54775d7b":"markdown","001a0e37":"markdown","545f0a4d":"markdown","b48e6dc3":"markdown","14aa7682":"markdown","0c53ece0":"markdown","a8a9640f":"markdown","a7cb8a75":"markdown","50d5163e":"markdown","18373cb7":"markdown","e8875f93":"markdown","129c7bf3":"markdown","4649b985":"markdown","ccc186e4":"markdown","ff8cc758":"markdown","db002f7c":"markdown","1716f2bc":"markdown","ce9e83cb":"markdown","5dc53c3f":"markdown","52a376bc":"markdown","23cd9561":"markdown","b1e2a87b":"markdown","9a76906b":"markdown","5eac6e6f":"markdown"},"source":{"5874279c":"# Set your own project id here\nPROJECT_ID = \"bqml-bike-rental\" # a string, like 'kaggle-bigquery-240818'\n\nimport pandas as pd\n\nfrom google.cloud import bigquery\nclient = bigquery.Client(project=PROJECT_ID, location=\"US\")\ndataset = client.create_dataset('model_dataset', exists_ok=True)\n\nfrom google.cloud.bigquery import magics\nfrom kaggle.gcp import KaggleKernelCredentials\nmagics.context.credentials = KaggleKernelCredentials()\nmagics.context.project = PROJECT_ID","acfb07f2":"%load_ext google.cloud.bigquery","0b6b6619":"# quick look at the table\ntable = client.get_table('bigquery-public-data.austin_bikeshare.bikeshare_trips')\nclient.list_rows(table, max_results=5).to_dataframe()","1b6db4b4":"%%bigquery rides_station_year\n\nSELECT start_station_name, EXTRACT(YEAR from start_time) as year, \n    COUNT(1) as num_rides\nFROM `bigquery-public-data.austin_bikeshare.bikeshare_trips`\nGROUP BY year, start_station_name\nORDER BY year, start_station_name","c513f738":"rides_station_year.groupby(\"year\").sum().plot.bar()","d21a989c":"%%bigquery rides_per_day\n\nWITH counts AS (\n    SELECT TIMESTAMP_TRUNC(start_time, DAY) as day,  \n        EXTRACT(YEAR from start_time) as year,\n        start_station_name, \n        COUNT(1) as num_rides\n    FROM `bigquery-public-data.austin_bikeshare.bikeshare_trips`\n    GROUP BY day, start_station_name, year\n), \navg_station AS(\n    SELECT year, start_station_name, \n        AVG(num_rides) as num_rides\n    FROM counts\n    GROUP BY start_station_name, year\n)\nSELECT year, AVG(num_rides) as avg_rides_per_day\nFROM avg_station\nGROUP BY year\nORDER BY year\n","ddad50d0":"rides_per_day","7a8ae7f9":"rides_station = rides_station_year.groupby(\"start_station_name\").agg({\"num_rides\":\"sum\",\"year\":\"min\"})\nrides_station.plot.scatter(x='year', y='num_rides')","a7ac9ed4":"rides_station.sort_values(\"num_rides\", ascending=False).head()","a984c468":"%%bigquery rides_in_2017\n\nSELECT start_station_name, TIMESTAMP_TRUNC(start_time, HOUR) as start_hour, \n    COUNT(1) as num_rides_2017\nFROM `bigquery-public-data.austin_bikeshare.bikeshare_trips`\nWHERE start_time BETWEEN '2017-01-01' and '2018-01-01'\nGROUP BY start_hour, start_station_name \nORDER BY num_rides_2017 DESC","d2e580a6":"%%bigquery rides_in_2018\n\nSELECT start_station_name,start_station_id, TIMESTAMP_TRUNC(start_time, HOUR) as start_hour, \n    COUNT(1) as num_rides_2018\nFROM `bigquery-public-data.austin_bikeshare.bikeshare_trips`\nWHERE start_time BETWEEN '2018-01-01' AND '2019-01-01'\nGROUP BY start_hour, start_station_name , start_station_id\nORDER BY num_rides_2018 DESC","0a1281ca":"rides_in_2017_grouped = rides_in_2017.groupby(\"start_station_name\").sum()\nstations_2017 = rides_in_2017_grouped.index\nrides_in_2018_grouped = rides_in_2018.groupby(\"start_station_name\").sum()\nstations_2018 = rides_in_2018_grouped.index\ncommon_stations = sorted(list( set(stations_2017) & set(stations_2018) ))\nstations_only_2017 = sorted(list( set(stations_2017) - set(stations_2018) ))\nstations_only_2018 = sorted(list(set(stations_2018) - set(stations_2017)))\n\nprint(f\"Total number of stations in 2017: {len(stations_2017)}\\n\")\nprint(f\"Total number of stations in 2018: {len(stations_2018)}\\n\")\nprint(f\"Common stations: {len(common_stations)}\\n\",common_stations,\"\\n\")\nprint(f\"Stations removed in 2018: {len(stations_only_2017)}\\n\", stations_only_2017,\"\\n\")\nprint(f\"Stations new in 2018: {len(stations_only_2018)}\\n\", stations_only_2018,\"\\n\")","d8ea94a6":"%%bigquery station_info\n\nSELECT name, status, latitude, longitude\nFROM `bigquery-public-data.austin_bikeshare.bikeshare_stations`\nORDER BY name","42dd2b5d":"station_info.head()","adffd1e8":"stations_with_info = list(station_info[\"name\"])\nstations_with_info_common = sorted(list( set(common_stations) & set(stations_with_info) ))\nstations_without_info_common = sorted(list( set(common_stations) - set(stations_with_info) ))\nstations_with_info_only_2017 = sorted(list( set(stations_only_2017) & set(stations_with_info) ))\nstations_without_info_only_2017 = sorted(list( set(stations_only_2017) - set(stations_with_info) ))\nstations_with_info_only_2018 = sorted(list( set(stations_only_2018) & set(stations_with_info) ))\nstations_without_info_only_2018 = sorted(list( set(stations_only_2018) - set(stations_with_info) ))\n\nprint(f\"Number of stations for which we have info: {len(stations_with_info)} \\n\")\nprint(f\"Common stations with info: {len(stations_with_info_common)} \\n\", stations_with_info_common, \"\\n\")\nprint(f\"Common stations without info: {len(stations_without_info_common)} \\n\", stations_without_info_common, \"\\n\")\nprint(f\"Stations with info that weree removed in 2018: {len(stations_with_info_only_2017)}\\n\", stations_with_info_only_2017,\"\\n\")\nprint(f\"Stations with info that were new in 2018: {len(stations_with_info_only_2018)}\\n\", stations_with_info_only_2018,\"\\n\")\n","00cfa034":"%%bigquery rides_common_stations_test\n\nWITH station_info AS (\n    SELECT name, status, latitude, longitude\n    FROM `bigquery-public-data.austin_bikeshare.bikeshare_stations`\n    WHERE status = 'active'\n    ORDER BY name\n), \nstations_2017 AS(\n    SELECT start_station_name\n    FROM `bigquery-public-data.austin_bikeshare.bikeshare_trips`\n    WHERE start_time BETWEEN '2017-01-01' and '2018-01-01'\n    GROUP BY start_station_name\n),\nstations_2018 AS(\n    SELECT start_station_name\n    FROM `bigquery-public-data.austin_bikeshare.bikeshare_trips`\n    WHERE start_time BETWEEN '2018-01-01' and '2019-01-01'\n    GROUP BY start_station_name\n),\ncounts AS (\n    SELECT COUNT(1) as num_rides, start_station_name, \n        TIMESTAMP_TRUNC(start_time, HOUR) as start_hour\n    FROM `bigquery-public-data.austin_bikeshare.bikeshare_trips`\n    WHERE start_time BETWEEN '2018-01-01' AND '2018-03-01' # check a few months\n    GROUP BY start_hour, start_station_name    \n),\ncommon_stations AS (\n    SELECT stations_2018.start_station_name \n    FROM stations_2018 INNER JOIN stations_2017 ON stations_2018.start_station_name = stations_2017.start_station_name\n), \ncommon_stations_info AS(\n    SELECT common_stations.start_station_name, station_info.latitude, station_info.longitude\n    FROM station_info INNER JOIN common_stations on station_info.name = common_stations.start_station_name\n)\nSELECT counts.start_station_name, counts.start_hour, common_stations_info.latitude as latitude, \n    common_stations_info.longitude as longitude, counts.num_rides as num_rides\nFROM counts INNER JOIN common_stations_info ON counts.start_station_name = common_stations_info.start_station_name\nORDER BY num_rides\n","3ac48d7d":"rides_common_stations_test.tail()","de625629":"%%bigquery\n\nCREATE OR REPLACE MODEL`model_dataset.bike_trips`\nOPTIONS(model_type='linear_reg') AS \nWITH station_info AS (\n    SELECT name, status, latitude, longitude\n    FROM `bigquery-public-data.austin_bikeshare.bikeshare_stations`\n    WHERE status = 'active'\n    ORDER BY name\n), \nstations_2017 AS(\n    SELECT start_station_name\n    FROM `bigquery-public-data.austin_bikeshare.bikeshare_trips`\n    WHERE start_time BETWEEN '2017-01-01' and '2018-01-01'\n    GROUP BY start_station_name\n),\nstations_2018 AS(\n    SELECT start_station_name\n    FROM `bigquery-public-data.austin_bikeshare.bikeshare_trips`\n    WHERE start_time BETWEEN '2018-01-01' and '2019-01-01'\n    GROUP BY start_station_name\n),\ncounts AS (\n    SELECT COUNT(1) as num_rides, start_station_name, \n        TIMESTAMP_TRUNC(start_time, HOUR) as start_hour\n    FROM `bigquery-public-data.austin_bikeshare.bikeshare_trips`\n    WHERE start_time BETWEEN '2017-01-01' AND '2018-1-01' # train on 2017 data\n    GROUP BY start_hour, start_station_name    \n),\ncommon_stations AS (\n    SELECT stations_2018.start_station_name \n    FROM stations_2018 INNER JOIN stations_2017 ON stations_2018.start_station_name = stations_2017.start_station_name\n), \ncommon_stations_info AS(\n    SELECT common_stations.start_station_name, station_info.latitude, station_info.longitude\n    FROM station_info INNER JOIN common_stations on station_info.name = common_stations.start_station_name\n)\nSELECT counts.start_station_name, counts.start_hour, counts.num_rides as label, common_stations_info.latitude as latitude, \n    common_stations_info.longitude as longitude \nFROM counts INNER JOIN common_stations_info ON counts.start_station_name = common_stations_info.start_station_name","24861e4e":"%%bigquery\n\nSELECT\n  *\nFROM ML.EVALUATE(MODEL `model_dataset.bike_trips`, (\nWITH station_info AS (\n    SELECT name, status, latitude, longitude\n    FROM `bigquery-public-data.austin_bikeshare.bikeshare_stations`\n    WHERE status = 'active'\n    ORDER BY name\n), \nstations_2017 AS(\n    SELECT start_station_name\n    FROM `bigquery-public-data.austin_bikeshare.bikeshare_trips`\n    WHERE start_time BETWEEN '2017-01-01' and '2018-01-01'\n    GROUP BY start_station_name\n),\nstations_2018 AS(\n    SELECT start_station_name\n    FROM `bigquery-public-data.austin_bikeshare.bikeshare_trips`\n    WHERE start_time BETWEEN '2018-01-01' and '2019-01-01'\n    GROUP BY start_station_name\n),\ncounts AS (\n    SELECT COUNT(1) as num_rides, start_station_name, \n        TIMESTAMP_TRUNC(start_time, HOUR) as start_hour\n    FROM `bigquery-public-data.austin_bikeshare.bikeshare_trips`\n    WHERE start_time BETWEEN '2018-01-01' AND '2019-1-01' # evaluate on 2018 data\n    GROUP BY start_hour, start_station_name    \n),\ncommon_stations AS (\n    SELECT stations_2018.start_station_name \n    FROM stations_2018 INNER JOIN stations_2017 ON stations_2018.start_station_name = stations_2017.start_station_name\n), \ncommon_stations_info AS(\n    SELECT common_stations.start_station_name, station_info.latitude, station_info.longitude\n    FROM station_info INNER JOIN common_stations on station_info.name = common_stations.start_station_name\n)\nSELECT counts.start_station_name, counts.start_hour, counts.num_rides as label, common_stations_info.latitude as latitude, \n    common_stations_info.longitude as longitude \nFROM counts INNER JOIN common_stations_info ON counts.start_station_name = common_stations_info.start_station_name\n    \n))\n","b516c57c":"%%bigquery predict_2018\n\nSELECT \n    TIMESTAMP_TRUNC(start_hour, DAY) as start_day,    \n    predicted_label as predicted_num_rides,\n    label as num_rides, \n    start_station_name, \n    latitude, \n    longitude\nFROM ML.PREDICT( MODEL `model_dataset.bike_trips`,(\nWITH station_info AS (\n    SELECT name, status, latitude, longitude\n    FROM `bigquery-public-data.austin_bikeshare.bikeshare_stations`\n    WHERE status = 'active'\n    ORDER BY name\n), \nstations_2017 AS(\n    SELECT start_station_name\n    FROM `bigquery-public-data.austin_bikeshare.bikeshare_trips`\n    WHERE start_time BETWEEN '2017-01-01' and '2018-01-01'\n    GROUP BY start_station_name\n),\nstations_2018 AS(\n    SELECT start_station_name\n    FROM `bigquery-public-data.austin_bikeshare.bikeshare_trips`\n    WHERE start_time BETWEEN '2018-01-01' and '2019-01-01'\n    GROUP BY start_station_name\n),\ncounts AS (\n    SELECT COUNT(1) as num_rides, start_station_name, \n        TIMESTAMP_TRUNC(start_time, HOUR) as start_hour\n    FROM `bigquery-public-data.austin_bikeshare.bikeshare_trips`\n    WHERE start_time BETWEEN '2018-01-01' AND '2019-1-01' # evaluate on 2018 data\n    GROUP BY start_hour, start_station_name    \n),\ncommon_stations AS (\n    SELECT stations_2018.start_station_name \n    FROM stations_2018 INNER JOIN stations_2017 ON stations_2018.start_station_name = stations_2017.start_station_name\n), \ncommon_stations_info AS(\n    SELECT common_stations.start_station_name, station_info.latitude, station_info.longitude\n    FROM station_info INNER JOIN common_stations on station_info.name = common_stations.start_station_name\n)\nSELECT counts.start_station_name, counts.start_hour, counts.num_rides as label, common_stations_info.latitude as latitude, \n    common_stations_info.longitude as longitude \nFROM counts INNER JOIN common_stations_info ON counts.start_station_name = common_stations_info.start_station_name\n))\nORDER BY start_day, start_station_name\n ","8230efd6":"predict_2018.head()","74118d24":"predict_2018_by_station = predict_2018.groupby(\"start_station_name\").sum()#agg({\"num_rides\":\"sum\", \"predicted_num_rides\":\"sum\",\n                                                                            #\"latitude\":\"mean\",\"longitude\":\"mean\"})\npredict_2018_by_station[[\"predicted_num_rides\",\"num_rides\"]].plot()\npredict_2018_by_station['rel-diff'] = (predict_2018_by_station[\"predicted_num_rides\"] - predict_2018_by_station[\"num_rides\"])\/predict_2018_by_station[\"predicted_num_rides\"]\nprint(\"Rows with largest relative difference\\n\",predict_2018_by_station.sort_values('rel-diff').head(),\"\\n\")\nprint(\"Average values\\n\", predict_2018_by_station.mean(),\"\\n\")","89bd62c2":"predict_2018_guadalupe21 = predict_2018[predict_2018['start_station_name'] == 'Guadalupe & 21st']\npredict_2018_guadalupe21[[\"predicted_num_rides\",\"num_rides\",\"start_day\"]].groupby(\"start_day\").sum().plot()","05992252":"%%bigquery new_stations_2018\n\nWITH station_info AS (\n    SELECT name, status, latitude, longitude\n    FROM `bigquery-public-data.austin_bikeshare.bikeshare_stations`\n    WHERE status = 'active'\n    ORDER BY name\n), \nstations_2017 AS(\n    SELECT start_station_name\n    FROM `bigquery-public-data.austin_bikeshare.bikeshare_trips`\n    WHERE start_time BETWEEN '2017-01-01' and '2018-01-01'\n    GROUP BY start_station_name\n),\nstations_2018 AS(\n    SELECT start_station_name\n    FROM `bigquery-public-data.austin_bikeshare.bikeshare_trips`\n    WHERE start_time BETWEEN '2018-01-01' and '2019-01-01'\n    GROUP BY start_station_name\n),\nonly_2018 AS (\n    SELECT stations_2018.start_station_name \n    FROM stations_2018 LEFT JOIN stations_2017 ON stations_2018.start_station_name = stations_2017.start_station_name\n    WHERE stations_2017.start_station_name is null \n)\nSELECT only_2018.start_station_name, station_info.latitude, station_info.longitude\nFROM only_2018 INNER JOIN station_info on only_2018.start_station_name = station_info.name\n","0fca6b64":"new_stations_2018","976c0383":"ax1 = station_info.plot.scatter(y='latitude', x='longitude', color='blue', label='all stations')\nnew_stations_2018.plot.scatter(y='latitude', x='longitude', ax=ax1, color='green', label='2018 new stations')\nstation_info[station_info.name.str.contains('Guadalupe & 21st|UT West Mall @ Guadalupe')].plot.scatter(y='latitude', x='longitude', color='red', \n                                                      label='bad prediction', ax=ax1)\n","4c60787c":"### Number of rides per year","900ac88b":"## Abstract \n\nThis kernel is a study on how to do better BQML exercise on the Austin rental bikes proposed [here](https:\/\/www.kaggle.com\/rtatman\/bigquery-machine-learning-exercise?utm_medium=email&utm_source=intercom&utm_campaign=sql-summer-camp). \nThe outcome of the exercise was that using the out-of-the-box 2017 data to predict the number of rides in 2018 does not work. \nIt is obvious that 2018 saw an increase of bike rides with respect to 2017, but in this kernel I look into why this is happening in more detail. \n\nIt is found that all the stations for which it is not possible to make an accurate prediction are geographically close and close to a campus of the Univeristy of Texas. These stations saw an increase in number of rides around mid February 2018. This lead me to look into what happen in the area in that period. \n\nI found out that the Austin B-cycle company launched a new initiative in the area, that included more stations and free passes for students (more details [here](https:\/\/www.bcycle.com\/news\/2018\/02\/14\/austin-b-cycle-expands-service-to-ut-campus-and-west-campus-neighborhoods)). This is why it is not possible to make accurate prerictions for a lot of stations. \n\nIf I had been working in the bike sharing company, this is something I would have for sure known from the beginning and I would have taken it into account. ","b35100e1":"### Information on the stations\nTo understand better the differences, we can focus on 2017 and 2018. \nWe can check which stations have been added or removed in 2018. ","340e7dd0":"To veryfy that, we can use pandas to group by the name of the station the datafeame we already have (`rides_station_year`), and check the year the station was used for the first time (the minimum of the years). ","54775d7b":"Quite a few stations were added in 2018, including one that alone had more than 70000 rides (cumulative in 2018 and 2019). ","001a0e37":"It looks like the difference starts being large between February and March 2018. ","545f0a4d":"### Rides per day","b48e6dc3":"### Number of stations","14aa7682":"We create the model and train it on 2017 data. We include also latitude and longitude of the station in the training. ","0c53ece0":"Now let's try to obtain all of this information from SQL only. \nI'm going to select only the stations common in 2017 and 2018 and with status 'active'","a8a9640f":"## Model creation","a7cb8a75":"The model seems to do reasonably well except for two stations where the difference is much larger: `Guadalupe & 21st` and `UT West Mall @ Guadalupe`. Let's focus on the first one to check if this difference is constant in time. ","50d5163e":"The performance is already improved with respect to the original exercise, but still not completely satisfactory","18373cb7":"Now we know which stations have changed between 2017 and 2018. \n\n\nWe now inspect the other table in the database, containing information on the individual stations. \nUnfortunateely it is not specified when the table was updated. ","e8875f93":"Look at how many rides are done each year","129c7bf3":"Yes, the two stations with the highest disagreement between predicted and observed rides are close to the new stations. This suggest that something happened in the area. ","4649b985":"## Model evaluation\n\nThe performance of the model is evaluated on 2018 data","ccc186e4":"## Conclusion\n\nAfter a google search for what happened in Austin between February and March 2018, I found that \nin February 2018 Austin B-cycle announced  an expansion of the service to UT Campus and West Campus Neighborhoods. \nThis included new stations and also an annual membership free of charge for the UT students (all the details can be found [here](https:\/\/www.bcycle.com\/news\/2018\/02\/14\/austin-b-cycle-expands-service-to-ut-campus-and-west-campus-neighborhoods). \n\nThe data from 2018 was so hard to predict because the combination of new stations and free membership for the students lead to a massive increase in the number of rides, which was impossible to predict with 2017 data. \n\nA person working for the bike sharing company would have for sure know this, and could have included in the model additional information. For example data related to other cities where this offer has been proposed before, the number of students who registered for the free membership, and so on. ","ff8cc758":"# Stocking rental bikes","db002f7c":"## Differences between 2018 and previous years\n","1716f2bc":"This new station is `21st & Speedway @PCL`, with 72799 rides. ","ce9e83cb":"Let's look at this in a plot (this could be done better with geopandas, but for the moment I just want to take a quick look)","5dc53c3f":"The average number of rides per station per year is indeed higher for 2018 than for the other years. \nThis information does not take into account the number of stations. For example, 2017 has a lower average per station per day than 2016, but the total nuber of rides is actually higher. It can be interesting to look also at the number of stations. ","52a376bc":"2018 saw a huge increase in the number of rides. \nThis can be due to the increase in number of stations or to an increase of the number of rides from each station.","23cd9561":"## Geographical location of the stations\n\nIt looks like the two stations that have the largest difference between predicted and observed number of rides are close geographically (they have similar values of latitude and longitude). \nIt's interesting to see if they are also close to the new stations that have been added in 2018. This could be related to an event attracting many people in the area or an initiative of the bike rental company. ","b1e2a87b":"## Setup","9a76906b":"## Take a quick look at the data","5eac6e6f":"## Looking at predictions\n\nWe can look at the predictions that our model makes for 2018. Remember that for now we are only looking at the stations that were present both in 2018 and 2017, and ignore the new stations in 2018. "}}