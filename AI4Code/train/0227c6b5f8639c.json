{"cell_type":{"05008d51":"code","b91121a6":"code","5dd9965c":"code","54ec5a79":"code","cfe627b7":"code","33793022":"code","3ffe7c67":"code","abef8a1e":"code","fe3f3a11":"code","f9d841c5":"code","b99d2927":"code","d51899ea":"code","0dacf381":"code","4cd2d51c":"code","1a2b787e":"code","4c9383a7":"code","3051fae6":"code","6e639419":"code","dd363734":"code","70de44bb":"code","54be8a3b":"code","51127e5c":"code","008973fb":"code","3b670440":"code","d3c0a54e":"code","1467d483":"code","930b836c":"code","dc74067e":"code","e809e49d":"markdown","9278afe3":"markdown","2a4b8089":"markdown","15864535":"markdown","23373c2a":"markdown","bf0182d7":"markdown","8ac29c04":"markdown","3a51707a":"markdown","b3256793":"markdown","ed7c28ab":"markdown","0f7b0a81":"markdown","52d197e2":"markdown","34562018":"markdown","84feba7a":"markdown","506593ce":"markdown","b314842a":"markdown","0b6ed6f6":"markdown"},"source":{"05008d51":"import pandas as pd\nimport datetime as dt\nimport numpy as np\nimport matplotlib.pyplot as plt","b91121a6":"df = pd.read_csv('..\/input\/retailtransactiondata\/Retail_Data_Transactions.csv', parse_dates=['trans_date'])","5dd9965c":"df.head(3)","54ec5a79":"df.info()","cfe627b7":"print(df['trans_date'].min(), df['trans_date'].max())","33793022":"sd = dt.datetime(2015,4,1)\ndf['hist']=sd - df['trans_date']\ndf['hist'].astype('timedelta64[D]')\ndf['hist']=df['hist'] \/ np.timedelta64(1, 'D')\ndf.head()","3ffe7c67":"df=df[df['hist'] < 730]\ndf.info()","abef8a1e":"rfmTable = df.groupby('customer_id').agg({'hist': lambda x:x.min(), # Recency\n                                        'customer_id': lambda x: len(x),               # Frequency\n                                        'tran_amount': lambda x: x.sum()})          # Monetary Value\n\nrfmTable.rename(columns={'hist': 'recency', \n                         'customer_id': 'frequency', \n                         'tran_amount': 'monetary_value'}, inplace=True)","fe3f3a11":"rfmTable.head()","f9d841c5":"df[df['customer_id']=='CS1112']","b99d2927":"quartiles = rfmTable.quantile(q=[0.25,0.50,0.75])\nprint(quartiles, type(quartiles))","d51899ea":"quartiles=quartiles.to_dict()\nquartiles\n","0dacf381":"## for Recency \n\ndef RClass(x,p,d):\n    if x <= d[p][0.25]:\n        return 1\n    elif x <= d[p][0.50]:\n        return 2\n    elif x <= d[p][0.75]: \n        return 3\n    else:\n        return 4\n    \n## for Frequency and Monetary value \n\ndef FMClass(x,p,d):\n    if x <= d[p][0.25]:\n        return 4\n    elif x <= d[p][0.50]:\n        return 3\n    elif x <= d[p][0.75]: \n        return 2\n    else:\n        return 1    \n    \n","4cd2d51c":"rfmSeg = rfmTable\nrfmSeg['R_Quartile'] = rfmSeg['recency'].apply(RClass, args=('recency',quartiles,))\nrfmSeg['F_Quartile'] = rfmSeg['frequency'].apply(FMClass, args=('frequency',quartiles,))\nrfmSeg['M_Quartile'] = rfmSeg['monetary_value'].apply(FMClass, args=('monetary_value',quartiles,))","1a2b787e":"rfmSeg['RFMClass'] = rfmSeg.R_Quartile.map(str) \\\n                            + rfmSeg.F_Quartile.map(str) \\\n                            + rfmSeg.M_Quartile.map(str)","4c9383a7":"rfmSeg.head()","3051fae6":"rfmSeg.sort_values(by=['RFMClass', 'monetary_value'], ascending=[True, False])","6e639419":"rfmSeg.groupby('RFMClass').agg('monetary_value').mean()","dd363734":"rfmSeg['Total Score'] = rfmSeg['R_Quartile'] + rfmSeg['F_Quartile'] +rfmSeg['M_Quartile']\nprint(rfmSeg.head(), rfmSeg.info())","70de44bb":"rfmSeg.groupby('Total Score').agg('monetary_value').mean()","54be8a3b":"rfmSeg.groupby('Total Score').agg('monetary_value').mean().plot(kind='bar', colormap='Blues_r')","51127e5c":"rfmSeg.groupby('Total Score').agg('frequency').mean().plot(kind='bar', colormap='Blues_r')","008973fb":"rfmSeg.groupby('Total Score').agg('recency').mean().plot(kind='bar', colormap='Blues_r')","3b670440":"res = pd.read_csv('..\/input\/retailtransactiondata\/Retail_Data_Response.csv')\nres.sort_values('customer_id', inplace=True)\n\nprint(res.head(), res.info())","d3c0a54e":"rfmSeg.reset_index(inplace=True)\nrfmSeg.head()","1467d483":"rfmSeg.sort_values('customer_id', inplace=True)\nrfm2=pd.merge(rfmSeg, res, on='customer_id')","930b836c":"rfm2.info()","dc74067e":"ax=rfm2.groupby('Total Score').agg('response').mean().plot(kind='bar', colormap='copper_r')\nax.set_xlabel(\"Total Score\")\nax.set_ylabel(\"Proportion of Responders\")","e809e49d":"## RFM Analysis","9278afe3":"In the case of receny, lower is better and hence our categorising scheme need to be reverse.","2a4b8089":"We will cross check details of one customer 'CS1112'. Looks like calcultion is correct (latest transaction is 77 days back\/ Total number of transaction is 6\/ Total amount is 358.","15864535":"let's convert quartile information into a dictionary so that cutoffs can be picked up.","23373c2a":"For analysis it is critical to combine the scores to create a single score. There are few approaches. One approach is to just concatenate the scores to create a 3 digit number between 111 and 444. Here the drawback is too many categories (4x4x4). Also, not easy prioritise scores like 421 vs 412. ","bf0182d7":"Let's assume that the study is being done as of 01\/Apr\/2015. We will identify the earliest and latest dates of transaction.","8ac29c04":"This data is at transaction level. ie one row for each transaction made by a customer (note that it is not at item level).","3a51707a":"RFM analysis involves categorising R,F and M into 3 or more categories. For convenience, let's create 4 categories based on quartiles (quartiles roughly divide the sample into 4 segments equal proportion).","b3256793":"We note that combined score is consistent in ordering R,F and M","ed7c28ab":"The chart shows that response behaviour is strongly related to combined score. However, there is not much difference between the scores of 3,4,5, and 6. While the performance of the scores is much lower for scores > 6.","0f7b0a81":"Let's conduct an RFM Analysis using a retail data. It contains customer level data on transactions\nby date. It also got response information to a promotion campaign conducted by the\norganization.\n\nI am thankful to many published materials especially by Correia given below.\nhttps:\/\/github.com\/joaolcorreia\/RFM-analysis\/blob\/master\/RFM%20Analysis.ipynb\n\n","52d197e2":"Only the transactions made in the last 2 years are considered for analysis.","34562018":"Number of days from the study date is calculated as below.","84feba7a":"Let's check how the combined score arrange R,F and M","506593ce":"Ultimate test of RFM score is the impact on any consumer behaviour. Let's check its impact on the response of customers to a promotion campaign. ","b314842a":"Another possibility is to combine the scores to create one score (eg. 4+1+1).  This will create a score between 3 and 12. Here the sdvantage is that each of the scores got same importance. However some scores will have many sgements as constituents (eg - 413 ad 431)","0b6ed6f6":"The data will be summarized at customer level by taking *number of days to the latest transaction*, *sum of all transction amount* and *total number of transaction*."}}