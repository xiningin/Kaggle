{"cell_type":{"ca163d2b":"code","8a0386d1":"code","4bf26ce9":"code","6e3cdb83":"code","05728446":"code","b9d5e1c4":"code","354a5541":"code","9da92aea":"code","260b3503":"code","60d95b1b":"code","5a4324d6":"code","78352204":"code","7d41baa6":"code","a2129480":"code","9fb61d20":"code","2fdad6e0":"code","ab018f80":"code","cb5cfdba":"code","e80c5aff":"code","19f819a7":"code","c41d37e9":"code","8df88beb":"code","20985788":"code","fca55e7c":"code","997b713b":"code","d460dda6":"code","36fb6a31":"code","821a2e26":"code","a6bb3046":"code","884e4318":"code","63ef8c79":"code","52022266":"code","981eb596":"code","eb3c7a08":"markdown","e90705d4":"markdown","3198d88c":"markdown","f1c3976a":"markdown","2619e3a5":"markdown","4897181d":"markdown","0ddbaebb":"markdown","747718fe":"markdown","fb877ab1":"markdown","d98cbbbd":"markdown","a53ea3cb":"markdown","8a53e3b6":"markdown","94a9616c":"markdown","69b76531":"markdown","3513dba5":"markdown","50bad6fb":"markdown","2e5011af":"markdown","f423063b":"markdown"},"source":{"ca163d2b":"import numpy as np\nimport pandas as pd\n\nimport os\nfor dirname, _, filenames in os.walk('\/kaggle\/input'):\n    for filename in filenames:\n        print(os.path.join(dirname, filename))","8a0386d1":"train = pd.read_csv('\/kaggle\/input\/lish-moa\/train_features.csv')\n\ntrain.shape","4bf26ce9":"train_target = pd.read_csv('\/kaggle\/input\/lish-moa\/train_targets_scored.csv')\n\ntrain_target.shape","6e3cdb83":"test = pd.read_csv('\/kaggle\/input\/lish-moa\/test_features.csv')\n\ntest.shape","05728446":"antagonists = []\n\nfor column in train_target.columns:\n    if column.endswith('_agonist'):\n        antagonist = column.replace('_agonist', '_antagonist')\n        if antagonist in train_target.columns:\n            antagonists.append((column, antagonist))\n\nantagonists","b9d5e1c4":"for pair in antagonists:\n    n = train_target[(train_target[pair[0]] == 1) & (train_target[pair[1]] == 1)].shape[0]\n    if n > 0:\n        print(pair[0], '-', pair[1])\n        print('Number of cases:', n)","354a5541":"# From https:\/\/www.kaggle.com\/carlmcbrideellis\/moa-setting-ctl-vehicle-0-improves-score\n\ntrain.at[train['cp_type'].str.contains('ctl_vehicle'),train.filter(regex='-.*').columns] = 0.0\n\ntest.at[test['cp_type'].str.contains('ctl_vehicle'),test.filter(regex='-.*').columns] = 0.0","9da92aea":"train_size = train.shape[0]\n\ntraintest = pd.concat([train, test])\n\ntraintest = pd.concat([traintest, pd.get_dummies(traintest['cp_type'], prefix='cp_type')], axis=1)\ntraintest = pd.concat([traintest, pd.get_dummies(traintest['cp_time'], prefix='cp_time')], axis=1)\ntraintest = pd.concat([traintest, pd.get_dummies(traintest['cp_dose'], prefix='cp_dose')], axis=1)\n\ntraintest = traintest.drop(['cp_type', 'cp_time', 'cp_dose'], axis=1)\n\ntrain = traintest[:train_size]\ntest  = traintest[train_size:]\n\ndel traintest","260b3503":"train.shape","60d95b1b":"x_train = train.drop('sig_id', axis=1)\n\ny_train = train_target.drop('sig_id', axis=1)\n\nx_test = test.drop('sig_id', axis=1)","5a4324d6":"# from https:\/\/www.kaggle.com\/pavelvpster\/moa-keras-optuna-rfecv\n\n# 500\nselected_features = ['g-0', 'g-1', 'g-2', 'g-3', 'g-4', 'g-5', 'g-6', 'g-7', 'g-8', 'g-9', 'g-10', 'g-11', 'g-12', 'g-13', 'g-14', 'g-15', 'g-16', 'g-17', 'g-18', 'g-19', 'g-20', 'g-21', 'g-22', 'g-23', 'g-24', 'g-25', 'g-26', 'g-27', 'g-28', 'g-29', 'g-30', 'g-31', 'g-32', 'g-33', 'g-34', 'g-35', 'g-36', 'g-37', 'g-38', 'g-39', 'g-40', 'g-41', 'g-42', 'g-43', 'g-44', 'g-45', 'g-46', 'g-47', 'g-48', 'g-49', 'g-50', 'g-51', 'g-52', 'g-53', 'g-54', 'g-55', 'g-56', 'g-57', 'g-58', 'g-59', 'g-60', 'g-61', 'g-62', 'g-63', 'g-64', 'g-65', 'g-66', 'g-67', 'g-68', 'g-69', 'g-70', 'g-71', 'g-72', 'g-73', 'g-74', 'g-75', 'g-76', 'g-77', 'g-78', 'g-79', 'g-80', 'g-81', 'g-82', 'g-83', 'g-84', 'g-85', 'g-86', 'g-87', 'g-88', 'g-89', 'g-90', 'g-91', 'g-92', 'g-93', 'g-94', 'g-95', 'g-96', 'g-97', 'g-98', 'g-99', 'g-100', 'g-101', 'g-102', 'g-103', 'g-104', 'g-105', 'g-106', 'g-107', 'g-108', 'g-109', 'g-110', 'g-111', 'g-112', 'g-113', 'g-114', 'g-115', 'g-116', 'g-117', 'g-118', 'g-121', 'g-122', 'g-123', 'g-125', 'g-126', 'g-127', 'g-128', 'g-129', 'g-130', 'g-131', 'g-132', 'g-133', 'g-139', 'g-144', 'g-149', 'g-152', 'g-153', 'g-154', 'g-155', 'g-158', 'g-161', 'g-162', 'g-165', 'g-166', 'g-167', 'g-168', 'g-169', 'g-170', 'g-171', 'g-172', 'g-173', 'g-174', 'g-175', 'g-176', 'g-177', 'g-178', 'g-179', 'g-180', 'g-182', 'g-185', 'g-188', 'g-189', 'g-191', 'g-192', 'g-193', 'g-194', 'g-195', 'g-196', 'g-197', 'g-198', 'g-199', 'g-200', 'g-201', 'g-202', 'g-203', 'g-204', 'g-209', 'g-211', 'g-213', 'g-214', 'g-217', 'g-220', 'g-221', 'g-222', 'g-223', 'g-225', 'g-226', 'g-229', 'g-233', 'g-239', 'g-240', 'g-243', 'g-244', 'g-246', 'g-247', 'g-250', 'g-254', 'g-255', 'g-256', 'g-257', 'g-259', 'g-261', 'g-262', 'g-265', 'g-269', 'g-270', 'g-271', 'g-273', 'g-279', 'g-282', 'g-284', 'g-286', 'g-289', 'g-292', 'g-294', 'g-295', 'g-298', 'g-299', 'g-300', 'g-303', 'g-306', 'g-310', 'g-311', 'g-312', 'g-314', 'g-316', 'g-317', 'g-318', 'g-320', 'g-321', 'g-323', 'g-326', 'g-327', 'g-328', 'g-332', 'g-333', 'g-335', 'g-339', 'g-340', 'g-341', 'g-346', 'g-347', 'g-351', 'g-353', 'g-355', 'g-357', 'g-360', 'g-364', 'g-365', 'g-370', 'g-375', 'g-383', 'g-385', 'g-388', 'g-389', 'g-390', 'g-391', 'g-392', 'g-399', 'g-401', 'g-402', 'g-403', 'g-404', 'g-409', 'g-417', 'g-423', 'g-424', 'g-425', 'g-426', 'g-428', 'g-429', 'g-430', 'g-431', 'g-433', 'g-434', 'g-438', 'g-439', 'g-440', 'g-441', 'g-443', 'g-444', 'g-445', 'g-446', 'g-447', 'g-448', 'g-449', 'g-450', 'g-451', 'g-452', 'g-453', 'g-454', 'g-455', 'g-456', 'g-460', 'g-461', 'g-463', 'g-465', 'g-467', 'g-470', 'g-473', 'g-474', 'g-475', 'g-476', 'g-481', 'g-483', 'g-485', 'g-486', 'g-489', 'g-490', 'g-495', 'g-500', 'g-501', 'g-502', 'g-504', 'g-509', 'g-513', 'g-516', 'g-517', 'g-518', 'g-527', 'g-531', 'g-535', 'g-540', 'g-542', 'g-543', 'g-544', 'g-547', 'g-548', 'g-549', 'g-552', 'g-556', 'g-558', 'g-562', 'g-566', 'g-571', 'g-572', 'g-573', 'g-574', 'g-578', 'g-584', 'g-585', 'g-590', 'g-592', 'g-595', 'g-596', 'g-600', 'g-602', 'g-603', 'g-605', 'g-606', 'g-611', 'g-612', 'g-615', 'g-617', 'g-618', 'g-619', 'g-620', 'g-623', 'g-624', 'g-625', 'g-626', 'g-627', 'g-628', 'g-629', 'g-630', 'g-631', 'g-632', 'g-633', 'g-634', 'g-635', 'g-636', 'g-637', 'g-638', 'g-639', 'g-640', 'g-643', 'g-645', 'g-646', 'g-648', 'g-651', 'g-654', 'g-657', 'g-658', 'g-659', 'g-660', 'g-661', 'g-662', 'g-663', 'g-664', 'g-665', 'g-666', 'g-668', 'g-670', 'g-672', 'g-673', 'g-674', 'g-675', 'g-677', 'g-678', 'g-679', 'g-685', 'g-689', 'g-695', 'g-697', 'g-698', 'g-699', 'g-701', 'g-702', 'g-703', 'g-704', 'g-707', 'g-709', 'g-710', 'g-712', 'g-713', 'g-714', 'g-715', 'g-721', 'g-722', 'g-724', 'g-725', 'g-726', 'g-734', 'g-736', 'g-737', 'g-740', 'g-742', 'g-743', 'g-745', 'g-747', 'g-750', 'g-751', 'g-752', 'g-753', 'g-756', 'g-757', 'g-758', 'g-759', 'g-760', 'g-761', 'g-762', 'g-763', 'g-764', 'g-766', 'g-767', 'g-768', 'g-769', 'g-770', 'g-771', 'c-0', 'c-1', 'c-2', 'c-3', 'c-4', 'c-5', 'c-11', 'c-12', 'c-14', 'c-19', 'c-20', 'c-21', 'c-22', 'c-23', 'c-25', 'c-27', 'c-32', 'c-35', 'c-36', 'c-37', 'c-40', 'c-47', 'c-54', 'c-55', 'c-57', 'c-58', 'c-61', 'c-62', 'c-63', 'c-65', 'c-66', 'c-71', 'c-74', 'c-75', 'c-77', 'c-78', 'c-79', 'c-80', 'c-81', 'c-82', 'c-83', 'c-84', 'c-85', 'c-86', 'c-87', 'c-88', 'c-89', 'c-90', 'c-91', 'c-92', 'c-93', 'c-97']","78352204":"x_train = x_train[selected_features]\n\nx_test = x_test[selected_features]","7d41baa6":"from sklearn.model_selection import KFold, StratifiedKFold\nfrom sklearn.metrics import log_loss\n\nimport lightgbm as lgb","a2129480":"def fit_predict(n_splits, params, x_train, y_train, x_test):\n    \n    oof = np.zeros(x_train.shape[0])\n    \n    y_preds = []\n    \n    cv = StratifiedKFold(n_splits=n_splits, shuffle=True, random_state=42)\n    for train_idx, valid_idx in cv.split(x_train, y_train):\n        \n        x_train_train = x_train.iloc[train_idx]\n        y_train_train = y_train.iloc[train_idx]\n        x_train_valid = x_train.iloc[valid_idx]\n        y_train_valid = y_train.iloc[valid_idx]\n\n        lgb_train = lgb.Dataset(data=x_train_train.astype('float32'), label=y_train_train.astype('float32'))\n        lgb_valid = lgb.Dataset(data=x_train_valid.astype('float32'), label=y_train_valid.astype('float32'))\n\n        estimator = lgb.train(params, lgb_train, 10000, valid_sets=lgb_valid,\n                              early_stopping_rounds=25, verbose_eval=0)\n\n        oof_part = estimator.predict(x_train_valid, num_iteration=estimator.best_iteration)\n        oof[valid_idx] = oof_part\n        \n        if x_test is not None:\n            y_part = estimator.predict(x_test, num_iteration=estimator.best_iteration)\n            y_preds.append(y_part)\n        \n    score = log_loss(y_train, oof)\n    print('LogLoss Score:', score)\n    \n    y_pred = np.mean(y_preds, axis=0)\n    \n    return y_pred, oof, score","9fb61d20":"import optuna\n\n\ncolumns_to_try = [\n    'glutamate_receptor_antagonist',\n    'dna_inhibitor',\n    'serotonin_receptor_antagonist',\n    'dopamine_receptor_antagonist',\n    'cyclooxygenase_inhibitor'\n]\n\ndef objective(trial):\n    \n    params = {\n        'objective': 'binary',\n        'metric': 'binary_logloss',\n        'boosting_type': 'gbdt',\n        'boost_from_average': True,\n        'num_threads': 4,\n        'random_state': 42,\n        \n        'num_leaves': trial.suggest_int('num_leaves', 10, 1000),\n        'min_data_in_leaf': trial.suggest_int('min_data_in_leaf', 10, 200),\n        'min_child_weight': trial.suggest_loguniform('min_child_weight', 0.001, 0.1),\n        'max_depth': trial.suggest_int('max_depth', 1, 100),\n        'bagging_fraction': trial.suggest_loguniform('bagging_fraction', .5, .99),\n        'feature_fraction': trial.suggest_loguniform('feature_fraction', .5, .99),\n        'lambda_l1': trial.suggest_loguniform('lambda_l1', 0.1, 2),\n        'lambda_l2': trial.suggest_loguniform('lambda_l2', 0.1, 2)\n    }\n    \n    scores = []\n    for column in columns_to_try:\n        _, _, score = fit_predict(3, params, x_train, y_train[column], None)\n        scores.append(score)\n    \n    return np.mean(scores)\n\n\n# study = optuna.create_study(direction='minimize')\n# study.optimize(objective, n_trials=100)","2fdad6e0":"# study.best_trial","ab018f80":"columns_1 = [\n    '5-alpha_reductase_inhibitor',\n    '11-beta-hsd1_inhibitor',\n    'adenylyl_cyclase_activator',\n    'aldehyde_dehydrogenase_inhibitor',\n    'ampk_activator',\n    'analgesic',\n    'antiarrhythmic',\n    'anticonvulsant',\n    'antifungal',\n    'antihistamine',\n    'antimalarial',\n    'antiviral',\n    'atm_kinase_inhibitor',\n    'atp-sensitive_potassium_channel_antagonist',\n    'atp_synthase_inhibitor',\n    'atr_kinase_inhibitor',\n    'autotaxin_inhibitor',\n    'bacterial_membrane_integrity_inhibitor',\n    'calcineurin_inhibitor',\n    'caspase_activator',\n    'catechol_o_methyltransferase_inhibitor',\n    'cck_receptor_antagonist',\n    'chk_inhibitor',\n    'coagulation_factor_inhibitor',\n    'diuretic',\n    'elastase_inhibitor',\n    'erbb2_inhibitor',\n    'farnesyltransferase_inhibitor',\n    'focal_adhesion_kinase_inhibitor',\n    'free_radical_scavenger',\n    'fungal_squalene_epoxidase_inhibitor',\n    'glutamate_inhibitor',\n    'gonadotropin_receptor_agonist',\n    'histone_lysine_demethylase_inhibitor',\n    'hsp_inhibitor',\n    'ikk_inhibitor',\n    'laxative',\n    'leukotriene_inhibitor',\n    'lipase_inhibitor',\n    'lxr_agonist',\n    'mdm_inhibitor',\n    'monoacylglycerol_lipase_inhibitor',\n    'monopolar_spindle_1_kinase_inhibitor',\n    'nicotinic_receptor_agonist',\n    'nitric_oxide_production_inhibitor',\n    'norepinephrine_reuptake_inhibitor',\n    'nrf2_activator',\n    'pdk_inhibitor',\n    'progesterone_receptor_antagonist',\n    'proteasome_inhibitor',\n    'protein_phosphatase_inhibitor',\n    'protein_tyrosine_kinase_inhibitor',\n    'ras_gtpase_inhibitor',\n    'retinoid_receptor_antagonist',\n    'steroid',\n    'syk_inhibitor',\n    'tgf-beta_receptor_inhibitor',\n    'thrombin_inhibitor',\n    'tlr_antagonist',\n    'transient_receptor_potential_channel_antagonist',\n    'tropomyosin_receptor_kinase_inhibitor',\n    'trpv_agonist',\n    'ubiquitin_specific_protease_inhibitor',\n    'vitamin_d_receptor_agonist'\n]","cb5cfdba":"params_1 = {\n    'objective': 'binary',\n    'metric': 'binary_logloss',\n    'boosting_type': 'gbdt',\n    'boost_from_average': True,\n    'num_threads': 4,\n    'random_state': 42,\n    \n    'learning_rate': 0.01,\n    \n    # from Optuna result in Version 7\n    'num_leaves': 212,\n    'min_data_in_leaf': 92,\n    'min_child_weight': 0.0010123391323415569,\n    'max_depth': 35,\n    'bagging_fraction': 0.7968351296815959,\n    'feature_fraction': 0.7556374471450119,\n    'lambda_l1': 0.23497601594060086,\n    'lambda_l2': 0.15889208239516134\n}\n\nparams_1","e80c5aff":"params_2 = {\n    'objective': 'binary',\n    'metric': 'binary_logloss',\n    'boosting_type': 'gbdt',\n    'boost_from_average': True,\n    'num_threads': 4,\n    'random_state': 42,\n    \n    'learning_rate': 0.01,\n    \n    # from Optuna result in Version 15\n    'num_leaves': 106,\n    'min_data_in_leaf': 176,\n    'min_child_weight': 0.08961015929882983,\n    'max_depth': 3,\n    'bagging_fraction': 0.5672004837454858,\n    'feature_fraction': 0.611628226420641,\n    'lambda_l1': 1.293005852529098,\n    'lambda_l2': 1.6012450757049599\n}\n\nparams_2","19f819a7":"n_splits = 3\n\ny_pred = pd.DataFrame()\n\noof = pd.DataFrame()\n\nscores = []\n\nfor column in y_train.columns:\n    print('Column:', column)\n    \n    if column in columns_1:\n        print('Params 1')\n        params = params_1\n    else:\n        print('Params 2')\n        params = params_2\n    \n    y_pred[column], oof[column], score = fit_predict(n_splits, params, x_train, y_train[column], x_test)\n    \n    scores.append(score)","c41d37e9":"np.mean(scores)","8df88beb":"x_train_2 = pd.concat([x_train, oof], axis=1)\n\nx_train_2.shape","20985788":"x_test_2 = pd.concat([x_test, y_pred], axis=1)\n\nx_test_2.shape","fca55e7c":"import optuna\n\n\ncolumns_to_try = [\n    'antiviral',\n    'dna_inhibitor'\n]\n\ndef objective(trial):\n    \n    params = {\n        'objective': 'binary',\n        'metric': 'binary_logloss',\n        'boosting_type': 'gbdt',\n        'boost_from_average': True,\n        'num_threads': 4,\n        'random_state': 42,\n        \n        'num_leaves': trial.suggest_int('num_leaves', 10, 1000),\n        'min_data_in_leaf': trial.suggest_int('min_data_in_leaf', 10, 200),\n        'min_child_weight': trial.suggest_loguniform('min_child_weight', 0.001, 0.1),\n        'max_depth': trial.suggest_int('max_depth', 1, 100),\n        'bagging_fraction': trial.suggest_loguniform('bagging_fraction', .5, .99),\n        'feature_fraction': trial.suggest_loguniform('feature_fraction', .5, .99),\n        'lambda_l1': trial.suggest_loguniform('lambda_l1', 0.1, 2),\n        'lambda_l2': trial.suggest_loguniform('lambda_l2', 0.1, 2)\n    }\n    \n    scores = []\n    for column in columns_to_try:\n        _, _, score = fit_predict(3, params, x_train_2.drop(column, axis=1), y_train[column], None)\n        scores.append(score)\n    \n    return np.mean(scores)\n\n\n# study = optuna.create_study(direction='minimize')\n# study.optimize(objective, n_trials=100)","997b713b":"params = {\n    'objective': 'binary',\n    'metric': 'binary_logloss',\n    'boosting_type': 'gbdt',\n    'boost_from_average': True,\n    'num_threads': 4,\n    'random_state': 42,\n    \n    'learning_rate': 0.01,\n\n    # from Optuna result in Version 21\n    'num_leaves': 204,\n    'min_data_in_leaf': 109,\n    'min_child_weight': 0.0022436199989295377,\n    'max_depth': 3,\n    'bagging_fraction': 0.8715885202491637,\n    'feature_fraction': 0.6187304356714799,\n    'lambda_l1': 1.4290015875633637,\n    'lambda_l2': 0.7289605844855718\n}\n\nparams","d460dda6":"y_pred_2 = pd.DataFrame()\n\noof_2 = pd.DataFrame()\n\nscores_2 = []\n\nfor column in y_train.columns:\n    print('Column:', column)\n    \n    y_pred_2[column], oof_2[column], score = fit_predict(n_splits, params, x_train_2.drop(column, axis=1),\n                                                         y_train[column], x_test_2.drop(column, axis=1))\n    \n    scores_2.append(score)","36fb6a31":"y_pred = y_pred_2\n\noof = oof_2\n\nscores = scores_2","821a2e26":"np.mean(scores)","a6bb3046":"score = pd.DataFrame()\nscore['feature'] = y_train.columns\nscore['score'] = scores + [0] * (len(y_train.columns) - len(scores))","884e4318":"import matplotlib.pyplot as plt\nimport seaborn as sns\n\nplt.figure(figsize=(10,40))\n\nsns.barplot(x=\"score\", y=\"feature\", data=score)\n\nplt.show()","63ef8c79":"for pair in antagonists:\n    n = y_pred[(y_pred[pair[0]] > 0.5) & (y_pred[pair[1]] > 0.5)].shape[0]\n    if n > 0:\n        print(pair[0], '-', pair[1])\n        print('Number of cases:', n)","52022266":"submission = pd.read_csv('\/kaggle\/input\/lish-moa\/sample_submission.csv')\n\ncolumns = list(set(submission.columns) & set(y_pred.columns))\nsubmission[columns] = y_pred[columns]\n\nsubmission.to_csv('submission.csv', index=False)","981eb596":"oof.to_csv('oof.csv', index=False)\n\nscore.to_csv('score.csv', index=False)","eb3c7a08":"## Optuna","e90705d4":"## Second level models","3198d88c":"## LightGBM","f1c3976a":"To predict each label it uses features + predictions of other labels from first level models","2619e3a5":"## Read data","4897181d":"## Check agonist \/ antagonist","0ddbaebb":"## 206 models","747718fe":"# LightGBM Baseline","fb877ab1":"## Check","d98cbbbd":"In general agonist and antagonist should not have 1 at the same time","a53ea3cb":"## Feature selection","8a53e3b6":"## Feature engineering","94a9616c":"## Submit predictions","69b76531":"## Prepare x, y","3513dba5":"## Save OOF and scores","50bad6fb":"## OHE","2e5011af":"### Scores","f423063b":"List agonist \/ antagonist pairs where both features have 1"}}