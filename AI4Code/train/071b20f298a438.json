{"cell_type":{"c2edafb3":"code","d09de282":"code","935610d2":"code","b82a231c":"code","a3e1d085":"code","912698f2":"code","a4f354bf":"code","be8a454c":"code","1a00ba66":"code","29257488":"code","5d57ee25":"code","a7026975":"code","1f034b6b":"code","49e360c8":"code","64c13935":"code","48eaffcb":"code","4914b7e6":"code","686a6b40":"code","04deb185":"code","44b196e1":"code","8f3e94bb":"code","efdb8eea":"code","a4c3cdca":"code","6f1d75b6":"code","833172de":"code","b3f33ac8":"code","db68280f":"code","e342bd74":"code","8110ccaa":"code","338f87e4":"code","4b6422b8":"code","433fcf4e":"code","90271ad7":"code","5c137ebd":"code","26a2d0bd":"code","ff8863ce":"code","b2a43d9d":"code","636c4b88":"code","4378d922":"code","8f94c31b":"code","05f3a0a6":"code","f70ea262":"code","d154e90a":"code","fb3edaee":"code","f491cbc5":"code","e3be4828":"code","9c5a176a":"code","3a35f289":"code","15f63c34":"code","834ba75a":"code","cbdc44c2":"code","cdb161b6":"code","97141cd9":"code","01e2f333":"markdown","5a4eaf27":"markdown","026d4222":"markdown","dcd5d3a6":"markdown","d5427c3d":"markdown","c8af7e10":"markdown","9a05cf92":"markdown","5262d487":"markdown","d8edc0d0":"markdown"},"source":{"c2edafb3":"%reload_ext autoreload\n%autoreload 2\n%matplotlib inline\n\nfrom fastai.vision import *","d09de282":"bs = 16","935610d2":"path = untar_data(URLs.PETS)\/'images'","b82a231c":"tfms = get_transforms(max_rotate=20, max_lighting=0.4, max_warp=0.4,\n                      p_affine=1., p_lighting=1.)\n","a3e1d085":"doc(get_transforms)","912698f2":"src = ImageItemList.from_folder(path).random_split_by_pct(0.2, seed=2)","a4f354bf":"def get_data(size, bs, padding_mode='reflection'):\n    return (src.label_from_re(r'([^\/]+)_\\d+.jpg$')\n           .transform(tfms, size=size, padding_mode=padding_mode)\n           .databunch(bs=bs).normalize(imagenet_stats))","be8a454c":"data = get_data(224, bs, 'zeros')","1a00ba66":"def _plot(i,j,ax):\n    x,y = data.train_ds[3]\n    x.show(ax, y=y)\n\nplot_multi(_plot, 3, 3, figsize=(8,8))","29257488":"data = get_data(224,bs)","5d57ee25":"plot_multi(_plot, 3, 3, figsize=(8,8))","a7026975":"gc.collect()\nlearn = create_cnn(data, models.resnet34, metrics=error_rate, bn_final=True)","1f034b6b":"learn.fit_one_cycle(3, slice(1e-2), pct_start=0.8)","49e360c8":"learn.unfreeze()\nlearn.fit_one_cycle(2, max_lr=slice(1e-6,1e-3), pct_start=0.8)","64c13935":"data = get_data(224,8) # Error for greater size\nlearn.data = data","48eaffcb":"learn.fit_one_cycle(2, max_lr=slice(1e-6,1e-4))","4914b7e6":"learn.save('352')","686a6b40":"data = get_data(352,16)","04deb185":"learn = create_cnn(data, models.resnet34, metrics=error_rate, bn_final=True).load('352')","44b196e1":"idx=0\nx,y = data.valid_ds[idx]\nx.show()\ndata.valid_ds.y[idx]","8f3e94bb":"k = tensor([\n    [0.  ,-5\/3,1],\n    [-5\/3,-5\/3,1],\n    [1.  ,1   ,1],\n]).expand(1,3,3,3)\/6","efdb8eea":"from fastai.callbacks.hooks import *","a4c3cdca":"k","6f1d75b6":"k.shape","833172de":"t = data.valid_ds[0][0].data; t.shape","b3f33ac8":"t[None].shape","db68280f":"edge = F.conv2d(t[None], k)","e342bd74":"show_image(edge[0], figsize=(5,5));","8110ccaa":"data.c","338f87e4":"learn.model","4b6422b8":"learn.summary()","433fcf4e":"m = learn.model.eval();","90271ad7":"xb,_ = data.one_item(x)\nxb_im = Image(data.denorm(xb)[0])\nxb = xb.cuda()","5c137ebd":"from fastai.callbacks.hooks import *","26a2d0bd":"def hooked_backward(cat=y):\n    with hook_output(m[0]) as hook_a: \n        with hook_output(m[0], grad=True) as hook_g:\n            preds = m(xb)\n            preds[0,int(cat)].backward()\n    return hook_a,hook_g","ff8863ce":"hook_a,hook_g = hooked_backward()","b2a43d9d":"acts  = hook_a.stored[0].cpu()\nacts.shape","636c4b88":"avg_acts = acts.mean(0)\navg_acts.shape","4378d922":"def show_heatmap(hm):\n    _,ax = plt.subplots()\n    xb_im.show(ax)\n    ax.imshow(hm, alpha=0.6, extent=(0,352,352,0),\n              interpolation='bilinear', cmap='magma');","8f94c31b":"show_heatmap(avg_acts)","05f3a0a6":"grad = hook_g.stored[0][0].cpu()\ngrad_chan = grad.mean(1).mean(1)\ngrad.shape,grad_chan.shape","f70ea262":"mult = (acts*grad_chan[...,None,None]).mean(0)","d154e90a":"show_heatmap(mult)","fb3edaee":"fn = path\/'..\/other\/bulldog_maine.jpg'","f491cbc5":"x = open_image(fn); x","e3be4828":"xb,_ = data.one_item(x)\nxb_im = Image(data.denorm(xb)[0])\nxb = xb.cuda()","9c5a176a":"hook_a,hook_g = hooked_backward()","3a35f289":"acts = hook_a.stored[0].cpu()\ngrad = hook_g.stored[0][0].cpu()\n\ngrad_chan = grad.mean(1).mean(1)\nmult = (acts*grad_chan[...,None,None]).mean(0)","15f63c34":"show_heatmap(mult)","834ba75a":"data.classes[0]","cbdc44c2":"hook_a,hook_g = hooked_backward(0)","cdb161b6":"acts = hook_a.stored[0].cpu()\ngrad = hook_g.stored[0][0].cpu()\n\ngrad_chan = grad.mean(1).mean(1)\nmult = (acts*grad_chan[...,None,None]).mean(0)","97141cd9":"show_heatmap(mult)","01e2f333":"## Data augmentation","5a4eaf27":"## Train a model","026d4222":"## fin","dcd5d3a6":"## Grad-CAM","d5427c3d":"## Heatmap","c8af7e10":"Paper: [Grad-CAM: Visual Explanations from Deep Networks via Gradient-based Localization](https:\/\/arxiv.org\/abs\/1610.02391)","9a05cf92":"## Convolution kernel","5262d487":"# Lesson 6: pets revisited","d8edc0d0":"[Lesson Video Link](https:\/\/course.fast.ai\/videos\/?lesson=6)\n\n[Lesson resources and updates](https:\/\/forums.fast.ai\/t\/lesson-6-official-resources-and-updates\/31441)\n\n[Lesson chat](https:\/\/forums.fast.ai\/t\/lesson-6-in-class-discussion\/31440)\n\n[Further discussion thread](https:\/\/forums.fast.ai\/t\/lesson-6-advanced-discussion\/31442)\n\nNote: This is a mirror of the FastAI Lesson 6 Nb. \nPlease thank the amazing team behind fast.ai for creating these, I've merely created a mirror of the same here\nFor complete info on the course, visit course.fast.ai"}}