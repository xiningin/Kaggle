{"cell_type":{"5a4243fd":"code","d4f5c702":"code","21de9b6a":"code","ae38a340":"code","2afafae2":"code","a9a9affd":"code","5c3dca5c":"code","bc82f59c":"markdown","c42ed067":"markdown"},"source":{"5a4243fd":"import warnings\nwarnings.filterwarnings('ignore')\nimport pandas as pd\nimport numpy as np\nimport dask.dataframe as dd\npd.set_option('display.max_columns', 500)\npd.set_option('display.max_rows', 500)\nimport matplotlib.pyplot as plt\nimport seaborn as sns\nimport lightgbm as lgb\nimport dask_xgboost as xgb\nimport dask.dataframe as dd\nfrom sklearn import preprocessing, metrics\nimport gc\nimport os\nimport pickle\nfor dirname, _, filenames in os.walk('\/kaggle\/input'):\n    for filename in filenames:\n        print(os.path.join(dirname, filename))","d4f5c702":"%%time\nsales_train_validation_dtype = {'id': np.dtype('O'),\n 'item_id': np.dtype('O'),\n 'dept_id': np.dtype('O'),\n 'cat_id': np.dtype('O'),\n 'store_id': np.dtype('O'),\n 'state_id': np.dtype('O')}\n\nfor i in range(1, 1914):\n    sales_train_validation_dtype['d_'+str(i)] = np.int16\n    \n    \nsell_prices_dtype = {'store_id': np.dtype('O'),\n                     'item_id': np.dtype('O'),\n                     'wm_yr_wk': np.dtype('int16'),\n                     'sell_price': np.dtype('float16')}\n\ncalendar_dtype = {'date': np.dtype('O'),\n                 'wm_yr_wk': np.dtype('int16'),\n                 'weekday': np.dtype('O'),\n                 'wday': np.dtype('int8'),\n                 'month': np.dtype('int8'),\n                 'year': np.dtype('int16'),\n                 'd': np.dtype('O'),\n                 'event_name_1': np.dtype('O'),\n                 'event_type_1': np.dtype('O'),\n                 'event_name_2': np.dtype('O'),\n                 'event_type_2': np.dtype('O'),\n                 'snap_CA': np.dtype('int8'),\n                 'snap_TX': np.dtype('int8'),\n                 'snap_WI': np.dtype('int8')}    \n\nsales_train_validation = pd.read_csv('\/kaggle\/input\/m5-forecasting-accuracy\/sales_train_validation.csv', \n                                    dtype=sales_train_validation_dtype)\ncalendar = pd.read_csv('\/kaggle\/input\/m5-forecasting-accuracy\/calendar.csv',\n                      dtype=calendar_dtype)\nsell_prices = pd.read_csv('\/kaggle\/input\/m5-forecasting-accuracy\/sell_prices.csv',\n                         dtype=sell_prices_dtype)\nsubmission = pd.read_csv('\/kaggle\/input\/m5-forecasting-accuracy\/sample_submission.csv')\n\nprint(sales_train_validation.info(verbose=False), \n      calendar.info(verbose=False), sell_prices.info(verbose=False), submission.info(verbose=False))","21de9b6a":"# Standarsize the data\nsales_train_validation['id'] = sales_train_validation['id'].apply(lambda x:'_'.join(x.split('_')[:-1]))\nsubmission['id'] = submission['id'].apply(lambda x:'_'.join(x.split('_')[:-1]))\n\n# Convert columns 'd_n' to n as well as the column 'd' in calendar\nday_map = {'d_'+str(i):i for i in range(1, 1970)}\nsales_train_validation = sales_train_validation.rename(columns=day_map)\ncalendar['d'] = calendar['d'].apply(lambda x:day_map[x]).astype(np.int16)\n","ae38a340":"train_cat_cols = ['id', 'item_id', 'dept_id', 'cat_id', 'store_id', 'state_id']\ncalendar_cat_cols = ['weekday', 'event_name_1', 'event_name_2', 'event_type_1', 'event_type_2']\n\ntrain_lbl_encoders = {}\nfor col in train_cat_cols:\n    lbl = preprocessing.LabelEncoder()\n    if col in ['item_id', 'id']:\n        sales_train_validation[col] = lbl.fit_transform(sales_train_validation[col].fillna('UNK')).astype(np.int16)\n    else:\n        sales_train_validation[col] = lbl.fit_transform(sales_train_validation[col].fillna('UNK')).astype(np.int8)\n    train_lbl_encoders[col] = lbl\n\ncalendar_lbl_encoders = {}    \nfor col in calendar_cat_cols:\n    lbl = preprocessing.LabelEncoder()\n    calendar[col] = lbl.fit_transform(calendar[col].fillna('UNK')).astype(np.int8)\n    train_lbl_encoders[col] = lbl\n\nfor col in ['store_id', 'item_id']:\n    sell_prices[col] = train_lbl_encoders[col].transform(sell_prices[col].fillna('UNK'))\n    \npickle.dump(train_lbl_encoders, open('train_lbl_encoders.pkl', 'wb'))\npickle.dump(calendar_lbl_encoders, open('calendar_lbl_encoders.pkl', 'wb'))\npickle.dump(day_map, open('day_map.pkl', 'wb'))\n\n# Unique products\nproduct = sales_train_validation[['id', 'item_id', 'dept_id', 'cat_id', 'store_id', 'state_id']].drop_duplicates()\n\n# Added validation\/ evaluation days\nfor i in range(1914, 1970):\n    sales_train_validation[i] = 0","2afafae2":"# Date-time features\ncalendar['date'] = pd.to_datetime(calendar['date'])\ncalendar['week'] = calendar['date'].dt.week.astype(np.int8)\ncalendar['day'] = calendar['date'].dt.day.astype(np.int8)\ncalendar.drop(['weekday'], axis=1, inplace=True)\ncalendar.head()","a9a9affd":"\n%%time\nsales_train_validation = pd.melt(sales_train_validation,\n                                    id_vars = ['id', 'item_id', 'dept_id', 'cat_id', 'store_id', 'state_id'],\n                                    var_name='d', value_name='sales')\nsales_train_validation['d'] = sales_train_validation['d'].astype(np.int16)\nsales_train_validation['sales'] = sales_train_validation['sales'].astype(np.int16)\n\nsales_train_validation = pd.merge(sales_train_validation, \n                                  calendar, \n                                  how='left', \n                                  on='d')\n\nsales_train_validation = pd.merge(sales_train_validation,\n                                  sell_prices, \n                                  on=['store_id', 'item_id', 'wm_yr_wk'], \n                                  how = 'left')\nprint(sales_train_validation.info())","5c3dca5c":"del sell_prices, calendar","bc82f59c":"## Label encoding categorical features","c42ed067":"## Using predefined dtypes to reduce memory usage"}}