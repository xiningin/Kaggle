{"cell_type":{"5a58eb2d":"code","2ca1e10c":"code","bf8e7bba":"code","d4b6acfd":"code","6df43003":"code","7a17dc09":"code","83bfac7d":"code","da44233e":"code","87b2fe4b":"code","23bb6b5b":"code","5fe72b54":"code","0cc39faa":"code","e8e3f9e8":"code","2672eba6":"code","9c4da1c9":"markdown","e14d377f":"markdown","0140e9bc":"markdown","3fb97f1a":"markdown","d7668795":"markdown","26f1a0cf":"markdown","1b5683eb":"markdown","258d9e78":"markdown","65527a06":"markdown","253852d5":"markdown"},"source":{"5a58eb2d":"import os\nimport cv2\nimport numpy as np\nimport pandas as pd\nimport matplotlib.pyplot as plt\nfrom sklearn.model_selection import train_test_split\nimport tensorflow as tf\nfrom tensorflow.keras.layers import *\nfrom tensorflow.keras.applications import ResNet50, ResNet101, ResNet152\nfrom tqdm import tqdm","2ca1e10c":"SEED = 42\nEPOCHS = 50\nBATCH_SIZE = 32 \nIMG_SIZE = 256\nROOT = '..\/input\/flower-color-images\/flower_images\/flower_images\/'\n\ndf = pd.read_csv(ROOT + 'flower_labels.csv')","bf8e7bba":"def seed_everything(seed):\n    np.random.seed(seed)\n    os.environ['PYTHONHASHSEED'] = str(seed)\n    tf.random.set_seed(seed)\n\nseed_everything(SEED)","d4b6acfd":"df = df.replace({0:'phlox',1:'rose',2:'calendula',3:'iris',4:'leucanthemum maximum',\n                 5:'bellflower',6:'viola',7:'rudbeckia laciniata',\n                 8:'peony',9:'aquilegia'})","6df43003":"df.head()","7a17dc09":"df.label.value_counts().plot.bar()","83bfac7d":"def img_plot(df):\n    imgs = []\n    labels = []\n    df = df.sample(frac=1)\n    for file, label in zip(df['file'][:25], df['label'][:25]):\n        img = cv2.imread(ROOT+file)\n        img = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)\n        imgs.append(img)\n        labels.append(label)\n    f, ax = plt.subplots(5, 5, figsize=(15,15))\n    for i, img in enumerate(imgs):\n        ax[i\/\/5, i%5].imshow(img)\n        ax[i\/\/5, i%5].axis('off')\n        ax[i\/\/5, i%5].set_title(labels[i])\n    plt.show()\n\nimg_plot(df)","da44233e":"train_df, test_df = train_test_split(df, \n                                     test_size=0.5, \n                                     random_state=SEED, \n                                     stratify=df['label'].values)\n\n\n\ndef create_datasets(df, img_size):\n    imgs = []\n    for file in tqdm(df['file']):\n        img = cv2.imread(ROOT+file)\n        img = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)\n        img = cv2.resize(img, (img_size,img_size))\n        imgs.append(img)\n    # not normalize    \n    imgs = np.array(imgs)\n    df = pd.get_dummies(df['label'])\n    return imgs, df\n\n\ntrain_imgs, train_df = create_datasets(train_df, IMG_SIZE)\ntest_imgs, test_df = create_datasets(test_df, IMG_SIZE)","87b2fe4b":"num_classes = len(df.label.value_counts())\n\ndef build_model(ResNet, img_size, n):\n    inp = Input(shape=(img_size,img_size, n))\n    resnet = ResNet(input_shape=(img_size,img_size,n),\n                    weights='imagenet',\n                    include_top=False)\n    # freeze ResNet\n    resnet.trainable = False\n    x = resnet(inp)\n    x = GlobalAveragePooling2D()(x)\n    x = Dropout(0.5)(x)\n    x = Dense(num_classes, activation='softmax')(x)\n    model = tf.keras.Model(inputs=inp, outputs=x)\n    model.compile(optimizer='adam', loss='categorical_crossentropy', metrics=['accuracy'])\n    return model\n\n\nresnet50 = build_model(ResNet50, IMG_SIZE, 3)\nresnet50.summary()","23bb6b5b":"checkpoint = tf.keras.callbacks.ModelCheckpoint('resnet50.h5', \n                                                monitor='loss', \n                                                save_best_only=True,\n                                                save_weights_only=True)\n\nresnet50.fit(train_imgs, train_df, batch_size=BATCH_SIZE,\n          epochs=EPOCHS, verbose=0, callbacks=[checkpoint])\nresnet50.load_weights('resnet50.h5')\n\n\nresnet50.evaluate(test_imgs, test_df)","5fe72b54":"resnet101 = build_model(ResNet101, IMG_SIZE, 3)\nresnet101.summary()","0cc39faa":"checkpoint = tf.keras.callbacks.ModelCheckpoint('resnet101.h5', \n                                                monitor='loss', \n                                                save_best_only=True,\n                                                save_weights_only=True)\n\nresnet101.fit(train_imgs, train_df, batch_size=BATCH_SIZE,\n              epochs=EPOCHS, verbose=0, callbacks=[checkpoint])\nresnet101.load_weights('resnet101.h5')\n\nresnet101.evaluate(test_imgs, test_df)","e8e3f9e8":"resnet152 = build_model(ResNet152, IMG_SIZE, 3)\nresnet152.summary()","2672eba6":"checkpoint = tf.keras.callbacks.ModelCheckpoint('resnet152.h5', \n                                                monitor='loss', \n                                                save_best_only=True,\n                                                save_weights_only=True)\n\nresnet152.fit(train_imgs, train_df, batch_size=BATCH_SIZE,\n              epochs=EPOCHS, verbose=0, callbacks=[checkpoint])\nresnet152.load_weights('resnet152.h5')\n\nresnet152.evaluate(test_imgs, test_df)","9c4da1c9":"## Import libraries","e14d377f":"## Set configurations and read metadata","0140e9bc":"### Using ResNet101","3fb97f1a":"## Plot images","d7668795":"### Using ResNet152","26f1a0cf":"## Build the model","1b5683eb":"## Create datasets","258d9e78":"Here is an example implementation using a small image dataset. There are 210 images and 10 classes in this dataset.\n\nThanks to [Olga Belitskaya] for publishing this dataset.\n\n[Olga Belitskaya]: https:\/\/www.kaggle.com\/olgabelitskaya","65527a06":"<h1><font size=\"6\">Classification of small datasets using ResNet<\/font><\/h1>","253852d5":"### Using ResNet50"}}