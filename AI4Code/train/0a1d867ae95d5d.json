{"cell_type":{"0f8f04f4":"code","9d2acad5":"code","5e9958b6":"code","dd0bab80":"code","67a04ec1":"code","2b10062f":"code","338bc4a7":"code","f393e78a":"code","4d0ea632":"code","0041351b":"code","e42f4508":"code","2b5c2e8d":"code","118bdc72":"code","9dd0819d":"code","875bec22":"code","30aa64e2":"code","9feee94d":"markdown","4e312d14":"markdown","38a0dc5e":"markdown","cbe185dd":"markdown","c7afea33":"markdown","2dd87b10":"markdown","0d443ac3":"markdown","c5ef21c1":"markdown"},"source":{"0f8f04f4":"import pandas as pd\n%pylab inline","9d2acad5":"ods = pd.read_csv('..\/input\/overdoses.csv')\ncleanNum = lambda n: int(n.replace(',', ''))\nods['Deaths'] = ods['Deaths'].map(cleanNum)\nods['Population'] = ods['Population'].map(cleanNum)\nods.head()","5e9958b6":"# deaths per capita?\nods['deaths_per_capita'] = ods['Deaths'] \/ ods['Population']\nods = ods.sort(['deaths_per_capita'])\n\nax = plt.subplot(111)\nods.deaths_per_capita.plot(\nkind='bar',\nfigsize=(12,3),\ntitle=\"Opioid-related deaths per capita\",\n)\nax.axis('off')\nfor i, x in enumerate(ods['Abbrev']):\n    ax.text(i-1 + 0.7, 0, x, rotation='45')","dd0bab80":"ps = pd.read_csv('..\/input\/prescriber-info.csv')\n# ps.head()","67a04ec1":"import xgboost as xgb\ndef cv (alg,X,y):\n    metrics = ['auc', 'map']\n    xgtrain = xgb.DMatrix(X,y)\n    param = alg.get_xgb_params()\n    cvresult = xgb.cv(param,\n                      xgtrain,\n                      num_boost_round=alg.get_params()['n_estimators'],\n                      nfold=7,\n                      metrics=metrics,\n                      early_stopping_rounds=50)\n    alg.set_params(n_estimators=cvresult.shape[0])\n    #Predict training set:\n    alg.fit(X,y,eval_metric=metrics)\n    # Show features, rated by fscore\n    features = alg.booster().get_fscore()\n    feat_imp = pd.Series(features).sort_values(ascending=False)\n    feat_imp[:50].plot(kind='bar', title='Feature Importances', figsize=(9,6))\n    plt.ylabel('Feature Importance Score')\n    # sort for human readability\n    import operator\n    sorted_features = sorted(features.items(), key=operator.itemgetter(1))\n    print('features by importance', sorted_features)\n    return features, cvresult","2b10062f":"ps.head()","338bc4a7":"ps.dtypes\n#the dypes are ints and objects.\n#the other analysis, the main one said credentials were a mess and didn't tell us anything that specialty didn't.\n#I will want to break down some code about opiod prescriber and find out what percentage of doctors are","f393e78a":"ps.shape\n#I think that's 256 drugs prescribed?","4d0ea632":"dentists = ps[ps['Specialty'] == 'Dentist']\n\ndentists['Gender'] = pd.get_dummies(dentists['Gender'])\n\ntarget = 'Opioid.Prescriber'\nX = dentists.drop(['NPI', 'Specialty', 'Credentials', 'State', target], 1)\ny = dentists[target]\n(X.shape, y.shape)","0041351b":"from sklearn.model_selection import train_test_split\nalg = xgb.XGBClassifier(\n        learning_rate =0.1,\n        n_estimators=1000,\n        max_depth=4,\n        min_child_weight=1,\n        gamma=0,\n        subsample=0.8,\n        colsample_bytree=0.8,\n        nthread=4,\n        objective=\"binary:logistic\",\n        scale_pos_weight=1,\n        seed=27) \n\nX_train, X_test, y_train, y_test = train_test_split(\n    X, y, test_size=0.33, random_state=42)\n\nfeatures, cvresults = cv(alg,X_train,y_train)\ncvresults[-3:]","e42f4508":"from sklearn import metrics\npred = alg.predict(X_test)\npredprob = alg.predict_proba(X_test)[:,1]\n#Print model report:\nprint(\"Accuracy : %.4g\" % metrics.accuracy_score(y_test, pred))\nprint(\"AUC Score (Train): %f\" % metrics.roc_auc_score(y_test, predprob))","2b5c2e8d":"mean_dentists = dentists.groupby('Opioid.Prescriber').mean()\nrelevant_stats = [mean_dentists[feature] for feature in features]\npd.DataFrame(relevant_stats).plot(kind=\"bar\")","118bdc72":"features","9dd0819d":"non_opioid_features = [ 'State', 'Gender', 'AMOXICILLIN', 'IBUPROFEN', 'AZITHROMYCIN', 'DOXYCYCLINE.HYCLATE', 'CHLORHEXIDINE.GLUCONATE', 'CEPHALEXIN']","875bec22":"from sklearn.preprocessing import LabelEncoder\nseries = {}\nfor feature in non_opioid_features:\n    series[feature] = dentists[feature]\nX = pd.DataFrame(series)\nle = LabelEncoder()\nle.fit(X['State'])\nX['State'] = le.transform(X['State'])\ny = dentists[target]\n(X.shape, y.shape)","30aa64e2":"from sklearn.model_selection import train_test_split\n\nX_train, X_test, y_train, y_test = train_test_split(\n    X, y, test_size=0.33, random_state=43)\n\nalg = xgb.XGBClassifier(\n        learning_rate =0.1,\n        n_estimators=1000,\n        max_depth=8,\n        min_child_weight=1,\n        gamma=1,\n        subsample=0.8,\n        colsample_bytree=0.8,\n        objective=\"binary:logistic\",\n        scale_pos_weight=1,\n        seed=27) \n\nfeatures, cvresults = cv(alg,X_train,y_train)\n#cvresults[-3:]\n\npred = alg.predict(X_test)\npredprob = alg.predict_proba(X_test)[:,1]\n#Print model report:\nprint(\"Accuracy : %.4g\" % metrics.accuracy_score(y_test, pred))\nprint(\"AUC Score (test): %f\" % metrics.roc_auc_score(y_test, predprob))","9feee94d":"# Predicting stuff\nsetting up some xgboost infra","4e312d14":"# Using non-opioid features\n\nAs Alan (AJ) Pryor, Jr. pointed out, some of these features are actually opioids (shows what I know...). so, if we prune to only those highly informative features that are *not* opioids, how well do we do?","38a0dc5e":"Here is where I want to branch this and print out basics about ps = pd.read_csv('..\/input\/prescriber-info.csv'), do a simple EDA with\n1. Head\n2. Describe\n3. shape\n4. dtypes etc","cbe185dd":"# Dentists\nWe want to control somewhat for profession.\ne.g. spine docs may prescribe opiates at a diff rate from dentists.","c7afea33":"Some of those features are highly predictive of whether or not a dentist is an opioid prescriber. But how do they correlate?","2dd87b10":"Amoxicilin is an antibiotic, so it beats me why that would be so much higher among opiate prescribers.\n\nOne thing is for sure, though - the opiate prescribers are far more likely to prescribe oxycodone-acetaminophen.","0d443ac3":"We can predict quite well whet or not a doctor is an opiate prescriber based on their prescription history. This makes sense, since the prescriber label is based on prescription history. But, perhaps this model could be used for early detection of doctors too willing to give out prescriptions.\n\nNow, for those features that were highly predictive - how do they correlate with prescriber label?","c5ef21c1":"In this notebook, I look at what prescribing behaviors among dentists predict the \"opiate prescriber\" label in the dataset. Perhaps this could help early detection of dentists too happy to prescribe opiates.\n\nSee below for characteristic prescriptions of opiate-prescribing dentists.\n "}}