{"cell_type":{"a550aaf4":"code","8e7bf95d":"code","ef854e60":"code","c4c7b859":"code","f2b579cb":"code","9ff8196f":"code","5396098a":"code","c754ae9f":"code","62ad4b09":"code","a5580c28":"code","4ac18a27":"code","1893e37d":"code","df65c17e":"code","fad11f20":"code","77f982af":"code","328ed993":"code","e0aaec0d":"code","dbf8ac14":"code","c9466ed4":"code","b7495ea7":"code","52a57fc2":"code","d28122c1":"code","40160940":"code","aa63bd40":"code","94a670cf":"code","c20cfe66":"code","55b79360":"code","c463756e":"code","e488690e":"code","6a641709":"code","1755ff91":"code","21a23108":"code","6ed8e00d":"code","6c3ae320":"code","3ae0a1e8":"markdown","74180f9e":"markdown","aa307152":"markdown"},"source":{"a550aaf4":"import datetime as dt\nimport pandas as pd\nimport matplotlib.pyplot as plt","8e7bf95d":"from lifetimes import BetaGeoFitter\nfrom lifetimes import GammaGammaFitter\nfrom lifetimes.plotting import plot_period_transactions\nfrom sqlalchemy import create_engine","ef854e60":"!pip install lifetimes","c4c7b859":"pd.set_option('display.max_columns', None)\npd.set_option('display.width', 500)\npd.set_option('display.float_format', lambda x: '%.4f' % x)\nfrom sklearn.preprocessing import MinMaxScaler\n","f2b579cb":"!pip install lifetimes","9ff8196f":"def outlier_thresholds(dataframe, variable):\n    quartile1 = dataframe[variable].quantile(0.01)\n    quartile3 = dataframe[variable].quantile(0.99)\n    interquantile_range = quartile3 - quartile1\n    up_limit = quartile3 + 1.5 * interquantile_range\n    low_limit = quartile1 - 1.5 * interquantile_range\n    return low_limit, up_limit","5396098a":"def replace_with_thresholds(dataframe, variable):\n    low_limit, up_limit = outlier_thresholds(dataframe, variable)\n    dataframe.loc[(dataframe[variable] < low_limit), variable] = low_limit\n    dataframe.loc[(dataframe[variable] > up_limit), variable] = up_limit","c754ae9f":"df_ =pd.read_csv(\"..\/input\/online-retail-ii-data-set-from-ml-repository\/Year 2010-2011.csv\",encoding='unicode_escape')","62ad4b09":"df_.head()\ndf=df_.copy()\ndf.shape","a5580c28":"#Sadece UK dekiler\nnew_df=df[(df[\"Country\"]== \"United Kingdom\")]\nnew_df.describe().T\nnew_df.head()","4ac18a27":"# Verinin Veri Taban\u0131ndan Okunmas\u0131\ncreds = {'user': 'synan_dsmlbc',\n         'passwd': 'haydegidelum',\n         'host': '34.91.75.155',\n         'port': 3306,\n         'db': 'synan_dsmlbc_db',\n        'auth_plugin' : 'mysql_native_password'\n}","1893e37d":"connstr = 'mysql+mysqlconnector:\/\/{synan_dsmlbc}:{haydegidelum}@{34.91.75.155}:{3306}\/{synan_dsmlbc_db}' #to sql kullanmas\u0131 kolay oldu\u011fu i\u00e7in\nconn = create_engine(connstr.format(**creds))\n\npd.read_sql_query(\"show databases;\", conn)\npd.read_sql_query(\"show tables\", conn)\n","df65c17e":"# top 10 ile veri setimize bakal\u0131m :\nimport pandas as pd\npd.read_sql_query(\"select * from online_retail_2010_2011 limit 10\", conn)","fad11f20":"#Veri \u00d6n \u0130\u015fleme yapal\u0131m;\nnew_df.dropna(inplace=True)\nnew_df = new_df[~new_df[\"Invoice\"].str.contains(\"C\", na=False)]\nnew_df = new_df[new_df[\"Quantity\"] > 0]\nnew_df = new_df[new_df[\"Price\"] > 0]","77f982af":"replace_with_thresholds(new_df, \"Quantity\")\nreplace_with_thresholds(new_df, \"Price\")\n\nnew_df[\"TotalPrice\"] = new_df[\"Quantity\"] * new_df[\"Price\"]\n\ntoday_date = dt.datetime(2011, 12, 11)\n\nnew_df.describe().T","328ed993":"#Lifetime Veri Yap\u0131s\u0131n\u0131n haz\u0131rlanmas\u0131\n\ncltv_df = new_df.groupby('Customer ID').agg({'InvoiceDate': [lambda date: (date.max() - date.min()).days, #davran\u0131\u015f paterni; ilk ve son i\u015flem aras\u0131nda ge\u00e7en s\u00fcre\n                                                         lambda date: (today_date - date.min()).days], #m\u00fc\u015fterilik ya\u015f\u0131; ilk geldi\u011fi ve son geldi\u011fi\n                                         'Invoice': lambda num: num.nunique(), #ka\u00e7 i\u015flem yapt\u0131\u011f\u0131\n                                         'TotalPrice': lambda TotalPrice: TotalPrice.sum()}) #toplam ciro\n","e0aaec0d":"cltv_df.columns = cltv_df.columns.droplevel(0)\ncltv_df.columns = ['recency', 'T', 'frequency', 'monetary']\n\ncltv_df[\"monetary\"] = cltv_df[\"monetary\"] \/ cltv_df[\"frequency\"]\n\ncltv_df = cltv_df[(cltv_df['frequency'] > 1)] #churn eden leri alm\u0131yoruz tekrarl\u0131 i\u015flem yapan\u0131 bul\n\ncltv_df[\"recency\"] = cltv_df[\"recency\"] \/ 7 #bg-nbd de haftal\u0131k cinsten belirtmek isteniyor\n\ncltv_df[\"T\"] = cltv_df[\"T\"] \/ 7 #m\u00fc\u015fteri ya\u015f\u0131 haftal\u0131k say\u0131s\u0131\n\ncltv_df.head()","dbf8ac14":"#G\u00f6rev1: 6 Ayl\u0131k CLTV Prediction\n\nbgf.predict(6*4, #4 hafta 1 ay yapar\n            cltv_df['frequency'],\n            cltv_df['recency'],\n            cltv_df['T']).sort_values(ascending=False).head(10)\n\n\ncltv_df[\"expected_purc_6_month\"] = bgf.predict(4*6,\n                                               cltv_df['frequency'],\n                                               cltv_df['recency'],\n                                               cltv_df['T'])\n\n\ncltv_df.sort_values(\"expected_purc_6_month\", ascending=False).head(10)","c9466ed4":"\n# Model objesinin tan\u0131mlanmas\u0131: tahmin edilen kazan\u00e7\n\nggf = GammaGammaFitter(penalizer_coef=0.01) #ceza katsay\u0131s\u0131 (penalizer_caef) hata pay\u0131","b7495ea7":"# Modelin kurulmas\u0131:\nggf.fit(cltv_df['frequency'], cltv_df['monetary']) ##uyarlamak(fit etmek)\n\ncltv = ggf.customer_lifetime_value(bgf, #ya\u015fam boyu de\u011feri\n                                   cltv_df['frequency'], #neler g\u00f6rmek istersem onlar\u0131 ekle\n                                   cltv_df['recency'],\n                                   cltv_df['T'],\n                                   cltv_df['monetary'],\n                                   time=6,  # 6 ayl\u0131k, tahminde bulun zaman k\u0131sm\u0131\n                                   freq=\"W\",  # T'nin frekans bilgisi.tahminde bulun zaman k\u0131sm\u0131\n                                   discount_rate=0.01) #indirim oran\u0131 buras\u0131 de\u011fi\u015febilir tahminde bulun zaman k\u0131sm\u0131\n\ncltv.head()","52a57fc2":"cltv = cltv.reset_index()\ncltv.sort_values(by=\"clv\", ascending=False).head(10)\n\ncltv_final = cltv_df.merge(cltv, on=\"Customer ID\", how=\"left\") #soldan ba\u015flayarak customer ID yi birle\u015ftir\n\ncltv_final.sort_values(by=\"clv\", ascending=False).head(10)","d28122c1":"#14088 nolu m\u00fc\u015fterinin M de\u011feri \u00e7ok y\u00fcksek oldu\u011fu halde frekans\u0131 ve expected_purc_6_month  d\u00fc\u015f\u00fck oldu\u011fu\n# i\u00e7in kendisinden daha d\u00fc\u015f\u00fck ciro yaratan m\u00fc\u015fteriden daha altta kalm\u0131\u015ft\u0131r. M\u00fc\u015fteri ya\u015f\u0131nada bak. eksi m\u00fc\u015fteri mi yeni m\u00fc\u015fteri mi? (T)\n#T ayn\u0131 veriye sabitledi\u011finde s\u0131kl\u0131k de\u011feri ne kadara gelir oran orant\u0131 ile bul ve o zaman F k\u0131sm\u0131 ile yorumlayabilirsin","40160940":"scaler = MinMaxScaler(feature_range=(0, 1)) ## CLV \u00e7ok y\u00fcksek oldu\u011funda 0,1 aras\u0131ndaki de\u011ferlere getirirse yorumlama k\u0131sm\u0131 daha kolay olur\nscaler.fit(cltv_final[[\"clv\"]])\ncltv_final[\"scaled_clv\"] = scaler.transform(cltv_final[[\"clv\"]])","aa63bd40":"#S\u0131ralama en k\u0131ymetli m\u00fc\u015fteriler\ncltv_final.sort_values(by=\"scaled_clv\", ascending=False).head()","94a670cf":"##############################################################\n# G\u00f6rev2: CLTV'ye G\u00f6re Segmentlerin Olu\u015fturulmas\u0131\n##############################################################","c20cfe66":"#1 Ay i\u00e7inde en \u00e7ok sat\u0131n alma bekledi\u011fimiz 10 m\u00fc\u015fteri\n\nbgf.predict(4, #4 hafta 1 ay yapar\n            cltv_df['frequency'],\n            cltv_df['recency'],\n            cltv_df['T']).sort_values(ascending=False).head(10)","55b79360":"cltv_df[\"expected_purc_1_month\"] = bgf.predict(4,\n                                               cltv_df['frequency'],\n                                               cltv_df['recency'],\n                                               cltv_df['T'])","c463756e":"cltv_df.sort_values(\"expected_purc_1_month\", ascending=False).head(10)","e488690e":"#12 Ay i\u00e7inde en \u00e7ok sat\u0131n alma yapmas\u0131n\u0131 bekledi\u011fimiz 10 m\u00fc\u015fteri\n\nbgf.predict(4 * 12,\n            cltv_df['frequency'],\n            cltv_df['recency'],\n            cltv_df['T']).sum()\n\ncltv_df[\"expected_purc_12_month\"] = bgf.predict(4*12,\n                                               cltv_df['frequency'],\n                                               cltv_df['recency'],\n                                               cltv_df['T'])","6a641709":"## 1 ayl\u0131k ve 12 ayl\u0131k kar\u015f\u0131la\u015ft\u0131rma\ncltv_df.sort_values(\"expected_purc_12_month\", ascending=False).head(15)\ncltv_df.sort_values(\"expected_purc_1_month\", ascending=False).head(15)\n\n#bende de\u011fi\u015fiklik olmad\u0131 ancak olsayd\u0131 \u015funlardan kaynakl\u0131 olabilir; i\u015flem say\u0131s\u0131 artabilir (d\u00f6nem artt\u0131\u011f\u0131 i\u00e7in) ancak daha d\u00fc\u015f\u00fck M i\u015flemleri yap\u0131lm\u0131\u015ft\u0131r.\n#dolay\u0131s\u0131 ile clv etkileri d\u00fc\u015febilir.","1755ff91":"cltv_final[\"segment\"] = pd.qcut(cltv_final[\"scaled_clv\"], 4, labels=[\"D\", \"C\", \"B\", \"A\"])\n\ncltv_final.head()\n\n\ncltv_final.sort_values(by=\"scaled_clv\", ascending=False).head(10)\n\n\ncltv_final.groupby(\"segment\").agg(\n    {\"count\", \"mean\", \"sum\"})","21a23108":"pd.read_sql_query(\"show databases;\", conn)\npd.read_sql_query(\"show tables\", conn)\npd.read_sql_query(\"select * from online_retail_2010_2011 limit 10\", conn)","6ed8e00d":"cltv_final.head()\n\ncltv_final[\"Customer ID\"] = cltv_final[\"Customer ID\"].astype(int)\n\ncltv_final.to_sql(name='serapgur', con=conn, if_exists='replace', index=False)","6c3ae320":"pd.read_sql_query(\"select * from serapgur limit 10\", conn)","3ae0a1e8":"\u00f6zel hediye \u00e7eki, \u00fcr\u00fcn hediyeleri olabilir, ilk \u00fcr\u00fcnler en \u00f6nce bu kullan\u0131c\u0131lara \u00f6nerilir.\nb segmentinde olup a segmentinde olacak yukar\u0131 \u00e7\u0131kar\u0131labilecek upgrade edebilecek \u00f6rne\u011fin cltv de\u011ferleri en y\u00fcksek olanlara \u00f6zel indirim, bir alana bir bedeva kampanyalar\u0131 yap\u0131labilinir.","74180f9e":"G\u00f6rev3: CLTV'ye G\u00f6re Segmentlerin Olu\u015fturulmas\u0131","aa307152":"G\u00f6rev4: Sonu\u00e7lar\u0131n Veri Taban\u0131na G\u00f6nderilmesi"}}