{"cell_type":{"3412cc87":"code","3c28b239":"code","94b02cb5":"code","321ab905":"code","b8b15578":"code","ec0956a0":"code","b360ef26":"code","3ee2602e":"markdown","dd4f14fd":"markdown","1c850b17":"markdown","a6977055":"markdown","ff253bad":"markdown"},"source":{"3412cc87":"# This Python 3 environment comes with many helpful analytics libraries installed\n# It is defined by the kaggle\/python Docker image: https:\/\/github.com\/kaggle\/docker-python\n# For example, here's several helpful packages to load\n\nimport numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\n\n# Input data files are available in the read-only \"..\/input\/\" directory\n# For example, running this (by clicking run or pressing Shift+Enter) will list all files under the input directory\n\nimport os\n# for dirname, _, filenames in os.walk('\/kaggle\/input'):\n#     for filename in filenames:\n#         print(os.path.join(dirname, filename))\n\n# You can write up to 20GB to the current directory (\/kaggle\/working\/) that gets preserved as output when you create a version using \"Save & Run All\" \n# You can also write temporary files to \/kaggle\/temp\/, but they won't be saved outside of the current session","3c28b239":"import torch\nfrom transformers import TrOCRProcessor, VisionEncoderDecoderModel\nimport requests \nfrom PIL import Image\n\nmodel_path = \"..\/input\/notebook-2-train-trocr-model-3-epochs\/model\/\"\n\ndevice = torch.device(\"cuda\" if torch.cuda.is_available() else \"cpu\")\nprocessor = TrOCRProcessor.from_pretrained(\"microsoft\/trocr-base-handwritten\") \nmodel = VisionEncoderDecoderModel.from_pretrained(model_path).to(device)\n\n## original pretrained model\n# model = VisionEncoderDecoderModel.from_pretrained(\"microsoft\/trocr-base-handwritten\")","94b02cb5":"%%sh\nrm -rf test\ncp -a ..\/input\/inclass-handwritten-digit-recognition\/SmallTest test\nmogrify -resize x100 -auto-threshold Kapur -format jpg test\/*","321ab905":"from IPython.display import display, Image as IImage\n\nprint('Before:')\ndisplay(IImage(filename='..\/input\/inclass-handwritten-digit-recognition\/SmallTest\/1a4545ae6128dab578f90fb22b55758a.png'))\nprint('After:')\ndisplay(IImage(filename='test\/1a4545ae6128dab578f90fb22b55758a.jpg'))","b8b15578":"data_path = 'test\/'\nrs = pd.read_csv(\"..\/input\/inclass-handwritten-digit-recognition\/sample_submission.csv\", dtype={'Id':str, 'Predicted':str})\nrs['file'] = data_path + rs['Id'] + '.jpg'","ec0956a0":"for idx, row in rs.iterrows():\n    image = Image.open(row.file).convert(\"RGB\")\n    pixel_values = processor(image, return_tensors=\"pt\").pixel_values \n    generated_ids = model.generate(pixel_values.to(device), max_length=5)\n    generated_text = processor.batch_decode(generated_ids, skip_special_tokens=True)[0]\n    rs.loc[idx, 'Predicted'] = generated_text\n    print(f'{idx+1}# Predicted: {generated_text}')\n    display(IImage(filename=row.file))","b360ef26":"rs.to_csv('submission.csv', index=False, columns=['Id','Predicted'])\n!cat submission.csv","3ee2602e":"## Preprocess SmallTest with ImageMagick (for demo)","dd4f14fd":"## Predict","1c850b17":"## Prepare submission data (+ path to file)","a6977055":"## Load TrOCR Model + our saved model","ff253bad":"## Write a submission file"}}