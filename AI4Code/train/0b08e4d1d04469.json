{"cell_type":{"cfb931ab":"code","a69c4698":"code","615da04f":"code","3b8317da":"code","680d32a1":"code","2513c89c":"code","e64f70ca":"code","cbd885d9":"code","577fe25d":"code","3e501e36":"code","a02b2dff":"code","d94fdb42":"code","c4eb532f":"code","0f0be160":"code","4ac399b2":"code","2ff9f7ea":"code","cad3c1f8":"code","97ff3712":"code","2c16ec75":"markdown","25c19967":"markdown","b3ba9c81":"markdown","280e86c2":"markdown","04696dee":"markdown","970486bf":"markdown"},"source":{"cfb931ab":"import numpy as np\nimport pandas as pd\n\nfrom numpy import asarray\nfrom pandas import read_csv\nfrom pandas import DataFrame\nfrom pandas import concat\nfrom sklearn.metrics import mean_absolute_error\nfrom sklearn.ensemble import RandomForestRegressor\nfrom xgboost import XGBRegressor\nimport matplotlib.pyplot as plt\n\nfrom tensorflow.keras.models import Sequential\nfrom tensorflow.keras.layers import Flatten, Conv1D\nfrom tensorflow.keras.layers import MaxPooling1D, Dense\n\nimport warnings\nwarnings.filterwarnings('ignore')\n\nfrom pylab import rcParams\nrcParams['figure.figsize'] = 12, 6","a69c4698":"df = pd.read_csv('..\/input\/predict-chargeback-frauds-payment\/df.csv', index_col=0)\ndf = shuffle(df)\ndf.head()","615da04f":"def normalize(df):\n    return (df - df.mean()) \/ df.std()","3b8317da":"df = df[['Card Number', 'Date', 'Amount', 'CBK',]]\n\ncard_numbers_to_idx = { v:k for k,v in enumerate(np.unique(df['Card Number'].values))}\ndf['Card Number'].replace(card_numbers_to_idx, inplace=True)\ndf['Card Number'] = normalize(df['Card Number'])\n\ndf['Date'] = pd.to_datetime(df['Date']).astype(int)\ndf['Date'] = normalize(df['Date'])\n\ndf['Amount'] = normalize(df['Amount'])\n\ndf.replace({'No': 0, 'Yes': 1}, inplace=True)\ndata = df.values","680d32a1":"def series_to_supervised(data, n_in=1, n_out=1, dropnan=True):\n    n_vars = 1 if type(data) is list else data.shape[1]\n    df = DataFrame(data)\n    cols = list()\n    # input sequence (t-n, ... t-1)\n    for i in range(n_in, 0, -1):\n        cols.append(df.shift(i))\n    # forecast sequence (t, t+1, ... t+n)\n    for i in range(0, n_out):\n        cols.append(df.shift(-i))\n    # put it all together\n    agg = concat(cols, axis=1)\n    # drop rows with NaN values\n    if dropnan:\n        agg.dropna(inplace=True)\n    return agg.values","2513c89c":"data = series_to_supervised(data, n_in=6)","e64f70ca":"class RandomForest():\n    def __init__(self):\n        self.n_estimators = 500\n        self.model = RandomForestRegressor(n_estimators=self.n_estimators)\n        \n    def train(self, train):\n        train = asarray(train)\n        X_train, y_train = train[:, :-1], train[:, -1]\n        self.model.set_params(n_estimators=self.n_estimators)\n        self.model.fit(X_train, y_train)\n        self.n_estimators += 500\n    \n    def predict(self, test):\n        yhat = self.model.predict([test])\n        return yhat[0]","cbd885d9":"class Xgboost():\n    def __init__(self):\n        self.n_estimators = 500\n        self.model = XGBRegressor(objective='reg:squarederror',\n                                  n_estimators=500)\n        \n    def train(self, train):\n        train = asarray(train)\n        X_train, y_train = train[:, :-1], train[:, -1]\n        self.model.set_params(n_estimators=self.n_estimators)\n        self.model.fit(X_train, y_train)\n        self.n_estimators += 500\n        \n    def predict(self, test):\n        y_hat = self.model.predict(asarray([test]))\n        return y_hat[0]","577fe25d":"class CNN():\n    def __init__(self):\n        self.n_in, self.n_out = 27, 1\n        self.model = Sequential()\n        self.model.add(Conv1D(filters=64, kernel_size=2, activation='relu'))\n        self.model.add(MaxPooling1D(pool_size=2))\n        self.model.add(Flatten())\n        self.model.add(Dense(50, activation='relu'))\n        self.model.add(Dense(self.n_out))\n        self.model.compile(optimizer='adam', loss='mse')\n        \n    def train(self, train):\n        train = asarray(train)\n    \n        X_train, y_train = train[:, :-1], train[:, -1]\n\n        n_features = X_train.shape[1]\n        X_train = X_train.reshape(len(X_train), self.n_in, 1)\n        \n        self.model.fit(X_train, y_train, epochs=500, verbose=0)\n        \n    def predict(self, test):\n        y_hat = self.model.predict(test.reshape(1, len(test), 1))\n        return y_hat[0][0]","3e501e36":"random_forest = RandomForest()\nxgboost = Xgboost()\ncnn = CNN()","a02b2dff":"def get_models():\n    models = []\n    models.append(('random_forest', random_forest))\n    models.append(('xgboost', xgboost))\n    models.append(('cnn', cnn))\n    return models","d94fdb42":"def train_test_split(data, n_test):\n    return data[:-n_test, :], data[-n_test:, :]\n\ndef training(data, n_test, n_models):\n    preds = [list() for a in range(n_models)]\n    train, test = train_test_split(data, n_test)\n\n    history = [x for x in train]\n    for i in range(len(test)):\n        X_test, y_test = test[i, :-1], test[i, -1]\n        models = get_models()\n        for j, (name, model) in enumerate(models):\n            model.train(history)\n            y_hat = model.predict(X_test)\n            preds[j].append(y_hat)\n            if(i % 2 == 0):\n                print('i:{:3d}, Model:{:13s}, Expected:{:.1f}, Predicted:{:.1f}'\n                      .format(i, name, y_test, y_hat))\n            \n        history.append(test[i])\n    \n    errors = [list() for a in range(n_models)]\n    for i, error in enumerate(errors):\n        errors[i] = mean_absolute_error(test[:, -1], preds[i])\n    return errors, test[:, -1], preds","c4eb532f":"epochs = 2\nmae, y, y_hat = training(data, epochs, 3)","0f0be160":"print('Random Forest MAE: %.3f' % mae[0])\nprint('XGBoost MAE: %.3f' % mae[1])\nprint('CNN MAE: %.3f' % mae[2])","4ac399b2":"fig, axes = plt.subplots(nrows=1, ncols=3, figsize=(12, 5))\naxes[0].set_title(\"Random Forest\")\naxes[0].plot(y, label='Expected')\naxes[0].plot(y_hat[0], label='Predicted')\naxes[0].legend()\naxes[1].set_title(\"XGBoost\")\naxes[1].plot(y, label='Expected')\naxes[1].plot(y_hat[1], label='Predicted')\naxes[1].legend()\naxes[2].set_title(\"CNN\")\naxes[2].plot(y, label='Expected')\naxes[2].plot(y_hat[2], label='Predicted')\naxes[2].legend()\n#fig.tight_layout()","2ff9f7ea":"def predict(models, data, nr_valid):\n    train, test = train_test_split(data, nr_valid)\n    for i in range(len(test)):\n        X_test, y_test = test[i, :-1], test[i, -1]\n        for j, (name, model) in enumerate(models):\n            pred = model.predict(X_test)\n            pred = 1 if pred > 0.5 else 0\n            print('{:1d}) Model Name:{:15s}, Predicted:{:1.3f} - Expected:{:1.3f}'\n                     .format(i+1, name, pred, y_test))","cad3c1f8":"df_valid = df.iloc[:12].copy()\nvalid_data = series_to_supervised(df_valid.values, n_in=6)\ndf_valid","97ff3712":"models = get_models()\npredict(models, valid_data, 6)","2c16ec75":"<h1 id=\"dataset\" style=\"color:#a97828; background:#4dc5ea;\"> \n    <center>Dataset\n        <a class=\"anchor-link\" href=\"#dataset\" target=\"_self\">\u00b6<\/a>\n    <\/center>\n<\/h1>","25c19967":"<h1 id=\"predict\" style=\"color:#a97828; background:#4dc5ea;\"> \n    <center>Predict\n        <a class=\"anchor-link\" href=\"#predict\" target=\"_self\">\u00b6<\/a>\n    <\/center>\n<\/h1>","b3ba9c81":"<div class=\"dataset-header-v2__top-image-container\">\n    <img src=\"https:\/\/storage.googleapis.com\/kaggle-datasets-images\/312305\/633246\/752964d08f6001573444649668b0b011\/dataset-cover.jpg?t=2019-08-22-03-58-44\" class=\"Header_CoverImg-sc-1431b7d ibFJYv\">\n<\/div>","280e86c2":"<h1 id=\"training\" style=\"color:#a97828; background:#4dc5ea;\"> \n    <center>Training\n        <a class=\"anchor-link\" href=\"#training\" target=\"_self\">\u00b6<\/a>\n    <\/center>\n<\/h1>","04696dee":"<h1 id=\"analysis\" style=\"color:#a97828; background:#4dc5ea;\"> \n    <center>Analysis\n        <a class=\"anchor-link\" href=\"#analysis\" target=\"_self\">\u00b6<\/a>\n    <\/center>\n<\/h1>","970486bf":"<h1 id=\"models\" style=\"color:#a97828; background:#4dc5ea;\"> \n    <center>Models\n        <a class=\"anchor-link\" href=\"#models\" target=\"_self\">\u00b6<\/a>\n    <\/center>\n<\/h1>"}}