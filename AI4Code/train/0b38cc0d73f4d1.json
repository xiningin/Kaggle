{"cell_type":{"73c9e2a9":"code","7fdfe67e":"code","3c6ede83":"code","20841a82":"code","2c874317":"code","46d83bf3":"code","4dede1b8":"code","437cb83b":"code","3bda0212":"code","d2891249":"code","2ad0cd97":"code","34dc148e":"code","d1c627a2":"code","3bf2436e":"code","2a44ffba":"code","d3093325":"code","848f735c":"code","23f3a861":"markdown","43eaa860":"markdown","28df3a5a":"markdown","69b1384c":"markdown","521435cd":"markdown","4e5c0976":"markdown","a6d8635a":"markdown","bcdcafe8":"markdown","2802b49c":"markdown","f9bae890":"markdown","7836a7b8":"markdown","c9e30327":"markdown","8f8a060a":"markdown","7cd996db":"markdown","e3ab53f2":"markdown"},"source":{"73c9e2a9":"import pandas as pd\nimport numpy as np\n\nimport seaborn as sns\nimport matplotlib.pyplot as plt\nimport plotly.express as px\n\nimport re\n\nplt.rcParams[\"figure.figsize\"] = (10, 10)\npd.set_option(\"display.max_columns\", None)\n","7fdfe67e":"transfers_raw = pd.read_csv(\"..\/input\/football-transfers-2020\/football_transfers_2021.csv\")\n","3c6ede83":"transfers_raw.head()\n","20841a82":"transfers_raw.info()\n","2c874317":"transfers_raw.age.hist(bins=30)\n","46d83bf3":"counts = transfers_raw.transfer_fee.value_counts().reset_index()\ncounts\n","4dede1b8":"def clean_transfer_fee(dataframe):\n    \"\"\"\n    Function to clean the transfers dataset.\n    First change the format of the age column from float to int and date column to datetime.\n    Then split the transfer fee column in two: transfer_type and transfer_amount.\n    Valid values for transfer_type are: [\"transfer\",\"free transfer\",\"loan\",\"unknown\",\"draft\",\"unknown\"]\n\n    \"\"\"\n    df = dataframe.copy()\n    df = df.assign(date=lambda x: pd.to_datetime(x.date), age=lambda x: x.age.astype(\"uint8\"))\n    x = df.transfer_fee\n    options = [\n        x == \"free transfer\",\n        x.str.contains(\"loan\", flags=re.IGNORECASE, na=False),\n        x == \"?\",\n        x == \"draft\",\n        x == \"-\",\n    ]\n    values = [\"free transfer\", \"loan\", \"unknown\", \"draft\", \"unknown\"]\n    df[\"transfer_type\"] = np.select(options, values, \"transfer\")\n    df[\"transfer_amount\"] = np.where(df.transfer_fee.str.contains(\"\\d+\"), df.transfer_fee, \"-1\")\n    df[\"transfer_amount\"] = df.transfer_amount.fillna(\"-1\").str.extract(r\"(-?\\d+.*$)\")\n    df[\"transfer_amount\"] = df.transfer_amount.str.replace(\n        \"m\", \"*1000000\", regex=False\n    ).str.replace(\"Th.\", \"*1000\", regex=False)\n    df[\"transfer_amount\"] = df.transfer_amount.astype(str).apply(eval)\n    df[\"transfer_amount\"] = df.transfer_amount.replace(-1, np.nan)\n    return df\n","437cb83b":"transfers = transfers_raw.pipe(clean_transfer_fee)\ntransfers.head()\n","3bda0212":"(\n    transfers.assign(month=lambda x: x.date.dt.month)\n    .value_counts(\"month\", sort=False)\n    .reset_index(name=\"n\")\n    .pipe((sns.barplot, \"data\"), x=\"month\", y=\"n\")\n)\nplt.title(\"Which months have the highest number of transfers in 2021?\", size=20)\nplt.ylabel(\"\")\nplt.xlabel(\"Month\", size=20)\n","d2891249":"counts = transfers.value_counts([\"country_dest\", \"league_dest\"]).reset_index()\n\ntop_5_leagues = [\"Italy\", \"England\", \"Spain\", \"France\", \"Germany\"]\n\n(\n    transfers.query(\"country_dest in @top_5_leagues\")\n    .assign(month=lambda x: x.date.dt.month)\n    .value_counts([\"month\", \"country_dest\"], sort=False)\n    .reset_index(name=\"n\")\n    .pipe((sns.barplot, \"data\"), x=\"month\", y=\"n\", hue=\"country_dest\")\n)\nplt.title(\"Which months have the highest number of transfers in 2021?\", size=20)\nplt.ylabel(\"\")\nplt.xlabel(\"Month\", size=20)\n","2ad0cd97":"(\n    transfers.filter([\"country_origin\", \"country_dest\"])\n    .rename(\n        columns={\"country_origin\": \"Country of Origin\", \"country_dest\": \"Country of Destination\"}\n    )\n    .melt(var_name=\"orig_dest\", value_name=\"country\")\n    .dropna()\n    .value_counts([\"orig_dest\", \"country\"])\n    .reset_index(name=\"n\")\n    .groupby(\"orig_dest\")\n    .apply(lambda x: x.nlargest(10, [\"n\"]))\n    .reset_index(drop=True)\n    .pipe(\n        (sns.catplot, \"data\"),\n        x=\"n\",\n        y=\"country\",\n        col=\"orig_dest\",\n        kind=\"bar\",\n        hue=\"country\",\n        sharey=False,\n        col_order=[\"Country of Origin\", \"Country of Destination\"],\n        dodge=False,\n        legend=False,\n    )\n    .set_titles(\"{col_name}\")\n    .set_axis_labels(\"\", \"\")\n)\nplt.suptitle(\"Number of transfers per country in 2021\", y=1.08, size=20)\n","34dc148e":"(\n    transfers.value_counts(\"transfer_type\")\n    .reset_index(name=\"n\")\n    .pipe((sns.barplot, \"data\"), x=\"n\", y=\"transfer_type\")\n)\nplt.title(\"Distribution of transfer type\", size=20)\nplt.ylabel(\"\")\nplt.xlabel(\"Count\", size=17)\n","d1c627a2":"(\n    transfers.query(\"transfer_type == 'transfer'\")\n    .groupby(\"team_dest\")\n    .agg(n=(\"player_name\", \"size\"), avg_fee=(\"transfer_amount\", \"mean\"))\n    .reset_index()\n    .nlargest(10, \"avg_fee\")\n    .pipe(\n        px.bar,\n        x=\"avg_fee\",\n        y=\"team_dest\",\n        title=\"Top 10 teams with the highest average purchase value in 2021<br><sup>Only considering transfers, not loans<\/sup>\",\n        labels={\"team_dest\": \"\", \"avg_fee\": \"Average purchase value\"},\n    )\n    .update_layout(yaxis=dict(autorange=\"reversed\"))\n)\n","3bf2436e":"(\n    transfers.query(\"transfer_type == 'transfer'\")\n    .groupby(\"team_origin\")\n    .agg(n=(\"player_name\", \"size\"), avg_fee=(\"transfer_amount\", \"mean\"))\n    .reset_index()\n    .nlargest(10, \"avg_fee\")\n    .pipe(\n        px.bar,\n        x=\"avg_fee\",\n        y=\"team_origin\",\n        title=\"Top 10 teams with the highest average sell value in 2021<br><sup>Only considering transfers, not loans<\/sup>\",\n        labels={\"team_origin\": \"\", \"avg_fee\": \"Average sell value\"},\n    )\n    .update_layout(yaxis=dict(autorange=\"reversed\"))\n)\n","2a44ffba":"(\n    transfers.query(\"country_dest in @top_5_leagues\")\n    .rename(columns={\"country_dest\": \"Country of destination\"})\n    .pipe(\n        (sns.displot, \"data\"),\n        x=\"age\",\n        discrete=True,\n        hue=\"Country of destination\",\n        stat=\"density\",\n        common_norm=False,\n        kind=\"hist\",\n        col=\"Country of destination\",\n        legend=False,\n    )\n)\n","d3093325":"fig, ax = plt.subplots(figsize=(15, 10))\n(\n    transfers.query(\"country_dest in @top_5_leagues\")\n    .rename(columns={\"country_dest\": \"Country of destination\"})\n    .pipe((sns.kdeplot, \"data\"), x=\"age\", hue=\"Country of destination\", common_norm=False, ax=ax)\n)\n","848f735c":"(\n    transfers.query(\"country_dest in @top_5_leagues\")\n    .groupby(\"country_dest\")[\"age\"]\n    .mean()\n    .reset_index()\n)\n","23f3a861":"### What is the distribution of the transfer types?","43eaa860":"### Which months have the highest number of transfers in 2021?","28df3a5a":"### Which teams have the highest average (mean) sell values?","69b1384c":"# Load data and required libraries","521435cd":"### What is the distribution of the ages of the transfered players in the top 5 leagues?","4e5c0976":"After some analysis, we see that if there is a numeric value in the transfers_fee column it will be in Euros (\u20ac) currency, that's important because there is no need to transform any numeric value from one currency to another.\n\nNow let's write a function that performs all the required cleaning steps","a6d8635a":"We can see in these two plots that Italy and Germany tend to transfer players of lower ages than England, France and Spain","bcdcafe8":"# Cleaning the data","2802b49c":"### Which countries have the highest number of transfers of 2021?\n\nTop 10 countries with highest count within origin and destination","f9bae890":"I leave the original transfer_fee column as a reference, since visually is easier to read the amount of the transfer in the formatted string\n\nWith our claned data, we can start with the exploratory data analysis\n\n# Exploratory Data Analysis","7836a7b8":"We can see that most of the transfers are free, and the second most common value in unknown, which means that we don't have a transfer fee for these cases","c9e30327":"Now let's analyze the **transfer_fee** column","8f8a060a":"This makes sense, since the two biggest markets are in summer and winter\n\nLet's explore the numbers of the top 5 leagues:","7cd996db":"The first steps in the cleaning process will be to format data types:\n*   The date column to datetime\n*   The age column to integer","e3ab53f2":"### Which teams have the highest average (mean) purchase values?"}}