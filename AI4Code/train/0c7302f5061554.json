{"cell_type":{"b51ea440":"code","1effe593":"code","33bad308":"code","36115728":"code","fc7f32ad":"code","e16855aa":"code","cb1bed01":"code","102cd51a":"code","c74f5434":"code","b743f298":"code","36e630a4":"code","604b5334":"code","b05e9d4c":"code","13cab76e":"code","dc717ce3":"code","81908c67":"code","8e0b7c34":"code","f1877b94":"code","bc281c12":"code","01503efc":"code","31bfaf05":"markdown","00796cd9":"markdown","ff6629d6":"markdown","e9492e9d":"markdown","470e98bc":"markdown","8d937fbe":"markdown","55f335c4":"markdown","2fb38590":"markdown","abc520fb":"markdown","3fe9b4e4":"markdown","5c9d04d8":"markdown","4da29feb":"markdown","4daf2dfe":"markdown","c73a7cff":"markdown","2f2b15c2":"markdown","ddc4b1a7":"markdown","7730e43c":"markdown","9c81900a":"markdown","d248a60b":"markdown","3aed6074":"markdown","cbf8fd4d":"markdown","ea2310cd":"markdown","5b8c96a5":"markdown","1fa709f5":"markdown","3d153c9b":"markdown","5f2feff6":"markdown","144c43d6":"markdown","7d1745ca":"markdown"},"source":{"b51ea440":"import numpy as np \nimport matplotlib.pyplot as plt\nfrom PIL import Image\n\n%matplotlib inline\nim = Image.open(\"..\/input\/coef-pic\/coef.png\")\n\nplt.figure(figsize=(10, 10), dpi=50)\nim_list = np.asarray(im)\nplt.imshow(im_list)\nplt.show()","1effe593":"import pandas as pd\nimport seaborn as sns\n\nimport plotly.figure_factory as ff\nimport plotly.express as px\n\nfrom sklearn.metrics import roc_auc_score, roc_curve, auc","33bad308":"def get_var_name(var):\n    for k,v in globals().items():\n        if id(v) == id(var):\n            name=k\n    return name","36115728":"def ensembling(main, support, coef1, coef2, coef3, coef4, coef5, coef6, coef7, coef8):\n    \n    main_name = get_var_name(locals().get('main'))\n    supp_name = get_var_name(locals().get('support'))\n    \n    mod_a  = main.copy()\n    mod_av = mod_a.values\n    \n    mod_b  = support.copy()\n    mod_bv = mod_b.values    \n              \n    ense  = main.copy()\n    ense_v = ense.values\n \n    for i in range (len(main)):       \n        diff = mod_bv[i, 1] - mod_av[i, 1]\n        pred_a = mod_av[i, 1]       \n        pred_b = mod_bv[i, 1] \n        \n        if ((pred_a < 0.25) & (diff >= 0)):        \n            pred = (pred_a * coef1) + (pred_b * (1.0 - coef1))\n\n        elif ((pred_a < 0.25) & (diff < 0)):        \n            pred = (pred_a * coef2) + (pred_b * (1.0 - coef2))\n            \n        elif ((pred_a >= 0.25) & (pred_a < 0.5) & (diff >= 0)):        \n            pred = (pred_a * coef3) + (pred_b * (1.0 - coef3))\n\n        elif ((pred_a >= 0.25) & (pred_a < 0.5) & (diff < 0)):        \n            pred = (pred_a * coef4) + (pred_b * (1.0 - coef4))   \n                      \n        elif ((pred_a >= 0.5) & (pred_a < 0.75) & (diff >= 0)):        \n            pred = (pred_a * coef5) + (pred_b * (1.0 - coef5))\n\n        elif ((pred_a >= 0.5) & (pred_a < 0.75) & (diff < 0)):        \n            pred = (pred_a * coef6) + (pred_b * (1.0 - coef6))\n            \n        elif ((pred_a >= 0.75) & (diff >= 0)):        \n            pred = (pred_a * coef7) + (pred_b * (1.0 - coef7))\n\n        elif ((pred_a >= 0.75) & (diff < 0)):        \n            pred = (pred_a * coef8) + (pred_b * (1.0 - coef8))\n        \n        else:\n            raise ValueError(\"if sentence error\")\n           \n        ense_v[i, 1] = pred\n        \n    ense.iloc[:, 1] = ense_v[:, 1]\n\n    ###############################    \n    X  = mod_a.iloc[:, 1]\n    Y1 = mod_b.iloc[:, 1]\n    Y2 = ense.iloc[:, 1]\n    \n    plt.style.use('seaborn-whitegrid') \n    plt.figure(figsize=(9, 9), facecolor='lightgray')\n    plt.title(f'\\nE N S E M B L I N G\\n')   \n      \n    plt.scatter(X, Y1, s=1.5, label=f'Support: {supp_name} {support.score}')    \n    plt.scatter(X, Y2, s=1.5, label='Generated')\n    plt.scatter(X, X, s=0.1, label=f'Main: {main_name}')\n    \n    plt.legend(fontsize=12, loc=2)\n    #plt.savefig('Ensembling_1.png')\n    plt.show()     \n    ###############################   \n    ense.iloc[:, 1] = ense.iloc[:, 1].astype(float)\n    hist_data = [mod_b.iloc[:, 1], ense.iloc[:, 1], mod_a.iloc[:, 1]] \n    group_labels = [f'Support: {supp_name} {support.score}', 'Ensembling', f'Main: {main_name}']\n    \n    fig = ff.create_distplot(hist_data, group_labels, bin_size=.2, show_hist=False, show_rug=False)\n    fig.show()   \n    ###############################   \n    \n    return ense","fc7f32ad":"path0 = '..\/input\/g2net-834\/submission.csv'\n\nmodel0 = pd.read_csv(path0).sort_values('id')\nmodel0.score = '834a'","e16855aa":"path1 = '..\/input\/g2net-855a\/submission.csv'\n\nmodel1 = pd.read_csv(path1).sort_values('id')\nmodel1.score = '855a'","cb1bed01":"path2 = '..\/input\/g2net-860\/submission.csv'\n\nmodel2 = pd.read_csv(path2).sort_values('id')\nmodel2.score = '860a'","102cd51a":"path3 = '..\/input\/g2net-861\/submission.csv'\n\nmodel3 = pd.read_csv(path3).sort_values('id')\nmodel3.score = '861a'","c74f5434":"path4 = '..\/input\/g2net-864\/model_submission.csv'\n\nmodel4 = pd.read_csv(path4).sort_values('id')\nmodel4.score = '864a'","b743f298":"path5 = '..\/input\/g2net-866\/submission.csv'\n\nmodel5 = pd.read_csv(path5).sort_values('id')\nmodel5.score = '866a'","36e630a4":"path6 = '..\/input\/g2net-869\/submission.csv'\n\nmodel6 = pd.read_csv(path6).sort_values('id')\nmodel6.score = '869a'","604b5334":"model_names = [f'm_{model0.score}', f'm_{model1.score}', f'm_{model2.score}', f'm_{model3.score}', f'm_{model4.score}', f'm_{model5.score}', f'm_{model6.score}']\n\nhist_data = [model0.target, model1.target, model2.target, model3.target, model4.target, model5.target, model6.target]  \n   \nfig = ff.create_distplot(hist_data, model_names, bin_size=.2, show_hist=False, show_rug=False) \n\nfig.show()","b05e9d4c":"mean_data=np.mean(hist_data, axis=1)\ncorr_data=np.corrcoef([model0.target, model1.target, model2.target, model3.target, model4.target, model5.target, model6.target])\ncorr_data = pd.DataFrame(corr_data)\ncorr = corr_data.applymap(lambda x : 0 if x >= 0.9999 else x)\ncorr_ = corr.copy()\ncorr.columns = model_names\ncorr['model'] = model_names\ncorr['pred_avg'] = mean_data\ncorr['cor_avg'] = (corr_.mean(axis='columns'))*len(corr_)\/(len(corr_)-1)\ncorr['cor_max'] = corr_.max(axis='columns')\ncorr","13cab76e":"sub1 = ensembling(model2, model3, 0.3, 0.7, 0.3, 0.7, 0.3, 0.7, 0.3, 0.7)\nprint('sub1_average', np.mean(sub1.target))","dc717ce3":"sub2 = ensembling(sub1, model4, 0.3, 0.8, 0.3, 0.8, 0.2, 0.6, 0.2, 0.6)\nprint('sub2_average', np.mean(sub2.target))","81908c67":"sub3 = ensembling(sub2, model6, 0.3, 0.5, 0.3, 0.5, 0.3, 0.7, 0.6, 0.4)\nprint('sub3_average', np.mean(sub3.target))","8e0b7c34":"sub4 = ensembling(sub3, model5, 0.4, 0.5, 0.4, 0.5, 0.5, 0.7, 0.65, 0.55)\nprint('sub4_average', np.mean(sub4.target))","f1877b94":"sub5 = ensembling(sub4, model0, 1, 1, 1, 1, 1, 1, 1, 1)\nprint('sub5_average', np.mean(sub5.target))","bc281c12":"sub6 = ensembling(sub5, model1, 1, 1, 1, 1, 1, 1, 1, 1)\nprint('sub6_average', np.mean(sub6.target))","01503efc":"sub1.to_csv(\"submission1.csv\",index=False)\nsub2.to_csv(\"submission2.csv\",index=False)\nsub3.to_csv(\"submission3.csv\",index=False)\nsub4.to_csv(\"submission4.csv\",index=False)\nsub5.to_csv(\"submission5.csv\",index=False)\n\nsub6.to_csv(\"submission_final.csv\",index=False)\n!ls","31bfaf05":"Thanks to: @ihelon https:\/\/www.kaggle.com\/ihelon\/g2net-eda-and-modeling\/output?select=model_submission.csv","00796cd9":"## Submission","ff6629d6":"## Data Set","e9492e9d":"<div class=\"alert alert-success\">  \n<\/div>","470e98bc":"<div class=\"alert alert-success\">  \n<\/div>","8d937fbe":"Thanks to: @hidehisaarai1213 https:\/\/www.kaggle.com\/hidehisaarai1213\/g2net-tf-on-the-fly-cqt-tpu-inference","55f335c4":"Revise the path and its Public Score when you replace the model.  Put '860b' and so forth, if you have the same score.<br>\n\u30e2\u30c7\u30eb\u3092\u5165\u308c\u66ff\u3048\u308b\u5834\u5408\u3001\u30d1\u30b9\u3068\u30b9\u30b3\u30a2\u3092\u4fee\u6b63\u3057\u3066\u4e0b\u3055\u3044\u3002\u540c\u3058\u30b9\u30b3\u30a2\u306e\u30e2\u30c7\u30eb\u304c\u3042\u308b\u5834\u5408\u3001'860b'\u306a\u3069\u3068\u3057\u3066\u533a\u5225\u3057\u3066\u4e0b\u3055\u3044\u3002","2fb38590":"## Below code is a modification of great notebook by [Somayyeh Gholami](https:\/\/www.kaggle.com\/somayyehgholami) & [Mehran Kazeminia](https:\/\/www.kaggle.com\/mehrankazeminia).<br> Check their [original work](https:\/\/www.kaggle.com\/somayyehgholami\/1-g2net-smart-ensembling).\n\nI want more control over how to ensemble models.  Therefore, I modified the code so that I can change the coefficient for each area in the scatter plot of the main and support model prediction value.\n\nSomayyeh Gholami & Mehran Kazeminia\u3055\u3093\u304c\u4f5c\u3063\u305f\u30a2\u30f3\u30b5\u30f3\u30d6\u30eb\u306e\u305f\u3081\u306e\u30b3\u30fc\u30c9\u3092\u4e00\u90e8\u5909\u66f4\u3057\u307e\u3057\u305f\u3002<br>\n\u5143\u30b3\u30fc\u30c9\u306fid\u306e\u5148\u982d\u6587\u5b57\u306b\u3088\u3063\u3066\u4fc2\u6570\u3092\u5909\u3048\u3066\u3044\u308b\u306e\u3067\u3059\u304c\u3001\u30e9\u30f3\u30c0\u30e0\u6027\u3092\u52a0\u3048\u308b\u4ee5\u4e0a\u306e\u610f\u5473\u304c\u5206\u304b\u308a\u307e\u305b\u3093\u3067\u3057\u305f\u3002<br>\n\u305d\u3053\u3067\u30a2\u30f3\u30b5\u30f3\u30d6\u30eb\u306b\u4f7f\u3046\u30e1\u30a4\u30f3\u30e2\u30c7\u30eb\u3068\u30b5\u30dd\u30fc\u30c8\u30e2\u30c7\u30eb\u306e\u4e88\u6e2c\u5024\u5206\u5e03\u3092\u8868\u3059\u6563\u5e03\u56f3\u306e\u30a8\u30ea\u30a2\u3054\u3068\u306b\u4fc2\u6570\u3092\u5909\u3048\u3089\u308c\u308b\u3088\u3046\u306b\u3057\u307e\u3057\u305f\u3002<br>\n\uff08\u30e1\u30a4\u30f3\u30e2\u30c7\u30eb\u306f\u305d\u308c\u307e\u3067\u306e\u30a2\u30f3\u30b5\u30f3\u30d6\u30eb\u30fb\u30e2\u30c7\u30eb\u3001\u30b5\u30dd\u30fc\u30c8\u30e2\u30c7\u30eb\u306f\u65b0\u3057\u304f\u30a2\u30f3\u30b5\u30f3\u30d6\u30eb\u306b\u5165\u308c\u308b\u30e2\u30c7\u30eb\u3092\u8868\u3057\u307e\u3059\u3002\uff09","abc520fb":"<div class=\"alert alert-success\">  \n<\/div>","3fe9b4e4":"<div class=\"alert alert-success\">\n    <h1 align=\"center\">If you find this work useful, please don't forget upvoting :)<\/h1>\n<\/div>","5c9d04d8":"**It's important to make sure the Public Score is getting better for every step (sub1\u2192sub2\u2192...).**<br>\nSubmitting all csv files leverage the value of this ensembling approach, even though it consumes daily submission allowance. If you find the step which worsen the score, you should change the coefficients or remove the model from ensemble.<br>\nI advise you to add \"-sub1\" and so forth to the Submission Description, for your record.<br>\nOut of Fold data may help you not to waste daily submission allowance, but that may be time consuming.\n\n\u5927\u4e8b\u306a\u306e\u306f\u3001sub1\u2192sub2\u2192...\u3068\u9032\u3093\u3067\u3044\u304f\u306b\u3064\u308c\u3066\u5e38\u306b\u30b9\u30b3\u30a2\u304c\u826f\u304f\u306a\u308b\u3053\u3068\u3002\u306a\u306e\u3067\u3001\u65e5\u6bce\u306esubmit\u5236\u9650\u6570\u3092\u98df\u3063\u3066\u3057\u307e\u3046\u3082\u306e\u306e\u3001sub1\u304b\u3089\u9806\u756a\u306bsubmit\u3057\u3066\u3044\u304f\u3053\u3068\u3067\u3001\u3053\u306e\u30a2\u30f3\u30b5\u30f3\u30d6\u30eb\u6cd5\u306e\u771f\u4fa1\u304c\u767a\u63ee\u3067\u304d\u308b\u3068\u601d\u308f\u308c\u307e\u3059\u3002\u30b9\u30b3\u30a2\u304c\u60aa\u304f\u306a\u308b\u30b9\u30c6\u30c3\u30d7\u304c\u3042\u308c\u3070\u3001\u305d\u3053\u3067\u5165\u308c\u305fsupport\u30e2\u30c7\u30eb\u306e\u8cea\u30fb\u76f8\u6027\u304c\u60aa\u3044\u304b Coefficient\u304c\u4e0d\u9069\u5207\u306a\u306e\u3067\u3001Coefficient\u3092\u8abf\u6574\u3059\u308b\u304b\u3001\u305d\u306e\u30e2\u30c7\u30eb\u3092\u30a2\u30f3\u30b5\u30f3\u30d6\u30eb\u304b\u3089\u629c\u304f\u5fc5\u8981\u304c\u3042\u308a\u307e\u3059\u3002<br>\nsubmit\u3057\u305f\u5f8c\u3001\u3069\u306ecsv\u3092\u51fa\u3057\u305f\u306e\u304b\u5206\u304b\u3089\u306a\u304f\u306a\u308b\u306e\u3067\u3001Submission Description\u6b04\u306b\"-sub1\"\u306a\u3069\u3068\u52a0\u3048\u3066\u304a\u304f\u3068\u4fbf\u5229\u3067\u3059\u3002<br>\nOut of Fold\u30c7\u30fc\u30bf\u304c\u3042\u308c\u3070\u3001submit\u305b\u305a\u306b\u78ba\u8a8d\u3067\u304d\u307e\u3059\u304c\u3001\u5168\u3066\u306e\u30e2\u30c7\u30eb\u306b\u5bfe\u3057\u3066\u7528\u610f\u3059\u308b\u306e\u306f\u5927\u5909\u305d\u3046\u3067\u3059\u306d\u3002","4da29feb":"## Model prediction average and correlation table","4daf2dfe":"Thanks to: @mrigendraagrawal https:\/\/www.kaggle.com\/mrigendraagrawal\/tf-g2net-eda-and-starter","c73a7cff":"<div class=\"alert alert-success\">  \n<\/div>","2f2b15c2":"## Import","ddc4b1a7":"<div class=\"alert alert-success\">  \n<\/div>","7730e43c":"Large blue area and low correlation reflect big differences between main and support models. They may be an excellent combo for ensemble or one of which is an inferior model.<br>A smaller coefficient widens the orange area, thus dragging the ensemble close to the support model.\n\n\u9752\u3044\u30a8\u30ea\u30a2\u306e\u5e83\u3055\u306fmain\u3068support\u30e2\u30c7\u30eb\u306e\u9055\u3044\u306e\u5927\u304d\u3055\u3092\u793a\u3059\u50be\u5411\u304c\u3042\u308a\u307e\u3059\u3002correlation\u306e\u65b9\u304c\u3088\u308a\u6b63\u78ba\u306b\u9055\u3044\u304c\u5206\u304b\u308b\u3068\u601d\u3044\u307e\u3059\u3002<br>\u5c0f\u3055\u306aCoefficient\u306f\u30aa\u30ec\u30f3\u30b8\u306e\u30a8\u30ea\u30a2\u3092\u5e83\u304f\u3057\u3001\u30a2\u30f3\u30b5\u30f3\u30d6\u30eb\u30fb\u30e2\u30c7\u30eb\u3092support\u30e2\u30c7\u30eb\u306b\u8fd1\u3065\u3051\u307e\u3059\u3002","9c81900a":"<div>\n    <h1 align=\"center\">Smart Ensembling<\/h1>    \n    <h1 align=\"center\">G2Net Gravitational Wave Detection<\/h1> \n    <h4 align=\"center\">By: Somayyeh Gholami & Mehran Kazeminia<\/h4>\n    <h5 align=\"center\">Modified by: kuroyuli<\/h4>\n<\/div>","d248a60b":"## Areas in the scatter plot","3aed6074":"Thanks to: @miklgr500 https:\/\/www.kaggle.com\/miklgr500\/cqt-g2net-efficientnetb1-tpu-inference\/output?select=submission.csv\n\nThanks to: @xuxu1234 https:\/\/www.kaggle.com\/xuxu1234\/lb-0-866-g2net-efficientnetb7-tpu-inference","cbf8fd4d":"## Thank you very much for reading.","ea2310cd":"<div class=\"alert alert-success\">  \n<\/div>","5b8c96a5":"## Functions","1fa709f5":"Thanks to: @yasufuminakama https:\/\/www.kaggle.com\/yasufuminakama\/g2net-efficientnet-b7-baseline-inference","3d153c9b":"I prefer this table rather than a heatmap.<br>\nMy strategy is to ensemble the most correlated models first and leave the less correlated and low scoring models for the latter ensemble.<br>In this way, I can judge the model is good for ensemble or not, and remove unnecessary models easily.<br>\nIn this version, I didn't use model0(834a) and model1 (855a).\n\n\u5404\u30e2\u30c7\u30eb\u540c\u58eb\u306e\u76f8\u95a2\u8868\u3067\u3059\u3002Heatmap\u3067\u3082\u3044\u3044\u3093\u3067\u3059\u304c\u3001\u7d30\u304b\u3044\u9055\u3044\u3092\u77e5\u308b\u305f\u3081\u8868\u3092\u4f7f\u3044\u307e\u3057\u305f\u3002<br>\n\u79c1\u306e\u6226\u7565\u306f\u300c\u6700\u521d\u306b\u76f8\u95a2\u304c\u9ad8\u3044\u30e2\u30c7\u30eb\u540c\u58eb\u3067\u30a2\u30f3\u30b5\u30f3\u30d6\u30eb\u3057\u3066\u3001\u4ed6\u3068\u306e\u76f8\u95a2\u304c\u4f4e\u304f\u3001\u30b9\u30b3\u30a2\u3082\u4f4e\u3044\u30e2\u30c7\u30eb\u306f\u5f8c\u56de\u3057\u306b\u3059\u308b\u3002\u300d\u3068\u3044\u3046\u3082\u306e\u3067\u3059\u3002<br>\u4ed6\u3068\u306e\u76f8\u95a2\u304c\u4f4e\u304f\u3001\u7cbe\u5ea6\u306e\u4f4e\u3044\u30e2\u30c7\u30eb\u306f\u300c\u7cbe\u5ea6\u306f\u4f4e\u3044\u3082\u306e\u306e\u3001\u4ed6\u306e\u30e2\u30c7\u30eb\u306e\u5f31\u3044\u90e8\u5206\u3092\u88dc\u3063\u3066\u30a2\u30f3\u30b5\u30f3\u30d6\u30eb\u3068\u3057\u3066\u826f\u3044\u30e2\u30c7\u30eb\u3092\u4f5c\u308c\u308b\u3082\u306e\u300d\u304b\u300c\u7cbe\u5ea6\u304c\u4f4e\u304f\u30a2\u30f3\u30b5\u30f3\u30d6\u30eb\u306b\u60aa\u5f71\u97ff\u3092\u4e0e\u3048\u308b\u3082\u306e\u300d\u306e\u53ef\u80fd\u6027\u304c\u3042\u308a\u3001\u305d\u308c\u3092\u898b\u6975\u3081\u308b\u306e\u306f\u5f8c\u306e\u65b9\u304c\u826f\u3044\u306e\u3067\u306f\u3068\u3044\u3046\u8003\u3048\u304b\u3089\u3067\u3059\u3002\uff08\u6700\u521d\u304b\u3089\u5165\u308c\u3066\u3057\u307e\u3046\u3068\u3001\u5916\u3057\u306b\u304f\u304f\u306a\u308b\u3002\uff09<br>\u3053\u306e\u30d0\u30fc\u30b8\u30e7\u30f3\u3067\u306f\u3001model0(834a)\u3068model1 (855a)\u3092\u30a2\u30f3\u30b5\u30f3\u30d6\u30eb\u306b\u52a0\u3048\u3066\u3044\u307e\u305b\u3093\u3002<br>\u3053\u306e\u6226\u7565\u304c\u6b63\u3057\u3044\u304b\u3069\u3046\u304b\u306f\u5206\u304b\u308a\u307e\u305b\u3093\u3002\u307f\u306a\u3055\u3093\u8a66\u884c\u932f\u8aa4\u3057\u3066\u307f\u3066\u4e0b\u3055\u3044\u3002","5f2feff6":"Thanks to: @wabinab https:\/\/www.kaggle.com\/wabinab\/submission-baseline","144c43d6":"Thanks to: @miklgr500 https:\/\/www.kaggle.com\/miklgr500\/g2net-efficientnetb1-tpu-evaluate\/output","7d1745ca":"<div class=\"alert alert-success\">\n    <h1 align=\"center\">Ensembling<\/h1>\n<\/div>"}}