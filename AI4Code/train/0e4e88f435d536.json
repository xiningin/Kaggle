{"cell_type":{"fe552cea":"code","9e08f356":"code","e24ab3b7":"code","4840c28a":"code","ffb2b2b9":"code","35ba44d0":"code","b463ee2a":"code","722786e9":"code","3f60d4c9":"code","9fb1aaed":"code","a7b8014b":"code","af41eb58":"code","c492daa4":"code","ac03e1d3":"code","10378f4a":"code","106ab568":"code","1711de81":"code","56e9b5e6":"code","6a100031":"code","e2d82fd3":"code","6b023690":"code","c85d93bd":"code","c81dd580":"code","e886c935":"code","22d2fec3":"code","55d90882":"code","275486fa":"code","a8700bdb":"code","55a570f6":"code","536aa638":"code","47797b67":"code","dd96bdd1":"code","6066d717":"code","c0d52fef":"code","5a267670":"code","b8a068f3":"code","1e04dd19":"code","3449b1f0":"code","b8ab0484":"code","f5f1470b":"code","317d7e5f":"code","41bfc3b5":"code","e6db574e":"code","6659b3de":"code","a87428ae":"code","c4fde2db":"code","a64b6317":"code","95ffcf60":"markdown","acd1e97e":"markdown","4d048167":"markdown","f3c78cba":"markdown","1533d42e":"markdown","45752762":"markdown","6838cb06":"markdown","9317d1fb":"markdown","b36968da":"markdown","476aae2e":"markdown","0dd7121d":"markdown","59bfda97":"markdown","855fd853":"markdown","5b19c7da":"markdown","a0ae74db":"markdown","868e6e3a":"markdown","724823fa":"markdown","9905d37b":"markdown","0d2e7d79":"markdown","1ea80e0c":"markdown","17815db5":"markdown","4184906c":"markdown","f934a2c1":"markdown"},"source":{"fe552cea":"import numpy as np \nfrom sklearn.model_selection import train_test_split\nfrom sklearn.linear_model import LogisticRegression\nimport math\nimport pandas as pd \nimport matplotlib.pyplot as plt\n\nimport seaborn as sns\nimport sklearn.metrics as metrics\n%matplotlib inline\nimport os\nfor dirname, _, filenames in os.walk('\/kaggle\/input'):\n    for filename in filenames:\n        print(os.path.join(dirname, filename))","9e08f356":"df_train = pd.read_csv(\"\/kaggle\/input\/GiveMeSomeCredit\/cs-training.csv\",index_col=0)\ndf_test = pd.read_csv(\"\/kaggle\/input\/GiveMeSomeCredit\/cs-test.csv\",index_col=0)\ndf_train.head()","e24ab3b7":"df_train.info()","4840c28a":"df_train.describe()","ffb2b2b9":"#\u5c1d\u8bd5\u8fc7SMOTE\u53bb\u8fc7\u91c7\u6837\uff0c\u4f46\u6ca1\u5565\u6548\u679c\uff0c\u5c31\u6ce8\u91ca\u6389\u4e86\n# from imblearn.over_sampling import SMOTE \n# sm = SMOTE(random_state=42)\n# X_train, y_train = sm.fit_resample(X_train, y_train)\n# print('bad rate is: ',y_train.mean())","35ba44d0":"import xgboost as xgb","b463ee2a":"X_train, X_test, y_train, y_test = train_test_split(df_train.drop(['SeriousDlqin2yrs'],axis=1), df_train['SeriousDlqin2yrs'], test_size=0.2, random_state=42)","722786e9":"def plot_AUC(model,X_test,y_test):\n    probs = model.predict_proba(X_test)\n    preds = probs[:,1]\n    fpr, tpr, threshold = metrics.roc_curve(y_test, preds)\n    roc_auc = metrics.auc(fpr, tpr)\n\n    plt.title('Receiver Operating Characteristic')\n    plt.plot(fpr, tpr, 'b', label = 'AUC = %0.2f' % roc_auc)\n    plt.legend(loc = 'lower right')\n    plt.plot([0, 1], [0, 1],'r--')\n    plt.xlim([0, 1])\n    plt.ylim([0, 1])\n    plt.ylabel('True Positive Rate')\n    plt.xlabel('False Positive Rate')\n    plt.show()","3f60d4c9":"\nmodel1 = xgb.XGBClassifier(objective=\"binary:logistic\", random_state=42)\nmodel1.fit(X_train,y_train)","9fb1aaed":"#\u5728\u9a8c\u8bc1\u96c6\u4e0a\u770b\u6027\u80fd\nmodel1.score(X_test,y_test)","a7b8014b":"# calculate the fpr and tpr for all thresholds of the classification\nplot_AUC(model1,X_test,y_test)","af41eb58":"#\u6df7\u6dc6\u77e9\u9635\ny_pred = model1.predict(X_test)\nmetrics.confusion_matrix(y_test,y_pred)","c492daa4":"weight = int(y_train.count()\/y_train.sum())","ac03e1d3":"model2 = xgb.XGBClassifier(objective=\"binary:logistic\", random_state=42,scale_pos_weight = weight)\nmodel2.fit(X_train,y_train)","10378f4a":"model2.score(X_test,y_test)","106ab568":"plot_AUC(model2,X_test,y_test)","1711de81":"#\u6df7\u6dc6\u77e9\u9635\ny_pred = model2.predict(X_test)\nmetrics.confusion_matrix(y_test,y_pred)","56e9b5e6":"\nfrom imblearn.over_sampling import SMOTE \nsm = SMOTE(random_state=42)\nX_train_balanced, y_train_balanced = sm.fit_resample(X_train.fillna(0), y_train)\nprint('bad rate is: ',y_train_balanced.mean())","6a100031":"model3 = xgb.XGBClassifier(objective=\"binary:logistic\", random_state=42)\nmodel3.fit(X_train_balanced,y_train_balanced)","e2d82fd3":"model3.score(X_test,y_test)","6b023690":"plot_AUC(model3,X_test,y_test)","c85d93bd":"#\u6df7\u6dc6\u77e9\u9635\ny_pred = model3.predict(X_test)\nmetrics.confusion_matrix(y_test,y_pred)","c81dd580":"param = {'min_child_weight': 10.0,\n'objective': 'binary:logistic',\n'max_depth': 5,\n'eval_metric': 'auc',\n'max_delta_step': 1.8,\n'colsample_bytree': 0.4,\n'subsample': 0.8,\n'eta': 0.025,\n'gamma': 0.65,\n'num_boost_round' : 391\n        }","e886c935":"from imblearn.ensemble import EasyEnsembleClassifier","22d2fec3":"X_train.head()","55d90882":"model4 = EasyEnsembleClassifier(n_estimators=20, random_state=42, base_estimator=xgb.XGBClassifier(objective=\"binary:logistic\",random_state=42))\nmodel4.fit(X_train.fillna(0),y_train)","275486fa":"model4.score(X_test.fillna(0),y_test)","a8700bdb":"plot_AUC(model4,X_test.fillna(0),y_test)","55a570f6":"import shap","536aa638":"final_model = model4","47797b67":"for x in final_model.estimators_:\n    print(x['classifier'].feature_importances_)","dd96bdd1":"explainer = shap.TreeExplainer(final_model)\n","6066d717":"shap_values = explainer.shap_values(X_train)\nprint(shap_values.shape)\n","c0d52fef":"shap.summary_plot(shap_values,X_train)","5a267670":"shap.summary_plot(shap_values,X_train,plot_type='bar')","b8a068f3":"shap.dependence_plot('RevolvingUtilizationOfUnsecuredLines', shap_values,X_train, interaction_index=None, show=False)","1e04dd19":"sample = X_test.sample(1,random_state=42)","3449b1f0":"sample","b8ab0484":"final_model.predict_proba(sample)","f5f1470b":"shap.initjs()\nshap_value_sample = explainer.shap_values(sample)\nshap.force_plot(explainer.expected_value, shap_value_sample, sample)","317d7e5f":"df_test.head()","41bfc3b5":"model_final = EasyEnsembleClassifier(n_estimators=50, random_state=42, base_estimator=xgb.XGBClassifier().set_params(**param))\nmodel_final.fit(df_train.drop(['SeriousDlqin2yrs'],axis=1), df_train['SeriousDlqin2yrs'])\n","e6db574e":"result = model_final.predict_proba(df_test.drop('SeriousDlqin2yrs',axis=1))","6659b3de":"result = [x[1] for x in result]","a87428ae":"df_result = pd.DataFrame({'Id':df_test['Unnamed: 0'].tolist(), 'Probability':result})","c4fde2db":"df_result.head()","a64b6317":"df_result.to_csv('submission_credit_3.csv', index=False)","95ffcf60":"\u755930%\u4f5c\u4e3a\u6a21\u578b\u7684\u9a8c\u8bc1\u96c6","acd1e97e":"\u6682\u65f6\u8df3\u8fc7","4d048167":"\u6211\u4eec\u4f7f\u7528\u7b2c\u4e00\u4e2a\u6a21\u578b\uff0c\u56e0\u4e3aAUC\u6700\u597d","f3c78cba":"# \u7279\u5f81\u91cd\u8981\u5ea6","1533d42e":"## model 3: use smote","45752762":"\u84dd\u8272\u8868\u793a\u8be5\u7279\u5f81\u7684\u8d21\u732e\u662f\u8d1f\u6570\uff0c\u7ea2\u8272\u5219\u8868\u793a\u8be5\u7279\u5f81\u7684\u8d21\u732e\u662f\u6b63\u6570\u3002","6838cb06":"> \n## \u5bfc\u5165\u5305<a class=\"anchor\" id=\"1\"><\/a>","9317d1fb":"## \u603b\u7ed3 <a class=\"anchor\" id=\"8\"><\/a>","b36968da":"## \u5bfc\u5165\u6570\u636e<a class=\"anchor\" id=\"2\"><\/a>","476aae2e":"## model 2: use change scale_pos_weight","0dd7121d":"\u5bf9\u4e8e\u6811\u7ed3\u6784\u7684\u6a21\u578b\uff0c\u6570\u636e\u5206\u7bb1\u5e76\u975e\u5fc5\u8981\u7684\uff0c\u56e0\u4e3a\u6811\u5206\u53c9\u7684\u8fc7\u7a0b\u4f1a\u6709\u4e2asplit\u7684\u9608\u503c\uff0c\u76f8\u5f53\u4e8e\u81ea\u52a8\u5206\u7bb1\u4e86\uff0c\u9664\u975e\u4f60\u786e\u4fe1\u4f60\u5bf9\u4e1a\u52a1\u7684\u7406\u89e3\u591f\u6df1\u5165","59bfda97":"## model 1: use default parameter","855fd853":"## EDA <a class=\"anchor\" id=\"3\"><\/a>\n\n\u8be6\u89c1 https:\/\/www.kaggle.com\/orange90\/credit-scorecard-example","5b19c7da":"\u672ckernel\u662f\u6587\u7ae0\u7684\u4f8b\u5b50\uff0c\u76f8\u5173\u7406\u8bba\u90e8\u53c2\u8003\u77e5\u4e4e\u4e13\u680f\u6587\u7ae0https:\/\/zhuanlan.zhihu.com\/p\/148102950\n\n## Table of Contents\n\n1. [\u5bfc\u5165\u5305](#1)\n2. [\u5bfc\u5165\u6570\u636e](#2)\n3. [EDA](#3)\n4. [\u6570\u636e\u5206\u7bb1](#4)\n5. [\u7279\u5f81\u7b5b\u9009](#5)\n6. [\u903b\u8f91\u56de\u5f52\u5efa\u6a21](#6)\n7. [\u8bc4\u5206\u5361\u8f6c\u6362](#7)\n8. [\u603b\u7ed3](#8)","a0ae74db":"# \u4f7f\u7528SHAP\u6765\u89e3\u91ca\u6a21\u578b","868e6e3a":"## model 4, easy ensemble","724823fa":"## \u6570\u636e\u5206\u7bb1\uff1f <a class=\"anchor\" id=\"4\"><\/a>","9905d37b":"## \u770b\u5355\u4e2a\u9884\u6d4b","0d2e7d79":"Reference:\nhttp:\/\/citeseerx.ist.psu.edu\/viewdoc\/download?doi=10.1.1.309.1465&rep=rep1&type=pdf","1ea80e0c":"\u56e0\u4e3a\u6bd4\u8d5b\u662f\u7528AUC\u4f5c\u4e3a\u6807\u51c6\uff0c\u6240\u4ee5\u6211\u4e5f\u770b\u770b\u6211\u7684\u6a21\u578bAUC\u591a\u5c11","17815db5":"## \u7279\u5f81\u7b5b\u9009 <a class=\"anchor\" id=\"5\"><\/a>","4184906c":"# \u5efa\u6a21 <a class=\"anchor\" id=\"6\"><\/a>","f934a2c1":"submission"}}