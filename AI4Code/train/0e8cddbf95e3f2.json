{"cell_type":{"2f1b811b":"code","a33f464f":"code","cba74716":"code","0d50f370":"code","8aae75a7":"code","c71bff35":"code","a9e69835":"code","51c6a1c6":"code","f936d8cc":"code","38482569":"code","4ee5abab":"code","e6b239c0":"code","cec216b5":"code","0a3fdc1b":"code","3e66e9c9":"code","340aca7b":"code","e3fee2c5":"code","679c6a74":"code","7c978774":"markdown","c81d79d2":"markdown","5c30cc77":"markdown","ccb6057b":"markdown"},"source":{"2f1b811b":"!pip uninstall -y allennlp","a33f464f":"!pip install pandas_profiling lightautoml","cba74716":"import logging\nimport os\nimport time\nlogging.basicConfig(format='[%(asctime)s] (%(levelname)s): %(message)s', level=logging.INFO)\n\nimport numpy as np\nimport pandas as pd\nfrom sklearn.metrics import mean_squared_error\nimport pandas_profiling\nimport torch\n\nfrom lightautoml.automl.presets.tabular_presets import TabularAutoML\nfrom lightautoml.dataset.roles import DatetimeRole\nfrom lightautoml.tasks import Task","0d50f370":"np.random.seed(42)\ntorch.set_num_threads(8)","8aae75a7":"df = pd.read_csv('\/kaggle\/input\/real-time-advertisers-auction\/Dataset.csv', dtype={'site_id': str, 'ad_type_id': str, 'geo_id': str, 'device_category_id': str, 'advertiser_id': str, 'order_id': str, \n                                           'line_item_type_id': str, 'os_id': str, 'integration_type_id': str, 'monetization_channel_id': str, 'ad_unit_id': str},\n                   parse_dates=[0], dayfirst=True)\ndf.head()","c71bff35":"def weird_division(n, d):\n    return n \/ d if d else 0\n\ndf['CPM'] = df.apply(lambda x: weird_division(((x['total_revenue']*100)),x['measurable_impressions'])*1000 , axis=1)","a9e69835":"len(df)","51c6a1c6":"df.profile_report()","f936d8cc":"df.drop(columns=['total_revenue', 'integration_type_id', 'revenue_share_percent'], inplace=True)\ndf[df['CPM'] >= 0]\ndf = df[df['CPM'] <= np.percentile(df['CPM'], 95)]","38482569":"train_data = df[df.date < pd.to_datetime(\"2019-06-22\")]\ntest_data = df[df.date >= pd.to_datetime(\"2019-06-22\")]","4ee5abab":"len(train_data), len(test_data)","e6b239c0":"train_data.head()","cec216b5":"task = Task('reg', loss='mse', metric='mse')","0a3fdc1b":"roles = {'target': 'CPM',\n         DatetimeRole(base_date=True, seasonality=(), base_feats=False): 'date',\n         }","3e66e9c9":"%%time \n\nautoml = TabularAutoML(task = task, \n                       timeout = 300,\n                       general_params = {'nested_cv': False, 'use_algos': [['linear_l2', 'lgb', 'lgb_tuned']]},\n                       reader_params = {'cv': 5, 'random_state': 42},\n                       tuning_params = {'max_tuning_iter': 20, 'max_tuning_time': 50},\n                       lgb_params = {'default_params': {'num_threads': 8}})\noof_pred = automl.fit_predict(train_data, roles = roles)\nlogging.info('oof_pred:\\n{}\\nShape = {}'.format(oof_pred, oof_pred.shape))","340aca7b":"len(oof_pred.data[:, 0])","e3fee2c5":"train_data['CPM'].isnull().sum()","679c6a74":"%%time\n\ntest_pred = automl.predict(test_data)\n\nprint('TEST score: {}'.format(mean_squared_error(test_data['CPM'].values, test_pred.data[:, 0])))","7c978774":"### Setup task and column metadata","c81d79d2":"### Data preparation and exploration","5c30cc77":"### Enjoy as machine does all the work","ccb6057b":"### Test MSE: 2563.072643811232"}}