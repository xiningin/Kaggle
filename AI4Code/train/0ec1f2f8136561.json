{"cell_type":{"574b97d3":"code","e74cfdfa":"code","44d52e66":"code","6002cf13":"code","9a42d17d":"code","032f6cf1":"code","fb8555f3":"code","a6a02d3e":"code","ec187e2c":"code","ad4b0964":"markdown","9d984c95":"markdown","14fd2398":"markdown","718f24f7":"markdown","c336636a":"markdown","17db1cfd":"markdown","d2ebf041":"markdown","be6d7c15":"markdown"},"source":{"574b97d3":"from __future__ import absolute_import\nfrom __future__ import print_function\n\nimport os\nimport numpy as np\nimport pandas as pd\nfrom tqdm.auto import tqdm\ntqdm.pandas()\nimport Levenshtein\nimport cv2\nfrom PIL import Image\nfrom matplotlib import pyplot as plt\nimport seaborn as sns\nfrom numpy import save, load\nimport warnings\nwarnings.filterwarnings('ignore')\n\nfrom scipy.spatial import distance\nfrom sklearn.decomposition import PCA\n\nimport tensorflow as tf\nfrom tensorflow.python.keras.preprocessing.image import load_img, img_to_array\nfrom tensorflow.keras.applications.vgg16 import VGG16\nfrom tensorflow.keras.preprocessing import image\nfrom tensorflow.keras.applications.vgg16 import preprocess_input\n\nfrom scipy import spatial\n\nprint(os.listdir(\"..\/input\"))","e74cfdfa":"# Levenshtein scoring function\n\ndef get_score(y_true, y_pred):\n    scores = []\n    for true, pred in zip(y_true, y_pred):\n        score = Levenshtein.distance(true, pred)\n        scores.append(score)\n    avg_score = np.mean(scores)\n    return avg_score\n\nprint(get_score('alex', 'axel'))\nprint(Levenshtein.distance('alex', 'axel'))","44d52e66":"nrows = 1100\n\nrawDF = pd.read_csv('..\/input\/bms-arranged-label\/arranged_bms_train_labels.csv', index_col=[0], nrows=nrows)\nplay = rawDF[['image_path','InChI']][:1000]\nplayTest = rawDF[['image_path','InChI']][1000:]\nprint(play.shape)\nplay.head()","6002cf13":"playTest.reset_index(drop=True, inplace=True)\nprint(playTest.shape)\nplayTest.head()","9a42d17d":"%%time\n\n# Model predict = feat extract from images going thru VGG16\n# 10k images = 1Gb features.npy ... 7:30 mins prep feat ... 9:50 mins predict ... average on test Lev = 78.4\n\nmodel = VGG16(weights='imagenet', include_top=False)\n\nfeatures = []\n\nfor row in tqdm(range(play.shape[0])):\n    img_path = play.image_path[row]\n    img = image.load_img(img_path, target_size=(224, 224))\n    x = image.img_to_array(img)\n    x = np.expand_dims(x, axis=0)\n    x = preprocess_input(x)\n    \n    #features.append(model.predict(x).squeeze())\n    features.append(model.predict(x).ravel())\n\nfeatures = np.array(features)\nfeatures.shape","032f6cf1":"%%time\n\n# Predict ONE img w Euclidean np.linalg.norm\n\nimgNum = 23\n\nmodel = VGG16(weights='imagenet', include_top=False)\n\nimg_path = playTest.image_path[imgNum]\nimg = image.load_img(img_path, target_size=(224, 224))\nx = image.img_to_array(img)\nx = np.expand_dims(x, axis=0)\nx = preprocess_input(x)\n\n#featOne = model.predict(x)\nfeatOne = model.predict(x).ravel()\n\n# Find the min Euclidean distance to one image vector\n\nMyDist = []\n\nfor v in range(features.shape[0]):\n    #Dist = np.linalg.norm(features[v]-featOne)\n    Dist = spatial.distance.euclidean(features[v],featOne)   \n    MyDist.append(Dist)\n    \nMyDist=np.array(MyDist)  \n\n# When the image we're searching with is in the features already - take the second smallest dist\n# as 0 is the first arg = same vector we search and dist = 0\n#nearVec = MyDist.argsort()[1] \n#vecDis = np.amin(MyDist[MyDist != np.amin(MyDist)]) # for picking the second smallest\n\nnearVec = MyDist.argmin()\nvecDis = MyDist.min()\nlevDis = Levenshtein.distance(playTest.InChI[imgNum], play.InChI[nearVec])\n\n\nprint('get_score ', get_score(playTest.InChI[imgNum], play.InChI[nearVec]))\nprint('levDis ',levDis)\nprint('vecDis ',vecDis)","fb8555f3":"print(playTest.shape)\nplayTest.head()","a6a02d3e":"%%time\n\n# Predict on many img\nmodel = VGG16(weights='imagenet', include_top=False)\nrealInchi = []\npredInchi = []\n\nLevDist = []\nVecDist = []\n\nfor imgNum in tqdm(range(playTest.shape[0])):\n\n    img_path = playTest.image_path[imgNum]\n    img = image.load_img(img_path, target_size=(224, 224))\n    x = image.img_to_array(img)\n    x = np.expand_dims(x, axis=0)\n    x = preprocess_input(x)\n    #featOne = model.predict(x)\n    featOne = model.predict(x).ravel()\n\n    # Find the min Euclidean distance to one image vector\n    MyDist = []\n    for v in range(features.shape[0]):\n        \n        #Dist = np.linalg.norm(features[v]-featOne)\n        #Dist = spatial.distance.cosine(features[v],featOne) \n        #Dist = spatial.distance.braycurtis(features[v],featOne) \n        #Dist = spatial.distance.canberra(features[v],featOne) \n        #Dist = spatial.distance.chebyshev(features[v],featOne) # Takes 10 mins for 100 samples...\n        #Dist = spatial.distance.cityblock(features[v],featOne)\n        #Dist = spatial.distance.correlation(features[v],featOne)\n        #Dist = spatial.distance.jensenshannon(features[v],featOne)\n        #Dist = spatial.distance.minkowski(features[v],featOne)\n        #Dist = spatial.distance.dice(features[v],featOne)\n        #Dist = spatial.distance.hamming(features[v],featOne)\n        #Dist = spatial.distance.jaccard(features[v],featOne)\n        Dist = spatial.distance.kulsinski(features[v],featOne)\n        #Dist = spatial.distance.rogerstanimoto(features[v],featOne)\n        #Dist = spatial.distance.russellrao(features[v],featOne)\n        #Dist = spatial.distance.sokalmichener(features[v],featOne)\n        #Dist = spatial.distance.sokalsneath(features[v],featOne)\n        #Dist = spatial.distance.yule(features[v],featOne)\n        \n        MyDist.append(Dist)\n    MyDist=np.array(MyDist)  \n    nearVec = MyDist.argmin()\n    vecDis = MyDist.min()\n\n    realInchi.append(playTest.InChI[imgNum])\n    predInchi.append(play.InChI[nearVec])\n\n    levDis = Levenshtein.distance(playTest.InChI[imgNum], play.InChI[nearVec])\n    LevDist.append(levDis)\n    VecDist.append(vecDis)\n\n\nprint('Average Lev dist ',get_score(realInchi, predInchi))\n","ec187e2c":"plt.scatter(VecDist,LevDist)\nplt.xlabel(\"Dist between Vectors \")\nplt.ylabel(\"Dist between InChI - Levenshtein \")\nplt.title(\"Relationship between Levenshtein and Vector distances\")","ad4b0964":"# Predict = find the nearest image vector","9d984c95":"# Data","14fd2398":"### Save \/ Load features npy","718f24f7":"# Features extraction ... from images to vectors","c336636a":"#SAVE\nsave('features.npy', features)","17db1cfd":"### Goal: identify any relationship between Levenshtein distance and the distance between image vectors\n\n* I wanted to see if a shorter distance between two molecules' image vectors correlates with a lower Levenshtein distance between the molecules InChI and vice versa.\n* I've checked several metrics used to measure distance between vectors: Euclidean, cosine, minkowski, dice, etc.\n\nSee results on a small set below\n","d2ebf041":"%%time\n\n#LOAD\nfeatures = load('..\/input\/bms-euclidean-to-levenshtein\/features.npy')\nfeatures.shape","be6d7c15":"# Results of Levenshtein average on the test w the metrics:\n\n* vectors (7,7,512) with np.linalg.norm Lev = 83.1\n* vectors flattened with np.linalg.norm Lev = 83.1\n* scipy spatial distance euclidean Lev = 83.1\n* cosine Lev = 79.4\n* braycurtis ... 79.2\n* canberra ... 81.9\n* cityblock ... 84.5\n* correlation ... 79.4\n* jensenshannon ... 78.5 \n* minkowski ... 83.1\n* dice ... 77.4\n* hamming ... 92.4\n* jaccard ... 78.7\n* **kulsinski ... 75.7**\n* rogerstanimoto ... 76.8\n* russellrao ... 76.7\n* sokalmichener ... 76.8\n* sokalsneath ... 77.4\n* yule ... 170\n"}}