{"cell_type":{"4096b057":"code","5325637e":"code","d98be8aa":"code","1cedd3fd":"code","ba643181":"code","8d802164":"code","a71e5336":"code","03d46c60":"code","ef3b8930":"code","3bda4c1a":"code","4326669b":"code","c105ee28":"code","2787e205":"code","fb2071e3":"code","d0e37d06":"code","85c7102f":"code","794044b0":"code","71f04fc9":"code","069f4852":"code","2d62a8a9":"code","c22614cc":"code","34b018a3":"code","f49cd9c9":"code","6a5b6405":"code","f3ea51b4":"code","e3813900":"code","b379c775":"markdown","62b1c73a":"markdown","2a918311":"markdown","bb2ea480":"markdown","40a73bdc":"markdown","c44c5ea4":"markdown","c3fa2407":"markdown","b36b22a6":"markdown","ee0a58e0":"markdown","36a211cc":"markdown","a8aab602":"markdown","dc0e65df":"markdown","584f357d":"markdown","79972345":"markdown","858bfa74":"markdown","a315a65b":"markdown"},"source":{"4096b057":"import pandas as pd\nimport numpy as np\n\nimport os\nimport cv2\nfrom PIL import Image\n\nfrom tqdm.auto import trange, tqdm\n\nimport keras\nimport tensorflow as tf\nfrom tqdm.keras import TqdmCallback\n\nfrom matplotlib import pyplot as plt\n%matplotlib inline\nfrom ipywidgets import interact\n\nimport plotly.express as px\nimport plotly.graph_objects as go\nimport plotly.figure_factory as ff\nfrom plotly.subplots import make_subplots","5325637e":"train = pd.read_csv('\/kaggle\/input\/digit-recognizer\/train.csv')\ntest = np.genfromtxt('\/kaggle\/input\/digit-recognizer\/test.csv', delimiter=',', skip_header=1)\nsample_submission = pd.read_csv('\/kaggle\/input\/digit-recognizer\/sample_submission.csv')","d98be8aa":"train.shape, test.shape, sample_submission.shape","1cedd3fd":"labels = train['label']\ntrain.drop(['label'], axis=1, inplace=True)","ba643181":"train = np.array(train, dtype=float)","8d802164":"train = train.reshape(42000, 28, 28)\ntest = test.reshape(28000, 28, 28)","a71e5336":"img_rows, img_cols = (32, 32)\ninput_shape = (img_rows, img_cols, 3)","03d46c60":"def resizeImage(images, new_size):\n    nimages = np.zeros((images.shape[0], new_size[0], new_size[1], 3))\n    for image in trange(images.shape[0]):\n        nimages[image, :new_size[0], :new_size[1], 0] = cv2.resize(images[image], new_size)\n        nimages[image, :new_size[0], :new_size[1], 1] = cv2.resize(images[image], new_size)\n        nimages[image, :new_size[0], :new_size[1], 2] = cv2.resize(images[image], new_size)\n    return nimages","ef3b8930":"train = resizeImage(train, (img_rows, img_cols))\ntest = resizeImage(test, (img_rows, img_cols))","3bda4c1a":"from keras.preprocessing.image import ImageDataGenerator","4326669b":"val_split = 0.05\nBATCH_SIZE = 256\nTRAIN_STEPS_PER_EPOCH = train.shape[0]*(1-val_split)\/\/BATCH_SIZE\nVAL_STEPS_PER_EPOCH = train.shape[0]*val_split\/\/BATCH_SIZE\n\ntrain_datagen = ImageDataGenerator(rescale=1\/255.0,\n                                   rotation_range=15,\n                                   zoom_range=0.15,\n                                   validation_split=val_split,\n                                   width_shift_range=0.15,\n                                   height_shift_range=0.15,\n                                   shear_range=0.15,\n                                   fill_mode='nearest')\n\ntest_datagen = ImageDataGenerator(rescale=1\/255.0)","c105ee28":"train_aug = train_datagen.flow(train,\n                               labels,\n                               batch_size=BATCH_SIZE,\n                               subset='training',\n                               shuffle=False,\n                               seed=42)\n\nvalid_aug = train_datagen.flow(train,\n                               labels,\n                               batch_size=BATCH_SIZE,\n                               subset='validation',\n                               shuffle=False,\n                               seed=42)\n\n\ntest_aug = train_datagen.flow(test,\n                              batch_size=BATCH_SIZE,\n                              shuffle=False,\n                              seed=42)","2787e205":"def build_model():\n    cnn = keras.models.Sequential()\n\n    cnn.add(keras.layers.Conv2D(filters=32, kernel_size=(3, 3), activation='relu', padding='same', kernel_initializer='random_uniform', input_shape=input_shape))\n    cnn.add(keras.layers.Dropout(0.5))\n    cnn.add(keras.layers.MaxPool2D(pool_size=(2, 2)))\n\n    cnn.add(keras.layers.Conv2D(filters=64, kernel_size=(3, 3), activation='relu', padding='same', kernel_initializer='random_uniform'))\n    cnn.add(keras.layers.Dropout(0.5))\n    cnn.add(keras.layers.MaxPool2D(pool_size=(2, 2)))\n\n    cnn.add(keras.layers.Conv2D(filters=64, kernel_size=(3, 3), activation='relu', padding='same', kernel_initializer='random_uniform'))\n    cnn.add(keras.layers.Dropout(0.5))\n    cnn.add(keras.layers.MaxPool2D(pool_size=(3, 3)))\n\n    cnn.add(keras.layers.Flatten())\n    cnn.add(keras.layers.Dense(units=128, activation='relu'))\n\n    cnn.add(keras.layers.Dense(units=10, activation='softmax'))\n    \n    cnn.compile(optimizer='rmsprop', loss='sparse_categorical_crossentropy', metrics=['acc'])\n    return cnn","fb2071e3":"cnn = build_model()","d0e37d06":"keras.utils.plot_model(cnn, show_shapes=True, show_layer_names=True)","85c7102f":"ch = tf.keras.callbacks.ModelCheckpoint(\n    filepath='mnist_model.h5',\n    save_weights_only=False,\n    monitor='acc',\n    mode='max',\n    save_best_only=True\n)\n\nes = tf.keras.callbacks.EarlyStopping(\n    monitor='acc',\n    min_delta=0.003,\n    patience=15,\n    mode='max',\n    restore_best_weights=True,\n)\n\nlr = tf.keras.callbacks.ReduceLROnPlateau(\n    monitor='acc',\n    factor=0.05,\n    patience=3,\n    mode='max',\n)","794044b0":"cnn.compile(optimizer='adam', loss='sparse_categorical_crossentropy', metrics=['acc'])","71f04fc9":"history = cnn.fit(train_aug, validation_data=valid_aug, epochs=50, verbose=0,\n                  callbacks=[ch, es, lr, TqdmCallback(verbose=1)])","069f4852":"y_pred = cnn.predict_classes(test)","2d62a8a9":"sample_submission['Label'] = y_pred\nsample_submission.to_csv('ss.csv', index=False)","c22614cc":"cnn.save('mnist_model.h5')","34b018a3":"!pip install flask gevent requests pillow flask-ngrok -q","f49cd9c9":"import os\nos.chdir('\/kaggle\/working')","6a5b6405":"html = '''<!DOCTYPE HTML>\n<!DOCTYPE HTML>\n<html lang=\"en\">\n    <head>\n        <meta http-equiv=\"Content-Type\" content=\"text\/html; charset=utf-8\" \/>\n        <title>MNIST Application<\/title>\n        <link rel=\"stylesheet\" href=\"https:\/\/codepen.io\/chriddyp\/pen\/bWLwgP.css\">\n    <\/head>\n\n    <body>\n\n        <br>\n        <center><h1 id=\"title\">MNIST Flask Application<\/h1><\/center>\n        <br>\n        <form name=\"image_form\" action=\"\/\" method=\"POST\" enctype=\"multipart\/form-data\">\n            <div style=\"width: 800px; margin: 0 auto; justify-content: center; align-items: center\">\n\n                <div style=\"width: 280px; height: 280px; float:left; border:1px solid rgb(100, 100, 100); font-size: 280px; line-height: 280px; text-align: center\">\n                    <img src=\"\" id=\"preview\" style=\"width: 280px; height: 280px; float:left;\">\n                <\/div>\n\n                <div style=\"width: 230px; height: 280px; float: left; position:relative\">\n                    <input type=\"file\" name=\"file\" id=\"filetag\" accept=\"image\/png, image\/jpeg, image\/jpg\" style=\"width: 75%; position:absolute; top: 30%; left: 12%\">\n                    <input id=\"predict\" class=\"cust_button\" type=\"submit\" value=\"Upload\" style=\"width: 75%; position:absolute; top: 50%; left: 12%\"\/> \n                <\/div>\n\n                <div style=\"width: 280px; height: 280px; float:left; border:1px solid black; font-size: 280px; line-height: 280px; text-align: center\">\n                    <span id=\"num\" style=\"\">{{number}}<\/span>\n                <\/div>\n            <\/div>\n        <\/form>\n    <\/body>\n\n    <script>\n        var fileTag = document.getElementById(\"filetag\"),\n            preview = document.getElementById(\"preview\");\n            \n        fileTag.addEventListener(\"change\", function() {\n        changeImage(this);\n        });\n\n        function changeImage(input) {\n        var reader;\n\n        if (input.files && input.files[0]) {\n            reader = new FileReader();\n\n            reader.onload = function(e) {\n            preview.setAttribute('src', e.target.result);\n            }\n\n            reader.readAsDataURL(input.files[0]);\n        }\n        }\n    <\/script>\n\n<\/html>\n'''","f3ea51b4":"!mkdir templates\n!mkdir uploads\nHTML_file = open('templates\/index.html', 'w')\nHTML_file.write(html)\nHTML_file.close()","e3813900":"# import os\n# import cv2\n# import keras\n# from flask import Flask, render_template, request\n# from flask_ngrok import run_with_ngrok\n# import numpy as np\n# from matplotlib import pyplot as plt\n\n# app = Flask(__name__, static_folder='\/kaggle\/working\/templates')\n# run_with_ngrok(app)\n\n# app.config['UPLOADS'] = 'uploads'\n\n# cnn = keras.models.load_model('\/kaggle\/working\/mnist_model.h5')\n\n# def process(file):\n#     image = cv2.imread(file)\n#     image = cv2.resize(image, (32, 32))\n#     image = np.resize(image, (1, 32, 32, 3))\n#     image = image\/255.0\n#     image = 1-image\n#     return image\n\n# @app.route('\/')\n# def index():\n#     return render_template('index.html')\n\n# @app.route('\/', methods=['GET', 'POST'])\n# def predict():\n#     if request.method == 'POST':\n#         file = request.files['file']\n#         filepath = f'uploads\/{file.filename}'\n#         file.save(filepath)\n#         image = process(filepath)\n#         print('process done')\n#         prediction = cnn.predict_classes(image)\n        \n#         return render_template('index.html', number=prediction[0])\n\n# if __name__ == '__main__':\n#     app.run()","b379c775":"<h1 style=\"background-color:#2d6187;color:white;font-family:Arial;font-size:350%;text-align:center\">CNN<\/h1>","62b1c73a":"<h1 style=\"background-color:#2d6187;color:white;font-family:Arial;font-size:350%;text-align:center\">Flask Application<\/h1>","2a918311":"Saving the HTML file","bb2ea480":"#### Flask Application\n\nThe below code has been commented out in order to allow me to save this kernal. To run the web application, uncomment the below code and run it.","40a73bdc":"<h4 style=\"background-color:#2d6187;color:white;font-family:Arial;font-size:350%;text-align:center\">Thank you<\/h4>","c44c5ea4":"Resizing images from (28, 28) -> (32, 32)","c3fa2407":"Reshaping train and images test to 2D","b36b22a6":"Every web application needs an HTML file, this is ours. It's very simple, but gets the job done.\nFeel free to replace this with yours!","ee0a58e0":"<a href=\"https:\/\/kritikseth.github.io\/ipynbtagredirect\" target=\"_parent\"><img src=\"https:\/\/raw.githack.com\/kritikseth\/kritikseth\/master\/assets\/icons\/kritik_ipynbtagredirect.svg\" alt=\"Kritik Seth\"\/><\/a>","36a211cc":"Purpose of this notebook is to build a CNN model and make a flask application to predict numbers all in one place.\nTo try out the application. Click on Copy and Edit button on top-right of the notebook, uncomment the last cell and press Run All","a8aab602":"**Callbacks**\n\nToo many epochs can lead to overfitting of the training dataset, whereas too few may result in an underfit model. Callbacks provide a way to execute code and interact with the training model process automatically.\n\nHere we implement the following callbacks:\n* ModelCheckpoint- saves the model, when the accuracy is has the maximum value\n* Early Stopping- stops the training of the model when the value of accuracy does not increase in a specified number of rounds by a specified value\n* ReduceLRonPlateau- Decrease the value of learning rate by a factor when the accuracy is flattening out\n* TqdmCallback- just a pretty way to keep track of epochs :)\n","dc0e65df":"This section of notebook focuses on building a flask application and running it using ngrok","584f357d":"> P.S.: You can use this application in your phone browser as well, just copy paste the link and you are ready to go :)","79972345":"#### Augmenting Images\n\nImage augmentation is one useful technique in building convolutional neural networks that can increase the size of the training set without acquiring new images. The idea is simple; duplicate images with some kind of variation so the model can learn from more examples.","858bfa74":"Please Upvote the notebook if you like the notebook and appreciate the efforts! :D\n\nContact me:\n* [LinkedIn](https:\/\/www.linkedin.com\/in\/kritikseth\/)\n* [GitHub](http:\/\/github.com\/kritikseth)\n* [Email](mailto:sethkritik@gmail.com)","a315a65b":"### Importing Libraries"}}