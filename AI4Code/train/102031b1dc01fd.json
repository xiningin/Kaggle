{"cell_type":{"b61fa419":"code","335d12f5":"code","a88b006f":"code","cdf5624e":"code","b2bb3e42":"code","dbb0d73d":"code","03398700":"code","24c0f1d4":"code","29e48e56":"code","e369e8be":"code","78ade2ec":"code","83f227aa":"code","6937a334":"code","06fbdac1":"code","07499d09":"code","53746dea":"code","daf94c42":"code","4fc1f6e7":"code","ff4afc25":"code","9ccc0755":"code","3c55f8ac":"code","142e4cb8":"code","38215118":"code","32ce2233":"code","eec574b7":"code","a7f4e115":"code","5dd6beb4":"code","745cdf7f":"code","0a957609":"code","e00e1b11":"code","da4ee270":"code","d520ffc3":"code","36a104d9":"code","23fb4e01":"code","aebff28b":"code","6890663c":"code","b843f639":"code","fad977c2":"code","5ceaf378":"code","f1a4745d":"code","75459f31":"code","f65849b1":"markdown","5305c17a":"markdown","8b30d2f4":"markdown","6e62ee38":"markdown"},"source":{"b61fa419":"%reload_ext autoreload\n%autoreload 2\n%matplotlib inline","335d12f5":"from fastai.utils.collect_env import show_install\nshow_install()","a88b006f":"from fastai.callbacks.tracker import *","cdf5624e":"import matplotlib.pyplot as plt\nfrom fastai.vision import *\nimport random \nimport gc","b2bb3e42":"def reset_seed(seed=42):\n    random.seed(seed)\n    os.environ['PYTHONHASHSEED'] = str(seed)\n#     tf.set_random_seed(seed)\n    np.random.seed(seed)\n    torch.manual_seed(seed)\n    torch.backends.cudnn.deterministic = True\n    if torch.cuda.is_available(): \n        torch.cuda.manual_seed(seed)\n        torch.cuda.manual_seed_all(seed)\nreset_seed()","dbb0d73d":"PATH = \"..\/input\/\"\n# TMP_PATH = \"\/tmp\/tmp\"\n# MODEL_PATH = \"\/tmp\/model\/\"","03398700":"path = Path(PATH)\npath_anno = path\/'annotations\/annotations'\npath_img = path\/'images\/images'","24c0f1d4":"fnames = get_image_files(path_img)","29e48e56":"def get_data(bs,size,seed=42):\n    reset_seed(seed)\n    pat = r'\/([^\/]+)_\\d+.jpg$'\n    return ImageDataBunch.from_name_re(path_img,fnames,pat,valid_pct=0.15,ds_tfms = get_transforms(),\n                                      size=size,bs=bs).normalize(imagenet_stats)","e369e8be":"def create_learner(data,is_fp16=False,seed=42):\n    reset_seed(seed)\n    learn = cnn_learner(data,models.resnet50,metrics=accuracy,path = os.getcwd(),\n                       callback_fns=[partial(SaveModelCallback, monitor='val_loss',mode='min',every='improvement')])\n    if is_fp16:\n        learn = learn.to_fp16()\n    return learn\n\ndef create_learner_lr_find(data,is_fp16=False,seed=42):\n    reset_seed(seed)\n    learn = cnn_learner(data,models.resnet50,metrics=accuracy,path = os.getcwd())\n    if is_fp16:\n        learn = learn.to_fp16()\n    return learn","78ade2ec":"# del data\n# del learn\n# gc.collect()","83f227aa":"data= get_data(32,224)","6937a334":"learn = create_learner_lr_find(data,True)\nlearn.lr_find()\nlearn.recorder.plot()","06fbdac1":"learn = create_learner(data,True)","07499d09":"reset_seed()\nlearn.freeze()\nlearn.fit_one_cycle(13,max_lr=2.8e-03)\nlearn.recorder.plot_losses()","53746dea":"learn.save('224-stage1')","daf94c42":"# learn.load('224-bs32-13epochs-stage1');","4fc1f6e7":"from sklearn.metrics import accuracy_score\ny_pred = learn.get_preds(with_loss=True)\nprint(accuracy_score(learn.data.valid_ds.y.items,np.argmax(to_np(y_pred[0]),axis=1)))\nprint(y_pred[2].mean())","ff4afc25":"# del data\n# del learn\n# gc.collect()","9ccc0755":"data= get_data(32,224)\n\nlearn = create_learner_lr_find(data,True)\n# learn.load('224-stage1');","3c55f8ac":"learn.load('224-stage1');\nlearn.unfreeze()\nlearn.lr_find()\nlearn.recorder.plot()","142e4cb8":"learn.unfreeze()\nlearn.lr_find()\nlearn.recorder.plot()","38215118":"learn = create_learner(data,True)\nlearn.load('224-stage1');\nlearn.unfreeze()\nlearn.fit_one_cycle(3,max_lr=slice(1e-06,4e-06))\nlearn.recorder.plot_losses()","32ce2233":"learn.save('224-stage2')","eec574b7":"del data\ndel learn\ngc.collect()","a7f4e115":"data= get_data(20,300)","5dd6beb4":"learn = create_learner_lr_find(data,True)\nlearn.load('224-stage2');","745cdf7f":"learn.freeze()\nlearn.lr_find()\nlearn.recorder.plot()","0a957609":"learn.freeze()\nlearn.lr_find()\nlearn.recorder.plot()","e00e1b11":"learn = create_learner(data,True)\nlearn.load('224-stage2');","da4ee270":"learn = create_learner(data,True)\nlearn.load('224-stage2');\nlearn.freeze()\nlearn.fit_one_cycle(3,max_lr=1e-05)\nlearn.recorder.plot_losses()","d520ffc3":"# learn = create_learner(data,True)\n# learn.load('224-stage2');\n# learn.freeze()\n# learn.fit_one_cycle(3,max_lr=2e-05)\n# learn.recorder.plot_losses()","36a104d9":"learn.save('300-stage1')","23fb4e01":"del data\ndel learn\ngc.collect()","aebff28b":"data= get_data(15,300)\n\nlearn = create_learner_lr_find(data,True)\nlearn.load('300-stage1');","6890663c":"learn.unfreeze()\nlearn.lr_find()\nlearn.recorder.plot()","b843f639":"learn.unfreeze()\nlearn.lr_find()\nlearn.recorder.plot()","fad977c2":"learn = create_learner(data,True)\nlearn.load('300-stage1');\nlearn.unfreeze()\nlearn.fit_one_cycle(6,max_lr=slice(1e-06,1.2e-04))\nlearn.recorder.plot_losses()","5ceaf378":"# learn = create_learner(data,True)\n# learn.load('300-stage1');\n# learn.unfreeze()\n# learn.fit_one_cycle(4,max_lr=slice(1e-06,1.2e-04))\n# learn.recorder.plot_losses()","f1a4745d":"learn.save('300-stage2');","75459f31":"learn.data.c","f65849b1":"# Stage 2","5305c17a":"# Stage 1 size 224","8b30d2f4":"# Stage 2 size 224","6e62ee38":"# Stage 1 size 300"}}