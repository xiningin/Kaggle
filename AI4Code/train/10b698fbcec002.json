{"cell_type":{"7af7985e":"code","047c9a5d":"code","1ffbf7a2":"code","07a8f16c":"code","bc718cc1":"code","2f397b87":"code","8399f8bd":"code","55a51300":"code","16260dc9":"code","27ef9847":"code","c1b4cf95":"code","e9575ae4":"code","f9b42e03":"code","26f5d563":"code","81f2fa0c":"code","89704135":"code","bbd8779e":"code","a90298c1":"code","37b8234d":"code","d6a489c0":"code","9e832ee7":"code","f9501389":"code","f435d8e4":"code","62a9f360":"code","41636db4":"code","e6512aa0":"code","01179e73":"code","b05f4b1e":"code","08107cc1":"code","bbf1e867":"code","a46ccf84":"code","6c60e373":"code","5274ee77":"code","cb16bd92":"code","6e3af475":"code","46ef7014":"code","706bbefa":"code","e5739ddd":"code","e71b2067":"code","819c49fb":"code","53b301d0":"code","a8f829d8":"code","37bd29a0":"code","615183af":"code","1b45f6f8":"code","088f2882":"code","70cad74d":"code","17ab7816":"code","02b8d806":"code","d9fa859b":"code","c4548281":"code","8b6e933c":"markdown","5b7684c2":"markdown","5e877278":"markdown","d2000433":"markdown","4aa25be6":"markdown","96e698bf":"markdown","2f9d76ad":"markdown","22ae2575":"markdown","db1480a8":"markdown","3a97c5cf":"markdown","b807e662":"markdown","a4a25718":"markdown","a035a998":"markdown","d4782080":"markdown","3babfa5b":"markdown","aaf33a5e":"markdown","fe3e22d8":"markdown","b5da8446":"markdown","37963751":"markdown","4e5bc894":"markdown","8d35bd1a":"markdown","6ae2e520":"markdown","af0c8e0d":"markdown","84eb595f":"markdown","7d50a256":"markdown"},"source":{"7af7985e":"from fastai.imports import *\nos. listdir('..\/input\/')","047c9a5d":"df = pd.read_csv('..\/input\/caravan-insurance-challenge.csv')\noriginal = df.copy()\ndf.head()","1ffbf7a2":"labels = ['ORIGIN', 'CustomerSubtype', 'NumberOfHouses1', 'AvgSizeHousehold1', 'AvgAge', 'CustomerMainType', 'RomanCatholic', 'Protestant...', 'OtherReligion', 'NoReligion', 'Married', 'LivingTogether', 'OtherRelation', 'Singles', 'HouseholdWithoutChildren', 'HouseholdWithChildren', 'HighLevelEducation', 'MediumLevelEducation', 'LowerLevelEducation', 'HighStatus', 'Entrepreneur', 'Farmer', 'MiddleManagement', 'SkilledLabourers', 'UnskilledLabourers', 'SocialClassA', 'SocialClassB1', 'SocialClassB2', 'SocialClassC', 'SocialClassD', 'RentedHouse', 'HomeOwners', '1Car', '2Cars', 'NoCar', 'NationalHealthService', 'PrivateHealthInsurance', 'Income<30.000', 'Income30-45.000', 'Income45-75.000', 'Income75-122.000', 'Income>123.000', 'AverageIncome', 'PurchasingPowerClass', 'ContributionPrivateThirdPartyInsurance', 'ContributionThirdPartyInsurance(firms)...', 'ContributionThirdPartyInsurane(agriculture)', 'ContributionCarPolicies', 'ContributionDeliveryVanPolicies', 'ContributionMotorcycle\/scooterPolicies', 'ContributionLorryPolicies', 'ContributionTrailerPolicies', 'ContributionTractorPolicies', 'ContributionAgriculturalMachinesPolicies', 'ContributionMopedPolicies', 'ContributionLifeInsurances', 'ContributionPrivateAccidentInsurancePolicies', 'ContributionFamilyAccidentsInsurancePolicies', 'ContributionDisabilityInsurancePolicies', 'ContributionFirePolicies', 'ContributionSurfboardPolicies', 'ContributionBoatPolicies', 'ContributionBicyclePolicies', 'ContributionPropertyInsurancePolicies', 'ContributionSocialSecurityInsurancePolicies', 'NumberOfPrivateThirdPartyInsurance1-12', 'NumberOfThirdPartyInsurance(firms)...', 'NumberOfThirdPartyInsurane(agriculture)', 'NumberOfCarPolicies', 'NumberOfDeliveryVanPolicies', 'NumberOfMotorcycle\/scooterPolicies', 'NumberOfLorryPolicies', 'NumberOfTrailerPolicies', 'NumberOfTractorPolicies', 'NumberOfAgriculturalMachinesPolicies', 'NumberOfMopedPolicies', 'NumberOfLifeInsurances', 'NumberOfPrivateAccidentInsurancePolicies', 'NumberOfFamilyAccidentsInsurancePolicies', 'NumberOfDisabilityInsurancePolicies', 'NumberOfFirePolicies', 'NumberOfSurfboardPolicies', 'NumberOfBoatPolicies', 'NumberOfBicyclePolicies', 'NumberOfPropertyInsurancePolicies', 'NumberOfSocialSecurityInsurancePolicies', 'CARAVAN']","07a8f16c":"df.columns = labels\ndf.shape","bc718cc1":"df.CARAVAN.value_counts().plot.pie(autopct='%1.1f%%', shadow=True, startangle=140,explode=(0.5, 0))","2f397b87":"yes = df[df.CARAVAN == 1].copy()","8399f8bd":"plt.figure(figsize=(15,8))\nyes['CustomerSubtype'].value_counts().plot(kind='bar', align='center',color='deepskyblue', grid=True);","55a51300":"plt.figure(figsize=(15,8))\nyes['AvgAge'].value_counts().plot(kind='bar', align='center',color='deepskyblue', grid=True);","16260dc9":"plt.figure(figsize=(15,8))\nyes['CustomerMainType'].value_counts().plot(kind='bar', align='center',color='deepskyblue', grid=True);","27ef9847":"from sklearn.metrics import confusion_matrix\nfrom sklearn.metrics import precision_score\nfrom sklearn.metrics import recall_score","c1b4cf95":"train = df[df.ORIGIN == 'train'].copy()\ntest = df[df.ORIGIN == 'test'].copy()","e9575ae4":"Train_Y = train.CARAVAN\nTrain_X = train.drop(['CARAVAN','ORIGIN'], axis=1)\n","f9b42e03":"Test_Y = test.CARAVAN\nTest_X = test.drop(['CARAVAN','ORIGIN'], axis=1)\n","26f5d563":"from sklearn import neighbors\nprint(\"Nearest Neighbors Dataframe Test score :\")\nclf = neighbors.KNeighborsClassifier(3,'distance')\nclf.fit(X=Train_X,y=Train_Y)\nclf.score(Test_X,Test_Y)","81f2fa0c":"KNN_y_pred_class = clf.predict(Test_X)\nclass_names = np.unique(np.array(Test_Y))\nconfusion_matrix(Test_Y, KNN_y_pred_class)","89704135":"from sklearn.metrics import classification_report\nprint(classification_report(Test_Y, KNN_y_pred_class))","bbd8779e":"from sklearn.metrics import roc_curve, auc\nknn_pred_prob = clf.predict_proba(Test_X)[:, 1]\nfpr, tpr, thresholds = roc_curve(Test_Y, knn_pred_prob)\nroc_auc = auc(fpr, tpr)\nlw = 2\nplt.plot(fpr, tpr,label='ROC curve KNN (AUC = %0.2f)' % roc_auc)\nplt.xlim([0.0, 1])\nplt.ylim([0.0, 1])\nplt.title('ROC curve for KNN CLASS 1')\nplt.xlabel('(1 - Specificity)')\nplt.ylabel('(Sensitivity)')\nplt.grid(True)\nplt.legend(loc=\"lower right\")\nplt.show()","a90298c1":"from sklearn.svm import SVC\nclf_S = SVC(kernel='rbf',probability=True,random_state=0, gamma=.01, C=100000)\nclf_S.fit(Train_X, Train_Y) \nprint(\"SVM Dataframe Test score :\")\nprint(clf_S.score(Test_X,Test_Y))","37b8234d":"SVM_y_pred_class = clf_S.predict(Test_X)\nclass_names = np.unique(np.array(Test_Y))\nconfusion_matrix(Test_Y, SVM_y_pred_class)","d6a489c0":"from sklearn.metrics import classification_report\nreport = classification_report(Test_Y,SVM_y_pred_class)\nprint(report)","9e832ee7":"from sklearn.metrics import roc_curve, auc\nsvm_pred_prob = clf_S.predict_proba(Test_X)[:, 1]\nfpr, tpr, thresholds = roc_curve(Test_Y, svm_pred_prob)\nroc_auc = auc(fpr, tpr)\nlw = 2\nplt.plot(fpr, tpr,label='ROC curve SVM (AUC = %0.2f)' % roc_auc)\nplt.xlim([0.0, 1])\nplt.ylim([0.0, 1])\nplt.title('ROC curve for SVM CLASS 1')\nplt.xlabel('(1 - Specificity)')\nplt.ylabel('(Sensitivity)')\nplt.grid(True)\nplt.legend(loc=\"lower right\")\nplt.show()","f9501389":"from sklearn import tree\nclf_tree = tree.DecisionTreeClassifier()\nclf_tree.fit(Train_X, Train_Y) \nprint(clf_tree.score(Test_X,Test_Y))","f435d8e4":"tree_y_pred_class = clf_tree.predict(Test_X)\nclass_names = np.unique(np.array(Test_Y))\nconfusion_matrix(Test_Y, tree_y_pred_class)","62a9f360":"print(classification_report(Test_Y, KNN_y_pred_class))","41636db4":"from sklearn.metrics import roc_curve, auc\ntree_pred_prob = clf_tree.predict_proba(Test_X)[:, 1]\nfpr, tpr, thresholds = roc_curve(Test_Y, tree_pred_prob)\nroc_auc = auc(fpr, tpr)\nlw = 2\nplt.plot(fpr, tpr,label='ROC curve Decision Tree (AUC = %0.2f)' % roc_auc)\nplt.xlim([0.0, 1])\nplt.ylim([0.0, 1])\nplt.title('ROC curve for Decision Tree CLASS 1')\nplt.xlabel('(1 - Specificity)')\nplt.ylabel('(Sensitivity)')\nplt.grid(True)\nplt.legend(loc=\"lower right\")\nplt.show()","e6512aa0":"from sklearn.ensemble import RandomForestClassifier\nrf = RandomForestClassifier()\nrf.fit(Train_X, Train_Y) \nprint(rf.score(Test_X,Test_Y))","01179e73":"rf_y_pred_class = rf.predict(Test_X)\nclass_names = np.unique(np.array(Test_Y))\nconfusion_matrix(Test_Y, rf_y_pred_class)","b05f4b1e":"print(classification_report(Test_Y, rf_y_pred_class))","08107cc1":"from sklearn.metrics import roc_curve, auc\nrf_pred_prob = rf.predict_proba(Test_X)[:, 1]\nfpr, tpr, thresholds = roc_curve(Test_Y, rf_pred_prob)\nroc_auc = auc(fpr, tpr)\nlw = 2\nplt.plot(fpr, tpr,label='ROC curve  Random Forest (AUC = %0.2f)' % roc_auc)\nplt.xlim([0.0, 1])\nplt.ylim([0.0, 1])\nplt.title('ROC curve for  random forest CLASS 1')\nplt.xlabel('(1 - Specificity)')\nplt.ylabel('(Sensitivity)')\nplt.grid(True)\nplt.legend(loc=\"lower right\")\nplt.show()","bbf1e867":"rf = RandomForestClassifier(n_estimators=100,max_leaf_nodes=3)\nrf.fit(Train_X, Train_Y) \nprint(rf.score(Test_X,Test_Y))","a46ccf84":"rf_y_pred_class = rf.predict(Test_X)\nclass_names = np.unique(np.array(Test_Y))\nconfusion_matrix(Test_Y, rf_y_pred_class)","6c60e373":"print(classification_report(Test_Y, rf_y_pred_class))","5274ee77":"from sklearn.metrics import roc_curve, auc\nrf_pred_prob = rf.predict_proba(Test_X)[:, 1]\nfpr, tpr, thresholds = roc_curve(Test_Y, rf_pred_prob)\nroc_auc = auc(fpr, tpr)\nlw = 2\nplt.plot(fpr, tpr,label='ROC curve  Random Forest (AUC = %0.2f)' % roc_auc)\nplt.xlim([0.0, 1])\nplt.ylim([0.0, 1])\nplt.title('ROC curve for  random forest CLASS 1')\nplt.xlabel('(1 - Specificity)')\nplt.ylabel('(Sensitivity)')\nplt.grid(True)\nplt.legend(loc=\"lower right\")\nplt.show()","cb16bd92":"def rf_feat_importance(m, df):\n    return pd.DataFrame({'cols':df.columns, 'imp':m.feature_importances_}\n                       ).sort_values('imp', ascending=False)\ndef plot_fi(fi): return fi.plot('cols', 'imp', 'barh', figsize=(12,7), legend=False)\nfi = rf_feat_importance(rf, Train_X); fi[:10]","6e3af475":"plot_fi(fi[:30]);","46ef7014":"from imblearn.ensemble import BalancedRandomForestClassifier","706bbefa":"brf=BalancedRandomForestClassifier()","e5739ddd":"brf.fit(X=Train_X,y=Train_Y)","e71b2067":"print(\"Test score :\")\nprint(brf.score(Test_X,Test_Y))","819c49fb":"from sklearn.metrics import roc_curve, auc\nbrf_pred_prob = brf.predict_proba(Test_X)[:, 1]\nfpr, tpr, thresholds = roc_curve(Test_Y, brf_pred_prob)\nroc_auc = auc(fpr, tpr)\nlw = 2\nplt.plot(fpr, tpr,label='ROC curve Balanced Random Forest (AUC = %0.2f)' % roc_auc)\nplt.xlim([0.0, 1])\nplt.ylim([0.0, 1])\nplt.title('ROC curve for Balanced random forest CLASS 1')\nplt.xlabel('(1 - Specificity)')\nplt.ylabel('(Sensitivity)')\nplt.grid(True)\nplt.legend(loc=\"lower right\")\nplt.show()","53b301d0":"from sklearn.discriminant_analysis import LinearDiscriminantAnalysis as LDA\nlda = LDA()\nlda.fit(X=Train_X,y=Train_Y)","a8f829d8":"print(\"Test score :\")\nprint(lda.score(Test_X,Test_Y))","37bd29a0":"lda_pred_prob = lda.predict_proba(Test_X)[:, 1]\nfpr, tpr, thresholds = roc_curve(Test_Y, lda_pred_prob)\nroc_auc = auc(fpr, tpr)\nlw = 2\nplt.plot(fpr, tpr,label='ROC curve LDA (AUC = %0.2f)' % roc_auc)\nplt.xlim([0.0, 1])\nplt.ylim([0.0, 1])\nplt.title('ROC curve for Balanced random forest CLASS 1')\nplt.xlabel('(1 - Specificity)')\nplt.ylabel('(Sensitivity)')\nplt.grid(True)\nplt.legend(loc=\"lower right\")\nplt.show()","615183af":"from xgboost import XGBClassifier\ntrain = original[original.ORIGIN == 'train'].copy()\ntest = original[original.ORIGIN == 'test'].copy()\n\nm = XGBClassifier()\n# Add silent=True to avoid printing out updates with each cycle\nTrain_Y = train.CARAVAN\nTrain_X = train.drop(['CARAVAN','ORIGIN'], axis=1)\nTest_Y = test.CARAVAN\nTest_X = test.drop(['CARAVAN','ORIGIN'], axis=1)\nm.fit(Train_X,Train_Y, verbose=False)\n","1b45f6f8":"print(\"Test score :\")\nprint(m.score(Test_X,Test_Y))","088f2882":"xgb_pred_prob = m.predict_proba(Test_X)[:, 1]\nfpr, tpr, thresholds = roc_curve(Test_Y, xgb_pred_prob)\nroc_auc = auc(fpr, tpr)\nlw = 2\nplt.plot(fpr, tpr,label='ROC curve LDA (AUC = %0.2f)' % roc_auc)\nplt.xlim([0.0, 1])\nplt.ylim([0.0, 1])\nplt.title('ROC curve for Balanced random forest CLASS 1')\nplt.xlabel('(1 - Specificity)')\nplt.ylabel('(Sensitivity)')\nplt.grid(True)\nplt.legend(loc=\"lower right\")\nplt.show()","70cad74d":"fpr6, tpr6, thresholds6 = roc_curve(Test_Y, lda_pred_prob)\nroc_auc6 = auc(fpr6, tpr6)\n\nfpr5, tpr5, thresholds5 = roc_curve(Test_Y, knn_pred_prob)\nroc_auc5 = auc(fpr5, tpr5)\n\nfpr4, tpr4, thresholds4 = roc_curve(Test_Y, rf_pred_prob)\nroc_auc4 = auc(fpr4, tpr4)\n\nfpr3, tpr3, thresholds3 = roc_curve(Test_Y, xgb_pred_prob)\nroc_auc3 = auc(fpr3, tpr3)\n\nfpr2, tpr2, thresholds2 = roc_curve(Test_Y, brf_pred_prob)\nroc_auc2 = auc(fpr2, tpr2)\n\nfpr1, tpr1, thresholds1 = roc_curve(Test_Y,svm_pred_prob)\nroc_auc1 = auc(fpr1, tpr1)\nlw = 2\nplt.plot(fpr6, tpr6,color='orange',label='ROC curve LDA (AUC = %0.2f)' % roc_auc6)\nplt.plot(fpr5, tpr5,color='green',label='ROC curve KNN (AUC = %0.2f)' % roc_auc5)\nplt.plot(fpr4, tpr4,color='gold',label='ROC curve RF (AUC = %0.2f)' % roc_auc4)\nplt.plot(fpr3, tpr3,color='gold',label='ROC curve XGBOOST (AUC = %0.2f)' % roc_auc3)\nplt.plot(fpr2, tpr2,color='black',label='ROC curve BRF (AUC = %0.2f)' % roc_auc2)\nplt.plot(fpr1, tpr1,color='navy',label='ROC curve SVM (AUC = %0.2f)' % roc_auc1)\nplt.xlim([0.0, 1.0])\nplt.ylim([0.0, 1.0])\nplt.title('ROC curve ')\nplt.xlabel('(1 - Specificity)')\nplt.ylabel('(Sensitivity)')\nplt.grid(True)\nplt.legend(loc=\"lower right\")\nplt.show()","17ab7816":"test_target = Test_Y.copy()\ntest_target.reset_index(drop=True, inplace=True)\ntest_target=test_target.replace({\n    1:'Yes',\n    0:'No'\n})\npredicted_target=brf.predict(Test_X)\npredicted_target=pd.Series(predicted_target).replace({\n    1:'Yes',\n    0:'No'\n})","02b8d806":"ranks=pd.DataFrame(data={\n    'realClass':test_target,\n    'predictedClass':predicted_target,\n    'rank':brf_pred_prob\n})\nranks.sort_values(by=['rank'],ascending=False,inplace=True)\nranks.head()","d9fa859b":"top = ranks.where(ranks['rank']>0.5,).dropna()\ntop.head()","c4548281":"top.shape","8b6e933c":" ### XGBOOST","5b7684c2":"The curves for each model are thus indicative of relative predictive power of each model. For instance, BRF model has higher probability of accurate prediction of correct class member, and gaining high level of accuracy prediction probability as compared to RP and SVM models.  xgboost is close .\n","5e877278":"# Conclusion\n","d2000433":"###  Objective\nThe main objective here is to score clients so we know who to email . We will evaluate our models using ROC curve and AUC.","4aa25be6":"### Customer Sub Type","96e698bf":"<br>","2f9d76ad":"### Number of houses","22ae2575":"### Customer main type ","db1480a8":"This model seems good enough let's plot feature importance using a function from the fast ai library","3a97c5cf":" ### LDA model","b807e662":"### Decision Tree\n","a4a25718":"This balanced random forest model seems to be outperforming the others , trying to tune it doesn't seem to improve our AUC.","a035a998":"## Random Forest","d4782080":"## KNN","3babfa5b":"## Comparing the models ","aaf33a5e":"A small tuning of the random forest gets us an even better AUC","fe3e22d8":"Our modeling process has provided some useful insights about the target market. In particular, it can be safely concluded that the target market is probably not a single group. There are at least two main customer profiles who are likely to own caravans and therefore are potential buyers of Caravan Insurance. For marketing purposes, each group would probably need to be approached in different ways, both in terms of the communication message as well as the medium of communication.\nWe identified 1307 customer who have higher probability of answering our mails ( Please note that in the original competition we didn't have the real class of the test set and so we built a mailing strategy accordingly )","b5da8446":"### Conclusion:\n\n   - It's a dataset with 9822 observations.\n   - The dataset is without null values and outliers\n   - The dataset is imbalanced as Yes answer represent only 6%\n","37963751":"## Balanced Models\n### Balanced Random Forest","4e5bc894":"## Data preparation","8d35bd1a":"### Age","6ae2e520":"adding the real labels :\n(sorry for the messy cell will be the only one i promise :p )","af0c8e0d":"### SVM\n","84eb595f":"# Model Training ","7d50a256":"# Scoring:\nBalanced Random Forest seems to offer the best results with an AUC of 0.73 , we will use this model for our scoring"}}