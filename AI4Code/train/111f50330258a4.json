{"cell_type":{"6c2c82ac":"code","b171e3d6":"code","dfcf56e9":"code","7278dc86":"code","2453dc2f":"code","df9a584e":"code","efb14bd9":"code","533360d9":"code","964ffa9e":"code","00ce6973":"code","ba5acba0":"code","a52431d9":"code","3be7f9c8":"code","ec918474":"code","da063ce5":"code","84c373ca":"code","294cf2db":"code","0d12d1b6":"code","17e91132":"code","a8ad9464":"code","4980e9d2":"code","6de0124c":"code","80e14e3b":"code","c2cbcf03":"code","c3898af0":"code","182534a2":"code","91c923ba":"code","25ec6e51":"code","55fb4994":"code","16174b34":"code","3ad0ee2a":"code","3bce5cc7":"code","7686c0f7":"code","1df1f790":"code","df5ad187":"code","e51dbd99":"code","53c84333":"code","79e0f807":"code","c24ec827":"code","94c1a58e":"code","cb57debe":"code","972e1670":"code","c3ebade5":"code","c802c336":"code","64ab92d4":"code","95ccee30":"code","23c987a4":"code","8a11fd30":"code","2a041520":"code","089f31b8":"code","82212dde":"code","469f27aa":"code","ad2430f3":"code","73f30cf4":"code","15be3ff4":"code","8ae1cce9":"code","de8e374e":"code","b0e81201":"code","0f897e48":"code","7ad0a6e9":"code","d211ccb7":"code","df0faf41":"code","4a0159ff":"code","fb1b956c":"code","eb4c617c":"code","36d35851":"code","3464aab0":"code","0089cfec":"code","71de04de":"markdown","a2f4b526":"markdown","b3ef8b2a":"markdown","ed4ee8d8":"markdown","70ceb714":"markdown","7d4245ca":"markdown","2c9c2b5e":"markdown","4d4cefca":"markdown","b9018002":"markdown","60d70765":"markdown","8ee3593d":"markdown","4242c840":"markdown","f56ec800":"markdown","ca6339f4":"markdown","e811b92f":"markdown","8c77f265":"markdown","fd549f68":"markdown","566b23eb":"markdown","7ce9358c":"markdown","e0baef48":"markdown","7031df05":"markdown","06bc98f4":"markdown","7bc59d70":"markdown","883c32dd":"markdown","ea39a56c":"markdown","e5bfdb73":"markdown"},"source":{"6c2c82ac":"import numpy as np\nimport pandas as pd\nimport matplotlib.pyplot as plt\nimport matplotlib.style as style\n%matplotlib inline\n\nimport seaborn as sns","b171e3d6":"style.use(\"fivethirtyeight\")","dfcf56e9":"listings = pd.read_csv(\"\/kaggle\/input\/berlin-airbnb-data\/listings_summary.csv\")","7278dc86":"listings.shape","2453dc2f":"# define the columns to keep\ncolumn_names=['id', \n       \n       'host_id', \n       'host_total_listings_count',  \n\n       'neighbourhood_group_cleansed',  \n       'latitude', 'longitude',\n              \n       'property_type', 'room_type', 'accommodates',\n       'bathrooms', 'bedrooms', \n       'amenities',      \n              \n       'price',  'security_deposit', 'extra_people',\n       'cleaning_fee',\n        'minimum_nights',\n       'maximum_nights', \n       \n       'number_of_reviews', \n       'cancellation_policy'\n             ]","df9a584e":"data = listings[column_names]\nprint(data.shape)","efb14bd9":"data.info()","533360d9":"data[['price', 'cleaning_fee', 'extra_people','security_deposit']].head(2)","964ffa9e":"## clean price columns\n\nprices=['price', 'cleaning_fee', 'extra_people', 'security_deposit']\n\nfor p in prices:\n    data[p]=pd.Series([str(s).replace('$', '').replace(',', '') for s in data[p]]).astype(float)\n    ","00ce6973":"data[['price', 'cleaning_fee', 'extra_people', 'security_deposit']].head(2)","ba5acba0":"data.security_deposit.fillna(0, inplace=True)\ndata.cleaning_fee.fillna(0,inplace=True)","a52431d9":"#missing values\ndata.isnull().sum()","3be7f9c8":"data.dropna(inplace=True)","ec918474":"data.shape","da063ce5":"data[\"price\"].describe()\n# appears we have some extreme outliers","84c373ca":"plt.figure(figsize=(10,2))\nax=sns.boxplot(data[\"price\"],color=\"darkblue\")\nax.set(xlim=(0, 500))","294cf2db":"plt.figure(figsize=(30,5))\nsns.boxplot(x=\"property_type\",y=\"price\",data=data)","0d12d1b6":"data = data[(data['property_type'] == 'Apartment')]\ndata.drop(['property_type'], axis=1, inplace=True)","17e91132":"len(data[data[\"price\"]>200])","a8ad9464":"len(data[data[\"price\"]>200])\ndata=data[data[\"price\"]<200]\n\nlen(data[data[\"price\"]==0])\ndata=data[data[\"price\"]>0] ","4980e9d2":"viz1=data.plot(kind=\"scatter\", x=\"longitude\", y=\"latitude\", alpha=0.4, figsize=(10,7), \n        c=\"price\", cmap=\"gist_heat_r\", colorbar=True, sharex=False)\n\nberlin_centre = (52, 13)","6de0124c":"sns.distplot(data[\"price\"],kde=False)","80e14e3b":"sns.distplot(np.log1p(data[\"price\"]),kde=False)","c2cbcf03":"data=data[data[\"price\"]<160]","c3898af0":"data.shape","182534a2":"plt.figure(figsize=(10,5))\ndata['neighbourhood_group_cleansed'].value_counts().sort_values().plot(kind='barh', color='darkblue')\nplt.title('Number of Accommodations per District');","91c923ba":"plt.figure(figsize=(20,5))\n\nchart=sns.boxplot(x=\"neighbourhood_group_cleansed\", y=\"price\", data=data, palette=\"viridis\")\nchart.set_xticklabels(chart.get_xticklabels(), rotation=45, horizontalalignment='right', fontsize=18)\nplt.title('Neighbourhood price distribution')\nchart","25ec6e51":"sns.boxplot(x=\"bedrooms\", y=\"price\", data=data,palette=\"summer\")","55fb4994":"plt.figure(figsize=(5,5))\nsns.heatmap(data.groupby(['neighbourhood_group_cleansed', 'bedrooms']).price.median().unstack(), \n            cmap='Blues', annot=True, fmt=\".0f\")\nplt.title(\"Median Prices by Neighbourhood and Bedrooms\")\nplt.show()","16174b34":"plt.figure(figsize=(15,3))\nsns.boxplot(x=\"cancellation_policy\", y=\"price\", data=data, palette='viridis')","3ad0ee2a":"data[\"cancellation_policy\"].value_counts()","3bce5cc7":"data = data[(data['cancellation_policy'] == 'flexible') |\n            (data['cancellation_policy'] == 'moderate') |\n            (data['cancellation_policy'] == 'strict_14_with_grace_period')]","7686c0f7":"plt.figure(figsize=(10,3))\nsns.boxplot(x=\"bathrooms\",y=\"price\",data=data)","1df1f790":"# cleaning the outliers\ndata[\"bathrooms\"].value_counts()\ndata=data[data[\"bathrooms\"]<=2]\n","df5ad187":"from collections import Counter","e51dbd99":"amenities = Counter()\ndata['amenities'].str.strip('{}')\\\n               .str.replace('\"', '')\\\n               .str.lstrip('\\\"')\\\n               .str.rstrip('\\\"')\\\n               .str.split(',')\\\n               .apply(amenities.update)\n\namenities.most_common(10)","53c84333":"# create a new dataframe for plotting\nsub_df = pd.DataFrame(amenities.most_common(25), columns=['amenity', 'count'])","79e0f807":"# plot the top amenities\nplt.figure(figsize=(10,5))\nsub_df.sort_values(by=['count'], ascending=True).plot(kind='barh', x='amenity', y='count',  \n                                                      figsize=(10,7), legend=False, color=\"darkblue\",\n                                                      title='Amenities')\nplt.xlabel('Count');","c24ec827":"data['Laptop_friendly_workspace'] = data['amenities'].str.contains('Laptop friendly workspace')\ndata['TV'] = data['amenities'].str.contains('TV')\ndata['Hot water']=data['amenities'].str.contains('Hot water')\ndata['Family_friendly'] = data['amenities'].str.contains('Family\/kid friendly')\ndata['Hair_dryer'] = data['amenities'].str.contains('Hair_dryer')\ndata['Smoking_allowed'] = data['amenities'].str.contains('Smoking allowed')","94c1a58e":"data.drop(['amenities'], axis=1, inplace=True)","cb57debe":"import geopy.distance\n\ndef calc_distance(lat,long):\n    berlin_centre = (52.5, 13.4)\n    apartment=(lat,long)\n    \n    return geopy.distance.distance(berlin_centre,apartment).km ","972e1670":"data['distance'] = data.apply(lambda x: calc_distance(x.latitude, x.longitude), axis=1)","c3ebade5":"data.columns","c802c336":"data.drop(['latitude', 'longitude', 'id','host_id'\n          ], axis=1, inplace=True)","64ab92d4":"# encode categorical columns\n\ndef encode_columns(column, data):\n    \n    data = pd.concat([data,pd.get_dummies(data[column],prefix=column)],axis=1)\n    data.drop(column, axis=1, inplace=True)\n    \n    return data\n","95ccee30":"categorical_columns = [ \n       'neighbourhood_group_cleansed', 'room_type', \n       'cancellation_policy'\n]\n    \nfor col in categorical_columns:\n    data=encode_columns(col,data)","23c987a4":"data.head(2)","8a11fd30":"# make binary columns the right type \n\ndata['Laptop_friendly_workspace'] = data['Laptop_friendly_workspace'].astype(int)\ndata['TV'] = data['TV'].astype(int)\ndata['Hot water'] = data['Hot water'].astype(int)\ndata['Family_friendly'] = data['Family_friendly'].astype(int)\ndata['Hair_dryer'] = data['Hair_dryer'].astype(int)\ndata['Smoking_allowed'] = data['Smoking_allowed'].astype(int)","2a041520":"data.isna().sum()","089f31b8":"data.dropna(inplace=True)","82212dde":"data.info()","469f27aa":"data.shape","ad2430f3":"y = data[[\"price\"]]","73f30cf4":"X = data.drop([\"price\"], axis=1)","15be3ff4":"from sklearn.model_selection import train_test_split\nfrom sklearn.metrics import mean_squared_error, r2_score\n\n# split data\nX_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.25, random_state=22)","8ae1cce9":"# scale data so that numerical variables have the same scale\nfrom sklearn.preprocessing import StandardScaler\nsc = StandardScaler()\nX_train = sc.fit_transform(X_train)\nX_test  = sc.transform(X_test)","de8e374e":"from sklearn.ensemble import RandomForestRegressor","b0e81201":"randf = RandomForestRegressor()\n\nrandf.fit(X_train, y_train)\nrandf_prediction=randf.predict(X_test)\n","0f897e48":"round(np.sqrt(mean_squared_error(y_test,randf_prediction)),2)","7ad0a6e9":"round(r2_score(y_test,randf_prediction),2)","d211ccb7":"import sklearn.metrics\nfrom sklearn.model_selection import cross_validate","df0faf41":"CV_randf=cross_validate(randf,X_train,y_train,scoring=[\"neg_mean_squared_error\"],\n                        cv=5)","4a0159ff":"print(\"The mean RMSE in the Cross-Validation is: {:.2f}%\".\n      format((np.sqrt(abs(np.mean(CV_randf[\"test_neg_mean_squared_error\"]))))))","fb1b956c":"import xgboost as xgb","eb4c617c":"booster = xgb.XGBRegressor(colsample_bytree=0.6, gamma=0.2, learning_rate=0.1, \n                           max_depth=6, n_estimators=100, random_state=4)\n\n\nbooster.fit(X_train, y_train)\n\ny_pred_train = booster.predict(X_train)\ny_pred_test = booster.predict(X_test)","36d35851":"RMSE = np.sqrt(mean_squared_error(y_test, y_pred_test))\nprint(f\"RMSE: {round(RMSE, 2)}\")","3464aab0":"r2 = r2_score(y_test, y_pred_test)\nr2\nprint(f\"R2: {round(r2, 2)}\")","0089cfec":"feat_importances = pd.Series(booster.feature_importances_, index=X.columns)\nfeat_importances.nlargest(15).sort_values().plot(kind='barh', color='darkblue', figsize=(10,5))\nplt.xlabel('Relative Feature Importance with XGBoost')","71de04de":"First, let's change the format of the price columns to numeric.","a2f4b526":"## Exploration","b3ef8b2a":"## Data cleaning and preparation","ed4ee8d8":"The last feature to create is the distance to city centre, to see if this can be a predictor of price in this case.","70ceb714":"### Map of apartments","7d4245ca":"As there are so many variables, let's select the ones that can be useful to predict price.","2c9c2b5e":"For price, it appears that there are some very large outliers (8600 per night seems excessive for an Airbnb). Let's clean this field after looking at the properties included in the dataset.","4d4cefca":"### Cancellation policy","b9018002":"Using the xgboost improves the result slightly, but as we can see it's hard to predict accurately on the data due to the high variance in price. Our prediction is still much smaller than the sd so we are better off, and we explain about 55% of the price variance with the model, which can be used to recommend a price to someone wanting to post their apartment on Airbnb.\n\nLet's see which features predict price the most (as selected by the xgboost model):","60d70765":"### Split data for modeling","8ee3593d":"### Cross-validation","4242c840":"# Airbnb Prices Berlin","f56ec800":"## Modeling","ca6339f4":"### Neighbourhoods","e811b92f":"### Bathrooms","8c77f265":"### Bedrooms","fd549f68":"As expected, the prices are very dispersed, and it seems that Hotel prices represent most of the high prices. Looking at the property types, we have 90% apartments, and for the other categories very few observations. I will keep only apartments for modeling to try to build a good model with this data.","566b23eb":"### Amenities","7ce9358c":"Let's remove the price outliers now:","e0baef48":"### __Property type__","7031df05":"After some exploration, these amenities seem to lead to different prices, so let's create binary variables out of them.","06bc98f4":"### Distance to centre","7bc59d70":"As we have NAs for deposit and cleaning fee, let's fill these fields with 0 (as we can assume that if they are not mentioned there is no charge).","883c32dd":"## Load data","ea39a56c":"Transforming the price to a log scale improves its distribution only slightly, so I decide to just remove the outliers on the right tail:","e5bfdb73":"There are still a few missing values which can be dropped:"}}