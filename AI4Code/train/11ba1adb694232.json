{"cell_type":{"a2c1c1e1":"code","5828f07c":"code","eefb28c1":"code","5aa68ad4":"code","90e1170a":"code","fc190a37":"code","fb873049":"code","097761be":"code","68d19251":"code","585e49eb":"code","98d7a536":"code","8fc110a6":"code","6029a54c":"code","319b8379":"code","9ed506dd":"code","930f355a":"code","1eada038":"code","48fe685a":"code","328ef33b":"code","71245807":"code","46fcf14d":"code","4a9fe3a3":"code","00db7616":"code","42fb8715":"code","e1ef9027":"markdown","02251254":"markdown","226da29d":"markdown","4d7fe81f":"markdown","edc944b0":"markdown","92752be4":"markdown","4b5dd5d7":"markdown","1ef1643f":"markdown","70deea8a":"markdown","c9fb1484":"markdown","d924c9c9":"markdown","649b5b22":"markdown","622d0ba3":"markdown","0317b213":"markdown","60df54bc":"markdown","09d717cf":"markdown","1cde4345":"markdown","c1244b68":"markdown","7cca9d14":"markdown"},"source":{"a2c1c1e1":"import os\nimport json\n\nimport numpy as np\nimport pandas as pd\nimport matplotlib.pyplot as plt\nimport seaborn as sns","5828f07c":"def load_trace_as_dataframe(filepath):\n    # Returns trace dataframe sorted by timestamp\n    \n    names = ['time', 'type'] + [f'col_{i}' for i in range(1, 9)]\n    \n    trace_df = pd.read_csv(\n        filepath, sep='\\t', comment='#', header=None, names=names\n    )\n    \n    trace_df.sort_values(by='time', inplace=True)\n    trace_df.reset_index(drop=True, inplace=True)\n    return trace_df\n\n\ndef extract_feature_df(trace_df, \n                       feature_name, \n                       col_names=('x', 'y', 'z', 'accuracy')):\n    \n    ''' \n    Extracts feature dataframe from trace dataframe by feature name.\n    \n    Suitable for features: \n    ----------------------\n        TYPE_WAYPOINT, if set col_names=('x', 'y'),\n        TYPE_ACCELEROMETER,\n        TYPE_GYROSCOPE,\n        TYPE_MAGNETIC_FIELD, \n        TYPE_ROTATION_VECTOR,\n        \n        TYPE_ACCELEROMETER_UNCALIBRATED, \n                    if set col_names=('x', 'y', 'z', 'x_2', 'y_2', 'z_2', 'accuracy'),\n                    \n        TYPE_GYROSCOPE_UNCALIBRATED, \n                    if set col_names=('x', 'y', 'z', 'x_2', 'y_2', 'z_2', 'accuracy'),\n                    \n        TYPE_MAGNETIC_FIELD_UNCALIBRATED, \n                    if set col_names=('x', 'y', 'z', 'x_2', 'y_2', 'z_2', 'accuracy')\n    '''\n    \n    feature_df = trace_df[trace_df['type'] == feature_name].copy()\n    for i, col in enumerate(col_names, start=1):\n        feature_df[col] = feature_df[f'col_{i}'].astype('float64')\n        \n    feature_df.drop(columns=[f'col_{i}' for i in range(1, 9)], inplace=True)\n    feature_df.drop(columns=['type'], inplace=True)\n    feature_df.reset_index(drop=True, inplace=True)\n    \n    return feature_df\n\n\ndef load_points(filepath):\n    # Takes the path to the trace file.\n    # Returns pandas dataframe which consists of device locations \n    # as x and y coordinates (values from TYPE_WAYPOINT) and their timestamps.\n    \n    trace_df = load_trace_as_dataframe(filepath)\n    points_df = extract_feature_df(\n        trace_df, 'TYPE_WAYPOINT', col_names=('x', 'y')\n    )\n    \n    return points_df\n\n\ndef visualize_many_traces_on_the_map(traces_dataframes, map_image, width, height, \n                                     traces_filenames=None, \n                                     figsize=None):\n    \n    \n    '''\n    Draws traces on the floor map.\n    \n    Parameters\n    ----------\n        traces_dataframes: list of pandas DataFrames\n            Each DataFrame should consist of device locations as x and y \n            coordinates and their timestamps.\n\n        map_image : numpy.array\n            Image of floor map.\n\n        width : float,\n            Width of floor. Should be taken from floor_info.json\n\n        height : float, \n            Height of floor. Should be taken from floor_info.json\n\n        traces_filenames : list of strings, optional, default: None\n            List of filenames. Used to display the legend. \n            There will be no legend if you pass traces_filenames=None\n\n        figsize : (float, float), optional, default: None\n            Size of the result image in terms of matplotlib.\n    \n    '''\n    \n    fig = plt.figure(figsize=figsize)\n    ax = plt.subplot(111)\n\n    plt.imshow(map_image, extent=[0, width, 0, height])\n\n    if traces_filenames:\n        \n        for filename, points in zip(traces_filenames, traces_dataframes):\n            plt.scatter(points['x'], points['y'], label=filename)\n            plt.plot(points['x'], points['y'])\n            \n        ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))\n    else:\n        for points in traces_dataframes:\n            plt.scatter(points['x'], points['y'])\n            plt.plot(points['x'], points['y'])\n\n\n    plt.show()\n\n    \ndef visualize_single_trace_on_the_map(points_df, map_image, width, height, \n                                      scaling_coef=0.3, figsize=None):\n    \n    '''\n    Draws single trace on the floor map.\n    \n    Parameters\n    ----------\n        points_df: pandas DataFrame\n            Should consist of device locations as x and y \n            coordinates and their timestamps.\n\n        map_image : numpy.array\n            Image of floor map.\n\n        width : float,\n            Width of floor. Should be taken from floor_info.json\n\n        height : float, \n            Height of floor. Should be taken from floor_info.json\n\n        scaling_coef : float\n            Scaling Coefficient. \n\n        figsize : (float, float), optional, default: None\n            Size of the result image in terms of matplotlib.\n    \n    '''\n    \n    fig = plt.figure(figsize=figsize)\n    ax = plt.subplot(111)\n\n    plt.imshow(map_image, extent=[0, width, 0, height])\n    plt.plot(points_df['x'], points_df['y'], linewidth=5, linestyle='-', color='blue')\n\n    for i in range(len(points_df)):\n        ax.text(\n            points_df.loc[i, 'x'], points_df.loc[i, 'y'], i, \n            ha=\"center\", size=15, \n            bbox=dict(boxstyle=\"circle, pad=0.3\", \n                      fc=\"cyan\", lw=2)\n        )\n \n    x_min, x_max = points_df['x'].min(), points_df['x'].max()\n    y_min, y_max = points_df['y'].min(), points_df['y'].max()\n\n    ax.set_xlim(x_min - scaling_coef*(x_max - x_min), x_max + scaling_coef*(x_max - x_min))\n    ax.set_ylim(y_min - scaling_coef*(y_max - y_min), y_max + scaling_coef*(y_max - y_min))\n\n    plt.show()\n\n    \ndef plot_trace_features(feature_df, timestamps=None, figsize=None):\n    \n    '''\n    Plots the trace features.\n    \n    Parameters\n    ----------\n        feature_df : pandas DataFrame\n            Can be exctracted from trace dataframe \n            using extract_feature_df function.\n        \n        timestamps : array-like, optional, default: None\n            Array of timestamps. \n            Used to mark timestamps on the chart in the form of vertical lines.\n            Pass timestamps=None if you don't want to use this feature.\n\n        figsize : (float, float), optional, default: None\n            Size of the result image in terms of matplotlib.\n    \n    Suitable for features: \n    ----------------------\n        TYPE_ACCELEROMETER \n        TYPE_GYROSCOPE \n        TYPE_MAGNETIC_FIELD \n        TYPE_ROTATION_VECTOR \n        TYPE_ACCELEROMETER_UNCALIBRATED \n        TYPE_GYROSCOPE_UNCALIBRATED \n        TYPE_MAGNETIC_FIELD_UNCALIBRATED\n    '''\n    \n    fig = plt.figure(figsize=figsize)\n    ax = plt.subplot(111)\n\n    for col in ['x', 'y', 'z']:\n        plt.plot(feature_df['time'], feature_df[col], label=col)\n\n\n    if points_df is not None:\n        xmin, xmax, ymin, ymax = plt.axis()\n\n        for i, timestamp in enumerate(timestamps):\n            plt.axvline(x=timestamp, c='k', ls='--')\n\n            ax.text(\n            timestamp, ymax, i, \n            ha=\"center\", size=15, \n            bbox=dict(boxstyle=\"circle, pad=0.3\", \n                      fc=\"white\", lw=2)\n            )\n    ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))\n    plt.show()","eefb28c1":"data_path = '\/kaggle\/input\/indoor-location-navigation'\nos.listdir(data_path)","5aa68ad4":"floor = '5a0546857ecc773753327266\/F1'\nfloor_metadata_dir = os.path.join(data_path, 'metadata', floor)\nfloor_train_dir = os.path.join(data_path, 'train', floor)\n\nos.listdir(floor_metadata_dir)","90e1170a":"# os.listdir(os.path.join(data_path, 'train'))[:10]","fc190a37":"# os.listdir(floor_train_dir)[:5]","fb873049":"paths = []\nfor filename in os.listdir(floor_train_dir):\n    if '.txt' not in filename:\n        continue\n    points = load_points(os.path.join(floor_train_dir, filename))\n    paths.append((filename, points))\n\npaths = sorted(paths, key=lambda path: len(path[1]), reverse=True)\npaths = paths[:20]\n\n\ntraces_dataframes = [trace for filename, trace in paths]\ntraces_filenames = [filename for filename, trace in paths]","097761be":"MAP_IMAGE = plt.imread(\n    os.path.join(floor_metadata_dir, 'floor_image.png')\n)\n\nwith open(os.path.join(floor_metadata_dir, 'floor_info.json')) as f:\n    content = f.read()\n    floor_info = json.loads(content)\n\nMAP_HEIGHT = float(floor_info['map_info']['height'])\nMAP_WIDTH = float(floor_info['map_info']['width'])\n    \nfloor_info","68d19251":"visualize_many_traces_on_the_map(\n    traces_dataframes, MAP_IMAGE, MAP_WIDTH, MAP_HEIGHT, \n    traces_filenames=traces_filenames, \n    figsize=(15, 12)\n)","585e49eb":"filename='5e15b0171506f2000638fe49.txt'\ntrace_filepath = os.path.join(floor_train_dir, filename)\n\ntrace_df = load_trace_as_dataframe(trace_filepath)\ntrace_df","98d7a536":"points_df = extract_feature_df(trace_df, 'TYPE_WAYPOINT', col_names=('x', 'y'))\npoints_df","8fc110a6":"visualize_single_trace_on_the_map(\n    points_df, MAP_IMAGE, MAP_WIDTH, MAP_HEIGHT, figsize=(10, 8)\n)","6029a54c":"acc_df = extract_feature_df(trace_df, 'TYPE_ACCELEROMETER')\nacc_df","319b8379":"plot_trace_features(acc_df, points_df['time'], figsize=(20, 5))","9ed506dd":"sns.pairplot(acc_df[['x', 'y', 'z']])\nplt.show()","930f355a":"gyro_df = extract_feature_df(trace_df, 'TYPE_GYROSCOPE')\ngyro_df","1eada038":"plot_trace_features(gyro_df, points_df['time'], figsize=(20, 5))","48fe685a":"sns.pairplot(gyro_df[['x', 'y', 'z']])\nplt.show()","328ef33b":"magn_df = extract_feature_df(trace_df, 'TYPE_MAGNETIC_FIELD')\nmagn_df","71245807":"plot_trace_features(magn_df, points_df['time'], figsize=(20, 5))","46fcf14d":"sns.pairplot(magn_df[['x', 'y', 'z']])\nplt.show()","4a9fe3a3":"rot_df = extract_feature_df(trace_df, 'TYPE_ROTATION_VECTOR')\nrot_df","00db7616":"plot_trace_features(rot_df, points_df['time'], figsize=(20, 5))","42fb8715":"sns.pairplot(rot_df[['x', 'y', 'z']])\nplt.show()","e1ef9027":"Here is a table of the attributes we need to deal with in this competition. \n\nAs you can see it contains feature names and its params. We will describe some of these features in more detail below.\n\nEach feature can be extracted from trace as dataframe with params as columns. For this we are using function `extract_feature_df` which is suitable for all features except TYPE_WIFI and TYPE_BEACON.\n\nThe table is taken from [competition's official github repo](https:\/\/github.com\/location-competition\/indoor-location-competition-20). (I've slightly modified it just for a more compact view).","02251254":"# TYPE_ROTATION_VECTOR","226da29d":"# Features Visualization","4d7fe81f":"* **train** directory contains sites (shopping malls) directories that consists of floor direcories. And each floor directory contains txt files, that have information about paths (smarthones).\n\n* **metedata** directory contains floor map, its size and geo inforamation for each site and each floor.\n\nIn this competition we should predict smartphone location: floor number and x, y coordinates (TYPE_WAYPOINT). \n","edc944b0":"# References\n* [Trace Parsing Script](https:\/\/www.kaggle.com\/c\/indoor-location-navigation\/discussion\/215381)\n* [Competition's Github Repository](https:\/\/github.com\/location-competition\/indoor-location-competition-20)","92752be4":"## Hope this notebook will be helpful for you. I wish you good fortune in the competition!","4b5dd5d7":"# Indoor Location & Navigation - Basic EDA - Traces and Features Visualization","1ef1643f":"# Loading floor map and its size","70deea8a":"# TYPE_ACCELEROMETER","c9fb1484":"Let's take a closer look at single trace (path) and its attributes.","d924c9c9":"# Visualization of Traces (Paths) on the Floor Map","649b5b22":"# TYPE_GYROSCOPE","622d0ba3":"# Defined tools","0317b213":"Here is some defined visualization and data loading tools what will be used later. Feel free to use it if you like =)\n\nTrace parsing script (function `load_trace_as_dataframe`) taken from [this post](https:\/\/www.kaggle.com\/c\/indoor-location-navigation\/discussion\/215381).  \nThanks [Tolga Dincer](https:\/\/www.kaggle.com\/tolgadincer) for this =)","60df54bc":"# Let's take a look into data directory.","09d717cf":"| Feature\t\t                    | Values |       |        |        |                   |        |           |                                   |\n|:----------------------------------|:------:|:-----:|:------:|:-------|:-----------------:|:------:|:---------:|:---------------------------------:|\n|TYPE_WAYPOINT                      |X axis  |Y axis |       |         |                   |        |           |                                   |\n|TYPE_ACCELEROMETER                 |X axis  |Y axis |Z axis |accuracy |                   |        |           |                                   |\n|TYPE_GYROSCOPE                     |X axis  |Y axis |Z axis |accuracy |                   |        |           |                                   | \n|TYPE_MAGNETIC_FIELD                |X axis  |Y axis |Z axis |accuracy |                   |        |           |                                   | \n|TYPE_ROTATION_VECTOR               |X axis  |Y axis |Z axis |accuracy |                   |        |           |                                   |\n|TYPE_ACCELEROMETER_UNCALIBRATED    |X axis  |Y axis |Z axis |X axis   |Y axis             |Z axis  |accuracy   |                                   |\n|TYPE_GYROSCOPE_UNCALIBRATED        |X axis  |Y axis |Z axis |X axis   |Y axis             |Z axis  |accuracy   |                                   |\n|TYPE_MAGNETIC_FIELD_UNCALIBRATED   |X axis  |Y axis |Z axis |X axis   |Y axis             |Z axis  |accuracy   |                                   |\n|TYPE_WIFI                          |ssid    |bssid  |RSSI   |frequency|last seen timestamp|        |           |                                   |\n|TYPE_BEACON                        |UUID    |MajorID|MinorID|Tx Power |RSSI               |Distance|MAC Address|same with Unix time, padding data  |\n","1cde4345":"# TYPE_MAGNETIC_FIELD","c1244b68":"# TYPE_WAYPOINT","7cca9d14":"# Loading coordinates of paths points"}}