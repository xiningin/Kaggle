{"cell_type":{"2cc0f28a":"code","d6f1b1ad":"code","3fa99900":"code","ef2c15bb":"markdown","6ecfe2c1":"markdown","5cd4dc67":"markdown"},"source":{"2cc0f28a":"import os\nimport torch\nfrom torchvision import models\n\nfrom ignite.engine import Events, create_supervised_trainer, create_supervised_evaluator\nfrom ignite.metrics import Loss, Accuracy\n\ndevice = torch.device(\"cuda\" if torch.cuda.is_available() else \"cpu\")\n\nmodel = models.resnet18(pretrained=True)\n\ncriterion = torch.nn.CrossEntropyLoss()\noptimizer = torch.optim.Adam(model.parameters(), lr=0.0003)\n\nmetrics = {\n    'loss': Loss(criterion),\n    'accuracy': Accuracy(),\n}\n\ntrainer = create_supervised_trainer(model, optimizer, criterion, device=device)\nval_evaluator = create_supervised_evaluator(model, metrics=metrics, device=device)","d6f1b1ad":"# create models directory if it doesn't exist\n!mkdir -p models","3fa99900":"def get_saved_model_path(epoch):\n    return f'models\/Model_{model_name}_{epoch}.pth'\n\nbest_acc = 0.\nbest_epoch = 1\nbest_epoch_file = ''\n\n@trainer.on(Events.EPOCH_COMPLETED)\ndef save_best_epoch_only(engine):\n    epoch = engine.state.epoch\n\n    global best_acc\n    global best_epoch\n    global best_epoch_file\n    best_acc = 0. if epoch == 1 else best_acc\n    best_epoch = 1 if epoch == 1 else best_epoch\n    best_epoch_file = '' if epoch == 1 else best_epoch_file\n\n    metrics = val_evaluator.run(val_loader).metrics\n\n    if metrics['accuracy'] > best_acc:\n        prev_best_epoch_file = get_saved_model_path(best_epoch)\n        if os.path.exists(prev_best_epoch_file):\n            os.remove(prev_best_epoch_file)\n            \n        best_acc = metrics['accuracy']\n        best_epoch = epoch\n        best_epoch_file = get_saved_model_path(best_epoch)\n        print(f'\\nEpoch: {best_epoch} - New best accuracy! Accuracy: {best_acc}\\n\\n\\n')\n        torch.save(model.state_dict(), best_epoch_file)","ef2c15bb":"## Dummy Ignite trainer\/engine preparation","6ecfe2c1":"## Below is the reusable `save_best_only` code snippet","5cd4dc67":"Keras has a `save_best_only` option for its [ModelCheckpoint](https:\/\/keras.io\/callbacks\/#modelcheckpoint). Ignite [doesn't](https:\/\/pytorch.org\/ignite\/_modules\/ignite\/handlers\/checkpoint.html) - it only has a `save_interval`.   \n   \nBelow is a very simple code snippet you can use with Ignite if you want to have this feature."}}