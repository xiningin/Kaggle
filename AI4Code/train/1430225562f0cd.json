{"cell_type":{"80a111c2":"code","af8650e7":"code","fd961dfd":"code","9e413930":"code","1b86c285":"code","ca8522e1":"code","86915a34":"code","95e00c1f":"code","b1fd2ad6":"code","c6d3b7fc":"code","2880c0ae":"markdown","2865bcea":"markdown","080da053":"markdown"},"source":{"80a111c2":"import numpy as np, pandas as pd\nfrom glob import glob\nimport shutil, os\nimport matplotlib.pyplot as plt\nfrom sklearn.model_selection import GroupKFold\nfrom tqdm.notebook import tqdm\nimport seaborn as sns, gc","af8650e7":"dim = 512 #1024, 256, 'original'\ntest_dir = f'\/kaggle\/input\/vinbigdata-{dim}-image-dataset\/vinbigdata\/test'","fd961dfd":"test_df = pd.read_csv(f'\/kaggle\/input\/vinbigdata-{dim}-image-dataset\/vinbigdata\/test.csv')\ntest_df.head()","9e413930":"shutil.copytree('\/kaggle\/input\/yolov5-official-v31-dataset\/yolov5', '\/kaggle\/working\/yolov5')\nos.chdir('\/kaggle\/working\/yolov5') # install dependencies\n\nimport torch\nfrom IPython.display import Image, clear_output  # to display images\n\nclear_output()\nprint('Setup complete. Using torch %s %s' % (torch.__version__, torch.cuda.get_device_properties(0) if torch.cuda.is_available() else 'CPU'))","1b86c285":"def yolo2voc(image_height, image_width, bboxes):\n    \"\"\"\n    yolo => [xmid, ymid, w, h] (normalized)\n    voc  => [x1, y1, x2, y1]\n    \n    \"\"\" \n    bboxes = bboxes.copy().astype(float) # otherwise all value will be 0 as voc_pascal dtype is np.int\n    \n    bboxes[..., [0, 2]] = bboxes[..., [0, 2]]* image_width\n    bboxes[..., [1, 3]] = bboxes[..., [1, 3]]* image_height\n    \n    bboxes[..., [0, 1]] = bboxes[..., [0, 1]] - bboxes[..., [2, 3]]\/2\n    bboxes[..., [2, 3]] = bboxes[..., [0, 1]] + bboxes[..., [2, 3]]\n    \n    return bboxes","ca8522e1":"for i in range(1,6):\n    torch.cuda.empty_cache()\n    gc.collect()\n    WEIGHT_FILE = f'\/kaggle\/input\/resnet50d-096-stage-2\/FOLD{i}.pt'    \n    !python detect.py --weights $WEIGHT_FILE --img 512 --conf 0.15 --iou 0.5 --source $test_dir --save-txt --save-conf --exist-ok\n    image_ids = []\n    PredictionStrings = []\n\n    for file_path in glob('runs\/detect\/exp\/labels\/*txt'):\n        image_id = file_path.split('\/')[-1].split('.')[0]\n        w, h = test_df.loc[test_df.image_id==image_id,['width', 'height']].values[0]\n        f = open(file_path, 'r')\n        data = np.array(f.read().replace('\\n', ' ').strip().split(' ')).astype(np.float32).reshape(-1, 6)\n        data = data[:, [0, 5, 1, 2, 3, 4]]\n        bboxes = list(np.concatenate((data[:, :2], yolo2voc(h, w, data[:, 2:])), axis =1).reshape(-1).astype(str))\n        for idx in range(len(bboxes)):\n            bboxes[idx] = str(int(float(bboxes[idx]))) if idx%6!=1 else bboxes[idx]\n        image_ids.append(image_id)\n        PredictionStrings.append(' '.join(bboxes))\n        os.remove(file_path)\n\n    pred_df = pd.DataFrame({'image_id':image_ids,\n                            'PredictionString':PredictionStrings})\n    sub_df = pd.merge(test_df, pred_df, on = 'image_id', how = 'left').fillna(\"14 1 0 0 1 1\")\n    sub_df = sub_df[['image_id', 'PredictionString']]\n    sub_df.to_csv(f'\/kaggle\/working\/Fold_{i}_cleaned.csv',index = False)","86915a34":"for i in range(1,6):\n    torch.cuda.empty_cache()\n    gc.collect()\n    WEIGHT_FILE = f'\/kaggle\/input\/resnet50d-096-stage-2\/FOLD{i}.pt'    \n    !python detect.py --weights $WEIGHT_FILE --img 512 --conf 0.00001 --iou 0.0 --source $test_dir --save-txt --save-conf --exist-ok\n    image_ids = []\n    PredictionStrings = []\n\n    for file_path in glob('runs\/detect\/exp\/labels\/*txt'):\n        image_id = file_path.split('\/')[-1].split('.')[0]\n        w, h = test_df.loc[test_df.image_id==image_id,['width', 'height']].values[0]\n        f = open(file_path, 'r')\n        data = np.array(f.read().replace('\\n', ' ').strip().split(' ')).astype(np.float32).reshape(-1, 6)\n        data = data[:, [0, 5, 1, 2, 3, 4]]\n        bboxes = list(np.concatenate((data[:, :2], yolo2voc(h, w, data[:, 2:])), axis =1).reshape(-1).astype(str))\n        for idx in range(len(bboxes)):\n            bboxes[idx] = str(int(float(bboxes[idx]))) if idx%6!=1 else bboxes[idx]\n        image_ids.append(image_id)\n        PredictionStrings.append(' '.join(bboxes))\n        os.remove(file_path)\n\n    pred_df = pd.DataFrame({'image_id':image_ids,\n                            'PredictionString':PredictionStrings})\n    sub_df = pd.merge(test_df, pred_df, on = 'image_id', how = 'left').fillna(\"14 1 0 0 1 1\")\n    sub_df = sub_df[['image_id', 'PredictionString']]\n    sub_df.to_csv(f'\/kaggle\/working\/Fold_{i}.csv',index = False)","95e00c1f":"for i in range(1,6):\n    torch.cuda.empty_cache()\n    gc.collect()\n    WEIGHT_FILE = f'\/kaggle\/input\/resnet50d-096-stage-2\/FOLD{i}.pt'    \n    !python detect.py --weights $WEIGHT_FILE --img 512 --conf 0.15 --iou 0.5 --source $test_dir --save-txt --save-conf --exist-ok --augment\n    image_ids = []\n    PredictionStrings = []\n\n    for file_path in glob('runs\/detect\/exp\/labels\/*txt'):\n        image_id = file_path.split('\/')[-1].split('.')[0]\n        w, h = test_df.loc[test_df.image_id==image_id,['width', 'height']].values[0]\n        f = open(file_path, 'r')\n        data = np.array(f.read().replace('\\n', ' ').strip().split(' ')).astype(np.float32).reshape(-1, 6)\n        data = data[:, [0, 5, 1, 2, 3, 4]]\n        bboxes = list(np.concatenate((data[:, :2], yolo2voc(h, w, data[:, 2:])), axis =1).reshape(-1).astype(str))\n        for idx in range(len(bboxes)):\n            bboxes[idx] = str(int(float(bboxes[idx]))) if idx%6!=1 else bboxes[idx]\n        image_ids.append(image_id)\n        PredictionStrings.append(' '.join(bboxes))\n        os.remove(file_path)\n\n    pred_df = pd.DataFrame({'image_id':image_ids,\n                            'PredictionString':PredictionStrings})\n    sub_df = pd.merge(test_df, pred_df, on = 'image_id', how = 'left').fillna(\"14 1 0 0 1 1\")\n    sub_df = sub_df[['image_id', 'PredictionString']]\n    sub_df.to_csv(f'\/kaggle\/working\/Fold_{i}_TTA.csv',index = False)","b1fd2ad6":"# torch.cuda.empty_cache()\n# gc.collect()\n# WEIGHT_FILE = f'\/kaggle\/input\/resnet50d-096-stage-2\/FOLD5.pt'    \n# !python detect.py --weights $WEIGHT_FILE --img 512 --conf 0.0 --iou 0.0 --source $test_dir --save-txt --save-conf --exist-ok --augment\n# image_ids = []\n# PredictionStrings = []\n\n# for file_path in glob('runs\/detect\/exp\/labels\/*txt'):\n#     image_id = file_path.split('\/')[-1].split('.')[0]\n#     w, h = test_df.loc[test_df.image_id==image_id,['width', 'height']].values[0]\n#     f = open(file_path, 'r')\n#     data = np.array(f.read().replace('\\n', ' ').strip().split(' ')).astype(np.float32).reshape(-1, 6)\n#     data = data[:, [0, 5, 1, 2, 3, 4]]\n#     bboxes = list(np.concatenate((data[:, :2], yolo2voc(h, w, data[:, 2:])), axis =1).reshape(-1).astype(str))\n#     for idx in range(len(bboxes)):\n#         bboxes[idx] = str(int(float(bboxes[idx]))) if idx%6!=1 else bboxes[idx]\n#     image_ids.append(image_id)\n#     PredictionStrings.append(' '.join(bboxes))\n\n# pred_df = pd.DataFrame({'image_id':image_ids,\n#                         'PredictionString':PredictionStrings})\n# sub_df = pd.merge(test_df, pred_df, on = 'image_id', how = 'left').fillna(\"14 1 0 0 1 1\")\n# sub_df = sub_df[['image_id', 'PredictionString']]\n# sub_df.to_csv(f'\/kaggle\/working\/Fold_5_uncleaned.csv',index = False)","c6d3b7fc":"shutil.rmtree('\/kaggle\/working\/yolov5')","2880c0ae":"# Inference","2865bcea":"This notebook is a fork of https:\/\/www.kaggle.com\/awsaf49\/vinbigdata-cxr-ad-yolov5-14-class-infer","080da053":"# YOLOv5 Stuff"}}