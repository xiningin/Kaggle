{"cell_type":{"9ea572b8":"code","38d5b16d":"code","d11e3207":"code","5b26b642":"code","27d0750f":"code","9f6ef020":"code","24a79c57":"code","1b0fbf74":"code","655d2efc":"code","abfb8651":"code","6e0c5f85":"code","9aa382fd":"code","957c3f73":"code","c6f5efda":"code","0202aeb5":"code","a4ef63d8":"code","fd461cba":"code","aa6d2842":"code","c790e748":"code","c116eb90":"code","26ffb41d":"code","eefa16ab":"code","dd759aa5":"code","befd7312":"markdown","ee6e3ece":"markdown","b5671672":"markdown","3fe3f54b":"markdown","4a86c40d":"markdown","80858019":"markdown","d2c12330":"markdown","e679483c":"markdown"},"source":{"9ea572b8":"%config Completer.use_jedi = False","38d5b16d":"import numpy as np\nimport pandas as pd\nimport seaborn as sns\nimport matplotlib.pyplot as plt\nfrom matplotlib.pyplot import imshow, imread\nimport tensorflow as tf\nfrom tensorflow.keras import backend as K\nfrom sklearn.model_selection import train_test_split\nfrom sklearn.model_selection import GridSearchCV\nimport lightgbm as lgb\nfrom lightgbm import LGBMRegressor\nfrom xgboost import XGBRegressor\nfrom statsmodels.nonparametric.smoothers_lowess import lowess\n\n\nimport os\nfor dirname, _, filenames in os.walk('\/kaggle\/input'):\n    for filename in filenames:\n        print(os.path.join(dirname, filename))","d11e3207":"submission_ex = pd.read_csv('\/kaggle\/input\/tabular-playground-series-jul-2021\/sample_submission.csv')\ntrain_df = pd.read_csv('\/kaggle\/input\/tabular-playground-series-jul-2021\/train.csv')\ntest_df = pd.read_csv('\/kaggle\/input\/tabular-playground-series-jul-2021\/test.csv')\n\ntargets_df = train_df[[\"target_carbon_monoxide\",\"target_benzene\",\"target_nitrogen_oxides\"]].copy()\ntrain_df.drop([\"target_carbon_monoxide\",\"target_benzene\",\"target_nitrogen_oxides\"], axis=1, inplace=True)  ","5b26b642":"def root_mean_squared_log_error(y_true, y_pred):\n    msle = tf.keras.losses.MeanSquaredLogarithmicError()\n    return K.sqrt(msle(y_true, y_pred)) ","27d0750f":"train_df.info()","9f6ef020":"test_df.info()","24a79c57":"train_df.isna().sum()","1b0fbf74":"test_df.isna().sum()","655d2efc":"# ################################################################\n# for c in train_df.columns:\n#     if c != 'date_time':\n#         fig = plt.figure(figsize = (15, 5))\n#         g = train_df[c].plot()\n#         g.legend([c])","abfb8651":"# ################################################################\n# fig = plt.figure(figsize = (30,30))\n# ax = fig.gca()\n# hist = train_df[train_df.columns.values].hist(bins=150, ax = ax)","6e0c5f85":"# ################################################################\n# for c in test_df.columns:\n#     if c != 'date_time':\n#         fig = plt.figure(figsize = (15, 5))\n#         g = test_df[c].plot()\n#         g.legend([c])","9aa382fd":"# ################################################################\n# fig = plt.figure(figsize = (30,30))\n# ax = fig.gca()\n# hist = test_df[test_df.columns.values].hist(bins=150, ax = ax)","957c3f73":"# ################################################################\n# corr = train_df.corr()\n# fig = plt.figure(figsize = (15,15))\n# sns.heatmap(corr, vmax = .8, square = True, annot=True)\n# plt.show()","c6f5efda":"# -------------------------------------------------\nfor df in [train_df, test_df]:\n    df['deg_K'] = (df['deg_C'] + 273.15)\n    df['deg_x'] = (df['deg_K']**-1)\n    df['s_3'] = (df['sensor_3']**-1)\n#     del df['deg_C']\n    del df['deg_K']\n    \n    df['date_time'] = pd.to_datetime(df['date_time'], errors='coerce')\n\n#     doy = df['date_time'].dt.dayofyear.values\n#     df['day_of_y_sin'] = np.sin(doy * (2. * np.pi \/ 365))\n#     df['day_of_y_cos'] = np.cos(doy * (2. * np.pi \/ 365))\n#     hh = df['date_time'].dt.hour.values\n#     df['hh_sin'] = np.sin(hh * (2. * np.pi \/ 24))\n#     df['hh_cos'] = np.cos(hh * (2. * np.pi \/ 24))\n    \n    df['time'] = df['date_time'].astype(np.int64)\/\/10**9\n    df['hh'] = df['date_time'].dt.hour.values\n    df['day_of_w'] = df['date_time'].dt.dayofweek.values\n    df['weekend'] = df['day_of_w'].apply(lambda x: 1 if (x>4)  else 0)\n    df['saturday'] = df['day_of_w'].apply(lambda x: 1 if (x == 5)  else 0)\n    df['sunday'] = df['day_of_w'].apply(lambda x: 1 if (x == 6)  else 0)\n    df['month'] = df['date_time'].dt.month.values\n    \n    ww = df[\"date_time\"].dt.isocalendar().week.values\n    df['ww_sin'] = np.sin(ww * (2. * np.pi \/ 52))\n    df['ww_cos'] = np.cos(ww * (2. * np.pi \/ 52))\n    df[\"working_h\"] =  df[\"hh\"].isin(np.arange(8, 21, 1)).astype(\"int\")\n\n    df[\"SMC\"] = (df[\"absolute_humidity\"] * 100) \/ df['relative_humidity']\n\n    df['hm_1'] = ((df['absolute_humidity'].values <= 0.25)).astype(int)\n\n    lag_features = ['deg_C', 'relative_humidity', 'absolute_humidity', 'sensor_1', 'sensor_2', 'sensor_3', 'sensor_4', 'sensor_5']\n    lags = [3, 6, 9, 12, 24]\n    for feature in lag_features:\n        for lag in lags:\n            df[feature + '_lag_' + str(lag)] = df[feature] - df[feature].shift(periods=lag, fill_value=0)\n\n# -------------------------------------------------","0202aeb5":"# lgbm = LGBMRegressor()\n# _target = 'target_carbon_monoxide'\n# X = np.array(train_df[list(test_df.columns.values)[1:]].values, dtype='float32')\n# hm_indices = train_df[train_df['hm_1'] == 1].index.values\n# X = np.delete(X, hm_indices, axis=0)\n# y = np.squeeze(np.array(targets_df[[_target]].values, dtype='float32'))\n# y = np.delete(y, hm_indices, axis=0)\n# params = {\n#     'num_leaves': [16, 21, 26, 31, 36],\n#     'learning_rate': [0.02, 0.01, 0.005],\n#     'max_depth': [2, 3, 4, 5, 6],\n#     'n_estimators': [1000, 1500, 2000]\n# }\n# grid= GridSearchCV(estimator=lgbm, param_grid = params, cv = 3, n_jobs=-1, verbose=True)\n# grid.fit(X, y)\n# print('=====================================', 'target: ', _target)\n# print(grid.best_estimator_)\n# print('-------------------------------------')\n# print(grid.best_score_)\n# print('-------------------------------------')\n# print(grid.best_params_)","a4ef63d8":"# lgbm = LGBMRegressor()\n# _target = 'target_benzene'\n# X = np.array(train_df[list(test_df.columns.values)[1:]].values, dtype='float32')\n# y = np.squeeze(np.array(targets_df[[_target]].values, dtype='float32'))\n# params = {\n#     'num_leaves': [3, 5, 7, 9],\n#     'learning_rate': [0.03, 0.01, 0.003],\n#     'max_depth': [-1, 2, 3, 4],\n#     'n_estimators': [1000, 1500, 2000]\n# }\n# grid= GridSearchCV(estimator=lgbm, param_grid = params, cv = 3, n_jobs=-1, verbose=True)\n# grid.fit(X, y)\n# print('=====================================', 'target: ', _target)\n# print(grid.best_estimator_)\n# print('-------------------------------------')\n# print(grid.best_score_)\n# print('-------------------------------------')\n# print(grid.best_params_)","fd461cba":"# lgbm = LGBMRegressor(reg_sqrt=True)\n# _target = 'target_nitrogen_oxides'\n# X = np.array(train_df[list(test_df.columns.values)[1:]].values, dtype='float32')\n# hm_indices = train_df[train_df['hm_1'] == 1].index.values\n# X = np.delete(X, hm_indices, axis=0)\n# y = np.squeeze(np.array(targets_df[[_target]].values, dtype='float32'))\n# y = np.delete(y, hm_indices, axis=0)\n# params = {\n#     'num_leaves': [6, 11, 16, 21, 26, 31],\n#     'learning_rate': [0.05, 0.03, 0.02, 0.01],\n#     'max_depth': [-1, 5, 10],\n#     'n_estimators': [300, 500, 700, 800, 1000, 1500]\n# }\n# grid= GridSearchCV(estimator=lgbm, param_grid = params, cv = 3, n_jobs=-1, verbose=True)\n# grid.fit(X, y)\n# print('=====================================', 'target: ', _target)\n# print(grid.best_estimator_)\n# print('-------------------------------------')\n# print(grid.best_score_)\n# print('-------------------------------------')\n# print(grid.best_params_)","aa6d2842":"lgbm_regs = {}\n\nlgbm_regs['target_carbon_monoxide'] = LGBMRegressor(learning_rate=0.005, max_depth=6, n_estimators=2000, num_leaves=26)\n\nlgbm_regs['target_benzene'] = LGBMRegressor(learning_rate=0.03, n_estimators=2000, num_leaves=3)\n\nlgbm_regs['target_nitrogen_oxides'] = LGBMRegressor(learning_rate=0.02, max_depth=10, n_estimators=300, reg_sqrt=True)\n\nxgbr = XGBRegressor(objective = 'reg:squarederror')","c790e748":"def postprocessing(pred, df):\n    _hh = df['hh'].values\n    _dow = df['day_of_w'].values\n    _hm = df['hm_1'].values\n    Mlr = {}\n    Mrl = {}\n    C = [0 for _ in range(len(pred))]\n    D = [0 for _ in range(len(pred))]\n    for i in range(len(pred)):\n        j = len(pred) - 1 - i\n        hl = _hh[i]\n        dl = _dow[i]\n        hml = _hm[i]\n        hr = _hh[j]\n        dr = _dow[j]\n        hmr = _hm[j]\n        curr_kl = str(hl) + '_' + str(dl)\n        curr_kr = str(hr) + '_' + str(dr)\n        if hml != 1:\n            if curr_kl not in Mlr:\n                Mlr[curr_kl] = []\n            Mlr[curr_kl].append(pred[i])\n        else:\n            if curr_kl in Mlr:\n                if len(Mlr[curr_kl]) > 1:\n                    D[i] += sum(Mlr[curr_kl][-2:])\n                    C[i] += 2\n                    pass\n                else:\n                    D[i] += Mlr[curr_kl][0]\n                    C[i] += 1\n        if hmr != 1:\n            if curr_kr not in Mrl:\n                Mrl[curr_kr] = []\n            Mrl[curr_kr].append(pred[j])\n        else:\n            if curr_kr in Mrl:\n                if len(Mrl[curr_kr]) > 1:\n                    D[j] += sum(Mrl[curr_kr][-2:])\n                    C[j] += 2\n                    pass\n                else:\n                    D[j] += Mrl[curr_kr][0]\n                    C[j] += 1\n    \n#     print(C)\n    for i in range(len(pred)):\n        if C[i] != 0:\n            pred[i] = D[i] \/ C[i]","c116eb90":"submit = True","26ffb41d":"submission = submission_ex.copy()\n\n# p_x = None\n# p_y = None\n    \nfor _target in ['target_benzene', 'target_carbon_monoxide', 'target_nitrogen_oxides']:\n    X = np.array(train_df[list(test_df.columns.values)[1:]].values, dtype='float32')\n    hm_indices = train_df[train_df['hm_1'] == 1].index.values\n    y = np.squeeze(np.array(targets_df[[_target]].values, dtype='float32'))\n    X_test = np.array(test_df.iloc[:,1:].values, dtype='float32')\n    \n#     if p_x is not None:\n#         X = np.c_[X, np.r_[p_x, p_y]]\n    \n    if not submit:\n        split_train = 5500\n        X, X_val = X[:split_train], X[split_train:]\n        y, y_val = y[:split_train], y[split_train:]\n        \n        XX = X\n        if _target != 'target_benzene':\n            X = np.delete(X, [e for e in hm_indices if e < split_train], axis=0)\n            y = np.delete(y, [e for e in hm_indices if e < split_train], axis=0)\n        \n        lgbm_regs[_target].fit(X, y)\n        p1 = lgbm_regs[_target].predict(X_val)\n        \n        if _target != 'target_benzene':\n            postprocessing(p1, train_df.iloc[split_train:,:])\n        \n#         p_y = p1\n#         p_x = lgbm_regs[_target].predict(XX)\n        \n        print('target: ', _target)\n        print('rmsle: ', root_mean_squared_log_error(y_val, p1))\n        \n        fig = plt.figure(figsize = (30, 10))\n        g = targets_df.iloc[split_train:,:].reset_index()[_target].plot()\n        tmp_col = pd.DataFrame(data=p1, columns=['tmp'])\n        g = tmp_col['tmp'].plot(alpha = 0.7)\n        g.legend([_target])\n    else:\n        print('submit: ', _target)\n        \n        if _target != 'target_benzene':\n            X = np.delete(X, hm_indices, axis=0)\n            y = np.delete(y, hm_indices, axis=0)\n            \n        lgbm_regs[_target].fit(X, y)\n        p1 = lgbm_regs[_target].predict(X_test)\n        \n        if _target != 'target_benzene':\n            postprocessing(p1, test_df)\n            \n        fig = plt.figure(figsize = (15, 5))\n        tmp_col = pd.DataFrame(data=p1, columns=[_target])\n        g = tmp_col[_target].plot()\n        g.legend([_target])\n            \n        submission[_target] = p1\n","eefa16ab":"submission.to_csv('submission.csv', index=False)\n\ntest = pd.read_csv('submission.csv')\ntest.tail()","dd759aa5":"test.head()","befd7312":"### feature correlation","ee6e3ece":"### train dataset","b5671672":"### GridSearch","3fe3f54b":"### postprocessing","4a86c40d":"### LGBMRegressor","80858019":"### test dataset","d2c12330":"### submission","e679483c":"### new features"}}