{"cell_type":{"a46eb023":"code","1273b4a1":"code","f7b21430":"code","a9e686e8":"code","99b5c17d":"code","d31c3ef4":"code","fe503ed7":"code","49cc74b4":"code","bef0a8e9":"code","fec30730":"code","6c14a3a4":"code","a0bafc51":"code","7adee9a0":"code","c8bcd18d":"code","f96d5038":"code","bf0e9e2e":"markdown","d7b99c2f":"markdown","b76b952b":"markdown","82d5f4b9":"markdown","1f00f2cf":"markdown","3251fc65":"markdown"},"source":{"a46eb023":"import re\nimport datetime\nimport fasttext\nimport numpy as np\nimport pandas as pd\nimport multiprocessing\nfrom sklearn.model_selection import train_test_split","1273b4a1":"# Number of processes to spin up.\nNUM_PROCESSES = multiprocessing.cpu_count()","f7b21430":"DATA_PATH = \"\/kaggle\/input\/consumer-reviews-of-amazon-products\/1429_1.csv\"\nMULTIPROC_FILES_PATH = \"\/kaggle\/output\/\"","a9e686e8":"print(\"Started: \", datetime.datetime.now())\ndf = pd.read_csv(DATA_PATH)\nprint(\"Data Read: \", datetime.datetime.now(), df.shape)","99b5c17d":"def get_sentiment(star):\n    \"\"\"\n    Function to return the sentiment from the stars given.\n    :param star: Number of stars.\n    :return sentiment: Sentiment based on stars.\n    \"\"\"\n\n    if star == 3:\n        return \"neutral\"\n    elif star < 3:\n        return \"negative\"\n    else:\n        return \"positive\"","d31c3ef4":"def preprocess_review(review):\n    \"\"\"\n    Function to preprocess the text review.\n    :param review: Review.\n    :return preprocessed_review: Preprocessed Review.\n    \"\"\"\n\n    # Minor preprocessing.\n    review = review.lower().strip()\n    review = review.lstrip(\",\").rstrip(\",\").replace(\"\\n\", \" \").replace(\"\\t\", \" \")\n    review = re.sub('[^.,a-zA-Z0-9 \\n\\.]', '', review)\n    preprocced_review = review\n    #TODO Add code to handle special chars by regex.\n\n    # N - Gramming.\n    # n = 4\n    # review = review.replace('^\"', '').replace('\"$', '').replace('\"\"', '\"')\n    # review = \"^\" + review.replace(\" \", \"*\") + \"$\" # Padding for short strings.\n    # preprocced_review = \" \".join([review[i: i + n] for i in range(len(review) - n + 1)])\n\n    return preprocced_review","fe503ed7":"def preprocess_data(df, f_ind):\n    \"\"\"\n    Function to preprocess the data.\n    :param df: Raw DataFrame.\n    :return df: Preprocessed DataFrame.\n    \"\"\"\n\n    df = df[[\"reviews.rating\", \"reviews.text\"]]\n    df = df.dropna()\n    print(\"Dropped Missing Rows: \", datetime.datetime.now())\n    df[\"sentiment\"] = df[\"reviews.rating\"].apply(lambda star: get_sentiment(star))\n    print(\"Label Processed:\", datetime.datetime.now())\n    df = df.drop([\"reviews.rating\"], axis=1)\n    print(\"Dropped Stars Column: \", datetime.datetime.now())\n    df[\"reviews.text\"] = df[\"reviews.text\"].apply(lambda review: preprocess_review(review))\n    print(\"Preprocessed Reviews (String Manipulations and N-Gramming): \", datetime.datetime.now(), df.shape)\n    df.to_csv(\".\/\" + \"amazon_multiproc_file_{}.csv\".format(f_ind))","49cc74b4":"dfs = np.array_split(df, NUM_PROCESSES)\njobs = []\nfor i in range(NUM_PROCESSES):\n    print(\"Process {} started\".format(i))\n    p = multiprocessing.Process(target=preprocess_data(dfs[i], i))\n    jobs.append(p)\n    p.start()","bef0a8e9":"import os\n\ntemp_df = pd.read_csv(\".\/\" + \"amazon_multiproc_file_0.csv\", nrows=4)\ncolumns = temp_df.columns\ndf = pd.DataFrame(columns=columns)\nfor file in os.listdir(\".\/\"):\n    if file.endswith(\".csv\") and \"multiproc\" in file:\n        print(f\"Now, concatinating {file}.\")\n        ind_df = pd.read_csv(os.path.join(\".\/\", file))\n        df = pd.concat([df, ind_df], axis=0)\ndf = df.loc[:, ~df.columns.str.match('Unnamed')]","fec30730":"X = df[\"reviews.text\"]\ny = df[\"sentiment\"]\nprint(\"X and Y Split Done: \", datetime.datetime.now())","6c14a3a4":"# Split into train-test sets.\nX_train, X_test, y_train, y_test = train_test_split(X, y,\n                                                    stratify=y,\n                                                    test_size=0.1)\nprint(\"Stratified Split Done. Writing Files now: \", datetime.datetime.now())","a0bafc51":"# Write the test file.\nwith open(\".\/test.txt\", \"w\") as test_file_handler:\n    for X_test_entry, y_test_entry in zip(X_test, y_test):\n        line_to_write = \"__label__\" + str(y_test_entry) + \"\\t\" + str(X_test_entry) + \"\\n\"\n        try:\n            test_file_handler.write(line_to_write)\n        except:\n            print(line_to_write)\n            break\nprint(\"Test File Written: \", datetime.datetime.now())","7adee9a0":"# Write the train file.\nwith open(\".\/train.txt\", \"w\") as train_file_handler:\n    for X_train_entry, y_train_entry in zip(X_train, y_train):\n        line_to_write = \"__label__\" + str(y_train_entry) + \"\\t\" + str(X_train_entry) + \"\\n\"\n        try:\n            train_file_handler.write(line_to_write)\n        except:\n            print(line_to_write)\n            break\nprint(\"Train File Written: \", datetime.datetime.now())","c8bcd18d":"model = fasttext.train_supervised(input=\".\/train.txt\")","f96d5038":"def print_results(N, p, r):\n    print(\"N\\t\" + str(N))\n    print(\"P@{}\\t{:.3f}\".format(1, p))\n    print(\"R@{}\\t{:.3f}\".format(1, r))\n\nresults = model.test(\".\/test.txt\")\nprint_results(*results)","bf0e9e2e":"# Amazon Product Reviews Sentiment Analysis using FastText\n\n## Description\n\nThis project aims to classify the Amazon Product reviews in three classes.\n\n1) Positive (If the stars are above 3). <br>\n2) Neutral  (If the stars are equal to 3). <br>\n3) Negative (If the stars are below 3).","d7b99c2f":"Model Training starts here.\n\nYou can also get results\/predictions for your test review by running the below file. ","b76b952b":"The below script reads the data, creates the labels, does some minor text preprocessing using `multiprocessing`.","82d5f4b9":"After the preprocessing is done, train-val-test files are to be created for the FastText model.\n\nThe format required by FastText is like `__label__positive    The restaurant was great.`\n\nNotice the `__label__`. It's how FastText understands that `positive` is the label for the data `The restaurant was great.`\n\nThey could either be separated by a space or a tab.\n\nThe file extension does not matter. It could be any of the TXT\/TSV\/CSV or other extensions which can hold textual data.","1f00f2cf":"## References and Sources\n\nThanks to the authors of these articles!\n\n1) <a href=\"https:\/\/towardsdatascience.com\/fasttext-under-the-hood-11efc57b2b3\">FastText: Under the Hood<\/a> (Medium Article). <br>\n2) <a href=\"https:\/\/stackabuse.com\/python-for-nlp-working-with-facebook-fasttext-library\/\">Python for NLP: Working with Facebook FastText Library<\/a> (StackAbuse Article). <br>\n3) <a href=\"https:\/\/fasttext.cc\/\">FastText Official Documentation<\/a> ","3251fc65":"## FastText Introduction\n\nFastText as a library for efficient learning of word representations and sentence classification. It is written in C++ and supports multiprocessing during training. FastText allows you to train supervised and unsupervised representations of words and sentences. These representations (embeddings) can be used for numerous applications from data compression, as features into additional models, for candidate selection, or as initializers for transfer learning."}}