{"cell_type":{"22719920":"code","ffcb36fa":"code","86fb87be":"code","543b877a":"code","49a75476":"code","fe589855":"code","ebba2bc9":"code","b4fed07b":"code","1436ca43":"code","d5c15e90":"code","ed1d06ad":"code","e63f9f90":"code","8e302f5a":"code","85739655":"code","43db08dc":"code","0be2cefa":"code","ec8e54ca":"code","75318ca0":"code","658ac5e8":"code","f9e305ba":"code","51ecd14e":"code","425c734d":"code","477e45d2":"code","221cdb6a":"code","3ede44d1":"code","9220ce30":"markdown","b045f993":"markdown","55d0a236":"markdown","827f8f53":"markdown","6d8943f2":"markdown","6813a8c3":"markdown","47f48f29":"markdown","ebcf5d64":"markdown","47b3f933":"markdown","af0f9073":"markdown","d96940ee":"markdown","947e8c15":"markdown","d138e953":"markdown","467cd021":"markdown","e80bf964":"markdown","b2b837ed":"markdown","da41a285":"markdown","5527a1be":"markdown","a55396dc":"markdown","3f33264a":"markdown","ccb3e7c0":"markdown","e5362f31":"markdown","210063d8":"markdown","b1c33015":"markdown","a3e15085":"markdown","37b0fc57":"markdown","7cc202e4":"markdown","e61776fd":"markdown","d524d827":"markdown","2b562f53":"markdown"},"source":{"22719920":"import numpy as np\nimport pandas as pd\nimport pandas_profiling\nimport seaborn as sns\nimport matplotlib.pyplot as plt\nfrom scipy.sparse import csr_matrix\nfrom sklearn.neighbors import NearestNeighbors\n\nimport plotly.offline as py\nfrom plotly.offline import init_notebook_mode, iplot\nimport plotly.graph_objs as go\nimport plotly.express as px\nfrom plotly.subplots import make_subplots\nfrom plotly import tools\ninit_notebook_mode(connected = True)\nimport plotly.figure_factory as ff\n\nfrom PIL import Image\nimport requests\nfrom io import BytesIO","ffcb36fa":"#Users\nu_cols = ['user_id', 'location', 'age']\nusers = pd.read_csv('..\/input\/bookcrossing-dataset\/Book reviews\/BX-Users.csv', sep=';', names=u_cols, encoding='latin-1',low_memory=False)\n\n#Books\ni_cols = ['isbn', 'book_title' ,'book_author','year_of_publication', 'publisher', 'img_s', 'img_m', 'img_l']\nbooks = pd.read_csv('..\/input\/bookcrossing-dataset\/Book reviews\/BX-Books.csv', sep=';', names=i_cols, encoding='latin-1',low_memory=False)\n\n#Ratings\nr_cols = ['user_id', 'isbn', 'rating']\nratings = pd.read_csv('..\/input\/bookcrossing-dataset\/Book reviews\/BX-Book-Ratings.csv', sep=';', names=r_cols, encoding='latin-1',low_memory=False)","86fb87be":"users = users.iloc[1:]\nbooks = books.iloc[1:]\nratings = ratings.iloc[1:]\nratings['rating'] = ratings['rating'].astype(int)","543b877a":"dat = ff.create_table(users.head())\ndat.update_layout(autosize=False,height=200, width = 700)","49a75476":"dat = ff.create_table(ratings.head())\ndat.update_layout(autosize=False,height=200, width = 700)","fe589855":"dat = ff.create_table(books.head())\ndat.update_layout(autosize=False,height=200, width = 4400)","ebba2bc9":"df = pd.merge(ratings,books,on='isbn')\ndat = ff.create_table(df.head())\ndat.update_layout(autosize=False,height=200, width = 3990)","b4fed07b":"df['rating'] = df['rating'].astype(int) \nratings = pd.DataFrame(df.groupby('book_title')['rating'].mean())\nratings['Total_Ratings'] = pd.DataFrame(df.groupby('book_title')['rating'].count())\nTop5books = ratings[ratings['Total_Ratings'] > 30].sort_values(by = 'rating', ascending = False)[:5].reset_index()\nTop5books1 = pd.merge(Top5books, df, on = 'book_title', how = 'inner')\ndat = ff.create_table(Top5books)\ndat.update_layout(autosize=False,height=200, width = 1200)","1436ca43":"pandas_profiling.ProfileReport(df)","d5c15e90":"dat = ff.create_table(df.head())\ndat.update_layout(autosize=False,height=200, width = 3990)","ed1d06ad":"df.drop(['year_of_publication', 'publisher', 'book_author', 'img_s', 'img_m', 'img_l'], axis = 1, inplace = True)","e63f9f90":"dat = ff.create_table(df.head())\ndat.update_layout(autosize=False,height=200, width = 800)","8e302f5a":"combine_book_rating = df.dropna(axis = 0, subset = ['book_title'])\n\nbook_ratingCount = (combine_book_rating.\n     groupby(by = ['book_title'])['rating'].\n     count().\n     reset_index().\n     rename(columns = {'rating': 'totalRatingCount'})\n     [['book_title', 'totalRatingCount']]\n    )\n\ndat = ff.create_table(book_ratingCount.head())\ndat.update_layout(autosize=False,height=200, width = 1200)","85739655":"rating_with_totalRatingCount = combine_book_rating.merge(book_ratingCount, left_on = 'book_title', right_on = 'book_title', how = 'left')\n\ndat = ff.create_table(rating_with_totalRatingCount.head())\ndat.update_layout(autosize=False,height=200, width = 1200)","43db08dc":"pd.set_option('display.float_format', lambda x: '%.3f' % x)\nprint(book_ratingCount['totalRatingCount'].describe())","0be2cefa":"print(book_ratingCount['totalRatingCount'].quantile(np.arange(.9, 1, .01)))","ec8e54ca":"#threshold\npopularity_threshold = 50\nrating_popular_book = rating_with_totalRatingCount.query('totalRatingCount >= @popularity_threshold')\ndat = ff.create_table(rating_popular_book.head())\ndat.update_layout(autosize=False,height=200, width = 900)","75318ca0":"#to avoid memory issue:\nusers['location'].value_counts()","658ac5e8":"combined = rating_popular_book.merge(users, left_on = 'user_id', right_on = 'user_id', how = 'left')\n\nall_user_rating = combined[combined['location'].str.contains(\"usa|canada|united kingdom|australia\")]\nall_user_rating=all_user_rating.drop('age', axis=1)\n\ndat = ff.create_table(all_user_rating.head())\ndat.update_layout(autosize=False,height=200, width = 1500)","f9e305ba":"all_user_rating = all_user_rating.drop_duplicates(['user_id', 'book_title'])\nall_user_rating_pivot = all_user_rating.pivot(index = 'book_title', columns = 'user_id', values = 'rating').fillna(0)\nprint('No null values now..')","51ecd14e":"all_user_rating_matrix = csr_matrix(all_user_rating_pivot.values)\nprint('Sparse matrix created..')","425c734d":"model_knn = NearestNeighbors(metric = 'cosine', algorithm = 'brute')\nmodel_knn.fit(all_user_rating_matrix)","477e45d2":"query_index = np.random.choice(all_user_rating_pivot.shape[0])\ndistances, indices = model_knn.kneighbors(all_user_rating_pivot.iloc[query_index, :].values.reshape(1, -1), n_neighbors = 6)\n\nfor i in range(0, len(distances.flatten())):\n    if i == 0:\n        print('Recommendations for {0}:\\n'.format(all_user_rating_pivot.index[query_index]))\n    else:\n        print('{0}: {1}, with distance of {2}:'.format(i, all_user_rating_pivot.index[indices.flatten()[i]], distances.flatten()[i]))","221cdb6a":"query_index = np.random.choice(all_user_rating_pivot.shape[0])\ndistances, indices = model_knn.kneighbors(all_user_rating_pivot.iloc[query_index, :].values.reshape(1, -1), n_neighbors = 6)\n\nfor i in range(0, len(distances.flatten())):\n    if i == 0:\n        print('Recommendations for {0}:\\n'.format(all_user_rating_pivot.index[query_index]))\n    else:\n        print('{0}: {1}, with distance of {2}:'.format(i, all_user_rating_pivot.index[indices.flatten()[i]], distances.flatten()[i]))","3ede44d1":"query_index = np.random.choice(all_user_rating_pivot.shape[0])\ndistances, indices = model_knn.kneighbors(all_user_rating_pivot.iloc[query_index, :].values.reshape(1, -1), n_neighbors = 6)\n\nfor i in range(0, len(distances.flatten())):\n    if i == 0:\n        print('Recommendations for {0}:\\n'.format(all_user_rating_pivot.index[query_index]))\n    else:\n        print('{0}: {1}, with distance of {2}:'.format(i, all_user_rating_pivot.index[indices.flatten()[i]], distances.flatten()[i]))","9220ce30":"**Here, I have used pandas profiling to visualize our data and used KNN approach for the recommendation system. This dataset contains 278,858 users (anonymized but with demographic information) providing 1,149,780 ratings (explicit \/ implicit) about 271,379 books.**\n![](https:\/\/www.detail-online.com\/fileadmin\/uploads\/04-Blog\/MKCA_Concourse_House-teaser-gross.jpg)\n\n**Let's dive into the analysis and if you like my notebook, please appreciate me with an <font color=  'red'>Upvote<\/font>.**","b045f993":"**Pandas Profiling Report**","55d0a236":"**Sparse Matrix**","827f8f53":"# Importing Libraries","6d8943f2":"**First, we will convert data into 2D matrix and later filling NA values to 0. Because, we will be calculating the distance between the rating vectors between book and the users. We will then transform the data(ratings) to the matrix dataframe into a scipy sparse matrix for more efficient classification.**","6813a8c3":"# Training Our Recommendation Model","47f48f29":"**Users Dataset**","ebcf5d64":"# 2.","47b3f933":"# Testing Our Recommendation Model","af0f9073":"**TOP RATED BOOKS: 5**","d96940ee":"**To Avoid Memory loss, we will keep constraints on Location of the users too. We will be taking locations: US, Canada and UK and Australia.Then, combining user data with the rating data and total rating count data.**","947e8c15":"**Ratings Dataset**","d138e953":"# The End","467cd021":"<font color = 'gold'> Observations:<\/font>\n**About 1% of books received 50 or more ratings. We will limit it to top 1%.**","e80bf964":"# KNN Approach","b2b837ed":"# Introduction","da41a285":"# Dataset","5527a1be":"# 3.","a55396dc":"**We will compute the nearest neigbors using <font color = 'red'>Brute<\/font> algorithm and we specify metric as a <font color = 'red'>cosine<\/font>, so that the algorithm will calculate the cosine similarity between the rating vectors. Fitting the model...**","3f33264a":"**Data Manipulation**","ccb3e7c0":"**Statistics Of Total Ratings Count**","e5362f31":"# 1.","210063d8":"**Books Dataset**","b1c33015":"# Recommendation System: K- Nearest Neighbors\n**We will find clusters of similar users based on their common book ratings, and make predictions using the average rating of top-k nearest neigbors. We will be having books in rows and their ratings as their values with user id's in columns.**","a3e15085":"**Ratings With Total Rating Count**","37b0fc57":"**Combined Book Ratings**","7cc202e4":"**Distibution of the top 1% books**","e61776fd":"# EDA","d524d827":"**Combining Books and Ratings on the basis of ISBN**","2b562f53":"**Keeping Threshold**"}}