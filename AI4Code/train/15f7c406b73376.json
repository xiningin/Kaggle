{"cell_type":{"0a616808":"code","9d9a5048":"code","18e244ee":"code","50fbe841":"code","c5a7fbe8":"code","e3c8d465":"code","57cdd827":"code","a730c2b0":"code","8934c9f5":"code","37986bb9":"code","f12c09c6":"code","094981ac":"code","272a3f44":"code","11e05ff6":"code","d0b62af6":"code","03d0de67":"code","1de4aaa0":"code","52d1b9f5":"code","f82d8368":"code","f79fb471":"code","f91e4411":"code","3cf442f4":"markdown","b52a641f":"markdown","72958378":"markdown","a249fdf9":"markdown","3bc2e4d5":"markdown","1086bf37":"markdown","9650b6ca":"markdown","3c2e693d":"markdown","794df764":"markdown","5b29074d":"markdown","be7fbf87":"markdown","bc5683d1":"markdown","e760f413":"markdown","172e483c":"markdown","865f041a":"markdown"},"source":{"0a616808":"import numpy as np\nimport matplotlib.pyplot as plt\nimport scipy.io as scio\nimport keras\nfrom IPython.display import clear_output\nimport keras.utils as ult\nfrom keras.layers import Activation, Dropout, Flatten, Dense, Input, BatchNormalization,Conv3D, MaxPooling3D, Dense, Add, Activation\nfrom keras import regularizers\nfrom keras.models import Model\nfrom keras.optimizers import Adam, SGD, Adagrad, RMSprop\nimport time\n\nfrom numpy.random import seed\nseed(1)\nfrom tensorflow import set_random_seed\nset_random_seed(2)","9d9a5048":"class PlotLosses(keras.callbacks.Callback):\n    def on_train_begin(self, logs={}):\n        self.i = 0\n        self.x = []\n        self.losses = []\n        self.val_losses = []\n        self.losses2 = []\n        self.val_losses2 = []\n        \n        self.fig = plt.figure()\n        \n        self.logs = []\n\n    def on_epoch_end(self, epoch, logs={}):\n        self.logs.append(logs)\n        self.x.append(self.i)\n        self.losses.append(logs.get('loss'))\n        self.val_losses.append(logs.get('val_loss'))\n        self.losses2.append(logs.get('categorical_accuracy'))\n        self.val_losses2.append(logs.get('val_categorical_accuracy'))\n\n        self.i += 1\n        \n        clear_output(wait=True)\n        plt.subplot(1,2,1)\n        plt.plot(self.x, self.losses2, label=\"Training accuracy\",linestyle='-')\n        plt.plot(self.x, self.val_losses2, label=\"Testing accuracy\",linestyle='--')\n        plt.ylim(0,1)\n        plt.legend()\n        plt.xlabel('Epoch')\n        plt.ylabel('Accuracy')\n        \n        plt.subplot(1,2,2)\n        plt.plot(self.x, self.losses, label=\"Training loss\",linestyle='-')\n        plt.plot(self.x, self.val_losses, label=\"Testing loss\",linestyle='--')\n\n        plt.legend()\n        plt.xlabel('Epoch')\n        plt.ylabel('Loss')\n        \n        plt.tight_layout()\n        \n        plt.show();\n        \nplot_losses = PlotLosses()","18e244ee":"def show_images(images,galaxy_labels):\n    fig = plt.figure()\n    plt.subplot(1,3,1)\n    plt.title(label_trans(galaxy_labels[0]))\n    plt.imshow(images[0,:,:,0], vmax=255)\n    plt.axis('off')\n    plt.subplot(1,3,2)\n    plt.imshow(images[0,:,:,1], vmax=255)\n    plt.axis('off')\n    plt.subplot(1,3,3)\n    plt.imshow(images[0,:,:,2], vmax=255)\n    plt.axis('off')\n\n    fig = plt.figure()\n    plt.subplot(1,3,1)\n    plt.title(label_trans(galaxy_labels[1]))\n    plt.imshow(images[1,:,:,0], vmax=255)\n    plt.axis('off')\n    plt.subplot(1,3,2)\n    plt.imshow(images[1,:,:,1], vmax=255)\n    plt.axis('off')\n    plt.subplot(1,3,3)\n    plt.imshow(images[1,:,:,2], vmax=255)\n    plt.axis('off')\n\n    fig = plt.figure()\n    plt.subplot(1,3,1)\n    plt.title(label_trans(galaxy_labels[5]))\n    plt.imshow(images[5,:,:,0], vmax=255)\n    plt.axis('off')\n    plt.subplot(1,3,2)\n    plt.imshow(images[5,:,:,1], vmax=255)\n    plt.axis('off')\n    plt.subplot(1,3,3)\n    plt.imshow(images[5,:,:,2], vmax=255)\n    plt.axis('off')","50fbe841":"def label_trans(label_id):\n    if label_id==0: return \"star\"\n    if label_id==1: return \"spiral galaxy\"\n    if label_id==2: return \"elliptical galaxy\"\n    else: return \"unknown\"  ","c5a7fbe8":"images=np.load(\"..\/input\/galaxy_cubes.npy\")\ngalaxy_labels=np.load(\"..\/input\/labels.npy\")\n[images.shape, galaxy_labels.shape]\n\nshow_images(images,galaxy_labels) ","e3c8d465":"images= images+np.random.randn(10000,41,41,3)*20\nimages= np.clip(images, 0, 255)\n\nshow_images(images,galaxy_labels) ","57cdd827":"num_train_examples =   2000\nnum_test_examples  =    500","a730c2b0":"images_train=images[0:num_train_examples,:,:,:]\nimages_test=images[2500:2500+num_test_examples,:,:,:]\n\nTrain_data=images_train.reshape(num_train_examples, images.shape[1],images.shape[2],images.shape[3],1)\nTest_data=images_test.reshape(num_test_examples, images.shape[1],images.shape[2],images.shape[3],1)\n\ntrain_labels=galaxy_labels[0:num_train_examples]\ntest_labels=galaxy_labels[2500:2500+num_test_examples]\n\ntrain_labels_cat=ult.to_categorical(train_labels,num_classes=3)\ntest_labels_cat=ult.to_categorical(test_labels,num_classes=3)","8934c9f5":"inputs = Input((images.shape[1], images.shape[2], images.shape[3], 1),name='main_input')\n\nconv00  = Conv3D(16, (3, 3, 2), strides=(1, 1, 1), padding='same', name='conv00')(inputs)\n#bn00 = BatchNormalization()(conv00)\nact00 = Activation('relu')(conv00)\npool00  = MaxPooling3D(pool_size=(3, 3, 1), strides=(2, 2, 1), padding='same')(act00)\n\n\nconv10  = Conv3D(16, (3, 3, 2), strides=(1, 1, 1), padding='same', name='conv10')(pool00)\n#bn10 = BatchNormalization()(conv10)\nact10 = Activation('relu')(conv10)\n#add00 = Add()([pool00,act10])\npool10  = MaxPooling3D(pool_size=(3, 3, 1), strides=(2, 2, 1), padding='same')(act10)\n\n\nconv20  = Conv3D(16, (3, 3, 2), strides=(1, 1, 1), padding='same', name='conv20')(pool10)\n#bn20 = BatchNormalization()(conv20)\nact20 = Activation('relu')(conv20)\n#add20 = Add()([pool10,act20])\npool20  = MaxPooling3D(pool_size=(3, 3, 1), strides=(2, 2, 1), padding='same')(act20)\n\nfl0 = Flatten(name='fl0')(pool20)\n#Do0 = Dropout(rate=0.5)(fl0)\nfc0 = Dense(32,activation='linear')(fl0)\n#Do1 = Dropout(rate=0.5)(fc0)\nfc1 = Dense(8,activation='linear')(fc0)\n#Do2 = Dropout(rate=0.5)(fc1)\n\nDn0 = Dense(3,activation='softmax', name='Dn0' )(fc1)\n\nmodel_1 = Model(inputs=[inputs], outputs=[Dn0])","37986bb9":"optzr =  Adam(lr=1e-4, beta_1=0.9, beta_2=0.999, decay=0.0)\nmodel_1.compile(loss='categorical_crossentropy',optimizer=optzr, metrics =['categorical_accuracy'])\nmodel_1.summary()","f12c09c6":"start_time = time.time()\nhistory=model_1.fit(Train_data,train_labels_cat, batch_size=20, epochs=50,validation_data=[Test_data,test_labels_cat],callbacks=[plot_losses],shuffle=True)\nelapsed_time = time.time() - start_time\ntime.strftime(\"%H:%M:%S\", time.gmtime(elapsed_time))","094981ac":"ls,acc=model_1.evaluate(Test_data,test_labels_cat)\nprint(\"Loss value: %.2f\" % (ls))  \nprint(\"Accuracy: %.1f\" % (acc*100))   ","272a3f44":"preds=model_1.predict(Test_data[50:51,:,:,:,:])\nprint(preds)\nprint(test_labels[50])","11e05ff6":"lr1=model_1.layers[1].output  \nlr2=model_1.layers[4].output\nlr3=model_1.layers[7].output\n\nactivation_model_lr1 = Model(inputs=[inputs], outputs=lr1)\nactivation_model_lr2 = Model(inputs=[inputs], outputs=lr2)\nactivation_model_lr3 = Model(inputs=[inputs], outputs=lr3)","d0b62af6":"s = np.random.randint(0,100)\nprint(s)\n\nplt.imshow(Test_data[s,:,:,0,0])\nplt.title('Input image')\nplt.show()\n\nactivations_lr1 = activation_model_lr1.predict(Test_data[s:s+1,:,:,:,:]) \nactivations_lr2 = activation_model_lr2.predict(Test_data[s:s+1,:,:,:,:]) \nactivations_lr3 = activation_model_lr2.predict(Test_data[s:s+1,:,:,:,:]) \n\nfor i in range(16):\n    img=activations_lr3[0,:,:,0,i]\n    plt.imshow(img)\n    plt.title('Number ' + str(i))\n    plt.show()\nplt.show()\n","03d0de67":"def build_finetune_model(base_model, dropout, fc_layers, num_classes):\n    for layer in base_model.layers:\n        layer.trainable = False\n\n    x = base_model.output\n    x = Flatten()(x)\n    for fc in fc_layers:\n        # New FC layer, random init\n        x = Dense(fc, activation='relu')(x) \n        x = Dropout(dropout)(x)\n\n    # New softmax layer\n    predictions = Dense(num_classes, activation='softmax')(x) \n    \n    finetune_model = Model(inputs=base_model.input, outputs=predictions)\n\n    return finetune_model","1de4aaa0":"from keras.applications.resnet50 import ResNet50\n\nbase_model = ResNet50(weights='imagenet', include_top=False, input_shape=(205, 205, 3))\n\nFC_LAYERS = [256]\ndropout = 0.5\n\nfinetune_model = build_finetune_model(base_model, dropout=dropout, fc_layers=FC_LAYERS, num_classes=3)\n\nfinetune_model.summary()\n","52d1b9f5":"from PIL import Image\nimages2=np.empty([3000,205,205,3])\nfor i in range(3000):\n    for c in range(3):\n        tmp=images[i,:,:,c]\n        img = Image.fromarray(tmp)\n        img2 = img.resize((205,205),Image.BICUBIC)\n        images2[i,:,:,c]=img2    \n\n#show_figures(images2)","f82d8368":"Train_data=images2[0:num_train_examples,:,:,:]\nTest_data=images2[2500:2500+num_test_examples,:,:,:]\n\nprint(Train_data.shape)\nprint(Test_data.shape)\n\ntrain_labels=galaxy_labels[0:num_train_examples]\ntest_labels=galaxy_labels[2500:2500+num_test_examples]\n\ntrain_labels_cat=ult.to_categorical(train_labels,num_classes=3)\ntest_labels_cat=ult.to_categorical(test_labels,num_classes=3)\n\nprint(train_labels_cat.shape)\nprint(test_labels_cat.shape)","f79fb471":"finetune_model.compile(optzr, loss='categorical_crossentropy', metrics=['categorical_accuracy'])\n\nhistory = finetune_model.fit(Train_data,train_labels_cat, batch_size=20, epochs=50,validation_data=[Test_data,test_labels_cat],callbacks=[plot_losses],shuffle=True)\n","f91e4411":"ls,acc=finetune_model.evaluate(Test_data,test_labels_cat)\nprint(\"Loss value: %.2f\" % (ls))  \nprint(\"Accuracy: %.1f\" % (acc*100))  ","3cf442f4":"# Resize the data","b52a641f":"# Galaxy morphology estimation","72958378":"## Create training and testing (validation) dataset","a249fdf9":"## Define an auxiliary function to plot the accuracy and loss value during training","3bc2e4d5":"# Check performance","1086bf37":"## Load the data\n\n**data**: are images at different wavelenghts i.e. 3D with 2 spatial (41x41 pixels) and 1 spectral (9 bands) dimension     \n**labels**: take values 0: star, 1: spiral galaxy, 2: elliptical galaxy   ","9650b6ca":"# Predict label for particular example","3c2e693d":"## Print the activations for particular inputs","794df764":"## Select optimizer and compile the model","5b29074d":"## Use intemediate layers as outputs","be7fbf87":"# Add white noise to observations","bc5683d1":"## Load necessary libraries","e760f413":"## Train the network","172e483c":"## Define network layers and characteristics","865f041a":"# Fine-tune pre-trained model"}}