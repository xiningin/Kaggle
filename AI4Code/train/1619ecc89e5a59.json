{"cell_type":{"c173c883":"code","94a48e05":"code","3efe4768":"code","08713825":"code","b654c1bd":"code","2f3e7c54":"code","6f1160d2":"code","d82a2649":"code","e2f72e1d":"code","462a1c8c":"code","fbf98269":"code","36d84301":"code","14c0533d":"code","0e5843fe":"code","23ba7bf7":"code","9b7f3421":"code","3a810020":"code","451da8a3":"code","2b329e1b":"code","4e18c627":"code","ec1b6100":"code","46b7048c":"code","4f7f5141":"code","5585f594":"code","312c308a":"code","366c0a19":"code","098749ad":"code","e2299889":"code","8f02d6e5":"code","9683a102":"code","e5130ba0":"code","73407e2d":"code","6f840bf6":"code","883394b8":"code","583f5dc6":"code","08f9e3fb":"markdown","80c3a2ba":"markdown","94a67367":"markdown","accb095c":"markdown","a7b2d1fc":"markdown","52a2c3aa":"markdown","e96d8ec8":"markdown","d32e5746":"markdown","e5992f1f":"markdown","7307dd92":"markdown","2a0b4007":"markdown","c406a13b":"markdown","609c1d05":"markdown","d25c82c1":"markdown","149ea83c":"markdown","4213c215":"markdown","091d71c7":"markdown","cc4ca96b":"markdown","bdd74403":"markdown","0694074a":"markdown","46fdbe37":"markdown","fcc18738":"markdown"},"source":{"c173c883":"%matplotlib inline\n\nimport numpy as np\nimport pandas as pd\nimport matplotlib.pyplot as plt\nimport seaborn as sns\nsns.set_context(\"notebook\")\n\nimport warnings\nwarnings.filterwarnings(\"ignore\")\n\nimport glob\nfilelist = glob.glob(\"..\/input\/*.csv\")\n\n# Load data\nsantander = pd.read_csv('..\/input\/santander.csv', sep=',', index_col=0, parse_dates=True)\ncols = ['Open', 'High', 'Low', 'Close', 'Volume']\nsantander = santander[cols].copy()\nsantander = santander[santander.index>='2015-01-01']\n\ndf_stocks = pd.DataFrame()\n\nfor i in filelist:\n    tmp = pd.read_csv(i)\n    tmp['symbol'] = i.split('\/')[-1].split('.')[0]\n    df_stocks = df_stocks.append(tmp)\n\ncols = ['Date', 'Close', 'Volume', 'symbol']\ndf_stocks = df_stocks[cols].copy()\ndf_stocks['Date'] = pd.to_datetime(df_stocks['Date'])\n\n# create new dataframe with just closing price for each stock\ndf = df_stocks.pivot(index='Date', columns='symbol', values='Close')\n\n# subset data since 2015\ndf = df[df.index>='2015-01-01']\ndf.tail()","94a48e05":"plt.figure(figsize=(15,7))\ntop = plt.subplot2grid((4,4), (0, 0), rowspan=3, colspan=4)\nbottom = plt.subplot2grid((4,4), (3,0), rowspan=1, colspan=4)\ntop.plot(santander.index, santander['Close']) \nbottom.bar(santander.index, santander['Volume']) \n \n# set the labels\ntop.axes.get_xaxis().set_visible(False)\ntop.set_title('Santander')\ntop.set_ylabel('Closing Price')\nbottom.set_ylabel('Volume');","3efe4768":"plt.figure(figsize=(15,7))\nsns.distplot(santander['Close'].dropna(), bins=50, color='purple');","08713825":"# simple moving averages\nsma5 = santander['Close'].rolling(5).mean() #5 days\nsma100 = santander['Close'].rolling(100).mean() #100 days\n \nsantander_sma = pd.DataFrame({'santander': santander['Close'], 'SMA 5': sma5, 'SMA 100': sma100})\nsantander_sma.plot(figsize=(15, 7), legend=True, title='Santander');","b654c1bd":"df.plot(figsize=(15,8))\nplt.ylabel('Price');","2f3e7c54":"returnfstart = df.apply(lambda x: x \/ x[0])\nreturnfstart.plot(figsize=(15,7)).axhline(1, lw=1, color='black')\nplt.ylabel('Return From Start Price');","6f1160d2":"df.pct_change().plot(figsize=(15,7))\nplt.axhline(0, color='black', lw=1)\nplt.ylabel('Daily Percentage Return');","d82a2649":"# Resample df to business months, take last observation as value \nmonthly = df.resample('BM').apply(lambda x: x[-1])\n\n# Calculate the monthly percentage change\nmonthly.pct_change().plot(figsize=(15,7))\nplt.axhline(0, color='black', lw=1)\nplt.ylabel('Monthly Percentage Return');","e2f72e1d":"# Resample df to quarters, take the mean as value per quarter\nquarter = df.resample('4M').mean()\n\n# Calculate the quarterly percentage change\nquarter.pct_change().plot(figsize=(15,7))\nplt.axhline(0, color='black', lw=1)\nplt.ylabel('Quarterly Percentage Return');","462a1c8c":"sns.jointplot('santander', 'siemens-gamesa', df, kind='reg', color='seagreen');","fbf98269":"# Compute the correlation matrix\ncorr = df.corr()\n\n# Generate a mask for the upper triangle\nmask = np.zeros_like(corr, dtype=np.bool)\nmask[np.triu_indices_from(mask)] = True\n\n# Set up the matplotlib figure\nf, ax = plt.subplots(figsize=(10, 10))\n\n# Generate a custom diverging colormap\ncmap = sns.diverging_palette(220, 10, as_cmap=True)\n\n# Draw the heatmap with the mask and correct aspect ratio\nsns.heatmap(corr, mask=mask, cmap=cmap, vmax=.3, center=0,\n            square=True, linewidths=.5, cbar_kws={\"shrink\": .5});\n","36d84301":"fig = sns.PairGrid(df[['santander', 'siemens-gamesa', 'telefnica']].dropna())\n# define top, bottom and diagonal plots\nfig.map_upper(plt.scatter, color='purple')\nfig.map_lower(sns.kdeplot, cmap='cool_d')\nfig.map_diag(sns.distplot, bins=30);","14c0533d":"daily_pct_c = df\/ df.shift(1) -1\ndaily_pct_c.hist(bins=50, figsize=(15,20))\nplt.show()\n\ndisplay(daily_pct_c.describe())","0e5843fe":"cum_daily_return = (1 + daily_pct_c).cumprod()\n\ncum_daily_return.plot(figsize=(12,8))\nplt.ylabel('Cumulative Daily Returns');\nplt.axhline(1, color='black', lw=1)\nplt.show()","23ba7bf7":"# Resample the cumulative daily return to cumulative monthly return \ncum_monthly_return = cum_daily_return.resample(\"M\").mean()\n\ncum_monthly_return.plot(figsize=(12,8))\nplt.ylabel('Cumulative Monthly Returns');\nplt.axhline(1, color='black', lw=1)\nplt.show()","9b7f3421":"# Define the minumum of periods to consider \nmin_periods = 75 \n\n# Calculate the volatility\nvol = daily_pct_c.rolling(min_periods).std() * np.sqrt(min_periods) \n\n# Plot the volatility\nvol.plot(figsize=(10, 8))\n\n# Show the plot\nplt.show()","3a810020":"santander.head()","451da8a3":"# Initialize the short and long windows\nshort_window = 40\nlong_window = 100\n\n# Initialize the `signals` DataFrame with the `signal` column\nsignals = pd.DataFrame(index=santander.index)\nsignals['signal'] = 0.0\n\n# Create short simple moving average over the short window\nsignals['short_mavg'] = santander['Close'].rolling(window=short_window, min_periods=1, center=False).mean()\n\n# Create long simple moving average over the long window\nsignals['long_mavg'] = santander['Close'].rolling(window=long_window, min_periods=1, center=False).mean()\n\n# Create signals\nsignals['signal'][short_window:] = np.where(signals['short_mavg'][short_window:] \n                                            > signals['long_mavg'][short_window:], 1.0, 0.0)   \n\n# Generate trading orders\nsignals['positions'] = signals['signal'].diff()","2b329e1b":"# Initialize the plot figure\nfig = plt.figure(figsize=(10, 8))\n\n# Add a subplot and label for y-axis\nax1 = fig.add_subplot(111,  ylabel='Price in $')\n\n# Plot the closing price\nsantander['Close'].plot(ax=ax1, color='grey', lw=2.)\n\n# Plot the short and long moving averages\nsignals[['short_mavg', 'long_mavg']].plot(ax=ax1, lw=2.)\n\n# Plot the buy signals\nax1.plot(signals.loc[signals.positions == 1.0].index, \n         signals.short_mavg[signals.positions == 1.0],\n         '^', markersize=10, color='m')\n         \n# Plot the sell signals\nax1.plot(signals.loc[signals.positions == -1.0].index, \n         signals.short_mavg[signals.positions == -1.0],\n         'v', markersize=10, color='k')\n         \n# Show the plot\nplt.show()","4e18c627":"# Set the initial capital\ninitial_capital= float(100000.0)\n\n# Create a DataFrame `positions`\npositions = pd.DataFrame(index=signals.index).fillna(0.0)\n\n# Buy a 100 shares\npositions['santander'] = 100*signals['signal']   \n  \n# Initialize the portfolio with value owned   \nportfolio = positions.multiply(santander['Close'], axis=0)\n\n# Store the difference in shares owned \npos_diff = positions.diff()\n\n# Add `holdings` to portfolio\nportfolio['holdings'] = (positions.multiply(santander['Close'], axis=0)).sum(axis=1)\n\n# Add `cash` to portfolio\nportfolio['cash'] = initial_capital - (pos_diff.multiply(santander['Close'], axis=0)).sum(axis=1).cumsum()   \n\n# Add `total` to portfolio\nportfolio['total'] = portfolio['cash'] + portfolio['holdings']\n\n# Add `returns` to portfolio\nportfolio['returns'] = portfolio['total'].pct_change()\n","ec1b6100":"fig = plt.figure(figsize=(10, 8))\n\nax1 = fig.add_subplot(111, ylabel='Portfolio value in $')\n\n# Plot the equity curve in dollars\nportfolio['total'].plot(ax=ax1, lw=2.)\n\n# Plot the \"buy\" trades against the equity curve\nax1.plot(portfolio.loc[signals.positions == 1.0].index, \n         portfolio.total[signals.positions == 1.0],\n         '^', markersize=10, color='m')\n\n# Plot the \"sell\" trades against the equity curve\nax1.plot(portfolio.loc[signals.positions == -1.0].index, \n         portfolio.total[signals.positions == -1.0],\n         'v', markersize=10, color='k')\n\n# Show the plot\nplt.show()","46b7048c":"# Isolate the returns of your strategy\nreturns = portfolio['returns']\n\n# annualized Sharpe ratio\nsharpe_ratio = np.sqrt(252) * (returns.mean() \/ returns.std())\n\n# Print the Sharpe ratio\nprint(np.round(sharpe_ratio,2))","4f7f5141":"# Define a trailing 252 trading day window\nwindow = 252\n\n# Calculate the max drawdown in the past window days for each day\nrolling_max = santander['Close'].rolling(window, min_periods=1).max()\ndaily_drawdown = santander['Close']\/rolling_max - 1.0\n\n# Calculate the minimum (negative) daily drawdown\nmax_daily_drawdown = daily_drawdown.rolling(window, min_periods=1).min()\n\n# Plot the results\ndaily_drawdown.plot()\nmax_daily_drawdown.plot()\n\n# Show the plot\nplt.show()","5585f594":"# Get the number of days in `aapl`\ndays = (santander.index[-1] - santander.index[0]).days\n\n# Calculate the CAGR \ncagr = ((((santander['Close'][-1]) \/ santander['Close'][1])) ** (365.0\/days)) - 1\n\n# Print CAGR\nprint(np.round(cagr,3))","312c308a":"# Drop the columns\nph_df = santander.drop(['Open', 'High', 'Low','Volume'], axis=1)\nph_df.reset_index(inplace=True)\nph_df.rename(columns={'Close': 'y', 'Date': 'ds'}, inplace=True)\nph_df['ds'] = pd.to_datetime(ph_df['ds'])\nph_df.head()","366c0a19":"from fbprophet import Prophet\nm = Prophet()\nm.fit(ph_df)\n\n# Create Future dates\nfuture_prices = m.make_future_dataframe(periods=365)\n\n# Predict Prices\nforecast = m.predict(future_prices)\nforecast[['ds', 'yhat', 'yhat_lower', 'yhat_upper']].tail()","098749ad":"fig = m.plot(forecast)\nax1 = fig.add_subplot(111)\nax1.set_title(\"Santander Stock Price Forecast\", fontsize=16)\nax1.set_xlabel(\"Date\", fontsize=12)\nax1.set_ylabel(\"Close Price\", fontsize=12)\nplt.show()","e2299889":"fig2 = m.plot_components(forecast)\nplt.show()","8f02d6e5":"# Monthly Data Predictions\nm = Prophet(changepoint_prior_scale=0.01).fit(ph_df)\nfuture = m.make_future_dataframe(periods=12, freq='M')\nfcst = m.predict(future)\nfig = m.plot(fcst)\nplt.title(\"Monthly Prediction \\n 1 year time frame\", fontsize=16)\nplt.xlabel(\"Date\", fontsize=12)\nplt.ylabel(\"Close Price\", fontsize=12)\n\nplt.show()","9683a102":"fig = m.plot_components(fcst)\nplt.show()","e5130ba0":"from plotly import tools\nimport plotly.plotly as py\nimport plotly.figure_factory as ff\nimport plotly.tools as tls\nimport plotly.graph_objs as go\nfrom plotly.offline import download_plotlyjs, init_notebook_mode, plot, iplot\ninit_notebook_mode(connected=True)","73407e2d":"trace = go.Ohlc(x=santander.index,\n                open=santander['Open'],\n                high=santander['High'],\n                low=santander['Low'],\n                close=santander['Close'],\n               increasing=dict(line=dict(color= '#58FA58')),\n                decreasing=dict(line=dict(color= '#FA5858')))\n\nlayout = {\n    'title': 'Santander Historical Price',\n    'xaxis': {'title': 'Date',\n             'rangeslider': {'visible': False}},\n    'yaxis': {'title': 'Stock Price'},\n    'shapes': [{\n        'x0': '2018-12-31', 'x1': '2018-12-31',\n        'y0': 0, 'y1': 1, 'xref': 'x', 'yref': 'paper',\n        'line': {'color': 'rgb(30,30,30)', 'width': 1}\n    }],\n    'annotations': [{\n        'x': '2019-01-01', 'y': 0.05, 'xref': 'x', 'yref': 'paper',\n        'showarrow': False, 'xanchor': 'left',\n        'text': '2019 <br> starts'\n    }]\n}\n\ndata = [trace]\n\nfig = go.Figure(data=data, layout=layout)\niplot(fig, filename='simple_ohlc')\n","6f840bf6":"# Moving Averages (10, 50 and 200)\nsantander['10_d_avg'] = santander.Close.rolling(window=10).mean()\nsantander['50_d_avg'] = santander.Close.rolling(window=50).mean()\nsantander['200_d_avg'] = santander.Close.rolling(window=200).mean()\nclose_p = santander['Close'].values.tolist()\n\n\n# Variables to insert into plotly\nten_d = santander['10_d_avg'].values.tolist()\nfifty_d = santander['50_d_avg'].values.tolist()\ntwoh_d = santander['200_d_avg'].values.tolist()\ndate = santander.index.values.tolist()\n\n# Set date as index\n#amzn_df = amzn_df.set_index('date')","883394b8":"fig = tls.make_subplots(rows=2, cols=1, shared_xaxes=True)\n\ncolors = ['#ff4500', '#92a1cf', '#6E6E6E']\navgs = ['10_d_avg', '50_d_avg', '200_d_avg']\n# for i,c in zip(range(n),color):\n#    ax1.plot(x, y,c=c)\n\nfor col, c in zip(avgs, colors):\n    fig.append_trace({'x': santander.index, 'y': santander[col], 'type': 'scatter', 'name': col, 'line': {'color': c}}, 1, 1)\nfor col in ['Close']:\n    fig.append_trace({'x': santander.index, 'y': santander[col], 'type': 'scatter', 'name': 'Closing Price', 'line':{'color': '#01DF3A'}}, 2, 1)\n    \nfig['layout'].update(height=800,title='Relationship between MAs <br> and Closing Price',\n                    paper_bgcolor='#F2DFCE', plot_bgcolor='#F2DFCE')\n    \niplot(fig, filename='pandas\/mixed-type subplots')","583f5dc6":"# Take off the date index\nsantander = santander.reset_index()\n\n# Plotly\ntrace0 = go.Scatter(\n    x = santander['Date'],\n    y = ten_d,\n    name = '10-day MA',\n    line = dict(\n        color = ('#ff6347'),\n        width = 4)\n)\ntrace1 = go.Scatter(\n    x = santander['Date'],\n    y = fifty_d,\n    name = '50-day MA',\n    line = dict(\n        color = ('#92a1cf'),\n        width = 4,\n    dash=\"dot\")\n)\ntrace2 = go.Scatter(\n    x = santander['Date'],\n    y = twoh_d,\n    name = '200-day MA',\n    line = dict(\n        color = ('#2EF688'),\n        width = 4,\n        dash = 'dash') # dash options include 'dash', 'dot', and 'dashdot'\n)\n\ndata = [trace0, trace1, trace2]\n\n\n# Edit the layout\nlayout = dict(title = 'Moving Averages for Santander',\n              xaxis = dict(title = 'Date'),\n              yaxis = dict(title = 'Price'),\n#               annotations=[\n#         dict(\n#             x='2016-01-13',\n#             y=657,\n#             xref='x',\n#             yref='y',\n#             text='<i> First major decline <br> after 10-d crosses <br> 50-d moving average <\/i>',\n#             showarrow=True,\n#             arrowhead=5,\n#             ax=5,\n#             ay=-50\n#         ), dict(\n#         x = \"2016-02-24\",\n#         y = 535,\n#         text = \"<i>Upward trend after <br> 10-day crosses <br>200-day moving average <\/i>\",\n#         textangle = 0,\n#         ax = 50,\n#         ay = 50,\n#         font = dict(\n#           color = \"black\",\n#           size = 12\n#         )\n#         )],\n              paper_bgcolor='#FFF9F5',\n              plot_bgcolor='#FFF9F5'\n              )\n\nfig = dict(data=data, layout=layout)\niplot(fig, filename='styled-line')","08f9e3fb":"Cumulative daily returns","80c3a2ba":"### Backtesting a strategy","94a67367":"#### Plot  Daily Closing Price of multiple stocks","accb095c":"PairGrid can be used for paired comparisons with flexibility on the type of charts being plotted. For this case, a scatterplots, kde plots and histograms are plotted.","a7b2d1fc":"Distribution of daily percentage change","52a2c3aa":"### Moving Averages","e96d8ec8":"#### Chart Simple Moving Average","d32e5746":"#### Maximum Drawdown","e5992f1f":"Volatility Calculation","7307dd92":"### Building a trading strategy","2a0b4007":"### Monthly Predictions","c406a13b":"#### Compound Annual Growth Rate (CAGR)","609c1d05":"### OHLC","d25c82c1":"Just looking at the chart, you can see that the relationship is somewhat linear. Strongly correlated stocks can be used in pair trading","149ea83c":"### Evaluating Moving Average Crossover Strategy\n#### Sharpe Ratio","4213c215":"#### Plot a Histogram of the Daily Closing Price","091d71c7":"### Forecast stock price","cc4ca96b":"Because of stocks overlapping each other, it is a little hard to make any comparisons here. It is better to have some hard numbers so lets do some correlation plots.\n\n#### Correlation Plots","bdd74403":"Another way is the plot the daily percentage change of stock price.","0694074a":"# Workflow for visualizing and analyzing stocks\nBasics for handling and analyzing stock market data\n\n### 1. Import Multiple Stock Data","46fdbe37":"### 2. Visualizing Stock Data\n\n#### Plot the Daily Closing Price and Volume of a Stock","fcc18738":"As each stock has different prices, it is difficult to compare between them to visualise any relationships. Some transformation can help to normalise this issue.\n\n#### Normalizing multiple stocks\nDividing all the closing price to the first closing price in the period."}}