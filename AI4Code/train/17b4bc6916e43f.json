{"cell_type":{"d535f50f":"code","d25397d4":"code","4291580e":"code","172f9488":"code","5d80e146":"code","cae3fc0d":"code","65039c02":"code","61eeff5a":"code","28fab03b":"code","afdd4f64":"markdown","20e438f5":"markdown","00250a0c":"markdown","d3e9e3ff":"markdown","e2215aef":"markdown","57cb2447":"markdown"},"source":{"d535f50f":"import pandas as pd\nimport numpy as np\nimport glob\nimport matplotlib.pyplot as plt\nfrom sklearn.ensemble import RandomForestClassifier\nfrom sklearn.model_selection import train_test_split\nfrom sklearn.metrics import average_precision_score,roc_auc_score\nfrom imblearn.over_sampling import SMOTE\nfrom tqdm import tqdm\nimport warnings\nwarnings.filterwarnings(\"ignore\")","d25397d4":"# This will load the whole data, where each row represents a completed match\n# Column 1 shows the run-rate of the team batting first (Team 1) at the end of 6 overs (powerplay).\n# Column 2 shows the wickets remaining for the team batting first (Team 1) at the end of 6 overs (powerplay).\n# Column 3 shows the run-rate of the team batting first (Team 1) at the end of 15 overs.\n# Column 4 shows the wickets remaining for the team batting first (Team 1) at the end of 15 overs.\n# Column 5 shows the run-rate of the team batting first at the completion of 1st innings i.e. 20 overs.\n# Column 6 shows if the team batting first won or lost. (I treated Tie as a win for both teams so this column would be 0 if team batting first lost and 1 otherwise).\n# Column 7 shows the required run-rate for the chasing team (Team 2) at the end of 1st over.\n# Column 8 shows the wickets remaining for the chasing team (Team 2) at the end of 1st over.\n# Column 9-44 show the same data for chasing team (Team 2) as column 7-8, at the end of overs number 2-19 respectively.\ndf_data = pd.read_table('\/kaggle\/input\/pakistansuperleaguepsl-155matches\/PSL_155matches.csv',sep=\",\")\ndf_data.head()","4291580e":"# This data frame is a subset of whole dataset which contains features from Team 1's innings only\ndf1 = df_data.iloc[:,0:6]\ndf1.head()","172f9488":"def situational_model(overnum, seed):\n    t = overnum-1\n    df2 = df_data.iloc[:,[0, 1 , 2 ,3 ,4 ,5 , (t*2)+6, (t*2)+7]] # This add two features i.e. Required run-rate and wickets remaining after particular over\n    \n    if overnum == 0: # This means we are interested in prediction after the end of first innings.\n        X = df2.values[:,[0,1,2,3,4]]\n    else:\n        X = df2.values[:,[0,1,2,3,4,6,7]]\n\n    y = df2.values[:,5] # 0 if Team batting first loses and 1 otherwise\n    X[X==np.inf] = 10000 # setting inf to high number just to avoid complications\n    \n    sm = SMOTE(random_state=42) # SMOTE function to deal with class imbalance \n    \n    X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.20, random_state=42) #80% matches for training- 20% for testing\n    \n    X_res, y_res = sm.fit_resample(X_train, y_train) # Since the data is imbalanced, we oversample the minority class in training data using SMOTE\n    \n    clf2 = RandomForestClassifier(random_state=seed).fit(X_res,y_res) # Random Forest classifier\n    \n    # Uncomment the below lines if you want to see the performance of model on test data\n    \n    #if seed == 42:\n    #    print('Valdiation accuracy: %.2f'%clf2.score(X_test,y_test)) \n    \n    return clf2 ","5d80e146":"num = 6 # Match of interest in test file\novernum = [0,6,15] # Overs of interest","cae3fc0d":"df_new = pd.read_table('https:\/\/raw.githubusercontent.com\/AmmarMalik93\/PSL-Prediction\/main\/new_matches.csv', sep=',', index_col=0)\nmatch = df_new.iloc[:,num-1].values.reshape(1,-1)\nTeam1 = df_new.columns[num-1].split('_')[0][0:2]\nTeam2 = df_new.columns[num-1].split('_')[1][0:2]\n\n\nprint('%s vs %s'%(Team1,Team2))\n\n\n## For other matches you can provide these values manually too","65039c02":"Team1_prob = list()\nTeam2_prob = list()\nRRR = list()\nWkts = list()\n\nfor over_num in overnum:\n    over_num = int(over_num)\n    win_prob = list()\n\n    if over_num == 0:\n        test = match[:,[0,1,2,3,4]]\n    else:\n        test = match[:,[0,1,2,3,4, (2*(over_num-1))+5, (2*(over_num-1))+5+1]]\n\n    for perm in tqdm(range(100)):\n        clf2 = situational_model((over_num), seed = perm)\n        win_prob.append(clf2.predict_proba(test)[0][1])\n\n    win_prob = np.mean(np.asarray(win_prob))\n\n    if over_num == 0:\n        print('After 1st Innings')\n    else:\n        print ('After Over # %d'%over_num)\n\n    print ('Win Probablity for %s: %.2f'%(Team1,win_prob))\n    print ('Win Probablity for %s: %.2f'%(Team2,1-win_prob))\n\n    if over_num == 0:\n        print('Required Run Rate: %.2f, Wickets Remaining: %d'%(match[:,4]+0.05,10))\n        RRR.append(match[:,4]+0.05)\n        Wkts.append(np.array([10]))\n    else:\n        print ('Required Run Rate: %.2f, Wickets Remaining: %d'%((test[:,-2]),test[:,-1]))\n        RRR.append(test[:,-2])\n        Wkts.append(test[:,-1])\n    Team1_prob.append(win_prob)\n    Team2_prob.append(1-win_prob)","61eeff5a":"# Define colors for each team\n\nteams = ['KK', 'LQ', 'PZ', 'IU', 'QG', 'MS']\ncols = ['tab:blue', 'greenyellow', 'gold', 'tab:orange', 'tab:purple', 'tab:green']","28fab03b":"if len(overnum)> 1:\n    fig, (ax1,ax2) = plt.subplots(2,1,figsize=(15,12))\n    width = 0.5\n    ax1.bar(np.arange(len(overnum)), Team1_prob[0:len(overnum)], width, label=Team1,\n            color=cols[teams.index(Team1)])\n    ax1.bar(np.arange(len(overnum)), Team2_prob[0:len(overnum)], width, label=Team2,\n            bottom = Team1_prob[0:len(overnum)],color=cols[teams.index(Team2)])\n    ax1.set_ylabel('Win Probablity', fontsize=16, fontweight='bold')\n    ax1.set_xlabel('After Over #', fontsize=16, fontweight='bold')\n    ax1.set_title(str('%svs%s'%(Team1,Team2)), fontsize=16, fontweight='bold')\n    ax1.legend(fontsize=16)\n    ax1.set_xticks(np.arange(len(overnum)))\n    ax1.set_xticklabels(overnum)\n    ax1.tick_params(labelsize=16)\n\n    ax2.plot(np.arange(len(overnum)),RRR[0:len(overnum)], 'bP--', label='Required RR',linewidth=5.0, fillstyle='full', markersize=10)\n    ax2.set_xlabel('After Over #', fontsize=16, fontweight='bold')\n    ax3 = ax2.twinx()\n    ax3.bar(np.arange(len(overnum)),np.asarray(Wkts).flatten()[0:len(overnum)], width, label='Wkt Rem.', color='green', alpha=0.5)\n\n    ax2.set_xticks(np.arange(len(overnum)))\n    ax2.set_xticklabels(overnum)\n    ax2.tick_params(axis = 'y', labelsize=16, labelcolor='blue')\n    ax2.tick_params(axis = 'x', labelsize=16, labelcolor='black')\n    ax2.set_ylabel('Required RR', fontsize=16, fontweight='bold',color='blue')\n\n    ax3.tick_params(labelsize=16, labelcolor='green')\n    ax3.set_ylabel('Wickets Remaining', fontsize=16, fontweight='bold', color='green')\n\n    ax1.grid(linestyle='-.')\n    ax2.grid(linestyle='-.')\n    #plt.savefig('results\/%svs%s_overbyover.png'%(Team1,Team2))\n    plt.show()\nelse:\n    \n    plt.subplots(figsize=(10,8))\n    sizes = [np.mean(win_prob), 1-np.mean(win_prob)]\n    plt.pie(sizes, labels=[Team1, Team2], autopct='%1.1f%%', wedgeprops=dict(width=0.65),\n    colors = [cols[teams.index(Team1)], cols[teams.index(Team2)]], textprops={'fontsize': 14, 'fontweight': 'bold'},\n    shadow=True, startangle=90)\n\n    if overnum !=0:\n        plt.title('%s vs %s, Match # %d, Prediction After %d overs 2nd Innings'%(Team1,Team2,num+14,over_num), fontsize = 16, fontweight= 'bold')\n    else:\n        plt.title('%s vs %s, Match # %d, Prediction After 1st Innings'%(Team1,Team2,num+14), fontsize = 16, fontweight= 'bold')\n    #plt.savefig('results\/%svs%s_pie.png'%(Team1,Team2))\n    plt.show()","afdd4f64":"## Extract Training\/Validation data\n\n* **Extract the data for all the matches.** *(From PSL:S01 to PSL:S06[Up-to Match#14])*\n* **Matches with no-result or matches decided on D\/L method were discared.** *(5 Matches)*\n* **Tied matches are treated as 'win' for both teams.**\n* **Team batting first is referred to as Team1, and Team batting second is referred to as Team2**\n\n**Following features were extracted:**\n* Run-rate in powerplay for Team1 (*PP_rr*)\n* Wickets remaining after powerplay for Team1 (*PP_wkt_rem*)\n* Run-rate in overs 6-15 for Team1 (*mid_rr*)\n* Wickets remaining after overs 6-15 for Team1 (*mid_wkt_rem*)\n* Overall run-rate for Team1 after first innings (*RR*)\n* Match result w.r.t. Team1 (*Win*)\n* Required Run-rate after each over for Team2 (*rrr_T2*)\n* Wickets remaining after each over for Team2 (*T2_wkt_rem*)","20e438f5":"## Testing\n**Now we test the performance of our model on the current matches of PSL:S06.**\n\nI haven't written a script to extract these features for current matches. Right now I am maintaining it manually at:\n<https:\/\/github.com\/AmmarMalik93\/PSL-Prediction\/blob\/main\/new_matches.csv>\n\nSo for example we are interested in knowing the performance of our model on Match no. 6 (IU vs LQ) in the above file, and in particular we are interested in knowing the winning probablities after the end of 1st innings, 6 overs after the second innings, and 15 overs after the second innings. Then,","00250a0c":"**We train our model 100 times with variable seed and average their performance, in order to be sure that the probablities are not by chance and are consistent**","d3e9e3ff":"## Import Libraries","e2215aef":"# Predicting Pakistan Super League (PSL) Matches using Random Forest Classification","57cb2447":"## Plots\n\n**If a single over is provided then a pie-chart is displayed showing the winning probablities after that over for both teams**\n**If multiple overs are provided then a bar chart is displayed showing winning probablities after the end of each of those overs**"}}