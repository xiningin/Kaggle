{"cell_type":{"4ea141dd":"code","90384336":"code","27fa1451":"code","1c068e18":"code","c6934e36":"code","b7a39f90":"code","4c407e0c":"code","a621fd91":"code","aa0a0a81":"code","8d70326d":"code","32246f1d":"code","89625576":"code","57b2ded1":"code","95de6eab":"code","10232bca":"code","d0feda53":"markdown","b5f77730":"markdown","29a8edf3":"markdown","ddbfd868":"markdown","f0b90f35":"markdown","ab8dfb55":"markdown","20b7d5bd":"markdown","2df4b5b2":"markdown","998649bf":"markdown","f2306837":"markdown","b15a24ba":"markdown","3935a718":"markdown","98ea5748":"markdown","7dc09399":"markdown","ae32358d":"markdown"},"source":{"4ea141dd":"import pandas as pd\nimport numpy as np\nimport plotnine as pn\nfrom itertools import chain\nfrom matplotlib import pyplot as plt\ndata = pd.read_csv(\"..\/input\/athlete_events.csv\", index_col=0)\ndata.head(10)","90384336":"#weight medals\ndata.Medal[data.Medal.isna()] = 0\ndata.Medal[data.Medal == \"Gold\"] = 1\ndata.Medal[data.Medal == \"Silver\"] = 0.667\ndata.Medal[data.Medal == \"Bronze\"] = 0.333\n#To avoid confusions on countries (see row 4 Team\/NOC above), I have eleceted too use the NOC only for identify countries\n#groupby country and region\ndataClean = (data\n             .pipe(lambda df: df[df.Season == \"Summer\"])\n             .pipe(lambda df: df[df.Year >=1960])\n             #sum all medals won by each country each year\n             .groupby([\"NOC\", \"Year\"])\n             .Medal\n             .sum()\n             .reset_index()\n             .set_index([\"Year\", \"NOC\"])\n             .sort_index()\n            )\n\"\"\"\nThis is the most efficient way I could think of to retrieve the top 25 per year\nFor each year, it retrieves those not in the top 25 and drops them\n\"\"\"\nfor year in dataClean.index.levels[0]:\n    index = dataClean.loc[year, :].sort_values(\"Medal\", ascending=False).tail(-10).index\n    for row in index:\n        dataClean = dataClean.drop(index=(year, row))\n#Assign rank\nnewCol = list(chain.from_iterable([np.arange(10, 0, -1)] * int((len(dataClean.index) \/ 10))))\ndataClean = (dataClean\n             .reset_index()\n             .sort_values([\"Year\", \"Medal\"])\n             .assign(rank=newCol)\n            )\n#tidy index\ndataClean.index = range(150)\ndataClean.head(20)","27fa1451":"(pn.ggplot(dataClean)\n +pn.aes(x=\"Year\", y=\"rank\", color=\"NOC\")\n +pn.geom_line()\n)","1c068e18":"(pn.ggplot(dataClean)\n + pn.aes(x=\"Year\", y=\"rank\", color=\"NOC\")\n + pn.geom_line()\n + pn.geom_point()\n + pn.scale_x_continuous(limits=(1960, 2016),\n                         breaks=range(1960, 2017, 4),\n                         expand=(0,1)\n                        )\n + pn.scale_y_reverse(limits=(10, 1),\n                      breaks=range(10, 0, -1),\n                      expand=(0, 0.25)\n                     )\n + pn.labs(x=\"Olympic Year\", y=\"Medal Rank\")\n + pn.ggtitle(\"Ranking Countries by Total Olympic Medals\")\n + pn.theme(figure_size=(12, 6))\n)","c6934e36":"dataClean[dataClean.Year.isin([1960, 1964, 1968])]","b7a39f90":"\"\"\"\nThis almost certainly isnt the best way to do this, but it was the solution I arrived\nRemove first 10 rows.\nAdd rows for missing countries.\nAdd rows to bottom of original.\nrepeat 15 times as there are 15 olympics covered\n\"\"\"\nallNOC = list(dataClean.NOC.unique())\nfor i in range(15):\n    hold = np.split(dataClean, [10], axis=0)\n    for country in allNOC:\n        if country not in list(hold[0].NOC):\n            hold[0] = pd.concat([hold[0], pd.DataFrame(data={\"Year\": hold[0].iloc[0, 0],\n                                                             \"NOC\": country,\n                                                             \"Medal\": 0,\n                                                             \"rank\": 11\n                                                             }, \n                                                       index=range(1)\n                                                      )\n                                ])\n    dataClean = pd.concat([hold[1], hold[0]])\n\ndataClean = dataClean.sort_values([\"Year\", \"rank\"]).reset_index(drop=True)\ndataClean.head(52)\n    \n    ","4c407e0c":"(pn.ggplot(dataClean)\n + pn.aes(x=\"Year\", y=\"rank\", color=\"NOC\")\n + pn.geom_line()\n + pn.geom_point()\n + pn.scale_x_continuous(limits=(1960, 2016),\n                         breaks=range(1960, 2017, 4),\n                         expand=(0,1)\n                        )\n + pn.scale_y_reverse(limits=(10, 1),\n                      breaks=range(10, 0, -1),\n                      expand=(0, 0.25)\n                     )\n + pn.labs(x=\"Olympic Year\", y=\"Medal Rank\")\n + pn.ggtitle(\"Ranking Countries by Total Olympic Medals\")\n + pn.theme(figure_size=(12, 6))\n)","a621fd91":"(pn.ggplot(dataClean)\n + pn.aes(x=\"Year\", y=\"rank\", color=\"NOC\")\n + pn.geom_line(size=1)\n + pn.geom_point()\n + pn.scale_x_continuous(limits=(1960, 2016),\n                         breaks=range(1960, 2017, 4),\n                         expand=(0,1)\n                        )\n + pn.scale_y_reverse(limits=(11, 1),\n                      breaks=range(11, 0, -1),\n                      expand=(0, 0.25)\n                     )\n + pn.scale_color_hue(colorspace=\"husl\",\n                      h=.2,\n                      l=.6,\n                      s=1\n                     )\n + pn.labs(x=\"Olympic Year\", y=\"Medal Rank\", color=\"Country\")\n + pn.ggtitle(\"Ranking Countries by Total Olympic Medals\")\n + pn.theme(panel_background=pn.element_rect(fill=\"darkgray\"),\n            panel_grid=pn.element_line(color=\"white\",\n                                       size=0.25\n                                      ),\n            figure_size=(12, 6)\n           )\n)","aa0a0a81":"(pn.ggplot(dataClean)\n + pn.aes(x=\"Year\", y=\"rank\", color=\"NOC\", label=\"NOC\")\n + pn.geom_line(size=1)\n + pn.geom_point()\n + pn.geom_text(nudge_y=0.25)\n + pn.scale_x_continuous(limits=(1960, 2016),\n                         breaks=range(1960, 2017, 4),\n                         expand=(0, 2)\n                        )\n + pn.scale_y_reverse(limits=(10, 0.5),\n                      breaks=range(10, 0, -1),\n                      expand=(0, 0.25)\n                     )\n + pn.scale_color_hue(colorspace=\"husl\",\n                      h=.2,\n                      l=.6,\n                      s=1\n                     )\n + pn.labs(x=\"Olympic Year\", y=\"Medal Rank\", color=\"Country\")\n + pn.ggtitle(\"Ranking Countries by Total Olympic Medals\")\n + pn.theme(panel_background=pn.element_rect(fill=\"darkgray\"),\n            panel_grid=pn.element_line(color=\"white\",\n                                       size=0.25\n                                      ),\n            figure_size=(12, 6)\n           )\n)","8d70326d":"\"\"\"\nI'm certain this could be done with some looped pandas commands to find all the endpoints\nBut I couldn't figure it out, so I manually selected\n\"\"\"\ndataCleanPoint = (dataClean\n .drop(range(10, 28, 1), axis=0)\n .drop(range(36, 56, 1), axis=0)\n .drop(range(62, 84, 1), axis=0)\n .drop(range(88, 106, 1), axis=0)\n .drop(range(114, 130, 1), axis=0)\n .drop(range(139, 156, 1), axis=0)\n .drop(range(166, 182, 1), axis=0)\n .drop(range(191, 208, 1), axis=0)\n .drop(range(218, 236, 1), axis=0)\n .drop(range(244, 266, 1), axis=0)\n .drop(range(270, 291, 1), axis=0)\n .drop(range(296, 317, 1), axis=0)\n .drop(range(322, 345, 1), axis=0)\n .drop(range(348, 364, 1), axis=0)\n .drop(range(374, 390, 1), axis=0)\n .drop([29, 30, 34, 108, 110, 111, 135, 158, 159, 164, 183, 189, 209, 213, 215, 237, 238, 240, 241, 267,  293, 318, 319],\n       axis=0\n      )\n)\ndataCleanPoint.head(26)","32246f1d":"(pn.ggplot(dataClean)\n + pn.aes(x=\"Year\", y=\"rank\", color=\"NOC\", label=\"NOC\")\n + pn.geom_line(size=1)\n + pn.geom_point()\n + pn.geom_text(data = dataCleanPoint,\n                nudge_y=0.25)\n + pn.scale_x_continuous(limits=(1960, 2016),\n                         breaks=range(1960, 2017, 4),\n                         expand=(0, 2)\n                        )\n + pn.scale_y_reverse(limits=(10, 0.5),\n                      breaks=range(10, 0, -1),\n                      expand=(0, 0.25)\n                     )\n + pn.scale_color_hue(colorspace=\"husl\",\n                      h=.2,\n                      l=.6,\n                      s=1\n                     )\n + pn.labs(x=\"Olympic Year\", y=\"Medal Rank\", color=\"Country\")\n + pn.ggtitle(\"Ranking Countries by Total Olympic Medals\")\n + pn.theme(panel_background=pn.element_rect(fill=\"darkgray\"),\n            panel_grid=pn.element_line(color=\"white\",\n                                       size=0.25\n                                      ),\n            figure_size=(12, 6)\n           )\n)","89625576":"(pn.ggplot(dataClean)\n + pn.aes(x=\"Year\", y=\"rank\", color=\"NOC\", label=\"NOC\")\n + pn.geom_line(size=1,\n                show_legend=False\n               )\n + pn.geom_point(show_legend=False)\n + pn.geom_label(data = dataCleanPoint,\n                 fill=\"darkgray\",\n                 size=8,\n                 show_legend=False\n                )\n + pn.scale_x_continuous(limits=(1960, 2016),\n                         breaks=range(1960, 2017, 4),\n                         expand=(0, 2)\n                        )\n + pn.scale_y_reverse(limits=(10, 1),\n                      breaks=range(10, 0, -1),\n                      expand=(0, 0.25),\n                     )\n + pn.scale_color_hue(colorspace=\"husl\",\n                      h=.2,\n                      l=.6,\n                      s=1\n                     )\n + pn.labs(x=\"Olympic Year\", y=\"Medal Rank\", color=\"Country\")\n + pn.ggtitle(\"Ranking Countries by Total Olympic Medals\")\n + pn.theme(panel_background=pn.element_rect(fill=\"darkgray\"),\n            panel_grid=pn.element_line(color=\"white\",\n                                       size=0.25\n                                      ),\n            figure_size=(12, 6)\n           )\n)","57b2ded1":"(pn.ggplot(dataClean)\n + pn.aes(x=\"Year\", y=\"rank\", color=\"NOC\", label=\"NOC\")\n + pn.geom_line(size=1,\n                show_legend=False\n               )\n + pn.geom_point(show_legend=False)\n + pn.geom_label(data = dataCleanPoint,\n                 fill=\"darkgray\",\n                 size=8,\n                 show_legend=False\n                )\n + pn.scale_x_continuous(limits=(1960, 2016),\n                         breaks=range(1960, 2017, 4),\n                         expand=(0, 2)\n                        )\n + pn.scale_y_reverse(limits=(10, 1),\n                      breaks=range(10, 0, -1),\n                      expand=(0, 0.25),\n                      sec.axis=pn.dup_axis() # this would add second axis\n                     )\n + pn.scale_color_hue(colorspace=\"husl\",\n                      h=.2,\n                      l=.6,\n                      s=1\n                     )\n + pn.labs(x=\"Olympic Year\", y=\"Medal Rank\", color=\"Country\")\n + pn.ggtitle(\"Ranking Countries by Total Olympic Medals\")\n + pn.theme(panel_background=pn.element_rect(fill=\"darkgray\"),\n            panel_grid=pn.element_line(color=\"white\",\n                                       size=0.25\n                                      ),\n            figure_size=(12, 6)\n           )\n)","95de6eab":"(pn.ggplot(dataClean)\n + pn.aes(x=\"Year\", y=\"rank\", color=\"NOC\", label=\"NOC\")\n + pn.geom_line(size=1,\n                show_legend=False\n               )\n + pn.geom_point(show_legend=False)\n + pn.geom_label(data = dataCleanPoint,\n                 fill=\"#848482\",\n                 size=9,\n                 label_size=0,\n                 label_padding=0.1,\n                 show_legend=False\n                )\n + pn.scale_x_continuous(limits=(1960, 2016),\n                         breaks=range(1960, 2017, 4),\n                         expand=(0, 2),\n                         minor_breaks=[]\n                        )\n + pn.scale_y_reverse(limits=(10, 1),\n                      breaks=range(10, 0, -1),\n                      expand=(0, 0.25),\n                      minor_breaks=[]\n                     )\n + pn.scale_color_hue(colorspace=\"husl\",\n                      h=.2,\n                      l=.6,\n                      s=1\n                     )\n + pn.labs(x=\"Olympic Year\", y=\"Medal Rank\", color=\"Country\")\n + pn.ggtitle(\"Ranking Countries by Total Olympic Medals\")\n + pn.theme(panel_background=pn.element_rect(fill=\"#848482\"),\n            panel_grid=pn.element_line(color=\"#E5E4E2\",\n                                       size=0.25\n                                      ),\n            figure_size=(12, 6),\n            plot_background=pn.element_rect(fill=\"#E5E4E2\"),\n            text=pn.element_text(color=\"#0C090A\"),\n            axis_text=pn.element_text(style=\"oblique\",\n                                      size=9\n                                     ),\n            axis_title=pn.element_text(style=\"oblique\",\n                                      size=12\n                                     ),\n            plot_title=pn.element_text(size=16\n                                      ),\n            axis_ticks=pn.element_line(color=\"#848482\"),\n            dpi=300\n           )\n)","10232bca":"(pn.ggplot(dataClean)\n + pn.aes(x=\"Year\", y=\"rank\", color=\"NOC\", label=\"NOC\")\n + pn.geom_line(size=1,\n                show_legend=False\n               )\n + pn.geom_point(show_legend=False)\n + pn.geom_label(data = dataCleanPoint,\n                 fill=\"#848482\",\n                 size=9,\n                 label_size=0,\n                 label_padding=0.1,\n                 show_legend=False\n                )\n + pn.scale_x_continuous(limits=(1960, 2016),\n                         breaks=range(1960, 2017, 4),\n                         expand=(0, 2),\n                         minor_breaks=[]\n                        )\n + pn.scale_y_reverse(limits=(10, 1),\n                      breaks=range(10, 0, -1),\n                      expand=(0, 0.25),\n                      minor_breaks=[]\n                     )\n + pn.scale_color_hue(colorspace=\"husl\",\n                      h=.2,\n                      l=.6,\n                      s=1\n                     )\n + pn.labs(x=\"Olympic Year\", y=\"Medal Rank\", color=\"Country\")\n + pn.ggtitle(\"Ranking Countries by Total Olympic Medals\")\n + pn.theme(panel_background=pn.element_rect(fill=\"#848482\"),\n            panel_grid=pn.element_line(color=\"#E5E4E2\",\n                                       size=0.25\n                                      ),\n            figure_size=(12, 6),\n            plot_background=pn.element_rect(fill=\"#E5E4E2\"),\n            text=pn.element_text(color=\"#0C090A\"),\n            axis_text=pn.element_text(style=\"oblique\",\n                                      size=9\n                                     ),\n            axis_title=pn.element_text(style=\"oblique\",\n                                      size=12\n                                     ),\n            plot_title=pn.element_text(size=16\n                                      ),\n            axis_ticks=pn.element_line(color=\"#848482\"),\n            dpi=300\n           )\n).save(filename=\"OlympicMedals.png\", verbose=True)","d0feda53":"Clean data is always easier to work from! Now, we have a weighted sum of medals and a rank for the top 25 countries per year. I think the best way to track this likely going to be a line plot.","b5f77730":"As I've said before, the power of a grammar of graphics system is the ease from which you can create beautifully complex graphs with rather straightforward, intuitive code. In this section, I'm going to examine the Olympic History data set to see how far I can push the abilities of Plotnine.","29a8edf3":"A bit of both it seems! Yugoslavia was 8th in 1960, didn't rank in 1964, and was 8th in 1968, so the graph filled in the line between those data points. One option woud be to use `pn.geom_seqment` to specify every point, but that is far too wieldy. I think it would be better to go back to the data and add blanks from year to year.\n","ddbfd868":"That's already much better! But now an interesting problems is visible...Note that in 1964, two countries seem to have rank 8! Is that an issue with the data or the graph?","f0b90f35":"Hit and miss. By altering the colors slightly and moving onto a dark background with white grid lines, the colors can be made much more distinguishable. But actually including all of the lines makes the plot even more unreadable. Besides, given we are only interested in the top 10, 11 doesn't really work. Let's try adding some labels instead...","ab8dfb55":"That's all for now folks. As `plotnine` expands its features, and I get better at coding, there must some revisions or new sections. In any case, I hope you all found this as helpful as I did!","20b7d5bd":"Welcome to what is currently the last section of tutorials\/notebooks on `Plotnine`, the Python port of R's `ggplot2`.\n\nFor more information on `Plotnine`, visit the API at https:\/\/plotnine.readthedocs.io\/en\/stable\/api.html.\n\nSince it is (essentially) a direct port of `ggplot2`, their API can also be very useful. It's at https:\/\/ggplot2.tidyverse.org\/reference\/.","2df4b5b2":"Well it's a start! Let's start by cleaning up the graph itself.","998649bf":"A bit better, though too crowded. I think we need to reduce the labels to single points and end points only. Probably most easily achieved by selecting data and using multiple layers.","f2306837":"Have to love that tug-of-war used to be an Olympic sport!\n\nI would like to create a graph that tracks the top 10 countries by total medals at each olympics since 1960, similar to this one (http:\/\/vis.berkeley.edu\/courses\/cs294-10-fa07\/wiki\/images\/4\/45\/RowingbumpsSmall.jpg) that tracks the position of the college rowing clubs at Oxford.","b15a24ba":"That's better! Now there's one point at each rank per year. But now lines that have values at 0 aren't shown. Also, the default color scale doesn't differentiate between colors enough, I think. Let's fix these...","3935a718":"We're getting there! Now that we have labels, we can hide the legend to reduce cluster. Also, bumping the text up doesn't seem to be the best option (it clashes with the lines). And I'd prefer the y-scale to be on both sides. Lets try something else.","98ea5748":"Better! The `pn.geom_label()` adds the text in a little box. Thus, the box overlaps any lines prevents the text from being obscured. Frustratingly, there doesn't yet seem seem to be a good way to add a secondary y-axis with in `plotnine`. In ggplot2, it would look something like...","7dc09399":"Unfortunately, this produces an error. Reading the `plotnine` documentation, a `dup_axis()` function has not been implemented, and none of the y-axis scale funtions take a secondary axis command! At this point, that just leaves a few themables to tidy up - like text font and plot backgrounds and minor gridlines.","ae32358d":"The last feature I want to invoke is `pn.ggplot().save()` which lets us save figures!"}}