{"cell_type":{"6e167a18":"code","610e5bb8":"code","31045f92":"code","110ac818":"code","0935af11":"code","ad099f36":"code","ea23239d":"code","96b91019":"code","9224c5c3":"code","7bc01f7e":"code","655f5c37":"code","14dc586c":"code","55db03af":"code","6b125672":"code","aca86cec":"code","480ce9a0":"code","56ec3567":"code","f23bdd18":"code","75870f47":"code","4e17bb5f":"code","448932c8":"code","e703c5e7":"markdown","28c4938f":"markdown","dc1a90f0":"markdown","a118c674":"markdown","51428337":"markdown","24d7a6ac":"markdown","1f0e05db":"markdown","1c835929":"markdown","e425f66b":"markdown","cb96242d":"markdown","6ef02780":"markdown","5f8934a9":"markdown","b639d91e":"markdown"},"source":{"6e167a18":"import tensorflow\nimport random\nrandom.seed(0)\nimport warnings\nwarnings.filterwarnings('ignore')\ntensorflow.__version__","610e5bb8":"project_path = '..\/input\/racoon-detection'\ndata_path = project_path + '\/Racoon Images\/images'\ntrain_csv_path = project_path + '\/train_labels_.csv'","31045f92":"IMAGE_SIZE=128","110ac818":"import csv\nimport numpy as np","0935af11":"IMAGE_SIZE=128\n\nnormalize = lambda coordinate, value: (coordinate * IMAGE_SIZE)\/value \n\nwith open (train_csv_path, 'r') as csvfile:\n  y_train = np.zeros((sum(1 for line in csvfile)-1,4))\n  X_train=[]\n  csvfile.seek(0)\n  data = csv.reader(csvfile, delimiter=',')\n  next(data)\n\n# int(data[1]) for row in data\n  for index, row in enumerate(data):\n    for i, r in enumerate(row[x] for x in [1,2,4,5,6,7]):\n      row[i+1] = int(r)\n# read the required values\n    path, image_width, image_height, x0, y0, x1, y1,_ = row\n    path = data_path + '\/' + path\n\n    y_train[index, 0] = normalize(x0, image_width)\n    y_train[index, 1] = normalize(y0, image_height)\n    y_train[index, 2] = normalize((x1-x0), image_width)\n    y_train[index, 3] = normalize((y1-y0), image_height)\n\n    X_train.append(path)\n","ad099f36":"X_train[0:5]","ea23239d":"y_train[0:5]","96b91019":"# resize the image to 128*128\nimport cv2\n\n#pick up a random image\nfilename = X_train[1]\nunscaled = cv2.imread(filename)\nregion = y_train[1]\n\nimage_height, image_width, _ = unscaled.shape\n\nx0= int(region[0] * image_width \/ IMAGE_SIZE)\ny0= int(region[1] * image_height \/ IMAGE_SIZE)\n\nx1= int((region[0] + region[2])* image_width \/ IMAGE_SIZE)\ny1= int((region[1] + region[3])* image_height \/ IMAGE_SIZE)","9224c5c3":"import matplotlib.pyplot as plt\nimport matplotlib.patches as patches\n\nfig, axis = plt.subplots(1)\naxis.imshow(unscaled)\n\nrect = patches.Rectangle((x0, y0), x1-x0, y1-y0, linewidth=2, edgecolor='r', facecolor='none')\n\naxis.add_patch(rect)\n\nplt.show()","7bc01f7e":"from PIL import Image\nfrom tensorflow.keras.applications.mobilenet import preprocess_input\n\nfor i, f in enumerate(X_train):\n  img = Image.open(f)\n  img = img.resize((IMAGE_SIZE, IMAGE_SIZE))\n  img = img.convert('RGB')\n\n  X_train[i] = preprocess_input(np.array(img, dtype=np.float32))\n  img.close()","655f5c37":"X_train = np.array(X_train)\nX_train.shape","14dc586c":"y_train.shape","55db03af":"from tensorflow.keras.applications.mobilenet import MobileNet\nfrom tensorflow.keras.models import Model\nfrom tensorflow.keras.layers import Conv2D, Reshape\n\nALPHA=1\n\ndef create_model(trainable=True):\n  model = MobileNet(input_shape=(IMAGE_SIZE,IMAGE_SIZE,3), include_top=False, alpha=ALPHA)\n\n  # freez the layers which we have till now from training\n  for layer in model.layers:\n    layer.trainable = trainable\n\n  x0 = model.layers[-1].output\n  x1 = Conv2D(4, kernel_size=4, name='coords')(x0)\n\n  x2 = Reshape((4,))(x1)\n\n  return Model(inputs = model.input, outputs=x2)\n","6b125672":"from tensorflow.keras.backend import epsilon\ndef loss(gt,pred):\n    intersections = 0\n    unions = 0\n    diff_width = np.minimum(gt[:,0] + gt[:,2], pred[:,0] + pred[:,2]) - np.maximum(gt[:,0], pred[:,0])\n    diff_height = np.minimum(gt[:,1] + gt[:,3], pred[:,1] + pred[:,3]) - np.maximum(gt[:,1], pred[:,1])\n    intersection = diff_width * diff_height\n    \n    # Compute union\n    area_gt = gt[:,2] * gt[:,3]\n    area_pred = pred[:,2] * pred[:,3]\n    union = area_gt + area_pred - intersection\n\n#     Compute intersection and union over multiple boxes\n    for j, _ in enumerate(union):\n        if union[j] > 0 and intersection[j] > 0 and union[j] >= intersection[j]:\n            intersections += intersection[j]\n            unions += union[j]\n\n    # Compute IOU. Use epsilon to prevent division by zero\n    iou = np.round(intersections \/ (unions + epsilon()), 4)\n    iou = iou.astype(np.float32)\n    return iou\n\ndef IoU(y_true, y_pred):\n    iou = tensorflow.py_function(loss, [y_true, y_pred], tensorflow.float32)\n    return iou","aca86cec":"model = create_model(False)\nmodel.summary()","480ce9a0":"model.compile(loss='mean_squared_error', optimizer='adam', metrics=[IoU])","56ec3567":"from tensorflow.keras.callbacks import EarlyStopping\n\nearlyS = EarlyStopping(monitor='IoU', patience=5, min_delta=0.01)\n\nmodel.fit(X_train, y_train, epochs=50, batch_size=32, callbacks=[])","f23bdd18":"filepath = data_path + '\/raccoon-62.jpg'\nunscaled = cv2.imread(filepath)\nimage_height, image_width, _ = unscaled.shape\nunscaled.shape\n","75870f47":"img = cv2.resize(unscaled, (IMAGE_SIZE,IMAGE_SIZE))\nfeat_scaled = preprocess_input(np.array(img, dtype=np.float32))\nprint(f'Before preporcessing image size was {unscaled.shape}')\nprint(f'After preprocess image size is {feat_scaled.shape}')","4e17bb5f":"region = model.predict(np.array([feat_scaled]))[0]","448932c8":"x0 = int(region[0] * image_width \/ IMAGE_SIZE) # Scale the BBox\ny0 = int(region[1] * image_height \/ IMAGE_SIZE)\n\nx1 = int((region[2]) * image_width \/ IMAGE_SIZE)\ny1 = int((region[3]) * image_height \/ IMAGE_SIZE)\n\n\nimport matplotlib.pyplot as plt\nimport matplotlib.patches as patches\nfrom PIL import Image\nimport numpy as np\n\n\n# Create figure and axes\nfig,ax = plt.subplots(1)\n\n# Display the image\nax.imshow(unscaled)\n\n# Create a Rectangle patch\nrect = patches.Rectangle((x0, y0), (x1 - x0) , (y1 - y0) , linewidth=2, edgecolor='r', facecolor='none')\n\n# Add the patch to the Axes\nax.add_patch(rect)\n\nplt.show()","e703c5e7":"### With the help of csv.reader write a for loop which can load the train.csv file and store the path, width, height, x0,y0,x1,y1 in induvidual variables. <br>\n1. Create a list variable known as 'path' which has all the path for all the training images\n2. Create an array 'coords' which has the resized coordinates of the bounding box for the training images\n\n<u>Note:<\/u> All the training images should be downsampled to 128 * 128 as it is the input shape of MobileNet (which we will be using for Object detection). Hence the corresponding coordinates of the bounding boxes should be changed to match the image dimension of 128 * 128 ","28c4938f":"### Print the shape of the train dataset","dc1a90f0":"### Load the training data from train.csv file","a118c674":"### Write a for loop which can load all the training images into a variable 'batch_images' using the paths from the 'paths' variable\n<u>Note:<\/u> Convert the image to RGB scale as the MobileNet accepts 3 channels as inputs   ","51428337":"### Resize the image to 128 * 128 and preprocess the image for the MobileNet model","24d7a6ac":"### Declare a variable IMAGE_SIZE = 128 as we will be using MobileNet which will be taking Input shape as 128 * 128 ","1f0e05db":"### Predict the coordinates of the bounding box for the given test image","1c835929":"### Plot the test image using .imshow and draw a boundary box around the image with the coordinates obtained from the model","e425f66b":"# Bounding box detection - Racoon data\n\n\n## Data files\n- images: images of racoons\n- train_labels.cv: contains coordinates for bounding box for every image","cb96242d":"### Write model.compile function & model.fit function with: <br>\n1. Optimizer = Adam, Loss = 'mse' and metrics = IoU\n2. Epochs = 30, batch_size = 32, verbose = 1","6ef02780":"### Import MobileNet and load MobileNet into a variable named 'model' which takes input shape of 128 * 128 * 3. Freeze all the layers. Add convolution and reshape layers at the end to ensure the output is 4 coordinates","5f8934a9":"### Define a custom loss function IoU which calculates Intersection Over Union","b639d91e":"### Pick a test image from the given data"}}