{"cell_type":{"d1691cac":"code","ca01ee9f":"code","cd16b3f3":"code","3236d632":"code","f593c583":"code","84a6f89e":"code","99c31ce5":"code","5de41388":"code","6ffc744b":"code","cd005de4":"code","0ad1edc3":"code","e1a6601d":"code","80cceca5":"code","dcd98906":"code","813a3ae9":"code","5af055eb":"code","ce081e33":"code","e4d45bea":"code","133b2c27":"code","a2848b4e":"code","152aa125":"code","a221a74c":"code","5418bd94":"code","04efbbff":"code","13261111":"code","c23d277a":"code","c4be8a1f":"code","3cd4abd8":"code","59648b90":"markdown","f7f5c6d4":"markdown","1299cb24":"markdown","0e434b06":"markdown","0f7fa9fc":"markdown","541f20fd":"markdown","b1b4bef4":"markdown","f6017649":"markdown"},"source":{"d1691cac":"import numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\nimport os\n\nimport matplotlib.pyplot as plt\n%matplotlib inline\nimport seaborn as sns\nprint(os.listdir(\"..\/input\"))","ca01ee9f":"train_df = pd.read_csv('..\/input\/train.csv')\ntest_df = pd.read_csv('..\/input\/test.csv')\n\nprint('Train dataset size:', train_df.shape)\nprint('Test dataset size:', test_df.shape)","cd16b3f3":"train_df.head(10)","3236d632":"f_cols = [f'var_{i}' for i in range(200)]","f593c583":"f, ax = plt.subplots(nrows=4, ncols=4, figsize=(16, 16))\nax = ax.flatten()\n\nfor i in range(len(ax)):\n    col1 = train_df[f_cols[i]].values\n    col2 = test_df[f_cols[i]].values\n    \n    ax[i].hist(col1, bins=100)\n    ax[i].hist(col2, bins=100, alpha=0.5)\n    ax[i].set_title(f_cols[i])","84a6f89e":"feature_means = np.mean(train_df[f_cols].values, axis=0)\nplt.hist(feature_means, bins=10)\n_ = plt.title('feature mean values')","99c31ce5":"train_features = train_df[f_cols]\ncorr_matrix = train_features.corr()\nplt.subplots(figsize=(20, 10))\n_ = sns.heatmap(corr_matrix, vmax=1, square=True)\n_ = plt.title('Correlation matrix')","5de41388":"from sklearn.model_selection import train_test_split\n\nX = train_df[f_cols].values\nY = train_df['target'].values\n\ntrain_X, val_X, train_Y, val_Y = train_test_split(X, Y, test_size=0.2, random_state=42, stratify=Y)","6ffc744b":"from catboost import CatBoostClassifier\n\ndef getModel():\n    model = CatBoostClassifier(\n        task_type='GPU',\n        iterations=20000,\n        learning_rate=0.05,\n        l2_leaf_reg=3147,\n        depth=2,\n        use_best_model=True,\n        early_stopping_rounds=200,\n        eval_metric='AUC',\n    )\n    return model","cd005de4":"model = getModel()\nmodel.fit(train_X, train_Y,\n          eval_set=(val_X, val_Y),\n          verbose=False)\n","0ad1edc3":"from sklearn.metrics import roc_auc_score\n\np = model.predict_proba(val_X)[:, 1]\nprint('validation ROC AUC:', roc_auc_score(val_Y, p))","e1a6601d":"test_p = model.predict_proba(test_df[f_cols].values)[:, 1]\npd.DataFrame({'ID_code': test_df['ID_code'], 'target': test_p}).to_csv('catboost_naive_submission.csv', index=False)","80cceca5":"from IPython.display import FileLink\nFileLink('catboost_naive_submission.csv')","dcd98906":"def shuffleDataInCols(data):\n    for i in range(data.shape[1]):\n        col = data[:, i].copy()\n        np.random.shuffle(col)\n        data[:, i] = col\n    return data\n\nmask_zero = val_Y == 0\nmask_one = val_Y == 0\n\nval_X_shuffled = val_X.copy()\nval_X_shuffled[mask_zero] = shuffleDataInCols(val_X_shuffled[mask_zero])\nval_X_shuffled[mask_one] = shuffleDataInCols(val_X_shuffled[mask_one])\n\np_shuffled = model.predict_proba(val_X_shuffled)[:, 1]\nprint('validation ROC AUC on a shuffled data:', roc_auc_score(val_Y, p_shuffled))","813a3ae9":"def getCountEncoding(X):\n    hist_df = pd.DataFrame()\n    \n    for var in f_cols:\n        var_stats = X[var].value_counts()\n        hist_df[var] = pd.Series(X[var]).map(var_stats)\n    return hist_df\n        ","5af055eb":"train_ce = getCountEncoding(train_df)\ntest_ce = getCountEncoding(test_df)\ntrain_ce.head(10)","ce081e33":"X = np.concatenate([train_df[f_cols].values, train_ce[f_cols].values], axis=1)\nY = train_df['target'].values\nprint(X.shape)\n\ntrain_X, val_X, train_Y, val_Y = train_test_split(X, Y, test_size=0.2, random_state=42, stratify=Y)","e4d45bea":"model = getModel()\nmodel.fit(train_X, train_Y,\n          eval_set=(val_X, val_Y),\n          verbose=False)","133b2c27":"p = model.predict_proba(val_X)[:, 1]\nprint('validation ROC AUC:', roc_auc_score(val_Y, p))","a2848b4e":"test_X = np.concatenate([test_df[f_cols].values, test_ce[f_cols].values], axis=1)\ntest_p = model.predict_proba(test_X)[:, 1]\npd.DataFrame({'ID_code': test_df['ID_code'], 'target': test_p}).to_csv('catboost_count_encoding_submission.csv', index=False)\n\nfrom IPython.display import FileLink\nFileLink('catboost_count_encoding_submission.csv')","152aa125":"train_unique_cnt = np.sum(train_ce.values==1, axis=1)\ntest_unique_cnt = np.sum(test_ce.values==1, axis=1)\n\nf, ax = plt.subplots(nrows=1, ncols=2, figsize=(16,10))\n_ = ax[0].hist(train_unique_cnt, bins=100)\n_ = ax[1].hist(test_unique_cnt, bins=100)","a221a74c":"mask_real = test_unique_cnt > 0\nmask_fake = test_unique_cnt == 0\n\nprint('Real samples:', np.sum(mask_real))\nprint('Fake samples:', np.sum(mask_fake))","5418bd94":"test_real_df = test_df[mask_real]\ntrain_test_features = pd.concat([train_df[f_cols], test_real_df[f_cols]], axis=0, ignore_index=True)\n\ntrain_test_ce = getCountEncoding(train_test_features)\nprint(train_test_features.shape)","04efbbff":"uniques_train_test = np.sum(train_test_ce.values==1, axis=1)\n_ = plt.hist(uniques_train_test, bins=100)","13261111":"X = np.concatenate([train_df[f_cols].values, train_test_ce[f_cols].values[0:train_df.shape[0]]], axis=1)\nY = train_df['target'].values\nprint(X.shape)\n\ntrain_X, val_X, train_Y, val_Y = train_test_split(X, Y, test_size=0.2, random_state=42, stratify=Y)","c23d277a":"model = getModel()\nmodel.fit(train_X, train_Y,\n          eval_set=(val_X, val_Y),\n          verbose=False)","c4be8a1f":"p = model.predict_proba(val_X)[:, 1]\nprint('validation ROC AUC:', roc_auc_score(val_Y, p))","3cd4abd8":"real_X = np.concatenate([test_real_df[f_cols].values, train_test_ce[f_cols].values[train_df.shape[0]:, :] ], axis=1)\ntest_p = model.predict_proba(real_X)[:, 1]\n\nres = np.zeros(test_df.shape[0], dtype=np.float32)\nres[mask_real] = test_p\npd.DataFrame({'ID_code': test_df['ID_code'], 'target': res}).to_csv('catboost_count_encoding_with_real_test_submission.csv', index=False)\n\nfrom IPython.display import FileLink\nFileLink('catboost_count_encoding_with_real_test_submission.csv')","59648b90":"**Count encoding**","f7f5c6d4":"**Real\/fake test subsets**","1299cb24":"Public Leaderboard score: 0.898","0e434b06":"![](https:\/\/i.ibb.co\/GcvsBHF\/santander-meme.png)","0f7fa9fc":"Feature shuffling","541f20fd":"Combine train and real test dataset","b1b4bef4":"Public Leaderboard score: 0.898","f6017649":"Public Leaderboard score: 0.913"}}