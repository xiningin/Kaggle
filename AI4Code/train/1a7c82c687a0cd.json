{"cell_type":{"02e855e2":"code","0076bfb6":"code","91b9ef9f":"code","3df39a36":"code","5de505ba":"code","e0c19b1c":"code","6f26f07e":"code","2709eebf":"code","c25f2a9a":"code","33a5a650":"code","978f912f":"markdown","ba114a61":"markdown","a9d36c19":"markdown","d0c3469c":"markdown","5e35d20e":"markdown","cc495cc6":"markdown","5ed9c789":"markdown","2454b01d":"markdown","e3d195a5":"markdown","800e07c1":"markdown"},"source":{"02e855e2":"!mkdir .\/src\/\n!curl --proto '=https' --tlsv1.2 -sSf https:\/\/sh.rustup.rs > rustup.sh\n!bash .\/rustup.sh -y","0076bfb6":"%%writefile Cargo.toml\n[package]\nname    = \"hungry-geese-rust-west\"\nversion = \"0.1.0\"\nauthors = [ \"JamesMcGuigan <james.mcguigan@gmail.com>\" ]\nedition = \"2018\"\n\n[lib]\nname = \"hungry_geese_rust_west\"\ncrate-type = [\"dylib\"]","91b9ef9f":"%%writefile src\/lib.rs\n\/\/ DOCS: https:\/\/bheisler.github.io\/post\/calling-rust-in-python\/\n\n#[no_mangle]\npub extern \"C\" fn go_west() -> i32 {\n    return 3; \/\/ NORTH, EAST, SOUTH, WEST\n}","3df39a36":"!source ~\/.cargo\/env; cargo build\n!cp .\/target\/debug\/*.so .\/\n!rm -rf .\/target ","5de505ba":"!find .\/","e0c19b1c":"%%writefile main.py\n# DOCS: https:\/\/bheisler.github.io\/post\/calling-rust-in-python\/\n\n# BUGFIX: Kaggle Submission Environment os.getcwd() == \"\/kaggle\/working\/\"\n# https:\/\/www.kaggle.com\/c\/rock-paper-scissors\/discussion\/216159\nimport os\nimport glob\nif \"simulations\" in os.environ.get('KAGGLE_DOCKER_IMAGE', ''):\n    os.chdir('\/kaggle_simulations\/agent\/')\n    print(\"os.getcwd() \", os.getcwd())\n    print(\"glob.glob(*)\", glob.glob(\"*\"))\n    print(\"os.environ  \", os.environ)\n    \n\nfrom cffi import FFI\nffi = FFI()\nffi.cdef(\"\"\"\n    int go_west();\n\"\"\")\nrust = ffi.dlopen(\".\/libhungry_geese_rust_west.so\")\n\n\n\nfrom kaggle_environments.envs.hungry_geese.hungry_geese import Observation, Configuration, Action, row_col\n\n# obs  {'remainingOverageTime': 60, 'index': 1, 'step': 30, 'geese': [[56], [68], [51, 52], [54]], 'food': [8, 15]}\n# conf {'episodeSteps': 200, 'actTimeout': 1, 'runTimeout': 1200, 'columns': 11, 'rows': 7, 'hunger_rate': 40, 'min_food': 2, 'max_length': 99}\ndef go_west_go_agent(obs, conf):\n    # if obs.step >= conf.hunger_rate-2: raise Exception(\"Don't submit to competition\")\n    action = rust.go_west();\n    return list(Action)[action].name","6f26f07e":"%run main.py","2709eebf":"from kaggle_environments import evaluate, make, utils\n\nenv = make(\"hungry_geese\", debug=True)\nenv.run([\n    \"main.py\", \n    \"main.py\", \n    \"main.py\", \n    \"main.py\"\n])\nenv.render(mode=\"ipython\", width=500, height=450)","c25f2a9a":"!GZIP=-9 tar cfz submission.tar.gz *.py *.so","33a5a650":"!mkdir test\n!cd test; tar xvf ..\/submission.tar.gz; python3 main.py\n!rm -rf test","978f912f":"# Kaggle Simulations Environment\n\nEverything seems to work in the local notebook","ba114a61":"Test the python file compiles","a9d36c19":"# Install Rust\n\nWe use the rustup script, and also create the directory structure that Cargo expects","d0c3469c":"# Python Code\n\nHere we need to statically define out functional imports, and find the correct path for the compiled binary.\n\nThe python file itself also needs to be called `main.py`","5e35d20e":"# Cargo File","cc495cc6":"# Hungry Geese - Rust CFFI\n\nThis is an attempt to port my [Hungry Geese Go West!](https:\/\/www.kaggle.com\/jamesmcguigan\/hungry-geese-go-west) notebook to Rust using CFFI bindings.\n\nThis is inspired by this tutorial: https:\/\/bheisler.github.io\/post\/calling-rust-in-python\/","5ed9c789":"# Compiling Rust\n\nKaggle Simulations have an issue with multi-directory submission files. So everything required to run should be copied to the root directory.\n- https:\/\/www.kaggle.com\/c\/rock-paper-scissors\/discussion\/216159","2454b01d":"Quick test to ensure we have all the correct files","e3d195a5":"# Rust Code\n\nIt is tricky to return variable length strings from Rust.\n- return `String` type is not supported by FFI\n- return `str` type complains that the string is variable length\n- we can work around this by simply returning a number, and converting to a string in python","800e07c1":"# Submission\n\nMulti-file submissions are a new Kaggle feature since Halite.\n> Today we released support for multi-file agents. To upload an agent with multiple files, submit your work as a .tar.gz archive (the name must end in .tar.gz) with a python file at the top level called main.py that conforms to the normal agent submission requirements. The maximum upload size of 100MB applies to the full archive. For the initial release of this feature we only compile the main.py file so to import other python files you'll either have to compile\/exec or importlib the relevant files. We're hoping to improve this in a future release and will update this topic as appropriate.\n> - https:\/\/www.kaggle.com\/c\/halite\/discussion\/177686\n\nFIXED: This seems to be working now in the Kaggle Submissions Environment!"}}