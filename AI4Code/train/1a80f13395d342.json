{"cell_type":{"da963ec9":"code","ac1421b1":"code","17088132":"code","256fa0b5":"code","31bcec60":"code","6e6290dc":"code","c6bfe11d":"code","30160904":"code","36e36313":"code","1fb64a44":"code","82400db2":"code","c47b989b":"code","3bafa9e1":"code","0c5e455d":"code","c2aee073":"code","ee40a846":"code","fda1853f":"code","6ad99be3":"code","8854b875":"code","4d8305c6":"code","24e3b0d0":"code","acb182fb":"code","61c829a8":"markdown","13a3be85":"markdown","c181869f":"markdown","d162ca7c":"markdown","1d06dd8b":"markdown","2326f2c3":"markdown","94fe737d":"markdown"},"source":{"da963ec9":"import numpy as np\nimport pandas as pd\npd.set_option(\"display.max_columns\", 100)","ac1421b1":"test = pd.read_csv(\"..\/input\/ncaam-march-mania-2021\/MSampleSubmissionStage1.csv\")\n\ntest[\"Season\"] = test[\"ID\"].apply(lambda x: int(x.split(\"_\")[0]))\ntest[\"TeamA\"] = test[\"ID\"].apply(lambda x: int(x.split(\"_\")[1]))\ntest[\"TeamB\"] = test[\"ID\"].apply(lambda x: int(x.split(\"_\")[2]))\n\nprint(test.shape)\ntest.head()","17088132":"tourney = pd.read_csv(\"..\/input\/ncaam-march-mania-2021\/MNCAATourneyCompactResults.csv\")\nprint(tourney.shape)\ntourney.head()","256fa0b5":"tourney.tail()","31bcec60":"def create_all_df(df):\n    win_df = df.rename(columns = {\n        \"WTeamID\" : \"TeamA\",\n        \"WScore\" : \"ScoreA\",\n        \"LTeamID\" : \"TeamB\",\n        \"LScore\" : \"ScoreB\"\n    }).copy()\n\n    lose_df = df.rename(columns = {\n        \"WTeamID\" : \"TeamB\",\n        \"WScore\" : \"ScoreB\",\n        \"LTeamID\" : \"TeamA\",\n        \"LScore\" : \"ScoreA\"\n    }).copy()\n    \n    win_df[\"ScoreGap\"] = win_df[\"ScoreA\"] - win_df[\"ScoreB\"]\n    lose_df[\"ScoreGap\"] = lose_df[\"ScoreA\"] - lose_df[\"ScoreB\"]\n    all_df = pd.concat([win_df, lose_df], axis = 0)\n    all_df[\"WinA\"] = (all_df[\"ScoreGap\"] > 0).astype(\"int8\")\n    all_df = all_df.sort_values(by = [\"Season\", \"TeamA\", \"TeamB\"]).reset_index(drop = True)\n    return all_df\n\nall_df = create_all_df(tourney)","6e6290dc":"regular = pd.read_csv(\"..\/input\/ncaam-march-mania-2021\/MRegularSeasonCompactResults.csv\")\nprint(regular.shape)\nregular.head()","c6bfe11d":"regular.tail()","30160904":"win_df = regular.groupby([\"Season\", \"WTeamID\"], as_index = False)[\"DayNum\"].count()\nwin_df.rename(columns = {\"DayNum\" : \"WCount\", \"WTeamID\" : \"TeamID\"}, inplace = True)\nlose_df = regular.groupby([\"Season\", \"LTeamID\"], as_index = False)[\"DayNum\"].count()\nlose_df.rename(columns = {\"DayNum\" : \"LCount\", \"LTeamID\" : \"TeamID\"}, inplace = True)\n\nfeatures_df = pd.concat([win_df[[\"Season\", \"TeamID\"]], lose_df[[\"Season\", \"TeamID\"]]], axis = 0).drop_duplicates()\nfeatures_df = features_df.sort_values(by = [\"Season\", \"TeamID\"]).reset_index(drop = True)\n\nfeatures_df = pd.merge(features_df, win_df, on = [\"Season\", \"TeamID\"], how = \"left\")\nfeatures_df = pd.merge(features_df, lose_df, on = [\"Season\", \"TeamID\"], how = \"left\")\nfeatures_df.fillna(0, inplace = True)","36e36313":"win_df = regular.groupby([\"Season\", \"WTeamID\"])[\"WScore\"].agg([\"sum\", \"mean\"]).reset_index(drop = False)\nwin_df.rename(columns = {\"WTeamID\" : \"TeamID\", \"sum\" : \"WScoreSum\", \"mean\" : \"WScoreMean\"}, inplace = True)\nlose_df = regular.groupby([\"Season\", \"LTeamID\"])[\"LScore\"].agg([\"sum\", \"mean\"]).reset_index(drop = False)\nlose_df.rename(columns = {\"LTeamID\" : \"TeamID\", \"sum\" : \"LScoreSum\", \"mean\" : \"LScoreMean\"}, inplace = True)\n\nfeatures_df = pd.merge(features_df, win_df, on = [\"Season\", \"TeamID\"], how = \"left\")\nfeatures_df = pd.merge(features_df, lose_df, on = [\"Season\", \"TeamID\"], how = \"left\")\nfeatures_df.fillna(0, inplace = True)\n\nfeatures_df[\"SeasonScoreSum\"] = features_df[\"WScoreSum\"] + features_df[\"LScoreSum\"]\nfeatures_df[\"SeasonScoreMean\"] = features_df[\"SeasonScoreSum\"] \/ (features_df[\"WCount\"] + features_df[\"LCount\"])","1fb64a44":"dummy = features_df.copy()\ndummy[\"Season\"] = dummy[\"Season\"] + 1\ndummy.rename(columns = {\n    \"WCount\" : \"WCount_shift1\",\n    \"LCount\" : \"LCount_shift1\",\n    \"WScoreSum\" : \"WScoreSum_shift1\",\n    \"WScoreMean\" : \"WScoreMean_shift1\",\n    \"LScoreSum\" : \"LScoreSum_shift1\",\n    \"LScoreMean\" : \"LScoreMean_shift1\",\n    \"SeasonScoreSum\" : \"SeasonScoreSum_shift1\",\n    \"SeasonScoreMean\" : \"SeasonScoreMean_shift1\",\n}, inplace = True)\n\nfeatures_df = pd.merge(features_df, dummy, on = [\"Season\", \"TeamID\"], how = \"left\")\nfeatures_df.fillna(0, inplace = True)","82400db2":"features_df","c47b989b":"import re\ndef treat_seed(seed):\n    return int(re.sub(\"[^0-9]\", \"\", seed))\n\ndef preprocess(df):\n    df = pd.merge(\n        df, features_df, left_on = [\"Season\", \"TeamA\"], right_on = [\"Season\", \"TeamID\"], how = \"left\"\n    ).rename(columns = {\n        \"WCount\" : \"WCountA\",\n        \"LCount\" : \"LCountA\",\n        \"WScoreSum\" : \"WScoreSumA\",\n        \"WScoreMean\" : \"WScoreMeanA\",\n        \"LScoreSum\" : \"LScoreSumA\",\n        \"LScoreMean\" : \"LScoreMeanA\",\n        \"SeasonScoreSum\" : \"SeasonScoreSumA\",\n        \"SeasonScoreMean\" : \"SeasonScoreMeanA\",\n\n        \"WCount_shift1\" : \"WCount_shift1A\",\n        \"LCount_shift1\" : \"LCount_shift1A\",\n        \"WScoreSum_shift1\" : \"WScoreSum_shift1A\",\n        \"WScoreMean_shift1\" : \"WScoreMean_shift1A\",\n        \"LScoreSum_shift1\" : \"LScoreSum_shift1A\",\n        \"LScoreMean_shift1\" : \"LScoreMean_shift1A\",\n        \"SeasonScoreSum_shift1\" : \"SeasonScoreSum_shift1A\",\n        \"SeasonScoreMean_shift1\" : \"SeasonScoreMean_shift1A\",\n    }).drop(columns = \"TeamID\")\n\n    df = pd.merge(\n        df, features_df, left_on = [\"Season\", \"TeamB\"], right_on = [\"Season\", \"TeamID\"], how = \"left\"\n    ).rename(columns = {\n        \"WCount\" : \"WCountB\",\n        \"LCount\" : \"LCountB\",\n        \"WScoreSum\" : \"WScoreSumB\",\n        \"WScoreMean\" : \"WScoreMeanB\",\n        \"LScoreSum\" : \"LScoreSumB\",\n        \"LScoreMean\" : \"LScoreMeanB\",\n        \"SeasonScoreSum\" : \"SeasonScoreSumB\",\n        \"SeasonScoreMean\" : \"SeasonScoreMeanB\",\n\n        \"WCount_shift1\" : \"WCount_shift1B\",\n        \"LCount_shift1\" : \"LCount_shift1B\",\n        \"WScoreSum_shift1\" : \"WScoreSum_shift1B\",\n        \"WScoreMean_shift1\" : \"WScoreMean_shift1B\",\n        \"LScoreSum_shift1\" : \"LScoreSum_shift1B\",\n        \"LScoreMean_shift1\" : \"LScoreMean_shift1B\",\n        \"SeasonScoreSum_shift1\" : \"SeasonScoreSum_shift1B\",\n        \"SeasonScoreMean_shift1\" : \"SeasonScoreMean_shift1B\",\n    }).drop(columns = \"TeamID\")\n    \n    seed = pd.read_csv(\"..\/input\/ncaam-march-mania-2021\/MNCAATourneySeeds.csv\")\n    df = pd.merge(df, seed, left_on = [\"Season\", \"TeamA\"], right_on = [\"Season\", \"TeamID\"], how = \"left\").rename(columns = {\"Seed\" : \"SeedA\"}).drop(columns = \"TeamID\")\n    df = pd.merge(df, seed, left_on = [\"Season\", \"TeamB\"], right_on = [\"Season\", \"TeamID\"], how = \"left\").rename(columns = {\"Seed\" : \"SeedB\"}).drop(columns = \"TeamID\")\n    df[\"SeedA\"] = df[\"SeedA\"].apply(treat_seed)\n    df[\"SeedB\"] = df[\"SeedB\"].apply(treat_seed)\n    return df","3bafa9e1":"all_df = preprocess(all_df)\nall_df","0c5e455d":"test = preprocess(test)\ntest","c2aee073":"print(list(all_df.columns))","ee40a846":"use_cols = list(all_df.columns)\nprint(len(use_cols))\nfor col in ['DayNum', 'ScoreA', 'ScoreB', 'WLoc', 'NumOT', 'ScoreGap', 'WinA']:\n    use_cols.remove(col)\nprint(len(use_cols))","fda1853f":"import lightgbm as lgb\nfrom sklearn.metrics import log_loss\nparams = {\n    \"objective\" : \"binary\",\n    \"metric\" : \"binary_logloss\",\n    \"verbosity\" : -1\n}\n\nmodels = []\nfor season in range(2015, 2020):\n    train = all_df.loc[all_df[\"Season\"] < season]\n    valid = all_df.loc[all_df[\"Season\"] == season]\n    X_train = train[use_cols]\n    X_valid = valid[use_cols]\n    y_train = train[\"WinA\"]\n    y_valid = valid[\"WinA\"]\n    train_set = lgb.Dataset(X_train, y_train)\n    valid_set = lgb.Dataset(X_valid, y_valid)\n    \n    model = lgb.train(\n        params = params,\n        train_set = train_set,\n        valid_sets = [train_set, valid_set],\n        num_boost_round = 100,\n        early_stopping_rounds = 10,\n        verbose_eval = 20\n    )\n    models.append(model)\n    \n    score = log_loss(y_true = y_valid, y_pred = model.predict(X_valid))\n    print(f\"season{season} logloss : {round(score, 3)}\")\n    print(\"=\" * 100)","6ad99be3":"import matplotlib.pyplot as plt\nplt.style.use(\"seaborn-white\")\nimport shap\nshap.initjs()\nexplainer = shap.TreeExplainer(models[-1])\nshap_values = explainer.shap_values(X = X_valid)\nshap.summary_plot(shap_values, X_valid)","8854b875":"test.head()","4d8305c6":"test.tail()","24e3b0d0":"submit_preds = []\nfor i, season in enumerate(range(2015, 2020)):\n    X_test = test.loc[test[\"Season\"] == season][use_cols]\n    preds = models[i].predict(X_test)\n    submit_preds.append(preds)\nsubmit_preds = np.concatenate(submit_preds, axis = 0)","acb182fb":"submit = pd.DataFrame()\nsubmit[\"ID\"] = test[\"ID\"]\nsubmit[\"Pred\"] = submit_preds\nsubmit.to_csv(\"submission.csv\", index = False)\nsubmit.head()","61c829a8":"# 5. Training","13a3be85":"# 4. Preprocessing","c181869f":"# 2. Tourney","d162ca7c":"# 6. Submit","1d06dd8b":"# 1. Download","2326f2c3":"from boruta import BorutaPy\nfrom sklearn.ensemble import RandomForestRegressor\nseason = 2019\ntrain = all_df.loc[all_df[\"Season\"] < season]\nvalid = all_df.loc[all_df[\"Season\"] == season]\nX_train = train[use_cols]\nX_valid = valid[use_cols]\ny_train = train[\"WinA\"]\ny_valid = valid[\"WinA\"]\nmodel = RandomForestRegressor().fit(X_train, y_train)\nprint(model.score(X_valid, y_valid))\nfeat_selector = BorutaPy(RandomForestRegressor(), n_estimators = \"auto\", verbose = 1).fit(X_train.values, y_train.values)\nuse_cols = list(X_train.columns[feat_selector.support_])\nX_train = train[use_cols]\nX_valid = valid[use_cols]\nmodel = RandomForestRegressor().fit(X_train, y_train)\nprint(model.score(X_valid, y_valid))","94fe737d":"# 3. RegularFeatures"}}