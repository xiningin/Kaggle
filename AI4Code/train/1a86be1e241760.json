{"cell_type":{"a49495b2":"code","1a0dab9f":"code","eeba223c":"code","df80f1fd":"code","498f24af":"code","6bd5b219":"code","1e504143":"code","0431242f":"code","0c7233c9":"code","f4da9b47":"code","1714f722":"code","13c8ec14":"code","5a33cc92":"code","59d36ad5":"code","b5d85496":"code","2cf33a99":"code","187ecd80":"code","935213cd":"code","8ee70538":"code","ff75c9b8":"code","a0a8051a":"code","d3589599":"code","75deb6c5":"code","690d5ded":"code","e1a72685":"code","4349a874":"code","16bf4759":"code","0295681a":"code","ca8a4a48":"code","a532c6db":"code","8e548ae8":"code","4e11f502":"code","0f801069":"code","2bb87508":"code","235b6d9e":"code","ad877925":"code","8a490d51":"code","385e7a0d":"code","6c475bc4":"code","46d3835e":"code","763b80ad":"code","a3b340cf":"code","39075732":"code","fcb4a8d0":"code","d980fa74":"code","b6213d4d":"code","4800080a":"code","45f561c9":"code","b5c5e271":"markdown","1a2de807":"markdown","eccb49fd":"markdown","742a11c3":"markdown","ab7a2e9f":"markdown","df9e3a89":"markdown","d02bb139":"markdown","fb55e2b2":"markdown","c507ad82":"markdown","49bd3098":"markdown","d30c56dc":"markdown","10a6c0e6":"markdown","3d89ecd4":"markdown","7f79668c":"markdown","1378697d":"markdown","fc759c34":"markdown","12e850c7":"markdown","fc0dd518":"markdown","d8108869":"markdown","cbb452c8":"markdown","6381f39b":"markdown","f1f6dc6a":"markdown","eed756a9":"markdown","65fcd1e2":"markdown","eb1ef3d2":"markdown","f4c53bf1":"markdown","862c9982":"markdown","9af4db9f":"markdown","3515257b":"markdown","57300b96":"markdown","80de1b10":"markdown","f3e218f3":"markdown","65386933":"markdown","6c2ab414":"markdown","c6fcedb2":"markdown","64160488":"markdown","98e19975":"markdown","1606950f":"markdown","c2b7bd85":"markdown","bc7b624a":"markdown","3605540f":"markdown","af3629aa":"markdown"},"source":{"a49495b2":"import numpy as np\nimport pandas as pd\nimport seaborn as sns\n\nimport datetime\nimport lightgbm as lgb\nfrom scipy import stats\nfrom scipy.sparse import hstack, csr_matrix\nfrom sklearn.model_selection import train_test_split, StratifiedKFold\nfrom wordcloud import WordCloud\nfrom collections import Counter\nfrom nltk.corpus import stopwords\nfrom nltk.util import ngrams\nfrom sklearn.preprocessing import StandardScaler\nfrom sklearn.preprocessing import LabelEncoder\nle = LabelEncoder()\nimport os\nimport xgboost as xgb\nimport lightgbm as lgb\n\nimport os\nimport matplotlib.pyplot as plt\n%matplotlib inline\npd.set_option('max_columns', 150)","1a0dab9f":"folder = '..\/input\/'\napplication_train = pd.read_csv(os.path.join(folder, 'application_train.csv'))\napplication_test = pd.read_csv(os.path.join(folder, 'application_test.csv'))\nbureau = pd.read_csv(os.path.join(folder, 'bureau.csv'))\nbureau_balance = pd.read_csv(os.path.join(folder, 'bureau_balance.csv'))\nPOS_CASH_balance = pd.read_csv(os.path.join(folder, 'POS_CASH_balance.csv'))\ncredit_card_balance = pd.read_csv(os.path.join(folder, 'credit_card_balance.csv'))\nprevious_application = pd.read_csv(os.path.join(folder, 'previous_application.csv'))\ninstallments_payments = pd.read_csv(os.path.join(folder, 'installments_payments.csv'))\nsample_submission = pd.read_csv(os.path.join(folder, 'sample_submission.csv'))","eeba223c":"application_train.head()","df80f1fd":"application_train.TARGET.value_counts(normalize=True)","498f24af":"pd.crosstab(application_train.TARGET, application_train.NAME_CONTRACT_TYPE, dropna=False, normalize='all')","6bd5b219":"pd.crosstab(application_train.TARGET, application_train.CODE_GENDER, dropna=False)","1e504143":"print('There are {0} people with realty. {1}% of them repay loans.'.format(application_train[application_train.FLAG_OWN_REALTY == 'Y'].shape[0], np.round(application_train[application_train.FLAG_OWN_REALTY == 'Y'].TARGET.value_counts(normalize=True).values[1], 3) * 100))\nprint('There are {0} people with cars. {1}% of them repay loans.'.format(application_train[application_train.FLAG_OWN_CAR == 'Y'].shape[0], np.round(application_train[application_train.FLAG_OWN_CAR == 'Y'].TARGET.value_counts(normalize=True).values[1], 4) * 100))\nprint('Average age of the car is {:.2f} years.'.format(application_train.groupby(['FLAG_OWN_CAR'])['OWN_CAR_AGE'].mean().values[1]))","0431242f":"pd.crosstab(application_train.CNT_CHILDREN, application_train.NAME_FAMILY_STATUS, dropna=False)","0c7233c9":"pd.crosstab(application_train.CNT_CHILDREN, application_train.CNT_FAM_MEMBERS, dropna=False)","f4da9b47":"application_train['NAME_TYPE_SUITE'].value_counts(dropna=False)","1714f722":"pd.crosstab(application_train.NAME_TYPE_SUITE, application_train.NAME_FAMILY_STATUS, dropna=False)","13c8ec14":"application_train.groupby(['NAME_INCOME_TYPE']).agg({'AMT_INCOME_TOTAL': ['mean', 'median', 'count']})","5a33cc92":"application_train[application_train['NAME_INCOME_TYPE'] == 'Maternity leave']['CODE_GENDER'].value_counts()\n","59d36ad5":"s = pd.crosstab(application_train.NAME_INCOME_TYPE, application_train.OCCUPATION_TYPE, dropna=False).style.background_gradient(cmap='viridis', low=.5, high=0).highlight_null('red')\ns","b5d85496":"print('{0} zero values.'.format(application_train[application_train['AMT_GOODS_PRICE'].isnull()].shape[0]))","2cf33a99":"non_zero_good_price = application_train[application_train['AMT_GOODS_PRICE'].isnull() == False]\ncredit_to_good_price = non_zero_good_price['AMT_CREDIT'] \/ non_zero_good_price['AMT_GOODS_PRICE']\nplt.boxplot(credit_to_good_price);\nplt.title('Credit amount to goods price.');","187ecd80":"sns.countplot(application_train['NAME_HOUSING_TYPE']);\nplt.xticks(rotation=45);\nplt.title('Counts of housing type')","935213cd":"application_train['contact_info'] = application_train['FLAG_MOBIL'] + application_train['FLAG_EMP_PHONE'] + application_train['FLAG_WORK_PHONE'] + application_train['FLAG_CONT_MOBILE'] + application_train['FLAG_PHONE'] + application_train['FLAG_EMAIL']\nsns.countplot(application_train['contact_info']);\nplt.title('Count of ways to contact client');","8ee70538":"application_train.loc[application_train['OBS_30_CNT_SOCIAL_CIRCLE'] > 1, 'OBS_30_CNT_SOCIAL_CIRCLE'] = '1+'\napplication_train.loc[application_train['DEF_30_CNT_SOCIAL_CIRCLE'] > 1, 'DEF_30_CNT_SOCIAL_CIRCLE'] = '1+'\napplication_train.loc[application_train['OBS_60_CNT_SOCIAL_CIRCLE'] > 1, 'OBS_60_CNT_SOCIAL_CIRCLE'] = '1+'\napplication_train.loc[application_train['DEF_60_CNT_SOCIAL_CIRCLE'] > 1, 'DEF_60_CNT_SOCIAL_CIRCLE'] = '1+'\n","ff75c9b8":"fig, ax = plt.subplots(figsize = (30, 8))\nplt.subplot(1, 4, 1)\nsns.countplot(application_train['OBS_30_CNT_SOCIAL_CIRCLE']);\nplt.subplot(1, 4, 2)\nsns.countplot(application_train['DEF_30_CNT_SOCIAL_CIRCLE']);\nplt.subplot(1, 4, 3)\nsns.countplot(application_train['OBS_60_CNT_SOCIAL_CIRCLE']);\nplt.subplot(1, 4, 4)\nsns.countplot(application_train['DEF_60_CNT_SOCIAL_CIRCLE']);","a0a8051a":"sns.boxplot(application_train['AMT_INCOME_TOTAL']);\nplt.title('AMT_INCOME_TOTAL boxplot');","d3589599":"sns.boxplot(application_train[application_train['AMT_INCOME_TOTAL'] < np.percentile(application_train['AMT_INCOME_TOTAL'], 90)]['AMT_INCOME_TOTAL']);\nplt.title('AMT_INCOME_TOTAL boxplot on data within 90 percentile');","75deb6c5":"application_train.groupby('TARGET').agg({'AMT_INCOME_TOTAL': ['mean', 'median', 'count']})","690d5ded":"plt.hist(application_train['AMT_INCOME_TOTAL']);\nplt.title('AMT_INCOME_TOTAL histogram');","e1a72685":"plt.hist(application_train[application_train['AMT_INCOME_TOTAL'] < np.percentile(application_train['AMT_INCOME_TOTAL'], 90)]['AMT_INCOME_TOTAL']);\nplt.title('AMT_INCOME_TOTAL histogram on data within 90 percentile');","4349a874":"plt.hist(np.log1p(application_train['AMT_INCOME_TOTAL']));\nplt.title('AMT_INCOME_TOTAL histogram on data with log1p transformation');","16bf4759":"sns.boxplot(application_train['AMT_CREDIT'], orient='v');\nplt.title('AMT_CREDIT boxplot');","0295681a":"sns.boxplot(application_train[application_train['AMT_CREDIT'] < np.percentile(application_train['AMT_CREDIT'], 95)]['AMT_CREDIT'], orient='v');\nplt.title('AMT_CREDIT boxplot on data within 90 percentile');","ca8a4a48":"application_train.groupby('TARGET').agg({'AMT_CREDIT': ['mean', 'median', 'count']})","a532c6db":"plt.hist(application_train['AMT_CREDIT']);\nplt.title('AMT_CREDIT histogram');","8e548ae8":"plt.hist(application_train[application_train['AMT_CREDIT'] < np.percentile(application_train['AMT_CREDIT'], 90)]['AMT_CREDIT']);\nplt.title('AMT_INCOME_TOTAL histogram on data within 90 percentile');","4e11f502":"plt.hist(np.log1p(application_train['AMT_CREDIT']));\nplt.title('AMT_CREDIT histogram on data with log1p transformation');","0f801069":"application_train['age'] = application_train['DAYS_BIRTH'] \/ -365\nplt.hist(application_train['age']);\nplt.title('Histogram of age in years.');","2bb87508":"application_train.loc[application_train['DAYS_EMPLOYED'] == 365243, 'DAYS_EMPLOYED'] = 0\napplication_train['years_employed'] = application_train['DAYS_EMPLOYED'] \/ -365\nplt.hist(application_train['years_employed']);\nplt.title('Length of working at current workplace in years.');","235b6d9e":"application_train.groupby(['NAME_INCOME_TYPE']).agg({'years_employed': ['mean', 'median', 'count', 'max'], 'age': ['median']})","ad877925":"application_train.groupby(['NAME_EDUCATION_TYPE', 'NAME_INCOME_TYPE']).agg({'AMT_INCOME_TOTAL': ['mean', 'median', 'count', 'max']})","8a490d51":"application_train['AMT_INCOME_TOTAL'] = np.log1p(application_train['AMT_INCOME_TOTAL'])\napplication_train['AMT_CREDIT'] = np.log1p(application_train['AMT_CREDIT'])\napplication_train['OWN_CAR_AGE'] = application_train['OWN_CAR_AGE'].fillna(0)\napplication_train['app AMT_CREDIT \/ AMT_ANNUITY'] = application_train['AMT_CREDIT'] \/ application_train['AMT_ANNUITY']\napplication_train['app EXT_SOURCE mean'] = application_train[['EXT_SOURCE_1', 'EXT_SOURCE_2', 'EXT_SOURCE_3']].mean(axis = 1)\napplication_train['app EXT_SOURCE_1 \/ DAYS_BIRTH'] = application_train['EXT_SOURCE_1'] \/ application_train['DAYS_BIRTH']\napplication_train['app AMT_INCOME_TOTAL \/ 12 - AMT_ANNUITY'] = application_train['AMT_INCOME_TOTAL'] \/ 12. - application_train['AMT_ANNUITY']\napplication_train['app AMT_INCOME_TOTAL \/ AMT_ANNUITY'] = application_train['AMT_INCOME_TOTAL'] \/ application_train['AMT_ANNUITY']\napplication_train['app AMT_INCOME_TOTAL - AMT_GOODS_PRICE'] = application_train['AMT_INCOME_TOTAL'] - application_train['AMT_GOODS_PRICE']","385e7a0d":"application_test.loc[application_test['OBS_30_CNT_SOCIAL_CIRCLE'] > 1, 'OBS_30_CNT_SOCIAL_CIRCLE'] = '1+'\napplication_test.loc[application_test['DEF_30_CNT_SOCIAL_CIRCLE'] > 1, 'DEF_30_CNT_SOCIAL_CIRCLE'] = '1+'\napplication_test.loc[application_test['OBS_60_CNT_SOCIAL_CIRCLE'] > 1, 'OBS_60_CNT_SOCIAL_CIRCLE'] = '1+'\napplication_test.loc[application_test['DEF_60_CNT_SOCIAL_CIRCLE'] > 1, 'DEF_60_CNT_SOCIAL_CIRCLE'] = '1+'\nnp.log1p(application_test['AMT_INCOME_TOTAL'])\nnp.log1p(application_test['AMT_CREDIT'])\napplication_test['age'] = application_test['DAYS_BIRTH'] \/ -365\napplication_test.loc[application_test['DAYS_EMPLOYED'] == 365243, 'DAYS_EMPLOYED'] = 0\napplication_test['years_employed'] = application_test['DAYS_EMPLOYED'] \/ -365\napplication_test['AMT_INCOME_TOTAL'] = np.log1p(application_test['AMT_INCOME_TOTAL'])\napplication_test['AMT_CREDIT'] = np.log1p(application_test['AMT_CREDIT'])\napplication_test['OWN_CAR_AGE'] = application_test['OWN_CAR_AGE'].fillna(0)\napplication_test['app AMT_CREDIT \/ AMT_ANNUITY'] = application_test['AMT_CREDIT'] \/ application_test['AMT_ANNUITY']\napplication_test['app EXT_SOURCE mean'] = application_test[['EXT_SOURCE_1', 'EXT_SOURCE_2', 'EXT_SOURCE_3']].mean(axis = 1)\napplication_test['app EXT_SOURCE_1 \/ DAYS_BIRTH'] = application_test['EXT_SOURCE_1'] \/ application_test['DAYS_BIRTH']\napplication_test['app AMT_INCOME_TOTAL \/ 12 - AMT_ANNUITY'] = application_test['AMT_INCOME_TOTAL'] \/ 12. - application_test['AMT_ANNUITY']\napplication_test['app AMT_INCOME_TOTAL \/ AMT_ANNUITY'] = application_test['AMT_INCOME_TOTAL'] \/ application_test['AMT_ANNUITY']\napplication_test['app AMT_INCOME_TOTAL - AMT_GOODS_PRICE'] = application_test['AMT_INCOME_TOTAL'] - application_test['AMT_GOODS_PRICE']","6c475bc4":"for col in ['FONDKAPREMONT_MODE', 'HOUSETYPE_MODE', 'WALLSMATERIAL_MODE', 'EMERGENCYSTATE_MODE', 'OBS_30_CNT_SOCIAL_CIRCLE', 'DEF_30_CNT_SOCIAL_CIRCLE', 'OBS_60_CNT_SOCIAL_CIRCLE', 'DEF_60_CNT_SOCIAL_CIRCLE',\n           'NAME_CONTRACT_TYPE', 'CODE_GENDER', 'FLAG_OWN_CAR', 'FLAG_OWN_REALTY', 'NAME_TYPE_SUITE', 'NAME_INCOME_TYPE', 'NAME_EDUCATION_TYPE', 'NAME_FAMILY_STATUS', 'NAME_HOUSING_TYPE', 'OCCUPATION_TYPE',\n            'WEEKDAY_APPR_PROCESS_START', 'ORGANIZATION_TYPE', 'WEEKDAY_APPR_PROCESS_START']:\n    unique_values = list(set(list(application_train[col].astype(str).unique()) + list(application_test[col].astype(str).unique())))\n    le.fit(unique_values)\n    application_train[col] = le.transform(application_train[col].astype(str))\n    application_test[col] = le.transform(application_test[col].astype(str))","46d3835e":"train = application_train","763b80ad":"train.head()","a3b340cf":"test = application_test","39075732":"train = train.fillna(0)\ntest = test.fillna(0)","fcb4a8d0":"X = train.drop(['SK_ID_CURR','contact_info', 'TARGET'], axis=1)\ny = train['TARGET']\nX_test = test.drop(['SK_ID_CURR'], axis=1)","d980fa74":"X_train, X_valid, y_train, y_valid = train_test_split(X, y, test_size=0.20, random_state=42)\nparams = {\n    'boosting': 'dart',\n    'application': 'binary',\n    'learning_rate': 0.01,\n    'num_leaves': 34,\n    'max_depth': 5,\n    'feature_fraction': 0.9,\n    'scale_pos_weight': 2,\n    'reg_alpha': 0.05,\n    'reg_lambda': 0.1}\nmodel = lgb.train(params, lgb.Dataset(X_train, y_train), 1000, [lgb.Dataset(X_train, y_train), lgb.Dataset(X_valid, y_valid)], verbose_eval=10, early_stopping_rounds=20)","b6213d4d":"lgb.plot_importance(model, max_num_features=30, figsize=(24, 18))","4800080a":"folds = StratifiedKFold(n_splits=10, shuffle=True, random_state=42)\nparams={'colsample_bytree': 0.8,\n 'learning_rate': 0.01,\n 'num_leaves': 34,\n 'subsample': 0.97,\n 'max_depth': 8,\n 'reg_alpha': 0.03,\n 'reg_lambda': 0.07,\n 'min_split_gain': 0.01,\n #'min_child_weight': 38\n       }\nprediction = np.zeros(X_test.shape[0])\nfor n_fold, (train_idx, valid_idx) in enumerate(folds.split(X, y)):\n        train_x, train_y = X.iloc[train_idx], y.iloc[train_idx]\n        valid_x, valid_y = X.iloc[valid_idx], y.iloc[valid_idx]\n        clf = lgb.LGBMClassifier(**params)\n        clf.fit(train_x, train_y, \n                eval_set = [(train_x, train_y), (valid_x, valid_y)], eval_metric = 'auc', \n                verbose = 100, early_stopping_rounds = 50)\n        prediction += clf.predict(X_test)","45f561c9":"sub = test[['SK_ID_CURR']].copy()\nsub['TARGET'] = prediction \/ 10\nsub.to_csv('sub.csv', index= False)","b5c5e271":"We can see that most of the people are married and have zero children. In face we can divide people into two group based on their family status - living together with their partner or single.","1a2de807":"So this means that only 278 loans have some other type. Let's fo deeper.","eccb49fd":"We can see that most of the loans are taken by working people with secondary education.","742a11c3":"Most clients provide 3 ways to contact them and usually minimus is 2, if we don't consider several people who left only 1.","ab7a2e9f":"##### NAME_INCOME_TYPE","df9e3a89":"## Data Exploration","d02bb139":"We have disbalanced target, though disbalance isn't really serious.","fb55e2b2":"##### AMT_INCOME_TOTAL","c507ad82":"##### AMT_CREDIT","49bd3098":"It is interesting to see that these two variables sometimes contradict each other. For example, separated, single or widowed applicants were sometimes accompanied by their partner. I suppose this means unofficial relationships? Also sometimes children accompanied the applicant. Maybe these were adult childred?","d30c56dc":"We can see that age distribution is almost normal and most of the people are between 30 and 40 years.","10a6c0e6":"##### FLAG_OWN_CAR and FLAG_OWN_REALTY","3d89ecd4":"Ther was a strange value - 365243, it could mean empty values or some errors, so I replace it with zero.\nA lot of people don't work, but let's look deeper into this.","7f79668c":"Well, it seems that a lot of non-working people are pensioners, which is normal. As for working people - they seem to work for several years at one place.","1378697d":"# Home Credit Default Risk\n\nThis kernel will contain EDA, visualization, feature engineering and some modelling. Work currently in progress.","fc759c34":"We can see that women take more loans and higher percentage of them repays the loans. And there are 4 people with unindentified gender, who repayed their loans :)","12e850c7":"It isn't surprising that there are a lot of families consisting of two or one adults. Also there are families with two adults and 1-2 children.","fc0dd518":"#### Continuous variables","d8108869":"This was EDA and basic feature engineering. I know that feature engineering and modelling could be much better, but decided to make EDA the main focus of this kernel. I'll do better feature engineering and modelling in the next one.","cbb452c8":"We can see following things from the information above:\n- income feature has some huge outliers. This could be due to rich individuals or due to errors in data;\n- average income is almost similar for those who repay the loans and those who don't;\n- if we leave only data within 90 percentile, it is almost normally distributed;\n- log transformation also helps;","6381f39b":"### application_train and application_test\nThese are main files with data and technically we can use only them to make predictions. Obviously using additional data is necessary to improve score.","f1f6dc6a":"We can see that there are 4 categories with little amount of people in them: several high-income businessmen, 4 women and 1 man on maternity leave, and some unemployed\/students. It is quite interesting that unemployed\/students have quite a high income.\nAnd of course, most of the people work.","eed756a9":"##### Contact information\nThere are 6 features showing that client provided some contact information, let's see how many ways of contact clients usually provide.","65fcd1e2":"# deliquencies\n\nIt is very important to see how many times clients was late with payments or defaulted his loans. I suppose info about his social circle is also important. I'll divide values into 2 groups: 0, 1 and more than 1.","eb1ef3d2":"##### DAYS_EMPLOYED","f4c53bf1":"##### NAME_CONTRACT_TYPE","862c9982":"##### Target","9af4db9f":"##### NAME_TYPE_SUITE\nThis feature shows who was accompanying client when he was applying for the loan.","3515257b":"We have 122 columns in just main file! Let's take a look on some of them.","57300b96":"##### AMT_GOODS_PRICE\nFor consumer loans it is the price of the goods for which the loan is given","80de1b10":"We can see that there are two types of contract - cash loans and revolving loans. Most of the loans are cash loans which are defaulted.","f3e218f3":"There are several files with data, let's go through them step by step.","65386933":"##### CNT_CHILDREN and NAME_FAMILY_STATUS","6c2ab414":"##### DAYS_BIRTH","c6fcedb2":"##### NAME_HOUSING_TYPE","64160488":"This feature shows the amount of the loan in question.\nWe can see following things from the information above:\n- income feature has some outliers. Maybe mortgage?;\n- average credit amoint is almost similar for those who repay the loans and those who don't;\n- if we leave only data within 95 percentile, it is almost normally distributed;\n- log transformation also helps;","98e19975":"We can see that most of the loans have the amount which is similar to the goods price, but there are some outliers.","1606950f":"## Basic modelling, LGB","c2b7bd85":"##### CODE_GENDER","bc7b624a":"#### Categorical features","3605540f":"## Transforming and merging data","af3629aa":"Ther are so many features and so many possible angles from which we can analyze them. Let's see this for example:"}}