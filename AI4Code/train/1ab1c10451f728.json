{"cell_type":{"df66b564":"code","f762cfe0":"code","76d48c61":"code","89302292":"code","31073bf9":"code","01172761":"code","dd7d6650":"code","19780ba5":"markdown","4e7c6b90":"markdown","04bc2608":"markdown","f83b631b":"markdown","c65eb1ce":"markdown","e15572a4":"markdown","1a112063":"markdown","cb5a6f48":"markdown","e9a925bb":"markdown","0f6a44ba":"markdown","9fad79b0":"markdown","2140a603":"markdown"},"source":{"df66b564":"import numpy as np\nimport pandas as pd\nnp.random.seed(20201201)\nDATADIR = '..\/input\/jane-street-market-prediction\/'","f762cfe0":"# Load the training set. \ntrain = pd.read_csv(DATADIR+'train.csv')","76d48c61":"# Analyzing the proceeeds\n\ndef analyze(column, limit=None):\n    \"\"\"\n    Calculates the risk factor $t$ and the score $u$ for the proceeds in train[column]\n    \"\"\"\n    p = train.groupby('date')[column].sum()\n    p_max = p.max()\n    if limit is not None:\n        p = p.clip(upper=limit)\n    p_sum = p.sum()\n    p_bar = p_sum\/len(p)\n    p_rms = np.sqrt((p**2).mean())\n    t = np.sqrt(250)*p_bar\/p_rms\n    u = min(max(t, 0), 6)*p_sum\n    pi_u = 2*(p_rms**2)\/p_bar\n    print(f\"p_sum: {p_sum:12.6f},  p_bar:  {p_bar:12.6f},  p_rms:  {p_rms:12.6f}\")\n    print(f\"u: {u:12.6f},  t:  {t:12.6f},  pi_u:  {pi_u:12.6f},  p_max:  {p_max:12.6f}\")","89302292":"train['proceeds'] = train['weight']*train['resp']\nanalyze('proceeds')","31073bf9":"train['max_proceeds'] = train['proceeds'].clip(lower=0)\nanalyze('max_proceeds')","01172761":"train['random_proceeds'] = train['proceeds']*np.random.randint(2, size=len(train['resp']))\nanalyze('random_proceeds')","dd7d6650":"train['small_proceeds'] = np.where(train['weight'] < 1, train['random_proceeds'], 0)\nanalyze('small_proceeds')","19780ba5":"## A simple bound on $t$\n\nWe can interpret $p_i$ as the proceeds for day $i$.\nLet us denote its arithmetic mean and its root mean square values as:\n$$\n\\bar{p} = \\frac{\\sum_i p_i}{N},\n\\\\\np_{rms} = \\sqrt{\\frac{\\sum_i p^2_i}{N}}.\n$$\n\nThen we can write:\n$$ \nt = \\sqrt{250} \\bar{p} \/ p_{rms}.\n$$ \n\nThe variance of the series is given by the difference of squares $\\sigma^2 = p_{rms}^2 - \\bar{p}^2$.\nBecause the variance is always positive, we can write the inequality:\n\n$$\np_{rms}^2 = \\bar{p}^2 + \\sigma^2 \\geq \\bar{p}^2.\n$$\n\nFrom this it follows that \n$$\n -\\sqrt{250} \\leq t \\leq \\sqrt{250} = 15.811388\\ldots, \n$$\n\nwith the equality only occurring for $\\sigma=0$, i. e. when all $p_i$ are equal.","4e7c6b90":"## Gradient of $t$\n\n$$\n\\frac{d t}{d p_i} = \\sqrt{250} \\left( \\frac{1}{N p_{rms}} - \\frac{\\bar{p}}{N p_{rms}^3} p_i \\right) \n                  = \\frac{\\sqrt{250}}{N p_{rms}} \\left( 1 - \\frac{\\bar{p} p_i}{p_{rms}^2} \\right).       \n$$\n\nAssuming that $\\bar{p} >0 $ (we are hoping to extract a profit, aren't we?),\nthis implies that $\\frac{d t}{d p_i} > 0$ as long as $p_i < \\pi_t$, with the limiting value $\\pi_t$ given by:\n$$\n \\pi_t = p_{rms}^2 \/ \\bar{p}. \n$$\n\nThis means that we can increase $t$ by reducing the actions on days for which $ p_i > \\pi_t$,\nand by adding actions on dates with $p_i < \\pi_t$\n(if there are still positive returns available to be included).","04bc2608":"#### Case 4: small risks\n\nImagine that we place bets only for small weights ($\\lt 1$), and that we are so lucky that we have selected all such winning bets and none of the loosing ones. So $\ud835\udc4e\ud835\udc50\ud835\udc61\ud835\udc56\ud835\udc5c\ud835\udc5b_{\ud835\udc56\ud835\udc57}=1$ if $weight_{\ud835\udc56\ud835\udc57}<1$ and $resp_{\ud835\udc56\ud835\udc57}>0$.","f83b631b":"Note that in this case $0 < t < 6$, but anyway $p_{max} < \\pi_u$.\nThis means that the best way to improve the score is to include all bets where we expect a positive outcome.","c65eb1ce":"#### Case 2: maximum profit\n\nIf I were clairvoyant, I would bet only on the profitable ticks, $\ud835\udc4e\ud835\udc50\ud835\udc61\ud835\udc56\ud835\udc5c\ud835\udc5b_{\ud835\udc56\ud835\udc57}=1$ only if $resp_{ij}>0$. \nOn the training set, this leads to a very high $t$ value, $t=13.7$.","e15572a4":"## Training data\n\nWe do not know the treshold values $\\pi_t$ or $\\pi_u$ for the test data, but we can get some insights from the training data. I will discuss here some extreme cases.","1a112063":"#### Case 3: completely random\n\nPlacing bets randomly: $\ud835\udc4e\ud835\udc50\ud835\udc61\ud835\udc56\ud835\udc5c\ud835\udc5b_{\ud835\udc56\ud835\udc57}=0$ or $1$ randomly with 50% chance each.","cb5a6f48":"## Gradient of $u$\n\nThe goal of the competition is not to optimize $t$, but to optimize the product \n$$\n u = \\min(\\max(t,0), 6) \\sum p_i\n$$\n\nFor $t \\gt 6$, the strategy to follow is simple: just maximize all $p_i$.\n\nThe case $0 \\lt t \\lt 6$ is more interesting. Then $u =  t N \\bar{p} = N \\sqrt{250} \\bar{p}^2 \/ p_{rms}$.\nThe derivatives to $p_i$ are given by:\n\n$$\n \\frac{d u}{d p_i} = \\sqrt{250} \\left( \\frac{2\\bar{p}}{p_{rms}} - \\frac{\\bar{p}^2}{p_{rms}^3} p_i \\right) \n                  = t \\left( 2 - \\frac{\\bar{p} p_i}{p_{rms}^2} \\right).       \n$$\n\nTo improve the score, we should compare the daily proceeds $p_i$ to the limiting value: \n$$\n \\pi_u = 2 p_{rms}^2 \/ \\bar{p} = 2 \\pi_t. \n$$\n\nThis means that we can increase $t$ by reducing the actions on days for which $ p_i > \\pi_u$,\nand by adding actions on dates with $p_i < \\pi_u$\n(if there are still positive returns available to be included).\n\n","e9a925bb":"# Analyzing the factor $t$\n\nIn the Jane Street Market Prediction Competition, the total proceeds $\\sum p_i$\nare weighted by a factor $\\min(\\max(t,0), 6)$, where\n\n$$\np_i = \\sum_j(weight_{ij} * resp_{ij} * action_{ij}),\n$$\n\n$$\nt = \\frac{\\sum p_i }{\\sqrt{\\sum p_i^2}} * \\sqrt{\\frac{250}{N}},\n$$\nand $N$ is the number of unique dates in the test set.\n(In order to avoid confusion with the summation indices, I use $N$ instead of the notation $|i|$ used on the competition web site.) \n\nThe factor $t$ has been likened to an *annualized Sharpe ratio*. More info on [Wikipedia](https:\/\/en.wikipedia.org\/wiki\/Sharpe_ratio)\nand some discussions on this topic [here](https:\/\/www.kaggle.com\/c\/jane-street-market-prediction\/discussion\/199107).\n\nThe factor t is a measure of the riskiness of the investment actions. Low $t$ means high variance, which implies high risk. \nSo it makes sense that for strategies with the same return $\\sum p_i$, the one with the highest $t$ (i.e. lowest risk) gets the better score. \n\nI have no idea why there is a cutoff at $t > 6$. \nMaybe it represents such a low level of variance that the implied risk becomes negligible to other risk factors that are beyond the scope of this competition.  ","0f6a44ba":"# Conclusion\n\nMy first impression is that there is no use in trying to optimize the $t$ factor in order to increase the score.\nFor startes, simply taking all bets for which one excepts a postive $resp$ seems like the best strategy.\n\nI might revisit this analysis later on when I have real results.","9fad79b0":"#### Case 1: accepting all bets\n\nTaking $action_{ij}=1$ for all $i$, $j$. This leads to a negative outcome, so $u=0$.","2140a603":"### Analyzing the training data\n\nWe will use the `analyze` function to calculate the relevant variables $\\sum p_i$, $\\bar{p}$, $p_{rms}$, $u$, $t$ and $\\pi_u$."}}