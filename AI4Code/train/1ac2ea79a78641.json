{"cell_type":{"2246d6eb":"code","b0f21db5":"code","69b61a1f":"code","13701623":"code","ac38d40b":"code","66e34e05":"code","1c15a8b9":"code","b5ab776a":"code","6dbc7cd9":"code","6034be75":"code","ef1ced34":"markdown","d37b621d":"markdown","2c33c642":"markdown","0b73d8b4":"markdown","9ed38a10":"markdown"},"source":{"2246d6eb":"# Install dependencies\n%pip install yfinance -q\n\n# Imports\nimport os\nimport numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\nfrom kaggle_secrets import UserSecretsClient\nimport yfinance as yf # Yahoo Finance API\nimport certifi # SSL cert\nfrom time import sleep\nimport plotly.express as px # Plotting library\nimport random\n\n# Util functions\ndef remove_empty_columns_from_right(df):\n    df = df.copy()\n    while len(df.columns) > 0 and not df[df.columns[-1]].any():\n        df.drop(df.columns[-1], axis=1, inplace=True)\n    return df\n\ndef reset_index(df):\n    df = df.copy()\n    df.index = list(range(len(df.index)))\n    return df","b0f21db5":"CURRENCY_SIGN = '$'\nN_DIGITS_AFTER_POINT = 2","69b61a1f":"trades = None\npositions = None\n\ninput_filenames = []\nfor dirname, _, filenames in os.walk('\/kaggle\/input'):\n    for filename in filenames:\n        path = os.path.join(dirname, filename)\n        if filename == 'trades.csv':\n            trades = pd.read_csv(path)\n            continue\n        if filename == 'positions.csv':\n            positions = pd.read_csv(path)\n            continue\n        input_filenames.append(path)\n\nif trades is None and positions is None:\n    print('Parse trades from Interactive Brokers reports')\nelif positions is None:\n    print('Trades are provided')","13701623":"\nif trades is None and positions is None:\n    print('Parse Interactive Brokers reports')\n    # Concatenate annual reports into a single one\n    interactive_brokers_reports = []\n\n    sorted_filenames = sorted(input_filenames)\n    for report_path in sorted_filenames:\n        interactive_brokers_reports.append(pd.read_csv(report_path, header=None, names=list(range(100))))\n\n    full_interactive_brokers_report = pd.concat(interactive_brokers_reports, ignore_index=True)\n\n    cut_report = remove_empty_columns_from_right(full_interactive_brokers_report)\n    cut_report.shape\n\n    trades_table = remove_empty_columns_from_right(cut_report[cut_report[0] == 'Trades'])\n    trades_table.drop(0, axis=1, inplace=True)\n    trades_table.columns = trades_table.iloc[0].values\n    trades_table.drop(trades_table.index[0], axis=0, inplace=True)\n    trades_table = reset_index(trades_table)\n    trades_table.shape\n\n    trades = trades_table[(trades_table['Header'] == 'Data') & (trades_table['Asset Category'] == 'Stocks')].copy()\n    trades.drop(['Header', 'Asset Category'], axis=1, inplace=True)\n    trades['Date\/Time'] = trades['Date\/Time'].apply(lambda s: pd.to_datetime(s))\n    trades.sort_values(by='Date\/Time', inplace=True)\n    trades = reset_index(trades)\n    trades = trades[['Symbol', 'Quantity', 'T. Price']]\n    trades = pd.DataFrame({\n        'symbol': trades['Symbol'],\n        'quantity': trades['Quantity'],\n        'price': trades['T. Price']\n    })\n    trades.to_csv('trades.csv', index=False)","ac38d40b":"if positions is None:\n    print('Calculate positions from trades')\nelse:\n    print('Positions are provided')","66e34e05":"if positions is None:\n    print('Calculate positions from trades')\n    symbol_state = {}\n    for index, trade in trades.iterrows():\n        symbol = trade['symbol']\n        symbol_state.setdefault(symbol, {'position': []})\n        quantity = int(trade['quantity'])\n        price = float(trade['price'])\n        if quantity > 0:\n            symbol_state[symbol]['position'].append({'quantity': quantity, 'price': price})\n        else:\n            position = symbol_state[symbol]['position']\n            quantity = -quantity\n            while quantity > 0:\n                if position[0]['quantity'] <= quantity:\n                    quantity -= position[0]['quantity']\n                    position.pop(0)\n                else:\n                    position[0]['quantity'] -= quantity\n                    quantity = 0\n\n    try:\n        # Merger. APHA & TLRY\n        if UserSecretsClient().get_secret('use-hardcoded-mergers') == 'True':\n            symbol_state['APHA'] = {'position': []}\n            symbol_state['TLRY'] = {'position': [{'quantity': 2.5143, 'price': 5.66}]}\n    except Exception as exc_info:\n        print(str(exc_info))\n\n    positions = pd.DataFrame()\n    positions['symbol'] = symbol_state.keys()\n    positions.index = symbol_state.keys()\n    positions['quantity'] = None\n    positions['average_price'] = None\n    for symbol, state in symbol_state.items():\n        quantity = 0\n        cost = 0.0\n        for item in state['position']:\n            quantity += item['quantity']\n            cost += item['quantity'] * item['price']\n        positions.at[symbol, 'quantity'] = quantity\n        positions.at[symbol, 'average_price'] = cost \/ quantity if quantity > 0 else 0.0\n    positions = positions[positions['quantity'] != 0].copy()\n    positions.sort_values(by='symbol', inplace=True)\n    positions = reset_index(positions)\n\n    positions.to_csv('positions.csv', index=False)","1c15a8b9":"# Suppress SSL warning\nos.environ['SSL_CERT_FILE'] = certifi.where()\n\nclass SecurityProfile:\n\n    def __init__(self, ticker):\n        self.ticker = ticker\n        \n    def data(self):\n        yf_ticker = yf.Ticker(self.ticker)\n        info = yf_ticker.info\n        history = yf_ticker.history(period='1d')\n        return {\n            'name': info['longName'],\n            'price': history['Close'][-1],\n            'sector': info.get('sector', 'N\/A'),\n            'industry': info.get('industry', 'N\/A')\n        }\n\nclass FakeSecurityProfile:\n\n    def __init__(self, ticker):\n        self.ticker = ticker\n        \n    def data(self):\n        industry_id = random.randint(0, 20)\n        return {\n            'name': self.ticker,\n            'price': random.randint(5, 15),\n            'sector': 'N\/A' if industry_id < 4 else f'Sector {int(industry_id \/ 4)}',\n            'industry': 'N\/A' if industry_id < 4 else f'Idustry {industry_id}'\n        }\n\nclass SecurityProfileCollection:\n    \n    def __init__(self, tickers, fake=False):\n        self.tickers = tickers\n        self.fake = fake\n        \n    def dataframe(self):\n        result = pd.DataFrame(columns=['symbol', 'sector', 'industry', 'name', 'price'])\n        success = False\n        for i in range(500):\n            if success:\n                break\n            print(f'!!! {i} !!!')\n            finished = True\n            try:\n                for index, ticker in enumerate(self.tickers):\n                    if index in result.index and result.at[index, 'sector'] is not None:\n                        continue\n                    print(index, ticker)\n                    security_profile = FakeSecurityProfile(ticker) if self.fake else SecurityProfile(ticker)\n                    data = security_profile.data()\n                    result.at[index, 'symbol'] = ticker\n                    result.at[index, 'sector'] = data['sector']\n                    result.at[index, 'industry'] = data['industry']\n                    result.at[index, 'name'] = data['name']\n                    result.at[index, 'price'] = data['price']\n            except Exception as ex:\n                print(ex)\n                raise\n                finished = False\n            if not finished:\n                sleep(10)\n            else:\n                success = True\n        return result\n\nportfolio = positions.copy()\nportfolio = portfolio[['symbol', 'quantity', 'average_price']]\n\nportfolio.index = list(range(portfolio.shape[0]))\n\nportfolio = portfolio.merge(SecurityProfileCollection(portfolio['symbol'], fake=False).dataframe(), on='symbol')","b5ab776a":"print(f'Cost: {(portfolio[\"average_price\"] * portfolio[\"quantity\"]).sum():.2f}{CURRENCY_SIGN}')\nprint(f'Value: {(portfolio[\"quantity\"] * portfolio[\"price\"]).sum():.2f}{CURRENCY_SIGN}')\nportfolio","6dbc7cd9":"portfolio['value'] = (portfolio['quantity'] * portfolio['price']).apply(lambda x: round(x, N_DIGITS_AFTER_POINT))\nshares = portfolio[portfolio['sector'] != 'N\/A'].copy()\nshares['total'] = 'Shares'\nfig = px.sunburst(\n    shares,\n    path=['total', 'sector', 'industry', 'symbol'],\n    values='value',\n    width=750,\n    height=750\n)\nfig.show()\nfunds = portfolio[portfolio['sector'] == 'N\/A'].copy()\nfunds['total'] = 'Funds'\nfig = px.sunburst(\n    funds,\n    path=['total', 'symbol'],\n    values='value',\n    width=750,\n    height=750\n)\nfig.show()","6034be75":"def sum_by_symbols(symbols):\n    pd.DataFrame({'symbol': portfolio['symbol'], 'amount': portfolio['quantity'] * portfolio['price']})\n    sub_df = portfolio[[symbol in symbols for symbol in portfolio['symbol']]]\n    return (sub_df['quantity'] * sub_df['price']).sum()\n\nshares_symbols = set(portfolio[portfolio['sector'] != 'N\/A']['symbol'])\nshares_symbols.update({'VT', 'VXF', 'VXUS'})\nshares_sum = sum_by_symbols(shares_symbols)\ngold_symbols = {'GLD'}\ngold_sum = sum_by_symbols(gold_symbols)\nmaterial_symbols = {'SLV', 'UNG', 'WEAT'}\nmaterial_sum = sum_by_symbols(material_symbols)\nobligation_symbols = {'TLT', 'TIP', 'BNDW'}\nobligation_sum = sum_by_symbols(obligation_symbols)\nrest = set(portfolio['symbol']) - shares_symbols - gold_symbols - material_symbols - obligation_symbols\nif len(rest) != 0:\n    raise Exception(f'Unprocessed symbols: {rest}')\ntotal = sum((shares_sum, gold_sum, material_sum, obligation_sum))\nprint(f'Shares: {shares_sum \/ total * 100:.02f}%')\nprint(f'Obligations: {obligation_sum \/ total * 100:.02f}%')\nprint(f'Gold: {gold_sum \/ total * 100:.02f}%')\nprint(f'Materials: {material_sum \/ total * 100:.02f}%')","ef1ced34":"# Calculate positions from trades unless positions are provided","d37b621d":"# Portfolio specific analytics","2c33c642":"# Parse Interactive Brokers reports unless trades or positions are provided","0b73d8b4":"# Collect information about current price, sector and industry","9ed38a10":"# Diversification by sectors and industries"}}