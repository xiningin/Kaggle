{"cell_type":{"74a91c10":"code","0f564179":"code","e03c752b":"code","8911e586":"code","de4b3bc2":"code","ecbc5150":"code","85271215":"code","e58ef239":"code","b486c380":"code","9f1d1598":"markdown","da31c7e4":"markdown","de7e5273":"markdown","6234a6f6":"markdown","eedccbb1":"markdown","b7cf0dc9":"markdown","5109dbde":"markdown","437bb3dd":"markdown","ec883daa":"markdown"},"source":{"74a91c10":"import numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\n\nimport seaborn as sns\nimport scipy.stats as stats\nimport matplotlib.pyplot as plt\nfrom statsmodels.api import  qqplot\n\nfrom sklearn import preprocessing as preprocessing\nfrom sklearn.linear_model import LinearRegression\nfrom sklearn.metrics import mean_absolute_error\nimport types\n\n\nfrom scipy.stats import shapiro, normaltest, anderson\nfrom sklearn.pipeline import Pipeline, FeatureUnion\nfrom sklearn.compose import ColumnTransformer\nfrom sklearn.impute import SimpleImputer\nfrom sklearn.compose import TransformedTargetRegressor\nfrom sklearn.base import BaseEstimator, TransformerMixin\n\ndef load_data(path):\n    return pd.read_csv(path+'train.csv', index_col='Id'), pd.read_csv(path+'test.csv', index_col='Id')\n\ndef init_sns():\n    # set seaborn style dark\n    sns.set_style('dark')\n    \ndef qq_plot(x, **kwargs):\n    qqplot(x, ax=plt.gca(), **kwargs)\n\ndef cat_cols(df):\n    \"\"\"return categorical columns\n    \"\"\"\n    return [cname for cname in df.columns if\n                    df[cname].dtype == \"O\"]\n\ndef num_cols(df):\n    \"\"\"return numerical columns\n\n        total columns = categorical columns + numerical columns\n    \"\"\"\n    return df.columns[~df.columns.isin(cat_cols(df))]\n\ndef get_cols_with_(x, data):\n    \"\"\" return columns of DataFrame 'data', which contains str 'x'\n    \"\"\"\n    cols = []\n    for c in data.columns:\n        if x in c:\n            cols.append(c)\n    return cols\n\ndef save(index, preds):\n    # Save test predictions to file\n    output = pd.DataFrame({'Id': index,\n                           'SalePrice': preds})\n    output.to_csv('submission.csv', index=False)\n    \ndef nomality_tests(data):\n    \"\"\"\n    return shpiro test result(s1, p1),\n    D\u2019Agostino\u2019s K^2 Test result(s2,p2), \n    Anderson-Darling Test result\n    in tuple\n    \"\"\"\n    s1, p1 = shapiro(data)\n    s2, p2 = normaltest(data)\n    result = anderson(data)\n    return (s1, p1), (s2, p2), result\n\ndef linear_regression(data):\n    lr = LinearRegression()\n    x_train, y_train = data[n_feats], data['SalePrice']\n    lr.fit(x_train, y_train)\n    return lr\n\ndef fill_garageyrblt(data, c):\n    rows = data['GarageYrBlt'].isnull()\n    data.loc[rows, 'GarageYrBlt']= \\\n    data.loc[rows, 'YearBuilt']\n    \ndef miss_val_handler(data):\n    \n    def _handle_(data, c, v):\n        if isinstance(v, types.FunctionType):\n            v(data, c)\n        else:\n            null_r = data[c].isnull()\n            if null_r.sum() == 0: return\n            data.loc[null_r, c] = v        \n\n    for c in MISS_VAL:\n        v = MISS_VAL[c]\n        if isinstance(v, tuple):\n            for e in v:\n                _handle_(data, c, e)\n        else:\n            _handle_(data, c, v)\n            \n    return data\n            \ndef BsmtExposure_no(data,c):\n    #data.loc[949, 'BsmtExposure']='No'\n    pass\n\ndef median_impute(data, c):\n    null_r = data[c].isnull()\n    if null_r.sum() == 0: return\n    data.loc[null_r, c] = data[c].median()\n    \ndef most_freq_impute(data, c):\n    null_r = data[c].isnull()\n    if null_r.sum() == 0: return\n    data.loc[null_r, c] = data[c].mode()[0]\n    \n# load data to TRAIN_DATA, TEST_DATA\nPATH = '\/kaggle\/input\/home-data-for-ml-course\/'\nTRAIN_DATA, TEST_DATA = load_data(PATH)\n\n## Chosen numeric features\nN_FEATS = ['BedroomAbvGr', 'GrLivArea', 'LowQualFinSF', 'YearBuilt', 'FullBath',\n           'EnclosedPorch', '1stFlrSF', 'BsmtFinSF2', 'OverallQual', 'YearRemodAdd',\n           'BsmtUnfSF', 'LotArea', 'KitchenAbvGr', 'Fireplaces', 'OverallCond',\n           'TotRmsAbvGrd', 'PoolArea', 'LotFrontage', 'OpenPorchSF', 'BsmtFinSF1',\n           'GarageYrBlt', 'TotalBsmtSF', 'GarageCars', '3SsnPorch', 'BsmtHalfBath',\n           'WoodDeckSF', '2ndFlrSF', 'GarageArea', 'BsmtFullBath', 'MiscVal', 'ScreenPorch',\n           'HalfBath', 'MasVnrArea', 'YrSold']\n\n## Chosen categrical featrues\nC_FEATS = ['MSZoning', 'Street', 'Alley', 'LotShape', 'LandContour', 'Utilities',\n           'LotConfig', 'LandSlope', 'Neighborhood', 'Condition1', 'Condition2', \n           'BldgType','HouseStyle', 'RoofStyle', 'RoofMatl', 'Exterior1st',\n           'Exterior2nd', 'MasVnrType', 'ExterQual', 'ExterCond', 'Foundation',\n           'BsmtQual', 'BsmtCond', 'BsmtExposure', 'BsmtFinType1', 'BsmtFinType2',\n           'Heating', 'HeatingQC', 'CentralAir', 'Electrical', 'KitchenQual',\n           'Functional', 'FireplaceQu', 'GarageType', 'GarageFinish', 'GarageQual',\n           'GarageCond', 'PavedDrive', 'PoolQC', 'Fence', 'MiscFeature', 'SaleType',\n           'SaleCondition', 'MoSold', 'MSSubClass']\n\n## Doc of Values for missing value to fill.\n## where key is column name and value to fill missing value\nMISS_VAL = {'PoolQC': 'NA',\n            'FireplaceQu': 'NA',\n            'GarageCond': 'NA',\n            'GarageType': 'NA',\n            'GarageFinish': 'NA',\n            'GarageQual': 'NA',\n            'BsmtExposure': ('NA', BsmtExposure_no),\n            'BsmtFinType2': 'NA',\n            'BsmtFinType1': 'NA',\n            'BsmtQual': 'NA',\n            'BsmtCond': 'NA',\n            'MasVnrType': 'None',\n            'Electrical': 'SBrkr',\n            'MasVnrArea': 0,\n            'LotFrontage': median_impute,\n            'GarageYrBlt': fill_garageyrblt,\n            'BsmtFullBath':0,\n            'BsmtHalfBath':0,\n            'TotalBsmtSF': 0,\n            'BsmtFinSF1': 0,\n            'BsmtUnfSF': 0, \n            'BsmtFinSF2': 0,\n            'Exterior1st': most_freq_impute,\n            'Exterior2nd': most_freq_impute,\n            'MSZoning': most_freq_impute,\n            'Functional': most_freq_impute,\n            'Utilities': most_freq_impute,\n            'KitchenQual': most_freq_impute,\n            'SaleType': most_freq_impute,\n            'GarageArea': 0,\n            'GarageCars': 0}\n\n## Ordinal features\nORDINAL = ['ExterQual','BsmtQual', 'KitchenQual',\n           'GarageQual', 'HeatingQC', 'PoolQC',\n           'GarageType', 'GarageFinish', 'GarageCond',\n           'BsmtCond', 'BsmtExposure', 'BsmtFinType1', \n           'BsmtFinType2', 'FireplaceQu', 'Electrical',\n           'LotShape', 'Functional', 'ExterCond',\n           'Utilities', 'PavedDrive']\n\n## Features to be one-hot encoded\nONE_HOT = ['LandSlope', 'LotConfig', 'Foundation', 'MSSubClass', 'SaleType', 'MSZoning',\n           'Neighborhood', 'MoSold', 'Condition1', 'Exterior2nd', 'BldgType', 'RoofStyle',\n           'HouseStyle', 'CentralAir', 'Heating', 'MasVnrType', 'LandContour', 'Street',\n           'Exterior1st', 'Condition2', 'SaleCondition', 'RoofMatl']\n\nQT = preprocessing.QuantileTransformer(output_distribution='normal', random_state=0)\nOHE =  preprocessing.OneHotEncoder(dtype='int', drop='first')\nORDE = preprocessing.OrdinalEncoder()\nCT = ColumnTransformer([('ohe', OHE, ONE_HOT),\n                        ('orde', ORDE, ORDINAL),\n                        ('qt', QT, N_FEATS)],\n                       remainder='drop')\n\nFEATS = N_FEATS + ORDINAL + ONE_HOT","0f564179":"# 'NA'\nNA_IMP = SimpleImputer(strategy='constant', fill_value='NA')\n# median\nMED_IMP = SimpleImputer(strategy='median')\n# most frequent\nFRQ_IMP = SimpleImputer(strategy='most_frequent')\n# 0\nZERO_IMP = SimpleImputer(strategy='constant', fill_value=0)\n# ","e03c752b":"class Garageyrblt(SimpleImputer, TransformerMixin):\n    def fit(self, X, y=None):\n        return self\n    def transform(self, X):\n        if self.copy: x = X.copy()\n        else: x = X\n        rows = x['GarageYrBlt'].isnull()\n        x.loc[rows, 'GarageYrBlt']= \\\n        x.loc[rows, 'YearBuilt']\n        return x\n    \nGYRBILT_IMP = Garageyrblt()","8911e586":"class ColumnSelector(BaseEstimator, TransformerMixin):\n    def __init__(self, columns):\n        self.columns = columns\n    def fit(self, X, y=None):\n        return self\n    def transform(self, X):\n        assert isinstance(X, pd.DataFrame)\n        return X[self.columns]\n    \nICT = FeatureUnion(n_jobs=1, transformer_list=[\n    ('na', Pipeline([\n        ('selector', ColumnSelector(['PoolQC',\n                                     'FireplaceQu',\n                                     'GarageCond',\n                                     'GarageType',\n                                     'GarageFinish',\n                                     'GarageQual',\n                                     'BsmtExposure',\n                                     'BsmtFinType2',\n                                     'BsmtFinType1',\n                                     'BsmtQual',\n                                     'BsmtCond'])),\n        ('imp', NA_IMP)])),\n    ('med', Pipeline([\n        ('selector', ColumnSelector(['LotFrontage'])),\n        ('imp', MED_IMP)])),\n    ('freq', Pipeline([\n        ('selector', ColumnSelector(['Exterior1st',\n                                     'Exterior2nd',\n                                     'MSZoning',\n                                     'Functional',\n                                     'Utilities',\n                                     'KitchenQual',\n                                     'Electrical',\n                                     'SaleType'])),\n        ('imp', FRQ_IMP)])),\n    ('gyrblt', Pipeline([\n        ('selector', ColumnSelector(['GarageYrBlt', 'YearBuilt'])),\n        ('imp', GYRBILT_IMP)])),\n    ('zero', Pipeline([\n        ('selector', ColumnSelector(['MasVnrArea',\n                                     'BsmtFullBath',\n                                     'BsmtHalfBath',\n                                     'TotalBsmtSF',\n                                     'BsmtFinSF1',\n                                     'BsmtUnfSF', \n                                     'BsmtFinSF2',\n                                     'GarageArea',\n                                     'GarageCars'])),\n        ('imp', ZERO_IMP)]))\n    ])","de4b3bc2":"REGRESSOR = TransformedTargetRegressor(regressor=LinearRegression(),\n                                       transformer=QT)","ecbc5150":"PIPELINE = Pipeline(memory=None,\n                    steps=[('imputers', ICT),\n                           ('col_trans', CT),\n                           ('linear_reg', REGRESSOR)],\n                    verbose=True)","85271215":"PIPELINE.fit(TRAIN_DATA,TRAIN_DATA['SalePrice'])","e58ef239":"test_data = TEST_DATA.copy()\ntrain_data = TRAIN_DATA.copy()\n# test + train data merge\nmerged = pd.concat([train_data, test_data], sort=True)\n\n# missing value handle\ntrain_data[949, 'BsmtExposure'] = 'No'\nMISS_VAL_IMPUTER = preprocessing.FunctionTransformer(miss_val_handler, validate=False)\n\nPIPELINE = Pipeline(memory=None,\n                    steps=[('imputer', MISS_VAL_IMPUTER),\n                           ('col_trans', CT),\n                           ('linear_reg', REGRESSOR)],\n                    verbose=True)\n\nPIPELINE.fit(merged.loc[:1460,:], merged.loc[:1460,'SalePrice'])\nprint(mean_absolute_error(TRAIN_DATA['SalePrice'],\n                          PIPELINE.predict(merged.loc[:1460,:])))","b486c380":"REGRESSOR = TransformedTargetRegressor(regressor=LinearRegression(),\n                                       transformer=QT)\n\nPIPELINE = Pipeline(memory=None,\n                    steps=[('col_trans', CT),\n                           ('linear_reg', REGRESSOR)],\n                    verbose=True)\n\nMISS_VAL_IMPUTER = preprocessing.FunctionTransformer(miss_val_handler, validate=False)\n\nPIPELINE = Pipeline(memory=None,\n                    steps=[('imputer', MISS_VAL_IMPUTER),\n                           ('col_trans', CT),\n                           ('linear_reg', REGRESSOR)],\n                    verbose=True)\n\ndef ols_regression(x_train, x_test):\n    X_train = x_train.copy()\n    X_test = x_test.copy()\n\n    # test + train data merge\n    merged = pd.concat([train_data, test_data], sort=True)\n    miss_val_handler(merged)\n    # missing value handle\n    X_train[949, 'BsmtExposure'] = 'No'\n\n    PIPELINE.fit(merged.loc[:1460,:], merged.loc[:1460,'SalePrice'])\n    print(mean_absolute_error(X_train['SalePrice'],\n                              PIPELINE.predict(merged.loc[:1460,:])))\n    \nols_regression(TRAIN_DATA, TEST_DATA)","9f1d1598":"# Imputers\n\nMake imputers from MISS_VAL dictionary.","da31c7e4":"First step of pipeline change dataframe to numpy array. so we can't use column name.","de7e5273":"# Data load and utility functions","6234a6f6":"# Pipeline","eedccbb1":"# TargetTransformer","b7cf0dc9":"# Goal\n\nMake pipeline with sklearn for later use.\n\nReference:\n[Pipelines and composite estimators](https:\/\/scikit-learn.org\/stable\/modules\/compose.html)","5109dbde":"# Summary","437bb3dd":"## Combine imputers with FeatureUnion","ec883daa":"## Class for fill_garageyrblt"}}