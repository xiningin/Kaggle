{"cell_type":{"c55f8b5b":"code","ad4debb3":"code","0eb854d5":"code","cb87ec6e":"code","41d4ab6f":"code","d5af1809":"code","5d4363c6":"code","be8c0329":"code","1696870a":"code","689db0cb":"code","815914bd":"code","c3357441":"code","64f7858e":"code","9ae34eae":"code","b2df9c3f":"code","bc3d4482":"code","ff63a190":"code","51fbb79d":"code","a1e00794":"code","3c87d1df":"code","2ccd02be":"code","111afba1":"code","a78511bd":"code","1f1af8fa":"code","fa25da8e":"code","488fa038":"code","290ea2b9":"markdown","7087546b":"markdown","826562e1":"markdown","a99d99dd":"markdown","b143f482":"markdown","f18083c8":"markdown","718e75fd":"markdown","8ef19561":"markdown","465e7a73":"markdown","bcb13782":"markdown","a7cd7947":"markdown","eee2c709":"markdown","38b23d7d":"markdown","e4378538":"markdown","5d213f91":"markdown","f82eb97d":"markdown","8ac50d00":"markdown"},"source":{"c55f8b5b":"import pandas as pd\nimport matplotlib.pyplot as plt\nimport re\nCSV_PATH = '..\/input\/tweet5foldoutputs'","ad4debb3":"df_ls = [] \nfor i in range(5):\n    df = pd.read_csv(f'{CSV_PATH}\/fold_{i}.csv')\n    df_ls.append(df)\ndf = pd.concat(df_ls)\ndf = df.drop(['Unnamed: 0'], axis=1)\ndf.head()","0eb854d5":"def jaccard(str1, str2): \n    a = set(str1.lower().split()) \n    b = set(str2.lower().split())\n    c = a.intersection(b)\n    return float(len(c)) \/ (len(a) + len(b) - len(c))\n\ndef calculate_jac(df):\n    ls = []\n    for row in df.iterrows():\n        row = row[1]\n        a = row.selected_text\n        b = row.selected_text_out\n        jac = jaccard(a,b)\n        ls.append(jac)\n    return ls","cb87ec6e":"jaccard_scores = calculate_jac(df)\ndf['jaccard'] = jaccard_scores","41d4ab6f":"df['selected_text_2'] = df['selected_text'].apply(lambda x: re.findall(r\"[\\w']+|[.,!?;]\",x))\ndf['selected_text_2_out'] = df['selected_text_out'].apply(lambda x: re.findall(r\"[\\w']+|[.,!?;]\",x))","d5af1809":"def jaccard2(a,b):\n    ls_a = []\n    ls_b = []\n    for word in a:\n        ls_a.append(word.lower())\n    for word in b:\n        ls_b.append(word.lower())\n    a = set(ls_a) \n    b = set(ls_b)\n    c = a.intersection(b)\n    denom = (len(a) + len(b) - len(c))\n    if denom == 0:\n        return 1\n    return float(len(c)) \/ denom\ndef calculate_jac2(df):\n    ls = []\n    for row in df.iterrows():\n        row = row[1]\n        a = row.selected_text_2\n        b = row.selected_text_2_out\n        jac = jaccard2(a,b)\n        ls.append(jac)\n    return ls","5d4363c6":"df['jaccard2'] = calculate_jac2(df)","be8c0329":"print(df['jaccard'].mean())","1696870a":"print(df['jaccard2'].mean())","689db0cb":"for i in range(5):\n    df_i = df[df.kfold == i]\n    jac = df_i['jaccard'].mean()\n    print(f'For out of fold {i}, jaccard is {jac}')","815914bd":"for i in range(5):\n    df_i = df[df.kfold == i]\n    jac = df_i['jaccard2'].mean()\n    print(f'For out of fold {i}, jaccard2 is {jac}')","c3357441":"df_positive = df[df['sentiment']=='positive']\ndf_negative = df[df['sentiment']=='negative']\ndf_neutral = df[df['sentiment']=='neutral']","64f7858e":"print('Jaccard for positive',df_positive['jaccard'].mean())\nprint('Jaccard for negative',df_negative['jaccard'].mean())\nprint('Jaccard for neutral',df_neutral['jaccard'].mean())","9ae34eae":"print('Jaccard2 for positive',df_positive['jaccard2'].mean())\nprint('Jaccard2 for negative',df_negative['jaccard2'].mean())\nprint('Jaccard2 for neutral',df_neutral['jaccard2'].mean())","b2df9c3f":"def print_bad_examples(df,num=10):\n    df = df.sort_values(by=['jaccard'])\n    for i in range(num):\n        row = df.iloc[i]\n        print('text:             ', row.text.strip())\n        print('selected text:    ', row.selected_text.strip())\n        print('my selected text: ',row.selected_text_out.strip())\n        print('-'*50)","bc3d4482":"def print_bad_examples2(df,num=10):\n    df = df.sort_values(by=['jaccard2'])\n    for i in range(num):\n        row = df.iloc[i]\n        print('text:             ', row.text.strip())\n        print('selected text:    ', row.selected_text.strip())\n        print('my selected text: ',row.selected_text_out.strip())\n        print('-'*50)","ff63a190":"print('Jaccard Worst Examples positive sentiment \\n')\nprint_bad_examples(df_positive)","51fbb79d":"print('Jaccard2 Worst Examples positive sentiment \\n')\nprint_bad_examples2(df_positive)","a1e00794":"print('Jaccard Worst Examples negative sentiment \\n')\nprint_bad_examples(df_negative)","3c87d1df":"print('Jaccard2 Worst Examples negative sentiment \\n')\nprint_bad_examples2(df_negative)","2ccd02be":"print('Jaccard Worst Examples neutral sentiment \\n')\nprint_bad_examples(df_neutral)","111afba1":"print('Jaccard2 Worst Examples neutral sentiment \\n')\nprint_bad_examples2(df_neutral)","a78511bd":"fig, axes = plt.subplots(nrows=1, ncols=2, figsize=(9, 3))\naxes[0].hist(df.jaccard.values)\naxes[0].set_title('Histogram of all jaccard scores')\naxes[1].hist(df.jaccard2.values)\naxes[1].set_title('Histogram of all jaccard2 scores')","1f1af8fa":"fig, axes = plt.subplots(nrows=1, ncols=2, figsize=(9, 3))\naxes[0].hist(df_neutral.jaccard.values)\naxes[0].set_title('Histogram of all neutral jaccard scores')\naxes[1].hist(df.jaccard2.values)\naxes[1].set_title('Histogram of all neutral jaccard2 scores')","fa25da8e":"fig, axes = plt.subplots(nrows=1, ncols=2, figsize=(9, 3))\naxes[0].hist(df_positive.jaccard.values)\naxes[0].set_title('Histogram of all positive jaccard scores')\naxes[1].hist(df.jaccard2.values)\naxes[1].set_title('Histogram of all positive jaccard2 scores')","488fa038":"fig, axes = plt.subplots(nrows=1, ncols=2, figsize=(9, 3))\naxes[0].hist(df_negative.jaccard.values)\naxes[0].set_title('Histogram of all negative jaccard scores')\naxes[1].hist(df.jaccard2.values)\naxes[1].set_title('Histogram of all negative jaccard2 scores')","290ea2b9":"# Lets plot the distribution of my model","7087546b":"## Bad examples for negative sentiments\nSimilar conclusion to positive. But perhaps when there are two or more sentiments in the model, the model fails to pick the one that is more intense?  \nFor example in `****` vs `pissed` and `stupid` vs `i hate`","826562e1":"## Bad examples for positive sentiments\nSeems to me here that even for bad examples the model performs fairly well and most of this can be attributed to human labelling issues.  \n'Best Model' that wins the competition might not be objectively useful as it might learn the bias of the human labellers.  \nFor example `good` and `nice` are both acceptable to me in the first\/worst example!  ","a99d99dd":"# Import stuff","b143f482":"# Calculating Jaccard scores","f18083c8":"## Jaccard2 -> Alternative calculation more resilient to noise??\nWe will name this as **jaccard2**  \nInstead of splitting just on spaces we split both on spaces AND punctuation  \nThen we calculate the jaccard scores","718e75fd":"# Experimental procedure\nModel : Roberta  \nTraining procedure: secret but very similar to [Abhishek Thakur's](https:\/\/www.kaggle.com\/abhishek) original kernel  \nThe outputs are the 5 out of fold prediction. Note that I used the best validation fold as the saved model so it will overfit this training data abit.  \nThis can be seen as the expectation on the training set when your model deals with new unseen examples.  ","8ef19561":"# Bad examples for neutral sentiments\nHere I just returned the selected text as it is. Seems to me here that most of the errors are punctuations.  \nA way to easily get higher score is to objectively truncate the punctuations such as to maximise jaccard scores.  \nSeems like some of the examples are mislabbeled sentiments. The last 5 rows are to me at least mislabelled.","465e7a73":"# Conclusion\n## For positive\/negative sentiments\nit seems like the model might miss out the context and only pick the word with the sentiment.  \nAlso when there are more than 1 sentiment in a sentence sometimes the model picks the less intense word\/span.  \n## For neutral sentiments\nPunctuations truncations or extention. Pick the optimal truncation\/extension strategy such that it maximises your jaccard scores.  \nSome mislabelled examples in training set when it is suppose to be positive or negative spotting this might result in improve of scores!\n\n## Last words\nSolving the above issues will take considerable effort and some needs to be hardcoded :(. Hardcoding in any solution in my opinion is bad as it is not generaliable to other problems. The best solution would be to solve the above problems without hardcoding any rules.","bcb13782":"# Bad examples of each sentiment","a7cd7947":"## Jaccard per fold\nNotice some difference even within each fold","eee2c709":"# See why the model fails  \nSince this is a conditional probability of predicting selected text given sentiment we should analyse by each sentiment","38b23d7d":"# Roberta error analysis\nIt is often the case in deep learning that we do abit of both random search and gradient descent. I realise alot of people including me do alot of random search but rarely do output analysis to figure out how to improve the model(aka gradient descent). The analysis here are done using [Abhishek Thakur's](https:\/\/www.kaggle.com\/abhishek) v2 folds.","e4378538":"# Analysis\n## Final Jaccard Scores","5d213f91":"# Reading and combining csv","f82eb97d":"## Final Jaccard2 Scores","8ac50d00":"## Jaccard scores for each sentiment"}}