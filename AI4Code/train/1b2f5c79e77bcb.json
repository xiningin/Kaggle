{"cell_type":{"9c3f0951":"code","d9f58a70":"code","0395b1cb":"code","2240ff69":"code","e52560ae":"code","707afc56":"code","0e90b969":"code","4f2ef9b4":"code","376a1ab6":"code","2a6fe118":"code","5d47e4a0":"markdown","a22995e6":"markdown","6c857f5b":"markdown"},"source":{"9c3f0951":"import gresearch_crypto\nimport pandas as pd\nimport numpy as np\nfrom lightgbm import LGBMRegressor\nimport xgboost as xgb\nimport traceback","d9f58a70":"path = \"\/kaggle\/input\/g-research-crypto-forecasting\/\"\ndf_train = pd.read_csv(path + \"train.csv\")\ndf_test = pd.read_csv(path + \"example_test.csv\")\ndf_asset_details = pd.read_csv(path + \"asset_details.csv\").set_index(\"Asset_ID\")\ndf_supp_train = pd.read_csv(path + \"supplemental_train.csv\")\nSEED = 137\n\nenv = gresearch_crypto.make_env()","0395b1cb":"df_asset_details","2240ff69":"used_columns = ['Count', 'Open', 'High', 'Low', 'Close',\n                'Volume', 'VWAP', 'upper_shadow', 'lower_shadow']\n#                 'Close\/Open',\n#                 'spread', 'mean_trade', 'log_price_change', 'high_div_low',\n#                 'trade', 'gtrade', 'shadow1', 'shadow3', 'shadow5', 'upper_shadow_log',\n#                 'lower_shadow_log']\n\ndef enrichment_features(df: pd.DataFrame) -> pd.DataFrame:\n    df['upper_shadow'] = df['High'] - np.maximum(df['Close'], df['Open'])\n    df['lower_shadow'] = np.minimum(df['Close'], df['Open']) - df['Low']\n#     df[\"Close\/Open\"] = df[\"Close\"] \/ df[\"Open\"]\n#     # df['hlco_ratio'] = (df['High'] - df['Low'])\/(df['Close']-df['Open'])\n#     df['spread'] = df['High'] - df['Low']\n#     df['mean_trade'] = df['Volume']\/df['Count']\n#     df['log_price_change'] = np.log(df['Close']\/df['Open'])\n#     df[\"high_div_low\"] = df[\"High\"] \/ df[\"Low\"]\n#     df['trade']=df['Close']-df['Open']\n#     df['gtrade']=df['trade']\/df['Count']\n#     df['shadow1']=df['trade']\/df['Volume']\n#     df['shadow3']=df['upper_shadow']\/df['Volume']\n#     df['shadow5']=df['lower_shadow']\/df['Volume']\n#     df['upper_shadow_log']=np.log(df['upper_shadow'])\n#     df['lower_shadow_log']=np.log(df['lower_shadow'])\n\n    return df[used_columns]","e52560ae":"# from scipy.stats import pearsonr\n\n# def log(model,X_train, X_valid, y_train, y_valid,train_split=1.0):\n#     if train_split > 0:\n#         X_train=X_train[:int(train_split*X_train.shape[0])]\n#         y_train=y_train[:int(train_split*y_train.shape[0])]\n    \n#         pred=model.predict(X_train)\n#         print('Training :- ')\n#         print(f'MSE : {np.mean((y_train-pred)**2)}')\n#         print(f'CV : {pearsonr(pred,y_train)[0]}')\n#     pred=model.predict(X_valid)\n#     print('Validation :- ')\n#     print(f'MSE : {np.mean((y_valid-pred)**2)}')\n#     print(f'CV : {pearsonr(pred,y_valid)[0]}')","707afc56":"# def validation(df_train, asset_id):\n#     asset_name = df_asset_details.iloc[asset_id][\"Asset_Name\"]\n#     df = df_train[df_train[\"Asset_ID\"] == asset_id]\n   \n#     currency_df = df_train[df_train[\"Asset_ID\"] == asset_id]\n#     currency_df = currency_df.dropna()\n#     currency_y = currency_df[\"Target\"]\n#     currency_x = enrichment_features(currency_df)\n    \n#     X_train=currency_x[:int(0.7*currency_x.shape[0])]\n#     y_train=currency_y[:int(0.7*currency_y.shape[0])]\n#     X_test=currency_x[int(0.7*currency_x.shape[0]):]\n#     y_test=currency_y[int(0.7*currency_x.shape[0]):]\n\n#     model = LGBMRegressor(**params)\n#     model.fit(X_train, y_train)\n#     print(f'[Finished Training] evaluating for {asset_name}')\n#     log(model,X_train, X_test, y_train, y_test,0.3)","0e90b969":"# validation(df_train, 2)","4f2ef9b4":"lgbm_params = {\n    \"n_estimators\": 5000,\n    \"num_leaves\" : 300,\n    \"learning_rate\" : 0.09,\n    \"random_seed\" : SEED,\n    \"n_jobs\": 4\n}\n\ndef init_model (x, y):\n    model = xgb.XGBRegressor(\n        n_estimators=500,\n        max_depth=15,\n        learning_rate=0.05,\n        subsample=0.9,\n        colsample_bytree=0.7,\n        missing=-999,\n        random_state=SEED,\n        tree_method='gpu_hist'  # use gpu\n    )\n\n    model.fit(x, y)\n\n    return model","376a1ab6":"models = {}\n\nfor asset_id in range(df_asset_details.shape[0]):\n    asset_name = df_asset_details.iloc[asset_id][\"Asset_Name\"]\n    currency_df = df_train[df_train[\"Asset_ID\"] == asset_id]\n    currency_df = currency_df.dropna()\n    \n    currency_y = currency_df[\"Target\"]\n    currency_x = enrichment_features(currency_df)\n    \n#     for column in currency_x.columns:\n#         print(column, np.max(currency_x[column]), np.max(currency_x[column]), currency_x[column].isna().sum())\n    \n    models[asset_id] = init_model(currency_x, currency_y)\n    \n    print(f\"{asset_name} model was initialized.\")","2a6fe118":"iter_test = env.iter_test()\n\nfor i, (df_test, df_pred) in enumerate(iter_test):\n    for j , row in df_test.iterrows():        \n        if models[row['Asset_ID']] is not None:\n            try:\n                model = models[row['Asset_ID']]\n                x_test = enrichment_features(row)\n                y_pred = model.predict(pd.DataFrame([x_test]))[0]\n                df_pred.loc[df_pred['row_id'] == row['row_id'], 'Target'] = y_pred\n            except:\n                df_pred.loc[df_pred['row_id'] == row['row_id'], 'Target'] = 0\n                traceback.print_exc()\n        else: \n            df_pred.loc[df_pred['row_id'] == row['row_id'], 'Target'] = 0  \n    \n    env.predict(df_pred)","5d47e4a0":"Validation test","a22995e6":"Train and submit","6c857f5b":"LGBM\n\n1000\n\n[Finished Training] evaluating for Bitcoin\nTraining :- \nMSE : 1.8713016691819038e-05\nCV : 0.47574778046270555\nValidation :- \nMSE : 1.7527629595927818e-05\nCV : 0.004341025230372545\n\n3000\n\n[Finished Training] evaluating for Bitcoin\nTraining :- \nMSE : 1.266277321245002e-05\nCV : 0.7357600141817864\nValidation :- \nMSE : 1.9788559920537545e-05\nCV : 0.002839122533392276\n\n5000\n\n[Finished Training] evaluating for Bitcoin\nTraining :- \nMSE : 7.1893931407124685e-06\nCV : 0.8870647218100292\nValidation :- \nMSE : 1.890073088293228e-05\nCV : 0.0017710093865425422"}}