{"cell_type":{"e2bfcb25":"code","d8a1ddb1":"code","dc42c70d":"code","ea2859f9":"code","fd441600":"code","6ab2f1a3":"code","345b64b1":"code","18e315fb":"code","cc1f9ff2":"code","97aa7566":"code","4cee9c1d":"code","50ae9e18":"code","4c39e0b7":"code","2e511027":"code","1295fa5e":"code","dd3ae639":"code","dc086628":"code","a21f0009":"code","6046ac8a":"code","173b2316":"code","b9b18835":"code","3d0e8e96":"code","3ec74b14":"code","a519c839":"code","6183b300":"code","cb27d995":"code","444f37d2":"code","7731b0e8":"code","3fa80d44":"markdown","998830d3":"markdown","67502410":"markdown","ebe90d00":"markdown","76f4970c":"markdown","18b71385":"markdown","24e36018":"markdown","c3343152":"markdown","5f3001de":"markdown","1c27860c":"markdown","6d45a47d":"markdown","99dcbbda":"markdown","95f7d1e9":"markdown","d5625040":"markdown","2faedf16":"markdown","0ce1f4bf":"markdown","880b9745":"markdown","975791db":"markdown","f7df5017":"markdown"},"source":{"e2bfcb25":"import numpy as np\nimport pandas as pd\nimport os\nimport matplotlib.pyplot as plt\nimport seaborn as sns\nfrom sklearn.preprocessing import LabelEncoder","d8a1ddb1":"dataset = pd.read_csv(\"..\/input\/heart-failure-clinical-data\/heart_failure_clinical_records_dataset.csv\")\nprint(np.shape(dataset))\ndataset","dc42c70d":"print(dataset['DEATH_EVENT'].value_counts())\ndataset['DEATH_EVENT'].value_counts().plot.pie(explode=[0,0.1],shadow=True,autopct='%1.1f%%',\n                                              title = 'Is patient died')","ea2859f9":"np.where(pd.isnull(dataset))","fd441600":"dataset.dtypes.value_counts()","6ab2f1a3":"dataset.describe()","345b64b1":"dataset['age'].plot.hist(title = \"Histogram of column AGE\")\nplt.xlabel('Age')","18e315fb":"dataset['creatinine_phosphokinase'].plot.hist(title = \"Histogram of column creatinine_phosphokinase\")\nplt.xlabel('Level of the CPK enzyme in the blood (mcg\/L)')","cc1f9ff2":" dataset['diabetes'].value_counts().plot.pie(explode=[0,0.1],shadow=True,autopct='%1.1f%%',\n                                       title = 'Is patiernt diabetic')","97aa7566":"dataset['ejection_fraction'].plot.hist(title = \"Histogram of column EJECTION_FRACTION\")\nplt.xlabel('Percentage of blood leaving the heart at each heart contraction')","4cee9c1d":" dataset['high_blood_pressure'].value_counts().plot.pie(explode=[0,0.1],shadow=True,autopct='%1.1f%%',\n                                       title = 'Is patiernt having hypertention')","50ae9e18":"dataset['platelets'].plot.hist(title = \"Histogram of column PLATELETS\")\nplt.xlabel('Platelets in the blood (kiloplatelets\/mL)')","4c39e0b7":"dataset['serum_creatinine'].plot.hist(title = \"Histogram of column SERUM_CREATININE\")\nplt.xlabel('Level of serum creatinine in the blood (mg\/dL)')","2e511027":"dataset['serum_sodium'].plot.hist(title = \"Histogram of column SERUM_SODIUM\")\nplt.xlabel('Level of serum sodium in the blood (mEq\/L)')","1295fa5e":" dataset['sex'].value_counts().plot.pie(explode=[0,0.1],shadow=True,autopct='%1.1f%%',\n                                       title= 'Is patient male')","dd3ae639":" dataset['smoking'].value_counts().plot.pie(explode=[0,0.1],shadow=True,autopct='%1.1f%%',\n                                       title = 'Does patient smokes')","dc086628":"dataset['time'].plot.hist(title = \"Histogram of column TIME\")\nplt.xlabel('Follow-up period (days)')","a21f0009":"corr = dataset.corr()\nf = plt.figure(figsize = (14,9))\nsns.heatmap(corr,vmax = 1,square = True,annot = True,vmin = -1)\nplt.show()","6046ac8a":"import plotly.express as px\n\nfig = px.histogram(dataset, x=\"serum_creatinine\",\n                   color=\"DEATH_EVENT\", marginal=\"rug\")\nfig.show()","173b2316":"fig = px.histogram(dataset, x=\"time\",\n                   color=\"DEATH_EVENT\", marginal=\"rug\")\nfig.show()","b9b18835":"fig = px.histogram(dataset, x=\"ejection_fraction\",\n                   color=\"DEATH_EVENT\", marginal=\"rug\")\nfig.show()","3d0e8e96":"fig = px.histogram(dataset, x=\"age\",\n                   color=\"DEATH_EVENT\", marginal=\"rug\")\nfig.show()","3ec74b14":"from sklearn.model_selection import train_test_split\n\nfeatures = ['time', 'serum_creatinine', 'ejection_fraction']\nx = dataset[features]\ny = dataset['DEATH_EVENT']\n\ntrain_x,test_x,train_y,test_y = train_test_split(x,y, test_size=0.2, random_state=30)","a519c839":"from sklearn.linear_model import LogisticRegression\nfrom sklearn.metrics import accuracy_score\n\nmodel_lr = LogisticRegression(solver='liblinear')\nmodel_lr.fit(train_x,train_y)\nlr_predict =  model_lr.predict(test_x)\nlr_accuracy = accuracy_score(test_y, lr_predict)\nprint('Accuracy for model using  Linear Regression: ', lr_accuracy*100 , \"%\")","6183b300":"from sklearn.metrics import confusion_matrix\nfrom sklearn.metrics import plot_confusion_matrix\nfrom sklearn.metrics import fbeta_score\n\nplt.figure()\nplot_confusion_matrix(model_lr,test_x, test_y)  \nplt.title(\"Confusion Matrix - Linear Regression Model\")\nplt.xticks(range(2), [\"Heart Not Failed\",\"Heart Fail\"], fontsize=16)\nplt.yticks(range(2), [\"Heart Not Failed\",\"Heart Fail\"], fontsize=16)\nplt.show()\n\nprint('F-Beta score for beta = 2 is ', fbeta_score(test_y, lr_predict, beta=2)*100, '%')","cb27d995":"from sklearn.neighbors import KNeighborsClassifier\n\nmodel_kn = KNeighborsClassifier(n_neighbors=5)\nmodel_kn.fit(train_x,train_y)\nkn_predict =  model_kn.predict(test_x)\nkn_fbeta = fbeta_score(test_y, kn_predict, beta=2)\nkn_accuracy = accuracy_score(test_y, lr_predict)\nprint('Accuracy for model using K-Neighbors Classifier: ', kn_accuracy*100 , \"%\")\nprint('F-Beta score for beta = 2 is ', kn_fbeta*100, '%')\n\nplt.figure()\nplot_confusion_matrix(model_kn,test_x, test_y)  \nplt.title(\"Confusion Matrix - K-Neighbors Classifier\")\nplt.xticks(range(2), [\"Heart Not Failed\",\"Heart Fail\"], fontsize=16)\nplt.yticks(range(2), [\"Heart Not Failed\",\"Heart Fail\"], fontsize=16)\nplt.show()","444f37d2":"from optuna.samplers import TPESampler\nimport optuna\nfrom sklearn.metrics import f1_score\nfrom sklearn.metrics import precision_score\nfrom sklearn.metrics import recall_score\n\ndef create_model(trial):\n    n_neighbors = trial.suggest_int(\"n_neighbors\", 3, 15)\n    p = trial.suggest_int(\"p\", 1, 2)\n    \n    model = KNeighborsClassifier(\n        n_neighbors=n_neighbors, \n        p=p,\n    )\n    return model\n\nsampler = TPESampler(seed=30)\n\ndef objective(trial):\n    model = create_model(trial)\n    model.fit(train_x, train_y)\n    preds = model.predict(test_x)\n    return fbeta_score(test_y, preds, beta=2)\n\nstudy = optuna.create_study(direction=\"maximize\", sampler=sampler)\nstudy.optimize(objective, n_trials=200)\n\nkn_params = study.best_params\nkn = KNeighborsClassifier(**kn_params)\nkn.fit(train_x, train_y)\npreds = kn.predict(test_x)\n\n\nprint('Optimized KNeighborsClassifier accuracy: ', accuracy_score(test_y, preds))\nprint('Optimized KNeighborsClassifier f1-score', f1_score(test_y, preds))\nprint('Optimized KNeighborsClassifier f2-score', fbeta_score(test_y, preds,beta=2))\nprint('Optimized KNeighborsClassifier precision', precision_score(test_y, preds))\nprint('Optimized KNeighborsClassifier recall', recall_score(test_y, preds))","7731b0e8":"plt.figure()\nplot_confusion_matrix(kn,test_x, test_y)  \nplt.title(\"Confusion Matrix - K-Neighbors Classifier\")\nplt.xticks(range(2), [\"Heart Not Failed\",\"Heart Fail\"], fontsize=16)\nplt.yticks(range(2), [\"Heart Not Failed\",\"Heart Fail\"], fontsize=16)\nplt.show()","3fa80d44":"Wszystkie pomiary to warto\u015bci liczbowe, dzi\u0119ki temu nie musimy kodowa\u0107 zmiennych kategorycznych.","998830d3":"\u015amiertelno\u015b\u0107 bior\u0105c pod uwag\u0119 wiek i analizuj\u0105c poni\u017cszy wykres, jak mo\u017cna by\u0142o si\u0119 spodziewa\u0107, wzrasta wraz z ilo\u015bci\u0105 lat pacjenta. Powy\u017cej 70lat wynosi ponad 50 punkt\u00f3w procentowych.","67502410":"Przy wykresie bior\u0105cym pod uwag\u0119 czas, mo\u017cemy zauwa\u017cy\u0107 \u017ce wi\u0119kszo\u015b\u0107 pacjent\u00f3w zmar\u0142o podczas pierwszych 100 dni leczenia.","ebe90d00":"Teraz sprawdzimy czy wszystkie dane wygl\u0105daj\u0105 na prawid\u0142owe. U\u017cyjemy do tego metody `describe()`. Na pierwszy rzut oka \u017cadne skrajne warto\u015bci w kolumnach nie odbiegaj\u0105 znacz\u0105co od normy, ale warto przyjrze\u0107 si\u0119 im bli\u017cej przy wizualizacji.","76f4970c":"Teraz gdy ju\u017c zapoznali\u015bmy si\u0119 bardzien z naszym zbiorem danych mo\u017cemy przej\u015b\u0107 do podzia\u0142u na zbi\u00f3r treningowy oraz testowy. Niestety nie posiadamy zbyt du\u017co danych, podzielimy zbi\u00f3r 80:20 aby nasz model mia\u0142 wystarczaj\u0105c\u0105 ilo\u015b\u0107 informacji do treningu.","18b71385":"Po optymalizacji otrzymali\u015bmy model kt\u00f3rego wynik miary F2 wynosi 70% a trafno\u015b\u0107 85%, czyli poprawili\u015bmy oba wyniki. Sprawd\u017amy tablic\u0119 pomy\u0142ek naszego modelu.","24e36018":"Na pocz\u0105tek wypr\u00f3bujmy model korzystaj\u0105cy z regresji logistycznej. Domy\u015blnie korzysta ona z normy L2. Parametr `solver` ustawimy na 'liblinear' poniewa\u017c nasz zbi\u00f3r jest ma\u0142y a problem nie jest bardzo z\u0142o\u017cony. ","c3343152":"Po og\u00f3lnej analizie naszego zbioru danych przechodzimy do por\u00f3wnania cech kt\u00f3re najbardziej wp\u0142ywaj\u0105 na \u015bmier\u0107 z kolumn\u0105 `DEATH_EVENT`\n\nJak mo\u017cna zauwa\u017cy\u0107 na poni\u017cszym wykresie dla kreatyniny w surowicy, widzimy \u017ce przy pomiarach zbli\u017conych zeru pacjenci mieli du\u017co wi\u0119ksz\u0105 szans\u0119 na prze\u017cycie. Przy wy\u017cszych wynikach r\u00f3\u017cnica zanika, a dla pomiar\u00f3w ponad 6ty\u015b jednostek wszyscy pacjenci zmarli.\n","5f3001de":"Gdy zapoznali\u015bmy si\u0119 ju\u017c dok\u0142adniej z danymi, warto by\u0142oby utworzy\u0107 macierz korelacji pomi\u0119dzy nimi. Z utworzonej poni\u017cej macierzy widzimy \u017ce cztery pomiary kt\u00f3re maj\u0105 najwi\u0119ksz\u0105 korelacje z warto\u015bci\u0105 kolumny `DEATH_EVENT` to\n* `time`(-0.53) oraz `ejection_fraction`(-0,27) - Ujemna korelacja\n* `serum_creatinine` (0.29) oraz `age` (0.25) - Dodatnia korelacja","1c27860c":"# Podsumowanie\n\nNajlepszym modelem z przeze mnie wybranych okaza\u0142 si\u0119 model korzystaj\u0105cy z algorytmu KNeighborsClassifier (K-Najbli\u017cszych s\u0105siad\u00f3w). Po optymalizacji uda\u0142o si\u0119 mu uzyska\u0107 wynik \n* `85%` trafno\u015bci (accuracy score)\n* `75%` miary f1\n* `70%` miary fbeta przy beta=2\n\nNie s\u0105 to mo\u017ce wyniki klasy \u015bwiatowej, ale jestem zadowolony \u017ce uda\u0142o mi si\u0119 zmaksymalizowa\u0107 mo\u017cliwo\u015bci modelu na miar\u0119 moich umiej\u0119tno\u015bci. Du\u017co \u0142atwiej pracowa\u0142oby si\u0119 na zbiorze z wi\u0119ksz\u0105 ilo\u015bci\u0105 danych ale nie zawsze jest to mo\u017cliwe. Patrz\u0105c na inne notebooki wi\u0119kszo\u015b\u0107 z nich przyk\u0142ada\u0142a du\u017c\u0105 uwag\u0119 do accuracy co w przypadku naszego problemu nie ma tak du\u017cego znaczenia jak miara f2, dlatego te\u017c postanowi\u0142em na maksymalizacje tej miary.","6d45a47d":"Jak mo\u017cemy zauwa\u017cy\u0107 poni\u017cej nasze dane tabelaryczne s\u0105 pe\u0142ne i nie zawieraj\u0105 \u017cadnych pustych wpis\u00f3w co u\u0142atwia nam prac\u0119.","99dcbbda":"Warto przyjrze\u0107 si\u0119 tablicy pomy\u0142ek dla naszego naszego modelu. Jak widzimy poni\u017cej nasz model radzi sobie nienajgorze. Na 60 przypadk\u00f3w 12 razy zdiagnozowa\u0142 \u017ce serce nie powinno stan\u0105\u0107, a w rzeczywisto\u015bci by\u0142o odwrotnie. Z racji \u017ce problem rozgrywa si\u0119 o ludzkie \u017cycie lepiej by\u0142o by czasami fa\u0142szywie zaalarmowa\u0107 o mo\u017cliwo\u015bci \u015bmierci ni\u017c zapewni\u0107 \u017ce wszystko powinno by\u0107 w porz\u0105dku. Potrzebna nam wi\u0119ksza czu\u0142o\u015b\u0107. W tym przypadku aby mierzy\u0107 poprawno\u015b\u0107 naszego modelu mo\u017cemy korzysta\u0107 r\u00f3wnie\u017c z miary F-Beta kt\u00f3ra pozwala nam regulowa\u0107 balans miedzy precyzja a czu\u0142o\u015bci\u0105, parametr Beta to waga czu\u0142o\u015bci. Jak mo\u017cemy zauwa\u017cy\u0107 gdy traktujemy czu\u0142o\u015b\u0107 jako 2 razy wa\u017cniejsz\u0105 od precyzji nasz wynik jest bliski 0.6 co ju\u017c nie jest tak satysfakcjonuj\u0105cym wynikiem jak powy\u017cszy.","95f7d1e9":"Z racji ma\u0142ego zbioru danych zmiana nie jest bardzo widoczna, ale to wci\u0105\u017c jedno potencjalnie uratowane \u017cycie wi\u0119cej, wi\u0119c powinni\u015bmy by\u0107 zadowoloni z poprawy naszego wyniku. ","d5625040":"Przy bardzo niskiej frakcji wyrzutowej pacjenci byli najbardziej nara\u017ceni na \u015bmier\u0107, przy wy\u017cszych wynikach \u015bmiertelne przypadki stanowi\u0105 ju\u017c ma\u0142y u\u0142amek.","2faedf16":"Spr\u00f3bujmy w takim razie prosto zoptymalizowa\u0107 algorytm pod k\u0105tem miary F2. Model nie jest bardzo z\u0142o\u017cony wi\u0119c jedynymi parametrami do optymalizacji w naszym algorytmie b\u0119d\u0105 liczba s\u0105siad\u00f3w (minimalnie 3, dla 1 model by\u0142by na pewno przeuczony), oraz p czyli wyb\u00f3r metryki. ","0ce1f4bf":"Zmniejszenie si\u0142y regularyzacji poprawi\u0142oby po\u015brednio nasz\u0105 czu\u0142o\u015b\u0107 ale model prawdopodobnie uleg\u0142by przeuczeniu, dlatego te\u017c p\u00f3ki co spr\u00f3bujemy wykorzysta\u0107 inny model,mianowicie K-najbli\u017cszych s\u0105siad\u00f3w, domy\u015blnie k=5. Co\u015b co od razu rzuca si\u0119 w oczy to, to \u017ce trafno\u015b\u0107 obu modeli jest r\u00f3wna (80%) natomiast miara F-Beta dla Beta=2 uleg\u0142a poprawie. Model w tym przypadku jest bardziej czu\u0142y, co w naszym problemie jest bardzo istotne. Co ciekawe, zauwa\u017cy\u0142em \u017ce przy zmniejszeniu liczby s\u0105siad\u00f3w miara F-Beta wzrasta jeszcze bardziej, ale jest to spowodowane, podobnie jak w przypadku zmiany si\u0142y regularyzacji, przeuczeniem modelu.","880b9745":"Skupmy si\u0119 na chwil\u0119 na kolumnie `DEATH_EVENT` i sprawd\u017amy ile pacjent\u00f3w zawartych w tabeli zmar\u0142o.","975791db":"# Heart Failure Precition - Projekt Podstawy Uczenia Maszynowego Laboratorum","f7df5017":"Wczytujemy nasz zb\u00f3r danych, jak mo\u017cemy wywnioskowa\u0107 zbi\u00f3r sk\u0142ada si\u0119 z danych odnosz\u0105cych si\u0119 do 299 pacjent\u00f3w. Posiadamy 12 r\u00f3\u017cnych kolumn z informacjami na temat stanu zdrowia pacjenta oraz kolumn\u0119 `DEATH_EVENT` binarnie opisuj\u0105c\u0105 czy pacjent zmar\u0142 czy nie. (1 - je\u017celi zmar\u0142)"}}