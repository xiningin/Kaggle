{"cell_type":{"2be4afe9":"code","e6ab3a8b":"code","9a5f6952":"code","07933e7c":"code","afe837ba":"code","040ecf9f":"markdown","373c7d97":"markdown","997b6032":"markdown","b0b2848a":"markdown"},"source":{"2be4afe9":"import pandas as pd\nimport numpy as np\nimport gc\nfrom sklearn.model_selection import KFold\nfrom sklearn.preprocessing import RobustScaler\nfrom keras.utils.vis_utils import plot_model\nfrom tensorflow import distribute\nfrom tensorflow.keras import layers\nfrom tensorflow.keras import backend\nfrom tensorflow.keras.optimizers import Adam\nfrom tensorflow.keras.models import Sequential\nfrom tensorflow.keras.models import load_model\nfrom tensorflow.keras.callbacks import EarlyStopping\nfrom tensorflow.keras.callbacks import ModelCheckpoint\nfrom tensorflow.keras.callbacks import ReduceLROnPlateau","e6ab3a8b":"def features(df):\n    df['area'] = df['time_step'] * df['u_in']\n    df['area'] = df.groupby('breath_id')['area'].cumsum()\n    df['u_in_cumsum'] = (df['u_in']).groupby(df['breath_id']).cumsum()\n    df['u_in_lag1'] = df.groupby('breath_id')['u_in'].shift(1)\n    df['u_out_lag1'] = df.groupby('breath_id')['u_out'].shift(1)\n    df['u_in_lag_back1'] = df.groupby('breath_id')['u_in'].shift(-1)\n    df['u_out_lag_back1'] = df.groupby('breath_id')['u_out'].shift(-1)\n    df['u_in_lag2'] = df.groupby('breath_id')['u_in'].shift(2)\n    df['u_out_lag2'] = df.groupby('breath_id')['u_out'].shift(2)\n    df['u_in_lag_back2'] = df.groupby('breath_id')['u_in'].shift(-2)\n    df['u_out_lag_back2'] = df.groupby('breath_id')['u_out'].shift(-2)\n    df['u_in_lag3'] = df.groupby('breath_id')['u_in'].shift(3)\n    df['u_out_lag3'] = df.groupby('breath_id')['u_out'].shift(3)\n    df['u_in_lag_back3'] = df.groupby('breath_id')['u_in'].shift(-3)\n    df['u_out_lag_back3'] = df.groupby('breath_id')['u_out'].shift(-3)\n    df['u_in_lag4'] = df.groupby('breath_id')['u_in'].shift(4)\n    df['u_out_lag4'] = df.groupby('breath_id')['u_out'].shift(4)\n    df['u_in_lag_back4'] = df.groupby('breath_id')['u_in'].shift(-4)\n    df['u_out_lag_back4'] = df.groupby('breath_id')['u_out'].shift(-4)\n    df['breath_id__u_in__max'] = df.groupby(['breath_id'])['u_in'].transform('max')\n    df['breath_id__u_in__diffmax'] = df.groupby(['breath_id'])['u_in'].transform('max')-df['u_in']\n    df['breath_id__u_in__diffmean'] = df.groupby(['breath_id'])['u_in'].transform('mean') - df['u_in']\n    df['u_in_diff1'] = df['u_in']-df['u_in_lag1']\n    df['u_out_diff1'] = df['u_out']-df['u_out_lag1']\n    df['u_in_diff2'] = df['u_in']-df['u_in_lag2']\n    df['u_out_diff2'] = df['u_out']-df['u_out_lag2']\n    df['u_in_diff3'] = df['u_in']-df['u_in_lag3']\n    df['u_out_diff3'] = df['u_out']-df['u_out_lag3']\n    df['u_in_diff4'] = df['u_in']-df['u_in_lag4']\n    df['u_out_diff4'] = df['u_out']-df['u_out_lag4']\n    df['cross']= df['u_in']*df['u_out']\n    df = df.fillna(0)\n    df['R'] = df['R'].astype(str)\n    df['C'] = df['C'].astype(str)\n    df['R__C'] = df[\"R\"].astype(str)+'__'+df[\"C\"].astype(str)\n    df = pd.get_dummies(df)\n    return df","9a5f6952":"train = pd.read_csv('..\/input\/ventilator-pressure-prediction\/train.csv')\ntest = pd.read_csv('..\/input\/ventilator-pressure-prediction\/test.csv')\nsubmission = pd.read_csv('..\/input\/ventilator-pressure-prediction\/sample_submission.csv')\n\npressure_values = np.sort(train.pressure.unique())\ntrain = features(train)\ntest = features(test)\ntrain = train.fillna(0)\ntest = test.fillna(0)\ntargets = train[['pressure']].to_numpy().reshape(-1, 80)\ntrain = train.drop(['pressure', 'id', 'breath_id', 'u_out', 'time_step'], axis=1)\ntest = test.drop(['id', 'breath_id', 'u_out', 'time_step'], axis=1)\ncols = list(train.columns)\n\nscaler = RobustScaler()\ntrain = scaler.fit_transform(train)\ntest = scaler.transform(test)\n\ntrain = train.reshape(-1, 80, train.shape[-1])\ntest = test.reshape(-1, 80, train.shape[-1])","07933e7c":"model = load_model('..\/input\/ventilatorpretrained\/fold1.hdf5')\nplot_model(model, to_file='model.png', show_shapes=True, show_layer_names=True)","afe837ba":"del model\ngc.collect()\n\nepochs = 200\nbatch_size = 16\nn_splits = 5\nimport_pre_trained = True\none_fold = True\ncreate_sub = False\n\ngpu_strategy = distribute.get_strategy()\n\nwith gpu_strategy.scope():\n    kf = KFold(n_splits=n_splits, shuffle=True, random_state=42)\n    test_preds = []\n    for fold, (train_idx, test_idx) in enumerate(kf.split(train, targets)):\n        backend.clear_session()\n        X_train, X_valid = train[train_idx], train[test_idx]\n        y_train, y_valid = targets[train_idx], targets[test_idx]\n        checkpoint_filepath = f\"fold{fold+1}.hdf5\"\n        if import_pre_trained:\n            model = load_model('..\/input\/ventilatorpretrained\/fold1.hdf5')\n        else:\n            model = Sequential([\n                layers.Input(shape = train.shape[-2:]),\n                layers.Bidirectional(layers.LSTM(512, return_sequences=True)),\n                layers.Bidirectional(layers.LSTM(512, return_sequences=True)),\n                layers.Dense(64, activation='selu'),\n                layers.Dense(1)])\n        optimizer = Adam(learning_rate=0.0002)\n        model.compile(optimizer=optimizer, loss=\"mae\")\n        lr = ReduceLROnPlateau(factor=0.5, patience=3, verbose=1)\n        es = EarlyStopping(patience=6, restore_best_weights=True)\n        sv = ModelCheckpoint(checkpoint_filepath, save_best_only=True, verbose=1)\n        print(f'-------------> Fold {fold+1} <-------------')\n        model.fit(X_train, y_train, validation_data=(X_valid, y_valid),\n                  epochs=epochs, batch_size=batch_size, callbacks=[lr, es, sv])\n        test_preds.append(model.predict(test).squeeze().reshape(-1, 1).squeeze())\n        del model, X_train, X_valid\n        gc.collect()\n        if one_fold:\n            break\n\nif create_sub:\n    pressure_min = pressure_values[0]\n    pressure_max = pressure_values[-1]\n    pressure_step = pressure_values[1] - pressure_values[0]\n    submission[\"pressure\"] = np.median(np.vstack(test_preds),axis=0)\n    submission['pressure'] = np.round((submission['pressure']-pressure_min)\/pressure_step)*pressure_step+pressure_min\n    submission['pressure'] = np.clip(submission['pressure'], pressure_min, pressure_max)\n    submission.to_csv('submission.csv', index=False)","040ecf9f":"# Imports","373c7d97":"# Read and Pre-Process Data","997b6032":"# Model","b0b2848a":"# Helper Function"}}