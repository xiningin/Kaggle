{"cell_type":{"10ed570e":"code","2a62e4ff":"code","a324ced8":"code","aa553086":"code","8e198e96":"code","09bb180c":"code","894ec1e7":"markdown","c4bc9a63":"markdown","4908ad91":"markdown","111cf5f1":"markdown","3e069835":"markdown","03f2b227":"markdown"},"source":{"10ed570e":"import os\nimport json\nimport numpy as np\nimport pandas as pd\nimport gc\nfrom pandas.io.json import json_normalize\n\n# Visualization\nimport seaborn as sns\nimport matplotlib.pyplot as plt\nfrom IPython.display import display\n%matplotlib inline\n\nfrom sklearn import preprocessing\n\n# Load Function by Julian - https:\/\/www.kaggle.com\/julian3833\/1-quick-start-read-csv-and-flatten-json-fields\/notebook\ndef load_df(csv_path='..\/input\/train.csv', nrows=None):\n    JSON_COLUMNS = ['device', 'geoNetwork', 'totals', 'trafficSource']\n    \n    df = pd.read_csv(csv_path, \n                     converters={column: json.loads for column in JSON_COLUMNS}, \n                     dtype={'fullVisitorId': 'str'}, # Important!!\n                     nrows=nrows)\n    \n    for column in JSON_COLUMNS:\n        column_as_df = json_normalize(df[column])\n        column_as_df.columns = [f\"{column}.{subcolumn}\" for subcolumn in column_as_df.columns]\n        df = df.drop(column, axis=1).merge(column_as_df, right_index=True, left_index=True)\n    print(f\"Loaded {os.path.basename(csv_path)}. Shape: {df.shape}\")\n    return df","2a62e4ff":"%%time\ndebug = False\nif debug is True: nrows = 5000\nelse: nrows = None\n\ntrain_df = load_df(nrows = nrows)\ntest_df = load_df(\"..\/input\/test.csv\", nrows = nrows)\n\ndisplay(train_df.sample(4))","a324ced8":"train_df[\"totals.transactionRevenue\"] = train_df[\"totals.transactionRevenue\"].astype('float')\ngdf = train_df.groupby(\"fullVisitorId\")[\"totals.transactionRevenue\"].sum().reset_index()\n\nplt.figure(figsize=(8,6))\nplt.scatter(range(gdf.shape[0]), np.sort(np.log1p(gdf[\"totals.transactionRevenue\"].values)))\nplt.xlabel('index', fontsize=12)\nplt.ylabel('TransactionRevenue', fontsize=12)\nplt.show()\n\n# Distinguish Groups\nspending_visitors = gdf.loc[gdf[\"totals.transactionRevenue\"] > 0, \"fullVisitorId\"]","aa553086":"# Dropping columns with singular outcome (including NA)\ndrop_cols = [c for c in train_df.columns if train_df[c].nunique(dropna=False)==1 ]\nprint(\"Columns with one outcome to drop:\\nCount: \", len(drop_cols),\"\\n\",drop_cols)\ntrain_df.drop(drop_cols, axis = 1, inplace = True)\ntest_df.drop([x for x in drop_cols if x in test_df.columns], axis = 1, inplace = True)\n\n# Isolate Dependent Variable and Merge\ny_name = 'totals.transactionRevenue'\nprint(\"Dependent Variable Name: \", y_name)\ny = train_df[y_name]\ntrain_df.drop(y_name, axis= 1, inplace= True)\n\n# Create Train\/Test Variable..\ntrain_df[\"istrain\"] = True\ntest_df[\"istrain\"] = False\n\n# Align Train \/ Test Columns\nnotintest = set(train_df.columns).difference(set(test_df.columns))\nprint(\"Variables not in test but in train : \", notintest)\ntrain_df.drop(notintest, axis=1, inplace=True)\n\n# Combine Train Test and Remove High Missing..\nprint(\"Test and Train columns Match?: \", all(train_df.columns == test_df.columns))\ndf = pd.concat([train_df, test_df], axis = 0)\ndel train_df, test_df; gc.collect();\n\n# Remove columns with high missing count\nhigh_miss_cols = [c for c in df.columns if df[c].isnull().sum() > (df.shape[0]*.5)]\nprint(\"High Missing Count Columns (50% + Miss):\\n\", high_miss_cols)\ndf.drop(high_miss_cols, axis =1, inplace= True)","8e198e96":"# Remake Train Set now that processing is done..\ntrain = pd.concat([df.loc[df[\"istrain\"] == True, :], y], axis = 1)\ntrain[\"spender\"] = False\ntrain.loc[train[\"fullVisitorId\"].isin(spending_visitors), \"spender\"] = True\n\n# Categorical Variables to Explore\ncategorical_vars = [\"channelGrouping\", \"device.browser\", \"device.deviceCategory\",\"device.isMobile\",\n                    \"device.operatingSystem\",\"geoNetwork.city\",\"geoNetwork.continent\",\"geoNetwork.country\",\n                    \"geoNetwork.metro\",\"geoNetwork.region\",\"geoNetwork.subContinent\"]\n\n# Colored CrossTab\nfor cols in categorical_vars:\n    print(\"{}\".format(cols.title()))\n    temp = pd.crosstab(train[cols], train[\"spender\"], dropna=False, normalize = \"index\").mul(100).round(2)\n    temp = temp.sort_values(by=True,ascending= False)[:10]\n    display(temp.style.background_gradient(cmap = sns.light_palette(\"purple\", as_cmap=True)))","09bb180c":"train[\"spender\"] = train[\"spender\"].astype(\"int\") # Binary\nprint(\"Browser and Grouping\")\ndisplay(pd.pivot_table(train, values=\"spender\",index=\"device.browser\",columns=\"channelGrouping\").mul(100).round(2).style.background_gradient(cmap = sns.light_palette(\"red\", as_cmap=True)))\nprint(\"Device and Grouping\")\ndisplay(pd.pivot_table(train, values=\"spender\",index=\"device.deviceCategory\",columns=\"channelGrouping\").mul(100).round(2).style.background_gradient(cmap = sns.light_palette(\"blue\", as_cmap=True)))\nprint(\"Is Mobile and Grouping\")\ndisplay(pd.pivot_table(train, values=\"spender\",index=\"device.isMobile\",columns=\"channelGrouping\").mul(100).round(2).style.background_gradient(cmap = sns.light_palette(\"orange\", as_cmap=True)))","894ec1e7":"### Next\n- Explore the continuous variables","c4bc9a63":"## What Makes a Super Spender? Explore Categorical Variables\n\nWhat are the subcategory characteristics of super spenders? This is what these table showcase. Units are **Percentages**. Looking at the **True** columns, the **higher** the percentage, the **more** superspenders in the category.\n\nLimitations: Class representation is not balanced, therefore this may over-emphasize unusual classes.","4908ad91":"## Minority Super-Spenders\n\nNoticing this stark contrast in customers, I want to explore the data in terms of spenders and non-spenders. My hopes is to capture the bigger picture.","111cf5f1":"## *What Makes a Super Spender?*\n_By Nick Brooks, September 2018_\n\nBuilding off what I learned from the SRK's [notebook](https:\/\/www.kaggle.com\/sudalairajkumar\/simple-exploration-baseline-ga-customer-revenue)..","3e069835":"## Deeper Multivariate Interactions","03f2b227":"## Pre-Processing"}}