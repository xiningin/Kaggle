{"cell_type":{"83ca0321":"code","bfdc8bfa":"code","c733500b":"code","6cc2b0a6":"code","414422a6":"code","7c47fafb":"code","78bf072e":"code","c042e915":"code","2182dd38":"code","1403fe4b":"code","f676bb89":"code","a7527f27":"code","6b2d2780":"code","cb21dc97":"code","82bef977":"markdown","4b075760":"markdown","2609860c":"markdown","d3a3ddc9":"markdown","5d295db9":"markdown","673f3dea":"markdown","4c98102d":"markdown","7a0a390e":"markdown","48a96611":"markdown","24f2945a":"markdown","cba46582":"markdown","43df70b8":"markdown","c22d7588":"markdown"},"source":{"83ca0321":"import matplotlib.pyplot as plt #Matplotlib allows us to draw graphs\nimport numpy as np #Numpy allows us to perform complex mathematical processes quickly\nimport pandas as pd #Pandas is another useful set of tools for statistics\nimport datetime\nfrom fbprophet import Prophet","bfdc8bfa":"energy = pd.read_csv('..\/input\/school-smartmeter-data\/meter-amr-readings-1200050359109.csv')\nenergy.head()","c733500b":"energy = pd.melt(energy, id_vars=['Reading Date', 'One Day Total kWh', 'Status', 'Substitute Date'], var_name='Time', value_name=\"Energy\")\nenergy.head()","6cc2b0a6":"energy['Timestamp'] = pd.to_datetime(energy['Reading Date'] + \" \" + energy['Time'], format='%Y-%m-%d %H:%M')\nprint('Start of data collection: ', energy['Timestamp'].min())\nprint('End of data collection: ', energy['Timestamp'].max())\nenergy = energy.sort_values(by=['Timestamp'])\n\n# energy['Timestamp'] = energy['Timestamp'].mask(energy['Timestamp'].dt.year == 2020, energy['Timestamp'] + pd.offsets.DateOffset(year=2021))\nenergy = energy[(energy['Timestamp']>\"2021-05-27\")]\n# energy = energy[(energy['Timestamp']>\"2021-05-27\") & (energy['Timestamp']<\"2021-06-08\")]\nenergy.head()\n","414422a6":"arduino = pd.read_csv('..\/input\/supplemental-data\/all_arduino_data_trim.csv')\n\narduino_location = 'STAFF'\n# choose from ['Temperature', 'Light values', 'Motion detected ']\ndata_type = 'Motion detected '\n\narduino_id = arduino_location + \"_\" + data_type\n\n# edit the column name to pick out your dataset\narduino_data = arduino[['Timestamp',arduino_id]]\narduino_data['Timestamp'] = pd.to_datetime(arduino_data['Timestamp'], format='%Y-%m-%d %H:%M')\n\nprint('\\n\\nStart of data collection: ', arduino_data['Timestamp'].min())\nprint('End of data collection: ', arduino_data['Timestamp'].max())\nprint(arduino_data.head())\n","7c47fafb":"fig, ax1 = plt.subplots(figsize=(15, 6))\nplt.xticks( rotation=25 )\nax2 = ax1.twinx()  \n\nax1.plot(arduino_data['Timestamp'], arduino_data[arduino_id], color='blue')\nax1.set_xlabel('Time')\nax1.set_ylabel(data_type)\nax1.legend([data_type], loc=\"upper left\")\n\nax2.plot(energy['Timestamp'], energy['Energy'], color='red')\nax2.set_ylabel('Energy use')\nax2.legend(['Energy use'], loc='upper right')\n","78bf072e":"train_data = energy[['Timestamp', 'Energy']][(energy['Timestamp']> \"2021-05-27 13:00:00\") & (energy['Timestamp']< \"2021-06-08\")]\ntest_data = energy[['Timestamp', 'Energy']][(energy['Timestamp']> \"2021-06-08\") & (energy['Timestamp']< \"2021-06-10\")]\n\n# We can use the Python 'merge' function to add the Arduino data as a column to the energy data frame\n\ntrain_data_arduino = train_data.merge(arduino_data, on='Timestamp')\ntest_data_arduino = test_data.merge(arduino_data, on='Timestamp')\n\ntrain_data.columns = ['ds', 'y']\ntest_data.columns = ['ds', 'y']\ntrain_data_arduino.columns = ['ds', 'y', data_type]\ntest_data_arduino.columns = ['ds', 'y', data_type]\n","c042e915":"model = Prophet(daily_seasonality=True, weekly_seasonality=True)\nmodel.fit(train_data)\n\nforecast = model.predict(test_data)\nfig = model.plot(forecast)\n","2182dd38":"fig = model.plot_components(forecast)","1403fe4b":"model_plus = Prophet(daily_seasonality=True, weekly_seasonality=True)\nmodel_plus.add_regressor(data_type)\nmodel_plus.fit(train_data_arduino)\n\nforecast_plus = model_plus.predict(test_data_arduino)\nfig = model_plus.plot(forecast_plus)\n","f676bb89":"fig = model_plus.plot_components(forecast)","a7527f27":"plt.scatter(x=test_data['y'], y=forecast['yhat'], alpha=0.5, label='Basic energy model')\nplt.plot([-20,140],[-20,140], ls=\"--\", c=\".3\") \n# plt.xlim(-20,140)\n# plt.ylim(-20,140)\nplt.xlabel('Real energy use')\nplt.ylabel('Predicted energy use')\n\nplt.scatter(x=test_data['y'], y=forecast_plus['yhat'], alpha=0.5, label='Model with Arduino data')\nplt.plot([-20,140],[-20,140], ls=\"--\", c=\".3\") \n# plt.xlim(-20,140)\n# plt.ylim(-20,140)\nplt.xlabel('Real energy use')\nplt.ylabel('Predicted energy use')\nplt.legend()","6b2d2780":"fig, ax1 = plt.subplots()\n# rotate the date labels so they don't overlap\nplt.xticks( rotation=25 )\n# set up the 2nd axis\nax2 = ax1.twinx()  \n\nax1.plot(test_data['ds'], test_data['y'], color='red')\nax1.set_xlabel('Timestamp')\nax1.set_ylabel('Energy use')\n\nax1.plot(forecast['ds'], forecast['yhat'], color='blue')\nax1.legend(['Energy use', 'Predicted energy use'], loc='upper right')\n","cb21dc97":"fig, ax1 = plt.subplots()\n# rotate the date labels so they don't overlap\nplt.xticks( rotation=25 )\n\nax1.plot(test_data['ds'], test_data['y'], color='red')\nax1.set_xlabel('Timestamp')\nax1.set_ylabel('Energy use')\n\nax1.plot(forecast_plus['ds'], forecast_plus['yhat'], color='blue')\nax1.legend(['Energy use', 'Predicted energy use'], loc='upper right')\n","82bef977":"Next, we can plot real and predicted energy use over time for the model with no Arduino data. ","4b075760":"# Step 2 - Comparing the data\n\n","2609860c":"# Step 1 - Loading libraries and data","d3a3ddc9":"Now, we can read in the extra data you've collected with you Arduinos.","5d295db9":"We can compare the forecasted energy use values to real energy use for the same time period. First we can use a scatter plot to view the correlation between forecasted and real rates. We can add a diagonal line to show where points should fall if they are a perfect prediction. ","673f3dea":"In this lesson, we will read in the data collected from the Arduinos, and see if it improves predictions. ","4c98102d":"We can break the model down into different components - an overall trend, weekly trend, yearly trend, and daily trend.","7a0a390e":"Next, we need to turn the date and time columns into a datetime column for python to work with. ","48a96611":"# Step 3 - Training a forecasting model\n\nHere, we will use a forecasting package called Prophet to train a model to predict energy usage. We will leave out yearly modelling, since we don't have enough \ndata to learn about energy use over a year.","24f2945a":"The data has been read in successfully, but we need one column for the energy readings, rather than one per time point. We can use the 'melt' function to do this. ","cba46582":"Now, we can plot the energy use data and the arduino data to see if they show a relationship. ","43df70b8":"# Step 3 - Preparing the data for modelling\n\nWe need to break the data into training and testing, to see how well the forecasting algorithm works.","c22d7588":"We can compare this to the predictions from the model that uses Arduino data. "}}