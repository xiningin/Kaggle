{"cell_type":{"9a4e4cea":"code","2e0eccac":"code","ca96ef0b":"code","b3a5b073":"code","1b66b2e6":"code","66392ebf":"code","c9813e40":"code","9ca76145":"code","aed71959":"code","b8507c78":"code","7e7ad67a":"code","47b92d9d":"code","738f3daf":"markdown","57c31e83":"markdown"},"source":{"9a4e4cea":"import pandas as pd\nimport os\nimport gc\nfrom tqdm import tqdm\n\nimport mlb\nenv = mlb.make_env() # initialize the environment\niter_test = env.iter_test() # iterator which loops over each date in test set","2e0eccac":"ROOT_DIR = \"..\/input\/mlb-player-digital-engagement-forecasting\"","ca96ef0b":"tr = pd.read_csv(f\"{ROOT_DIR}\/train.csv\")\nprint(tr.shape)\ngc.collect()","b3a5b073":"N_DATES = tr.shape[0]\nd = []\nfor idx in tqdm(range(N_DATES)):\n    u = eval(tr.iloc[idx, 1])\n    d += u\n#================","1b66b2e6":"tgt_df = pd.DataFrame(d)\nprint(tgt_df.shape)","66392ebf":"tgt_df['year'] = pd.DatetimeIndex(tgt_df['engagementMetricsDate']).year\ntgt_df['month'] = pd.DatetimeIndex(tgt_df['engagementMetricsDate']).month","c9813e40":"tgt_df","9ca76145":"new_df = tgt_df[tgt_df['year'] == 2021]\nnew_df = new_df[tgt_df['month'] >= 4]\nnew_df.head()","aed71959":"### group by year?\nplayer_avg = new_df.groupby([\"playerId\"])[[\"target1\",\"target2\",\"target3\",\"target4\"]].mean().reset_index()\nplayer_median = new_df.groupby([\"playerId\"])[[\"target1\",\"target2\",\"target3\",\"target4\"]].median().reset_index()\nplayer_mean=pd.concat([player_avg, player_median], axis=1).groupby(axis=1, level=0).mean()\nplayer_mean[\"target1\"] = .85 * player_mean[\"target1\"]\nplayer_mean[\"target2\"] = .85 * player_mean[\"target2\"]\nplayer_mean[\"target3\"] = .85 * player_mean[\"target3\"]\nplayer_mean[\"target4\"] = .85 * player_mean[\"target4\"]\ngc.collect()\nprint(player_mean.shape)\nplayer_mean","b8507c78":"def process_pred(df):\n    df[\"playerId\"] = df[\"date_playerId\"].apply(lambda x: int( x.split(\"_\")[1] ) )\n    df.drop([\"target1\",\"target2\",\"target3\",\"target4\"], axis=1, inplace=True)\n    df = df.merge(player_mean, on=\"playerId\", how=\"left\")\n    df.drop(\"playerId\", axis=1, inplace=True)\n    df = df.fillna(0.)\n    return df\n#===================","7e7ad67a":"for (test_df, sample_prediction_df) in iter_test:\n    sample_prediction_df = process_pred(sample_prediction_df)\n    env.predict(sample_prediction_df)","47b92d9d":"sample_prediction_df.head()","738f3daf":"## COMPUTING PLAYER MEAN","57c31e83":"Credit to @ulrich07 - I simply took his notebook and filtered out all but 2021 player targets and then averaged for each player.\n\nHere is his noteboook that I forked.\n\nhttps:\/\/www.kaggle.com\/ulrich07\/baseline-model-player-mean-or-median"}}