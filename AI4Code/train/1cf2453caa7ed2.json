{"cell_type":{"9c4d3fd1":"code","04dc715c":"code","ad3a3258":"code","4ecae58b":"code","b33cbf66":"code","b55589af":"code","c5c2633c":"code","c02246e5":"code","ad56bf62":"code","c9b572eb":"code","012d1850":"code","f4dbef4e":"code","9e82505a":"code","d68d2aac":"code","6fa1bef7":"code","a650e2fd":"code","ffa1855d":"code","dcaeeba1":"code","598ebea3":"code","075bfd54":"code","360ab73f":"code","2f21556b":"code","52da8795":"code","741dd913":"code","91a0a549":"code","98e00b08":"code","9b439a93":"code","f9f8e21a":"code","1cba8711":"code","d29c3b60":"code","bedee2df":"code","0f396928":"code","8dded08c":"code","3a589002":"code","5a2106f6":"code","220bac90":"code","9667ce82":"code","e56d082e":"code","8e8a0254":"code","f748076f":"code","87ca91d3":"markdown","31c3acaa":"markdown","403fd421":"markdown","7a610e2e":"markdown","5819ed01":"markdown","a796bde4":"markdown","a215bb32":"markdown","b4b18dcf":"markdown","164d60b3":"markdown","e548815b":"markdown","4703aed6":"markdown","1f8508fb":"markdown","888d7b21":"markdown","599d4820":"markdown","5d493266":"markdown","f9e17057":"markdown","ff0188a4":"markdown","96f32ba6":"markdown","131f91e8":"markdown","c1952a36":"markdown","0c0b315f":"markdown","8893bebb":"markdown","d44029f2":"markdown","8a639fa1":"markdown","5ec587a4":"markdown","4d3d77f1":"markdown","f5718959":"markdown","d5c15a26":"markdown","8141081d":"markdown","b2310d12":"markdown","094fee27":"markdown","2bde5761":"markdown","0e5860fe":"markdown","a6b01f48":"markdown","6ee7019a":"markdown"},"source":{"9c4d3fd1":"import numpy as np\nimport pandas as pd\nimport seaborn as sns\nimport matplotlib.pyplot as plt\n\nsns.set_palette(\"husl\")\nsns.set_style('white')","04dc715c":"train_df = pd.read_csv(\"..\/input\/train_V2.csv\")","ad3a3258":"print(\"Size of train dataset : \" + str(len(train_df)))","4ecae58b":"train_df.head()","b33cbf66":"features = ['assists', 'boosts', 'damageDealt', 'DBNOs', 'headshotKills', 'heals', 'killPlace', 'kills', 'killStreaks', \n            'longestKill', 'revives', 'rideDistance', 'roadKills', 'swimDistance', 'teamKills', 'vehicleDestroys', 'walkDistance', 'weaponsAcquired']\ninfos = ['matchDuration', 'matchType', 'maxPlace', 'numGroups']\nELO = ['rankPoints', 'killPoints', 'winPoints']\nlabel = ['winPlacePerc']","b55589af":"sample = train_df.sample(100000)\n\nf,ax = plt.subplots(figsize=(15, 12))\nsns.heatmap(sample[ELO + features + label].corr(), annot=True, linewidths=.5, fmt= '.1f',ax=ax)\nplt.show()","c5c2633c":"plt.figure(figsize=(15,10))\ntrain_df['matchType'].value_counts().sort_values(ascending=False).plot.bar()\nplt.show()","c02246e5":"game_index_dic = {\"solo\": 1, \"solo-fpp\": 1, 'normal-solo': 1, \"normal-solo-fpp\": 1,\n       \"duo\": 2, \"duo-fpp\": 2, 'normal-duo': 2,\"normal-duo-fpp\": 2,\n       \"squad\": 3, \"squad-fpp\": 3, 'normal-squad': 3,\"normal-squad-fpp\": 3,\n       \"crashfpp\" :4, \"crashtpp\" :4,\n       \"flarefpp\" :5, \"flaretpp\":5\n      }\n\ngame_name_dic = {\"solo\": \"solo\", \"solo-fpp\": \"solo\", 'normal-solo': \"solo\", \"normal-solo-fpp\": \"solo\",\n                   \"duo\": \"duo\", \"duo-fpp\": \"duo\", 'normal-duo': \"duo\",\"normal-duo-fpp\": \"duo\",\n                   \"squad\": \"squad\", \"squad-fpp\": \"squad\", 'normal-squad': \"squad\",\"normal-squad-fpp\": \"squad\",\n                   \"crashfpp\": \"crash\", \"crashtpp\": \"crash\",\n                   \"flarefpp\": \"flare\", \"flaretpp\": \"flare\"\n      }","ad56bf62":"train_df['matchTypeName'] = train_df['matchType'].apply(lambda x: game_name_dic[x])\ntrain_df['matchType'] = train_df['matchType'].apply(lambda x: game_index_dic[x])","c9b572eb":"f, ax = plt.subplots(figsize=(12, 8))\nax.set(yscale=\"log\")\ntrain_df['matchTypeName'].value_counts().sort_values(ascending=False).plot.bar(ax=ax)\nplt.show()","012d1850":"plt.figure(figsize=(12,8))\nsns.distplot(train_df['matchDuration'])\nplt.show()","f4dbef4e":"def get_map(x):\n    if x > 1600:\n        return 0\n    else: \n        return 1","9e82505a":"train_df['miniRoyale'] = train_df['matchDuration'].transform(get_map)","d68d2aac":"data = train_df\nf, ax = plt.subplots(figsize=(12, 8))\nax.set(yscale=\"log\")\nsns.countplot(x='miniRoyale', hue='matchTypeName', ax=ax, data=data, palette=sns.color_palette(n_colors=5))\nplt.show()","6fa1bef7":"agg = train_df.groupby(['matchId', 'groupId']).size().to_frame('teamSize')\ntrain_df = train_df.merge(agg, how='left', on=['matchId', 'groupId'])","a650e2fd":"train_df.head()","ffa1855d":"data = train_df[['teamSize']].copy()\ndata.loc[data['teamSize'] >= 9] = '9+'\nplt.figure(figsize=(15,10))\nsns.countplot(data['teamSize'].astype('str').sort_values())\nplt.show()","dcaeeba1":"size_dic = {1:1, 2:2, 3:4, 4:4, 5:4}","598ebea3":"sample = train_df[train_df['matchType'] == 1]\nplt.figure(figsize=(15, 6))\nsns.countplot(sample['teamSize'])\nplt.show()","075bfd54":"sample = train_df[train_df['matchId'] == \"6dc8ff871e21e6\"]\nplt.figure(figsize=(10,4))\nsns.countplot(sample['teamSize'])\nplt.show()","360ab73f":"fig,ax = plt.subplots(figsize=(12,8))\nax.set_xticklabels([])\nsns.scatterplot(x='Id', y='winPlacePerc', hue='teamSize', data=sample, ax=ax)\nplt.show()","2f21556b":"train_df['matchTeamSize'] = train_df['teamSize'] \/ train_df['matchType'].apply(lambda x: size_dic[x])","52da8795":"train_df['matchTeamSize'] = train_df['matchTeamSize'].apply(lambda x: max(2, x))","741dd913":"train_df['skill'] = train_df['headshotKills'] + 0.01 * train_df['longestKill'] - train_df['teamKills']\/(train_df['kills']+1)","91a0a549":"data = train_df.sample(10000)\nplt.figure(figsize=(15,10))\nsns.scatterplot(x='skill', y='winPlacePerc', hue='matchTypeName', data=data, palette=sns.color_palette(n_colors=5))\nplt.show()","98e00b08":"train_df['hsRatio'] = train_df['headshotKills'] \/ train_df['kills']\ntrain_df['hsRatio'].fillna(0, inplace=True)","9b439a93":"data = train_df.sample(10000)\nplt.figure(figsize=(15,10))\nsns.scatterplot(x='hsRatio', y='winPlacePerc', hue='matchTypeName', data=data, palette=sns.color_palette(n_colors=5))\nplt.show()","f9f8e21a":"def transform_hsRatio(x):\n    if x == 1 or x == 0:\n        return 0.5\n    else: \n        return x","1cba8711":"train_df['hsRatio'] = train_df['hsRatio'].apply(transform_hsRatio)","d29c3b60":"data = train_df.sample(10000)\nplt.figure(figsize=(15,10))\nsns.scatterplot(x='hsRatio', y='winPlacePerc', hue='matchTypeName', data=data, palette=sns.color_palette(\"husl\", n_colors=5))\nplt.show()","bedee2df":"train_df['distance'] = (train_df['walkDistance'] + 0.4 * train_df['rideDistance'] + train_df['swimDistance'])\/train_df['matchDuration']","0f396928":"data = train_df.sample(10000)\nplt.figure(figsize=(15,10))\nsns.scatterplot(x='distance', y='winPlacePerc', hue='matchTypeName', data=data, palette=sns.color_palette(n_colors=5))\nplt.show()","8dded08c":"train_df['boostsRatio'] = train_df['boosts']**2 \/ train_df['walkDistance']**0.5\ntrain_df['boostsRatio'].fillna(0, inplace=True)\ntrain_df['boostsRatio'].replace(np.inf, 0, inplace=True)","3a589002":"data = train_df.sample(10000)\nplt.figure(figsize=(15,10))\nsns.scatterplot(x='boostsRatio', y='winPlacePerc', hue='matchTypeName', data=data, palette=sns.color_palette(n_colors=5))\nplt.show()","5a2106f6":"train_df['healsRatio'] = train_df['heals'] \/ train_df['matchDuration']**0.1\ntrain_df['healsRatio'].fillna(0, inplace=True)\ntrain_df['healsRatio'].replace(np.inf, 0, inplace=True)","220bac90":"data = train_df.sample(10000)\nplt.figure(figsize=(15,10))\nsns.scatterplot(x='healsRatio', y='winPlacePerc', hue='matchTypeName', data=data, palette=sns.color_palette(n_colors=5))\nplt.show()","9667ce82":"train_df['killsRatio'] = train_df['kills'] \/ train_df['matchDuration']**0.1\ntrain_df['killsRatio'].fillna(0, inplace=True)\ntrain_df['killsRatio'].replace(np.inf, 0, inplace=True)","e56d082e":"data = train_df.sample(10000)\nplt.figure(figsize=(15,10))\nsns.scatterplot(x='killsRatio', y='winPlacePerc', hue='matchTypeName', data=data, palette=sns.color_palette(n_colors=5))\nplt.show()","8e8a0254":"engineered = ['matchTeamSize', 'skill', 'hsRatio', 'distance', 'boostsRatio', 'healsRatio', 'killsRatio']","f748076f":"sample = train_df.sample(100000)\n\nf,ax = plt.subplots(figsize=(15, 12))\nsns.heatmap(sample[engineered + label].corr(), annot=True, linewidths=.5, fmt= '.1f',ax=ax)\nplt.show()","87ca91d3":"# PUBG : EDA & Feature Engineering - 0.0243 (Top 5%)\n\n### *In this kernel, I will present the feature engineering I did for the PUBG placement ranking predictions.*\n#### So far, I've reached 0.0243 using those, which is top 5% approximately.\n\nI have also played this game quite a lot, I will try to expose the things I learned playing that helped me design these features.","31c3acaa":"### A good player tends to aim for the head\n> $ \\text{hsRatio} = \\frac{\\text{headshotKills}}{\\text{Kills}} $","403fd421":"## Played map\n\nIndeed, there are 3 different maps in PUBG, which are of different size. The bigger the map, the longer the match, and the more distance players have to travel.","7a610e2e":"#### Good players go for kills\n> $ \\text{killsRatio} = \\frac{\\text{kills}}{\\text{matchDuration}^{0.1}}$","5819ed01":"Teams larger than 4 members ? Weird...","a796bde4":"This plot let us notice that players in the same group have the same placement, despite the fact that they are not in the same team (because it's solos)","a215bb32":"Flare games can easily be considered the same way as squad games, but crash games are a bit different.","b4b18dcf":"# Following work\n\nAfter the features engineering, I did some more preprocessing. I chose not to include the code, but here are the ideas :\n\n### Grouping by squads\n\nAs mentionned before, scores are the same for the each members of the team. Therefore it is clever to consider groups instead of players.\n\nDepending on the pertinence of the feature, I am going to use the merge to increase the size of the feature space. \nI usually take the maximum, mean, median and minimum in each group for the feature, except the ones that will (almost) always have 0 as minimum.\nSome data don't change in inbetween a group or a game, therefore only one way of merging is needed.\n\n### Normalizing when needed\n\nI normalize (with a min\/max scale) features that need to be.\n\n### Features based on rankings\n\nI also increase the size of our feature space by considering the rank of the group inside its match for each feature. ","164d60b3":"##### To be continued...\n>A lot more of clever features can be designed, but I'm gonna stick with these for now.","e548815b":"There we have it, a nice Gaussian-like repartition with skilled players on the right and less skilled players on the left !","4703aed6":"### Correlation between features","1f8508fb":"#### But groups are indexed weirdly :","888d7b21":"## Creating player level features","599d4820":"Not very convinced with this one, as people who get a ratio of one are mostly the ones who only got one kill, it could be luck. The interesting part of this feature is in $ ] 0;0.5[  \\cup  ] 0.5; 1 [ $. Therefore we modify it a bit.","5d493266":"Teams in solos have up to 64 players, while they should all have 1 player.\n\nLet us consider a single solo game : ","f9e17057":"## Loading data","ff0188a4":"Considering the last column and my intuition, I can already detect features that I'll drop later :\nteamKills, swimDistance, roadKills, vehicleDestroys.\n\nELO variables also seem pretty useless. That is because matchmaking is based on those features, therefore people with similar Points will be put in the same game.\nHowever I have the intuition they can still be used. A first thing to do is to sum them into a single feature.","96f32ba6":"> $  \\text{matchTeamSize} = \\max( \\frac{\\text{teamSize}}{\\text{size(matchType)}} ,2) $","131f91e8":"With merged groups, this feature takes way too high values, therefore I threshold it at 2.","c1952a36":"### It is important to consider the size of the team in different gamemodes\n\n* Solos : 1 player\n* Duos : 2 players\n* Squad : 1 to 4 players\n* Crash : 1 to 4 players\n* Flaredrop : 1 to 4 players\n\nA full squad will have more chances to win, obviously. \n\nThe following dictionary precises the maximum number of players in a group depending on the gamemode.\n\n","0c0b315f":"## Creating group level features\n\n### Group sizes ","8893bebb":"### PUBG is a skilled based game ...\nHere is a feature evaluating the skill of a player. It takes into consideration the fact that players teamkilling are usually trolling.\n> $ \\text{skill} = \\text{headshotKills} + 0.01 \\cdot \\text{longestKill} - \\frac{\\text{teamKills}}{\\text{kills}+1}  $","d44029f2":"Because they are shorter, crash games are labelled as Mini Royale, although they are not. But this gamemode is a bit special as mentionned before.","8a639fa1":"It is important to normalize by the length of the game.","5ec587a4":"## * Feel free to ask me anything in the comments.*","4d3d77f1":"Focusing on the last line\/column, there seems to be work to be done on the matchTeamSize and hsRatio feature. The first one is highly constrained by the problem with group ids ...","f5718959":"#### The importance of boosts\nDuring end game, good players will always keep their boost jauge to the max. Movements are faster and it provides life regeneration. Furthermore, having a lot of boost means being well stuffed, therefore it increases the chances of winning. Therefore you want to be \"full boost\" when on foot.\n> $ \\text{boostRatio} = \\frac{\\text{boosts}^2}{\\sqrt{\\text{walkDistance}}}$","d5c15a26":"#### Healing means living\n> $ \\text{healsRatio} = \\frac{\\text{heals}}{\\text{matchDuration}^{0.1}}$","8141081d":"I can already separate columns in some categories :","b2310d12":"There are two players who have been incorrectly put in the same group.","094fee27":"#### The more distance the travel, the longer you are supposed to stay alive\n\n> $ \\text{distance} = (\\text{walkDistance} + 0.4 \\cdot \\text{rideDistance} + \\text{swimDistance} ) \\cdot \\frac{1}{matchDuration} $","2bde5761":"### Correlation map of our new features","0e5860fe":"There are two Gaussians, I assume the first one corresponds to the \"Mini Royale\" mode played on the Sanhok map which is considerably smaller and faster paced. The second one corresponds to the normal maps.\n\nWe can create a feature saying whether we are in Mini Royale or not.","a6b01f48":"## Gametypes\nI merge gametypes to 5 categories : solo, duo, squad, crash and flare. \nI create one column with indexes, that will be used for the model, and an other one with names, for visualisation purposes.","6ee7019a":"**Thanks for reading my work. As this is my first kernel, any advice is highly appreciated. **\n\n**Don't forget to leave an upvote, it is always appreciated as well, as doing this kernel took me quite a lot of time.**\n \n**Cheers, **\n\n**Theo.**"}}