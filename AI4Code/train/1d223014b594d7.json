{"cell_type":{"faf82772":"code","86b8c6ed":"code","e22e2942":"code","1567c3a1":"code","d71727b8":"code","99e2a857":"code","6792c454":"code","b3951452":"code","2fb9e197":"code","f039f3ca":"code","97858492":"code","e07110c9":"code","77d46462":"code","aee30d4b":"code","332a1c85":"code","147a67ed":"code","40785736":"code","8edce5d0":"code","a5d76b86":"code","e1590393":"code","b978255a":"code","e5d45d86":"code","2aba7284":"code","cba3a1d0":"markdown","ae3bcbb0":"markdown"},"source":{"faf82772":"from keras.preprocessing.image import ImageDataGenerator\nfrom keras import applications\nfrom keras.models import Model\nfrom keras.layers import Dense, Flatten, Dropout,GlobalMaxPooling2D\nimport matplotlib.pyplot as plt\nimport numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\nimport os\nprint(os.listdir(\"..\/input\"))\nimport cv2\nfrom tqdm import tqdm_notebook\nimport matplotlib.pyplot as plt\n\n%matplotlib inline\n","86b8c6ed":"train_df = pd.read_csv(\"..\/input\/aptos2019-blindness-detection\/train.csv\")\ntest_df = pd.read_csv('..\/input\/aptos2019-blindness-detection\/test.csv')\n\ntrain_dir = '..\/input\/aptos2019-blindness-detection\/train_images'\ntest_dir = '..\/input\/aptos2019-blindness-detection\/test_images'","e22e2942":"train_df[\"id_code\"]=train_df[\"id_code\"].apply(lambda x:x+\".png\")\ntrain_df['diagnosis'] = train_df['diagnosis'].astype(str)\n\ntest_df[\"id_code\"]=test_df[\"id_code\"].apply(lambda x:x+\".png\")","1567c3a1":"train_df.head()","d71727b8":"test_df.head()","99e2a857":"imgs = []\nfor imgk in tqdm_notebook(os.listdir(train_dir)[:5]):\n        path = os.path.join(train_dir,imgk)\n        imgl = cv2.imread(path,cv2.IMREAD_COLOR)\n        imgs.append(np.array(imgl))","6792c454":"imgs = np.asarray(imgs)\nprint(imgs[1].shape)","b3951452":"   \nfig, axs = plt.subplots(2, 2)\naxs[0, 0].imshow(imgs[0])\naxs[1, 0].imshow(imgs[1])\naxs[0, 1].imshow(imgs[2])\naxs[1, 1].imshow(imgs[3])\n\nplt.show()","2fb9e197":"imgsize = 250","f039f3ca":"model = applications.ResNet50(include_top=False,input_shape= (imgsize,imgsize,3), \n                              weights = '..\/input\/resnet50\/resnet50_weights_tf_dim_ordering_tf_kernels_notop.h5')","97858492":"#model.trainable = False\nfor layer in model.layers[:-15]:\n       layer.trainable = False","e07110c9":"model_x = model.output\nmodel_x = GlobalMaxPooling2D()(model_x)\nmodel_x = Dropout(0.3)(model_x)\nmodel_x = Dense(1024,activation='relu')(model_x)\nmodel_x = Dropout(0.3)(model_x)\npredictions = Dense(5, activation='softmax')(model_x)\n\nmodel_output = Model(inputs=model.input, outputs=predictions)","77d46462":"X_tr = [] #training image\nY_tr = [] #training lables\ntest_img = [] #test images","aee30d4b":"#loading training images and labels\ndef load_train_image(f_path):\n        imges = train_df['id_code']\n        for img_id in tqdm_notebook(imges):\n                img = cv2.imread(os.path.join(f_path, img_id), cv2.IMREAD_COLOR)\n                img = cv2.resize(img,(imgsize,imgsize))\n                X_tr.append(np.array(img))\n                Y_tr.append(train_df[train_df['id_code'] == img_id]['diagnosis'].values[0])  \n        return X_tr, Y_tr","332a1c85":"#loading test images\ndef load_test_image(ft_path):\n        imgts = test_df['id_code']\n        for img_id_ts in tqdm_notebook(imgts):\n                imgk = cv2.imread(os.path.join(ft_path, img_id_ts), cv2.IMREAD_COLOR)\n                imgk = cv2.resize(imgk,(imgsize,imgsize))\n                test_img.append(np.array(imgk))\n                  \n        return test_img","147a67ed":"load_train_image(f'..\/input\/aptos2019-blindness-detection\/train_images\/')\n\nX_tr = np.array(X_tr)\nX_tr = X_tr.astype('float32')\nX_tr \/= 255\nY_tr = np.array(Y_tr)","40785736":"load_test_image(f'..\/input\/aptos2019-blindness-detection\/test_images\/')\n\ntest_img = np.array(test_img)\ntest_img = test_img.astype('float32')\ntest_img \/= 255","8edce5d0":"%%time\ndata_gen = ImageDataGenerator(horizontal_flip = True,\n                              vertical_flip = True,\n                             rotation_range=20,\n                             width_shift_range=0.2,\n                             height_shift_range=0.2,\n                             validation_split = 0.20\n                                                   )\ntrain_aug = data_gen.flow(X_tr,Y_tr,\n                          subset = 'training')\ntrain_valid_aug = data_gen.flow(X_tr,\n                               Y_tr,\n                               subset = 'validation')\n\ntest_aug = data_gen.flow(test_img)","a5d76b86":"model_output.compile(loss='sparse_categorical_crossentropy',             \n              optimizer='adam',      \n              metrics=['acc'])","e1590393":"history = model_output.fit_generator(generator = train_aug,\n                              steps_per_epoch=90,\n                              epochs=10,\n                              validation_data=train_valid_aug,\n                              validation_steps=20\n                              )","b978255a":"# summarize history for accuracy\nplt.plot(history.history['acc'])\nplt.plot(history.history['val_acc'])\nplt.title('model accuracy')\nplt.ylabel('accuracy')\nplt.xlabel('epoch')\nplt.legend(['train', 'test'], loc='upper left')\nplt.show()\n# summarize history for loss\nplt.plot(history.history['loss'])\nplt.plot(history.history['val_loss'])\nplt.title('model loss')\nplt.ylabel('loss')\nplt.xlabel('epoch')\nplt.legend(['train', 'test'], loc='upper left')\nplt.show()","e5d45d86":"batch_size = 32\nresult = model_output.predict_generator(test_aug ,steps = (test_img.shape[0] \/\/ batch_size)+1)","2aba7284":"print(result)","cba3a1d0":"Kernal Needs to be upated.","ae3bcbb0":"Showing some images"}}