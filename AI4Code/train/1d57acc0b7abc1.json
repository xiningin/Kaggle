{"cell_type":{"f8029bb5":"code","f98b1f0b":"code","deb2bbd6":"code","5afb12fa":"code","21f48280":"code","b752bbba":"code","12d5acb2":"code","1793baf2":"code","7c1a5056":"code","18c602a5":"code","9f2a6a0d":"code","3d66e7c0":"code","e9ceebdc":"code","7b3e000c":"code","e26c90bc":"code","ad521258":"code","85a5f181":"code","73ed7118":"code","9e5c2844":"code","10baea6f":"code","ce8b1c48":"code","bbf6064a":"code","3c6afa2e":"code","90f50194":"code","2b3c7ea9":"code","987ffa1f":"code","e599a816":"code","11638cd3":"code","376ec61f":"code","37562122":"markdown","3770361c":"markdown","58d5ab08":"markdown","70d14d5a":"markdown","c15c4441":"markdown","a3bbc953":"markdown","db29ca38":"markdown","6440cd0d":"markdown"},"source":{"f8029bb5":"#Initialize packages.\n\nimport pandas as pd\nimport numpy as np\nimport requests\nimport shutil\nimport os.path\nfrom os import path","f98b1f0b":"default = pd.read_csv('..\/input\/coins-dataset\/source_csv\/coinlist.csv',encoding='ISO-8859-1')\ndf = default[['id','broadperiod', 'imagedir', 'filename']]\ndf.head(5)","deb2bbd6":"def download_img(broadperiod, imagedir, filename, idnum):\n    # Sets the url and filename for the image. (Need to append the period name to filename for ML processing later.)\n    # The parameters are converted to string objects in case they are initially numeric.\n    image_url = \"https:\/\/finds.org.uk\/\" + str(imagedir) + \"medium\/\" + str(filename)\n    filename = str(broadperiod) + '__' + str(idnum) + '.jpg'\n    \n    # Check if the file already exists before running requests.get. (Useful for rerunning batch_dl.)\n    if path.exists('data\/images\/' + filename):\n        print(filename + \" already exists.\")\n    \n    # When the file doesn't exist, downloads the file.\n    else:\n        r = requests.get(image_url, stream=True)\n    \n        # If the file is accessible via r, download it.\n        if r.status_code == 200:\n            r.raw.decode_content = True\n        \n            with open('data\/images\/' + filename, 'wb') as f:\n                shutil.copyfileobj(r.raw,f)\n        \n            print('Downloaded: ', str(filename))\n        else:\n            print(\"Image couldn't be retreived\")\n\n            \n    # This function iterates over a dataframe.\ndef batch_dl(df):\n    i = 0\n    while i < len(df):\n        download_img(df.broadperiod[i], df.imagedir[i], df.filename[i], df.id[i])\n        i += 1","5afb12fa":"gr = pd.read_csv('..\/input\/coins-dataset\/source_csv\/greek_provincal.csv',encoding='ISO-8859-1')[['id','broadperiod', 'imagedir', 'filename']]\nmed = pd.read_csv('..\/input\/coins-dataset\/source_csv\/medieval.csv',encoding='ISO-8859-1')[['id','broadperiod', 'imagedir', 'filename']]\npmed = pd.read_csv('..\/input\/coins-dataset\/source_csv\/post_medieval.csv',encoding='ISO-8859-1')[['id','broadperiod', 'imagedir', 'filename']]\nemed = pd.read_csv('..\/input\/coins-dataset\/source_csv\/early_medieval.csv',encoding='ISO-8859-1')[['id','broadperiod', 'imagedir', 'filename']]\n\nbig = pd.concat([df, gr, med, pmed, emed]).drop_duplicates()\nbig.head()","21f48280":"# If you want to run this notebook off Kaggle, you can uncomment this to download the images.\n# batch_dl(big)","b752bbba":"# Import fastai modules\nfrom fastai.vision import *\nfrom fastai.metrics import error_rate","12d5acb2":"# Get the file list for our image dataset.\nfnames = get_image_files('..\/input\/coins-dataset\/images')\n# Print part of the list.\nfnames[:11]","1793baf2":"# Set up regex for finding image filenames to find labels for image names.\n\npat = r'\/([^\/m]+?(?=__))'\nimagepath = '..\/input\/coins-dataset\/images'","7c1a5056":"data = ImageDataBunch.from_name_re(imagepath, fnames, pat, ds_tfms=get_transforms(), size=224, bs=64).normalize(imagenet_stats)","18c602a5":"learn = cnn_learner(data, models.resnet50, metrics=error_rate, model_dir=\"\/kaggle\/working\/\")","9f2a6a0d":"data.show_batch(rows=3, figsize=(7,6))","3d66e7c0":"print(data.classes)\nlen(data.classes),data.c","e9ceebdc":"data = ImageDataBunch.from_name_re(imagepath, fnames, pat, ds_tfms=get_transforms(),\n                                   size=299, bs=32).normalize(imagenet_stats)","7b3e000c":"learn.model","e26c90bc":"learn.fit_one_cycle(4)","ad521258":"learn.save('stage-1-50')","85a5f181":"learn.unfreeze()","73ed7118":"learn.lr_find()","9e5c2844":"learn.recorder.plot()","10baea6f":"learn.fit_one_cycle(4, max_lr=slice(1e-6,1e-2))","ce8b1c48":"learn.save('stage-2-50')","bbf6064a":"interp = ClassificationInterpretation.from_learner(learn)","3c6afa2e":"interp.plot_confusion_matrix(figsize=(12,12))","90f50194":"interp.plot_top_losses(9, figsize=(15,15))","2b3c7ea9":"learn.export('\/kaggle\/working\/export.pkl')","987ffa1f":"defaults.device = torch.device('cpu')","e599a816":"img = open_image('..\/input\/coins-dataset\/images\/EARLY MEDIEVAL__1000545.jpg')\nimg","11638cd3":"learn = load_learner('\/kaggle\/working')","376ec61f":"pred_class,pred_idx,outputs = learn.predict(img)\npred_class.obj","37562122":"Now here's a breakdown of this data:\n\n- **id**: The unique identifier for a given artefact or coin from the PAS database. We will append this to the end of our image names so that all files are unique.\n- **broadperiod**: The broad period of time from which the coin came from.\n- **imagedir**: The directory the image is located in on the website.\n- **filename**: The name of the file from the website.\n\nNote that even with this information, some files weren't downloaded. More on this later.","3770361c":"Since we want to download all the images from our existing csv files, we can just take all the data and concatenate them into one dataframe. Once we do this, we can run the batch_dl() function to download all the images we want.\n\n### Limitations\nUsing this method, many images could not be downloaded from PAS. However, the sample was big enough to train a deep learning model.","58d5ab08":"# Model for Identifying the Time Period of Coins\nArtefacts and coins can be difficult to identify. While it would probably be unwise to rely only on a deep learning model to identify or date artefacts (even broadly speaking) I wanted to see how accurate such an algorithm could be.\n\n### Motivation\n\nI'm still learning how to implement machine learning using the first lesson of the [fast.ai online course](https:\/\/course.fast.ai\/).\n## 1. Get the image data\nFirst, we need to download the images from the [Portable Antiquities Scheme](https:\/\/finds.org.uk\/database\/) (will be refered to as PAS). The method for downloading the images is as follows:\n\n- If you are not already a member, register at the PAS website.\n- Perform a query for coins (or other artefacts if you decide to train a model on different objects)\n- Download the csv file for that query. (Note: If your query is too big, you may need to limit your query to specific time periods or dates.)\n- Repeat as many times as desired, attempting to get images of coins from each broad time period.","70d14d5a":"Now let's look at one of the csv files I used to create the dataset.","c15c4441":"## 2. Train the Model - Res 32\nNow is the part where we're going to try to train the model. Most of the code is derived from [this fast.ai lesson](https:\/\/github.com\/fastai\/course-v3\/blob\/master\/nbs\/dl1\/lesson1-pets.ipynb).","a3bbc953":"## Final Training\nNow we're going to fine-tune the model.","db29ca38":"Using the data such as that from above, I was able to put together this function to download the image files. This specific function appends the \"broadperiod\" name to the front of the filename.","6440cd0d":"It looks like there may be issues with how the coins are classified. The model tends to get confused between the varieties of medieval, post medieval, and early medieval coins. Perhaps these categories are variable based on a variety of factors, thus confounding the model.\n\nAlso, the images are being cropped in the processing, which also confounds the model."}}