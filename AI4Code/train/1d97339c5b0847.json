{"cell_type":{"dd3439e2":"code","aa04f6b7":"code","22b2b440":"code","d65a9c8c":"code","9131a5b6":"code","7d27e975":"code","8001ee8e":"code","c2c84157":"code","86467c85":"code","3672d8ac":"code","04e264d4":"code","dfef3f08":"code","fb4dac3a":"code","da0b5135":"code","e42c8f20":"code","2263a40f":"code","c045f561":"code","8c24810f":"code","498c2d95":"code","d54fd3a3":"code","5b6463b1":"code","5b08d447":"code","f5682df9":"code","50d641b5":"code","358dadc6":"code","14b2f3c9":"code","fad7d7cd":"code","1b3e610c":"code","41f6f524":"code","b6ad0177":"code","65b27a52":"code","705278a9":"code","c59f098f":"code","744d9492":"code","d8bdf7e8":"code","062b0770":"code","54e6fa44":"markdown","5d64a45f":"markdown","23fd5bce":"markdown","5a89944d":"markdown","59c6fc71":"markdown","86c842e6":"markdown","b96fcca1":"markdown","deebb513":"markdown","9a0f4254":"markdown","f73fa3b5":"markdown","485dbc48":"markdown","dc9b0d74":"markdown","97cc8007":"markdown","c4b85224":"markdown","dd93c46c":"markdown","ee87256d":"markdown"},"source":{"dd3439e2":"import pandas as pd\nimport numpy as np\nimport os\nimport seaborn as sns\nimport matplotlib.pyplot as plt\nfrom collections import Counter\nfrom sklearn.preprocessing import LabelEncoder\nfrom sklearn.decomposition import PCA\nfrom sklearn.model_selection import train_test_split, GridSearchCV\nfrom sklearn.metrics import accuracy_score, recall_score, classification_report\nimport lightgbm as lgb\n\n# path\npath_dir = '..\/input\/ieee-fraud-detection\/'\nfile_list = os.listdir(path_dir)\nfile_list","aa04f6b7":"# Train Data\ntrain_identity = pd.read_csv(path_dir+'train_identity.csv')\ntrain_transaction = pd.read_csv(path_dir+'train_transaction.csv')\n# Test Data\ntest_identity = pd.read_csv(path_dir+'test_identity.csv')\ntest_transaction = pd.read_csv(path_dir+'test_transaction.csv')","22b2b440":"train_identity.head()","d65a9c8c":"train_transaction.head()","9131a5b6":"train_merge = pd.merge(train_identity, train_transaction, on=['TransactionID'], how='right')\ntest_merge = pd.merge(test_identity, test_transaction, on=['TransactionID'], how='right')\ntrain_merge = train_merge.drop(['DeviceInfo'], axis=1)\ntest_merge = test_merge.drop(['DeviceInfo'], axis=1)\n\ndel train_identity, train_transaction, test_identity, test_transaction","7d27e975":"train_merge.head()","8001ee8e":"# Check NULL ratio >= 0.77\ncheck_null = train_merge.isna().sum() \/ len(train_merge)\ncheck_null[check_null >= 0.77]","c2c84157":"# remove cols of null ratio >= 0.77\nremove_cols = list(check_null[check_null >= 0.77].keys())\nnot_remove_cols = ['id_30','id_31','R_emaildomain','P_emaildomain','ProductCD','card4','card6','DeviceType']\n\nfor col in not_remove_cols:\n    if col in remove_cols:\n        remove_cols.remove(col)\n    else:\n        pass\n\ntrain_merge = train_merge.drop(remove_cols, axis=1)\ntest_merge = test_merge.drop(remove_cols, axis=1)\nprint(train_merge.shape)\nprint(test_merge.shape)","86467c85":"train_merge.head()","3672d8ac":"# select types\nobject_cols = train_merge.select_dtypes(include='object').columns\nnobject_cols = train_merge.select_dtypes(exclude='object').columns\n\nprint('Columns of Object Type\\n{}'.format(object_cols.values))","04e264d4":"train_merge[object_cols] = train_merge[object_cols].fillna('NaN')\ntrain_merge[nobject_cols] = train_merge[nobject_cols].fillna(0)\n\ntest_merge[object_cols] = test_merge[object_cols].fillna('NaN')\nnobject_cols = list(nobject_cols)\nnobject_cols.remove('isFraud')\ntest_merge[nobject_cols] = test_merge[nobject_cols].fillna(0)","dfef3f08":"train_merge.head()","fb4dac3a":"# Ratio of isFraud(target value)\nisfraud_values = train_merge['isFraud'].value_counts().values\nisfraud_0 = (isfraud_values[0] \/ len(train_merge['isFraud'])) * 100\nisfraud_1 = (isfraud_values[1] \/ len(train_merge['isFraud'])) * 100\nprint('Ratio of isFraud 0 : {:.1f} %'.format(isfraud_0))\nprint('Ratio of isFraud 1 : {:.1f} %'.format(isfraud_1))\n\n# plot\nplt.figure(figsize=(7, 4))\nsns.countplot(x='isFraud', data=train_merge)\nplt.xlabel('isFraud'); plt.ylabel('Count')\nplt.title('Count of Target Value'); plt.show()","da0b5135":"cols = ['DeviceType', 'ProductCD', 'card4', 'card6']\nplt.figure(figsize=(11, 15))\nfor i, col in enumerate(cols):\n    plt.subplot(len(cols), 1, i+1)\n    sns.countplot(x=col,  hue='isFraud', data=train_merge)\n    plt.title('Count by '+str(col))\n    plt.tight_layout()","e42c8f20":"# Distribution of TransactionAmt by isFraud\nplt.figure(figsize=(11, 8))\nfor i in [0, 1]:\n    plt.subplot(2,1, i+1)\n    sns.distplot(train_merge[train_merge['isFraud'] == i][train_merge['TransactionAmt'] <=700]['TransactionAmt'])\n    plt.title('Distribution of TransactionAmt by isFraud '+str(i))\n    plt.tight_layout()","2263a40f":"# Distribution of TransactionAmt by DeviceType\ndevicetype = train_merge['DeviceType'].unique()\nplt.figure(figsize=(11, 8))\nfor i, device in enumerate(devicetype):\n    plt.subplot(len(devicetype), 1, i+1)\n    sns.distplot(train_merge[train_merge['DeviceType'] == device][train_merge['TransactionAmt'] <=700]['TransactionAmt'])\n    plt.title('Distribution of TransactionAmt by '+str(device))\n    plt.tight_layout()","c045f561":"productcd = train_merge['ProductCD'].unique()\nplt.figure(figsize=(11, 9))\nfor i, cd in enumerate(productcd):\n    plt.subplot(len(productcd), 1, i+1)\n    sns.distplot(train_merge[train_merge['ProductCD']==cd][train_merge['TransactionAmt'] <=700]['TransactionAmt'])\n    plt.title('Distribution of TransactionAmt by '+str(cd))\n    plt.tight_layout()","8c24810f":"# unique\ud55c \ud2b9\uc131\uc774 \ub108\ubb34 \ub9ce\uc544 \ub370\uc774\ud130 \ub2e8\uc21c\ud654 \ud544\uc694 \nprint('id_30 : {}'.format(train_merge['id_30'].unique())+'\\n')\nprint('id_31 : {}'.format(train_merge['id_31'].unique())+'\\n')\nprint('P_emaildomain : {}'.format(train_merge['P_emaildomain'].unique())+'\\n')\nprint('R_emaildomain : {}'.format(train_merge['R_emaildomain'].unique())+'\\n')","498c2d95":"def simplify_categorical(data):\n    mobile_os = [i.split(' ')[0] for i in data['id_30']]\n    browser = []\n    for i in data['id_31']:\n        if i.split(' ')[0] == 'mobile' and len(i.split(' ')) > 1: # ex. mobile safari 10.0, mobile safari generic, ...\n            browser.append(i.split(' ')[1])\n        elif i.split('\/')[0] == 'Samsung':    # ex. Samsung\/SM-G532M, Samsung\/SCH, Samsung\/SM-G531H,\n            browser.append('samsung')\n        elif i.split('\/')[0] == 'Microsoft':  # ex. Microsoft\/Windows\n            browser.append('ie')\n        elif i.split('\/')[0] == 'Mozilla':    # ex. Mozilla\/Firefox\n            browser.append('firefox')\n        elif i.split('\/')[0] == 'Generic':    # ex. Generic\/Android\n            browser.append('android')\n        elif len(i.split(' ')) >= 1:          # ex. edge 14.0, android brower 4.0, Chrome 63.0 for Android, ...\n            browser.append(i.split(' ')[0])\n        else:\n            browser.append(i)                  # android, chrome, edge, google, le, ...\n    p_emaildomain = [i.split('.')[0] for i in data['P_emaildomain']]\n    r_emaildomain = [i.split('.')[0] for i in data['R_emaildomain']]\n    \n    data['id_30'] = [i.lower() for i in mobile_os]\n    data['id_31'] = [i.lower() for i in browser]\n    data['P_emaildomain'] = [i.lower() for i in p_emaildomain]\n    data['R_emaildomain'] = [i.lower() for i in r_emaildomain]\n    \n    return data\n\ntrain = simplify_categorical(train_merge)\ntrain_target = train['isFraud']\ntrain = train.drop('isFraud', axis=1)\ntest = simplify_categorical(test_merge)\n\ndel train_merge, test_merge","d54fd3a3":"print('id_30 : {}'.format(train['id_30'].unique())+'\\n')\nprint('id_31 : {}'.format(train['id_31'].unique())+'\\n')\nprint('P_emaildomain : {}'.format(train['P_emaildomain'].unique())+'\\n')\nprint('R_emaildomain : {}'.format(train['R_emaildomain'].unique())+'\\n')","5b6463b1":"# LabelEncoding \ncategorical_features = list(object_cols)\n\nfor col in categorical_features:\n    le = LabelEncoder()\n    le.fit(list(train[col].values) + list(test[col].values))\n    train[col] = le.transform(list(train[col].values))\n    test[col] = le.transform(list(test[col].values))","5b08d447":"train_corr = train[:50000].copy()\ntrain_corr['isFraud'] = train_target.copy()\n\ncorrmat = train_corr.corr()\ntop_corr_features = corrmat.index[abs(corrmat['isFraud']) >= 0.10]\n# top_corr_features\nplt.figure(figsize=(13,10))\nsns.heatmap(train_corr[top_corr_features].corr(), annot=False, cmap=\"RdYlGn\")\nplt.title('Variable Correlations')\nplt.show()\n\ndel corrmat","f5682df9":"train = train.drop('TransactionID', axis=1)\ntest_tid = test['TransactionID']\ntest = test.drop('TransactionID', axis=1)","50d641b5":"# Standardization\ntrain_scale_ = train.drop(categorical_features, axis=1)\ntest_scale_ = test.drop(categorical_features, axis=1)\n\n# z = (x - u) \/ s\ntrain_scale = (train_scale_ - train_scale_.mean()) \/ train_scale_.std()\ntest_scale = (test_scale_ - train_scale_.mean()) \/ train_scale_.std()","358dadc6":"train[train_scale.columns] = train_scale\ntest[test_scale.columns] = test_scale\n\ndel train_scale_, test_scale_, train_scale, test_scale","14b2f3c9":"pca = PCA(n_components=3)\npca.fit(train)\npca_train = pca.transform(train)\npca_test = pca.transform(test)","fad7d7cd":"train['pca_col1'] = pca_train[:, 0]\ntrain['pca_col2'] = pca_train[:, 1]\ntrain['pca_col3'] = pca_train[:, 2]\n\ntest['pca_col1'] = pca_test[:, 0]\ntest['pca_col2'] = pca_test[:, 1]\ntest['pca_col3'] = pca_test[:, 2]\n\ndel pca_train, pca_test","1b3e610c":"train.columns","41f6f524":"# Split train set \/ valid set\nx_train, x_val, y_train, y_val = train_test_split(train, train_target, test_size=0.3, random_state=42)","b6ad0177":"# LightGBM\nlgb_train = lgb.Dataset(x_train, y_train, categorical_feature=categorical_features)\nlgb_val = lgb.Dataset(x_val, y_val, categorical_feature=categorical_features)\n\n# parameters\nparams = {\n    'objective':'binary',\n    'boosting_type': 'gbdt',\n    'max_depth': -1,\n    'learning_rate': 0.03,\n    'num_leaves': 500,        # number of leaves in full tree\n    'feature_fraction':0.7,   # selected parameters ratio in each iteration for building trees\n    'bagging_fraction':0.8,   # specifies the fraction of data to be used for each iteration\n    'bagging_seed':11,        # random seed for bagging\n    'n_jobs':-1,\n    'verbosity': -1\n}\n\n# Training\nlgb_model = lgb.train(params, lgb_train, valid_sets=[lgb_train, lgb_val],\n                     num_boost_round=3000,\n                     early_stopping_rounds=500,\n                     verbose_eval=100)","65b27a52":"val_preds_lgb = [1 if i>=0.5 else 0 for i in lgb_model.predict(x_val)]\n\nprint('Accuracy : {:.2f}'.format(accuracy_score(val_preds_lgb, y_val)))\nprint('Recall : {:.2f}'.format(recall_score(val_preds_lgb, y_val)))\nprint(classification_report(val_preds_lgb, y_val))","705278a9":"# feature importances\nfeature_importance = lgb_model.feature_importance()\ndf_fi = pd.DataFrame({'columns':x_train.columns, 'importances':feature_importance})\ndf_fi = df_fi[df_fi['importances'] > 500].sort_values(by=['importances'], ascending=False)\n\nfig = plt.figure(figsize=(15, 6))\nax = sns.barplot(df_fi['columns'], df_fi['importances'])\nax.set_xticklabels(df_fi['columns'], rotation=80, fontsize=13)\nplt.title('Feature Importance')\nplt.tight_layout()\nplt.show()","c59f098f":"test_preds = lgb_model.predict(test)","744d9492":"test_pred_df = pd.DataFrame()\ntest_pred_df['TransactionID'] = test_tid\ntest_pred_df['isFraud'] = test_preds","d8bdf7e8":"test_pred_df.head(10)","062b0770":"test_pred_df.to_csv('lgb_submission.csv', index=False)","54e6fa44":"## LightGBM model","5d64a45f":"## EDA\n- Ratio of isFraud by column\n- Distribution of TransactionAmt by isFraud\n- Distribution of TransactionAmt by DeviceType","23fd5bce":"### Check Null ratio\ncheck null ratio by column and drop columns with null ratio >= 0.77","5a89944d":"#### Distribution of TransactionAmt by isFraud","59c6fc71":"### Fill Na by column type","86c842e6":"#### Z-Score Standardization","b96fcca1":"## Load Data\nLoad identity.csv and transaction.csv","deebb513":"#### Distribution of TransactionAmt by DeviceType","9a0f4254":"#### Label Encoding","f73fa3b5":"#### Adding PCA variables","485dbc48":"#### Corrleations","dc9b0d74":"## Save Prediction of test to *.csv","97cc8007":"#### Data Simplication\n- mobile os \/ browers \/ email domain","c4b85224":"## Data Preprocessing","dd93c46c":"#### Ratio of isFraud by column","ee87256d":"## Data Merge\nMerge identity data and transaction data on 'TransactionID' column. "}}