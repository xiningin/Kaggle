{"cell_type":{"964cd67b":"code","d25e32b1":"code","0cf6f6fd":"code","25982453":"code","6e863897":"code","8f49ad5d":"code","2d0c4c75":"code","da9b4b33":"code","a264e70b":"code","288b2940":"code","8c574a1e":"code","914b0e8f":"code","9d4a800f":"code","df9ad936":"code","7497c17e":"code","6075b6c8":"markdown","d933a138":"markdown"},"source":{"964cd67b":"import numpy as np\nimport pandas as pd\nimport matplotlib.pyplot as plt\nimport cv2, os, json, rasterio\n\nfrom sklearn.preprocessing import *\n\nfrom tensorflow.keras.models import load_model\n# from tensorflow.keras.preprocessing.image import load_img, img_to_array\n# from tensorflow.keras.applications.resnet_v2 import preprocess_input","d25e32b1":"def sliding_window(tif, stepSize, windowSize):\n    \n    for y in range(0, tif.shape[0], stepSize):\n        for x in range(0, tif.shape[1], stepSize):\n            \n            yield(x,y, tif[y:y + windowSize[1], x:x+windowSize[0]])\n            pass\n        pass\n    pass","0cf6f6fd":"def Normalise(arr_band):\n    \n    arr_band = Normalizer().fit_transform(arr_band)\n    return arr_band\n    pass","25982453":"def preprocess_input(sub_tile):\n    \n    for i in range(0,6):\n        sub_tile[:,:,i] = Normalise(sub_tile[:,:,i])\n        pass\n    \n    return sub_tile\n    pass","6e863897":"loc_prob_df = pd.DataFrame(columns=[\"TileNumber\",\"Class\",\"Probability\",\"AnnualCrop\",\"Forest\",\"HerbaceousVegetation\",\"Highway\",\"Industrial\",\n                                   \"Pasture\",\"PermanentCrop\",\"Residential\",\"River\",\"SeaLake\"])","8f49ad5d":"# Loading saved TensorFlow model\nmodel = load_model(\"..\/input\/eurosat-allbands-classification\/6bands_v5-5.h5\")\n# Loading the best weights found while training\nmodel.load_weights(\"..\/input\/eurosat-allbands-classification\/6bands_weights_v5-5.h5\")\n\n# Printing summary of the model\nmodel.summary()","2d0c4c75":"bands = {'1':1, '2':2, '3':3, '4':4, '5':5, '6':6, '7':7, '8':8, '8a':9, '9':10, '10':11, '11':12, '12':13}\nbands_L2A = {'1':1, '2':2, '3':3, '4':4, '5':5, '6':6, '7':7, '8':8, '8a':9, '9':10, '11':11, '12':12}","da9b4b33":"src = rasterio.open(\"..\/input\/testdata\/BombayV2-Merged.tif\")","a264e70b":"%%time\narr_3, arr_4, arr_8 = src.read(bands['3']), src.read(bands['4']), src.read(bands['8'])\narr_6, arr_7 = src.read(bands['6']), src.read(bands['7'])\narr_11 = src.read(bands['11'])\n\narr_3 = np.array(arr_3, dtype=np.float32)\narr_4 = np.array(arr_4, dtype=np.float32)\narr_6, arr_7 = np.array(arr_6, dtype=np.float32), np.array(arr_7, dtype=np.float32)\narr_8 = np.array(arr_8, dtype=np.float32)\narr_11 = np.array(arr_11, dtype=np.float32)","288b2940":"%%time\nbands_10_20 = np.dstack((arr_3, arr_4, arr_6, arr_7, arr_8, arr_11))\n\nbands_10_20.shape","8c574a1e":"test_img = cv2.imread(\"..\/input\/testdata\/TCI-BombayV2.png\")","914b0e8f":"with open(\"..\/input\/testdata\/label_map.json\",\"r\") as f:\n    class_names = json.load(f)\n    pass\n\nclass_names = {i:k for k,i in class_names.items()}\nclass_count = {k:0 for i,k in class_names.items()}\nclasses = list(class_names.values())\n\nprint(\"Class names and their labels : {}\".format(class_names))\nprint(\"Class Names : {}\".format(classes))\nprint(\"Classes and the number of times they have been detected : {}\".format(class_count))","9d4a800f":"%%time\n\nc = 0\n\nfor (x,y, roiOrig) in sliding_window(bands_10_20, 64, (64,64)):\n    \n    roi = preprocess_input(roiOrig)\n    roi = cv2.resize(roiOrig, dsize=(64, 64), interpolation=cv2.INTER_CUBIC)\n    roi = np.expand_dims(roi, axis=0)\n    # print(roi.shape)\n\n    pred_value = model.predict(roi) # predicting the land use\n    pred_prob = np.max(pred_value)\n    pred_name = class_names[np.argmax(pred_value)]\n    class_count[pred_name] += 1\n    # print(pred_value)\n    \n    cv2.rectangle(test_img, (x,y), (x+64,y+64), (0,255,0),2)\n    label = \"{}\".format(pred_name)\n    prob = \"{:.2f}%\".format(pred_prob*100)\n    label_bin = \"{}\".format(np.argmax(pred_value))\n\n    # Storing tile number and predicted class label\n    tileNumber = \"{}\".format(c+1)\n    cv2.putText(test_img, tileNumber, (x+2,y+15), cv2.FONT_HERSHEY_SIMPLEX, 0.35, (0,0,255), 1)\n    cv2.putText(test_img, label_bin, (x+2,(2*y+64)\/\/2), cv2.FONT_HERSHEY_SIMPLEX, 0.45, (0,255,0), 1)\n    \n    label_prob = \"{} {}\".format(label, prob)\n\n    loc_prob_df = loc_prob_df.append({'TileNumber':tileNumber,'Class':label,'Probability':prob,\n                                      \"AnnualCrop\":pred_value[0][0],\"Forest\":pred_value[0][1],\n                                      \"HerbaceousVegetation\":pred_value[0][2],\"Highway\":pred_value[0][3],\n                                      \"Industrial\":pred_value[0][4],\"Pasture\":pred_value[0][5],\n                                      \"PermanentCrop\":pred_value[0][6],\"Residential\":pred_value[0][7],\n                                      \"River\":pred_value[0][8],\"SeaLake\":pred_value[0][9]}, ignore_index=True)\n\n    c += 1\n    print(\"\\r{}\".format(c),end=\"\")\n    pass\n\nprint()","df9ad936":"loc_prob_df.shape","7497c17e":"print(\"[INFO] Saving image with bounding box, class label and tile number\")\ncv2.imwrite(\"Model-V5_5-BombayV2.png\",test_img)\n\nprint(class_count)\n\nprint(\"[INFO] Saving results to a CSV file\")\nloc_prob_df.to_csv(\"Model-V5_5-BombayV2.csv\", index=False)","6075b6c8":"* Without Clause\n\nVersion Number | Tile | Level | Model\n-------------- | ---- | ----- | -----\n5 | Bangalore | L1C | Model V5-3 \n6 | Jakarta | L1C | Model V5-3\n7 | Bombay | L1C | Model V5-3\n8 | Bangalore | L2A | Model V5-3\n9 | Calais | L2A | Model V5-3\n16 | Bangalore | L1C | Model V5-4\n18 | Jakarta | L1C | Model V5-4\n19 | Bombay | L1C | Model V5-4\n20 | Delhi | L1C | Model V5-4\n22 | Bombay | L1C | Model V5-5\n23 | Jakarta | L1C | Model V5-5\n24 | Mathura, Vizag | L1C | Model V5-5\n25 | Bombay V2 | L1C | Model V5-5\n\n* With Clause\n\nVersion Number | Tile | Model\n-------------- | ---- | -----\n10 | Bangalore | Model V5-3\n11 | Bombay | Model V5-3\n12 | Jakarta | Model V5-3\n\n> Version 21 : Taking features of Misclassified SeaLake and comparing them to Forest Dataset.","d933a138":"# Classifying sub-tiles within the tile"}}