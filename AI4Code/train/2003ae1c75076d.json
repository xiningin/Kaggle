{"cell_type":{"f50cc832":"code","fda0439b":"code","930e9af5":"code","4707e1a0":"code","5380c889":"code","8a3263d0":"code","699e8ab0":"code","2d215097":"code","a33c4c9f":"code","8c6d44ac":"code","ce036159":"code","4453292b":"code","83ca5c19":"code","2cda6a3e":"code","2798055c":"code","e7b3feec":"code","885a5aa2":"code","5c3ef390":"code","b3b7fd93":"code","97129e2a":"code","9ac93b2a":"code","c820df30":"code","7d9fe0e5":"code","27fea94b":"markdown","0205acc8":"markdown","87061723":"markdown","79651c32":"markdown","73c6328b":"markdown","5e74c1e3":"markdown","71c61533":"markdown","dc6953ca":"markdown","80a1d95e":"markdown","fc5dbe6e":"markdown","cf355e78":"markdown","be7bd680":"markdown","1670845e":"markdown","5c46dcd9":"markdown","0e804755":"markdown","a299ef69":"markdown","30c16431":"markdown","f4d35169":"markdown","c31f5402":"markdown","2c8acfb3":"markdown","239ba880":"markdown","be3ea0c0":"markdown","2bfe0923":"markdown"},"source":{"f50cc832":"# Check nvcc version\n!nvcc -V\n# Check GCC version\n!gcc --version","fda0439b":"import torch","930e9af5":"%%time\n\nprint(\"this will take around 9 mins\")\n# install dependencies: (use cu101 because colab has CUDA 10.1)\n# !pip install -U torch==1.7.0+cu101 torchvision==0.6.1+cu101 -f https:\/\/download.pytorch.org\/whl\/torch_stable.html\n\n# install mmcv-full thus we could use CUDA operators\n!pip install mmcv-full\n\n\n","4707e1a0":"!rm -rf mmdetection\n!git clone --branch v2.7.0 https:\/\/github.com\/open-mmlab\/mmdetection.git\n%cd mmdetection\n\n!pip install -e .\n\n# install Pillow 7.0.0 back in order to avoid bug in colab\n!pip install Pillow==7.0.0","5380c889":"# Check Pytorch installation\nimport torch, torchvision\nprint(torch.__version__, torch.cuda.is_available())\n\n# Check MMDetection installation\nimport mmdet\nprint(mmdet.__version__)\n\n# Check mmcv installation\nfrom mmcv.ops import get_compiling_cuda_version, get_compiler_version\nprint(get_compiling_cuda_version())\nprint(get_compiler_version())","8a3263d0":"!mkdir checkpoints\n# !wget -c http:\/\/download.openmmlab.com\/mmdetection\/v2.0\/mask_rcnn\/mask_rcnn_r50_caffe_fpn_mstrain-poly_3x_coco\/mask_rcnn_r50_caffe_fpn_mstrain-poly_3x_coco_bbox_mAP-0.408__segm_mAP-0.37_20200504_163245-42aa3d00.pth \\\n#       -O checkpoints\/mask_rcnn_r50_caffe_fpn_mstrain-poly_3x_coco_bbox_mAP-0.408__segm_mAP-0.37_20200504_163245-42aa3d00.pth\n\n\n!wget -c https:\/\/s3.ap-northeast-2.amazonaws.com\/open-mmlab\/mmdetection\/models\/cascade_rcnn_x101_32x4d_fpn_1x_20190501-af628be5.pth \\\n      -O checkpoints\/cascade_rcnn_x101_32x4d_fpn_1x_20190501-af628be5.pth\n","699e8ab0":"from mmdet.apis import inference_detector, init_detector, show_result_pyplot\n\n# Choose to use a config and initialize the detector\n# config = 'configs\/mask_rcnn\/mask_rcnn_r50_caffe_fpn_mstrain-poly_3x_coco.py'\n\nconfig = 'configs\/cascade_rcnn\/cascade_rcnn_x101_32x4d_fpn_1x_coco.py'\n# Setup a checkpoint file to load\n# checkpoint = 'checkpoints\/mask_rcnn_r50_caffe_fpn_mstrain-poly_3x_coco_bbox_mAP-0.408__segm_mAP-0.37_20200504_163245-42aa3d00.pth'\ncheckpoint = 'checkpoints\/cascade_rcnn_x101_32x4d_fpn_1x_20190501-af628be5.pth'\n# initialize the detector\nmodel = init_detector(config, checkpoint, device='cuda:0')","2d215097":"# Use the detector to do inference\nimg = 'demo\/demo.jpg'\nresult = inference_detector(model, img)","a33c4c9f":"# Let's plot the result\nshow_result_pyplot(model, img, result, score_thr=0.1)","8c6d44ac":"from mmcv import Config\ncfg = Config.fromfile('.\/configs\/cascade_rcnn\/cascade_rcnn_x101_32x4d_fpn_1x_coco.py')\n\n","ce036159":"cfg","4453292b":"cfg.model.roi_head.bbox_head","83ca5c19":"from mmdet.apis import set_random_seed\n\ncfg.dataset_type = 'CocoDataset'\ncfg.classes = (\"Aortic_enlargement\", \"Atelectasis\", \"Calcification\", \"Cardiomegaly\", \"Consolidation\", \"ILD\", \"Infiltration\", \"Lung_Opacity\", \"Nodule\/Mass\", \"Other_lesion\", \"Pleural_effusion\", \"Pleural_thickening\", \"Pneumothorax\", \"Pulmonary_fibrosis\")\n\ncfg.data.train.img_prefix = '..\/..\/input\/vinbigdata-coco-dataset-with-wbf-3x-downscaled\/vinbigdata-coco-dataset-with-wbf-3x-downscaled\/'\ncfg.data.train.classes = cfg.classes\ncfg.data.train.ann_file = '..\/..\/input\/vinbigdata-coco-dataset-with-wbf-3x-downscaled\/vinbigdata-coco-dataset-with-wbf-3x-downscaled\/train_annotations.json'\ncfg.data.train.type='CocoDataset'\n\n\ncfg.data.val.img_prefix = '..\/..\/input\/vinbigdata-coco-dataset-with-wbf-3x-downscaled\/vinbigdata-coco-dataset-with-wbf-3x-downscaled\/'\ncfg.data.val.classes = cfg.classes\ncfg.data.val.ann_file = '..\/..\/input\/vinbigdata-coco-dataset-with-wbf-3x-downscaled\/vinbigdata-coco-dataset-with-wbf-3x-downscaled\/val_annotations.json'\ncfg.data.val.type='CocoDataset'\n\n\n\ncfg.data.test.img_prefix = '..\/..\/input\/vinbigdata-coco-dataset-with-wbf-3x-downscaled\/vinbigdata-coco-dataset-with-wbf-3x-downscaled\/'\ncfg.data.test.classes = cfg.classes\ncfg.data.test.ann_file = '..\/..\/input\/vinbigdata-coco-dataset-with-wbf-3x-downscaled\/vinbigdata-coco-dataset-with-wbf-3x-downscaled\/val_annotations.json'\ncfg.data.test.type='CocoDataset'\n\n\n\n\n# cfg.model.roi_head.bbox_head.num_classes = 14\n\ncfg.model.roi_head.bbox_head[0].num_classes = 14\ncfg.model.roi_head.bbox_head[1].num_classes = 14\ncfg.model.roi_head.bbox_head[2].num_classes = 14\n\n\ncfg.data.train.type = 'CocoDataset'\ncfg.data.val.type = 'CocoDataset'\ncfg.data.test.type = 'CocoDataset'\n\ncfg.optimizer.lr = 0.02 \/ 8\ncfg.lr_config.warmup = None\ncfg.log_config.interval = 10\n\n# Change the evaluation metric since we use customized dataset.\ncfg.evaluation.metric = 'bbox'\n# We can set the evaluation interval to reduce the evaluation times\ncfg.evaluation.interval = 12\n# We can set the checkpoint saving interval to reduce the storage cost\ncfg.checkpoint_config.interval = 10\n\n# Set seed thus the results are more reproducible\ncfg.seed = 0\nset_random_seed(0, deterministic=False)\ncfg.gpu_ids = range(1)\n\n# we can use here mask_rcnn.\ncfg.load_from = '.\/checkpoints\/cascade_rcnn_x101_32x4d_fpn_1x_20190501-af628be5.pth'\ncfg.work_dir = \"..\/vinbig_output\"\n\n# One Epoch takes around 18 mins\ncfg.total_epochs = 21","2cda6a3e":"# the dataset has been taken : https:\/\/www.kaggle.com\/sreevishnudamodaran\/vinbigdata-fusing-bboxes-coco-dataset\nimport os\nos.listdir(\"..\/..\/input\/vinbigdata-coco-dataset-with-wbf-3x-downscaled\/vinbigdata-coco-dataset-with-wbf-3x-downscaled\")","2798055c":"# for saving checkpoint and plots\nimport os\nos.makedirs('..\/vinbig_output')","e7b3feec":"print(f'Config:\\n{cfg.pretty_text}')","885a5aa2":"from mmdet.datasets import build_dataset\nfrom mmdet.models import build_detector\nfrom mmdet.apis import train_detector","5c3ef390":"model = build_detector(\n    cfg.model, train_cfg=cfg.train_cfg, test_cfg=cfg.test_cfg)\n\n","b3b7fd93":"datasets = [build_dataset(cfg.data.train)]","97129e2a":"# cfg.lr_config.policy='step'\ntrain_detector(model, datasets[0], cfg, distributed=False, validate=True)\n","9ac93b2a":"os.chdir('..\/')\n","c820df30":"\n!python mmdetection\/tools\/analyze_logs.py plot_curve .\/vinbig_output\/None.log.json --keys loss_cls --legend loss_cls --out \"loss_cls\"","7d9fe0e5":"!rm -rf \".\/mmdetection\"","27fea94b":"![image.png](attachment:image.png)","0205acc8":"# Building Dataset","87061723":"The aim of this notebook is to install and run a training pipeline using MMDET Framework.","79651c32":"# Features","73c6328b":"# Downloading Checkpoint For Demo","5e74c1e3":"# MMDet Framework","71c61533":"# Verifying Installation","dc6953ca":"# Plotting Classification Loss","80a1d95e":"Dataset Source: https:\/\/www.kaggle.com\/sreevishnudamodaran\/vinbigdata-fusing-bboxes-coco-dataset","fc5dbe6e":"Check the output dir for the plot.","cf355e78":"3. **High Efficiency**\n    1. All basic bbox and mask operations run on GPUs. The training speed is faster than or comparable to other codebases, including Detectron2, maskrcnn-benchmark and SimpleDet.","be7bd680":"# Building MMDet From Source","1670845e":"1. **Modular Design**\n    1. The detection framework is decomposed into different components. This gives the flexiblity to construct a customized object detection framework using different backbones and models.\n    \n    2. The framework mainly contains following parts:\n    \n        1. Config: This is the place where you get to set the configurations for the framwork like data dirs, num of epochs, gpus to use etc.\n        2. mmdet: This module contains the files related to backbones, necks, heads and losses etc.\n        \n        3. Tools: This is the directory that contains utilities for training, testing and computing the evaluation metric.\n","5c46dcd9":"# Configuration Settings On BaseConfig","0e804755":"# Prereq: MMCV(~9 mins)","a299ef69":"# Installing MMDet Framework","30c16431":"# Training Detector With BBox Eval","f4d35169":"# Sample Inference Demo","c31f5402":"# Initializing Detector","2c8acfb3":"# MMDet on VinBigData","239ba880":"MMDetection is an open source object detection toolbox based on PyTorch. It is a part of the OpenMMLab project developed by Multimedia Laboratory, CUHK.","be3ea0c0":"I am using here faster rcnn for the demo purpose but as listed above the training pipeline can be customized using different framework and backbones. Just need to change the config settings down here. The config dir of mmdet framework contains various implmentation. Do checkit out.","2bfe0923":"2. **Multiple Frameworks**(https:\/\/github.com\/open-mmlab\/mmdetection)\n    1. List of Supported Backbones\n    \n        1. ResNet (CVPR'2016)\n        2. ResNeXt (CVPR'2017)\n        3. VGG (ICLR'2015)\n        4. HRNet (CVPR'2019)\n        5. RegNet (CVPR'2020)\n        6. Res2Net (TPAMI'2020)\n        7. ResNeSt (ArXiv'2020)\n    2. Supported Frameworks\n        1. [RPN (NeurIPS'2015)](https:\/\/github.com\/open-mmlab\/mmdetection\/blob\/master\/configs\/rpn)\n        2. [Fast R-CNN (ICCV'2015)](https:\/\/github.com\/open-mmlab\/mmdetection\/blob\/master\/configs\/fast_rcnn)\n        3. [Faster R-CNN (NeurIPS'2015)](https:\/\/github.com\/open-mmlab\/mmdetection\/blob\/master\/configs\/faster_rcnn)\n        4. [Mask R-CNN (ICCV'2017)](https:\/\/github.com\/open-mmlab\/mmdetection\/blob\/master\/configs\/mask_rcnn)\n        5. [Cascade R-CNN (CVPR'2018)](https:\/\/github.com\/open-mmlab\/mmdetection\/blob\/master\/configs\/cascade_rcnn)\n        6. [Cascade Mask R-CNN (CVPR'2018)](https:\/\/github.com\/open-mmlab\/mmdetection\/blob\/master\/configs\/cascade_rcnn)\n        7. [SSD (ECCV'2016)](https:\/\/github.com\/open-mmlab\/mmdetection\/blob\/master\/configs\/ssd)\n        8. [RetinaNet (ICCV'2017)](https:\/\/github.com\/open-mmlab\/mmdetection\/blob\/master\/configs\/retinanet)\n        9. [GHM (AAAI'2019)](https:\/\/github.com\/open-mmlab\/mmdetection\/blob\/master\/configs\/ghm)\n        10. [Mask Scoring R-CNN (CVPR'2019)](https:\/\/github.com\/open-mmlab\/mmdetection\/blob\/master\/configs\/ms_rcnn)\n        11. [Double-Head R-CNN (CVPR'2020)](https:\/\/github.com\/open-mmlab\/mmdetection\/blob\/master\/configs\/double_heads)\n        12. [Hybrid Task Cascade (CVPR'2019)](https:\/\/github.com\/open-mmlab\/mmdetection\/blob\/master\/configs\/htc)\n        13. [Libra R-CNN (CVPR'2019)](https:\/\/github.com\/open-mmlab\/mmdetection\/blob\/master\/configs\/libra_rcnn)\n        14. [Guided Anchoring (CVPR'2019)](https:\/\/github.com\/open-mmlab\/mmdetection\/blob\/master\/configs\/guided_anchoring)\n        15. [FCOS (ICCV'2019)](https:\/\/github.com\/open-mmlab\/mmdetection\/blob\/master\/configs\/fcos)\n        16. [RepPoints (ICCV'2019)](https:\/\/github.com\/open-mmlab\/mmdetection\/blob\/master\/configs\/reppoints)\n        17. [Foveabox (TIP'2020)](https:\/\/github.com\/open-mmlab\/mmdetection\/blob\/master\/configs\/foveabox)\n        18. [FreeAnchor (NeurIPS'2019)](https:\/\/github.com\/open-mmlab\/mmdetection\/blob\/master\/configs\/free_anchor)\n        19. [NAS-FPN (CVPR'2019)](https:\/\/github.com\/open-mmlab\/mmdetection\/blob\/master\/configs\/nas_fpn)\n        20. [ATSS (CVPR'2020)](https:\/\/github.com\/open-mmlab\/mmdetection\/blob\/master\/configs\/atss)\n        21. [FSAF (CVPR'2019)](https:\/\/github.com\/open-mmlab\/mmdetection\/blob\/master\/configs\/fsaf)\n        22. [PAFPN (CVPR'2018)](https:\/\/github.com\/open-mmlab\/mmdetection\/blob\/master\/configs\/pafpn)\n        23. [Dynamic R-CNN (ECCV'2020)](https:\/\/github.com\/open-mmlab\/mmdetection\/blob\/master\/configs\/dynamic_rcnn)\n        24. [PointRend (CVPR'2020)](https:\/\/github.com\/open-mmlab\/mmdetection\/blob\/master\/configs\/point_rend)\n        25. [CARAFE (ICCV'2019)](https:\/\/github.com\/open-mmlab\/mmdetection\/blob\/master\/configs\/carafe\/README.md)\n        26. [DCNv2 (CVPR'2019)](https:\/\/github.com\/open-mmlab\/mmdetection\/blob\/master\/configs\/dcn\/README.md)\n        27. [Group Normalization (ECCV'2018)](https:\/\/github.com\/open-mmlab\/mmdetection\/blob\/master\/configs\/gn\/README.md)\n        28. [Weight Standardization (ArXiv'2019)](https:\/\/github.com\/open-mmlab\/mmdetection\/blob\/master\/configs\/gn+ws\/README.md)\n        29. [OHEM (CVPR'2016)](https:\/\/github.com\/open-mmlab\/mmdetection\/blob\/master\/configs\/faster_rcnn\/faster_rcnn_r50_fpn_ohem_1x_coco.py)\n        30. [Soft-NMS (ICCV'2017)](https:\/\/github.com\/open-mmlab\/mmdetection\/blob\/master\/configs\/faster_rcnn\/faster_rcnn_r50_fpn_soft_nms_1x_coco.py)\n        31. [Generalized Attention (ICCV'2019)](https:\/\/github.com\/open-mmlab\/mmdetection\/blob\/master\/configs\/empirical_attention\/README.md)\n        32. [GCNet (ICCVW'2019)](https:\/\/github.com\/open-mmlab\/mmdetection\/blob\/master\/configs\/gcnet\/README.md)\n        33. [Mixed Precision (FP16) Training (ArXiv'2017)](https:\/\/github.com\/open-mmlab\/mmdetection\/blob\/master\/configs\/fp16\/README.md)\n        34. [InstaBoost (ICCV'2019)](https:\/\/github.com\/open-mmlab\/mmdetection\/blob\/master\/configs\/instaboost\/README.md)\n        35. [GRoIE (ICPR'2020)](https:\/\/github.com\/open-mmlab\/mmdetection\/blob\/master\/configs\/groie\/README.md)\n        36. [DetectoRS (ArXix'2020)](https:\/\/github.com\/open-mmlab\/mmdetection\/blob\/master\/configs\/detectors\/README.md)\n        37. [Generalized Focal Loss (NeurIPS'2020)](https:\/\/github.com\/open-mmlab\/mmdetection\/blob\/master\/configs\/gfl\/README.md)\n        38. [CornerNet (ECCV'2018)](https:\/\/github.com\/open-mmlab\/mmdetection\/blob\/master\/configs\/cornernet\/README.md)\n        39. [Side-Aware Boundary Localization (ECCV'2020)](https:\/\/github.com\/open-mmlab\/mmdetection\/blob\/master\/configs\/sabl\/README.md)\n        40. [YOLOv3 (ArXiv'2018)](https:\/\/github.com\/open-mmlab\/mmdetection\/blob\/master\/configs\/yolo\/README.md)\n        41. [PAA (ECCV'2020)](https:\/\/github.com\/open-mmlab\/mmdetection\/blob\/master\/configs\/paa\/README.md)\n        42. [YOLACT (ICCV'2019)](https:\/\/github.com\/open-mmlab\/mmdetection\/blob\/master\/configs\/yolact\/README.md)\n        43. [CentripetalNet (CVPR'2020)](https:\/\/github.com\/open-mmlab\/mmdetection\/blob\/master\/configs\/centripetalnet\/README.md)\n        44. [VFNet (ArXix'2020)](https:\/\/github.com\/open-mmlab\/mmdetection\/blob\/master\/configs\/vfnet\/README.md)\n        45. [DETR (ECCV'2020)](https:\/\/github.com\/open-mmlab\/mmdetection\/blob\/master\/configs\/detr\/README.md)\n        46. [CascadeRPN (NeurIPS'2019)](https:\/\/github.com\/open-mmlab\/mmdetection\/blob\/master\/configs\/cascade_rpn\/README.md)\n        47. [SCNet (AAAI'2021)](https:\/\/github.com\/open-mmlab\/mmdetection\/blob\/master\/configs\/scnet\/README.md)"}}