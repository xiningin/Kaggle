{"cell_type":{"962c0ada":"code","911ed745":"code","d61e06ae":"code","f9826129":"code","241350d0":"code","eb721806":"code","95472577":"code","b6806105":"code","25742d3e":"code","2dfe52d0":"code","18df1d10":"code","24996677":"code","640eb53e":"code","36ad07ca":"code","51449178":"markdown","9ea5292d":"markdown","9d2e732d":"markdown","b1f344a2":"markdown"},"source":{"962c0ada":"!pip install -U -q efficientnet","911ed745":"import tensorflow as tf\nimport numpy as np\nimport pandas as pd\nfrom matplotlib import pyplot as plt\nfrom kaggle_datasets import KaggleDatasets\nimport efficientnet.tfkeras as efn\nfrom tqdm import tqdm\nfrom pathlib import Path\n\nfrom tensorflow.keras.preprocessing.image import ImageDataGenerator\nfrom tensorflow.keras.callbacks import EarlyStopping, ModelCheckpoint\n\nprint(\"tf version \" + tf.__version__)","d61e06ae":"# there are some issues with dataset - unable to load it to GCS now\nGCS_DS_PATH = KaggleDatasets().get_gcs_path()\nGCS_DS_PATH","f9826129":"try:\n    tpu = tf.distribute.cluster_resolver.TPUClusterResolver()\n    tf.config.experimental_connect_to_cluster(tpu)\n    tf.tpu.experimental.initialize_tpu_system(tpu)\n    strategy = tf.distribute.experimental.TPUStrategy(tpu)\n    print(\"Running on TPU\", tpu.master())\nexcept ValueError:\n    strategy = tf.distribute.get_strategy()\n    print(\"Running on GPU\")\n\nprint(\"REPLICAS: \", strategy.num_replicas_in_sync)","241350d0":"BASE_PATH = Path(\"..\") \/ \"input\" \/ \"siim-isic-melanoma-classification\"\nSHAPE = (224, 224, 3)\nBATCH_SIZE = 64","eb721806":"train_df = pd.read_csv(BASE_PATH \/ \"train.csv\")\ntest_df = pd.read_csv(BASE_PATH \/ \"test.csv\")\n\ntrain_df[\"image_path\"] = train_df.apply(lambda x: str(\n    BASE_PATH \/ \"jpeg\" \/ \"train\" \/ f\"{x.image_name}.jpg\"), axis=1)\ntest_df[\"image_path\"] = test_df.apply(lambda x: str(\n    BASE_PATH \/ \"jpeg\" \/ \"test\" \/ f\"{x.image_name}.jpg\"), axis=1)\n\n\ntrain_df.head()","95472577":"base_data_gen = dict(\n    rescale=1\/255.,\n    horizontal_flip=True,\n    vertical_flip=True,\n)\n\ntrain_datagen = ImageDataGenerator(\n    **base_data_gen,\n    zoom_range=0.1,\n    validation_split=0.1,\n)\n# for TTA\ntest_datagen = ImageDataGenerator(\n    **base_data_gen\n)\n\ngen_args = dict(\n    dataframe=train_df,\n    x_col=\"image_path\",\n    y_col=\"benign_malignant\",\n    batch_size=BATCH_SIZE,\n    seed=42,\n    target_size=SHAPE[:2],\n    color_mode=\"grayscale\" if SHAPE[-1] == 1 else \"rgb\",\n    class_mode=\"binary\",\n    shuffle=True,\n)\n\ntrain_gen = train_datagen.flow_from_dataframe(\n    **gen_args,\n    subset=\"training\"\n)\n\nvalid_gen = train_datagen.flow_from_dataframe(\n    **gen_args,\n    subset=\"validation\"\n)\n\ntest_gen = test_datagen.flow_from_dataframe(\n    dataframe=test_df,\n    x_col=\"image_path\",\n    y_col=None,\n    batch_size=BATCH_SIZE,\n    target_size=SHAPE[:2],\n    color_mode=\"grayscale\" if SHAPE[-1] == 1 else \"rgb\",\n    shuffle=False,\n    class_mode=None\n)","b6806105":"def plot_examples(images_arr):\n  fig, axes = plt.subplots(1, 5, figsize=(15,15))\n  axes = axes.flatten()\n  for img, ax in zip(images_arr, axes):\n    ax.imshow(img.reshape(SHAPE), cmap=\"gray\")\n    ax.axis(\"off\")\n  plt.tight_layout()\n  plt.show()\n\n\nsample_training_images, _ = next(train_gen)\nplot_examples(sample_training_images)","25742d3e":"def create_model(input_shape):\n    base_model = efn.EfficientNetB0(\n        weights=\"noisy-student\", include_top=False, input_shape=input_shape\n    )\n    model = tf.keras.Sequential([\n        base_model,\n        tf.keras.layers.GlobalAveragePooling2D(),\n        tf.keras.layers.Dense(1, activation=\"sigmoid\")\n    ])\n\n    return model","2dfe52d0":"with strategy.scope():\n    model = create_model(input_shape=SHAPE)\n    model.compile(\n        optimizer=tf.keras.optimizers.Adam(),\n        loss=\"binary_crossentropy\",\n        metrics=[\"accuracy\"]\n    )\n    model.summary()","18df1d10":"%%time\n\ncallbacks = [\n    ModelCheckpoint(filepath=\"weights.hdf5\", verbose=1, save_best_only=True),\n    EarlyStopping(monitor=\"val_loss\", patience=5),\n]\nsteps_per_epoch = len(train_gen.filenames) \/\/ BATCH_SIZE\nvalidation_steps = len(valid_gen.filenames) \/\/ BATCH_SIZE\n\nhistory = model.fit(\n    train_gen,\n    steps_per_epoch=steps_per_epoch,\n    epochs=1000,\n    validation_data=valid_gen,\n    validation_steps=validation_steps,\n    verbose=1,\n)","24996677":"history_df = pd.DataFrame(history.history)\nhistory_df[['loss', 'val_loss']].plot()\nhistory_df[['acc', 'val_acc']].plot()","640eb53e":"tta = []\ntta_steps = 10\ntest_steps = len(test_gen.filenames) \/\/ BATCH_SIZE\n\nfor _ in tqdm(range(tta_steps)):\n    test_gen.reset()\n    preds = model.predict_generator(\n        generator=test_gen,\n        steps=test_steps\n    )\n    tta.append(preds)\n\ntta_mean = np.mean(tta, axis=0)","36ad07ca":"labels = train_gen.class_indices\n\nsub_df =  pd.read_csv(BASE_PATH \/ \"sample_submission.csv\")\nsub_df.target = tta_mean\nsub_df.to_csv(\"submission.csv\", index=False)\nsub_df.head()","51449178":"## Base TensorFlow EfficientNetB0 on noisy-student weights + TTA","9ea5292d":"### Submission","9d2e732d":"### TTA","b1f344a2":"### EfficientNetB0 on nosy-student"}}