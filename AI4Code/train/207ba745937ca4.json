{"cell_type":{"c9db98b7":"code","e3afa6e2":"code","f09b7b92":"code","21d618f5":"code","47edd732":"code","f80df756":"code","3fc9a0f5":"code","67122d68":"code","a2a52c4b":"code","8d68680a":"code","531fffb5":"code","2a6a93ba":"code","a44af4d4":"code","dc3d48b6":"code","f1f83edc":"code","9e4ac8de":"code","a4d3e0c1":"code","e996c601":"code","511036a4":"code","8a2ce6cb":"code","1cb02c82":"code","2828f2aa":"code","cfd2c277":"code","66d6c34e":"code","c38b890b":"code","264ac9a3":"code","bd24face":"code","626c70c9":"markdown","661733f8":"markdown","a797e580":"markdown","26f6310f":"markdown","11bc9be1":"markdown","7203565c":"markdown","ac5ea2e3":"markdown","0c88739b":"markdown","614518cf":"markdown","608801a6":"markdown","47b50579":"markdown","d07cb45f":"markdown","8f98d2ee":"markdown","b0193064":"markdown","4fc7247b":"markdown","1533f56b":"markdown","34dd98c6":"markdown","0cb955f3":"markdown","033577eb":"markdown"},"source":{"c9db98b7":"# This Python 3 environment comes with many helpful analytics libraries installed\n# It is defined by the kaggle\/python Docker image: https:\/\/github.com\/kaggle\/docker-python\n# For example, here's several helpful packages to load\n\nimport numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\n\n# Input data files are available in the read-only \"..\/input\/\" directory\n# For example, running this (by clicking run or pressing Shift+Enter) will list all files under the input directory\n\nimport os\nfor dirname, _, filenames in os.walk('\/kaggle\/input'):\n    for filename in filenames:\n        print(os.path.join(dirname, filename))\n\n# You can write up to 20GB to the current directory (\/kaggle\/working\/) that gets preserved as output when you create a version using \"Save & Run All\" \n# You can also write temporary files to \/kaggle\/temp\/, but they won't be saved outside of the current session","e3afa6e2":"import matplotlib.pyplot as plt \nimport seaborn as sns \nimport plotly.express as px \nimport plotly.graph_objects as go\nimport gc \nimport math \nfrom tqdm import tqdm \nfrom wordcloud import WordCloud \nimport scipy as sp\nimport nltk \nfrom nltk.corpus import stopwords\n\nfrom sklearn.metrics.pairwise import cosine_similarity\nfrom sklearn.manifold import TSNE \nfrom sklearn.cluster import KMeans \nfrom sklearn.preprocessing import LabelEncoder \nfrom sklearn.model_selection import cross_val_score, train_test_split \nfrom sklearn.metrics import mean_absolute_error, mean_squared_error\nfrom sklearn.ensemble import RandomForestRegressor\n\npd.set_option(\"display.max_columns\", None)","f09b7b92":"df_all = pd.read_csv(\"..\/input\/kaggle-survey-2021\/kaggle_survey_2021_responses.csv\", header=1)\ndf_all = df_all.iloc[:, 1:]\ndf_all.head()","21d618f5":"stats_cols = df_all.columns[:6].to_list() \\\n  +  [\"In what industry is your current employer\/contract (or your most recent employer if retired)? - Selected Choice\"]  +  [\"What is your current yearly compensation (approximate $USD)?\"] \n\ndf_stats = df_all[stats_cols]\ndf_stats = df_stats[df_stats[df_stats.columns[-1]].notna()]\ndf_stats = df_stats.reset_index(drop=True)\nprint(df_stats[df_stats.columns[-1]].value_counts())","47edd732":"def cln_salary(x) -> int:\n    x = str(x)\n    x = x.replace(\"$\", \"\")\n    x = x.replace(\",\", \"\")\n    x = x.replace(\">\", \"\")\n    \n    if x.find(\"-\") >= 0:\n        return round(int(x.split(\"-\")[0]) + int(x.split(\"-\")[-1]) \/ 2) \n    else:\n        return int(x)\n    \nfix_col = [\"age\", \"gender\", \"country\", \"education\", \"role\", \"experience\", \"employer\", \"compensation_categorical\"]\ndf_stats.columns = fix_col\n    \ndf_stats[\"compensation_numerical\"] = df_stats[df_stats.columns[-1]].apply(cln_salary).astype(int)\ncategorical = df_stats[\"compensation_categorical\"].value_counts(normalize=True)\nall_mean = df_stats[\"compensation_numerical\"].mean()\n\nfig = go.Figure(data=[\n        go.Bar(name=\"compensation\", y=categorical.values.ravel()),\n])\n\nfig.update_layout(\n#         shapes=[\n#         dict(\n#           type= 'line',\n#           yref= 'y', y0= all_mean, y1=all_mean,\n#           xref= 'x', x0= -0.5, x1= len(categorical.index)-0.5\n#         )],\n        barmode='group',\n        title='Overall distribution of annual income',\n        xaxis_title='compesation',\n        yaxis_title='Count',\n        xaxis = dict(\n            tickmode = 'array',\n            tickvals = [x for x in range(len(categorical.index))],\n            ticktext = categorical.index\n        )\n)\n\n# fig.add_annotation(x=len(categorical.index)*0.95, y=all_mean,  xshift=-20, yshift=10,\n#             text=\"Global Average\",\n#             showarrow=False)\n\nfig.show()","f80df756":"def viz_groupby_compesation(df: pd.DataFrame, col_name: str):\n    \"\"\"plot bar\"\"\"\n    x = df_stats.groupby(col_name)[\"compensation_numerical\"].mean()\n    \n    fig = go.Figure(data=[\n        go.Bar(name=f\"compensation with {col_name}\", y=x.values.ravel()),\n    ])\n    fig.update_layout(\n        barmode='group',\n        title=f'Overall distribution of annual income by {col_name}',\n        xaxis_title=col_name,\n        yaxis_title='compensation',\n        xaxis = dict(\n            tickmode = 'array',\n            tickvals = [xx for xx in range(len(x.index))],\n            ticktext = x.index\n        )\n    )\n    fig.show()\n    \n    \ndef viz_groupby_compesation_location(df: pd.DataFrame):\n    \"\"\"plot location map\"\"\"\n    x = df_stats.groupby(\"country\")[\"compensation_numerical\"].mean().to_frame()\n    x[\"country\"] = x.index \n    x.reset_index(drop=True, inplace=True)\n    \n    fig = px.choropleth(x, \n                    locations = 'country',  \n                    color = \"compensation_numerical\",\n                    locationmode = 'country names', \n                    color_continuous_scale = 'viridis',\n                    title =  \"compensation by country\", \n                    range_color = [0, x[\"compensation_numerical\"].max()])\n    fig.update(layout=dict(title=dict(x=0.5)))\n    fig.show()\n    ","3fc9a0f5":"viz_groupby_compesation(df_stats, \"age\")","67122d68":"viz_groupby_compesation(df_stats, \"gender\")","a2a52c4b":"viz_groupby_compesation_location(df_stats)","8d68680a":"viz_groupby_compesation(df_stats, \"role\")","531fffb5":"viz_groupby_compesation(df_stats, \"education\")","2a6a93ba":"viz_groupby_compesation(df_stats, \"employer\")","a44af4d4":"def stats_predicter(df: pd.DataFrame, col_name: str):\n    n_df = df[col_name].value_counts().to_frame().rename(columns={col_name: \"values\"})\n    mu_df = df.groupby(col_name).mean().loc[:, [\"compensation_numerical\"]].rename(columns={\"compensation_numerical\": \"mean\"})\n    std_df = df.groupby(col_name).std().loc[:, [\"compensation_numerical\"]].rename(columns={\"compensation_numerical\": \"std\"})\n    \n    dfs = pd.merge(n_df, mu_df, how=\"inner\", left_index=True, right_index=True)\n    dfs = pd.merge(dfs, std_df, how=\"inner\", left_index=True, right_index=True)    \n    \n    predict = []\n    for n, mu, std in zip(dfs[\"values\"].to_list(), dfs[\"mean\"].to_list(), dfs[\"std\"].to_list()):\n        x_mu_min = round(mu - 1.96 * ( std \/ math.sqrt(n) ), 3)\n        x_mu_max = round(mu + 1.96 * ( std \/ math.sqrt(n) ), 3)        \n        predict.append(str(x_mu_min) + \" ~ \" + str(x_mu_max))\n        \n    dfs[\"population_mean\"] = predict \n    dfs = dfs.rename(columns={\"mean\": \"sample_mean\"})\n    dfs.index.name = col_name \n    return dfs[[\"sample_mean\", \"population_mean\"]]","dc3d48b6":"stats_predicter(df_stats, \"age\")","f1f83edc":"col_all = pd.read_csv(\"..\/input\/kaggle-survey-2021\/kaggle_survey_2021_responses.csv\")\ncol_all = col_all.iloc[:1, 1:]\n\nnum2many_question = {}\nfor col in col_all.columns.to_list():\n    if len(col.split(\"_\")) > 1:\n        num = col.split(\"_\")[0][1:]\n        if num not in num2many_question:\n            num2many_question[num] = col_all[col].values[0].split(\"-\")[0]\n        else:\n            continue \n    else:\n        continue \n        \nnum2once_question = {}\nfor col in col_all.columns.to_list():\n    if len(col.split(\"_\")) == 1:\n        num = col.split(\"_\")[0][1:]\n        if num not in num2once_question:\n            num2once_question[num] = col_all[col].values[0]\n        else:\n            continue \n    else:\n        continue \n        ","9e4ac8de":"num2once_question","a4d3e0c1":"num2many_question","e996c601":"%%time \n\ndef take_dummies(df):\n    cols = [c for _, c in num2many_question.items()]\n    category_cols = []\n    \n    for col in cols:\n        category_cols.extend([c for c in df.columns.to_list() if c.find(col) >= 0])\n    return pd.get_dummies(data=df, columns=category_cols)\n\ndf_ml = df_all[df_all[\"What is your current yearly compensation (approximate $USD)?\"].notna()].reset_index(drop=True)\n# df_ml = df_ml.rename(columns={\"What is your current yearly compensation (approximate $USD)?\": \"target\"})\ndf_ml[\"target\"] = df_ml[\"What is your current yearly compensation (approximate $USD)?\"].apply(cln_salary).astype(int)\n\n# labelencoder \nle_list = [] # I want to get the converted category later, so save it\nfor _, col in num2once_question.items():\n    le = LabelEncoder()\n    df_ml[col] = df_ml[col].fillna(\"none\")\n    df_ml[col] = le.fit_transform(df_ml[col])\n    le_list.append(le.classes_)\ndf_ml.drop([\"What is your current yearly compensation (approximate $USD)?\"], axis=1, inplace=True)\n\n# get dummies \ndf_ml = take_dummies(df_ml)\n\n# \u3044\u304f\u3064\u304b\u306e\u30ab\u30e9\u30e0\u306b\u304a\u3044\u3066\u6b20\u640d\u5024\u304c\u767a\u751f\u3057\u305f\u306e\u3067\u524a\u9664\u3057\u305f\u3002\u539f\u56e0\u4e0d\u660e\ndf_ml = df_ml.dropna(axis=1).reset_index(drop=True)\ngc.collect()\ndf_ml.head()","511036a4":"def fit_predict(df: pd.DataFrame):\n    x_train, x_val = train_test_split(df, test_size=0.25, random_state=42)\n    x_train, y_train = x_train.drop(\"target\", axis=1), x_train[[\"target\"]]\n    x_val, y_val = x_val.drop(\"target\", axis=1), x_val[[\"target\"]]\n    # metrics \n    score = cross_val_score(RandomForestRegressor(random_state=42, n_jobs=-1), df.drop(\"target\", axis=1), df[[\"target\"]], cv=5)\n    print(score)\n    print(f\"CV SCORE: {np.mean(score)}\")\n    # train model \n    model = RandomForestRegressor(random_state=42, n_jobs=-1).fit(x_train, y_train)\n    pred = model.predict(x_val).flatten()\n    print(f\"mae: {mean_squared_error(pred, y_val.values.ravel(), squared=False)}\")\n    gc.collect()\n    return model \n\nmodel = fit_predict(df_ml)","8a2ce6cb":"def ml_predicter(model, df_ml, col_name, number):\n    classes = le_list[number]\n    col_num, pred = [], []\n    \n    for col in df_ml[col_name].unique():\n        x = df_ml[df_ml[col_name] == col].drop(\"target\", axis=1)\n        y = model.predict(x).flatten()\n        y = np.mean(y)\n        pred.append(y)\n        col_num.append(classes[int( col-1 )])\n        \n    return pd.DataFrame({\"ml_predict\": pred}, index=col_num)\n\ndef main(df_stats, df_ml, number, model):\n    stats = stats_predicter(df_stats, use_stats_cols[number])\n    ml = ml_predicter(model, df_ml, use_ml_cols[number], number_list[number])\n    return pd.merge(stats, ml, how=\"inner\", left_index=True, right_index=True)\n        \nuse_ml_cols = [\n    \"What is your age (# years)?\", \n    \"What is your gender? - Selected Choice\", \n    \"In which country do you currently reside?\",\n    \"What is the highest level of formal education that you have attained or plan to attain within the next 2 years?\",\n    \"Select the title most similar to your current role (or most recent title if retired): - Selected Choice\",\n    \"For how many years have you been writing code and\/or programming?\",\n    \"In what industry is your current employer\/contract (or your most recent employer if retired)? - Selected Choice\"\n]\n\nuse_stats_cols = [\n    \"age\", \n    \"gender\", \n    \"country\",\n    \"education\",\n    \"role\",\n    \"experience\",\n    \"employer\"\n]\n\nnumber_list = [0, 1, 2, 3, 4, 5, 10]","1cb02c82":"main(df_stats, df_ml, 0, model)","2828f2aa":"main(df_stats, df_ml, 1, model)","cfd2c277":"main(df_stats, df_ml, 2, model)","66d6c34e":"main(df_stats, df_ml, 3, model)","c38b890b":"main(df_stats, df_ml, 4, model)","264ac9a3":"main(df_stats, df_ml, 5, model)","bd24face":"main(df_stats, df_ml, 6, model)","626c70c9":"## x education level ","661733f8":"## x Age ","a797e580":"### Profession","26f6310f":"### Gender ","11bc9be1":"# Visualization of annual income disparity in the group\n---","7203565c":"## x country ","ac5ea2e3":"# Predict ML and Statistical test\n---","0c88739b":"### Employment status","614518cf":"## x employment ","608801a6":"## x role ","47b50579":"### Country","d07cb45f":"* Train phase ","8f98d2ee":"# Estimator by statistical test\n---\nEstimate the population average of average annual income between each group, using the entire raw data obtained as part of the sample data. The significance level is 95%.","b0193064":"## x gender ","4fc7247b":"+ Prepare Dataset ","1533f56b":"### Education level ","34dd98c6":"### Age ","0cb955f3":"### experience ","033577eb":"# Estimate by machine learning\n---"}}