{"cell_type":{"9ef35e40":"code","e7344f6a":"code","560ea634":"code","4c3ce6ec":"code","6314d019":"code","156acca6":"code","a3600221":"code","269624b8":"code","387cba78":"code","31d8562b":"code","098d2e78":"code","60c1d355":"code","b15b1465":"markdown","32c2e235":"markdown","1e4875c7":"markdown","912adb69":"markdown","a36955f5":"markdown","ab51ae6d":"markdown","cf6cf373":"markdown"},"source":{"9ef35e40":"import pandas as pd\nimport numpy as np\nimport fastai\nfrom sklearn.model_selection import StratifiedKFold\nimport torchvision.models as torch_models\nimport dill\nfrom fastai.vision.all import *\n","e7344f6a":"fastai.__version__","560ea634":"kaggle_path = '..\/input\/hotel-id-2021-fgvc8\/'\ntrain_img_path = '..\/input\/fgvc8hoteltrain512\/'","4c3ce6ec":"DEBUG = False","6314d019":"train = pd.read_csv(kaggle_path+'train.csv').sample(frac=1, random_state = 2021).reset_index(drop = True)\n\n# add image path\ntrain['image'] = train_img_path + train.chain.astype('str') + '\/' + train.image\n","156acca6":"if DEBUG:\n    ## Map chains to 6 buckets.\n    train['h_c'] = train['hotel_id'].astype('str')+' c'+train['chain'].astype('str')\n    train['chain_bucket']=train['chain'].map({0:1,\n                                               6:2,\n                                               5:3,\n                                               90:4,\n                                               3:4,\n                                               89:4,\n                                               87:5,\n                                               4:5,\n                                               2:5,\n                                               88:5,\n                                               9:6,\n                                               82:6,\n                                               78:6}).fillna(0)\n    \n    # Do a stratified KFold to construct a proper validation set.\n    skf = StratifiedKFold(n_splits = 5, random_state = None, shuffle = False)\n\n    train.kfold = -1\n\n    for f, (t,v) in enumerate(skf.split(X = train, y = train.hotel_id.values)):\n        train.loc[v, 'kfold'] = f\n\n    train.groupby('kfold')['hotel_id'].count()","a3600221":"train['is_demo_valid'] = False\n\nif DEBUG:\n    # limit data to one bucket\n    train=train[train.chain_bucket==6]\n    # set fold 0 as validation set\n    train.loc[train['kfold'] == 0, 'is_demo_valid'] = True\n\ntrain[(train.is_demo_valid)]","269624b8":"dls = ImageDataLoaders.from_df(df = train[['image', 'hotel_id', 'is_demo_valid']], path = '.',folder = '.', valid_col = 'is_demo_valid',\n                                item_tfms=Resize(448, method='pad', pad_mode='reflection')\n                               ,batch_tfms=aug_transforms(size=224)\n                               ,bs=32)","387cba78":"dls.show_batch() ","31d8562b":"learn = cnn_learner(dls, densenet161, metrics=[accuracy, top_k_accuracy], opt_func=QHAdam).to_fp16()","098d2e78":"%time\n\nlearn.fine_tune(12, 0.005, freeze_epochs=3)","60c1d355":"learn.export(f'export_dn161_kaggle_notebook.pkl', pickle_module=dill)","b15b1465":"# Dataloader and augmentation\nSetting pad_mode to `reflection` gave a significant boost.","32c2e235":"Set the DEBUG flag = `True` to construct a validation set and to restrict the number of train data. Set the flag = `False` to train on the entire set without validation set. ","1e4875c7":"# About\nThis notebook trains a simple model for the [Hotel-ID to Combat Human Trafficking 2021 - FGVC8](https:\/\/www.kaggle.com\/c\/hotel-id-2021-fgvc8\/overview) competition.\nThe notebook uses the downsized version of the competiton train images. The max height or width is 512 pix. The score can be improved by running more epochs.","912adb69":"# Training\nDensenet161 worked best in my experiment but training is slow. Resnet101 was a good faster alternative but results were slightly worse. CrossEntropy-Loss (CE) worked better for me than label smoothing and a bit better than FocalLoss (FL).\n\nQHAdam gave a significant boost.","a36955f5":"# Load train info and define validation set\nLoad train image descriptions and add path information of downsized images.","ab51ae6d":"If in DEBUG mode limit data and construct validation set.","cf6cf373":"Check some augmented sample images."}}