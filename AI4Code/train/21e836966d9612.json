{"cell_type":{"5eb8b840":"code","30cab26c":"code","e2d5a899":"code","93907392":"code","bfa77298":"code","ae62ec73":"code","8021947d":"code","26337f3c":"code","73431e09":"code","be0a5174":"code","379b1e56":"code","03a3e2fe":"code","efb7ae06":"code","7b42a805":"code","35cbe1f5":"code","76628b81":"code","50657b88":"code","3d96a7e5":"code","6c6e9d2d":"code","d57e0d20":"code","131476af":"code","1e06a771":"code","acc88486":"code","30e6d791":"code","6bde7891":"code","e9bb0f43":"code","d4918d46":"code","784d18e1":"markdown","0e1748ad":"markdown","df461e3c":"markdown","0e59d12d":"markdown","05eeb585":"markdown","e4709692":"markdown","bace523c":"markdown","2cdfb3c8":"markdown","b8804fde":"markdown","037f1280":"markdown","21f54c57":"markdown","ca3a1c30":"markdown","8dd108dd":"markdown","ecc7dfe3":"markdown","a194c0d2":"markdown","9b5c8cd5":"markdown","fbb4de80":"markdown","21f05b43":"markdown","34abb92a":"markdown","3ae16d11":"markdown","f6cdf5d9":"markdown","53bc6fe7":"markdown","40b6f312":"markdown","540cf189":"markdown"},"source":{"5eb8b840":"import pandas as pd\nimport numpy as np\nimport seaborn as sns\nimport tqdm\nimport gc","30cab26c":" num_rows = 10000","e2d5a899":"df = pd.read_csv('..\/input\/application_train.csv', nrows= num_rows)\ntest_df = pd.read_csv('..\/input\/application_test.csv', nrows= num_rows)\ndf = df.append(test_df).reset_index()","93907392":"df = df[df['CODE_GENDER'] != 'XNA']\ndf['DAYS_EMPLOYED'].replace(365243, np.nan, inplace= True)","bfa77298":"docs = [_f for _f in df.columns if 'FLAG_DOC' in _f]\nlive = [_f for _f in df.columns if ('FLAG_' in _f) & ('FLAG_DOC' not in _f) & ('_FLAG_' not in _f)]\n\nprint(docs[:3])\nprint(live[:3])","ae62ec73":"inc_by_org = df[['AMT_INCOME_TOTAL', 'ORGANIZATION_TYPE']].groupby('ORGANIZATION_TYPE').median()['AMT_INCOME_TOTAL']","8021947d":"df['NEW_CREDIT_TO_ANNUITY_RATIO'] = df['AMT_CREDIT'] \/ df['AMT_ANNUITY']\n\ndf['NEW_CREDIT_TO_GOODS_RATIO'] = df['AMT_CREDIT'] \/ df['AMT_GOODS_PRICE']","26337f3c":"df['NEW_DOC_IND_AVG'] = df[docs].mean(axis=1)\n\ndf['NEW_DOC_IND_STD'] = df[docs].std(axis=1)\n\ndf['NEW_DOC_IND_KURT'] = df[docs].kurtosis(axis=1)\n\ndf['NEW_LIVE_IND_SUM'] = df[live].sum(axis=1)\n\ndf['NEW_LIVE_IND_STD'] = df[live].std(axis=1)\n\ndf['NEW_LIVE_IND_KURT'] = df[live].kurtosis(axis=1)","73431e09":"df['NEW_INC_PER_CHLD'] = df['AMT_INCOME_TOTAL'] \/ (1 + df['CNT_CHILDREN'])\ndf['NEW_INC_BY_ORG'] = df['ORGANIZATION_TYPE'].map(inc_by_org)\ndf['NEW_EMPLOY_TO_BIRTH_RATIO'] = df['DAYS_EMPLOYED'] \/ df['DAYS_BIRTH']\ndf['NEW_ANNUITY_TO_INCOME_RATIO'] = df['AMT_ANNUITY'] \/ (1 + df['AMT_INCOME_TOTAL'])\ndf['NEW_SOURCES_PROD'] = df['EXT_SOURCE_1'] * df['EXT_SOURCE_2'] * df['EXT_SOURCE_3']\ndf['NEW_EXT_SOURCES_MEAN'] = df[['EXT_SOURCE_1', 'EXT_SOURCE_2', 'EXT_SOURCE_3']].mean(axis=1)\ndf['NEW_SCORES_STD'] = df[['EXT_SOURCE_1', 'EXT_SOURCE_2', 'EXT_SOURCE_3']].std(axis=1)\ndf['NEW_SCORES_STD'] = df['NEW_SCORES_STD'].fillna(df['NEW_SCORES_STD'].mean())\ndf['NEW_CAR_TO_BIRTH_RATIO'] = df['OWN_CAR_AGE'] \/ df['DAYS_BIRTH']\ndf['NEW_CAR_TO_EMPLOY_RATIO'] = df['OWN_CAR_AGE'] \/ df['DAYS_EMPLOYED']\ndf['NEW_PHONE_TO_BIRTH_RATIO'] = df['DAYS_LAST_PHONE_CHANGE'] \/ df['DAYS_BIRTH']\ndf['NEW_PHONE_TO_EMPLOY_RATIO'] = df['DAYS_LAST_PHONE_CHANGE'] \/ df['DAYS_EMPLOYED']\ndf['NEW_CREDIT_TO_INCOME_RATIO'] = df['AMT_CREDIT'] \/ df['AMT_INCOME_TOTAL']","be0a5174":"def one_hot_encoder(df, nan_as_category = True):\n    original_columns = list(df.columns)\n    categorical_columns = [col for col in df.columns if df[col].dtype == 'object']\n    df = pd.get_dummies(df, columns= categorical_columns, dummy_na= nan_as_category)\n    new_columns = [c for c in df.columns if c not in original_columns]\n    return df, new_columns","379b1e56":"nan_as_category = False","03a3e2fe":"bureau = pd.read_csv('..\/input\/bureau.csv', nrows = num_rows)\nbb = pd.read_csv('..\/input\/bureau_balance.csv', nrows = num_rows)\nbb, bb_cat = one_hot_encoder(bb, nan_as_category)\nbureau, bureau_cat = one_hot_encoder(bureau, nan_as_category)\n\n# Bureau balance: Perform aggregations and merge with bureau.csv\nbb_aggregations = {'MONTHS_BALANCE': ['min', 'max', 'size']}\nfor col in bb_cat:\n    bb_aggregations[col] = ['mean']\nbb_agg = bb.groupby('SK_ID_BUREAU').agg(bb_aggregations)\nbb_agg.columns = pd.Index([e[0] + \"_\" + e[1].upper() for e in bb_agg.columns.tolist()])\nbureau = bureau.join(bb_agg, how='left', on='SK_ID_BUREAU')\nbureau.drop(['SK_ID_BUREAU'], axis=1, inplace= True)\ndel bb, bb_agg\ngc.collect()","efb7ae06":"num_aggregations = {\n    'DAYS_CREDIT': ['min', 'max', 'mean', 'var'],\n    'DAYS_CREDIT_ENDDATE': ['min', 'max', 'mean'],\n    'DAYS_CREDIT_UPDATE': ['mean'],\n    'CREDIT_DAY_OVERDUE': ['max', 'mean'],\n    'AMT_CREDIT_MAX_OVERDUE': ['mean'],\n    'AMT_CREDIT_SUM': ['max', 'mean', 'sum'],\n    'AMT_CREDIT_SUM_DEBT': ['max', 'mean', 'sum'],\n    'AMT_CREDIT_SUM_OVERDUE': ['mean'],\n    'AMT_CREDIT_SUM_LIMIT': ['mean', 'sum'],\n    'AMT_ANNUITY': ['max', 'mean'],\n    'CNT_CREDIT_PROLONG': ['sum'],\n    'MONTHS_BALANCE_MIN': ['min'],\n    'MONTHS_BALANCE_MAX': ['max'],\n    'MONTHS_BALANCE_SIZE': ['mean', 'sum']\n}","7b42a805":"cat_aggregations = {}\nfor cat in bureau_cat: \n    cat_aggregations[cat] = ['mean']\nfor cat in bb_cat: \n    cat_aggregations[cat + \"_MEAN\"] = ['mean']\ncat_aggregations","35cbe1f5":"bureau_agg = bureau.groupby('SK_ID_CURR').agg({**num_aggregations, **cat_aggregations})\nbureau_agg.columns = pd.Index(['BURO_' + e[0] + \"_\" + e[1].upper() for e in bureau_agg.columns.tolist()])\nbureau_agg.head(2)","76628b81":"ins = pd.read_csv('..\/input\/installments_payments.csv', nrows = num_rows)\nins, cat_cols = one_hot_encoder(ins, nan_as_category= True)","50657b88":"# Percentage and difference paid in each installment (amount paid and installment value)\nins['PAYMENT_PERC'] = ins['AMT_PAYMENT'] \/ ins['AMT_INSTALMENT']\nins['PAYMENT_DIFF'] = ins['AMT_INSTALMENT'] - ins['AMT_PAYMENT']\n\n# Days past due and days before due (no negative values)\nins['DPD'] = ins['DAYS_ENTRY_PAYMENT'] - ins['DAYS_INSTALMENT']\nins['DBD'] = ins['DAYS_INSTALMENT'] - ins['DAYS_ENTRY_PAYMENT']\nins['DPD'] = ins['DPD'].apply(lambda x: x if x > 0 else 0)\nins['DBD'] = ins['DBD'].apply(lambda x: x if x > 0 else 0)","3d96a7e5":"X = pd.read_csv('..\/input\/application_train.csv', nrows= num_rows)","6c6e9d2d":"X['CODE_GENDER'].replace('XNA',np.nan, inplace=True)\nX['DAYS_LAST_PHONE_CHANGE'].replace(0, np.nan, inplace=True)\n","d57e0d20":"X['annuity_income_percentage'] = X['AMT_ANNUITY'] \/ X['AMT_INCOME_TOTAL']\nX['car_to_birth_ratio'] = X['OWN_CAR_AGE'] \/ X['DAYS_BIRTH']\nX['car_to_employ_ratio'] = X['OWN_CAR_AGE'] \/ X['DAYS_EMPLOYED']\nX['children_ratio'] = X['CNT_CHILDREN'] \/ X['CNT_FAM_MEMBERS']\nX['credit_to_annuity_ratio'] = X['AMT_CREDIT'] \/ X['AMT_ANNUITY']\nX['credit_to_goods_ratio'] = X['AMT_CREDIT'] \/ X['AMT_GOODS_PRICE']\nX['credit_to_income_ratio'] = X['AMT_CREDIT'] \/ X['AMT_INCOME_TOTAL']\nX['days_employed_percentage'] = X['DAYS_EMPLOYED'] \/ X['DAYS_BIRTH']\nX['income_credit_percentage'] = X['AMT_INCOME_TOTAL'] \/ X['AMT_CREDIT']\nX['income_per_child'] = X['AMT_INCOME_TOTAL'] \/ (1 + X['CNT_CHILDREN'])\nX['income_per_person'] = X['AMT_INCOME_TOTAL'] \/ X['CNT_FAM_MEMBERS']\nX['payment_rate'] = X['AMT_ANNUITY'] \/ X['AMT_CREDIT']\nX['phone_to_birth_ratio'] = X['DAYS_LAST_PHONE_CHANGE'] \/ X['DAYS_BIRTH']\nX['phone_to_employ_ratio'] = X['DAYS_LAST_PHONE_CHANGE'] \/ X['DAYS_EMPLOYED']","131476af":"# External sources\nX['external_sources_weighted'] = X.EXT_SOURCE_1 * 2 + X.EXT_SOURCE_2 * 3 + X.EXT_SOURCE_3 * 4\nfor function_name in ['min', 'max', 'sum', 'mean', 'nanmedian']:\n    X['external_sources_{}'.format(function_name)] = eval('np.{}'.format(function_name))(\n        X[['EXT_SOURCE_1', 'EXT_SOURCE_2', 'EXT_SOURCE_3']], axis=1)","1e06a771":"engineered_numerical_columns = ['annuity_income_percentage',\n                                'car_to_birth_ratio',\n                                'car_to_employ_ratio',\n                                'children_ratio',\n                                'credit_to_annuity_ratio',\n                                'credit_to_goods_ratio',\n                                'credit_to_income_ratio',\n                                'days_employed_percentage',\n                                'income_credit_percentage',\n                                'income_per_child',\n                                'income_per_person',\n                                'payment_rate',\n                                'phone_to_birth_ratio',\n                                'phone_to_employ_ratio',\n                                'external_sources_weighted',\n                                'external_sources_min',\n                                'external_sources_max',\n                                'external_sources_sum',\n                                'external_sources_mean',\n                                'external_sources_nanmedian']","acc88486":"X_eng = X[engineered_numerical_columns + ['TARGET']]\nX_eng_corr = abs(X_eng.corr())","30e6d791":"X_eng_corr.sort_values('TARGET', ascending=False)['TARGET']\n","6bde7891":"sns.heatmap(X_eng_corr, \n            xticklabels=X_eng_corr.columns,\n            yticklabels=X_eng_corr.columns)","e9bb0f43":"AGGREGATION_RECIPIES = [\n    (['CODE_GENDER', 'NAME_EDUCATION_TYPE'], [('AMT_ANNUITY', 'max'),\n                                              ('AMT_CREDIT', 'max'),\n                                              ('EXT_SOURCE_1', 'mean'),\n                                              ('EXT_SOURCE_2', 'mean'),\n                                              ('OWN_CAR_AGE', 'max'),\n                                              ('OWN_CAR_AGE', 'sum')]),\n    (['CODE_GENDER', 'ORGANIZATION_TYPE'], [('AMT_ANNUITY', 'mean'),\n                                            ('AMT_INCOME_TOTAL', 'mean'),\n                                            ('DAYS_REGISTRATION', 'mean'),\n                                            ('EXT_SOURCE_1', 'mean')]),\n    (['CODE_GENDER', 'REG_CITY_NOT_WORK_CITY'], [('AMT_ANNUITY', 'mean'),\n                                                 ('CNT_CHILDREN', 'mean'),\n                                                 ('DAYS_ID_PUBLISH', 'mean')]),\n    (['CODE_GENDER', 'NAME_EDUCATION_TYPE', 'OCCUPATION_TYPE', 'REG_CITY_NOT_WORK_CITY'], [('EXT_SOURCE_1', 'mean'),\n                                                                                           ('EXT_SOURCE_2', 'mean')]),\n    (['NAME_EDUCATION_TYPE', 'OCCUPATION_TYPE'], [('AMT_CREDIT', 'mean'),\n                                                  ('AMT_REQ_CREDIT_BUREAU_YEAR', 'mean'),\n                                                  ('APARTMENTS_AVG', 'mean'),\n                                                  ('BASEMENTAREA_AVG', 'mean'),\n                                                  ('EXT_SOURCE_1', 'mean'),\n                                                  ('EXT_SOURCE_2', 'mean'),\n                                                  ('EXT_SOURCE_3', 'mean'),\n                                                  ('NONLIVINGAREA_AVG', 'mean'),\n                                                  ('OWN_CAR_AGE', 'mean'),\n                                                  ('YEARS_BUILD_AVG', 'mean')]),\n    (['NAME_EDUCATION_TYPE', 'OCCUPATION_TYPE', 'REG_CITY_NOT_WORK_CITY'], [('ELEVATORS_AVG', 'mean'),\n                                                                            ('EXT_SOURCE_1', 'mean')]),\n    (['OCCUPATION_TYPE'], [('AMT_ANNUITY', 'mean'),\n                           ('CNT_CHILDREN', 'mean'),\n                           ('CNT_FAM_MEMBERS', 'mean'),\n                           ('DAYS_BIRTH', 'mean'),\n                           ('DAYS_EMPLOYED', 'mean'),\n                           ('DAYS_ID_PUBLISH', 'mean'),\n                           ('DAYS_REGISTRATION', 'mean'),\n                           ('EXT_SOURCE_1', 'mean'),\n                           ('EXT_SOURCE_2', 'mean'),\n                           ('EXT_SOURCE_3', 'mean')]),\n]","d4918d46":"X['cnt_non_child'] = X['CNT_FAM_MEMBERS'] - X['CNT_CHILDREN']\nX['child_to_non_child_ratio'] = X['CNT_CHILDREN'] \/ X['cnt_non_child']\nX['income_per_non_child'] = X['AMT_INCOME_TOTAL'] \/ X['cnt_non_child']\nX['credit_per_person'] = X['AMT_CREDIT'] \/ X['CNT_FAM_MEMBERS']\nX['credit_per_child'] = X['AMT_CREDIT'] \/ (1 + X['CNT_CHILDREN'])\nX['credit_per_non_child'] = X['AMT_CREDIT'] \/ X['cnt_non_child']","784d18e1":"#### Let's now look at the **installments_payments.csv**. \n\nMost of his techniques are as before except a few new domain features.","0e1748ad":"This notebook holds the examples of feature engineering done during the Home Credit Default Risk competition. I hope this kernel helps in finding features features that work well for more and more people.","df461e3c":"Removing the anomalies,","0e59d12d":"In an overall, I loved his way of getting more features in a quick fashion with a huge amount of domain feature engineering.","05eeb585":"Some aggregations that has been used by them.","e4709692":"First he has created a function that returns him the one hot encoded dataframe and column names.","bace523c":"Then importing the data,","2cdfb3c8":"In these new features, he has taken the income per number of child, income by organization type, the number of days employed to the number of days of birth and annuity by income. He has also made polynomial features using EXT-SOURCE- columns. He has also taken the mean and standard deviation of these columns.\n\nMore features that were made are the car age to number of days of birth and days employed. Also days since last phone change were also divided by the previous two columns. Again, credit to income ratios were also made.","b8804fde":"Tons of new features with very less code!","037f1280":"# Feature Engineering for Financial data","21f54c57":"Whose kernel should I go through next? Any suggestions?","ca3a1c30":"For the categorical columns he has simply took the mean of the columns.","8dd108dd":"He then takes the median of incomes of different organization types.","ecc7dfe3":"And then he has applied those aggregations at once grouping by on the SK_ID_CURR variable. Then made the columns into a single index.","a194c0d2":"He quickly gets all the repetitive named columns with a list comprehension.","9b5c8cd5":"#### Now let's take a look at what he did to get more features with the **bureu.csv** file.","fbb4de80":"##  A case study of Oliver - The Division and Aggregation feature engineering\n\nThese features were engineered by Oliver, **who got the 1st rank with his team 'Home Aloan' in the competition**. We can see from his practice that getting a bunch of features out can be as simple as getting the sum, standard deviation and the mean of the columns.  \nCheck his full [kernel](https:\/\/www.kaggle.com\/ogrellier\/lighgbm-with-selected-features\/code) to see in-depth.","21f05b43":"The feature engineering begins.\n\nHe first takes the ratio of amount credit by annuity as we well as amount credit by goods price.","34abb92a":"##  A case study of the 13th place solution\n\nThe git repo is [here](https:\/\/github.com\/neptune-ml\/open-solution-home-credit).","3ae16d11":"#### Let's start with the** application_tran.csv**.","f6cdf5d9":"**application_train.csv**","53bc6fe7":"Overall these features are quite similar to Oliver's feature engineering but still with different other features that can be accounted.","40b6f312":"Then with all the columns he had got before, he forms generalized columns by getting the mean, standard deviation, kurtosis and sum to get more features out.","540cf189":"I found this trick of his quite nice for getting different features out by performing aggregations. He has created a dictionary of all the types of aggregations and then applied it on the numerical columns."}}