{"cell_type":{"9b416fb1":"code","ce6bd236":"code","910ee977":"code","ac7874ed":"code","4aa76ce1":"code","cb4c8cc9":"code","6aeea36f":"code","b728c6d5":"code","6693d2cb":"code","1d04a91d":"code","952bf294":"code","083f37a2":"code","adc422bc":"code","d463407f":"markdown","81102159":"markdown","bc1bdcca":"markdown","c8261d60":"markdown","335c9f1d":"markdown","3385ecfc":"markdown","6849f848":"markdown","e81289d8":"markdown","ee97b601":"markdown","8ce1a546":"markdown","035b706f":"markdown","33ba99fc":"markdown","2482c9e7":"markdown","4239a338":"markdown","b2f12e64":"markdown"},"source":{"9b416fb1":"import requests\nimport numpy as np\nimport pandas as pd\nimport io\nimport tensorflow as tf\nimport matplotlib.pyplot as plt\nfrom random import random\nfrom sklearn.preprocessing import MinMaxScaler\nfrom sklearn.metrics import mean_absolute_error","ce6bd236":"BASE_URL = 'https:\/\/raw.githubusercontent.com\/CSSEGISandData\/COVID-19\/master\/csse_covid_19_data\/csse_covid_19_time_series\/'\nCONFIRMED = 'time_series_covid19_confirmed_global.csv'\nDEATH = 'time_series_covid19_deaths_global.csv'\nRECOVERED = 'time_series_covid19_recovered_global.csv'\nCONFIRMED_US = 'time_series_covid19_confirmed_US.csv'\nDEATH_US = 'time_series_covid19_deaths_US.csv'\n\ndef get_covid_data(subset = 'CONFIRMED'):\n    \"\"\"This function returns the latest available data subset of COVID-19. \n        The returned value is in pandas DataFrame type.\n    Args:\n        subset (:obj:`str`, optional): Any value out of 5 subsets of 'CONFIRMED',\n        'DEATH', 'RECOVERED', 'CONFIRMED_US' and 'DEATH_US' is a valid input. If the value\n        is not chosen or typed wrongly, CONFIRMED subet will be returned.\n    \"\"\"    \n    switcher =  {\n                'CONFIRMED'     : BASE_URL + CONFIRMED,\n                'DEATH'         : BASE_URL + DEATH,\n                'RECOVERED'     : BASE_URL + RECOVERED,\n                'CONFIRMED_US'  : BASE_URL + CONFIRMED_US,\n                'DEATH_US'      : BASE_URL + DEATH_US,\n                }\n\n    CSV_URL = switcher.get(subset, BASE_URL + CONFIRMED)\n\n    with requests.Session() as s:\n        download        = s.get(CSV_URL)\n        decoded_content = download.content.decode('utf-8')\n        data            = pd.read_csv(io.StringIO(decoded_content))\n\n    return data","910ee977":"def covid_model(input_len):\n  covid_19_RNN=tf.keras.models.Sequential()\n  #input layer\n  covid_19_RNN.add(tf.keras.layers.LSTM(units = 250, return_sequences=True,input_shape=(input_len,1)))\n  covid_19_RNN.add(tf.keras.layers.Dropout(0.01))\n  #1st hidden layer\n  covid_19_RNN.add(tf.keras.layers.LSTM(units = 150, return_sequences=True))\n  covid_19_RNN.add(tf.keras.layers.Dropout(0.01))\n  # #2nd hidden layer\n  covid_19_RNN.add(tf.keras.layers.LSTM(units = 200, return_sequences=True))\n  covid_19_RNN.add(tf.keras.layers.Dropout(0.02))\n  #3rd hidden layer\n  covid_19_RNN.add(tf.keras.layers.LSTM(units = 150, return_sequences=True))\n  covid_19_RNN.add(tf.keras.layers.Dropout(0.02))\n  #4th hidden layer\n  covid_19_RNN.add(tf.keras.layers.LSTM(units = 125, return_sequences=True))\n  covid_19_RNN.add(tf.keras.layers.Dropout(0.04))\n  #output layer\n  covid_19_RNN.add(tf.keras.layers.Dense(units = 1))\n\n\n  #compile the model\n  covid_19_RNN.compile(optimizer='adam',loss='mae')\n  return covid_19_RNN","ac7874ed":"# Initializing Parameters\n\nTEST_PORTION = 0\nTEST_SIZE = 14 \nOBSERVATION_WINDOW_SIZE = 14\nAUGMENTATION_LEVEL = 50\nAUGMENTATION_SCORE = 0.1\nINPUT_FILE = 'CONFIRMED'\n\"\"\"\nINPUT_FILE : 'CONFIRMED', 'DEATH', 'RECOVERED', 'CONFIRMED_US' and 'DEATH_US'\n\"\"\"","4aa76ce1":"# GPU settings initialization\n\nconfig = tf.compat.v1.ConfigProto()\nconfig.gpu_options.allow_growth = True\nsession = tf.compat.v1.Session(config=config)\n\ndevice_name = tf.test.gpu_device_name()\nif not device_name == '\/device:GPU:0':\n  raise SystemError('GPU device not found')\nprint('Found GPU at: {}'.format(device_name))","cb4c8cc9":"# Reading the Input File\n\ndf = get_covid_data(subset = INPUT_FILE)\nprint(df)\n\nif 'US' in INPUT_FILE:\n  data_start = 10\nelse:\n  data_start = 3\n\nconfirmed_data=pd.DataFrame(df.sum(axis=0))[data_start:]\ndates=list(confirmed_data.index)\ntest_size = np.asarray(max( np.round( len(dates) * TEST_PORTION ) , TEST_SIZE )).astype(int)\ntime_steps = max( OBSERVATION_WINDOW_SIZE , 1)\naug_steps = max( AUGMENTATION_LEVEL , 1)\nscaler_threshold = min( AUGMENTATION_SCORE, 0.2 )\n\nday=[]\nfor i in range(0,len(dates)):\n  day.append(i+1)\nday=np.array(day)","6aeea36f":"# Augmentation and Preprocessing of the Train Data\n\nscaler = MinMaxScaler( feature_range=(random()*0.2,1-random()*0.2) )\ntrain_data = confirmed_data[:-test_size]\n\nx_data=[]\ny_data=[]\n\nfor j in range(0,aug_steps):\n    for i in range(time_steps,len(train_data)):\n        scaler=MinMaxScaler( feature_range=(random()*scaler_threshold, 1 - random()*scaler_threshold) )\n        augmentation = scaler.fit_transform(train_data[i-time_steps:i+1])\n        x_data.append(augmentation[:time_steps])\n        y_data.append(augmentation[time_steps])\n\nx_data = np.array(x_data)\nx_data = np.reshape(x_data,(x_data.shape[0],x_data.shape[1],1))\ny_data = np.array(y_data)","b728c6d5":"# Fitting the model to the augmented data\n\ncovid_19_RNN = covid_model(x_data.shape[1])\ncovid_19_RNN.fit(x_data ,y_data , batch_size=2048 , epochs=200 , validation_split=0.4 , verbose=2)","6693d2cb":"# The test data sequence generation and preprocessing\n\ntest_data = confirmed_data.values\ntest_data = test_data\ntest_data = np.array(test_data).reshape(-1,1)","1d04a91d":"# Prediction using the trained covid_19_RNN model\n\nscaler=MinMaxScaler( feature_range = (scaler_threshold, 1 - scaler_threshold) )\nprediction_result = []\n\nfor i in range(time_steps ,len(test_data)):\n  x_test = []\n  x_test.append( scaler.fit_transform(test_data[ i - time_steps : i ]) )\n  x_test = np.reshape(x_test[0],(1 , x_test[0].shape[0], 1))\n  predicted_covid_19_spread = covid_19_RNN.predict(x_test)[0][-1]\n  predict_val = scaler.inverse_transform(predicted_covid_19_spread.reshape(1,1))\n  predict_val = predict_val.astype(int)\n  prediction_result.append(predict_val[0][0])\n\ny_test = test_data[time_steps : len(test_data)]\ny_test = y_test.reshape(len(y_test)).astype(int)","952bf294":"# Test Data Results\n\nresult_error = prediction_result - y_test\nresult_error_percentage = 100*np.divide(result_error, y_test)\n\ntest_dates  = np.asarray(dates[-len(y_test):]).reshape(len(y_test))\nreal_value  = y_test.reshape(len(y_test)).astype(int)\npredition   = np.asarray(prediction_result)\nerror_p     = result_error_percentage.reshape(len(y_test))\nerror_p     = np.around(error_p, decimals=2)\n\nResults = {'Date': test_dates, 'Real Value [No.]': real_value, 'Predicted Value [No.]': predition, 'Error Percentage [%]':error_p}\ndf_results = pd.DataFrame(data=Results)\nprint(df_results)\nMAEP  = mean_absolute_error(predition, y_test)\nMAEP  = np.around(MAEP, decimals=0)\nprint('Mean Absolute Error of Prediction                 :' + str(MAEP))\nMAPEP = mean_absolute_error(error_p,np.zeros(len(error_p)))\nMAPEP = np.around(MAPEP, decimals=2)\nprint('Mean Absolute of Prediction Error Percentages  [%]:' + str(MAPEP))","083f37a2":"plt.figure(2, figsize=(12,9))\nplt.plot(range(0,len(confirmed_data)),confirmed_data[0],label=\"True Number of corona-cases\", c='r', marker='.')\nplt.plot(range(len(confirmed_data) - len(prediction_result) ,len(confirmed_data)),prediction_result,label=\"Prediction of Number of corona-cases\",c='b', marker='.')\nplt.xlabel('Day Number')\nplt.ylabel('Number of people')\nplt.legend()\nplt.grid(which='both', axis='both')\nplt.title('Day by Day Prediction of Time Series COVID-19 Cases - ' + INPUT_FILE.upper() + ' GLOBAL')\nplt.show()","adc422bc":"# The test data sequence generation and preprocessing\n\ntest_data = confirmed_data.values\ntest_data = test_data[-(test_size + time_steps):]\ntest_data = np.array(test_data).reshape(-1,1)\nprediction = np.append(test_data[-14:], 0*test_data[:14])\nprediction = np.asarray(prediction).reshape(28,1)\n\nscaler=MinMaxScaler( feature_range = (scaler_threshold, 1 - scaler_threshold) )\nprediction_result = []\n\nfor i in range(time_steps ,len(prediction)):\n  x_test = []\n  x_test.append( scaler.fit_transform(prediction[ i - time_steps : i ]) )\n  x_test = np.reshape(x_test[0],(1 , x_test[0].shape[0], 1))\n  predicted_covid_19_spread = covid_19_RNN.predict(x_test)[0][-1]\n  predict_val = scaler.inverse_transform(predicted_covid_19_spread.reshape(1,1))\n  predict_val = predict_val.astype(int)\n  prediction[i]= predict_val\n  prediction_result.append(predict_val[0][0])\n\nplt.figure(2, figsize=(12,9))\nplt.plot(range(0,len(confirmed_data)),confirmed_data[0],label=\"True Number of corona-cases\", c='r', marker='.')\nplt.plot(range(len(confirmed_data) - test_size + 14 ,len(confirmed_data) + 14),prediction_result,label=\"Prediction of Number of corona-cases\",c='b', marker='.')\nplt.xlabel('Day Number')\nplt.ylabel('Number of people')\nplt.legend()\nplt.grid(which='both', axis='both')\nplt.title('14 Days Prediction of Time Series COVID-19 Cases - ' + INPUT_FILE.upper() + ' GLOBAL')\nplt.show()","d463407f":"**Data Loading**","81102159":"**Model Fit**","bc1bdcca":"**GPU Initialization**","c8261d60":"**Data Downloader Function**","335c9f1d":"**Prediction Phase of 14 Days Based on 14 previous Days**\n\nIn this part, 14 days are assumed to be known and then one day is predicted. Then based on the 13 known days and 1 predicted day the next day is predicted. This will continue until 14 days. Consequently, the last day is predicted based on 13 prediction and 1 known day.","3385ecfc":"**Initializing Parameters**","6849f848":"**Test Results Comparison**","e81289d8":"**Test Data Generation**","ee97b601":"**Prediction of Globally Confirmed Cases of COVID-19**\n\nFor this prediction, a recurrent neural network with 4 layers are used. Dropouts and Adam optimizer are used to have better generalization results. To have better predictions, rather than the absolute values, the thrends are fed to the network for training and in addition they are fairly augmented to have considerably more training data as the data it self may not be very comprehensive.","8ce1a546":"**Build of the LSTM model with Dropouts and Return Sequences**","035b706f":"** Invoking the import machinery**","33ba99fc":"**Preprocessing the Data**","2482c9e7":"**Prediction of Next Two Weeks**\n\n\nHere the prediction of next two weeks is shown.","4239a338":"**Prediction Phase of Single Day Based on 14 previous Days**\n\nIn this part number of cases for each day is predicted by the last 14 days. Basically, it is predicting a single day based on last real value 14 days, however, the results are shown over last 14 days to compare the accuracy with prediction of all 14 days based on previous 14 days. ","b2f12e64":"**Plotting the Results Day by Day Prediction**"}}