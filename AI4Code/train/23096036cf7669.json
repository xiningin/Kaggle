{"cell_type":{"86d43242":"code","8baf091e":"code","4be48895":"code","524bd0bd":"code","764c7617":"code","c30ce8e7":"code","e9d798a2":"code","5651efb8":"code","ef36d71e":"code","5a4c8535":"code","cdb589ad":"code","5ca30d7f":"code","ac7a42c2":"code","1d1bdc77":"code","3c1f8b69":"code","82e8b1b6":"code","be75f0aa":"code","29f51f9c":"code","0ec81f4a":"code","bb0e76d5":"code","6d1f85e1":"code","f8b9f681":"code","8db95370":"code","f89e4002":"markdown","e6800040":"markdown","b936c8f1":"markdown","dcd9d775":"markdown","68b7d764":"markdown","2db81c1c":"markdown","4277b9b1":"markdown"},"source":{"86d43242":"import numpy as np\nimport pandas as pd\nimport seaborn as sns\nimport os\nimport matplotlib.pyplot as plt\nfrom datetime import datetime\nfrom tqdm import tqdm","8baf091e":"rootdir='\/kaggle\/input\/ashrae-energy-prediction\/'\ntrain = pd.read_csv(rootdir + 'train.csv')\n# convert timestamps\ntrain['timestamp'] = pd.to_datetime(train['timestamp'],format='%Y-%m-%d %H:%M:%S')\n# add log_meter_reading\ntrain['log_meter_reading'] = np.log1p(train['meter_reading'])\ntrain.head()","4be48895":"def ave_before_date(df, date_value):\n    dfsub = df.loc[df.timestamp<date_value,['log_meter_reading']]\n    return np.nanmean(dfsub['log_meter_reading'])","524bd0bd":"def ave_after_date(df, date_value):\n    dfsub = df.loc[df.timestamp>date_value,['log_meter_reading']]\n    return np.nanmean(dfsub['log_meter_reading'])","764c7617":"date_value = datetime(2016,5,21)\nprint('Average BEFORE cut-off date...')\nave_bef = train.groupby(['building_id','meter']).apply(lambda x: ave_before_date(x, date_value)).to_frame()\nave_bef.columns=['before']\nprint('Average AFTER cut-off date...')\nave_aft = train.groupby(['building_id','meter']).apply(lambda x: ave_after_date(x, date_value)).to_frame()\nave_aft.columns=['after']\nprint('Merge...')\nave_total = pd.merge(ave_bef,ave_aft,on=['building_id','meter'])\nave_total.head()","c30ce8e7":"# some time series do not have points for the entire year, so the average results in NaN's\n\n# set nans to zero\nfor col in ave_total.columns:\n    ave_total.loc[np.isnan(ave_total[col]), col] = 0","e9d798a2":"plt.figure(figsize=(8,6))\nsns.scatterplot(ave_total.after, ave_total.before)\nplt.grid();","5651efb8":"plt.figure(figsize=(10,6))\nsns.scatterplot(ave_total.after, ave_total.before)\nplt.grid();\nplt.xscale('log')\nplt.yscale('log')\nplt.xlim(0.001,15);\nplt.ylim(0.001,15);","ef36d71e":"thr = 0.1 # arbitrary threshold\nprint(f'Series with average below {thr} before cut-off date: ' + str(sum(ave_total['before']<thr)))\nprint(f'Series with average below {thr} after cut-off date: ' + str(sum(ave_total['after']<thr)))","5a4c8535":"# rows where average is below threshold\nix_before = ave_total.loc[ave_total.before<thr].index.to_frame()\nix_before.head()","cdb589ad":"ix_after = ave_total.loc[ave_total.after<thr].index.to_frame()\n\n#ix_after.head()","5ca30d7f":"ix_before.meter.value_counts()","ac7a42c2":"ix_after.meter.value_counts()","1d1bdc77":"# time series with meter = 1,2, or 3\nix_before_not0meter=ix_before.loc[ix_before.meter>0]","3c1f8b69":"k=-1","82e8b1b6":"k +=1\nplt.figure(figsize=(8,6))\nbid = ix_after.iloc[k,0]\nmid = ix_after.iloc[k,1]\nbuilding_time_series = train.loc[(train.building_id==bid) & (train.meter==mid)]\nbef_value = ave_total.loc[bid].loc[mid]['before']\naft_value = ave_total.loc[bid].loc[mid]['after']\nplt.plot(building_time_series.timestamp, building_time_series.meter_reading);\nplt.title('Building {:d} - Meter {:d} - Before {:.2f} After {:.2f}'.format(bid,mid,bef_value,aft_value));\nplt.grid();","be75f0aa":"plt.figure(figsize=(8,5))\nfor col in ['before','after']:\n    sns.distplot(ave_total[col],label=col,kde=False)\nplt.grid();\nplt.legend();\nplt.xlabel('Average log meter');\n","29f51f9c":"# copy dataframe\ntrain_clean = train.copy()","0ec81f4a":"# remove sections where before_average < threshold\nfor k in tqdm(range(len(ix_before))):\n    bid = ix_before.iloc[k,0]\n    mid = ix_before.iloc[k,1]\n    ix_to_drop = train_clean[(train_clean.building_id == bid) & (train_clean.meter == mid) & (train_clean.timestamp < date_value)].index\n    train_clean.drop(ix_to_drop, inplace = True)","bb0e76d5":"# remove sections where after_average < threshold\nfor k in tqdm(range(len(ix_after))):\n    bid = ix_after.iloc[k,0]\n    mid = ix_after.iloc[k,1]\n    ix_to_drop = train_clean[(train_clean.building_id == bid) & (train_clean.meter == mid) & (train_clean.timestamp < date_value)].index\n    train_clean.drop(ix_to_drop, inplace = True)","6d1f85e1":"# new length\nprint('New dataset length: ' + str(len(train_clean)))","f8b9f681":"# cleanup ratio\nprint('{:.1f}% of datapoints removed from original training dataset'.format(100*(1-len(train_clean)\/len(train))))","8db95370":"train_clean.to_csv('train_cleanup01.csv',index=False)","f89e4002":"There exist a few time series with average below threshold AFTER cut-off date","e6800040":"**Count the number of time series with average below threshold by grouping them by meter**","b936c8f1":"**Cleanup**","dcd9d775":"Use the next cell to browse through the time series with average below threshold","68b7d764":"**Averages**","2db81c1c":"Most time series with average below threshold before cut-off date have meter=0, although some exist with other meter types","4277b9b1":"Export new dataset"}}