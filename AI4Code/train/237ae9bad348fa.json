{"cell_type":{"c48e48ba":"code","3708729c":"code","dade4c78":"code","c0230a18":"code","dbb374e7":"code","ed4b9933":"code","4a378ffb":"code","0f23850a":"code","57380c5e":"code","4c7c2000":"code","c38b909d":"code","a5be1db8":"code","af860a96":"code","ca3f0bd7":"code","05438989":"code","91435a98":"code","5b0bef70":"code","aec9aa09":"code","9437006e":"code","43726317":"code","a94ba0e2":"code","7d3bb63c":"code","4e298b7a":"code","9eccf1e0":"code","ab8fe523":"markdown","62a1f15c":"markdown","56f592ad":"markdown","ae4c3bdc":"markdown","08ca281d":"markdown","eafd093d":"markdown","564a807c":"markdown"},"source":{"c48e48ba":"!pip3 install ..\/input\/datasketch\/datasketch-1.5.3-py2.py3-none-any.whl","3708729c":"import warnings\nwarnings.filterwarnings('ignore', category=DeprecationWarning)\nwarnings.filterwarnings('ignore', category=FutureWarning)\n\nimport numpy as np\nimport pandas as pd\nfrom tqdm.autonotebook import tqdm\nimport unidecode\nimport codecs\nimport cv2\nimport matplotlib.pyplot as plt\nimport re\nimport time\nimport spacy\nfrom datasketch import MinHash, MinHashLSHForest\nimport gc","dade4c78":"np.random.seed(0)\nnlp = spacy.load('en_core_web_lg')","c0230a18":"def cosine_similarity(string1, string2):\n    d1 = nlp(string1)\n    d2 = nlp(string2)\n    return d2.similarity(d2)","dbb374e7":"def jaccard_similarity(l1, l2):\n    intersection = len(list(set(l1).intersection(l2)))\n    union = (len(l1) + len(l2)) - intersection\n    return float(intersection) \/ union","ed4b9933":"def plot_matched_images(images_path, posting_id):\n    plt.figure(figsize = (50, 50))\n    for i, j in enumerate(zip(images_path, posting_id)):\n        plt.subplot(10, 10, i + 1)\n        img = cv2.cvtColor(cv2.imread(j[0]), cv2.COLOR_BGR2RGB)\n        plt.title(j[1])\n        plt.axis(\"off\")\n        plt.tight_layout()\n        plt.imshow(img)","4a378ffb":"def handle_consecutive_char(string):\n    # check & fix for 3 or more consecutive characters\n    return re.sub(r'(.)\\1+\\1+', r'\\1', string)","0f23850a":"digit_check = re.compile('\\d')\ndef check_alpha_num(token):\n    # check if the token id alphanumeric\n    return bool(digit_check.search(token))","57380c5e":"source_path = '..\/input\/shopee-product-matching'","4c7c2000":"train_df = pd.read_csv(f'{source_path}\/train.csv')\ntest_df = pd.read_csv(f'{source_path}\/test.csv')","c38b909d":"tqdm.pandas()\ntrain_df['image_path'] = train_df['image'].progress_apply(lambda x: f\"{source_path}\/train_images\/{x}\")\ntest_df['image_path'] = test_df['image'].progress_apply(lambda x: f\"{source_path}\/test_images\/{x}\")","a5be1db8":"tqdm.pandas()\ntrain_df['unicode_handled_title'] = train_df['title'].progress_apply(lambda x: unidecode.unidecode(codecs.decode(x, 'unicode_escape')))\ntrain_df['clean_title'] = train_df['unicode_handled_title'].progress_apply(lambda x: ' '.join(handle_consecutive_char(i) for i in str(\n                re.sub('[^A-Za-z0-9]', ' ', x.lower().strip())).split() if i.strip() and not check_alpha_num(i.strip()) and not (i.strip(\n                ) == len(i.strip()) * i.strip()[0])))","af860a96":"class LSH:\n    def __init__(self, permutations, number_of_recommendations, depth, dataframe):\n        self.permutations = permutations\n        self.number_of_recommendations = number_of_recommendations\n        self.depth = depth\n        self.dataframe = dataframe\n        self.minhash = []\n        self.forest = None\n    \n    def minhash_data(self):\n        for title in self.dataframe['clean_title']:\n            tokens = title.split(' ')\n            min_hash = MinHash(num_perm=self.permutations)\n            for t in tokens:\n                min_hash.update(t.encode('utf-8'))\n            self.minhash.append(min_hash)\n    \n    def prepare_forest(self):\n        self.forest = MinHashLSHForest(num_perm=self.permutations, l=self.depth)\n        for i, j in enumerate(self.minhash):\n            self.forest.add(i, j)\n        self.forest.index()\n        del self.minhash\n        gc.collect()\n    \n    def query_forest(self, query, number_of_results, cosine_sim=False):\n        query_tokens = query.split(' ')\n        min_hash = MinHash(num_perm=self.permutations)\n        for i in query_tokens:\n            min_hash.update(i.encode('utf-8'))\n        result = self.forest.query(min_hash, self.number_of_recommendations)\n        if cosine_sim:\n            print(\"Cosine Similarity\")\n            result = [(key, self.cosine_similarity(self.dataframe.iloc[key].clean_title, query)) for key in result]\n        else:\n            print(\"Jaccard Similarity\")\n            result = [(key, self.jaccard_similarity(self.dataframe.iloc[key].clean_title.split(' '), query_tokens)) for key in result]\n        result = sorted(result, key=lambda x: x[1], reverse=True)[:number_of_results]\n        iloc = [i[0] for i in result]\n        return self.dataframe.iloc[iloc].image_path.to_list(), self.dataframe.iloc[iloc].posting_id.to_list()\n    \n    def jaccard_similarity(self, l1, l2):\n        intersection = len(list(set(l1).intersection(l2)))\n        union = (len(l1) + len(l2)) - intersection\n        return float(intersection) \/ union\n    \n    def cosine_similarity(self, string1, string2):\n        d1 = nlp(string1)\n        d2 = nlp(string2)\n        return d1.similarity(d2)\n    \n\n        ","ca3f0bd7":"obj = LSH(permutations=256, number_of_recommendations=50, depth=10, dataframe=train_df)","05438989":"%%time\nobj.minhash_data()","91435a98":"%%time\nobj.prepare_forest()","5b0bef70":"query = 'focallure blush on powder mineral pigment warna'\nim_path, train_path = obj.query_forest(query, 30)\nplot_matched_images(im_path, train_path)","aec9aa09":"query = 'focallure blush on powder mineral pigment warna'\nim_path, train_path = obj.query_forest(query, 30, cosine_sim=True)\nplot_matched_images(im_path, train_path)","9437006e":"query = 'johnsonas top to toe hair body bath ml'\nim_path, train_path = obj.query_forest(query, 30)\nplot_matched_images(im_path, train_path)","43726317":"query = 'johnsonas top to toe hair body bath ml'\nim_path, train_path = obj.query_forest(query, 30, cosine_sim=True)\nplot_matched_images(im_path, train_path)","a94ba0e2":"query = 'pcs ikat rambut karet polos elastis gaya korea untuk wanita'\nim_path, train_path = obj.query_forest(query, 30)\nplot_matched_images(im_path, train_path)","7d3bb63c":"query = 'pcs ikat rambut karet polos elastis gaya korea untuk wanita'\nim_path, train_path = obj.query_forest(query, 30, cosine_sim=True)\nplot_matched_images(im_path, train_path)","4e298b7a":"query = 'pashmina kusut polos rawis hitam'\nim_path, train_path = obj.query_forest(query, 30)\nplot_matched_images(im_path, train_path)","9eccf1e0":"query = 'pashmina kusut polos rawis hitam'\nim_path, train_path = obj.query_forest(query, 30, cosine_sim=True)\nplot_matched_images(im_path, train_path)","ab8fe523":"## Helper funtions","62a1f15c":"### Comparing product matches for Jaccard & Cosine similarity","56f592ad":"## Import Libraries","ae4c3bdc":"* Setting number of permutations\n* Setting number of recommendations to return  \n* Setting depth of LSH Forest\n* Preparing shingles\n* MinHashing all the shingles\n* Preparing MinHashForest of MinHash\n* Indexing forest\n* Querying forest\n* Calculating jaccard similarity & cosine similarity (Post-processing)","08ca281d":"## LSH ","eafd093d":"Reference: http:\/\/ekzhu.com\/datasketch\/","564a807c":"<h3 align=\"center\" style=\"background-color:#003300;color:white;\">Thanks! More updates to come. WIP<\/h3> "}}