{"cell_type":{"13ce0710":"code","54d62886":"code","c4ed1b36":"code","81d39108":"code","4e572142":"code","6db40519":"code","1fe97fc1":"code","b5c04529":"code","dc4f8157":"code","cfad061b":"code","3deaa98d":"code","3f8c20a8":"code","66297698":"code","264231a8":"code","3f814c64":"code","02e8c224":"code","0eaa8d07":"code","a8297691":"code","34da862a":"code","f74c9474":"code","1c26d2ac":"code","61ff4771":"code","dd205bc0":"code","be69cb26":"code","8f3229d0":"code","4bfa6d3c":"code","8d47ae4e":"code","8316c68e":"code","c4fb8935":"code","e61fd41c":"code","230a6d38":"code","815b616f":"code","ac09d730":"code","40b96aaa":"code","60681304":"code","6c600691":"code","31fe2eb0":"code","391550e2":"markdown","0589de2e":"markdown","ba528a5a":"markdown","bda6cfba":"markdown","8cdb5b74":"markdown","eb7c7424":"markdown","4d69baf0":"markdown","1fc64b20":"markdown","61b0e4c8":"markdown","75e73591":"markdown","cfd0b475":"markdown","d9bfd2e3":"markdown","c634dac0":"markdown","1d612a7d":"markdown","3b66c135":"markdown","d898978c":"markdown","aa147ef0":"markdown","b9fb51f3":"markdown","eda50078":"markdown","7968cf51":"markdown","4bd4d565":"markdown","96fbb673":"markdown","ca124151":"markdown","a5529489":"markdown","8cda7559":"markdown","b5267fdd":"markdown","ece1faf5":"markdown","5235b8e7":"markdown","c6d590f7":"markdown","f732f2ab":"markdown","3e07b763":"markdown","cea567c4":"markdown","83cd3862":"markdown","f86bb8af":"markdown","23aaf466":"markdown","9202ab6a":"markdown","f15c997e":"markdown","6535792a":"markdown","0e7f1ddf":"markdown","9131b276":"markdown","70af87e4":"markdown","baace03f":"markdown","844f574a":"markdown","3938ff8e":"markdown","9bbcd10e":"markdown","f2346bf0":"markdown","e0bab0a2":"markdown","4ce717c3":"markdown","67996e72":"markdown","09da32ba":"markdown","3b302509":"markdown","d485adc3":"markdown","a26bc539":"markdown","700c3bc6":"markdown","3ca12cbf":"markdown","8993a58c":"markdown","d188d77f":"markdown","c7544957":"markdown","a2669ae7":"markdown"},"source":{"13ce0710":"pip install lifetimes","54d62886":"import datetime as dt\nimport pandas as pd\nimport matplotlib.pyplot as plt\nfrom sklearn.preprocessing import MinMaxScaler\n\nfrom lifetimes import BetaGeoFitter\nfrom lifetimes import GammaGammaFitter\nfrom lifetimes.plotting import plot_period_transactions","c4ed1b36":"df = pd.read_csv(\"..\/input\/online-retail-ii-uci\/online_retail_II.csv\")","81d39108":"df.head()","4e572142":"df.describe().T","6db40519":"df.isnull().sum()","1fe97fc1":"df.dropna(inplace=True)","b5c04529":"df[\"Description\"].nunique()","dc4f8157":"df[\"Description\"].value_counts().head()","cfad061b":"df.groupby(\"Description\").agg({\"Quantity\": \"sum\"}).sort_values(by=\"Quantity\", ascending=False).head(10)","3deaa98d":"df = df[~df[\"Invoice\"].str.contains(\"C\", na=False)]\ndf = df[(df['Quantity'] > 0)]\ndf = df[(df['Price'] > 0)]\ndf = df[df['Country'] == 'United Kingdom']","3f8c20a8":"def outlier_thresholds(dataframe, variable):\n    quartile1 = dataframe[variable].quantile(0.01)\n    quartile3 = dataframe[variable].quantile(0.99)\n    interquantile_range = quartile3 - quartile1\n    up_limit = quartile3 + 1.5 * interquantile_range\n    low_limit = quartile1 - 1.5 * interquantile_range\n    return low_limit, up_limit\ndef replace_with_thresholds(dataframe, variable):\n    low_limit, up_limit = outlier_thresholds(dataframe, variable)\n    dataframe.loc[(dataframe[variable] < low_limit), variable] = low_limit\n    dataframe.loc[(dataframe[variable] > up_limit), variable] = up_limit\n","66297698":"replace_with_thresholds(df, \"Quantity\")\nreplace_with_thresholds(df, \"Price\")","264231a8":"df[\"TotalPrice\"] = df[\"Quantity\"] * df[\"Price\"]","3f814c64":"df.sort_values(by = 'TotalPrice', ascending = False)","02e8c224":"today_date = pd.to_datetime(df['InvoiceDate'].max()) + pd.DateOffset(days=2)","0eaa8d07":"cltv_df = df.groupby('Customer ID').agg(\n        {'InvoiceDate': [lambda InvoiceDate: (today_date - pd.to_datetime(InvoiceDate).max()).days,\n                         lambda InvoiceDate: (today_date - pd.to_datetime(InvoiceDate).min()).days],\n         'Invoice': lambda Invoice: Invoice.nunique(),\n         'TotalPrice': lambda TotalPrice: TotalPrice.sum()})","a8297691":"cltv_df.columns = cltv_df.columns.droplevel(0)\ncltv_df.columns = ['recency', 'T', 'frequency', 'monetary']\ncltv_df.head()","34da862a":"cltv_df.sort_values(by = 'monetary', ascending = False)","f74c9474":"cltv_df[\"monetary\"] = cltv_df[\"monetary\"] \/ cltv_df[\"frequency\"]","1c26d2ac":"cltv_df = cltv_df[(cltv_df['frequency'] > 1)]","61ff4771":"cltv_df[\"recency\"] = cltv_df[\"recency\"] \/ 7\ncltv_df[\"T\"] = cltv_df[\"T\"] \/ 7","dd205bc0":"cltv_df.sort_values(by = \"monetary\", ascending = False)","be69cb26":"bgf = BetaGeoFitter(penalizer_coef=0.001)\nbgf.fit(cltv_df['frequency'], cltv_df['recency'], cltv_df['T'])","8f3229d0":"bgf.conditional_expected_number_of_purchases_up_to_time(1,\n                                                        cltv_df['frequency'],\n                                                        cltv_df['recency'],\n                                                        cltv_df['T']).sort_values(ascending=False).head(10)","4bfa6d3c":"bgf.predict(4,\n            cltv_df['frequency'],\n            cltv_df['recency'],\n            cltv_df['T']).sort_values(ascending=False).head(10)","8d47ae4e":"bgf.predict(4 * 3,\n            cltv_df['frequency'],\n            cltv_df['recency'],\n            cltv_df['T']).sum()","8316c68e":"bgf.predict(4,\n            cltv_df['frequency'],\n            cltv_df['recency'],\n            cltv_df['T']).sum()","c4fb8935":"    cltv_df[\"expected_purc_1_week\"] = bgf.predict(1,\n                                                  cltv_df['frequency'],\n                                                  cltv_df['recency'],\n                                                  cltv_df['T'])\n\n    cltv_df[\"expected_purc_1_month\"] = bgf.predict(4,\n                                                   cltv_df['frequency'],\n                                                   cltv_df['recency'],\n                                                   cltv_df['T'])\n\n    cltv_df[\"expected_purc_3_month\"] = bgf.predict(12,\n                                                   cltv_df['frequency'],\n                                                   cltv_df['recency'],\n                                                   cltv_df['T'])","e61fd41c":"cltv_df.sort_values(\"expected_purc_1_week\", ascending=False).head(10)","230a6d38":"ggf = GammaGammaFitter(penalizer_coef=0.01) \nggf.fit(cltv_df['frequency'], cltv_df['monetary'])\ncltv_df[\"expected_average_profit\"] = ggf.conditional_expected_average_profit(cltv_df['frequency'], cltv_df['monetary'])","815b616f":"cltv = ggf.customer_lifetime_value(bgf,\n                                       cltv_df['frequency'],\n                                       cltv_df['recency'],\n                                       cltv_df['T'],\n                                       cltv_df['monetary'],\n                                       time=6, # Prediction for 6 months   \n                                       freq=\"W\",  # Frequency of T.\n                                       discount_rate=0.01)","ac09d730":"cltv = cltv.reset_index()\ncltv_final = cltv_df.merge(cltv, on=\"Customer ID\", how=\"left\")","40b96aaa":"cltv_final.head()","60681304":"scaler = MinMaxScaler(feature_range=(0, 1))\nscaler.fit(cltv_final[[\"clv\"]])\ncltv_final[\"scaled_clv\"] = scaler.transform(cltv_final[[\"clv\"]])\ncltv_final.sort_values(by=\"scaled_clv\", ascending=False).head(10)","6c600691":"cltv_final[\"segment\"] = pd.qcut(cltv_final[\"clv\"], 4, labels=[\"D\", \"C\", \"B\", \"A\"])\ncltv_final.sort_values(by=\"scaled_clv\", ascending=False)","31fe2eb0":"cltv_final.describe().T","391550e2":"# References:\n[1] https:\/\/www.seedrs.com\/academy\/how-to-calculate-customer-lifetime-value\/\n\n[2] Fader, P. S., Hardie, B. G., & Lee, K. L. (2008). Computing P (alive) using the BG\/NBD model.\n\n[3] Jasek, P., Vrana, L., Sperkova, L., Smutny, Z., & Kobulsky, M. (2019). Comparative analysis of selected probabilistic customer lifetime value models in online shopping. Journal of Business Economics and Management, 20(3), 398-423.\n\n[4] Venkatakrishna, M. R., Mishra, M. P., & Tiwari, M. S. P. Customer Lifetime Value Prediction and Segmentation using Machine Learning.\n","0589de2e":"* Deliver Personalized Experiences\n* Improve Your Customer Service\n* Reward the Loyalty\n* Build Teams That Can Successfully Implement Your Strategy\n* Use Digital Channels Effectively\n* Take the First Step","ba528a5a":"We divide the final values we get into segments so that we can apply different strategies for each group.","bda6cfba":"![image.png](attachment:ffb0b225-9a3c-4cca-9cd1-65277c0a59f7.png)","8cdb5b74":"As usual, we import the libraries we will use first. \n\n*In this prediction model we will additionally use the lifetimes library.*","eb7c7424":"![image.png](attachment:958a574b-9b8f-4b21-a188-d4c6b2dc40d6.png)","4d69baf0":"In order to ensure efficiency and effectiveness in customer relations, it is necessary to first understand what the customer needs, to develop products suitable for this need, and then to present the product to the right customer, at the right time and at the right price. In this respect, CRM is the whole of the methods used by companies to make the relationship they have established with their existing or potential customers in the most efficient, effective and ultimately most profitable.","1fc64b20":"# 1) Exploring the Dataset:","61b0e4c8":"The most important issue in this section is the need to predict the potential values \u200b\u200bof our new customers.\n\nWhether our customer has just come and purchased 1\u20132 products, we want to assign a value to this customer. So we need to make an estimation of whether this future customer is very valuable or unimportant to us.\n\nIf we can predict this situation, we can follow a marketing strategy with the customer accordingly. In this case, making CLTV Prediction for the future is at a very important point in CRM studies. Another need here is this: Although we have the average revenue and purchasing frequency of the customer, the reason why we cannot make forward forecasts is,\nFor the company, we do not have the behavioral distribution of all customers. In addition, we cannot make an estimation for individuals based on this probability distribution.\nWith BG-NBD and Gamma-Gamma models, we will solve this problem and make forward-looking predictions.","75e73591":"To build our forecasting model, we need to select **customers who make us multiple purchases**.","cfd0b475":"![](https:\/\/survicate.com\/wp-content\/uploads\/2019\/05\/clv-clevertap.jpg)","d9bfd2e3":"# 2-Customer Lifetime Value Calculation","c634dac0":"**Variables**\n\nInvoiceNo: Invoice number. It is a unique value. If this code starts with C, it means return\n\nStockCode: Product code. It is unique for each product.\n\nDescription: Product name\n\nQuantity: Number of products. It expresses how many of the products on the invoices have been sold. Those starting with C take a negative value.\n\nInvoiceDate: Invoice date and time\n\nUnitPrice: Product price\n\nCustomer ID: Customer number. It is a unique number for each customer\n\nCountry: The name of the country. Indicates the country where the customer lives.","1d612a7d":"**Columns We Have Created**\n\n\nRecency : It is equal to the duration between a customers first purchase and their last purchase.\n\nT (Age of the customer): It is equal to the duration between a customer's first purchase and the last day in the dataset. \n\nFrequency: The number of periods in which the customer has made a repeat purchase.\n\nMonetary: The profitability value of the customer's relationship with the company.","3b66c135":"We are only interested in values greater than zero in the Quantity and Price fields. We also do not consider canceled transactions.","d898978c":"**How is Customer Lifetime Value calculated?**\n\nThe CLTV account has many calculation metrics. Basically, the metrics to focus on are;\n* Average Order Value\n* Purchase Frequency\n* Profit Margin\n* Churn Rate\n* Customer Value\n* Customer Life Time Value","aa147ef0":"# 3-Customer Lifetime Value Prediction","b9fb51f3":"Now let's set up a model that makes a 6-month CLTV prediction by combining our BG-NBD and Gamma-Gamma model. As a result, we will bring our customers who are most likely to shop in a 6-month projection.","eda50078":"Average customer expenditures per visit (S) = \u00a35.90 \nThe purchase cycle (C) = 4.2 \nAverage customer value \/ week (A) = \u00a324.30 \n\nWhen you have estimated your variables you will have to take into account some constants. These are:\n\n**1. Average customer lifespan (T) \u2013 How long, based on your experience, do customers remain your customers?**\n\nCalculate Churn Rate %:\n\nCB \u2013 Customers at the beginning of a period\n\nCE \u2013 Customers at the end of a period\n\nIf you had 100 customers at the start of the period, and 95 customers at the end of the period, your churn rate would be:\n\nChurn rate (%) = (100-95)\/100 = 5\/100\n\n= 5%\n\nT = 1 \/ 5% \n\n= 1 \/ 0.05 = 20\n\n**2. Discount rate (I) \u2013 No, this is not your customer\u2019s discount. You are projecting a value, into the future, but you\u2019ll have to adapt this value to present tense. Simply put \u2013 the value of a certain good in the future is lower than that of one you are holding in your hands today. This is the interest rate used in discounted cash flow analysis to determine the present value of future cash flows. Confused? Go with a standard 10% rate.**\n\n**3. Customer retention rate (R) \u2013 How many of your customers come back to your store and purchase from you, compared to the previous, equal amount of time?**\n\nCE = customers at the end of a period of time\nCN = customers acquired during a period of time\nCB = customers at the beginning of a period of time\nSay you had:\n\nCE = 95\n\nCN = 20\n\nCB = 100\n\nR = ((95-20) \/ 100) \u00d7 100 \n\n= (75 \/ 100) \u00d7 100 \n\n= 0.75 \u00d7 100\n\n= 75%\n\n**4. Profit Margin (P)**\n\nTotal revenue: \u00a3500\n\nCost of sales: \u00a3393.45\n\nP = ((500-393.45) \/ 500) x 100 = 21.3%\n\n**5. Average Gross Margin per Customer Lifespan (M) \u2013 the gross profit per customer expected in the given average lifespan.**\n\nM = 21.3%( 52(24.30) x 20)\n\n=\u00a35,382.94\n\n\n\n\nSimple Customer Lifetime Value Formula: \n\n= 52(24.30) x 20\n\n= \u00a325,272\n\n\n**NOTE: the number 52 comes from the number of weeks in a year.**\n\n[1]","7968cf51":"## Segmentation of Scaled CLV Values ","4bd4d565":"We scale them between 1 and 0 so that the values we get can give an idea of size and smallness, so it provides us with information without any calculations.","96fbb673":"As a result of the following transactions and calculations, we may now calculate the value of each customer in our company.\n\nWhen we evaluate our customers on an annual basis, for example, if we have the information on the annual average number of orders and how much they spend on these orders, we can calculate the Customer Life Time Value for each customer.","ca124151":"BG\/NBD model asks us for *recency* and *T* **weekly**","a5529489":"Let's add columns to the data set, where we can observe the purchasing behavior of customers in 1 week, 1 month and 3-month periods. \n\n> The BGNBD model only gives an idea about the purchase frequency. It does not produce a conclusion about profitability.","8cda7559":"# Gamma-Gamma Model","b5267fdd":"Who are the **10 customers** we expect the **most to purchase in a month?**","ece1faf5":"It is used for the estimation of the conditional expected average profit in a certain period of time.","5235b8e7":"![image.png](attachment:62904107-4469-4931-b3d6-841a857fc0c0.png)","c6d590f7":"![image.png](attachment:9f6bb250-0c7b-4e67-b60f-d2aba71c1ed8.png)","f732f2ab":"# However!!! \n\n* **This calculation will represent a single time period. It will also only represent the time the analysis was made.**\n\n* **In these formulas, Total Price is the dominant factor and will suppress the frequency. This leads to the fact that the number of transactions will not matter once the customer has earned the same price to the company.**\n\n* **Churn rate comes from all customer base. It will not be personal. Likewise, Profit is not specific to the customer, coming from the entire customer base.**\n\nFor all these reasons, we need a more comprehensive model. For this, we will use BG-NBD and Gamma-Gamma models.","3e07b763":"To work on segments, we can group according to their mean, count and sum values. Thus, we will have obtained very useful insights for each group before the marketing actions we will take.","cea567c4":"![](https:\/\/miro.medium.com\/max\/700\/1*YjLKQnJE3wr7LQlovO78iQ.png)","83cd3862":"# Why use CRM?","f86bb8af":"![image.png](attachment:e55a1954-32f4-4da4-bade-81f16650054a.png)","23aaf466":"Who are the **10 customers** we expect the **most to purchase in a week?**","9202ab6a":"In this notebook, we will do the following topics step by step, respectively:\n* 1-Dataset Analysis\n* 2-Customer Lifetime Value Calculation\n* 3-Customer Lifetime Value Prediction","f15c997e":"We need to calculate the average profit:","6535792a":"# BG-NBD Model","0e7f1ddf":"We merge the CLTV value we have calculated into the df we use. So add it as a colon.","9131b276":"# Key points to successfully apply CRM techniques:","70af87e4":"![image.png](attachment:5e6032ae-31ed-4f12-977f-f5c2e257b813.png)","baace03f":"![image.png](attachment:65626382-479d-49a0-a944-5e3a5e60dc7d.png)","844f574a":"# Customer Relationship Management","3938ff8e":"![](https:\/\/popupsmart.com\/encyclopedia\/user\/pages\/26.customer-lifetime-value-clv\/customer-lifetime-value.jpg)","9bbcd10e":"![](https:\/\/miro.medium.com\/max\/1838\/0*ZUepkV0FnvKzRsIU)","f2346bf0":" Let's bring the customers with high frequency and monetary values for 1 week projection.","e0bab0a2":"What is the Expected Number of Sales of the Whole Company in **3 Months?**","4ce717c3":"![image.png](attachment:b6553486-c356-4cc3-ace1-7504383ecc42.png)","67996e72":"# Calculation of CLTV with BG-NBD and GG model.","09da32ba":"> Retaining existing customers is less costly than acquiring new customers. Therefore, increasing the value of our existing customers is the most important way to ensure growth.","3b302509":"\u201cIt is the total expected revenue from a company's entire lifetime relationship with a customer, less any expenses incurred for the customer.\n\nThe customer value approach requires more variable and inclusive strategies rather than a static and uniform approach. Expansion, correct sales and cross-selling techniques, monitoring customer behavior, obtaining intelligence, making strategic decisions and applying are some of the methods to be used.\n\nYou should use your customer services effectively for a positive customer experience. Every contact of the customer with your brand will be an opportunity to convey the values you will add to them.\n\nHigher customer lifetime value means more revenue for your business. Prioritize customer lifetime value to increase your profitability.","d485adc3":"To provide a unique customer experience (CX), you will need a complete profile of your customer. You may need all kinds of data to create a customer profile. CRM techniques; It aggregates data from a variety of sources, including email, websites, physical stores, call centers, mobile sales, marketing and advertising efforts.\n\nKnowing who your customers are, what they want, your interactions with them in the past, and what your future interactions might look like is the focus of CRM.","a26bc539":"There is no relationship between purchasing frequency and the calculated monetary value.\nThe average calculated value differs for each customer.","700c3bc6":"What is the Expected Number of Sales of the Whole Company in **1 Months?**","3ca12cbf":"![image.png](attachment:85d345b3-7392-4d4a-9792-1869c00acddc.png)","8993a58c":"We can make outlier values in variables such as Quantity and Price more appropriate with these functions.","d188d77f":"# Let's prepare the dataset for CLTV Prediction","c7544957":"# Scaling CLV Values","a2669ae7":"# Customer Lifetime Value (CLTV)"}}