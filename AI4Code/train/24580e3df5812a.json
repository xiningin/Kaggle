{"cell_type":{"d19979e1":"code","5b3de0f8":"code","84996585":"code","b1fbfe98":"code","65fd3320":"code","16153d5e":"code","6b646dd0":"code","740cae3a":"code","b2ab4b69":"code","a6922fe5":"code","d41a3e22":"code","9a8fd10d":"code","cfe09d89":"code","8a9b8ab0":"code","46f0b64b":"code","0d6efa4d":"code","c75abddc":"code","6a62c20b":"code","9f865e6c":"code","3dc34821":"code","9f4cfc8a":"code","52d3b5d9":"code","4d385faf":"code","dc9ed81f":"code","ef44af5d":"code","ca2dbb04":"code","45a1825e":"code","d8d0520f":"code","0d37e509":"code","def9d8d0":"code","25ac5277":"code","b29f10bb":"code","a26fa7a7":"code","4411c804":"code","630d50ef":"code","4647dea1":"code","61315924":"code","329d341f":"code","050ae3ad":"code","ff764af0":"code","91e9e104":"code","38011df0":"code","31a62e6b":"code","c42e68c5":"code","60df2862":"code","2335122b":"code","a2a6a1a8":"code","18e9b8d4":"code","50172d40":"code","e7782727":"code","756dd24b":"code","5dffaa46":"code","471e7949":"code","29d60f5e":"code","0adac331":"code","c7b3a744":"code","b921912d":"code","6551ee93":"code","ba5cd61b":"markdown","4efb90a7":"markdown","e38805e6":"markdown","d388d2cc":"markdown","0077d67d":"markdown","9aa615c5":"markdown","2806022b":"markdown","d6defeb9":"markdown","ca0dcb12":"markdown","e8ee27ee":"markdown","319473f0":"markdown","fba3586a":"markdown","0ee34b24":"markdown","95828904":"markdown","966533b8":"markdown","5b59cfa1":"markdown","50efdce5":"markdown","bb938037":"markdown","33f58570":"markdown","58ae8f1b":"markdown","17d2c0ce":"markdown","a925a14d":"markdown","e2df2334":"markdown","6b5bc1b4":"markdown","f0a3900d":"markdown"},"source":{"d19979e1":"# Basic operations\nimport numpy as np\nimport pandas as pd\npd.options.mode.chained_assignment = None \nfrom scipy.stats import norm\n# Data visualizations\nimport matplotlib.pyplot as plt\nimport seaborn as sns\nimport plotly.offline as py\nfrom plotly.offline import init_notebook_mode, iplot\nimport plotly.graph_objs as go\n#Modeling: Random Forest Classifier\nfrom sklearn.model_selection import train_test_split\nfrom sklearn.ensemble import RandomForestClassifier\nfrom sklearn.metrics import confusion_matrix\nfrom sklearn.metrics import classification_report\nfrom sklearn.pipeline import Pipeline\nfrom sklearn.model_selection import cross_val_score\nfrom sklearn.metrics import matthews_corrcoef\nfrom sklearn.metrics import roc_curve\nfrom sklearn.metrics import auc\n#Model explanation\nimport eli5 \nfrom eli5.sklearn import PermutationImportance\nimport shap \nfrom pdpbox import pdp, info_plots #for partial plots\n\n%matplotlib inline\n\n# for providing path\nimport os\n#print(os.listdir('..\/input\/'))","5b3de0f8":"# reading the data\ndata = pd.read_csv('..\/input\/heart-disease-uci\/heart.csv')\n\n##\/kaggle\/input\/heart-disease-uci\/heart.csv\n\n\n# getting the shape\ndata.shape","84996585":"# Checking dataset head\ndata.head()","b1fbfe98":"# Describing dataset\ndata.describe()","65fd3320":"#Pairplot\nsns.pairplot(data)","16153d5e":"# Heatmap\nplt.rcParams['figure.figsize'] = (15, 10)\nplt.style.use('ggplot')\nsns.heatmap(data.corr(), annot = True)\nplt.title('Heatmap for the Dataset', fontsize = 20)\nplt.show()","6b646dd0":"# Checking the distribution of age amonng the patients\nplt.rcParams['figure.figsize'] = (12, 9)\nsns.distplot(data['age'], fit=norm, kde=False)\nplt.title('Distribution of Age', fontsize = 15)\nplt.show()","740cae3a":"# Checking Target\nplt.rcParams['figure.figsize'] = (12, 9)\nsns.countplot(data['target'])\nplt.xlabel(\" Target\")\nplt.ylabel(\"Count\")\nplt.show()","b2ab4b69":"# Checking gender distribuition\nplt.rcParams['figure.figsize'] = (12, 9)\nsize = data['sex'].value_counts()\ncolors = ['lightblue', 'lightgreen']\nlabels = \"Male\", \"Female\"\nexplode = [0, 0.01]\nmy_circle = plt.Circle((0, 0), 0.7, color = 'white')\nplt.pie(size, colors = colors, labels = labels, shadow = True, explode = explode, autopct = '%.2f%%')\nplt.title('Distribution of Gender', fontsize = 15)\np = plt.gcf()\np.gca().add_artist(my_circle)\nplt.legend()\nplt.show()","a6922fe5":"# Checking chest type\nplt.rcParams['figure.figsize'] = (12, 9)\nsns.countplot(data['cp'])\nplt.xlabel(\" Chest type\")\nplt.ylabel(\"Count\")\nplt.show()","d41a3e22":"# tresbps vs target\nplt.rcParams['figure.figsize'] = (12, 9)\nsns.boxplot(data['target'], data['trestbps'], palette = 'viridis')\nplt.title('Relation of tresbps with target', fontsize = 20)\nplt.show()","9a8fd10d":"# cholestrol vs target\nplt.rcParams['figure.figsize'] = (12, 9)\nsns.violinplot(data['target'], data['chol'], palette = 'colorblind')\nplt.title('Relation of Cholestrol with Target', fontsize = 20, fontweight = 30)\nplt.show()","cfe09d89":"# Resting electrocardiographic measurement vs target\nplt.rcParams['figure.figsize'] = (12, 9)\ndat = pd.crosstab(data['target'], data['restecg']) \ndat.div(dat.sum(1).astype(float), axis = 0).plot(kind = 'bar', \n                                                 stacked = False, \n                                                 color = plt.cm.rainbow(np.linspace(0, 1, 4)))\nplt.title('Relation of ECG measurement with Target', fontsize = 20, fontweight = 30)\nplt.show()","8a9b8ab0":"# Relation between age and target\nplt.rcParams['figure.figsize'] = (12, 9)\nsns.swarmplot(data['target'], data['age'], palette = 'winter', size = 10)\nplt.title('Relation of Age and target', fontsize = 20, fontweight = 30)\nplt.show()","46f0b64b":"# Relation between sex and target\nsns.boxenplot(data['target'], data['sex'], palette = 'Set3')\nplt.title('Relation of Sex and target', fontsize = 20, fontweight = 30)\nplt.show()","0d6efa4d":"# Relation between thal: A blood disorder called thalassemia (3 = normal; 6 = fixed defect; 7 = reversable defect)\nsns.boxenplot(data['target'], data['thal'], palette = 'magma')\nplt.title('Relation between Target and Blood disorder-Thalessemia', fontsize = 20, fontweight = 30)\nplt.show()","c75abddc":"# target vs chol and hue = thalach\nplt.rcParams['figure.figsize'] = (15, 8)\nplt.style.use('fivethirtyeight')\nplt.scatter(x = data['target'], y = data['chol'], s = data['thalach']*100, color = 'yellow')\nplt.title('Relation of target with cholestrol and thalessemia', fontsize = 20, fontweight = 30)\nplt.show()","6a62c20b":"# multi-variate analysis\nsns.boxplot(x = data['target'], y = data['trestbps'], hue = data['sex'], palette = 'rainbow')\nplt.title('Checking relation of tresbps with genders to target', fontsize = 20, fontweight = 30)\nplt.show()","9f865e6c":"# Changing columns names\ndata.columns = ['age', 'sex', 'chest_pain_type', 'resting_blood_pressure', 'cholesterol', 'fasting_blood_sugar', 'rest_ecg', 'max_heart_rate_achieved',\n       'exercise_induced_angina', 'st_depression', 'st_slope', 'num_major_vessels', 'thalassemia', 'target']\ndata.columns","3dc34821":"# Preparing labels to encode\ndata['sex'][data['sex'] == 0] = 'female'\ndata['sex'][data['sex'] == 1] = 'male'\n\ndata['chest_pain_type'][data['chest_pain_type'] == 1] = 'typical angina'\ndata['chest_pain_type'][data['chest_pain_type'] == 2] = 'atypical angina'\ndata['chest_pain_type'][data['chest_pain_type'] == 3] = 'non-anginal pain'\ndata['chest_pain_type'][data['chest_pain_type'] == 4] = 'asymptomatic'\n\ndata['fasting_blood_sugar'][data['fasting_blood_sugar'] == 0] = 'lower than 120mg\/ml'\ndata['fasting_blood_sugar'][data['fasting_blood_sugar'] == 1] = 'greater than 120mg\/ml'\n\ndata['rest_ecg'][data['rest_ecg'] == 0] = 'normal'\ndata['rest_ecg'][data['rest_ecg'] == 1] = 'ST-T wave abnormality'\ndata['rest_ecg'][data['rest_ecg'] == 2] = 'left ventricular hypertrophy'\n\ndata['exercise_induced_angina'][data['exercise_induced_angina'] == 0] = 'no'\ndata['exercise_induced_angina'][data['exercise_induced_angina'] == 1] = 'yes'\n\ndata['st_slope'][data['st_slope'] == 1] = 'upsloping'\ndata['st_slope'][data['st_slope'] == 2] = 'flat'\ndata['st_slope'][data['st_slope'] == 3] = 'downsloping'\n\ndata['thalassemia'][data['thalassemia'] == 1] = 'normal'\ndata['thalassemia'][data['thalassemia'] == 2] = 'fixed defect'\ndata['thalassemia'][data['thalassemia'] == 3] = 'reversable defect'","9f4cfc8a":"# Checking type of data in our dataframe\ndata.dtypes","52d3b5d9":"# Converting columns in objects\ndata['sex'] = data['sex'].astype('object')\ndata['chest_pain_type'] = data['chest_pain_type'].astype('object')\ndata['fasting_blood_sugar'] = data['fasting_blood_sugar'].astype('object')\ndata['rest_ecg'] = data['rest_ecg'].astype('object')\ndata['exercise_induced_angina'] = data['exercise_induced_angina'].astype('object')\ndata['st_slope'] = data['st_slope'].astype('object')\ndata['thalassemia'] = data['thalassemia'].astype('object')","4d385faf":"# Taking the labels out from the data \ny = data['target']\ndata = data.drop('target', axis = 1)\nprint(\"Shape of y:\", y.shape)","dc9ed81f":"# OneHot encoding of the data\n# drop_first = True, means dropping the first categories from each of the attribues \n# for ex gender having gender_male and gender-female would be male having values 1 and 0\ndata = pd.get_dummies(data, drop_first=True)","ef44af5d":"# Checking the dataset after encoding\ndata.head()","ca2dbb04":"# Splitting the dependent and independent variables from the data\nx = data","45a1825e":"# Checking the shapes of x and y\nprint(\"Shape of x:\", x.shape)\nprint(\"Shape of y:\", y.shape)","d8d0520f":"y.value_counts()","0d37e509":"# Splitting the sets into training and test sets\nx_train, x_test, y_train, y_test = train_test_split(x, y, test_size = 0.2, random_state = 0)","def9d8d0":"# getting the shapes\nprint(\"Shape of x_train :\", x_train.shape)\nprint(\"Shape of x_test :\", x_test.shape)\nprint(\"Shape of y_train :\", y_train.shape)\nprint(\"Shape of y_test :\", y_test.shape)","25ac5277":"#Creating a function to find the best value for n_estimators, considering 3 folders cross-validation \ndef get_score(n_estimators):\n    \"\"\"Return the precision over 5 CV folds\"\"\"\n    random_forest_pipeline = Pipeline(steps=[('model', RandomForestClassifier(n_estimators, max_depth=5))])\n    scores = cross_val_score(random_forest_pipeline, x, y,\n                                  cv=5,\n                                  scoring='precision')\n    return scores.mean()","b29f10bb":"results_random_forest = {}\nfor i in range(1,9):\n    results_random_forest[50*i] = get_score(50*i)","a26fa7a7":"plt.plot(list(results_random_forest.keys()), list(results_random_forest.values()))\nplt.xlabel('n_estimators')\nplt.ylabel('Precision')\nplt.show()","4411c804":"#Finding the best n_estimators\nn_estimators_random_forest = min(results_random_forest, key=results_random_forest.get)\nn_estimators_random_forest","630d50ef":"#Fitting Model\nmodel = RandomForestClassifier(n_estimators = n_estimators_random_forest, random_state=0, max_depth=5, n_jobs=8)\nmodel.fit(x_train, y_train)","4647dea1":"# Getting predictions\ny_predict = model.predict(x_test)\ny_pred_quant = model.predict_proba(x_test)[:, 1]  #predict_proba(self, X) ---Probability estimates.\ny_pred = model.predict(x_test)","61315924":"# Generating Cofusion Matrix\ncm = confusion_matrix(y_test, y_pred)\nplt.rcParams['figure.figsize'] = (5, 5)\nsns.heatmap(cm, annot = True, annot_kws = {'size':15}, cmap = 'PuBu')","329d341f":"# Generating Classification Report\ncr = classification_report(y_test, y_pred)\nprint(cr)","050ae3ad":"# Computing Accuracy for training and test data\nprint(\"Training Accuracy :\", model.score(x_train, y_train))\nprint(\"Testing Accuracy :\", model.score(x_test, y_test))","ff764af0":"#Computing Matthews Correlation Coefficient\nprint('Matthews Correlation Coefficient:', matthews_corrcoef(y_test, y_pred))","91e9e104":"# Computing Specificity and Sensitivity scores\ntotal=sum(sum(cm))\nsensitivity = cm[0,0]\/(cm[0,0]+cm[1,0])\nprint('Sensitivity : ', sensitivity )\nspecificity = cm[1,1]\/(cm[1,1]+cm[0,1])\nprint('Specificity : ', specificity)","38011df0":"#ROC Curve\n\n#Computing fpr (false positives rate), tpr (true positives rate) and thresholds\nfpr, tpr, thresholds = roc_curve(y_test, y_pred_quant)\n\n#Ploting ROC Curve\nfig, ax = plt.subplots(figsize=(8,6))\nax.plot(fpr, tpr)\nax.plot([0, 1], [0, 1], transform=ax.transAxes, ls=\"-\", c=\".3\")\nplt.xlim([0.0, 1.0])\nplt.ylim([0.0, 1.0])\nplt.title('ROC curve for diabetes classifier', fontweight = 30)\nplt.xlabel('False Positive Rate (1 - Specificity)')\nplt.ylabel('True Positive Rate (Sensitivity)')\nplt.show()","31a62e6b":"# Checking AUC score\nauc = auc(fpr, tpr)\nprint(\"AUC Score :\", auc)","c42e68c5":"#Tree for Model Explanation\nfrom sklearn.tree import export_graphviz\nestimator = model.estimators_[1]\nfeature_names = [i for i in x_train.columns]\ny_train_str = y_train.astype('str')\ny_train_str[y_train_str == '0'] = 'no disease'\ny_train_str[y_train_str == '1'] = 'disease'\ny_train_str = y_train_str.values\nexport_graphviz(estimator, out_file='tree.dot', \n                feature_names = feature_names,\n                class_names = y_train_str,\n                rounded = True, proportion = True, \n                label='root',\n                precision = 2, filled = True)\n\nfrom subprocess import call\ncall(['dot', '-Tpng', 'tree.dot', '-o', 'tree.png', '-Gdpi=50'])\nfrom IPython.display import Image\nImage(filename = 'tree.png')","60df2862":"# Checking the importance of each attributes\nperm = PermutationImportance(model, random_state = 0).fit(x_test, y_test)\neli5.show_weights(perm, feature_names = x_test.columns.tolist())","2335122b":"# Partial dependence plot for thalassemia_fixed defect\nbase_features = data.columns.values.tolist()\nfeat_name = 'thalassemia_fixed defect'\npdp_dist = pdp.pdp_isolate(model = model, dataset = x_test, model_features = base_features, feature = feat_name)\npdp.pdp_plot(pdp_dist, feat_name)\nplt.show()","a2a6a1a8":"# Partial dependence plot for num_major_vessels\nbase_features = data.columns.values.tolist()\nfeat_name = 'num_major_vessels'\npdp_dist = pdp.pdp_isolate(model=model, dataset=x_test, model_features = base_features, feature = feat_name)\npdp.pdp_plot(pdp_dist, feat_name)\nplt.show()","18e9b8d4":"# Partial dependence graph for st_depression\nbase_features = data.columns.values.tolist()\nfeat_name = 'st_depression'\npdp_dist = pdp.pdp_isolate(model = model, dataset = x_test, model_features = base_features, feature = feat_name)\npdp.pdp_plot(pdp_dist, feat_name)\nplt.show()","50172d40":"\n# Partial dependence plot for thalassemia_reversable defect\nbase_features = data.columns.values.tolist()\nfeat_name = 'thalassemia_reversable defect'\npdp_dist = pdp.pdp_isolate(model = model, dataset = x_test, model_features = base_features, feature = feat_name)\npdp.pdp_plot(pdp_dist, feat_name)\nplt.show()","e7782727":"# Partial dependence graph for chest_pain_type_atypical angina\nbase_features = data.columns.values.tolist()\nfeat_name = 'chest_pain_type_atypical angina'\npdp_dist = pdp.pdp_isolate(model = model, dataset = x_test, model_features = base_features, feature = feat_name)\npdp.pdp_plot(pdp_dist, feat_name)\nplt.show()","756dd24b":"# Checking shap values\nexplainer = shap.TreeExplainer(model)\nshap_values = explainer.shap_values(x_test)\nshap.summary_plot(shap_values[1], x_test, plot_type=\"bar\")","5dffaa46":"shap.summary_plot(shap_values[1], x_test)","471e7949":"# Checking the patient's conditions\ndef patient_analysis(model, patient):\n  explainer = shap.TreeExplainer(model)\n  shap_values = explainer.shap_values(patient)\n  shap.initjs()\n  return shap.force_plot(explainer.expected_value[1], shap_values[1], patient)","29d60f5e":"# Real time prediction for patients\npatients = x_test.iloc[1,:].astype(float)\npatient_analysis(model, patients)","0adac331":"patients = x_test.iloc[:, 2].astype(float)\npatient_analysis(model, patients)","c7b3a744":"patients = x_test.iloc[:,3].astype(float)\npatient_analysis(model, patients)","b921912d":"# dependence plot\nshap.dependence_plot('num_major_vessels', shap_values[1], x_test, interaction_index = \"st_depression\")","6551ee93":"shap_values = explainer.shap_values(x_train.iloc[:50])\nshap.initjs()\nshap.force_plot(explainer.expected_value[1], shap_values[1], x_test.iloc[:50])\n","ba5cd61b":"**Shap Values for Model Explanation**","4efb90a7":"> The above Distribution plot shows the distribution of Age amongst all of the entries in the dataset about the heart patients. The Graph suggests that the highest number of people suffering from heart diseases are in the age group of 55-65 years. The patients in the age group 20-30 are very less likely to suffer from heart diseases.\n>> As we know that the number of people in the age group 65-80 has a very low population, hence distribution is also less. we might have to opt for other plots to investigate further and get some more intuitive results.","e38805e6":"A confusion matrix is a technique for summarizing the performance of a classification algorithm. Classification accuracy alone can be misleading if you have an unequal number of observations in each class or if you have more than two classes in your dataset. Calculating a confusion matrix can give you a better idea of what your classification model is getting right and what types of errors it is making.","d388d2cc":"**Report for the Third Patient**","0077d67d":"> In the above Box plot between Target and tresbps wrt Gender, shows that Women have higher tresbps than men in case of not suffering from any heart diseases, whereas men and women have almost equal tresbps in case of suffering from a heart diseases. Also, In case of suffering from heart diseases, patients have a slightly lower tresbps in comparison to the patients who are not suffering from heart diseases.","9aa615c5":"### Data description\n\nage: The person's age in years\n\n\nsex: The person's sex (1 = male, 0 = female)\n\n\ncp: The chest pain experienced (Value 1: typical angina, Value 2: atypical angina, Value 3: non-anginal pain, Value 4: asymptomatic)\n\n\ntrestbps: The person's resting blood pressure (mm Hg on admission to the hospital)\n\n\nchol: The person's cholesterol measurement in mg\/dl\n\n\nfbs: The person's fasting blood sugar (> 120 mg\/dl, 1 = true; 0 = false)\n\n\nrestecg: Resting electrocardiographic measurement (0 = normal, 1 = having ST-T wave abnormality, 2 = showing probable or definite left ventricular hypertrophy by Estes' criteria)\n\n\nthalach: The person's maximum heart rate achieved\n\n\nexang: Exercise induced angina (1 = yes; 0 = no)\n\n\noldpeak: ST depression induced by exercise relative to rest ('ST' relates to positions on the ECG plot. See more here)\n\n\nslope: the slope of the peak exercise ST segment (Value 1: upsloping, Value 2: flat, Value 3: downsloping)\n\n\nca: The number of major vessels (0-3)\n\n\nthal: A blood disorder called thalassemia (3 = normal; 6 = fixed defect; 7 = reversable defect)\n\n\ntarget: Heart disease (0 = no, 1 = yes)\n","2806022b":"> The above plot between cholestrol levels and target suggests that the Patients likely to suffer from heart diseases are having higher cholestrol levels in comparison to the patients with target 0(likely to not suffer from the heart diseases.","d6defeb9":"> tresbps: Resting Blood Pressure \n>> The above plot suggests that the patients who are most likely to not suffer from the disease have a slighly greater blood pressure than the patients who have heart diseases.","ca0dcb12":"### Model Explanation","e8ee27ee":"Diagnostic tests are often sold, marketed, cited and used with sensitivity and specificity as the headline metrics. \n- Sensitivity = TruePositives\/TruePositives+FalseNegatives\n- Specificity = FalseNegatives\/FalseNegatives+TruePositives","319473f0":"> The column bar chart represents target vs ECG Measurements(Electro Cardio Gram)\n>> We can observe that  the mahority of patients not likely to suffer from heart diseases are having restscg value 0 whereas those having restecg value 1 are more likelihood to suffer from a heart disease.","fba3586a":"**Partial Dependence Plot for Top 5 Features**","0ee34b24":"> The above Pie chart, whhich shows us the distribution of Gender in this study. Males are almost two times more likely to suffer from heart diseases in comparison to females: 68% of the patients are men whereas only 32% are women.","95828904":"Random forests or random decision forests are an ensemble learning method for classification, regression and other tasks that operates by constructing a multitude of decision trees at training time and outputting the class that is the mode of the classes (classification) or mean prediction (regression) of the individual trees. Random decision forests correct for decision trees' habit of overfitting to their training set.","966533b8":"**Force Plot**","5b59cfa1":"> From the above Swarm plot, it is not possible to find any clue or pattern between age and ddisease development, so age is not a very good attribute to determine the heart disease of a patient as a patient of heart diseases range from 30-70, whereas it is not important that all of the people lying in that same age group are bound to suffer from the heart diseases.","50efdce5":"**Shap Values**","bb938037":">In the above Boxen plot between Target and a Blood disorder called Thalessemia, It can be inferred that the patients suffering from heart diseases have low chances of also suffering from thalessemia in comparison to the patients who are less likely to suffer from the heart diseases. Hence, it is also a good feature to classify heart diseases.","33f58570":"### Heart Diseases Analysis\n\nNote: this notebook was forked from [Roshan Sharma](http:\/\/https:\/\/www.kaggle.com\/roshansharma\/heart-diseases-analysis\/notebook) and new analisys were added from it!","58ae8f1b":"## Data Visualizations","17d2c0ce":"**Report for the First Patient**","a925a14d":"**Eli5 Values**","e2df2334":"### Modelling: Random Forest Classifier","6b5bc1b4":"**Report for the Second Patient**","f0a3900d":"> The above heat map shows the correlations amongst the different attributes of the given dataset. Almost all of the features\/attributes are lower correlated with each other. This implies we must include all of the features, as we can only eliminate those features where the correlation of two or more features are very high."}}