{"cell_type":{"dead2d4f":"code","bf2d67cf":"code","31084fe7":"code","3ba672cb":"code","dea8340c":"code","4bf575da":"code","03990c19":"code","3a0acf0a":"code","b70fe7f6":"code","62a131b6":"code","5c9d6cbd":"code","78810975":"code","8e6521e9":"code","4c84b380":"code","a284359f":"code","e4ad6992":"code","7b6cff55":"code","78845edf":"code","ec58d8a6":"code","a0b69f90":"code","c2ddc06c":"code","23d96fe8":"code","24aec82f":"code","c66f126b":"code","c8bab664":"code","aef9ccbd":"code","512bb192":"code","321b748c":"markdown","acebdc6d":"markdown","d48ef974":"markdown","a8805e22":"markdown","f79ad937":"markdown","2086a8cc":"markdown","1cc214ed":"markdown","4140e27b":"markdown","096aa907":"markdown","77164d01":"markdown","8dffb161":"markdown","61df3d86":"markdown","bcb3c064":"markdown","515160f1":"markdown","a8ed944d":"markdown","dd997238":"markdown"},"source":{"dead2d4f":"from numpy.random import seed\nseed(101)\nfrom tensorflow import set_random_seed\nset_random_seed(101)\n\nimport pandas as pd\nimport numpy as np\nimport pydicom\nimport pylab\nimport os\nimport pickle\n\nimport matplotlib.pyplot as plt\n%matplotlib inline\n\n# Don't Show Warning Messages\nimport warnings\nwarnings.filterwarnings('ignore')\n","bf2d67cf":"df_train = pd.read_csv('..\/input\/stage_1_train_labels.csv')\ndf_test = pd.read_csv('..\/input\/stage_1_sample_submission.csv')\ndf_info = pd.read_csv('..\/input\/stage_1_detailed_class_info.csv')\n\nprint(df_train.shape)\nprint(df_test.shape)\nprint(df_info.shape)\n","31084fe7":"# check df_info for missing values\ndf_info.isnull().sum()","3ba672cb":"# New Col: num_bounding_boxes\ndf_train['num_bounding_boxes'] = 1","dea8340c":"# create a dataframe with unique patientId's\ndf_group = \\\ndf_train.drop(['x','y','width','height','Target'], axis=1).groupby('patientId').sum()\n\n# reset the index\ndf_group.reset_index(inplace=True)\n\ndf_group.head()","4bf575da":"# check\nprint(df_train['patientId'].nunique())\nprint(len(df_group))","03990c19":"# create new columns\ndf_group['PatientAge'] = 0\ndf_group['PatientSex'] = 0\ndf_group['ViewPosition'] = 0","3a0acf0a":"# extract the meta data and store in df_group\n\nfor i in range(0,len(df_group)):\n    patientId = df_group.loc[i,'patientId']\n    \n    path = \\\n'..\/input\/stage_1_train_images\/%s.dcm' % patientId\n    \n    # get the meta data\n    dcm_data = pydicom.read_file(path)\n    \n    df_group.loc[i,'PatientAge'] = dcm_data.PatientAge\n    df_group.loc[i,'PatientSex'] = dcm_data.PatientSex\n    df_group.loc[i,'ViewPosition'] = dcm_data.ViewPosition\n    ","b70fe7f6":"# create new columns\ndf_test['PatientAge'] = 0\ndf_test['PatientSex'] = 0\ndf_test['ViewPosition'] = 0\n\nfor i in range(0,len(df_test)):\n    patientId = df_test.loc[i,'patientId']\n    \n    path = \\\n'..\/input\/stage_1_test_images\/%s.dcm' % patientId\n    \n    # get the meta data\n    dcm_data = pydicom.read_file(path)\n    \n    df_test.loc[i,'PatientAge'] = dcm_data.PatientAge\n    df_test.loc[i,'PatientSex'] = dcm_data.PatientSex\n    df_test.loc[i,'ViewPosition'] = dcm_data.ViewPosition\n    ","62a131b6":"# change the datatype to int16. now it is string\ndf_group['PatientAge'] = df_group['PatientAge'].astype(np.int16)\ndf_test['PatientAge'] = df_test['PatientAge'].astype(np.int16)","5c9d6cbd":"df = df_info\n\ndf.drop_duplicates(inplace=True)\n\n# reset the index or NaN's will be produced when trying to add the class col to df_group\ndf.reset_index(inplace=True)\n\ndf_group['class'] = df['class']","78810975":"# check for age errors in the train set\ndf_group[df_group['PatientAge'] > 100]\n\n# 5 age errors found","8e6521e9":"# check for age errors in the test set\ndf_test[df_test['PatientAge'] > 100]\n\n# no age errors found","4c84b380":"# view the x-rays\n# load a patient's file\npatientId = df_train.loc[24537,'patientId']\npath = \\\n'..\/input\/stage_1_train_images\/%s.dcm' % patientId\n\ndcm_data = pydicom.read_file(path)\n\n# convert the image to a numpy array\nim = dcm_data.pixel_array\n\n# view an image\npylab.imshow(im, cmap=pylab.cm.gist_gray)\npylab.axis('off')","a284359f":"# remove the 1 at the start of the age\n# assumes 1 was added by mistake to these ages\nage_errors = ['3b8b8777-a1f6-4384-872a-28b95f59bf0d', '73aeea88-fc48-4030-8564-0a9d7fdecac4',\n             'a4e8e96d-93a6-4251-b617-91382e610fab', 'ec3697bd-184e-44ba-9688-ff8d5fbf9bbc',\n             'f632328d-5819-4b29-b54f-adf4934bbee6']\n\ndf_group.loc[3175, 'PatientAge'] = 48\ndf_group.loc[9708, 'PatientAge'] = 51\ndf_group.loc[15273, 'PatientAge'] = 53\ndf_group.loc[23374, 'PatientAge'] = 50\ndf_group.loc[24537, 'PatientAge'] = 55","e4ad6992":"# check the changes\ndf_group.loc[23374,:]","7b6cff55":"df_group['noopacity_but_not_normal'] = df_group['class']\n\ndef noopacity_but_not_normal(x):\n    if x == 'No Lung Opacity \/ Not Normal':\n        return 1\n    else:\n        return 0\n\ndf_group['noopacity_but_not_normal'] = \\\ndf_group['noopacity_but_not_normal'].apply(noopacity_but_not_normal)","78845edf":"# New Col: target\ndf_group['target'] = \\\ndf_group['class'].map({'Lung Opacity':1, 'Normal':0, 'No Lung Opacity \/ Not Normal':0})","ec58d8a6":"for i in range(0,len(df_group)):\n    if df_group.loc[i,'target'] == 0:\n        df_group.loc[i,'num_bounding_boxes'] = 0","a0b69f90":"# Source: https:\/\/www.kaggle.com\/peterchang77\/exploratory-data-analysis\n\ndef parse_data(df):\n    \"\"\"\n    Method to read a CSV file (Pandas dataframe) and parse the \n    data into the following nested dictionary:\n\n      parsed = {\n        \n        'patientId-00': {\n            'dicom': path\/to\/dicom\/file,\n            'label': either 0 or 1 for normal or pnuemonia, \n            'boxes': list of box(es)\n        },\n        'patientId-01': {\n            'dicom': path\/to\/dicom\/file,\n            'label': either 0 or 1 for normal or pnuemonia, \n            'boxes': list of box(es)\n        }, ...\n\n      }\n\n    \"\"\"\n    # --- Define lambda to extract coords in list [y, x, height, width]\n    extract_box = lambda row: [row['y'], row['x'], row['height'], row['width']]\n\n    parsed = {}\n    for n, row in df.iterrows():\n        # --- Initialize patient entry into parsed \n        pid = row['patientId']\n        if pid not in parsed:\n            parsed[pid] = {\n                'dicom': '..\/input\/stage_1_train_images\/%s.dcm' % pid,\n                'label': row['Target'],\n                'boxes': []}\n\n        # --- Add box if opacity is present\n        if parsed[pid]['label'] == 1:\n            parsed[pid]['boxes'].append(extract_box(row))\n\n    return parsed\n\n\n# run the function\n\ndf_boxes = pd.read_csv('..\/input\/stage_1_train_labels.csv')\n\nparsed = parse_data(df_boxes)","c2ddc06c":"# check the bounding boxes for one patientId\nbox = parsed['00436515-870c-4b36-a041-de91049b9ab4']['boxes']\n\nbox","23d96fe8":"# extract the boxes for each patient\n\ndf_group['bounding_boxes'] = df_group['patientId']\n\ndef bounding_boxes(x):\n    # get the dictionary value\n    box = parsed[x]['boxes']\n    \n    return box\n\ndf_group['bounding_boxes'] = df_group['bounding_boxes'].apply(bounding_boxes)","24aec82f":"# drop the PredictionString col from df_test\ndf_test = df_test.drop('PredictionString', axis=1)","c66f126b":"df_group.isnull().sum()        ","c8bab664":"df_test.isnull().sum()","aef9ccbd":"# note: we are saving df_group with the name dftrain for easy reference later\npickle.dump(df_group,open('dftrain.pickle','wb'))\npickle.dump(df_test,open('dftest.pickle','wb'))","512bb192":"# check if the pickled files exist\n!ls","321b748c":"**Quick Note**\n\nThe purpose of this notebook is simply to create the tabular data that will be used in Part 2. At the end of this notebook the dataframes are saved as pickled files. For the details of how the Generators were built and how the Keras cnn was set up please go straight to Part 2.\n\nHowever, you will find this notebook useful if you would like to know how to extract meta data from the image files or see how to find and fix patient age errors.","acebdc6d":"<hr>\n**Continued in Part 2...**","d48ef974":"### TAIL CHECKS","a8805e22":"### Create the train set bounding boxes","f79ad937":"### Fix errors in the age feature","2086a8cc":"<hr>","1cc214ed":"### Save the dataframes","4140e27b":"### Create new columns using df_info","096aa907":"### Extract the meta data from the images","77164d01":"### If no pneumonia set num_bounding_boxes to 0","8dffb161":"### Add a col to df_group for noopacity_but_not_normal","61df3d86":"### Extract meta data from the test images and store in df_test","bcb3c064":"The images all look like adults. Therefore, it could be that 1 was added by mistake to the beginning of the age. ","515160f1":"### Add the class column to df_group","a8ed944d":"Make sure that NaN's have not been introduced during pre processing.","dd997238":"### Map the 3 class labels to 0 and 1"}}