{"cell_type":{"fe0cc589":"code","732fac2d":"code","f9d3b875":"code","a4a8341d":"code","9d644fd1":"code","9c99fbe9":"code","fc73761e":"code","b0e2b640":"code","df210864":"code","b285d696":"code","bf0391e5":"code","fdd1d02a":"code","c193f90a":"code","0f789b06":"code","3d726fa0":"code","52ac8207":"code","c7c04f2d":"code","4e24d361":"code","21f6dbb5":"code","0aea1654":"code","627a42be":"code","c5594f8a":"code","6c260dab":"code","f0c44620":"code","2cb42bf2":"code","b351616a":"code","7646d2e8":"code","3d6302be":"code","3e2d26d7":"code","3a73b469":"code","9e389468":"code","61fe4ab2":"code","480bbf40":"code","f9288255":"code","5074af6d":"code","df79d1ae":"markdown","0846a82a":"markdown"},"source":{"fe0cc589":"import numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\nimport pandas as pd\nimport numpy as np\nimport csv\nimport matplotlib.pyplot as plt\n%matplotlib inline\nfrom pandas.plotting import scatter_matrix\nfrom sklearn.metrics import mean_squared_error\nimport seaborn as sns; sns.set()\nfrom sklearn.model_selection import train_test_split\nfrom sklearn.externals.six import StringIO  \nfrom sklearn.ensemble import RandomForestRegressor\nimport xgboost as xgb\nfrom xgboost import XGBRegressor\nfrom sklearn.feature_selection import RFECV\nfrom sklearn.metrics import mean_squared_error as mse\n%matplotlib inline \nfrom sklearn.model_selection import GridSearchCV\nfrom sklearn.metrics import explained_variance_score,r2_score\n# Input data files are available in the \"..\/input\/\" directory.\n# For example, running this (by clicking run or pressing Shift+Enter) will list the files in the input directory\nfrom sklearn.feature_selection import RFECV\nimport os\nfrom tqdm import tqdm\nfrom skopt import BayesSearchCV\nfrom sklearn.model_selection import StratifiedKFold\nprint(os.listdir(\"..\/input\"))\nprint(os.listdir(\"..\/input\/malware\"))\n\n# Any results you write to the current directory are saved as output.","732fac2d":"dtypes = {\n        'MachineIdentifier':                                    'category',\n        'ProductName':                                          'category',\n        'EngineVersion':                                        'category',\n        'AppVersion':                                           'category',\n        'AvSigVersion':                                         'category',\n        'IsBeta':                                               'int8',\n        'RtpStateBitfield':                                     'float16',\n        'IsSxsPassiveMode':                                     'int8',\n        'DefaultBrowsersIdentifier':                            'float32',\n        'AVProductStatesIdentifier':                            'float32',\n        'AVProductsInstalled':                                  'float16',\n        'AVProductsEnabled':                                    'float16',\n        'HasTpm':                                               'int8',\n        'CountryIdentifier':                                    'int16',\n        'CityIdentifier':                                       'float32',\n        'OrganizationIdentifier':                               'float16',\n        'GeoNameIdentifier':                                    'float16',\n        'LocaleEnglishNameIdentifier':                          'int16',\n        'Platform':                                             'category',\n        'Processor':                                            'category',\n        'OsVer':                                                'category',\n        'OsBuild':                                              'int16',\n        'OsSuite':                                              'int16',\n        'OsPlatformSubRelease':                                 'category',\n        'OsBuildLab':                                           'category',\n        'SkuEdition':                                           'category',\n        'IsProtected':                                          'float16',\n        'AutoSampleOptIn':                                      'int8',\n        'PuaMode':                                              'category',\n        'SMode':                                                'float16',\n        'IeVerIdentifier':                                      'float16',\n        'SmartScreen':                                          'category',\n        'Firewall':                                             'float16',\n        'UacLuaenable':                                         'float32',\n        'UacLuaenable':                                         'float64', # was 'float32'\n        'Census_MDC2FormFactor':                                'category',\n        'Census_DeviceFamily':                                  'category',\n        'Census_OEMNameIdentifier':                             'float32', # was 'float16'\n        'Census_OEMModelIdentifier':                            'float32',\n        'Census_ProcessorCoreCount':                            'float16',\n        'Census_ProcessorManufacturerIdentifier':               'float16',\n        'Census_ProcessorModelIdentifier':                      'float32', # was 'float16'\n        'Census_ProcessorClass':                                'category',\n        'Census_PrimaryDiskTotalCapacity':                      'float64', # was 'float32'\n        'Census_PrimaryDiskTypeName':                           'category',\n        'Census_SystemVolumeTotalCapacity':                     'float64', # was 'float32'\n        'Census_HasOpticalDiskDrive':                           'int8',\n        'Census_TotalPhysicalRAM':                              'float32',\n        'Census_ChassisTypeName':                               'category',\n        'Census_InternalPrimaryDiagonalDisplaySizeInInches':    'float32', # was 'float16'\n        'Census_InternalPrimaryDisplayResolutionHorizontal':    'float32', # was 'float16'\n        'Census_InternalPrimaryDisplayResolutionVertical':      'float32', # was 'float16'\n        'Census_PowerPlatformRoleName':                         'category',\n        'Census_InternalBatteryType':                           'category',\n        'Census_InternalBatteryNumberOfCharges':                'float64', # was 'float32'\n        'Census_OSVersion':                                     'category',\n        'Census_OSArchitecture':                                'category',\n        'Census_OSBranch':                                      'category',\n        'Census_OSBuildNumber':                                 'int16',\n        'Census_OSBuildRevision':                               'int32',\n        'Census_OSEdition':                                     'category',\n        'Census_OSSkuName':                                     'category',\n        'Census_OSInstallTypeName':                             'category',\n        'Census_OSInstallLanguageIdentifier':                   'float16',\n        'Census_OSUILocaleIdentifier':                          'int16',\n        'Census_OSWUAutoUpdateOptionsName':                     'category',\n        'Census_IsPortableOperatingSystem':                     'int8',\n        'Census_GenuineStateName':                              'category',\n        'Census_ActivationChannel':                             'category',\n        'Census_IsFlightingInternal':                           'float16',\n        'Census_IsFlightsDisabled':                             'float16',\n        'Census_FlightRing':                                    'category',\n        'Census_ThresholdOptIn':                                'float16',\n        'Census_FirmwareManufacturerIdentifier':                'float16',\n        'Census_FirmwareVersionIdentifier':                     'float32',\n        'Census_IsSecureBootEnabled':                           'int8',\n        'Census_IsWIMBootEnabled':                              'float16',\n        'Census_IsVirtualDevice':                               'float16',\n        'Census_IsTouchEnabled':                                'int8',\n        'Census_IsPenCapable':                                  'int8',\n        'Census_IsAlwaysOnAlwaysConnectedCapable':              'float16',\n        'Wdft_IsGamer':                                         'float16',\n        'Wdft_RegionIdentifier':                                'float16',\n        'HasDetections':                                        'int8'\n        }","f9d3b875":"def reduce_mem_usage(df, verbose=True):\n    numerics = ['int16', 'int32', 'int64', 'float16', 'float32', 'float64']\n    start_mem = df.memory_usage().sum() \/ 1024**2    \n    for col in tqdm(df.columns):\n        col_type = df[col].dtypes\n        if col_type in numerics:\n            c_min = df[col].min()\n            c_max = df[col].max()\n            if str(col_type)[:3] == 'int':\n                if c_min > np.iinfo(np.int8).min and c_max < np.iinfo(np.int8).max:\n                    df[col] = df[col].astype(np.int8)\n                elif c_min > np.iinfo(np.int16).min and c_max < np.iinfo(np.int16).max:\n                    df[col] = df[col].astype(np.int16)\n                elif c_min > np.iinfo(np.int32).min and c_max < np.iinfo(np.int32).max:\n                    df[col] = df[col].astype(np.int32)\n                elif c_min > np.iinfo(np.int64).min and c_max < np.iinfo(np.int64).max:\n                    df[col] = df[col].astype(np.int64)  \n            else:\n                if c_min > np.finfo(np.float16).min and c_max < np.finfo(np.float16).max:\n                    df[col] = df[col].astype(np.float16)\n                elif c_min > np.finfo(np.float32).min and c_max < np.finfo(np.float32).max:\n                    df[col] = df[col].astype(np.float32)\n                else:\n                    df[col] = df[col].astype(np.float64)    \n    end_mem = df.memory_usage().sum() \/ 1024**2\n    if verbose: print('Mem. usage decreased to {:5.2f} Mb ({:.1f}% reduction)'.format(end_mem, 100 * (start_mem - end_mem) \/ start_mem))\n    return df","a4a8341d":"numerics = ['int8', 'int16', 'int32', 'int64', 'float16', 'float32', 'float64']\nnumerical_columns = [c for c,v in dtypes.items() if v in numerics]\ncategorical_columns = [c for c,v in dtypes.items() if v not in numerics]\ncategorical_columns.remove('MachineIdentifier')\n# categorical_columns","9d644fd1":"train = pd.read_csv(r'..\/input\/malware\/sampled_1pc.csv',dtype=dtypes,low_memory=True)  \nprint(train.head())\ntrain=reduce_mem_usage(train)","9c99fbe9":"print(train['AvSigVersion'].unique())\nprint(type(train['AvSigVersion']))\ntrain['version']=train['AvSigVersion'].str.split('.')\n#train['version']=train['AvSigVersion'].apply(lambda x: x.split('.'))\ntrain['version']=[item[0]+(item[1]) for item in train['version']]\ntrain['version']=train['version'].astype(int)\ntrain.groupby('version').sum()\n","fc73761e":"test = pd.read_csv(r'..\/input\/Microsoft Malware Prediction\/test.csv',dtype=dtypes,low_memory=True)\ntest=reduce_mem_usage(test)","b0e2b640":"print(test['AvSigVersion'].unique())\nprint(type(test['AvSigVersion']))\ntest['version']=test['AvSigVersion'].str.split('.')\ntest['version']=[item[0]+(item[1]) for item in test['version']]\ntest['version']=test['version'].astype(int)\ntest.groupby('version').sum()","df210864":"# train.drop('AvSigVersion',axis=1,inplace=True)\n# test.drop('AvSigVersion',axis=1,inplace=True)","b285d696":"def get_percentage_missing(series):\n    \"\"\" Calculates percentage of NaN values in DataFrame\n    :param series: Pandas DataFrame object\n    :return: float\n    \"\"\"\n    num = series.isnull().sum()\n    den = len(series)\n    return round(num\/den, 2)\n\n# Only include columns that contain any NaN values\ndf_with_any_null_values = train[train.columns[train.isnull().any()].tolist()]\ndata =get_percentage_missing(df_with_any_null_values)\nfilter_df=data[data>0.5]\nprint(train.shape)\nremove_cols=[]\nfor n,v in filter_df.iteritems():\n    remove_cols.append(n)\nremove_cols.append('AvSigVersion')","bf0391e5":"#Lets start by plotting a heatmap to determine if any variables are correlated\nplt.figure(figsize = (12,8))\nsns.heatmap(data=train[numerical_columns].corr())\nplt.show()\nplt.gcf().clear()\n","fdd1d02a":"# Create correlation matrix\ncorr_matrix = train[numerical_columns].corr().abs()\n# Select upper triangle of correlation matrix\nupper = corr_matrix.where(np.triu(np.ones(corr_matrix.shape), k=1).astype(np.bool))\n# Find index of feature columns with correlation greater than 0.90\nto_drop = [column for column in upper.columns if any(upper[column] > 0.90)]\nfor each in to_drop:\n    remove_cols.append(each)\nremove_cols","c193f90a":"# train.drop('EngineVersion',axis=1,inplace=True)\n# train.drop('AppVersion',axis=1,inplace=True)\n# train.drop('AvSigVersion',axis=1,inplace=True)\n# train.drop('OsVer',axis=1,inplace=True)\n# train.drop('MachineIdentifier',axis=1,inplace=True)\n# train.drop('Census_OSVersion',axis=1,inplace=True)\ntrain.drop(remove_cols,axis=1,inplace=True)\n#train.drop('MachineIdentifier',axis=1,inplace=True)\n# #train.dropna(axis=0,how='any')\ntrain.replace(np.nan,0,inplace=True)\ncategorical_columns=list(set(categorical_columns)-set(remove_cols))","0f789b06":"categorical_columns","3d726fa0":"def encode_categorical_columns(x_train, x_test, columns, sort=True):\n    train_length = x_train.shape[0]\n    for col in tqdm(columns):\n        if col == 'MachineIdentifier' or col == 'HasDetections':\n            continue\n            \n        combined_data = pd.concat([x_train[col], x_test[col]])\n        combined_data, _ = pd.factorize(combined_data, sort=sort)\n        combined_data = pd.Series(combined_data).astype('int32')\n        x_train[col] = combined_data.iloc[:train_length].values\n        x_test[col] = combined_data.iloc[train_length:].values\n        x_train[col] = x_train[col].fillna(0)\n        x_test[col] = x_test[col].fillna(0)\n        del combined_data\n        \n    return x_train, x_test\ntest.drop(remove_cols,axis=1,inplace=True)\ntest.replace(np.nan,0,inplace=True)\n#test.drop('MachineIdentifier',axis=1,inplace=True)\ntrain, test = encode_categorical_columns(train, test, categorical_columns)","52ac8207":"train.drop('MachineIdentifier',axis=1,inplace=True)\nx=train.loc[:,train.columns != 'HasDetections']\ny=train.loc[:,train.columns == 'HasDetections']\nx.head(),y.head()","c7c04f2d":"test_final=test['MachineIdentifier'].copy()\n#train.drop('MachineIdentifier',axis=1,inplace=True)\ntest.drop('MachineIdentifier',axis=1,inplace=True)","4e24d361":"rf=RandomForestRegressor(random_state=23,verbose=0, warm_start=True,n_jobs=-1,n_estimators=600)\nrf.fit(x, y)\nimp=pd.DataFrame({'label':x.columns,'imp':rf.feature_importances_})\nfeature_select=imp[imp['imp']>0.01]['label']\nfeature_select","21f6dbb5":"zero_features = list(imp[imp['imp'] == 0.000]['label'])\nprint('There are %d features with 0.0 importance' % len(zero_features))\nprint(zero_features)\nimp.tail()","0aea1654":"# new_features=feature_select\n# test_columns=['SmartScreen','EngineVersion']\n# test.replace(np.nan,0,inplace=True)\n# test_final=test['MachineIdentifier'].copy()","627a42be":"test=test[feature_select]\ny_train = train[train['version'].astype(int) < 1275 ]['HasDetections']\ny_test = train[train['version'].astype(int) >= 1275 ]['HasDetections']\n\ntrain=train[feature_select]\nx_train = train[train['version'].astype(int) < 1275 ]\nx_test = train[train['version'].astype(int) >= 1275 ]\n\nx_train.head(),y_test.head(),x_test.head()\n","c5594f8a":"param_test1 = {\n 'max_depth':range(3,10,2),\n 'min_child_weight':range(1,6,2),\n 'n_estimators':[140,280,560,1020]\n}\ngsearch1 = GridSearchCV(estimator = XGBRegressor(learning_rate =0.1,max_depth=5,\n min_child_weight=1, gamma=0, subsample=0.8, colsample_bytree=0.8,tree_method='gpu_hist',\n objective= 'binary:logistic', scale_pos_weight=1, seed=27), \n param_grid = param_test1, scoring='roc_auc',n_jobs=-1,iid=False, cv=5)\ngsearch1.fit(x_train,y_train)\n# Set the clf to the best combination of parameters\noptimal=gsearch1.best_estimator_\nprint(gsearch1.best_estimator_)\ngsearch1.best_params_,gsearch1.best_score_","6c260dab":"param_test2 = {\n'gamma':[i\/10.0 for i in range(0,5)]\n}\ngsearch2 = GridSearchCV(estimator = gsearch1.best_estimator_,\nparam_grid = param_test2, scoring='roc_auc',n_jobs=-1,iid=False, cv=5)\ngsearch2.fit(x_train,y_train)\nprint(gsearch2.best_estimator_)\ngsearch2.best_params_, gsearch2.best_score_","f0c44620":"#score improved from 0.598 to 0.600\nparam_test3 = {\n 'subsample':[i\/10.0 for i in range(6,10)],\n 'colsample_bytree':[i\/10.0 for i in range(6,10)]\n}\ngsearch3 = GridSearchCV(estimator = gsearch2.best_estimator_,\nparam_grid = param_test3, scoring='roc_auc',n_jobs=-1,iid=False, cv=5)\ngsearch3.fit(x_train,y_train)\nprint(gsearch3.best_estimator_)\ngsearch3.best_params_, gsearch3.best_score_","2cb42bf2":"#subsample and colsample both comes as 0.8. Let try with 0.05 diff\nparam_test4 = {\n 'subsample':[i\/100.0 for i in range(75,90,5)],\n 'colsample_bytree':[i\/100.0 for i in range(75,90,5)]\n}\ngsearch4 = GridSearchCV(estimator = gsearch3.best_estimator_,\nparam_grid = param_test4, scoring='roc_auc',n_jobs=-1,iid=False, cv=5)\ngsearch4.fit(x_train,y_train)\nprint(gsearch4.best_estimator_)\ngsearch4.best_params_, gsearch4.best_score_\n##no diff found, so will use the previous parameter","b351616a":"param_test5 = {\n 'reg_alpha':[1e-5, 1e-2, 0.1,0, 0.001, 0.005, 0.01, 0.05]\n}\ngsearch5 = GridSearchCV(estimator = gsearch3.best_estimator_,\nparam_grid = param_test5, scoring='roc_auc',n_jobs=-1,iid=False, cv=5)\ngsearch5.fit(x_train,y_train)\nprint(gsearch5.best_estimator_)\ngsearch5.best_params_, gsearch5.best_score_","7646d2e8":"xgb_final = gsearch5.best_estimator_\nxgb_final.fit(x_train,y_train)\n","3d6302be":"param_test6 = {\n 'learning_rate':np.linspace(0,1,30)\n}\ngsearch6 = GridSearchCV(estimator = gsearch5.best_estimator_,\nparam_grid = param_test6, scoring='roc_auc',n_jobs=-1,iid=False, cv=5)\ngsearch6.fit(x_train,y_train)\nprint(gsearch6.best_estimator_)\ngsearch6.best_params_, gsearch6.best_score_\n","3e2d26d7":"# xgb_final=XGBRegressor(base_score=0.5, booster='gbtree', colsample_bylevel=1,\n#        colsample_bytree=0.8, gamma=0.0, learning_rate=0.1379,\n#        max_delta_step=0, max_depth=3, min_child_weight=3, missing=None,\n#        n_estimators=1020, n_jobs=-1, scoring = 'roc_auc',\n#        objective='binary:logistic', random_state=0, reg_alpha=0,\n#        reg_lambda=1, scale_pos_weight=1, seed=27, silent=True,\n#        subsample=0.9, tree_method='gpu_hist')","3a73b469":"xgb_final = gsearch6.best_estimator_\n#df_trainC['version']=df_trainC['version'].values.astype(int)\nresult=xgb_final.fit(x_train,y_train)\n#df_trainD['version']=df_trainD['version'].values.astype(int)\npreds=xgb_final.predict(x_test)\nrmse = np.sqrt(mean_squared_error(y_test, preds))\nprint(\"RMSE: %f\" % (rmse))\n# print(test.columns)\n#test['version']=test['version'].values.astype(int)\n\nypred_final=xgb_final.predict(test) \n# print(ypred_final.shape)\n# print(test_final.shape)\noutput_xgb=pd.DataFrame({'MachineIdentifier':test_final,'HasDetections':ypred_final})\noutput_xgb.to_csv(r'second_file.csv',index=False)","9e389468":"ITERATIONS = 4\nbayes_cv_tuner = BayesSearchCV(\n    estimator = xgb.XGBRegressor(\n        n_jobs = -1,\n        tree_method='gpu_hist',\n        objective = 'binary:logistic',\n        eval_metric = 'auc',\n        silent=1,\n        #n_estimators=1020\n    ),\n    search_spaces = {\n        'learning_rate': (0.01, 1.0, 'log-uniform'),\n        'min_child_weight': (0, 10),\n        'max_depth': (0, 50),\n        'max_delta_step': (0, 20),\n        'subsample': (0.01, 1.0, 'uniform'),\n        'colsample_bytree': (0.01, 1.0, 'uniform'),\n        'colsample_bylevel': (0.01, 1.0, 'uniform'),\n        'reg_lambda': (1e-9, 1000, 'log-uniform'),\n        'reg_alpha': (1e-9, 1.0, 'log-uniform'),\n        'gamma': (1e-9, 0.5, 'log-uniform'),\n        'min_child_weight': (0, 5),\n        'n_estimators': [600,1020,1500],\n        'scale_pos_weight': (1e-6, 500, 'log-uniform')\n    },    \n    scoring = 'roc_auc',\n    cv = StratifiedKFold(\n        n_splits=3,\n        shuffle=True,\n        random_state=42\n    ),\n    n_jobs = -1,\n    n_iter = ITERATIONS,   \n    verbose = 0,\n    refit = True,\n    random_state = 42\n)\n\ndef status_print(optim_result):\n    \"\"\"Status callback durring bayesian hyperparameter search\"\"\"\n    \n    # Get all the models tested so far in DataFrame format\n    all_models = pd.DataFrame(bayes_cv_tuner.cv_results_)    \n    \n    # Get current parameters and the best parameters    \n    best_params = pd.Series(bayes_cv_tuner.best_params_)\n    print('Model #{}\\nBest ROC-AUC: {}\\nBest params: {}\\n'.format(\n        len(all_models),\n        np.round(bayes_cv_tuner.best_score_, 4),\n        bayes_cv_tuner.best_params_\n    ))\n    \n    # Save all model results\n    clf_name = bayes_cv_tuner.estimator.__class__.__name__\n","61fe4ab2":"bayes_cv_tuner.fit(x_train,y_train, callback=status_print)\n#bayes_cv_tuner.fit(df_trainC.loc[:,df_trainC.columns != ['HasDetections']], df_trainC['HasDetections'], callback=status_print)","480bbf40":"xgb_cv=XGBRegressor(colsample_bylevel= bayes_cv_tuner.best_params_['colsample_bylevel'],\n                    colsample_bytree= bayes_cv_tuner.best_params_['colsample_bytree'], \n                    gamma= bayes_cv_tuner.best_params_['gamma'],\n                    learning_rate= bayes_cv_tuner.best_params_['learning_rate'], \n                    max_delta_step= bayes_cv_tuner.best_params_['max_delta_step'],\n                    max_depth= bayes_cv_tuner.best_params_['max_depth'],\n                    min_child_weight= bayes_cv_tuner.best_params_['max_depth'], \n                    reg_alpha= bayes_cv_tuner.best_params_['reg_alpha'], \n                    reg_lambda= bayes_cv_tuner.best_params_['reg_lambda'], \n                    scale_pos_weight= bayes_cv_tuner.best_params_['scale_pos_weight'],\n                    subsample= bayes_cv_tuner.best_params_['subsample'],\n                   tree_method='gpu_hist')\nxgb_cv.fit(x_train,y_train)","f9288255":"preds=xgb_cv.predict(x_test)\nrmse = np.sqrt(mean_squared_error(y_test, preds))\nprint(\"RMSE: %f\" % (rmse))","5074af6d":"y_test = xgb_cv.predict(test)\noutput_xgb=pd.DataFrame({'MachineIdentifier':test_final,'HasDetections':y_test})\noutput_xgb.to_csv(r'first_file.csv',index=False)","df79d1ae":"### RFE implementation for xgboost","0846a82a":"del train"}}