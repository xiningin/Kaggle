{"cell_type":{"35111771":"code","f7b9a5ca":"code","37287c57":"code","1bf88155":"code","2f18341e":"code","712ee1c2":"code","d81d279b":"code","741fb1bd":"code","318e5477":"code","025bd40c":"code","66cd302a":"code","1e747983":"markdown"},"source":{"35111771":"import numpy as np \nimport pandas as pd \nimport json\nimport bq_helper\nfrom pandas.io.json import json_normalize\nimport seaborn as sns \nimport lightgbm as lgb\nfrom sklearn.preprocessing import LabelEncoder\nfrom sklearn.model_selection import TimeSeriesSplit, KFold,GroupKFold\nfrom sklearn.metrics import mean_squared_error\nimport functools\nfrom multiprocessing import Pool\nimport logging\nimport gc\nimport logging\nimport matplotlib.pyplot as plt\nimport time\nfrom line_profiler import LineProfiler\nfrom sklearn.metrics import mean_squared_error\nfrom scipy.stats import stats\nimport os\nimport re\nprint(os.listdir(\"..\/input\"))\n","f7b9a5ca":"def line_profiling(func,arg):\n    lp=LineProfiler()\n    lp_wrapper=lp(func)\n    lp_wrapper(arg)\n    lp.print_stats()","37287c57":"def process_date_time(data_df):\n    \n    data_df['date'] = data_df['date'].astype(str)\n    data_df[\"date\"] = data_df[\"date\"].apply(lambda x : x[:4] + \"-\" + x[4:6] + \"-\" + x[6:])\n    data_df[\"date\"] = pd.to_datetime(data_df[\"date\"])   \n    data_df[\"year\"] = data_df['date'].dt.year\n    data_df[\"month\"] = data_df['date'].dt.month\n    data_df[\"day\"] = data_df['date'].dt.day\n    data_df[\"weekday\"] = data_df['date'].dt.weekday\n    data_df['weekofyear'] = data_df['date'].dt.weekofyear\n    data_df['month_unique_user_count'] = data_df.groupby('month')['fullVisitorId'].transform('nunique')\n    data_df['day_unique_user_count'] = data_df.groupby('day')['fullVisitorId'].transform('nunique')\n    data_df['weekday_unique_user_count'] = data_df.groupby('weekday')['fullVisitorId'].transform('nunique')\n    data_df['weekofyear_unique_user_count'] = data_df.groupby('weekofyear')['fullVisitorId'].transform('nunique')\n    return data_df\n","1bf88155":"def process_format(data_df):\n\n    for col in ['visitNumber', 'totals.hits', 'totals.pageviews']:\n        data_df[col] = data_df[col].astype(float)\n    data_df['trafficSource.adwordsClickInfo.isVideoAd'].fillna(True, inplace=True)\n    data_df['trafficSource.isTrueDirect'].fillna(False, inplace=True)\n    \n    return data_df","2f18341e":"def process_totals(data_df):\n    #data_df['visitNumber'] = data_df['visitNumber']\n    data_df['visits_id_sum'] = data_df.groupby(['fullVisitorId'])['visitNumber'].transform('sum')\n    data_df['visits_id_min'] =  data_df.groupby(['fullVisitorId'])['visitNumber'].transform('min')\n    data_df['visits_id_max'] = data_df.groupby(['fullVisitorId'])['visitNumber'].transform('max')\n    data_df['visits_id_mean'] = data_df.groupby(['fullVisitorId'])['visitNumber'].transform('mean')\n    data_df['visits_id_nunique'] = data_df.groupby('visitNumber')['fullVisitorId'].transform('nunique')\n    #data_df['totals_hits'] = data_df['totals_hits']\n    data_df['hits_id_sum'] = data_df.groupby(['fullVisitorId'])['totals.hits'].transform('sum')\n    data_df['hits_id_cnt'] = data_df.groupby(['fullVisitorId'])['totals.hits'].transform('count')\n    data_df['totals.pageviews'] = data_df['totals.pageviews'].fillna(0)\n    data_df['pageviews_id_sum'] = data_df.groupby(['fullVisitorId'])['totals.pageviews'].transform('sum')\n    data_df['pageviews_id_cnt'] = data_df.groupby(['fullVisitorId'])['totals.pageviews'].transform('count')\n    data_df['mean_hits_per_day'] = data_df.groupby(['day'])['totals.hits'].transform('mean')\n    data_df['sum_hits_per_day'] = data_df.groupby(['day'])['totals.hits'].transform('sum')\n    data_df['max_hits_per_day'] = data_df.groupby(['day'])['totals.hits'].transform('max')\n    data_df['min_hits_per_day'] = data_df.groupby(['day'])['totals.hits'].transform('min')\n    data_df['var_hits_per_day'] = data_df.groupby(['day'])['totals.hits'].transform('var')\n    data_df['mean_pageviews_per_day'] = data_df.groupby(['day'])['totals.pageviews'].transform('mean')\n    data_df['sum_pageviews_per_day'] = data_df.groupby(['day'])['totals.pageviews'].transform('sum')\n    data_df['max_pageviews_per_day'] = data_df.groupby(['day'])['totals.pageviews'].transform('max')\n    data_df['min_pageviews_per_day'] = data_df.groupby(['day'])['totals.pageviews'].transform('min')   \n    \n    return data_df\n    \n","712ee1c2":"train_df=pd.read_hdf('..\/input\/load-data-faster-with-hdf\/train_df.h5')\ntest_df=pd.read_hdf('..\/input\/load-data-faster-with-hdf\/test_df.h5')\nprint('train loaded')\nprint('test_loaded')","d81d279b":"line_profiling(process_date_time,train_df)","741fb1bd":"line_profiling(process_format,train_df)","318e5477":"train_df=process_format(train_df)","025bd40c":"train_df=process_totals(train_df)","66cd302a":"line_profiling(process_totals,train_df)","1e747983":"**<p> .transform() is almost 87 of the time in process_date_time function<\/p>**"}}