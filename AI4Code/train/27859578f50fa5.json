{"cell_type":{"6277bcb8":"code","beff0306":"code","67068cab":"code","f29bfc07":"code","f1b40305":"code","1f9aafc2":"code","96a2ecbb":"code","6c4c0534":"code","36656065":"code","961ae7af":"code","d80406c1":"code","978e3c1a":"code","4abac42f":"code","71966217":"code","7026feee":"code","5dc7b1b7":"code","87179d5c":"code","46f6ba8b":"code","64fbd639":"code","95a2c811":"code","2b62ed54":"code","2460bb70":"code","67f8826e":"code","f9d297b6":"code","bab35542":"code","753f510f":"code","cdaa9a63":"code","61af3663":"code","85da0467":"code","ba78cb36":"code","e6c2bf05":"code","f583a3a5":"code","f45fd2f4":"code","57e43711":"code","b382a9a0":"code","52aa6b53":"code","6cae0292":"markdown","ac730127":"markdown","426735e9":"markdown","b6c03087":"markdown","f3a6e303":"markdown","4b94412f":"markdown","d42d7ac2":"markdown","37c0d03d":"markdown","091a900e":"markdown","f8ebfc85":"markdown","33730992":"markdown","82b0872f":"markdown","33bc20be":"markdown","14366efe":"markdown","c41cf3cd":"markdown","6392aca0":"markdown","05481925":"markdown","39fd2ecf":"markdown","7acf1d71":"markdown","e9a3ef6f":"markdown","04170ab8":"markdown","141db8c3":"markdown","266345cd":"markdown","fd37674e":"markdown"},"source":{"6277bcb8":"import pandas as pd\nimport numpy as np\nimport scipy.stats as stats\nimport pymc3 as pm\nimport matplotlib.pyplot as plt\n!pip install arviz\nimport arviz as az","beff0306":"az.style.use('arviz-darkgrid')","67068cab":"import bq_helper\nfrom bq_helper import BigQueryHelper\n# https:\/\/www.kaggle.com\/sohier\/introduction-to-the-bq-helper-package\nchicago_crime = bq_helper.BigQueryHelper(active_project=\"bigquery-public-data\",\n                                   dataset_name=\"chicago_crime\")","f29bfc07":"bq_assistant = BigQueryHelper(\"bigquery-public-data\", \"chicago_crime\")\nbq_assistant.list_tables()","f1b40305":"bq_assistant.head(\"crime\", num_rows=3)","1f9aafc2":"bq_assistant.table_schema(\"crime\")","96a2ecbb":"weather = pd.read_csv(\"..\/input\/historical-hourly-weather-data\/temperature.csv\", \n                      usecols=[\"datetime\", \"Chicago\"], error_bad_lines=False)","6c4c0534":"weather.head()","36656065":"weather.info()","961ae7af":"weather[weather.isna().any(axis = 1)].head(10)","d80406c1":"weather1= weather.dropna()","978e3c1a":"weather1['datetime'].min()","4abac42f":"weather1['datetime'].max()","71966217":"violent = ['ASSAULT','BATTERY','CRIM SEXUAL ASSAULT', 'ROBBERY',\n            'HOMICIDE', 'KIDNAPPING']","7026feee":"query1 = \"\"\"SELECT\n    primary_type,\n    date\nFROM\n    `bigquery-public-data.chicago_crime.crime`\nWHERE\n    arrest = True \n    AND (date > '2012-10-01') AND (date < '2017-11-30')\n    AND primary_type IN ('ASSAULT','BATTERY','CRIM SEXUAL ASSAULT', 'ROBBERY',\n            'HOMICIDE', 'KIDNAPPING')\n\"\"\"\n\nresponse1 = chicago_crime.query_to_pandas_safe(query1)\nresponse1.head(10)","5dc7b1b7":"response1[response1.isna().any(axis=1)]","87179d5c":"response1['datetime'] = pd.to_datetime(response1['date']).dt.tz_localize(None)\nresponse2 = response1.set_index(['datetime'])","46f6ba8b":"response2.head(3)","64fbd639":"response2 = response2.resample('D').count()\nresponse2.head()","95a2c811":"weather1.head(3)","2b62ed54":"weather1['datetime'] = pd.to_datetime(weather1['datetime'])\nweather2 = weather1.set_index(['datetime'])\nweather2 = weather2.resample('D').mean()","2460bb70":"weather2.head(3)","67f8826e":"df = weather2.join(response2, on='datetime')\n\ndf.columns=['Ktemp', 'incidents', 'incidents2']","f9d297b6":"df.head()","bab35542":"df.info()","753f510f":"df=df.dropna()","cdaa9a63":"plt.scatter(df['Ktemp'], df['incidents'])","61af3663":"with pm.Model() as model1: \n    alpha = pm.Normal('alpha',20,10)\n    beta = pm.Normal('beta',0.2,0.1)\n    sigma = pm.Uniform('sigma', 0,10)\n    mu = pm.Deterministic('mu', alpha + beta* df['Ktemp'])\n    pred = pm.Normal('pred', mu,sigma, observed = df['incidents'])\n    trace1 = pm.sample(1000,tune = 1000, cores=2)","85da0467":"az.plot_trace(trace1, var_names =['~mu'])","ba78cb36":"x_points = np.linspace(250,320,100)\nplt.scatter(df['Ktemp'], df['incidents'], alpha = 0.5)\nplt.plot(x_points, trace1['alpha'].mean() + trace1['beta'].mean() * x_points, color = 'red')\nmu_pred = trace1['alpha'] + trace1['beta'] * x_points[:,None]\nprediction = stats.norm.rvs(mu_pred, trace1['sigma'])\naz.plot_hpd(x_points, prediction.T, credible_interval=0.95)","e6c2bf05":"df2 = df[(df.index.month == 12) & (df.index.day.isin([24,25,26,27,28,29,30,31]))]","f583a3a5":"df2.head()","f45fd2f4":"with pm.Model() as model2: \n    alpha = pm.Normal('alpha',20,10)\n    beta = pm.Normal('beta',0.2,0.1)\n    sigma = pm.Uniform('sigma', 0,10)\n    mu = pm.Deterministic('mu', alpha + beta* df2['Ktemp'])\n    pred = pm.Normal('pred', mu,sigma, observed = df2['incidents'])\n    trace2 = pm.sample(1000,tune = 1000, cores=2)","57e43711":"az.plot_trace(trace2, var_names=['~mu'])","b382a9a0":"x_points = np.linspace(250,290,100)\nplt.scatter(df2['Ktemp'], df2['incidents'], alpha = 0.5)\nplt.plot(x_points, trace2['alpha'].mean() + trace2['beta'].mean() * x_points, color = 'red')\nmu_pred = trace2['alpha'] + trace2['beta'] * x_points[:,None]\nprediction = stats.norm.rvs(mu_pred, trace2['sigma'])\naz.plot_hpd(x_points, prediction.T, credible_interval = 0.95)","52aa6b53":"x_points = np.linspace(250,310,100)\nplt.scatter(df['Ktemp'], df['incidents'], alpha = 0.5)\nplt.scatter(df2['Ktemp'], df2['incidents'], alpha = 1, color = 'red')\nplt.plot(x_points, trace1['alpha'].mean() + trace1['beta'].mean() * x_points, color = 'blue')\nmu_pred1 = trace1['alpha'] + trace1['beta'] * x_points[:,None]\nprediction1 = stats.norm.rvs(mu_pred, trace1['sigma'])\naz.plot_hpd(x_points, prediction1.T, color = 'lightblue')\nx_points2 = np.linspace(254,285,100)\nmu_pred2 = trace2['alpha'] + trace2['beta'] * x_points2[:,None]\nprediction2 = stats.norm.rvs(mu_pred2, trace2['sigma'])\nplt.plot(x_points2, trace2['alpha'].mean() + trace2['beta'].mean() * x_points, color = 'red')\naz.plot_hpd(x_points2, prediction2.T, credible_interval = 0.95, color = 'red')","6cae0292":"Time to combine the dataframes:","ac730127":"Let's query the subset of crimes that are assault or battery and lead to arrests during the timeframe of the weather data:\n\n'2012-10-01' - \n'2017-11-30'","426735e9":"Check data quality:","b6c03087":"Again, Blue dots represent incidents, the red line represents the mean incident value for given temperature. The orange represents the 0.95 credible interval. \n\n\nNow let's plot the entire dataset, highlighting the results during christmas","f3a6e303":"Aggregate average daily air temperature to match:","4b94412f":"Let's plot the distribution for the slope and the intercept based on our priors and the data:","d42d7ac2":"Check the database schema:","37c0d03d":"Let's aggregate the crimes by count per day:","091a900e":"It appears that the slope is quite a bit less steep. Let's visualize the results.","f8ebfc85":"Check the data","33730992":"We see a weak correlation between temperature and incidents of violent crime, let's model this using a Bayesian linear model with pymc3:","82b0872f":"Import the Chicago City Weather data:","33bc20be":"It appears there are a number of null values, let's examine them","14366efe":"Check if our query was successful:","c41cf3cd":"Check the date range of our weather data:","6392aca0":"Let's plot the data to get an overview:","05481925":"Set datetime as index:","39fd2ecf":"Let's drop the rows with NaN values","7acf1d71":"We use BigQuery to query a dataset from the Chicago Police Department's CLEAR (Citizen Law Enforcement Analysis and Reporting) system from 2010 to present","e9a3ef6f":"Blue dots represent incidents, the red line represents the mean incident value for given temperature. The orange represents the 0.95 credible interval. \n\nNow we turn our attention to the Christmas period. If separately examine the week 24.12 - 31.12, will we get the same slope and intercept?","04170ab8":" Now let's look at crime, specifically violent crime","141db8c3":"Let's plot the credible interval and mean of our model:","266345cd":"The mean for the entire year is shown in blue line, while the mean for the Christmas week is shown in red line. The blue dots represent the whole year incidents, while red dots indicate incidents during the Christmas week. The 95% credible interval is shown in corresponding colors. We can see that the mean rate of violent chrime incidents is slightly lower during the Christmas week, than dates of similar temperature during other parts of the year. Thank you for reading!","fd37674e":"**Is the week 24.12 - 31.12 an outlier in violent crime in Chicago, when accounting for temperature? Are people more peaceful during Christmas time?**\n\nAn analysis using Bayesian linear regression with PyMC3"}}