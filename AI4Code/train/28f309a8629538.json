{"cell_type":{"545d4c7f":"code","fd5b9501":"code","ccdf52a6":"code","b4ce5e01":"code","65d78ac9":"code","cbc5c4ed":"code","3b156646":"code","dd7329c0":"code","11fd4c2d":"code","3e7f5d7e":"code","3f8ad070":"code","dd0ca155":"code","76f4c0a8":"code","ace09b35":"code","2aaba482":"code","21ec3cce":"code","f4cf43b5":"code","6352e7c2":"code","feffa805":"code","4b2a0c28":"code","cc3cb021":"code","240d7ec6":"code","2cc14576":"code","9fa95ed9":"code","977c4836":"code","490c6e5e":"code","cada99a7":"code","c87e7672":"code","f0346655":"code","a26e07c4":"code","0d3eae29":"code","c23df23a":"code","820fe935":"code","f4a7a339":"markdown"},"source":{"545d4c7f":"# # This Python 3 environment comes with many helpful analytics libraries installed\n# # It is defined by the kaggle\/python Docker image: https:\/\/github.com\/kaggle\/docker-python\n# # For example, here's several helpful packages to load\n\n# import numpy as np # linear algebra\n# import pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\n\n# # Input data files are available in the read-only \"..\/input\/\" directory\n# # For example, running this (by clicking run or pressing Shift+Enter) will list all files under the input directory\n\n# import os\n# for dirname, _, filenames in os.walk('\/kaggle\/input'):\n#     for filename in filenames:\n#         print(os.path.join(dirname, filename))\n\n# # You can write up to 5GB to the current directory (\/kaggle\/working\/) that gets preserved as output when you create a version using \"Save & Run All\" \n# # You can also write temporary files to \/kaggle\/temp\/, but they won't be saved outside of the current session","fd5b9501":"!pip install tensorflow-gpu==1.15","ccdf52a6":"import tensorflow as tf\nprint(tf.__version__)#1.15.0\nimport keras\nprint(keras.__version__)#2.3.1","b4ce5e01":"keras.backend.tensorflow_backend._get_available_gpus()","65d78ac9":"tf.config.experimental.list_physical_devices()","cbc5c4ed":"import numpy as np \nimport pandas as pd \nimport os\nimport matplotlib.pyplot as plt\nimport matplotlib.patches as patches\n%matplotlib inline\nimport cv2\nimport time\nfrom collections import Counter\n!python --version\n!git clone https:\/\/github.com\/matterport\/Mask_RCNN.git\n!cd Mask_RCNN ; python setup.py install\n!pip show mask-rcnn\nfrom os import sys\nsys.path.append('.\/Mask_RCNN\/')\nfrom mrcnn.utils import Dataset\nfrom mrcnn.visualize import display_instances\nfrom mrcnn.utils import extract_bboxes\nfrom mrcnn.config import Config\nfrom mrcnn.model import MaskRCNN\nfrom mrcnn.utils import compute_ap\nfrom mrcnn.model import load_image_gt\nfrom mrcnn.model import mold_image","3b156646":"train_csv=pd.read_csv(os.path.join(\"\/kaggle\/input\/face-mask-detection-dataset\/train.csv\"))\ndf=train_csv.copy(deep=True)\ndf.head(),df.shape","dd7329c0":"submission=pd.read_csv(os.path.join(\"\/kaggle\/input\/face-mask-detection-dataset\/submission.csv\"))\nsubmission.head()","11fd4c2d":"bbox=[]\nfor i in range(len(train_csv)):\n    arr=[]\n    for j in df.iloc[i][['x1','x2','y1','y2']]:\n        arr.append(j)\n    bbox.append(arr)\ndf[\"bbox\"]=bbox\ndf.head()","3e7f5d7e":"train_csv.head()","3f8ad070":"def get_boxes(id):\n    boxes=[]\n    c_names=[]\n    dt=df[df['name']==str(id)]\n    for i in range(len(dt)):\n        boxes.append(dt.iloc[i]['bbox'])\n        c_names.append(dt.iloc[i]['classname'])\n    return boxes,c_names\n# print(get_boxes('1812.jpg'))\nboxes,c_names=get_boxes('1812.jpg')\nprint(boxes)\nprint(c_names)","dd0ca155":"ctr=Counter(df['classname'])\nprint(len(ctr),ctr)\nct=list(ctr)\nct","76f4c0a8":"SUB_DATA=list(set(submission['name']))\nlen(list(SUB_DATA)),SUB_DATA[:10]","ace09b35":"ct.insert(0,'BG')\nct","2aaba482":"class wobotDataset(Dataset):\n    \n    def load_dataset_2(self):\n        for i in range(len(SUB_DATA)):\n            di=SUB_DATA[i]\n            self.add_image(\n                'wobot',\n                image_id=di,\n                image_id_df=di,\n                path=os.path.join(images,di)\n            )\n\n    def load_dataset(self,train_bool):\n        D_DATA=[]\n        if(train_bool):\n            D_DATA=train_DATA\n        else:\n            D_DATA=test_DATA\n            \n        for i in range(len(ct)):\n            self.add_class(\"wobot\", i+1, ct[i])\n\n        for i in range(len(D_DATA)):\n            di=D_DATA[i]\n            self.add_image(\n                'wobot',\n                image_id=di[0],\n                image_id_df=di[0],\n                path=os.path.join(images,di[0]),\n                class_names=di[-1],\n                height=di[1],\n                width=di[2]\n                          )\n            \n    def get_boxes(self,id):\n        boxes=[]\n        c_names=[]\n        dt=df[df['name']==str(id)]\n        for i in range(len(dt)):\n            boxes.append(dt.iloc[i]['bbox'])\n            c_names.append(dt.iloc[i]['classname'])\n        return boxes,c_names\n \n    def load_mask(self, image_id):\n        info = self.image_info[image_id]\n        w=info['width']\n        h=info['height']\n        image_id_df=info['image_id_df']\n        boxes,c_names= self.get_boxes(image_id_df)\n        masks = np.zeros((h, w, len(boxes)), dtype='uint8')\n        class_ids = list()\n        for i in range(len(boxes)):\n#             print('i->'+str(i))\n            box = boxes[i]\n            row_s, row_e = box[1], box[3]\n            col_s, col_e = box[0], box[2]\n            masks[row_s:row_e, col_s:col_e, i] = 1\n            class_ids.append(self.class_names.index(c_names[i]))\n        return masks, np.asarray(class_ids, dtype='int32')\n \n    def image_reference(self, image_id):\n        info = self.image_info[image_id]\n        return info['path']\n\n# class wobotConfig(Config):\n#     NAME = 'wobot_cfg'\n#     NUM_CLASSES = 1 + 20\n#     IMAGES_PER_GPU = 1\n#     STEPS_PER_EPOCH = len(train_set.image_ids)\n \n# config = wobotConfig()\n\n# from mrcnn import\nclass MaskRCNN(MaskRCNN):\n    def __init__(self, mode, config, model_dir):\n        \"\"\"\n        mode: Either \"training\" or \"inference\"\n        config: A Sub-class of the Config class\n        model_dir: Directory to save training logs and trained weights\n        \"\"\"\n        assert mode in ['training', 'inference']\n        self.mode = mode\n        self.config = config\n        self.model_dir = model_dir\n        self.set_log_dir()\n        self.keras_model = self.build(mode=mode, config=config)\n        \n        self.keras_model.metrics_tensors = []\n    \nfrom tensorflow.python.util import deprecation\ndeprecation._PRINT_DEPRECATION_WARNINGS = False\n\nclass PredictionConfig(Config):\n    NAME = 'wobot_cfg'\n    NUM_CLASSES = 1 + 20\n    GPU_COUNT = 1\n    IMAGES_PER_GPU = 1\n","21ec3cce":"#https:\/\/drive.google.com\/file\/d\/1XtgbixT2EKzteuiT2uLuzdWFgJt_Nz6g\/view?usp=sharing\n!wget \"https:\/\/drive.google.com\/uc?export=download&id=1XtgbixT2EKzteuiT2uLuzdWFgJt_Nz6g\"","f4cf43b5":"!wget 'https:\/\/drive.google.com\/file\/d\/1XtgbixT2EKzteuiT2uLuzdWFgJt_Nz6g\/view?usp=sharing'","6352e7c2":"!ls","feffa805":"!curl -L -o mask_rcnn_wobot_cfg_0002.h5 \"https:\/\/drive.google.com\/uc?export=download&id=1XtgbixT2EKzteuiT2uLuzdWFgJt_Nz6g\"","4b2a0c28":"!ls","cc3cb021":"cfg = PredictionConfig()\nmodel = MaskRCNN(mode='inference', model_dir='.\/', config=cfg)\nmodel.load_weights('..\/input\/maskrcnn-model\/mask_rcnn_wobot_cfg_0002.h5', by_name=True)","240d7ec6":"images=os.path.join(\"\/kaggle\/input\/face-mask-detection-dataset\/Medical mask\/Medical mask\/Medical Mask\/images\")\nprint(len(os.listdir(images)))","2cc14576":"submission_set = wobotDataset()\nsubmission_set.load_dataset_2()\nsubmission_set.prepare()\nprint('submission: %d' % len(submission_set.image_ids))","9fa95ed9":"# count_sub=0\n# for image_id in submission_set.image_ids:\n#     count_sub+=1\n#     info = submission_set.image_info[image_id]\n#     print(info)","977c4836":"# print(count_sub)","490c6e5e":"sub_df=pd.DataFrame(columns=['name','x1','x2','y1','y2','classname'])\nprinter=0\nfor image_id in submission_set.image_ids:\n#     ####\n#     if image_id>5:\n#         break\n#     ####\n    \n    image = submission_set.load_image(image_id)\n    name = submission_set.image_info[image_id]['image_id_df']\n    \n    scaled_image = mold_image(image, cfg)\n    sample = np.expand_dims(scaled_image, 0)\n    yhat = model.detect(sample, verbose=0)\n#     x2,x1,y2,y1\n    r=yhat[0]\n    subb=r['rois']\n    subc=r['class_ids']\n    subc2=[ct[x] for x in subc]\n    subb,subc,subc2\n    \n    for (i,j) in zip(subb,subc2):\n        x2,x1,y2,y1=i\n        classname=j\n        sub_df.loc[len(sub_df)]=(name,x1,x2,y1,y2,classname)\n        \n    if(printer%100==0):\n        print(printer)\n    printer+=1\n    \nprint(sub_df.shape)","cada99a7":"# printer","c87e7672":"sub_df","f0346655":"from mrcnn import visualize","a26e07c4":"image = submission_set.load_image(1673)\nscaled_image = mold_image(image, cfg)\nsample = np.expand_dims(scaled_image, 0)\nyhat = model.detect(sample, verbose=1)\nr = yhat[0]\nvisualize.display_instances(image, r['rois'], r['masks'], r['class_ids'], ct, r['scores'])\n","0d3eae29":"image = submission_set.load_image(1674)\nscaled_image = mold_image(image, cfg)\nsample = np.expand_dims(scaled_image, 0)\nyhat = model.detect(sample, verbose=1)\n\nfrom mrcnn import visualize\n\nr = yhat[0]\nvisualize.display_instances(image, r['rois'], r['masks'], r['class_ids'], \n                            ct, r['scores'])","c23df23a":"submit_csv=sub_df.sort_values('name',ascending=False)#,inplace=True\nprint(submit_csv.shape)\nsubmit_csv","820fe935":"submit_csv.to_csv('submission.csv',index=False)\nsubmit_csv=pd.read_csv('submission.csv')\nsubmit_csv","f4a7a339":"# Complete train\/test\/submit notebook - https:\/\/drive.google.com\/file\/d\/1xkS8eSxzq6fusPTCv3y-EKhYiCeTdCLM\/view?usp=sharing\n"}}