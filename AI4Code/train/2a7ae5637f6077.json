{"cell_type":{"76089001":"code","84302dc1":"code","61707404":"code","eec2526e":"code","e756e57c":"code","bb50b025":"code","ba9dc578":"code","631888c6":"code","5a7e8814":"code","691d9229":"code","4052c385":"code","19e2ee35":"code","d3ff8965":"code","bc7e5833":"code","c4073182":"code","82fe1376":"code","a74dcad4":"code","09cdddf7":"code","89bd1c5e":"code","b67a271b":"code","d1fd02e8":"code","07342a34":"code","97f46334":"code","69b190cf":"code","a59a27f9":"markdown","bdb801b8":"markdown","acc9f910":"markdown","51b50f48":"markdown","92fd71d2":"markdown","6105fc19":"markdown","b9fa3c9c":"markdown","e54e7833":"markdown","f9422ba0":"markdown","7aee8188":"markdown","5a2a8a44":"markdown","1043966c":"markdown","581e909f":"markdown","253b9c0e":"markdown","03fa4d2f":"markdown","a46e7ab1":"markdown","5ad375b7":"markdown","636382a0":"markdown"},"source":{"76089001":"import pandas as pd\ncalendar = pd.read_csv(\"..\/input\/m5-forecasting-accuracy\/calendar.csv\")\ncalendar.fillna(\"missing\")\n\nsell_prices  =pd.read_csv(\"..\/input\/m5-forecasting-accuracy\/sell_prices.csv\")\nsales_train_validation = pd.read_csv(\"..\/input\/m5-forecasting-accuracy\/sales_train_validation.csv\")","84302dc1":"calendar","61707404":"sell_prices","eec2526e":"sales_train_validation","e756e57c":"sales_train_validation['updated_ID'] = sales_train_validation.id.apply(lambda x:\"_\".join(x.split(\"_\")[:-1]))","bb50b025":"sales_train_validation[['dept_id',\"cat_id\",\"store_id\",\"item_id\"]].nunique()","ba9dc578":"# reference from https:\/\/www.kaggle.com\/tarunpaparaju\/m5-competition-eda-models\nimport os\nimport gc\nimport time\nimport math\nimport datetime\nfrom math import log, floor\nfrom sklearn.neighbors import KDTree\n\nimport numpy as np\nimport pandas as pd\nfrom pathlib import Path\nfrom sklearn.utils import shuffle\nfrom tqdm.notebook import tqdm as tqdm\n\nimport seaborn as sns\nfrom matplotlib import colors\nimport matplotlib.pyplot as plt\nfrom matplotlib.colors import Normalize\n\nimport plotly.express as px\nimport plotly.graph_objects as go\nimport plotly.figure_factory as ff\nfrom plotly.subplots import make_subplots\n\nimport pywt\nfrom statsmodels.robust import mad\n\nimport scipy\nimport statsmodels\nfrom scipy import signal\nimport statsmodels.api as sm\nfrom fbprophet import Prophet\nfrom scipy.signal import butter, deconvolve\nfrom statsmodels.tsa.arima_model import ARIMA\nfrom statsmodels.tsa.api import ExponentialSmoothing, SimpleExpSmoothing, Holt\n\nimport warnings\nwarnings.filterwarnings(\"ignore\")","631888c6":"ids = sorted(list(set(sales_train_validation['id'])))\nd_cols = [c for c in sales_train_validation.columns if 'd_' in c]\nx_1 = sales_train_validation.loc[sales_train_validation['id'] == ids[2]].set_index('id')[d_cols].values[0]\nx_2 = sales_train_validation.loc[sales_train_validation['id'] == ids[1]].set_index('id')[d_cols].values[0]\nx_3 = sales_train_validation.loc[sales_train_validation['id'] == ids[17]].set_index('id')[d_cols].values[0]\n\nfig = make_subplots(rows=3, cols=1)\n\nfig.add_trace(go.Scatter(x=np.arange(len(x_1)), y=x_1, showlegend=False,\n                    mode='lines', name=\"First sample\",\n                         marker=dict(color=\"red\")),\n             row=1, col=1)\n\nfig.add_trace(go.Scatter(x=np.arange(len(x_2)), y=x_2, showlegend=False,\n                    mode='lines', name=\"Second sample\",\n                         marker=dict(color=\"violet\")),\n             row=2, col=1)\n\nfig.add_trace(go.Scatter(x=np.arange(len(x_3)), y=x_3, showlegend=False,\n                    mode='lines', name=\"Third sample\",\n                         marker=dict(color=\"dodgerblue\")),\n             row=3, col=1)\n\nfig.update_layout(height=1200, width=800, title_text=\"Sample sales\")\nfig.show()","5a7e8814":"ids = sorted(list(set(sales_train_validation['id'])))\nd_cols = [c for c in sales_train_validation.columns if 'd_' in c]\nx_1 = sales_train_validation.loc[sales_train_validation['id'] == ids[2]].set_index('id')[d_cols].values[0][:90]\nx_2 = sales_train_validation.loc[sales_train_validation['id'] == ids[1]].set_index('id')[d_cols].values[0][0:90]\nx_3 = sales_train_validation.loc[sales_train_validation['id'] == ids[17]].set_index('id')[d_cols].values[0][0:90]\nfig = make_subplots(rows=3, cols=1)\n\nfig.add_trace(go.Scatter(x=np.arange(len(x_1)), y=x_1, showlegend=False,\n                    mode='lines+markers', name=\"First sample\",\n                         marker=dict(color=\"mediumseagreen\")),\n             row=1, col=1)\n\nfig.add_trace(go.Scatter(x=np.arange(len(x_2)), y=x_2, showlegend=False,\n                    mode='lines+markers', name=\"Second sample\",\n                         marker=dict(color=\"violet\")),\n             row=2, col=1)\n\nfig.add_trace(go.Scatter(x=np.arange(len(x_3)), y=x_3, showlegend=False,\n                    mode='lines+markers', name=\"Third sample\",\n                         marker=dict(color=\"dodgerblue\")),\n             row=3, col=1)\n\nfig.update_layout(height=1200, width=800, title_text=\"Sample sales snippets\")\nfig.show()","691d9229":"def maddest(d, axis=None):\n    return np.mean(np.absolute(d - np.mean(d, axis)), axis)\n\ndef denoise_signal(x, wavelet='db4', level=1):\n    coeff = pywt.wavedec(x, wavelet, mode=\"per\")\n    sigma = (1\/0.6745) * maddest(coeff[-level])\n\n    uthresh = sigma * np.sqrt(2*np.log(len(x)))\n    coeff[1:] = (pywt.threshold(i, value=uthresh, mode='hard') for i in coeff[1:])\n\n    return pywt.waverec(coeff, wavelet, mode='per')","4052c385":"y_w1 = denoise_signal(x_1)\ny_w2 = denoise_signal(x_2)\ny_w3 = denoise_signal(x_3)\n\n\nfig = make_subplots(rows=3, cols=1)\n\nfig.add_trace(\n    go.Scatter(x=np.arange(len(x_1)), mode='lines+markers', y=x_1, marker=dict(color=\"mediumaquamarine\"), showlegend=False,\n               name=\"Original signal\"),\n    row=1, col=1\n)\n\nfig.add_trace(\n    go.Scatter(x=np.arange(len(x_1)), y=y_w1, mode='lines', marker=dict(color=\"darkgreen\"), showlegend=False,\n               name=\"Denoised signal\"),\n    row=1, col=1\n)\n\nfig.add_trace(\n    go.Scatter(x=np.arange(len(x_2)), mode='lines+markers', y=x_2, marker=dict(color=\"thistle\"), showlegend=False),\n    row=2, col=1\n)\n\nfig.add_trace(\n    go.Scatter(x=np.arange(len(x_2)), y=y_w2, mode='lines', marker=dict(color=\"purple\"), showlegend=False),\n    row=2, col=1\n)\n\nfig.add_trace(\n    go.Scatter(x=np.arange(len(x_3)), mode='lines+markers', y=x_3, marker=dict(color=\"lightskyblue\"), showlegend=False),\n    row=3, col=1\n)\n\nfig.add_trace(\n    go.Scatter(x=np.arange(len(x_3)), y=y_w3, mode='lines', marker=dict(color=\"navy\"), showlegend=False),\n    row=3, col=1\n)\n\nfig.update_layout(height=1200, width=800, title_text=\"Original (pale) vs. Denoised (dark) sales\")\nfig.show()","19e2ee35":"fig, ax = plt.subplots(nrows=3, ncols=2, figsize=(30, 20))\n\nax[0, 0].plot(x_1, color='seagreen', marker='o') \nax[0, 0].set_title('Original Sales', fontsize=24)\nax[0, 1].plot(y_w1, color='red', marker='.') \nax[0, 1].set_title('After Wavelet Denoising', fontsize=24)\n\nax[1, 0].plot(x_2, color='seagreen', marker='o') \nax[1, 0].set_title('Original Sales', fontsize=24)\nax[1, 1].plot(y_w2, color='red', marker='.') \nax[1, 1].set_title('After Wavelet Denoising', fontsize=24)\n\nax[2, 0].plot(x_3, color='seagreen', marker='o') \nax[2, 0].set_title('Original Sales', fontsize=24)\nax[2, 1].plot(y_w3, color='red', marker='.') \nax[2, 1].set_title('After Wavelet Denoising', fontsize=24)\n\nplt.show()","d3ff8965":"def average_smoothing(signal, kernel_size=5, stride=1):\n    sample = []\n    start = 0\n    end = kernel_size\n    while end <= len(signal):\n        start = start + stride\n        end = end + stride\n        sample.extend(np.ones(end - start)*np.mean(signal[start:end]))\n    return np.array(sample)","bc7e5833":"y_a1 = average_smoothing(x_1)\ny_a2 = average_smoothing(x_2)\ny_a3 = average_smoothing(x_3)\n\nfig = make_subplots(rows=3, cols=1)\n\nfig.add_trace(\n    go.Scatter(x=np.arange(len(x_1)), mode='lines+markers', y=x_1, marker=dict(color=\"lightskyblue\"), showlegend=False,\n               name=\"Original sales\"),\n    row=1, col=1\n)\n\nfig.add_trace(\n    go.Scatter(x=np.arange(len(x_1)), y=y_a1, mode='lines', marker=dict(color=\"navy\"), showlegend=False,\n               name=\"Denoised sales\"),\n    row=1, col=1\n)\n\nfig.add_trace(\n    go.Scatter(x=np.arange(len(x_2)), mode='lines+markers', y=x_2, marker=dict(color=\"thistle\"), showlegend=False),\n    row=2, col=1\n)\n\nfig.add_trace(\n    go.Scatter(x=np.arange(len(x_2)), y=y_a2, mode='lines', marker=dict(color=\"indigo\"), showlegend=False),\n    row=2, col=1\n)\n\nfig.add_trace(\n    go.Scatter(x=np.arange(len(x_3)), mode='lines+markers', y=x_3, marker=dict(color=\"mediumaquamarine\"), showlegend=False),\n    row=3, col=1\n)\n\nfig.add_trace(\n    go.Scatter(x=np.arange(len(x_3)), y=y_a3, mode='lines', marker=dict(color=\"darkgreen\"), showlegend=False),\n    row=3, col=1\n)\n\nfig.update_layout(height=1200, width=800, title_text=\"Original (pale) vs. Denoised (dark) signals\")\nfig.show()","c4073182":"fig, ax = plt.subplots(nrows=3, ncols=3, figsize=(30, 20))\n\nax[0, 0].plot(x_1, color='seagreen', marker='o') \nax[0, 0].set_title('Original Sales', fontsize=24)\nax[0, 1].plot(y_w1, color='red', marker='.') \nax[0, 1].set_title('After Wavelet Denoising', fontsize=24)\nax[0, 2].plot(y_a1, color='red', marker='.') \nax[0, 2].set_title('After Average_smoothing', fontsize=24)\n\n\nax[1, 0].plot(x_2, color='seagreen', marker='o') \nax[1, 0].set_title('Original Sales', fontsize=24)\nax[1, 1].plot(y_w2, color='red', marker='.') \nax[1, 1].set_title('After Wavelet Denoising', fontsize=24)\nax[1, 2].plot(y_a2, color='red', marker='.') \nax[1, 2].set_title('After Average Smoothing', fontsize=24)\n\nax[2, 0].plot(x_3, color='seagreen', marker='o') \nax[2, 0].set_title('Original Sales', fontsize=24)\nax[2, 1].plot(y_w3, color='red', marker='.') \nax[2, 1].set_title('After Wavelet Denoising', fontsize=24)\nax[2, 2].plot(y_a3, color='red', marker='.') \nax[2, 2].set_title('After Average Smoothing', fontsize=24)\n\nplt.show()","82fe1376":"def max_val_smoothing(signal, kernel_size=5, stride=1):\n    sample = []\n    start = 0\n    end = kernel_size\n    while end <= len(signal):\n        start = start + stride\n        end = end + stride\n        sample.extend(np.ones(end - start)*np.ma(signal[start:end]))\n    return np.array(sample)","a74dcad4":"y_a1 = average_smoothing(x_1)\ny_a2 = average_smoothing(x_2)\ny_a3 = average_smoothing(x_3)\n\nfig = make_subplots(rows=3, cols=1)\n\nfig.add_trace(\n    go.Scatter(x=np.arange(len(x_1)), mode='lines+markers', y=x_1, marker=dict(color=\"lightskyblue\"), showlegend=False,\n               name=\"Original sales\"),\n    row=1, col=1\n)\n\nfig.add_trace(\n    go.Scatter(x=np.arange(len(x_1)), y=y_a1, mode='lines', marker=dict(color=\"navy\"), showlegend=False,\n               name=\"Denoised sales\"),\n    row=1, col=1\n)\n\nfig.add_trace(\n    go.Scatter(x=np.arange(len(x_2)), mode='lines+markers', y=x_2, marker=dict(color=\"thistle\"), showlegend=False),\n    row=2, col=1\n)\n\nfig.add_trace(\n    go.Scatter(x=np.arange(len(x_2)), y=y_a2, mode='lines', marker=dict(color=\"indigo\"), showlegend=False),\n    row=2, col=1\n)\n\nfig.add_trace(\n    go.Scatter(x=np.arange(len(x_3)), mode='lines+markers', y=x_3, marker=dict(color=\"mediumaquamarine\"), showlegend=False),\n    row=3, col=1\n)\n\nfig.add_trace(\n    go.Scatter(x=np.arange(len(x_3)), y=y_a3, mode='lines', marker=dict(color=\"darkgreen\"), showlegend=False),\n    row=3, col=1\n)\n\nfig.update_layout(height=1200, width=800, title_text=\"Original (pale) vs. Denoised (dark) signals\")\nfig.show()","09cdddf7":"past_sales = sales_train_validation.set_index('id')[d_cols] \\\n    .T \\\n    .merge(calendar.set_index('d')['date'],\n           left_index=True,\n           right_index=True,\n            validate='1:1') \\\n    .set_index('date')\n\nstore_list = sell_prices['store_id'].unique()\n","89bd1c5e":"means = []\nfig = go.Figure()\nfor s in store_list:\n  store_items = [c for c in past_sales.columns if s in c]\n  data = past_sales[store_items].sum(axis=1).rolling(90).mean()\n  means.append(np.mean(past_sales[store_items].sum(axis=1)))\n  fig.add_trace(go.Scatter(x=np.arange(len(data)), y=data, name=s))\n    \nfig.update_layout(yaxis_title=\"Sales\", xaxis_title=\"Time\", title=\"Rolling Average Sales vs. Time (per store)\")","b67a271b":"fig = go.Figure()\n\nfor i, s in enumerate(store_list):\n  store_items = [c for c in past_sales.columns if s in c]\n  data = past_sales[store_items].sum(axis=1).rolling(90).mean()\n  fig.add_trace(go.Box(x=[s]*len(data), y=data, name=s))\n    \nfig.update_layout(yaxis_title=\"Sales\", xaxis_title=\"Time\", title=\"Rolling Average Sales vs. Store name \")","d1fd02e8":"df = pd.DataFrame(np.transpose([means, store_list]))\ndf.columns = [\"Mean sales\", \"Store name\"]\npx.bar(df, y=\"Mean sales\", x=\"Store name\", color=\"Store name\", title=\"Mean sales vs. Store name\")","07342a34":"greens = [\"darkgreen\", \"mediumseagreen\", \"seagreen\", \"green\"]\nstore_list = sell_prices['store_id'].unique()\nfig = go.Figure()\nmeans = []\nstores = []\nfor i, s in enumerate(store_list):\n    if \"tx\" in s or \"TX\" in s:\n        store_items = [c for c in past_sales.columns if s in c]\n        data = past_sales[store_items].sum(axis=1).rolling(90).mean()\n        means.append(np.mean(past_sales[store_items].sum(axis=1)))\n        stores.append(s)\n        fig.add_trace(go.Scatter(x=np.arange(len(data)), y=data, name=s, marker=dict(color=greens[i%len(greens)])))\n        \nfig.update_layout(yaxis_title=\"Sales\", xaxis_title=\"Time\", title=\"Rolling Average Sales vs. Time (Texas)\")","97f46334":"fig = go.Figure()\n\nfor i, s in enumerate(store_list):\n    if \"tx\" in s or \"TX\" in s:\n        store_items = [c for c in past_sales.columns if s in c]\n        data = past_sales[store_items].sum(axis=1).rolling(90).mean()\n        fig.add_trace(go.Box(x=[s]*len(data), y=data, name=s, marker=dict(color=greens[i%len(greens)])))\n    \nfig.update_layout(yaxis_title=\"Sales\", xaxis_title=\"Time\", title=\"Rolling Average Sales vs. Store name (Texas)\")","69b190cf":"df = pd.DataFrame(np.transpose([means, stores]))\ndf.columns = [\"Mean sales\", \"Store name\"]\npx.bar(df, y=\"Mean sales\", x=\"Store name\", color=\"Store name\", title=\"Mean sales vs. Store name\", color_continuous_scale=greens)\n\n\nfig = go.Figure(data=[\n    go.Bar(name='', x=stores, y=means, marker={'color' : greens})])\n\nfig.update_layout(title=\"Mean sales vs. Store name (Texas)\", yaxis=dict(title=\"Mean sales\"), xaxis=dict(title=\"Store name\"))\nfig.update_layout(barmode='group')\nfig.show()","a59a27f9":"# Denoising Data","bdb801b8":"here , i have plotted the actual data, wavelet denoised trend data, and average smoothed trend data. Just to show there representations with each other. ","acc9f910":"In the above plots ,  we can see how the sales in 3 different store in texas variate over time , there distributions in overall texas area. We can see that in the some initial time period when the sales of one store were increasing ,the other were side by side to each other .It is like , the crowd in region of store 1 liked the product when the people near other stores didn't. And after some time it got reversed. THe sales of store 1 went down to be almost same as the other two.\n\nWe conclude that store 2 TX_2 has the maximum sales and TX_1 has the minimum sales.","51b50f48":"Denoising is a technique to find trend in time-series data , although it may loose some useful information in the data but it helps us to understand the trend more better.","92fd71d2":"## Wavelet Denoising","6105fc19":"Above plot represents sales of 3 randomly choosen stores. We can see that these sales are so inconsistent and hence we can infer that sales of any store depends upon various other features as we see on some days these sales have gone down to 0 , may be there was no stock or some kind of problem in that area the store didn't open or even the customers liked the product so much that they have stocked it in there house as they want to go out.","b9fa3c9c":"The baar plot shows all sales of different stores over a period of time. ","e54e7833":" Note: This notebook is almost a duplicate of [this kernel](https:\/\/www.kaggle.com\/tarunpaparaju\/m5-competition-eda-models). I have just created this learning purpose . You can have look at the original kernel too.","f9422ba0":"The above plot shows details the same way  as we get from  average smoothing , but just a small difference is that we have used max value of the window instead of the mean value to plot the graph , showing a bit of different trend front the averge one. ","7aee8188":"In the above plots i have just plotted graph of sales for first 90 days of same store which i had used in the previous graph. As you can see , the sales are very volatile as stated before too.","5a2a8a44":"A different technique to extract trends from our data.Both the Wavelet and Avg. smoothing techniques provides different trends in our data , but to use them as data to train model on , is not a good choice as they may lack some important details about the data which we might require for better performance.","1043966c":"Lets have a look over the data first and then perform the basic EDA.","581e909f":"Wavelet denoising (usually used with electric signals) is a way to remove the unnecessary noise from a time series. This method calculates coefficients called the \"wavelet coefficients\". These coefficients decide which pieces of information to keep (signal) and which ones to discard (noise).\n\nWe make use of the MAD (mean absolute deviation) value to understand the randomness in the sales and accordingly decide the minimum threshold for the wavelet coefficients in the time series. We filter out the low coefficients from the wavelets and reconstruct the sales data from the remaining coefficients and that's it; we have successfully removed noise from the sales data.","253b9c0e":"The above graph shows the actual time series graph on the left side and on right side we have shown wavelet denoised time series data, just used to extract trends from the original data.","03fa4d2f":"## Average Smoothing","a46e7ab1":"Note : The same can be also be done for other cities too and details analytics and there trends can be extracted.","5ad375b7":"The box plot shows the sales ditribution in different Stores provided in the dataset. We can infer that california sales vs stores have the highest variance and california has also maintained the highest overall mean sale. Where other Texas and Winsonica have maintained there sales with no so much varation and also each store in Texas have similar sales ,whereas in Winsonica there is high varaince in sales of each store","636382a0":"Here we have plotted rolling means of 90 days of the sales based of different store present in clifornia , texas and winsonica locations.\nShowing various trends in there sales. \n\nWe cans see that CA-3 has maintained high sales over the given period of time , but it looks like a kind of period graph which after a time gets reduced in sales but then again it heads up to overcome the previous top mark. \n\nAn all time increase and maintained sales have been marked in WI_2. there is no such time they have got there sales reduced to much."}}