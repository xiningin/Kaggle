{"cell_type":{"90324df3":"code","519a4ce7":"code","6e5723b1":"code","42b78d1a":"code","4c30715e":"code","4f34d412":"code","18d1d88b":"code","525d0e10":"code","79894920":"code","8dc212fb":"code","c8db4f8f":"code","277569d8":"code","8f446235":"code","41db2627":"code","2bffa7ca":"code","61d9a47c":"code","b20daf12":"code","f933ae1c":"code","c1a5e6c7":"code","80c2acc9":"code","68779210":"code","907a6a11":"code","17c33a2a":"code","e325b0de":"code","7d5159d0":"code","734a9039":"code","3fe868ac":"code","59ba212e":"code","46c8c63a":"code","a8af6d80":"code","0f8c4095":"code","385ad8e1":"code","6fe7c713":"code","3d1db558":"markdown","b2d86ee6":"markdown","ab54e8b7":"markdown","8ed1e094":"markdown","a994dc7e":"markdown","b1f53715":"markdown","ac0a48c6":"markdown","cbe3e4a8":"markdown","ee4cf74a":"markdown","c16b6eda":"markdown"},"source":{"90324df3":"# Import Libraries\nimport numpy as np\nimport tensorflow.keras as keras\nfrom tensorflow.keras.preprocessing.image import ImageDataGenerator\nfrom tensorflow.keras.preprocessing import image\nfrom tensorflow.keras.applications.mobilenet import preprocess_input, decode_predictions\nfrom tensorflow.keras.layers import GlobalAveragePooling2D, Dense\nfrom tensorflow.keras.models import Model\n\nfrom IPython.display import Image","519a4ce7":"DLDir = \"..\/input\/testdata1\/\"    #directory of downloaded files\nfruit1 = 'apple food'  #keyword to be used in train model\nfruit2 = 'water pear'  #keyword to be used in train model\n","6e5723b1":"def prepare_image(filepath):\n   img = image.load_img(filepath, target_size=(224, 224))\n   img_array = image.img_to_array(img)\n   img_array_expanded_dims = np.expand_dims(img_array, axis=0)\n   return keras.applications.mobilenet.preprocess_input(img_array_expanded_dims)","42b78d1a":"import os\ndef chkFolder(path):\n    try:\n        os.listdir(path)\n        return True\n    except:\n        return False\n        \ndef validateImageFile(key , removeErr=True, prn = False) :\n    #global DLDir #dd = '\/kaggle\/input\/testdata1\/applefood\/'\n    dd = DLDir + key\n    fnames =[]\n    errFName = []\n    if(chkFolder(dd)):\n        for fname in os.listdir(dd):\n            _fname = dd  +'\/' +fname\n            try:\n                Image(filename=_fname)\n                if(prn):print('ok',_fname )\n                fnames.append(_fname)\n            except:\n                if(removeErr):os.remove(_fname )\n                print('error read file  fn', _fname)\n    print ('done to validateImageFile',key )\n    return fnames,errFName","4c30715e":"#show image\nimport numpy as np # linear algebra\nfrom PIL import Image as im\nimport matplotlib.pyplot as plt\ndef showImage(fname):\n    img_array = np.array(im.open(fname))\n    plt.imshow(img_array)","4f34d412":"# Load Mobile\n#@@ As creating model, one could meet error sometimes. it may be busy in server or slow in connecting speed\nmodel = keras.applications.mobilenet_v2.MobileNetV2()","18d1d88b":"img_file='..\/input\/images22\/apple.jpg'\nImage(filename=img_file)","525d0e10":"# check model prediction\npreprocessed_image = prepare_image(img_file)\npredictions = model.predict(preprocessed_image)\nresults = decode_predictions(predictions)\nprint(results[0])","79894920":"img_file='..\/input\/images2\/applef.jpg'\nImage(filename=img_file)","8dc212fb":"# check model prediction\npreprocessed_image = prepare_image(img_file)\npredictions = model.predict(preprocessed_image)\nresults = decode_predictions(predictions)\nprint(results)","c8db4f8f":"def funDownLoadImage( key , print_urls = False , print_size = False, print_paths = False):\n    !pip install google_images_download\n    from google_images_download import google_images_download\n    global DLDir #dd = '\/kaggle\/input\/testdata1\/applefood\/'\n    dd = DLDir \n    response = google_images_download.googleimagesdownload()\n    arguments = {\"keywords\":key,\"limit\":30,\n                 \"print_urls\":print_urls,\"print_size\":print_size,\"print_paths\":print_paths,\"format\":\"jpg\", \"size\":\">400*300\",\n                 \"output_directory\" : dd\n                }\n    paths = response.download(arguments)\n    return paths","277569d8":"#first check if file exist already before downloading\nfnames,errFName = validateImageFile(fruit1 )\nif(len(fnames)<=0) : \n    paths = funDownLoadImage(fruit1)\n    validateImageFile(fruit1 , False ) #validate again","8f446235":"#downloading #2\nfnames,errFName = validateImageFile(fruit2 )\nif(len(fnames)<=0) : \n    paths = funDownLoadImage(fruit2)\n    validateImageFile(fruit2 , False ) #validate again","41db2627":"# remove files of URLError \/ Wrong image format\nif(fruit1 == 'apple food'):\n    !rm  ..\/input\/testdata1\/\"apple food\"\/16.*","2bffa7ca":"#DLDir = \"..\/input\/testdata1\/\"    #directory of downloaded files\n\n#!ls -l ..\/input\/testdata1\/Granny_Smith","61d9a47c":"# remove files of URLError \/ Wrong image format\n'''\n!rm .\/downloads\/apple\/15.*\n!rm .\/downloads\/apple\/2.*\n!rm .\/downloads\/apple\/8.*\n!rm .\/downloads\/apple\/4.*\n!rm .\/downloads\/apple\/14.*\n!rm .\/downloads\/apple\/13.*\n!rm .\/downloads\/apple\/16.*\n!rm .\/downloads\/apple\/17.*\n!rm .\/downloads\/apple\/19.*\n!rm .\/downloads\/apple\/20.*\n# rename files with special characters\n#!mv .\/downloads\/\"apple food\/2.* .\/downloads\/\"apple\"\/2.blue-tit.jpg\n#!mv .\/downloads\/apple\/18.* .\/downloads\/\"apple\"\/18.blue-tit.jpg\n'''","b20daf12":"\n'''\n'# remove files of URLError \/ Wrong image format\n!rm .\/downloads\/banana\/10.*.jpg\n!rm .\/downloads\/banana\/14.*.jpg\n!rm .\/downloads\/banana\/15.*.jpg\n# rename files with special characters\n!mv .\/downloads\/banana\/12.* .\/downloads\/banana\/13.Waterpear.jpg\n'''","f933ae1c":"# Data Generator\ntrain_datagen=ImageDataGenerator(preprocessing_function=preprocess_input)\n\ntrain_generator=train_datagen.flow_from_directory(DLDir,\n                                                target_size=(224,224),\n                                                color_mode='rgb',\n                                                batch_size=32,\n                                                class_mode='categorical',\n                                                shuffle=True)","c1a5e6c7":"num_classes = 2\nprediction_dict = {0: fruit1, 1: fruit2}\n#prediction_dict = {1: \"apple food\", 0: \"Water pear\"}","80c2acc9":"# Load Model (MobieNet V2)\nbase_model=keras.applications.mobilenet_v2.MobileNetV2(input_shape=(224,224,3),weights='imagenet',include_top=False) #imports the mobilenet model and discards the last 1000 neuron layer.\n\n# Add Extra Layers to Model\nx=base_model.output\nx=GlobalAveragePooling2D()(x)\nx=Dense(1024,activation='relu')(x) #we add dense layers so that the model can learn more complex functions and classify for better results.\nx=Dense(1024,activation='relu')(x) #dense layer 2\nx=Dense(512,activation='relu')(x) #dense layer 3\npreds=Dense(num_classes,activation='softmax')(x) #final layer with softmax activation\n\nmodel=Model(inputs=base_model.input,outputs=preds)","68779210":"# Check layers no. & name\nfor i,layer in enumerate(model.layers):\n    print(i,layer.name)","907a6a11":"# set extra layers to trainable (layer #155~159)\nfor layer in model.layers[:155]:\n    layer.trainable=False\nfor layer in model.layers[155:]:\n    layer.trainable=True\n\n# Compile Model\nmodel.compile(loss='categorical_crossentropy', optimizer='adam',metrics=['accuracy'])\nmodel.summary()","17c33a2a":"# Train Model (target is loss <0.01)\nnum_epochs = 20\nstep_size_train=train_generator.n\/\/train_generator.batch_size\nmodel.fit_generator(generator=train_generator, steps_per_epoch=step_size_train, epochs=num_epochs)","e325b0de":"showImage('..\/input\/testdata\/Granny_Smith.jpg')\n","7d5159d0":"#img_file='..\/input\/images22\/apple.jpg'\nimg_file='..\/input\/testdata\/Granny_Smith.jpg'\nImage(filename=img_file)","734a9039":"# Test the new model\npreprocessed_image = prepare_image(img_file)\npredictions = model.predict(preprocessed_image)\nmaxindex = int(np.argmax(predictions))\nprint(predictions[0][maxindex],prediction_dict[maxindex])","3fe868ac":"predictions","59ba212e":"img_file='..\/input\/images2\/applef.jpg'\nImage(filename=img_file)","46c8c63a":"# Test the new model\npreprocessed_image = prepare_image(img_file)\npredictions = model.predict(preprocessed_image)\nmaxindex = int(np.argmax(predictions))\nprint(predictions[0][maxindex],prediction_dict[maxindex])","a8af6d80":"img_file='..\/input\/images22\/apple.jpg'\nImage(filename=img_file)","0f8c4095":"# Test the new model\npreprocessed_image = prepare_image(img_file)\npredictions = model.predict(preprocessed_image)\nmaxindex = int(np.argmax(predictions))\nprint(predictions[0][maxindex],prediction_dict[maxindex])\nprint(predictions[0])","385ad8e1":"R","6fe7c713":"# remove downloaded images\n!rm -rf ..\/input\/testdata1\/","3d1db558":"### Install google_images_download","b2d86ee6":"## Load Model (Keras built-in)","ab54e8b7":"### Download fruit2 food images","8ed1e094":"> ## Test New Model","a994dc7e":"### Download fruit1 images","b1f53715":"## Download Images from Internet","ac0a48c6":"### *Confirm the model recognize German Shepherd*","cbe3e4a8":"## Test Model","ee4cf74a":"# Image Classification - MobileNet v2 Transfer Learning","c16b6eda":"[](http:\/\/)[](http:\/\/)### Download Water pear Images"}}