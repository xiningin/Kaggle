{"cell_type":{"97aff6de":"code","365d81f6":"code","bb0ebf6d":"code","d10af848":"code","513706bd":"code","24671637":"code","bca8f6eb":"code","b300ce89":"code","bba0cb91":"code","1051cf94":"code","e37c043d":"code","a5148b86":"code","8411605f":"code","bf73bafd":"code","b954ea82":"code","5bfd9a75":"code","60df56e5":"code","f967cfb4":"code","4b0caac0":"code","ba8755d3":"code","82ad4f8d":"code","51bad2fd":"code","1c2ff563":"code","999b0ed6":"code","b1981632":"code","76d172ce":"code","6e51f265":"code","634ccaef":"code","7cf6a922":"code","40b2365c":"code","aa472ba5":"code","5261a9e6":"code","331127d4":"code","9def4ecc":"code","98acc861":"code","6d47d98b":"code","f45616c9":"code","9f9b788f":"code","c11b10ee":"markdown","a431dc3f":"markdown","93c689cb":"markdown","d08a2fb3":"markdown","1783245d":"markdown","c32b6cae":"markdown","5c641ff3":"markdown","ce9489cf":"markdown","5e93ad97":"markdown","fcfe2fe9":"markdown","6351d7a6":"markdown","c0600713":"markdown","b881efa0":"markdown","1e9bce56":"markdown","34b08027":"markdown","9daf9376":"markdown","ea363e05":"markdown","143ae55d":"markdown","86c05aeb":"markdown","4fbf7081":"markdown","d81d03bc":"markdown","28bc6684":"markdown","fbd5cfd9":"markdown"},"source":{"97aff6de":"# This Python 3 environment comes with many helpful analytics libraries installed\n# It is defined by the kaggle\/python Docker image: https:\/\/github.com\/kaggle\/docker-python\n# For example, here's several helpful packages to load\n\nimport numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\n\n# Input data files are available in the read-only \"..\/input\/\" directory\n# For example, running this (by clicking run or pressing Shift+Enter) will list all files under the input directory\n\nimport os\nfor dirname, _, filenames in os.walk('\/kaggle\/input'):\n    for filename in filenames:\n        print(os.path.join(dirname, filename))\n\n# You can write up to 20GB to the current directory (\/kaggle\/working\/) that gets preserved as output when you create a version using \"Save & Run All\" \n# You can also write temporary files to \/kaggle\/temp\/, but they won't be saved outside of the current session","365d81f6":"pip install openpyxl","bb0ebf6d":"pip install xlrd","d10af848":"pip install lifetimes","513706bd":"# Loading the required libraries\n\nimport pandas as pd\nimport numpy as np\nimport matplotlib.pyplot as plt\nimport datetime as dt\nimport seaborn as sns\nimport missingno as msno\nfrom sklearn.preprocessing import MinMaxScaler\nfrom lifetimes import BetaGeoFitter\nfrom lifetimes import GammaGammaFitter\nfrom lifetimes.plotting import plot_period_transactions\nimport warnings\nwarnings.filterwarnings(\"ignore\")","24671637":"# Reading the online-retail-dataset\ndata = pd.read_excel(\"\/kaggle\/input\/online-retail-ii-data-set-from-ml-repository\/online_retail_II.xlsx\",\n                    sheet_name = \"Year 2009-2010\")","bca8f6eb":"# Copy dataset\ndf = data.copy()\ndf.head()","b300ce89":"# Function the checking dataset\ndef check_df(dataframe):\n    print(\"##################### Shape #####################\")\n    print(dataframe.shape)\n    print(\"##################### Types #####################\")\n    print(dataframe.dtypes)\n    print(\"##################### Head #####################\")\n    print(dataframe.head(3))\n    print(\"##################### Tail #####################\")\n    print(dataframe.tail(3))\n    print(\"##################### NA #####################\")\n    print(dataframe.isnull().sum())\n    print(\"##################### Quantiles #####################\")\n    print(dataframe.quantile([0, 0.05, 0.50, 0.95, 0.99, 1]).T)","bba0cb91":"check_df(df)","1051cf94":"# Missing value visualization\nmsno.bar(df);","e37c043d":"msno.matrix(df);","a5148b86":"# There is no specific correlation between missing values\nmsno.heatmap(df);","8411605f":"# Outlier value visualization\nsns.boxplot(df[\"Quantity\"]);","bf73bafd":"sns.boxplot(df[\"Price\"]);","b954ea82":"def outlier_thresholds(dataframe, variable):\n    # Quartiles\n    quartile1 = dataframe[variable].quantile(0.01)\n    quartile3 = dataframe[variable].quantile(0.99)\n    # IQR\n    interquantile_range = quartile3 - quartile1\n    \n    up_limit = quartile3 + 1.5 * interquantile_range\n    low_limit = quartile1 - 1.5 * interquantile_range\n    \n    return low_limit, up_limit\n\n\ndef replace_with_thresholds(dataframe, variable):\n    low_limit, up_limit = outlier_thresholds(dataframe, variable)\n    # Threshold value for upper limit\n    dataframe.loc[(dataframe[variable] > up_limit), variable] = up_limit","5bfd9a75":"# outliers values are now cleaner\ndf.describe([0.01,0.25,0.50,0.75,0.99]).T","60df56e5":"def crm_data_prep(dataframe):\n    # Drop the missing values\n    dataframe.dropna(axis=0, inplace=True)\n    # Removal of returned invoices\n    dataframe = dataframe[~dataframe[\"Invoice\"].str.contains(\"C\", na=False)]\n    # Those with a quantity value greater than zero\n    dataframe = dataframe[dataframe[\"Quantity\"] > 0]\n    # Threshold for Quantity and Price\n    replace_with_thresholds(dataframe, \"Quantity\")\n    replace_with_thresholds(dataframe, \"Price\")\n    # Multiplying quantity and price for the new column total price\n    dataframe[\"TotalPrice\"] = dataframe[\"Quantity\"] * dataframe[\"Price\"]\n    return dataframe\n\ndf = crm_data_prep(df)","f967cfb4":"sns.boxplot(df[\"Quantity\"]);","4b0caac0":"sns.boxplot(df[\"Price\"]);","ba8755d3":"check_df(df)","82ad4f8d":"df[\"InvoiceDate\"].max()","51bad2fd":"def create_rfm(dataframe):\n    # today_date\n    today_date = dt.datetime(2010, 12, 11)\n    \n    # rfm table\n    rfm = dataframe.groupby('Customer ID').agg({'InvoiceDate': lambda date: (today_date - date.max()).days,\n                                                'Invoice': lambda num: num.nunique(),\n                                                \"TotalPrice\": lambda price: price.sum()})\n    # rfm columns name\n    rfm.columns = ['recency', 'frequency', \"monetary\"]\n    \n    rfm = rfm[(rfm['monetary'] > 0)]\n    # adding recency score as a new column\n    rfm[\"recency_score\"] = pd.qcut(rfm['recency'], 5, labels=[5, 4, 3, 2, 1])\n    # adding frequency score as a new column\n    rfm[\"frequency_score\"] = pd.qcut(rfm[\"frequency\"].rank(method=\"first\"), 5, labels=[1, 2, 3, 4, 5])\n    # adding rfm_segment as a new column\n    rfm['rfm_segment'] = rfm['recency_score'].astype(str) + rfm['frequency_score'].astype(str)\n    # naming segments\n    seg_map = {\n        r'[1-2][1-2]': 'hibernating',\n        r'[1-2][3-4]': 'at_risk',\n        r'[1-2]5': 'cant_loose',\n        r'3[1-2]': 'about_to_sleep',\n        r'33': 'need_attention',\n        r'[3-4][4-5]': 'loyal_customers',\n        r'41': 'promising',\n        r'51': 'new_customers',\n        r'[4-5][2-3]': 'potential_loyalists',\n        r'5[4-5]': 'champions'\n    }\n\n    rfm['rfm_segment'] = rfm['rfm_segment'].replace(seg_map, regex=True)\n    # rfm columns name\n    rfm = rfm[[\"recency\", \"frequency\", \"monetary\", \"rfm_segment\"]]\n    return rfm","1c2ff563":"rfm = create_rfm(df)\nrfm.head()","999b0ed6":"# Rfm segments visualization\nfor col in rfm.columns[0:3]:\n    plt.figure(figsize=(15,7))\n    sns.barplot(x=\"rfm_segment\",y=col,data=rfm)\n    plt.show()","b1981632":"check_df(rfm)","76d172ce":"# CLTV calculate functions\n\ndef create_cltv_calculate(dataframe):\n    # avg_order_value\n    dataframe['avg_order_value'] = dataframe['monetary'] \/ dataframe['frequency']\n\n    # purchase_frequency\n    dataframe[\"purchase_frequency\"] = dataframe['frequency'] \/ dataframe.shape[0]\n\n    # repeat rate & churn rate\n    repeat_rate = dataframe[dataframe.frequency > 1].shape[0] \/ dataframe.shape[0]\n    churn_rate = 1 - repeat_rate\n\n    # profit_margin\n    dataframe['profit_margin'] = dataframe['monetary'] * 0.05\n\n    # Customer Value\n    dataframe['cv'] = (dataframe['avg_order_value'] * dataframe[\"purchase_frequency\"])\n\n    # Customer Lifetime Value\n    dataframe['cltv'] = (dataframe['cv'] \/ churn_rate) * dataframe['profit_margin']\n\n    # MinMaxScaler\n    scaler = MinMaxScaler(feature_range=(1, 100))\n    scaler.fit(dataframe[[\"cltv\"]])\n    dataframe[\"cltv_calculated\"] = scaler.transform(dataframe[[\"cltv\"]])\n\n    dataframe[\"cltv_calculated_segment\"] = pd.qcut(dataframe[\"cltv_calculated\"], 3, labels=[\"C\", \"B\", \"A\"])\n\n    dataframe = dataframe[[\"recency\", \"frequency\", \"monetary\", \"rfm_segment\",\n                           \"cltv_calculated\", \"cltv_calculated_segment\"]]\n\n    return dataframe","6e51f265":"rfm_cltv = create_cltv_calculate(rfm)\ncheck_df(rfm_cltv)","634ccaef":"plt.figure(figsize=(15,7))\nsns.barplot(x=\"rfm_segment\",y=\"cltv_calculated\",data=rfm_cltv);","7cf6a922":"plt.figure(figsize=(15,7));\nsns.barplot(x=\"cltv_calculated\",y=\"cltv_calculated_segment\",data=rfm_cltv);","40b2365c":"rfm_cltv.head()","aa472ba5":"# The correlation seems very weak.\n\nplt.scatter(rfm_cltv.monetary,rfm_cltv.frequency,s=75)\n\nplt.xlabel(\"monetary\")\nplt.ylabel(\"frequency\")\nplt.legend()\nplt.show()","5261a9e6":"# CLTV predict functions\n\ndef create_cltv_predict(dataframe):\n    today_date = dt.datetime(2010, 12, 11)\n\n    # recency user specific dynamic\n    rfm = dataframe.groupby('Customer ID').agg({'InvoiceDate': [lambda date: (date.max()-date.min()).days,\n                                                                lambda date: (today_date - date.min()).days],\n                                                'Invoice': lambda num: num.nunique(),\n                                                'TotalPrice': lambda TotalPrice: TotalPrice.sum()})\n    # for column name issue\n    rfm.columns = rfm.columns.droplevel(0)\n\n    # recency_cltv_predict\n    rfm.columns = ['recency_cltv_predicted', 'T', 'frequency', 'monetary']\n\n    # calculation of monetary_avg\n    rfm[\"monetary\"] = rfm[\"monetary\"] \/ rfm[\"frequency\"]\n    rfm.rename(columns={\"monetary\": \"monetary_avg\"}, inplace=True)\n\n\n    # for BG-NBD model calculation of weekly recency and weekly T\n    # recency_weekly_cltv_p\n    rfm[\"recency_weekly_cltv_predicted\"] = rfm[\"recency_cltv_predicted\"] \/ 7\n    rfm[\"T_weekly\"] = rfm[\"T\"] \/ 7\n\n\n\n    # Control monetary_avg values\n    rfm = rfm[rfm[\"monetary_avg\"] > 0]\n\n    # recency filter -for a smoother cltvp account-\n    rfm = rfm[(rfm['frequency'] > 1)]\n\n    rfm[\"frequency\"] = rfm[\"frequency\"].astype(int)\n\n    # BG-NBD\n    bgf = BetaGeoFitter(penalizer_coef=0.01)\n    bgf.fit(rfm['frequency'],\n            rfm['recency_weekly_cltv_predicted'],\n            rfm['T_weekly'])\n\n\n    # expected_average_profit\n    ggf = GammaGammaFitter(penalizer_coef=0.01)\n    ggf.fit(rfm['frequency'],\n            rfm['monetary_avg'])\n    rfm[\"expected_average_profit\"] = ggf.conditional_expected_average_profit(rfm['frequency'],\n                                                                             rfm['monetary_avg'])\n    # 6 month cltv_predict\n    cltv = ggf.customer_lifetime_value(bgf,\n                                       rfm['frequency'],\n                                       rfm['recency_weekly_cltv_predicted'],\n                                       rfm['T_weekly'],\n                                       rfm['monetary_avg'],\n                                       time=6,\n                                       freq=\"W\",\n                                       discount_rate=0.01)\n\n    rfm[\"cltv_predicted\"] = cltv\n\n    # MinMaxScaler\n    scaler = MinMaxScaler(feature_range=(1, 100))\n    scaler.fit(rfm[[\"cltv_predicted\"]])\n    rfm[\"cltv_predicted\"] = scaler.transform(rfm[[\"cltv_predicted\"]])\n\n    # cltv_predict_segments\n    rfm[\"cltv_predicted_segment\"] = pd.qcut(rfm[\"cltv_predicted\"], 3, labels=[\"C\", \"B\", \"A\"])\n\n    ## recency_cltv_p, recency_weekly_cltv_p\n    rfm = rfm[[\"recency_cltv_predicted\", \"T\", \"monetary_avg\", \"recency_weekly_cltv_predicted\", \"T_weekly\",\n              \"expected_average_profit\",\n               \"cltv_predicted\", \"cltv_predicted_segment\"]]\n\n\n    return rfm","331127d4":"rfm_cltv_predicted = create_cltv_predict(df)\ncheck_df(rfm_cltv_predicted)","9def4ecc":"rfm_cltv_predicted.head()","98acc861":"rfm_cltv_predicted.groupby('cltv_predicted_segment').agg('expected_average_profit').mean().plot(kind='bar', colormap='copper_r');\nplt.ylabel(\"profit\");","6d47d98b":"crm_final = rfm_cltv.merge(rfm_cltv_predicted, on=\"Customer ID\", how=\"left\")\ncheck_df(crm_final)","f45616c9":"# will be effective in campaign decisions\n\ncrm_final.sort_values(by=\"monetary_avg\", ascending=False).head()","9f9b788f":"crm_final.sort_values(by=\"cltv_predicted\", ascending=False).head()","c11b10ee":"<a id = \"16\"><\/a><br>\n<font color = '#F1C40F'>\n\n### And finally CRM!","a431dc3f":"<a id = \"17\"><\/a><br>\n<font color = '#34495E'>\n\n## Final\n\n**So we can analyze each metric comparatively.**\n\n**We can make different decisions for customers in different segments.**\n\n**We can make different campaigns according to the decisions taken.**\n\n**After that, the productivity of the campaign can be measured by making different offers to the masses.**\n\n**A\/B test can be used for this.**","93c689cb":"<font color = '#34495E'>\n\n**Now, we are creating RFM.**\n    \n<a id = \"11\"><\/a><br>\n\n## **What is RFM?**\n<p><img style=\"float: right;margin:-10px 20px 20px 5px; max-width:380px\" src=\"https:\/\/d35fo82fjcw0y8.cloudfront.net\/2018\/03\/01013508\/Incontent_image.png\"><\/p>\n\n**<p>RFM represents a method used for measuring customer value. An RFM analysis can show you who are the most valuable customers for your business. The ones who buy most frequently, most often, and spend the most. First of all, the metrics you have seen are calculated**\n","d08a2fb3":"<a id = \"7\"><\/a><br>\n<font color = '#F1C40F'>\n# Data Preprocessing","1783245d":"<a id = \"15\"><\/a><br>\n<font color = '#F1C40F'>\n\n## CLTV Predict","c32b6cae":"<a id = \"6\"><\/a><br>\n<font color = '#F1C40F'>\n\n# Load Dataset","5c641ff3":"![](https:\/\/miro.medium.com\/max\/1234\/0*JJBP4ToZiaw0HVPN.png)","ce9489cf":"<font color = '#34495E'>\n    \n\n**This time we divided people into A, B, C segments. (Not to be confused with rfm segmentation.) Let's remember we do life-time value calculations.**\n\n**The calculations in the table have been made.**\n\n**Standardization process was done for better understanding**","5e93ad97":"<font color = '#D35400'>\n    \n**Missing values are deleted. Canceled Invoices are not received and and a new variable was created.**","fcfe2fe9":"<font color = '#34495E'>\n<a id = \"2\"><\/a><br>\n\n### **What is CRM?**\n\nCustomer relationship management (CRM) is the combination of practices, strategies and technologies that companies use to manage and analyze customer interactions and data throughout the customer lifecycle.CRM targets to gain new customers other than existing customers.With CRM software, the customer feels special, so dependency occurs for the company or product.In this study, we will create CRM by making RFM and then CLTV.\n\n<font color = '#34495E'>\n<a id = \"3\"><\/a><br>\n\n### **What is the purpose?**\n\nIn this notebook, we will create CRM by making RFM and then CLTV.\n\n<font color = '#34495E'>\n<a id = \"4\"><\/a><br>\n\n### **Content of Dataset**\n\nThis Online Retail II data set contains all the transactions occurring for a UK-based and registered, non-store online retail between 01\/12\/2009 and 09\/12\/2011.The company mainly sells unique all-occasion gift-ware. Many customers of the company are wholesalers.\n\n<font color = '#34495E'>\n<a id = \"5\"><\/a><br>\n\n### **Attribute Information:**\n\n**InvoiceNo**: Invoice number. If this code starts with the letter 'c', it indicates a cancellation.\n\n**StockCode**: Product code. Description: Product name. Quantity: The quantities of each product per transaction.\n\n**InvoiceDate**: Invoice date and time.The day and time when a transaction was generated.\n\n**UnitPrice**: Unit price. Product price per unit in sterling.\n\n**CustomerID**: Customer number.A 5-digit integral number uniquely assigned to each customer.\n\n**Country**: Country name. The name of the country where a customer resides.","6351d7a6":"<a id = \"13\"><\/a><br>\n<font color = '#F1C40F'>\n\n# CLTV Calculate","c0600713":"<a id = \"18\"><\/a><br>\n<font color = '#34495E'>\n \n\n### **What is a cohort model?**\n    \n**Instead of simply assuming all the customers to be one group, we can try to split them into multiple groups and calculate the CLTV for each group.**\n\n**Note: recency value customized. (One of the key differences between RFM and CLTV)**","b881efa0":"<a id = \"14\"><\/a><br>\n<font color = '#34495E'>\n\n<p><img style=\"float: right;margin:-10px 20px 20px 5px; max-width:380px\" src=\"https:\/\/www.surveysensum.com\/wp-content\/uploads\/2019\/11\/customer-lifetime-Value-SurveySensum.png\"><\/p>\n\n## What is Customer Lifetime Value(CLV or CLTV)?\n\n**Customer lifetime value is how much money a customer will bring your brand throughout their entire time as a paying customer.It is the monetary value that a customer will give to a company during its relationship-communication with a company.**\n\n**In fact, it is to be able to extract the future situation from the current situation of the customer.**\n\n**For this we will first make a simple calculation and then we will add the time factor.**","1e9bce56":"<font color = '#FF7F50'>\n    \nContent:\n    \n1. [Customer Relationship Management (CRM)](#1)\n    * [What is CRM?](#2)\n    * [What is the purpose?](#3)\n    * [Content of Dataset](#4)\n    * [Attribute Information](#5)\n2. [Load Dataset](#6)\n3. [Data Preprocessing](#7)\n    * [Outliers](#8)\n    * [Thresholds](#9)\n4. [RFM](#10)\n    * [What is RFM?](#11)\n    * [RFM Segments](#12)\n5. [CLTV Calculate](#13)\n    * [What is Customer Lifetime Value(CLV or CLTV)?](#14)\n6. [CLTV Predict](#15)\n    * [What is a cohort model?](#18)\n    * [BG-NBD](#19)\n    * [Gamma Gamma](#20)\n7. [And Finally CRM](#16)\n8. [Final](#17)","34b08027":"<a id = \"10\"><\/a><br>\n<font color = '#F1C40F'>\n\n# RFM ","9daf9376":"<a id = \"9\"><\/a><br>\n<font color = '#D35400'>\n### Thresholds\n\n**Outlier values are trimmed (very little) without damaging the data.Here we have set a lower and upper limit. But since the lower limit is set, we'll only assign it to the upper limit. We'll do it for Quantity and Price.**","ea363e05":"<a id = \"8\"><\/a><br>\n<font color = '#D35400'>\n### Outliers\n\n**Check out descriptive statistics of numerical variables. See the difference between 75% and 99% values and then See the difference between 99% and max values. We can think that there are some outliers.**","143ae55d":"<a id = \"19\"><\/a><br>\n<font color = '#34495E'>\n    \n### BG-NBD\n**-Beta Geometric Negative Binominal Distribution-**\n\n**In short, expected sales value. Used to estimate how many purchases customers can make over a period of time**\n\n**This method computes the probability that a customer with history (frequency, recency_weekly, T_weekly) is currently alive.(relationship between recency & frequency)**","86c05aeb":"<a id = \"20\"><\/a><br>\n<font color = '#34495E'>\n    \n\n### Gamma Gamma\n**-conditional expected number of purchases up to time-**\n\n**Note1: There should be no correlation between the frequency of transactions and their monetary value.**\n\n**Note2: We are considering only customers who made repeat purchases with the business i.e., frequency > 0. Because, if the frequency is 0, it means that they are a one-time customer and are considered already dead.**","4fbf7081":"<font color = '#34495E'>\n\n**Then segments are created.**\n\n**So why are we doing this?**\n\n**We look for answers to these questions;**\n\n**-Who is our most profitable customer? -What is it they appreciate in my products or services? -Who are my new customers? -How do I attract new customers to the company?**\n\n**The answers to the questions are hidden in the segmentation.**\n\n**With better RFM segmentation, we\u2019ll be able to address certain segments in a personalized manner, based on their needs and preferences.**\n\n**Browse the scheme to more easily understand segmentation.**\n","d81d03bc":"![](http:\/\/)","28bc6684":"<a id = \"1\"><\/a><br>\n<font color = '#F1C40F'>\n# **Customer Relationship Management (CRM)**\n<img style=\"float: margin:1000px 50px 50px 1px; max-width:500px\" src=\"https:\/\/previews.123rf.com\/images\/wrightstudio\/wrightstudio1706\/wrightstudio170604163\/80553736-crm-customer-relationship-management-concept-customer-service-and-relationship-.jpg\">\n","fbd5cfd9":"<a id = \"12\"><\/a><br>\n<font color = '#F1C40F'>\n\n## RFM Segments"}}