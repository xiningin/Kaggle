{"cell_type":{"df2be266":"code","443fef18":"code","08ae25a7":"code","5176c084":"code","f7c3a67a":"code","a2f096b4":"code","d4ad24ba":"code","a5e4d024":"code","be4b221b":"code","ae36b91a":"code","92ac4912":"code","9d820b45":"code","aa31fa22":"code","26f7f26f":"code","9e1dff55":"code","f2726898":"code","f17c9890":"code","88df06d4":"code","7f49c625":"code","f9127875":"code","ebd39a91":"code","3a71c32a":"code","df138c63":"code","f1c9d4fe":"code","3302da10":"markdown","b04037ff":"markdown","5cc5ed8d":"markdown","62c719ca":"markdown","dfe1eda7":"markdown","3700879b":"markdown","34842988":"markdown"},"source":{"df2be266":"%config Completer.use_jedi = False","443fef18":"%%capture\n!cp -r \/kaggle\/input\/label-assignment-nfl\/label_assignment\/gmmreg-install \/kaggle\/working\/gmmreg-install\n%cd \/kaggle\/working\/gmmreg-install\/src\n!python setup.py install --user\n%cd \/kaggle\/working\n%rm -r \/kaggle\/working\/gmmreg-install","08ae25a7":"%%capture\n!cp -r \/kaggle\/input\/nfl-yolov5-models-v2\/yolov5 \/kaggle\/working\/yolov5","5176c084":"import os\nimport sys\n\nfrom tqdm.notebook import tqdm\nimport pandas as pd","f7c3a67a":"is_sub = len(os.listdir('\/kaggle\/input\/nfl-health-and-safety-helmet-assignment\/test')) != 6","a2f096b4":"# N_VIDEOS = 6\ndeepsort_cfg = {\n    'model_path': '\/kaggle\/input\/deepsort-nfl-models\/deepsort_nfl_v2.pth',\n    'max_dist': 0.05,\n    'min_confidence': 0.35,\n    'max_iou_distance': 0.6,\n    'max_age': 30,\n    'n_init': 1,\n    'nn_budget': 80,\n}\nlabeler_cfg_Endzone = {\n    'level': 3, \n    'scales':  [1, 0.2, 0.1], \n    'lambdas': [0.1, 0.04, 0.02], \n    'iters':   [30, 20, 10],\n    'n_grid': 5\n}\nlabeler_cfg_Sideline = {\n    'level': 3, \n    'scales':  [1, 0.5, 0.25], \n    'lambdas': [1, 0.02, 0.25], \n    'iters':   [30, 20, 10],\n    'n_grid': 5\n}\nvideos = os.listdir('\/kaggle\/input\/nfl-health-and-safety-helmet-assignment\/test')#[:N_VIDEOS]\nvideos = list(map(lambda x: x.split('.')[0], videos))\nvideos.sort()\nbase_video_dir = '\/kaggle\/input\/nfl-health-and-safety-helmet-assignment\/test'","d4ad24ba":"YOLO_WEIGHTS = [\n    '\/kaggle\/input\/nfl-yolov5-models-v2\/artifacts\/run_183sllab_model:v0\/best.pt',\n    '\/kaggle\/input\/nfl-yolov5-models-v2\/artifacts\/run_3fc0fdzr_model:v0\/best.pt',\n    '\/kaggle\/input\/nfl-yolov5-models-v2\/artifacts\/run_1nqxdcxw_model:v0\/best.pt', # yolov5x6_FOLD01 (validated on folds 0 and 1)\n    '\/kaggle\/input\/nfl-yolov5-models-v2\/artifacts\/run_m24omzoc_model:v0\/best.pt', # yolov5x6_FOLD40 (validated on folds 2 and 3)\n    '\/kaggle\/input\/nfl-yolov5-models-v2\/artifacts\/run_3pena160_model:v0\/best.pt', # yolov5x6_FOLD40 (validated on folds 0 and 4)\n]","a5e4d024":"%cd yolov5\nimport glob\nfrom pathlib import Path\nall_detections = []\nfor weights in YOLO_WEIGHTS:\n    bboxes = []\n    for video in tqdm(glob.glob(\"\/kaggle\/input\/nfl-health-and-safety-helmet-assignment\/test\/*.mp4\")):\n        !python detect.py --weights $weights --img 1280 --conf 0.25 --save-txt --save-conf --source $video > \/dev\/null 2>&1\n        for file in glob.glob(\"runs\/detect\/exp\/labels\/*.txt\"):\n            bbox = pd.read_csv(file, sep = ' ', names = ['class', 'xc', 'yc', 'w', 'h', 'conf']).drop('class', axis = 1)\n            bbox['video_frame'] = Path(file).stem\n            bboxes.append(bbox)\n        !rm -r runs\/detect\/exp\n    bboxes = pd.concat(bboxes)\n    bboxes['left'] = ((bboxes['xc'] - bboxes['w']\/2) * 1280).astype(int)\n    bboxes['top'] = ((bboxes['yc'] - bboxes['h']\/2) * 720).astype(int)\n    bboxes['width'] = (bboxes['w'] * 1280).astype(int)\n    bboxes['height'] = (bboxes['h'] * 720).astype(int)\n    all_detections.append(bboxes)\n%cd ..","be4b221b":"# all_detections = [bboxes]","ae36b91a":"# files = [\n#     '\/kaggle\/input\/nfl-csv-dataset\/yolov5s6_run_2tasc22q_F0.csv',\n#     '\/kaggle\/input\/nfl-csv-dataset\/yolov5s6_run_29r299qh_F1.csv',\n#     '\/kaggle\/input\/nfl-csv-dataset\/yolov5s6_run_3skk47rd_F2.csv',\n#     '\/kaggle\/input\/nfl-csv-dataset\/yolov5s6_run_20f824im_F4.csv'\n# ]\n# all_detections = []\n# for i, file in enumerate(files):\n#     det = pd.read_csv(file).rename(columns = {'w':'width', 'h':'height'})\n#     det = det[det['video_frame'].apply(lambda x: '_'.join(x.split('_')[:-1])).isin(videos)].copy()                                \n#     all_detections.append(det)","92ac4912":"sys.path.append(\"\/kaggle\/input\/weighted-boxes-fusion-nfl\")\nfrom ensemble_boxes.ensemble_boxes_wbf import weighted_boxes_fusion\nfrom nfl_wbf.utils import *","9d820b45":"all_detections = preprocess_detection_list(all_detections)\ndetections = fuse(all_detections, weighted_boxes_fusion, iou_thr=0.55) #change the name to fuse\ndetections = x1y1x2y2_to_ltwh(denormalize(detections))\ndetections.to_csv('detections.csv')","aa31fa22":"sys.path.append('\/kaggle\/input\/deepsort-nfl')\nfrom deepsort.sort import sort_bboxes","26f7f26f":"# sort_bboxes inputs bboxes for a single video \n# with the columns ['video_frame', 'left', 'width', 'top', 'height', 'conf']\n# and the base dir for the videos (train\/test) and hyper_params\n# it outputs a dataframe with the columns\n# ['video_frame', 'id', 'left', 'width', 'top', 'height']\n\n## Expand height for better tracking\ndetections['height'] = detections['height']*2\ndetections['video'] = detections['video_frame'].apply(lambda x: '_'.join(x.split('_')[:-1]))\ndetections = detections.set_index('video')\n\ntracked_detections = []\nfor video in tqdm(videos):\n    bboxes_video = detections.loc[video].reset_index(drop = True)\n    tracked_detections.append(sort_bboxes(bboxes_video, base_video_dir, **deepsort_cfg))\ntracked_detections = pd.concat(tracked_detections).reset_index()\ntracked_detections['height'] = tracked_detections['height']\/\/2\ntracked_detections.to_csv('tracked_detections.csv')","9e1dff55":"sys.path.append(\"\/kaggle\/input\/label-assignment-nfl\")\nfrom label_assignment.all import *\nfrom label_assignment.helmet_assignment.score import NFLAssignmentScorer\nfrom label_assignment.helmet_assignment.video import video_with_predictions","f2726898":"# from gmmreg._core import run_multi_level\n# from functools import partial\n# import numpy as np\n# class Register():\n#     def __init__(self, algo = 'gmmreg', **kwargs):\n#         if algo == 'gmmreg':\n#             if 'n_grid' in kwargs:\n#                 n_grid = kwargs.pop('n_grid')\n#                 grid = np.linspace(-2, 2, n_grid)\n#                 self.grid = np.array(np.meshgrid(grid, grid)).T.reshape(-1,2)\n#             else:\n#                 self.grid = None\n#             self.algo = partial(run_multi_level, **kwargs)\n#         else:\n#             raise ValueError('Only gmmreg is implemented')\n#     def __call__(self, src, trg):\n#         if self.grid is None: grid = src\n#         else: grid = self.grid\n#         return self.algo(src, trg, grid)","f17c9890":"labeler_cfg_Endzone = {\n    'level': 3, \n    'scales':  [1, 0.2, 0.1], \n    'lambdas': [0.1, 0.04, 0.02], \n    'iters':   [30, 20, 10],\n    'n_grid': 5\n}\n# reg_gmm_Endzone = Register(**labeler_cfg_Endzone)\nlabeler_cfg_Sideline = {\n    'level': 3, \n    'scales':  [1, 0.2, 0.1], \n    'lambdas': [0.1, 0.04, 0.02], \n    'iters':   [30, 20, 10],\n    'n_grid': 5\n}\n# reg_gmm_Sideline = Register(**labeler_cfg_Sideline)","88df06d4":"# def match_videoV2(dl, theta, video):\n#     video_dist = []\n#     for frame in dl.frames:\n#         xy_video, xy_tracking, labels_video, labels_tracking = dl(frame) \n#         xy_tracking = normalize(xy_tracking)\n#         xy_video = normalize(xy_video)\n#         xy_video = rotate(xy_video, theta)\n#         if frame == 1:\n#             _xy_video = xy_tracking\n#         if 'Sideline' in video:\n#             xy_video = reg_gmm_Sideline(xy_video, _xy_video)\n#         else:\n#             xy_video = reg_gmm_Endzone(xy_video, _xy_video)\n\n#         dist = cdist(xy_video, xy_tracking)\n#         M = linear_sum_assignment(dist)\n#         _xy_video = xy_tracking[M[1]]\n        \n#         cost = 1\/dist[M].mean()\n#         dist = label_matrix(dist, labels_video, labels_tracking)\n#         video_dist.append(dist * cost)\n#     return video_dist ","7f49c625":"def track2sub(dl, video, **kwargs):\n    theta = estimate_theta(dl, **kwargs)\n    video_dist = match_videoV2(dl, theta, video)\n    video_agg_dist = pd.concat(video_dist).groupby(level=0).agg('mean')\n    video_labels, idx_video = assign_labels(dl, video_agg_dist)\n    video_sub = build_submission_for_video(dl, video_labels, idx_video)\n    return video_sub, theta","f9127875":"# the input of DataLoader must be a dataframe of columns \n# video_frame, id, left, width, top, height\n# it doesn't remove any boxes by default, to limit top 22, set 'top22 = True'\n# Set is_train = True to load train track data and False to load test track data\n\ndl = DataLoader(tracked_detections, is_train = False)\n\nsubmission = []\nfor video in tqdm(dl.videos):\n\n    ## Filtering the dataloader to return the data of a single video\n    dl.filter_video(video = video)\n\n    ## generating submission for a single video\n    if 'Sideline' in video:\n        video_sub, theta = track2subV2(dl, video, **labeler_cfg_Sideline)\n    else:\n        video_sub, theta = track2subV2(dl, video, **labeler_cfg_Endzone)\n    submission.append(video_sub)\n\nsubmission = pd.concat(submission)","ebd39a91":"sys.path.append(\"\/kaggle\/input\/label-assignment-nfl\")\nfrom label_assignment.utils import fix_submission","3a71c32a":"submission_fixed = fix_submission(submission)\nsubmission_fixed.to_csv(index = False)\nsubmission_fixed.to_csv('submission.csv', index = False)\nsubmission_fixed","df138c63":"if not is_sub:\n    gt_labels = pd.read_csv('\/kaggle\/input\/nfl-health-and-safety-helmet-assignment\/train_labels.csv')\n    for video in tqdm(videos):\n        scorer = NFLAssignmentScorer(gt_labels.query(f'video == \"{video}.mp4\"'))\n        print(f'Score for Video {video:>21}: {scorer.score(submission_fixed):5.3f}')","f1c9d4fe":"!rm -r \/kaggle\/working\/yolov5","3302da10":"## Fix sub","b04037ff":"## Debug","5cc5ed8d":"# Inference","62c719ca":"## Tracking with DeepSort","dfe1eda7":"## Box Fusion","3700879b":"## Label Assignment","34842988":"## Detection with YoloV5"}}