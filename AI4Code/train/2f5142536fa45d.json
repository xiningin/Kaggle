{"cell_type":{"d0720d3d":"code","aa7526f9":"code","5dfcb650":"code","0a8e8e63":"code","16f3ac6d":"code","6045540b":"code","c98ad738":"code","f8166e20":"code","6324e676":"code","6d0a831f":"code","fa0a3c67":"code","3601458d":"code","0ad3713e":"code","22342da6":"code","ed23c27b":"code","36637ac4":"code","ad5d18a9":"code","dafa52b9":"code","06dc1e66":"code","301701b6":"code","79184521":"code","128cc09f":"code","eb6a70b0":"code","e0f6c523":"code","b0a14e4f":"code","af705f03":"code","9e319cfb":"code","9c93e994":"code","75e8df28":"code","f69692f2":"code","585f9c34":"markdown","504e5463":"markdown","ce201f88":"markdown","dc1d9793":"markdown","f995706a":"markdown","50c94ca7":"markdown","82d820ce":"markdown","4b5981f9":"markdown","be5b996b":"markdown","7383be38":"markdown","48bc0ecf":"markdown","5939cd7c":"markdown","de17bc98":"markdown","3df9695f":"markdown","bababe25":"markdown","13082d1d":"markdown","607017ee":"markdown","79778b8a":"markdown","ff564c13":"markdown","461403f8":"markdown","154080b3":"markdown","280ee543":"markdown","27f50e82":"markdown"},"source":{"d0720d3d":"#loading libraries\nimport numpy as np\nimport pandas as pd\n\nimport os\n\nimport seaborn as sns\nimport matplotlib.pyplot as plt\nimport matplotlib.ticker as ticker\n\nimport timeit\n\n%matplotlib inline","aa7526f9":"#load data\ndata = pd.read_csv(r\"..\/input\/telco-customer-churn\/WA_Fn-UseC_-Telco-Customer-Churn.csv\")\n#first few rows\ndata.head()","5dfcb650":"data.info()","0a8e8e63":"#Unique values in each attribute\nfor item in data.columns:\n    print(f\"Unique {item}'s count: {data[item].nunique()}\")\n    print(f\"{data[item].unique()}\\n\\n\")","16f3ac6d":"catCols = [\"gender\", \"SeniorCitizen\", \"Partner\", \"Dependents\", \"PhoneService\", \"InternetService\", \n           \"OnlineSecurity\", \"OnlineBackup\", \"DeviceProtection\", \"TechSupport\", \"StreamingTV\", \n           \"StreamingMovies\", \"Contract\", \"PaperlessBilling\", \"PaymentMethod\", \"Churn\"]\ndata[catCols] = data[catCols].astype('category') # change columns to type category\n\ndata[\"tenure\"] = data[\"tenure\"].astype('int64') # change columns to type int64\n\n# Converting totalcharges column to float gives an error, lets find out why\n# data[\"TotalCharges\"] = data[\"TotalCharges\"].astype('float64') # change columns to type float64\n","6045540b":"tCharges = data.sort_values('TotalCharges')\ntCharges['TotalCharges'].head(20)","c98ad738":"#convert empty strings to NAN (actually there is one space)\ndata['TotalCharges'] = data[\"TotalCharges\"].replace(\" \",np.nan)\n\n#remove nulls and reset index\ndata = data[data[\"TotalCharges\"].notnull()]\ndata = data.reset_index()[data.columns]\n\n#convert to float64\ndata[\"TotalCharges\"] = data[\"TotalCharges\"].astype(float)","f8166e20":"colsForReplacement = [ 'OnlineSecurity', 'OnlineBackup', 'DeviceProtection',\n                'TechSupport','StreamingTV', 'StreamingMovies']\n\nfor colName in colsForReplacement:\n    data[colName] = data[colName].replace({'No internet service' : 'No'})","6324e676":"data[\"SeniorCitizen\"] = data[\"SeniorCitizen\"].replace({1:\"Yes\",0:\"No\"})","6d0a831f":"#lets convert the types again as we did alot of changes and they reverted back to `object` type\ncatCols = [\"gender\", \"SeniorCitizen\", \"Partner\", \"Dependents\", \"PhoneService\", \"InternetService\", \"OnlineSecurity\", \n           \"OnlineBackup\", \"DeviceProtection\", \"TechSupport\", \"StreamingTV\", \"MultipleLines\",\n           \"StreamingMovies\", \"Contract\", \"PaperlessBilling\", \"PaymentMethod\", \"Churn\"]\ndata[catCols] = data[catCols].astype('category') # change columns to type category\n\n# Converting totalcharges column to float gives an error, lets find out why\ndata[\"TotalCharges\"] = data[\"TotalCharges\"].astype('float64') # change columns to type float64\n\n# data[\"Churn\"] = data[\"Churn\"].astype('bool')","fa0a3c67":"fig = plt.figure(figsize=(20,5))\n\nfig.add_subplot(131)\nsns.boxplot(data=data, y=\"tenure\", color=\"#8da0cb\")\nsns.color_palette(\"BuGn_r\")\nfig.add_subplot(132)\nsns.boxplot(data=data, y=\"MonthlyCharges\", color=\"#fc8d62\")\n\nfig.add_subplot(133)\nsns.boxplot(data=data, y=\"TotalCharges\", color=\"#66c2a5\")","3601458d":"services = ['PhoneService','MultipleLines','InternetService','OnlineSecurity', 'OnlineBackup',\n            'DeviceProtection','TechSupport','StreamingTV','StreamingMovies']\n\nfig = plt.figure(figsize=(20,15))\nplt.subplots_adjust(hspace=0.35)\n\nfor i, item in enumerate(services, 1):\n    fig.add_subplot(3,3,i)\n    plt.title(f'{item} Counts', fontsize=17)\n    sns.countplot(data=data, x=item)\n","0ad3713e":"#split churned and didnt churn\nchurn = data[data['Churn']=='Yes']\nno_churn = data[data['Churn']=='No']\n\n#Separating catagorical, numerical, target & id columns\nid_col = ['customerID']\ntarget_col = ['Churn']\nnum_cols = ['tenure', 'MonthlyCharges', 'TotalCharges']\ncat_cols   = [x for x in data.columns if x not in num_cols + ['Churn', 'customerID']]","22342da6":"#function to plot count barcharts for all categorical attributes\ndef drawBar(churn, no_churn, column):  \n    fig = plt.figure(figsize=(13,4.5))\n    plt.subplots_adjust(hspace=0.25)\n    \n    def bar_subplot(is_churn=True):\n        #assign variables based on is_churn\n        data, plot = [churn, '121'] if is_churn else [no_churn, '122']\n        title = f'Churn - {column}' if is_churn else f'No Churn - {column}'\n        data_vals = data[column].value_counts().sort_values()\n        \n        fig.add_subplot(plot)\n        plt.title(title, fontsize=17)\n        if(column == 'PaymentMethod'): plt.xticks(rotation=20)\n        for i, item in enumerate(data_vals):\n            plt.text(i, item+data_vals.max()*.018, \"{:0.2f}%\".format(item\/data_vals.sum()*100), \n                     horizontalalignment='center', verticalalignment='center',color='black')\n        sns.countplot(data=data, x=column, order=data[column].value_counts(ascending=True).index)\n    \n    bar_subplot(True)\n    bar_subplot(False)    ","ed23c27b":"#plot counts of churned and didnt churn\ntotal_churn_vals = data['Churn'].value_counts().sort_values()\n\nplt.figure(figsize=(13,4.5))\nplt.title('Total Customer Churn', fontsize=17)\nplt.text(0,total_churn_vals[0]+80, \"{:0.2f}%\".format(total_churn_vals[0]\/total_churn_vals.sum()*100), \n         horizontalalignment='center', verticalalignment='center', color='black')\nplt.text(1,total_churn_vals[1]+80 , \"{:0.2f}%\".format(total_churn_vals[1]\/total_churn_vals.sum()*100), \n         horizontalalignment='center', verticalalignment='center', color='black')\n# plt.axis('off')\nsns.countplot(data=data, x='Churn')\n\n#Plot all catagorical variables distribution\nfor colName in cat_cols:\n    drawBar(churn, no_churn, colName)","36637ac4":"fig = plt.figure(figsize=(20,5))\n\nfig.add_subplot(131)\nsns.boxplot(data=data, x=\"Churn\", y=\"tenure\", palette=[\"#8da0cb\", \"#fc8d62\"])\n\nfig.add_subplot(132)\nsns.boxplot(data=data, x=\"Churn\", y=\"MonthlyCharges\", palette=[\"#8da0cb\", \"#fc8d62\"])\n\nfig.add_subplot(133)\nsns.boxplot(data=data, x=\"Churn\", y=\"TotalCharges\", palette=[\"#8da0cb\", \"#fc8d62\"])","ad5d18a9":"numCorr = data[num_cols].corr()\nplt.title('Correlation Numerical Variables', fontsize=14)\nsns.heatmap(numCorr, annot=True, square=True,fmt='.2f', cmap = 'Blues')","dafa52b9":"def plot_dist(churn, no_churn, attr):\n    f, axes = plt.subplots(1, 3, figsize=(20, 5), sharex=True) \n    ax1=sns.distplot(churn[attr] , color=\"skyblue\", ax=axes[0], bins=30,\n                     hist_kws=dict(edgecolor=\"skyblue\", linewidth=2)) \n\n    ax2=sns.distplot(no_churn[attr] , color=\"gold\", ax=axes[1], bins=30,\n                     hist_kws=dict(edgecolor=\"gold\", linewidth=2))\n\n    ax3=sns.kdeplot(churn[attr] , color=\"skyblue\", ax=axes[2], legend=False)\n    ax3=sns.kdeplot(no_churn[attr] , color=\"gold\", ax=axes[2], legend=False)\n    ax3.set_xlabel(attr)\n    \n    sns.despine(top=True, right=True)\n    f.text(0.07, 0.5, 'Frequency', va='center', rotation='vertical')\n    f.suptitle(f'{attr} Histogram', fontsize=14)\n    f.legend(labels=['Churn','No Churn'], loc=1, borderaxespad=7)\n\nplot_dist(churn, no_churn, \"tenure\")\nplot_dist(churn, no_churn, \"MonthlyCharges\")\nplot_dist(churn, no_churn, \"TotalCharges\")","06dc1e66":"sns.pairplot(data[num_cols+[\"Churn\"]], hue=\"Churn\", height=5.5,diag_kind=\"kde\")","301701b6":"#break tenure by 12 month margins (yearly)\nreplace_tenure = [(range(0,12), '0-12'),(range(12,24), '12-24'),(range(24,48), '24-48'),(range(48,60), '48-60'),(range(60,73), '60+')]\ndata[\"grouped_tenure\"] = data['tenure']\nfor i, x in replace_tenure:\n    data[\"grouped_tenure\"].replace(i, x, inplace=True)","79184521":"plt.figure(figsize=(20,5))\nplt.title('Tenure (Grouped) Churn Comparison', fontsize=14)\nsns.countplot(data=data, x='grouped_tenure',hue='Churn', order=sorted(data['grouped_tenure'].value_counts().index))","128cc09f":"avg_tenure_group = data.groupby([\"grouped_tenure\",\"Churn\"])[[\"MonthlyCharges\",\"TotalCharges\"]].mean().reset_index()\navg_tenure_group","eb6a70b0":"fig = plt.figure(figsize=(20,10))\nplt.subplots_adjust(hspace=0.35)\n\n\nfig.add_subplot(211)\nplt.title('Avg Monthly Charges by Tenure', fontsize=14)\nsns.barplot(data=avg_tenure_group, x='grouped_tenure',y='MonthlyCharges',hue='Churn', \n            order=sorted(avg_tenure_group['grouped_tenure'].value_counts().index))\nplt.legend(fontsize=14, title_fontsize=14, title ='Churn')\n\nfig.add_subplot(212)\nplt.title('Avg Total Charges by Tenure', fontsize=14)\nsns.barplot(data=avg_tenure_group, x='grouped_tenure',y='TotalCharges',hue='Churn', \n            order=sorted(avg_tenure_group['grouped_tenure'].value_counts().index))\nplt.legend(fontsize=14, title_fontsize=14, title ='Churn')\n\nsns.despine()","e0f6c523":"data","b0a14e4f":"from sklearn.preprocessing import LabelEncoder\nfrom sklearn.preprocessing import StandardScaler\n\n\n#Add grouped tenure to cat_cols\nif ('grouped_tenure' not in cat_cols):\n    cat_cols.append('grouped_tenure')\n    \n#Binary columns with 2 values\nbin_cols   = data.nunique()[data.nunique() == 2].keys().tolist()\n#Columns more than 2 values\nmulti_cols = [i for i in cat_cols if i not in bin_cols]\n\n#Label encoding Binary columns\nle = LabelEncoder()\nfor i in bin_cols :\n    data[i] = le.fit_transform(data[i])\n    \n#Duplicating columns for multi value columns\ndata = pd.get_dummies(data = data,columns = multi_cols )\n\n#Scaling Numerical columns between 0,1\n# scaled = MinMaxScaler(feature_range = (0,1))\n# scaled.fit(data[num_cols])\n# scaled = pd.DataFrame(scaled.transform(data[num_cols]),columns=num_cols)\n\n#Scaling Numerical columns with mean 0 (better accuracy than MinMaxScaler)\nstd = StandardScaler()\nscaled = std.fit_transform(data[num_cols])\nscaled = pd.DataFrame(scaled,columns=num_cols)\n\n#dropping original values merging scaled values for numerical columns\ndf_telcom_og = data.copy()\ndata = data.drop(columns = num_cols,axis = 1)\ndata = data.merge(scaled,left_index=True,right_index=True,how = \"left\")","af705f03":"def data_prediction_plot(logit,train_x,test_x,train_y,test_y, cols, cf = 'coefficients'):\n    logit.fit(train_x,train_y.values.ravel())\n    predictions   = logit.predict(test_x)\n    probabilities = logit.predict_proba(test_x)\n    \n    if   cf == \"coefficients\" :\n        coefficients  = pd.DataFrame(logit.coef_.ravel())\n    elif cf == \"features\" :\n        coefficients  = pd.DataFrame(logit.feature_importances_)\n        \n    column_df     = pd.DataFrame(cols)\n    coef_sumry    = (pd.merge(coefficients,column_df,left_index= True,\n                              right_index= True, how = \"left\"))\n    coef_sumry.columns = [\"coefficients\",\"features\"]\n    coef_sumry    = coef_sumry.sort_values(by = \"coefficients\",ascending = False)\n\n    print(f'{logit}\\n\\nClassification report:\\n{classification_report(test_y,predictions)}')\n    print(f'\\nAccuracy Score: {accuracy_score(test_y,predictions)}')\n\n    #Plot confusion matrix\n    plot_confusion_matrix(logit, test_x, test_y, cmap=plt.cm.Reds)\n    plt.grid(False)\n\n    # Plot feature importance bar\n    # Prepare Data\n    coef_sumry.reset_index(inplace=True)\n    coef_sumry['colors'] = ['red' if x < 0 else 'green' for x in coef_sumry['coefficients']]\n    coef_sumry\n\n    # Draw plot\n    plt.figure(figsize=(14,10), dpi= 80)\n    plt.hlines(y=coef_sumry.index, xmin=0, xmax=coef_sumry.coefficients, color=coef_sumry.colors, alpha=0.4, linewidth=5)\n\n    # Decorations\n    plt.gca().set(ylabel='$Features$', xlabel='$Coefficients$')\n    plt.yticks(coef_sumry.index, coef_sumry.features, fontsize=12)\n    plt.title('Feature Importance', fontdict={'size':20})\n    plt.grid(linestyle='--', alpha=0.5)\n    plt.show()","9e319cfb":"from sklearn.model_selection import train_test_split\nfrom sklearn.linear_model import LogisticRegression\nfrom sklearn.metrics import accuracy_score,precision_score,recall_score,scorer,f1_score,roc_auc_score,roc_curve\nfrom sklearn.metrics import confusion_matrix,classification_report,plot_confusion_matrix\n\nimport statsmodels.api as sm\nfrom yellowbrick.classifier import DiscriminationThreshold\n\n\n#seperating dependent and independent variables\ncols    = [i for i in data.columns if i not in id_col + target_col]\n\n#split train and test data\ntrain,test = train_test_split(data,test_size = .25 ,random_state = 1)\n\ntrain_x = train[cols]\ntrain_y = train[target_col]\ntest_x = test[cols]\ntest_y = test[target_col]\n\nlogit  = LogisticRegression(C=1.0, max_iter=100, solver='liblinear')\n\ndata_prediction_plot(logit,train_x,test_x,train_y,test_y, cols)","9c93e994":"from imblearn.over_sampling import SMOTE\n\ncols    = [i for i in data.columns if i not in id_col+target_col]\n\ntrain,test = train_test_split(data,test_size = .25 ,random_state = 1)\n\nsmote_train_x = train[cols]\nsmote_train_y = train[target_col]\nsmote_test_x = test[cols]\nsmote_test_y = test[target_col]\n\n#oversampling minority class using smote\nos = SMOTE(random_state = 0)\nos_smote_x,os_smote_y = os.fit_sample(smote_train_x,smote_train_y)\nos_smote_x = pd.DataFrame(data = os_smote_x,columns=cols)\nos_smote_y = pd.DataFrame(data = os_smote_y,columns=target_col)\n###\n\nlogit_smote = LogisticRegression(C=1.0, max_iter=100, solver='liblinear')\n\ndata_prediction_plot(logit_smote,os_smote_x,smote_test_x,os_smote_y,smote_test_y, cols)","75e8df28":"from sklearn.feature_selection import RFE\n\nlogit = LogisticRegression()\n\nrfe = RFE(logit,10)\nrfe = rfe.fit(os_smote_x,os_smote_y.values.ravel())\n\nrfe.support_\nrfe.ranking_\n\n#identified columns Recursive Feature Elimination\nidc_rfe = pd.DataFrame({\"rfe_support\" :rfe.support_,\n                       \"columns\" : [i for i in data.columns if i not in id_col + target_col],\n                       \"ranking\" : rfe.ranking_,\n                      })\ncols = idc_rfe[idc_rfe[\"rfe_support\"] == True][\"columns\"].tolist()\n\n\n#separating train and test data\ntrain_rf_x = os_smote_x[cols]\ntrain_rf_y = os_smote_y\ntest_rf_x  = test[cols]\ntest_rf_y  = test[target_col]\n\nlogit_rfe = LogisticRegression(C=1.0, class_weight=None, dual=False, fit_intercept=True,\n          intercept_scaling=1, max_iter=100, multi_class='ovr', n_jobs=1,\n          penalty='l2', random_state=None, solver='liblinear', tol=0.0001,\n          verbose=0, warm_start=False)\n#applying model\ndata_prediction_plot(logit_rfe,train_rf_x,test_rf_x,train_rf_y,test_rf_y, cols)\n","f69692f2":"from sklearn.ensemble import RandomForestClassifier\n\ncols = [i for i in data.columns if i not in id_col + target_col]\nrf_x     = data[[i for i in cols if i not in target_col]]\nrf_y     = data[target_col]\n\n#random forest classifier\nrfc   = RandomForestClassifier(n_estimators = 100,max_depth = 2,criterion = \"entropy\")\nrfc.fit(rf_x,rf_y)\n\ndata_prediction_plot(rfc, rf_x,test_x[cols], rf_y,test_y, cols,\"features\")\n","585f9c34":"### Customer Churn based on tenure\nBased on the plots we have seen so far, there is a big indiction that tenure strongly correlates with Churn, so we need to break it down further","504e5463":"## Data Preprocessing","ce201f88":"### Customer Churn in Categorical Variables","dc1d9793":"Insights from the boxplots:\n* For tenure, we notice that the median for churned customers is about 10 months.\n* For monthly charges, churned customers had higher monthly charges than the retained customers, with a median of 80.\n* For total charges: churned customers had lower total charges than retained customers.\n\nBased on the insights, since customers tend to have a shorter tenure when their monthly charges are higher, it affects their total charges. This is reflected by the lower total charges for the churned customers.","f995706a":"### Customer Service Distrubtion","50c94ca7":"### Random Forest Classifier","82d820ce":"While converting the attribute data types to categories and `int64`, it works well, but we get an error when assigning type `float64` to `TotalCharges`","4b5981f9":"### Recursive Feature Elimination","be5b996b":"# Introduction\n## What is Customer Churn?\nCustomer churn or customer attrition is the measure of the percentage of customers that stopped doing business or using a company's service during a certain time frame.\nThe number is simply calculated by dividing the number of customers lost during a certain time period over the number of customers at the beginning of that time period.\n\n## Why is it important?\nIn most businesses, it is less expensive to retain existing customers than gaining new customers in place of churned customers. This is because earning business from new customers means working leads all the way through the sales funnel, utilizing your marketing and sales resources throughout the process. Customer retention, on the other hand, is generally more cost-effective as you\u2019ve already earned the trust and loyalty of existing customers.","7383be38":"## Data Cleaning & Transformation","48bc0ecf":"## Exploratory Analysis\n### Outlier Detection","5939cd7c":"## Baseline Model","de17bc98":"And for SeniorCitizen column, we should convert it to `Yes` and `No` to maintain consistency.","3df9695f":"# Dataset Overview\nWe are working with a kaggle dataset [Telco Customer Churn](https:\/\/www.kaggle.com\/blastchar\/telco-customer-churn) containing information about 7,043 customers and if they are still in service with the company.\n\n| Attribute | Description |\n|:-|:-|\n| customerId | Customer Id |\n| gender | Whether the customer is a male or a female |\n| SeniorCitizen | Whether the customer is a senior citizen or not (1, 0) |\n| Partner | Whether the customer has a partner or not (Yes, No) |\n| Dependents | Whether the customer has dependents or not (Yes, No) |\n| tenure | Number of months the customer has stayed with the company |\n| PhoneService | Whether the customer has a phone service or not (Yes, No) |\n| MultipleLines | Whether the customer has multiple lines or not (Yes, No, No phone service) |\n| InternetService | Customer\u2019s internet service provider (DSL, Fiber optic, No) |\n| OnlineSecurity | Whether the customer has online security or not (Yes, No, No internet service) |\n| OnlineBackup | Whether the customer has online backup or not (Yes, No, No internet service) |\n| DeviceProtection | Whether the customer has device protection or not (Yes, No, No internet service) |\n| TechSupport | Whether the customer has tech support or not (Yes, No, No internet service) |\n| StreamingTV | Whether the customer has streaming TV or not (Yes, No, No internet service) |\n| StreamingMovies | Whether the customer has streaming movies or not (Yes, No, No internet service) |\n| Contract | The contract term of the customer (Month-to-month, One year, Two year) |\n| PaperlessBilling | Whether the customer has paperless billing or not (Yes, No) |\n| PaymentMethod | The customer\u2019s payment method (Electronic check, Mailed check, Bank transfer (automatic), Credit card (automatic)) |\n| MonthlyCharges | The amount charged to the customer monthly |\n| TotalCharges | The total amount charged to the customer |\n| Churn | Whether the customer churned or not (Yes or No) |","bababe25":"Looking at the boxplots, we can see that there are no outliers in the numerical variables in our dataset.","13082d1d":"We notice that some of the attributes have redundant values like MultipleLines with `No` and `No phone service`, we can combine those to make it easier for the classifier down the line.","607017ee":"### Synthetic Minority Oversampling TEchnique (SMOTE)","79778b8a":"We see that 11 values are empty strings (they didnt show as NA's earlier). And looking at the columns, it seems the missing values are arbitrary. So rather than imputing zeros, we will remove the entire rows as it's only 0.15% of the entire data.","ff564c13":"TotalCharges is positively correlated with MonthlyCharges and tenure.","461403f8":"The number of enteries are 7043 with no NAN (for now), and we have 21 attributes including the ID.\nMost of the attributes have the wrong type, we should assign them the right data type to avoid problems down the line.","154080b3":"### Customer Churn in Numerical Variables","280ee543":"From the barchart, we can deduce that the number of people churning increases the shorter their tenure is.","27f50e82":"## Modelling"}}