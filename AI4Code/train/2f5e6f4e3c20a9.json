{"cell_type":{"297e9680":"code","9e07f305":"code","76fef0f9":"code","6e55e7ec":"code","a30a62ac":"code","6900830f":"code","b315bb8e":"code","b70edaf6":"code","5f0256ea":"code","2cc7381d":"code","cfe12f59":"code","f1a1de54":"code","bd755cbc":"code","4dd7f2d6":"code","908b3d2d":"code","5fde7607":"code","7d2541f2":"code","1a74acbb":"code","f5851583":"code","3ca5daba":"code","6647bb65":"code","bce9d7e6":"code","61232b54":"code","0e44b1be":"code","419843e3":"code","4325d3b0":"code","68166812":"code","f0c32fcc":"code","07b7f26e":"code","f5a2ceea":"code","0696b4a3":"code","a17fe428":"code","d8d9c99e":"code","bf6c9533":"code","0687f8c9":"code","f4652477":"code","7206ac25":"code","55c8efb9":"code","5f5c7093":"code","82137fc3":"code","cee77ab2":"code","0834b409":"code","18807571":"markdown","2c86cce6":"markdown","2d27def5":"markdown","ff2340d4":"markdown","e99a7b00":"markdown","54a50e07":"markdown","3f163058":"markdown","c11bf36f":"markdown","79790313":"markdown","0daaea59":"markdown","7fb144e9":"markdown"},"source":{"297e9680":"%reload_ext autoreload\n%autoreload 2\n%matplotlib inline\n\nimport seaborn as sns\nimport matplotlib.pyplot as plt\nimport numpy as np\nimport pandas as pd\nfrom fastai.vision import *","9e07f305":"PATH = Path('..\/input\/planet-understanding-the-amazon-from-space')\nTRAIN = Path('..\/input\/planet-understanding-the-amazon-from-space\/train-jpg')\nTEST = Path('..\/input\/planet-understanding-the-amazon-from-space\/test-jpg-v2')\nPATH.ls()","76fef0f9":"df = pd.read_csv(PATH\/'train_v2.csv')\nsamplesub = pd.read_csv(PATH\/'sample_submission_v2.csv')","6e55e7ec":"df.head()","a30a62ac":"print('Number of training files = {}'.format(len(df)))\nprint('Number of test files = {}'.format(len(samplesub)))\n\nprint('Number of training files = {}'.format(len(TRAIN.ls())))\nprint('Number of test files = {}'.format(len(TEST.ls())))","6900830f":"labels = df.groupby('tags')['image_name'].count().reset_index()\nlabels.head()","b315bb8e":"labels.sort_values('image_name',ascending=False).head()","b70edaf6":"#sns.barplot(x=labels['tags'],y=labels['image_name'])\nimport matplotlib.ticker as ticker\nplt.figure(figsize=(30,12))\nax = sns.barplot(x='tags',y='image_name',data=labels)\nax.xaxis.set_major_locator(ticker.MultipleLocator(5))","5f0256ea":"sample_primary = df.loc[df['tags']=='clear primary'].head()\nsample_partly_cloudy = df.loc[df['tags']=='partly_cloudy primary'].head()","2cc7381d":"sample_partly_cloudy","cfe12f59":"sample_primary","f1a1de54":"open_image(TRAIN\/'train_2.jpg') # Clear primary\n","bd755cbc":"open_image(TRAIN\/'train_17.jpg') # partly_cloudy primary","4dd7f2d6":"#tfms = [[*rand_resize_crop(256),dihedral(),zoom(scale=1.05)],[]]\ntfms = get_transforms(flip_vert=True, max_lighting=0.1, max_zoom=1.05, max_warp=0.)","908b3d2d":"src = ImageList.from_df(df,path=TRAIN,cols='image_name',suffix='.jpg').split_by_rand_pct(0.2).label_from_df(cols='tags',label_delim=' ')","5fde7607":"data = src.transform(tfms).databunch(bs=64).normalize(imagenet_stats)","7d2541f2":"data.show_batch(rows=3)","1a74acbb":"arch = models.resnet50","f5851583":"learn = cnn_learner(data,arch,metrics=[fbeta],model_dir='\/kaggle\/working')","3ca5daba":"learn.lr_find()\n# Find a good learning rate","6647bb65":"learn.recorder.plot()","bce9d7e6":"lr = 1e-2","61232b54":"learn.fit_one_cycle(7,slice(lr))","0e44b1be":"learn.save('stage1-256-resnet50')","419843e3":"learn.unfreeze()","4325d3b0":"learn.lr_find()\nlearn.recorder.plot()\n","68166812":"learn.fit_one_cycle(7,slice(1e-5,lr\/5))","f0c32fcc":"learn.recorder.plot_losses()","07b7f26e":"learn.save('stage2-256-resnet50')","f5a2ceea":"learn.export('\/kaggle\/working\/export.pkl')","0696b4a3":"test = ImageList.from_folder(TEST).add(ImageList.from_folder(PATH\/'test-jpg-additional'))\nlen(test)","a17fe428":"learn = load_learner(Path('\/kaggle\/working'), test=test)\npreds, _ = learn.get_preds(ds_type=DatasetType.Test)","d8d9c99e":"thresh = 0.5\nlabelled_preds = [' '.join([learn.data.classes[i] for i,p in enumerate(pred) if p > thresh]) for pred in preds]","bf6c9533":"labelled_preds[:5]","0687f8c9":"fnames = [f.name[:-4] for f in learn.data.test_ds.items]","f4652477":"df_preds = pd.DataFrame({'image_name':fnames, 'tags':labelled_preds}, columns=['image_name', 'tags'])","7206ac25":"df_preds.to_csv('\/kaggle\/working\/submission.csv', index=False)","55c8efb9":"a = df_preds.sort_values('image_name',ascending=True)\na.head()","5f5c7093":"df_preds.shape","82137fc3":"samplesub.tail(50)","cee77ab2":"samplesub.shape","0834b409":"#! kaggle competitions submit planet-understanding-the-amazon-from-space -f {'\/kaggle\/working\/submission.csv'} -m \"My submission\"","18807571":"# Load data","2c86cce6":"### Training","2d27def5":" ### Let's check how many files there are on training and test sets","ff2340d4":"### Define transformations","e99a7b00":"# Define paths","54a50e07":"# Train model","3f163058":"We can see some labels are overrepresented on our dataset. For instance, clear primary \tdominates the dataset, followed by partly_cloudy primary. Let's take a look at some images of these classes.","c11bf36f":"# Exploratory data analysis","79790313":"### Fine tuning","0daaea59":"### Now to the classes. Since this is a multi-label classification each image can have N different labels, including:\n\n","7fb144e9":"We are going to train a naive model using Fastai v3"}}