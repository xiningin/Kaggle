{"cell_type":{"0df4d9f5":"code","2d047ae0":"code","193cf35c":"code","e3dbbcdc":"code","d2924a94":"code","bd7649a6":"code","bb96e9c8":"code","7f200688":"code","6b941de3":"code","82033082":"code","c604c3fa":"code","1e99f815":"code","501f5383":"code","0475b255":"code","2bc06db3":"code","204dd60f":"code","9063c1b3":"code","89ff15f5":"code","38dc1a8e":"code","1397ac50":"code","b800f6cf":"code","cb3fe924":"code","9b376346":"code","bae5092e":"code","da26799f":"code","9ebf0337":"code","f9df9ec7":"code","e5440b0e":"code","d4184bf1":"code","2dfea8cc":"code","0018f85f":"code","879b25bb":"markdown","da23f67c":"markdown","356b0e51":"markdown","0e658f48":"markdown","bf474ef6":"markdown","e403ad94":"markdown","bbee9afe":"markdown","e6f0e4da":"markdown","cfb19e7f":"markdown","8abed926":"markdown","62b49484":"markdown","6a4adaf4":"markdown","b1f0db55":"markdown","7bb10349":"markdown","6a8975a6":"markdown","39eeed23":"markdown","fcc37550":"markdown","e5c01079":"markdown","f8ec9916":"markdown","f27fcd9a":"markdown","fdcfc429":"markdown","2f0a35c2":"markdown","03772509":"markdown","a7a2cd19":"markdown","0e303add":"markdown","2442adbe":"markdown","f8517d7c":"markdown"},"source":{"0df4d9f5":"import numpy as np\nimport pandas as pd\nimport scipy.special\nimport matplotlib.pyplot as plt\nimport os","2d047ae0":"path_in = '..\/input\/santa-workshop-tour-2019\/'\npath_start_solution = '..\/input\/santa-workshop-tour-start-solution\/'\nprint('input_data:', os.listdir(path_in))\nprint('start solution:', os.listdir(path_start_solution))","193cf35c":"data = pd.read_csv(path_in+'family_data.csv')\ndata.index = data['family_id']\nsamp_subm = pd.read_csv(path_in+'sample_submission.csv')\nstart_solution = pd.read_csv(path_start_solution+'santa_workshop_tour_start_solution_01.csv', index_col=0)","e3dbbcdc":"num_days = 100\nlower = 125\nupper = 300\ndays = list(range(num_days, 0, -1))","d2924a94":"def calc_family_costs(family):\n    assigned_day = family['assigned_day']\n    number_member = family['n_people']\n    if assigned_day == family['choice_0']:\n        penalty = 0\n    elif assigned_day == family['choice_1']:\n        penalty = 50\n    elif assigned_day == family['choice_2']:\n        penalty = 50 + 9 * number_member\n    elif assigned_day == family['choice_3']:\n        penalty = 100 + 9 * number_member\n    elif assigned_day == family['choice_4']:\n        penalty = 200 + 9 * number_member\n    elif assigned_day == family['choice_5']:\n        penalty = 200 + 18 * number_member\n    elif assigned_day == family['choice_6']:\n        penalty = 300 + 18 * number_member\n    elif assigned_day == family['choice_7']:\n        penalty = 300 + 36 * number_member\n    elif assigned_day == family['choice_8']:\n        penalty = 400 + 36 * number_member\n    elif assigned_day == family['choice_9']:\n        penalty = 500 + 36 * number_member + 199 * number_member\n    else:\n        penalty = 500 + 36 * number_member + 398 * number_member\n    return penalty","bd7649a6":"def calc_accounting_cost(data):\n    accounting_cost = 0\n    daily_occupancy = {k:0 for k in days}\n    family_size_dict = data[['n_people']].to_dict()['n_people']\n    for f, d in enumerate(data['assigned_day']):\n        n = family_size_dict[f]\n        daily_occupancy[d] += n\n\n    accounting_cost = (daily_occupancy[days[0]]-125.0) \/ 400.0 * daily_occupancy[days[0]]**(0.5)\n    accounting_cost = max(0, accounting_cost)\n    \n    yesterday_count = daily_occupancy[days[0]]\n    for day in days[1:]:\n        today_count = daily_occupancy[day]\n        diff = abs(today_count - yesterday_count)\n        accounting_cost += max(0, (daily_occupancy[day]-125.0) \/ 400.0 * daily_occupancy[day]**(0.5 + diff \/ 50.0))\n        yesterday_count = today_count\n    return accounting_cost","bb96e9c8":"def plot_results(data, name):\n    x = data.columns\n    y = data.loc[name]\n    plt.plot(x, y, 'ro')\n    plt.grid()\n    plt.title(name)\n    plt.xlabel('steps')\n    plt.ylabel('value')\n    plt.show()","7f200688":"def check_day(data, day):\n    group_data = data.groupby('assigned_day').sum()['n_people'].to_frame()\n    if (125 <= group_data.loc[day, 'n_people']) & (group_data.loc[day, 'n_people'] <= 300):\n        return True\n    else:\n        return False","6b941de3":"for i in range(num_days):\n    data.loc[i*50:(i+1)*50-1, 'assigned_day'] = i+1\ndata['assigned_day'] = data['assigned_day'].astype(int)","82033082":"data['assigned_day'] = start_solution['assigned_day']","c604c3fa":"data.head()","1e99f815":"family_id = 100\ncalc_family_costs(data.iloc[family_id])","501f5383":"data['penalty_cost'] = data.apply(calc_family_costs, axis=1)","0475b255":"data.head()","2bc06db3":"acc_costs = calc_accounting_cost(data)\nacc_costs","204dd60f":"print('Total costs:', data['penalty_cost'].sum()+ acc_costs)","9063c1b3":"def check_swap_day(data, family, choice):\n    data_copy = data.copy()\n    data_copy.loc[family, 'assigned_day'] = data_copy.loc[family, 'choice_'+str(choice)]\n    data_copy.loc[family, 'penalty_cost'] = calc_family_costs(data_copy.iloc[family])\n    \n    penalty_before = data.loc[family, 'penalty_cost']\n    accounting_before = calc_accounting_cost(data)\n    \n    penalty_after = data_copy.loc[family, 'penalty_cost']\n    accounting_after = calc_accounting_cost(data_copy)\n    \n    # Check conditions\n    day_before = check_day(data_copy, data.loc[family, 'assigned_day'])\n    day_after = check_day(data_copy, data_copy.loc[family, 'assigned_day'])\n\n    if(day_before==True and day_after==True):\n        improvement = (penalty_before-penalty_after)+(accounting_before-accounting_after)\n    else:\n        improvement = -1\n    \n    return improvement","89ff15f5":"family_id = 386\ncheck_swap_day(data, family_id, 0)","38dc1a8e":"def check_swap_family(data, family, choice):\n    family1 = family\n    day_family1 = data.loc[family1, 'assigned_day']\n    penalty1 = data.loc[family1, 'penalty_cost']\n    member_family1 = data.loc[family1, 'n_people']\n    \n    day_member_list = data.groupby('assigned_day')['family_id'].apply(list).to_frame()\n    \n    improvements = {}\n    for member in day_member_list.loc[data.loc[family1, 'choice_'+str(choice)], 'family_id']:\n        family2 = member\n        day_family2 = data.loc[family2, 'assigned_day']\n        member_family2 = data.loc[family2, 'n_people']\n        penalty2 = data.loc[family2, 'penalty_cost']\n        \n        # simulate the swap with another family\n        data_copy = data.copy()\n        data_copy.loc[family2, 'assigned_day'] = data_copy.loc[family1, 'assigned_day']\n        data_copy.loc[family1, 'assigned_day'] = data_copy.loc[family1, 'choice_'+str(choice)]\n        # calc the new penalty cost for both families\n        new_penalty1 = calc_family_costs(data_copy.iloc[family1])\n        new_penalty2 = calc_family_costs(data_copy.iloc[family2])\n        # check both days before and after swaping\n        day_before = check_day(data_copy, data.loc[family1, 'assigned_day'])\n        day_after = check_day(data_copy, data_copy.loc[family1, 'choice_'+str(choice)])\n        # calc the accounting costs before and after swaping\n        accounting_before = calc_accounting_cost(data)\n        accounting_after = calc_accounting_cost(data_copy)\n        if(day_before==True and day_after==True):\n            improvement = (penalty1-new_penalty1) + (penalty2-new_penalty2) + (accounting_before-accounting_after)\n        else:\n            improvement = -1\n        improvements.update({member:improvement})\n   \n    maximum = max(zip(improvements.values(), improvements.keys()))\n    family_swap = maximum[1]\n    return improvement, family_swap","1397ac50":"family_id = 386\ncheck_swap_family(data, family_id, 0)","b800f6cf":"family_id = 386\nchoice = 0\nimprovement_day = check_swap_day(data, family_id, choice)\nimprovement_family, family_swap = check_swap_family(data, family_id, choice)\nimprovement_day, improvement_family, family_swap","cb3fe924":"def go_to_bazaar(data, family):\n    family1 = family\n    day_family1 = data.loc[family1, 'assigned_day']\n    penalty1 = data.loc[family1, 'penalty_cost']\n    member_family1 = data.loc[family1, 'n_people']\n    \n    status = False\n    \n    for choice in range(10):\n        \"\"\" Should i swap the day? \"\"\"\n        improvement_day = check_swap_day(data, family1, choice)\n        \"\"\" Should i swap with another family? \"\"\"\n        improvement_family, family2 = check_swap_family(data, family1, choice)\n    \n        if(improvement_day >= 0 or improvement_family >= 0):\n            if(improvement_day > improvement_family):\n                #print('swap day')\n                data.loc[family, 'assigned_day'] = data.loc[family, 'choice_'+str(choice)]\n                data.loc[family, 'penalty_cost'] = calc_family_costs(data.iloc[family])\n                status = True\n            else:\n                #print('swap family')\n                data.loc[family2, 'assigned_day'] = data.loc[family1, 'assigned_day']\n                data.loc[family1, 'assigned_day'] = data.loc[family1, 'choice_'+str(choice)]\n        \n                data.loc[family1, 'penalty_cost'] = calc_family_costs(data.iloc[family1])\n                data.loc[family2, 'penalty_cost'] = calc_family_costs(data.iloc[family2])\n                status = True\n            if(status==True):\n                break","9b376346":"family_id = 386\n#go_to_bazaar(data, family_id)\n#print('Total costs:', data['penalty_cost'].sum(), calc_accounting_cost(data))","bae5092e":"results = pd.DataFrame()\nresults[0] = data['penalty_cost'].describe()\nresults.loc['costs', 0] = data['penalty_cost'].sum()+calc_accounting_cost(data)","da26799f":"num_steps = 10\n\nfor step in range(num_steps):\n    print('step: ', step)\n    families_high_scored = list(data[data['penalty_cost']>0].index)\n    print('# families: ', len(families_high_scored),\n          'first:', families_high_scored[0],\n          'last:', families_high_scored[-1])\n    for family in families_high_scored:\n        #print('   family:', family)\n        go_to_bazaar(data, family)\n    data['penalty_cost'] = data.apply(calc_family_costs, axis=1)\n    print('costs:', data['penalty_cost'].sum(), calc_accounting_cost(data))\n    results[step+1] = data['penalty_cost'].describe()\n    results.loc['costs', step+1] = data['penalty_cost'].sum()+calc_accounting_cost(data)","9ebf0337":"results = results.reindex(sorted(results.columns), axis=1)","f9df9ec7":"plot_results(results, 'costs')","e5440b0e":"plot_results(results, 'mean')","d4184bf1":"print('Total costs:', data['penalty_cost'].sum() + calc_accounting_cost(data))","2dfea8cc":"data = data.sort_index()\noutput = pd.DataFrame({'family_id': samp_subm.index,\n                       'assigned_day': data['assigned_day']})\noutput.to_csv('submission.csv', index=False)","0018f85f":"import pandas as pd\nsanta_workshop_tour_start_solution_01 = pd.read_csv(\"..\/input\/santa-workshop-tour-start-solution\/santa_workshop_tour_start_solution_01.csv\")","879b25bb":"Load a start solution.","da23f67c":"Calc the cost for all families.","356b0e51":"# Load Libraries","0e658f48":"# Write Output","bf474ef6":"# Method To Reduce The Total Costs\nThe main idea is to change the day with another family or swap the assigned day with respect to the constraints.","e403ad94":"# Input Data","bbee9afe":"Total costs for the start solution are the sum over the family costs and the accounting cost.","e6f0e4da":"Calc the accounting costs for all days and all families.","cfb19e7f":"Combine the check_swap_day and check_swap_family functions to the algorithm.","8abed926":"## Check day\nTo check a swap we have to test the constraint explained before.","62b49484":"# Final costs","6a4adaf4":"Have a look on the data.","b1f0db55":"# Parameter","7bb10349":"Test the check_swap_family function.","6a8975a6":"## Accounting Costs","39eeed23":"# Analyse Results","fcc37550":"# Iterations","e5c01079":"# Store Results\nWe want to analyse the results of the iteration steps.","f8ec9916":"Compare the check_swap_day and check_swap_family functions.","f27fcd9a":"Test the go_to_bazaar function.","fdcfc429":"Test the check_swap_day function.","2f0a35c2":"## Plot Function\nWe use a plot function to visualize the total costs of each iteration step and check the convergence.","03772509":"# Create A Start Solution\nWe use a simple distribution and test the above functions to calc the cost per family.","a7a2cd19":"Calc the family costs for a given family_id.","0e303add":"# Functions\nWe define some function for the method used below. The cost functions based on the starter code: https:\/\/www.kaggle.com\/inversion\/santa-s-2019-starter-notebook\n## Calc Family Costs","2442adbe":"# Read Data\nHere you can also load a start solution.","f8517d7c":"# Welcome to Santa's Workshop Tour Bazaar 2019\nThis is a starter code and easy to understand. \n\nWe consider a linear optimization problem to minimize a cost function subject to constraints. The cost function contains the family (preference) and accounding (penalty) costs. The constraints are: For each day the total number of people attending the workshop must be between 125 and 300. \n\nWe use code snipes from the starter notebook: https:\/\/www.kaggle.com\/inversion\/santa-s-2019-starter-notebook\n\nThe algorithm: We create a simple feasible start solution for the first iteration step. For this we say that every day get the same number fo families. This number is 50. After that the families go to the bazaar to reduce the total costs. Each familie with preference costs greater than 0 tries to swap the day with another family or swap the assigned day. But the swap is only valid if it changes the preference or acoounding costs.\n\nThe convergence of the algorithm: By using the GPU we can realize 3 iteration steps to get total costs of 288.002. If you are able to do 10 iterations steps (not on kaggle for this algorithm) you will see the following results:\n\n|iteration step| objective value|\n|---------------|-------------|\n | 0 | 10.645.224 |   \n | 1 | 719.769 |   \n | 2 | 363.117 |   \n | 3 | 288.002 |   \n | 4 | 259.360 |   \n | 5 | 249.604 |   \n | 6 | 246.836 |   \n | 7 | 245.979 |   \n | 8 | 244.238 |   \n | 9 | 243.764 |   \n | 10 | 243.317 | \n \n We can see that the improvement of the objective value is small in the later steps. Alternatively you can also start with another start solution which is closer to the optimum. \n \nFor this version we start with a precalculated start solution. "}}