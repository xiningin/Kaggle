{"cell_type":{"5cd3920e":"code","6387576f":"code","1597a27a":"code","53e4aaf7":"code","b46f5a2c":"code","3c8b0552":"code","116f93e9":"code","30e1d2cb":"code","d86de257":"code","8aee4922":"code","62070849":"code","9122de0f":"code","4cde3913":"code","8e4365f2":"code","fce91253":"code","9e7d7d59":"code","17cdf7cc":"code","c3feebe8":"code","201a8433":"code","edbb4d83":"code","739c7e0a":"code","5180763a":"code","aa9daebf":"markdown","41127533":"markdown","8c439e63":"markdown","c74db510":"markdown","cad634f1":"markdown","a6cf5067":"markdown","de0381fa":"markdown","23c99e7d":"markdown"},"source":{"5cd3920e":"# Importing some libraries.\nimport os\nimport cv2\nimport pandas as pd\nimport numpy as np \nimport matplotlib.pyplot as plt\nimport seaborn as sns\n%matplotlib inline\n\nimport tensorflow as tf\nfrom tensorflow.keras.preprocessing.image import ImageDataGenerator#, img_to_array, load_img\nfrom tensorflow.keras.layers import Dense, Conv2D, MaxPool2D, Flatten, Dropout\nfrom tensorflow.keras.models import Sequential\nfrom tensorflow.keras.optimizers import Adam, RMSprop\nfrom tensorflow.keras.callbacks import EarlyStopping, ModelCheckpoint\nfrom tensorflow.keras.models import Model, load_model","6387576f":"index_file = pd.read_csv(r\"\/kaggle\/input\/lego-minifigures-classification\/index.csv\")\nmetadata = pd.read_csv(r\"\/kaggle\/input\/lego-minifigures-classification\/metadata.csv\")","1597a27a":"df = pd.merge(index_file, metadata[['class_id','minifigure_name']], on='class_id')\ndf","53e4aaf7":"sns.barplot()","b46f5a2c":"df['minifigure_name'].value_counts().plot(kind='bar', figsize=(12,6), title='MINIFIGURE COUNTS')","3c8b0552":"df_train = pd.DataFrame([])\ndf_valid = pd.DataFrame([])\n\nfor i in range(1,len(df['class_id'].value_counts())+1):\n    df_train = df_train.append(df[df['class_id'] == i].iloc[ :-1])    \n    df_valid = df_valid.append(df[df['class_id'] == i].iloc[-1: ])","116f93e9":"print('no. of classes: ', len(df['class_id'].unique()))\nprint('no. of names: ', len(df['minifigure_name'].unique()))","30e1d2cb":"common_dir = \"\/kaggle\/input\/lego-minifigures-classification\/\"","d86de257":"plt.figure(figsize=(14,10))\nfor i, j in enumerate(df.sample(15).iterrows(), 1):\n    plt.subplot(3,5,i)\n    image = cv2.imread(os.path.join(common_dir, j[1]['path']))\n    image = cv2.cvtColor(image, cv2.COLOR_BGR2RGB)\n    plt.imshow(image)\n    plt.title(f\"{j[1]['class_id']}: {j[1]['minifigure_name']}\")\n    plt.xticks([])\n    plt.yticks([])","8aee4922":"train_datagen = ImageDataGenerator(rescale=1.0\/255, shear_range=0.3, rotation_range=30,\n                                   width_shift_range=0.3, height_shift_range=0.3,\n                                   brightness_range=[0.2,1.0], horizontal_flip=True, \n                                   vertical_flip= True, fill_mode='nearest',zoom_range=0.4) \n\nvalid_datagen = ImageDataGenerator(rescale=1.0\/255)","62070849":"train_generator = train_datagen.flow_from_dataframe(dataframe=df_train, directory=common_dir, \n                                                    x_col='path',y_col='minifigure_name',shuffle=True,\n                                                   target_size=(256,256),batch_size=16)\n\nvalid_generator = valid_datagen.flow_from_dataframe(dataframe= df_valid, directory= common_dir,\n                                                   x_col='path', y_col='minifigure_name',\n                                                   shuffle=False, batch_size=16, target_size=(256,256))","9122de0f":"early_stop = EarlyStopping(monitor='val_loss', patience=3)\n\n# Checkpoint to save the best model measuring the val_loss.\ncallbacks_save = ModelCheckpoint('best LEGO-CNN.hdf5', \n                                 monitor='val_loss', \n                                 mode='min', \n                                 save_best_only=True)","4cde3913":"!pip install efficientnet\nimport efficientnet.keras as efn\n","8e4365f2":"\nbase_model = efn.EfficientNetB6(input_shape=(256,256,3), \n                                weights='imagenet', \n                                include_top=False, \n                                pooling='avg')\n# Here 3 in input_shape represent channels: \n# In RFB image their are 3 channels(coloured image in layman's language).\n\nx = Dropout(0.3)(base_model.output)    # adding Droupout layer to the model.\nprediction_efn = Dense(31, activation='softmax')(x)\nmodel = Model(base_model.input, prediction_efn)\n\nmodel.compile(optimizer = Adam(0.0001), loss = 'categorical_crossentropy', metrics = ['accuracy'])","fce91253":"model.fit(x=train_generator, \n          validation_data=valid_generator, \n          epochs=20, \n          callbacks=[early_stop, callbacks_save])","9e7d7d59":"loss = model.history.history['loss']\naccuracy = model.history.history['accuracy']\nval_loss = model.history.history['val_loss']\nval_accuracy = model.history.history['val_accuracy']","17cdf7cc":"# Plotting Training and Validation set loss.\n\nplt.plot(loss, color='r', label='loss')\nplt.plot(val_loss, color='b', label='val_loss')\nplt.legend()\nplt.title('Training and validation loss')","c3feebe8":"# Plotting Training and Validation set Accuracy.\n\nplt.plot(accuracy, color='r', label='accuracy')\nplt.plot(val_accuracy, color='g', label='validation accuracy')\nplt.legend()\nplt.title('Training and validation Accuracy')","201a8433":"model_LEGO = load_model('best LEGO-CNN.hdf5')","edbb4d83":"import random\n\nn = len(df_valid)\nrandom_image = random.randrange(n) # randomly selecting one number.\n\ntest_set = df_valid['path'].iloc[random_image] # Picking the image based on randomly selected number.\n\n# Graphically representing the Image.\ntest_image = cv2.imread(os.path.join(common_dir, test_set))\nplt.imshow(test_image)\nplt.title(df_valid['minifigure_name'].iloc[random_image])","739c7e0a":"test_image = cv2.resize(test_image, dsize=(256,256))# reshaping the image size into(512,512)\ntest_image = np.reshape(test_image, (1,256,256,3)) # 1 image, (512,512) size, 3 representing the RGB type.\n\nprediction = model.predict(test_image).argmax()","5180763a":"minifigure_name = metadata['minifigure_name'][metadata['class_id'] == prediction].iloc[0]\nprint('True name of predicted figure: ', minifigure_name)","aa9daebf":"## Training and validation set loss:","41127533":"## Training and validation set accuracy:","8c439e63":"### Here I am trying efficientnet architecture, you can also try mobilenetv2(better version of v1).","c74db510":"### Adding early stopping and checkpoint to save the best model:","cad634f1":"### Checking the predicting power of model by predicting a randomly imported image from valid set.","a6cf5067":"### Seperating train and valid images with only 1 image in valid set of and rest in train set of each minifigures:","de0381fa":"### Randomly importing 15 images from enitre dataset.","23c99e7d":"## Data Augmentation"}}