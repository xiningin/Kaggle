{"cell_type":{"e7e96fdf":"code","e2c06754":"code","fd45a2a9":"code","65405a09":"code","dcfaa0a1":"code","00a371ec":"code","13aff363":"code","0e181901":"code","a4e5601e":"code","0f0a9fcc":"code","c7df4536":"code","580bd752":"code","635731f7":"code","1e676e74":"code","163b887f":"code","8ba15e4e":"code","15c44c8c":"code","00c0a0b6":"markdown"},"source":{"e7e96fdf":"from IPython.core.display import display, HTML\n\nimport pandas as pd\nimport numpy as np\nimport pandas as pd\nimport os\nimport gc\nimport joblib\nfrom joblib import Parallel, delayed\nfrom sklearn.model_selection import KFold, StratifiedKFold, KFold\nfrom sklearn.preprocessing import MinMaxScaler,QuantileTransformer,RobustScaler, normalize\nimport tensorflow as tf\nfrom tensorflow import keras\nfrom tensorflow.keras.callbacks import EarlyStopping\nfrom tensorflow.keras.callbacks import LearningRateScheduler\nfrom tensorflow.keras.optimizers.schedules import ExponentialDecay\nfrom sklearn.metrics import accuracy_score, f1_score, roc_auc_score, log_loss,mean_squared_error,r2_score,mean_absolute_error\nimport matplotlib.pyplot as plt \nimport seaborn as sns\nimport numpy.matlib\nfrom catboost import Pool, CatBoostRegressor\nimport catboost as cb\nimport xgboost as xgb\nimport lightgbm as lgb\n\nimport warnings\nwarnings.filterwarnings('ignore')","e2c06754":"df_train = pd.read_csv('..\/input\/ventilator-pressure-prediction\/train.csv')\ndf_test = pd.read_csv('..\/input\/ventilator-pressure-prediction\/test.csv')\nsubmission = pd.read_csv('..\/input\/ventilator-pressure-prediction\/sample_submission.csv')","fd45a2a9":"df_train.head()","65405a09":"df_test.head()","dcfaa0a1":"fig = plt.figure(figsize = (13, 8))\nrc = ['R', 'C']\nfor i in rc:\n    plt.subplot(2, 2, rc.index(i)+1)\n    plt.title(i, y = 1.2, size = 25, fontname = 'monospace', color = 'black')\n    a = sns.countplot(x = i, data = df_train, palette = ['#488a99', '#dbae58', '#4b585c'])\n    plt.ylabel('')\n    plt.xlabel('')\n    plt.xticks(fontname = 'monospace', size = 12)\n    plt.yticks([])\n    for j in ['right', 'top']:\n        a.spines[j].set_visible(False)\n    for j in ['bottom', 'left']:    \n        a.spines[j].set_linewidth(1.2)\n        \n    summ = 0\n    for p in a.patches:\n        summ += p.get_height()\n\n    for p in a.patches:\n        height = p.get_height()\n        a.annotate(f'{height}', (p.get_x() + p.get_width() \/ 2, p.get_height()), \n                   ha = 'center', va = 'center', \n                   size = 13,\n                   xytext = (1, -15), \n                   textcoords = 'offset points',\n                   fontname = 'monospace', color = 'white')\n        a.annotate(f'{round((height\/summ) * 100, 1)}%', (p.get_x() + p.get_width() \/ 2, p.get_height()), \n                   ha = 'center', va = 'center', \n                   size = 15,\n                   xytext = (1, 13), \n                   textcoords = 'offset points',\n                   fontname = 'monospace', color = 'black')   \n        \nfor i in rc:\n    plt.subplot(2, 2, rc.index(i)+3)\n    a = sns.countplot(x = i, data = df_test, palette = ['#488a99', '#dbae58', '#4b585c'])\n    plt.ylabel('')\n    plt.xlabel('')\n    plt.xticks(fontname = 'monospace', size = 12)\n    plt.yticks([])\n    for j in ['right', 'top']:\n        a.spines[j].set_visible(False)\n    for j in ['bottom', 'left']:    \n        a.spines[j].set_linewidth(1.2)\n        \n    summ = 0\n    for p in a.patches:\n        summ += p.get_height()\n\n    for p in a.patches:\n        height = p.get_height()\n        a.annotate(f'{height}', (p.get_x() + p.get_width() \/ 2, p.get_height()), \n                   ha = 'center', va = 'center', \n                   size = 13,\n                   xytext = (1, -15), \n                   textcoords = 'offset points',\n                   fontname = 'monospace', color = 'white')\n        a.annotate(f'{round((height\/summ) * 100, 1)}%', (p.get_x() + p.get_width() \/ 2, p.get_height()), \n                   ha = 'center', va = 'center', \n                   size = 15,\n                   xytext = (1, 13), \n                   textcoords = 'offset points',\n                   fontname = 'monospace', color = 'black')\n        \nplt.figtext(0.15, 1.1, 'Distribution of lung attributes (R\/C)', fontname = 'monospace', size = 30, color = 'black')\nplt.figtext(1.03, 0.15, 'TEST', fontname = 'monospace', size = 25, color = 'black', rotation = 90)\nplt.figtext(1.03, 0.7, 'TRAIN', fontname = 'monospace', size = 25, color = 'black', rotation = 90)\n        \nfig.tight_layout(h_pad = 10)\nplt.show()","00a371ec":"fig = plt.figure(figsize = (15, 15))\nr, c, plot = [5, 20, 50], [10, 20, 50], 1\nfor i in range(3):\n    rr = r[i]\n    for k in range(3):\n        cc = c[k]\n        br_id = df_train.query('R == @rr & C == @cc').iloc[0,1]\n        plt.subplot(3, 3, plot)\n        plt.title(f'breath id = {br_id} | R = {rr} | C = {cc}', fontname = 'monospace', size = 14)\n        a = sns.lineplot(data = df_train.query(\"breath_id == @br_id\"), x = \"time_step\", y = \"u_in\", color = '#4b585c', linewidth = 2)\n        sns.lineplot(data = df_train.query(\"breath_id == @br_id\"), x = \"time_step\", y = \"u_out\", color = '#dbae58', linewidth = 2)\n        sns.lineplot(data = df_train.query(\"breath_id == @br_id\"), x = \"time_step\", y = \"pressure\", color = '#488a99', linewidth = 2)\n        plt.ylabel('')\n        plt.xlabel('time stemp', size = 14, fontname = 'monospace', labelpad = 10)\n        plt.xticks(size = 12, fontname = 'monospace')\n        plt.yticks(size = 12, fontname = 'monospace')\n\n        for j in ['right', 'top']:\n            a.spines[j].set_visible(False)\n        for j in ['bottom', 'left']:    \n            a.spines[j].set_linewidth(1.2)\n            \n        plot += 1\n\nplt.figtext(0.01, 1.08, 'Observations on breaths with all possible lung attributes', fontname = 'monospace', size = 30, color = 'black')\nplt.figtext(0.35, 1.03, 'u_in', fontname = 'monospace', size = 27, color = '#4b585c')\nplt.figtext(0.45, 1.03, 'u_out', fontname = 'monospace', size = 27, color = '#dbae58')\nplt.figtext(0.55, 1.03, 'pressure', fontname = 'monospace', size = 27, color = '#488a99')\nfig.tight_layout(h_pad = 3)\nplt.show()","13aff363":"fig = plt.figure(figsize = (15, 12))\nplot = 1\nfor i in range(3):\n    rr = r[i]\n    for k in range(3):\n        cc = c[k]\n        plt.subplot(3, 3, plot)\n        plt.title(f'R = {rr} | C = {cc}', fontname = 'monospace', size = 15, color = 'black')\n        a = sns.kdeplot(df_train.query('time_step < 0.000001 & u_in < 0.000001 & R == @rr & C == @cc')['pressure'], color = '#488a99', shade = True, alpha = 1, linewidth = 1.5, edgecolor = 'black')\n        plt.ylabel('')\n        plt.xlabel('')\n        plt.xticks(size = 12, fontname = 'monospace')\n        plt.yticks([])\n\n        for j in ['right', 'top']:\n            a.spines[j].set_visible(False)\n        for j in ['bottom', 'left']:    \n            a.spines[j].set_linewidth(1.2)\n            \n        plot += 1\n\ny = 1.27\nfor i in range(3):\n    rr = r[i]\n    y -= 0.333\n    x = -0.315\n    for k in range(3):\n        cc = c[k]\n        x += 0.333\n        plt.figtext(x, y, f'Min: {round(df_train.query(\"time_step < 0.000001 & u_in < 0.000001 & R == @rr & C == @cc\")[\"pressure\"].min(),2)}', fontname = 'monospace', color = 'black')\n        plt.figtext(x, y-0.02, f'Max: {round(df_train.query(\"time_step < 0.000001 & u_in < 0.000001 & R == @rr & C == @cc\")[\"pressure\"].max(),2)}', fontname = 'monospace')\n        plt.figtext(x, y-0.04, f'Mean: {round(df_train.query(\"time_step < 0.000001 & u_in < 0.000001 & R == @rr & C == @cc\")[\"pressure\"].mean(),2)}', fontname = 'monospace', color = 'black')\n        plt.figtext(x, y-0.06, f'Median: {round(df_train.query(\"time_step < 0.000001 & u_in < 0.000001 & R == @rr & C == @cc\")[\"pressure\"].median(),2)}', fontname = 'monospace', color = 'black')\n        \nplt.figtext(0.01, 1.08, 'Distribution of pressure depending on lung attributes', fontname = 'monospace', size = 30, color = 'black')\n        \nfig.tight_layout(h_pad = 3)\nplt.show()","0e181901":"#df=pd.concat([df_train,df_test],axis=0)","a4e5601e":"def add_features(df):\n    df['area'] = df['time_step'] * df['u_in']\n    df['area'] = df.groupby('breath_id')['area'].cumsum()\n    \n    df['u_in_cumsum'] = (df['u_in']).groupby(df['breath_id']).cumsum()\n    \n    df['u_in_lag2'] = df['u_in'].shift(2).fillna(0)\n    df['u_in_lag4'] = df['u_in'].shift(4).fillna(0)\n    \n    df['R'] = df['R'].astype(str)\n    df['C'] = df['C'].astype(str)\n    df = pd.get_dummies(df)\n    \n    df['ewm_u_in_mean'] = df.groupby('breath_id')['u_in'].ewm(halflife=10).mean().reset_index(level=0,drop=True)\n    df['ewm_u_in_std'] = df.groupby('breath_id')['u_in'].ewm(halflife=10).std().reset_index(level=0,drop=True)\n    df['ewm_u_in_corr'] = df.groupby('breath_id')['u_in'].ewm(halflife=10).corr().reset_index(level=0,drop=True)\n    \n    df['rolling_10_mean'] = df.groupby('breath_id')['u_in'].rolling(window=10, min_periods=1).mean().reset_index(level=0,drop=True)\n    df['rolling_10_max'] = df.groupby('breath_id')['u_in'].rolling(window=10, min_periods=1).max().reset_index(level=0,drop=True)\n    df['rolling_10_std'] = df.groupby('breath_id')['u_in'].rolling(window=10, min_periods=1).std().reset_index(level=0,drop=True)\n    \n    df['expand_mean'] = df.groupby('breath_id')['u_in'].expanding(2).mean().reset_index(level=0,drop=True)\n    df['expand_max'] = df.groupby('breath_id')['u_in'].expanding(2).max().reset_index(level=0,drop=True)\n    df['expand_std'] = df.groupby('breath_id')['u_in'].expanding(2).std().reset_index(level=0,drop=True)\n    \n    return df","0f0a9fcc":"df_train=add_features(df_train)\ndf_test=add_features(df_test)","c7df4536":"df_train = df_train.fillna(0)\ndf_test = df_test.fillna(0)","580bd752":"%%time\ndef display_importances(feature_importance_df_):\n    # Plot feature importances\n    cols = feature_importance_df_[[\"feature\", \"importance\"]].groupby(\"feature\").mean().sort_values(\n        by=\"importance\", ascending=False)[:50].index\n    \n    best_features = feature_importance_df_.loc[feature_importance_df_.feature.isin(cols)]\n    \n    plt.figure(figsize=(8,10))\n    sns.barplot(x=\"importance\", y=\"feature\", \n                data=best_features.sort_values(by=\"importance\", ascending=False))\n    plt.title('LightGBM Features (avg over folds)')\n    plt.tight_layout()\n    plt.savefig('lgbm_importances.png')","635731f7":"%%time\ndef lgb_model(train, test,n_fold=5):\n    #\u63d0\u53d6ID\n    train_ids=train[\"id\"]\n    test_ids=test[\"id\"]\n    #\u63d0\u53d6\u6807\u7b7e\n    y = train['pressure']    \n    # \u5254\u9664\u591a\u4f59\u5217\n    x = train.drop(['id', 'breath_id', 'pressure'], axis = 1)\n    x_test = test.drop(['id', 'breath_id'], axis = 1)\n    print(\"x_trian{}\".format(x.shape))\n    print(\"x_test{}\".format(x_test.shape))\n    print(\"y_train{}\".format(y.shape))\n    #\u63d0\u53d6\u7279\u5f81\u540d\u79f0\n    feature_names=list(x.columns)\n    #\u8f6c\u53d8\u4e3anp arrays\n    x=np.array(x)\n    x_test=np.array(x_test)\n    #\u7279\u5f81\u91cd\u8981\u6027\n    feature_importance_values=np.zeros(len(feature_names))\n    #\u5b58\u653e\u4ea4\u53c9\u9a8c\u8bc1\u7ed3\u679c\n    out_of_fold = np.zeros(x.shape[0])\n    #\u5b58\u653e\u9884\u6d4b\u7ed3\u679c\n    test_predictions = np.zeros(x_test.shape[0])\n    # k\u6298\n    kfold = KFold(n_splits = n_fold, random_state = 10086, shuffle = True)\n    #\u4ea4\u53c9\u9a8c\u8bc1\u548c\u8bad\u7ec3\u5206\u6570\n    valid_scores=[]\n    train_scores=[]\n    # \u904d\u5386\u4ea4\u53c9\u9a8c\u8bc1\n    for fold, (trn_ind, val_ind) in enumerate(kfold.split(x)):\n        x_train, x_val = x[trn_ind], x[val_ind]\n        y_train, y_val = y[trn_ind], y[val_ind]\n        model = lgb.LGBMRegressor(n_estimators=10000,\n                                  learning_rate=0.1,\n                                  max_depth=-1,\n                                  max_bin=250,\n                                  subsample=0.9,\n                                  subsample_freq=3,\n                                  min_data_in_leaf=500,\n                                  boosting_type='gbdt',\n                                  feature_fraction=0.65,\n                                  lambda_l1=0.3,\n                                  lambda_l2=0.3,\n                                  n_jobs=-1,\n                                  random_state=10086\n        )\n        model.fit(x_train,\n                  y_train,\n                  eval_metric=\"mae\",\n                  eval_set=[(x_train,y_train),(x_val,y_val)],\n                  eval_names=['train','valid'],\n                  categorical_feature=\"auto\",\n                  early_stopping_rounds=30,\n                  verbose=100\n        )\n       \n        #\u6700\u4f73\u8fed\u4ee3\u6b21\u6570\n        best_iteration=model.best_iteration_\n       \n        # \u7279\u5f81\u91cd\u8981\u6027\n        feature_importance_values+=model.feature_importances_\/kfold.n_splits\n       \n        #\u9884\u6d4b\u6d4b\u8bd5\u96c6\n        test_predictions += model.predict(x_test,num_iteration=best_iteration) \/ kfold.n_splits\n      \n        out_of_fold[val_ind]=model.predict(x_val,num_iteration=best_iteration)\n      \n        #\u8bb0\u5f55\u5206\u6570\n        train_score=mean_absolute_error(y_train, model.predict(x_train,num_iteration=best_iteration))\n       \n        valid_score=mean_absolute_error(y_val, model.predict(x_val,num_iteration=best_iteration)) \n\n        #print(\"train_rmspe:{},valid_rmspe:{}\".format(train_rmspe,valid_rmspe,valid_rmspe))\n        print('Fold %2d ,train-score : %.6f,valid-score : %.6f' % (fold + 1, train_score,valid_score))\n        train_scores.append(train_score)\n        valid_scores.append(valid_score)\n\n    #\u63d0\u4ea4df\n    submission_test=pd.DataFrame({\"id\":test_ids,\"pressure\":test_predictions})\n    #\u7279\u5f81\u91cd\u8981\u6027\n    feature_importance=pd.DataFrame({\"feature\":feature_names,\"importance\":feature_importance_values})\n    train_scores.append(np.mean(train_scores))\n    valid_scores.append(np.mean(valid_score))\n    fold_names=list(range(n_fold))\n    fold_names.append(\"overall\")\n    \n    #\u7ed3\u679c\u5206\u6570\n    metrics=pd.DataFrame({\"fold\":fold_names,\"train\":train_scores,\"valid\":valid_scores})\n    return submission_test,feature_importance,metrics","1e676e74":"submission_test,feature_importance,metrics=lgb_model(df_train,df_test)","163b887f":"display_importances(feature_importance)","8ba15e4e":"metrics","15c44c8c":"submission_test.to_csv('sumbission.csv', index=False)","00c0a0b6":"# \u7279\u5f81\u63cf\u8ff0\n* id:\n* breath_id\n* R\n* C\n* time_step\n* u_in\n* u_out\n* pressure"}}