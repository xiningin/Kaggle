{"cell_type":{"971a3987":"code","618bfb9b":"code","b1f717be":"code","b79e499e":"code","cf39d8c6":"code","1fea254e":"code","c7cc39df":"code","efc1bf83":"code","70e44723":"code","a77d92b5":"code","3db9ea09":"code","19012c14":"code","3ea34168":"code","19cd7d44":"code","2f2ce647":"code","53f384f7":"code","b1a642e9":"code","587af03e":"code","1ff6df29":"code","d3bd1ec0":"code","4b1bdfee":"code","a4733d1d":"code","2b9aafa3":"code","470e7d21":"code","3068e376":"code","dbd17515":"code","0090558f":"code","175325a6":"code","d3c1896c":"code","58c247d0":"code","57f8e375":"markdown","fb6004fa":"markdown","49e9aabe":"markdown","9f0a8ed5":"markdown","990eedbd":"markdown","9d0a1dcc":"markdown","4a5c39e0":"markdown"},"source":{"971a3987":"# This Python 3 environment comes with many helpful analytics libraries installed\n# It is defined by the kaggle\/python docker image: https:\/\/github.com\/kaggle\/docker-python\n# For example, here's several helpful packages to load in \n\nimport numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\n\n# Input data files are available in the \"..\/input\/\" directory.\n# For example, running this (by clicking run or pressing Shift+Enter) will list all files under the input directory\n\nimport os\nfor dirname, _, filenames in os.walk('\/kaggle\/input'):\n    for filename in filenames:\n        print(os.path.join(dirname, filename))\n\n# Any results you write to the current directory are saved as output.","618bfb9b":"PROJECT_ID = 'geultto'\n# Not using kaggle-competitions-project!\n\nfrom google.cloud import bigquery\nclient = bigquery.Client(project=PROJECT_ID, location=\"US\")\ndataset = client.create_dataset('bqml_example', exists_ok=True)\n\nfrom google.cloud.bigquery import magics\nfrom kaggle.gcp import KaggleKernelCredentials\nmagics.context.credentials = KaggleKernelCredentials()\nmagics.context.project = PROJECT_ID\n","b1f717be":"table = client.get_table(\"kaggle-competition-datasets.geotab_intersection_congestion.train\")\n\n# look at five rows from our dataset\nclient.list_rows(table, max_results=5).to_dataframe()","b79e499e":"%load_ext google.cloud.bigquery","cf39d8c6":"%%bigquery\nCREATE MODEL IF NOT EXISTS `bqml_example.total_time_p20`\nOPTIONS(model_type='linear_reg') AS\nSELECT\n    TotalTimeStopped_p20 as label,\n    Weekend,\n    Hour,\n    Month,\n    EntryHeading,\n    ExitHeading,\n    City\nFROM\n  `kaggle-competition-datasets.geotab_intersection_congestion.train`\nWHERE\n    RowId < 2600000","1fea254e":"%%bigquery\nCREATE MODEL IF NOT EXISTS `bqml_example.total_time_p50`\nOPTIONS(model_type='linear_reg') AS\nSELECT\n    TotalTimeStopped_p50 as label,\n    Weekend,\n    Hour,\n    Month,\n    EntryHeading,\n    ExitHeading,\n    City\nFROM\n  `kaggle-competition-datasets.geotab_intersection_congestion.train`\nWHERE\n    RowId < 2600000","c7cc39df":"%%bigquery\nCREATE MODEL IF NOT EXISTS `bqml_example.total_time_p80`\nOPTIONS(model_type='linear_reg') AS\nSELECT\n    TotalTimeStopped_p80 as label,\n    Weekend,\n    Hour,\n    Month,\n    EntryHeading,\n    ExitHeading,\n    City\nFROM\n  `kaggle-competition-datasets.geotab_intersection_congestion.train`\nWHERE\n    RowId < 2600000","efc1bf83":"%%bigquery\nCREATE MODEL IF NOT EXISTS `bqml_example.distance_p20`\nOPTIONS(model_type='linear_reg') AS\nSELECT\n    DistanceToFirstStop_p20 as label,\n    Weekend,\n    Hour,\n    Month,\n    EntryHeading,\n    ExitHeading,\n    City\nFROM\n  `kaggle-competition-datasets.geotab_intersection_congestion.train`\nWHERE\n    RowId < 2600000","70e44723":"%%bigquery\nCREATE MODEL IF NOT EXISTS `bqml_example.distance_p50`\nOPTIONS(model_type='linear_reg') AS\nSELECT\n    DistanceToFirstStop_p50 as label,\n    Weekend,\n    Hour,\n    Month,\n    EntryHeading,\n    ExitHeading,\n    City\nFROM\n  `kaggle-competition-datasets.geotab_intersection_congestion.train`\nWHERE\n    RowId < 2600000","a77d92b5":"%%bigquery\nCREATE MODEL IF NOT EXISTS `bqml_example.distance_p80`\nOPTIONS(model_type='linear_reg') AS\nSELECT\n    DistanceToFirstStop_p80 as label,\n    Weekend,\n    Hour,\n    Month,\n    EntryHeading,\n    ExitHeading,\n    City\nFROM\n  `kaggle-competition-datasets.geotab_intersection_congestion.train`\nWHERE\n    RowId < 2600000","3db9ea09":"%%bigquery\nSELECT\n  *\nFROM\n  ML.TRAINING_INFO(MODEL `bqml_example.distance_p20`)\nORDER BY iteration ","19012c14":"%%bigquery\nSELECT\n  *\nFROM ML.EVALUATE(MODEL `bqml_example.total_time_p20`, (\n  SELECT\n    TotalTimeStopped_p20 as label,\n    Weekend,\n    Hour,\n    Month,\n    EntryHeading,\n    ExitHeading,\n    City\n  FROM\n    `kaggle-competition-datasets.geotab_intersection_congestion.train`\n  WHERE\n    RowId > 2600000))","3ea34168":"%%bigquery\nSELECT\n  *\nFROM ML.EVALUATE(MODEL `bqml_example.total_time_p50`, (\n  SELECT\n    TotalTimeStopped_p50 as label,\n    Weekend,\n    Hour,\n    Month,\n    EntryHeading,\n    ExitHeading,\n    City\n  FROM\n    `kaggle-competition-datasets.geotab_intersection_congestion.train`\n  WHERE\n    RowId > 2600000))","19cd7d44":"%%bigquery\nSELECT\n  *\nFROM ML.EVALUATE(MODEL `bqml_example.total_time_p80`, (\n  SELECT\n    TotalTimeStopped_p80 as label,\n    Weekend,\n    Hour,\n    Month,\n    EntryHeading,\n    ExitHeading,\n    City\n  FROM\n    `kaggle-competition-datasets.geotab_intersection_congestion.train`\n  WHERE\n    RowId > 2600000))","2f2ce647":"%%bigquery\nSELECT\n  *\nFROM ML.EVALUATE(MODEL `bqml_example.distance_p20`, (\n  SELECT\n    DistanceToFirstStop_p20 as label,\n    Weekend,\n    Hour,\n    Month,\n    EntryHeading,\n    ExitHeading,\n    City\n  FROM\n    `kaggle-competition-datasets.geotab_intersection_congestion.train`\n  WHERE\n    RowId > 2600000))","53f384f7":"%%bigquery\nSELECT\n  *\nFROM ML.EVALUATE(MODEL `bqml_example.distance_p50`, (\n  SELECT\n    DistanceToFirstStop_p50 as label,\n    Weekend,\n    Hour,\n    Month,\n    EntryHeading,\n    ExitHeading,\n    City\n  FROM\n    `kaggle-competition-datasets.geotab_intersection_congestion.train`\n  WHERE\n    RowId > 2600000))","b1a642e9":"%%bigquery\nSELECT\n  *\nFROM ML.EVALUATE(MODEL `bqml_example.distance_p80`, (\n  SELECT\n    DistanceToFirstStop_p80 as label,\n    Weekend,\n    Hour,\n    Month,\n    EntryHeading,\n    ExitHeading,\n    City\n  FROM\n    `kaggle-competition-datasets.geotab_intersection_congestion.train`\n  WHERE\n    RowId > 2600000))","587af03e":"%%bigquery df_1\nSELECT\n  RowId,\n  predicted_label as Target\nFROM\n  ML.PREDICT(MODEL `bqml_example.distance_p20`,\n    (\n    SELECT\n        RowId,\n        Weekend,\n        Hour,\n        Month,\n        EntryHeading,\n        ExitHeading,\n        City\n    FROM\n      `kaggle-competition-datasets.geotab_intersection_congestion.test`))\n    ORDER BY RowId ASC","1ff6df29":"%%bigquery df_2\nSELECT\n  RowId,\n  predicted_label as Target\nFROM\n  ML.PREDICT(MODEL `bqml_example.distance_p50`,\n    (\n    SELECT\n        RowId,\n        Weekend,\n        Hour,\n        Month,\n        EntryHeading,\n        ExitHeading,\n        City\n    FROM\n      `kaggle-competition-datasets.geotab_intersection_congestion.test`))\n    ORDER BY RowId ASC","d3bd1ec0":"%%bigquery df_3\nSELECT\n  RowId,\n  predicted_label as Target\nFROM\n  ML.PREDICT(MODEL `bqml_example.distance_p80`,\n    (\n    SELECT\n        RowId,\n        Weekend,\n        Hour,\n        Month,\n        EntryHeading,\n        ExitHeading,\n        City\n    FROM\n      `kaggle-competition-datasets.geotab_intersection_congestion.test`))\n    ORDER BY RowId ASC","4b1bdfee":"%%bigquery df_4\nSELECT\n  RowId,\n  predicted_label as Target\nFROM\n  ML.PREDICT(MODEL `bqml_example.total_time_p20`,\n    (\n    SELECT\n        RowId,\n        Weekend,\n        Hour,\n        Month,\n        EntryHeading,\n        ExitHeading,\n        City\n    FROM\n      `kaggle-competition-datasets.geotab_intersection_congestion.test`))\n    ORDER BY RowId ASC","a4733d1d":"%%bigquery df_5\nSELECT\n  RowId,\n  predicted_label as Target\nFROM\n  ML.PREDICT(MODEL `bqml_example.total_time_p50`,\n    (\n    SELECT\n        RowId,\n        Weekend,\n        Hour,\n        Month,\n        EntryHeading,\n        ExitHeading,\n        City\n    FROM\n      `kaggle-competition-datasets.geotab_intersection_congestion.test`))\n    ORDER BY RowId ASC","2b9aafa3":"%%bigquery df_6\nSELECT\n  RowId,\n  predicted_label as Target\nFROM\n  ML.PREDICT(MODEL `bqml_example.total_time_p80`,\n    (\n    SELECT\n        RowId,\n        Weekend,\n        Hour,\n        Month,\n        EntryHeading,\n        ExitHeading,\n        City\n    FROM\n      `kaggle-competition-datasets.geotab_intersection_congestion.test`))\n    ORDER BY RowId ASC","470e7d21":"df_6.head(2)","3068e376":"df_1['RowId'] = df_1['RowId'].apply(str) + '_0'\ndf_2['RowId'] = df_2['RowId'].apply(str) + '_1'\ndf_3['RowId'] = df_3['RowId'].apply(str) + '_2'\ndf_4['RowId'] = df_4['RowId'].apply(str) + '_3'\ndf_5['RowId'] = df_5['RowId'].apply(str) + '_4'\ndf_6['RowId'] = df_6['RowId'].apply(str) + '_5'\n","dbd17515":"df = pd.concat([df_1, df_2, df_3, df_4, df_5, df_6], axis=0)","0090558f":"df.rename(columns={'RowId': 'TargetId'}, inplace=True)","175325a6":"submission = pd.read_csv(\"..\/input\/bigquery-geotab-intersection-congestion\/sample_submission.csv\")\nsubmission = submission.merge(df, on='TargetId')\nsubmission.rename(columns={'Target_y': 'Target'}, inplace=True)\nsubmission = submission[['TargetId', 'Target']]","d3c1896c":"submission.to_csv('submission.csv', index=False)","58c247d0":"submission.tail()","57f8e375":"### Setting\n- <img src=\"https:\/\/www.dropbox.com\/s\/ntne7578189c1d5\/Screenshot%202019-09-15%2000.34.21.png?raw=1\">","fb6004fa":"### Explanation\n- This kernel is using BQML Code\n- Train 6 model and Predict 6 model\n- Reference : [BigQuery ML Template (Intersection Congestion)](https:\/\/www.kaggle.com\/sirtorry\/bigquery-ml-template-intersection-congestion)","49e9aabe":"### Predict Output","9f0a8ed5":"### Evaluate Model\n","990eedbd":"### Using BigQuery Dataset\n- If you want to using bigquery dataset, you need to google cloud platform project\n- [Document](https:\/\/cloud.google.com\/resource-manager\/docs\/creating-managing-projects)\n- My Project name is \"geultto\"\n- We can access kaggle-competitions-project \"dataset\", but we don't make kaggle-competitions-project job(unauthorized)\n    - So, We use my project \"geultto\"\n    - (WARNING) You must check the [BigQuery Pricing Document](https:\/\/cloud.google.com\/bigquery\/pricing?hl=us)\n    - And [BigQueryML Pricing Document](https:\/\/cloud.google.com\/bigquery-ml\/pricing)","9d0a1dcc":"### Create BigQueryML Model[](http:\/\/)","4a5c39e0":"### Check models in bigquery console\n- Visit [https:\/\/console.cloud.google.com\/bigquery?project={your_project_id}](https:\/\/console.cloud.google.com\/bigquery)\n- Find bqml_example.model1\n    - <img src=\"https:\/\/www.dropbox.com\/s\/ov1aaqpnziec6ku\/Screenshot%202019-09-14%2023.43.06.png?raw=1\">\n- Training Part\n    - <img src=\"https:\/\/www.dropbox.com\/s\/kaz1td1kn64tyyt\/Screenshot%202019-09-14%2023.43.22.png?raw=1\">\n- Evaluation Part\n    - <img src=\"https:\/\/www.dropbox.com\/s\/7k0uhdogdhw2k80\/Screenshot%202019-09-14%2023.43.29.png?raw=1\">\n- Then We check model1 using BigQuery query"}}