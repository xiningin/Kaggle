{"cell_type":{"42f00708":"code","7e4c5ba6":"code","1df1a41c":"code","ee90be9b":"code","d28f9bdd":"code","c289f31d":"code","9aad0fb6":"code","4aa62fce":"code","b0b3b989":"code","e3bf71ad":"code","7611375d":"code","ab2077df":"code","c3c9b637":"code","ba887da8":"code","8f5758ec":"code","1530b072":"code","b7e39983":"code","4c13d2c7":"code","92776fef":"code","090f2256":"code","7fe2bbcd":"code","4a47ca77":"code","ee383864":"code","7a36184a":"code","6996a452":"code","26a50dad":"code","8cd32670":"code","00ea9bd1":"code","a73ba483":"code","fe4ec62f":"code","9d47a2d2":"code","3424fc55":"code","514bba2f":"code","4817ad6c":"code","7d6f41fc":"code","9cfe634b":"code","96b40eae":"code","5638269a":"code","07f29860":"code","5fcd5fd6":"code","b5d6b59c":"code","ce0bdf3c":"code","65abff73":"code","9e2b537c":"markdown","04f2c310":"markdown","609e4b1d":"markdown","e9853ea5":"markdown","690dcba0":"markdown","53db82a6":"markdown","d95144d3":"markdown","05a395ef":"markdown","9122b748":"markdown","02fcc99e":"markdown","731cf2fc":"markdown","c2ec59f1":"markdown","98fec065":"markdown","3fb44159":"markdown","b834ff9f":"markdown","b81c8f78":"markdown","c4bcded6":"markdown","09a480c0":"markdown","8bd587a2":"markdown","cc22db29":"markdown","28af8215":"markdown","64ee9486":"markdown","03a00a96":"markdown","cdfc34d6":"markdown","3a8defb2":"markdown","9535c2ce":"markdown","e9c6b323":"markdown","a7cf4277":"markdown","c4588cc4":"markdown","2835117b":"markdown","21cc0749":"markdown","891d6bdc":"markdown","2141c288":"markdown","fdeec534":"markdown","4733fcb1":"markdown","4daeea84":"markdown","2a4bda6c":"markdown","911bb814":"markdown","a6aeccd3":"markdown","43031ef7":"markdown","3b843cd9":"markdown","99911b86":"markdown","778a44c1":"markdown"},"source":{"42f00708":"import os \nimport sys\nimport json\nimport math\nimport random\nimport numpy as np\nimport pandas as pd\nimport gc\nfrom tqdm import tqdm\n\nimport matplotlib.pyplot as plt \nimport seaborn as sns\nimport plotly.express as px\nimport plotly.graph_objects as go\n\nfrom sklearn.model_selection import train_test_split, KFold,  StratifiedKFold\n\nimport tensorflow as tf\nimport tensorflow_addons as tfa\nimport tensorflow.keras.backend as K\nimport tensorflow.keras.layers as L\n\nimport warnings\nwarnings.filterwarnings(\"ignore\")","7e4c5ba6":"seed = 42","1df1a41c":"dropout_model = 0.36\nhidden_dim_first = 128\nhidden_dim_second = 248\nhidden_dim_third = 212","ee90be9b":"commits_df = pd.DataFrame(columns = ['commit_num', 'dropout_model', 'hidden_dim_first', 'hidden_dim_second', 'hidden_dim_third', 'LB_score'])","d28f9bdd":"n=0\ncommits_df.loc[n,'commit_num'] = 0\ncommits_df.loc[n,'dropout_model'] = 0.4\ncommits_df.loc[n,'hidden_dim_first'] = 128\ncommits_df.loc[n,'hidden_dim_second'] = 128\ncommits_df.loc[n,'hidden_dim_third'] = 128\ncommits_df.loc[n,'LB_score'] = 0.25883","c289f31d":"n=1\ncommits_df.loc[n,'commit_num'] = 3\ncommits_df.loc[n,'dropout_model'] = 0.36\ncommits_df.loc[n,'hidden_dim_first'] = 128\ncommits_df.loc[n,'hidden_dim_second'] = 256\ncommits_df.loc[n,'hidden_dim_third'] = 128\ncommits_df.loc[n,'LB_score'] = 0.25855","9aad0fb6":"n=2\ncommits_df.loc[n,'commit_num'] = 4\ncommits_df.loc[n,'dropout_model'] = 0.36\ncommits_df.loc[n,'hidden_dim_first'] = 256\ncommits_df.loc[n,'hidden_dim_second'] = 256\ncommits_df.loc[n,'hidden_dim_third'] = 128\ncommits_df.loc[n,'LB_score'] = 0.25887","4aa62fce":"n=3\ncommits_df.loc[n,'commit_num'] = 5\ncommits_df.loc[n,'dropout_model'] = 0.36\ncommits_df.loc[n,'hidden_dim_first'] = 128\ncommits_df.loc[n,'hidden_dim_second'] = 384\ncommits_df.loc[n,'hidden_dim_third'] = 128\ncommits_df.loc[n,'LB_score'] = 0.25880","b0b3b989":"n=4\ncommits_df.loc[n,'commit_num'] = 6\ncommits_df.loc[n,'dropout_model'] = 0.36\ncommits_df.loc[n,'hidden_dim_first'] = 384\ncommits_df.loc[n,'hidden_dim_second'] = 128\ncommits_df.loc[n,'hidden_dim_third'] = 128\ncommits_df.loc[n,'LB_score'] = 0.25989","e3bf71ad":"n=5\ncommits_df.loc[n,'commit_num'] = 7\ncommits_df.loc[n,'dropout_model'] = 0.36\ncommits_df.loc[n,'hidden_dim_first'] = 128\ncommits_df.loc[n,'hidden_dim_second'] = 192\ncommits_df.loc[n,'hidden_dim_third'] = 128\ncommits_df.loc[n,'LB_score'] = 0.25877","7611375d":"n=6\ncommits_df.loc[n,'commit_num'] = 8\ncommits_df.loc[n,'dropout_model'] = 0.36\ncommits_df.loc[n,'hidden_dim_first'] = 128\ncommits_df.loc[n,'hidden_dim_second'] = 224\ncommits_df.loc[n,'hidden_dim_third'] = 128\ncommits_df.loc[n,'LB_score'] = 0.25868","ab2077df":"n=7\ncommits_df.loc[n,'commit_num'] = 9\ncommits_df.loc[n,'dropout_model'] = 0.36\ncommits_df.loc[n,'hidden_dim_first'] = 128\ncommits_df.loc[n,'hidden_dim_second'] = 288\ncommits_df.loc[n,'hidden_dim_third'] = 128\ncommits_df.loc[n,'LB_score'] = 0.25881","c3c9b637":"n=8\ncommits_df.loc[n,'commit_num'] = 10\ncommits_df.loc[n,'dropout_model'] = 0.36\ncommits_df.loc[n,'hidden_dim_first'] = 128\ncommits_df.loc[n,'hidden_dim_second'] = 248\ncommits_df.loc[n,'hidden_dim_third'] = 128\ncommits_df.loc[n,'LB_score'] = 0.25850","ba887da8":"n=9\ncommits_df.loc[n,'commit_num'] = 11\ncommits_df.loc[n,'dropout_model'] = 0.36\ncommits_df.loc[n,'hidden_dim_first'] = 128\ncommits_df.loc[n,'hidden_dim_second'] = 240\ncommits_df.loc[n,'hidden_dim_third'] = 128\ncommits_df.loc[n,'LB_score'] = 0.25868","8f5758ec":"n=10\ncommits_df.loc[n,'commit_num'] = 12\ncommits_df.loc[n,'dropout_model'] = 0.35\ncommits_df.loc[n,'hidden_dim_first'] = 128\ncommits_df.loc[n,'hidden_dim_second'] = 248\ncommits_df.loc[n,'hidden_dim_third'] = 128\ncommits_df.loc[n,'LB_score'] = 0.25884","1530b072":"n=11\ncommits_df.loc[n,'commit_num'] = 13\ncommits_df.loc[n,'dropout_model'] = 0.3\ncommits_df.loc[n,'hidden_dim_first'] = 128\ncommits_df.loc[n,'hidden_dim_second'] = 248\ncommits_df.loc[n,'hidden_dim_third'] = 128\ncommits_df.loc[n,'LB_score'] = 0.25879","b7e39983":"n=12\ncommits_df.loc[n,'commit_num'] = 15\ncommits_df.loc[n,'dropout_model'] = 0.45\ncommits_df.loc[n,'hidden_dim_first'] = 128\ncommits_df.loc[n,'hidden_dim_second'] = 248\ncommits_df.loc[n,'hidden_dim_third'] = 128\ncommits_df.loc[n,'LB_score'] = 0.25920","4c13d2c7":"n=13\ncommits_df.loc[n,'commit_num'] = 17\ncommits_df.loc[n,'dropout_model'] = 0.37\ncommits_df.loc[n,'hidden_dim_first'] = 128\ncommits_df.loc[n,'hidden_dim_second'] = 248\ncommits_df.loc[n,'hidden_dim_third'] = 128\ncommits_df.loc[n,'LB_score'] = 0.25885","92776fef":"n=14\ncommits_df.loc[n,'commit_num'] = 18\ncommits_df.loc[n,'dropout_model'] = 0.36\ncommits_df.loc[n,'hidden_dim_first'] = 128\ncommits_df.loc[n,'hidden_dim_second'] = 248\ncommits_df.loc[n,'hidden_dim_third'] = 248\ncommits_df.loc[n,'LB_score'] = 0.25841","090f2256":"n=15\ncommits_df.loc[n,'commit_num'] = 19\ncommits_df.loc[n,'dropout_model'] = 0.36\ncommits_df.loc[n,'hidden_dim_first'] = 128\ncommits_df.loc[n,'hidden_dim_second'] = 248\ncommits_df.loc[n,'hidden_dim_third'] = 384\ncommits_df.loc[n,'LB_score'] = 0.25956","7fe2bbcd":"n=16\ncommits_df.loc[n,'commit_num'] = 20\ncommits_df.loc[n,'dropout_model'] = 0.36\ncommits_df.loc[n,'hidden_dim_first'] = 128\ncommits_df.loc[n,'hidden_dim_second'] = 128\ncommits_df.loc[n,'hidden_dim_third'] = 248\ncommits_df.loc[n,'LB_score'] = 0.25891","4a47ca77":"n=17\ncommits_df.loc[n,'commit_num'] = 21\ncommits_df.loc[n,'dropout_model'] = 0.36\ncommits_df.loc[n,'hidden_dim_first'] = 128\ncommits_df.loc[n,'hidden_dim_second'] = 248\ncommits_df.loc[n,'hidden_dim_third'] = 240\ncommits_df.loc[n,'LB_score'] = 0.25831","ee383864":"n=18\ncommits_df.loc[n,'commit_num'] = 22\ncommits_df.loc[n,'dropout_model'] = 0.36\ncommits_df.loc[n,'hidden_dim_first'] = 128\ncommits_df.loc[n,'hidden_dim_second'] = 248\ncommits_df.loc[n,'hidden_dim_third'] = 216\ncommits_df.loc[n,'LB_score'] = 0.25827","7a36184a":"n=19\ncommits_df.loc[n,'commit_num'] = 23\ncommits_df.loc[n,'dropout_model'] = 0.36\ncommits_df.loc[n,'hidden_dim_first'] = 128\ncommits_df.loc[n,'hidden_dim_second'] = 248\ncommits_df.loc[n,'hidden_dim_third'] = 184\ncommits_df.loc[n,'LB_score'] = 0.25898","6996a452":"n=20\ncommits_df.loc[n,'commit_num'] = 24\ncommits_df.loc[n,'dropout_model'] = 0.36\ncommits_df.loc[n,'hidden_dim_first'] = 128\ncommits_df.loc[n,'hidden_dim_second'] = 248\ncommits_df.loc[n,'hidden_dim_third'] = 208\ncommits_df.loc[n,'LB_score'] = 0.25868","26a50dad":"n=21\ncommits_df.loc[n,'commit_num'] = 25\ncommits_df.loc[n,'dropout_model'] = 0.36\ncommits_df.loc[n,'hidden_dim_first'] = 128\ncommits_df.loc[n,'hidden_dim_second'] = 248\ncommits_df.loc[n,'hidden_dim_third'] = 212\ncommits_df.loc[n,'LB_score'] = 0.25823","8cd32670":"n=22\ncommits_df.loc[n,'commit_num'] = 26\ncommits_df.loc[n,'dropout_model'] = 0.36\ncommits_df.loc[n,'hidden_dim_first'] = 128\ncommits_df.loc[n,'hidden_dim_second'] = 248\ncommits_df.loc[n,'hidden_dim_third'] = 210\ncommits_df.loc[n,'LB_score'] = 0.25844","00ea9bd1":"n=23\ncommits_df.loc[n,'commit_num'] = 27\ncommits_df.loc[n,'dropout_model'] = 0.36\ncommits_df.loc[n,'hidden_dim_first'] = 64\ncommits_df.loc[n,'hidden_dim_second'] = 124\ncommits_df.loc[n,'hidden_dim_third'] = 108\ncommits_df.loc[n,'LB_score'] = 0.25963","a73ba483":"n=24\ncommits_df.loc[n,'commit_num'] = 28\ncommits_df.loc[n,'dropout_model'] = 0.36\ncommits_df.loc[n,'hidden_dim_first'] = 128\ncommits_df.loc[n,'hidden_dim_second'] = 248\ncommits_df.loc[n,'hidden_dim_third'] = 108\ncommits_df.loc[n,'LB_score'] = 0.25860","fe4ec62f":"n=25\ncommits_df.loc[n,'commit_num'] = 29\ncommits_df.loc[n,'dropout_model'] = 0.36\ncommits_df.loc[n,'hidden_dim_first'] = 128\ncommits_df.loc[n,'hidden_dim_second'] = 244\ncommits_df.loc[n,'hidden_dim_third'] = 128\ncommits_df.loc[n,'LB_score'] = 0.25846","9d47a2d2":"# Find and mark maximum value of LB score\ncommits_df['LB_score'] = pd.to_numeric(commits_df['LB_score'])\ncommits_df['best'] = 0\ncommits_df.loc[commits_df['LB_score'].idxmin(), 'best'] = 1","3424fc55":"commits_df.sort_values(by=['LB_score'])","514bba2f":"# Interactive plot with results of parameters tuning\nfig = px.scatter_3d(commits_df, x='hidden_dim_first', y='hidden_dim_second', z='LB_score', color = 'best', \n                    symbol = 'dropout_model',\n                    title='hidden_dim_1st & 2nd and LB score visualization of COVID-19 mRNA VDP solutions')\nfig.update(layout=dict(title=dict(x=0.07)))","4817ad6c":"# Interactive plot with results of parameters tuning\nfig = px.scatter_3d(commits_df, x='hidden_dim_second', y='dropout_model', z='LB_score', color = 'best', \n                    symbol = 'hidden_dim_first',\n                    title='hidden_dim_2nd & dropout and LB score visualization of COVID-19 mRNA VDP solutions')\nfig.update(layout=dict(title=dict(x=0.07)))","7d6f41fc":"# Interactive plot with results of parameters tuning\nfig = px.scatter_3d(commits_df, x='hidden_dim_second', y='hidden_dim_third', z='LB_score', color = 'best', \n                    symbol = 'hidden_dim_first',\n                    title='hidden_dim_2nd & 3nd and LB score visualization of COVID-19 mRNA VDP solutions')\nfig.update(layout=dict(title=dict(x=0.07)))","9cfe634b":"# Download datasets\ntrain = pd.read_json('\/kaggle\/input\/stanford-covid-vaccine\/train.json', lines=True)\ntest = pd.read_json('\/kaggle\/input\/stanford-covid-vaccine\/test.json', lines=True)\nsample_sub = pd.read_csv(\"\/kaggle\/input\/stanford-covid-vaccine\/sample_submission.csv\")","96b40eae":"# Target columns \ntarget_cols = ['reactivity', 'deg_Mg_pH10', 'deg_pH10', 'deg_Mg_50C', 'deg_50C']","5638269a":"token2int = {x:i for i, x in enumerate('().ACGUBEHIMSX')}\n\ndef get_pair_index_structure(structure):\n    structure = np.array([struc for struc in structure], dtype=\"<U4\")\n\n    open_index = np.where(structure == \"(\")[0]\n    closed_index = np.where(structure == \")\")[0]\n\n    structure[open_index] = range(0, len(open_index))\n    structure[closed_index] = range(len(open_index)-1, -1, -1)\n    structure[structure == \".\"] = -1\n    structure = structure.astype(int)\n\n    pair_structure = np.array([-1]*len(structure))\n    for i in range(len(open_index)):\n        start, end = np.where(structure == i)[0]\n        pair_structure[start] = end\n        pair_structure[end] = start    \n        \n    return pair_structure","07f29860":"def preprocess_inputs(df, cols=['sequence', 'structure', 'predicted_loop_type']):\n    return np.transpose(\n        np.array(\n            df[cols]\n            .applymap(lambda seq: [token2int[x] for x in seq])\n            .values\n            .tolist()\n        ),\n        (0, 2, 1)\n    )\n\ntrain_inputs_all = preprocess_inputs(train)\ntrain_labels_all = np.array(train[target_cols].values.tolist()).transpose((0, 2, 1))","5fcd5fd6":"# Building model (with my upgrade)\n\ndef MCRMSE(y_true, y_pred):\n    colwise_mse = tf.reduce_mean(tf.square(y_true - y_pred), axis=1)\n    return tf.reduce_mean(tf.sqrt(colwise_mse), axis=1)\n\ndef gru_layer(hidden_dim, dropout):\n    return tf.keras.layers.Bidirectional(\n                                tf.keras.layers.GRU(hidden_dim,\n                                dropout=dropout,\n                                return_sequences=True,\n                                kernel_initializer = 'orthogonal'))\n\ndef lstm_layer(hidden_dim, dropout):\n    return tf.keras.layers.Bidirectional(\n                                tf.keras.layers.LSTM(hidden_dim,\n                                dropout=dropout,\n                                return_sequences=True,\n                                kernel_initializer = 'orthogonal'))\n\ndef build_model(model_type=1, seq_len=107, pred_len=68, embed_dim=100, \n                dropout=dropout_model, hidden_dim_first = hidden_dim_first, \n                hidden_dim_second = hidden_dim_second, hidden_dim_third = hidden_dim_third):\n    \n    inputs = tf.keras.layers.Input(shape=(seq_len, 3))\n\n    embed = tf.keras.layers.Embedding(input_dim=len(token2int), output_dim=embed_dim)(inputs)\n    reshaped = tf.reshape(\n        embed, shape=(-1, embed.shape[1],  embed.shape[2] * embed.shape[3]))\n    \n    reshaped = tf.keras.layers.SpatialDropout1D(.2)(reshaped)\n    \n    if model_type == 0:\n        hidden = gru_layer(hidden_dim_first, dropout)(reshaped)\n        hidden = gru_layer(hidden_dim_second, dropout)(hidden)\n        hidden = gru_layer(hidden_dim_third, dropout)(hidden)\n        \n    elif model_type == 1:\n        hidden = lstm_layer(hidden_dim_first, dropout)(reshaped)\n        hidden = lstm_layer(hidden_dim_second, dropout)(hidden)\n        hidden = lstm_layer(hidden_dim_third, dropout)(hidden)\n        \n    elif model_type == 2:\n        hidden = gru_layer(hidden_dim_first, dropout)(reshaped)\n        hidden = lstm_layer(hidden_dim_second, dropout)(hidden)\n        hidden = lstm_layer(hidden_dim_third, dropout)(hidden)\n        \n    elif model_type == 3:\n        hidden = lstm_layer(hidden_dim_first, dropout)(reshaped)\n        hidden = gru_layer(hidden_dim_second, dropout)(hidden)\n        hidden = gru_layer(hidden_dim_third, dropout)(hidden)\n\n    elif model_type == 4:\n        hidden = lstm_layer(hidden_dim_first, dropout)(reshaped)\n        hidden = gru_layer(hidden_dim_second, dropout)(hidden)\n        hidden = lstm_layer(hidden_dim_third, dropout)(hidden)\n    \n    truncated = hidden[:, :pred_len]\n\n    out = tf.keras.layers.Dense(5, activation='linear')(truncated)\n\n    model = tf.keras.Model(inputs=inputs, outputs=out)\n\n    adam = tf.optimizers.Adam()\n    model.compile(optimizer=adam, loss=MCRMSE)\n    \n    return model","b5d6b59c":"# Tunning model (with my upgrade)\n\ndef train_and_predict(n_folds=5, model_name=\"model\", model_type=0, epochs=90, debug=False,\n                      dropout_model=dropout_model, hidden_dim_first = hidden_dim_first, \n                      hidden_dim_second = hidden_dim_second, hidden_dim_third = hidden_dim_third,\n                      seed=seed):\n\n    print(\"Model:\", model_name)\n\n    ensemble_preds = pd.DataFrame(index=sample_sub.index, columns=target_cols).fillna(0) # test dataframe with 0 values\n    kf = KFold(n_folds, shuffle=True, random_state=seed)\n    skf = StratifiedKFold(n_folds, shuffle=True, random_state=seed)\n    val_losses = []\n    historys = []\n\n    for i, (train_index, val_index) in enumerate(skf.split(train_inputs_all, train['SN_filter'])):\n        print(\"Fold:\", str(i+1))\n\n        model_train = build_model(model_type=model_type, \n                                  dropout=dropout_model, \n                                  hidden_dim_first = hidden_dim_first, \n                                  hidden_dim_second = hidden_dim_second, \n                                  hidden_dim_third = hidden_dim_third)\n        model_short = build_model(model_type=model_type, seq_len=107, pred_len=107,\n                                  dropout=dropout_model, \n                                  hidden_dim_first = hidden_dim_first, \n                                  hidden_dim_second = hidden_dim_second, \n                                  hidden_dim_third = hidden_dim_third)\n        model_long = build_model(model_type=model_type, seq_len=130, pred_len=130,\n                                 dropout=dropout_model, \n                                 hidden_dim_first = hidden_dim_first, \n                                 hidden_dim_second = hidden_dim_second, \n                                 hidden_dim_third = hidden_dim_third)\n\n        train_inputs, train_labels = train_inputs_all[train_index], train_labels_all[train_index]\n        val_inputs, val_labels = train_inputs_all[val_index], train_labels_all[val_index]\n\n        checkpoint = tf.keras.callbacks.ModelCheckpoint(f'{model_name}.h5')\n\n        history = model_train.fit(\n            train_inputs , train_labels, \n            validation_data=(val_inputs,val_labels),\n            batch_size=64,\n            epochs=epochs, # changed 70\n            callbacks=[tf.keras.callbacks.ReduceLROnPlateau(), checkpoint],\n            verbose=2 if debug else 0\n        )\n\n        print(f\"{model_name} Min training loss={min(history.history['loss'])}, min validation loss={min(history.history['val_loss'])}\")\n\n        val_losses.append(min(history.history['val_loss']))\n        historys.append(history)\n\n        model_short.load_weights(f'{model_name}.h5')\n        model_long.load_weights(f'{model_name}.h5')\n\n        public_preds = model_short.predict(public_inputs)\n        private_preds = model_long.predict(private_inputs)\n\n        preds_model = []\n        for df, preds in [(public_df, public_preds), (private_df, private_preds)]:\n            for i, uid in enumerate(df.id):\n                single_pred = preds[i]\n\n                single_df = pd.DataFrame(single_pred, columns=target_cols)\n                single_df['id_seqpos'] = [f'{uid}_{x}' for x in range(single_df.shape[0])]\n\n                preds_model.append(single_df)\n\n        preds_model_df = pd.concat(preds_model)\n        ensemble_preds[target_cols] += preds_model_df[target_cols].values \/ n_folds\n\n        if debug:\n            print(\"Intermediate ensemble result\")\n            print(ensemble_preds[target_cols].head())\n\n    ensemble_preds[\"id_seqpos\"] = preds_model_df[\"id_seqpos\"].values\n    ensemble_preds = pd.merge(sample_sub[\"id_seqpos\"], ensemble_preds, on=\"id_seqpos\", how=\"left\")\n\n    print(\"Mean Validation loss:\", str(np.mean(val_losses)))\n\n    if debug:\n        fig, ax = plt.subplots(1, 1, figsize = (10, 5))\n        for i, history in enumerate(historys):\n            ax.plot(history.history['loss'])\n            ax.plot(history.history['val_loss'])\n            ax.set_title('model_'+str(i+1))\n            ax.set_ylabel('Loss')\n            ax.set_xlabel('Epoch')\n        plt.show()\n\n    return ensemble_preds\n\n\npublic_df = test.query(\"seq_length == 107\").copy()\nprivate_df = test.query(\"seq_length == 130\").copy()\npublic_inputs = preprocess_inputs(public_df)\nprivate_inputs = preprocess_inputs(private_df)\n\nensembles = []\n\nfor i in range(5):\n    model_name = \"model_\"+str(i+1)\n\n    ensemble = train_and_predict(n_folds=5, model_name=model_name, model_type=i, epochs=100,\n                                 dropout_model=dropout_model, hidden_dim_first = hidden_dim_first, \n                                 hidden_dim_second = hidden_dim_second, hidden_dim_third = hidden_dim_third,\n                                 seed=seed)\n    ensembles.append(ensemble)","ce0bdf3c":"# Ensembling the solutions\nensemble_final = ensembles[0].copy()\nensemble_final[target_cols] = 0\n\nfor ensemble in ensembles:\n    ensemble_final[target_cols] += ensemble[target_cols].values \/ len(ensembles)\n\nensemble_final","65abff73":"# Submission\nensemble_final.to_csv('ensemble_final.csv', index=False)","9e2b537c":"### Commit 13\n\n* dropout_model = 0.3\n* hidden_dim_first = 128\n* hidden_dim_second = 248\n* hidden_dim_third = 128\n\nLB = 0.25879","04f2c310":"## 4. Ensembling the solutions and submission <a class=\"anchor\" id=\"4\"><\/a>\n\n[Back to Table of Contents](#0.1)","609e4b1d":"The structure from https:\/\/www.kaggle.com\/vbmokin\/higher-lb-score-by-tuning-mloss-upgrade-visual","e9853ea5":"### Commit 6\n\n* dropout_model = 0.36\n* hidden_dim_first = 384\n* hidden_dim_second = 128\n* hidden_dim_third = 128\n\nLB = 0.25989","690dcba0":"## 2.2 Previous commits <a class=\"anchor\" id=\"2.2\"><\/a>\n\n[Back to Table of Contents](#0.1)","53db82a6":"## 2.1. Commit now <a class=\"anchor\" id=\"2.1\"><\/a>\n\n[Back to Table of Contents](#0.1)","d95144d3":"### Commit 10\n\n* dropout_model = 0.36\n* hidden_dim_first = 128\n* hidden_dim_second = 248\n* hidden_dim_third = 128\n\nLB = 0.25850","05a395ef":"# Acknowledgements\n\n* notebook [GRU & LSTM mix with custom loss](https:\/\/www.kaggle.com\/gandagorn\/gru-lstm-mix-with-custom-loss) as a basis\n* notebook [mVAN : COVID mRNA Vaccine Analysis Notebook [.268]](https:\/\/www.kaggle.com\/aestheteaman01\/mvan-covid-mrna-vaccine-analysis-notebook-268) as basis for the first notebook \n* notebook [Higher LB score by tuning mloss - upgrade & visual](https:\/\/www.kaggle.com\/vbmokin\/higher-lb-score-by-tuning-mloss-upgrade-visual) as a sample of tunning ","9122b748":"### Commit 5\n\n* dropout_model = 0.36\n* hidden_dim_first = 128\n* hidden_dim_second = 384\n* hidden_dim_third = 128\n\nLB = 0.25880","02fcc99e":"### Commit 7\n\n* dropout_model = 0.36\n* hidden_dim_first = 128\n* hidden_dim_second = 192\n* hidden_dim_third = 128\n\nLB = 0.25877","731cf2fc":"### Commit 19\n\n* dropout_model = 0.36\n* hidden_dim_first = 128\n* hidden_dim_second = 248\n* hidden_dim_third = 248\n\nLB = 0.25956","c2ec59f1":"### Commit 4\n\n* dropout_model = 0.36\n* hidden_dim_first = 256\n* hidden_dim_second = 256\n* hidden_dim_third = 128\n\nLB = 0.25887","98fec065":"### Commit 17\n\n* dropout_model = 0.37\n* hidden_dim_first = 128\n* hidden_dim_second = 248\n* hidden_dim_third = 128\n\nLB = 0.25885","3fb44159":"## 2. My upgrade <a class=\"anchor\" id=\"2\"><\/a>\n\n[Back to Table of Contents](#0.1)","b834ff9f":"Your comments and feedback are most welcome.","b81c8f78":"<a class=\"anchor\" id=\"0\"><\/a>\n# [OpenVaccine: COVID-19 mRNA Vaccine Degradation Prediction](https:\/\/www.kaggle.com\/c\/stanford-covid-vaccine)","c4bcded6":"### My upgrade: the structure of the model and its training","09a480c0":"I hope you find my upgrade of the original notebooks useful and enjoyable.","8bd587a2":"### Commit 0 (parameters from https:\/\/www.kaggle.com\/gandagorn\/gru-lstm-mix-with-custom-loss, commit 8)\n\n* dropout_model = 0.4\n* hidden_dim_first = 128\n* hidden_dim_second = 128\n* hidden_dim_third = 128\n\nLB = 0.25883","cc22db29":"### Commit 12\n\n* dropout_model = 0.35\n* hidden_dim_first = 128\n* hidden_dim_second = 248\n* hidden_dim_third = 128\n\nLB = 0.25884","28af8215":"### Commit 3\n\n* dropout_model = 0.36\n* hidden_dim_first = 128\n* hidden_dim_second = 256\n* hidden_dim_third = 128\n\nLB = 0.25855","64ee9486":"### Commit 24\n\n* dropout_model = 0.36\n* hidden_dim_first = 128\n* hidden_dim_second = 248\n* hidden_dim_third = 208\n\nLB = 0.25868","03a00a96":"### Commit 18\n\n* dropout_model = 0.36\n* hidden_dim_first = 128\n* hidden_dim_second = 248\n* hidden_dim_third = 248\n\nLB = 0.25841","cdfc34d6":"## 2.3 Parameters and LB score visualization <a class=\"anchor\" id=\"2.3\"><\/a>\n\n[Back to Table of Contents](#0.1)","3a8defb2":"### Commit 23\n\n* dropout_model = 0.36\n* hidden_dim_first = 128\n* hidden_dim_second = 248\n* hidden_dim_third = 184\n\nLB = 0.25898","9535c2ce":"### Commit 8\n\n* dropout_model = 0.36\n* hidden_dim_first = 128\n* hidden_dim_second = 224\n* hidden_dim_third = 128\n\nLB = 0.25868","e9c6b323":"### Commit 22\n\n* dropout_model = 0.36\n* hidden_dim_first = 128\n* hidden_dim_second = 248\n* hidden_dim_third = 216\n\nLB = 0.25827","a7cf4277":"[Go to Top](#0)","c4588cc4":"### Commit 11\n\n* dropout_model = 0.36\n* hidden_dim_first = 128\n* hidden_dim_second = 240\n* hidden_dim_third = 128\n\nLB = 0.25868","2835117b":"### Commit 25\n\n* dropout_model = 0.36\n* hidden_dim_first = 128\n* hidden_dim_second = 248\n* hidden_dim_third = 212\n\nLB = 0.25823","21cc0749":"### Commit 15\n\n* dropout_model = 0.45\n* hidden_dim_first = 128\n* hidden_dim_second = 248\n* hidden_dim_third = 128\n\nLB = 0.25920","891d6bdc":"## 3. Download data, auxiliary functions and model tuning <a class=\"anchor\" id=\"3\"><\/a>\n\n[Back to Table of Contents](#0.1)","2141c288":"### Commit 27\n\n* dropout_model = 0.36\n* hidden_dim_first = 64\n* hidden_dim_second = 124\n* hidden_dim_third = 108\n\nLB = 0.25963","fdeec534":"From notebook https:\/\/www.kaggle.com\/gandagorn\/gru-lstm-mix-with-custom-loss\n\nMy upgrade: structure of model","4733fcb1":"### Commit 21\n\n* dropout_model = 0.36\n* hidden_dim_first = 128\n* hidden_dim_second = 248\n* hidden_dim_third = 240\n\nLB = 0.25831","4daeea84":"## 1. Import libraries <a class=\"anchor\" id=\"1\"><\/a>\n\n[Back to Table of Contents](#0.1)","2a4bda6c":"### Commit 20\n\n* dropout_model = 0.36\n* hidden_dim_first = 128\n* hidden_dim_second = 128\n* hidden_dim_third = 248\n\nLB = 0.25891","911bb814":"<a class=\"anchor\" id=\"0.1\"><\/a>\n## Table of Contents\n\n1. [Import libraries](#1)\n1. [My upgrade](#2)\n    -  [Commit now](#2.1)\n    -  [Previous commits](#2.2)\n    -  [Parameters and LB score visualization](#2.3)\n1. [Download data, auxiliary functions and model tuning](#3)\n1. [Ensembling solutions and submission](#4)","a6aeccd3":"### Commit 26\n\n* dropout_model = 0.36\n* hidden_dim_first = 128\n* hidden_dim_second = 248\n* hidden_dim_third = 210\n\nLB = 0.25844","43031ef7":"### Commit 29\n\n* dropout_model = 0.36\n* hidden_dim_first = 128\n* hidden_dim_second = 244\n* hidden_dim_third = 128\n\nLB = 0.25846","3b843cd9":"### I use the notebook [GRU & LSTM mix with custom loss](https:\/\/www.kaggle.com\/gandagorn\/gru-lstm-mix-with-custom-loss) from [Daniel G\u00e4rber](https:\/\/www.kaggle.com\/gandagorn), which used the notebook [mVAN : COVID mRNA Vaccine Analysis Notebook [.268]](https:\/\/www.kaggle.com\/aestheteaman01\/mvan-covid-mrna-vaccine-analysis-notebook-268) from [Aman Kumar](https:\/\/www.kaggle.com\/aestheteaman01), as a basis and will try to tune its various parameters","99911b86":"### Commit 9\n\n* dropout_model = 0.36\n* hidden_dim_first = 128\n* hidden_dim_second = 288\n* hidden_dim_third = 128\n\nLB = 0.25881","778a44c1":"### Commit 28\n\n* dropout_model = 0.36\n* hidden_dim_first = 128\n* hidden_dim_second = 248\n* hidden_dim_third = 108\n\nLB = 0.25860"}}