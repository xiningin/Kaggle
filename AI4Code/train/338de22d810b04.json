{"cell_type":{"b5cf11e8":"code","86b379fe":"code","23e83063":"code","347c7e4a":"code","1b8436c3":"code","f5ec8cb4":"code","cd1b6ca0":"code","09fc19b9":"code","52b9c255":"code","0cde2377":"code","c22a91fb":"code","600c51b1":"code","c531c3b4":"code","c71906b0":"code","9c8199cf":"code","0c5d33b1":"code","5f7393db":"code","ce1c791a":"code","288a9984":"code","58501afe":"code","687fc1f4":"code","dd01c8bf":"code","7f7b70a4":"code","22e60993":"markdown"},"source":{"b5cf11e8":"!pip install -q comet_ml","86b379fe":"from comet_ml import Experiment\nfrom fastai.tabular import *","23e83063":"DATA_DIR='..\/input\/'","347c7e4a":"def load_df(mode = 'train'):\n    df = pd.read_csv(f'{DATA_DIR}{mode}_transaction.csv')\n    # (590540, 434)\n    dfi = pd.read_csv(f'{DATA_DIR}{mode}_identity.csv')\n    df =  pd.merge(df, dfi, how='left', on='TransactionID')\n    return df\n","1b8436c3":"df = load_df()","f5ec8cb4":"cat_names = [\n              # Transaction\n              'ProductCD', 'addr1', 'addr2', 'P_emaildomain', 'R_emaildomain',\n              *[f'card{i}' for i in range(1,7)],\n              *[f'M{i}' for i in range(1,10)],\n              # Identity\n              'DeviceType', 'DeviceInfo', \n               *[f'id_{i}' for i in range(12,39)],\n             ]\ncont_names = [i for i in df.keys() if i not in cat_names]\n\n# Following SafeBox Kernel\ndrop_col = ['isFraud', 'TransactionID', 'TransactionDT', 'V300', 'V309', 'V111', 'C3', 'V124', 'V106', 'V125', 'V315', 'V134', 'V102', 'V123', 'V316', 'V113', 'V136', 'V305', 'V110', 'V299', 'V289', 'V286', 'V318', 'V103', 'V304', 'V116', 'V298', 'V284', 'V293', 'V137', 'V295', 'V301', 'V104', 'V311', 'V115', 'V109', 'V119', 'V321', 'V114', 'V133', 'V122', 'V319', 'V105', 'V112', 'V118', 'V117', 'V121', 'V108', 'V135', 'V320', 'V303', 'V297', 'V120']\nfor c in drop_col:\n    if c in cat_names:\n        cat_names.remove(c)\n    else:\n        cont_names.remove(c)\n\nprocs = [FillMissing, Categorify, Normalize] # Order matters\npath = '';\nmetrics = [AUROC()]\ndep_var = 'isFraud'\nlabel_cls = CategoryList\nlog = False\ny_range = None\nkwargs = {'log': log} if log else {}\n","cd1b6ca0":"bs=4096\nsplit_idx=int(0.8*df.shape[0])\n# Take one sample of NA for each column\nna_idxs = np.unique(np.concatenate([np.where(df[k].isna())[0][0:1] for k in df.keys()]))\ntrain_idxs = np.concatenate([\n    np.arange(split_idx),\n    na_idxs[np.where(na_idxs>split_idx)],\n])\nvalid_idxs = np.setdiff1d(arange_of(df), train_idxs)\n# train_idxs.shape, valid_idxs.shape\ndata_bunch = TabularList.from_df(df, path=path, cat_names=cat_names, cont_names=cont_names, procs=procs) \\\n    .split_by_idxs(train_idxs, valid_idxs) \\\n    .label_from_df(cols=dep_var, label_cls=label_cls, **kwargs).databunch(bs=bs*2*2)\n","09fc19b9":"len(data_bunch.train_ds), len(data_bunch.valid_ds)","52b9c255":"learn = tabular_learner(data_bunch, layers=[200, 100], ps=[0.001, 0.01], emb_drop=0.04, metrics=metrics, y_range=y_range)","0cde2377":"# learn.lr_find(stop_div=True, num_it=100)\n# learn.recorder.plot()","c22a91fb":"experiment = Experiment(api_key=\"ADD_YOUR_KEY-from-comet.ml\", project_name=\"ieee\", workspace=\"username\")\nwith experiment.train():\n    learn.fit_one_cycle(1, 1e-2, wd=0.2)\n    learn.fit_one_cycle(3, 1e-3, wd=0.2)\n","600c51b1":"# from fastai.callbacks.tracker import EarlyStoppingCallback\n# cbs=[EarlyStoppingCallback(learn, monitor='auroc', min_delta=0.001, patience=3, )]\n# with experiment.train():\n#     learn.fit_one_cycle(30, 1e-4, wd=0.2, callbacks=cbs)","c531c3b4":"filename='ieee'\n!mkdir models\nlearn.export(f'models\/{filename}.pkl')","c71906b0":"# Cleanup\n\ndel learn\ndel df\nimport gc\ndel data_bunch\ngc.collect()","9c8199cf":"df_test = load_df('test')","0c5d33b1":"df_test[dep_var] = 0","5f7393db":"for i in range(1,15):\n    df_test[f'C{i}'] = df_test[f'C{i}'].fillna(-999)\n# df_test.fillna(-999, inplace=True)","ce1c791a":"learn = load_learner(\n    '',\n    f'models\/{filename}.pkl', \n    TabularList.from_df(df_test, path=path, cat_names=cat_names, cont_names=cont_names, procs=procs),\n    bs=bs\n)","288a9984":"with experiment.test():\n    test_preds, targs = learn.get_preds(ds_type=DatasetType.Test)","58501afe":"len(np.where(test_preds[:, 1]>0.5)[0])","687fc1f4":"# Sanity check\nassert(len(np.where(test_preds[:, 1]>0.5)[0])>8000)","dd01c8bf":"submission = df_test[['TransactionID']].copy()\nsubmission['isFraud']=test_preds[:, 1]","7f7b70a4":"name = filename\nsubmission.to_csv('submission.csv', index=False, header=True)","22e60993":"# Test"}}