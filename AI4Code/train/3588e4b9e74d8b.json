{"cell_type":{"62df1dfe":"code","da6a5e7b":"code","397893f0":"code","840b92fb":"code","0bc5e2c8":"code","757bedc2":"code","c268e997":"code","7c007537":"code","1337b898":"code","f525c7e1":"code","eb1f31d4":"markdown","c12f7bb2":"markdown","2f6d95e5":"markdown","1b8eeb01":"markdown","b7810253":"markdown","e7341c89":"markdown","a5f060cc":"markdown","6279bafe":"markdown","9b631738":"markdown","5ee115be":"markdown"},"source":{"62df1dfe":"import bq_helper\nimport matplotlib.pyplot as plt\nimport matplotlib.ticker as ticker\nimport numpy as np\nfrom matplotlib.pyplot import figure\nfrom bq_helper import BigQueryHelper\nimport pandas as pd\n\n# https:\/\/www.kaggle.com\/sohier\/introduction-to-the-bq-helper-package\nchicago_crime = bq_helper.BigQueryHelper(active_project=\"bigquery-public-data\",\n                                   dataset_name=\"chicago_crime\")","da6a5e7b":"bq_assistant = BigQueryHelper(\"bigquery-public-data\", \"chicago_crime\")\n#List all availablt tables\nbq_assistant.list_tables()","397893f0":"# First couple rows of the crime table\nbq_assistant.head(\"crime\", num_rows=3)","840b92fb":"# Schema and dtypes of the variables in the crime table\nbq_assistant.table_schema(\"crime\")","0bc5e2c8":"# Query construction to look at macro trends (total incidents reported, arrests, and percent of arrests) over the years\nquery_all = \"\"\"SELECT year,\n                COUNT(*) AS Incidents,\n                COUNTIF(arrest = TRUE) AS Arrests,\n                COUNTIF(arrest = TRUE) \/ COUNT(*) AS Pct_Arrested\n            FROM `bigquery-public-data.chicago_crime.crime`\n            GROUP BY year\n            ORDER BY year\"\"\"\n# Run query and store in pandas df\nresponse_all = chicago_crime.query_to_pandas_safe(query_all)\n\n# Set plot size and text size\nfig, ax1 = plt.subplots(figsize=(15,8))\nplt.rcParams['font.size'] = 15\n\n#Create plot with bars for incidents and arrests\nax1.set_xlabel('Year')\nax1.set_ylabel('Count')\nax1.bar(x = response_all.year, height = response_all.Incidents, label = \"Incidents\")\nax1.bar(x = response_all.year, height = response_all.Arrests, label = \"Arrests\")\nplt.yticks(np.arange(0, 650000, 100000))\n# Set correct tick marks on x-axis\nplt.xticks(np.arange(min(response_all.year), max(response_all.year)+1, step=1), rotation = 'vertical')\nax1.legend(loc=2)\n# Create second axis with the same x-axis for percent arrested\nax2 = ax1.twinx() \n# Create line for percent arrested over time\ncolor = 'tab:red'\nax2.set_ylabel('% Arrested')\nax2.plot(response_all.year, response_all.Pct_Arrested*100, color = color, label = \"% Arrested\", linewidth = 3)\nax2.legend(loc=0)\n\nplt.show()","757bedc2":"# Construct a query to get a better understanding of most common types of incident and arrests and their percentages of arrests. \nquery_type_count = \"\"\"SELECT primary_type, \n                            COUNT(*) AS Incidents, \n                            COUNTIF(arrest = TRUE) AS Arrests, \n                            (COUNTIF(arrest = TRUE) \/ COUNT(*)) * 100 AS Percent_Arrests \n                    FROM `bigquery-public-data.chicago_crime.crime` \n                    GROUP BY primary_type \n                    ORDER BY Arrests DESC\"\"\"\nchicago_crime.query_to_pandas_safe(query_type_count)","c268e997":"# Initial query to get incidents by type over time\nquery_incidents = \"\"\"SELECT year,\n                    primary_type,\n                    COUNT(*) AS Incidents\n                FROM `bigquery-public-data.chicago_crime.crime`\n                GROUP BY year, primary_type\"\"\"\ndf_incidents = chicago_crime.query_to_pandas_safe(query_incidents)\n# Initial query to get arrests by type over time\nquery_arrest = \"\"\"SELECT year,\n                    primary_type,\n                    COUNT(*) AS Arrests\n                FROM `bigquery-public-data.chicago_crime.crime`\n                WHERE arrest = TRUE\n                GROUP BY year, primary_type\"\"\"\ndf_arrests = chicago_crime.query_to_pandas_safe(query_arrest)\n\n# Using df in previous cell, create lists of most common types of incidents and arrests, this will be used to filter the query results to remove less significant types\n# PS if anyone has ideas of how to integrate this filter step into the query, perhaps using RANK OVER PARTITION, please let me know. \ntop_incidents = ['THEFT', 'BATTERY', 'CRIMINAL DAMAGE', 'NARCOTICS', 'OTHER OFFENSE', 'ASSAULT', 'BURGLARY', 'MOTOR VEHICLE THEFT', 'DECEPTIVE PRACTICE']\ntop_arrests = ['NARCOTICS', 'BATTERY', 'BATTERY', 'CRIMINAL TRESSPASS', 'ASSAULT','OTHER OFFENSE', 'PROSTITUTION', 'WEAPONS VIOLATION', 'CRIMINAL DAMAGE']\n# Use the lists to filter the query responses\ndf_incidents = df_incidents.loc[df_incidents['primary_type'].isin(top_incidents)]\ndf_arrests = df_arrests.loc[df_arrests['primary_type'].isin(top_arrests)]\n\n#Set plot figure size and text size\nplt.rcParams['font.size'] = 22\nfig = plt.figure(figsize = (25, 30))\n\n# First plot, count of incidents by type\nax1 = fig.add_subplot(211)\nax1.set_title(\"Count of Incidents by Type\")\n# Set correct tick marks on x-axis\nplt.xticks(np.arange(min(df_incidents.year), max(df_incidents.year)+1, step=1))\n# Use for loop to apply name of incident as label to each type's line\nfor name, group in df_incidents.groupby('primary_type'):\n    group.plot(x='year', y='Incidents', ax=ax1, label=name)\nax1.legend(loc=0, fontsize='small')\n# Second plot, count of arrests by type\nax2 = fig.add_subplot(212)\nax2.set_title(\"Count of Arrests by Type\")\n# Set correct tick marks on x-axis\nplt.xticks(np.arange(min(df_arrests.year), max(df_arrests.year)+1, step=1))\n# Use for loop to apply name of incident as label to each type's line\nfor name, group in df_arrests.groupby('primary_type'):\n    group.plot(x='year', y='Arrests', ax=ax2, label=name)\nax2.legend(loc=0, fontsize='small')","7c007537":"# Construct query to calculate the % change for each year by the type of arrest\nquery_pct_change_arrest = \"\"\"SELECT\n  primary_type,\n  FORMAT('%3.2f', (COUNTIF(year = 2002) - COUNTIF(year = 2001)) \/ CASE WHEN COUNTIF(year = 2001) = 0 THEN NULL ELSE COUNTIF(year = 2001) END) AS d2002,\n  FORMAT('%3.2f', (COUNTIF(year = 2003) - COUNTIF(year = 2002)) \/ CASE WHEN COUNTIF(year = 2002) = 0 THEN NULL ELSE COUNTIF(year = 2002) END) AS d2003,\n  FORMAT('%3.2f', (COUNTIF(year = 2004) - COUNTIF(year = 2003)) \/ CASE WHEN COUNTIF(year = 2004) = 0 THEN NULL ELSE COUNTIF(year = 2004) END) AS d2004,\n  FORMAT('%3.2f', (COUNTIF(year = 2005) - COUNTIF(year = 2004)) \/ CASE WHEN COUNTIF(year = 2005) = 0 THEN NULL ELSE COUNTIF(year = 2005) END) AS d2005,\n  FORMAT('%3.2f', (COUNTIF(year = 2006) - COUNTIF(year = 2005)) \/ CASE WHEN COUNTIF(year = 2006) = 0 THEN NULL ELSE COUNTIF(year = 2006) END) AS d2006,\n  FORMAT('%3.2f', (COUNTIF(year = 2007) - COUNTIF(year = 2006)) \/ CASE WHEN COUNTIF(year = 2007) = 0 THEN NULL ELSE COUNTIF(year = 2007) END) AS d2007,\n  FORMAT('%3.2f', (COUNTIF(year = 2008) - COUNTIF(year = 2007)) \/ CASE WHEN COUNTIF(year = 2008) = 0 THEN NULL ELSE COUNTIF(year = 2008) END) AS d2008,\n  FORMAT('%3.2f', (COUNTIF(year = 2009) - COUNTIF(year = 2008)) \/ CASE WHEN COUNTIF(year = 2009) = 0 THEN NULL ELSE COUNTIF(year = 2009) END) AS d2009,\n  FORMAT('%3.2f', (COUNTIF(year = 2010) - COUNTIF(year = 2009)) \/ CASE WHEN COUNTIF(year = 2010) = 0 THEN NULL ELSE COUNTIF(year = 2010) END) AS d2010,\n  FORMAT('%3.2f', (COUNTIF(year = 2011) - COUNTIF(year = 2010)) \/ CASE WHEN COUNTIF(year = 2011) = 0 THEN NULL ELSE COUNTIF(year = 2011) END) AS d2011,\n  FORMAT('%3.2f', (COUNTIF(year = 2012) - COUNTIF(year = 2011)) \/ CASE WHEN COUNTIF(year = 2012) = 0 THEN NULL ELSE COUNTIF(year = 2012) END) AS d2012,\n  FORMAT('%3.2f', (COUNTIF(year = 2013) - COUNTIF(year = 2012)) \/ CASE WHEN COUNTIF(year = 2013) = 0 THEN NULL ELSE COUNTIF(year = 2013) END) AS d2013,\n  FORMAT('%3.2f', (COUNTIF(year = 2014) - COUNTIF(year = 2013)) \/ CASE WHEN COUNTIF(year = 2014) = 0 THEN NULL ELSE COUNTIF(year = 2014) END) AS d2014,\n  FORMAT('%3.2f', (COUNTIF(year = 2015) - COUNTIF(year = 2014)) \/ CASE WHEN COUNTIF(year = 2015) = 0 THEN NULL ELSE COUNTIF(year = 2015) END) AS d2015,\n  FORMAT('%3.2f', (COUNTIF(year = 2016) - COUNTIF(year = 2015)) \/ CASE WHEN COUNTIF(year = 2016) = 0 THEN NULL ELSE COUNTIF(year = 2016) END) AS d2016,\n  FORMAT('%3.2f', (COUNTIF(year = 2017) - COUNTIF(year = 2016)) \/ CASE WHEN COUNTIF(year = 2017) = 0 THEN NULL ELSE COUNTIF(year = 2017) END) AS d2017\nFROM\n  `bigquery-public-data.chicago_crime.crime`\nWHERE\n  arrest = TRUE\nGROUP BY\n  primary_type\nORDER BY COUNTIF(year = 2018) DESC\"\"\"\n\nresponse_pct_change_arrest = chicago_crime.query_to_pandas_safe(query_pct_change_arrest)\nresponse_pct_change_arrest","1337b898":"query_narcotics_pct = \"\"\"SELECT primary_type,\n                            COUNTIF(year = 2015) AS Incidents_2015,\n                            COUNTIF(year = 2015 AND arrest = TRUE) AS Arrests_2015,\n                            ( COUNTIF(year = 2015 AND arrest = TRUE)\/ CASE WHEN COUNTIF(year = 2015) = 0 THEN NULL ELSE COUNTIF(year = 2015) END ) * 100 AS Pct_2015,\n                            COUNTIF(year = 2016) AS Incidents_2016,\n                            COUNTIF(year = 2016 AND arrest = TRUE) AS Arrests_2016,\n                            ( COUNTIF(year = 2016 AND arrest = TRUE)\/ CASE WHEN COUNTIF(year = 2016) = 0 THEN NULL ELSE COUNTIF(year = 2016) END ) * 100 AS Pct_2016,\n                            ( ( ( COUNTIF(year = 2016 AND arrest = TRUE)\/ CASE WHEN COUNTIF(year = 2016) = 0 THEN NULL ELSE COUNTIF(year = 2016) END ) -\n                                ( COUNTIF(year = 2015 AND arrest = TRUE)\/ CASE WHEN COUNTIF(year = 2015) = 0 THEN NULL ELSE COUNTIF(year = 2015) END ) ) \/\n                                    ( COUNTIF(year = 2015 AND arrest = TRUE)\/ CASE WHEN COUNTIF(year = 2015) = 0 THEN NULL ELSE COUNTIF(year = 2015) END ) ) * 100 AS Pct_Delta\n                            FROM `bigquery-public-data.chicago_crime.crime`\n                            GROUP BY primary_type\n                            ORDER BY Incidents_2016 DESC\"\"\"\n\npct_delt = chicago_crime.query_to_pandas_safe(query_narcotics_pct)\n# Filter resulting df for only top 15 rows for the bar plot\npct_delt = pct_delt.head(15)\n\n#Set plot figure size and text size\nplt.rcParams['font.size'] = 11\nfig = plt.figure(figsize = (17, 25))\n# Create horizontal barchart for % deltas\nfig, ax = plt.subplots()\nax.barh(pct_delt.primary_type, pct_delt.Pct_Delta)\n# Lables and show plot + full df\nax.set_xlabel('Percent Delta')\nax.set_title('Pct Delta for Pct of Arrests of Top 10 types by Count of Incidents in 2016')\nplt.show()\nchicago_crime.query_to_pandas_safe(query_narcotics_pct)","f525c7e1":"# Query to get count of incidents of type battery, narcotics, and theft by hour of day\nquery_hour_type = \"\"\"SELECT EXTRACT(HOUR FROM date)  AS Hour,\n                        COUNTIF(year = 2018 AND primary_type = 'BATTERY') AS Count_Battery,\n                        COUNTIF(year = 2018 AND primary_type = 'NARCOTICS') AS Count_Narcotics,\n                        COUNTIF(year = 2018 AND primary_type = 'THEFT') AS Count_Theft\n                FROM `bigquery-public-data.chicago_crime.crime`\n                GROUP BY Hour\n                ORDER BY Hour\"\"\"\nhour_type = chicago_crime.query_to_pandas_safe(query_hour_type)\n\n# Set plot figure size\nfig = plt.figure(figsize = (20, 7))\n\n# Create subplots for each type of incident\n\nax = fig.add_subplot(131)\nax.bar(hour_type.Hour, hour_type.Count_Battery)\nax.set_title('Battery Incidents By Hour of Day')\nplt.xlabel('Hour')\n\nax2 = fig.add_subplot(132)\nax2.bar(hour_type.Hour, hour_type.Count_Narcotics)\nax2.set_title('Narcotics Incidents By Hour of Day')\nplt.xlabel('Hour')\n\nax3 = fig.add_subplot(133)\nax3.bar(hour_type.Hour, hour_type.Count_Theft)\nax3.set_title('Theft Incidents By Hour of Day')\nplt.xlabel('Hour')\n\nplt.show()","eb1f31d4":"Now that we know the most common types of incidents and arrests, how have these been trending over the previous years?","c12f7bb2":"Here we will look at some micro trends. First, we look at the hour of the day specific types of incidents of crime are occurring. ","2f6d95e5":"We also saw a steep drop in the percent of incidents of crime that resulted in an arrest from 2015-2016. Below we see across the board of the most common incidents, the percentage of arrests decreased. For instance, percent of arrests for theft incidents dropped 10%, criminal damage dropped 16%, assault dropped nearaly 22% and decpetive practive dropped 31%. \n\nThese percent decreases can be interpreted as: In 2015, of the 17,044 reported incidents dealing with assault, roughly 24% of those incidents resulted in an arrest. While in 2016, of the 18,737 reported incidents dealing with assualt, only 18% of those incidents resulted in an arrest, which represents a 21.7% decline. ","1b8eeb01":"Let's start by examining the macro trends of incidents of crime in Chicago. ","b7810253":"**How to Query the Chicago Crime Dataset (BigQuery)**","e7341c89":"What are the most common types of arrests? We will use this information to target relevant types (Note: this table is for all time).","a5f060cc":"We see a couple noteable trends that could warrant further investigation. First, since 2001, both yearly incidents of crime and yearly arrests have been declining. There was also a steep drop in the percent of incidents of crime that resulted in an arrest from 2015-2016. ","6279bafe":"To get a more granular view into yearly changes in these types of crimes, we can construct a query that will return the percent change in yearly arrests for each type.","9b631738":"We will start by looking further into the decline in yearly incidents and arrests. Two areas I am curious about are the type and location. I want to know if there have been significant decreases in types of crimes or if any locations have seen decreases in number of crimes. ","5ee115be":"\nAlthough this is definitely an eye chart, by focusing on specific types or years we can find very useful information. For instance, narcotics arrests declined 80% in 2016.. In 2017, there are a number of interesting insights. In 2017, arrests for weapons violations increased 32% while homicide arrests decreased 57%. Knowing this, I would want to do more research to see if resources spent dealing with weapons violations are correlated with less homicides. "}}