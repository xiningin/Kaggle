{"cell_type":{"459dbb4b":"code","a0e57bef":"code","cfa501a3":"code","a6bece83":"code","dc8df1fa":"markdown","0d959cef":"markdown"},"source":{"459dbb4b":"%matplotlib inline\nimport os\nimport pandas as pd\nimport datetime as dt\nimport numpy as np\nfrom IPython.core.interactiveshell import InteractiveShell\nInteractiveShell.ast_node_interactivity = \"all\"\nimport datetime as dt\nfrom tqdm import tqdm\nimport matplotlib.pyplot as plt\nimport seaborn as sns","a0e57bef":"plt.rcParams['figure.figsize'] = [16, 10]\nplt.rcParams['font.size'] = 18\npd.set_option('display.max_columns', 99)\nstart = dt.datetime.now()\n\nvalidation_splits = pd.DataFrame([\n    ['Atlanta', 33.791, 33.835],\n    ['Boston', 42.361, 42.383],\n    ['Chicago', 41.921, 41.974],\n    ['Philadelphia', 39.999, 40.046],\n], columns=['City', 'l1', 'l2'])\n\ntrain = pd.read_csv(\n    '..\/input\/bigquery-geotab-intersection-congestion\/train.csv')\ntest = pd.read_csv('..\/input\/bigquery-geotab-intersection-congestion\/test.csv')\n\ntrain['IsTrain'] = 1\ntest['IsTrain'] = 0\n\nfull = pd.concat([train, test], sort=True)\n\nfull = full.merge(validation_splits, on='City')\nfull['ValidationGroup'] = 1\nfull.loc[full.Latitude <= full.l1 , 'ValidationGroup'] = 0\nfull.loc[full.Latitude > full.l2 , 'ValidationGroup'] = 2\nfull.drop(['l1', 'l2'], axis=1, inplace=True)\n\nm = full.groupby(['City', 'IntersectionId'])[[\n    'IsTrain', 'Latitude', 'Longitude']].mean()\nc = full.groupby(['City', 'IntersectionId'])[['RowId']].count()\ndf = pd.merge(m, c, left_index=True, right_index=True)\ndf = df.rename(columns={'RowId': 'Cnt'})\ndf = df.reset_index()","cfa501a3":"for i, city in enumerate(df.City.unique()):\n    coords = df[df.City == city]\n    fig, ax = plt.subplots()\n    sc = ax.scatter(\n        y=coords.Latitude,\n        x=coords.Longitude,\n        c=coords.IsTrain,\n        s = 3 * np.sqrt(coords.Cnt),\n        alpha=0.7,\n        linewidths=0.,\n        cmap=plt.cm.RdYlGn\n    )\n    l1 = validation_splits[validation_splits.City == city].l1.values[0]\n    l2 = validation_splits[validation_splits.City == city].l2.values[0]\n    plt.plot([coords.Longitude.min(), coords.Longitude.max()],\n             [l1, l1], color='orange', lw = 3)\n    plt.plot([coords.Longitude.min(), coords.Longitude.max()],\n             [l2, l2], color='green', lw = 3)\n    plt.grid()\n    cbar = plt.colorbar(sc, orientation='horizontal')\n    cbar.set_label('Train observations%')\n    plt.tight_layout()\n    plt.title(f'{city} - train\/test split')\n    plt.ylabel('Latitude')\n    plt.xlabel('Longitude')\n    \nplt.show();","a6bece83":"full.groupby(['IsTrain', 'ValidationGroup'])[['RowId']].count()","dc8df1fa":"# Overfitting investigation\n\nWe have seen that the train and test set significanty different [1].\n\nWe also experienced large difference between local validation and LB score.\n\nLet's check the train-test spatial distribution!\n\n### References\n[1] **Bojan Tunguz**: https:\/\/www.kaggle.com\/tunguz\/adversarial-geotab\n","0d959cef":"### We need to overfit in the orange area and use more conservative models for the red\/green intersections"}}