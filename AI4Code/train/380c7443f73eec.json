{"cell_type":{"bfcce8b9":"code","1df09143":"code","9cf973dc":"code","6ca776e3":"code","60ba1849":"code","c059aa74":"code","2c40b4bb":"code","09389196":"code","85f89b88":"code","dfb74f66":"code","9e7557c6":"code","93704125":"code","c3d05df6":"code","00856923":"code","0649be30":"code","8bbf60c6":"code","01fde9f9":"code","50ab8a76":"code","290f306b":"code","12daac65":"code","39f6a2f4":"code","0dd4055e":"code","0433fd0a":"code","a3191894":"code","72c22e9b":"code","2dc394b4":"code","a3ef74ae":"code","400127e3":"code","f9a7c390":"code","55988005":"code","8dabdbe2":"code","015da78b":"code","7b52a4ae":"code","2f911dd2":"code","3ec2e4fa":"code","faa000f5":"code","6fca332b":"code","09dc47bb":"code","e47c764e":"code","0fa53e8f":"code","2b82eb7d":"code","6615e043":"code","0488e57c":"code","a15c3fab":"code","d7895f4c":"code","08fcf36a":"code","c0ecd540":"code","966a2ab3":"code","f49d5d71":"code","cd682208":"code","a3156074":"code","80945c9e":"code","8e11b81a":"code","67f444cf":"code","7fa0d66f":"code","dd25ff7d":"code","8b09fd83":"markdown","8deda8fa":"markdown","55b4cc0f":"markdown","61ee9e89":"markdown","5f29e022":"markdown","16165f73":"markdown","f7d78f4a":"markdown","2003f680":"markdown","abc8664d":"markdown","2fe99df4":"markdown","e0d10590":"markdown","7cc3a81f":"markdown","89fb7620":"markdown","07eeda39":"markdown","732ce4bb":"markdown","35ed52d6":"markdown","b111d6a1":"markdown","6d059082":"markdown","572556a7":"markdown","1255abf5":"markdown","3494fe92":"markdown","5cf791cb":"markdown","7381eb57":"markdown","0ac75ec0":"markdown"},"source":{"bfcce8b9":"#Import needed Libraries\nimport numpy as np\nimport pandas as pd\nimport matplotlib.pyplot as plt\n%matplotlib inline\nimport seaborn as sns\nimport csv\nimport sklearn\nfrom sklearn.preprocessing import StandardScaler\nfrom sklearn.metrics import recall_score,precision_score,precision_recall_curve,confusion_matrix,recall_score\nfrom sklearn.model_selection import cross_val_predict\nfrom sklearn.ensemble import RandomForestClassifier,GradientBoostingClassifier\n","1df09143":"#File Contains Non-informative columns\ndata=pd.read_csv('\/kaggle\/input\/credit-card-customers\/BankChurners.csv',na_values='NULL')\ndata=data[data.columns[:-2]]\ndata.head(5)","9cf973dc":"np.random.seed=42;seed=42","6ca776e3":"data.shape","60ba1849":"data.Attrition_Flag.value_counts()","c059aa74":"data.info()","2c40b4bb":"#Analysing Customers Age\nage=data.Customer_Age.astype(\"int64\")\nage.describe()","09389196":"fig=plt.figure(figsize=(5,5))\nplt.title('Age_Plot')\nplt.hist(age,color='g')\nplt.grid(True)\nplt.xlabel('Age_In_Years')\nfor x in [0.25,0.50,0.75]:\n    plt.axvline(age.quantile(x),c='r',lw=2.0)\nplt.show()","85f89b88":"data.Customer_Age=age;del age","dfb74f66":"data.info()","9e7557c6":"#Gender\ngender=data.Gender\ngender.value_counts()","93704125":"plt.hist(data.Gender,bins=4)\nplt.xticks(ticks=[0,1],labels=['Male','Female'])\nplt.title('Gender_Plot');plt.grid('True')\nplt.show()","c3d05df6":"data.Gender.replace(['F','M'],[0,1],inplace=True)","00856923":"#Dependency Count\ndependency=data.Dependent_count.astype('int64')\ndependency.describe()","0649be30":"plt.figure(figsize=(8,10))\nplt.title('Dependent_Plot')\nplt.hist(dependency,color='g')\nplt.grid('True')\nplt.show()","8bbf60c6":"data.Dependent_count=dependency","01fde9f9":"data.info()","50ab8a76":"#Converting Object dtype to Float Numbers\nfor x in data.columns[-12:]:\n    data[x]=data[x].astype('float64')\ndata.head(5)","290f306b":"data.info()","12daac65":"#Credit Limit \ndata.Credit_Limit.describe()","39f6a2f4":"#plot of credit limit\nfig,(ax1,ax2,ax3)=plt.subplots(1,3,figsize=(20,10))\nfig.suptitle('Credit_Limit_Plot')\nax1.set_title('Hist_Of _Credit_Limit')\nax1.hist(data.Credit_Limit,color='r')\nax1.set_xlabel('Credit_Limit')\nax2.set_title('Boxplot_Of_Credit_Limit')\nsns.boxplot(y=data.Credit_Limit,orient='v',color='g',ax=ax2)\nax2.set_xlabel('Credit_Limit')\nax3.set_title('Violin_Plot_Of_Credit_Limit')\nsns.violinplot(y=data.Credit_Limit,orient='v',color='b',ax=ax3)\nax3.set_xlabel('Credit_Limit')\nax2.grid('True');ax1.grid('True');ax3.grid('True')\nplt.show()","0dd4055e":"#Box Plots\nfig,(ax1,ax2)=plt.subplots(1,2,figsize=(10,10))\nfig.suptitle('BoxPlots')\nax1.set_title('Total_Rev_Bal & Trans_Amt')\nsns.boxplot(data=data[['Total_Revolving_Bal','Total_Trans_Amt']],ax=ax1)\nax2.set_title('Tot_Amt_Chg & Ct & Avg_ut_Rat')\nsns.boxplot(data=data[['Total_Amt_Chng_Q4_Q1','Total_Ct_Chng_Q4_Q1','Avg_Utilization_Ratio']],ax=ax2)\nplt.xticks([0,1,2],['Total_Amt_Chng','Total_Ct_Chng','Avg_Utilization'])\nplt.show()","0433fd0a":"object_data=data.select_dtypes('object')\nobject_data.head(5)","a3191894":"#1.Attrition_Flag Mapping\nobject_data.Attrition_Flag.replace(['Existing Customer','Attrited Customer'],[0,1],inplace=True)\n# Card Category Mapping\nobject_data.Card_Category.replace(['Blue','Silver','Gold','Platinum'],[0,1,2,3],inplace=True)\n#Income Category Mapping\nobject_data.Income_Category.replace([x for x in data.Income_Category.value_counts().index],[0,1,2,3,4,5],inplace=True)\n# Education Level Mapping\nobject_data.Education_Level.replace(['Unknown','Uneducated','High School','College','Graduate','Post-Graduate','Doctorate'],[0,1,2,3,4,5,6],inplace=True)\nobject_data.head(5)","72c22e9b":"data.Marital_Status.value_counts()","2dc394b4":"#Marital Status Mapping\nobject_data.Marital_Status.replace(['Unknown','Single','Married','Divorced'],[0,1,2,3],inplace=True)\nobject_data.head(5)","a3ef74ae":"for x in object_data.columns:\n    data[x]=object_data[x]\ndata.head(5)","400127e3":"data.drop('CLIENTNUM',axis=1,inplace=True)","f9a7c390":"#HeatMap of correlations\nfig=plt.figure(figsize=(20,20))\ncorrmat=data.corr()\nmask=np.array(corrmat)\nmask[np.tril_indices_from(mask)]=False\nsns.heatmap(corrmat,mask=mask,annot=True,vmax=1.0,square=True)\nplt.show()","55988005":"data['Avg_per_Total_Rev']=round(data['Avg_Open_To_Buy']\/(data['Total_Revolving_Bal']+1),3)\ndata.head(5)","8dabdbe2":"data['Avg_per_Total_Trans']=round((data['Avg_Open_To_Buy']+1)\/(1+data['Total_Trans_Amt']),3)","015da78b":"data.head(5)","7b52a4ae":"#Droping some features\ndata.drop(['Avg_Open_To_Buy','Marital_Status','Education_Level','Card_Category','Dependent_count'],axis=1,inplace=True)\ndata.head(5)","2f911dd2":"#Taking the Log of some features\ncol=['Credit_Limit','Customer_Age','Months_on_book','Total_Relationship_Count','Total_Revolving_Bal','Total_Trans_Amt','Total_Trans_Ct','Avg_per_Total_Rev','Avg_per_Total_Trans']\nfor x in col:\n    data[x]=np.log10(data[x]+1)\ndata.head(5)","3ec2e4fa":"#HeatMap of Transformed features correlations\nfig=plt.figure(figsize=(15,15))\ncorrmat=data.corr()\nmask=np.array(corrmat)\nmask[np.tril_indices_from(mask)]=False\nsns.heatmap(corrmat,mask=mask,annot=True,vmax=1.0,square=True)\nplt.title('Heatmap Of Transformed Features Correlation',size=30)\nplt.show()","faa000f5":"#Split the Data Into test and train using StratifiedShuffleSplit\nfrom sklearn.model_selection import StratifiedShuffleSplit as sss\nsplit=sss(n_splits=1,test_size=0.20,random_state=42)\nfor x,y in split.split(data,data['Attrition_Flag']):\n    train=data.loc[x];test=data.loc[y]\nprint('Train',train.shape,'\\n','Test',test.shape)","6fca332b":"#Extracting Target Features of Train and Test\ny_train=train.Attrition_Flag.values\ny_test=test.Attrition_Flag.values\ntrain.drop('Attrition_Flag',axis=1,inplace=True)\ntest.drop('Attrition_Flag',axis=1,inplace=True)\ny_train.shape","09dc47bb":"train.head(5)","e47c764e":"# STANDARD SCALING\nscaler=sklearn.preprocessing.StandardScaler()\nscaler.fit(train)\ntrain=scaler.transform(train)\ntest=scaler.transform(test)\ntrain[:3]","0fa53e8f":"#Function to return Prediction,Decision_Function,confusion_matrix and classifcation report\ndef f(classifier,x,y,Method):\n    pre=cross_val_predict(classifier,x,y,cv=5)\n    pre_thresh=cross_val_predict(classifier,x,y,cv=5,method=Method)\n    con_mat=confusion_matrix(y,pre)\n    precision=precision_score(y,pre)\n    recall=recall_score(y,pre)\n    print('confusion_matrix:','\\n',con_mat,'\\n','\\n','precision_score:',round(precision,3),'\\n','\\n','recall_score:',round(recall,3))\n    return pre,pre_thresh","2b82eb7d":"#Function To Display Precision_Recall_Curve\ndef curve(thresh,title):\n    precision,recall,threshold=precision_recall_curve(y_train,thresh)\n    plt.figure(figsize=(8,10))\n    plt.plot(threshold,precision[:-1],c='r',label='Precision',lw=2)\n    plt.plot(threshold,recall[:-1],c='g',label='Recall',lw=2)\n    plt.legend(loc='best')\n    plt.xlabel('Threshold')\n    plt.ylabel('Precision_Recall')\n    plt.title(title)\n    plt.grid('True')\n    plt.show()","6615e043":"#Selecting Best Number Of Estimators\nestimators=[2,5,10,20,35,50,75,100,150,200,220,250,300];scores=[];\nfor x in estimators:\n    forest_clf=RandomForestClassifier(n_estimators=x,random_state=42)\n    forest_pre=cross_val_predict(forest_clf,train,y_train,cv=5)\n    scores.append(recall_score(y_train,forest_pre))\n# Plot of Scores vs Estimators\nplt.figure(figsize=(8,8))\nplt.plot(estimators,scores,'r*--',lw=2.5)\nplt.xlabel('Number of Estimators')\nplt.ylabel('Scores')\nplt.title('Random_Forest_Estimators_vs_Scores_Plot')\nplt.grid('True')\nplt.show()\n          ","0488e57c":"forest_clf=RandomForestClassifier(random_state=42,n_estimators=220)\nforest_clf.fit(train,y_train)","a15c3fab":"forest_pre,forest_proba=f(forest_clf,train,y_train,'predict_proba')","d7895f4c":"curve(forest_proba[:,-1],'RandomForest_Precision_Recall_Curve')","08fcf36a":"# Predicting Test data\nforest_test=forest_clf.predict(test)","c0ecd540":"#Test Data Recall Score\nrecall_score(y_test,forest_test)","966a2ab3":"#Finding Best Estimators for GradientBoostingClassifier\nestimators=[2,5,10,20,35,50,100,150,200,250,270];scores=[]\nfor x in estimators:\n    grad_clf=GradientBoostingClassifier(n_estimators=x,random_state=42)\n    grad_pre=cross_val_predict(grad_clf,train,y_train,cv=5)\n    scores.append(recall_score(y_train,grad_pre))\nplt.figure(figsize=(8,8))\nplt.title('GradientBoost_Estimators_Vs_Scores')\nplt.xlabel('Number Of Estimators')\nplt.ylabel('Scores')\nplt.plot(estimators,scores,'r*--',lw=2.5)\nplt.grid('True')\nplt.show()","f49d5d71":"grad_clf=GradientBoostingClassifier(random_state=42,n_estimators=250)\ngrad_clf.fit(train,y_train)","cd682208":"grad_pre,grad_proba=f(grad_clf,train,y_train,'predict_proba')","a3156074":"print('Fig 1.5')\ncurve(grad_proba[:,-1],'GradientBoosting Precision Recall Curve')","80945c9e":"# Predicting Test Data\ngrad_test=grad_clf.predict(test)","8e11b81a":"#Test Recall Score\nrecall_score(y_test,grad_test)","67f444cf":"for x,y in zip(data.columns,grad_clf.feature_importances_):\n    print(x,'\\t',round(y,5))","7fa0d66f":"#Set The Threshold for Decision Making at 0.2 For GradientBoosting\nthreshold=0.2\ngrad_tradeoff_dec=grad_proba[:,-1]\ngrad_tradeoff_pre=np.where(grad_tradeoff_dec>=0.2,1,0)\nprint('confusion_matrix:','\\n',confusion_matrix(y_train,grad_tradeoff_pre),'\\n','\\n','Precision_Score:',round(precision_score(y_train,grad_tradeoff_pre),3),'\\n','\\n','Recall_Score:',round(recall_score(y_train,grad_tradeoff_pre),3))","dd25ff7d":"#PREDICTING TEST DATA\ngrad_tradeoff_test_proba=grad_clf.predict_proba(test)[:,-1]\ngrad_tradeoff_test_pre=np.where(grad_tradeoff_test_proba>=0.2,1,0)\nprint('Test_Precision_Score:',round(precision_score(y_test,grad_tradeoff_test_pre),3),'\\n','\\n','Test Recall Score:',round(recall_score(y_test,grad_tradeoff_test_pre),3))","8b09fd83":"The result above shows that a threshold of 0.2 yields a recall score of 0.932 and precision score of 0.863\n","8deda8fa":"The data is imbalanced as can be seen above from its Target value counts\nwith 1627 Attrited Customers out of 10127 customers\n","55b4cc0f":"PRECISION-RECALL CALLOFF : Precision and Recall scores vary with each other and with the value of threshold used for decision Making,as Precision increases Recall scores tends to decrease. If the threshold for decision making is decreased higher recall score is acheived while precision score reduces, if we increase the threshold of decision making a higher precision score is acheived with a reduced recall score this can be demonstrated from the Fig 1.5 (Gradient Boosting Precision_Recall_Curve),The threshold is at 0.6 which gives a precision of 0.943 and recall of 0.882. If the threshold is reduced to 0.2 we will acheive a recall of 0.9+ while precision will be 0.83. To achieve a recall of 1.0 the threshold 0.0 while precision will be between 0.35 and 0.40. The Business Objective is to predict as much Customers who are more likely to churn or be attrited this will be achieved by setting the threshold to get a high recall while keeping the precision at a reasonable point\n  ","61ee9e89":"The Results above shows that features such as Total_Trans_Amt and Total_Chng_Q4_Q1 are the most informative and contributes significantly to the GradientBoosting Model while features such as Gender,Customer Age and Total_Ct_Chng_Q4_Q1 can be considered inconsequential and contributes less to the model and can be dropped.","5f29e022":"PRECISION-RECALL CALLOFF","16165f73":"There are no hard rules for altering thresholds to make decisions, there are numerous ways to achieve this. We can acheive any value for recall and precision by continously varying the threshold.","f7d78f4a":"# MODEL BUILDING ","2003f680":"Task: Predict Customers who are likely to Abandon or lose interest int their services with the bank(Not Specified). in technical terms achieve a high recall score while keeping the precision score at a considerable point.","abc8664d":"Gradient Boosting Classifier Gives a Recall score of 0.885 and a Precision Score of 0.943 on Train Data using Cross Validation and a Recall of 0.852 on Test data","2fe99df4":"The Boxplots of several Features with Continous Values are shown above.\nThe Boxplot shows the presence of much outliers for some of the features","e0d10590":"The heatmap of corelations between the features is shown above. \nFrom the heatmap some features shows very weak correlations with the Target varaible(Attrition_Falg) features such as Education_Level,Credit_Limit,Card_Category,Avg_Open_To_Buy.\nThe Heatmap also shows perfect corrleations between Credit_Limit and Avg_Open_To_Buy,which suggests that one of the features will not be useful. Features such as Dependent_counts,Marital_Status shows weak correlation with every all other features","7cc3a81f":"The features contains values of varying magnitude. Values with higher magnitudes will have higher weights when buildingodels for this reason Features with higher magnitudes were transformed to the log to base 10 of their values to shrink their weights and put them on par with other features to prevent overfitting","89fb7620":"The Histplot above shows That majority of the customers have Credit Limits less than 10000,From the violin plot it can be seen that more customers have limits around 5000. The Boxplot shows the presence of outliers,some customers have credit limits as high as 30000. We have to deal with the outliers since this feature will most likely be an informative one ","07eeda39":"ANALYSING FEATURE IMPORTANCES","732ce4bb":"Target Column is Attrition_Flag Column ","35ed52d6":"# BANK CHURNERS","b111d6a1":"Heatmap of Transformed and Extracted Features is shown above","6d059082":"RANDOM FOREST CLASSIFIER","572556a7":"GRADIENT BOOSTING CLASSIFIER","1255abf5":"Most Columns with dtype as object are digits and can be directly transformed to float point numbers ","3494fe92":"Some important Functions will be written and  to avoid repeating codes\n","5cf791cb":"# Handling Features with non-numeric dtypes","7381eb57":"data have no missing point","0ac75ec0":"The Age plot above shows a normal distribution. The Vertical Lines Indicates Quarterly Quantiles "}}