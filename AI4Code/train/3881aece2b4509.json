{"cell_type":{"562f6dcf":"code","0d1dd60d":"code","4e6251bb":"code","9363669b":"code","81bae626":"code","dbcc690e":"code","96430a38":"code","ae2af209":"code","5017f77f":"code","e51047c6":"code","38e60334":"code","aca1fbe1":"code","ff989a53":"code","b490e85d":"code","207d1ca0":"code","ffaa972a":"code","cafe7961":"code","280d9da8":"code","c0add71d":"code","4e78382e":"code","d98e9ac1":"code","e7b705ad":"code","cdb5b886":"code","d9b75b2c":"code","1be447a1":"code","fb6825b3":"code","f75280d5":"code","5c46f71b":"code","2d453675":"code","43780193":"code","67c49d41":"code","c7d5ec88":"code","c5657244":"code","b53234c8":"code","b42b3db8":"code","183b37c6":"code","7af5e592":"code","0c294a21":"code","cf3bf1aa":"code","85003101":"code","43ad3f5e":"code","78862fad":"code","1f69ea4b":"code","d44606d9":"code","b13bd084":"code","c26ae48c":"code","3227d479":"code","382f7de6":"code","22b93bb7":"code","d85f31c7":"code","d50bc40a":"code","404e1232":"code","55186186":"code","1182109a":"code","6157bb47":"code","b0bb3b7d":"code","ff0ec79c":"code","25c5b807":"code","96f46c3a":"code","c8f52339":"code","220166d4":"code","abd6b075":"code","f58d40c5":"code","f7380a0a":"code","bac08267":"code","9b850877":"code","c4ebba18":"code","3f6f63a5":"code","4fc99867":"code","a98c9399":"code","c7153f2f":"code","ca8f5f4f":"code","002fd674":"code","85a7be45":"code","581362fa":"code","86cd9451":"code","c8e08657":"code","bbe49b1e":"code","5aef1f33":"code","3127ec99":"code","de9a7527":"code","e9cbc4f3":"code","8d9135e0":"code","e5b530d4":"code","9a30b3c4":"code","ad69233a":"code","ef65d22e":"markdown","abae15d9":"markdown","171df91c":"markdown","f893192f":"markdown","99fb5b33":"markdown","222a0a11":"markdown","36d19faa":"markdown","3b4113a3":"markdown","bf95449a":"markdown","fcae58f2":"markdown","9e155b20":"markdown","6eb379ba":"markdown","99ac5a45":"markdown","94f1bcb4":"markdown","2643283a":"markdown","9b3e675b":"markdown","cd9df915":"markdown","bb5d9629":"markdown","ef6d1add":"markdown","2fa954ce":"markdown","174c6833":"markdown","3eeb4b84":"markdown","21ee8750":"markdown","f19b39cd":"markdown","8a7ba713":"markdown","2ff78164":"markdown","5f91efc8":"markdown","2908e46b":"markdown","df126854":"markdown","37ee297d":"markdown","b43921d6":"markdown","3783b08c":"markdown","1c7d9c73":"markdown"},"source":{"562f6dcf":"%matplotlib inline\nimport numpy as np\nimport pandas as pd\nfrom fastai.vision import *\nimport matplotlib.pyplot as plt\nimport seaborn as sns\nimport os\nimport shutil\n","0d1dd60d":"path = Path('..\/input\/plant-pathology-2020-fgvc7\/images')","4e6251bb":"path.ls()[0:3]","9363669b":"outpath = Path('\/kaggle\/working')\noutpath.ls()","81bae626":"ii = open_image(path\/'Train_1767.jpg')\nii.show()\n","dbcc690e":"train = pd.read_csv('..\/input\/plant-pathology-2020-fgvc7\/train.csv')\ntest = pd.read_csv('..\/input\/plant-pathology-2020-fgvc7\/test.csv')","96430a38":"classes=['healthy', 'multiple_diseases', 'rust', 'scab']","ae2af209":"train.head(5)","5017f77f":"# https:\/\/www.kaggle.com\/otzhora\/fastai-simple-efficientnet-ensemble-solution\ndef get_tag(row):\n    if row.healthy:\n        return \"healthy\"\n    if row.multiple_diseases:\n        return \"multiple_diseases\"\n    if row.rust:\n        return \"rust\"\n    if row.scab:\n        return \"scab\"\ndef transform_data(train_labels):\n    train_labels.image_id = [image_id+'.jpg' for image_id in train_labels.image_id]\n    train_labels['tag'] = [get_tag(train_labels.iloc[idx]) for idx in train_labels.index]\n    train_labels = train_labels.drop(columns=['healthy', 'multiple_diseases', 'rust', 'scab'])\n    return train_labels","e51047c6":"train_tag = transform_data(train)","38e60334":"train_tag","aca1fbe1":"rust = train_tag[train_tag['tag']=='rust']","ff989a53":"rust.head()","b490e85d":"rust_leaves = list(rust['image_id']);len(rust_leaves)","207d1ca0":"_,axs = plt.subplots(1,3,figsize=(22,22))\nopen_image(path\/'Train_3.jpg').show(ax=axs[0],title='1')\nopen_image(path\/'Train_10.jpg').show(ax=axs[1],title='2')\nopen_image(path\/'Train_15.jpg').show(ax=axs[2],title='3')","ffaa972a":"scab = train_tag[train_tag['tag']=='scab']\nscab.head(10)","cafe7961":"scab_leaves = list(scab['image_id']);len(scab_leaves)","280d9da8":"sc = open_image(path\/'Train_0.jpg')\nsc","c0add71d":"multi_d = train_tag[train_tag['tag']=='multiple_diseases']\nmulti_d.head(10)","4e78382e":"multi_leaves =  list(multi_d['image_id'])","d98e9ac1":"mt1 = open_image(path\/'Train_122.jpg')\nmt2 = open_image(path\/'Train_113.jpg')\nmt3 = open_image(path\/'Train_95.jpg')\n_,axs = plt.subplots(1,3,figsize=(22,22))\nmt1.show(ax=axs[0],title='1')\nmt2.show(ax=axs[1],title='2')\nmt3.show(ax=axs[2],title='3')","e7b705ad":"ht = train_tag[train_tag['tag']=='healthy']\nht.head(10)","cdb5b886":"healthy_leaves = list(ht['image_id'])\nhealthy_leaves[0:3]","d9b75b2c":"ht1 = open_image(path\/'Train_2.jpg')\nht2 = open_image(path\/'Train_4.jpg')\nht3 = open_image(path\/'Train_5.jpg')\n_,axs = plt.subplots(1,3,figsize=(22,22))\nht1.show(ax=axs[0],title='1')\nht2.show(ax=axs[1],title='2')\nht3.show(ax=axs[2],title='3')","1be447a1":"print(len(scab),len(rust),len(multi_d),len(ht))","fb6825b3":"dd = train_tag.groupby('tag')['image_id'].count().reset_index()","f75280d5":"dd","5c46f71b":"sns.barplot(x='tag', y='image_id', data=dd)","2d453675":"# https:\/\/www.kaggle.com\/lextoumbourou\/plant-pathology-2020-eda-training-fastai2\n_, axes = plt.subplots(ncols=4, nrows=1, constrained_layout=True, figsize=(10, 3))\nfor ax, column in zip(axes, classes):\n    train[column].value_counts().plot.bar(title=column,ax=ax)\n\nplt.show()","43780193":"from sklearn.model_selection import train_test_split","67c49d41":"trainsplit,validsplit = train_test_split(train_tag,test_size=0.30,random_state=42,stratify=train_tag['tag'])","c7d5ec88":"trainsplit.shape,validsplit.shape","c5657244":"trainsplitdd = trainsplit.groupby('tag')['image_id'].count().reset_index()","b53234c8":"trainsplitdd","b42b3db8":"validplitdd = validsplit.groupby('tag')['image_id'].count().reset_index()","183b37c6":"validplitdd","7af5e592":"sns.barplot(x='tag', y='image_id', data=trainsplitdd)","0c294a21":"valid_idx = validsplit.index\ntrain_idx = trainsplit.index","cf3bf1aa":"tfms = get_transforms()","85003101":"np.random.seed(42)\nsrc = ImageList.from_df(path=path,df=train_tag).split_by_idx(valid_idx).label_from_df('tag')","43ad3f5e":"src","78862fad":"data_512 = src.transform(tfms,size=512).databunch(bs=8).normalize(imagenet_stats)\n#data_1020 = src.transform(tfms,size=1020).databunch(bs=8).normalize(imagenet_stats)","1f69ea4b":"data_512,data_512.show_batch(5,figsize=(7,7)),data_512.classes,data_512.c","d44606d9":"learn = cnn_learner(data_512,models.densenet169,wd=1e-4,metrics=accuracy,model_dir=outpath)","b13bd084":"learn.lr_find(num_it=300)","c26ae48c":"learn.recorder.plot(suggestion=True)","3227d479":"lr = 2e-3\nlearn.fit_one_cycle(8,lr)","382f7de6":"learn.recorder.plot_losses()","22b93bb7":"learn.save('stage1_512')","d85f31c7":"(outpath).ls()","d50bc40a":"learn.load('stage1_512')","404e1232":"learn.unfreeze()","55186186":"learn.lr_find()","1182109a":"learn.recorder.plot()","6157bb47":"learn.fit_one_cycle(3,slice(8e-6,1e-4))","b0bb3b7d":"learn.save('stage2_512')","ff0ec79c":"#data_1020 = src.transform(tfms,size=1020).databunch(bs=8).normalize(imagenet_stats)\n\n#learn.data = data_1020\n#data_1020.train_ds[0][0].shape","25c5b807":"#learn.freeze()","96f46c3a":"#learn.lr_find()","c8f52339":"#learn.recorder.plot()","220166d4":"#learn.fit_one_cycle(5, slice(lr))","abd6b075":"#learn.save('stage1_1020')","f58d40c5":"\n\n#learn.unfreeze()\n\n","f7380a0a":"#learn.fit_one_cycle(5, slice(1e-5, lr\/5))","bac08267":"#learn.save('stage2_1020')","9b850877":"interp = ClassificationInterpretation.from_learner(learn)","c4ebba18":"interp.plot_confusion_matrix()","3f6f63a5":"interp.plot_top_losses(k=16,figsize=(20,20),heatmap=False)","4fc99867":"learn.load('stage2_512')","a98c9399":"learn.export(outpath\/'export.pkl')","c7153f2f":"outpath.ls()","ca8f5f4f":"test_images = ImageList.from_folder(path)\ntest_images.filter_by_func(lambda x: x.name.startswith(\"Test\"))","002fd674":"test_df = pd.read_csv('..\/input\/plant-pathology-2020-fgvc7\/test.csv')","85a7be45":"test_df.image_id = [image_id+'.jpg' for image_id in test_df.image_id]","581362fa":"test_df.head()","86cd9451":"learn = load_learner(outpath)","c8e08657":"all_test_preds = []\nfrom tqdm import tqdm_notebook as tqdm\nfor item in tqdm(test_images.items):\n    name = item.name[:-4]\n    img = open_image(item)\n    preds = learn.predict(img)[2]\n    all_test_preds.append(preds)\n   # test_df.loc[name]['healthy'] = preds[0]\n   # test_df.loc[name]['multiple_diseases'] = preds[1]\n   # test_df.loc[name]['rust'] = preds[2]\n  #  test_df.loc[name]['scab'] = preds[3]","bbe49b1e":"aa = [f.numpy() for f in all_test_preds]","5aef1f33":"bb = np.stack(aa,axis=0)\nlen(bb)","3127ec99":"bb","de9a7527":"test_df_output = pd.concat([test_df, pd.DataFrame(bb, columns=classes)], axis=1).round(6)","e9cbc4f3":"test_df_output.head()","8d9135e0":"test_df_output['image_id'] = test_df['image_id'].str.strip('.jpg')","e5b530d4":"test_df_output.to_csv('\/kaggle\/working\/submission3.csv',index=False)","9a30b3c4":"data.save(outpath\/'data.pkl')","ad69233a":"outpath.ls()","ef65d22e":"## Create databunch","abae15d9":"Now let's do the same steps for the other classes","171df91c":"# Define paths","f893192f":"## Class distribution","99fb5b33":"There's only a small number of leaves with multiple diseases. The dataset is dominated by scab, rust and healthy plants.","222a0a11":"Questions:\n\n- Are there different steps of the life cycle represented on the dataset (e.g. horns, brownish spots and yellowish spots)?","36d19faa":"### Healthy","3b4113a3":"## Fit","bf95449a":"There is an imbalance, which is most pronouced for multiple_diseases.","fcae58f2":"We are going to split our dataset using a stratificantion strategy because our data is imbalanced","9e155b20":"A serious disease of apples and ornamental crabapples, apple scab (*Venturia inaequalis*) attacks both leaves and fruit. The fungal disease forms **pale yellow or olive-green spots on the upper surface of leaves**. **Dark, velvety spots may appear on the lower surface**. Severely infected leaves become twisted and puckered and may drop early in the summer.\n\nSymptoms on fruit are similar to those found on leaves. Scabby spots are sunken and tan and may have velvety spores in the center. As these spots mature, they become larger and turn brown and corky. Infected fruit becomes distorted and may crack allowing entry of secondary organisms. Severely affected fruit may drop, especially when young.\n\nApple scab overwinters primarily in fallen leaves and in the soil. Disease development is favored by wet, cool weather that generally occurs in spring and early summer. Fungal spores are carried by wind, rain or splashing water from the ground to flowers, leaves or fruit. During damp or rainy periods, newly opening apple leaves are extremely susceptible to infection. The longer the leaves remain wet, the more severe the infection will be. Apple scab spreads rapidly between 55-75 degrees F.\n\n<img src=\"https:\/\/www.backyardnature.net\/n\/09\/090802sc.jpg\" width=\"500px\">\n\nFigure 4. Apple scab (Source: https:\/\/www.backyardnature.net\/n\/09\/090802sc.jpg)\n\nSource: https:\/\/www.planetnatural.com\/pest-problem-solver\/plant-disease\/apple-scab\/","6eb379ba":"### Cedar apple rust","99ac5a45":"### Apple scab","94f1bcb4":"# Train model","2643283a":"We can see some leaves with very faint spots, indicating rust or scab, being classified as healthy. Maybe changing the lightining can solve this.\n\nAs expected, multiple_diseases are being misclassified as other diseases due to low representation on the validation set.","9b3e675b":"## Going bigger ","cd9df915":"### Multiple diseases","bb5d9629":"## Data splitting","ef6d1add":"# Import modules","2fa954ce":"# EDA","174c6833":"Apparently we do have different stages of the life cycle. For instance, image 3 shows an orange spot with yellow borders, while image 1 shows a mostly yellow spot with a darker center.","3eeb4b84":"Multiple diseases was underrepresented on the validation set. We will try a stratified split next time.","21ee8750":"This time I'm not going to classifying each of the diseases on the leaves (because I'm not an expert in plants diseases). We are just going to take a look at some samples.","f19b39cd":"# Prepare data for training","8a7ba713":"# Interpretation and predictions","2ff78164":"Train and test files are all mixed in the **images** folder. We are going to create 2 folders called Train and Test and then move the files there. Just to organize things a bit...","5f91efc8":"## Select architeture","2908e46b":"Question:\n\n- Can the different stages influence our predictions?","df126854":"Great. Now let's take a look into the data","37ee297d":"We have 4 classes in this dataset:\n\n* Healthy\n* Multiple diseases\n* Scab\n* Rust\n\nWhat is the distribution of these classes? Are there more samples of one class than the others?","b43921d6":"Cedar apple rust (*Gymnosporangium juniperi-virginianae*) is a fungal disease that requires juniper plants to complete its complicated two year life-cycle. Spores overwinter as a reddish-brown gall on young twigs of various juniper species. In early spring, during wet weather, these galls swell and bright orange masses of spores are blown by the wind where they infect susceptible apple and crab-apple trees. The spores that develop on these trees will only infect junipers the following year. From year to year, the disease must pass from junipers to apples to junipers again; it cannot spread between apple trees.\n\nOn apple and crab-apple trees, look for pale yellow pinhead sized spots on the upper surface of the leaves shortly after bloom. These gradually enlarge to bright orange-yellow spots which make the disease easy to identify. Orange spots may develop on the fruit as well. Heavily infected leaves may drop prematurely.\n\n\n<img src=\"https:\/\/upload.wikimedia.org\/wikipedia\/commons\/2\/27\/Cedar_apple_rust_cycle_for_Wikipedia.jpg\" width=\"500px\">\nFigure 1. Life cycle of the cedar apple rust (Source: https:\/\/en.wikipedia.org\/wiki\/Gymnosporangium_juniperi-virginianae)\n\n<img src=\"http:\/\/www.missouribotanicalgarden.org\/Portals\/0\/Gardening\/Gardening%20Help\/images\/Pests\/CedarApple_Rust168.jpg\" width=\"500px\">\n\nFigure 2. Apple leafs infected with *G. juniperi-virginianae* (Source: http:\/\/www.missouribotanicalgarden.org\/gardens-gardening\/your-garden\/help-for-the-home-gardener\/advice-tips-resources\/pests-and-problems\/diseases\/rusts\/cedar-apple-rust.aspx)\n\n<img src=\"https:\/\/www.fs.fed.us\/wildflowers\/plant-of-the-week\/images\/cedarapplerust\/Gymnosparangium_juniperi-virginianae_23A.jpg\" width=\"500px\">\n\nFigure 3. Yellow spots on apple leaves (Source: https:\/\/www.fs.fed.us\/wildflowers\/plant-of-the-week\/gymnosporangium_juniperi-virginianae.shtml)\n\n\nSource: https:\/\/www.planetnatural.com\/pest-problem-solver\/plant-disease\/cedar-apple-rust\/","3783b08c":"## Visualizing diseases","1c7d9c73":"Alright. So our data is a set of images and each of these can be assigned to 4 labels, namely healthy, multiple_diseases, rust and scab. \n\nI'm not a botanist, so I will just look some quick references explaining what these diseases are."}}