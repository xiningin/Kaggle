{"cell_type":{"30ca4c18":"code","92de4897":"code","bc60c3d6":"code","385e47f0":"code","baebb18b":"code","29487202":"code","23fcbe90":"code","b8613627":"code","1ea5b96c":"code","10c7f196":"code","e5e13461":"code","4fbab721":"code","73b8c346":"code","35cbfc94":"code","cd89274a":"code","087153cf":"code","8e366608":"code","90dc4ee7":"code","f990e93b":"code","47615bd5":"code","042a36b4":"code","79837779":"code","34df77a5":"code","657acd1b":"code","217253fb":"code","e25ff154":"code","78b39ef1":"code","7a90da9d":"code","ce58a3f3":"code","8b1c231a":"code","80d2f464":"code","8a65d094":"code","8eac64e2":"code","66738db6":"code","d936f31b":"code","f3c0b503":"code","97cd3688":"code","a8a6152d":"code","bfa4d1e7":"code","d788e4de":"code","ec1921d5":"code","c8288de8":"code","1ad38785":"code","b5390348":"code","21d3c17d":"code","310f4681":"code","6e150e2b":"code","afab28bb":"code","7160ccbd":"code","71e324db":"code","ee10d3eb":"code","3d760844":"code","de4af47b":"code","328b3288":"code","4d000535":"code","a1e5989c":"code","6686a064":"code","c531b22a":"code","19aa9cf3":"code","ba28d4c2":"code","43327e7e":"code","37d023b0":"code","f3acf5c3":"code","a34d193a":"code","965514a8":"code","398b1c6a":"code","e54e21bd":"code","181797e3":"code","2f3bea33":"code","645d3dab":"code","3be669b3":"code","fea3ff86":"code","917f39d7":"code","a5813f7e":"code","c738231a":"code","81ec4839":"code","5925b387":"code","cdf27ed9":"code","c24fd304":"code","4893f931":"code","b9a656e5":"code","df6126f3":"markdown","715cf42d":"markdown","e3ef0029":"markdown","34e34cba":"markdown","561451d2":"markdown","f84f5f2f":"markdown","e8f744d5":"markdown","598a5001":"markdown","d9b2f480":"markdown","dcc1d516":"markdown","35301622":"markdown","57673085":"markdown","b8bd548d":"markdown","0ccd6229":"markdown","441dd765":"markdown","b9ee1bf1":"markdown","4e368d93":"markdown","8581c259":"markdown","c41eb055":"markdown","4a975aa3":"markdown","baf9e58e":"markdown","34058eba":"markdown","057a3538":"markdown","e7786608":"markdown","3aee157c":"markdown","08231fe2":"markdown","078c57cd":"markdown","7c5fa961":"markdown","ea7b7cd7":"markdown","7b1dd2bb":"markdown","63c9f77f":"markdown","19e31fb3":"markdown","4571ca7a":"markdown","7bacb77b":"markdown","f5edae73":"markdown","1c7a990f":"markdown","ef24fd68":"markdown","b6ea880f":"markdown","432030ea":"markdown","9d5f18c3":"markdown","f205702a":"markdown","66712ce1":"markdown"},"source":{"30ca4c18":"import matplotlib.pyplot as plt\nimport seaborn as sns\nimport numpy as np\nimport pandas as pd\n\nimport warnings\nwarnings.filterwarnings(\"ignore\")","92de4897":"data = pd.read_csv(\"..\/input\/insurance\/insurance.csv\")\nprint(data.shape)\ndata.head()","bc60c3d6":"data_explore = data.copy()","385e47f0":"data_explore.info()","baebb18b":"data_explore.describe()","29487202":"Q1 = data_explore.quantile(0.25)\nQ3 = data_explore.quantile(0.75)\nIQR = Q3 - Q1\noutliers = ((data_explore < (Q1 - 1.5 * IQR)) | (data_explore > (Q3 + 1.5 * IQR))).sum()\noutliers[outliers>0]","23fcbe90":"plt.figure(figsize=(10, 4))\nplt.subplot(1, 2, 1)\nsns.boxplot(x='charges', data=data_explore)\nplt.subplot(1, 2, 2)\nsns.boxplot(x='bmi', data=data_explore)\nplt.show()","b8613627":"from sklearn.preprocessing import LabelEncoder\n\nlabel_encoder = LabelEncoder()\ndata_explore[\"sex_enc\"] = label_encoder.fit_transform(data_explore[\"sex\"])\nprint(label_encoder.classes_)\ndata_explore[\"smoker_enc\"] = label_encoder.fit_transform(data_explore[\"smoker\"])\nprint(label_encoder.classes_)\ndata_explore[\"region_enc\"] = label_encoder.fit_transform(data_explore[\"region\"])\nprint(label_encoder.classes_)","1ea5b96c":"sns.pairplot(data_explore)","10c7f196":"data_explore['charges'].hist()\nplt.xlabel('Charges')","e5e13461":"sns.catplot(x=\"smoker\", kind=\"count\",hue = 'sex', data=data_explore, legend_out=False )\nplt.title(\"Distribution of Smokers on Basis of Gender\")\nplt.show()","4fbab721":"data_explore[(data_explore['smoker']=='yes') & (data_explore['sex']=='female')]['charges'].count(), data_explore[(data_explore['smoker']=='yes') & (data_explore['sex']=='male')]['charges'].count()","73b8c346":"data_explore_male = data_explore[data_explore[\"sex\"]==\"male\"]\ndata_explore_female = data_explore[data_explore[\"sex\"]==\"female\"]\ndata_explore_non_smoker = data_explore[data_explore[\"smoker\"]==\"no\"]\ndata_explore_smoker = data_explore[data_explore[\"smoker\"]==\"yes\"]","35cbfc94":"data_explore_smoker.age.hist()\nplt.xlabel('Age')","cd89274a":"plt.figure(figsize=(12, 5))\nplt.subplot(1, 2, 1)\ndata_explore_smoker['charges'].hist()\nplt.title('Distribution of Charges for Smokers')\nplt.subplot(1, 2, 2)\ndata_explore_non_smoker['charges'].hist()\nplt.title('Distribution of Charges for Non-Smokers')\nplt.show()","087153cf":"data_explore_smoker['charges'].min()","8e366608":"fig, ax = plt.subplots()\ndata_explore.plot(kind=\"scatter\", x=\"age\", y=\"charges\", alpha=0.5, c=\"smoker_enc\", cmap=plt.get_cmap(\"brg\"), colorbar=False, ax=ax, figsize=(8, 4))\nplt.title(\"Distribution of treatment charges over ages\\nSmokers - Green   Non-smokers: Blue\")\nplt.show()","90dc4ee7":"fig, ax = plt.subplots(nrows=1, ncols=2)\nfig.set_figheight(6)\nfig.set_figwidth(12)\ndata_explore_smoker.plot(kind=\"scatter\", x=\"age\", y=\"charges\", ax=ax[0])\nax[0].set_title(\"Smokers treatment charges distribution over age\")\ndata_explore_non_smoker.plot(kind=\"scatter\", x=\"age\", y=\"charges\", ax=ax[1])\nax[1].set_title(\"Non Smokers treatment charges distribution over age\")\nplt.show()","f990e93b":"fig, ax = plt.subplots()\ndata_explore.plot(kind=\"scatter\", x=\"age\", y=\"charges\", alpha=0.7, c=\"sex_enc\", cmap=plt.get_cmap(\"brg\"), colorbar=False, ax=ax, figsize=(8, 4))\nplt.title(\"Distribution of charges over ages\\nMale - Green   Female: Blue\")\nplt.show()","47615bd5":"fig, ax = plt.subplots(nrows=1, ncols=2)\nfig.set_figheight(6)\nfig.set_figwidth(15)\ndata_explore_male.plot(kind=\"scatter\", x=\"age\", y=\"charges\",alpha=0.7,c=\"smoker_enc\", cmap=plt.get_cmap(\"brg\"), colorbar=False, ax=ax[0])\nax[0].set_title(\"Males treatment charges distribution over age\\nSmokers - Green   Non-smokers: Blue\")\ndata_explore_female.plot(kind=\"scatter\", x=\"age\", y=\"charges\",alpha=0.7,c=\"smoker_enc\", cmap=plt.get_cmap(\"brg\"), colorbar=False, ax=ax[1])\nax[1].set_title(\"Females treatment charges distribution over age\\nSmokers - Green   Non-smokers: Blue\")\nplt.show()","042a36b4":"fig, ax = plt.subplots()\ndata_explore.plot(kind=\"scatter\", x=\"bmi\", y=\"charges\", alpha=0.7, c=\"smoker_enc\", cmap=plt.get_cmap(\"PiYG\"), colorbar=False, ax=ax)\nplt.title(\"Distribution of charges over bmi\\nSmokers - Green   Non-smokers: Red\")\nplt.show()","79837779":"fig, ax = plt.subplots(nrows=1, ncols=2)\nfig.set_figheight(6)\nfig.set_figwidth(15)\ndata_explore_smoker.plot(kind=\"scatter\", x=\"bmi\", y=\"charges\", c=\"age\", cmap=plt.get_cmap(\"jet\"), colorbar=False, ax=ax[0])\nax[0].set_title(\"Smokers treatment charges distribution over BMI\")\ndata_explore_non_smoker.plot(kind=\"scatter\", x=\"bmi\", y=\"charges\", c=\"age\", cmap=plt.get_cmap(\"jet\"), colorbar=True, ax=ax[1])\nax[1].set_title(\"Non-Smokers treatment charges distribution over BMI\")\nplt.show()","34df77a5":"corr_matrix = data_explore.corr()\n\nplt.figure(figsize=(12, 6))\nsns.heatmap(corr_matrix, mask=np.zeros_like(corr_matrix, dtype=np.bool), annot=True, square=True)\nplt.show()","657acd1b":"from sklearn.model_selection import StratifiedShuffleSplit\n\nstratified_data = StratifiedShuffleSplit(n_splits=1, test_size=0.2, random_state=42)","217253fb":"for train_idx, test_idx in stratified_data.split(data, data[\"smoker\"]):\n    stratified_train_set = data.iloc[train_idx]\n    stratified_test_set = data.iloc[test_idx]\n    \nstratified_train_set.shape, stratified_test_set.shape","e25ff154":"y_train = stratified_train_set['charges'].copy()\nX_train = stratified_train_set.drop(columns='charges', axis=1)\n\ny_test = stratified_test_set['charges'].copy()\nX_test = stratified_test_set.drop(columns='charges', axis=1)","78b39ef1":"cat_attrs = ['sex', 'smoker', 'region']\nnum_attrs = ['age', 'bmi', 'children']","7a90da9d":"from sklearn.preprocessing import StandardScaler, OneHotEncoder\nfrom sklearn.compose import ColumnTransformer","ce58a3f3":"pre_process = ColumnTransformer([('scaler', StandardScaler(), num_attrs),\n                                ('encode', OneHotEncoder(), cat_attrs)], remainder='passthrough')","8b1c231a":"X_train_transformed = pre_process.fit_transform(X_train)\nX_test_transformed = pre_process.transform(X_test)","80d2f464":"X_train_transformed.shape, X_train.iloc[0, :], X_train_transformed[0]","8a65d094":"feature_columns = list(X_train.columns)\nnew_col_name = ['female', 'male', 'smoker_no', 'smoker_yes', 'northeast', 'northwest', 'southeast', 'southwest']\nfeature_columns.extend(new_col_name)\nfeature_columns = [ col for col in feature_columns if not col in cat_attrs]\nfeature_columns","8eac64e2":"from sklearn.model_selection import cross_val_score\n\nresults = []\n\ndef cv_results(model, X, y):\n    scores = cross_val_score(model, X, y, cv = 7, scoring=\"neg_mean_squared_error\", n_jobs=-1)\n    rmse_scores = np.sqrt(-scores)\n    rmse_scores = np.round(rmse_scores, 2)\n    print('CV Scores: ', rmse_scores)\n    print('rmse: {},  S.D.:{} '.format(np.mean(rmse_scores), np.std(rmse_scores)))\n    results.append([model.__class__.__name__, np.mean(rmse_scores), np.std(rmse_scores)])","66738db6":"from sklearn.linear_model import LinearRegression","d936f31b":"linear_reg = LinearRegression()\nlinear_reg.fit(X_train_transformed, y_train)","f3c0b503":"feature_imp = [ col for col in zip(feature_columns,linear_reg.coef_)]\nfeature_imp.sort(key=lambda x:x[1], reverse=True)\nfeature_imp","97cd3688":"cv_results(linear_reg, X_train_transformed, y_train)","a8a6152d":"from sklearn.preprocessing import PolynomialFeatures","bfa4d1e7":"poly_features = PolynomialFeatures(degree=2, include_bias=False)","d788e4de":"from sklearn.pipeline import Pipeline\n\npoly_reg = Pipeline([('poly_features', poly_features),\n                    ('linear_reg', LinearRegression(n_jobs=-1))])","ec1921d5":"poly_reg.fit(X_train_transformed, y_train)","c8288de8":"cv_results(poly_reg, X_train_transformed, y_train)","1ad38785":"from sklearn.svm import SVR","b5390348":"svr_reg = SVR(C=1, kernel='rbf')\nsvr_reg.fit(X_train_transformed, y_train)","21d3c17d":"cv_results(svr_reg, X_train_transformed, y_train)","310f4681":"from sklearn.tree import DecisionTreeRegressor","6e150e2b":"tree_reg = DecisionTreeRegressor(criterion='mse', random_state=42)\ntree_reg.fit(X_train_transformed, y_train)","afab28bb":"feature_imp = [ col for col in zip(feature_columns,tree_reg.feature_importances_)]\nfeature_imp.sort(key=lambda x:x[1], reverse=True)\nfeature_imp","7160ccbd":"cv_results(tree_reg, X_train_transformed, y_train)","71e324db":"from sklearn.ensemble import RandomForestRegressor","ee10d3eb":"forest_reg = RandomForestRegressor(n_estimators=100, criterion='mse', n_jobs=-1, random_state=42)\nforest_reg.fit(X_train_transformed, y_train)","3d760844":"feature_imp = [ col for col in zip(feature_columns,forest_reg.feature_importances_)]\nfeature_imp.sort(key=lambda x:x[1], reverse=True)\nfeature_imp","de4af47b":"cv_results(forest_reg, X_train_transformed, y_train)","328b3288":"from sklearn.ensemble import AdaBoostRegressor","4d000535":"ada_reg = AdaBoostRegressor(loss='linear', n_estimators=100, learning_rate=0.01, random_state=42)\nada_reg.fit(X_train_transformed, y_train)","a1e5989c":"cv_results(ada_reg, X_train_transformed, y_train)","6686a064":"from xgboost import XGBRegressor","c531b22a":"xgb_reg = XGBRegressor(max_depth=3, n_estimators=100, learning_rate=0.1, objective='reg:squarederror', random_state=42)\nxgb_reg.fit(X_train_transformed, y_train)","19aa9cf3":"cv_results(xgb_reg, X_train_transformed, y_train)","ba28d4c2":"result_df = pd.DataFrame(data=results, columns=['Model', 'RMSE', 'S.D'])\nresult_df","43327e7e":"from sklearn.model_selection import GridSearchCV","37d023b0":"xgb_grid_parm=[{'n_estimators':[25, 50, 75, 100], 'learning_rate':[0.001, 0.01, 0.1, 0.5, 1], 'max_depth':[3, 6, 8, 12] }]\nxgb_grid_search = GridSearchCV(XGBRegressor(objective='reg:squarederror', n_jobs=-1, random_state=42), xgb_grid_parm, cv=5, scoring=\"neg_mean_squared_error\", return_train_score=True, n_jobs=-1)\nxgb_grid_search.fit(X_train_transformed, y_train)","f3acf5c3":"xgb_grid_search.best_params_","a34d193a":"cvres = xgb_grid_search.cv_results_\nprint(\"Results for each run of XGBoost Regression...\")\nfor train_mean_score, test_mean_score, params in zip(cvres[\"mean_train_score\"], cvres[\"mean_test_score\"], cvres[\"params\"]):\n    print(np.sqrt(-train_mean_score), np.sqrt(-test_mean_score), params)","965514a8":"best_xgb_reg = xgb_grid_search.best_estimator_\nbest_xgb_reg","398b1c6a":"cv_results(best_xgb_reg, X_test_transformed, y_test)","e54e21bd":"# R2-Score\nbest_xgb_reg.score(X_train_transformed, y_train), best_xgb_reg.score(X_test_transformed, y_test)","181797e3":"combine_data = pd.concat([stratified_train_set, stratified_test_set], axis=0)","2f3bea33":"combine_data.shape","645d3dab":"combine_data['smoker_enc'] = label_encoder.fit_transform(combine_data['smoker'])","3be669b3":"y_train_pred = best_xgb_reg.predict(X_train_transformed)\ny_test_pred = best_xgb_reg.predict(X_test_transformed)","fea3ff86":"y_pred = np.concatenate([y_train_pred, y_test_pred], axis=0)","917f39d7":"combine_data['predicted_charges'] = y_pred","a5813f7e":"combine_data.head()","c738231a":"plt.figure(figsize=(15, 6))\nplt.subplot(1, 2, 1)\nplt.scatter(combine_data['age'], combine_data['charges'], c=combine_data[\"smoker_enc\"], cmap=plt.get_cmap(\"brg\"), alpha=0.7)\nplt.title(\"Distribution of Observed Charges\\nNon-Smoker: blue, Smoker: green\")\nplt.subplot(1, 2, 2)\nplt.scatter(combine_data['age'], combine_data['predicted_charges'], c=combine_data[\"smoker_enc\"], cmap=plt.get_cmap(\"brg\"), alpha=0.7)\nplt.title(\"Distribution of Predicted Charges\\nNon-Smoker: blue, Smoker: green\")\nplt.show()","81ec4839":"combine_data_smoker = combine_data[combine_data['smoker']=='yes']\ncombine_data_non_smoker = combine_data[combine_data['smoker']=='no']","5925b387":"combine_data_smoker.describe()","cdf27ed9":"combine_data_non_smoker.describe()","c24fd304":"plt.figure(figsize=(15, 6))\nplt.subplot(1, 2, 1)\ncombine_data_smoker['charges'].hist()\nplt.title('Observed Charges for Smokers')\nplt.subplot(1, 2, 2)\ncombine_data_smoker['predicted_charges'].hist()\nplt.title('Predicted Charges for Non-Smokers')\nplt.show()","4893f931":"plt.figure(figsize=(15, 6))\nplt.subplot(1, 2, 1)\ncombine_data_non_smoker['charges'].hist()\nplt.title('Observed Charges for Non-Smokers')\nplt.subplot(1, 2, 2)\ncombine_data_non_smoker['predicted_charges'].hist()\nplt.title('Predicted Charges for Non-Smokers')\nplt.show()","b9a656e5":"plt.figure(figsize=(15, 6))\nplt.subplot(1, 2, 1)\nplt.scatter(combine_data_smoker['age'], combine_data_smoker['charges'], c='green')\nplt.scatter(combine_data_smoker['age'], combine_data_smoker['predicted_charges'], c='red')\nplt.title(\"Analysis of Predicted Charges for Smokers\\nObserved Charges: green, Predicted Charges: red\")\nplt.subplot(1, 2, 2)\nplt.scatter(combine_data_non_smoker['age'], combine_data_non_smoker['charges'], c='green')\nplt.scatter(combine_data_non_smoker['age'], combine_data_non_smoker['predicted_charges'], c='red')\nplt.title(\"Analysis of Predicted Charges for Non-Smokers\\nObserved Charges: green, Predicted Charges: red\")\nplt.show()","df6126f3":"### Random Forest","715cf42d":"## Step 1: Frame the Problem","e3ef0029":"## Step 2: Data Exploration","34e34cba":"Among all implemented ML algorithms, XGBoost Regression has given us a better result. Now, lets tune hyperparameters of XGBoost.","561451d2":"- For non-smokers, there are less treatment records having treatment charges more than 30000. Whereas there are many treatment records of smokers having treatment charges more than 30000.","f84f5f2f":"# Medical Treatment Cost Prediction","e8f744d5":"### Outliers","598a5001":"### Analysis 4: Distribution of Charges over BMI","d9b2f480":"- Observation\n    - Our best model has able  predict almost accurately the charges for following:\n        - Non-smoker having treatment charges less than 15000.\n        - Most of the smoking patients.\n    - Model has failed badly to give accurate predictions for following:\n        - Non-smokers having treatment charges above 15000.\n        - For some smokers having treatment charges above 50000.","dcc1d516":"### XGBoost","35301622":"### SVR with RBF Kernel","57673085":"### Statistical Overview","b8bd548d":"There are no columns having null values.","0ccd6229":"Well this is very good improvement in model's performance. Increasing model's complexity has certainly reduced the overfitting.","441dd765":"- We know that having BMI above 30 is sign of being unhealthy and having smoking habit along with it, makes health much more worse.\n- We can see that for smoking peoples having BMI over 30 has treatment charges more than 30000.\n- For non-smoking peoples having BMI above 30 are having very less(almost half) treatment charges compare to the smoking people having BMI in similar range. Also, for non-smoking peoples having BMI in range of 25 to 40, treatment charges increases with increase in age. This statement is not completely true as there are some records which indicates that there are high treatment charges for young non-smoking people.\n- Here we can say that for peoples having BMI greater than 30 and also having smoking habit is very bad. These peoples will have very high treatment charges.","b9ee1bf1":"To evaluate each model we will be using RMSE as evaluation metric.","4e368d93":"- There are many treatment records of male peoples, having treatment charges more than 15000 than females.","8581c259":"Lets see if we can reduce RMSE by using tree models or not.","c41eb055":"Our main focus will be on following factors: sex, age, smoker, bmi, region. Number of children will never affect the cost of treatment.","4a975aa3":"### Linear Regression - Analytical approach","baf9e58e":"### AdaBoost","34058eba":"- This distubution shows that irrespective of gender, charges for smoker is high compare to non-smokers.","057a3538":"### Decision Tree","e7786608":"## Step 3: Data Preprocessing","3aee157c":"There are almost 30% more male smokers than female smokers.","08231fe2":"Before saving the model, lets observe predictions made by model on overall dataset. This analysis will help us to know where actually model has underperformed.","078c57cd":"- Graphs on diagonal represent histogram of each feature.\n- Dataset contains more number of treatment records involving peoples having age around 20.\n- We can see that our taget variable 'charges' is completely right-skewed. Most of the treatment records have charges less than 12000.\n- There is many records of people who are non-smoker than ones who are.\n- There is not somuch diffence in number of records of male and female patients. Similar is the case for region-wise records.\n- Looking at distribution of charges against sex, region and smoker, the charges are fairly same accross all categories in sex and in region. For smokers the tratement charges are on higher side compare to non-smokers.\n- We some growing patterns in graphs of Charges vs BMI, Charges vs Age.\n\nWe will now explore each feature in more depth.","7c5fa961":"- It seems that treatment charges increases with increase in age, but there are many treatment records shows high treatment charges for younger peoples.\n- There are many treatment records having charges less than 15000. Many of those records are of non-smoking peoples. Above 15000, there are many smokers than non-smokers.","ea7b7cd7":"### Analysis 2: Distribution of Smokers on Basis of Gender","7b1dd2bb":"- Objective:  Predict the cost of treatment.\n\n- Description:\n    - Given data contains records cost of treatment of different patients. \n    - The cost of treatment depends on many factors: Disease, severity of disease, type of treatment, age, diagnosis, type of clinic, city of residence and so on. \n    - In given dataset, few following factors available with us: age, sex, bmi, children, smoker, and region.\n    - General understanding\/common sense told us that in following scenarios the cost of treatment will be higher:\n        1. if person is smoker \n        2. person is having BMI > 30\n\n- Problem Type: Supervise & Regression\n- Batch Learning. Since data is not changing rapidly.","63c9f77f":"We can observe that as the depth of decision tree is increasing, model is overfitting to the dataset.","19e31fb3":"Now we will create preprocessing pipeline which will do following things:\n- Encoding of categorical features\n- Standardization of numerical attributes","4571ca7a":"## Step 5: Fine Tune a Model","7bacb77b":"### Analysis 5: Correlation Plot","f5edae73":"There are some categorical features. Lets encode those features before we use them for analysis.","1c7a990f":"The RMSE obtained is large. The model is clearly underfitting.\n\nLets try to increase model's complexity by adding polynomial features.","ef24fd68":"## Step 4: Select and Train a Model","b6ea880f":"### Polynomial Regression ","432030ea":"## Step 6: Model Evaluation","9d5f18c3":"### Analysis 3: Distribution of treatment charges over age.","f205702a":"- Treament charges is strongly correlated with Smoker feature. Also charges are fairly correlated with Age and BMI.\n- There is no correlation among independent features.","66712ce1":"### Analysis 1: Observe Distribution of all features."}}