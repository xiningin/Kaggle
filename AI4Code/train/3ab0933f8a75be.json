{"cell_type":{"c98638bc":"code","f0cc400c":"code","d93794d4":"code","9f3dd860":"code","c9bc921f":"code","1dfcc6b1":"code","40b1e0f9":"code","d9225f59":"code","e2b07eb3":"code","b6d4f164":"code","d42e7ff4":"code","b9fa66bb":"code","bc9de770":"code","bcdda025":"code","06d3845f":"code","b13d99f2":"code","6b208c68":"code","a7331453":"code","3c3f775a":"code","8b98e2d5":"code","1687dccd":"markdown","41e5769c":"markdown","357f6feb":"markdown","d11c62e2":"markdown","3b967fef":"markdown","436ceef0":"markdown","ff29dff4":"markdown","1c46680b":"markdown","0c83f6c5":"markdown","6b1ce22d":"markdown","810938af":"markdown","26da762c":"markdown","94c5a525":"markdown","7dd3d180":"markdown","ed821a8b":"markdown","effc301d":"markdown","1c7a4dbb":"markdown","73ebb303":"markdown","42d9f4dc":"markdown","96dbc507":"markdown","8954ed4c":"markdown"},"source":{"c98638bc":"![ -d \/kaggle\/input\/release-2021-v1\/augeropendata ] && [ ! -d augeropendata ] && ln -s \/kaggle\/input\/release-2021-v1\/augeropendata augeropendata  # kaggle specific linking dataset to augeropendata directory","f0cc400c":"# Data analysis tools\nimport pandas as pd\nimport numpy as np\nimport scipy.stats\nfrom scipy import stats","d93794d4":"# Plotting\nimport matplotlib.pyplot as plt\n%matplotlib inline","9f3dd860":"# Default values for plots\nplt.rcParams[\"figure.figsize\"] = [14, 9] # figure width and height\nplt.rcParams[\"font.size\"] = 20","c9bc921f":"# Jupyter\/ IPython formatting\nfrom IPython.display import Math, Latex, display","1dfcc6b1":"# Data loading, encapsulated to make it less installation and OS dependant\nimport os.path\nfrom zipfile import ZipFile\ndef AugerOpen(fdir, file):\n    \"\"\"\n    Loads a file from the auger open data release. Can be either in the local directory,\n    in the parent directory or in the augeropendata directory.\n    File is identified by it directory *fdir* and filename *file* and can be found in the directory\n    or in a zip file.\n    \"\"\"\n    for loc in [\".\", \"..\", \"augeropendata\", \"data\"]:\n        fname = os.path.join(loc, fdir, file)\n        if os.path.isfile(fname):\n            return open(fname)\n        zname=os.path.join(loc, fdir + \".zip\")\n        if os.path.isfile(zname):\n            with ZipFile(zname) as myzip:\n                return myzip.open(os.path.join(fdir, file))\n    raise FileNotFoundError(os.path.join(fdir, file))","40b1e0f9":"data = pd.read_csv(AugerOpen(\"summary\", \"dataSummary.csv\"))\nenergy = data.drop_duplicates('id')[\"sd_energy\"] ","d9225f59":"data = data[data[\"sd_exposure\"]>0]\ndata = data.sort_values(by='sdid')\nexposure = data[\"sd_exposure\"].iat[-1]\nLatex(f'The exposure is ${exposure:7.1f} \\\\U{{km}}^2 \\\\U{{sr}} \\\\U{{year}}$.')","e2b07eb3":"log_E_min = 0.4\nE_bins = 20\nE_bin_size = 0.1\nlog_E_max = log_E_min + E_bins * E_bin_size","b6d4f164":"n_under = energy.where(energy < pow(10., log_E_min)).count()\nn_over = energy.where(energy > pow(10., log_E_max)).count()\nLatex(f'{n_over} events are above log10 (E) = {18+log_E_max}.')","d42e7ff4":"log_bins = np.linspace(log_E_min, log_E_max, E_bins + 1)\nlog_bin_centers = log_bins[:-1] + 0.05\nbins = pow(10, log_bins);\nbin_energy = pow(10, log_bin_centers)\nbin_width = bins[1:] - bins[:-1]","b9fa66bb":"h = np.histogram(energy, bins)[0]","bc9de770":"alpha = 0.16\nbeta = 0.16\nlim_low = (h - np.nan_to_num(0.5 * scipy.stats.chi2.ppf(alpha, 2 * h)) )\nlim_up = ( 0.5 * scipy.stats.chi2.ppf(1 - beta, 2 * (h + 1)) - h)","bcdda025":"cut_nz = h > 0\ncut_z = h == 0","06d3845f":"normalization = exposure * bin_width * 1e18\nflux = h[cut_nz] \/ normalization[cut_nz]\nflux_lower = lim_low[cut_nz] \/ normalization[cut_nz]\nflux_upper = lim_up[cut_nz] \/ normalization[cut_nz]","b13d99f2":"bin_energy18 = bin_energy * 1e18\nbin_energy18_3 = bin_energy18**3\nflux_E3 = flux * bin_energy18_3[cut_nz]\nflux_E3_lower = flux_lower * bin_energy18_3[cut_nz]\nflux_E3_upper = flux_upper * bin_energy18_3[cut_nz]","6b208c68":"FC_90CL_0 = 2.44","a7331453":"FC_CL    = FC_90CL_0 \/ normalization[cut_z]\nFC_CL_E3 = FC_CL * bin_energy18_3[cut_z]","3c3f775a":"Y_0val = FC_CL * 0.9\n\nplt.title(\"Spectrum with event counts\")\nplt.errorbar(bin_energy18[cut_nz], flux, [flux_lower, flux_upper], fmt=\"o\")\nplt.errorbar(bin_energy18[cut_z], FC_CL, Y_0val, uplims=True, marker=\"None\", color=\"steelblue\", \n             markeredgecolor=\"r\", markerfacecolor=\"r\", linewidth=2.0, linestyle=\"None\", capsize=5)\nplt.xscale(\"log\")\nplt.yscale(\"log\")\nplt.xlabel('E [eV]')\nplt.ylabel(r'J$^{Raw}$(E) [km$^{-2}$ sr$^{-1}$ yr$^{-1}$ eV$^{-1}$]')\n\n# expand the range in y to have space for the labels and upper limits\nplt.ylim(flux[flux > 0].min()*0.01, flux.max()*7)\n\n# add the counts to the points\nfor E, J, count in zip(bin_energy18, flux, h):\n    if count > 0:\n        plt.annotate(count, (E, J), rotation=30, va='bottom')","8b98e2d5":"Y_0val2 = FC_CL_E3 * 0.6\nplt.title(r\"Spectrum with flux\")\nplt.errorbar(bin_energy18[cut_nz], flux_E3, [flux_E3_lower, flux_E3_upper], fmt=\"o\")\nplt.errorbar(bin_energy18[cut_z], FC_CL_E3, Y_0val2, uplims=True, barsabove=True, marker=\"None\", color=\"steelblue\",\n             markeredgecolor=\"r\", markerfacecolor=\"r\", linewidth=2.0, linestyle=\"None\", capsize=5)\nplt.xscale(\"log\")\nplt.yscale(\"log\")\nplt.xlabel('E [eV]')\nplt.ylabel(r'J$^{Raw}$(E) [km$^{-2}$ $\\times$ E$^{3} $sr$^{-1}$ yr$^{-1}$ eV$^{2}$]')\nNone","1687dccd":"The exposure is calculated according to [Nucl. Instrum. Methods A 613, 29 (2010)](https:\/\/www.sciencedirect.com\/science\/article\/abs\/pii\/S0168900209021688) ( [arXiv:1111.6764](https:\/\/arxiv.org\/abs\/1111.6764) ) .\nFor energies above $2.5 \\times 10^{18}$ eV, the detection efficiency becomes larger than 97% and the exposure is obtained from the integration of the aperture of the array over the observation time. The aperture is in turn obtained as the effective area under zenith angle $\\theta$, $A \\cos(\\theta)$, integrated over the solid angle within which the showers are observed. $A$ is well defined as a consequence of the hexagonal structure of the array. Each station that has six adjacent, data taking neighbors, contributes a cell of area $A_{cell} = 1.95 \\mathrm{km}^{2}$; the corresponding aperture for showers with $\\theta < 60^{\\circ}$ is 4.59 $\\mathrm{km}^{2} \\mathrm{sr}$.","41e5769c":"The raw energy spectrum, rescaled by $E^{3}$, is displayed here. On the X axis we put the energy (in eV) defined as the bin center while on the Y axis the flux multiplied by the third power of the energy (in $\\mathrm{km}^{-2} \\mathrm{sr}^{-1} \\mathrm{yr}^{-1} \\mathrm{eV}^{2}$ units). \n","357f6feb":"The raw flux is calculated as the ratio $ \\frac{ N (E) }{\\epsilon \\Delta E} $ whereas $N(E)$ is the number of events falling in each bin, $\\epsilon$ is the cumulated exposure and $\\Delta E$ is the width of the energy bin. The resulting spectrum is not corrected for detector effects and it is therefore defined as raw energy spectrum.","d11c62e2":"The errors are asymmetric Poisson errors. The upper and lower limits of the 68% confidence interval for a count of $N$ events falling in each bin are given by\n\\begin{align}\nN_{\\mathrm{lower}} &= \\frac{1}{2} F^{-1}_{\\chi^2}(\\alpha; 2N)\\\\\nN_{\\mathrm{upper}} &= \\frac{1}{2} F^{-1}_{\\chi^2}(1 - \\beta; 2(N + 1))\\\\\n\\end{align}\nwhere $F^{-1}_{\\chi^2}$ is the quantile of the $\\chi^2$ distribution for the indicated number of degrees of freedom. The upper and lower tail probabilities $\\alpha$ and $\\beta$ are equal and chosen to have the central confidence interval of 68%, i.e., \n$1 - \\alpha - \\beta = 0.68$. This gives us $\\alpha = \\beta = 0.16$.\nFor more information, check the [section on  statistics of the PDG](https:\/\/pdg.lbl.gov\/2020\/reviews\/rpp2020-rev-statistics.pdf).\n\n**Note**: the lim_low variable is undefined for a count $N = 0$ and the function call returns NaN. We use `np.nan_to_num` to convert the lower limit to zero in the case.","3b967fef":"$\\newcommand{\\U}[1]{\\,\\mathrm{#1}}\n\\newcommand{\\UU}[1]{\\mathrm{#1}}$","436ceef0":"For empty bins we calculate 90% CL upper limits according to Feldman Cousins (as defined in [Phys. Rev. D 102, 062005 (2020)](https:\/\/journals.aps.org\/prd\/pdf\/10.1103\/PhysRevD.102.062005) ( [arXiv:2008.06486v2](https:\/\/arxiv.org\/abs\/2008.06486) ).\n\n2.44 is the limit for a Poissonian distribution, 0 realizations and 90% CL.\nSee [Phys. Rev. D 57, 3873](https:\/\/journals.aps.org\/prd\/abstract\/10.1103\/PhysRevD.57.3873) ( [arXiv:physics\/9711021](https:\/\/arxiv.org\/abs\/physics\/9711021) ) for more details.","ff29dff4":"Calculate the upper limits on the flux.","1c46680b":"## Spectrum plots","0c83f6c5":"![PierreAugerObservatoryLogo.jpg](attachment:PierreAugerObservatoryLogo.jpg)\n# Raw energy Spectrum\n\n<i>Notebook released together with the Pierre Auger Observatory Open Data release 2021 (<a href=\"https:\/\/doi.org\/10.5281\/zenodo.4487613\">DOI 10.5281\/zenodo.4487613<\/a>). More information at the <a href=\"https:\/\/www.auger.org\/opendata\/\">Auger open data website<\/a>.<\/i>","6b1ce22d":"In this dataset we use 10% of the total Surface Detector data as published in [Phys. Rev. D 102, 062005 (2020)](https:\/\/journals.aps.org\/prd\/pdf\/10.1103\/PhysRevD.102.062005) ( [arXiv:2008.06486v2](https:\/\/arxiv.org\/abs\/2008.06486) ) recorded between January 1st 2004 and August 31st 2018. We use events with zenith angle less than 60 degrees and energies above $2.5\\times10^{18}$ eV.","810938af":"The raw energy spectrum is displayed here. On the X axis we put the energy (in eV) defined as the bin center, on the Y axis the flux (in $\\mathrm{km}^{-2} \\mathrm{sr}^{-1} \\mathrm{yr}^{-1} \\mathrm{eV}^{-1}$ units). The number of events detected in each bin is shown on the top of the data points.","26da762c":"This is the kaggle version of a Pierre Auger Observatory Open Data notebook. You can run it by clicking on \"Copy and Edit\" in the top right corner.","94c5a525":"Fill the histogram to get the number of events in each energy bin.","7dd3d180":"## Normalize spectrum and estimate  the statistical uncertainies","ed821a8b":"In this notebook we derive the raw energy spectrum as measured by the Pierre Auger Observatory Surface Detector above $ 2.5 \\times 10^{18} $ eV.","effc301d":"To better visualize the changes in the slope, the flux is rescaled by $E^{3}$ whereas $E$ is the center of the logarithmic bin.","1c7a4dbb":"## Notebook setup","73ebb303":"Check the presence of events above the highest energy interval.","42d9f4dc":"Identify the bins with events and those with no events. In bins without events we calculate upper limits.","96dbc507":"The released data includes 5 events with energies larger than $10^{20}$ eV out of the 15  observed with the full data set [Phys. Rev. D 102, 062005 (2020)](https:\/\/journals.aps.org\/prd\/pdf\/10.1103\/PhysRevD.102.062005) ( [arXiv:2008.06486v2](https:\/\/arxiv.org\/abs\/2008.06486) ). Considering that the exposure is about 10% of the total one, the probability to observe 5 or more events with energies larger than $10^{20}$ eV is about 1.9%. \nThis is an upward fluctuation that cannot be interpreted as an excess of events.\n\nThe energy spectrum corrected for detector effects can be estimated from the raw spectrum using the matrix formalism addressed in [Phys. Rev. D 102, 062005 (2020)](https:\/\/journals.aps.org\/prd\/pdf\/10.1103\/PhysRevD.102.062005) ( [arXiv:2008.06486v2](https:\/\/arxiv.org\/abs\/2008.06486) ).\nWith the released data set, the consistency between the resulting energy spectrum and the model used to characterize the flux with the full statistics (see eq. 9 and Tab. III of [Phys. Rev. D 102, 062005 (2020)](https:\/\/journals.aps.org\/prd\/pdf\/10.1103\/PhysRevD.102.062005) (  [arXiv:2008.06486v2](https:\/\/arxiv.org\/abs\/2008.06486) ) can be quantified with a p-value of 75%.","8954ed4c":"Define the energy bins, selected to be of constant width in the decimal logarithm of the energy ($ \\Delta \\mathrm{log}_{10}(E) = 0.1$)."}}