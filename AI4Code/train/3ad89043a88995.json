{"cell_type":{"82b638ec":"code","47aceb73":"code","2f89a060":"code","b21cc181":"code","c5ab31fe":"code","1bedb1ca":"code","4395ec73":"code","f14551e9":"code","3b0ec23b":"code","333cd03e":"code","ccd99a48":"markdown","10ff4fe9":"markdown","690084a4":"markdown","2e967185":"markdown","ab041131":"markdown","e797c16d":"markdown","93cb8b39":"markdown","9546e7d0":"markdown"},"source":{"82b638ec":"import numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\n\ncohort = {}\n","47aceb73":"\ncohort['2020-04-16'] = dict()\ncohort['2020-04-16']['solution_file'] = '\/kaggle\/input\/covid19-epidemiological-benchmarking-dataset\/Benchmarking Data\/2020_04_16\/solution_20200426_derived.csv'\ncohort['2020-04-16']['test_file'] = '\/kaggle\/input\/covid19-epidemiological-benchmarking-dataset\/Benchmarking Data\/2020_04_16\/test.csv'\n\n\ncohort['2020-04-16']['kaggle_leader'] = '\/kaggle\/input\/covid19-epidemiological-benchmarking-dataset\/Benchmarking Data\/2020_04_16\/Kaggle\/15210154 - Pub_0_50424 Priv_0_22123.csv'\ncohort['2020-04-16']['cpmp'] = '\/kaggle\/input\/cpmpextraday\/submission.csv'\n\ncohort['2020-04-16']['ihme'] = '\/kaggle\/input\/covid19-epidemiological-benchmarking-dataset\/Benchmarking Data\/IHME\/2020_04_16.05\/Hospitalization_all_locs.csv'\ncohort['2020-04-16']['lanl'] = '\/kaggle\/input\/covid19-epidemiological-benchmarking-dataset\/Benchmarking Data\/LANL\/2020-04-15_deaths_quantiles_us.csv'\n","2f89a060":"def load_solution(solution_file,test_file):\n    df_benchmark_panel = pd.read_csv(solution_file,index_col=0)\n    df_test = pd.read_csv(test_file,index_col=0)\n    df_benchmark_panel = df_benchmark_panel.merge(df_test,left_index=True,right_index=True)\n    return df_benchmark_panel\n","b21cc181":"def load_kaggle(submission_file,df_benchmark_panel):\n    df_kaggle = pd.read_csv(submission_file,index_col=0)\n    df_kaggle = df_kaggle.rename(columns={\"Fatalities\": \"kaggle_leader\"})\n    df_benchmark_panel = df_benchmark_panel.merge(df_kaggle[['kaggle_leader']],left_index=True,right_index=True)\n    return df_benchmark_panel\n\ndef load_cpmp(submission_file,df_benchmark_panel):\n    df_kaggle = pd.read_csv(submission_file,index_col=0)\n    df_kaggle = df_kaggle.rename(columns={\"Fatalities\": \"cpmp\"})\n    df_benchmark_panel = df_benchmark_panel.merge(df_kaggle[['cpmp']],left_index=True,right_index=True)\n    return df_benchmark_panel\n","c5ab31fe":"def load_ihme(ihme_file,df_benchmark_panel):\n    df_ihme = pd.read_csv(ihme_file,index_col=[0])\n    for location in df_benchmark_panel['Province_State'].unique():\n        df_ihme.loc[(df_ihme['location_name'] == location),'ihme'] = df_ihme[df_ihme['location_name'] == location]['deaths_mean'].cumsum()\n    \n    df_benchmark_panel = df_benchmark_panel.merge(df_ihme[['location_name','date','ihme']],left_on=['Province_State','Date'],right_on=['location_name','date'],how='inner')\n\n    del(df_benchmark_panel['location_name'])\n    del(df_benchmark_panel['date'])\n    return df_benchmark_panel","1bedb1ca":"def load_lanl(lanl_file,df_benchmark_panel):\n    df_lanl = pd.read_csv(lanl_file)\n    df_lanl = df_lanl.rename(columns={\"q.50\": \"lanl\"})\n    df_benchmark_panel = df_benchmark_panel.merge(df_lanl[['state','dates','lanl']],left_on=['Province_State','Date'],right_on=['state','dates'],how='inner')\n    del(df_benchmark_panel['state'])\n    del(df_benchmark_panel['dates'])\n    return df_benchmark_panel\n","4395ec73":"def evaluate_models(evaluate, df_benchmark_panel):\n\n    df_eval = df_benchmark_panel[(df_benchmark_panel['Fatalities'] >= 0) & (df_benchmark_panel['Usage'] == 'Private') \n                                 & (df_benchmark_panel['Province_State'] != 'New York') & (df_benchmark_panel['Province_State'] != 'New Jersey')].reset_index(drop=True)\n    for model in evaluate:\n        df_eval['%s_mae' % model] = np.abs(df_eval[model] - df_eval['Fatalities'])\n        df_eval['%s_rmsle'  % model] = np.abs(np.log(1+df_eval[model])-np.log(1+df_eval[\"Fatalities\"]))\n        \n    results = dict()\n    for model in evaluate:\n        results[model] = dict()\n        results[model]['MAE'] = ((df_eval[model] - df_eval['Fatalities']).abs().mean())\n        results[model]['RMSE'] = np.sqrt(((df_eval[model]-df_eval[\"Fatalities\"])**2).mean())\n        results[model]['RMSLE'] = np.sqrt(((np.log(1+df_eval[model])-np.log(1+df_eval[\"Fatalities\"]))**2).mean())\n    \n    \n    df_eval.to_csv('\/kaggle\/working\/benchmark.csv')\n    return (results, df_eval)\n    \n    \n    ","f14551e9":"df_benchmarks = pd.DataFrame(columns=['Model','Forecast_Date','MAE','RMSE','RMSLE'])\n\nfor forecast_date in ['2020-04-16']:\n    \n    \n    df_benchmark_panel = load_solution(cohort[forecast_date]['solution_file'],cohort[forecast_date]['test_file'])\n    df_benchmark_panel = load_kaggle(cohort[forecast_date]['kaggle_leader'],df_benchmark_panel)\n    df_benchmark_panel = load_cpmp(cohort[forecast_date]['cpmp'],df_benchmark_panel)\n    df_benchmark_panel = load_ihme(cohort[forecast_date]['ihme'],df_benchmark_panel)\n    df_benchmark_panel = load_lanl(cohort[forecast_date]['lanl'],df_benchmark_panel)\n    results, df_eval = evaluate_models(['kaggle_leader', 'cpmp', 'ihme','lanl'], df_benchmark_panel)\n    \n    for model in results: \n        \n        row_dict = {'Model': model,'Forecast_Date':forecast_date,'MAE':np.round(results[model]['MAE'],0),'RMSE':np.round(results[model]['RMSE'],1), 'RMSLE': np.round(results[model]['RMSLE'],3) } \n        \n        df_benchmarks = df_benchmarks.append(row_dict,ignore_index=True)\n        \n","3b0ec23b":"df_benchmarks","333cd03e":"df = df_eval[['Province_State', 'Fatalities', 'kaggle_leader', 'cpmp', 'ihme', 'kaggle_leader_mae', 'cpmp_mae', 'ihme_mae', 'lanl_mae']\n             ].groupby('Province_State').last().reset_index()\ndf.sort_values(by='Fatalities', ascending=False)","ccd99a48":"# Merge IHME model\n\n- For April 10 model (Favors)\n- Not sure what loss function optimized for (Might Disadvantage)\n","10ff4fe9":"# Summary\n\nThe goal of this notebook was to benchmark some epidemeological models across a range of evaluation metrics. This was to get a more robust sense for how the Kaggle models perform against well known epidemiological models. \n\nFor now I have only benchmarked the leading Kaggle model. The week 3 and week 4 leading model clearly wins against IHME and LANL on RMSLE (the loss function it was evaluated against). But the advantage goes away when evaluated on other loss functions like MAE and RMSE.\n","690084a4":"# Merge LANL model\n\n- April 8 forecast (disadvantage)\n","2e967185":"# Merge Lead Kaggle model\n- Optimized for RMSLE and for predicing cases and fatalities (Disadvantage)\n- Optimized for global predictions (Disadvantage)\n- We're picking winning model ex-post. No way we would have known this model would have won ex-ante (Advantage)\n\n","ab041131":"# Evaluate","e797c16d":"# Load in solution","93cb8b39":"## Possible Next Steps\n\n- test Kaggle ensembles\n- benchmark all global\n- benchmark confirmed cases\n- benchmark more models\n- add additional metrics\n\n","9546e7d0":"## Week 4"}}