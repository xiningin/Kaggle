{"cell_type":{"a945bee8":"code","f9fdc1a9":"code","528b065d":"code","a9f4631e":"code","e2ee3b12":"code","8c1965d9":"code","28d94cec":"code","887eeae7":"code","d9da7550":"code","28736861":"code","54bfa0d3":"code","a45b1558":"code","3e7c6407":"code","66a2d0b0":"code","56f2ab10":"code","961491ef":"code","b5328a3e":"code","cd173b56":"code","7a5f543a":"code","a728b86f":"code","6f2e6768":"code","1c16f8a5":"code","30ac9633":"code","30a3e8c0":"code","181cadeb":"code","c90a3a28":"code","2769b0c9":"code","06efd548":"code","202b7742":"code","1c8cef45":"code","587378e2":"code","d00b18dc":"code","da7d621f":"code","16cf7123":"code","388b9b00":"code","b1a273eb":"code","d92298fc":"code","25305bc3":"code","2a378ef9":"code","47bbacf6":"code","0d905f6c":"code","b93fe568":"code","23f8f02d":"code","07ca4b67":"code","3e03f012":"code","0bbb3d07":"code","4dc5c34f":"code","38f323b6":"code","3bc97dd7":"code","48f3c70c":"code","54ddde22":"code","55f1c5b7":"code","fa9ad816":"code","a785e91d":"code","4ab2ac83":"markdown","6d21e399":"markdown","0bab3e47":"markdown","ef4e0b4f":"markdown","80c506c9":"markdown"},"source":{"a945bee8":"# This Python 3 environment comes with many helpful analytics libraries installed\n# It is defined by the kaggle\/python Docker image: https:\/\/github.com\/kaggle\/docker-python\n# For example, here's several helpful packages to load\n\nimport numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\n\n# Input data files are available in the read-only \"..\/input\/\" directory\n# For example, running this (by clicking run or pressing Shift+Enter) will list all files under the input directory\n\nimport os\nfor dirname, _, filenames in os.walk('\/kaggle\/input'):\n    for filename in filenames:\n        print(os.path.join(dirname, filename))\n\n# You can write up to 5GB to the current directory (\/kaggle\/working\/) that gets preserved as output when you create a version using \"Save & Run All\" \n# You can also write temporary files to \/kaggle\/temp\/, but they won't be saved outside of the current session","f9fdc1a9":"train = pd.read_csv('\/kaggle\/input\/av-genpact-hack-dec2018\/train.csv')\nmeal = pd.read_csv('\/kaggle\/input\/av-genpact-hack-dec2018\/meal_info.csv')\ncenter = pd.read_csv('\/kaggle\/input\/av-genpact-hack-dec2018\/fulfilment_center_info.csv')","528b065d":"train.head()","a9f4631e":"data = train.merge(meal, on='meal_id')","e2ee3b12":"data = data.merge(center, on='center_id')","8c1965d9":"data.head()","28d94cec":"data.nunique()","887eeae7":"corr = data.corr()\nimport seaborn as sns\nsns.heatmap(corr)","d9da7550":"center_id = 55\nmeal_id = 1993","28736861":"train_df = data[data['center_id']==center_id]\ntrain_df = train_df[train_df['meal_id']==meal_id]","54bfa0d3":"period = len(train_df)","a45b1558":"train_df['Date'] = pd.date_range('2015-01-01', periods=period, freq='W')","3e7c6407":"train_df['Day'] = train_df['Date'].dt.day\ntrain_df['Month'] = train_df['Date'].dt.month\ntrain_df['Year'] = train_df['Date'].dt.year\ntrain_df['Quarter'] = train_df['Date'].dt.quarter","66a2d0b0":"train_df.head()","56f2ab10":"xb_data = train_df.drop(columns=['id','center_id','meal_id','category','cuisine','center_type'])\n\nxb_data = xb_data.set_index(['Date'])","961491ef":"x_train = xb_data.drop(columns='num_orders')\ny_train = xb_data['num_orders']\ny_train = np.log1p(y_train)\nsplit_size = period-15\nX_train = x_train.iloc[:split_size,:]\nX_test = x_train.iloc[split_size:,:]\nY_train =  y_train.iloc[:split_size]\nY_test = y_train.iloc[split_size:]","b5328a3e":"import matplotlib.pyplot as plt\nplt.figure(figsize=(20,5))\nplt.plot(Y_train, label='training_data')\nplt.plot(Y_test, label='Validation_test')\nplt.legend(loc='best')","cd173b56":"from xgboost import XGBRegressor\nmodel_2 = XGBRegressor(\n learning_rate = 0.01,\n eval_metric ='rmse',\n    n_estimators = 50000,\n    max_depth = 5,\n    subsample = 0.8,\n    colsample_bytree = 1,\n    gamma = 0.5\n  \n  \n )\n#model.fit(X_train, y_train)\nmodel_2.fit(X_train, Y_train, eval_metric='rmse', \n          eval_set=[(X_test, Y_test)], early_stopping_rounds=500, verbose=100)","7a5f543a":"a = (model_2.get_booster().best_iteration)\na","a728b86f":"xgb_model = XGBRegressor(\n     \n     learning_rate = 0.01,\n   \n    n_estimators = a,\n    max_depth = 5,\n    subsample = 0.8,\n    colsample_bytree = 1,\n    gamma = 0.5)","6f2e6768":"xgb_model.fit(X_train, Y_train)","1c16f8a5":"xgb_preds = xgb_model.predict(X_test)","30ac9633":"xgb_preds = np.exp(xgb_preds)","30a3e8c0":"train_df.tail()","181cadeb":"xgb_preds = pd.DataFrame(xgb_preds)\nxgb_preds.index = Y_test.index","c90a3a28":"Y_train = np.exp(Y_train)\nY_test = np.exp(Y_test)","2769b0c9":"plt.figure(figsize=(20,5))\nplt.plot(Y_train, label='training_data')\nplt.plot(Y_test, label='Validation_test')\nplt.plot(xgb_preds, color='cyan', label='xgb_preds')\nplt.legend(loc='best')","06efd548":"from lightgbm import LGBMRegressor\nlgb_fit_params={\"early_stopping_rounds\":500, \n            \"eval_metric\" : 'rmse', \n            \"eval_set\" : [(X_test,Y_test)],\n            'eval_names': ['valid'],\n            'verbose':100\n           }\n\nlgb_params = {'boosting_type': 'gbdt',\n 'objective': 'regression',\n 'metric': 'rmse',\n 'verbose': 0,\n 'bagging_fraction': 0.8,\n 'bagging_freq': 1,\n 'lambda_l1': 0.01,\n 'lambda_l2': 0.01,\n 'learning_rate': 0.001,\n 'max_bin': 255,\n 'max_depth': 6,\n 'min_data_in_bin': 1,\n 'min_data_in_leaf': 1,\n 'num_leaves': 31}\n\nY_train = np.log1p(Y_train)\nY_test = np.log1p(Y_test)","202b7742":"clf_lgb = LGBMRegressor(n_estimators=10000, **lgb_params, random_state=123456789, n_jobs=-1)\nclf_lgb.fit(X_train, Y_train, **lgb_fit_params)","1c8cef45":"lgb_model = LGBMRegressor(bagging_fraction=0.8, bagging_freq=1, lambda_l1=0.01,\n              lambda_l2=0.01, learning_rate=0.01, max_bin=255, max_depth=6,\n              metric='rmse', min_data_in_bin=1, min_data_in_leaf=1,\n              n_estimators=10000, objective='regression',\n              random_state=123456789, verbose=0)","587378e2":"lgb_model.fit(X_train,Y_train)\n","d00b18dc":"lgm_preds = lgb_model.predict(X_test)\nlgm_preds = np.exp(lgm_preds)","da7d621f":"lgm_preds = pd.DataFrame(lgm_preds)\nlgm_preds.index = Y_test.index","16cf7123":"Y_train = np.exp(Y_train)\nY_test = np.exp(Y_test)","388b9b00":"plt.figure(figsize=(20,5))\nplt.plot(Y_train)\nplt.plot(Y_test, label='Original')\nplt.plot(xgb_preds, color='cyan', label=\"xgb_prediction\")\nplt.plot(lgm_preds, color='red', label='light_lgm_prediction')\nplt.legend(loc='best')","b1a273eb":"from catboost import CatBoostRegressor\nY_train = np.log1p(Y_train)\nY_test = np.log1p(Y_test)\n\ncat_model=CatBoostRegressor()\ncat_model.fit(X_train, Y_train)","d92298fc":"cat_preds = cat_model.predict(X_test)\ncat_preds = np.exp(cat_preds)","25305bc3":"cat_preds = pd.DataFrame(cat_preds)\ncat_preds.index = Y_test.index\nY_train = np.exp(Y_train)\nY_test = np.exp(Y_test)","2a378ef9":"plt.figure(figsize=(20,5))\nplt.plot(Y_train)\nplt.plot(Y_test, label='Original')\nplt.plot(xgb_preds, color='cyan', label=\"xgb_prediction\")\nplt.plot(lgm_preds, color='red', label='light_lgm_prediction')\nplt.plot(cat_preds, color='green', label='cat_prediction')\nplt.legend(loc='best')","47bbacf6":"prophet_data = train_df[['Date','num_orders']]\nprophet_data.index = xb_data.index\nprophet_data = prophet_data.iloc[:split_size,:]","0d905f6c":"prophet_data =prophet_data.rename(columns={'Date':'ds',\n                             'num_orders':'y'})\nprophet_data.head()","b93fe568":"from fbprophet import Prophet\nm = Prophet(growth='linear',\n            seasonality_mode='multiplicative',\n#            changepoint_prior_scale = 30,\n           seasonality_prior_scale = 35,\n           holidays_prior_scale = 10,\n           daily_seasonality = True,\n           weekly_seasonality = False,\n           yearly_seasonality= False,\n           ).add_seasonality(\n                name='monthly',\n                period=30.5,\n                fourier_order=30\n            \n            ).add_seasonality(\n                name='weekly',\n                period=7,\n                fourier_order=55\n            ).add_seasonality(\n                name='yearly',\n                period=365.25,\n                fourier_order=20\n            )\n        \nm.fit(prophet_data)","23f8f02d":"future = m.make_future_dataframe(periods=15, freq='W')","07ca4b67":"forecast = m.predict(future)\n# forecast['yhat'] = np.exp(forecast['yhat'])\n# forecast['yhat_lower'] = np.exp(forecast['yhat_lower'])\n# forecast['yhat_upper'] = np.exp(forecast['yhat_upper'])\nforecast[['ds', 'yhat', 'yhat_lower', 'yhat_upper']].tail()","3e03f012":"fig2 = m.plot_components(forecast)\n","0bbb3d07":"from fbprophet.plot import plot_plotly\nimport plotly.offline as py\npy.init_notebook_mode()\n\nfig = plot_plotly(m, forecast)  # This returns a plotly Figure\npy.iplot(fig)","4dc5c34f":"prophet_preds = forecast['yhat'].iloc[split_size:]\nprophet_preds.index = Y_test.index","38f323b6":"plt.figure(figsize=(20,5))\nplt.plot(Y_train)\nplt.plot(Y_test, label='Original')\nplt.plot(xgb_preds, color='cyan', label=\"xgb_prediction\")\nplt.plot(lgm_preds, color='red', label='light_lgm_prediction')\nplt.plot(prophet_preds, color='green', label='prophet_prediction')\nplt.plot(cat_preds, color='blue', label='cat_prediction')\nplt.legend(loc='best')","3bc97dd7":"plt.figure(figsize=(20,5))\n# plt.plot(Y_train)\nplt.plot(Y_test, label='Original')\nplt.plot(xgb_preds, color='cyan', label=\"xgb_prediction\")\nplt.plot(lgm_preds, color='red', label='light_lgm_prediction')\nplt.plot(prophet_preds, color='green', label='prophet_prediction')\nplt.plot(cat_preds, color='blue', label='cat_prediction')\nplt.legend(loc='best')","48f3c70c":"a = np.array(prophet_preds)\nb = np.array(lgm_preds)\nc = np.array(xgb_preds)\nd = np.array(cat_preds)\nfinal_preds =  (b*0.8)+ (d*0.2) \nfinal_preds = (final_preds*0.4) + (a*0.6)","54ddde22":"final_preds[6]","55f1c5b7":"final_preds = pd.DataFrame(final_preds[6])\nfinal_preds.index = Y_test.index","fa9ad816":"final_preds = pd.DataFrame(final_preds)\nfinal_preds.index = Y_test.index\nplt.figure(figsize=(20,5))\n# plt.plot(Y_train)\nplt.plot(Y_test, label='Original')\nplt.plot(xgb_preds, color='cyan', label=\"xgb_prediction\")\nplt.plot(lgm_preds, color='orange', label='light_lgm_prediction')\nplt.plot(prophet_preds, color='green', label='prophet_prediction')\nplt.plot(final_preds, color='red',linestyle='--', label='final_prediction')\nplt.plot(cat_preds, color='blue', label='cat_prediction')\nplt.legend(loc='best')","a785e91d":"from sklearn.metrics import mean_squared_error\nprint(mean_squared_error(Y_test, final_preds, squared=False))","4ab2ac83":"# XGB Boost","6d21e399":"# Cat_Regressor","0bab3e47":"# Combine Forecast","ef4e0b4f":"# Prophet model","80c506c9":"# Light GBM Model"}}