{"cell_type":{"a60d21ee":"code","4eda065a":"code","d3676b32":"code","f9b85fa1":"code","34d5899f":"code","13a7d191":"code","4efb7bed":"code","96f90855":"code","58bae213":"code","88822094":"code","7f619a2d":"code","1295229b":"code","482b6d62":"code","4c151aa6":"code","527c03ca":"code","019f5c58":"code","7cca2391":"code","bd9eb25a":"code","9abaa317":"code","3009bbf5":"code","b002f791":"code","1b222e1e":"code","daa6266a":"code","b0a81f59":"code","35bb69f6":"code","3da81457":"code","98e58a2f":"code","a72550ed":"code","d949556a":"code","decac1de":"code","8b85392f":"markdown","d0c9ea4b":"markdown","de2ed490":"markdown","e6a63042":"markdown","f9b17f75":"markdown","0ff2324a":"markdown","34e5ff1d":"markdown","fa051164":"markdown","52e13b25":"markdown","79622ff5":"markdown","396caed7":"markdown","aa07ca8f":"markdown"},"source":{"a60d21ee":"import numpy as np\nimport matplotlib.pyplot as plt \nimport seaborn as sns\n\n# get EPA air quality data set through Google BigQuery\nfrom google.cloud import bigquery\nbqclient = bigquery.Client()\naq_dataset_ref = bqclient.dataset('epa_historical_air_quality', project='bigquery-public-data')\naq_dataset = bqclient.get_dataset(aq_dataset_ref)\n\n# Set maximum number of columns to display to a relatively high number so all columns will typically be seen in the notebook\nimport pandas as pd\npd.options.display.max_columns = 2000","4eda065a":"# Listing tables in the dataset\n[x.table_id for x in bqclient.list_tables(aq_dataset)]","d3676b32":"# Listing schemas of a few tables in the next few cells:\n\nannual_summary_table = bqclient.get_table(aq_dataset.table('air_quality_annual_summary'))\nco_daily_summary_table = bqclient.get_table(aq_dataset.table('co_daily_summary'))","f9b85fa1":"annual_summary_table.schema","34d5899f":"co_daily_summary_table.schema","13a7d191":"# List some rows of annual summary table\nbqclient.list_rows(annual_summary_table, max_results=5).to_dataframe()","4efb7bed":"# List some rows of a daily summary table (carbon monoxide)\nbqclient.list_rows(co_daily_summary_table, max_results=5).to_dataframe()","96f90855":"# Most commonly measured parameters in air quality annual summary table and their units\ntest_query = \"\"\"\nSELECT\n    parameter_name, units_of_measure, COUNT(*) AS counts\nFROM\n    `bigquery-public-data.epa_historical_air_quality.air_quality_annual_summary`\nWHERE\n    year=2019\nGROUP BY\n    parameter_name, units_of_measure\nORDER BY\n    counts DESC\nLIMIT\n    20\n\"\"\"\nquery_job = bqclient.query(test_query)\nquery_job.to_dataframe()","58bae213":"# Define pollutants to look at in annual summary data (these will be used in later sections)\nPOLLUTANTS_ANNUAL = ['PM2.5 - Local Conditions', 'PM10 Total 0-10um STP', 'Nitrogen dioxide (NO2)', 'Ozone', 'Sulfur dioxide', 'Carbon monoxide']\nPOLLUTANTS_ANNUAL_UNITS = {\n    'PM2.5 - Local Conditions': 'Micrograms\/cubic meter (LC)', \n    'PM10 Total 0-10um STP': 'Micrograms\/cubic meter (25 C)', \n    'Nitrogen dioxide (NO2)': 'Parts per billion', \n    'Ozone': 'Parts per million', \n    'Sulfur dioxide': 'Parts per billion', \n    'Carbon monoxide': 'Parts per million'\n}","88822094":"# Number of data points in annual summary with exceptional events\ntest_query = \"\"\"\nSELECT \n    event_type, COUNT(*) AS counts\nFROM\n    `bigquery-public-data.epa_historical_air_quality.air_quality_annual_summary`\nWHERE\n    year=2019\nGROUP BY\n    event_type\nORDER BY\n    counts DESC\nLIMIT\n    10\n\"\"\"\nquery_job = bqclient.query(test_query)\nquery_job.to_dataframe()","7f619a2d":"# Number of data points in CO daily summary with exceptional events:\ntest_query = \"\"\"\nSELECT\n    event_type, COUNT(*) AS counts\nFROM\n    `bigquery-public-data.epa_historical_air_quality.co_daily_summary`\nWHERE\n    EXTRACT(YEAR FROM date_local)=2019\nGROUP BY\n    event_type\nORDER BY\n    counts DESC\nLIMIT\n    10\n\"\"\"\nquery_job = bqclient.query(test_query)\nquery_job.to_dataframe()","1295229b":"def pollutant_bar(data, pollutant, x, y):\n    \"\"\"Pretty bar plot for pollutant strength (y) vs geographic area (x)\n    \"\"\"\n    pollutant_result = data[data.parameter_name == pollutant]\n    plt.figure(figsize=(9, 9))\n    sns.barplot(x=x, y=y, hue='is_california', data=pollutant_result)\n    plt.xticks(rotation=90, ha='right')\n    plt.title(pollutant)\n    plt.ylabel(POLLUTANTS_ANNUAL_UNITS[pollutant])","482b6d62":"# average air qualities by state and pollutant in USA for 2019\npollutants_for_query = \"', '\".join(POLLUTANTS_ANNUAL)\npollutants_for_query = \"'\"+pollutants_for_query+\"'\"\nquery = f\"\"\"\nSELECT\n    state_name, parameter_name, AVG(arithmetic_mean) AS arithmetic_mean_average\nFROM\n    `bigquery-public-data.epa_historical_air_quality.air_quality_annual_summary`\nWHERE\n    year=2019 AND parameter_name IN ({pollutants_for_query})\nGROUP BY\n    state_name, parameter_name\nORDER BY\n    arithmetic_mean_average DESC\n\"\"\"\nquery_job = bqclient.query(query)\nresult = query_job.to_dataframe()\nresult['is_california'] = result['state_name'] == 'California'\nfor pollutant in POLLUTANTS_ANNUAL:\n    pollutant_bar(result, pollutant, x='state_name', y='arithmetic_mean_average')","4c151aa6":"state_codes = {\n    'District Of Columbia' : 'dc','Mississippi': 'MS', 'Oklahoma': 'OK', \n    'Delaware': 'DE', 'Minnesota': 'MN', 'Illinois': 'IL', 'Arkansas': 'AR', \n    'New Mexico': 'NM', 'Indiana': 'IN', 'Maryland': 'MD', 'Louisiana': 'LA', \n    'Idaho': 'ID', 'Wyoming': 'WY', 'Tennessee': 'TN', 'Arizona': 'AZ', \n    'Iowa': 'IA', 'Michigan': 'MI', 'Kansas': 'KS', 'Utah': 'UT', \n    'Virginia': 'VA', 'Oregon': 'OR', 'Connecticut': 'CT', 'Montana': 'MT', \n    'California': 'CA', 'Massachusetts': 'MA', 'West Virginia': 'WV', \n    'South Carolina': 'SC', 'New Hampshire': 'NH', 'Wisconsin': 'WI',\n    'Vermont': 'VT', 'Georgia': 'GA', 'North Dakota': 'ND', \n    'Pennsylvania': 'PA', 'Florida': 'FL', 'Alaska': 'AK', 'Kentucky': 'KY', \n    'Hawaii': 'HI', 'Nebraska': 'NE', 'Missouri': 'MO', 'Ohio': 'OH', \n    'Alabama': 'AL', 'Rhode Island': 'RI', 'South Dakota': 'SD', \n    'Colorado': 'CO', 'New Jersey': 'NJ', 'Washington': 'WA', \n    'North Carolina': 'NC', 'New York': 'NY', 'Texas': 'TX', \n    'Nevada': 'NV', 'Maine': 'ME'}\n# from: https:\/\/stackoverflow.com\/questions\/48979352\/choropleth-map-in-python-using-plotly-without-state-codes\n\nmapdf = result.copy()\nmapdf = mapdf[(mapdf['state_name'] != 'Country Of Mexico') & (mapdf['state_name'] != 'Puerto Rico') & (mapdf['state_name'] != 'Virgin Islands')]\nmapdf['state_code'] = mapdf['state_name'].apply(lambda x: state_codes[x])","527c03ca":"import plotly.offline as pyo \nimport plotly.graph_objects as go\npyo.init_notebook_mode()\n\ndef pollutant_usa_map(data, pollutant):\n    pollutant_result = data[data.parameter_name == pollutant]\n    fig = go.Figure(data=go.Choropleth(\n            locations=pollutant_result['state_code'],\n            z=pollutant_result['arithmetic_mean_average'].astype(float),\n            locationmode='USA-states',\n            colorscale='Reds',\n            colorbar_title=POLLUTANTS_ANNUAL_UNITS[pollutant]))\n    fig.update_layout(title_text=pollutant,\n        geo_scope='usa')\n    fig.show()","019f5c58":"for pollutant in POLLUTANTS_ANNUAL:\n    pollutant_usa_map(mapdf, pollutant)","7cca2391":"def pollutant_bar_county(data, pollutant, x, y):\n    \"\"\"Pretty bar plot for pollutant strength (y) vs geographic area (x)\n    \"\"\"\n    pollutant_result = data[data.parameter_name == pollutant]\n    plt.figure(figsize=(9, 9))\n    sns.barplot(x=x, y=y, data=pollutant_result)\n    plt.xticks(rotation=90, ha='right')\n    plt.title(pollutant)\n    plt.ylabel(POLLUTANTS_ANNUAL_UNITS[pollutant])","bd9eb25a":"# average air qualities by county and pollutant for California in 2019\nquery = f\"\"\"\nSELECT \n    county_name, parameter_name, AVG(arithmetic_mean) AS arithmetic_mean_average\nFROM \n    `bigquery-public-data.epa_historical_air_quality.air_quality_annual_summary`\nWHERE\n    year=2019 AND state_name='California' AND parameter_name IN ({pollutants_for_query})\nGROUP BY\n    county_name, parameter_name\nORDER BY\n    arithmetic_mean_average DESC\n\"\"\"\nquery_job = bqclient.query(query)\nresult = query_job.to_dataframe()\nfor pollutant in POLLUTANTS_ANNUAL:\n    pollutant_bar_county(result, pollutant, x='county_name', y='arithmetic_mean_average')","9abaa317":"# Get converter from county name to FIPS code\nquery = f\"\"\"\nSELECT\n    county_name, CONCAT(state_code, county_code) AS fips\nFROM\n    `bigquery-public-data.epa_historical_air_quality.air_quality_annual_summary`\nWHERE\n    year=2019 AND state_name='California' AND parameter_name IN ({pollutants_for_query})\nGROUP BY\n    county_name, fips\n\"\"\"\nquery_job = bqclient.query(query)\nresult2 = query_job.to_dataframe()\nconversion_to_fips = result2.set_index('county_name').to_dict()['fips']","3009bbf5":"import plotly.express as px\n\nfrom urllib.request import urlopen\nimport json\nwith urlopen('https:\/\/raw.githubusercontent.com\/plotly\/datasets\/master\/geojson-counties-fips.json') as response:\n    counties = json.load(response)\n\ndef pollutant_county_map(data, pollutant):\n    pollutant_result = data[data.parameter_name == pollutant]\n    fig = px.choropleth(pollutant_result, geojson=counties, locations='fips',\n                       color='arithmetic_mean_average',\n                       hover_data=['county_name', 'arithmetic_mean_average'], title=pollutant)\n    fig.update_geos(fitbounds='locations')\n    fig.show()\n\nmapdf = result.copy()\nmapdf['fips'] = mapdf['county_name'].apply(lambda x: conversion_to_fips[x])\n\nfor pollutant in POLLUTANTS_ANNUAL:\n    pollutant_county_map(mapdf, pollutant)","b002f791":"# Average number of days primary air quality standard exceeded by pollutant and county for California in 2019\nquery = f\"\"\"\nSELECT\n    county_name, parameter_name, AVG(primary_exceedance_count) AS average_above_primary\nFROM\n    `bigquery-public-data.epa_historical_air_quality.air_quality_annual_summary`\nWHERE\n    year=2019 AND state_name='California' AND parameter_name IN ({pollutants_for_query})\nGROUP BY\n    county_name, parameter_name\nORDER BY\n    average_above_primary DESC\n\"\"\"\nquery_job = bqclient.query(query)\nresult = query_job.to_dataframe()\nfor pollutant in POLLUTANTS_ANNUAL:\n    pollutant_bar_county(result, pollutant, x='county_name', y='average_above_primary')\n    plt.ylabel(''.join([pollutant, ' average days above primary standard']))","1b222e1e":"# Average number of days secondary air quality standard exceeded by pollutant and county in California in 2019:\nquery = f\"\"\"\nSELECT\n    county_name, parameter_name, AVG(secondary_exceedance_count) AS average_above_secondary\nFROM\n    `bigquery-public-data.epa_historical_air_quality.air_quality_annual_summary`\nWHERE\n    year=2019 AND state_name='California' AND parameter_name IN ({pollutants_for_query})\nGROUP BY\n    county_name, parameter_name\nORDER BY\n    average_above_secondary DESC\n\"\"\"\nquery_job = bqclient.query(query)\nresult = query_job.to_dataframe()\nfor pollutant in POLLUTANTS_ANNUAL:\n    pollutant_bar_county(result, pollutant, x='county_name', y='average_above_secondary')\n    plt.ylabel(''.join([pollutant, ' average days above secondary standard']))","daa6266a":"# start of names of pollutants to examine in daily summary tables\nPOLLUTANTS_DAILY = ['pm25_frm', 'pm10', 'no2', 'o3', 'so2', 'co']","b0a81f59":"# Monthly variation of pollutants for California average\ndef plot_pollutant_vs_month(pollutant):\n    \"\"\"Plot average pollutant concentration vs month for California in 2019\n    \"\"\"\n    query = f\"\"\"\n    SELECT\n        EXTRACT(MONTH FROM date_local) AS month, AVG(arithmetic_mean) AS average\n    FROM\n        `bigquery-public-data.epa_historical_air_quality.{pollutant}_daily_summary`\n    WHERE\n        state_name='California' AND EXTRACT(YEAR FROM date_local)=2019\n    GROUP BY\n        month\n    ORDER BY\n        month ASC\n    \"\"\"\n    query_job = bqclient.query(query)\n    result = query_job.to_dataframe()\n    result = result.set_index('month')\n    result.plot()\n    plt.ylabel(''.join([pollutant, ' average']))\n    \nfor pollutant in POLLUTANTS_DAILY:\n    plot_pollutant_vs_month(pollutant)","35bb69f6":"# Montly variation of pollutants for counties in California\n\ndef plot_pollutant_vs_county_month(pollutant):\n    \"\"\"Plot average pollutant vs month and county for California\n    \"\"\"\n    query = f\"\"\"\n    SELECT \n        county_name, EXTRACT(MONTH FROM date_local) AS month, AVG(arithmetic_mean) AS average\n    FROM\n        `bigquery-public-data.epa_historical_air_quality.{pollutant}_daily_summary`\n    WHERE\n        state_name='California' AND EXTRACT(YEAR FROM date_local)=2019\n    GROUP BY\n        month, county_name\n    \"\"\"\n    query_job = bqclient.query(query)\n    result = query_job.to_dataframe()\n    table = pd.pivot_table(result, values='average', index='county_name', columns='month')\n    table = table.sort_values(by=12, ascending=False)\n    plt.figure(figsize=(8, 8))\n    sns.heatmap(table, annot=True, fmt='.2f', cmap='Reds')\n    plt.title(pollutant)\n    \nfor pollutant in POLLUTANTS_DAILY:\n    plot_pollutant_vs_county_month(pollutant)","3da81457":"def plot_climate_vs_pollutant(climate_variable_name='Outdoor Temperature', climate_aggregator='AVG', pollutant_name='Carbon monoxide',\n                             axis=None):\n    \"\"\"Plot average pollutant concentration vs climate parameter aggregated at county level\n    \"\"\"\n    query = f\"\"\"\n    WITH county_climate AS\n    (\n    SELECT\n        county_name, {climate_aggregator}(arithmetic_mean) AS climate_parameter\n    FROM\n        `bigquery-public-data.epa_historical_air_quality.air_quality_annual_summary`\n    WHERE\n        year=2019 AND state_name='California' AND parameter_name='{climate_variable_name}'\n    GROUP BY\n        county_name\n    )\n    SELECT\n        AVG(climate_parameter) AS climate_parameter, AVG(arithmetic_mean) AS average_pollutant\n    FROM\n        `bigquery-public-data.epa_historical_air_quality.air_quality_annual_summary` AS annual_table\n    JOIN \n        county_climate ON(annual_table.county_name=county_climate.county_name)\n    WHERE\n        year=2019 AND state_name='California' AND parameter_name='{pollutant_name}'\n    GROUP BY\n        annual_table.county_name\n    \"\"\"\n    query_job = bqclient.query(query)\n    result = query_job.to_dataframe()\n    if axis is None:\n        axis = plt.gca()\n    result.plot(x='climate_parameter', y='average_pollutant', kind='scatter', ax=axis)\n    axis.set_xlabel(''.join([climate_aggregator, '(', climate_variable_name, ')']))\n    axis.set_ylabel(''.join([pollutant_name, ' average']))\n    \ndef plot_climate_vs_pollutants(pollutants, climate_variable_name='Outdoor Temperature'):\n    \"\"\"Plot average pollutants concentrations vs climate average and standard deviation\n    Aggregated at county level\n    \"\"\"\n    f, axs = plt.subplots(len(pollutants), 2, sharey='row', sharex='col', figsize=(8, 20))\n    for i, pollutant in enumerate(pollutants):\n        plot_climate_vs_pollutant(climate_variable_name, 'AVG', pollutant, axis=axs[i, 0])\n        plot_climate_vs_pollutant(climate_variable_name, 'STDDEV', pollutant, axis=axs[i, 1])","98e58a2f":"plot_climate_vs_pollutants(POLLUTANTS_ANNUAL, 'Outdoor Temperature')","a72550ed":"plot_climate_vs_pollutants(POLLUTANTS_ANNUAL, 'Average Ambient Pressure')","d949556a":"# Humidity plots\nplot_climate_vs_pollutants(POLLUTANTS_ANNUAL, 'Relative Humidity ')","decac1de":"# Wind speed plots\nplot_climate_vs_pollutants(POLLUTANTS_ANNUAL, 'Wind Speed - Scalar')","8b85392f":"# Exploring 2019 California Air Quality\n\nThe World Health Organization estimates that 4.2 million deaths occur every year as a result of exposure to outdoor air pollution. https:\/\/www.who.int\/health-topics\/air-pollution#tab=tab_1. A good understanding of where and when pollutants concentrate can help people understand causes of pollutants and how they might be reduced as well as monitor how pollution mitigation efforts are going.\n\nIn this notebook, I do some basic exploration of the SQL US Environmental Protection Agency (EPA) Air Quality System (AQS) Data Mart (https:\/\/www.epa.gov\/outdoor-air-quality-data). This data mart has a tremendous amount of data, so to keep the scope of this analysis managable, I only looked at 2019 data and also primarily limited the geographic extent to California.\n\nMore background information can be found here:\n\nKaggle page for this data: https:\/\/www.kaggle.com\/epa\/epa-historical-air-quality.\n\nBigquery page for this data:\nhttps:\/\/console.cloud.google.com\/marketplace\/product\/epa\/historical-air-quality?filter=solution-type:dataset&filter=category:climate&q=public%20data&id=198c2178-3986-4182-a7c7-4c9ae81dfc5d\n\nOverview of air quality data:\nhttps:\/\/blog.breezometer.com\/ultimate-guide-understanding-air-quality-data\n\nDescription of six crieria air pollutants:\nhttps:\/\/www.epa.gov\/criteria-air-pollutants\n\n\n","d0c9ea4b":"In 2019, California's pollution levels weren't exceptional for the USA, but it was in the top 5 states for PM10. ","de2ed490":"<a id=\"california-counties\"><\/a>\n## Variations across counties in California","e6a63042":"The seasonal pollutant trends seen when aggregating across California 2019 occur mostly in the same manner for individual counties as well. There are a few exceptions, for instance, some counties counties had their worst PM2.5 levels during a summer month. This might be due to fires and would be something interesting to investigate further.","f9b17f75":"<a id=\"seasonal\"><\/a>\n## Seasonal Variations of Pollutant Concentrations","0ff2324a":"There are some significant correlations between climate variables and pollution variables. For example, between either PM2.5 or PM10 and average temperature. I anticipate that one could uncover stronger correlations if looking at data on finer geographic and temporal scales.","34e5ff1d":"The Los Angeles area, well known for its smog, is unsurprisingly among the areas with higher particulate matter pollution levels. The highest levels, however, seem to appear in the southern central valley. This could be due to wildfires. The highest values of carbon monoxide were interestingly recorded in the southern parts of the bay area. It also seems like many counties are missing data for certain pollutants, but I would need to look more into the data to confirm whether this is the reason that they don't appear in the plots.","fa051164":"<a id=\"basic-dataset\"><\/a>\n## Basic dataset Information","52e13b25":"Different pollutants had different seasonal dependences. PM2.5, NO and CO were most concentrated in the winter months. PM10, NO2 and SO2 were most concentrated in the fall. Finally, ozone was most concentrated in the summer.","79622ff5":"The rest of this notebook is organized as follows:\n* [Basic Dataset Information (In this section I look at the general information available in the dataset)](#basic-dataset)\n* [California Compared to Other States (In this section I compare pollution in California to other states for context)](#california-vs-others)\n* [Variations Across Counties in California](#california-counties)\n* [Seasonal Variations of Pollutant Concentrations](#seasonal)\n* [Dependence of Pollutant Concentrations on County Climate](#climate)","396caed7":"<a id=\"california-vs-others\"><\/a>\n## California Compared to Other States\n\nLet's get some context of how California's air quality compares to other states.","aa07ca8f":"<a id=\"climate\"><\/a>\n## Dependence of Pollutant Concentrations on County Climate\n\nWeather can impact air quality as well as change human behaviors that impact pollution.\nhttps:\/\/scied.ucar.edu\/learning-zone\/air-quality\/how-weather-affects-air-quality\nDifferent types of weather can also impact the probability of events that markedly impact pollution, such as wildfires.\n\nIn this section I'll look at the correlation between county climate and pollution."}}