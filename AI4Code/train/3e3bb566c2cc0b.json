{"cell_type":{"13013407":"code","bd793489":"code","75d209a4":"code","c838db06":"code","db11e5f9":"code","11f2e8fb":"code","b74c0fd9":"code","659aa1b4":"code","702bbf8d":"code","0144c497":"code","b33aa74a":"code","a260f92e":"code","a5dc37dc":"code","6ba5e03a":"code","7a318b6a":"code","eab76e3b":"code","a0233afa":"code","5767e686":"code","d3e5e316":"code","aadadb86":"code","9b8a8750":"code","48355df6":"code","80dbc779":"code","43504771":"code","133b00b2":"code","80bdba25":"code","00e57005":"code","10828b17":"code","9a9a9383":"code","1285aee0":"code","5766640b":"code","91c27e35":"code","0add5168":"code","f1d73926":"code","dbce70ee":"code","01c95c8d":"code","5cea8c4d":"code","212b2bad":"markdown","12d0f883":"markdown","054734b5":"markdown","b0252c6d":"markdown","5f75edc1":"markdown","845416b5":"markdown","02d922b8":"markdown","804c8656":"markdown","8f39419b":"markdown","bb88b7f1":"markdown","4a250701":"markdown","2fb70395":"markdown","d3de4592":"markdown","8248c4df":"markdown","7c9ff395":"markdown","d3ae8fac":"markdown","5a21afa8":"markdown","ee330e6d":"markdown","93fb55b9":"markdown","286a1b58":"markdown","c2e9cbf2":"markdown"},"source":{"13013407":"import numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\nimport geopandas as gpd\nimport matplotlib.pyplot as plt\nimport folium\nfrom shapely import wkt\n\nimport datetime as dt\nimport warnings\n\nimport matplotlib.pyplot as plt\nimport seaborn as sns\nimport plotly.graph_objects as go\nimport plotly.express as px\nimport plotly.offline as py\nfrom plotly.subplots import make_subplots\n\nwarnings.filterwarnings(action=\"ignore\")\nnp.set_printoptions(suppress=True)\npd.set_option(\"display.float_format\", lambda x: \"%.5f\" % x)\npd.options.display.max_rows = 999\n\n# Input data files are available in the \"..\/input\/\" directory.\n# For example, running this (by clicking run or pressing Shift+Enter) will list all files under the input directory\n\nimport os\nfor dirname, _, filenames in os.walk('\/kaggle\/input'):\n    for filename in filenames:\n        print(os.path.join(dirname, filename))\n\n# Any results you write to the current directory are saved as output.","bd793489":"covid_df = pd.read_csv('\/kaggle\/input\/enrichednytimescovid19\/covid19_us_county.csv')\nprint(covid_df.shape)","75d209a4":"#turn to datetime from string\ncovid_df['date'] = pd.to_datetime(covid_df['date'])","c838db06":"# also want to merge in geo info for geospatial viz and analysis\ngeo_county_df = pd.read_csv('\/kaggle\/input\/enrichednytimescovid19\/us_county_pop_and_shps.csv')\ngeo_covid_df = pd.merge(covid_df, geo_county_df, how='left', on=['fips', 'county', 'state', 'county_pop_2019_est']).dropna()\ngeo_covid_df['date2'] = geo_covid_df['date'].astype('str')","db11e5f9":"covid_df.tail(2)","11f2e8fb":"covid_df.describe()","b74c0fd9":"# number of unique U.S. counties with at least 1 confirmed case?\n#covid_df.fips.nunique()","659aa1b4":"# what is the date range?\nprint('begin: {0}, end: {1}'.format(covid_df.date.min(), covid_df.date.max()))","702bbf8d":"geo_covid_df['deaths_per_100k_pop'] = geo_covid_df['deaths_per_capita_100k']\nfig = px.scatter_mapbox(geo_covid_df[geo_covid_df.date > dt.datetime(2020, 3, 14)], \n                        lat=\"county_center_lat\", lon=\"county_center_lon\", \n                        hover_name=\"county\", hover_data=[\"state\", \"county\"], color=\"deaths_per_100k_pop\", \n                        size=\"deaths_per_capita_100k\",size_max=30, zoom=3, height=500,\n                        animation_frame=str('date2'))\nfig.update_layout(mapbox_style=\"open-street-map\")\nfig.update_layout(margin={\"r\":0,\"t\":0,\"l\":0,\"b\":0})\npy.offline.iplot(fig)","0144c497":"geo_covid_df['new cases per 100k pop.'] = geo_covid_df['new_day_cases_per_capita_100k']\nfig = px.density_mapbox(geo_covid_df[geo_covid_df.date > dt.datetime(2020, 3, 14)], \n                        lat=\"county_center_lat\", lon=\"county_center_lon\", \n                        hover_name=\"county\", hover_data=[\"state\", \"county\", \"new cases per 100k pop.\"], \n                        radius=10,\n                        z='new cases per 100k pop.',\n                        zoom=3, \n                        height=600,\n                        width=1000,\n                        title='new cases per 100k pop.',\n                        animation_frame=str('date2'),\n                       )\nfig.update_layout(mapbox_style=\"open-street-map\")\nfig.update_layout(margin={\"r\":0,\"t\":0,\"l\":0,\"b\":0})\npy.offline.iplot(fig)","b33aa74a":"us_df = covid_df.groupby(['date'], as_index=False).sum()\n\nplt_titles = ['U.S. Total Cases', 'U.S. Total Deaths']\nfig = make_subplots(rows=2, cols=1, subplot_titles=plt_titles)\nfig.add_trace(go.Scatter(x=us_df['date'], y=us_df['cases']), row=1, col=1)\nfig.add_trace(go.Scatter(x=us_df['date'], y=us_df['deaths']), row=2, col=1)\nfig.update_xaxes(range=[dt.date(2020, 2, 1), covid_df.date.max() + dt.timedelta(days=2)])\nfig.update_layout(title='U.S - COVID19 Cumulative Totals', height=700,\n                  showlegend=False)","a260f92e":"fig = px.bar(us_df, x='date', y='new_day_cases')\nfig.update_layout(title = 'U.S -  New Cases per Day')\npy.offline.iplot(fig)","a5dc37dc":"# lets get just the latest date\nlatest_covid_df = covid_df[covid_df.date == covid_df.date.max()]\n#latest_covid_df.head(2)\ntop10_cases_county_df = latest_covid_df.sort_values('cases_per_capita_100k', ascending=False).head(10)\ntop10_cases_county_df['state_county'] = top10_cases_county_df['state'] + '-' + top10_cases_county_df['county']\n\nfig = go.Figure(data=[go.Bar(\n            x=top10_cases_county_df['state_county'], y=top10_cases_county_df['cases_per_capita_100k'],\n        )])\nfig.update_layout(title='Top 10 Counties - Cases Per 100k People (as of {0})'.format(covid_df.date.max()))\npy.offline.iplot(fig)","6ba5e03a":"latest_covid_df['log_cases_per_capita_100k'] = latest_covid_df['cases_per_capita_100k'].apply(lambda x: np.log(x+1))\nlatest_covid_df['log_pop_per_sq_mile_2010'] = latest_covid_df['pop_per_sq_mile_2010'].apply(lambda x: np.log(x+1))\nsns.jointplot(x=\"log_cases_per_capita_100k\", y=\"log_pop_per_sq_mile_2010\", kind=\"hex\",\n              data=latest_covid_df);","7a318b6a":"us_state_df = covid_df.groupby(['date', 'state'], as_index=False).sum()\nus_state_df['date2'] = us_state_df['date'].astype('str')\nmax_date = covid_df.date.max()\nfig = px.pie(us_state_df[us_state_df.date == max_date], \n             values='cases', names='state', title='U.S Total Cases Per State - {0}'.format(max_date))\nfig.update_traces(textposition='inside', textinfo='percent+label')\nfig.update_layout(height=700)\nfig.show()","eab76e3b":"us_state_abbrev = {\n    'Alabama': 'AL',\n    'Alaska': 'AK',\n    'American Samoa': 'AS',\n    'Arizona': 'AZ',\n    'Arkansas': 'AR',\n    'California': 'CA',\n    'Colorado': 'CO',\n    'Connecticut': 'CT',\n    'Delaware': 'DE',\n    'District of Columbia': 'DC',\n    'Florida': 'FL',\n    'Georgia': 'GA',\n    'Guam': 'GU',\n    'Hawaii': 'HI',\n    'Idaho': 'ID',\n    'Illinois': 'IL',\n    'Indiana': 'IN',\n    'Iowa': 'IA',\n    'Kansas': 'KS',\n    'Kentucky': 'KY',\n    'Louisiana': 'LA',\n    'Maine': 'ME',\n    'Maryland': 'MD',\n    'Massachusetts': 'MA',\n    'Michigan': 'MI',\n    'Minnesota': 'MN',\n    'Mississippi': 'MS',\n    'Missouri': 'MO',\n    'Montana': 'MT',\n    'Nebraska': 'NE',\n    'Nevada': 'NV',\n    'New Hampshire': 'NH',\n    'New Jersey': 'NJ',\n    'New Mexico': 'NM',\n    'New York': 'NY',\n    'North Carolina': 'NC',\n    'North Dakota': 'ND',\n    'Northern Mariana Islands':'MP',\n    'Ohio': 'OH',\n    'Oklahoma': 'OK',\n    'Oregon': 'OR',\n    'Pennsylvania': 'PA',\n    'Puerto Rico': 'PR',\n    'Rhode Island': 'RI',\n    'South Carolina': 'SC',\n    'South Dakota': 'SD',\n    'Tennessee': 'TN',\n    'Texas': 'TX',\n    'Utah': 'UT',\n    'Vermont': 'VT',\n    'Virgin Islands': 'VI',\n    'Virginia': 'VA',\n    'Washington': 'WA',\n    'West Virginia': 'WV',\n    'Wisconsin': 'WI',\n    'Wyoming': 'WY'\n}","a0233afa":"us_state_df['state_code'] = us_state_df.apply(lambda x: us_state_abbrev.get(x.state,float('nan')), axis=1)\nus_state_df['log(confirmedCases)'] = np.log(us_state_df['cases'] + 1)\nus_state_df['log(deaths)'] = np.log(us_state_df['deaths'] + 1)","5767e686":"px.choropleth(us_state_df[us_state_df.date > dt.datetime(2020, 3, 1)],\n              locationmode='USA-states',\n              scope='usa',\n              locations='state_code',\n              color='log(confirmedCases)',\n              hover_name='state',\n              hover_data=[\"cases\"],\n              animation_frame=str('date2'),\n              color_continuous_scale=px.colors.sequential.Darkmint,\n              title = 'Total Cases growth for USA (Log. Scale)')","d3e5e316":"px.choropleth(us_state_df[us_state_df.date > dt.datetime(2020, 3, 1)],\n              locationmode='USA-states',\n              scope='usa',\n              locations='state_code',\n              color='log(deaths)',\n              hover_name='state',\n              hover_data=[\"deaths\"],\n              animation_frame=str('date2'),\n              color_continuous_scale=px.colors.sequential.OrRd,\n              title = 'Total deaths for USA (Log. Scale)')","aadadb86":"fig = go.Figure()\n\nstates = latest_covid_df.groupby(['state'], as_index=False).sum().sort_values('deaths', ascending=False).head(50).state.values\nfor astate in reversed(states):\n    astate_df = us_state_df[us_state_df['state'] == astate]\n    fig.add_trace(go.Scatter(\n        x=astate_df['date'], y=astate_df['deaths'],\n        mode='lines',\n        #line=dict(width=0.5, color='rgb(184, 247, 212)'),\n        line=dict(width=0.5),\n        stackgroup='one',\n        #groupnorm='percent', # sets the normalization for the sum of the stackgroup,\n        name=astate\n    ))\n\n\nfig.update_layout(\n    title = 'States - Total Confirmed Deaths',\n    showlegend=True,\n    xaxis_type='date',\n    xaxis=dict(\n        range=(us_state_df.date.min(), us_state_df.date.max() + dt.timedelta(days=10))\n    ),\n    yaxis=dict(\n        type='linear',\n        title='Total Confirmed Deaths'\n        #range=[1, 101],\n        #ticksuffix='%'\n    ))\n\nfig.show()","9b8a8750":"state_df = latest_covid_df.groupby('state', as_index=False).sum()\nstate_df['cases_per_capita_100k'] = state_df['cases'] \/ state_df['county_pop_2019_est'] * 100000\nstate_df = state_df.sort_values('cases_per_capita_100k', ascending=False)\n\nfig = go.Figure(data=[go.Bar(\n            x=state_df['state'], y=state_df['cases_per_capita_100k'],\n        )])\nfig.update_layout(title='State - Cases Per 100k People (as of {0})'.format(covid_df.date.max()), width=1000)\npy.offline.iplot(fig)","48355df6":"state_df = state_df.sort_values('cases', ascending=False)\n\nfig = go.Figure(data=[go.Bar(\n            x=state_df['state'], y=state_df['cases'],\n        )])\nfig.update_layout(title='State - Total Cases (as of {0})'.format(covid_df.date.max()), width=1000)\npy.offline.iplot(fig)","80dbc779":"georgia_df = covid_df[covid_df.state == 'Georgia'].sort_values('cases_per_capita_100k', ascending=False)\nfig = px.line(georgia_df, x=\"date\", y=\"cases_per_capita_100k\", color='county')\nfig.update_layout(title='Georgia - Total Cases per 100k people', height=700)\nfig.show()","43504771":"georgia_df = geo_covid_df[geo_covid_df['state'] == 'Georgia']\nfig = px.scatter_mapbox(georgia_df[georgia_df.date > dt.datetime(2020, 3, 14)], \n                        lat=\"county_center_lat\", lon=\"county_center_lon\", \n                        hover_name=\"county\", hover_data=[\"state\", \"county\"], color=\"deaths_per_100k_pop\", \n                        size=\"deaths_per_capita_100k\",size_max=30, zoom=5, height=500,\n                        animation_frame=str('date2'))\nfig.update_layout(mapbox_style=\"open-street-map\")\nfig.update_layout(margin={\"r\":0,\"t\":0,\"l\":0,\"b\":0})\npy.offline.iplot(fig)","133b00b2":"ny_df = geo_covid_df[geo_covid_df['state'] == 'New York']\nfig = px.scatter_mapbox(ny_df[ny_df.date > dt.datetime(2020, 3, 14)], \n                        lat=\"county_center_lat\", lon=\"county_center_lon\", \n                        hover_name=\"county\", hover_data=[\"state\", \"county\"], color=\"deaths_per_100k_pop\", \n                        size=\"deaths_per_capita_100k\",size_max=30, zoom=5, height=500,\n                        animation_frame=str('date2'))\nfig.update_layout(mapbox_style=\"open-street-map\")\nfig.update_layout(margin={\"r\":0,\"t\":0,\"l\":0,\"b\":0})\npy.offline.iplot(fig)","80bdba25":"ny_df = covid_df[covid_df.state == 'New York'].groupby(['date'], as_index=False).sum().sort_values('date')\nrest_us_df = covid_df[covid_df.state != 'New York'].groupby(['date'], as_index=False).sum().sort_values('date')\n\nny_population = state_df[state_df['state'] == 'New York'].county_pop_2019_est.iloc[0]\nrest_us_population = state_df[state_df['state'] != 'New York'].county_pop_2019_est.sum()\n\n#calc percent too\nny_pop_percent = np.round((ny_population \/ (ny_population + rest_us_population)) * 100, 2)\nrest_pop_percent = np.round((rest_us_population \/ (ny_population + rest_us_population)) * 100, 2)","00e57005":"fig = make_subplots(rows=1, cols=2, subplot_titles=['Total Confirmed Deaths', 'Population'])\n\n\nfig.add_trace(go.Scatter(x=ny_df['date'], y=ny_df['deaths'],\n   name='New York', marker_color='blue'\n), row=1, col=1)\n\nfig.add_trace(go.Scatter(x=rest_us_df['date'], y=rest_us_df['deaths'],\n   name='Rest of U.S.', marker_color='crimson'\n), row=1, col=1)\n\n\nfig.update_yaxes(dtick=1000, title='Total Confirmed Deaths', row=1, col=1)\nfig.update_xaxes(range=[dt.date(2020, 3, 1), covid_df.date.max() + dt.timedelta(days=1)], row=1, col=1)\n\n\nfig.add_bar(\n            x=['New York', 'rest of U.S.'], y=[ny_population, rest_us_population], \n            marker_color=['blue','red'],\n            text=[str(ny_pop_percent)+ ' %', str(rest_pop_percent) + ' %'],\n            textposition='auto',\n            row=1, col=2\n        )\n\nfig.update_layout(height=500, showlegend=False)\n\npy.offline.iplot(fig)","10828b17":"plt_titles = ['New York New Cases per Day', 'Rest of U.S. New Cases Per Day']\nfig = make_subplots(rows=1, cols=2, subplot_titles=plt_titles)\nfig.add_bar(x=ny_df['date'], y=ny_df['new_day_cases'], row=1, col=1)\nfig.add_bar(x=rest_us_df['date'], y=rest_us_df['new_day_cases'], row=1, col=2)\n#fig.update_xaxes(range=[dt.date(2020, 2, 1), covid_df.date.max() + dt.timedelta(days=2)])\nfig.update_layout(height=700, showlegend=False)\npy.offline.iplot(fig)","9a9a9383":"# merge in demographic info per county\ndemog_df = pd.read_csv('\/kaggle\/input\/enrichednytimescovid19\/us_county_demographics.csv')\ndemog_df.head(2)","1285aee0":"covid_demo_df = pd.merge(covid_df, demog_df, on=['state_fips', 'county_fips'], how='left')\ncovid_demo_df = covid_demo_df[covid_demo_df.date == covid_demo_df.date.max()]","5766640b":"corr_cols = [\n       'cases_per_capita_100k', 'deaths_per_capita_100k', 'pop_per_sq_mile_2010',\n       'MALE_PERC', 'FEMALE_PERC', 'WHITE_POP_PERC',\n       'BLACK_POP_PERC', 'ASIAN_POP_PERC', 'HISP_POP_PERC', 'AGE_OTO4',\n       'AGE_5TO14', 'AGE_15TO24', 'AGE_25TO34', 'AGE_35TO44', 'AGE_45TO54',\n       'AGE_55TO64', 'AGE_65TO74', 'AGE_75TO84', 'AGE_84PLUS']\ncorr = covid_demo_df[corr_cols].corr()\nplt.figure(figsize=(10,6))\nsns.heatmap(corr)","91c27e35":"merge_df = pd.merge(latest_covid_df, geo_county_df, how='left', on=['fips', 'county', 'state', 'county_pop_2019_est']).dropna()\n#print(merge_df.shape)","0add5168":"merge_df['geom'] =  merge_df['county_geom'].apply(wkt.loads)\nmdf = gpd.GeoDataFrame(merge_df, geometry='geom')\nmdf.crs = \"EPSG:4326\"","f1d73926":"variable = 'cases_per_capita_100k'\n# set the range for the choropleth\nvmin, vmax = 1, 100\n# create figure and axes for Matplotlib\nfig, ax = plt.subplots(1, figsize=(30, 10))\n# create map\nmdf[['geom', variable]].plot(variable, cmap='Reds', linewidth=0.8, ax=ax, edgecolor='0.8')\n\nsm = plt.cm.ScalarMappable(cmap='Reds', norm=plt.Normalize(vmin=vmin, vmax=vmax))\n# empty array for the data range\nsm._A = []\n# add the colorbar to the figure\ncbar = fig.colorbar(sm)","dbce70ee":"mar31_df = covid_df[covid_df.date == '2020-03-31']\n#mar31_df.head(2)","01c95c8d":"merge_df = pd.merge(mar31_df, geo_county_df, how='left', on=['fips', 'county', 'state', 'county_pop_2019_est']).dropna()\nmerge_df['geom'] =  merge_df['county_geom'].apply(wkt.loads)\nmdf = gpd.GeoDataFrame(merge_df, geometry='geom')\nmdf.crs = \"EPSG:4326\"\n#print(mdf.shape)","5cea8c4d":"col = 'cases_per_capita_100k'\n\nmdf2 = mdf[['geom', 'county', col]]\n\nbins = list(mdf2[col].quantile([0, 0.25, 0.5, 0.75, 1]))\n\nm = folium.Map(location=[48, -102], zoom_start=3)\n\nfolium.Choropleth(\n    geo_data=mdf2,\n    name='choropleth',\n    data=mdf2,\n    columns=['county', col],\n    key_on='feature.properties.county',\n    fill_color='Reds',\n    fill_opacity=0.7,\n    line_opacity=0.2,\n    legend_name='March 31st - County new day cases per 100,000 people',\n    bins=bins,\n    reset=True\n).add_to(m)\n\nfolium.LayerControl().add_to(m)\n\nm","212b2bad":"## Extra: Geospatial Viz. w\/ Folium <a id=\"7\"><\/a>","12d0f883":"## Extra: Geospatial Viz. w\/ Geopandas <a id=\"6\"><\/a>","054734b5":"Look at deaths per 100,000 people for counties in new york","b0252c6d":"New Cases Per Day New York vs the Rest of U.S.","5f75edc1":"## Georgia <a id=\"3\"><\/a>","845416b5":"What is the date range of the dataset?","02d922b8":"Look at county density heatmap of new day cases per 100,000 people","804c8656":"look at correlation matrix for different columns","8f39419b":"Want to look at interactive animation of deaths per 100,000 people per county (using plotly and mapbox)","bb88b7f1":"## State EDA <a id=\"2\"><\/a>","4a250701":"## New York compared to the rest of the U.S. <a id=\"4\"><\/a>","2fb70395":"## U.S. EDA <a id=\"1\"><\/a>","d3de4592":"Take a look at the current counties with the highest cases and deaths per capita","8248c4df":"Now lets use folium to create an interactive chloropleth map looking at the end of march","7c9ff395":"Joint Plot of the log of cases per capita 100k and county population density","d3ae8fac":"County total deaths per 100k people in Georgia?","5a21afa8":"Look at total cases per 100k people for counties in Georgia (sorted from current highest to lowest). You can toggle on and off certain counties using the legend.","ee330e6d":"# COVID19 - U.S. Counties Analysis and Visualization (Updated Daily)\n\nThis notebook is to demonstrate how the enriched nytimes covid19 dataset can be used for explatory covid19 analysis, as well as for geospatial analysis and visualization.\n\nPlotly is used for most of the visualizations, and I also show 2 alternative geospatial plotting packages that can be used (Geopandas and Folium).\n\n\n# Table of Content\n\n* [<font size=3>U.S. EDA<\/font>](#1)\n\n* [<font size=3>State EDA<\/font>](#2)\n\n* [<font size=3>Georgia<\/font>](#3)\n\n* [<font size=3>New York vs the Rest<\/font>](#4)\n\n* [<font size=3>Demographics<\/font>](#5)\n\n* [<font size=3>Extra: Geospatial Viz. w\/ Geopandas<\/font>](#6)\n\n* [<font size=3>Extra: Geospatial Viz. w\/ Folium<\/font>](#7)\n\n    \n(Below is a geospatial time-lapse video created in kepler.gl using this dataset)\n![COVID19](https:\/\/github.com\/ringhilterra\/enriched-covid19-data\/blob\/master\/example_viz\/covid-cases-final-04-06.gif?raw=true)","93fb55b9":"## Demographics <a id=\"5\"><\/a>","286a1b58":"Look at total U.S. cases and deaths over time","c2e9cbf2":"Total U.S. New Cases Reported per Day"}}