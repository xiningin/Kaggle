{"cell_type":{"797668aa":"code","4aa055b9":"code","562f3d47":"code","fe26b0f8":"code","cf8bd711":"code","80929abe":"code","ffef53eb":"code","aba5d3e0":"code","db80a926":"code","5ee889f0":"code","dca8274d":"code","943a7ec3":"code","854c1e09":"code","ca1fb2f1":"code","6df2adb8":"code","375822ab":"code","b0249aba":"code","4c7eb1ea":"code","8d1ca704":"code","c47c843c":"code","752837c2":"code","771758e9":"code","91f17013":"code","982f89ed":"code","cf2ec8bc":"code","1549aa90":"code","790a7dc1":"code","eda7e900":"code","33dde475":"code","2d637103":"code","c8bbaf7d":"code","27ab5ef1":"code","2c6a3c61":"code","c0fe0ecc":"code","ec990151":"markdown","2793bf30":"markdown","5905344b":"markdown","8b5d9369":"markdown","35ad1e58":"markdown","8414765a":"markdown","8d1ae985":"markdown","4eb43f2a":"markdown","dbf0dede":"markdown","02cbb96b":"markdown","67671287":"markdown","3e0cbe17":"markdown","5667e6bf":"markdown","77f4c4e9":"markdown","29c4c2c4":"markdown","c0b76314":"markdown","e0ea9b91":"markdown","84123bd4":"markdown","22ac63f1":"markdown","7e6aafaa":"markdown","2b866ae1":"markdown","d6dbf803":"markdown","7119937a":"markdown","3df56bb4":"markdown","e9c8d1a5":"markdown","dc32043e":"markdown","c201b58f":"markdown","0e07c739":"markdown","b12832de":"markdown","10e1e7c8":"markdown"},"source":{"797668aa":"import os\nimport pandas as pd\nimport numpy as np\nimport math\nimport datetime as dt\n\nfrom sklearn.metrics import mean_squared_error, mean_absolute_error, explained_variance_score, r2_score \nfrom sklearn.metrics import mean_poisson_deviance, mean_gamma_deviance, accuracy_score\nfrom sklearn.preprocessing import MinMaxScaler\n\nimport tensorflow as tf\nfrom tensorflow.keras.models import Sequential\nfrom tensorflow.keras.layers import Dense, Dropout\nfrom tensorflow.keras.layers import LSTM, GRU\n\nfrom itertools import cycle\nimport plotly.graph_objects as go\nimport plotly.express as px\nfrom plotly.subplots import make_subplots\n","4aa055b9":"maindf = pd.read_csv('..\/input\/tesla-stock-data-20162021\/TSLA.csv')\nmaindf = maindf.rename(columns={'Date': 'date','Open':'open','High':'high','Low':'low','Close':'close',\n                                'Adj Close':'adj_close','Volume':'volume'})\nmaindf.head()","562f3d47":"print(\"Total number of days: \",maindf.shape[0])\nprint(\"Total number of fields: \",maindf.shape[1])","fe26b0f8":"print(\"Null values:\", maindf.isnull().values.sum())\nprint(\"NA values:\", maindf.isna().values.any())","cf8bd711":"# convert date field from string to Date format \nmaindf['date'] = pd.to_datetime(maindf.date)\nmaindf.head()","80929abe":"print(\"Starting date: \",maindf.iloc[0][0])\nprint(\"Ending date: \", maindf.iloc[-1][0])\nprint(\"Duration: \", maindf.iloc[-1][0]-maindf.iloc[0][0])","ffef53eb":"monthvise= maindf.groupby(maindf['date'].dt.strftime('%B'))[['open','close']].mean()\nnew_order = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', \n             'September', 'October', 'November', 'December']\nmonthvise = monthvise.reindex(new_order, axis=0)\nmonthvise","aba5d3e0":"fig = go.Figure()\n\nfig.add_trace(go.Bar(\n    x=monthvise.index,\n    y=monthvise['open'],\n    name='Stock Open Price',\n    marker_color='crimson'\n))\nfig.add_trace(go.Bar(\n    x=monthvise.index,\n    y=monthvise['close'],\n    name='Stock Close Price',\n    marker_color='lightsalmon'\n))\n\nfig.update_layout(barmode='group', xaxis_tickangle=-45, \n                  title='Monthwise comparision between Stock open and close price')\nfig.show()","db80a926":"maindf.groupby(maindf['date'].dt.strftime('%B'))['low'].min()\nmonthvise_high = maindf.groupby(maindf['date'].dt.strftime('%B'))['high'].max()\nmonthvise_high = monthvise_high.reindex(new_order, axis=0)\n\nmonthvise_low = maindf.groupby(maindf['date'].dt.strftime('%B'))['low'].min()\nmonthvise_low = monthvise_low.reindex(new_order, axis=0)\n\nfig = go.Figure()\nfig.add_trace(go.Bar(\n    x=monthvise_high.index,\n    y=monthvise_high,\n    name='Stock high Price',\n    marker_color='rgb(0, 153, 204)'\n))\nfig.add_trace(go.Bar(\n    x=monthvise_low.index,\n    y=monthvise_low,\n    name='Stock low Price',\n    marker_color='rgb(255, 128, 0)'\n))\n\nfig.update_layout(barmode='group', \n                  title=' Monthwise High and Low stock price')\nfig.show()","5ee889f0":"names = cycle(['Stock Open Price','Stock Close Price','Stock High Price','Stock Low Price'])\n\nfig = px.line(maindf, x=maindf.date, y=[maindf['open'], maindf['close'], \n                                          maindf['high'], maindf['low']],\n             labels={'date': 'Date','value':'Stock value'})\nfig.update_layout(title_text='Stock analysis chart', font_size=15, font_color='black',legend_title_text='Stock Parameters')\nfig.for_each_trace(lambda t:  t.update(name = next(names)))\nfig.update_xaxes(showgrid=False)\nfig.update_yaxes(showgrid=False)\n\nfig.show()","dca8274d":"closedf = maindf[['date','close']]\nprint(\"Shape of close dataframe:\", closedf.shape)","943a7ec3":"fig = px.line(closedf, x=closedf.date, y=closedf.close,labels={'date':'Date','close':'Close Stock'})\nfig.update_traces(marker_line_width=2, opacity=0.8)\nfig.update_layout(title_text='Stock close price chart', plot_bgcolor='white', font_size=15, font_color='black')\nfig.update_xaxes(showgrid=False)\nfig.update_yaxes(showgrid=False)\nfig.show()","854c1e09":"closedf = closedf[closedf['date'] > '2020-08-16']\nclose_stock = closedf.copy()\nprint(\"Total data for prediction: \",closedf.shape[0])","ca1fb2f1":"fig = px.line(closedf, x=closedf.date, y=closedf.close,labels={'date':'Date','close':'Close Stock'})\nfig.update_traces(marker_line_width=2, opacity=0.8, marker_line_color='orange')\nfig.update_layout(title_text='Considered period to predict Stock close price', plot_bgcolor='white', font_size=15, font_color='black')\nfig.update_xaxes(showgrid=False)\nfig.update_yaxes(showgrid=False)\nfig.show()","6df2adb8":"del closedf['date']\nscaler=MinMaxScaler(feature_range=(0,1))\nclosedf=scaler.fit_transform(np.array(closedf).reshape(-1,1))\nprint(closedf.shape)","375822ab":"training_size=int(len(closedf)*0.60)\ntest_size=len(closedf)-training_size\ntrain_data,test_data=closedf[0:training_size,:],closedf[training_size:len(closedf),:1]\nprint(\"train_data: \", train_data.shape)\nprint(\"test_data: \", test_data.shape)","b0249aba":"# convert an array of values into a dataset matrix\ndef create_dataset(dataset, time_step=1):\n    dataX, dataY = [], []\n    for i in range(len(dataset)-time_step-1):\n        a = dataset[i:(i+time_step), 0]   ###i=0, 0,1,2,3-----99   100 \n        dataX.append(a)\n        dataY.append(dataset[i + time_step, 0])\n    return np.array(dataX), np.array(dataY)","4c7eb1ea":"time_step = 15\nX_train, y_train = create_dataset(train_data, time_step)\nX_test, y_test = create_dataset(test_data, time_step)\n\nprint(\"X_train: \", X_train.shape)\nprint(\"y_train: \", y_train.shape)\nprint(\"X_test: \", X_test.shape)\nprint(\"y_test\", y_test.shape)","8d1ca704":"# reshape input to be [samples, time steps, features] which is required for LSTM\nX_train =X_train.reshape(X_train.shape[0],X_train.shape[1] , 1)\nX_test = X_test.reshape(X_test.shape[0],X_test.shape[1] , 1)\n\nprint(\"X_train: \", X_train.shape)\nprint(\"X_test: \", X_test.shape)","c47c843c":"tf.keras.backend.clear_session()\nmodel=Sequential()\nmodel.add(GRU(32,return_sequences=True,input_shape=(time_step,1)))\nmodel.add(GRU(32,return_sequences=True))\nmodel.add(GRU(32))\nmodel.add(Dropout(0.20))\nmodel.add(Dense(1))\nmodel.compile(loss='mean_squared_error',optimizer='adam')","752837c2":"model.summary()","771758e9":"history = model.fit(X_train,y_train,validation_data=(X_test,y_test),epochs=200,batch_size=32,verbose=1)","91f17013":"import matplotlib.pyplot as plt\n\nloss = history.history['loss']\nval_loss = history.history['val_loss']\n\nepochs = range(len(loss))\n\nplt.plot(epochs, loss, 'r', label='Training loss')\nplt.plot(epochs, val_loss, 'b', label='Validation loss')\nplt.title('Training and validation loss')\nplt.legend(loc=0)\nplt.figure()\n\n\nplt.show()","982f89ed":"### Lets Do the prediction and check performance metrics\ntrain_predict=model.predict(X_train)\ntest_predict=model.predict(X_test)\ntrain_predict.shape, test_predict.shape","cf2ec8bc":"# Transform back to original form\n\ntrain_predict = scaler.inverse_transform(train_predict)\ntest_predict = scaler.inverse_transform(test_predict)\noriginal_ytrain = scaler.inverse_transform(y_train.reshape(-1,1)) \noriginal_ytest = scaler.inverse_transform(y_test.reshape(-1,1)) ","1549aa90":"# Evaluation metrices RMSE and MAE\nprint(\"Train data RMSE: \", math.sqrt(mean_squared_error(original_ytrain,train_predict)))\nprint(\"Train data MSE: \", mean_squared_error(original_ytrain,train_predict))\nprint(\"Train data MAE: \", mean_absolute_error(original_ytrain,train_predict))\nprint(\"-------------------------------------------------------------------------------------\")\nprint(\"Test data RMSE: \", math.sqrt(mean_squared_error(original_ytest,test_predict)))\nprint(\"Test data MSE: \", mean_squared_error(original_ytest,test_predict))\nprint(\"Test data MAE: \", mean_absolute_error(original_ytest,test_predict))","790a7dc1":"print(\"Train data explained variance regression score:\", explained_variance_score(original_ytrain, train_predict))\nprint(\"Test data explained variance regression score:\", explained_variance_score(original_ytest, test_predict))","eda7e900":"print(\"Train data R2 score:\", r2_score(original_ytrain, train_predict))\nprint(\"Test data R2 score:\", r2_score(original_ytest, test_predict))","33dde475":"print(\"Train data MGD: \", mean_gamma_deviance(original_ytrain, train_predict))\nprint(\"Test data MGD: \", mean_gamma_deviance(original_ytest, test_predict))\nprint(\"----------------------------------------------------------------------\")\nprint(\"Train data MPD: \", mean_poisson_deviance(original_ytrain, train_predict))\nprint(\"Test data MPD: \", mean_poisson_deviance(original_ytest, test_predict))","2d637103":"# shift train predictions for plotting\n\nlook_back=time_step\ntrainPredictPlot = np.empty_like(closedf)\ntrainPredictPlot[:, :] = np.nan\ntrainPredictPlot[look_back:len(train_predict)+look_back, :] = train_predict\nprint(\"Train predicted data: \", trainPredictPlot.shape)\n\n# shift test predictions for plotting\ntestPredictPlot = np.empty_like(closedf)\ntestPredictPlot[:, :] = np.nan\ntestPredictPlot[len(train_predict)+(look_back*2)+1:len(closedf)-1, :] = test_predict\nprint(\"Test predicted data: \", testPredictPlot.shape)\n\nnames = cycle(['Original close price','Train predicted close price','Test predicted close price'])\n\n\nplotdf = pd.DataFrame({'date': close_stock['date'],\n                       'original_close': close_stock['close'],\n                      'train_predicted_close': trainPredictPlot.reshape(1,-1)[0].tolist(),\n                      'test_predicted_close': testPredictPlot.reshape(1,-1)[0].tolist()})\n\nfig = px.line(plotdf,x=plotdf['date'], y=[plotdf['original_close'],plotdf['train_predicted_close'],\n                                          plotdf['test_predicted_close']],\n              labels={'value':'Stock price','date': 'Date'})\nfig.update_layout(title_text='Comparision between original close price vs predicted close price',\n                  plot_bgcolor='white', font_size=15, font_color='black', legend_title_text='Close Price')\nfig.for_each_trace(lambda t:  t.update(name = next(names)))\n\nfig.update_xaxes(showgrid=False)\nfig.update_yaxes(showgrid=False)\nfig.show()","c8bbaf7d":"x_input=test_data[len(test_data)-time_step:].reshape(1,-1)\ntemp_input=list(x_input)\ntemp_input=temp_input[0].tolist()\n\nfrom numpy import array\n\nlst_output=[]\nn_steps=time_step\ni=0\npred_days = 30\nwhile(i<pred_days):\n    \n    if(len(temp_input)>time_step):\n        \n        x_input=np.array(temp_input[1:])\n        #print(\"{} day input {}\".format(i,x_input))\n        x_input = x_input.reshape(1,-1)\n        x_input = x_input.reshape((1, n_steps, 1))\n        \n        yhat = model.predict(x_input, verbose=0)\n        #print(\"{} day output {}\".format(i,yhat))\n        temp_input.extend(yhat[0].tolist())\n        temp_input=temp_input[1:]\n        #print(temp_input)\n       \n        lst_output.extend(yhat.tolist())\n        i=i+1\n        \n    else:\n        \n        x_input = x_input.reshape((1, n_steps,1))\n        yhat = model.predict(x_input, verbose=0)\n        temp_input.extend(yhat[0].tolist())\n        \n        lst_output.extend(yhat.tolist())\n        i=i+1\n               \nprint(\"Output of predicted next days: \", len(lst_output))","27ab5ef1":"last_days=np.arange(1,time_step+1)\nday_pred=np.arange(time_step+1,time_step+pred_days+1)\nprint(last_days)\nprint(day_pred)","2c6a3c61":"temp_mat = np.empty((len(last_days)+pred_days+1,1))\ntemp_mat[:] = np.nan\ntemp_mat = temp_mat.reshape(1,-1).tolist()[0]\n\nlast_original_days_value = temp_mat\nnext_predicted_days_value = temp_mat\n\nlast_original_days_value[0:time_step+1] = scaler.inverse_transform(closedf[len(closedf)-time_step:]).reshape(1,-1).tolist()[0]\nnext_predicted_days_value[time_step+1:] = scaler.inverse_transform(np.array(lst_output).reshape(-1,1)).reshape(1,-1).tolist()[0]\n\nnew_pred_plot = pd.DataFrame({\n    'last_original_days_value':last_original_days_value,\n    'next_predicted_days_value':next_predicted_days_value\n})\n\nnames = cycle(['Last 15 days close price','Predicted next 30 days close price'])\n\nfig = px.line(new_pred_plot,x=new_pred_plot.index, y=[new_pred_plot['last_original_days_value'],\n                                                      new_pred_plot['next_predicted_days_value']],\n              labels={'value': 'Stock price','index': 'Timestamp'})\nfig.update_layout(title_text='Compare last 15 days vs next 30 days',\n                  plot_bgcolor='white', font_size=15, font_color='black',legend_title_text='Close Price')\n\nfig.for_each_trace(lambda t:  t.update(name = next(names)))\nfig.update_xaxes(showgrid=False)\nfig.update_yaxes(showgrid=False)\nfig.show()","c0fe0ecc":"lstmdf=closedf.tolist()\nlstmdf.extend((np.array(lst_output).reshape(-1,1)).tolist())\nlstmdf=scaler.inverse_transform(lstmdf).reshape(1,-1).tolist()[0]\n\nnames = cycle(['Close price'])\n\nfig = px.line(lstmdf,labels={'value': 'Stock price','index': 'Timestamp'})\nfig.update_layout(title_text='Plotting whole closing stock price with prediction',\n                  plot_bgcolor='white', font_size=15, font_color='black',legend_title_text='Stock')\n\nfig.for_each_trace(lambda t:  t.update(name = next(names)))\n\nfig.update_xaxes(showgrid=False)\nfig.update_yaxes(showgrid=False)\nfig.show()","ec990151":"# Import Dataset","2793bf30":"Look at the below image to get bit of understanding about create dataset for forecasting time-series-analysis\n\n\n![Capture.PNG](attachment:8bd2bfa8-efd4-41c5-9ebc-45159ae91515.PNG)\n","5905344b":"<a name=\"mse\"><\/a>\n\n### Evaluation metrices RMSE, MSE and MAE\n\nRoot Mean Square Error (RMSE), Mean Square Error (MSE) and Mean absolute Error (MAE) are a standard way to measure the error of a model in predicting quantitative data.","8b5d9369":"<a name=\"predate\"><\/a>\n\n# Convert Date field into datetime format","35ad1e58":"<a name=\"norm\"><\/a>\n\n### Normalizing close price","8414765a":"<a name=\"hl\"><\/a>\n\n### Monthwise High and Low stock price ","8d1ae985":"<a name=\"pwhole\"><\/a>\n\n### Plotting entire Closing Stock Price with next 30 days period of prediction ","4eb43f2a":"<a name=\"dur\"><\/a>\n\n### Find the duration of dataset","dbf0dede":"<a name=\"gru\"><\/a>\n\n# Model Building (GRU)\n\n**GRUs (Gated Recurrent Units) are very similar to Long Short Term Memory(LSTM). Just like LSTM, GRU uses gates to control the flow of information. They are relatively new as compared to LSTM. This is the reason they offer some improvement over LSTM and have simpler architecture.**\n\nImage reference: [Here](http:\/\/dprogrammer.org\/rnn-lstm-gru)\n\n![unnamed.png](attachment:a72d6346-c5f0-4f8c-b5fe-8657e85a700c.png)\n\nFollow below reference links tto know more about GRU and LSTM:\n\n- [Comprehensive guide about GRU](https:\/\/www.analyticsvidhya.com\/blog\/2021\/03\/introduction-to-gated-recurrent-unit-gru\/)\n\n- [Comprehensive guide about LSTM](https:\/\/colah.github.io\/posts\/2015-08-Understanding-LSTMs\/)","02cbb96b":"<a name=\"split\"><\/a>\n\n### Prepare Data for train and test","67671287":"<a name=\"trans\"><\/a>\n\n### Transform Close price base on Time-series-analysis forecasting requirement","3e0cbe17":"<a name=\"cp\"><\/a>\n\n# Comparision of original stock close price and predicted close price","5667e6bf":"<a name=\"r2\"><\/a>\n\n### R<sup>2<\/sup> score for regression\n\nR-squared (R2) is a statistical measure that represents the proportion of the variance for a dependent variable that's explained by an independent variable or variables in a regression model.\n\n1 = Best <br>\n0 or < 0 = worse","77f4c4e9":"<a name=\"pdays\"><\/a>\n\n### Plotting last 15 days of dataset and next predicted 30 days","29c4c2c4":"<a name=\"lib\"><\/a>\n\n# Import libraries and packages","c0b76314":"<a name=\"mpd\"><\/a>\n\n### Regression Loss Mean Gamma deviance regression loss (MGD) and Mean Poisson deviance regression loss (MPD)","e0ea9b91":"<a name=\"trend\"><\/a>\n\n### Trend comparision between stock open price, close price, high price, low price","84123bd4":"<a name=\"oc\"><\/a>\n\n### Monthwise comparision between Stock open and close price","22ac63f1":"# Table of contents\n\n- [Introduction](#intro)\n- [Import libraries and dataset](#lib)\n- [Checking Null\/NA values ](#na)\n- [Preprocessing Date and convert into Datatime format](#predate)\n- [Perform Exploratory Data Analysis(EDA)](#eda)\n    - [Find the duration of dataset](#dur)\n    - [Monthwise comparision between Stock open and close price](#oc)\n    - [Monthwise High and Low stock price](#hl)\n    - [Trend comparision between stock open price, close price, high price, low price](#trend)\n- [Preprare Stock Close price](#sc)\n    - [Make separate dataframe](#df)\n    - [Plot stock close price](#pclose)\n- [Consider only 1 year data for prediction](#year)\n    - [Normalizing close price](#norm)\n    - [Split Train and Test ](#split)\n    - [Transform Close price base on Time-series-analysis forecasting requirement](#trans)\n- [Model Building (GRU) ](#gru)\n- [Plotting Loss chart](#loss)\n- [Model Evaluation](#eval)\n    - [Evaluation metrices RMSE, MSE and MAE](#mse)\n    - [Explained variance regression score](#var)\n    - [R<sup>2<\/sup> score for regression](#r2)\n    - [Regression Loss Mean Gamma deviance regression loss (MGD) and Mean Poisson deviance regression loss (MPD)](#mpd)\n- [Comparision of original stock close price and predicted close price](#cp)\n- [Predicting next 30 days (Testing)](#days)\n    - [Plotting last 15 days of dataset and next predicted 30 days](#pdays)\n    - [Plotting entire Closing Stock Price with next 30 days period of prediction ](#pwhole)","7e6aafaa":"<a name=\"na\"><\/a>\n\n# Checking Null and NA value","2b866ae1":"<a name=\"eval\"><\/a>\n\n# Model Evaluation","d6dbf803":"<a name=\"days\"><\/a>\n\n# Predicting next 30 days","7119937a":"<a name=\"year\"><\/a>\n\n# Consider only last 1 year data for prediction","3df56bb4":"<a name=\"loss\"><\/a>\n\n### Plotting loss chart","e9c8d1a5":"<a name=\"intro\"><\/a>\n\n# Introduction\n\nImage reference: [Here](https:\/\/www.educba.com\/time-series-analysis\/)\n\n![Time-Series-Analysis.jpg](attachment:b42e4e0c-6ae5-4779-9349-8cc3b464ec91.jpg)\n\n> **Time series is a sequence or series of data points in which the time component is involved throughout the occurrence and Analyzing this time series data with certain tools and techniques is called time series analysis.**\n\n[Click Here](https:\/\/www.analyticsvidhya.com\/blog\/2021\/06\/time-series-analysis-a-comprehensive-guide\/)  to know more about Time series analysis.\n\nHere, we have a last 5 years Stock Data of the most fastest growing company which is TESLA.\n\nIn this notebook, You will be going to learn following: \n- **EDA Techniques**\n- **Plotting basic charts using Plotly**\n- **Easily learn about Time series analysis using GRU neural network** \n- **Prediction next 30 days** ","dc32043e":"<a name=\"var\"><\/a>\n\n### Explained variance regression score\n\n\nThe explained variance score explains the dispersion of errors of a given dataset, and the formula is written as follows: Here, and Var(y) is the variance of prediction errors and actual values respectively. Scores close to 1.0 are highly desired, indicating better squares of standard deviations of errors.","c201b58f":"<a name=\"sc\"><\/a>\n\n**Here, We are going to predict close price for next 30 days**\n\n# Prepare Stock Close price","0e07c739":"<a name=\"eda\"><\/a>\n\n# EDA - Exploratory Data Analysis","b12832de":"<a name=\"df\"><\/a>\n\n### Make separate dataframe of close price","10e1e7c8":"<a name=\"pclose\"><\/a>\n\n### Plotting Stock Close price chart"}}