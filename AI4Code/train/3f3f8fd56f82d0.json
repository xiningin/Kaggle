{"cell_type":{"568eaf01":"code","43e1d82a":"code","0afdcc47":"code","d8ea82cc":"code","74635e46":"code","bfa0e02e":"code","9d776daf":"code","52469bb3":"code","fe1f2d7e":"code","328888a3":"code","bac75cea":"code","5188baa2":"markdown","be8340f7":"markdown","8b9d0c85":"markdown","d2afdb02":"markdown","29b1d984":"markdown","f6b82f4c":"markdown","9dfb04dd":"markdown","a2b4ef46":"markdown","0fb037d9":"markdown","d3fbda15":"markdown","a0dbf064":"markdown","4058258f":"markdown","02854a2b":"markdown","15f6ada4":"markdown","545fc828":"markdown","571aa72e":"markdown","1c0b5164":"markdown","59bf1d3c":"markdown"},"source":{"568eaf01":"%%HTML\n<div class='tableauPlaceholder' id='viz1639941409691' style='position: relative'><object class='tableauViz'  style='display:none;'><param name='host_url' value='https%3A%2F%2Fpublic.tableau.com%2F' \/> <param name='embed_code_version' value='3' \/> <param name='site_root' value='' \/><param name='name' value='CustomerBaseAnalysis_16399275189440&#47;TableOverview' \/><param name='tabs' value='yes' \/><param name='toolbar' value='yes' \/><param name='animate_transition' value='yes' \/><param name='display_static_image' value='yes' \/><param name='display_spinner' value='yes' \/><param name='display_overlay' value='yes' \/><param name='display_count' value='yes' \/><param name='language' value='en-GB' \/><\/object><\/div>                <script type='text\/javascript'>                    var divElement = document.getElementById('viz1639941409691');                    var vizElement = divElement.getElementsByTagName('object')[0];                    if ( divElement.offsetWidth > 800 ) { vizElement.style.width='800px';vizElement.style.height='850px';} else if ( divElement.offsetWidth > 500 ) { vizElement.style.width='800px';vizElement.style.height='850px';} else { vizElement.style.width='100%';vizElement.style.height='900px';}                     var scriptElement = document.createElement('script');                    scriptElement.src = 'https:\/\/public.tableau.com\/javascripts\/api\/viz_v1.js';                    vizElement.parentNode.insertBefore(scriptElement, vizElement);                <\/script>","43e1d82a":"%%HTML\n<div class='tableauPlaceholder' id='viz1639941441975' style='position: relative'><object class='tableauViz'  style='display:none;'><param name='host_url' value='https%3A%2F%2Fpublic.tableau.com%2F' \/> <param name='embed_code_version' value='3' \/> <param name='site_root' value='' \/><param name='name' value='CustomerBaseAnalysis_16399275189440&#47;CustomerDistribution' \/><param name='tabs' value='yes' \/><param name='toolbar' value='yes' \/><param name='animate_transition' value='yes' \/><param name='display_static_image' value='yes' \/><param name='display_spinner' value='yes' \/><param name='display_overlay' value='yes' \/><param name='display_count' value='yes' \/><param name='language' value='en-GB' \/><\/object><\/div>                <script type='text\/javascript'>                    var divElement = document.getElementById('viz1639941441975');                    var vizElement = divElement.getElementsByTagName('object')[0];                    if ( divElement.offsetWidth > 800 ) { vizElement.style.width='800px';vizElement.style.height='850px';} else if ( divElement.offsetWidth > 500 ) { vizElement.style.width='800px';vizElement.style.height='850px';} else { vizElement.style.width='100%';vizElement.style.height='900px';}                     var scriptElement = document.createElement('script');                    scriptElement.src = 'https:\/\/public.tableau.com\/javascripts\/api\/viz_v1.js';                    vizElement.parentNode.insertBefore(scriptElement, vizElement);                <\/script>","0afdcc47":"%%HTML\n<div class='tableauPlaceholder' id='viz1639941461821' style='position: relative'><object class='tableauViz'  style='display:none;'><param name='host_url' value='https%3A%2F%2Fpublic.tableau.com%2F' \/> <param name='embed_code_version' value='3' \/> <param name='site_root' value='' \/><param name='name' value='CustomerBaseAnalysis_16399275189440&#47;PurchasePower' \/><param name='tabs' value='yes' \/><param name='toolbar' value='yes' \/><param name='animate_transition' value='yes' \/><param name='display_static_image' value='yes' \/><param name='display_spinner' value='yes' \/><param name='display_overlay' value='yes' \/><param name='display_count' value='yes' \/><param name='language' value='en-GB' \/><\/object><\/div>                <script type='text\/javascript'>                    var divElement = document.getElementById('viz1639941461821');                    var vizElement = divElement.getElementsByTagName('object')[0];                    if ( divElement.offsetWidth > 800 ) { vizElement.style.width='800px';vizElement.style.height='850px';} else if ( divElement.offsetWidth > 500 ) { vizElement.style.width='800px';vizElement.style.height='850px';} else { vizElement.style.width='100%';vizElement.style.height='900px';}                     var scriptElement = document.createElement('script');                    scriptElement.src = 'https:\/\/public.tableau.com\/javascripts\/api\/viz_v1.js';                    vizElement.parentNode.insertBefore(scriptElement, vizElement);                <\/script>","d8ea82cc":"%%HTML\n<div class='tableauPlaceholder' id='viz1639941480681' style='position: relative'><object class='tableauViz'  style='display:none;'><param name='host_url' value='https%3A%2F%2Fpublic.tableau.com%2F' \/> <param name='embed_code_version' value='3' \/> <param name='site_root' value='' \/><param name='name' value='CustomerBaseAnalysis_16399275189440&#47;WebConversion' \/><param name='tabs' value='yes' \/><param name='toolbar' value='yes' \/><param name='animate_transition' value='yes' \/><param name='display_static_image' value='yes' \/><param name='display_spinner' value='yes' \/><param name='display_overlay' value='yes' \/><param name='display_count' value='yes' \/><param name='language' value='en-GB' \/><\/object><\/div>                <script type='text\/javascript'>                    var divElement = document.getElementById('viz1639941480681');                    var vizElement = divElement.getElementsByTagName('object')[0];                    if ( divElement.offsetWidth > 800 ) { vizElement.style.width='800px';vizElement.style.height='850px';} else if ( divElement.offsetWidth > 500 ) { vizElement.style.width='800px';vizElement.style.height='850px';} else { vizElement.style.width='100%';vizElement.style.height='900px';}                     var scriptElement = document.createElement('script');                    scriptElement.src = 'https:\/\/public.tableau.com\/javascripts\/api\/viz_v1.js';                    vizElement.parentNode.insertBefore(scriptElement, vizElement);                <\/script>","74635e46":"%%HTML\n<div class='tableauPlaceholder' id='viz1639941507111' style='position: relative'><object class='tableauViz'  style='display:none;'><param name='host_url' value='https%3A%2F%2Fpublic.tableau.com%2F' \/> <param name='embed_code_version' value='3' \/> <param name='site_root' value='' \/><param name='name' value='CustomerBaseAnalysis_16399275189440&#47;ActivityCheck' \/><param name='tabs' value='yes' \/><param name='toolbar' value='yes' \/><param name='animate_transition' value='yes' \/><param name='display_static_image' value='yes' \/><param name='display_spinner' value='yes' \/><param name='display_overlay' value='yes' \/><param name='display_count' value='yes' \/><param name='language' value='en-GB' \/><\/object><\/div>                <script type='text\/javascript'>                    var divElement = document.getElementById('viz1639941507111');                    var vizElement = divElement.getElementsByTagName('object')[0];                    if ( divElement.offsetWidth > 800 ) { vizElement.style.width='800px';vizElement.style.height='850px';} else if ( divElement.offsetWidth > 500 ) { vizElement.style.width='800px';vizElement.style.height='850px';} else { vizElement.style.width='100%';vizElement.style.height='900px';}                     var scriptElement = document.createElement('script');                    scriptElement.src = 'https:\/\/public.tableau.com\/javascripts\/api\/viz_v1.js';                    vizElement.parentNode.insertBefore(scriptElement, vizElement);                <\/script>","bfa0e02e":"%%HTML\n<div class='tableauPlaceholder' id='viz1639941541946' style='position: relative'><object class='tableauViz'  style='display:none;'><param name='host_url' value='https%3A%2F%2Fpublic.tableau.com%2F' \/> <param name='embed_code_version' value='3' \/> <param name='site_root' value='' \/><param name='name' value='CustomerBaseAnalysis_16399275189440&#47;ProductsbyIncome' \/><param name='tabs' value='yes' \/><param name='toolbar' value='yes' \/><param name='animate_transition' value='yes' \/><param name='display_static_image' value='yes' \/><param name='display_spinner' value='yes' \/><param name='display_overlay' value='yes' \/><param name='display_count' value='yes' \/><param name='language' value='en-GB' \/><\/object><\/div>                <script type='text\/javascript'>                    var divElement = document.getElementById('viz1639941541946');                    var vizElement = divElement.getElementsByTagName('object')[0];                    if ( divElement.offsetWidth > 800 ) { vizElement.style.width='800px';vizElement.style.height='850px';} else if ( divElement.offsetWidth > 500 ) { vizElement.style.width='800px';vizElement.style.height='850px';} else { vizElement.style.width='100%';vizElement.style.height='900px';}                     var scriptElement = document.createElement('script');                    scriptElement.src = 'https:\/\/public.tableau.com\/javascripts\/api\/viz_v1.js';                    vizElement.parentNode.insertBefore(scriptElement, vizElement);                <\/script>","9d776daf":"import pandas as pd\n\ndf = pd.read_csv('..\/input\/customer-personality-analysis\/marketing_campaign.csv', sep='\\t', lineterminator='\\r')\ndf.head()","52469bb3":"df = df.dropna()\n\nimport matplotlib.pyplot as plt\nmeatBought=df['MntMeatProducts']\nwineBought=df['MntWines']\nplt.plot(meatBought, wineBought, marker='.', linestyle='none')\nplt.xlabel('meat bought')\nplt.ylabel('wine bought')\nplt.show()","fe1f2d7e":"import numpy as np\nplt.plot(meatBought, wineBought, marker='.', linestyle='none')\nplt.xlabel('meat bought')\nplt.ylabel('wines bought')\n\na, b = np.polyfit(meatBought, wineBought, 1)\n\nprint('slope =', a, 'wine bought \/ meat bought')\nprint('intercept =', b, 'wine bought')\n\nx = np.array([0,1750])\ny = a * x + b\n\nplt.plot(x, y)\n\nplt.show()","328888a3":"def pearson_coef(x, y):\n    pearson_matrix = np.corrcoef(x,y)\n\n    return pearson_matrix[0,1]\n\ncorr = pearson_coef(meatBought, wineBought)\n\nprint(corr)","bac75cea":"permutation_replicates = np.empty(10000)\n\nfor i in range(10000):\n    meat_perm = np.random.permutation(meatBought)\n\n    permutation_replicates[i] = pearson_coef(meat_perm,wineBought)\n\np = np.sum(permutation_replicates >= corr) \/ len(permutation_replicates)\nprint('p-value =', p)","5188baa2":"## Tableau Analysis <a class=\"anchor\"  id=\"chapter2\"><\/a>","be8340f7":"We do the permutation 10000 times and get a p-value of 0.0 as a result. Even performing the permutation 100000 times still gives the same p-value. This means that the p-value is very low, we never had in any of the replicates a Pearson coefficient higher than the one observed in the original dataset. We can therefore reject the null hypothesis with strong statistical significance. There is definitely a relationship between the amount of meat and wine bought by the customer base.","8b9d0c85":"We can now create some charts that will give us valuable insights into the customer base.\n\nFirst we want to take a good look in our customer segments and understand how it is composed.","d2afdb02":"## Python Statistics <a class=\"anchor\"  id=\"chapter3\"><\/a>","29b1d984":"Checking the scatter plot, we can assume that there is a correlation between the amount of meat and wine bought by the customers. We will assume that wine bought is a linear function of the meat bought. So that would be f = ai + b, where\na woule be the slope and\u00a0b\u00a0woule be the intercept. The intercept represents the minimal amount of wine bought, while the slope tells us how the wine bought varies with the amount of meat bought. We can find what is the optimal regression line and add it to the scatter plot.","f6b82f4c":"Next up, we can do some hypothesis testing. The observed correlation between meat and wine bought may just be by chance. We want to test the following null hypothesis:\n\nThe amount of wine bought is totally independent of the amount of meat bought.\n\nTo test this hypothesis we will use the Pearson Correlation Coefficient between the two variables as our test statistic, since they are both numerical and the coefficient can represent the relationship between them. The first step would be to write a function that calculates the Pearson coefficient and calculate it for the original data we have available.","9dfb04dd":"Checking the second chart, as we would expect, higher education levels show higher average household income. Breaking further down to marital status, there seems to be no clear indication that this affects income within a certain education level.\n\nThe first chart shows that, since higher education levels have higher average income, they tend to move towards higher buyer tiers as well. Therefore, the more educated customers tend to buy more products overall in their lifetime. Marital status again does not seem to directly affect purchase volume. On the other hand, if we check the segmentation by year of birth we can see that older-aged customers tend to buy more products and move towards higher buyer tiers.\n\nNext, we will check the web conversion that we calculated using the estimated total web visits from the SQL query. The conversion rate (web purchases\/web visits) is a valuable KPI that can show the performance of the web traffic.","a2b4ef46":"The visualisation shows us the breakdown of the customer base across 2 major aspects: marital status and education. We can see that most of the customers are in a relationship, either married or together with someone, followed by single and divorced customers. Across all marital statuses, graduates and PhD are the 2 prevalent education levels, followed by the masters'. Therefore, the greatest part of the customer base comes from higher education.\n\nIn the tooltip of the above visualisation there is some additional information about the year of birth distribution within each of the segments. Within all major segments the year range of 1971-1985 is the prevalent one, followed by 1956-1970. Most of the customers are therefore middle-aged, between 30s and 50s.\n\nThe next visualisation will give a bit of insight regarding the purchasing power of the customers and how they are segmented into the different buyer tiers.","0fb037d9":"We check the web conversion across the year of birth of the customers, expecting perhaps that younger customers that are more accustomed to the web environment will have higher web conversion rate than the older customers. However, there seems to be a slightly downward trend in the first chart, indicating that web conversion is lower when customer age is younger. It's best to check the two aspects of the web conversion in order to find what drives the lower conversion for the younger customer base. We can then see that web visits (and purchases) volume is increasing for more middle-aged customers, but the visits to purchases increase is not proportional. Therefore, the higher web traffic that comes from younger customers actually leads to lower conversion. This is a common phenomenon, as traffic volume increases but conversion does not always have the same proportional increase due to the natural decrease in traffic value.\n\nAnother piece of valuable information we can extract from the dataset is how active have are more valuable customers been lately. This is the customer segment that generates the most value, so ideally we want to keep them engaged and spending regularly.","d3fbda15":"We want to clean up the NaN values from the dataset. Then it is always a good idea to do some EDA for our variables ahead of our analysis. To this end, we plot the meat products versus wine bought.","a0dbf064":"The above charts shows the distribution of weeks since last purchase within each of the buyer tiers. Even though there does not seem to be any significant difference in the distribution across the 5 tiers, we want to focus on the top 2 buyer tiers. There, we see that ~72% of tier 4 and ~78% of tier 5 customers have not been active in the last 4 weeks. This would not be a good sign, these are the customer segments that we would ideally focus on and re-engage with in order to get some quick wins from our customer base.\n\nFinally, we have chart regarding the average number of products bought per purchase. We can view this in correlation with the average income of our customers.","4058258f":"As most of us know, a glass of good wine paired with some nicely cooked meat can be an excellent combination! The Python analysis that follows will test if the customers of the dataset agree with this notion. We will therefore try to understand the correlation between the amount of meat products bought and the amount of wine bought.\n\nFirst, we import the dataset using pandas:","02854a2b":"## SQL Query <a class=\"anchor\"  id=\"chapter1\"><\/a>","15f6ada4":"The scatter plot indicates what we would normally expect, that customers with a higher average income tend to buy more products with each purchase than lower-income customers. Adding the start date (first registration date) of the customer as an additional dimension, there is no clear indication that this affects purchasing behaviour in any way. We could perhaps see that in the two higher segments of the chart (>50 and >90 products per purchase) we have more light-colored dots than darker ones. That would mean that customers that joined earlier, more loyal, tend to buy more products with each purchase than the ones that registered during the last year. But it is not 100% clear from this chart whether this is the case.","545fc828":"After importing the data in Tableau, the dataset that we created looks as below:","571aa72e":"The function returns a coefficient of ~0.57, indicating a relatively strong positive relationship between the two variables.\n\nFor the actual hypothesis testing, we will permute the meat bought values but leave the wine bought values fixed. This simulates the hypothesis that they are totally independent of each other. For each repetition, we will calculate the Pearson coefficient and finally calculate the p-value that will indicate whether our hypothesis is correct or not.","1c0b5164":"# Customer Analytics Dataset\n* [SQL Query](#chapter1)\n* [Tableau Analysis](#chapter2)\n* [Python Statistics](#chapter3)\n\nThe customer analytics dataset offers the opportunity to do some data pre-processing using SQL, create data visualisations with Tableau and perform statistics testing with Python. These can all be found in this notebook. The goal is to demonstrate some SQL\/Python coding and Tableau visualisation skills, along with some analytical skills regarding insights that can be found in the dataset. To do this some assumptions have to be made, as mentioned later, but they are made in order to be able to extend the analysis and add some complexity to the process.","59bf1d3c":"The dataset is clean to start with, so there is not much to do in terms of data cleaning and pre-processing.\n\nExamining the dataset for the first time to check for abnormal data values, we can see that there are some customer birth years registered that are way before 1940:\n```\nSELECT \n  year_birth\n  , COUNT(DISTINCT ID) AS customers\nFROM `spil-bi.test_spyros.customerAnalysisTest`\nGROUP BY 1\nORDER BY 1\n```\nThese values seem to be suspicious. Keeping only customers with year_birth from 1940 onwards seems be more logical, so we will exclude any other data later in the code.\n\nThere are a couple of calculations that we can do in order to add some complexity and value to our dataset.\n\nThe first thing to do is create a new customer segment, one based on the value of the customer itself. We can therefore calculate the lifetime value of a customer as the total products they buy throughout their lifetime and use this new value to create buyer tiers, i.e. segments that represent the value of the customer. We have to make an assumption here, as normally not all products have the same value (e.g. gold products have much higher value than the rest). However, since we lack revenue in our data, we make the assumption that all products have similar value in order to be able to use lifetime purchases as a segmentation parameter.\n\nThe second calculation is about converting the NumWebVisitsMonth of each customer to an estimate of the total number of web visits they performed in their lifetime. To do this, we assume that the last dt_customer available in the dataset is the last day of data we have available (i.e. the end date of the dataset, as if it were today). We can then calculate how many days of lifetime each customer has available and by converting this to a decimal representation of months, calculate an estimated total amount of web visits for each customer. The end goal is to be able to compare this to their web purchases which would give us web conversion rate, a valuable KPI.\n\nThe above calculations are done in the below part of SQL:\n```\nWITH lifetimeAmount AS (\n  SELECT\n    ID\n    , dt_customer as startDate\n    , SUM(mntWines + mntFruits + mntMeatProducts + mntFishProducts + mntSweetProducts + mntGoldProds) as totalAmount\n    , SUM(numWebVisitsMonth) as webVisitsMonthly\n  FROM `marketing_campaign.csv`\n  WHERE year_birth >= 1940\n  GROUP BY 1,2\n  )\n  \n, tiers as (\n  SELECT \n    ID\n    , CASE\n        WHEN totalAmount >= 0 and totalAmount < 100 then 'Tier 1'\n        WHEN totalAmount >= 100 and totalAmount < 750 then 'Tier 2'\n        WHEN totalAmount >= 750 and totalAmount < 1500 then 'Tier 3'\n        WHEN totalAmount >= 1500 and totalAmount < 2000 then 'Tier 4'\n        WHEN totalAmount >= 2000 then 'Tier 5'\n      END AS buyerTier\n    , round((date_diff(max(startDate) over (), startDate, day)\/30) * webVisitsMonthly) as estimatedWebVisitsTotal\n  FROM lifetimeAmount\n  )  \n```\nFor the last part of the SQL query, we join the new information back to the original dataset and do some aggregations. The dataset is already pretty small, so an aggregation was not really necessary. However, when working with TB of data and due to limitations, it is not possible to import the raw data as a whole in Tableau. Therefore, it is always best to aggregate the data as much as possible before starting with visualisation analysis.\n\nThe final SQL query that will give us the data to import in Tableau is the following:\n```\nWITH lifetimeAmount AS (\n  SELECT\n    ID\n    , dt_customer as startDate\n    , SUM(mntWines + mntFruits + mntMeatProducts + mntFishProducts + mntSweetProducts + mntGoldProds) as totalAmount\n    , SUM(numWebVisitsMonth) as webVisitsMonthly\n  FROM `marketing_campaign.csv`\n  WHERE year_birth >= 1940\n  GROUP BY 1,2\n  )\n  \n, tiers as (\n  SELECT \n    ID\n    , CASE\n        WHEN totalAmount >= 0 and totalAmount < 100 then 'Tier 1'\n        WHEN totalAmount >= 100 and totalAmount < 750 then 'Tier 2'\n        WHEN totalAmount >= 750 and totalAmount < 1500 then 'Tier 3'\n        WHEN totalAmount >= 1500 and totalAmount < 2000 then 'Tier 4'\n        WHEN totalAmount >= 2000 then 'Tier 5'\n      END AS buyerTier\n    , round((date_diff(max(startDate) over (), startDate, day)\/30) * webVisitsMonthly) as estimatedWebVisitsTotal\n  FROM lifetimeAmount\n  )  \n\nSELECT\n  d.year_birth\n  , d.dt_customer as startDate\n  , d.education\n  , d.marital_status\n  , t.buyerTier\n  , CASE\n      WHEN d.recency BETWEEN 0 AND 7 THEN '0-1 weeks ago'\n      WHEN d.recency BETWEEN 8 AND 28 THEN '2-4 weeks ago'\n      WHEN d.recency BETWEEN 29 AND 64 THEN '5-8 weeks ago'\n      WHEN d.recency BETWEEN 65 AND 84 THEN '9-12 weeks ago'\n      WHEN d.recency >= 85 THEN '12+ weeks ago'\n    END AS weeksSinceLastPurchase\n  , AVG(d.income) as avgIncome\n  , SUM(d.kidhome + d.teenhome) as numberOfChildren\n  , SUM(d.mntWines) as wineAmount\n  , SUM(d.mntFruits) as fruitAmount\n  , SUM(d.mntMeatProducts) as meatAmount\n  , SUM(d.mntFishProducts) as fishAmount\n  , SUM(d.mntSweetProducts) as sweetAmount\n  , SUM(d.mntGoldProds) as goldAmount\n  , SUM(d.numDealsPurchases) as dealsPurchases\n  , SUM(d.numWebPurchases) as webPurchases\n  , SUM(d.numCatalogPurchases) as catalogPurchases\n  , SUM(d.numStorePurchases) as storePurchases\n  , SUM(t.estimatedWebVisitsTotal) as estimatedWebVisitsTotal\n  , COUNT(DISTINCT d.ID) as customers\nFROM `marketing_campaign.csv` d\nJOIN tiers t USING (ID)\nGROUP BY 1,2,3,4,5,6\n```"}}