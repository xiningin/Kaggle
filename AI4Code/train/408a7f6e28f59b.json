{"cell_type":{"92821aa5":"code","bb6efe02":"code","a9831206":"code","bd6f4a8f":"code","61d3ba6f":"code","5b3a79a7":"code","12590386":"code","9141f417":"code","b3e04921":"code","036c9a18":"code","dac15803":"code","b1b5a739":"code","393224dd":"code","624ffd73":"code","205e93e3":"code","dfd3b3fe":"code","4c53d7fc":"code","cfb7b15b":"code","755ddcd2":"code","5aca9a47":"code","3cdd9dec":"code","563844d2":"code","28fa9c5f":"code","b7231cd5":"code","4d4d84b1":"code","633b480e":"code","51fa34b8":"code","f82298b1":"code","1f58f025":"code","f473784e":"code","c3341f14":"code","6937af47":"code","10c7849b":"code","57ec9a0c":"code","fb5c11d8":"code","a3262413":"code","40ddea72":"code","9f798d51":"code","4dcc6e18":"code","50d4d153":"code","dcacb853":"code","9fa8c248":"code","ddc01d5b":"code","6d9e4aef":"code","a5af296b":"code","77df5af5":"code","aa65e55e":"code","a1ec42ae":"code","9f71ccf0":"code","190ef32d":"code","5bf942ad":"code","473fabea":"code","471bc347":"code","b7fd6188":"code","32fa730b":"code","8077c04b":"code","fb413510":"code","39cfd69d":"markdown"},"source":{"92821aa5":"import pickle\nimport seaborn as sns\nimport matplotlib.pyplot as plt\n%matplotlib inline\nimport pandas as pd\nimport numpy as np\nfrom scipy.stats import boxcox\nfrom sklearn.utils import shuffle","bb6efe02":"from sklearn.compose import ColumnTransformer\nfrom sklearn.preprocessing import OneHotEncoder\nfrom sklearn.pipeline import Pipeline\nfrom sklearn.preprocessing import StandardScaler\nfrom sklearn.ensemble import RandomForestRegressor\nfrom xgboost import XGBRegressor\nfrom sklearn.metrics import r2_score,mean_absolute_error","a9831206":"import xgboost","bd6f4a8f":"xgboost.__version__","61d3ba6f":"data = pd.read_csv('..\/input\/t20-international-cleaned-and-processed-data\/T20 International Dataset.csv')","5b3a79a7":"data=(data).drop(['Unnamed: 0'],axis=1).reset_index(drop=True)","12590386":"data.head()","9141f417":"data.info()","b3e04921":"data.isnull().sum()","036c9a18":"data.describe().T","dac15803":"#x,parameters=boxcox(data.CurrentRunRate)","b1b5a739":"#sns.distplot(x,kde=True)","393224dd":"#data = pd.get_dummies(data, columns=['battingTeam','bowlingTeam','city'], drop_first=True)","624ffd73":"#data","205e93e3":"X = data.drop(columns=['Final_Score'])\ny = data['Final_Score']\nfrom sklearn.model_selection import train_test_split\nX_train,X_test,y_train,y_test = train_test_split(X,y,test_size=0.3,random_state=43)","dfd3b3fe":"num_features = ['powerPlay', 'AverageScore','delivery_left', 'score', 'CurrentRunRate', 'wicketsLeft','Run_In_Last5', 'Wickets_In_Last5', 'innings']","4c53d7fc":"cat_features = ['battingTeam','bowlingTeam','city']","cfb7b15b":"\"\"\"preprocessor = ColumnTransformer([(\"numerical\", \"passthrough\", num_features), \n                                  (\"categorical\", OneHotEncoder(sparse=False, handle_unknown=\"ignore\"),\n                                   cat_features)])\"\"\"","755ddcd2":"trf = ColumnTransformer([\n    ('trf',OneHotEncoder(sparse=False),['battingTeam','bowlingTeam','city'])\n]\n,remainder='passthrough')","5aca9a47":"\"\"\"trf = ColumnTransformer([\n    ('trf',OneHotEncoder(sparse=False,drop='first'),['battingTeam','bowlingTeam','city'])\n]\n,remainder='passthrough')\"\"\"","3cdd9dec":"pipe = Pipeline(steps=[\n    ('step1',trf),\n    #('step2',StandardScaler()),\n    ('step3',XGBRegressor(       \n    reg_alpha=1, \n        n_estimators=700, \n        min_child_weight=1,\n        max_depth=12, \n        #learning_rate=0.15, \n        booster=\"gbtree\", \n        base_score=1)  \n    )\n])","563844d2":"#reg_alpha=1, n_estimators=1300, min_child_weight=1, max_depth=15, learning_rate=0.1, booster=gbtree, base_score=0.25, score=(train=-0.087, test=-1.450), total=210.0min","28fa9c5f":"\"\"\"reg_alpha=1, n_estimators=700, min_child_weight=1, max_depth=13, learning_rate=0.15, booster=gbtree, base_score=1, score=(train=-0.263, test=-1.607)\"\"\"","b7231cd5":"pipe.fit(X_train,y_train)\ny_pred = pipe.predict(X_test)","4d4d84b1":"#OHE=OneHotEncoder(sparse=False,drop='first')\n#OHE.fit_transform(X_train[['battingTeam','bowlingTeam','city']])","633b480e":"\"\"\"import xgboost as xgb\nfrom sklearn.model_selection import GridSearchCV\nfrom sklearn.model_selection import RandomizedSearchCV\n\nregressor=xgb.XGBRegressor()\n## Hyper Parameter Optimization\nbooster=['gbtree']\nbase_score=[0.25,0.5,0.75,1]\nn_estimators = [400, 700, 1000, 1300]\nmax_depth = [7,11,15]\nlearning_rate=[0.1,0.15,0.20]\nmin_child_weight=[1,2,3,4]\nreg_alpha=[1]\n\n# Define the grid of hyperparameters to search\nhyperparameter_grid = {\n    'n_estimators': n_estimators,\n    'max_depth':max_depth,\n    'learning_rate':learning_rate,\n    'min_child_weight':min_child_weight,\n    'booster':booster,\n    'base_score':base_score,\n    'reg_alpha': reg_alpha\n    }\"\"\"","51fa34b8":"\"\"\"# Set up the random search with 5-fold cross validation\nrandom_cv = RandomizedSearchCV(estimator=regressor,\n            param_distributions=hyperparameter_grid,\n            cv=5, n_iter=25,\n            scoring = 'neg_mean_absolute_error',n_jobs = -1,\n            verbose = 10, \n            return_train_score = True,\n            random_state=43)\n\nrandom_cv.fit(X,y)\"\"\"","f82298b1":"print(r2_score(y_test,y_pred))\nprint(mean_absolute_error(y_test,y_pred))","1f58f025":"print(r2_score(y_test,y_pred))\nprint(mean_absolute_error(y_test,y_pred))","f473784e":"i=X_train.columns.to_list()\nli=[0,141.2,'Afghanistan','Pakistan','Dubai',60,65,6.5,5,26,2,1]\ninp=pd.DataFrame([li],columns=i)\ninp.head()","c3341f14":"t=pipe.predict(inp)","6937af47":"t[0]","10c7849b":"pickle.dump(pipe,open('model.pkl','wb'))","57ec9a0c":"#pipe['step2'].transform(pipe['step1'].transform(X_test))","fb5c11d8":"preprocessor = pipe.named_steps[\"step1\"]\nohe_categories = preprocessor.named_transformers_[\"trf\"].categories_\nnew_ohe_features = [f\"{col}__{val}\" for col, vals in zip(cat_features, ohe_categories) for val in vals]","a3262413":"all_features =  new_ohe_features + num_features ","40ddea72":"preprocessor","9f798d51":"print(len(new_ohe_features),len(num_features),len(new_ohe_features)+len(num_features))","4dcc6e18":"len(all_features)","50d4d153":"import shap\n\n#load JS vis in the notebook\nshap.initjs() \n","dcacb853":"#set the tree explainer as the model of the pipeline\nexplainer = shap.TreeExplainer(pipe['step3'])","9fa8c248":"#apply the preprocessing to x_test\n#observations1 = pipe['step1'].transform(X_test)\nobservations1 = pipe['step1'].transform(X_test.sample(1000, random_state=42))\n\n#observations = pipe['step2'].transform(observations1)\n","ddc01d5b":"############################### checking without scaling\n\nobservations = observations1","6d9e4aef":"print(observations.shape,len(all_features))","a5af296b":"\nshap_values = explainer.shap_values(observations)","77df5af5":"#pickle.dump(shap_values,open('shap_testData.pkl','wb'))","aa65e55e":"all_features[128]","a1ec42ae":"shap.summary_plot(shap_values, observations, show=False, max_display=len(all_features))","9f71ccf0":"X[X[\"city\"]=='Thiruvananthapuram']","190ef32d":"shap.summary_plot(shap_values, features=observations, feature_names=all_features,max_display=len(all_features))\n","5bf942ad":"#plot the feature importance\nshap.summary_plot(shap_values, features=observations, feature_names=all_features,max_display=len(all_features), plot_type=\"bar\")","473fabea":"shap.dependence_plot(\"score\", shap_values, \n                     pd.DataFrame(observations, columns=all_features))","471bc347":"i = 0\nshap.force_plot(explainer.expected_value, shap_values[i], \n                features=observations[i], feature_names=all_features)","b7fd6188":"shap.force_plot(explainer.expected_value, shap_values,\n                features=observations, feature_names=all_features)","32fa730b":"################","8077c04b":"pd.DataFrame(pipe[\"step1\"].transform(X_train), columns=all_features).head()","fb413510":"import eli5\neli5.show_weights(pipe[\"step3\"], feature_names=all_features)\n","39cfd69d":"### 1. Read Dataset"}}