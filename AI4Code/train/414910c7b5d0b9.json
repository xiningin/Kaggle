{"cell_type":{"edfa60a2":"code","dc477830":"code","27296a0c":"code","80c6204c":"code","2f60e6f0":"code","bfc80fee":"code","6ba58d7e":"code","08b12464":"code","ef628ee0":"code","e3b4e5a0":"code","839e4a1b":"code","a9e340c9":"code","9a471390":"code","168ea708":"code","d5eac798":"code","09e02c5e":"code","0e26bfac":"code","4302dbc1":"code","61219ed8":"code","b14ffaaf":"code","b857fbba":"code","b1c99058":"code","97aec234":"code","876133ea":"code","8ffbcd38":"code","fa617da4":"code","98399850":"code","3e257b1f":"code","a2a559c0":"code","0146ef74":"code","c20dc1eb":"code","ea86e159":"code","fae32ec6":"code","8a02a0c5":"code","4216d7cf":"code","2f8450d9":"code","4f5ae8a4":"code","489301b4":"code","e916fea8":"code","27d6a0f2":"code","0813fe55":"markdown","dd23be5b":"markdown","6d997bcd":"markdown","80472c61":"markdown","495a049d":"markdown","ffe8273a":"markdown","b6f873df":"markdown"},"source":{"edfa60a2":"%reload_ext autoreload\n%autoreload 2\n%matplotlib inline","dc477830":"import numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\nfrom fastai.vision import *\nfrom fastai.metrics import error_rate","27296a0c":"path = Path('\/kaggle\/input\/histopathologic-cancer-detection\/')\npath.ls()","80c6204c":"path_img_train= path\/'train'","2f60e6f0":"path_img_test=path\/'test'","bfc80fee":"path_label=path\/'train_labels.csv'","6ba58d7e":"df_label=pd.read_csv(path_label)","08b12464":"df_label.head()","ef628ee0":"tfms = get_transforms(do_flip=True, flip_vert=True, max_rotate=.0, max_zoom=.1,\n                      max_lighting=0.05, max_warp=0.)","e3b4e5a0":"doc(get_transforms)","839e4a1b":"data = ImageDataBunch.from_csv(path,folder='train',csv_labels=path_label,ds_tfms=tfms, size=90, suffix='.tif',test=path_img_test,bs=64);\nstats=data.batch_stats()        \ndata.normalize(stats)","a9e340c9":"data.show_batch(rows=5, figsize=(12,9))","9a471390":"print(data.classes)\nlen(data.classes),data.c","168ea708":"data","d5eac798":"learn = cnn_learner(data, models.resnet34, metrics=error_rate)","09e02c5e":"learn","0e26bfac":"learn.fit_one_cycle(1)","4302dbc1":"interp = ClassificationInterpretation.from_learner(learn)","61219ed8":"interp.plot_top_losses(9, figsize=(15,11))","b14ffaaf":"interp.plot_confusion_matrix(figsize=(12,12),dpi=60)","b857fbba":"interp.most_confused(min_val=2)","b1c99058":"learn.model_dir=Path('\/kaggle\/working')\nlearn.lr_find()","97aec234":"learn.recorder.plot()","876133ea":"learn.save('stage1')","8ffbcd38":"learn.unfreeze()","fa617da4":"learn.fit_one_cycle(1)","98399850":"learn.lr_find()","3e257b1f":"learn.recorder.plot()","a2a559c0":"learn.load('stage1')","0146ef74":"learn.recorder.plot()","c20dc1eb":"learn.unfreeze()\nlearn.fit_one_cycle(2, max_lr=slice(1e-6,1e-4))","ea86e159":"preds,y=learn.get_preds()","fae32ec6":"from sklearn.metrics import roc_auc_score","8a02a0c5":"def auc_score(y_pred,y_true,tens=True):\n    score=roc_auc_score(y_true,torch.sigmoid(y_pred)[:,1])\n    if tens:\n        score=tensor(score)\n    else:\n        score=score\n    return score","4216d7cf":"pred_score=auc_score(preds,y)\npred_score","2f8450d9":"preds,y=learn.TTA()\npred_score_tta=auc_score(preds,y)\npred_score_tta","4f5ae8a4":"preds_test,y_test=learn.get_preds(ds_type=DatasetType.Test)","489301b4":"sub=pd.read_csv(f'{path}\/sample_submission.csv').set_index('id')\nsub.head()","e916fea8":"clean_fname=np.vectorize(lambda fname: str(fname).split('\/')[-1].split('.')[0])\nfname_cleaned=clean_fname(data.test_ds.items)\nfname_cleaned=fname_cleaned.astype(str)","27d6a0f2":"sub.loc[fname_cleaned,'label']=to_np(preds_test[:,1])\nsub.to_csv(f'submission_{pred_score}.csv')","0813fe55":"this bring back the model we save earlier NOT weights!","dd23be5b":"**how to show document in fastai!**","6d997bcd":"learn unfreeze says please train the whole model! NOT just some specific layer in the MODEL?","80472c61":"Please train the whole model ..unfreeze!","495a049d":"i don't get this, why the plot looks the same even after i load the old model? WHY? whatever","ffe8273a":"so after unfreeze it should be worst the result, because now we are training from scratch or training the whole network instead of just the last layer. Remember we are trying to use the transfer learning concept here. The network that are being trained for say eye, is kind of the same as the network trained for cat. So, we don't have to reinvent to wheel.","b6f873df":"OK let's do the prediction"}}