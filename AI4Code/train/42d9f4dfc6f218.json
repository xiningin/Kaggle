{"cell_type":{"7d6ceb01":"code","4e0015c0":"code","99a4d31e":"code","9a4c4b3f":"code","365a7bad":"code","dc633014":"code","6293975b":"code","00eb2608":"code","63147c48":"code","874d8eb0":"markdown"},"source":{"7d6ceb01":"import numpy as np\nimport pandas as pd\nfrom tqdm import tqdm\nfrom scipy import spatial","4e0015c0":"df = pd.read_csv('..\/input\/train.csv')\ndf.head(10)","99a4d31e":"df_structures = pd.read_csv('..\/input\/structures.csv')\ndf_structures.head(10)","9a4c4b3f":"indices = None\ndistances = None\nfor c in tqdm(df_structures.molecule_name.unique()[:5]):\n    x = df_structures[df_structures.molecule_name==c][['x','y','z']]\n    z = spatial.KDTree(x,x.shape[0])\n    permol = z.query(x,x.shape[0])\n    if(indices is None):\n        distances = permol[0].tolist()\n        indices = permol[1].tolist()\n    else:\n        distances += permol[0].tolist()\n        indices += permol[1].tolist()\nnearestneighbors = pd.DataFrame(indices)\ndistanceneighbors = pd.DataFrame(distances)","365a7bad":"nearestneighbors.head(10)","dc633014":"distanceneighbors.head(10)","6293975b":"distances = {}\natoms = {}\n\ni = 0\nfor k,groupdf in tqdm(df_structures.groupby('molecule_name')):\n    \n    x = groupdf[['atom']]\n    z = spatial.KDTree(groupdf[['x','y','z']],x.shape[0])\n    permol = z.query(groupdf[['x','y','z']],x.shape[0])\n    d = np.take_along_axis(permol[0],np.argsort(permol[1]),axis=1)\n    o1 = np.arange(d.shape[1]).reshape(1,-1)\n    o2 = np.repeat(o1,o1.shape[1],axis=0)[np.triu_indices(o1.shape[1], k = 1)]\n    o3 = np.repeat(o1,o1.shape[1],axis=0).T[np.triu_indices(o1.shape[1], k = 1)]\n    indices = np.array([str(i2) +'_'+str(i1) for i1,i2 in zip(o2,o3)]).tolist()\n    d = d[np.triu_indices(d.shape[0], k = 1)].tolist()\n    distances[k] =  dict(zip(indices, d))\n    a = x.atom.values.reshape(1,-1)\n    b = np.repeat(a,a.shape[1],axis=0)[np.triu_indices(a.shape[1], k = 1)]\n    c = np.repeat(a,a.shape[1],axis=0).T[np.triu_indices(a.shape[1], k = 1)]\n    atoms[k] = dict(zip(indices, (b+c).tolist()))\n  \n    \n    if(i==10):\n        break\n    i+=1\ndistanceneighbors = pd.DataFrame.from_dict(distances,orient='index')\natomneighbors = pd.DataFrame.from_dict(atoms,orient='index')","00eb2608":"distanceneighbors.head(10)","63147c48":"\natomneighbors.head(10)","874d8eb0":"Or if you want to preserve the index structure (Note speed this up by label encoding the atoms!)"}}