{"cell_type":{"f92fe17b":"code","6aa849ca":"code","d462e296":"code","67a84084":"code","2317c231":"code","c43c83b4":"code","a66fbaad":"code","6354f042":"code","3a375e87":"code","56651928":"code","f8062d6c":"code","19798dbc":"code","8fd0b526":"code","acf2aed1":"code","c0a2de7c":"code","9a23f6a9":"code","5a84af1d":"code","fd05a178":"code","ec1aae84":"code","5dc88f2b":"code","784cd88d":"code","0d198ba2":"code","a014a301":"code","4a27b360":"code","183214da":"code","1b4c57ad":"code","25e31e8d":"code","8a5bb6b5":"code","bd30dbe1":"code","2294aa96":"code","decfb197":"code","05dc3dbe":"code","f940e549":"code","c2aefb38":"code","3a32f6ca":"code","38c664c8":"markdown","f209c89a":"markdown","c12a30bd":"markdown","cc16f12e":"markdown","b2398b9d":"markdown","10064f5f":"markdown","bc274175":"markdown","af1684fd":"markdown","e9632ffc":"markdown","12b2c3a9":"markdown","00bfbfc0":"markdown","4d058292":"markdown","a03b6ba6":"markdown","97f42731":"markdown","bd59724a":"markdown","5aa473ce":"markdown","51ff4d59":"markdown","811baef2":"markdown","18ef75e6":"markdown","8413742a":"markdown","a4c92ccd":"markdown","fee95161":"markdown","08ee67a6":"markdown","2f54e201":"markdown","917e4d98":"markdown","eb8c6923":"markdown","211244e4":"markdown","12b2e533":"markdown","491661fb":"markdown","db515371":"markdown"},"source":{"f92fe17b":"import numpy as np\nimport pandas as pd \nfrom keras.preprocessing.image import ImageDataGenerator, load_img\nfrom keras.utils import to_categorical\nfrom sklearn.model_selection import train_test_split\nimport matplotlib.pyplot as plt\nimport random\nimport os\nprint(os.listdir(\"..\/input\"))\n","6aa849ca":"import zipfile\n\ndef unzip_file(path_to_zip_file, directory_to_extract_to):\n    with zipfile.ZipFile(path_to_zip_file, 'r') as zip_ref:\n        zip_ref.extractall(directory_to_extract_to)\n        \nunzip_file(\"..\/input\/train.zip\", \".\/train\")\nunzip_file(\"..\/input\/test1.zip\", \".\/test\")","d462e296":"FAST_RUN = False\nIMAGE_WIDTH=128\nIMAGE_HEIGHT=128\nIMAGE_SIZE=(IMAGE_WIDTH, IMAGE_HEIGHT)\nIMAGE_CHANNELS=3","67a84084":"filenames = os.listdir(\".\/train\/train\")\ncategories = []\nfor filename in filenames:\n    category = filename.split('.')[0]\n    if category == 'dog':\n        categories.append(1)\n    else:\n        categories.append(0)\n\ndf = pd.DataFrame({\n    'filename': filenames,\n    'category': categories\n})","2317c231":"df.head()","c43c83b4":"df.tail()","a66fbaad":"df['category'].value_counts().plot.bar()","6354f042":"sample = random.choice(filenames)\nimage = load_img(\".\/train\/train\/\"+sample)\nplt.imshow(image)","3a375e87":"from keras.models import Sequential\nfrom keras.layers import Conv2D, MaxPooling2D, Dropout, Flatten, Dense, Activation, BatchNormalization\n\nmodel = Sequential()\n\nmodel.add(Conv2D(32, (3, 3), activation='relu', input_shape=(IMAGE_WIDTH, IMAGE_HEIGHT, IMAGE_CHANNELS)))\nmodel.add(BatchNormalization())\nmodel.add(MaxPooling2D(pool_size=(2, 2)))\nmodel.add(Dropout(0.25))\n\nmodel.add(Conv2D(64, (3, 3), activation='relu'))\nmodel.add(BatchNormalization())\nmodel.add(MaxPooling2D(pool_size=(2, 2)))\nmodel.add(Dropout(0.25))\n\nmodel.add(Conv2D(128, (3, 3), activation='relu'))\nmodel.add(BatchNormalization())\nmodel.add(MaxPooling2D(pool_size=(2, 2)))\nmodel.add(Dropout(0.25))\n\nmodel.add(Flatten())\nmodel.add(Dense(512, activation='relu'))\nmodel.add(BatchNormalization())\nmodel.add(Dropout(0.5))\nmodel.add(Dense(2, activation='softmax')) # 2 because we have cat and dog classes\n\nmodel.compile(loss='categorical_crossentropy', optimizer='rmsprop', metrics=['accuracy'])\n\nmodel.summary()","56651928":"from keras.callbacks import EarlyStopping, ReduceLROnPlateau","f8062d6c":"earlystop = EarlyStopping(patience=10)","19798dbc":"learning_rate_reduction = ReduceLROnPlateau(monitor='val_acc', \n                                            patience=2, \n                                            verbose=1, \n                                            factor=0.5, \n                                            min_lr=0.00001)","8fd0b526":"callbacks = [earlystop, learning_rate_reduction]","acf2aed1":"!pip install wandb","c0a2de7c":"df[\"category\"] = df[\"category\"].replace({0: 'cat', 1: 'dog'}) ","9a23f6a9":"train_df, validate_df = train_test_split(df, test_size=0.20, random_state=42)\ntrain_df = train_df.reset_index(drop=True)\nvalidate_df = validate_df.reset_index(drop=True)","5a84af1d":"train_df['category'].value_counts().plot.bar()","fd05a178":"validate_df['category'].value_counts().plot.bar()","ec1aae84":"total_train = train_df.shape[0]\ntotal_validate = validate_df.shape[0]\nbatch_size=15","5dc88f2b":"train_datagen = ImageDataGenerator(\n    rotation_range=15,\n    rescale=1.\/255,\n    shear_range=0.1,\n    zoom_range=0.2,\n    horizontal_flip=True,\n    width_shift_range=0.1,\n    height_shift_range=0.1\n)\n\ntrain_generator = train_datagen.flow_from_dataframe(\n    train_df, \n    \".\/train\/train\/\", \n    x_col='filename',\n    y_col='category',\n    target_size=IMAGE_SIZE,\n    class_mode='categorical',\n    batch_size=batch_size\n)","784cd88d":"validation_datagen = ImageDataGenerator(rescale=1.\/255)\nvalidation_generator = validation_datagen.flow_from_dataframe(\n    validate_df, \n    \".\/train\/train\/\", \n    x_col='filename',\n    y_col='category',\n    target_size=IMAGE_SIZE,\n    class_mode='categorical',\n    batch_size=batch_size\n)","0d198ba2":"example_df = train_df.sample(n=1).reset_index(drop=True)\nexample_generator = train_datagen.flow_from_dataframe(\n    example_df, \n    \".\/train\/train\/\", \n    x_col='filename',\n    y_col='category',\n    target_size=IMAGE_SIZE,\n    class_mode='categorical'\n)","a014a301":"plt.figure(figsize=(12, 12))\nfor i in range(0, 15):\n    plt.subplot(5, 3, i+1)\n    for X_batch, Y_batch in example_generator:\n        image = X_batch[0]\n        plt.imshow(image)\n        break\nplt.tight_layout()\nplt.show()","4a27b360":"epochs=3 if FAST_RUN else 50\nhistory = model.fit_generator(\n    train_generator, \n    epochs=epochs,\n    validation_data=validation_generator,\n    validation_steps=total_validate\/\/batch_size,\n    steps_per_epoch=total_train\/\/batch_size,\n    callbacks=callbacks\n)","183214da":"model.save_weights(\"model.h5\")","1b4c57ad":"fig, (ax1, ax2) = plt.subplots(2, 1, figsize=(12, 12))\nax1.plot(history.history['loss'], color='b', label=\"Training loss\")\nax1.plot(history.history['val_loss'], color='r', label=\"validation loss\")\nax1.set_xticks(np.arange(1, epochs, 1))\nax1.set_yticks(np.arange(0, 1, 0.1))\n\nax2.plot(history.history['acc'], color='b', label=\"Training accuracy\")\nax2.plot(history.history['val_acc'], color='r',label=\"Validation accuracy\")\nax2.set_xticks(np.arange(1, epochs, 1))\n\nlegend = plt.legend(loc='best', shadow=True)\nplt.tight_layout()\nplt.show()","25e31e8d":"test_filenames = os.listdir(\"..\/input\/test1\/test1\")\ntest_df = pd.DataFrame({\n    'filename': test_filenames\n})\nnb_samples = test_df.shape[0]","8a5bb6b5":"test_gen = ImageDataGenerator(rescale=1.\/255)\ntest_generator = test_gen.flow_from_dataframe(\n    test_df, \n    \".\/test\/test1\/\", \n    x_col='filename',\n    y_col=None,\n    class_mode=None,\n    target_size=IMAGE_SIZE,\n    batch_size=batch_size,\n    shuffle=False\n)","bd30dbe1":"predict = model.predict_generator(test_generator, steps=np.ceil(nb_samples\/batch_size))","2294aa96":"test_df['category'] = np.argmax(predict, axis=-1)","decfb197":"label_map = dict((v,k) for k,v in train_generator.class_indices.items())\ntest_df['category'] = test_df['category'].replace(label_map)","05dc3dbe":"test_df['category'] = test_df['category'].replace({ 'dog': 1, 'cat': 0 })","f940e549":"test_df['category'].value_counts().plot.bar()","c2aefb38":"sample_test = test_df.head(18)\nsample_test.head()\nplt.figure(figsize=(12, 24))\nfor index, row in sample_test.iterrows():\n    filename = row['filename']\n    category = row['category']\n    img = load_img(\"..\/input\/test1\/test1\/\"+filename, target_size=IMAGE_SIZE)\n    plt.subplot(6, 3, index+1)\n    plt.imshow(img)\n    plt.xlabel(filename + '(' + \"{}\".format(category) + ')' )\nplt.tight_layout()\nplt.show()","3a32f6ca":"submission_df = test_df.copy()\nsubmission_df['id'] = submission_df['filename'].str.split('.').str[0]\nsubmission_df['label'] = submission_df['category']\nsubmission_df.drop(['filename', 'category'], axis=1, inplace=True)\nsubmission_df.to_csv('submission.csv', index=False)","38c664c8":"# Prepare Traning Data","f209c89a":"# Submission","c12a30bd":"### Virtaulize Result","cc16f12e":"### See Total In count","b2398b9d":"# Import Library","10064f5f":"* **Input Layer**: It represent input image data. It will reshape image into single diminsion array. Example your image is 64x64 = 4096, it will convert to (4096,1) array.\n* **Conv Layer**: This layer will extract features from image.\n* **Pooling Layer**: This layerreduce the spatial volume of input image after convolution.\n* **Fully Connected Layer**: It connect the network from a layer to another layer\n* **Output Layer**: It is the predicted values layer. ","bc274175":"# Define Constants","af1684fd":"# See sample image","e9632ffc":"Because we will use image genaretor `with class_mode=\"categorical\"`. We need to convert column category into string. Then imagenerator will convert it one-hot encoding which is good for our classification. \n\nSo we will convert 1 to dog and 0 to cat","12b2c3a9":"# Save Model","00bfbfc0":"For categoral classication the prediction will come with probability of each category. So we will pick the category that have the highest probability with numpy average max","4d058292":"This Kernel for someone want to deep dive into image classification. I use CNN for classification model. If you found this Kernel helpful please up vote it. If you have some feedback and question don't forget to comment below. \n\nI have simplier model with \n* https:\/\/www.kaggle.com\/uysimty\/get-start-image-classification\n\nForked from original notebook: https:\/\/www.kaggle.com\/uysimty\/keras-cnn-dog-or-cat-classification","a03b6ba6":"# See how our generator work","97f42731":"We will convert the predict category back into our generator classes by using `train_generator.class_indices`. It is the classes that image generator map while converting data into computer vision","bd59724a":"# Fit Model","5aa473ce":"From our prepare data part. We map data with `{1: 'dog', 0: 'cat'}`. Now we will map the result back to dog is 1 and cat is 0","51ff4d59":"From our data we have 12000 cats and 12000 dogs","811baef2":"### Validation Generator","18ef75e6":"# Prepare data","8413742a":"# Traning Generator","a4c92ccd":"Seem to be nice ","fee95161":"# Predict","08ee67a6":"**Early Stop**\n\nTo prevent over fitting we will stop the learning after 10 epochs and val_loss value not decreased","2f54e201":"**Learning Rate Reduction**\n\nWe will reduce the learning rate when then accuracy not increase for 2 steps","917e4d98":"# Build Model\n\n<img src=\"https:\/\/i.imgur.com\/ebkMGGu.jpg\" width=\"100%\"\/>","eb8c6923":"# Callbacks","211244e4":"# Prepare Testing Data","12b2e533":"# Create Testing Generator","491661fb":"# Virtualize Training","db515371":"### See predicted result with images"}}