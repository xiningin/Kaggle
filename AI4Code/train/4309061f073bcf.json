{"cell_type":{"bea1fa08":"code","ec196b68":"code","5b4db392":"code","463fcd17":"code","d975ee47":"code","90f08cbc":"code","d44bd603":"code","8e427e7a":"code","a3cfd43e":"code","fee1d5fd":"code","6b7f5a3f":"code","85b3c24c":"code","b5d4dbd8":"code","9f908bfd":"code","3b03b039":"code","ff80b4ae":"code","c7bb5847":"code","cf50f9c0":"code","46128dc8":"code","80de6645":"code","3fedbd71":"code","89db44ca":"code","c279e4b2":"markdown","53d93534":"markdown","a9970401":"markdown","86cdefcc":"markdown","3df1c9ef":"markdown","0c237700":"markdown","9e73369c":"markdown","bbb3dbe9":"markdown","b5eb10f7":"markdown","79de7b83":"markdown","8bdfadfb":"markdown","de11ede2":"markdown","dda7afd4":"markdown","4dd6afbd":"markdown","7c10ceab":"markdown","0f55a630":"markdown","08e7b566":"markdown","d97b23e2":"markdown","b9e06247":"markdown","85041cc4":"markdown","fd4922ce":"markdown","7fde5af9":"markdown","02fafd28":"markdown","4005c7dd":"markdown","5bb8e4cc":"markdown","134192ce":"markdown"},"source":{"bea1fa08":"!pip install -q scanpy\n\nimport scanpy as sc # import scanpy to handle our AnnData \nimport pandas as pd # import pandas to handle dataframes\nimport matplotlib.pyplot as plt # import matplotlib to visualize our qc metrics\n\n# magic incantation to help matplotlib work with our jupyter notebook\n%matplotlib inline ","ec196b68":"adata = sc.read('..\/input\/scrnaseq-analysis-model-outputs\/brain_raw\/brain_raw.h5ad') ","5b4db392":"adata.obs.head() #contains information about the various unique cells ","463fcd17":"adata.var.head() #contains all the genes with the ERCC column identifying spike-in and non-spike-in genes","d975ee47":"qc = sc.pp.calculate_qc_metrics(adata, qc_vars = ['ERCC']) #this returns a tuple of (cell_qc_dataframe, gene_qc_dataframe)\n                                 # ask for the percentage of reads from spike ins\n                                \ncell_qc_dataframe = qc[0]\ngene_qc_dataframe = qc[1]\n\nprint('This is the cell quality control dataframe:')\ncell_qc_dataframe.head()","90f08cbc":"import seaborn as sns\nsns.jointplot(\n    data=cell_qc_dataframe,\n    x=\"log1p_total_counts\",\n    y=\"log1p_n_genes_by_counts\",\n    kind=\"hex\",\n)","d44bd603":"sns.histplot(cell_qc_dataframe[\"pct_counts_ERCC\"])","8e427e7a":"print('This is the gene quality control dataframe:')\ngene_qc_dataframe.head()","a3cfd43e":"plt.hist(cell_qc_dataframe['total_counts'], bins=1000)\nplt.xlabel('Total counts')\nplt.ylabel('N cells')\nplt.axvline(50000, color='red')","fee1d5fd":"sum(cell_qc_dataframe['total_counts'] < 50000)","6b7f5a3f":"plt.hist(cell_qc_dataframe['n_genes_by_counts'], bins=100)\nplt.xlabel('N genes')\nplt.ylabel('N cells')\nplt.axvline(1000, color='red')","85b3c24c":"plt.hist(cell_qc_dataframe['pct_counts_ERCC'], bins=1000)\nplt.xlabel('Percent counts ERCC')\nplt.ylabel('N cells')\nplt.axvline(10, color='red')","b5d4dbd8":"low_ERCC_mask = (cell_qc_dataframe['pct_counts_ERCC'] < 10)\nadata = adata[low_ERCC_mask]","9f908bfd":"# Filter cells with fewer 750 genes detected.\nprint('Started with: \\n', adata)\nsc.pp.filter_cells(adata, min_genes = 750)\nprint('Finished with: \\n', adata)","3b03b039":"gene_qc_dataframe.head()","ff80b4ae":"plt.hist(gene_qc_dataframe['n_cells_by_counts'], bins=1000)\nplt.xlabel('N cells expressing > 0')\nplt.ylabel('log(N genes)') # for visual clarity\nplt.axvline(2, color='red')\nplt.yscale('log') ","c7bb5847":"sum(gene_qc_dataframe['n_cells_by_counts'] < 2)","cf50f9c0":"plt.hist(gene_qc_dataframe['total_counts'], bins=1000)\nplt.xlabel('Total counts')\nplt.ylabel('log(N genes)') # for visual clarity\nplt.yscale('log') \nplt.axvline(10, color='red')","46128dc8":"sum(gene_qc_dataframe['total_counts'] < 10)","80de6645":"print('Started with: \\n', adata)\nsc.pp.filter_genes(adata, min_cells = 2)\nsc.pp.filter_genes(adata, min_counts = 10)\nprint('Finished with: \\n', adata)","3fedbd71":"print(adata) ## Final dimensions of the QC'd dataset\nadata.write('brain_qc.h5ad')","89db44ca":"!zip \"brain_qc.zip\" \".\/brain_qc.h5ad\"","c279e4b2":"<h1 style = \"font-family: garamond; font-size: 40px; font-style: normal; letter-spcaing: 3px; background-color: #f6f5f5; color :#fe346e; border-radius: 100px 100px; text-align:center\">Summary<\/h1>\n\n- We calculated the quality control metrics across cells and genes.\n- Performed Quality control in cells by removing cells with (i)a low number of reads, (ii)very few unique genes, and (iii)low starting amounts of endogenous RNA\n- Quality control in genes by removing \"undetectable\" genes (A gene is defined to be detectable if at least two cells contain more than 5 reads from the gene)\n- Saving the quality controlled data for further pipeline.","53d93534":"https:\/\/chanzuckerberg.github.io\/scRNA-python-workshop\/preprocessing\/01-basic-qc.html","a9970401":"<h1 style = \"font-family: garamond; font-size: 40px; font-style: normal; letter-spcaing: 3px; background-color: #f6f5f5; color :#fe346e; border-radius: 100px 100px; text-align:center\">Quality Control for Cells<\/h1>\n\n## Library size \nFirst, we consider the total number of reads detected per cell. Cells with few reads are likely to have been broken or failed to capture a cell, and should thus be removed.","86cdefcc":"### Loading the data","3df1c9ef":"Placing a threshold is always a judgement call. Here, the majority of cells have less than 10% ERCC counts, but there's a <b>long tail of cells that have very high spike-in counts; these are likely dead cells and should be removed.<\/b>","0c237700":"<h1 style = \"font-family: garamond; font-size: 40px; font-style: normal; letter-spcaing: 3px; background-color: #f6f5f5; color :#fe346e; border-radius: 100px 100px; text-align:center\">Quality Control for Genes<\/h1>\n\nIt is typically a good idea to remove genes whose expression level is considered \"undetectable\". \n- We define a <b>gene as detectable if at least two cells contain more than 5 reads from the gene. <\/b> However, the threshold strongly depends on the sequencing depth. \n- It is important to keep in mind that <b> genes must be filtered after cell filtering <\/b> since some genes may only be detected in poor quality cells.","9e73369c":"## Cell Filtering based on above analysis\nThere isn't an automatic function for removing cells with a high percentage of ERCC reads, but we can use a mask to remove them like so:\n- Removing cells having ERCC percentage count >= 10\n- Removing cell having gene count < 750","bbb3dbe9":"<h1 style = \"font-family: garamond; font-size: 40px; font-style: normal; letter-spcaing: 3px; background-color: #f6f5f5; color :#fe346e; border-radius: 100px 100px; text-align:center\">Introduction<\/h1>\n\n- Once we have our expression matrix, it is important to examine the same, to remove <b>poor quality cells<\/b> which were not detected in the initial processing of the raw reads. If this is not done at this stage, it may add <b>technical noise<\/b> which has the potential to disturb the biological signals of interest in the downstream analysis.\n- To perform Quality Control (QC) we will be looking for cells which are <b>outliers<\/b> with respect to the rest of the dataset rather than comparing to independent quality standards.","b5eb10f7":"- \u201cn_cells_by_counts\u201d. Number of cells this expression is measured in.\n- \u201cmean_counts\u201d. Mean expression by counts over all cells.\n- \u201cpct_dropout_by_counts\u201d. Percentage of cells this feature does not appear in.\n- \u201ctotal_counts\u201d. Sum of counts for a gene.\n","79de7b83":"<br>\n<h1 style = \"font-size:60px; font-family:Garamond ; font-weight : normal; background-color: #f6f5f5 ; color : #fe346e; text-align: center; border-radius: 100px 100px;\">Quality Control<\/h1>\n<br>","8bdfadfb":"Looks like the authors have already removed cells with fewer than 50,000 reads.","de11ede2":"<h1 style = \"font-family: garamond; font-size: 40px; font-style: normal; letter-spcaing: 3px; background-color: #f6f5f5; color :#fe346e; border-radius: 100px 100px; text-align:center\">Computing quality control metrics<\/h1>\n\n- We'll compute <b>quality metrics<\/b> and then filter cells and genes accordingly.\n- The <b>calculate_qc_metrics<\/b> function returns two dataframes: one containing quality control metrics about cells, and one containing metrics about genes. This function is housed in the 'preprocessing' portion of the SCANPY library.","dda7afd4":"First, we consider the total number of cell in which a gene is deteted. Genes with few cell count are outliers and should thus be removed.","4dd6afbd":"calculate_qc_metrics when ['ERCC'] is inserted, it returns the information of both cells and genes with respect to Spike-ins.","7c10ceab":"There are 3969 gene which are detected in less than 2 cells, i.e. having n_cells_by_counts < 2","0f55a630":"### Installations","08e7b566":"There are 4432 genes which are having sum_counts < 10","d97b23e2":"## Detected genes \nIn addition to ensuring sufficient sequencing depth for each sample, we also want to make sure that the reads are distributed across the transcriptome. Thus, we count the total number of unique genes detected in each sample.","b9e06247":"Around 5000 genes are removed after filtering.","85041cc4":"From the plot we conclude that most cells have between ~1,000-5,000 detected genes, which is typical for smartseq2 data. However, this varies by experimental protocol and sequencing depth.\n\nThe most notable feature in the above plot is the <b>little peak on the left hand side <\/b>of the distribution. If detection rates were equal across the cells then the distribution should be approximately normal. Thus, we will remove those cells in the tail of the distribution (fewer than ~1000 detected genes).","fd4922ce":"- \u201cn_genes_by_counts\u201d. The number of genes with at least 1 count in a cell. Calculated for all cells.\n- \u201ctotal_counts\u201d. Total number of counts in a cell.\n- \u201cpct_counts_in_top_50_genes\u201d. Cumulative percentage of counts for 50 most expressed genes in a cell.\n- \u201ctotal_genes_by_counts\u201d. Number of genes with positive counts in a cell. (total gene count having True ERCC)\n- \u201ctotal_counts_ERCC\u201d. Total number of counts for variabes in qc_vars.\n- \u201cpct_counts_ERCC\u201d. Proportion of total counts for a cell which belong to ERCC.\n\n","7fde5af9":"Gives the histogram for **pct_counts_ERCC** - %genes in the cell which are ERCC","02fafd28":"Plot between **log1p_n_genes_by_counts** (log(1+x) where x is count of unique genes in a cell) and **log1p_total_counts** (log(1+x) where x is total count of genes in a cell)\n\nPlots a bivariate histogram using hexagonal bins with marginal histograms.","4005c7dd":"## Spike-ins \n- Another measure of cell quality is the ratio between ERCC spike-in RNAs and endogenous RNAs. This ratio can be used to estimate the total amount of RNA in the captured cells. \n- **Cells with a high level of spike-in RNAs had low starting amounts of RNA, likely due to the cell being dead or stressed which may result in the RNA being degraded.**","5bb8e4cc":"# Saving the Quality Controlled adata","134192ce":"![image.png](attachment:9f5d68fc-8c8d-42f3-8816-dc0a3a7dd763.png)"}}