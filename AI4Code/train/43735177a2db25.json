{"cell_type":{"333ab791":"code","9b77a55f":"code","3bb9b87f":"code","90d36808":"code","72a54e08":"code","7eb0ad7b":"code","aa2756bd":"code","1eadf322":"code","c5e07662":"code","c085ccd0":"code","dce50b03":"code","56327bde":"code","8e9cd871":"code","47da8072":"code","df3a2de9":"code","58205574":"code","45fa6551":"code","19bcd4fd":"code","b5c74db7":"code","557363b8":"code","4a239c5e":"code","7fabcd5b":"code","7c424454":"code","450e2e7b":"code","36709ad7":"code","de5d33d6":"code","90ab04e4":"code","a84d3f34":"code","141332cf":"code","20cb20fa":"code","048e4811":"code","a270fec2":"code","f244805f":"markdown","fa924d2a":"markdown","4418dc9e":"markdown","3ce2aaa3":"markdown","2305a87d":"markdown","19ebf3c5":"markdown"},"source":{"333ab791":"# This Python 3 environment comes with many helpful analytics libraries installed\n# It is defined by the kaggle\/python Docker image: https:\/\/github.com\/kaggle\/docker-python\n# For example, here's several helpful packages to load\n\nimport numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\n\n# Input data files are available in the read-only \"..\/input\/\" directory\n# For example, running this (by clicking run or pressing Shift+Enter) will list all files under the input directory\n\nimport os\nfor dirname, _, filenames in os.walk('\/kaggle\/input'):\n    for filename in filenames:\n        print(os.path.join(dirname, filename))\n\n# You can write up to 20GB to the current directory (\/kaggle\/working\/) that gets preserved as output when you create a version using \"Save & Run All\" \n# You can also write temporary files to \/kaggle\/temp\/, but they won't be saved outside of the current session","9b77a55f":"import numpy as np\nimport pandas as pd \nfrom keras.layers import Input, Lambda, Dense, Flatten , Dropout , MaxPool2D\nfrom keras.models import Model , Sequential\nimport tensorflow as tf\nfrom tensorflow.keras.preprocessing import image\nfrom keras.preprocessing.image import ImageDataGenerator\nfrom glob import glob\nimport matplotlib.pyplot as plt\nimport random\nimport os\nfrom distutils.file_util import copy_file\nimport warnings\nwarnings.filterwarnings('ignore')\nfrom keras.callbacks import EarlyStopping ,ReduceLROnPlateau","3bb9b87f":"covidDataPath='..\/input\/covid19-radiography-database\/COVID-19_Radiography_Dataset\/COVID'\npneumoniaDataPath='..\/input\/covid19-radiography-database\/COVID-19_Radiography_Dataset\/Viral Pneumonia'\nnormalDataPath='..\/input\/covid19-radiography-database\/COVID-19_Radiography_Dataset\/Normal'","90d36808":"# Lists for access paths\nlistCovidPaths = []\nlistNormalPaths = []\n\n# Get covid images files paths\nfor root, directories, files in os.walk(covidDataPath):\n    for name in files:\n        listCovidPaths.append(os.path.join(root, name))\n\n# for root, directories, files in os.walk(pneumoniaDataPath):\n#     for name in files:\n#         listCovidPaths.append(os.path.join(root, name))        \n        \n# Get normal images files paths\nfor root, directories, files in os.walk(normalDataPath):\n    for name in files:\n        listNormalPaths.append(os.path.join(root, name))\n\n# Shuffle lists for random train \/ test\n\nrandom.shuffle(listCovidPaths)\nrandom.shuffle(listNormalPaths)","72a54e08":"len(listCovidPaths)","7eb0ad7b":"len(listNormalPaths)","aa2756bd":"# main folder\n!mkdir .\/Data\/\n\n# Train data folders\n!mkdir .\/Data\/Train\/\n!mkdir .\/Data\/Train\/Covid\/\n!mkdir .\/Data\/Train\/Normal\/\n\n# Test data folders\n!mkdir .\/Data\/Test\/\n!mkdir .\/Data\/Test\/Covid\/\n!mkdir .\/Data\/Test\/Normal\/\n\n# Valid data folders\n!mkdir .\/Data\/Valid\/\n!mkdir .\/Data\/Valid\/Covid\/\n!mkdir .\/Data\/Valid\/Normal\/\n\n# Paths to covid images folders\npathCovidTrain = '.\/Data\/Train\/Covid\/'\npathCovidTest = '.\/Data\/Test\/Covid\/'\npathCovidValid='.\/Data\/Valid\/Covid\/'\n\n\n# Paths to normal images folders\npathNormalTrain = '.\/Data\/Train\/Normal\/'\npathNormalTest = '.\/Data\/Test\/Normal\/'\npathNormalValid='.\/Data\/Valid\/Normal\/'\n","1eadf322":"\"\"\"\nMoving files to new folders\n\"\"\"\n\n# Move covid images files to new folders\nfor i in range(3616):\n    if i < 2893:\n        copy_file(listCovidPaths[i], pathCovidTrain)\n    elif i>=2893 and i<=3255:\n        copy_file(listCovidPaths[i], pathCovidValid)\n    else  : \n        copy_file(listCovidPaths[i], pathCovidTest)\n        \nfor i in range(10192):\n    if i < 8154:\n        copy_file(listNormalPaths[i], pathNormalTrain)\n    elif i>=8154 and i<=9174:\n        copy_file(listNormalPaths[i], pathNormalValid)     \n    else  : \n        copy_file(listNormalPaths[i], pathNormalTest)       ","c5e07662":"\ntrain_data_gen = ImageDataGenerator(rescale=1.\/255 ,\n                                    zoom_range= 0.3, \n                                    horizontal_flip= True, \n                                    shear_range= 0.2,\n                                    rotation_range = 30\n                                    )\n\ntrain = train_data_gen.flow_from_directory(directory= '.\/Data\/Train',\n                                           class_mode = 'binary',\n                                           batch_size=64,\n                                           target_size=(224,224))","c085ccd0":"test_data_gen = ImageDataGenerator(rescale=1.\/255 )\n\ntest = test_data_gen.flow_from_directory(directory= '.\/Data\/Test' , \n                                          target_size=(224,224), \n                                            class_mode = 'binary',\n                                        shuffle=False,\n                                        batch_size=64)\n\nvalid = test_data_gen.flow_from_directory(directory= '.\/Data\/Valid' , \n                                          target_size=(224,224), \n                                            class_mode = 'binary',\n                                        shuffle=False,\n                                        batch_size=64)","dce50b03":"plt.figure(figsize=(12, 12))\nfor i in range(0, 10):\n    plt.subplot(2, 5, i+1)\n    for X_batch, Y_batch in train:\n        image = X_batch[0]        \n        dic = {0:'NORMAL', 1:'COVID'}\n        plt.title(dic.get(Y_batch[0]))\n        plt.axis('off')\n        plt.imshow(np.squeeze(image),cmap='gray',interpolation='nearest')\n        break\nplt.tight_layout()\nplt.show()","56327bde":"inc = tf.keras.applications.InceptionResNetV2(\n    include_top = False,\n    weights = 'imagenet',\n    input_shape = (224,224,3),\n    classifier_activation = 'sigmoid'\n)","8e9cd871":"for layer in inc.layers:           \n  layer.trainable = False","47da8072":"'''\nDefinition of the Keras model outputs\n'''\n\nx = Flatten()(inc.output)\nprediction= Dense(units=1 , activation='sigmoid')(x)\n\nmodel = Model(inc.input,prediction)","df3a2de9":"\"\"\"\nCompile model\n\"\"\"\n\nmodel.compile(\n    optimizer = tf.keras.optimizers.Adam(0.001),\n    loss = 'binary_crossentropy',\n    metrics = ['accuracy']\n)","58205574":"early = EarlyStopping(monitor='val_accuracy', mode='min', patience=3)\nlearning_rate_reduction = ReduceLROnPlateau(monitor='val_accuracy', patience = 2, verbose=1,factor=0.3, min_lr=0.000001)\ncallbacks_list = [ early, learning_rate_reduction]","45fa6551":"from sklearn.utils.class_weight import compute_class_weight\nweights = compute_class_weight('balanced',np.unique(train.classes), train.classes)\ncw = dict(zip( np.unique(train.classes), weights))\nprint(cw)","19bcd4fd":"hist = model.fit(train, steps_per_epoch= len(train), epochs= 15, validation_data= valid,class_weight=cw,validation_steps= len(test), callbacks=callbacks_list)","b5c74db7":"pd.DataFrame(hist.history).plot()","557363b8":"import seaborn as sns","4a239c5e":"\n#Plot training and validation Loss\nfig, axarr = plt.subplots(1,3, figsize=(15,5),sharex=True)\n\nsns.set(style=\"ticks\", font_scale = 1)\nsns.despine(top=True, right=True, left=False, bottom=False)\n\nhistoryDF = pd.DataFrame.from_dict(hist.history)\n\nax = sns.lineplot(x =historyDF.index, y = hist.history['accuracy'],ax=axarr[0],label=\"Training\");\nax = sns.lineplot(x =historyDF.index, y = hist.history['val_accuracy'],ax=axarr[0],label=\"Validation\");\nax.set_ylabel('Recall')\n\nax = sns.lineplot(x =historyDF.index, y = hist.history['loss'],ax=axarr[1],label=\"Training\");\nax = sns.lineplot(x =historyDF.index, y = hist.history['val_loss'],ax=axarr[1],label=\"Validation\");\nax.set_ylabel('Loss')\nax = sns.lineplot(x =historyDF.index, y = hist.history['lr'],ax=axarr[2]);\nax.set_ylabel('Learning Rate')    \naxarr[0].set_title(\"Training and Validation Set - Accuracy\")\naxarr[1].set_title(\"Training and Validation Set - Loss\")\naxarr[2].set_title(\"Learning Rate during Training\")\n\nfor ax in axarr:\n    ax.set_xlabel('Epochs')\n    \nplt.suptitle('Training Performance Plots',fontsize=16, weight = 'bold');\nfig.tight_layout(pad=3.0)      \nplt.show()","7fabcd5b":"test_accu = model.evaluate(test)\nprint('The testing accuracy is :',test_accu[1]*100, '%')","7c424454":"preds = model.predict(test,verbose=1)\npredictions = preds.copy()\npredictions[predictions <= 0.5] = 0\npredictions[predictions > 0.5] = 1","450e2e7b":"from sklearn.metrics import classification_report,confusion_matrix\ncm = pd.DataFrame(data=confusion_matrix(test.classes, predictions, labels=[0, 1]),index=[\"Actual Normal\", \"Actual COVID\"],\ncolumns=[\"Predicted Normal\", \"Predicted COVID\"])\nimport seaborn as sns\nsns.heatmap(cm,annot=True,fmt=\"d\")","36709ad7":"print(classification_report(y_true=test.classes,y_pred=predictions,target_names =['NORMAL','COVID']))","de5d33d6":"test.reset()\nx=np.concatenate([test.next()[0] for i in range(test.__len__())])\ny=np.concatenate([test.next()[1] for i in range(test.__len__())])\nprint(x.shape)\nprint(y.shape)","90ab04e4":"y_true=test.classes","a84d3f34":"from sklearn.metrics import precision_recall_fscore_support, accuracy_score\n","141332cf":"#Accuracy Result\nacc = accuracy_score(y_true, predictions)\n#Precision, Recall and F-Score (For the whole dataset)\nresults_all = precision_recall_fscore_support(y_true, predictions, average='macro',zero_division = 1)\n#Precision, Recall and F-Score (For each Class)\nresults_class = precision_recall_fscore_support(y_true, predictions, average=None, zero_division = 1)\n\n#Organise the Results into a Dataframe\nmetric_columns = ['Precision','Recall', 'F-Score','S']\nall_df = pd.concat([pd.DataFrame(list(results_class)).T,pd.DataFrame(list(results_all)).T])\nall_df.columns = metric_columns\nall_df.index = ['COVID','Normal','Total']\n\n#Function to plot the metrics into a nice bar Plot\ndef metrics_plot(df,metric):\n    plt.figure(figsize=(22,10))\n    ax = sns.barplot(data =df, x=df.index, y = metric,palette = \"Blues_d\")\n    #Bar Labels\n    for p in ax.patches:\n        ax.annotate(\"%.1f%%\" % (100*p.get_height()), (p.get_x() + p.get_width() \/ 2., abs(p.get_height())),\n        ha='center', va='bottom', color='black', xytext=(-3, 5),rotation = 'horizontal',textcoords='offset points')\n    sns.despine(top=True, right=True, left=True, bottom=False)\n    ax.set_xlabel('Class',fontsize = 14,weight = 'bold')\n    ax.set_ylabel(metric,fontsize = 14,weight = 'bold')\n    ax.set(yticklabels=[])\n    ax.axes.get_yaxis().set_visible(False) \n    plt.title(metric+ ' Results per Class', fontsize = 16,weight = 'bold');\n    \nmetrics_plot(all_df, 'Precision')#Results by Class\nmetrics_plot(all_df, 'Recall')#Results by Class\nmetrics_plot(all_df, 'F-Score')#Results by Class\nprint('**Overall Results**')\nprint('Accuracy Result: %.2f%%'%(acc*100)) #Accuracy of the whole Dataset\nprint('Precision Result: %.2f%%'%(all_df.iloc[1,0]*100))#Precision of the whole Dataset\nprint('Recall Result: %.2f%%'%(all_df.iloc[1,1]*100))#Recall of the whole Dataset\nprint('F-Score Result: %.2f%%'%(all_df.iloc[1,2]*100))#F-Score of the whole Dataset","20cb20fa":"dic = {0:'NORMAL', 1:'COVID'}\nplt.figure(figsize=(20,20))\nfor i in range(0+224, 15+224):\n  plt.subplot(5,3, (i-224)+1)\n  if preds[i, 0] >= 0.5: \n      out = ('{:.2%} probability of being Covid case'.format(preds[i][0]))\n      \n      \n  else: \n      out = ('{:.2%} probability of being Normal case'.format(1-preds[i][0]))\n      \n      \n\n  plt.title(out+\"\\n Actual case : \"+ dic.get(y[i]))    \n  plt.imshow(np.squeeze(x[i]))\n  plt.axis('off')\nplt.show()","048e4811":"# Testing with random Chest X-Ray\nimg_path = '..\/input\/covid19-radiography-database\/COVID-19_Radiography_Dataset\/COVID\/COVID-1.png'\nfrom tensorflow.keras.preprocessing import image\nimg = image.load_img(img_path, target_size=(224,224))\n\n# Preprocessing the image\npp_img = image.img_to_array(img)\npp_img = pp_img\/255\npp_img = np.expand_dims(pp_img, axis=0)\n\n#predict\npreds= model.predict(pp_img)\n\n#print\nplt.figure(figsize=(6,6))\nplt.axis('off')\nif preds>= 0.5: \n    out = ('I am {:.2%} percent confirmed that this is a Normal case'.format(preds[0][0]))\n    \nelse: \n    out = ('{:.2%} percent confirmed that this is a COVID case'.format(1-preds[0][0]))\n    \n\nplt.title(\" Chest X-Ray\\n\"+out)  \nplt.imshow(np.squeeze(pp_img))\nplt.show()","a270fec2":"from sklearn.metrics import roc_curve\nfpr_keras, tpr_keras, thresholds_keras = roc_curve(test.classes, predictions)\nfrom sklearn.metrics import auc\nauc_keras = auc(fpr_keras, tpr_keras)\nplt.figure(1)\nplt.plot([0, 1], [0, 1], 'k--')\nplt.plot(fpr_keras, tpr_keras, label='Keras (area = {:.3f})'.format(auc_keras))\nplt.xlabel('False positive rate')\nplt.ylabel('True positive rate')\nplt.title('ROC curve')\nplt.legend(loc='best')\nplt.show()","f244805f":"# Data Preparation","fa924d2a":"# Data Augmentation","4418dc9e":"# Importing Required Libraries","3ce2aaa3":"# Importing ResNet V2","2305a87d":"\n# Results","19ebf3c5":"## Confusion Matrix"}}