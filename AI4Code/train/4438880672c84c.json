{"cell_type":{"22d274ee":"code","c3af2026":"code","a6055535":"code","d1e48f12":"code","ebf42ecf":"code","8bd2d264":"code","cc64ce22":"code","920731a7":"code","48b085b6":"code","d743db9b":"code","ce9d3c3d":"code","fe6bed35":"code","165d50f0":"code","4d7398e4":"code","35594d74":"code","76e805fc":"code","f7a78a6e":"code","11262e9f":"code","33aacd6c":"code","2c019173":"code","b2bf432f":"code","e984ef92":"code","d92f36c7":"code","487b525e":"code","eea8a2d7":"code","c364caf6":"code","2c437fe6":"code","fba57288":"code","475e8a20":"code","4fc15f4d":"code","c3713356":"code","1643b42b":"code","f3056a66":"code","df75c4bd":"code","25546443":"code","e2e64807":"code","efdd3825":"code","eb28a6c7":"markdown","f65e59f4":"markdown"},"source":{"22d274ee":"import matplotlib.pyplot as plt\n%matplotlib inline\nimport seaborn as sns\nsns.set(style=\"whitegrid\")\nimport glob\nimport numpy as np\nfrom tensorflow.keras.preprocessing.image import load_img,img_to_array\nimport os\nfrom tensorflow.keras.utils import to_categorical\nfrom tqdm import tqdm\nfrom PIL import Image\nimport cv2","c3af2026":"#used label encoder\ncode = {'Benign':0 ,'Ransomware':1}\n\ndef getcode(n) : \n    for x , y in code.items() : \n        if n == y : \n            return x","a6055535":"s=224#size\ntrain=80\ntest=20","d1e48f12":"X_train = []\ny_train = []\ntraining_data = []","ebf42ecf":"# Dir = '..\/input\/iot-malware-removed-dublicated\/IOT_Malware_dataset'\nDir_1 = '..\/input\/ransimg\/RansImg DB'","8bd2d264":"files = glob.glob(pathname= str( Dir_1+'\/Benign'+'\/*.*'))\na=len(files)\nn_train1=int((train \/100)*a)\nn_test1=a-n_train1\nfor file in tqdm(files[0:n_train1]): \n    image = cv2.imread(file)\n    #image = cv2.cvtColor(image, cv2.COLOR_BGR2RGB)\n    image_array = cv2.resize(image , (s,s), interpolation = cv2.INTER_AREA)\n    X_train.append(list(image_array))\n    y_train.append(code['Benign'])\n    training_data.append([image_array, code['Benign']])","cc64ce22":"\nfiles = glob.glob(pathname= str( Dir_1+'\/Ransomware'+'\/*.*'))\na=len(files)\nn_train2=int((train \/100)*a)\nn_test2=a-n_train2\nfor file in tqdm(files[0:n_train2]): \n    image = cv2.imread(file)\n    #image = cv2.cvtColor(image, cv2.COLOR_BGR2RGB)\n    image_array = cv2.resize(image , (s,s), interpolation = cv2.INTER_AREA)\n    X_train.append(list(image_array))\n    y_train.append(code['Ransomware'])\n    training_data.append([image_array, code['Ransomware']])","920731a7":"print(f'we have {len(X_train)} items in X_train')","48b085b6":"# test for randomness\nprint(len(training_data))\nprint('y_train',y_train[70:80])\n\n#using Random library\nimport random\nrandom.shuffle(training_data)\n#for sample in training_data[:10]:# just test for Shuffle\n  #  print(sample[1])\n    \n#then return data to X_train and y_train\nX_train = []\ny_train = []\n\nfor features,label in training_data:\n    X_train.append(features)\n    y_train.append(label)\nprint('y_train after shuffle',y_train[70:80]) # so data it's random\n# free some space in Ram\ndel training_data # means var train ,we did not needed any more so deleted for free space from ram ","d743db9b":"plt.figure(figsize=(20,20))\nfor i in range(4):\n    plt.subplot(1,4,i+1)\n    plt.imshow(X_train[i]) \n    plt.axis('off')\n    plt.title(getcode(y_train[i]), fontsize=15)","ce9d3c3d":"X_test = []\ny_test = []\ntraining_data = []","fe6bed35":"files = glob.glob(pathname= str( Dir_1+'\/Benign'+'\/*.*'))\nfor file in tqdm(files[n_train1:n_train1+n_test1]): \n    image = cv2.imread(file)\n    #image = cv2.cvtColor(image, cv2.COLOR_BGR2RGB)\n    image_array = cv2.resize(image , (s,s), interpolation = cv2.INTER_AREA)\n    X_test.append(list(image_array))\n    y_test.append(code['Benign'])\n    training_data.append([image_array, code['Benign']])","165d50f0":"files = glob.glob(pathname= str( Dir_1+'\/Ransomware'+'\/*.*'))\nfor file in tqdm(files[n_train2:n_train2+n_test2]): \n    image = cv2.imread(file)\n    #image = cv2.cvtColor(image, cv2.COLOR_BGR2RGB)\n    image_array = cv2.resize(image , (s,s), interpolation = cv2.INTER_AREA)\n    X_test.append(list(image_array))\n    y_test.append(code['Ransomware'])\n    training_data.append([image_array, code['Ransomware']])","4d7398e4":"print(f'we have {len(X_test)} items in X_train')","35594d74":"# test for randomness\nprint(len(training_data))\nprint('y_train',y_test[70:80])\n\n#using Random library\nimport random\nrandom.shuffle(training_data)\n#for sample in training_data[:10]:# just test for Shuffle\n    #print(sample[1])\n    \n#then return data to X_train and y_train\nX_test = []\ny_test = []\n\nfor features,label in training_data:\n    X_test.append(features)\n    y_test.append(label)\n\nprint('y_train after shuffle',y_test[70:80]) # so data it's random\n# free some space in Ram\ndel training_data # means var train ,we did not needed any more so deleted for free space from ram ","76e805fc":"plt.figure(figsize=(18,18))\nfor i in range(4):\n    plt.subplot(1,4,i+1)\n    plt.imshow(X_test[i]) \n    plt.axis('off')\n    plt.title(getcode(y_test[i]), fontsize=15)","f7a78a6e":"X_train = np.array(X_train)\nX_test = np.array(X_test)\ny_train = np.array(y_train)\ny_test = np.array(y_test)\n\nprint(f'X_train shape  is {X_train.shape}')\nprint(f'X_test shape  is {X_test.shape}')\nprint(f'y_train shape  is {y_train.shape}')\nprint(f'y_test shape  is {y_test.shape}')","11262e9f":"#from keras.utils import to_categorical\n\n#Keras need data in 4 dimention\n# Reshape image in 3 dimensions (height = 28px, width = 28px , channels = 1)\nX_train = X_train.reshape(-1,s,s,3)\nX_test = X_test.reshape(-1,s,s,3)\n\nprint(X_train.shape)\nprint(X_test.shape)\n","33aacd6c":"#Convert y_train to categorical\ny_train=to_categorical(y_train)\nprint(\"y_train \",y_train.shape)\n#Convert y_train to categorical\ny_test=to_categorical(y_test)\nprint(\"y_test \",y_test.shape)","2c019173":"# from tensorflow.keras.applications import ResNet50, VGG16, VGG19, DenseNet121\nimport tensorflow as tf\nfrom tensorflow.keras.utils import plot_model\n# you can choise ResNet50, VGG16, VGG19, DenseNet121 or 169 or 201, EfficientNetB0 from 0 to 7,InceptionResNetV2\n#InceptionV3, MobileNet, MobileNetV2, MobileNetV3Large, MobileNetV3Small, Xception\npre_trained_model = tf.keras.applications.Xception(input_shape = (s, s, 3), \n                                include_top = False, \n                                weights = 'imagenet')#imagenet\nfor layer in pre_trained_model.layers:\n    layer.trainable = False  #to make the layers to Freeze Weights\n# pre_trained_model.summary()\n# plot_model(pre_trained_model, show_shapes=True, to_file='ResNetwork.png')","b2bf432f":"from tensorflow.keras import Model\nimport tensorflow as tf\nfrom tensorflow.keras.utils import plot_model\nfrom tensorflow.keras.optimizers import SGD,Adam,RMSprop,Adagrad\nfrom tensorflow.keras.layers import GlobalAveragePooling2D\n\nx = GlobalAveragePooling2D()(pre_trained_model.output)\nx = tf.keras.layers.Flatten()(x)\n#Full Connected Layers\n# x = tf.keras.layers.Dense(1024, activation='relu')(x)\n# x = tf.keras.layers.Dropout(0.6)(x)\n# x = tf.keras.layers.Dense(1024, activation='relu')(x)\n# #Add dropout to avoid Overfit\n# x = tf.keras.layers.Dropout(0.6)(x)\n# x = tf.keras.layers.Dense(512, activation='relu')(x)\n# #Add dropout to avoid Overfit\n# x = tf.keras.layers.Dropout(0.48)(x)\nx = tf.keras.layers.Dense(256, activation='relu')(x)\n# x = tf.keras.layers.Dropout(0.48)(x)\n\n\nx=tf.keras.layers.Dense(2, activation='softmax')(x)\n       \n\nmodel = Model( pre_trained_model.input, x) \nmodel.summary()\n\nmodel.summary()\nopt = Adam(learning_rate=0.0001)#, momentum=0.9\n# Compile the model\n\nMETRICS = ['categorical_accuracy']#, tensorflow.keras.metrics.Precision(name='categorical_precision'),\n           #tensorflow.keras.metrics.Recall(name='categorical_recall')]\nmodel.compile(loss=tf.keras.losses.CategoricalCrossentropy(),#label_smoothing = 0.1\n              optimizer=opt, metrics=METRICS) #[\"categorical_accuracy\"]\n#categorical_crossentropy\n#lr=0.00001\n#plot_model(model, show_shapes=True, to_file='ResNetwork.png')","e984ef92":"from tensorflow.keras.callbacks import ModelCheckpoint, EarlyStopping,ReduceLROnPlateau\n#ModelCheckpoint means save best weights\nmodel_chkpt = ModelCheckpoint('best_mod.h5', save_best_only=True, monitor='accuracy')\nlearning_rate_reduction1 = ReduceLROnPlateau(monitor='loss', \n                                             patience=2, verbose=1, factor=0.5,mode=\"min\", min_lr=0.00001)\nlearning_rate_reduction2 = ReduceLROnPlateau(monitor='val_loss', \n                                             patience=2, verbose=1, factor=0.5,mode=\"min\", min_lr=0.00001)\n\nearly_stopping = EarlyStopping(monitor='val_categorical_accuracy', restore_best_weights=True, patience=28)#False\ncallbacks1=[early_stopping]#,learning_rate_reduction2,learning_rate_reduction1]","d92f36c7":"# FAST_RUN=True\n#if FAST_RUN else 6\nepochs=128 #64\nhistory = model.fit(X_train, y_train, \n          validation_data=(X_test, y_test),\n          epochs=epochs, batch_size=32, shuffle=True, #True  16\n          callbacks=callbacks1\n         )\n#validation_data=(X_test, y_test)  validation_split=0.20,","487b525e":"fig, ax = plt.subplots(1,2, figsize=(12, 3))\nax[0].plot(history.history['loss'], color='b', label=\"Training loss\")\nax[0].plot(history.history['val_loss'], color='r', label=\"validation loss\",axes =ax[0])\nlegend = ax[0].legend(loc='best', shadow=True)\n\nax[1].plot(history.history['categorical_accuracy'], color='b', label=\"Training accuracy\")\nax[1].plot(history.history['val_categorical_accuracy'], color='r',label=\"Validation accuracy\")\nlegend = ax[1].legend(loc='best', shadow=True)","eea8a2d7":"import plotly.express as px\npx.line(history.history, y=['categorical_accuracy', 'val_categorical_accuracy'],title=\"Training accuracy\")","c364caf6":"import plotly.express as px\npx.line(history.history, y=['loss', 'val_loss'], title=\"Training loss\")","2c437fe6":"ModelLoss, ModelAccuracy = model.evaluate(X_test,y_test,batch_size=32)#,precision, recall\nprint('Test Loss is {}'.format(ModelLoss))\nprint('Test Accuracy is {}'.format(ModelAccuracy ))","fba57288":"import sklearn.metrics as metrics\nfrom sklearn.model_selection import cross_val_score\nimport tensorflow as tf\nplt.figure()\nax = plt.subplot()\nax.set_title('Confusion Matrix')\n#pred = model.predict_classes(X_test) #we can't using this function because not founding in Function Model\npred = model.predict(X_test)\npred = np.argmax(pred, axis=1)\nY_TEST = np.argmax(y_test, axis =1)\n# cm = metrics.confusion_matrix(Y_TEST,pred)\n# print(cm)\ncm = tf.math.confusion_matrix(\n    Y_TEST, pred, num_classes=2, weights=None, dtype=tf.dtypes.int32,\n    name=None\n)\nprint(cm)\n\nclasses=['Benign', 'Ransomware']\nsns.heatmap(cm, annot=True,xticklabels=classes, yticklabels=classes,cmap='Blues')#YlGnBu_r or Blues or twilight_shifted_r\nprint('Number of images:',Y_TEST.shape)\nprint('Actual image ',Y_TEST[0:21])\nprint('Predic image ',pred[0:21])\nplt.xlabel('Predicted')\nplt.ylabel('Actual')\nplt.show","475e8a20":"from sklearn.metrics import classification_report\nprint(classification_report(Y_TEST, pred))\n\n#support : means number each classifier","4fc15f4d":"from sklearn.preprocessing import label_binarize\nfrom sklearn.metrics import precision_recall_curve\n# precision recall curve\nprecision = dict()\nrecall = dict()\nPRED = to_categorical(pred)\ny = y_test\n#Df['label'].values\n# Binarize the output\ny = label_binarize(y, classes=[0,1])\nn_classes = y.shape[1]\n\nfor i in range(n_classes):\n    precision[i], recall[i], _ = precision_recall_curve(y_test[:, i],\n                                                        PRED[:, i])\n    plt.plot(recall[i], precision[i], lw=2, label='class {}'.format(i))\n\nplt.xlabel(\"recall\")\nplt.ylabel(\"precision\")\nplt.legend(loc=\"best\")\nplt.title(\"precision vs. recall curve\")\nplt.show()","c3713356":"from sklearn.preprocessing import label_binarize\nfrom sklearn.metrics import roc_curve, auc\n\nPRED = to_categorical(pred)\ny = y_test\n#Df['label'].values\n# Binarize the output\ny = label_binarize(y, classes=[0,1])\nn_classes = y.shape[1]\n\nfpr = dict()\ntpr = dict()\nroc_auc = dict()\nfor i in range(n_classes):\n       fpr[i], tpr[i], _ = roc_curve(y_test[:,i], PRED[:,i])\n       roc_auc[i] = auc(fpr[i], tpr[i])\ncolors = ['blue', 'red', 'green']\n#cls = {1:'normal', 2:'other pneumonia', 0:'covid'}\ncls = {0:'covid', 1:'normal', 2:'other pneumonia'}\nfor i, color ,c in zip(range(n_classes), colors, cls.values()):\n    plt.plot(fpr[i], tpr[i], color=color, lw=1.5,\n             label='ROC curve of '+c+ '(AUC = {1:0.2f})'\n             ''.format(i, roc_auc[i]))\n    \nplt.plot([0, 1], [0, 1], 'k--',linestyle='--')\nplt.xlim([-0.05, 1.0])\nplt.ylim([0.0, 1.05])\nplt.xlabel('False Positive Rate')\nplt.ylabel('True Positive Rate')\nplt.title('ROC for multi-class data')\nplt.legend(loc=\"lower right\")\nplt.show()","1643b42b":"import matplotlib.pyplot as plt\nplt.style.use('fivethirtyeight')\n\n#precision, recall, _ = precision_recall_curve(Y_test, PRED)\nfor i in range(n_classes):\n    precision[i], recall[i], _ = precision_recall_curve(y_test[:, i],\n                                                        PRED[:, i])\n   # plt.plot(recall[i], precision[i], lw=2, label='class {}'.format(i))\n    #fig, ax = plt.subplots(1, figsize=(6,3))\n    plt.step(recall[i], precision[i],where='post', lw=2 ,label='class {}'.format(i))\n    #plt.fill_between(recall[i], precision[i], step='post', color='lightgray')\n    \nplt.suptitle('Precision-Recall Tradeoff')\nplt.xlabel('Recall')\nplt.ylabel('Precision')\nplt.legend(loc=\"best\")\nplt.show()\n","f3056a66":"from sklearn.metrics import roc_auc_score\n\nroc_auc_score(y_test, PRED)","df75c4bd":"from sklearn.metrics import log_loss\nlog_loss(y_test, PRED)","25546443":"from sklearn.metrics import accuracy_score\n\nprint('accuracy_score     :',accuracy_score(Y_TEST,pred,normalize=True)) # fraction of all Trues over everything normalize by default is true\n#print('number of all Trues:',accuracy_score(Y_TEST,pred, normalize=False)) #number of all Trues\nprint('Number of images   :',Y_TEST.shape)","e2e64807":"\nfrom sklearn.metrics import recall_score\n# recall_score(y_true, y_pred, labels=None, pos_label=1, average=\u2019binary\u2019, sample_weight=None)\n\nRecallScore = recall_score(Y_TEST, pred, average='micro') #it can be : binary,macro,weighted,samples\nprint('Recall Score(Sensitivity) is : ', RecallScore)","efdd3825":"from sklearn.metrics import precision_score\n\n# precision_score(y_true, y_pred, labels=None, pos_label=1, average=\u2019binary\u2019,sample_weight=None)\nPrecisionScore = precision_score(Y_TEST, pred, average='micro') #it can be : binary,macro,weighted,samples\nprint('Precision Score is : ', PrecisionScore)","eb28a6c7":"## ====================================================================================","f65e59f4":"![alt text](https:\/\/miro.medium.com\/max\/712\/1*Z54JgbS4DUwWSknhDCvNTQ.png)"}}