{"cell_type":{"5f52bfad":"code","f8f2107b":"code","1eb4334e":"code","288ccfd0":"code","9f4df816":"code","6d300b70":"code","f50cdeb9":"code","3982c437":"code","5a8809ef":"code","91f988a1":"code","75a08751":"code","4cc915e5":"code","704f6362":"code","1306d060":"code","888e0601":"code","0e7d2503":"code","108f6d42":"code","5ffcf539":"code","456bb918":"code","16b714c6":"code","fd37a14c":"code","2084300a":"code","f63cf4bb":"code","98f43f9f":"code","f196dc1c":"code","e4a10ae6":"code","3c83f27b":"code","c8334429":"code","2ff9a821":"code","ec174951":"code","ea0eea09":"code","0b6025ce":"code","bbabdf5a":"markdown","449bb065":"markdown","26d56ccf":"markdown","0a005b08":"markdown","40d25402":"markdown","fe33fd48":"markdown","0e88ccd1":"markdown","b02e935e":"markdown","27996d4c":"markdown","04f0d8fc":"markdown","4c13a202":"markdown"},"source":{"5f52bfad":"# import modules\nimport numpy as np\nimport matplotlib.pyplot as plt\nimport pandas as pd\nimport seaborn as sns\nimport datetime","f8f2107b":"# read the cleaned dataframe\ndf = pd.read_csv(\"..\/input\/covid-cases-deaths-vaccine-doses-23082021\/covid_data_cleaned.csv\")","1eb4334e":"# A few issues need to be resolved before EDA, the date needs to be parsed again\ndf.date_parsed = pd.to_datetime(df.date_parsed, format=\"%Y\/%m\/%d\")\n\n# extract the country list\ncountry_list = df.Country.unique()","288ccfd0":"# Function, create a dataframe for new cases in given countries\ndef new_cases_df(countries):\n    index_col=df.date_parsed.unique()\n    country_dict = {}\n    for c in countries:\n        country_dict[c] = list(df[df.Country == c][\"New_cases_per_100\"])\n    return pd.DataFrame(country_dict, index=index_col)\n\n# Give the plot for the dataframe above \ndef new_cases_timeplot(countries):\n    plt.figure(figsize=(16,6))\n    sns.lineplot(data=new_cases_df(countries))\n    plt.title(\"New cases per 100 in selected countries\")\n    plt.xlabel(\"Months\")\n    plt.ylabel(\"New cases per 100\")\n    plt.show()","9f4df816":"# do the same for new deaths\ndef new_deaths_df(countries):\n    index_col=df.date_parsed.unique()\n    country_dict = {}\n    for c in countries:\n        country_dict[c] = list(df[df.Country == c][\"New_deaths_per_100\"])\n    return pd.DataFrame(country_dict, index=index_col)\n\ndef new_deaths_timeplot(countries):\n    plt.figure(figsize=(16,6))\n    sns.lineplot(data=new_deaths_df(countries))\n    plt.title(\"New deaths per 100 in selected countries\")\n    plt.xlabel(\"Months\")\n    plt.ylabel(\"New deaths per 100\")\n    plt.show()","6d300b70":"# cumulative cases\ndef cul_cases_df(countries):\n    index_col=df.date_parsed.unique()\n    country_dict = {}\n    for c in countries:\n        country_dict[c] = list(df[df.Country == c][\"Cumulative_cases_per_100\"])\n    return pd.DataFrame(country_dict, index=index_col)\n\ndef cul_cases_timeplot(countries):\n    plt.figure(figsize=(16,6))\n    sns.lineplot(data=cul_cases_df(countries))\n    plt.title(\"Cumulative cases per 100 in selected countries\")\n    plt.xlabel(\"Months\")\n    plt.ylabel(\"Cumulative cases per 100\")\n    plt.show()","f50cdeb9":"# cumulative cases\ndef cul_cases_df(countries):\n    index_col=df.date_parsed.unique()\n    country_dict = {}\n    for c in countries:\n        country_dict[c] = list(df[df.Country == c][\"Cumulative_cases_per_100\"])\n    return pd.DataFrame(country_dict, index=index_col)\n\ndef cul_cases_timeplot(countries):\n    plt.figure(figsize=(16,6))\n    sns.lineplot(data=cul_cases_df(countries))\n    plt.title(\"Cumulative cases per 100 in selected countries\")\n    plt.xlabel(\"Months\")\n    plt.ylabel(\"Cumulative cases per 100\")\n    plt.show()","3982c437":"# cumulative deaths\ndef cul_deaths_df(countries):\n    index_col=df.date_parsed.unique()\n    country_dict = {}\n    for c in countries:\n        country_dict[c] = list(df[df.Country == c][\"Cumulative_deaths_per_100\"])\n    return pd.DataFrame(country_dict, index=index_col)\n\ndef cul_deaths_timeplot(countries):\n    plt.figure(figsize=(16,6))\n    sns.lineplot(data=cul_deaths_df(countries))\n    plt.title(\"Cumulative deaths per 100 in selected countries\")\n    plt.xlabel(\"Months\")\n    plt.ylabel(\"Cumulative deaths per 100\")\n    plt.show()","5a8809ef":"# and cumulative vaccinations\ndef vacc_df(countries):\n    index_col=df.date_parsed.unique()\n    country_dict = {}\n    for c in countries:\n        country_dict[c] = list(df[df.Country == c][\"total_vaccinations_per_hundred\"])\n    return pd.DataFrame(country_dict, index=index_col)\n\ndef vacc_timeplot(countries):\n    plt.figure(figsize=(16,6))\n    sns.lineplot(data=vacc_df(countries))\n    plt.title(\"Vaccine doses given per 100 in selected countries\")\n    plt.xlabel(\"Months\")\n    plt.ylabel(\"Vaccine doses given per 100\")\n    plt.show()","91f988a1":"# Example: Compare UK, India, Italy, and Malaysia (can be replaced by any list of countries in country_list)\nselected_countries = [\"United Kingdom\", \"India\", \"Italy\",\"Malaysia\"]\nnew_cases_timeplot(selected_countries)","75a08751":"new_deaths_timeplot(selected_countries)","4cc915e5":"cul_cases_timeplot(selected_countries)","704f6362":"cul_deaths_timeplot(selected_countries)","1306d060":"vacc_timeplot(selected_countries)","888e0601":"# combines new cases and deaths of a single country\ndef cases_deaths(country):\n    df_cases_deaths = new_cases_df([country]).join(new_deaths_df([country]), lsuffix='_Cases', rsuffix='_Deaths')\n    df_cases_deaths = (df_cases_deaths-df_cases_deaths.mean())\/df_cases_deaths.std()\n    return df_cases_deaths\n","0e7d2503":"# try to shift cases to achieve better correlation\ndef df_derived_by_shift(df,lag=0,NON_DER=[]):\n    df = df.copy()\n    if not lag:\n        return df\n    cols ={}\n    for i in range(1,lag+1):\n        for x in list(df.columns):\n            if x not in NON_DER:\n                if not x in cols:\n                    cols[x] = ['{}_{}'.format(x, i)]\n                else:\n                    cols[x].append('{}_{}'.format(x, i))\n    for k,v in cols.items():\n        columns = v\n        dfn = pd.DataFrame(data=None, columns=columns, index=df.index)    \n        i = 1\n        for c in columns:\n            dfn[c] = df[k].shift(periods=i)\n            i+=1\n        df = pd.concat([df, dfn], axis=1)\n    return df\n","108f6d42":"df_uk = cases_deaths(\"United Kingdom\").reset_index().rename(columns={\"index\": \"Date\"})\ndf_uk_lagged = df_derived_by_shift(df_uk, 30, [\"Date\"]).set_index(\"Date\")\ndf_uk_lagged","5ffcf539":"# now consider the correlation matrix\ncorr = df_uk_lagged.corr()\ncorr","456bb918":"# Want the maximum correlation between deaths and a lagged case number\ncase_lag = corr.loc[\"United Kingdom_Cases_1\":\"United Kingdom_Cases_30\", \"United Kingdom_Deaths\"].sort_values(ascending=False)","16b714c6":"# the lag that produces the highest correlation\ncase_lag.index[0][-2:]","fd37a14c":"# Get the vaccination column into play\ndf_uk_lagged_with_vacc = df_uk_lagged.join(vacc_df([\"United Kingdom\"]))\ndf_uk_lagged_with_vacc.rename(columns={\"United Kingdom\": \"Vaccine per 100\"}, inplace=True)","2084300a":"# Use the 21st lag (best correlation) to produce a plot\nplt.figure(figsize=(16,16))\nsns.regplot(x=df_uk_lagged_with_vacc.loc[df_uk_lagged_with_vacc[\"Vaccine per 100\"] == 0][\"United Kingdom_Cases_21\"],\n            y=df_uk_lagged_with_vacc.loc[df_uk_lagged_with_vacc[\"Vaccine per 100\"] == 0][\"United Kingdom_Deaths\"],\n            label=\"no vaccine\",\n           scatter=False)\nsns.regplot(x=df_uk_lagged_with_vacc.loc[df_uk_lagged_with_vacc[\"Vaccine per 100\"] > 0].loc[df_uk_lagged_with_vacc[\"Vaccine per 100\"] <= 10][\"United Kingdom_Cases_21\"],\n            y=df_uk_lagged_with_vacc.loc[df_uk_lagged_with_vacc[\"Vaccine per 100\"] > 0].loc[df_uk_lagged_with_vacc[\"Vaccine per 100\"] <= 10][\"United Kingdom_Deaths\"],\n           label=\"low vaxxed population\",\n           scatter=False\n           )\nsns.regplot(x=df_uk_lagged_with_vacc.loc[df_uk_lagged_with_vacc[\"Vaccine per 100\"] > 10].loc[df_uk_lagged_with_vacc[\"Vaccine per 100\"] <= 60][\"United Kingdom_Cases_21\"],\n            y=df_uk_lagged_with_vacc.loc[df_uk_lagged_with_vacc[\"Vaccine per 100\"] > 10].loc[df_uk_lagged_with_vacc[\"Vaccine per 100\"] <= 60][\"United Kingdom_Deaths\"],\n           label=\"medium vaxxed population\",\n           scatter=False)\nsns.regplot(x=df_uk_lagged_with_vacc.loc[df_uk_lagged_with_vacc[\"Vaccine per 100\"] > 60].loc[df_uk_lagged_with_vacc[\"Vaccine per 100\"] <= 100][\"United Kingdom_Cases_21\"],\n            y=df_uk_lagged_with_vacc.loc[df_uk_lagged_with_vacc[\"Vaccine per 100\"] > 60].loc[df_uk_lagged_with_vacc[\"Vaccine per 100\"] <= 100][\"United Kingdom_Deaths\"],\n           label=\"high vaxxed population\",\n           scatter=False)\nsns.regplot(x=df_uk_lagged_with_vacc.loc[df_uk_lagged_with_vacc[\"Vaccine per 100\"] > 100][\"United Kingdom_Cases_21\"],\n            y=df_uk_lagged_with_vacc.loc[df_uk_lagged_with_vacc[\"Vaccine per 100\"] > 100][\"United Kingdom_Deaths\"],\n           label=\"very high vaxxed population\",\n           scatter=False)\nplt.xlabel(\"Cases per 100 (lagged)\")\nplt.ylabel(\"Deaths per 100\")\nplt.title(\"Cases versus Deaths in Different Vaccination Stage\")\nplt.legend()\nplt.show()","f63cf4bb":"# First compute the lagged correlation in the given country by introduce a function\ndef lag_corr(country):\n    df_c = cases_deaths(country).reset_index().rename(columns={\"index\": \"Date\"})\n    df_c_lagged = df_derived_by_shift(df_c, 60, [\"Date\"]).set_index(\"Date\")\n    corr = df_c_lagged.corr()\n    case_lag = corr.loc[country+\"_Cases_1\":country+\"_Cases_60\", country+\"_Deaths\"].sort_values(ascending=False)\n    return case_lag.index[0][-2:].replace(\"_\", \"\")\n","98f43f9f":"# use the lag to define the next function\ndef case_death_plot(country):\n    df_c = cases_deaths(country).reset_index().rename(columns={\"index\": \"Date\"})\n    df_c_lagged = df_derived_by_shift(df_c, 30, [\"Date\"]).set_index(\"Date\")\n    df_c_lagged_with_vacc = df_c_lagged.join(vacc_df([country]))\n    df_c_lagged_with_vacc.rename(columns={country: \"Vaccine per 100\"}, inplace=True)\n    plt.figure(figsize=(16,16))\n    plt.xlim(0, None)\n    sns.regplot(x=df_c_lagged_with_vacc.loc[df_c_lagged_with_vacc[\"Vaccine per 100\"] == 0][country+\"_Cases_\"+lag_corr(country)],\n                y=df_c_lagged_with_vacc.loc[df_c_lagged_with_vacc[\"Vaccine per 100\"] == 0][country+\"_Deaths\"],\n                label=\"no vaccine\",\n                truncate=False,\n                scatter=False)\n    sns.regplot(x=df_c_lagged_with_vacc.loc[df_c_lagged_with_vacc[\"Vaccine per 100\"] > 0].loc[df_c_lagged_with_vacc[\"Vaccine per 100\"] <= 10][country+\"_Cases_\"+lag_corr(country)],\n                y=df_c_lagged_with_vacc.loc[df_c_lagged_with_vacc[\"Vaccine per 100\"] > 0].loc[df_c_lagged_with_vacc[\"Vaccine per 100\"] <= 10][country+\"_Deaths\"],\n               label=\"low vaxxed population\",\n               truncate=False,\n               scatter=False)\n    sns.regplot(x=df_c_lagged_with_vacc.loc[df_c_lagged_with_vacc[\"Vaccine per 100\"] > 10].loc[df_c_lagged_with_vacc[\"Vaccine per 100\"] <= 60][country+\"_Cases_\"+lag_corr(country)],\n                y=df_c_lagged_with_vacc.loc[df_c_lagged_with_vacc[\"Vaccine per 100\"] > 10].loc[df_c_lagged_with_vacc[\"Vaccine per 100\"] <= 60][country+\"_Deaths\"],\n               label=\"medium vaxxed population\",\n               truncate=False,\n               scatter=False)\n    sns.regplot(x=df_c_lagged_with_vacc.loc[df_c_lagged_with_vacc[\"Vaccine per 100\"] > 60].loc[df_c_lagged_with_vacc[\"Vaccine per 100\"] <= 100][country+\"_Cases_\"+lag_corr(country)],\n                y=df_c_lagged_with_vacc.loc[df_c_lagged_with_vacc[\"Vaccine per 100\"] > 60].loc[df_c_lagged_with_vacc[\"Vaccine per 100\"] <= 100][country+\"_Deaths\"],\n               label=\"high vaxxed population\",\n               truncate=False,\n               scatter=False)\n    sns.regplot(x=df_c_lagged_with_vacc.loc[df_c_lagged_with_vacc[\"Vaccine per 100\"] > 100][country+\"_Cases_\"+lag_corr(country)],\n                y=df_c_lagged_with_vacc.loc[df_c_lagged_with_vacc[\"Vaccine per 100\"] > 100][country+\"_Deaths\"],\n               label=\"very high vaxxed population\",\n               truncate=False,\n               scatter=False)\n    plt.xlabel(\"Cases per 100 (lagged)\")\n    plt.ylabel(\"Deaths per 100\")\n    plt.title(\"Cases versus Deaths in Different Vaccination Stage for \"+country)\n    plt.legend()\n    plt.show()\n    \n    ","f196dc1c":"# A few Examples\ncase_death_plot(\"India\")","e4a10ae6":"case_death_plot(\"Italy\")","3c83f27b":"case_death_plot(\"United Kingdom\")","c8334429":"case_death_plot(\"United States\")","2ff9a821":"case_death_plot(\"South Africa\")","ec174951":"case_death_plot(\"Canada\")","ea0eea09":"case_death_plot(\"China\")","0b6025ce":"case_death_plot(\"Australia\")","bbabdf5a":"The function is now complete, I will apply it to a couple of countries to try to see a trend.","449bb065":"The dataframe saved from last time changed the date back to objects, so I need to parse them again.","26d56ccf":"For all these countries, we can see that as the vaccination increases, the gradient of case to death is decreasing in most cases. This shows that high vaccination number tends to a lower death rate. However, exceptional cases tend to appear in the low or medium vaccination rates. This is likely due to the fact that most infected people are not vaccinated, an ease of quarantine laws in the country, or an outbreak due to another country. Nevertheless, we can conclude that once the vaccination rate is high enough, it can effectively lower the death rate even if the case number is high.","0a005b08":"Now, I want to analyse the relationship between new cases and deaths, in a single country, under different vaccination stage. The new cases and new deaths columns will be useful. For clarity, I will standardise the distribution of the new cases\/deaths.","40d25402":"Firstly, I am going to create a few functions that will help comparing the data from different countries.","fe33fd48":"As an experiment, I'm using a specific country to test the code (UK), and attempt to draw a graph.","0e88ccd1":"The following function is created by Andr\u00e9 Ara\u00fajo. It allows time lag for each column of the given dataframe. Since an increase in case number will not immediately cause an increase in death number, but rather with a time lag. It will be useful to find a better (lagged) correlation between the two.\n\nSource: https:\/\/www.kaggle.com\/dedecu\/cross-correlation-time-lag-with-pandas","b02e935e":"Now I will do it in the general case.","27996d4c":"The following plot allows us to see the relationship between case and death number in the UK, under different vaccination stages.","04f0d8fc":"In this notebook, I will continue from the last part and do some data visualisation.","4c13a202":"As a test to the function, I will compare UK, India, Italy, and Malaysia, but the function should work for any list of countries"}}