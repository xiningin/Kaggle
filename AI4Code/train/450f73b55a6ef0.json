{"cell_type":{"717ce4af":"code","78da20c1":"code","3841d2eb":"code","8f3d59a3":"code","944b10f9":"code","662fb738":"code","f9d0b289":"code","42d6abc3":"code","717433fa":"code","36f1d4b0":"code","7841f50d":"code","fd8cb4fb":"code","9501f25b":"code","59cd83ad":"code","e199a97c":"markdown","7a613739":"markdown","9a7a2a5a":"markdown","979f2b8d":"markdown","17667f05":"markdown","736aae06":"markdown","9e1e9d16":"markdown","3e70c2cc":"markdown","d5aedd71":"markdown","4c82c671":"markdown"},"source":{"717ce4af":"#!pip install transformers","78da20c1":"import numpy as np\nimport pandas as pd\n\nimport matplotlib\nimport matplotlib.pyplot as plt\n\nfrom sklearn.model_selection import train_test_split\nfrom sklearn.linear_model import LogisticRegression\nfrom sklearn.model_selection import GridSearchCV\nfrom sklearn.model_selection import cross_val_score\nfrom sklearn.metrics import accuracy_score\n\nimport torch\nimport transformers as ppb\n\nimport warnings\nwarnings.filterwarnings('ignore')","3841d2eb":"df = pd.read_csv('..\/input\/nlp-reports-news-classification\/water_problem_nlp_ua_for_Kaggle_100.csv', delimiter=';', \n                 header=0, encoding='cp1251')\ndf = df.fillna(0)\n\nconvert_dict = {'text': str, \n                'env_problems': int,\n                'pollution': int, \n                'treatment': int,\n                'climate': int,\n                'biomonitoring': int} \n  \ndf = df.astype(convert_dict)\ndf = df.sample(frac=1).reset_index(drop=True)\ndf","8f3d59a3":"df.info()","944b10f9":"# For pre-trained DistilBERT:\nmodel_class, tokenizer_class, pretrained_weights = (ppb.DistilBertModel, ppb.DistilBertTokenizer, 'distilbert-base-multilingual-cased')\n\n# Other models: https:\/\/huggingface.co\/transformers\/pretrained_models.html\n\n# Load pretrained model\/tokenizer\ntokenizer = tokenizer_class.from_pretrained(pretrained_weights)\nmodel = model_class.from_pretrained(pretrained_weights)","662fb738":"# Tokenization the sentences - break them up into word and subwords in the format BERT is comfortable with\ntokenized = df['text'].apply((lambda x: tokenizer.encode(x, add_special_tokens=True)))\n\nmax_len = 0\nfor i in tokenized.values:\n    if len(i) > max_len:\n        max_len = len(i)\n\npadded = np.array([i + [0]*(max_len-len(i)) for i in tokenized.values])\nnp.array(padded).shape","f9d0b289":"# Creation variable to ignore (mask) the data padding\nattention_mask = np.where(padded != 0, 1, 0)\nprint(attention_mask.shape)\nattention_mask","42d6abc3":"# Modeling\ninput_ids = torch.tensor(padded).to(torch.int64)\nattention_mask = torch.tensor(attention_mask).to(torch.int64)\n\nwith torch.no_grad():\n    last_hidden_states = model(input_ids, attention_mask=attention_mask)","717433fa":"# Last hidden states\nfeatures = last_hidden_states[0][:,0,:].numpy()","36f1d4b0":"def target_prediction(df, features, target, test_size=0.2):\n    # Text classification model and prediction for given feature \"target\" (with labels) in df\n    \n    # Target\n    labels = df[target]\n    \n    # EDA\n    print()\n    # Extracting the number of examples of each class\n    Relevant_len = df[df[target] == 1].shape[0]\n    Not_len = df[df[target] == 0].shape[0]\n    # Draw bar plot\n    plt.rcParams['figure.figsize'] = (7, 5)\n    plt.bar(10, Relevant_len, 3, label=\"Relevant\", color='green')\n    plt.bar(15, Not_len, 3, label=\"Not\", color='red')\n    plt.legend(loc='upper center')\n    plt.ylabel('Number of examples')\n    plt.title('Propertion of examples for ' + target)\n    plt.show()\n    \n    # Train, test split \n    test_start = int(len(df)*(1-test_size))\n    train_features = features[:test_start]\n    test_features = features[test_start:]\n    train_labels = labels[:test_start]\n    test_labels = labels[test_start:]\n    df_test = df[test_start:]\n    #print(test_start, train_features.shape, len(train_labels), df_test.shape)\n    \n    # Train a simple model\n    print(f'Classification for {target}:')\n    parameters = {'C': np.linspace(0.0001, 100, 20)}\n    model = GridSearchCV(LogisticRegression(), parameters)\n    model.fit(train_features, train_labels)\n\n    print('best parameters: ', model.best_params_)\n    print('best scores: ', model.best_score_)\n    \n    # Test prediction\n    test_pred = model.predict(test_features)\n    print('Score of the test prediction -', accuracy_score(test_labels, test_pred))\n    df_test['pred'] = test_pred\n    \n    test_proba_pred = model.predict_proba(test_features)\n    print('Predict_proba for test dataset:')\n    df_test['predict_proba'] = test_proba_pred[:,1]\n    df_test['predict_proba'] = df_test['predict_proba'].round(2)\n    display(df_test[['text', target, 'pred', 'predict_proba']])\n    print('\\n\\n')\n    return df_test\n#test_features, test_pred, test_proba_pred","7841f50d":"# List of the target features in df\ncols = df.columns.tolist()[1:]\nprint('Target columns:', cols)","fd8cb4fb":"pd.set_option('display.max_colwidth', 200)","9501f25b":"%%time\n# Solving NLP Classification tasks\nprint('Solving NLP Classification tasks')\nfor col in cols:\n    target_prediction(df, features, col, test_size=0.4)","59cd83ad":"#df_test = target_prediction(df, features, 'env_problems', test_size=0.4)","e199a97c":"I hope you find this kernel useful and enjoyable.","7a613739":"Your comments and feedback are most welcome.","9a7a2a5a":"## 4. Text Classification and Predict_proba<a class=\"anchor\" id=\"4\"><\/a>\n\n[Back to Table of Contents](#0.1)","979f2b8d":"[Go to Top](#0)","17667f05":"# Acknowledgements\n\nThis notebook uses such good notebooks: \n* BERT model from the paper with notebook [A Visual Guide to Using BERT for the First Time](http:\/\/jalammar.github.io\/a-visual-guide-to-using-bert-for-the-first-time\/)\n* EDA from the notebook [NLP - EDA, Bag of Words, TF IDF, GloVe, BERT](https:\/\/www.kaggle.com\/vbmokin\/nlp-eda-bag-of-words-tf-idf-glove-bert)\n* Classification model from the notebook [Heart Disease - Automatic AdvEDA & FE & 20 models](https:\/\/www.kaggle.com\/vbmokin\/heart-disease-automatic-adveda-fe-20-models)\n* similar my notebook [NLP for EN : BERT Classification for Water Report](https:\/\/www.kaggle.com\/vbmokin\/nlp-for-en-bert-classification-for-water-report)\n\nMy dataset [NLP : Reports & News Classification](https:\/\/www.kaggle.com\/vbmokin\/nlp-reports-news-classification)\n\nSource of models:\nhttps:\/\/huggingface.co\/transformers\/pretrained_models.html","736aae06":"<a class=\"anchor\" id=\"0\"><\/a>\n# [NLP : Reports & News Classification](https:\/\/www.kaggle.com\/vbmokin\/nlp-reports-news-classification)\n## Automatic Environmental Reports & News Classification (Ukranian) - Predict_proba","9e1e9d16":"## 3. BERT: Data Prepairing and Modeling <a class=\"anchor\" id=\"3\"><\/a>\n\n[Back to Table of Contents](#0.1)","3e70c2cc":"## 1. Import libraries <a class=\"anchor\" id=\"1\"><\/a>\n\n[Back to Table of Contents](#0.1)","d5aedd71":"<a class=\"anchor\" id=\"0.1\"><\/a>\n## Table of Contents\n\n1. [Import libraries](#1)\n1. [Download data](#2)\n1. [BERT: Data Prepairing and Modeling](#3)\n1. [Text Classification and Predict_proba](#4)","4c82c671":"## 2. Download data <a class=\"anchor\" id=\"2\"><\/a>\n\n[Back to Table of Contents](#0.1)"}}