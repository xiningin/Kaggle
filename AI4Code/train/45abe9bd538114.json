{"cell_type":{"526bd4aa":"code","470490f8":"code","ef058707":"code","762a8b1d":"code","627f3be7":"code","f76f0be4":"code","ec44e981":"code","89fd1c68":"code","343f11aa":"code","ed103c12":"code","43531f60":"code","2898afd4":"code","026c1971":"code","77b172db":"code","7fa6f55b":"code","70261fda":"code","7b312898":"code","2049c29c":"code","4754c9ed":"code","a47cbfd2":"code","6f7a97f4":"code","cf096364":"code","3ed420c6":"code","1a9c7943":"code","e86fe7dc":"code","77d17150":"code","008fd5d2":"code","fc89450c":"code","45423a45":"code","b81eae8e":"code","08a7a864":"code","a1a46071":"code","200e66f6":"code","654c13e5":"markdown","a89adf38":"markdown","654b171e":"markdown","98385686":"markdown","410a9fae":"markdown","3b6f339d":"markdown","7641b06d":"markdown","9ca181ab":"markdown","41271c65":"markdown","6fe85d3e":"markdown","00372d12":"markdown","fcceb66f":"markdown","f43c8a78":"markdown","1d400cb1":"markdown","cf50a62a":"markdown","490e24d3":"markdown","4b1c43b8":"markdown","ce6f85f9":"markdown","712c1771":"markdown","1fc82e85":"markdown","dca34b37":"markdown","21173a38":"markdown","613709db":"markdown","b1c92cf2":"markdown","33a1fc83":"markdown","86bcef8f":"markdown","52dad239":"markdown","5d0e7d80":"markdown","cc5036cd":"markdown","c4b388ec":"markdown"},"source":{"526bd4aa":"import numpy as np\nimport pandas as pd \nfrom keras.preprocessing.image import ImageDataGenerator, load_img\nfrom keras.utils import to_categorical\nfrom sklearn.model_selection import train_test_split\nimport matplotlib.pyplot as plt\nimport random\nimport os\nprint(os.listdir(\"..\/input\"))\n","470490f8":"FAST_RUN = False\nIMAGE_WIDTH=128\nIMAGE_HEIGHT=128\nIMAGE_SIZE=(IMAGE_WIDTH, IMAGE_HEIGHT)\nIMAGE_CHANNELS=3","ef058707":"filenames = os.listdir(\"..\/input\/train\/train\")\ncategories = []\nfor filename in filenames:\n    category = filename.split('.')[0]\n    if category == 'dog':\n        categories.append(1)\n    else:\n        categories.append(0)\n\ndf = pd.DataFrame({\n    'filename': filenames,\n    'category': categories\n})","762a8b1d":"df.head()","627f3be7":"df.tail()","f76f0be4":"df['category'].value_counts().plot.bar()","ec44e981":"sample = random.choice(filenames)\nimage = load_img(\"..\/input\/train\/train\/\"+sample)\nplt.imshow(image)","89fd1c68":"from keras.models import Sequential\nfrom keras.layers import Conv2D, MaxPooling2D, Dropout, Flatten, Dense, Activation, BatchNormalization\n\nmodel = Sequential()\n\nmodel.add(Conv2D(32, (3, 3), activation='relu', input_shape=(IMAGE_WIDTH, IMAGE_HEIGHT, IMAGE_CHANNELS)))\nmodel.add(BatchNormalization())\nmodel.add(MaxPooling2D(pool_size=(2, 2)))\nmodel.add(Dropout(0.25))\n\nmodel.add(Conv2D(64, (3, 3), activation='relu'))\nmodel.add(BatchNormalization())\nmodel.add(MaxPooling2D(pool_size=(2, 2)))\nmodel.add(Dropout(0.25))\n\nmodel.add(Conv2D(128, (3, 3), activation='relu'))\nmodel.add(BatchNormalization())\nmodel.add(MaxPooling2D(pool_size=(2, 2)))\nmodel.add(Dropout(0.25))\n\nmodel.add(Flatten())\nmodel.add(Dense(512, activation='relu'))\nmodel.add(BatchNormalization())\nmodel.add(Dropout(0.5))\nmodel.add(Dense(2, activation='softmax')) # 2 because we have cat and dog classes\n\nmodel.compile(loss='categorical_crossentropy', optimizer='rmsprop', metrics=['accuracy'])\n\nmodel.summary()","343f11aa":"from keras.callbacks import EarlyStopping, ReduceLROnPlateau","ed103c12":"earlystop = EarlyStopping(patience=10)","43531f60":"learning_rate_reduction = ReduceLROnPlateau(monitor='val_acc', \n                                            patience=2, \n                                            verbose=1, \n                                            factor=0.5, \n                                            min_lr=0.00001)","2898afd4":"callbacks = [earlystop, learning_rate_reduction]","026c1971":"df[\"category\"] = df[\"category\"].replace({0: 'cat', 1: 'dog'}) ","77b172db":"train_df, validate_df = train_test_split(df, test_size=0.20, random_state=42)\ntrain_df = train_df.reset_index(drop=True)\nvalidate_df = validate_df.reset_index(drop=True)","7fa6f55b":"train_df['category'].value_counts().plot.bar()","70261fda":"validate_df['category'].value_counts().plot.bar()","7b312898":"total_train = train_df.shape[0]\ntotal_validate = validate_df.shape[0]\nbatch_size=15","2049c29c":"train_datagen = ImageDataGenerator(\n    rotation_range=15,\n    rescale=1.\/255,\n    shear_range=0.1,\n    zoom_range=0.2,\n    horizontal_flip=True,\n    width_shift_range=0.1,\n    height_shift_range=0.1\n)\n\ntrain_generator = train_datagen.flow_from_dataframe(\n    train_df, \n    \"..\/input\/train\/train\/\", \n    x_col='filename',\n    y_col='category',\n    target_size=IMAGE_SIZE,\n    class_mode='categorical',\n    batch_size=batch_size\n)","4754c9ed":"validation_datagen = ImageDataGenerator(rescale=1.\/255)\nvalidation_generator = validation_datagen.flow_from_dataframe(\n    validate_df, \n    \"..\/input\/train\/train\/\", \n    x_col='filename',\n    y_col='category',\n    target_size=IMAGE_SIZE,\n    class_mode='categorical',\n    batch_size=batch_size\n)","a47cbfd2":"example_df = train_df.sample(n=1).reset_index(drop=True)\nexample_generator = train_datagen.flow_from_dataframe(\n    example_df, \n    \"..\/input\/train\/train\/\", \n    x_col='filename',\n    y_col='category',\n    target_size=IMAGE_SIZE,\n    class_mode='categorical'\n)","6f7a97f4":"plt.figure(figsize=(12, 12))\nfor i in range(0, 15):\n    plt.subplot(5, 3, i+1)\n    for X_batch, Y_batch in example_generator:\n        image = X_batch[0]\n        plt.imshow(image)\n        break\nplt.tight_layout()\nplt.show()","cf096364":"epochs=3 if FAST_RUN else 50\nhistory = model.fit_generator(\n    train_generator, \n    epochs=epochs,\n    validation_data=validation_generator,\n    validation_steps=total_validate\/\/batch_size,\n    steps_per_epoch=total_train\/\/batch_size,\n    callbacks=callbacks\n)","3ed420c6":"model.save_weights(\"model.h5\")","1a9c7943":"fig, (ax1, ax2) = plt.subplots(2, 1, figsize=(12, 12))\nax1.plot(history.history['loss'], color='b', label=\"Training loss\")\nax1.plot(history.history['val_loss'], color='r', label=\"validation loss\")\nax1.set_xticks(np.arange(1, epochs, 1))\nax1.set_yticks(np.arange(0, 1, 0.1))\n\nax2.plot(history.history['acc'], color='b', label=\"Training accuracy\")\nax2.plot(history.history['val_acc'], color='r',label=\"Validation accuracy\")\nax2.set_xticks(np.arange(1, epochs, 1))\n\nlegend = plt.legend(loc='best', shadow=True)\nplt.tight_layout()\nplt.show()","e86fe7dc":"test_filenames = os.listdir(\"..\/input\/test1\/test1\")\ntest_df = pd.DataFrame({\n    'filename': test_filenames\n})\nnb_samples = test_df.shape[0]","77d17150":"test_gen = ImageDataGenerator(rescale=1.\/255)\ntest_generator = test_gen.flow_from_dataframe(\n    test_df, \n    \"..\/input\/test1\/test1\/\", \n    x_col='filename',\n    y_col=None,\n    class_mode=None,\n    target_size=IMAGE_SIZE,\n    batch_size=batch_size,\n    shuffle=False\n)","008fd5d2":"predict = model.predict_generator(test_generator, steps=np.ceil(nb_samples\/batch_size))","fc89450c":"test_df['category'] = np.argmax(predict, axis=-1)","45423a45":"label_map = dict((v,k) for k,v in train_generator.class_indices.items())\ntest_df['category'] = test_df['category'].replace(label_map)","b81eae8e":"test_df['category'] = test_df['category'].replace({ 'dog': 1, 'cat': 0 })","08a7a864":"test_df['category'].value_counts().plot.bar()","a1a46071":"sample_test = test_df.head(18)\nsample_test.head()\nplt.figure(figsize=(12, 24))\nfor index, row in sample_test.iterrows():\n    filename = row['filename']\n    category = row['category']\n    img = load_img(\"..\/input\/test1\/test1\/\"+filename, target_size=IMAGE_SIZE)\n    plt.subplot(6, 3, index+1)\n    plt.imshow(img)\n    plt.xlabel(filename + '(' + \"{}\".format(category) + ')' )\nplt.tight_layout()\nplt.show()","200e66f6":"submission_df = test_df.copy()\nsubmission_df['id'] = submission_df['filename'].str.split('.').str[0]\nsubmission_df['label'] = submission_df['category']\nsubmission_df.drop(['filename', 'category'], axis=1, inplace=True)\nsubmission_df.to_csv('submission.csv', index=False)","654c13e5":"# Predict","a89adf38":"# Callbacks","654b171e":"# Traning Generator","98385686":"* **Input Layer**: It represent input image data. It will reshape image into single diminsion array. Example your image is 64x64 = 4096, it will convert to (4096,1) array.\n* **Conv Layer**: This layer will extract features from image.\n* **Pooling Layer**: This layerreduce the spatial volume of input image after convolution.\n* **Fully Connected Layer**: It connect the network from a layer to another layer\n* **Output Layer**: It is the predicted values layer. ","410a9fae":"# Submission","3b6f339d":"# Fit Model","7641b06d":"Seem to be nice ","9ca181ab":"### Virtaulize Result","41271c65":"# Build Model\n\n<img src=\"https:\/\/i.imgur.com\/ebkMGGu.jpg\" width=\"100%\"\/>","6fe85d3e":"# Save Model","00372d12":"# Virtualize Training","fcceb66f":"# See how our generator work","f43c8a78":"Because we will use image genaretor `with class_mode=\"categorical\"`. We need to convert column category into string. Then imagenerator will convert it one-hot encoding which is good for our classification. \n\nSo we will convert 1 to dog and 0 to cat","1d400cb1":"# See sample image","cf50a62a":"We will convert the predict category back into our generator classes by using `train_generator.class_indices`. It is the classes that image generator map while converting data into computer vision","490e24d3":"# Define Constants","4b1c43b8":"# Import Library","ce6f85f9":"### See Total In count","712c1771":"# Prepare Testing Data","1fc82e85":"### Validation Generator","dca34b37":"This Kernel for someone want to deep dive into image classification. I use CNN for classification model. If you found this Kernel helpful please up vote it. If you have some feedback and question don't forget to comment below. \n\nI have simplier model with \n* https:\/\/www.kaggle.com\/uysimty\/get-start-image-classification","21173a38":"# Prepare data","613709db":"From our prepare data part. We map data with `{1: 'dog', 0: 'cat'}`. Now we will map the result back to dog is 1 and cat is 0","b1c92cf2":"**Early Stop**\n\nTo prevent over fitting we will stop the learning after 10 epochs and val_loss value not decreased","33a1fc83":"# Create Testing Generator","86bcef8f":"**Learning Rate Reduction**\n\nWe will reduce the learning rate when then accuracy not increase for 2 steps","52dad239":"### See predicted result with images","5d0e7d80":"From our data we have 12000 cats and 12000 dogs","cc5036cd":"For categoral classication the prediction will come with probability of each category. So we will pick the category that have the highest probability with numpy average max","c4b388ec":"# Prepare Traning Data"}}