{"cell_type":{"f30fb508":"code","b544def6":"code","1b6c02b2":"code","6f37c594":"code","64407869":"code","427522f2":"code","a80459dc":"code","005e5847":"code","c46ae00b":"code","0ddf551d":"code","3966d35d":"code","dc127dc8":"code","b2821bb5":"code","85ec3e25":"code","8152bf15":"code","11d3e168":"code","d64b3488":"code","ae44951d":"code","c90199d4":"code","6b58333b":"code","565e979a":"code","12211426":"code","539e7297":"code","38352d33":"code","fb0eae7c":"code","0862f333":"code","a40e827e":"code","0844c816":"code","5b446b43":"code","c1235e00":"code","4d3e7566":"code","1dd3a528":"code","bd321fd6":"code","587944c3":"code","7068770f":"code","eeb122d3":"code","de6fe060":"code","4bafaece":"code","f6ade668":"code","c63eb656":"code","0e757cbe":"code","cb7239a8":"code","607d30b5":"code","7bc3dba9":"code","4d856778":"code","99a3477d":"code","eeffebf6":"code","33d8ca11":"code","c09e15ef":"code","dc6d57cf":"code","06f1aecc":"code","276e84bf":"code","d5ae28fd":"code","895a942b":"code","31db3eb4":"code","7a089955":"code","15f4061b":"code","6e8ee25d":"code","56b72da2":"code","7fb8da7b":"code","4e5ab018":"code","e99b95b8":"code","a42385b9":"code","efe19803":"code","4cbdd777":"code","82f62f94":"code","96cf45b3":"code","6dc64d9e":"code","3c026370":"code","7bb1ddbd":"code","4efdcd1f":"code","f1e51692":"code","95836db5":"code","243c8c31":"code","8330769e":"code","d7096f84":"code","caa67b43":"code","ab9f784e":"code","c9721456":"code","ba8fff6b":"code","dba6aabf":"code","ffb7c6ef":"code","9a1263f3":"code","6f70a145":"code","3f04fb49":"code","123660a3":"code","06fb1f3e":"code","67b75c25":"code","b6621ce7":"code","586fde38":"code","a062e269":"code","4767040a":"code","bb149dae":"markdown","ff1c57ca":"markdown","714220fc":"markdown","4a44d1b9":"markdown","37a49c1c":"markdown","36d97a54":"markdown","4f0c22d1":"markdown","7bf52d1a":"markdown","6e40520a":"markdown","1a525a04":"markdown","27c2ae5e":"markdown","9dc0e9bf":"markdown","a8cd4a7d":"markdown","ca591ac0":"markdown","cee97de4":"markdown","e5174b30":"markdown","a84a82ed":"markdown","88b37ee4":"markdown","cdb03443":"markdown","dd247ea8":"markdown","8a90e344":"markdown","7c08fa1b":"markdown","9b4b6345":"markdown","cb76c556":"markdown","185b0002":"markdown"},"source":{"f30fb508":"%matplotlib inline\nimport matplotlib.pyplot as plt\nimport seaborn as sns\nimport numpy as np\nimport pandas as pd\npd.set_option('display.max_columns', None)\npd.set_option('display.max_rows', None)\nimport warnings\nwarnings.filterwarnings(\"ignore\")","b544def6":"data = pd.read_csv(\"..\/input\/tmdb-box-office-prediction\/train.csv\")\nprint(data.shape)\ndata.head(n=2)","1b6c02b2":"data_explore = data.copy()","6f37c594":"data_explore.info()","64407869":"data_explore.isna().sum()","427522f2":"data_explore['is_sequel'] = data_explore['belongs_to_collection'].apply(lambda x: 0 if pd.isna(x) else 1).astype('int64')","a80459dc":"def modify_date(x):\n    \"\"\"\n    Given data format is mm\/dd\/YY. This function will extract the year, month and day on which movie is release.\n    \"\"\"\n    x=str(x)\n    year=x.split('\/')[2]\n    if int(year)<20:\n        return x[:-2]+'20'+year\n    else:\n        return x[:-2]+'19'+year\n    \ndata_explore['release_date']=data_explore['release_date'].apply(lambda x: modify_date(x))\ndata_explore['release_year'] = pd.DatetimeIndex(data_explore['release_date']).year\ndata_explore['release_month'] = pd.DatetimeIndex(data_explore['release_date']).month\ndata_explore['release_day'] = pd.DatetimeIndex(data_explore['release_date']).day\ndata_explore['release_dow'] = pd.DatetimeIndex(data_explore['release_date']).dayofweek","005e5847":"drop_cols = ['id', 'belongs_to_collection', 'homepage', 'imdb_id', 'release_date', 'poster_path', 'tagline', 'title']\ndata_explore = data_explore.drop(columns=drop_cols, axis=1)","c46ae00b":"nan_cols = data_explore.isna().sum()\nnan_cols[nan_cols>0]","0ddf551d":"data_explore.describe()","3966d35d":"import ast\ndict_cols = ['genres', 'production_companies', 'production_countries', 'spoken_languages', 'Keywords', 'cast', 'crew']\n\nfor col in dict_cols:\n    data_explore[col] = data_explore[col].apply(lambda x: {} if pd.isna(x) else ast.literal_eval(x))","dc127dc8":"na_cols = data_explore.columns[data_explore.isna().any()].tolist()\nna_cols.remove('overview')\nna_cols.remove('runtime')\ndata_explore['runtime'].fillna(value=data_explore['runtime'].median(), inplace=True)\ndata_explore['overview'].fillna(value='', inplace=True)\nfor col in na_cols:\n    data_explore[col].fillna(value='', inplace=True)","b2821bb5":"def get_names(x, col):\n    \"\"\"\n        Get the name field from each JSON object.\n        For crew field, considering the Director only.\n        For cast field, considering the first 3 cast members. Generally they are the main roles from movie.\n    \"\"\"\n    names = []\n    for item in x:\n        if col=='crew':\n            if item['job']=='Director':\n                names.append(item['name'])\n        elif col=='cast':\n            if item['order'] in (0, 1, 2):\n                names.append(item['name'])\n        else:\n            names.append(item['name'])\n    return names\n    \nfor col in dict_cols:\n    data_explore[col] = data_explore[col].apply(lambda x: get_names(x, col))","85ec3e25":"data_explore.head(n=3)","8152bf15":"Q1 = data_explore.quantile(0.25)\nQ3 = data_explore.quantile(0.75)\nIQR = Q3 - Q1\noutliers = ((data_explore < (Q1 - 1.5 * IQR)) | (data_explore > (Q3 + 1.5 * IQR))).sum()\noutliers[outliers>0]","11d3e168":"data_explore.hist(figsize=(15, 15))\nplt.show()","d64b3488":"most_popular_movies = data_explore.sort_values('popularity', ascending=False).head(n=20)\nmost_popular_movies['revenue(million)'] = most_popular_movies['revenue'].apply(lambda x : x\/\/1000000)    # revenue in millions\nmost_popular_movies['budget(million)'] = most_popular_movies['budget'].apply(lambda x : x\/\/1000000)    # revenue in millions\nmost_popular_movies[['genres', 'original_title', 'production_companies', 'popularity', 'cast', 'crew', 'budget(million)', 'revenue(million)']]","ae44951d":"plt.figure(figsize=(12, 10))\nax = sns.barplot(y='original_title', x='popularity', data=most_popular_movies, order=most_popular_movies.sort_values('popularity', ascending=False).original_title, orient='h')\nfor p in ax.patches:\n        ax.annotate('{}'.format(int(p.get_width())), (p.get_width(), p.get_y()+0.5), fontsize=12)\nplt.title('Top 20 Most Popular Movies', fontsize=12)\nplt.ylabel('')\nplt.show()","c90199d4":"highest_revenue_movies = data_explore.sort_values('revenue', ascending=False).head(n=20)\nhighest_revenue_movies['revenue(million)'] = highest_revenue_movies['revenue'].apply(lambda x : x\/\/1000000)    # revenue in millions\nhighest_revenue_movies['budget(million)'] = highest_revenue_movies['budget'].apply(lambda x : x\/\/1000000)    # revenue in millions\nhighest_revenue_movies[['genres', 'original_title', 'production_companies', 'popularity', 'cast', 'crew', 'budget(million)', 'revenue(million)']]","6b58333b":"plt.figure(figsize=(12, 10))\nax = sns.barplot(y='original_title', x='revenue(million)', data=highest_revenue_movies, order=highest_revenue_movies.sort_values('revenue(million)', ascending=False).original_title, orient='h')\nfor p in ax.patches:\n        ax.annotate('{}'.format(int(p.get_width())), (p.get_width(), p.get_y()+0.5), fontsize=12)\nplt.title('Top 20 High Revenue(million) Movies', fontsize=12)\nplt.ylabel('')\nplt.show()","565e979a":"highest_budget_movies = data_explore.sort_values('budget', ascending=False).head(n=20)\nhighest_budget_movies['revenue(million)'] = highest_budget_movies['revenue'].apply(lambda x : x\/\/1000000)    # revenue in millions\nhighest_budget_movies['budget(million)'] = highest_budget_movies['budget'].apply(lambda x : x\/\/1000000)    # revenue in millions\nhighest_budget_movies[['genres', 'original_title', 'production_companies', 'popularity', 'cast', 'crew', 'budget(million)', 'revenue(million)']]","12211426":"plt.figure(figsize=(12, 10))\nax = sns.barplot(y='original_title', x='budget(million)', data=highest_budget_movies, order=highest_budget_movies.sort_values('budget(million)', ascending=False).original_title, orient='h')\nfor p in ax.patches:\n        ax.annotate('{}'.format(int(p.get_width())), (p.get_width(), p.get_y()+0.5), fontsize=12)\nplt.title('Top 20 High Budget(million) Movies', fontsize=12)\nplt.ylabel('')\nplt.show()","539e7297":"most_profit_movies = data_explore.copy()\nmost_profit_movies['revenue(million)'] = most_profit_movies['revenue'].apply(lambda x : x\/\/1000000)    # revenue in millions\nmost_profit_movies['budget(million)'] = most_profit_movies['budget'].apply(lambda x : x\/\/1000000)    # revenue in millions\nmost_profit_movies['profit(million)'] = most_profit_movies['revenue(million)']-most_profit_movies['budget(million)']\nmost_profit_movies = most_profit_movies.sort_values('profit(million)', ascending=False).head(n=20)\nmost_profit_movies[['genres', 'original_title', 'production_companies', 'popularity', 'cast', 'crew', 'budget(million)', 'revenue(million)', 'profit(million)']]","38352d33":"plt.figure(figsize=(12, 10))\nax = sns.barplot(y='original_title', x='profit(million)', data=most_profit_movies, order=most_profit_movies.sort_values('profit(million)', ascending=False).original_title, orient='h')\nfor p in ax.patches:\n        ax.annotate('{}'.format(int(p.get_width())), (p.get_width(), p.get_y()+0.5), fontsize=12)\nplt.title('Top 20 Highest Grossing Movies', fontsize=12)\nplt.ylabel('')\nplt.show()","fb0eae7c":"data_explore_enc = data_explore['genres'].apply(lambda x: pd.Series([1] * len(x), index=x)).fillna(0, downcast='infer')\ndata_explore_genres = pd.concat([data_explore, data_explore_enc], axis=1)\ngenres = data_explore_enc.columns\ndata_explore_genres.head(n=3)","0862f333":"genres_info = []\nfor col in genres:\n    total_movies, total_budget, median_budget, total_revenue, median_revenue, median_popularity=0, 0, 0, 0, 0, 0\n    total_movies = data_explore_genres[data_explore_genres[col]==1][col].count()\n    total_budget = data_explore_genres[data_explore_genres[col]==1]['budget'].sum()\n    median_budget = data_explore_genres[data_explore_genres[col]==1]['budget'].median()\n    total_revenue = data_explore_genres[data_explore_genres[col]==1]['revenue'].sum()\n    median_revenue = data_explore_genres[data_explore_genres[col]==1]['revenue'].median()\n    median_popularity = data_explore_genres[data_explore_genres[col]==1]['popularity'].median()\n    genres_info.append([col, total_movies, total_budget, median_budget, total_revenue, median_revenue, median_popularity])","a40e827e":"genres_info = pd.DataFrame(genres_info, columns=['genres', 'movies_count', 'total_budget', 'median_budget', 'total_revenue', 'median_revenue', 'median_popularity'])\ngenres_info['total_budget(million)'] = genres_info['total_budget'].apply(lambda x : x\/\/1000000)    # budget in millions\ngenres_info['median_budget(million)'] = genres_info['median_budget'].apply(lambda x : x\/\/1000000)    # budget in millions\ngenres_info['total_revenue(million)'] = genres_info['total_revenue'].apply(lambda x : x\/\/1000000)    # revenue in millions\ngenres_info['median_revenue(million)'] = genres_info['median_revenue'].apply(lambda x : x\/\/1000000)    # revenue in millions\ngenres_info[['genres', 'movies_count', 'total_budget(million)', 'median_budget(million)', 'total_revenue(million)', 'median_revenue(million)', 'median_popularity']]","0844c816":"plt.figure(figsize=(15, 5))\nax = sns.barplot(x='genres', y='movies_count', data=genres_info, order=genres_info.sort_values('movies_count', ascending=False).genres)\nfor p in ax.patches:\n        ax.annotate('{}'.format(int(p.get_height())), (p.get_x()+0.1, p.get_height()+10))\nplt.xticks(rotation=45)\nplt.ylabel('# of Movies', fontsize=12)\nplt.xlabel('Genres', fontsize=12)\nplt.show()","5b446b43":"plt.figure(figsize=(15, 5))\nax = sns.barplot(x='genres', y='median_popularity', data=genres_info, order=genres_info.sort_values('median_popularity', ascending=False).genres)\nfor p in ax.patches:\n        ax.annotate('{}'.format(np.round(p.get_height(), 2)), (p.get_x()+0.1, p.get_height()))\nplt.xticks(rotation=45)\nplt.ylabel('Median Popularity', fontsize=12)\nplt.xlabel('Genres', fontsize=12)\nplt.show()","c1235e00":"plt.figure(figsize=(15, 6))\nx_indexes = np.arange(len(genres))     \nwidth = 0.35                            \ngenres_info = genres_info.sort_values('total_revenue(million)', ascending=False)\nplt.bar(x_indexes,  genres_info['total_revenue(million)'], label=\"Total Movies Revenue\", width=width)\nplt.bar(x_indexes + width,  genres_info['total_budget(million)'], label=\"Total Movies Budget\", width=width)\nplt.legend(loc=\"upper right\", fontsize=12)\nplt.xticks(ticks=x_indexes+0.5, labels=genres_info['genres'].values, fontsize=12, rotation=-45)\nplt.xlabel('Genres', fontsize=12)\nplt.ylabel('Sum value(million)', fontsize=12)\nplt.show()","4d3e7566":"plt.figure(figsize=(15, 6))\nx_indexes = np.arange(len(genres))     \nwidth = 0.35                            \ngenres_info = genres_info.sort_values('median_revenue(million)', ascending=False)\nplt.bar(x_indexes,  genres_info['median_revenue(million)'], label=\"Median Movies Revenue\", width=width)\nplt.bar(x_indexes + width,  genres_info['median_budget(million)'], label=\"Median Movies Budget\", width=width)\nplt.legend(loc=\"upper right\", fontsize=12)\nplt.xticks(ticks=x_indexes+0.5, labels=genres_info['genres'].values, fontsize=12, rotation=-45)\nplt.xlabel('Genres', fontsize=12)\nplt.ylabel('Median value(million)', fontsize=12)\nplt.show()","1dd3a528":"# Thanks to following kernel from where I learnt WordCloud generation. https:\/\/www.kaggle.com\/artgor\/eda-feature-engineering-and-model-interpretation\n\nfrom wordcloud import WordCloud","bd321fd6":"plt.figure(figsize = (12, 12))\ntext = ' '.join(data_explore['original_title'].values)\nwordcloud = WordCloud(max_font_size=None, background_color='white', width=1200, height=1000).generate(text)\nplt.imshow(wordcloud)\nplt.title('Top Words in Movie Titles', fontsize=14)\nplt.axis(\"off\")\nplt.show()","587944c3":"list_of_genres = list(data_explore['genres'].values)\nplt.figure(figsize = (12, 12))\ntext = ' '.join(['_'.join(i.split(' ')) for j in list_of_genres for i in j])\nwordcloud = WordCloud(max_font_size=None, background_color='white', collocations=False, width=1200, height=1000).generate(text)\nplt.imshow(wordcloud)\nplt.title('Top Genres', fontsize=14)\nplt.axis(\"off\")\nplt.show()","7068770f":"list_of_keywords = list(data_explore['Keywords'].values)\nplt.figure(figsize = (12, 12))\ntext = ' '.join(['_'.join(i.split(' ')) for j in list_of_keywords for i in j])\nwordcloud = WordCloud(max_font_size=None, background_color='black', collocations=False, width=1200, height=1000).generate(text)\nplt.imshow(wordcloud)\nplt.title('Top Keywords', fontsize=14)\nplt.axis(\"off\")\nplt.show()","eeb122d3":"plt.figure(figsize=(7, 7))\nsns.boxplot(x='revenue', data=data_explore, orient='v')\nax = plt.gca()\nax.get_yaxis().get_major_formatter().set_scientific(False)\nax.set_ylim(0, 300000000)\nax.set_title('Distribution of Revenue')","de6fe060":"plt.figure(figsize=(10, 6))\nsns.scatterplot(x='budget', y='revenue', data=data_explore)\nax = plt.gca()\nax.get_xaxis().get_major_formatter().set_scientific(False)\nax.get_yaxis().get_major_formatter().set_scientific(False)\nax.set_title('Revenue Vs. Budget')\nplt.show()","4bafaece":"plt.figure(figsize=(10, 6))\nsns.scatterplot(x='popularity', y='revenue', data=data_explore)\nax = plt.gca()\nax.get_yaxis().get_major_formatter().set_scientific(False)\nax.set_title('Revenue Vs. Popularity')\nplt.xlim(0, 60)\nplt.show()","f6ade668":"plt.figure(figsize=(15, 5))\nsns.scatterplot(x='runtime', y='revenue', data=data_explore)\nplt.xticks(rotation=90)\nax = plt.gca()\nax.get_yaxis().get_major_formatter().set_scientific(False)\nax.set_title('Revenue Vs. Movie Runtime')\nplt.xlim(50, 200)\nplt.show()","c63eb656":"plt.figure(figsize=(15, 5))\nsns.barplot(x='release_year', y='revenue', data=data_explore, estimator=np.mean)\nplt.xticks(rotation=90)\nax = plt.gca()\nax.get_yaxis().get_major_formatter().set_scientific(False)\nax.set_title('Avg. Revenue Each Year (Since 1960)')\nax.set_xlim(left=31.5)","0e757cbe":"plt.figure(figsize=(15, 5))\nsns.barplot(x='release_month', y='revenue', data=data_explore, estimator=np.mean)\nplt.xticks(rotation=90)\nax = plt.gca()\nax.get_yaxis().get_major_formatter().set_scientific(False)\nax.set_title('Avg. Revenue Each Month')","cb7239a8":"plt.figure(figsize=(15, 5))\nsns.barplot(x='release_dow', y='revenue', data=data_explore, estimator=np.mean)\nplt.xticks(rotation=90)\nax = plt.gca()\nax.get_yaxis().get_major_formatter().set_scientific(False)\nax.set_title('Avg. Revenue on Each Day of Week')","607d30b5":"plt.figure(figsize=(15, 6))\nsns.boxplot(x='original_language', y='revenue', data=data_explore)\n# plt.xticks(rotation=90)\nax = plt.gca()\nax.get_yaxis().get_major_formatter().set_scientific(False)\nax.set_ylim(top=400000000)\nax.set_xlim(right=15.5)","7bc3dba9":"# Thanks to following post from where I learn how to create sorted box-plot. \n# https:\/\/medium.com\/the-barometer\/note-to-self-pandas-sort-boxplots-by-median-2a6c70c11644\n\ndef boxplot_sorted(df, by, column):\n    # use dict comprehension to create new dataframe from the iterable groupby object\n    # each group name becomes a column in the new dataframe\n    df2 = pd.DataFrame({col:vals[column] for col, vals in df.groupby(by)})\n    # find and sort the median values in this new dataframe\n    meds = df2.mean().sort_values(ascending=False)\n    # use the columns in the dataframe, ordered sorted by median value\n    # return axes so changes can be made outside the function\n    return df2[meds.index].boxplot()","4d856778":"plt.figure(figsize=(15, 7))\naxes = boxplot_sorted(data_explore, by = ['original_language'], column = 'revenue')\nax = plt.gca()\nax.get_yaxis().get_major_formatter().set_scientific(False)\nax.set_ylim((-10000000, 300000000))\nax.set_xlim(right=10.5)\nplt.xlabel('Orignal Language')\nplt.ylabel('Revenue')\nplt.title('Distribution of Revenue for Top 10 Movies(by Average Revenue)')\nplt.show()","99a3477d":"plt.figure(figsize=(15, 7))\naxes = boxplot_sorted(data_explore, by = ['release_year'], column = 'revenue')\nax = plt.gca()\nax.get_yaxis().get_major_formatter().set_scientific(False)\nax.set_ylim((-10000000, 400000000))\nax.set_xlim(right=20.5)\nplt.xlabel('Release Year')\nplt.ylabel('Revenue')\nplt.title('Distribution of Revenue for Top 20 Years (by Average Revenue)')\nplt.show()","eeffebf6":"plt.figure(figsize=(12, 7))\ncorr_matrix = data_explore.corr()\nsns.heatmap(corr_matrix, mask=np.zeros_like(corr_matrix, dtype=np.bool), square=True, annot=True, cbar=False)\nplt.tight_layout()","33d8ca11":"corr_matrix['revenue'].sort_values(ascending=False)","c09e15ef":"from sklearn.impute import SimpleImputer\nfrom sklearn.compose import ColumnTransformer\nfrom sklearn.base import BaseEstimator, TransformerMixin\nfrom sklearn.pipeline import Pipeline\nfrom sklearn.preprocessing import OneHotEncoder, PowerTransformer, MultiLabelBinarizer","dc6d57cf":"X = data.drop(columns=['revenue'], axis=1).copy()\ny = data['revenue'].copy()\nX.shape, y.shape","06f1aecc":"from collections import Counter\ntop_30_values = dict()\n\nlist_of_genres_names = list(X['genres'].apply(lambda x: [] if pd.isna(x) else ast.literal_eval(x)).apply(lambda x: [i['name'] for i in x] if x != {} else []).values)\ntop_30_genres = (Counter([i for j in list_of_genres_names for i in j]).most_common(30))\ntop_30_values['genres'] = [x for x, y in top_30_genres]\n\nlist_of_production_companies_names = list(X['production_companies'].apply(lambda x: [] if pd.isna(x) else ast.literal_eval(x)).apply(lambda x: [i['name'] for i in x] if x != {} else []).values)\ntop_30_production_companies = (Counter([i for j in list_of_production_companies_names for i in j]).most_common(30))\ntop_30_values['production_companies'] = [x for x, y in top_30_production_companies]\n\nlist_of_production_countries_names = list(X['production_countries'].apply(lambda x: [] if pd.isna(x) else ast.literal_eval(x)).apply(lambda x: [i['name'] for i in x] if x != {} else []).values)\ntop_30_production_countries = (Counter([i for j in list_of_production_countries_names for i in j]).most_common(30))\ntop_30_values['production_countries'] = [x for x, y in top_30_production_countries]\n\nlist_of_keywords = list(X['Keywords'].apply(lambda x: [] if pd.isna(x) else ast.literal_eval(x)).apply(lambda x: [i['name'] for i in x] if x != {} else []).values)\ntop_30_keywords = (Counter([i for j in list_of_keywords for i in j]).most_common(30))\ntop_30_values['Keywords'] = [x for x, y in top_30_keywords]\n\nlist_of_cast_names = list(X['cast'].apply(lambda x: [] if pd.isna(x) else ast.literal_eval(x)).apply(lambda x: [i['name'] for i in x if i['order'] in (0, 1, 2)] if x != {} else []).values)\ntop_30_cast = (Counter([i for j in list_of_cast_names for i in j]).most_common(30))\ntop_30_values['cast'] = [x for x, y in top_30_cast]","276e84bf":"drop_cols = ['id', 'homepage', 'imdb_id', 'original_title', 'spoken_languages', 'overview', 'poster_path', 'tagline', 'title', 'crew']\nencoded_cols = [] # This will contain all the encoded column names of multivalued field","d5ae28fd":"class CustomAttr(BaseEstimator, TransformerMixin):\n    def __init__(self):\n        pass\n    \n    def fit(self, X, y=None):\n        return self\n    \n    def transform(self, X):\n        try:\n            X['is_sequel'] = X['belongs_to_collection'].apply(lambda x: 0 if pd.isna(x) else 1)\n#             print(\"is_sequel attribute added!\")\n            \n            X['release_date']= X['release_date'].apply(lambda x: self.modify_date(x))\n            \n            X['release_year'] = pd.DatetimeIndex(X['release_date']).year\n#             print(\"release_year attribute added!\")\n            \n            X['release_month'] = pd.DatetimeIndex(X['release_date']).month\n#             print(\"release_month attribute added!\")\n            \n            X['release_day'] = pd.DatetimeIndex(X['release_date']).day\n#             print(\"release_day attribute added!\")\n            \n            X['release_dow'] = pd.DatetimeIndex(X['release_date']).dayofweek\n#             print(\"release_dow attribute added!\")\n            \n            X = X.drop(['belongs_to_collection', 'release_date'], axis=1)\n#             print(\"belongs_to_collection, release_date attribute removed!\")\n            return X\n        except Exception as e:\n            print(\"CustomAttr: Exception caught: {}\".format(e))\n\n    @staticmethod\n    def modify_date(x):\n        \"\"\"\n            Converting date: mm\/dd\/YY to mm\/dd\/YYYY\n            NaN date fields are handle here only.\n        \"\"\"\n        try:\n            if x is np.nan:\n                x='01\/01\/00'\n            x=str(x)\n            year=x.split('\/')[2]\n            if int(year)<20:\n                return x[:-2]+'20'+year\n            else:\n                return x[:-2]+'19'+year\n        except Exception as e:\n            print(\"CustomAttr: modify_date() function -  exception caught for date {}: {}\".format(x,e))","895a942b":"class JSONHandler(BaseEstimator, TransformerMixin):\n    def __init__(self):\n        \"\"\"\n        For each multivalued field, there will be a MultiLabelBinarizer.\n        \"\"\"\n        self.mlbs = dict()\n    \n    def fit(self, X, y=None):\n        return self\n    \n    def transform(self, X):\n        for col in list(X.columns):\n            try:\n                X[col] = X[col].apply(lambda x: [] if pd.isna(x) else ast.literal_eval(x))\n                X[col] = X[col].apply(lambda x: self.get_names(x, col))\n                if not (col in self.mlbs.keys()):\n                    self.mlbs[col] = MultiLabelBinarizer()\n                    X_enc = pd.DataFrame(self.mlbs[col].fit_transform(X[col]),columns=self.mlbs[col].classes_, \n                                         index=X.index)\n                    encoded_cols.extend(list(self.mlbs[col].classes_))\n                else:\n                    X_enc = pd.DataFrame(self.mlbs[col].transform(X[col]),columns=self.mlbs[col].classes_, \n                                         index=X.index)\n                X = X.drop(col, axis=1)\n                X = pd.concat([X, X_enc], axis=1)\n#                 print(\"{}, {}, {}\".format(col, X_enc.shape, X.shape))\n#                 print(\"{} attribute encoded &  removed!\".format(col))\n            except Exception as e:\n                print(\"JSONHandler: Exception caught for {}: {}\".format(col,e))\n        return X\n       \n\n    @staticmethod\n    def get_names(x, col):\n        \"\"\"\n            Get the name field value from JSON object.\n        \"\"\"\n        names = []\n        try:\n            names = [item['name'] for item in x if item['name'] in top_30_values[col]]\n            if len(names)==0:\n                names.append('other_'+col)\n            return names\n        except Exception as e:\n            print(\"JSONHandler: get_names() function -  exception caught {}: {}\".format(x,e))","31db3eb4":"num_pipeline = Pipeline([('imputer', SimpleImputer(strategy='median')),\n                        ('scaler', PowerTransformer())])\n\ncat_pipeline = Pipeline([('imputer', SimpleImputer(strategy='most_frequent')),\n                         ('cat_enc', OneHotEncoder(handle_unknown='ignore'))])\n\npre_process = ColumnTransformer([('drop_cols', 'drop', drop_cols),\n                                 ('num_process', num_pipeline, ['budget', 'popularity', 'runtime']),\n                                 ('add_custom_attrs', CustomAttr(), ['belongs_to_collection', 'release_date']),\n                                 ('cat_process', cat_pipeline, ['original_language', 'status']),\n                                 ('jason_handler', JSONHandler(), ['genres', 'production_companies', 'production_countries', 'Keywords', 'cast'])], remainder='passthrough')\n\nX_transformed = pre_process.fit_transform(X)\nX_transformed.shape","7a089955":"from sklearn.model_selection import train_test_split\n\nX_train_transformed, X_test_transformed, y_train, y_test = train_test_split(X_transformed, np.log1p(y), test_size=0.2, random_state=42)\nX_train_transformed.shape, X_test_transformed.shape","15f4061b":"feature_columns = ['budget', 'popularity', 'runtime', 'is_sequel', 'release_year', 'release_month', 'release_day', 'release_dow'] + list(pre_process.transformers_[3][1]['cat_enc'].get_feature_names(['original_language', 'status'])) + encoded_cols\nlen(feature_columns)","6e8ee25d":"from sklearn.model_selection import KFold\n\nkf = KFold(n_splits=5, shuffle=True, random_state=42)","56b72da2":"from sklearn.model_selection import cross_val_score\n\nresults = []\n\ndef performance_measures(model, store_results=True):    \n    train_rmses = cross_val_score(model, X_train_transformed, y_train, scoring='neg_root_mean_squared_error', cv=kf, n_jobs=-1)\n    train_rmses *= -1\n    train_mean_rmse = np.mean(train_rmses)\n    \n    test_rmses = cross_val_score(model, X_test_transformed, y_test, scoring='neg_root_mean_squared_error', cv=kf, n_jobs=-1)\n    test_rmses *= -1\n    test_mean_rmse = np.mean(test_rmses)\n    \n    print(\"Train Mean RMSE: {}\\nTest Mean RMSE: {}\".format(train_mean_rmse, test_mean_rmse))\n    \n    if store_results:\n        results.append([model.__class__.__name__, train_mean_rmse, test_mean_rmse])","7fb8da7b":"def plot_feature_importance(feature_columns, importance_values):\n    feature_imp = [ col for col in zip(feature_columns, importance_values)]\n    feature_imp.sort(key=lambda x:x[1], reverse=True)\n\n    imp = pd.DataFrame(feature_imp[0:15], columns=['feature', 'importance'])\n    plt.figure(figsize=(10, 8))\n    sns.barplot(y='feature', x='importance', data=imp, orient='h')\n    plt.title('15 Most Important Features', fontsize=16)\n    plt.ylabel(\"Feature\", fontsize=16)\n    plt.xlabel(\"\")\n    plt.show()","4e5ab018":"from sklearn.linear_model import Ridge\n\nridge_reg = Ridge(alpha=1, random_state=42)\nridge_reg.fit(X_train_transformed, y_train)","e99b95b8":"plot_feature_importance(feature_columns, ridge_reg.coef_)","a42385b9":"performance_measures(ridge_reg) ","efe19803":"from sklearn.ensemble import RandomForestRegressor\n\nforest_reg = RandomForestRegressor(n_estimators=500, max_depth=16, max_features=0.2, n_jobs=-1, random_state=42)\nforest_reg.fit(X_train_transformed, y_train)","4cbdd777":"plot_feature_importance(feature_columns, forest_reg.feature_importances_)","82f62f94":"performance_measures(forest_reg)","96cf45b3":"from xgboost import XGBRegressor\n\nxgb_reg = XGBRegressor(objective='reg:squarederror', n_estimators = 1000, max_depth = 14, learning_rate = 0.01, \n                       gamma=1.0, subsample = 0.7, colsample_bytree = 0.6, colsample_bylevel = 0.5, \n                       random_state=42, n_jobs=-1)\nxgb_reg.fit(X_train_transformed, y_train)","6dc64d9e":"plot_feature_importance(feature_columns, xgb_reg.feature_importances_)","3c026370":"performance_measures(xgb_reg)","7bb1ddbd":"from catboost import CatBoostRegressor\n\ncat_boost_reg = CatBoostRegressor(loss_function='RMSE', bagging_temperature = 0.3, colsample_bylevel = 0.7, \n                                  depth = 9, eval_metric = 'RMSE', iterations = 1500, \n                                  random_state=42, verbose=0)\ncat_boost_reg.fit(X_train_transformed, y_train)","4efdcd1f":"plot_feature_importance(feature_columns, cat_boost_reg.feature_importances_)","f1e51692":"performance_measures(cat_boost_reg)","95836db5":"from lightgbm import LGBMRegressor\n\nlgb_reg = LGBMRegressor(objective = 'regression', num_iterations = 100, max_depth = 12, learning_rate= 0.03, \n                        metric = 'rmse', colsample_bytree= 0.6, subsample_freq= 1, subsample= 0.5, n_jobs=-1, \n                        random_state=42)\nlgb_reg.fit(X_train_transformed, y_train)","243c8c31":"plot_feature_importance(feature_columns, lgb_reg.feature_importances_)","8330769e":"performance_measures(lgb_reg)","d7096f84":"from sklearn.ensemble import VotingRegressor\n\nnamed_estimators = [('cat_bost', cat_boost_reg), ('xgb_reg', xgb_reg), ('lgb_reg', lgb_reg), ('forest_reg', forest_reg), ('ridge_reg', ridge_reg)]\n\nvoting_reg = VotingRegressor(estimators=named_estimators, n_jobs=-1)\nvoting_reg.fit(X_train_transformed, y_train)","caa67b43":"performance_measures(voting_reg)","ab9f784e":"pd.DataFrame(results, columns=['Model', 'Train RMSE', 'Test RMSE'])","c9721456":"predicted_revenue = voting_reg.predict(X_transformed)\noverall_data = X.copy()\noverall_data['revenue'] = y.copy()\noverall_data['predicted_revenue'] = np.expm1(predicted_revenue)","ba8fff6b":"overall_data.head(n=2)","dba6aabf":"plt.figure(figsize=(10, 5))\nsns.scatterplot(x='budget', y='revenue', data=overall_data, label='Observed')\nsns.scatterplot(x='budget', y='predicted_revenue', data=overall_data, color='red', label='Predicted')\nplt.ylim(0, 750000000)\nplt.xlim(0, 250000000)\nplt.xlabel('Budget', fontsize=14)\nplt.ylabel('Revenue', fontsize=14)\nax = plt.gca()\nax.get_xaxis().get_major_formatter().set_scientific(False)\nax.get_yaxis().get_major_formatter().set_scientific(False)\nax.set_title('Revenue Vs. Budget')\nplt.show()","ffb7c6ef":"plt.figure(figsize=(10, 5))\nsns.scatterplot(x='popularity', y='revenue', data=overall_data, label='Observed')\nsns.scatterplot(x='popularity', y='predicted_revenue', data=overall_data, color='red', label='Predicted')\nplt.ylim(0, 500000000)\nplt.xlim(0, 50)\nplt.xlabel('Popularity', fontsize=14)\nplt.ylabel('Revenue', fontsize=14)\nax = plt.gca()\nax.get_xaxis().get_major_formatter().set_scientific(False)\nax.get_yaxis().get_major_formatter().set_scientific(False)\nax.set_title('Revenue Vs. Popularity')\nplt.show()","9a1263f3":"year_info = overall_data[['release_date', 'revenue', 'predicted_revenue']].copy()\nyear_info['release_date']=year_info['release_date'].apply(lambda x: modify_date(x))\nyear_info['release_year'] = pd.DatetimeIndex(year_info['release_date']).year\nyear_info = year_info.groupby(['release_year']).median()\nyear_info = year_info.sort_values('release_year')\n\nrelease_years = list(year_info.index)\nx_indexes = np.arange(len(release_years))     \nwidth = 0.25                            \n\nplt.figure(figsize=(10, 5))\nplt.bar(x_indexes,  year_info['revenue'], label=\"Median Observed Movies Revenue\", width=width)\nplt.bar(x_indexes + width,  year_info['predicted_revenue'], label=\"Median Predicted Movies Revenue\", width=width)\nplt.legend(loc=\"upper left\", fontsize=12)\nplt.xticks(ticks=x_indexes+0.5, labels=release_years, fontsize=12, rotation=-45)\nplt.title('1990-2017')\nplt.xlabel('Release Year', fontsize=12)\nplt.ylabel('Revenue', fontsize=12)\nplt.xlim(left=61.5, right=90)\nplt.ylim(top=50000000)\nax = plt.gca()\nax.get_yaxis().get_major_formatter().set_scientific(False)\nplt.show()","6f70a145":"x_indexes = np.arange(len(release_years))     \nwidth = 0.35                            \n\nplt.figure(figsize=(10, 5))\nplt.bar(x_indexes,  year_info['revenue'], label=\"Median Observed Movies Revenue\", width=width)\nplt.bar(x_indexes + width,  year_info['predicted_revenue'], label=\"Median Predicted Movies Revenue\", width=width)\nplt.legend(loc=\"upper left\", fontsize=12)\nplt.xticks(ticks=x_indexes+0.5, labels=release_years, fontsize=12, rotation=-45)\nplt.title('1960-1989')\nplt.xlabel('Release Year', fontsize=12)\nplt.ylabel('Revenue', fontsize=12)\nplt.xlim(left=32, right=62)\nplt.ylim(top=80000000)\nax = plt.gca()\nax.get_yaxis().get_major_formatter().set_scientific(False)\nplt.show()","3f04fb49":"final_model = Pipeline([('pre_process', pre_process),\n                        ('voting_reg', voting_reg)])\nfinal_model.fit(X, np.log1p(y))","123660a3":"test_data = pd.read_csv('..\/input\/tmdb-box-office-prediction\/test.csv')\nprint(test_data.shape)\ntest_data.head(n=3)","06fb1f3e":"test_data.info()","67b75c25":"test_data.isna().sum()","b6621ce7":"predictions = final_model.predict(test_data)\npredictions = np.expm1(predictions)","586fde38":"output = pd.DataFrame(test_data['id'])\noutput['revenue'] = predictions.copy()","a062e269":"output.head()","4767040a":"output.to_csv(\".\/submission.csv\", index=False)","bb149dae":"- We can see that model is failed to predict the high revenue movies. There are many low budget high earning movies for which model has predicted less revenue.\n- Also model is less accuracte for high budget films.","ff1c57ca":"## Step 5: Model Evaluation","714220fc":"### Genres","4a44d1b9":"Since belongs_to_collection attribute is only present for sequel movies so lets create a new feature which will indicate whether movie is sequel or not.","37a49c1c":"#### Correlation Plot","36d97a54":"# TMDB Revenue Prediction","4f0c22d1":"- In this step I will create a pipeline to handle all data preprocessing operations.\n- Pipeline will do following tasks:\n    - Dropping unwanted columns\n    - Fill null values\n    - Scaling numerical features\n    - Encoding single valued & multivalued categorical fields\n    - Creating new features from existing ones\n    ","7bf52d1a":"### Wordclouds","6e40520a":"## Step 1: Frame the Problem","1a525a04":"- Among all models voting regressor gives better RMLSE. I will be taking it as a final model\n- Now lets see how model is performing on overall dataset. This will be helpful to understand where the model is accurate and where it is not.","27c2ae5e":"- Except runtime, all columns which contain NULL values are the columns which are multi-valued. So will replace them with empty set.\n- NULL value in runtime will be replace by the median value.","9dc0e9bf":"## Step 3: Data Preprocessing","a8cd4a7d":"#### Observation:\n   - There is not any clear trend between budget and revenue. But we can see that higher budget films generally earn more compare to small budget films.","ca591ac0":"### Top 20 Most Popular Movies","cee97de4":"### Top 20 Highest Earned Movies","e5174b30":"- Min budget, runtime is zero\n- Min revenue is one","a84a82ed":"- <b>Objective:<\/b> For given information about movies which include cast, crew, plot keywords, budget, posters, release dates, languages, production companies, and countries we have to build a model which will accurately predict the overall worldwide revenue for a movie. \n\n\n- Following are few important features present in dataset:\n    - belongs_to_collection\t: This feautue is present only for true movie sequels.\n    - budget: Buget of film\tin USD\n    - genres\n    - original_language: Language with the original version of the film.\t\n    - original_title: Title of film when it is first officially released locally\t\n    - overview: Describe the plot of the movie.\n    - popularity\n    - production_companies\n    - production_countries\t\n    - release_date\t\n    - runtime: Length of movie.\n    - spoken_languages: Languages spoken in the movie\n    - status: Whether movie is release or not.\n    - Keywords\n    - cast: Information all cast memebers\n    - crew: Information of, director, producer, writer etc.\n    - revenue: Target variable. Revenue of film\tin USD\n    \n    \n- Data types present in dataset:\n    - String\n    - Numeric\n    - Date\n    - JSON\n    \n    \n- Handling JSON data\n    - There are various attributes such as cast, crew, genres which represents important information about movie. This are multivalued fields. Each value in these fields is a JSON object.\n    - Ex. of genres. [{'id': 35, 'name': 'Comedy'}, {'id': 18, 'name': 'Drama'}, {'id': 10751, 'name': 'Family'}, {'id': 10749, 'name': 'Romance'}]\n    - From these JSON object, I will be extracting the name only. So the multivalued field will contain list of strings rather than list of JSON objects.\n    - For each multivalued field there will be many JSON object which means many name fields. Including all those name fields for encoding will increase the dimensionality of data by huge factor and this will impact the model training. So I will be including 30 most occured names for each multivalued field and the other names will be marked as 'other'.\n    - This list of names can encoded further using MutliLabelBinarizer.","88b37ee4":"## Step 2: Data Exploration","cdb03443":"### Top 20 High Budget Movies","dd247ea8":"### Revenue","8a90e344":"## Step 4: Modelling","7c08fa1b":"- For most popular movies, model is less accuracte.\n- It seems that model has learn that for least popular movies revenue will be less. We can see that in bottom left corner, there are least popular movies which have earn high revenue, but model has predicted less.","9b4b6345":"- Now lets create final complete pipeline which will handle the data preprocessing as well as prediction task.","cb76c556":"### Top 20 Highest Grossing Movies","185b0002":"## Step 6: Make Submission"}}