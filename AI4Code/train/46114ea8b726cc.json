{"cell_type":{"c54eb848":"code","dcb0de89":"code","8a182b9a":"code","b7bde439":"code","88320175":"code","09ecef81":"code","5c9e5d8b":"code","8066ff33":"code","ac734fd5":"code","1b866b48":"code","5093ad74":"code","d1a7af17":"code","8f4a6f3e":"code","4faa93b9":"code","bfaa7d51":"code","bd364098":"code","122260a3":"code","79d80804":"code","f41ba6cb":"code","dc0bef33":"code","b57b15ce":"code","e306f729":"code","58f81e69":"code","b0f56216":"code","dbb5530c":"markdown","2f4e2dfe":"markdown","ec31387c":"markdown","483dcdf4":"markdown","11d9fc7a":"markdown","e404097d":"markdown","1eba31f0":"markdown","3dd4ee4a":"markdown","1b53fcf0":"markdown","6fdf685a":"markdown"},"source":{"c54eb848":"import gc\nimport numpy as np\nimport pandas as pd\nfrom pylab import rcParams\nimport matplotlib.pyplot as plt\nfrom sklearn.metrics import mean_squared_error\nimport statsmodels.api as sm\nfrom statsmodels.tsa.arima_model import ARIMA\nfrom scipy.stats import probplot\n\n%matplotlib inline\n\nimport os\nfor dirname, _, filenames in os.walk('\/kaggle\/input'):\n    for filename in filenames:\n        print(os.path.join(dirname, filename))\n\nimport warnings\nwarnings.filterwarnings(\"ignore\")","dcb0de89":"column_types = {\n    'store':'int8',\n    'item':'int8',\n    'sales':'float64',\n}\ntrain = pd.read_csv('\/kaggle\/input\/demand-forecasting-kernels-only\/train.csv',dtype=column_types,parse_dates=['date'])\ntest = pd.read_csv('\/kaggle\/input\/demand-forecasting-kernels-only\/test.csv',dtype=column_types,parse_dates=['date'])\nsubmission = pd.read_csv('\/kaggle\/input\/demand-forecasting-kernels-only\/sample_submission.csv')","8a182b9a":"train.info()","b7bde439":"test.info()","88320175":"print('Train from {%s} to {%s}' % (train.date.min(),train.date.max()))\nprint('Test from {%s} to {%s}' % (test.date.min(),test.date.max()))","09ecef81":"pre_skew = train['sales'].skew()\npre_kurt = train['sales'].kurt()\n\ntrain['sales'] = np.log1p(train['sales'])\n\nprint('Training Set Sales Skew from {%f} downto {%f}' % (pre_skew,train['sales'].skew()))\nprint('Training Set Sales Kurtosis from {%f} downto {%f}' % (pre_kurt,train['sales'].kurt()))","5c9e5d8b":"sales = train[train.store==1][train.item==1].sales\nrcParams['figure.figsize'] = 20, 5\nplt.plot(sales)","8066ff33":"rcParams['figure.figsize'] = 20, 10\nfigure = sm.tsa.seasonal_decompose(sales,freq=360).plot() # decompose with 360\nfigure.show()","ac734fd5":"sales_diff1 = sales.diff(1).iloc[1:]\nrcParams['figure.figsize'] = 20, 5\nplt.plot(sales_diff1)","1b866b48":"sales_diff2 = sales.diff(2).iloc[2:]\nrcParams['figure.figsize'] = 20, 5\nplt.plot(sales_diff2)","5093ad74":"from statsmodels.graphics.tsaplots import plot_acf\nrcParams['figure.figsize'] = 20, 5\nfigure = plot_acf(sales_diff1,lags=30,title='Train sales autocorrelation in 30 lags')\nfigure.show()","d1a7af17":"from statsmodels.graphics.tsaplots import plot_pacf\nrcParams['figure.figsize'] = 20, 5\nfigure = plot_pacf(sales_diff1,lags=30,title='Train sales partial autocorrelation in 30 lags')\nfigure.show()","8f4a6f3e":"def evaluate_arima_model(X, arima_order):\n    # prepare training dataset\n    train_size = int(len(X) * 0.8)\n    train, test = X[0:train_size], X[train_size:]\n    history = [x for x in train]\n    # make predictions\n    predictions = list()\n    for t in range(len(test)):\n        model = ARIMA(history, order=arima_order)\n        model_fit = model.fit(disp=0)\n        yhat = model_fit.forecast()[0]\n        predictions.append(yhat)\n        history.append(test[t])\n    # calculate out of sample error\n    error = mean_squared_error(test, predictions)\n    return error\n    \n# evaluate combinations of p, d and q values for an ARIMA model\ndef evaluate_models(dataset, p_values, d_values, q_values):\n    dataset = dataset.astype('float32')\n    best_score, best_cfg = float(\"inf\"), None\n    for p in p_values:\n        for d in d_values:\n            for q in q_values:\n                order = (p,d,q)\n                try:\n                    mse = evaluate_arima_model(dataset, order)\n                    if mse < best_score:\n                        best_score, best_cfg = mse, order\n                    print('ARIMA%s MSE=%.3f' % (order,mse))\n                except:\n                    continue\n    print('Best ARIMA%s MSE=%.3f' % (best_cfg, best_score))\n    return best_cfg, best_score","4faa93b9":"# p_values = range(6,9)\n# d_values = range(0,3)\n# q_values = range(0,3)\n# best_cfg, best_score = evaluate_models(sales.values, p_values, d_values, q_values)\nbest_cfg=(7,1,1) # for sales","bfaa7d51":"rcParams['figure.figsize'] = 20, 5\nmodel = ARIMA(sales, order=best_cfg) # 7 from ar, 1 from diff, 1 for ma.\nresult = model.fit()\nprint(result.summary())\nresult.plot_predict(start=750, end=1000)\nplt.show()","bd364098":"rmse = np.sqrt(mean_squared_error(sales.diff().iloc[1:1001].values, result.predict(start=1,end=1000)))\nprint(\"The root mean squared error with ARIMA(1,1,0) is {%f}.\" % rmse)","122260a3":"y = []\ny_hat = []\nmodels = {}\nfor k,si in train[train.store<=3].groupby(['store','item']):\n    print(k,si.sales.min(),si.sales.max())\n#     y+=(si.sales.diff(1).tolist()[1:]) # \u5bf9\u5e94order\u4e2d\u7684d=1\n    model = ARIMA(si.sales.values, order=best_cfg)\n    result = model.fit()\n#     y_hat+=(result.predict(start=1).tolist())\n    models[str(si.store)+'_'+str(si.item)] = result","79d80804":"for k,si in train[train.store>3][train.store<=6].groupby(['store','item']):\n    print(k,si.sales.min(),si.sales.max())\n#     y+=(si.sales.diff(1).tolist()[1:]) # \u5bf9\u5e94order\u4e2d\u7684d=1\n    model = ARIMA(si.sales.values, order=best_cfg)\n    result = model.fit()\n#     y_hat+=(result.predict(start=1).tolist())\n    models[str(si.store)+'_'+str(si.item)] = result","f41ba6cb":"for k,si in train[train.store>6].groupby(['store','item']):\n    print(k,si.sales.min(),si.sales.max())\n#     y+=(si.sales.diff(1).tolist()[1:]) # \u5bf9\u5e94order\u4e2d\u7684d=1\n    model = ARIMA(si.sales.values, order=best_cfg)\n    result = model.fit()\n#     y_hat+=(result.predict(start=1).tolist())\n    models[str(si.store)+'_'+str(si.item)] = result","dc0bef33":"# rcParams['figure.figsize'] = 20, 5\n# plt.plot(y[:200])\n# plt.plot(y_hat[:200])\n# plt.show()","b57b15ce":"# rmse = np.sqrt(mean_squared_error(y, y_hat))\n# print(\"The root mean squared error with ARIMA{%s} between y and y_hat is {%f}.\" % (best_cfg,rmse))","e306f729":"models[str(1)+'_'+str(1)].predict(start='2018-01-01 00:00:00')","58f81e69":"1\/0","b0f56216":"for row in test.itertuples():\n    print(getattr(row,'Index'), getattr(row,'date'), getattr(row,'store'), getattr(row,'item'))\n    models[str(getattr(row,'store'))+'_'+str(getattr(row,'item'))].predict(start=getattr(row,'date'))","dbb5530c":"Log1p Transform for sales.\n\n\n- all_data['SalePrice'] = np.log1p(all_data['SalePrice'])\n- predictions[name] = np.expm1(model.predict(train_x))","2f4e2dfe":"## PREPROCESS","ec31387c":"### Build Submission File","483dcdf4":"### Autocorrelation","11d9fc7a":"### Trends, Seasonality and Noise","e404097d":"### Partial Autocorrelation","1eba31f0":"### All in ARIMA","3dd4ee4a":"## ARIMA\n\nCheck item==1&store==1 sales.","1b53fcf0":"### Stationarity","6fdf685a":"### Predict by ARIMA\n\nhttps:\/\/blog.csdn.net\/qq_37135484\/article\/details\/101205161\nhttps:\/\/www.codercto.com\/a\/41483.html\n\nOnly item==1&store==1."}}