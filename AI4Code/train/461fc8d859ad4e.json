{"cell_type":{"ea01a6a0":"code","70794d28":"code","291428b9":"code","ec138d88":"code","a85d8846":"code","e21f49e7":"code","cfc1d184":"code","431377b4":"code","a9a29cc3":"code","d08ec4cc":"code","742ebd8a":"code","6657fea5":"code","0a4c2247":"code","7be568c7":"code","55234e5c":"code","f181cac6":"code","6948339b":"code","8300f48d":"code","3b072e12":"code","24fc7237":"code","0a73521e":"code","0ed26de2":"code","74a02edf":"code","2548c768":"code","09b89415":"code","7f379d3d":"code","3464b850":"code","a2a279ee":"code","0f658d0f":"code","cb2e3c0d":"code","f8f77fa9":"code","37f3fca0":"code","d7208827":"code","25461200":"code","ac3962de":"code","90b96333":"code","9e4534d1":"code","9a9b7e2d":"code","7899227b":"code","3d7be521":"code","a9d1dbd8":"code","9572f80b":"code","2612c886":"code","f48014b6":"code","63cf5322":"code","34e80a13":"code","ce3aadec":"code","7b4d46b0":"code","e2bd4190":"code","16cfa27d":"markdown","b67db353":"markdown","ab47108c":"markdown","a51bc77e":"markdown","6846accc":"markdown","03376fad":"markdown","ae8b3ea3":"markdown","b5b123d9":"markdown","0af0dfc1":"markdown","ecdc14eb":"markdown","b6d01fe8":"markdown","e7ea473d":"markdown","8bc11d6d":"markdown","3aea255f":"markdown","9a62460c":"markdown","92ffd57f":"markdown","0415355e":"markdown"},"source":{"ea01a6a0":"%pylab inline\nimport matplotlib.pyplot as plt\nimport matplotlib.image as mpimg\n\nimport numpy as np\nimport pandas as pd","70794d28":"df_train = pd.read_csv('\/kaggle\/input\/i2a2-bone-age-regression\/train.csv')\ndf_train.head()","291428b9":"df_train_femele = df_train.query('patientSex == \"F\"')\ndf_train_femele.describe()","ec138d88":"df_train_femele.hist(column = 'boneage', bins = 40, color = 'blue', alpha = 0.5, figsize=(20, 10))\nplt.show()","a85d8846":"first_female_group = df_train_femele.query('boneage < 50')\nprint('Less than 50 months: ', len(first_female_group))\n\nsecond_female_group = df_train_femele.query('boneage >= 50 and boneage < 100')\nprint('Between 50 and 100 months: ', len(second_female_group))\n\nthird_female_group = df_train_femele.query('boneage >= 100 and boneage < 150')\nprint('Between 100 and 150 months: ', len(third_female_group))\n\nfourth_female_group = df_train_femele.query('boneage >= 150 and boneage < 200')\nprint('Between 150 and 200 months: ', len(fourth_female_group))\n\nfifth_female_group = df_train_femele.query('boneage >= 200')\nprint('More than 200 months: ', len(fifth_female_group))","e21f49e7":"df_train_male = df_train.query('patientSex == \"M\"')\ndf_train_male.hist(column = 'boneage', bins = 40, color = 'blue', alpha = 0.5, figsize=(20, 10))\nplt.show()","cfc1d184":"first_male_group = df_train_male.query('boneage < 50')\nprint('Less than 50 months: ', len(first_male_group))\n\nsecond_male_group = df_train_male.query('boneage >= 50 and boneage < 100')\nprint('Between 50 and 100 months: ', len(second_male_group))\n\nthird_male_group = df_train_male.query('boneage >= 100 and boneage < 150')\nprint('Between 100 and 150 months: ', len(third_male_group))\n\nfourth_male_group = df_train_male.query('boneage >= 150 and boneage < 200')\nprint('Between 150 and 200 months: ', len(fourth_male_group))\n\nfifth_male_group = df_train_male.query('boneage >= 200')\nprint('More than 200 months: ', len(fifth_male_group))","431377b4":"import cv2\nimport numpy as np\nimport os","a9a29cc3":"def normalize_images(path):\n    df = pd.read_csv(f'\/kaggle\/input\/i2a2-bone-age-regression\/{path}.csv')\n\n    for filename in df['fileName']:\n       _clean_image(filename)","d08ec4cc":"def _clean_image(filename):\n    image = cv2.imread(f\"\/kaggle\/input\/i2a2-bone-age-regression\/images\/{filename}\")\n    contours = _get_contours(image)\n    \n    mask = np.zeros_like(image)\n    cv2.drawContours(mask, contours, -1, (0, 255, 0), 2)\n    (x, y, _) = np.where(mask == 255)\n \n    if len(x) > 0 and len(y) > 0:\n        (topx, topy) = (np.min(x), np.min(y))\n        (bottomx, bottomy) = (np.max(x), np.max(y))\n\n        image = image[topx:bottomx+1, topy:bottomy+1]\n        print('contours', len(contours))\n\n        height, width, _ = image.shape\n        print('width', width)\n\n        if width > 800:\n            width_cutoff = width \/\/ 2\n            image = image[:, width_cutoff:]\n\n    if not os.path.exists(f'\/kaggle\/output\/kaggle\/working\/clean-images'):\n      os.makedirs(f'\/kaggle\/output\/kaggle\/working\/clean-images')\n\n    cv2.imwrite(f\"\/kaggle\/output\/kaggle\/working\/clean-images\/{filename}\", image)","742ebd8a":"def _get_contours(image):\n    image_gray = cv2.cvtColor(image, cv2.COLOR_BGR2GRAY)\n\n    image_edges = cv2.Canny(image_gray, 40, 180)\n\n    contours, hierarchy = cv2.findContours(image_edges, cv2.RETR_LIST, cv2.CHAIN_APPROX_SIMPLE)\n\n    return contours","6657fea5":"normalize_images('train')","0a4c2247":"df = pd.read_csv(f'\/kaggle\/input\/i2a2-bone-age-regression\/train.csv')\ndf = df.head(10)\n\nfor filename in df['fileName']:\n  plt.title('Before')\n  before = mpimg.imread(f\"\/kaggle\/input\/i2a2-bone-age-regression\/images\/{filename}\")\n  imgplot = plt.imshow(before)\n  plt.show()\n\n  plt.title('After')\n  after = mpimg.imread(f\"\/kaggle\/output\/kaggle\/working\/clean-images\/{filename}\")\n  imgplot = plt.imshow(after)\n  plt.show()","7be568c7":"from numpy import expand_dims\nfrom keras.preprocessing.image import load_img\nfrom keras.preprocessing.image import img_to_array\nfrom keras.preprocessing.image import ImageDataGenerator","55234e5c":"image = load_img(\"\/kaggle\/output\/kaggle\/working\/clean-images\/1377.png\")\ndata = img_to_array(image)\n\nsamples = expand_dims(data, 0)\ndatagen = ImageDataGenerator(\n            rotation_range=40,\n            width_shift_range=0.2,\n            height_shift_range=0.2,\n            shear_range=0.2,\n            zoom_range=0.2,\n            horizontal_flip=True,\n            fill_mode='constant')\n\niterator = datagen.flow(samples, batch_size=1)\nfor i in range(9):\n    plt.subplot(330 + 1 + i)\n    batch = iterator.next()\n    image_generated = batch[0].astype('uint8')\n    plt.imshow(image_generated)\nplt.show()","f181cac6":"def image_generated(filename, number_samples):\n  image = load_img(f\"\/kaggle\/output\/kaggle\/working\/clean-images\/{filename}\")\n  data = img_to_array(image)\n\n  samples = expand_dims(data, 0)\n  datagen = ImageDataGenerator(\n                rotation_range=40,\n                width_shift_range=0.2,\n                height_shift_range=0.2,\n                shear_range=0.2,\n                zoom_range=0.2,\n                horizontal_flip=True,\n                fill_mode='constant')\n\n  iterator = datagen.flow(samples, batch_size=1)\n  new_images = []\n  for i in range(number_samples):\n    batch = iterator.next()\n    image_generated = batch[0].astype('uint8')\n    new_images.append(image_generated)\n  \n  return new_images","6948339b":"def update_dataset(dataset, patientSex, number_samples):\n  mean_bornage = dataset['boneage'].mean()\n\n  for filename in dataset['fileName']:\n    new_images = image_generated(filename, number_samples)\n    for idx, image in enumerate(new_images):\n      cv2.imwrite(f\"\/kaggle\/output\/kaggle\/working\/clean-images\/{idx}-{filename}\", image)\n\n      new_data = pd.DataFrame({\"fileName\":[f\"{idx}-{filename}\"], \"patientSex\":[patientSex], \"boneage\": [mean_bornage]})\n      dataset = pd.concat([dataset, new_data], ignore_index=True)\n  \n  return dataset","8300f48d":"first_increased_female_group = update_dataset(first_female_group, 'F', 4).head(1000)\nfirst_increased_female_group","3b072e12":"second_female_group = second_female_group.sample(n=1000, random_state=1)\nthird_female_group = third_female_group.sample(n=1000, random_state=1)\nfourth_female_group = fourth_female_group.sample(n=1000, random_state=1)\n\ntrain_female_final = pd.concat([first_increased_female_group, second_female_group, third_female_group, fourth_female_group], ignore_index=True)","24fc7237":"train_female_final.to_csv('\/kaggle\/output\/kaggle\/working\/F-train.csv')","0a73521e":"!ls -all -h \/kaggle\/output\/kaggle\/working","0ed26de2":"first_increased_male_group = update_dataset(first_male_group, 'M', 4).head(1000)\nfirst_increased_male_group","74a02edf":"fifth_increased_male_group = update_dataset(fifth_male_group, 'M', 4).head(1000)\nfifth_increased_male_group","2548c768":"second_male_group = second_male_group.sample(n=1000, random_state=1)\nthird_male_group = third_male_group.sample(n=1000, random_state=1)\nfourth_male_group = fourth_male_group.sample(n=1000, random_state=1)\n\ntrain_male_final = pd.concat([first_increased_male_group, second_male_group, third_male_group, fourth_male_group, fifth_increased_male_group], ignore_index=True)","09b89415":"train_male_final.to_csv('\/kaggle\/output\/kaggle\/working\/M-train.csv')","7f379d3d":"!ls -all -h \/kaggle\/output\/kaggle\/working","3464b850":"import matplotlib.pyplot as plt\nimport numpy as np\nimport os\nimport pandas as pd\nimport random\nimport tensorflow as tf\n\nfrom keras.applications.resnet import ResNet50, preprocess_input\nfrom keras.callbacks import EarlyStopping, ModelCheckpoint   \nfrom keras.layers import Conv2D, Dense, Dropout, Flatten, GlobalMaxPooling2D, MaxPooling2D\nfrom keras.models import Model, Sequential\nfrom keras.preprocessing.image import img_to_array\nfrom keras.preprocessing.image import load_img\nfrom keras.utils import np_utils\n\nfrom sklearn.model_selection import train_test_split","a2a279ee":"def init_model(patientSex, df):\n    if not os.path.isfile(f'\/kaggle\/output\/kaggle\/working\/model.hand.x-ray.weights.{patientSex}.best.hdf5'):\n        images, outputs = _prepare_dataset(df)\n        model, x, y = _train(patientSex, images, outputs)\n        print('New train!')\n    else:\n        model = _create_model()\n        model.load_weights(f'\/kaggle\/output\/kaggle\/working\/model.hand.x-ray.weights.{patientSex}.best.hdf5')\n        print('Using network trained!')\n\n    return model","0f658d0f":"def _preprocess_images(filename):\n    image = load_img(filename, target_size=(128, 128))\n    image = img_to_array(image)\n    image = image.reshape((image.shape[0], image.shape[1], image.shape[2]))\n    return preprocess_input(image) \n\ndef _prepare_dataset(df):\n    images = [_preprocess_images(f\"\/kaggle\/output\/kaggle\/working\/clean-images\/{filename}\") for filename in df['fileName']]\n    images = np.array(images, dtype=np.float32)\n\n    outputs = df['boneage']\n    outputs = np.array(outputs, dtype=np.float32)\n\n    return images, outputs","cb2e3c0d":"def _create_model():\n    base_model = ResNet50(weights=\"imagenet\", include_top=False, input_shape= (128, 128, 3))\n    \n    number_of_frozen_layers = 0\n    for i, layer in enumerate(base_model.layers):\n      if i>=number_of_frozen_layers:\n        break\n      layer.trainable = False\n\n    x = GlobalMaxPooling2D()(base_model.output)\n    x = Flatten()(x)\n    x = Dense(16, activation = 'relu')(x)\n    x = Dense(1, activation = 'linear')(x)\n\n    model = Model(base_model.input, x)\n    model.summary()\n    \n    return model","f8f77fa9":"def _train(patientSex, images, outputs):\n    print('Number images:', len(images))\n    print('Number outputs:', len(outputs))\n\n    # divindo dataset de treinamento em treinamento, teste e valida\u00e7\u00e3o\n    seed = 42\n    x_train, x_test, y_train, y_test = train_test_split(images, outputs, test_size = 0.20, random_state=seed)\n    x_train, x_valid, y_train, y_valid = train_test_split(x_train, y_train, test_size = 0.20, random_state = seed)\n\n    # normaliza\u00e7\u00e3o\n    x_train = x_train.astype('float32')\/255\n    x_valid = x_valid.astype('float32')\/255\n    x_test = x_test.astype('float32')\/255\n\n    # mudando escala de idades para valores entre [0-1]\n    max_bornage = outputs.max()\n    y_train = y_train \/ max_bornage\n    y_valid = y_valid \/ max_bornage\n    y_test = y_test \/ max_bornage\n\n    model = _create_model()\n    model.compile(loss='mse', optimizer='adam', metrics=['mse'])\n\n    checkpointer = [ModelCheckpoint(filepath=f'\/kaggle\/output\/kaggle\/working\/model.hand.x-ray.weights.{patientSex}.best.hdf5', save_best_only=True),\n                    EarlyStopping(patience= 5)]\n    history = model.fit(x_train, y_train,\n           batch_size=32,\n           epochs=50,\n           verbose=1,\n           validation_data=(x_valid, y_valid),\n           callbacks=checkpointer)\n    \n    plt.plot(history.history['mse'])\n    plt.show()\n    \n    # carregando os pesos que geraram a melhor precis\u00e3o de valida\u00e7\u00e3o\n    model.load_weights(f'\/kaggle\/output\/kaggle\/working\/model.hand.x-ray.weights.{patientSex}.best.hdf5')\n\n    # avaliar e imprimir a precis\u00e3o do teste\n    loss, mse = model.evaluate(x_test, y_test, verbose=2)\n    print(\"Testing set Mean Square Error: {:5.2f} MPG\".format(mse))\n\n    return model, x_test, y_test","37f3fca0":"df_F = pd.read_csv(f'\/kaggle\/output\/kaggle\/working\/F-train.csv')\nimages, outputs = _prepare_dataset(df_F)","d7208827":"model, x_test, y_test = _train('F', images, outputs)","25461200":"max_bornage = outputs.max()\npredict_boneages = max_bornage * model.predict(x_test, batch_size = 32, verbose = True)\nreal_boneages = max_bornage * y_test\n\nord_ind = np.argsort(y_test)\nord_ind = ord_ind[np.linspace(0, len(ord_ind)-1, 8).astype(int)]\nfig, axs = plt.subplots(4, 2, figsize = (15, 30))\nfor (ind, ax) in zip(ord_ind, axs.flatten()):\n    ax.imshow(x_test[ind, :,:,0], cmap = 'bone')\n    ax.set_title('Age: %fY\\nPredicted Age: %fY' % (real_boneages[ind], \n                                                   predict_boneages[ind]))\n    ax.axis('off')\nfig.savefig('image_predictions-F.png', dpi = 300)","ac3962de":"fig, ax = plt.subplots(figsize = (7,7))\nax.plot(real_boneages, predict_boneages, 'r.', label = 'predictions')\nax.plot(real_boneages, real_boneages, 'b-', label = 'actual')\nax.legend(loc = 'upper right')\nax.set_xlabel('Actual Age (Months)')\nax.set_ylabel('Predicted Age (Months)')","90b96333":"df_M = pd.read_csv(f'\/kaggle\/output\/kaggle\/working\/M-train.csv')\nimages_M, outputs_M = _prepare_dataset(df_M)","9e4534d1":"model_M, x_test_M, y_test_M = _train('M', images_M, outputs_M)","9a9b7e2d":"max_bornage_M = outputs_M.max()\npredict_boneages_M = max_bornage_M * model.predict(x_test_M, batch_size = 32, verbose = True)\nreal_boneages_M = max_bornage_M * y_test_M\n\nord_ind = np.argsort(y_test_M)\nord_ind = ord_ind[np.linspace(0, len(ord_ind)-1, 8).astype(int)]\nfig, axs = plt.subplots(4, 2, figsize = (15, 30))\nfor (ind, ax) in zip(ord_ind, axs.flatten()):\n    ax.imshow(x_test_M[ind, :,:,0], cmap = 'bone')\n    ax.set_title('Age: %fY\\nPredicted Age: %fY' % (real_boneages_M[ind], \n                                                   predict_boneages_M[ind]))\n    ax.axis('off')\nfig.savefig('image_predictions-M.png', dpi = 300)","7899227b":"fig, ax = plt.subplots(figsize = (7,7))\nax.plot(real_boneages_M, predict_boneages_M, 'r.', label = 'predictions')\nax.plot(real_boneages_M, real_boneages_M, 'b-', label = 'actual')\nax.legend(loc = 'upper right')\nax.set_xlabel('Actual Age (Months)')\nax.set_ylabel('Predicted Age (Months)')","3d7be521":"df_submission = pd.read_csv('\/kaggle\/input\/i2a2-bone-age-regression\/sample_submission.csv')\ndf_submission.head()","a9d1dbd8":"normalize_images('sample_submission')","9572f80b":"df_girls = df_submission.query('patientSex == \"F\"')\nX_girls, Y_girls = _prepare_dataset(df_girls)\n\n# normalize\nX_girls = X_girls.astype('float32')\/255\n\nmax_bornage_girls = Y_girls.max()\nY_girls = Y_girls \/ max_bornage_girls","2612c886":"model_girls = init_model('F', df_girls)","f48014b6":"predicted = model_girls.predict_generator(X_girls)\npredicted_months = max_bornage_girls*(predicted.flatten())\n\nfilenames = df_girls['fileName']\nresults_girls = pd.DataFrame({\"fileName\": filenames,\n                      \"boneage\": predicted_months})\n\nresults_girls.head()","63cf5322":"df_boys = df_submission.query('patientSex == \"M\"')\nX_boys, Y_boys = _prepare_dataset(df_boys)\n\n# normalize\nX_boys = X_boys.astype('float32')\/255\n\nmax_bornage_boys = Y_boys.max()\nY_boys = Y_boys \/ max_bornage_boys","34e80a13":"model_boys = init_model('M', df_boys)","ce3aadec":"predicted = model_boys.predict_generator(X_boys)\npredicted_months = max_bornage_boys*(predicted.flatten())\n\nfilenames = df_boys['fileName']\nresults_boys = pd.DataFrame({\"fileName\": filenames,\n                      \"boneage\": predicted_months})\n\nresults_boys.head()","7b4d46b0":"results = pd.concat([results_girls, results_boys], ignore_index=True)","e2bd4190":"results.to_csv(\"results.csv\",index=False)","16cfa27d":"# Results","b67db353":"## Prepare train dataset","ab47108c":"Clean images in train dataset.","a51bc77e":"First, let's clean the dataset images to extract realy Hand X-Ray images, without for example black boards around and things possible to disturb the neural network learning.","6846accc":"Like we saw before, the numbers images to ages is very differnet. So the train dataset isn't balanced enought to apply a model.\n\nFor that, we'll increase images in range with less images and use less images in age ranges where there much more than is necessary.\n\nWe'll use data augmentation to it.","03376fad":"## Neural network","ae8b3ea3":"A example to apply data augementation to generate new images from one.","b5b123d9":"## Analyse data","0af0dfc1":"Now, We'll separe what data in train dataset will be incresed.\n\nWe have already seen that train datasest isn't balanced. Look again girl's data.","ecdc14eb":"So, we'll the same to boys's data.\n\nIn this case, we'll increase the first and the last groups doing a dataset with 5000 samples, 1000 samples of each group.","b6d01fe8":"## Prepare images","e7ea473d":"In `df_train_femele` we'll increase the first group, and choose ramdon 1000 elemnets each other group to create a balanced dataset with 4000 samples.\n\nWe won't use the last group because it has so small numbers of images.","8bc11d6d":"This is the first notebook for this solution. Here we'll only analyse data and prepare datasets to apply on neural networks models in the next notebook.","3aea255f":"Girls and boys like women and men have so much different ossea structure, for that, for this solution, we'll train two models one to apply to girls Hand X-Ray and another to boys.","9a62460c":"We run dataset in diferents models, filter to girls and boys.","92ffd57f":"This is the first notebook for this solution. Here we'll only analyse data and prepare datasets to apply on neural networks models in the next notebook.","0415355e":"Examples images before and after."}}