{"cell_type":{"7bf2507a":"code","74860768":"code","c07b4563":"code","7fd267be":"code","d7c78cf3":"code","7ca41b2f":"code","edf75508":"code","5e3b7594":"code","0c6e38d4":"code","02290aae":"code","d092e3ce":"code","4ad5769c":"code","d24d5f8d":"code","0b68d708":"code","a6d94f7c":"code","742fba4e":"code","8b043bee":"code","2a3b0d7e":"code","18e81506":"code","618e8138":"code","1a567997":"code","eed66dbe":"code","94bd08f3":"code","87ecf6b6":"code","eba30a16":"code","70dc6ac1":"code","280d4e47":"code","55d4547a":"code","f4ffe670":"code","63cdfc1b":"code","20a022de":"code","aee45858":"code","e3821bfe":"code","d6c00236":"code","32be4e16":"code","04ce4d18":"code","10cdb81b":"code","1d541298":"code","46f7c9f5":"code","6ecc96cd":"code","5d1ad1f6":"code","8cdc6226":"code","a5afe922":"code","cc53d364":"code","f684363f":"code","ce7bc8b2":"code","8363519b":"code","92cf9d37":"code","f20bb2a1":"code","28cc1b1d":"code","3b570c42":"code","7a96bd38":"code","00dd8175":"code","cecc0c61":"code","78208f80":"code","e7df740e":"code","9ea003a8":"code","1bd97dbf":"code","25894d14":"code","bb45e6dd":"code","9bf330bc":"code","6a9fcb83":"code","94108515":"code","8b177082":"code","f27ea540":"code","89f851b1":"code","61c5e390":"code","bbc9b5aa":"code","18f9c056":"code","5f9708a5":"code","706f1bd5":"code","60c213dd":"code","e66b88df":"code","e926e9f1":"code","ad5e9a5e":"code","c4bde26d":"code","db8207ee":"code","a1cdb548":"code","5afb8afb":"code","4ae57b76":"code","e3c5bcbd":"code","43e815e6":"markdown","ab3d372f":"markdown"},"source":{"7bf2507a":"# imports\n\nimport pymysql as pms\nimport pandas as pd\nimport numpy as np\nimport seaborn as sns\nimport matplotlib.pyplot as plt\n%matplotlib inline\nimport sklearn.linear_model as slm\nimport sklearn.metrics as sm\nfrom sklearn.model_selection import train_test_split as split\nfrom sklearn.model_selection import GridSearchCV\nimport sklearn.svm as svm\nimport sklearn.ensemble as sen\nimport sklearn.preprocessing as sp","74860768":"conn=pms.Connect(host='localhost', user='root', passwd='SenanTuran25', db='ds2')","c07b4563":"dt=pd.read_sql('select * from b1612', con=conn)","7fd267be":"pd.set_option('display.max_columns', None)\npd.set_option('display.max_rows', None)","d7c78cf3":"dt.head()","7ca41b2f":"df=dt[(dt['teyinat']=='Istehlak')&(dt['kr_kx']=='KR')&(dt['date_start']>='2013-01-01')&((dt['amount']*dt['exrate'])<40000)]","edf75508":"df.head()","5e3b7594":"df.shape, dt.shape","0c6e38d4":"df['dft']=None","02290aae":"df.head()","d092e3ce":"#1.df['dft']=df.max_over_days.apply(lambda x: int((x>120)))\n#2.\n\"\"\"   def a(x):\n          if (x>120):\n              return 1\n          else:\n              return 0\ndf['dft']=df.max_over_days.apply(a)\n\"\"\"\ndf['dft']=(df.max_over_days>360).astype(np.int8)\n\ndf.head()","4ad5769c":"df.dft.value_counts()","d24d5f8d":"df.dft.sum()","0b68d708":"df=df[(df.max_over_days>360)|(df.max_over_days<=120)]\ndf.head()","a6d94f7c":"df.dft.value_counts(), df.shape","742fba4e":"df.columns","8b043bee":"dm=df.drop(columns=['npl_group','cust_id','account_ssuda','teyinat','kr_kx','res_pricipal', 'over_days_prin',\n'arr_prin', 'over_days_int', 'arr_int', 'max_over_days'])\ndm.head()","2a3b0d7e":"dm['clt_amount']=dm['amount']*dm['exrate']\ndm.drop(columns=['amount'], inplace=True)\ndm.head()","18e81506":"dm.currency.value_counts()","618e8138":"dm=pd.get_dummies(dm, columns=['currency'],prefix=['cur'])\ndm.head()","1a567997":"def yd(d):\n    return str(d)[0:4]\ndef mn(a):\n    return str(a)[5:7]","eed66dbe":"dm['year']=dm.date_start.apply(yd)\ndm['month']=dm.date_start.apply(mn)\ndm.drop(columns=['branch_code','date_end', 'annuity', 'exrate', 'cur_USD'], inplace=True)\ndm.head()","94bd08f3":"dm.year.value_counts(), dm.month.value_counts()","87ecf6b6":"dm=pd.get_dummies(dm, prefix=['yr','mn'], columns=['year', 'month'])\ndm.head()","eba30a16":"dm.drop(columns=['date_start','yr_2014','mn_10'], inplace=True)\ndm.head()","70dc6ac1":"Pl=sp.PolynomialFeatures()","280d4e47":"poly=pd.DataFrame(Pl.fit_transform(dm[['maturity','intrate','clt_amount']]))\npoly.head()","55d4547a":"Pl.get_feature_names(input_features=['maturity','intrate','clt_amount'])","f4ffe670":"poly.columns=['1',\n 'maturity',\n 'intrate',\n 'clt_amount',\n 'maturity^2',\n 'maturity__intrate',\n 'maturity__clt_amount',\n 'intrate^2',\n 'intrate__clt_amount',\n 'clt_amount^2']\npoly.drop(columns=['1'], inplace=True)\npoly.head()","63cdfc1b":"dm.reset_index(drop=True, inplace=True)\ndm.head()","20a022de":"dm=dm.drop(columns=['maturity','intrate','clt_amount']).merge(poly, left_index=True, right_index=True)\ndm.head()","aee45858":"x_train, x_test, y_train, y_test=split(dm.drop(columns=['dft']),dm[['dft']], test_size=0.25, random_state=25)","e3821bfe":"x_train.reset_index(drop=True, inplace=True)\ny_train.reset_index(drop=True, inplace=True)\nx_test.reset_index(drop=True, inplace=True)\ny_test.reset_index(drop=True, inplace=True)","d6c00236":"nms=['maturity',\n 'intrate',\n 'clt_amount',\n 'maturity^2',\n 'maturity__intrate',\n 'maturity__clt_amount',\n 'intrate^2',\n 'intrate__clt_amount',\n 'clt_amount^2']","32be4e16":"rb=sp.RobustScaler()","04ce4d18":"sc_x_train=pd.DataFrame(rb.fit_transform(x_train[nms]), \ncolumns=[nms])\nsc_x_train.head()","10cdb81b":"x_train.head()","1d541298":"x_train.drop(columns=nms, inplace=True)","46f7c9f5":"x_train.head()","6ecc96cd":"x_train=x_train.merge(sc_x_train,left_index=True, right_index=True)\nx_train.head()","5d1ad1f6":"x_train.columns","8cdc6226":"x_train.columns=['cur_AZN','cur_EUR',\n'yr_2013',  'yr_2015',\n'yr_2016', 'mn_01','mn_02','mn_03','mn_04','mn_05',\n'mn_06','mn_07','mn_08','mn_09','mn_11','mn_12','maturity','intrate',\n'clt_amount', 'maturity^2','maturity__intrate', 'maturity__clt_amount',\n'intrate^2',  'intrate__clt_amount','clt_amount^2']\nx_train.head()","a5afe922":"sc_x_test=pd.DataFrame(rb.transform(x_test[nms]), columns=nms)\nsc_x_test.head()","cc53d364":"x_test.drop(columns=nms, inplace=True)\nx_test.head()","f684363f":"x_test=x_test.merge(sc_x_test, left_index=True, right_index=True)\nx_test.head()","ce7bc8b2":"# Logistic Regression\nlogreg1=slm.LogisticRegression(penalty='none')","8363519b":"logreg1.fit(x_train, y_train)","92cf9d37":"pd.DataFrame(logreg1.coef_)","f20bb2a1":"prd=pd.DataFrame(logreg1.predict(x_test), columns=['Prd_(0.5)'])\nprd.head()","28cc1b1d":"pd.DataFrame(logreg1.predict_proba(x_test)).head()","3b570c42":"cutoff=y_train.dft.mean()\ncutoff","7a96bd38":"pd.set_option('display.precision', 15)","00dd8175":"prd['Prd_(ctff=0.63)']=(pd.DataFrame(logreg1.predict_proba(x_test))[1]>cutoff).astype(np.int8)\nprd.head()","cecc0c61":"sm.accuracy_score(y_test, prd['Prd_(0.5)'])","78208f80":"sm.accuracy_score(y_test, prd['Prd_(ctff=0.63)'])","e7df740e":"sm.balanced_accuracy_score(y_test, prd['Prd_(0.5)'])","9ea003a8":"sm.balanced_accuracy_score(y_test, prd['Prd_(ctff=0.63)'])","1bd97dbf":"print(sm.classification_report(y_test, prd['Prd_(ctff=0.63)']),'\\n\\n', \nsm.confusion_matrix(y_test, prd['Prd_(ctff=0.63)']))","25894d14":"prd.columns","bb45e6dd":"prd.columns=['Prd_(ctff=0.5)_noRgl', 'Prd_(ctff=0.63)_noRgl']\nprd.head()","9bf330bc":"logreg2=slm.LogisticRegressionCV(cv=5, penalty='l1', Cs=[0.1,1,10,100,1000], solver='saga', max_iter=100000)","6a9fcb83":"logreg2.fit(x_train, y_train)","94108515":"logreg2.C_","8b177082":"logreg2.coef_","f27ea540":"pd.DataFrame(logreg2.coef_.T, index=x_train.columns)  # T--transpose()","89f851b1":"prd['Prd_(ctff=0.5)_l1']=pd.DataFrame(logreg2.predict(x_test))\nprd['Prd_(ctff=0.63)_l1']=(pd.DataFrame(logreg2.predict_proba(x_test))[1]>cutoff).astype(np.int8)\nprd.head()","61c5e390":"sm.accuracy_score(y_test, prd['Prd_(ctff=0.5)_l1']), sm.accuracy_score(y_test, prd['Prd_(ctff=0.63)_l1'])","bbc9b5aa":"sm.balanced_accuracy_score(y_test, prd['Prd_(ctff=0.5)_l1']), sm.balanced_accuracy_score(y_test, prd['Prd_(ctff=0.63)_l1'])","18f9c056":"print(sm.classification_report(y_test, prd['Prd_(ctff=0.63)_l1']), '\\n',sm.confusion_matrix(y_test, prd['Prd_(ctff=0.63)_l1']))","5f9708a5":"# SVM.SVC\nregsvc=svm.SVC()\nregsvc.fit(x_train, y_train)","706f1bd5":"prd['Prd_SVC']=regsvc.predict(x_test)\nprd.head()","60c213dd":"sm.accuracy_score(y_test, prd['Prd_SVC'])","e66b88df":"# random forest\nrf_reg=sen.RandomForestClassifier()\nrf_reg.fit(x_train, y_train)","e926e9f1":"prd['Prd_rfc']=rf_reg.predict(x_test)\nprd['Prd_rfc_(ctff=0.63)']=(pd.DataFrame(rf_reg.predict_proba(x_test))[1]>cutoff).astype(np.int8)\nprd.head()","ad5e9a5e":"sm.accuracy_score(y_test, prd['Prd_rfc']), sm.accuracy_score(y_test, prd['Prd_rfc_(ctff=0.63)'])","c4bde26d":"print(sm.classification_report(y_test,prd['Prd_rfc_(ctff=0.63)']),'\\n' ,sm.confusion_matrix(y_test, prd['Prd_rfc_(ctff=0.63)']))","db8207ee":"fpr, tpr, threshold=sm.roc_curve(y_test, pd.DataFrame(logreg1.predict_proba(x_test))[1])","a1cdb548":"plt.plot(fpr, tpr, 'darkorange')\nplt.plot([0,1],[0,1], 'b--')\nplt.xlim([0,1])\nplt.ylim([0,1])\nplt.xlabel('False positives')\nplt.ylabel('True positives')\nplt.legend(['lorenz curve'])","5afb8afb":"sm.auc(fpr, tpr)","4ae57b76":"# gini coefficient\ngini=2*sm.auc(fpr, tpr)-1","e3c5bcbd":"gini","43e815e6":"# (auc-0.5)\/0.5=2*auc(fpr,tpr)-1","ab3d372f":"# Lorenz curve, gini coefficient"}}