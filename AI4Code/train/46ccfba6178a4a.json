{"cell_type":{"7b2ebb5d":"code","71460c04":"code","1dec8592":"code","120ea2b1":"code","8389ecf6":"code","cb4f40d3":"code","f551771f":"code","de834d2c":"code","f70043a6":"code","6acbc204":"code","3c670b93":"code","a9322310":"code","fca5e14a":"code","6dd8d919":"code","f3549e90":"code","871baa15":"code","de1adf39":"code","47a170a7":"code","9c73d191":"code","c5019497":"code","abde4e1a":"code","ee16ca6c":"code","40bccaad":"code","69704c8e":"code","1e1881ea":"code","bb24ce82":"code","1258b375":"markdown","3ededc00":"markdown","8634fabd":"markdown","49ca096c":"markdown","5a1a30fb":"markdown","65adb0ea":"markdown","70571bb6":"markdown","e975ad60":"markdown","497d15cb":"markdown","d35d1f10":"markdown","ccbad7cd":"markdown","3a9b315c":"markdown","6e01cb89":"markdown","cac1a4ed":"markdown","2dda0ed2":"markdown","df6dcc27":"markdown","9bb2caa5":"markdown","2fff7022":"markdown","7c17295f":"markdown","fa4bdb7a":"markdown"},"source":{"7b2ebb5d":"# numpy\nimport numpy as np\nfrom scipy.stats import pearsonr as p\nimport pandas as pd\nimport matplotlib.pyplot as plt\n\nimport seaborn as sns\nsns.set(rc={'figure.figsize':(15,13)})\n\nimport datatable as dt\n\n# garbage collector to keep RAM in check\nimport gc  \n\n# system\nimport warnings\nwarnings.filterwarnings('ignore')","71460c04":"%%time\n!wc -l ..\/input\/ubiquant-market-prediction\/train.csv","1dec8592":"%%time\ntrain_data = dt.fread('..\/input\/ubiquant-market-prediction\/train.csv')","120ea2b1":"%%time\ntrain_data = train_data.to_pandas()","8389ecf6":"print(train_data.columns)","cb4f40d3":"train_data['investment_id'].nunique()","f551771f":"print(f'Investment index is in the range from {min(train_data.investment_id.unique())} to {max(train_data.investment_id.unique())}')","de834d2c":"plt.figure(figsize=(20,10))\nplt.subplot(2,1,1)\nplt.plot(train_data['time_id'], train_data['target'], color='black', lw=0.1)\nplt.ylabel (f'Target', fontsize=18);\nplt.xticks([])\nplt.tight_layout()\n\nplt.subplot(2,1,2)\nplt.plot(train_data.groupby('time_id')['investment_id'].nunique(), color='black', lw=1)\nplt.plot(train_data.groupby('time_id')['investment_id'].nunique().rolling(30).mean(), color='red', lw=2)\nplt.ylabel (f'Number of assets', fontsize=18);\nplt.xlabel ('Time_id', fontsize=18)\nplt.tight_layout()\n\nplt.show()\ngc.collect()","f70043a6":"plt.figure(figsize=(20,10))\nplt.subplot(2,1,1)\nplt.plot(train_data['investment_id'], train_data['target'], color='gray', lw=0.1)\nplt.plot(train_data.groupby('investment_id')['target'].mean(), color='red', lw=1)\nplt.plot(train_data.groupby('investment_id')['target'].std(), color='blue', lw=1)\nplt.ylabel (f'Target', fontsize=18);\nplt.xticks([])\nplt.tight_layout()\n\nplt.subplot(2,1,2)\nplt.plot(train_data.groupby('investment_id')['time_id'].nunique(), color='black', lw=1)\nplt.ylabel (f'Number of time_id', fontsize=18);\nplt.xlabel ('Assets', fontsize=18)\nplt.tight_layout()\n\nplt.show()\ngc.collect()","6acbc204":"plt.figure(figsize=(20,5))\nplt.plot(train_data.groupby('investment_id')['target'].mean(), color='red', lw=1)\nplt.ylabel (f'Mean of target over each asset', fontsize=18);\nplt.xlabel (f'Assets', fontsize=18);\nplt.xticks([])\nplt.tight_layout()\nplt.show()\ngc.collect()","3c670b93":"plt.figure(figsize = (12,5))\nax = sns.distplot(train_data['target'], bins=1000)\nplt.xlim(-3,3)\nplt.xlabel(\"Histogram of the IRR values\", size=18)\nplt.show();\ngc.collect();","a9322310":"print(f'Skew and kurtosis of the target are: {train_data.target.skew()} and {train_data.target.kurtosis()}')","fca5e14a":"plt.figure(figsize=(20,5))\nplt.title ('Cumulative net return', fontsize=18)\nplt.plot(train_data['time_id'], train_data['target'].cumsum(), color='green', lw=2);\nplt.ylabel (f'Overall return', fontsize=18);\nplt.xlabel ('Time_id', fontsize=18)\nplt.show()","6dd8d919":"plt.figure(figsize=(20,20))\nfor i in range(5):\n    plt.subplot(5,1,i+1)\n    cumReturn = train_data.loc[train_data['investment_id']==i,'target'].cumsum()\n    time_id = train_data.loc[train_data['investment_id']==i,'time_id']\n    plt.plot(time_id, cumReturn, color='green', lw=2);\n    plt.ylabel (f'Return {i}', fontsize=18);\n\nplt.xlabel ('Time_id', fontsize=18)\ndel cumReturn, time_id\ngc.collect();","f3549e90":"plt.figure(figsize=(20,20))\nfor i in range(5):\n    plt.subplot(5,1,i+1)\n    for j in range(300):\n        feature = train_data.loc[train_data['investment_id']==i,f'f_{j}'].cumsum()\n        time_id = train_data.loc[train_data['investment_id']==i,'time_id']\n        plt.plot(time_id, feature, color='gray', lw=0.1);\n    plt.ylabel (f'Invest {i}', fontsize=18);\n\nplt.xlabel ('Time_id', fontsize=18)\ndel feature, time_id\ngc.collect();","871baa15":"%%time\nsns.heatmap(train_data[[f'f_{i}' for i in range(100)]].corr());","de1adf39":"corr = []\nfor i in range(300):\n    corr.append( train_data['target'].corr(train_data[f'f_{i}']) )","47a170a7":"plt.figure(figsize=(10,7))\nplt.plot(corr, 'k')\nplt.xlabel('Features', fontsize=16)\nplt.ylabel('Target', fontsize=16)\nplt.title('Correlation between target and features', fontsize=18)\nplt.show()","9c73d191":"corr.index(max(corr))","c5019497":"corr = []\nfor i in range(300):\n    corr.append( train_data['target'].cumsum().corr(train_data[f'f_{i}'].cumsum()) )","abde4e1a":"plt.figure(figsize=(10,7))\nplt.plot(corr, 'k.')\nplt.xlabel('Features', fontsize=16)\nplt.ylabel('Target', fontsize=16)\nplt.title('Correlation between target and features', fontsize=18)\nplt.show()","ee16ca6c":"len([idx for idx, elem in enumerate(corr) if abs(elem)>0.95])","40bccaad":"groups = train_data.groupby('investment_id').size()\n\nplt.plot(groups, 'k.')\nplt.xlabel('Investments')\nplt.ylabel('Number of time ids')\nplt.show()","69704c8e":"[i for i, val in enumerate(groups) if val < 200]","1e1881ea":"groups = train_data.groupby('investment_id')['time_id'].max()\n\nplt.plot(groups, 'k.')\nplt.xlabel('Investments')\nplt.ylabel('Max time ids')\nplt.show()","bb24ce82":"groups = train_data.groupby('investment_id')['time_id'].min()\n\nplt.plot(groups, 'k.')\nplt.xlabel('Investments')\nplt.ylabel('Min time ids')\nplt.show()","1258b375":"#### Feature that correlates most with the target","3ededc00":"#### Correlation between the features","8634fabd":"# 3. The target: investment return rate (IRR)","49ca096c":"# 4. Features","5a1a30fb":"#### Most of cumulated features correlate perfectly with cumulated target!!!","65adb0ea":"# Introduction\nRegardless of your investment strategy, fluctuations are expected in the financial market. Despite this variance, professional investors try to estimate their overall returns. Risks and returns differ based on investment types and other factors, which impact stability and volatility. To attempt to predict returns, there are many computer-based algorithms and models for financial market trading. Yet, with new techniques and approaches, data science could improve quantitative researchers' ability to forecast an investment's return.\n\n\n\nUbiquant Investment (Beijing) Co., Ltd is a leading domestic quantitative hedge fund based in China. Established in 2012, they rely on international talents in math and computer science along with cutting-edge technology to drive quantitative financial market investment. Overall, Ubiquant is committed to creating long-term stable returns for investors.\n\nIn this competition, you\u2019ll build a model that forecasts an investment's return rate. Train and test your algorithm on historical prices. Top entries will solve this real-world data science problem with as much accuracy as possible.\n\nIf successful, you could improve the ability of quantitative researchers to forecast returns. This will enable investors at any scale to make better decisions. You may even discover you have a knack for financial datasets, opening up a world of new opportunities in many industries.","70571bb6":"## Contents\n\n1. Load data\n2. General information\n3. Analysis the target\n4. Analysis the features","e975ad60":"#### IRR randomly variate in the range (-10,10). The variation of its deviation seems to correlate with the number of assets that increases linearly with time. This trend may continue for the next 200 time_ids.  ","497d15cb":"#### There are 3579 investments indexed in the rage from 0 to 3773, i.e. not all the indexes in this range is used.","d35d1f10":"# 1. Load data\n#### The train.csv is large: 18.557G with 3141411 rows","ccbad7cd":"Credit: this analysis is inspired by the seminal [nootbook](https:\/\/www.kaggle.com\/carlmcbrideellis\/jane-street-eda-of-day-0-and-feature-importance)","3a9b315c":"#### Cumulated features of some investments","6e01cb89":"# 2. General information\n\n#### There are 304 columns in the train dataset including *row_id*, *time_id*, *investment_id*, *target* and 300 features","cac1a4ed":"## Good luck!","2dda0ed2":"# 5. Investments\n\n#### There are many investment with just few time id. They may not be relevant for the training.","df6dcc27":"#### We should not use **pandas** to load this file. Indeed, we should use **datatable** to avoid OOM issue and speed up the loading process then convert the loaded data to pandas dataframe.","9bb2caa5":"#### Some individual investments has positive return","2fff7022":"#### Correlation between features and target","7c17295f":"#### Assuming an uniform investment (all investment have the same weight), the overall investment is in loss ^_^","fa4bdb7a":"#### There are 202 correlations with an absolute correlation coefficient over 0.95 "}}