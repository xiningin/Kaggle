{"cell_type":{"055f3e03":"code","e9da82da":"code","ce192fc0":"code","b12d1707":"code","94d40abb":"code","9988ffc5":"code","46f4cc89":"code","a9930587":"code","1400a06c":"code","da4bccfc":"code","c44d9b5f":"code","9c65401e":"code","3a38572f":"code","1868f637":"code","98d524c4":"code","c7035b35":"code","f7f5e031":"code","87170a51":"code","35166183":"code","b8bfc4c9":"code","e3d6f48c":"code","994b0638":"code","60ab281e":"code","d3077aa5":"code","fab962f7":"code","fb1495d6":"code","a517523d":"code","58f21dfb":"code","09f2f8e1":"code","f3aa5c32":"markdown","0a39c858":"markdown","055baf88":"markdown","efe3bf13":"markdown","723b6169":"markdown","21e832b9":"markdown","38954c99":"markdown","154ae776":"markdown","d123ab88":"markdown","74fe70c2":"markdown","cd335ee4":"markdown","85fbfc7f":"markdown","5aa99889":"markdown","d52a55cb":"markdown","1b385df3":"markdown","b8dc5f3f":"markdown"},"source":{"055f3e03":"!pip install pycaret==2.3.1","e9da82da":"!pip install shap","ce192fc0":"import numpy as np\nimport pandas as pd\nimport matplotlib.pyplot as plt\n%matplotlib inline\nimport seaborn as sns\n\nimport warnings\nwarnings.simplefilter(action='ignore', category=FutureWarning)\n\nfrom pycaret.regression import setup, compare_models, create_model, tune_model, finalize_model, blend_models, predict_model, interpret_model\nimport shap","b12d1707":"train = pd.read_csv('..\/input\/tabular-playground-series-jul-2021\/train.csv')\ntest = pd.read_csv('..\/input\/tabular-playground-series-jul-2021\/test.csv')\nsub = pd.read_csv('..\/input\/tabular-playground-series-jul-2021\/sample_submission.csv')\n\n# date_time\u3092\u65e5\u4ed8\u578b\u306b\u5909\u63db\ntrain['date_time'] = pd.to_datetime(train['date_time'])\ntest['date_time'] = pd.to_datetime(test['date_time'])","94d40abb":"train_temp = train.loc[:,['target_carbon_monoxide','target_benzene','target_nitrogen_oxides','sensor_1','sensor_2','sensor_3','sensor_4','sensor_5']]\nsns.pairplot(train_temp)","9988ffc5":"sel_train = train[6600:6900].copy()\ncols = ['target_carbon_monoxide','target_benzene','target_nitrogen_oxides','deg_C', 'relative_humidity','absolute_humidity', 'sensor_1', 'sensor_2', 'sensor_3', 'sensor_4' ,'sensor_5']\nfor col in train[cols].columns:\n    plt.figure(figsize=(16,4))\n    plt.plot(sel_train.date_time, sel_train[col])\n    plt.ylabel(col)\n    plt.show()","46f4cc89":"def plot_data(df, name1, num1, name2,num2):\n    plt.figure(figsize=(16,4))\n    plt.plot(df.date_time, df[name1]*num1, label=name1)\n    plt.plot(df.date_time, df[name2]*num2, label=name2)\n    plt.legend()\n    plt.show()","a9930587":"plot_data(train, 'target_benzene', 1, 'target_carbon_monoxide', 4.6)\nplot_data(train[:300], 'target_benzene', 1, 'target_carbon_monoxide', 4.6)\nplot_data(train[6800:7100], 'target_benzene', 1, 'target_carbon_monoxide', 4.6)","1400a06c":"plot_data(train, 'target_benzene', 19, 'target_nitrogen_oxides', 1)\nplot_data(train[:300], 'target_benzene', 19, 'target_nitrogen_oxides', 1)\nplot_data(train[6800:7100], 'target_benzene', 19, 'target_nitrogen_oxides', 1)","da4bccfc":"# \u65e5\u4ed8\u306e\u7279\u5fb4\u91cf\u3092\u5897\u3084\u3059\ntrain['week_day'] = train['date_time'].dt.weekday\ntrain['hour'] = train['date_time'].dt.hour\n\n# \u30bb\u30f3\u30b5\u30fc\u304c\u30aa\u30d5\u306e\u3068\u304d1\ntrain['IsSensorOff'] = 0\ntrain.loc[train['absolute_humidity'] < 0.24 , 'IsSensorOff'] = 1\n\n# \u6708\u5e73\u5747\u6e29\u5ea6\u3092\u8ffd\u52a0\ntrain['month'] = train['date_time'].dt.month\ntrain.loc[:, 'degC_month'] = train.groupby(['month'])['deg_C'].transform('mean')\n\n# \u65e5\u4ed8\u306e\u7279\u5fb4\u91cf\u3092\u5897\u3084\u3059\ntest['week_day'] = test['date_time'].dt.weekday\ntest['hour'] = test['date_time'].dt.hour\n\n# \u30bb\u30f3\u30b5\u30fc\u304c\u30aa\u30d5\u306e\u3068\u304d1\ntest['IsSensorOff'] = 0\ntest.loc[test['absolute_humidity'] < 0.24 , 'IsSensorOff'] = 1\n\n# \u6708\u5e73\u5747\u6e29\u5ea6\u3092\u8ffd\u52a0\ntest['month'] = test['date_time'].dt.month\ntest.loc[:, 'degC_month'] = test.groupby(['month'])['deg_C'].transform('mean')","c44d9b5f":"train1 = train.loc[:,['IsSensorOff','degC_month','week_day','hour','sensor_1','sensor_2','sensor_3','sensor_4','sensor_5','target_carbon_monoxide']]\ntrain1.head()","9c65401e":"reg1 = setup(data=train1, target='target_carbon_monoxide',categorical_features=[\"IsSensorOff\", \"week_day\", \"hour\"], session_id=1)","3a38572f":"catboost1 = create_model(\"catboost\", fold=4)\net1 = create_model(\"et\", fold=4)\nlightgbm1 = create_model(\"lightgbm\", fold=4)\ngbr1 = create_model(\"gbr\", fold=4)\nrf1 = create_model(\"rf\", fold=4)\nblend1 = blend_models(estimator_list= [catboost1, et1, lightgbm1, gbr1, rf1], fold=4)\npred_h1 = predict_model(blend1)\nfinal1 = finalize_model(blend1)\npred1 = predict_model(final1, data=test)","1868f637":"interpret_model(catboost1)","98d524c4":"interpret_model(lightgbm1)","c7035b35":"interpret_model(rf1)","f7f5e031":"train2 = train.loc[:,['sensor_2','target_benzene']]\ntrain2.head()","87170a51":"reg2 = setup(data=train2, target='target_benzene', session_id=2)","35166183":"gbr2 = create_model(\"gbr\", fold=4)\net2 = create_model(\"et\", fold=4)\nlightgbm2 = create_model(\"lightgbm\", fold=4)\ncatboost2 = create_model(\"catboost\", fold=4)\nrf2 = create_model(\"rf\", fold=4)\nblend2 = blend_models(estimator_list= [catboost2, lightgbm2, gbr2, rf2], fold=4)\npred_h2 = predict_model(blend2)\nfinal2 = finalize_model(blend2)\npred2 = predict_model(final2, data=test)","b8bfc4c9":"interpret_model(catboost2)","e3d6f48c":"interpret_model(lightgbm2)","994b0638":"interpret_model(rf2)","60ab281e":"train3 = train1 = train.loc[:,['IsSensorOff','degC_month','week_day','hour','sensor_1','sensor_2','sensor_3','sensor_4','sensor_5','target_nitrogen_oxides']]\ntrain3.head()","d3077aa5":"reg3 = setup(data=train3, target='target_nitrogen_oxides',categorical_features=[\"IsSensorOff\", \"week_day\", \"hour\"], session_id=3)","fab962f7":"catboost3 = create_model(\"catboost\", fold=4)\net3 = create_model(\"et\", fold=4)\nlightgbm3 = create_model(\"lightgbm\", fold=4)\ngbr3 = create_model(\"gbr\", fold=4)\nrf3 = create_model(\"rf\", fold=4)\nblend3 = blend_models(estimator_list= [catboost3, et3, lightgbm3, gbr3, rf3], fold=4)\npred_h3 = predict_model(blend3)\nfinal3 = finalize_model(blend3)\npred3 = predict_model(final3, data=test)","fb1495d6":"interpret_model(catboost3)","a517523d":"interpret_model(lightgbm3)","58f21dfb":"interpret_model(rf3)","09f2f8e1":"sub.target_carbon_monoxide = pred1.Label\nsub.target_benzene = pred2.Label\nsub.target_nitrogen_oxides = pred3.Label\nsub.to_csv('addfeatures_submission.csv',index=False)\nsub","f3aa5c32":"#### Benzene\nSince there is a very strong positive correlation between benzene and sensor_2, we chose sensor_2 as the only feature.","0a39c858":"Comparing the first and second halves of the training data, we can see that \"benzene and carbon monoxide\" overlap with almost the same size spikes for the entire period, while \"benzene and nitrogen oxide\" is reversed, with benzene being larger in the first half and nitrogen oxide being larger in the second half.  \nTherefore, it seems that there is no problem using the sensor as a feature for carbon monoxide, but nitrogen oxide seems to require some kind of feature in addition to the sensor.  \nWhen I looked at the details, I found that nitrogen oxides seem to increase when the temperature is low, but even if the temperature is temporarily high for a few days in winter, nitrogen oxides do not seem to decrease. Assuming that benzene and carbon monoxide are generated by automobile exhaust and nitrogen oxides are generated by exhaust plus winter heating, I thought it would be better to use the average temperature as a characteristic quantity on a monthly basis because air pollution does not disappear immediately.","055baf88":"Here's a closer look at the actual outlier: the corresponding data was found around 2010\/12\/16.","efe3bf13":"I have checked SHAP with CatBoost, LightGBM and Random forest. For nitrogen oxides, degC_month is the most important feature. I also found that the features I have added are used.","723b6169":"### About the value of Nitroge oxides\nConsider the feature values needed to predict nitrogen oxides.  \nLet's match the scales and display \"benzene and carbon monoxide\" and \"benzene and nitrogen oxides\".","21e832b9":"#### Benzene and Carbon monoxide","38954c99":"#### Nitrogen oxides\nI specify IsSensorOff as a category for the same reason as carbon monoxide. I  expect to use degC_month to make predictions.","154ae776":"# Tabular Playground Series - Jul 2021\nContinued from [last time](https:\/\/www.kaggle.com\/astashiro\/tps-jul2021-02pycaretblend) .","d123ab88":"#### Benzene and Nitrogen oxides","74fe70c2":"Let's look at the thermometer, hygrometer, and sensors that are not working.  \nBenzene is linked to a value close to zero, but carbon monoxide and nitrogen oxides have spikes independent of each sensor.\nIt seems that each sensor can be used as a feature for carbon monoxide and nitrogen oxide as long as the outlier is considered separately, so I would like to add a feature for whether the sensors are off or not.","cd335ee4":"#### Public Score\n**0.26977** \n\nMy score was worse than  [last time](https:\/\/www.kaggle.com\/astashiro\/tps-jul2021-02pycaretblend). \nHowever, when using only LightGBM, predicting with these features resulted in better scores. \n\nWhen using only LightGBM  \n0.30025 --> 0.27216  \n \nWhen blended  \n0.25441 --> 0.26977  \n\nThe newly added features are likely to be effective, but I thought that the way the features are used when training on multiple models might be poor.  \n\n**Issue**\n1. Prediction when the sensor is not working\n2. Nitrogen Oxides Prediction\n\n\nI will continue to consider it.","85fbfc7f":"### Prediction with PyCaret\n#### Carbon monoxide\nI want to clearly separate carbon monoxide into outliers and other predictions, so I specify IsSensorOff as the category.","5aa99889":"## Add features\nI added features that I thought were valid and predicted them.","d52a55cb":"### Submission","1b385df3":"### Causes of outliers\nThere are no outliers between benzene and each sensor, and there is a strong positive correlation, especially with sensor_2. Outliers are noticeable for carbon monoxide and nitrogen oxides. Therefore, we hypothesized that the benzene value was calculated from the values of each sensor, and that the carbon monoxide and nitrogen oxide values were not calculated from these sensors.\n\n**Hypothesis**  \nBenzene and Sensor1-5 : positive correlation  \nCarbon monoxide and Sensor1-5 : pseudo-correlation  (latent variable: Benzene)  \nNitrogen oxides and Sensor1-5 : pseudo-correlation  (latent variable: Benzene)  ","b8dc5f3f":"### Add features\n\nAdd the following as features    \nweek_day,hour : Added with the expectation of predicting carbon monoxide and nitrogen oxide values when the sensor is off  \nIsSensorOff : Added in anticipation of determining if sensors are off or not.  \ndegC_month : Added in anticipation of determining seasonal variations."}}