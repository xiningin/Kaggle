{"cell_type":{"fafd5035":"code","fe935e5b":"code","eca2e2ae":"code","7bed7b45":"code","7880a62c":"code","543ab608":"code","26c36eb7":"code","947b489f":"code","9bc61d39":"code","e76cd5f1":"code","79db6ac7":"markdown","2f9e923f":"markdown","35171d4d":"markdown","8a3e154a":"markdown"},"source":{"fafd5035":"%matplotlib inline\nimport os\nimport pandas as pd\nimport datetime as dt\nimport numpy as np\nfrom IPython.core.interactiveshell import InteractiveShell\nInteractiveShell.ast_node_interactivity = \"all\"\nfrom tqdm import tqdm\nimport matplotlib.pyplot as plt\nimport seaborn as sns\nimport xgboost as xgb","fe935e5b":"plt.rcParams['figure.figsize'] = [16, 10]\nplt.rcParams['font.size'] = 14\npd.set_option('display.max_columns', 99)\nstart = dt.datetime.now()","eca2e2ae":"full = pd.read_csv('..\/input\/feature-extraction\/features_v3.csv.gz')\nfull.shape","7bed7b45":"TRAIN_SAMPLE_SIZE = 0.5","7880a62c":"full['random'] = np.random.rand(len(full))\n\ntrain = full[full.IsTrain == 1]\ntest = full[full.IsTrain == 0]\n\ncolumn_stats = pd.concat([\n    pd.DataFrame(full.count()).rename(columns={0: 'cnt'}),\n    pd.DataFrame(full.nunique()).rename(columns={0: 'unique'}),\n], sort=True, axis=1)\ncolumn_stats.sort_values(by='unique')\n\ntrain_columns = list(column_stats[column_stats.cnt < 10 ** 6].index)\nprint(train_columns)\n\ntarget_columns = [\n    'TotalTimeStopped_p20',\n    'TotalTimeStopped_p50',\n    'TotalTimeStopped_p80',\n    'DistanceToFirstStop_p20',\n    'DistanceToFirstStop_p50',\n    'DistanceToFirstStop_p80',\n]\n\ndo_not_use = train_columns + [\n    'IsTrain', 'Path', 'RowId', 'IntersectionId',\n    'random', 'intersection_random', 'ValidationGroup',\n    'Intersection'\n]\n\nfeature_columns = [c for c in full.columns if c not in do_not_use]\nprint(len(feature_columns))\nprint(feature_columns)","543ab608":"fix = {\n    'lambda': 1., 'nthread': 4, 'booster': 'gbtree',\n    'silent': 1, 'eval_metric': 'rmse',\n    'objective': 'reg:squarederror'}\nconfig = dict(min_child_weight=20,\n              eta=0.02, colsample_bytree=0.5,\n              max_depth=10, subsample=0.8)\nconfig.update(fix)\nnround = 1500","26c36eb7":"intersections = train.groupby('Intersection')[\n    ['RowId']].count().reset_index()\nintersections = intersections.drop('RowId', axis=1)\nintersections['intersection_random'] = np.random.rand(len(intersections))\ntrain = train.merge(intersections, on='Intersection')","947b489f":"total_mse = 0.0\nsubmission_parts = []\nfeature_importances = []\nfor i, target in enumerate(target_columns):\n    print(f'Training and predicting for target {target}')\n    train_idx = train.intersection_random < TRAIN_SAMPLE_SIZE\n    valid_idx = train.intersection_random >= TRAIN_SAMPLE_SIZE\n\n    Xtr = train[train_idx][feature_columns]\n    Xv = train[valid_idx][feature_columns]\n    ytr = train[train_idx][target].values\n    yv = train[valid_idx][target].values\n    print(Xtr.shape, ytr.shape, Xv.shape, yv.shape)\n\n    dtrain = xgb.DMatrix(Xtr, label=ytr)\n    dvalid = xgb.DMatrix(Xv, label=yv)\n\n    watchlist = [(dtrain, 'train'), (dvalid, 'valid')]\n    model = xgb.train(config, dtrain, nround, evals=watchlist,\n                      verbose_eval=100, early_stopping_rounds=50)\n\n    pv = model.predict(dvalid)\n    mse = np.mean((yv - pv) ** 2)\n    total_mse += mse \/ 6\n    print(target, 'rmse', np.sqrt(mse))\n    \n    # Feature Importance\n    f = model.get_fscore()\n    f = pd.DataFrame({'feature': list(f.keys()), 'imp': list(f.values())})\n    f.imp = f.imp \/ f.imp.sum()\n    feature_importances.append(f)\n    fimp = pd.concat(feature_importances).groupby(['feature']).sum()\n    fimp = fimp.sort_values(by='imp', ascending=False).reset_index()\n    fimp.to_csv('fimp_general.csv', index=False)\n\n    df = pd.DataFrame({\n        'TargetId': test.RowId.astype(str) + '_' + str(i),\n        'Target': model.predict(xgb.DMatrix(test[feature_columns]))})\n    submission_parts.append(df)","9bc61d39":"rmse = np.sqrt(total_mse)\nprint('Total rmse', rmse)\nsubmission = pd.concat(submission_parts, sort=True)\nsubmission.to_csv('general.csv', index=False)","e76cd5f1":"end = dt.datetime.now()\nprint('Latest run {}.\\nTotal time {}s'.format(end, (end - start).seconds))","79db6ac7":"### Intersection validation split","2f9e923f":"### Set xgboost learning parameters","35171d4d":"### Collect train features and target columns","8a3e154a":"### Train models for each target"}}