{"cell_type":{"dfc3e0c0":"code","078d00ad":"code","ca78061b":"code","f9b506f1":"code","f439a92f":"code","339ecdbe":"code","ca227430":"code","8d2bdd9e":"code","82d3285c":"code","d39f53b4":"code","ef935725":"code","24de31e4":"code","46603919":"code","155180bd":"code","9ee0f361":"code","abc6576b":"code","62bc8acf":"code","b20ac9f6":"code","d98afa77":"code","480b87c1":"code","776fe495":"code","cfeeee58":"code","3ada0c82":"code","29f4284b":"code","e0a0ffbc":"code","fc501c7d":"code","a3b37c8b":"code","110e5cc0":"code","a13a81ec":"code","fa25f4d5":"code","85a085de":"code","dc7f34c0":"markdown","3cec8073":"markdown","55841e4e":"markdown"},"source":{"dfc3e0c0":"# Importing required things\nimport os\nimport csv\nfrom tqdm import tqdm\nfrom collections import OrderedDict\nimport regex\nimport itertools\nimport random\n\nfrom PIL import Image\nimport matplotlib.pyplot as plt\n%matplotlib inline\n\nimport numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)","078d00ad":"# file locations\ninput_filepath = '..\/input'\ntrain_csv_filepath = os.path.join(input_filepath, 'train.csv')","ca78061b":"# labels list\n# order should be the same as number in dataset\nlabels = [\"Nucleoplasm\", \"Nuclear membrane\", \"Nucleoli\", \"Nucleoli fibrillar center\", \"Nuclear speckles\", \"Nuclear bodies\", \"Endoplasmic reticulum\", \"Golgi apparatus\", \n          \"Peroxisomes\", \"Endosomes\", \"Lysosomes\", \"Intermediate filaments\", \"Actin filaments\", \"Focal adhesion sites\", \"Microtubules\", \"Microtubule ends\", \"Cytokinetic bridge\", \n          \"Mitotic spindle\", \"Microtubule organizing center\", \"Centrosome\", \"Lipid droplets\", \"Plasma membrane\", \"Cell junctions\", \"Mitochondria\", \"Aggresome\", \"Cytosol\", \"Cytoplasmic bodies\", \"Rods & rings\"]","f9b506f1":"def parse_indice(indice):\n    \"\"\"\n    Converts various types of indice lists into normal Python list of integers\n    \"\"\"\n    # case of space separated string, as in dataset\n    if isinstance(indice, str):\n        indice = indice.split(' ')\n        indice = [int(index) for index in indice]\n        \n    # scalar converted to single-element list\n    if not isinstance(indice, list):\n        indice = [indice]\n        \n    return indice","f439a92f":"def get_labels(indice):\n    \"\"\"\n    Returns the labels of given indice. Indice may be give as space separated string (as in dataset), as python list or as single value\n    \"\"\"\n\n    ans = [labels[index] for index in parse_indice(indice)]\n    return ans  \n\n# def try_get_labels():\n#     arguments = [0, [0], '1 5']\n#     return [get_labels(arg) for arg in arguments]\n# try_get_labels()","339ecdbe":"def get_hots(indice):\n    \"\"\"\n    Returns 1-hot representation of a given indice. Since it can be multiple indice, it is actually many-hot\n    \"\"\"\n    \n    # range(len(labels)): sequence of integers from zero to number of labels-1\n    # int(index in parse_indice(indice)): 1-hot computation\n    ans = np.asarray([int(index in parse_indice(indice)) for index in range(len(labels))])\n    return ans\n    \n# def try_get_hots():\n#     arguments = [0, [0], '1 5']\n#     return [get_hots(arg) for arg in arguments]\n\n# np.asarray(try_get_hots())","ca227430":"def read_train_set():\n    \"\"\"\n    Reads entire trainset into the list of dicts\n    Images are not readen\n    \"\"\"\n    ans = []\n    \n    # train set is guided by CSV file\n    with open(train_csv_filepath) as fp:\n        reader = csv.DictReader(fp, delimiter=',')\n        # reading all rows and appending extra keys\n        for row in reader:\n            row['Hots'] = get_hots(row['Target'])\n            row['Labels'] = get_labels(row['Target'])\n            row['Train'] = True\n            ans.append(row)\n    return ans\n\n# def try_read_train_set():\n    \n#     train_set = read_train_set();\n#     return train_set[0];\n\n# try_read_train_set()","8d2bdd9e":"def parse_filename(filename: str):\n    \"\"\"\n    Extracts sample id and \"color\" from filename\n    \"\"\"\n    filename = os.path.splitext(filename)[0]\n    Id, Color = filename.split('_')\n    return {'Id': Id, 'Color': Color}\n\n# def try_parse_filename():\n    \n#     args = ['00631ec8-bad9-11e8-b2b9-ac1f6b6435d0_red.png']\n#     return [parse_filename(filename) for filename in args]\n\n# try_parse_filename()","82d3285c":"def read_test_set():\n    \"\"\"\n    Reads entire test set into list of dicts\n    Keys are the same as for dataset, except labels are not given\n    \"\"\"\n    \n    # test set in guided by present files \n    filenames = os.listdir(os.path.join(input_filepath, 'test'))\n    # unique ids\n    Ids = set([parse_filename(filename)['Id'] for filename in filenames])\n    # forming the same dicts as in train set\n    return [OrderedDict([('Id', id), ('Train', False)]) for id in Ids]\n\n# def try_read_test_set():\n#     return read_test_set()[0]\n\n# try_read_test_set()   \n    ","d39f53b4":"# dataset, including both train and test parts, one after another\ndataset0 = read_train_set() + read_test_set()\n\n# dict to address samples by id\nby_id_index = {Sample['Id']: i for (i,Sample) in enumerate(dataset0)}","ef935725":"def dataset0_get_sample(indice_or_ids):\n    \"\"\"\n    Returns samples by given list of (ordinal) indice or string Ids\n    \"\"\"\n    if isinstance(indice_or_ids, list):\n        return [dataset0_get_sample(index) for index in indice_or_ids]\n\n    if isinstance(indice_or_ids, str):\n        indice_or_ids = by_id_index[indice_or_ids]\n\n    return dataset0[indice_or_ids]","24de31e4":"def dataset0_filter(Train: bool = True, Ids = None, Labels = None, Folds = None, FoldsCount: int = None):\n    \"\"\"\n    Creates filtering generator, which returns all samples in sequence, matching conditions\n\n    All specified conditions should be satisfied (logical AND)\n\n    :param Train: include train set (`True`, default), test set (`False`) or both (`None`)\n    :param Ids: include specified Id or Ids, can be regex; default is `None`, which means include all\n    :param Labels: include specified labels; any of specifield labels can present; `None` means any labels (Default)\n    :paran Folds: numeric indice of folds to include; dataset is slit into folds by hash code\n    :paran FoldsCount: total number of folds to split dataset into\n    \"\"\"\n\n    for sample in dataset0:\n\n        # checking train or test set parameter\n        if Train is not None and sample['Train'] != Train:\n            continue\n\n        # checking ids regexes\n        if Ids is not None:\n            if not isinstance(Ids, list):\n                Ids = [Ids]\n\n            if not any(regex.match(sample['Id']) for regex in Ids):\n                continue\n\n        # checking labels filter\n        if Labels is not None:\n\n            if 'Labels' not in sample:\n                continue\n\n            if not isinstance(Labels, list):\n                Labels = [Labels]\n\n            if not any(label in Labels for label in sample['Labels']):\n                continue\n\n        # checking folds parameters\n        # there are two of them: folds list and folds count, working together\n        # dataset is splitten into number of folds, specified by folds count\n        # and then only folds specified by list returned\n        if Folds is not None:\n\n            if not isinstance(Folds, list):\n                Folds = [Folds]\n\n            # fold is computed from hash\n            # by definition, hash should be random\n            h = hash(sample['Id'])\n            Fold = h % FoldsCount\n            \n            if Fold not in Folds:\n                continue\n\n        yield sample       \n","46603919":"#dataset0_get_sample(0)","155180bd":"#dataset0_get_sample('00631ec8-bad9-11e8-b2b9-ac1f6b6435d0')","9ee0f361":"#dataset0_filter(Train = False).__next__()","abc6576b":"#list(itertools.islice(dataset0_filter(Train = True),1))","62bc8acf":"#list(itertools.islice(dataset0_filter(Labels = \"Focal adhesion sites\"),3))","b20ac9f6":"#list(itertools.islice(dataset0_filter(Folds = 0, FoldsCount = 3),1))","d98afa77":"#list(itertools.islice(dataset0_filter(Folds = 1, FoldsCount = 3),1))","480b87c1":"#list(itertools.islice(dataset0_filter(Folds = 2, FoldsCount = 3),1))","776fe495":"colors = ['red', 'green', 'blue', 'yellow']","cfeeee58":"def get_filepath(sample, color):\n    \"\"\"\n    Computes path to image file, specified by given sample dict and color\n    \n    Image can loose data, so use it for visualization only\n    \"\"\"\n    filename = '%s_%s.png' % (sample['Id'], color)\n    if sample['Train']:\n        return os.path.join(input_filepath, 'train', filename)\n    else:\n        return os.path.join(input_filepath, 'test', filename)","3ada0c82":"def get_PIL_image(sample, color):\n    \"\"\"\n    Reads sample as PIL image\n    \n    Image retained pale to conserve data\n    \"\"\"\n    filepath = get_filepath(sample, color)\n    return Image.open(filepath).convert('RGB')","29f4284b":"def get_PIL_image_colored(sample, color):\n    \"\"\"\n    Reads sample as PIL images and colors it according to color suffix\n    \"\"\"\n    if 'red' == color:\n        matrix = (1, 0, 0, 0,\n              0, 0, 0, 0,\n              0, 0, 0, 0)\n    elif 'green' == color:\n        matrix = (0, 0, 0, 0,\n              1, 0, 0, 0,\n              0, 0, 0, 0)\n    elif 'blue' == color:\n        matrix = (0, 0, 0, 0,\n              0, 0, 0, 0,\n              1, 0, 0, 0)\n    elif 'yellow' == color:\n        matrix = (1, 0, 0, 0,\n              1, 0, 0, 0,\n              0, 0, 0, 0)\n    return get_PIL_image(sample, color).convert('RGB', matrix)","e0a0ffbc":"#get_PIL_image_colored(dataset0_get_sample('0ba299c4-bbbc-11e8-b2ba-ac1f6b6435d0'), 'yellow')","fc501c7d":"def get_numpy_images(sample):\n    \"\"\"\n    Reads all sample images as numpy 4-channel array \n    Pixel values normalized to one\n    \"\"\"\n    images = [np.array(get_PIL_image_colored(sample, color)) for color in colors]\n    images_np = np.stack(images)\n    images_np = images_np \/ 255\n    return images_np","a3b37c8b":"def get_PIL_image_mixed(sample):\n    \"\"\"\n    Reads all sample images and mixes them into single multicolor image\n    \n    Image can loose data, so use it for visualization only\n    \"\"\"\n    images_np = get_numpy_images(sample) * 255\n    #images_np = np.sum(images_np, axis=0) \/ len(images)\n    images_np = np.sum(images_np, axis=0)\n    images_np = images_np.astype( np.uint8 )\n    ans = Image.fromarray(images_np)\n    return ans","110e5cc0":"#get_PIL_image_mixed(dataset0_get_sample('0ba299c4-bbbc-11e8-b2ba-ac1f6b6435d0'))","a13a81ec":"def create_subplots(rows=5, cols=5, scale_factor=5):\n    \"\"\"\n    Creates subplot with given number of rows and columns and a given scale\n    :param rows:\n    :param cols: number of columns\n    :param scale_factor: to set figure size on screen or browser\n    \"\"\"\n    fig, axes = plt.subplots(rows, cols,figsize=(cols*scale_factor,rows*scale_factor))\n    return fig, axes","fa25f4d5":"# taking all samples, turning them to list, shuffling and then turning back to generator\nselected_samples = list(dataset0_filter())\nrandom.shuffle(selected_samples)\nselected_samples = (sample for sample in selected_samples)","85a085de":"# function to draw single image\ndef plot_sample(ax, sample):\n    ax.imshow(get_PIL_image_mixed(sample))\n\n    title = str(sample['Labels'])\n    ax.set_title(title)   \n\n# creating subplots and drawing images of first selected samples    \nfig, axes = create_subplots()\nfor ax in itertools.chain(*axes):\n    plot_sample(ax, selected_samples.__next__())","dc7f34c0":"Functions below allow to access dataset easily and also compute PIL images for samples\nSee images at the end","3cec8073":"# Visualizations","55841e4e":"# Functions"}}