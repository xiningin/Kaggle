{"cell_type":{"a67c01e2":"code","c233355c":"code","e61d69c7":"code","2d531806":"code","2f22886f":"code","a922379a":"code","a05adfa2":"code","7f013c9e":"code","bb8a4b83":"code","9baf786e":"code","10fbe5b5":"markdown","2efb1f36":"markdown","d0e4411e":"markdown","ea56d192":"markdown"},"source":{"a67c01e2":"import pandas as pd\nimport numpy as np\nfrom sklearn import model_selection\nfrom sklearn import linear_model\nfrom sklearn import metrics\nfrom sklearn import preprocessing","c233355c":"folds = 5","e61d69c7":"# read train and targets datasets\ntrain_df = pd.read_csv('..\/input\/lish-moa\/train_features.csv')\ntargets_df = pd.read_csv('..\/input\/lish-moa\/train_targets_scored.csv')\n\n# join both datasets so later we can shuffle the joined df\ndf = train_df.merge(targets_df)\n\n# suffle dataset\ndf = df.sample(frac=1).reset_index(drop=True)\n\ntrain_cols = train_df.columns\ntarget_cols = targets_df.drop('sig_id', axis=1).columns\n\n# lets re-constructed our initial train and targets dataframes from the shuffled df\ntrain_df = df[train_cols]\ntargets_df = df[target_cols]\n\n# create a new column called kfold\ntrain_df['kfold'] = -1\ntargets_df['kfold'] = -1\n\n# concat all target values with each other and assing the result on a new column called target_concat\ntargets_df['target_concat'] = targets_df[target_cols].apply(lambda row: '_'.join(row.values.astype(str)), axis=1)\n\n# now we want to label encode these target_concat values\n# initialize LabelEncoder\nlbl = preprocessing.LabelEncoder()\n# fit LabelEncoder with all the data\nlbl.fit(targets_df['target_concat'])\n# transform all the data\ntargets_df.loc[:, 'target_enc'] = lbl.transform(targets_df['target_concat'])\n\n# fetch the new encoded targets\ny = targets_df.target_enc\n\n# initiate the kfold class form model_selection module\nkf = model_selection.StratifiedKFold(n_splits=folds)\n\n# fill the new column kfold\nfor f, (t_, v_) in enumerate(kf.split(X=train_df, y=y)):\n    train_df.loc[v_, 'kfold'] = f\n    targets_df.loc[v_, 'kfold'] = f\n\n# targets_df.drop(['target_concat', 'target_enc'], axis=1, inplace=True)","2d531806":"train_df.kfold.value_counts()","2f22886f":"# now all the folds have the same (or almost the same) target distribution\nfor f in range(folds):\n    print(\"\")\n    print(f\"FOLD: {f}\")\n    print(targets_df[targets_df['kfold'] == f]['target_enc'].value_counts())","a922379a":"# write folds datasets\ntargets_df.drop(['target_concat', 'target_enc'], axis=1, inplace=True)\ntargets_df.to_csv('train_targets_scored_folds.csv', index=False)\ntrain_df.to_csv('train_features_folds.csv', index=False)","a05adfa2":"predictions_list = []\n\ndef run(fold):\n    submission = pd.read_csv('..\/input\/lish-moa\/sample_submission.csv')\n    train_df = pd.read_csv('.\/train_features_folds.csv')\n    targets_df = pd.read_csv('.\/train_targets_scored_folds.csv')\n    test_df = pd.read_csv('..\/input\/lish-moa\/test_features.csv')\n    \n    # lets label encode categorical columns\n    for col in ['cp_type', 'cp_time', 'cp_dose']:\n        # initialize LabelEncoder\n        lbl = preprocessing.LabelEncoder()\n        # fit LabelEncoder with all the data\n        lbl.fit(train_df[col])\n        # transform all the data\n        train_df.loc[:, col] = lbl.transform(train_df[col])\n        test_df.loc[:, col] = lbl.transform(test_df[col])\n\n    # get training data using folds\n    df_train = train_df[train_df['kfold'] != fold].reset_index(drop=True)\n    # get validation data using folds\n    df_valid = train_df[train_df['kfold'] == fold].reset_index(drop=True)\n        \n    # get training targets using folds\n    y_train = targets_df[targets_df['kfold'] != fold].reset_index(drop=True)\n    # get validation targets using folds\n    y_valid = targets_df[targets_df['kfold'] == fold].reset_index(drop=True)\n    \n    # drop sig_id column\n    x_train = df_train.drop(['sig_id', 'kfold'],axis=1)\n    x_valid = df_valid.drop(['sig_id', 'kfold'],axis=1)\n    x_test = test_df.drop(['sig_id'], axis=1)\n    y_train = y_train.drop(['kfold'],axis=1)\n    y_valid = y_valid.drop(['kfold'],axis=1)\n    \n    # initialize regression model\n    model = linear_model.Lasso(alpha=0.1, max_iter=3000, random_state=42, selection='random')\n    \n    # fit model on training data\n    model.fit(x_train, y_train)\n    \n    # predict on validation data\n    valid_preds = model.predict(x_valid)    \n    \n    # get log loss score    \n    log_loss = metrics.log_loss(np.ravel(y_valid), np.ravel(valid_preds))\n    # print auc\n    print(\"\")\n    print(f'Fold = {fold}, log loss = {log_loss}')\n\n    # predictions\n    predictions = model.predict(x_test)\n    predictions_list.append(predictions)","7f013c9e":"# run for each fold\nfor fold in range(folds):\n    run(fold)","bb8a4b83":"# average predictions of each of the folds models\npredictions = (predictions_list[0] + predictions_list[1] + predictions_list[2] +\n               predictions_list[3] + predictions_list[4]) \/ folds\nsubmission = pd.read_csv('\/kaggle\/input\/lish-moa\/sample_submission.csv')\n\nfor i in range(len(submission.columns)):\n    if i != 0:\n        col = submission.columns[i]\n        submission[col] = predictions[:, i - 1]","9baf786e":"submission.to_csv('submission.csv',index=False)","10fbe5b5":"## Create Folds","2efb1f36":"## Lasso Regression","d0e4411e":"Check that all folds have the same target distribution","ea56d192":"## Predictions and Submission"}}