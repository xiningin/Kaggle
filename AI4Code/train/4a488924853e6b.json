{"cell_type":{"ecff824b":"code","3ddb40b1":"code","10b7543c":"code","cb8af949":"code","a305e5e1":"code","885cbeb2":"code","17c93036":"code","97a79333":"code","e44e868b":"code","81e41db5":"code","d2fbb731":"code","e968161f":"code","98bbc273":"code","26f2bf8b":"code","71d0792e":"code","347869d4":"code","8d93fb04":"code","a4b65958":"code","36d86d34":"markdown","57bba1d9":"markdown","42b4dedf":"markdown","1cff06ad":"markdown"},"source":{"ecff824b":"# data preprocessing origins from https:\/\/www.kaggle.com\/ulrich07\/osic-multiple-quantile-regression-starter\nimport numpy as np\nimport pandas as pd\nimport pydicom\nimport os\nimport random\nimport matplotlib.pyplot as plt\nfrom tqdm import tqdm\nfrom PIL import Image\nfrom sklearn.metrics import mean_absolute_error\nfrom sklearn.model_selection import KFold\nfrom lightgbm import LGBMRegressor","3ddb40b1":"def seed_everything(seed=2020):\n    random.seed(seed)\n    os.environ['PYTHONHASHSEED'] = str(seed)\n    np.random.seed(seed)\n    \nseed_everything(42)","10b7543c":"ROOT = \"..\/input\/osic-pulmonary-fibrosis-progression\"","cb8af949":"tr = pd.read_csv(f\"{ROOT}\/train.csv\")\ntr.drop_duplicates(keep=False, inplace=True, subset=['Patient','Weeks'])\nchunk = pd.read_csv(f\"{ROOT}\/test.csv\")\n\nprint(\"add infos\")\nsub = pd.read_csv(f\"{ROOT}\/sample_submission.csv\")\nsub['Patient'] = sub['Patient_Week'].apply(lambda x:x.split('_')[0])\nsub['Weeks'] = sub['Patient_Week'].apply(lambda x: int(x.split('_')[-1]))\nsub =  sub[['Patient','Weeks','Confidence','Patient_Week']]\nsub = sub.merge(chunk.drop('Weeks', axis=1), on=\"Patient\")","a305e5e1":"tr['WHERE'] = 'train'\nchunk['WHERE'] = 'val'\nsub['WHERE'] = 'test'\ndata = tr.append([chunk, sub])","885cbeb2":"data['min_week'] = data['Weeks']\ndata.loc[data.WHERE=='test','min_week'] = np.nan\ndata['min_week'] = data.groupby('Patient')['min_week'].transform('min')","17c93036":"base = data.loc[data.Weeks == data.min_week]\nbase = base[['Patient','FVC']].copy()\nbase.columns = ['Patient','min_FVC']\nbase['nb'] = 1\nbase['nb'] = base.groupby('Patient')['nb'].transform('cumsum')\nbase = base[base.nb==1]\nbase.drop('nb', axis=1, inplace=True)","97a79333":"data = data.merge(base, on='Patient', how='left')\ndata['base_week'] = data['Weeks'] - data['min_week']\ndel base","e44e868b":"for col in ['Sex', 'SmokingStatus']:\n    data[col] = data[col].astype('category').cat.codes","81e41db5":"feature_list = ['Age', 'Sex', 'SmokingStatus', 'Percent', 'base_week', 'min_FVC']\ncat_feat = ['Sex', 'SmokingStatus']","d2fbb731":"tr = data.loc[data.WHERE=='train']\nchunk = data.loc[data.WHERE=='val']\nsub = data.loc[data.WHERE=='test']\ndel data\n\ntr.shape, chunk.shape, sub.shape","e968161f":"lgb_params = {\n    'n_jobs': 1,\n    'max_depth': 4,\n    'min_data_in_leaf': 16,\n    'subsample': 0.9,\n    'n_estimators': 500,\n    'learning_rate': 0.02,\n    'colsample_bytree': 0.9,\n    'boosting_type': 'gbdt',\n    'metric': ['quantile', 'rmse']\n}","98bbc273":"y = tr['FVC']#.values\nz = tr[feature_list]#.values\nze = sub[feature_list]#.values","26f2bf8b":"NFOLD = 5\nkf = KFold(n_splits=NFOLD)","71d0792e":"pred = np.zeros((z.shape[0], 3))\npe = np.zeros((ze.shape[0], 3))\n\nquantiles = [0.2, 0.5, 0.8]\ncnt = 0\nfor tr_idx, val_idx in kf.split(z):\n    cnt += 1\n    for i in range(len(quantiles)): \n        q = quantiles[i]\n        print(f\"FOLD {cnt}, quantile {q}\")\n        lgb = LGBMRegressor(objective='quantile', alpha=q, **lgb_params)\n        lgb.fit(X=z.loc[tr_idx], y=y[tr_idx], eval_set=[[z.loc[val_idx], y[val_idx]]], \n                categorical_feature=cat_feat, early_stopping_rounds=10, verbose=0)\n        \n        pred[val_idx, i] = lgb.predict(z.loc[val_idx])\n        pe[:, i] += lgb.predict(ze)\/NFOLD","347869d4":"err = mean_absolute_error(y, pred[:, 1])\nunc = np.mean(pred[:, 2] - pred[:, 0])\nprint(err, unc)a","8d93fb04":"def get_submission(sub, pe):\n    sub['FVC1'] = pe[:, 1]*0.996\n    sub['Confidence1'] = pe[:, 2] - pe[:, 0]\n    \n    subm = sub[['Patient_Week','FVC','Confidence','FVC1','Confidence1']].copy()\n    subm.loc[~subm.FVC1.isnull(),'FVC'] = subm.loc[~subm.FVC1.isnull(),'FVC1']\n    subm.loc[~subm.FVC1.isnull(),'Confidence'] = subm.loc[~subm.FVC1.isnull(),'Confidence1']\n    \n    print(\"fill in prediction that already exists\")\n    otest = pd.read_csv('..\/input\/osic-pulmonary-fibrosis-progression\/test.csv')\n    for i in range(len(otest)):\n        subm.loc[subm['Patient_Week']==otest.Patient[i]+'_'+str(otest.Weeks[i]), 'FVC'] = otest.FVC[i]\n        subm.loc[subm['Patient_Week']==otest.Patient[i]+'_'+str(otest.Weeks[i]), 'Confidence'] = 0.1\n    subm[[\"Patient_Week\",\"FVC\",\"Confidence\"]].to_csv(\"submission.csv\", index=False)\n    print(\"sub file saved\")","a4b65958":"get_submission(sub, pe)","36d86d34":"## Metrics","57bba1d9":"$\\sigma_{clipped} = max(\\sigma, 70),$\n\n$\\Delta = min ( |FVC_{true} - FVC_{predicted}|, 1000 ),$\n\n$metric = -   \\frac{\\sqrt{2} \\Delta}{\\sigma_{clipped}} - \\ln ( \\sqrt{2} \\sigma_{clipped} ).$","42b4dedf":"## Save sub","1cff06ad":"## LGB"}}