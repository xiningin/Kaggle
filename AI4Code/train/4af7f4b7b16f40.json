{"cell_type":{"52d59f1d":"code","2bf4863b":"code","64116a29":"code","c0920272":"code","bb0ff579":"code","c50d2a79":"code","e4332667":"code","6930810b":"code","ba376d61":"code","937aee81":"code","4fac8eee":"code","38654339":"code","9f809e01":"code","b757b354":"code","9bc676c9":"code","576ca6f1":"code","fbff45af":"code","a564db4f":"code","e6a57dc1":"code","a42ad503":"code","31470db0":"code","a2cf2d7c":"code","6e5a718f":"code","a1550870":"code","616457ee":"code","8c35e23d":"code","d075f635":"code","3bb23331":"code","5c9e89fc":"code","807d19a5":"code","017026e6":"code","50a47337":"code","b7d0ca6a":"code","d6cbc221":"code","dd74e49f":"code","71c5acc0":"code","97cb2294":"code","73c151d5":"code","d8d9e2cd":"code","31d2e40a":"code","9b36df56":"code","7ed92826":"code","a457abf3":"code","445be92d":"code","b573bf8f":"code","531ee888":"code","f343f7d6":"code","51dcfa94":"code","58fb4efe":"code","1fd204e5":"code","26168ccf":"code","0ab83abd":"code","9452a2ef":"code","e550d94f":"code","422864f1":"code","bd14abc2":"code","796e394f":"code","c85f1d6e":"code","50bb683a":"code","2c12b226":"code","5d0b4e5f":"code","c7c92d68":"markdown","fbf0a59f":"markdown","eb024885":"markdown","fa0fc359":"markdown","ed8f88b3":"markdown","37e4b71e":"markdown","c340b220":"markdown","8663ae7d":"markdown","3a292d86":"markdown","27398f5a":"markdown","172fbee6":"markdown","8a8d38fb":"markdown","621aa8ed":"markdown","7ba12936":"markdown","c77fd390":"markdown","62ae46b5":"markdown","29be5663":"markdown","8a06296a":"markdown","c9d2e5c6":"markdown","e150e5dd":"markdown","55598a5e":"markdown","aab15ce3":"markdown","90cf6b44":"markdown","d3d3bbef":"markdown","748d5b16":"markdown","63955d2c":"markdown","3cf8efc2":"markdown","e736578f":"markdown","d1be5c01":"markdown","7c77f021":"markdown","6411b473":"markdown","333cfcb3":"markdown","28ce0c8a":"markdown","586f5439":"markdown","83cc68d7":"markdown","9f486cf8":"markdown","ea49c589":"markdown","d497cb3f":"markdown","5367ac06":"markdown","9bcc7465":"markdown","d31b9723":"markdown","f6eda557":"markdown","209faf34":"markdown","76280c68":"markdown","321c3064":"markdown","c1893c1b":"markdown","00a7885b":"markdown","76604dd2":"markdown","ab98f927":"markdown","c02c304a":"markdown","4923a83a":"markdown","78a2a350":"markdown","7e2539fc":"markdown","62c26d36":"markdown","00195a50":"markdown","6cb80c61":"markdown","5952a8a2":"markdown","204c95e2":"markdown","3c0404f4":"markdown","bd91c9c2":"markdown","13855c41":"markdown","959bc5cc":"markdown","8a670e2d":"markdown","4c668400":"markdown","1e6d229f":"markdown","75b0e976":"markdown","21b0e513":"markdown","4e62d930":"markdown","bf0bc3d7":"markdown","d5433ac5":"markdown","b225a07f":"markdown","22f7c14f":"markdown","f566dc2d":"markdown","c2218d7e":"markdown","c7fab915":"markdown","a954b393":"markdown","ce3883e7":"markdown","063336a7":"markdown","63e238e8":"markdown","4be9bf98":"markdown","4d2c2258":"markdown"},"source":{"52d59f1d":"import os\nimport matplotlib.pyplot as plt\nimport pandas as pd\nimport seaborn as sns\nimport numpy as np\n!pip install sorted-months-weekdays\n!pip install pip install sort-dataframeby-monthorweek\nimport sort_dataframeby_monthorweek as sd\nimport datetime\nfrom sklearn.metrics import mean_squared_error\n!pip install pmdarima\nfrom pmdarima import auto_arima\nimport os\nfrom sklearn.model_selection import train_test_split, GridSearchCV\nfrom sklearn.preprocessing import StandardScaler\nfrom sklearn.metrics import accuracy_score, confusion_matrix, classification_report\nfrom sklearn.linear_model import LogisticRegression\nimport sklearn\nfrom sklearn.neighbors import KNeighborsClassifier\nfrom sklearn.svm import SVC\nfrom sklearn.tree import DecisionTreeClassifier\nfrom sklearn.ensemble import RandomForestClassifier\nfrom sklearn.ensemble import RandomForestClassifier\nfrom sklearn.ensemble import AdaBoostClassifier\nfrom sklearn.ensemble import GradientBoostingClassifier\nfrom xgboost import XGBClassifier\nfrom sklearn.ensemble import ExtraTreesClassifier\nfrom sklearn.ensemble import VotingClassifier\nimport pickle\n\nimport folium\nfrom folium.plugins import HeatMap\nimport plotly.express as px\n        \nimport warnings\nwarnings.filterwarnings('ignore')","2bf4863b":"import os\nfor dirname, _, filenames in os.walk('\/kaggle\/input'):\n    for filename in filenames:\n        print(os.path.join(dirname, filename))","64116a29":"data = pd.read_csv(\"..\/input\/hotel-booking-demand\/hotel_bookings.csv\")","c0920272":"data.head()","bb0ff579":"data.info()","c50d2a79":"NaN = data.isna().sum()\nNaN","e4332667":"data = data.drop(['company', 'agent'], axis=1)","6930810b":"data = data.dropna(subset=['country', 'children', 'arrival_date_week_number'], axis=0) \n\ndata = data.reset_index(drop=True)\ndata.head()","ba376d61":"NaN = data.isna().sum()\nNaN","937aee81":"filter = (data.children == 0) & (data.adults == 0) & (data.babies == 0)\nsum(filter)","4fac8eee":"data = data[~filter]\ndata.head()","38654339":"data.describe()","9f809e01":"columnas = ['lead_time', 'stays_in_weekend_nights', 'stays_in_week_nights', 'adults', \n           'babies', 'required_car_parking_spaces', 'adr', 'previous_cancellations']\nn = 1\nplt.figure(figsize=(20,15))\n\nfor column in columnas:\n  plt.subplot(4,4,n)\n  n = n+2\n  sns.boxplot(data[column])\n  plt.tight_layout()","b757b354":"from sklearn.cluster import DBSCAN\n\ncolumnas = ['lead_time', 'stays_in_weekend_nights', 'stays_in_week_nights', 'adults', \n           'babies', 'required_car_parking_spaces', 'adr', 'previous_cancellations']","9bc676c9":"deteccion_outliers = DBSCAN(min_samples = 2, eps = 3)\nclusters = deteccion_outliers.fit_predict(data[columnas])\nlist(clusters).count(-1)","576ca6f1":"data.loc[data.lead_time > 400, 'lead_time'] = 400\ndata.loc[data.stays_in_weekend_nights >=  5, 'stays_in_weekend_nights'] = 5\ndata.loc[data.stays_in_week_nights > 20, 'stays_in_week_nights'] = 20\ndata.loc[data.adults > 10, 'adults'] = 10\ndata.loc[data.babies > 8, 'babies'] = 0\ndata.loc[data.required_car_parking_spaces > 5, 'required_car_parking_spaces'] = 0\ndata.loc[data.adr > 1000, 'adr'] = 1000\ndata.loc[data.adr < 30, 'adr'] = 0","fbff45af":"# TOTAL DE HU\u00c9SPEDES\n\ndata['Total_Guests'] = data['adults'] + data['children']\n\n# Comprobamos que efectivamente no hay ning\u00fan registro que sume 0!\n\nfilter = data.Total_Guests != 0\nsum(filter) # el n\u00famero de registros total son 118728, asi que es correcto\n","a564db4f":"paises_mas_visitas = data[data['is_canceled'] == 0]['country'].value_counts().reset_index()\npaises_mas_visitas.columns = ['country', 'No of guests']\npaises_mas_visitas","e6a57dc1":"basemap = folium.Map()\nguests_map = px.choropleth(paises_mas_visitas, locations = paises_mas_visitas['country'],color_continuous_scale=\"portland\",\n                           color = paises_mas_visitas['No of guests'], hover_name = paises_mas_visitas['country'])\nguests_map.show()\n","a42ad503":"cuanto_se_paga = data[data['is_canceled'] == 0] \n\n# Vamos a usar para este fin la variable 'adr' (Average Daily Rate as defined by dividing the sum of all lodging transactions by the total number of staying nights)\n\npx.box(data_frame = cuanto_se_paga, x = 'reserved_room_type', y = 'adr', color = 'hotel')","31470db0":"px.box(data_frame = cuanto_se_paga, x = 'reserved_room_type', y = 'adr')","a2cf2d7c":"cuanto_se_paga_MES = cuanto_se_paga.groupby(['arrival_date_month'])['adr'].mean().reset_index()\ncuanto_se_paga_MES","6e5a718f":"# En primer lugar, vamos a crear una funci\u00f3n heciendo uso de la librer\u00eda sort_dataframeby_monthorweek y su funci\u00f3n Sort_Dataframeby_Month\n\n\ndef group_by_month(df, column_name):\n    return sd.Sort_Dataframeby_Month(df, column_name)\n\ndata_resort = data[(data['hotel'] == 'Resort Hotel') & (data['is_canceled'] == 0)]\n\ndata_city = data[(data['hotel'] == 'City Hotel') & (data['is_canceled'] == 0)]\n\nresort_hotel = data_resort.groupby(['arrival_date_month'])['adr'].mean().reset_index()\n\ncity_hotel=data_city.groupby(['arrival_date_month'])['adr'].mean().reset_index()\n\nfinal_hotel = resort_hotel.merge(city_hotel, on = 'arrival_date_month')\n\nfinal_hotel.columns = ['mes', 'precio_por_resort', 'precio_por_hotel_ciudad']\n\nfinal_prices = group_by_month(final_hotel, 'mes')\nfinal_prices","a1550870":"# lead_time: n\u00ba d\u00edas transcurridos entre la fecha de reserva y el dia de llegada. ANTICIPACI\u00d3N DE LA RESERVA.\n\nplt.figure(figsize=(12,6))\nsns.barplot(x='arrival_date_year', y='lead_time',hue='is_canceled', data= data)\n\nplt.title('Arriving year, Leadtime and Cancelations')\n\n# En el gr\u00e1fico de abajo, podemos observar que en los 3 a\u00f1os de an\u00e1lisis, las reservas con m\u00e1s de 100 d\u00edas transcurridos\n# tienen mayor posibilidad de ser canceladas.","616457ee":"plt.figure(figsize=(15,6))\n\nsns.countplot(data = data, x = 'arrival_date_day_of_month', hue='hotel')\nplt.show()","8c35e23d":"plt.figure(figsize=(15, 8))\n\nplt.subplot(1, 2, 2)\nsns.countplot(data = data, x = 'stays_in_weekend_nights', hue='is_canceled')\nplt.title('N\u00famero de noches en fin de semana', size=11)\nplt.subplots_adjust(right=2)\n\nplt.show()\n\n\n# Como podemos observar abajo, la mayor\u00eda de las reservas para fin de semana no se han cancelado. \n# INFORMACI\u00d3N \u00daTIL PARA PREDECIR.","d075f635":"# BB: BED AND BREAKFAST\n# FB: FULL BOARD (PENSI\u00d3N COMPLETA)\n\nmeal_labels= ['BB','HB', 'SC', 'Sin definir', 'FB']\nsize = data['meal'].value_counts()\nplt.figure(figsize=(8,8))\ncmap =plt.get_cmap(\"Pastel2\")\ncolors = cmap(np.arange(6)*1)\nmy_circle=plt.Circle( (0,0), 0.7, color='white')\nplt.pie(size, labels=meal_labels, colors=colors, wedgeprops = { 'linewidth' : 3, 'edgecolor' : 'white' })\np=plt.gcf()\np.gca().add_artist(my_circle)\nplt.title('Tipo de r\u00e9gimen', weight='bold')\nplt.show()\n\n# Como podemos observar en el gr\u00e1fico de abajo, la gran mayor\u00eda de reservas son con r\u00e9gimen de Bed & Breakfast\n# Casi nadie elige Full Board","3bb23331":"group_meal_data = data.groupby(['hotel','meal']).size().unstack(fill_value=0).transform(lambda x: x\/x.sum())\ngroup_meal_data.applymap('{:.2f}'.format)","5c9e89fc":"deposit_type_Spain = data[data['country'] == \"ESP\"]['deposit_type'].value_counts().reset_index()\ndeposit_type_Spain.columns = ['Tipo de dep\u00f3sito', 'N\u00ba Reservas']\ndeposit_type_Spain","807d19a5":"reservation_date_Spain = data[data['country'] == \"PRT\"][data['is_canceled'] == 0]['arrival_date_year'].value_counts().reset_index()\nreservation_date_Spain.columns = ['A\u00f1o', 'N\u00ba Reservas']\nreservation_date_Spain","017026e6":"sns.countplot(data=data, x= 'total_of_special_requests', hue='is_canceled')","50a47337":"sns.countplot(data=data, x= 'previous_cancellations', hue='is_canceled')","b7d0ca6a":"sns.countplot(data=data, x= 'booking_changes', hue='is_canceled')","d6cbc221":"\n# Analizamos la variable \"lead time\" en relaci\u00f3n con la cancelaci\u00f3n\n\n# Primero, vamos a dividir \"lead time\" en varios intervalos: menos de 100 dias, de entre 100-355 dias y 365 d\u00edas o mas\n\nlead_time_1 = data[data[\"lead_time\"] < 100]\nlead_time_2 = data[(data[\"lead_time\"] >= 100) & (data[\"lead_time\"] < 365)]\nlead_time_3 = data[data[\"lead_time\"] >= 365]\n\n\n# A continuaci\u00f3n calculamos las cancelaciones de acuerdo a estos grupos: \n\nlead_cancel_1 = lead_time_1[\"is_canceled\"].value_counts()\nlead_cancel_2 = lead_time_2[\"is_canceled\"].value_counts()\nlead_cancel_3 = lead_time_3[\"is_canceled\"].value_counts()\n\n\n\ntotal_lead_days_cancel = pd.DataFrame(data=[lead_cancel_1,lead_cancel_2,lead_cancel_3],\n             index=[\"[0,100) days\", \"[100,365) days\", \"[365,max) days\"])\n# Mostramos la tabla\ntotal_lead_days_cancel\n\n","dd74e49f":"autopct='%1.1f%%'","71c5acc0":"# Gr\u00e1ficamente lo representamos as\u00ed:\n\nfig, ax = plt.subplots(1,3, figsize=(15,4))\nax[0].pie(np.array([total_lead_days_cancel[0][0], total_lead_days_cancel[1][0]]),\n          labels=[\"not_canceled\", \"canceled\"], autopct='%1.1f%%', startangle=90)\nax[0].set_title(\"lead_time entre 0 y 100 dias\", size=15)\nax[1].pie(np.array([total_lead_days_cancel[0][1], total_lead_days_cancel[1][1]]),\n          labels=[\"not_canceled\", \"canceled\"], autopct='%1.1f%%', startangle=90)\nax[1].set_title(\"lead_time entre 100 y 365 dias\", size=15)\nax[2].pie(np.array([total_lead_days_cancel[0][2], total_lead_days_cancel[1][2]]),\n          labels=[\"not_canceled\", \"canceled\"],autopct='%1.1f%%', startangle=90)\nax[2].set_title(\"lead_time 365 dias o mas\", size=15)\nplt.tight_layout()\nplt.show()","97cb2294":"plt.figure(figsize = (24, 12))\n\ncorr = data.corr()\nsns.heatmap(corr, annot = True, linewidths = 1)\nplt.show()\n","73c151d5":"\neliminar = ['days_in_waiting_list', 'arrival_date_year', 'arrival_date_year', 'assigned_room_type',\n            'reservation_status', 'country', 'days_in_waiting_list', 'children', 'adults', 'babies']\n\ndata.drop(eliminar, axis = 1, inplace = True)","d8d9e2cd":"cat_cols = [col for col in data.columns if data[col].dtype == 'O']\ndata[cat_cols].head()\ncat_df = data[cat_cols]","31d2e40a":"cat_df['reservation_status_date'] = pd.to_datetime(cat_df['reservation_status_date'])\n\ncat_df['year'] = cat_df['reservation_status_date'].dt.year\ncat_df['month'] = cat_df['reservation_status_date'].dt.month\ncat_df['day'] = cat_df['reservation_status_date'].dt.day\n\n# Aqu\u00ed podr\u00edamos eliminar la variable a partir de la cual hemos sacado la informaci\u00f3n pero preferimos conservarla de momento.\n# Al final lo acabamos haciendo, junto con otras columnas que no vemos \u00fatiles.\n\ncat_df.drop(['reservation_status_date','arrival_date_month'] , axis = 1, inplace = True)\n\n","9b36df56":"for col in cat_df.columns:\n    print(f\"{col}: \\n{cat_df[col].unique()}\\n\")","7ed92826":"cat_df.head()","a457abf3":"cat_df['hotel'] = cat_df['hotel'].map({'Resort Hotel' : 0, 'City Hotel' : 1})\n\ncat_df['meal'] = cat_df['meal'].map({'BB' : 0, 'FB': 1, 'HB': 2, 'SC': 3, 'Undefined': 4})\n\ncat_df['market_segment'] = cat_df['market_segment'].map({'Direct': 0, 'Corporate': 1, 'Online TA': 2, 'Offline TA\/TO': 3,\n                                                           'Complementary': 4, 'Groups': 5, 'Undefined': 6, 'Aviation': 7})\n\ncat_df['distribution_channel'] = cat_df['distribution_channel'].map({'Direct': 0, 'Corporate': 1, 'TA\/TO': 2, 'Undefined': 3,\n                                                                       'GDS': 4})\n\ncat_df['reserved_room_type'] = cat_df['reserved_room_type'].map({'C': 0, 'A': 1, 'D': 2, 'E': 3, 'G': 4, 'F': 5, 'H': 6,\n                                                                   'L': 7, 'B': 8})\n\ncat_df['customer_type'] = cat_df['customer_type'].map({'Transient': 0, 'Contract': 1, 'Transient-Party': 2, 'Group': 3})\n\n\ncat_df['deposit_type'] = cat_df['deposit_type'].map({'No Deposit': 0, 'Refundable': 1, 'Non Refund': 2})","445be92d":"num_df = data.drop(columns = cat_cols, axis = 1)\nnum_df.drop('is_canceled', axis = 1, inplace = True)\nnum_df","b573bf8f":"num_df['lead_time'] = np.log(num_df['lead_time'] + 1)\nnum_df['arrival_date_week_number'] = np.log(num_df['arrival_date_week_number'] + 1)\nnum_df['arrival_date_day_of_month'] = np.log(num_df['arrival_date_day_of_month'] + 1)\nnum_df['adr'] = np.log(num_df['adr'] + 1)\n\n# eliminamos los nas que nos genera esa normalizacion\nnum_df['adr'] = num_df['adr'].fillna(value = num_df['adr'].mean())\n","531ee888":"X = pd.concat([cat_df, num_df], axis = 1)\n\ny = data['is_canceled']\nX.shape, y.shape","f343f7d6":"X.head()","51dcfa94":"X_train, X_test, y_train, y_test = train_test_split(X, y, test_size = 0.30)","58fb4efe":"X_train.head()","1fd204e5":"X_test.dtypes","26168ccf":"lr = LogisticRegression(solver='liblinear')\nlr.fit(X_train, y_train)\n\ny_pred_lr = lr.predict(X_test)\n\nacc_lr = accuracy_score(y_test, y_pred_lr)\nconf = confusion_matrix(y_test, y_pred_lr)\nclf_report = classification_report(y_test, y_pred_lr)\n\nprint(f\"Accuracy Score of Logistic Regression is : {acc_lr}\")\nprint(f\"Confusion Matrix : \\n{conf}\")\nprint(f\"Classification Report : \\n{clf_report}\")","0ab83abd":"xgb = XGBClassifier(booster = 'gbtree', learning_rate = 0.1, max_depth = 5, n_estimators = 180)\nxgb.fit(X_train, y_train)\n\ny_pred_xgb = xgb.predict(X_test)\n\nacc_xgb = accuracy_score(y_test, y_pred_xgb)\nconf = confusion_matrix(y_test, y_pred_xgb)\nclf_report = classification_report(y_test, y_pred_xgb)\n\nprint(f\"Accuracy Score of Ada Boost Classifier is : {acc_xgb}\")\nprint(f\"Confusion Matrix : \\n{conf}\")\nprint(f\"Classification Report : \\n{clf_report}\")","9452a2ef":"X.info()","e550d94f":"X_2=X[[\"hotel\",\"meal\"]]\ny = data['is_canceled']","422864f1":"X_train, X_test, y_train, y_test = train_test_split(X_2, y, test_size = 0.30)\n\n\nxgb = XGBClassifier(booster = 'gbtree', learning_rate = 0.1, max_depth = 5, n_estimators = 180)\nxgb.fit(X_train, y_train)\n\ny_pred_xgb = xgb.predict(X_test)\n\nacc_xgb = accuracy_score(y_test, y_pred_xgb)\nconf = confusion_matrix(y_test, y_pred_xgb)\nclf_report = classification_report(y_test, y_pred_xgb)\n\nprint(f\"Accuracy Score of Ada Boost Classifier is : {acc_xgb}\")\nprint(f\"Confusion Matrix : \\n{conf}\")\nprint(f\"Classification Report : \\n{clf_report}\")","bd14abc2":"X_3=X[[\"hotel\",\"meal\", \"reserved_room_type\", \"customer_type\",\"year\", \"month\", \"day\", \"lead_time\", \"deposit_type\",\n       \"arrival_date_week_number\",\n       \"arrival_date_day_of_month\",      \n       \"stays_in_weekend_nights\", \"stays_in_week_nights\",\"is_repeated_guest\", \n       \"previous_cancellations\",\"previous_bookings_not_canceled\",\n       \"adr\",\"required_car_parking_spaces\",\"total_of_special_requests\", \"Total_Guests\", \"booking_changes\"]]\ny = data['is_canceled']","796e394f":"X_train, X_test, y_train, y_test = train_test_split(X_3, y, test_size = 0.30)\n\n\nxgb = XGBClassifier(booster = 'gbtree', learning_rate = 0.1, max_depth = 5, n_estimators = 180)\nxgb.fit(X_train, y_train)\n\ny_pred_xgb = xgb.predict(X_test)\n\nacc_xgb = accuracy_score(y_test, y_pred_xgb)\nconf = confusion_matrix(y_test, y_pred_xgb)\nclf_report = classification_report(y_test, y_pred_xgb)\n\nprint(f\"Accuracy Score of Ada Boost Classifier is : {acc_xgb}\")\nprint(f\"Confusion Matrix : \\n{conf}\")\nprint(f\"Classification Report : \\n{clf_report}\")","c85f1d6e":"corr = abs(data.corr())\ncorr[['is_canceled']].sort_values(by = 'is_canceled',ascending = False).style.background_gradient()","50bb683a":"# Se graba el modelo en el directorio (descomentar si se quiere guardar)\n\"\"\"\npkl_filename = \"model_prediccion_cancelaciones.pkl\"\nwith open(pkl_filename, 'wb') as file:\n    pickle.dump(xgb, file)\n\"\"\"","2c12b226":"# Se carga el modelo para comprobar que funciona (descomentar si se quiere comprobar una vez guardado el modelo)\n\"\"\"\npkl_filename = \"model_prediccion_cancelaciones.pkl\"\nwith open(pkl_filename, 'rb') as file:\n    model = pickle.load(file)\n\"\"\"","5d0b4e5f":"# Descomentar si se han ejecutado las anteriores celdas (grabaci\u00f3n y carga del modelo)\n\"\"\"\nscore = model.score(X_test, y_test)\nprint(score)\n\"\"\"","c7c92d68":"#### 7.1. Modelo 1: Regresi\u00f3n Log\u00edstica","fbf0a59f":"## 2. An\u00e1lisis preliminar","eb024885":"----------------------------------------------------------------------------","fa0fc359":"Para la construcci\u00f3n de nuestro modelo, pondremos nuestro foco en el tipo de variable objetivo que tenemos. Al tratarse de una variable binaria ( 1=se ha cancelado y 0=no se ha cancelado), elegiremos un algoritmo de regresi\u00f3n log\u00edstica. Este modelo nos devolver\u00e1 la probabilidad de cancelaci\u00f3n, que posteriormente se implementar\u00e1 en nuestra aplicaci\u00f3n.","ed8f88b3":"La mayor\u00eda de las reservas se realizaron sin dep\u00f3sito y las que se realizaron con deposito s\u00f3lo una parte \u00ednfima fue con opci\u00f3n a reembolso. por otro lado, el n\u00famero anual de reservas tiene una tendencia decreciente.","37e4b71e":"#### 4.e. \u00bfExiste alguna relaci\u00f3n entre el n\u00famero de d\u00edas transcurridos desde la reserva, y las cancelaciones?","c340b220":"#### Se graba el modelo en el directorio para la posterior construcci\u00f3n de la app","8663ae7d":"#### 3.3 B\u00fasqueda de datos at\u00edpicos","3a292d86":"# <h1 align=\"center\">Modelo para la predicci\u00f3n de cancelaciones<\/h1>\n","27398f5a":"#### 4.j. Datos de inter\u00e9s sobre Espa\u00f1a","172fbee6":"-------------------------------------------------------\n","8a8d38fb":"Hay una tendencia al alza, cuantos m\u00e1s d\u00edas transcurren m\u00e1s cancelaciones se producen.","621aa8ed":"#### Eliminaci\u00f3n de las dos variables con gran cantidad de NA'S","7ba12936":"#### Nuevo an\u00e1lisis de los NA\u00b4S","c77fd390":"#### [Enlace al conjunto de datos (kaggle)](https:\/\/www.kaggle.com\/jessemostipak\/hotel-booking-demand)","62ae46b5":"Continuamos incluyendo una a una las variables hasta que obtenemos el siguiente modelo:","29be5663":"#### 4.i. Pesos en funci\u00f3n del tipo de alojamiento:","8a06296a":"#### 4.k. Relaci\u00f3n entre total_of_special_requests, previous_cancellations y cancelaciones","c9d2e5c6":"## 5. Gr\u00e1fico de correlaciones\n","e150e5dd":"**Lead_time** es la que mayor correlaci\u00f3n tiene. Tal como se mencion\u00f3 en la explicaci\u00f3n del gr\u00e1fico de correlaciones.\n\n**Peticiones especiales** aumentan la probabilidad de cancelaci\u00f3n, se entiende que las camas extra, determinados servicios u otras comodidades hacen que los clientes cambien de opci\u00f3n con m\u00e1s facilidad por diferencias de precio, calidades o cambios en sus necesidades. Tiene una correlaci\u00f3n de 0.18 con la variable adr (precio de la reserva)\n\n**Parkings:** la correlaci\u00f3n mas importante la tiene con lead_time (0.12) por lo que nuevamente el tiempo entre la reserva y el book-in es determinante. Puede ser ocasionado por cambios en la planificaci\u00f3n del viaje e imprevistos entre otros factores.\n\n**Cambios en la reserva:** El cliente tiene cambios en sus necesidades y al modificarla, tambi\u00e9n busca otras opciones las cuales podr\u00edan interesarle m\u00e1s.\n\n**Cancelaciones previas:** A mayor n\u00famero de cancelaciones previas realizadas por el cliente anteriores a la reserva actual, mayor probabilidad de cancelaci\u00f3n de reserva.\n\n**Repeated Guests:** si es un cliente que repite reserva, es probable que cancele debido a que puede buscar un destino nuevo a su vez.\n","55598a5e":"#### 6.2. Diferenciaci\u00f3n entre categ\u00f3ricas y num\u00e9ricas","aab15ce3":"#### 7.2. Modelo 2: XGBoost","90cf6b44":"   ### \u00cdndice:\n   \n       1. Importaci\u00f3n de librer\u00edas y datos\n\n       2. An\u00e1lisis preliminar\n       \n       3. Preprocesado\n       \n       4. EDA\n       \n       5. Gr\u00e1fico de correlaciones\n       \n       6. Exploraci\u00f3n y transformaci\u00f3n de variables\n       \n       7. Construcci\u00f3n del modelo\n\n","d3d3bbef":"--------------------------------------------------------------------------------------------------------------","748d5b16":"El gr\u00e1fico muestra el n\u00famero de noches en fin de semana que tienen las reservas. Si se suman los valores de las reservas con una o dos noches se ve claramente como el valor de estas es superior al del resto de la semana (reservas con valor cero en el n\u00famero de noches) por lo que hay un claro aumento de la reservas en fin de semana. Adem\u00e1s el n\u00famero de reservas canceladas con alguna noche en fin de semana es proporcionalmente inferior al del resto de reservas.","63955d2c":"#### Ahora se visualiza sin diferenciar","3cf8efc2":"Comenzamos incluyendo \u00fanicamente las variables \"hotel\" y \"meal\", y analizando las predicciones.","e736578f":"#### 4.f. \u00bfSe distribuyen de forma homog\u00e9nea las llegadas dependiendo del mes?\n","d1be5c01":"En este apartado, hemos abordado el an\u00e1lisis de diferentes preguntas capaces de darnos mucha informaci\u00f3n, no solo a la hora de construir nuestro modelo de predicci\u00f3n, sino de entender un poco m\u00e1s el mundo de las reservas de hoteles, as\u00ed como las necesidades que les pueden surgir a las empresas y que nosotros tratamos de solucionar con nuestras herramientas de Big Data.\n\n","7c77f021":"#### 6.3. Categorizaci\u00f3n para facilitar los c\u00e1lculos:","6411b473":"#### 4.c. \u00bfVar\u00eda el precio seg\u00fan la \u00e9poca del a\u00f1o?","333cfcb3":"#### 6.4. Normalizamos las variables num\u00e9ricas","28ce0c8a":"El 94% de las reservas con pensi\u00f3n completa (full Board) se hacen en los Resort Hotel","586f5439":"#### 3.2. Correcci\u00f3n preliminar de errores detectados:\nAl analizar las caracter\u00edsticas de las reservas, en concreto en lo que se refiere a los hu\u00e9spedes, nos damos cuenta de que existen un total de 170 observaciones que cumplen con la condici\u00f3n de que: (data.children == 0) & (data.adults == 0) & (data.babies == 0)\n\nNo puede haber 0's en una misma observaci\u00f3n en adults, children y babies (pues no se puede hacer una reserva sin hu\u00e9spedes). \n","83cc68d7":"#### Comprobaci\u00f3n de que no hay registros que sumen cero y por tanto el numero de registros total es correcto:","9f486cf8":"En este primer an\u00e1lisis exploratorio se realiza un recuento del n\u00famero de hu\u00e9spedes por nacionalidad.\nDestaca Portugal con una clara diferencia respecto Gran Breta\u00f1a.","ea49c589":"Pasamos a anlizar el gr\u00e1fico de correlaciones,que nos va a dar una informaci\u00f3n muy \u00fatil a la hora de definir nuestro modelo.\nComo podemos analizar, las correlaciones m\u00e1s altas con la variable \"is_cancelled\" (nuestra target) son:\n\"lead_time\" (0.29), \"total_of_special_requests\" (-0.24), \"booking_changes\" (-0.15)y \"previous_cancellations\" (0.11).\nDel correlograma extraemos lagran cantidad de valores que guardan una correlaci\u00f3n negativa con la variable objetivo. Las correlaciones por lo general son bajas.\n\nQue la variable que m\u00e1s correlaci\u00f3n tenga sea lead_time no nos soprende en el sentido que reservas hechas con una menor anticipaci\u00f3n est\u00e1n menos afectadas por imprevistos que puedan desembocar en su posterior cancelaci\u00f3n.\n\nComo es razonable, la variable Total_Guests que hemos creado mediante feature engineering, est\u00e1 muy correlacionada con adults, children e incluso babies, por lo que se proceder\u00e1 a eliminar estas \u00faltimas. \n\nLa correlaci\u00f3n entre las variables total_guests y adr (0.43) se debe a que a mayor n\u00famero de personas por reserva, mayor es el precio de la misma.\n\n\nStays_in_weekend_night \/ Stays_in_week_night: Las reservas con noches de diario y fines de\nsemana tienen m\u00e1s probabilidad de ser canceladas. Las estancias en d\u00edas de diario son habituales\nen viajes de negocios y las de fin de semana son m\u00e1s cortas y suelen surgir menos imprevistos.\nCorrelaci\u00f3n (0.46).\n\nLa correlaci\u00f3n entre las variables total_guests \/ adr (0.43) se debe a que, a mayor n\u00famero de\npersonas por reserva, mayor es el precio de la misma.\n\nRepeated Guests \/ Previous_bookings_not_canceled: si un cliente repite y previamente\nrealiz\u00f3 reservas las cuales no cancel\u00f3 (0.43) significa que ser\u00e1 m\u00e1s propenso a cancelar por\ncambios en sus preferencias.\n\nSpecial_request \/ adr las camas extra, determinados servicios u otras comodidades hacen que\nlos clientes cambien de opci\u00f3n con m\u00e1s facilidad por diferencias de precio (0.18).\n\nTotal_guests \/ Special_request: a mayor n\u00famero de personas por reserva y peticiones\nespeciales mayor riegos de cancelaci\u00f3n. Puede deberse a discrepancias entre las personas de la\nreserva. Correlaci\u00f3n (0.16).\n\nPrevious_cancelations \/ Previous_bookings_not_\ncancelled:  Los clientes que previamente han reservado y han cancelado algunas de esas\nreservas tienen m\u00e1s probabilidad de cancelar sus nuevas reservas. (0.15).\n\nParking \/ lead_time (0.12) el tiempo entre la reserva y el book-in es determinante. Puede ser\nocasionado por cambios en la planificaci\u00f3n del viaje e imprevistos entre otros factores.","d497cb3f":"#### 4.h. \u00bfQu\u00e9 tipo de r\u00e9gimen de pensi\u00f3n  eligen los hu\u00e9spedes?","5367ac06":"#### 4.b. \u00bfCu\u00e1nto se paga por una noche de alojamiento?","9bcc7465":"Nos quedamos con las siguientes variables: \n\n\"hotel\"\n\"meal\"\n\"reserved_room_type\"\n\"customer_type\"\n\"year\"\n\"month\"\n\"day\"\n\"deposit_type\"                    \n\"lead_time\"\n\"arrival_date_week_number\"\n\"arrival_date_day_of_month\"\n\"stays_in_weekend_nights\"\n\"stays_in_week_nights\"\n\"is_repeated_guest\"\n\"previous_cancellations\"\n\"previous_bookings_not_canceled\"\n\"adr\"\n\"required_car_parking_spaces\"\n\"total_of_special_requests\"\n\"Total_Guests\"\n\"Booking_changes\"\n\n\nHemos prescindido de:\n\n\"market segment\"\n\"distribution_channel\"\n\"num_personas\"","d31b9723":"#### 3.1.Tratamiento de datos faltantes: an\u00e1lisis de los valores NA\nLas variables country, agent y company destacan por su n\u00famero de NA\u00b4S","f6eda557":"Pasos a seguir:\n\n- Comprobaci\u00f3n de la correcta tipolog\u00eda y rol de las variables\n- Tratamiento de datos faltantes\n- Correcci\u00f3n preliminar de errores detectados\n- B\u00fasqueda de datos at\u00edpicos","209faf34":"Pr\u00e1cticamente no var\u00eda el accuracy","76280c68":"#### 6.1 Eliminamos algunas columnas no \u00fatiles","321c3064":"#### Ahora se eliminan las observaciones de las variables en las que hay pocos NA\u00b4s\n ","c1893c1b":"Verificamos esta informaci\u00f3n que nos dan los boxplot empleando t\u00e9cnicas de clustering, en concreto, el algoritmo DBScan. Se utiliza como m\u00e9todo de detecci\u00f3n de anomal\u00edas basado en la densidad de datos, tanto unidimensionales como multidimensionales.\nDistingue entre diferentes puntos dentro del cl\u00faster: core points, border points y noise points. Los llamados \"noise points\" son aquellos que no pertenecen a ning\u00fan cl\u00faster, y que por lo tanto pueden llegar a considerarse an\u00f3malos.\n","00a7885b":"------------------------------------","76604dd2":"#### Desempe\u00f1o del modelo","ab98f927":"Nos encontramos con un dataset con un total de 32 columnas.","c02c304a":"#### Se concluye que se trata de un error, por lo que procedemos a eliminarlos:","4923a83a":"## 3. Preprocesado de los datos","78a2a350":"## 4. EDA","7e2539fc":"Al considerar las diferentes opciones de tratamiento de NA's nos decantamos por no imputar estos valores con sus medias ni 0's dado que para el caso de la variable 'company', los missing values representaban un 96 \\% del total de la data de esa columna. Por lo tanto, modificarlos supondr\u00eda una grave alteraci\u00f3n de los datos.\nHemos de tener adem\u00e1s en cuenta que la eliminaci\u00f3n de variables s\u00f3lo debe llevarse a cabo cuando la proporci\u00f3n de missings sea muy elevada (superior al 50%) y, por tanto, la p\u00e9rdida de informaci\u00f3n no lo sea tanto.\n\nPara el caso de \u2018agent\u2019, aunque el porcentaje no era tan elevado, de igual manera decidimos eliminarlo dado que no nos aportaba mucha informaci\u00f3n para el modelo.\n\n","62c26d36":"Casi la mitad de las reservas sin solicitudes especiales se han cancelado.\nSin embargo, vemos que en cuanto hay una solicitud de peticiones especiales o m\u00e1s, hay muchas mas reservas que no se cancelan que se cancelan.\n\n","00195a50":"#### Se procede a sustituir la mayor\u00eda de los valores at\u00edpicos por otros dentro del \u00faltimo cuartil o por el valor cero dependiendo del caso.","6cb80c61":"A continuaci\u00f3n, se muestra a modo de ejemplo el procedimiento que seguimos. Hemos ido incluyendo una por una las diferentes variables hasta que hemos obtenido un accuracy satisfactorio, logrando reducir la dimensionalidad de los datos.","5952a8a2":"## 1. Importaci\u00f3n de librer\u00edas y datos","204c95e2":"## 6. Exploraci\u00f3n y transformaci\u00f3n de variables","3c0404f4":"Como podemos observar m\u00e1s arriba, nuestro modelo tiene un scoring de 0.807. En cuanto a la matriz de confusi\u00f3n, la diagonal principal representar\u00e1 los casos en los que nuestro modelo ha acertado. La otra diagonal, por el contrario, representar\u00e1 los casos en los que nuestro modelo ha fallado. En concreto, nuestro modelo tiene 21.072 verdaderos positivos, 1.157 falsos positivos, 5.695 falsos negativos y 7.695 verdaderos negativos. ","bd91c9c2":"#### 4.a. Pa\u00edses con m\u00e1s visitas","13855c41":"#### 4.d. Diferencias por el tipo de alojamiento:","959bc5cc":"####  Separamos en Train y en Test","8a670e2d":"#### Clara primac\u00eda de Europa y en especial de Portugal","4c668400":"----------------------------------------------------------------------------------------------------\n","1e6d229f":"-----------------------------------------------------------------------------------------------------------------","75b0e976":"Comenzamos con la detecci\u00f3n de outliers visualizando los boxplot de las diferentes variables que conforman nuestro modelo. De su visualizaci\u00f3n obtenemos un total de 8 variables que presentan cierta problem\u00e1tica: 'lead time', 'stays in weekend nights', 'stays in week nights', 'adults', 'babies', 'required car parking spaces', 'adr', 'previous cancellations'.\n","21b0e513":"#### 4.g. \u00bfTienen mayor \u00edndice de cancelaci\u00f3n los fines de semana?","4e62d930":"Se concluye que se distribuyen de forma razonablemente homogenea. El valor m\u00e1s bajo se registra los d\u00edas 31, esto se debe a que no todos los meses tienen 31 d\u00edas y por tanto el recuento de llegadas es inferior.","bf0bc3d7":"Esta primera correcci\u00f3n de registros conflictivos nos anima a proceder con la b\u00fasqueda de datos at\u00edpicos, esto es, observaciones num\u00e9ricamente distantes del resto de los datos.\n\nResulta de gran importancia poder lidiar con este tipo dada su gran influencia en los resultados, si los modelos no son robustos.\nPara la detecci\u00f3n de estos datos, dado que no existe un m\u00e9todo perfecto de detecci\u00f3n, hemos hecho uso de varios, considerando como at\u00edpicas aquellas observaciones consideradas como tal por m\u00e1s de un m\u00e9todo.\n","d5433ac5":"En nuestro caso, por ejemplo, encontramos que la variable \u201clead_time\u201d tiene un total de 2 noisy points. En total, esas 8 variables que ve\u00edamos problem\u00e1ticas suman 2713 noisy points.\n","b225a07f":"----------------------------\n","22f7c14f":"De este gr\u00e1fico extraemos que cuando el tiempo de espera es mayor, aumentan las probabilidades de cancelaci\u00f3n. La cantidad de reservas se mantiene estable en general entre 20 y 100 d\u00edas y a continuaci\u00f3n desciende.\n","f566dc2d":"Obtenemos inicialmente un accuracy de 0.627.","c2218d7e":"De este An\u00e1lisis Exploratorio de los datos nos vamos a quedar con la siguiente informaci\u00f3n \u00fatil para el modelo:\n\n- La indudable importancia de la variable hotel, referida al tipo de hotel que se est\u00e1 reservando, pues como hemos podido ver en varios gr\u00e1ficos, la diferencia en la interpretaci\u00f3n es considerable cuando habalmos de un resort frente a cuando hablamos de un hotel de ciudad.\n\n\n\n- Por otro lado, las peculiaridades que ciertas variables como \u201clead_time\u201d, total number of guests, \u201cBooking_changes\u201d y \u201cprevious_cancellations\u201d, las cuales consideramos que pueden tener un peso considerable para predecir de una manera m\u00e1s precisa futuras cancelaciones. ","c7fab915":"------------------------------------------------------------------------------------------------------------","a954b393":"#### 7.3. Conclusi\u00f3n e implementaci\u00f3n del modelo en la aplicaci\u00f3n","ce3883e7":"------------------------------------\n","063336a7":"#### **Importancia de las variables en el modelo**","63e238e8":"La mayoria de las reservas son con r\u00e9gimen de Bed & Breakfast y s\u00f3lo una parte muy peque\u00f1a elije pensi\u00f3n completa.","4be9bf98":"Con este modelo, empleando un clasificador XGBoost con learning_rate = 0.1, max_depth = 5, n_estimators = 180 se ha conseguido un accuracy de 0.982.\n\nSin embargo, no se puede dejar de lado el modo en el que se va a implementar este modelo.\nHemos optado por el dise\u00f1o de una interfaz sencilla, amigable para los usuarios de la empresa, por lo que par\u00e1ndonos a analizar las variables que han sido empleadas en el modelo consideramos la posibilidad de reducir nuestra dimensionalidad.\n\nPara ello, se emplear\u00e1 el m\u00e9todo de lo particular a lo general analizando como se comporta el accuracy y hasta qu\u00e9 punto somos capaces de simplificar nuestro modelo.\n\n","4d2c2258":"## 7. Construcci\u00f3n del modelo"}}