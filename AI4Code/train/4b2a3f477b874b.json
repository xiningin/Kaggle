{"cell_type":{"9e03e7e9":"code","4b6dacf6":"code","aad93ec6":"code","9c693d59":"code","f90045bd":"code","aeec39ab":"code","1d2365df":"code","c84c987c":"code","da835fc9":"code","e7dfebf4":"code","ace505a6":"code","d5cfd25f":"code","4b0f40c2":"markdown"},"source":{"9e03e7e9":"!pip install kaggler==0.8.7","4b6dacf6":"import kaggler\nprint(kaggler.__version__)","aad93ec6":"import warnings\nwarnings.filterwarnings(\"ignore\")\n\nimport gc\nimport joblib\nimport lightgbm as lgb\nimport numpy as np\nimport os\nimport pandas as pd\nfrom sklearn.model_selection import StratifiedKFold\nfrom kaggler.metrics import auc\nfrom kaggler.model import AutoLGB\nfrom kaggler.preprocessing import EmbeddingEncoder, TargetEncoder, LabelEncoder","9c693d59":"trn = pd.read_csv(\"\/kaggle\/input\/cat-in-the-dat\/train.csv\")\ntst = pd.read_csv(\"\/kaggle\/input\/cat-in-the-dat\/test.csv\")\nsample = pd.read_csv(\"\/kaggle\/input\/cat-in-the-dat\/sample_submission.csv\")","f90045bd":"y_trn = trn['target']","aeec39ab":"for col in trn.columns:\n    print('{:>8s}: {:6d}'.format(col, trn[col].nunique()))","1d2365df":"features = [x for x in trn.columns if x not in ['id', 'target']]\n\nfeatures_to_emb = ['nom_5', 'nom_6', 'nom_7', 'nom_8', 'nom_9', 'ord_3', 'ord_4', 'ord_5']\nn_emb = [16, 16, 20, 20, 30, 4, 8, 16]","c84c987c":"features_emb = []\nfor n, col in zip(n_emb, features_to_emb):\n    features_emb += ['{}_{}'.format(col, i + 1) for i in range(n)]","da835fc9":"n_fold = 5\nseed = 42\ncv = StratifiedKFold(n_splits=n_fold, random_state=seed)","e7dfebf4":"le = LabelEncoder(min_obs=50)\nte = TargetEncoder(smoothing=1, min_samples=50, cv=cv)\n\nX_trn = pd.concat([le.fit_transform(trn[features]), te.fit_transform(trn[features], y_trn)], axis=1)\nX_tst = pd.concat([le.transform(tst[features]), te.transform(tst[features])], axis=1)\nfeatures = ['le_{}'.format(col) for col in features] + ['te_{}'.format(col) for col in features]\n\nX_trn.columns = features\nX_tst.columns = features\nprint(X_trn.shape, X_tst.shape)","ace505a6":"p = np.zeros((trn.shape[0],))\np_tst = np.zeros((tst.shape[0],))\n\nfeatures += features_emb\nfor i, (i_trn, i_val) in enumerate(cv.split(X_trn, y_trn), 1):\n    y_trn_cv = y_trn[i_trn].reset_index(drop=True)\n\n    ee = EmbeddingEncoder(cat_cols=features_to_emb, num_cols=[], n_emb=n_emb, random_state=seed)\n    X_emb_trn = ee.fit_transform(trn.loc[i_trn, features_to_emb], y_trn_cv)\n    X_emb_val = ee.transform(trn.loc[i_val, features_to_emb])\n    X_emb_tst = ee.transform(tst[features_to_emb])\n    \n    X_trn_cv = pd.concat([X_trn.loc[i_trn].reset_index(drop=True), \n                          pd.DataFrame(X_emb_trn, columns=features_emb)], axis=1)\n    X_val_cv = pd.concat([X_trn.loc[i_val].reset_index(drop=True), \n                          pd.DataFrame(X_emb_val, columns=features_emb)], axis=1)\n    X_tst_cv = pd.concat([X_tst, pd.DataFrame(X_emb_tst, columns=features_emb)], axis=1)\n   \n    if i == 1:\n        print('Feature selection and parameter tuning with CV #{}'.format(i))\n        model = AutoLGB(objective='binary', metric='auc', sample_size=50000, random_state=seed)\n        model.tune(X_trn_cv, y_trn_cv)\n        print('{} features selected out of {}'.format(len(model.features), len(features)))\n        \n    model.fit(X_trn_cv, y_trn_cv)\n    p[i_val] = model.predict(X_val_cv)\n    print('AUC (CV #{}): {:.4f}'.format(i, auc(y_trn[i_val], p[i_val])))\n    p_tst += model.predict(X_tst_cv) \/ n_fold\n    \nprint('AUC CV: {:.4f}'.format(auc(y_trn, p)))","d5cfd25f":"print(\"Saving submission file\")\nsubmission = pd.DataFrame.from_dict({\n    'id': tst.id.values,\n    'target': p_tst\n})\nsubmission.to_csv(\"submission.csv\", index=False)","4b0f40c2":"Kaggler's EmbeddingEncoder + TargetEncoder + AutoLGB"}}