{"cell_type":{"fc989fe4":"code","acaf72db":"code","58a9495c":"code","3148781d":"code","160de9a1":"code","6365425e":"code","f338ac20":"code","ebd5dd11":"code","5242562a":"code","734cf3e9":"code","c08c5420":"code","3f1fa119":"code","b3bea65f":"code","91dea778":"code","2d33ed1a":"code","14579020":"code","23480f4b":"code","e126417b":"code","d79798ee":"code","d98641e7":"code","9132d3b1":"code","53f854c7":"code","565204bb":"code","101d615e":"code","c0794182":"code","bfb08ac2":"markdown","cb017165":"markdown","867a7cc8":"markdown","98a7aef3":"markdown","286cf41f":"markdown","3d7a52bf":"markdown","e46b7d39":"markdown","913f80d0":"markdown","a199d90d":"markdown","b3caa8ae":"markdown"},"source":{"fc989fe4":"# Load packages\nimport pandas as pd\nimport numpy as np\nimport pystan\nimport matplotlib.pyplot as plt\nimport random\n\n# Import data\ndat = pd.read_csv(\"..\/input\/results.csv\")\neuros = dat.loc[(dat.tournament ==\"UEFA Euro qualification\") & (pd.DatetimeIndex(dat['date']).year == 2019)]\n\n# Take last 10 years of data\ndat = dat[ pd.DatetimeIndex(dat['date']).year >= 2010]\n\n# Create home and away\ndat[\"homei\"] = 1-dat.neutral\ndat[\"homej\"] = 0\n\n# Create margin\ndat['margin'] = dat.home_score - dat.away_score\n\n\n# Set up team id mapping\nteam_key = pd.DataFrame({\"teamname\" : dat.home_team.append(dat.away_team).unique(),\n                         \"teamid\"   : range(1, 1+len(dat.home_team.append(dat.away_team).unique()))})\n\n# Recoding ids in qualifying data\ndat = dat.merge(team_key, left_on=\"home_team\" , right_on=\"teamname\")\ndat = dat.drop(columns=[\"teamname\", \"home_team\"])\ndat = dat.rename(index = str, columns = {\"teamid\" : \"home_team\"})\n\ndat = dat.merge(team_key, left_on=\"away_team\" , right_on=\"teamname\")\ndat = dat.drop(columns=[\"teamname\", \"away_team\"])\ndat = dat.rename(index = str, columns = {\"teamid\" : \"away_team\"})\n\n\n# Final dataset for modeling\nnames = [\"N\", \"y\", \"h_i\", \"h_j\", \"team_i\", \"team_j\", \"N_g\"]\nvalues = [len(dat.index), dat.margin, dat.homei, dat.homej, dat.home_team, dat.away_team, 278]\n\ntrain = dict(zip(names, values))","acaf72db":"model = \"\"\"\ndata {\n    int N;\n    vector[N] y;\n    int team_i[N];\n    int team_j[N];\n    int h_i[N];\n    int h_j[N];\n    int N_g;\n}\nparameters {\n    vector[N_g] alpha_raw;\n    vector[N_g] theta_raw;\n    real eta;\n    real<lower=0> tau_theta;\n    real<lower=0> tau_alpha;\n    real<lower=0> sigma;\n}\ntransformed parameters {\n    vector[N_g] alpha;\n    vector[N_g] theta;\n    alpha = eta + alpha_raw*tau_alpha;\n    theta = theta_raw*tau_theta;\n}\nmodel {\n    \/\/ vector for conditional mean storage\n    vector[N] mu;\n\n    \/\/ priors\n    tau_theta ~ cauchy(0,1)T[0,];\n    tau_alpha ~ cauchy(0,.25)T[0,];\n    sigma ~ cauchy(0,1)T[0,];\n    eta ~ normal(.5,.25);\n    theta_raw ~ normal(0,1);\n    alpha_raw ~ normal(0,1);\n\n    \/\/ define mu for the Gaussian\n    for( t in 1:N ) {\n    mu[t] = (theta[team_i[t]] + alpha[team_i[t]]*h_i[t]) - \n    (theta[team_j[t]] + alpha[team_j[t]]*h_j[t]);\n}\n\n    \/\/ the likelihood\n    y ~ normal(mu,sigma);\n}\n\"\"\"\n\nsm = pystan.StanModel(model_code = model)\nfit = sm.sampling(data = train, \n                  iter = 1500, \n                  warmup = 750,\n                  refresh = 100,\n                  control = dict(adapt_delta = 0.9))","58a9495c":"# Extracting team skill levels\nth = pd.DataFrame(fit.extract()[\"theta\"])\na = pd.DataFrame(fit.extract()[\"alpha\"])\nsig = fit.extract()[\"sigma\"]\na.columns = team_key.teamname\nth.columns = team_key.teamname\n\n# Filtering to top 25 teams\ntheta25 = th[th.median().nlargest(25).index]\ntheta25 = theta25[theta25.columns[::-1]]\n\n# Creating the plot\ntheta25.boxplot(grid = False, vert = False, showfliers = False, figsize=(12, 8))\nplt.title('Team Power Rankings')\nplt.xlabel('Skill Level')\nplt.ylabel('Teams')","3148781d":"# Groups\nGroupA = [\"England\", \"Bulgaria\", \"Kosovo\", \"Montenegro\", \"Czech Republic\"]\nGroupB = [\"Ukraine\", \"Luxembourg\", \"Portugal\", \"Serbia\", \"Lithuania\"]\nGroupC = [\"Northern Ireland\", \"Germany\", \"Netherlands\", \"Estonia\", \"Belarus\"]\nGroupD = [\"Ireland\", \"Switzerland\", \"Denmark\", \"Gibraltar\", \"Georgia\"]\nGroupE = [\"Slovakia\", \"Wales\", \"Hungary\", \"Croatia\", \"Azerbaijan\"]\nGroupF = [\"Spain\", \"Sweden\", \"Romania\", \"Malta\", \"Norway\", \"Faroe Islands\"]\nGroupG = [\"Poland\", \"Israel\", \"Macedonia\", \"Slovenia\", \"Austria\", \"Latvia\"]\nGroupH = [\"France\", \"Turkey\", \"Albania\", \"Iceland\", \"Andorra\", \"Moldova\"]\nGroupI = [\"Belgium\", \"Russia\", \"Kazakhstan\", \"Cyprus\", \"Scotland\", \"San Marino\"]\nGroupJ = [\"Italy\", \"Greece\", \"Bosnia-Herzegovina\", \"Finland\", \"Armenia\", \"Liechtenstein\"]\n\ndef matchups(group):\n    df = pd.DataFrame({'home_team': [], 'away_team': []})\n    for i in group:\n        for j in [x for x in group if x != i]:\n            df = df.append({'home_team': i, 'away_team': j}, ignore_index=True)\n    return df\n        \n\ndef get_current_table(group, data):\n    group = matchups(group)\n    \n    euro_results = group.merge(data, on = [\"home_team\", \"away_team\"], how = \"left\")\n    return euro_results[[\"home_team\", \"away_team\", \"home_score\", \"away_score\"]]\n\n\n\ndef get_standings(group, data):\n    \n    # Getting results\n    current_table = get_current_table(group, data)\n    current_table[\"GD\"] = current_table.home_score - current_table.away_score\n        \n    # GF, GA, and record\n    standings = pd.DataFrame(current_table.groupby([\"home_team\"])[\"home_score\"].sum() + current_table.groupby([\"away_team\"])[\"away_score\"].sum())#.reset_index()\n    standings[\"goals_against\"] = current_table.groupby([\"home_team\"])[\"away_score\"].sum() + current_table.groupby([\"away_team\"])[\"home_score\"].sum()\n    standings[[\"win\", \"draw\", \"loss\"]] = current_table.groupby('home_team').GD.apply(lambda x: pd.Series([(x > 0).sum(), (x == 0).sum(), (x < 0).sum()])).unstack() + current_table.groupby('away_team').GD.apply(lambda x: pd.Series([(x < 0).sum(), (x == 0).sum(), (x > 0).sum()])).unstack()\n    \n    # Formatting\n    standings = standings.reset_index()\n    standings.columns = [\"team\", \"goals_for\", \"goals_against\", \"win\", \"draw\", \"loss\"]\n    \n    # GD, points\n    standings[\"goal_diff\"] = standings.goals_for - standings.goals_against\n    standings[\"points\"] = standings.win*3 + standings.draw\n    \n    # Ordering standings\n    standings = standings.sort_values(by = [\"points\", \"goal_diff\", \"goals_for\"], ascending =False)\n    standings.index = range(1,len(standings.index)+1)\n    \n    return standings","160de9a1":"def short_compare(i, j, homei =1, homej=0, th= th, a = a, sig = sig, allowdraw = True):\n    \n    home = int(th[i].sample(1).values + a[i].sample(1).values*homei)\n    away = int(th[j].sample(1).values + a[j].sample(1).values*homej)\n       \n    return home, away\n    \nshort_compare(\"Bosnia-Herzegovina\", \"Germany\")\n\ndef short_sim_season(group, data):\n    current_table = get_current_table(group, data)\n    \n    current_table_1 = current_table[current_table.home_score.isnull()].copy()\n    \n    for i in current_table_1.index:\n        current_table[\"home_score\"][i], current_table[\"away_score\"][i] = short_compare(current_table.home_team[i], current_table.away_team[i])\n    \n    current_table[\"GD\"] = current_table.home_score - current_table.away_score\n        \n    # GF, GA, and record\n    standings = pd.DataFrame(current_table.groupby([\"home_team\"])[\"home_score\"].sum() + current_table.groupby([\"away_team\"])[\"away_score\"].sum())#.reset_index()\n    standings[\"goals_against\"] = current_table.groupby([\"home_team\"])[\"away_score\"].sum() + current_table.groupby([\"away_team\"])[\"home_score\"].sum()\n    standings[[\"win\", \"draw\", \"loss\"]] = current_table.groupby('home_team').GD.apply(lambda x: pd.Series([(x > 0).sum(), (x == 0).sum(), (x < 0).sum()])).unstack() + current_table.groupby('away_team').GD.apply(lambda x: pd.Series([(x < 0).sum(), (x == 0).sum(), (x > 0).sum()])).unstack()\n    \n    # Formatting\n    standings = standings.reset_index()\n    standings.columns = [\"team\", \"goals_for\", \"goals_against\", \"win\", \"draw\", \"loss\"]\n    \n    # GD, points\n    standings[\"goal_diff\"] = standings.goals_for - standings.goals_against\n    standings[\"points\"] = standings.win*3 + standings.draw\n    \n    # Ordering standings\n    standings = standings.sort_values(by = [\"points\", \"goal_diff\", \"goals_for\"], ascending =False)\n    standings.index = range(1,len(standings.index)+1)\n    \n    return standings\n\n\ndef long_sim_season(group, data, reps = 1000):\n    pd.options.mode.chained_assignment = None  # default='warn'\n    \n    qual = pd.Series()\n    for i in range(0, reps):\n        season = short_sim_season(group, data)\n        qual = qual.append(season[\"team\"].head(2))\n    return qual.value_counts()\/reps*100","6365425e":"# Current Standings of Group\nget_standings(GroupA, euros)","f338ac20":"# Odds of each team qualifying under simulation\nlong_sim_season(GroupA, euros)","ebd5dd11":"# Current Standings of Group\nget_standings(GroupB, euros)","5242562a":"# Odds of each team qualifying under simulation\nlong_sim_season(GroupB, euros)","734cf3e9":"# Current Standings of Group\nget_standings(GroupC, euros)","c08c5420":"# Odds of each team qualifying under simulation\nlong_sim_season(GroupC, euros)","3f1fa119":"# Current Standings of Group\nget_standings(GroupD, euros)","b3bea65f":"# Odds of each team qualifying under simulation\nlong_sim_season(GroupD, euros)","91dea778":"# Current Standings of Group\nget_standings(GroupE, euros)","2d33ed1a":"# Odds of each team qualifying under simulation\nlong_sim_season(GroupE, euros)","14579020":"# Current Standings of Group\nget_standings(GroupF, euros)","23480f4b":"# Odds of each team qualifying under simulation\nlong_sim_season(GroupF, euros)","e126417b":"# Current Standings of Group\nget_standings(GroupG, euros)","d79798ee":"# Odds of each team qualifying under simulation\nlong_sim_season(GroupG, euros)","d98641e7":"# Current Standings of Group\nget_standings(GroupH, euros)","9132d3b1":"# Odds of each team qualifying under simulation\nlong_sim_season(GroupH, euros)","53f854c7":"# Current Standings of Group\nget_standings(GroupI, euros)","565204bb":"# Odds of each team qualifying under simulation\nlong_sim_season(GroupI, euros)","101d615e":"# Current Standings of Group\nget_standings(GroupJ, euros)","c0794182":"# Odds of each team qualifying under simulation\nlong_sim_season(GroupJ, euros)","bfb08ac2":"# Group H","cb017165":"# Group B","867a7cc8":"# Group E","98a7aef3":"# Group C","286cf41f":"# Group J","3d7a52bf":"# Group F","e46b7d39":"# Group A","913f80d0":"# Group I","a199d90d":"# Group D","b3caa8ae":"# Group G"}}