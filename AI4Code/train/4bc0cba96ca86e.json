{"cell_type":{"a760f5df":"code","f07b6870":"code","bbd52976":"code","3b07b7bf":"code","500ae310":"code","43ef4f3b":"code","52554b28":"code","445e180b":"code","7c6b820f":"code","b957d2f4":"code","fc441692":"code","0d7495b7":"code","cd763ec2":"code","bf6d8bc5":"code","65d2596f":"code","2c9d5776":"code","56d17998":"code","174fd620":"code","cdd5bf4a":"code","05780bff":"code","e32ce917":"code","0078354e":"code","9d88c4b3":"code","e364c136":"code","00f49827":"code","fecf1bd3":"code","685bf8bd":"code","ebabe252":"code","555db196":"code","5fc1a23b":"code","ca6971ea":"code","78af3117":"code","eef6e0d4":"code","0604fe07":"code","c6957b72":"code","d79a68cd":"code","0fe48d2a":"code","06edf9c2":"code","9d4656dc":"code","2ab868c9":"code","04b44256":"code","8160fc89":"code","aa81c76d":"code","4d1ab360":"code","f1425388":"code","1a8bebf0":"code","f8c0093b":"code","d7d5e6a6":"markdown","413525df":"markdown","e00c3dd1":"markdown","2b9dc8a0":"markdown","c6701825":"markdown","eef1f7d4":"markdown","d3ac7705":"markdown","b7a178df":"markdown","09466803":"markdown","8d5f2f10":"markdown","1f24003c":"markdown","e07513d2":"markdown","786c8ca1":"markdown","0d1d0ed1":"markdown","8689a907":"markdown","96a17b5b":"markdown","b867e60b":"markdown","2e1f28c0":"markdown","0c1a802d":"markdown","f1ac1744":"markdown","2c974531":"markdown"},"source":{"a760f5df":"# Uncomment and run the commands below if imports fail\n# !conda install numpy pytorch torchvision cpuonly -c pytorch -y\n# !pip install matplotlib --upgrade --quiet\n!pip install jovian --upgrade --quiet","f07b6870":"import torch\nimport jovian\nimport torchvision\nimport torch.nn as nn\nimport pandas as pd\nimport matplotlib.pyplot as plt\nimport torch.nn.functional as F\nfrom torchvision.datasets.utils import download_url\nfrom torch.utils.data import DataLoader, TensorDataset, random_split","bbd52976":"project_name='02-insurance-linear-regression'","3b07b7bf":"DATASET_URL = \"https:\/\/hub.jovian.ml\/wp-content\/uploads\/2020\/05\/insurance.csv\"\nDATA_FILENAME = \"insurance.csv\"\ndownload_url(DATASET_URL, '.')","500ae310":"dataframe_raw = pd.read_csv(DATA_FILENAME)\ndataframe_raw.head()","43ef4f3b":"your_name = \"swapnil\"","52554b28":"def customize_dataset(dataframe_raw, rand_str):\n    dataframe = dataframe_raw.copy(deep=True)\n    # drop some rows\n    dataframe = dataframe.sample(int(0.95*len(dataframe)), random_state=int(ord(rand_str[0])))\n    # scale input\n    dataframe.bmi = dataframe.bmi * ord(rand_str[1])\/100.\n    # scale target\n    dataframe.charges = dataframe.charges * ord(rand_str[2])\/100.\n    # drop column\n    if ord(rand_str[3]) % 2 == 1:\n        dataframe = dataframe.drop(['region'], axis=1)\n    return dataframe","445e180b":"dataframe = customize_dataset(dataframe_raw, your_name)\ndataframe.head()","7c6b820f":"dataframe.shape","b957d2f4":"num_rows = dataframe.shape[0]\nprint(num_rows)","fc441692":"num_cols = dataframe.shape[1]\nprint(num_cols)","0d7495b7":"input_cols = dataframe.columns[dataframe.columns != \"charges\"]\n\ninput_cols","cd763ec2":"categorical_cols = [col for col in dataframe.select_dtypes(exclude=[\"number\"]).columns.values]\n\ncategorical_cols","bf6d8bc5":"output_cols = [dataframe.columns[-1]]\noutput_cols","65d2596f":"dataframe[\"charges\"].describe()","2c9d5776":"jovian.commit(project=project_name, environment=None)","56d17998":"def dataframe_to_arrays(dataframe):\n    # Make a copy of the original dataframe\n    dataframe1 = dataframe.copy(deep=True)\n    # Convert non-numeric categorical columns to numbers\n    for col in categorical_cols:\n        dataframe1[col] = dataframe1[col].astype('category').cat.codes\n    # Extract input & outupts as numpy arrays\n    inputs_array = dataframe1[input_cols].to_numpy()\n    targets_array = dataframe1[output_cols].to_numpy()\n    return inputs_array, targets_array","174fd620":"inputs_array, targets_array = dataframe_to_arrays(dataframe)\ninputs_array, targets_array","cdd5bf4a":"dtype = torch.float32\n\ninputs = torch.from_numpy(inputs_array).type(dtype)\n\ntargets = torch.from_numpy(targets_array).type(dtype)","05780bff":"inputs.dtype, targets.dtype","e32ce917":"dataset = TensorDataset(inputs, targets)","0078354e":"from torch.utils import data\nval_percent = 0.12 # between 0.1 and 0.2\nval_size = int(num_rows * val_percent)\ntrain_size = num_rows - val_size\n\n\ntrain_ds, val_ds = random_split(dataset, [train_size, val_size])","9d88c4b3":"batch_size = 128","e364c136":"train_loader = DataLoader(train_ds, batch_size, shuffle=True)\nval_loader = DataLoader(val_ds, batch_size)","00f49827":"for xb, yb in train_loader:\n    print(\"inputs:\", xb)\n    print(\"targets:\", yb)\n    break","fecf1bd3":"jovian.commit(project=project_name, environment=None)","685bf8bd":"input_size = len(input_cols)\noutput_size = len(output_cols)","ebabe252":"class InsuranceModel(nn.Module):\n    def __init__(self):\n        super().__init__()\n        self.linear = nn.Linear(input_size, output_size)                  \n        \n    def forward(self, xb):\n        out = self.linear(xb)                      \n        return out\n    \n    def training_step(self, batch):\n        inputs, targets = batch \n        # Generate predictions\n        out = self(inputs)          \n        # Calcuate loss\n        loss = F.l1_loss(out,targets)                          \n        return loss\n    \n    def validation_step(self, batch):\n        inputs, targets = batch\n        # Generate predictions\n        out = self(inputs)\n        # Calculate loss\n        loss = F.l1_loss(out, targets)                 \n        return {'val_loss': loss.detach()}\n        \n    def validation_epoch_end(self, outputs):\n        batch_losses = [x['val_loss'] for x in outputs]\n        epoch_loss = torch.stack(batch_losses).mean()   # Combine losses\n        return {'val_loss': epoch_loss.item()}\n    \n    def epoch_end(self, epoch, result, num_epochs):\n        # Print result every 20th epoch\n        if (epoch+1) % 20 == 0 or epoch == num_epochs-1:\n            print(\"Epoch [{}], val_loss: {:.4f}\".format(epoch+1, result['val_loss']))","555db196":"model = InsuranceModel()","5fc1a23b":"list(model.parameters())","ca6971ea":"jovian.commit(project=project_name, environment=None)","78af3117":"def evaluate(model, val_loader):\n    outputs = [model.validation_step(batch) for batch in val_loader]\n    return model.validation_epoch_end(outputs)\n\ndef fit(epochs, lr, model, train_loader, val_loader, opt_func=torch.optim.SGD):\n    history = []\n    optimizer = opt_func(model.parameters(), lr)\n    for epoch in range(epochs):\n        # Training Phase \n        for batch in train_loader:\n            loss = model.training_step(batch)\n            loss.backward()\n            optimizer.step()\n            optimizer.zero_grad()\n        # Validation phase\n        result = evaluate(model, val_loader)\n        model.epoch_end(epoch, result, epochs)\n        history.append(result)\n    return history","eef6e0d4":"result = evaluate (model,val_loader)\nprint(result)","0604fe07":"epochs = 300\nlr = 1e-2\nhistory1 = fit(epochs, lr, model, train_loader, val_loader)","c6957b72":"epochs = 300\nlr = 1e-3\nhistory2 = fit(epochs, lr, model, train_loader, val_loader)","d79a68cd":"epochs = 300\nlr = 1e-4\nhistory3 = fit(epochs, lr, model, train_loader, val_loader)","0fe48d2a":"epochs = 300\nlr = 1e-5\nhistory4 = fit(epochs, lr, model, train_loader, val_loader)","06edf9c2":"epochs = 300\nlr = 1e-6\nhistory5 = fit(epochs, lr, model, train_loader, val_loader)","9d4656dc":"hist = history1 + history2 + history3 + history4 + history5\nloss = []\nfor value in hist:\n    loss.append(value['val_loss'])\n    \nplt.plot(loss)","2ab868c9":"val_loss = loss[-1]\nval_loss","04b44256":"jovian.log_metrics(val_loss=val_loss)","8160fc89":"jovian.commit(project=project_name, environment=None)","aa81c76d":"def predict_single(input, target, model):\n    inputs = input.unsqueeze(0)\n    predictions = model(inputs)              \n    prediction = predictions[0].detach()\n    print(\"Input:\", input)\n    print(\"Target:\", target)\n    print(\"Prediction:\", prediction)","4d1ab360":"input, target = val_ds[0]\npredict_single(input, target, model)","f1425388":"input, target = val_ds[13]\npredict_single(input, target, model)","1a8bebf0":"input, target = val_ds[30]\npredict_single(input, target, model)","f8c0093b":"jovian.commit(project=project_name, environment=None)\njovian.commit(project=project_name, environment=None) # try again, kaggle fails sometimes","d7d5e6a6":"\nWe are now ready to train the model. You may need to run the training loop many times, for different number of epochs and with different learning rates, to get a good result. Also, if your loss becomes too large (or `nan`), you may have to re-initialize the model by running the cell `model = InsuranceModel()`. Experiment with this for a while, and try to get to as low a loss as possible.","413525df":"Now scroll back up, re-initialize the model, and try different set of values for batch size, number of epochs, learning rate etc. Commit each experiment and use the \"Compare\" and \"View Diff\" options on Jovian to compare the different results.","e00c3dd1":"**Q: Use the `evaluate` function to calculate the loss on the validation set before training.**","2b9dc8a0":"## Step 4: Train the model to fit the data\n\nTo train our model, we'll use the same `fit` function explained in the lecture. That's the benefit of defining a generic training loop - you can use it for any problem.","c6701825":"## Step 3: Create a Linear Regression Model\n\nOur model itself is a fairly straightforward linear regression (we'll build more complex models in the next assignment). \n","eef1f7d4":"## Step 1: Download and explore the data\n\nLet us begin by downloading the data. We'll use the `download_url` function from PyTorch to get the data as a CSV (comma-separated values) file. ","d3ac7705":"## (Optional) Step 6: Try another dataset & blog about it\n\nWhile this last step is optional for the submission of your assignment, we highly recommend that you do it. Try to clean up & replicate this notebook (or [this one](https:\/\/jovian.ml\/aakashns\/housing-linear-minimal), or [this one](https:\/\/jovian.ml\/aakashns\/mnist-logistic-minimal) ) for a different linear regression or logistic regression problem. This will help solidify your understanding, and give you a chance to differentiate the generic patters in machine learning from problem-specific details.\n\nHere are some sources to find good datasets:\n\n- https:\/\/lionbridge.ai\/datasets\/10-open-datasets-for-linear-regression\/\n- https:\/\/www.kaggle.com\/rtatman\/datasets-for-regression-analysis\n- https:\/\/archive.ics.uci.edu\/ml\/datasets.php?format=&task=reg&att=&area=&numAtt=&numIns=&type=&sort=nameUp&view=table\n- https:\/\/people.sc.fsu.edu\/~jburkardt\/datasets\/regression\/regression.html\n- https:\/\/archive.ics.uci.edu\/ml\/datasets\/wine+quality\n- https:\/\/pytorch.org\/docs\/stable\/torchvision\/datasets.html\n\nWe also recommend that you write a blog about your approach to the problem. Here is a suggested structure for your post (feel free to experiment with it):\n\n- Interesting title & subtitle\n- Overview of what the blog covers (which dataset, linear regression or logistic regression, intro to PyTorch)\n- Downloading & exploring the data\n- Preparing the data for training\n- Creating a model using PyTorch\n- Training the model to fit the data\n- Your thoughts on how to experiment with different hyperparmeters to reduce loss\n- Making predictions using the model\n\nAs with the previous assignment, you can [embed Juptyer notebook cells & outputs from Jovian](https:\/\/medium.com\/jovianml\/share-and-embed-jupyter-notebooks-online-with-jovian-ml-df709a03064e) into your blog. \n\nDon't forget to share your work on the forum: https:\/\/jovian.ml\/forum\/t\/share-your-work-here-assignment-2\/4931","b7a178df":"Let's check out the weights and biases of the model using `model.parameters`.","09466803":"Let us create a model using the `InsuranceModel` class. You may need to come back later and re-run the next cell to reinitialize the model, in case the loss becomes `nan` or `infinity`.","8d5f2f10":"**Q: Complete the class definition below by filling out the constructor (`__init__`), `forward`, `training_step` and `validation_step` methods.**\n\nHint: Think carefully about picking a good loss fuction (it's not cross entropy). Maybe try 2-3 of them and see which one works best. See https:\/\/pytorch.org\/docs\/stable\/nn.functional.html#loss-functions","1f24003c":"One final commit before we train the model.","e07513d2":"**Q: What is the final validation loss of your model?**","786c8ca1":"**Q: Train the model 4-5 times with different learning rates & for different number of epochs.**\n\nHint: Vary learning rates by orders of 10 (e.g. `1e-2`, `1e-3`, `1e-4`, `1e-5`, `1e-6`) to figure out what works.","0d1d0ed1":"## Step 5: Make predictions using the trained model\n\n**Q: Complete the following function definition to make predictions on a single input**","8689a907":"# Insurance cost prediction using linear regression\n\nIn this assignment we're going to use information like a person's age, sex, BMI, no. of children and smoking habit to predict the price of yearly medical bills. This kind of model is useful for insurance companies to determine the yearly insurance premium for a person. The dataset for this problem is taken from: https:\/\/www.kaggle.com\/mirichoi0218\/insurance\n\n\nWe will create a model with the following steps:\n1. Download and explore the dataset\n2. Prepare the dataset for training\n3. Create a linear regression model\n4. Train the model to fit the data\n5. Make predictions using the trained model\n\n\nThis assignment builds upon the concepts from the first 2 lectures. It will help to review these Jupyter notebooks:\n- PyTorch basics: https:\/\/jovian.ml\/aakashns\/01-pytorch-basics\n- Linear Regression: https:\/\/jovian.ml\/aakashns\/02-linear-regression\n- Logistic Regression: https:\/\/jovian.ml\/aakashns\/03-logistic-regression\n- Linear regression (minimal): https:\/\/jovian.ml\/aakashns\/housing-linear-minimal\n- Logistic regression (minimal): https:\/\/jovian.ml\/aakashns\/mnist-logistic-minimal\n\n","96a17b5b":"Let's log the final validation loss to Jovian and commit the notebook","b867e60b":"Are you happy with your model's predictions? Try to improve them further.","2e1f28c0":"## Step 2: Prepare the dataset for training\n\nWe need to convert the data from the Pandas dataframe into a PyTorch tensors for training. To do this, the first step is to convert it numpy arrays. If you've filled out `input_cols`, `categorial_cols` and `output_cols` correctly, this following function will perform the conversion to numpy arrays.","0c1a802d":"To load the dataset into memory, we'll use the `read_csv` function from the `pandas` library. The data will be loaded as a Pandas dataframe. See this short tutorial to learn more: https:\/\/data36.com\/pandas-tutorial-1-basics-reading-data-files-dataframes-data-selection\/","f1ac1744":"We're going to do a slight customization of the data, so that you every participant receives a slightly different version of the dataset. Fill in your name below as a string (enter at least 5 characters)","2c974531":"The `customize_dataset` function will customize the dataset slightly using your name as a source of random numbers."}}