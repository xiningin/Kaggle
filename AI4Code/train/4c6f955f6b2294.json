{"cell_type":{"c8e56d92":"code","3e2c32ca":"code","e18cae83":"code","7f25b439":"code","7a5415b7":"code","f0d7af09":"code","52c49871":"code","abab66b8":"code","cdf53e7f":"code","ce8f1a81":"code","507810e9":"code","7ea9c91b":"code","e3f69381":"code","5f763a11":"code","5b557009":"code","3399b3cd":"code","efccc5d2":"code","457e03ea":"code","26e99457":"code","6be8c86d":"markdown","53886f3c":"markdown","3a7cde57":"markdown","d07681c6":"markdown","c72bf4fc":"markdown","1a08f568":"markdown","8d6ed337":"markdown","7d6d74ba":"markdown","a5754e97":"markdown","fec2774a":"markdown","78a43333":"markdown","70e70ae6":"markdown","dcad8e37":"markdown","443f1d3f":"markdown","848ac60a":"markdown","21ac9f4e":"markdown","12b41544":"markdown","7730a99f":"markdown","5d386991":"markdown","c69703e1":"markdown","60270fcd":"markdown","3ca33481":"markdown","05ea1abf":"markdown","283b4374":"markdown"},"source":{"c8e56d92":"from IPython.display import Image\nImage(\"..\/input\/covidpic\/covid2.jpg\",width=800)","3e2c32ca":"%matplotlib inline \nimport pandas as pd\nimport numpy as np\nimport matplotlib.pyplot as plt\nfrom matplotlib import cm\nimport os","e18cae83":"brazil_df = pd.read_csv(\"\/kaggle\/input\/covid19-global-and-regional\/brazil_province_wise.csv\", parse_dates=['Date'])\ncanadian_provinces_df = pd.read_csv(\"\/kaggle\/input\/covid19-global-and-regional\/canada_province_wise.csv\", parse_dates=['Date'])\nchina_df = pd.read_csv(\"\/kaggle\/input\/covid19-global-and-regional\/china_province_wise.csv\", parse_dates=['Date'])\nitaly_df = pd.read_csv(\"\/kaggle\/input\/covid19-global-and-regional\/italy_province_wise.csv\", parse_dates=['Date'])\nglobal_df = pd.read_csv(\"\/kaggle\/input\/covid19-global-and-regional\/covid_19_clean_complete.csv\", parse_dates=['Date'])\n\nbrazil_df.set_index(brazil_df['Date'],drop=True,inplace=True)\ncanadian_provinces_df.set_index(canadian_provinces_df['Date'],drop=True,inplace=True)\nchina_df.set_index(china_df['Date'],drop=True,inplace=True)\nitaly_df.set_index(italy_df['Date'],drop=True,inplace=True)\n\nbrazil_df.drop(['Date'],axis=1, inplace=True)\ncanadian_provinces_df.drop(['Date'],axis=1, inplace=True)\nchina_df.drop(['Date'],axis=1, inplace=True)\nitaly_df.drop(['Date'],axis=1, inplace=True)\n\ncanada_df = canadian_provinces_df.groupby(['Date']).sum()","7f25b439":"global_df.info()","7a5415b7":"canadian_provinces_df.tail()","f0d7af09":"plt.rcParams.update({'font.size': 15})\nwith plt.style.context('seaborn-white'):\n    fig, ax = plt.subplots(2,2, figsize=(16,11))\n    \nbrazil_df[['Confirmed','Deaths','Recovered']].plot(ax=ax[1,0],linestyle='--', linewidth=2.5)\ncanada_df[['Confirmed','Deaths']].plot(ax=ax[0,0], sharex=ax[0,0],linestyle='--', linewidth=2.5)\nchina_df.groupby(['Date']).sum()[['Confirmed','Deaths','Recovered']].plot(ax=ax[0,1],linestyle='--', linewidth=2.5)\nitaly_df[['Confirmed','Deaths','Recovered']].plot(ax=ax[1,1], sharex=ax[0,1],linestyle='--', linewidth=2.5)\n\nax[0,0].set_title('Canada')\nax[1,0].set_title('Brazil')\nax[0,1].set_title('China')\nax[1,1].set_title('Italy')\n\ndef make_yticklabel(tick_value, pos): \n    return \"{}K\".format(tick_value \/ 1000)\n\nfrom matplotlib.ticker import FuncFormatter \nax[0,0].yaxis.set_major_formatter(FuncFormatter(make_yticklabel))\nax[1,0].yaxis.set_major_formatter(FuncFormatter(make_yticklabel))\nax[0,1].yaxis.set_major_formatter(FuncFormatter(make_yticklabel))\nax[1,1].yaxis.set_major_formatter(FuncFormatter(make_yticklabel))\n\nplt.tight_layout()","52c49871":"plt.rcParams.update({'font.size': 22})\ndf0 = global_df[global_df['Date']=='2020-04-24'].groupby(['Country\/Region'])['Confirmed'].sum().sort_values(ascending=False)[1:15]\ndf0 = df0.sort_values(ascending=True)\ndf1 = global_df[global_df['Date']=='2020-04-24'].groupby(['Country\/Region'])['Confirmed'].sum().sort_values(ascending=False)[0:15]\ndf1 = df1.sort_values(ascending=True)\nwith plt.style.context('seaborn-darkgrid'):\n    fig, ax = plt.subplots(1,2)\n    df0.plot.barh(ax=ax[0],title=\"COVID-19 Confirmed Cases - US excluded\",figsize=(38,20),color=['black','orange','red','black','green','navy', 'red', 'green', 'red', 'navy','black','blue','green','goldenrod'])\n    df1.plot.barh(ax=ax[1],title=\"COVID-19 Confirmed Cases including US\",figsize=(38,20),color=['black','orange','red','black','green','navy', 'red', 'green', 'red', 'navy','black','blue','green','goldenrod','blue'])\n    ax[0].set_ylabel(None)\n    ax[1].set_ylabel(None)","abab66b8":"df = global_df[global_df['Date']=='2020-04-24'].groupby(['Country\/Region'])[['Recovered','Deaths']].sum().sort_values(by='Deaths',ascending=False)[0:11]\ndf = df.sort_values(by='Deaths',ascending=True)\ndf.drop(['Netherlands'], axis=0,inplace=True)\nwith plt.style.context('seaborn-poster'):\n    df.plot.barh(title=\"COVID-19 Deaths and Recoveries\",figsize=(14,6))","cdf53e7f":"df = global_df[global_df['Date']=='2020-04-24'].groupby(['Country\/Region'])[['Confirmed','Recovered','Deaths']].sum()\ndf['Deaths\/Confirmed'] = df['Deaths']\/df['Confirmed']\ndf = df.sort_values(by='Deaths\/Confirmed',ascending=False)[0:45]\ndf = df.sort_values(by='Deaths\/Confirmed',ascending=True)\nwith plt.style.context('seaborn-poster'):\n    df['Deaths\/Confirmed'].plot.barh(title=\"COVID-19 - Deaths\/Confirmed \",figsize=(20,20))\nplt.xticks(rotation=30,ha='right')\nplt.show()","ce8f1a81":"ax = canadian_provinces_df.loc['2020-04-24'][['Province\/State','Confirmed']].sort_values(by='Confirmed',ascending=False)[0:9]\nwith plt.style.context('seaborn-poster'):\n    ax.plot.bar(x='Province\/State',title=\"COVID-19 Confirmed Cases in Canada\",figsize=(15,6),color='navy')\nplt.xticks(rotation=30,ha='right')\nplt.show()","507810e9":"Image(\"..\/input\/covid19sir\/sir.png\",width=800)","7ea9c91b":"from scipy.integrate import odeint\nfrom scipy.optimize import curve_fit\nfrom sklearn.model_selection import train_test_split\nfrom sklearn.metrics import mean_squared_error","e3f69381":"# population\nN_ontario = 14446515 ","5f763a11":"# ontario recoveries table\non_recov_df = pd.read_csv('\/kaggle\/input\/ontario-recovered\/ontario_recovered.csv', parse_dates=['date_recovered'])\non_recov_df = on_recov_df[on_recov_df['province']=='Ontario']\non_recov_df.drop(['province'],axis=1,inplace=True)\non_recov_df.sort_values(by='date_recovered',inplace=True)\non_recov_df.rename(columns={'date_recovered': 'Date'},inplace=True)\non_recov_df.reset_index(drop=True,inplace=True)\n\n# joining the ontario recoveries table to the general canadian provinces table\nontario_df = canadian_provinces_df[canadian_provinces_df['Province\/State']=='Ontario'].iloc[0:,:]\nontario_df = ontario_df.merge(on_recov_df,how='inner',on='Date') \nontario_df.drop(['Recovered'],axis=1,inplace=True)\nontario_df.rename(columns={\"cumulative_recovered\": \"Recovered\"},inplace=True)\n\n# treating missing values on the resulting dataframe, and including day count data\nontario_df.fillna(0,inplace=True)\nontario_df['day_count'] = list(range(1,len(ontario_df)+1))","5b557009":"# defining the variables for the SIR model\nontario_df['Rec_immune'] = ontario_df['Deaths'] + ontario_df['Recovered']\nontario_df['Infected'] = ontario_df['Confirmed'] - ontario_df['Rec_immune']\nontario_df['Susceptible'] = N_ontario - ontario_df['Rec_immune'] - ontario_df['Infected']\n\n# we need arrays for odeint\nsus = np.array(ontario_df['Susceptible'],dtype=float)\ninfec = np.array(ontario_df['Infected'],dtype=float)\nrec = np.array(ontario_df['Rec_immune'],dtype=float)\n\n# splitting the data for validation purposes\nx_train, x_test, y_train, y_test = train_test_split(ontario_df['day_count'],\\\n    ontario_df[['Susceptible','Infected','Rec_immune']],test_size=0.25,shuffle=False)\nxtrain = np.array(x_train.iloc[0:],dtype=float)\nytrain = np.array(y_train.iloc[0:],dtype=float)\nxtest = np.array(x_test.iloc[0:],dtype=float)\nytest = np.array(y_test.iloc[0:],dtype=float)\n\n# forecasting data\ntdata = np.array(ontario_df.day_count,dtype=float)\nxcast = np.linspace(0,120,121)\nycast = np.array(ontario_df[['Susceptible','Infected','Rec_immune']],dtype=float)","3399b3cd":"# create model\ndef sir_model(z,t,beta,gamma):  \n    dSdt = -(beta*z[1]*z[0])\/N_ontario\n    dIdt = (beta*z[1]*z[0])\/N_ontario - gamma*z[1]\n    dRdt = gamma*z[1]\n    dzdt = [dSdt, dIdt, dRdt]\n    return dzdt","efccc5d2":"# fit model to train set\nz0 = [ytrain[0,0],ytrain[0,1],ytrain[0,2]]\n\ndef fit_odeint(t,beta,gamma):\n    return odeint(sir_model,z0,t,args=(beta,gamma,))[:,1]\n\npopt, pcov = curve_fit(fit_odeint,xtrain,ytrain[:,1],p0=[1,1])\nfitted = fit_odeint(xtrain, *popt)\n\nprint(\"Optimal parameters: beta =\", popt[0], \" and gamma = \", popt[1])","457e03ea":"# predict\nxcast = np.linspace(0,120,121)\npredicted = odeint(sir_model,ytrain[0,:],xcast,args=(popt[0],popt[1],))[:,1] \n\npoptcast, pcovcast = curve_fit(fit_odeint,tdata,ycast[:,1],p0=[1,1])\nforecast = fit_odeint(xcast,*poptcast)","26e99457":"# visualization\nwith plt.style.context('seaborn-white'):\n    fig, ax = plt.subplots(1,1, figsize=(16,11))\nplt.plot(xtrain, ytrain[:,1], 'o',label=\"Feb-12 to Apr-07\",color='lightcoral')\nplt.plot(xtest, ytest[:,1], 'o',label=\"Apr-07 to Apr-28\",color='cornflowerblue')\nplt.plot(xcast, predicted,label=\"Original curve\",color='lightcoral')\nplt.plot(xcast, forecast,label=\"Flattened curve\",color='cornflowerblue')\nplt.axvline(x=xtest[-1], ls='--',color='gray')\nplt.legend(bbox_to_anchor=(0.7, 1), loc='upper left', borderaxespad=0.)\nplt.title(\"Fit of SIR model: COVID-19 infections in Ontario\")\nplt.ylabel(\"Population infected\")\nplt.xlabel(\"Days\")\nplt.show()","6be8c86d":"Unfortunately, the original dataset doesn't contain information about the number of recoveries in Canada, and we need it for the SIR model. So, an additional table had to be imported and properly processed (see the steps taken on the cell right above). \n\nNow, we're ready to build the model. First, we define the R(t), I(t), and S(t) variables according to the SIR model theory. It's a good idea to also split the data into two sets for validation purposes, and we can use the train_test_split function for that. The dependent variable t can be taken as the number of days passed since the first recording, and we're gonna store that data into the day_count column. We have about 75 days of recordings to base our model, and we will take 120 days to be the forecasting interval.","53886f3c":"We're ready to make some plots. First, we can compare the number of confirmed cases, deaths, and recoveries throughout the observed months for each of the 4 selected countries:","3a7cde57":"Understandably, the two provinces with the highest number of inhabitants have recorded the highest number of cases: Quebec and Ontario. Observe that the provinces in the Atlantic region and the northern territories have very few recorded cases. \n\nA plausible explanation for this is the fact that people live much farther apart in these places, since natural obstacles are present among cities in the Atlantic, and a low density of populous towns exist within the vast amount of land in the territories. So, social distancing can be more easily practiced.","d07681c6":"Prediction is conducted by taking the optimal parameters obtained from the fit, and passing them as arguments to *odeint*. The forecast is done in a similar fashion, only by taking the longer interval xcast to be the interval of prediction:","c72bf4fc":"$\\dfrac{dS}{dt} = - \\beta \\frac{I}{N} S$\n\n$\\dfrac{dI}{dt} = \\beta \\frac{I}{N} S - \\gamma I$\n\n$\\dfrac{dR}{dt} =  \\gamma I S$","1a08f568":"**We can also draw some conclusions from plotting the number of confirmed COVID-19 cases for the 15 countries with the highest amount of confirmations in the dataset:**","8d6ed337":"<a id=\"section-three\"><\/a>\n# Forecasting: Ontario\n\nNow, let's jump to analysing the regional data at a deeper level, taking Ontario as the main region to be analyzed. To do that, we can use the SIR model of infections. \n\nAccording to the definition used by [WolframMathWorld](https:\/\/mathworld.wolfram.com\/SIRModel.html), \"A SIR model is an epidemiological model that computes the theoretical number of people infected with a contagious illness in a closed population over time. The name of this class of models derives from the fact that they involve coupled equations relating the number of susceptible people S(t), number of people infected I(t), and number of people who have recovered  R(t).\"","7d6d74ba":"Now, we're ready to plot. Let's make sure to include a vertical dashed line at the beginning of the forecasting prediction interval. The days are counted as of Feb-12.\n\nThe test data here is being used to verify the evolution of the infection rate: if Ontario had followed the same path as it was following on the first 50 days of the pandemic, the province would see a curve similar to the pink one:","a5754e97":"<h1>Exploratory Data Analysis & Forecasting on Covid-19 global and regional data<\/h1> \n    \n* [Introduction](#section-one)\n* [EDA: Global](#section-two)\n* [Forecasting: Ontario](#section-three)","fec2774a":"The model can be created using the couple differential equations, as follows:","78a43333":"Let's take a closer look at Ontario, Canada, and see what can be concluded when the SIR model is applied to data from this region. We need to do some cleaning and pre-processing first:","70e70ae6":"The 3 coupled differential equations of the SIR model can be expressed as:","dcad8e37":"**Note that some countries, such as Canada, have data split among provinces. So, if we need to analyze the country as a whole, it's important to group the provincial data, taking the sum of values within each province. That can be easily done with Pandas.**\n\nNow, we can take a look at the loaded dataframes, and inspect their structure:","443f1d3f":"The plot above isn't very helpful for drawing conclusions, as there isn't a very noticeable pattern from the regions displayed. However, some interesting points can be observed. For instance, Nicaragua has been recording more than a quarter of deaths for the contaminations in its territory. Moreover, the number of deaths\/cases in Belgium endorses the previous hypothesis about the country recording many deaths for not so many confirmed cases.\n\n**Caution must be taken here, however, when assuming that the number of confirmed cases is correct for every country. Some countries haven't been able to properly test people for contamination, so that number could, in fact, be much larger.**\n\nWe can take advantage of the Province\/State data for the countries that have those records in the dataset. Below is a graph of confirmed cases in Canada for the 9 provinces with the highest number of cases:","848ac60a":"<a id=\"section-two\"><\/a>\n# EDA: Global\nLet's start by importing the relevant libraries and loading the pre-processed data into global and country specific dataframes.","21ac9f4e":"We'll save separate dataframes for 4 selected countries to take a closer look at: Brazil, Canada, China, Italy. The approach of these countries in dealing with the pandemic has been fairly disparate, so there is a lot of room for comparisons.","12b41544":"We'll fit the model to the train dataset using the *fit_odeint* function, and passing the beta and gamma parameters to be fit:","7730a99f":"Where N is the population of the system (i.e. region) considered, and $\\beta, \\gamma$ are free parameters to be determined. One way to implement the SIR model in Python is by using the *odeint* package from scipy, which is a ODE solving suite. Let's first import the required packages and move on to building the model:","5d386991":"However, recent records (as of Apr-6) show that Ontario has in fact been seeing a curve similar to the blue one, which has a lower peak than the pink one. Ontario has been flattening the curve!\n\nAccording to the forecasting predictions, infection rates should continue to decrease and reach a lower point near the middle-end of June. -- that is if we continue to follow the same behavior that we've been following since Apr-06, which is roughly when social distancing measures started to be implemented in Ontario.\n\nSo, the conclusion here is that social distancing and self-isolation measures are probably contributing to the decrease in the number infected people, and therefore, those measures should continue until at least mid-June in order to prevent a bigger portion of the province from getting infected.\n\nThe good news is we're on the right track for keeping the number of infections low and preventing a higher number of fatalities. Stay safe, Ontario. We are gonna make it through! ","c69703e1":"The plot above shows that the US is easily the most contaminated region in the world. It is worth noticing, however, that the US population (328.2 million) is much larger than the population of Spain (46.94 million), which accounts for the second most contaminated region in the world. China, on the other hand, occupies the 9th position.\n\n**Below is a bar graph of recoveries and deaths for the countries with the highest number of deaths. By comparing this chart with that of confirmed cases above, a few interesting things can be noticed:**\n<li> A large number of confirmed cases do not necessarily imply a large number of deaths. Belgium, for instance, occupies the 12th position in the number of confirmed cases, but it bumps to the 6th position when it comes to the number of deaths.\n<li> By comparing the number of recoveries with the number of deaths in each country, we can observe where the Covid combat measures have been the most effective. Germany, for instance, has shown a large number of recoveries. While Germany has a larger number of contaminations than other countries, it records fewer deaths.","60270fcd":"<a id=\"section-one\"><\/a>\n# Introduction\nIn this notebook, I am going to explore the Covid-19 dataset, with the goal of drawing insights and building some hypotheses to be tested to help answer some of the most pondered questions in the last few months: \n\n1. What makes a certain region more vulnerable to Covid infections? \n2. What measures need to be taken in order for the infection rate to decrease?","3ca33481":"The sklearn functions will be useful for testing the accuracy of the model fit. We need to include information about the population size of Ontario","05ea1abf":"From the curves above, it is obvious that Italy has recorded the highest amount of confirmed cases and deaths among the 4 regions. Brazil, on the other hand, displays the sharpest slope for the curve of confirmed cases. So, Brazil may outnumber Italy within a couple of months.\n\nDifferently from the 3 other countries, China has been displaying a plateau of confirmed cases since March. This could be because the pandemic started much earlier there, and the number of cases is coming to a peak.\n\nEven though our dataset doesn't have the number of recoveries in Canada, we can infer that the recovery curve is probably not much below the confirmed curve, since Canada displays s small number of deaths.\n","283b4374":"**We could, instead, compare the number of deaths to the number of cases in a more direct way. By, for instance, taking the ratio of former by the latter:**"}}