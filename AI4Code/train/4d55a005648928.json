{"cell_type":{"d70d1fb4":"code","d5146add":"code","108c7576":"code","17b45696":"code","1fd09ace":"code","54978aa7":"code","1143f3e3":"code","94d2230e":"code","3de670f3":"code","d13c1fd8":"code","3eaf8c49":"code","1e157b32":"code","6eb871a0":"code","2ccfb051":"code","ae07498f":"code","11d9a26b":"code","4565f080":"code","b2692fe2":"code","25938e27":"code","3c16e19a":"code","55aace76":"code","2b5d1334":"code","9746278d":"code","d15e3718":"code","9c7baca5":"code","f2396e50":"code","a8d937ab":"code","11526b22":"code","d5c7c45f":"code","cf38f800":"code","3193e78d":"code","f065153a":"code","06a3f609":"code","7fffb58a":"code","d0a8fda0":"code","30bced3f":"code","c0592ad5":"code","bc36d1ab":"code","7c1fbc40":"code","7f9834a0":"markdown","429b0c41":"markdown","928e3c46":"markdown","b3570ca0":"markdown","31701836":"markdown","ba42c207":"markdown","1dc04d1d":"markdown","e1f6d596":"markdown","4cd12cd5":"markdown","35d0285b":"markdown","83026814":"markdown","4b237f67":"markdown","6e2c354d":"markdown","39d6c4d5":"markdown","14a30619":"markdown","14418c2a":"markdown","a4d1698b":"markdown"},"source":{"d70d1fb4":"import pandas as pd \nimport gc\n\ngc.collect()","d5146add":"df = pd.read_csv(\n    '\/kaggle\/input\/2019-trendmicro-ctf-wildcard-400\/gowiththeflow_20190826.csv',\n    header = 0, \n    names= ['ts', 'src', 'dst', 'port', 'bytes']\n)\ndf.info()","108c7576":"answers = []","17b45696":"df.head()","1fd09ace":"def internal(ip):\n    internals = ('12.','13.','14.')\n    return ip.startswith(internals,0)\n\nprint(internal('16.79.101.100'),internal('13.79.101.100'))","54978aa7":"df['internal_src'] = df.src.apply(internal)\ndf['internal_dst'] = df.dst.apply(internal)","1143f3e3":"df['ts'] = pd.to_datetime(df['ts'], unit='ms')\ndf['hour'] = df.ts.dt.hour.astype('uint8')\ndf['min'] = df.ts.dt.minute.astype('uint8')\n\ngc.collect()","94d2230e":"a = df[['src','bytes']].groupby(by=['src']).sum().sort_values(by=['bytes'],ascending=False)[['bytes']].index.to_list()[0]\na","3de670f3":"answers.append(a)\ngc.collect()","d13c1fd8":"df.hour.hist(bins=100)","3eaf8c49":"gc.collect()\na = df[(((df.internal_src == 1) & (df.internal_dst == 0)) & (df.hour <=15))][['src','bytes']].groupby(by=['src']).sum().sort_values(by=['bytes'],ascending=False)[['bytes']].index.to_list()[0]\na","1e157b32":"answers.append(a)\ngc.collect()","6eb871a0":"host_port = df[((df.internal_src == 1) & (df.internal_dst == 0))][['src','port','bytes']].groupby(by=['src','port']).sum().sort_values(by=['bytes']).reset_index()\nhost_port","2ccfb051":"import numpy as np\ndef normalization(sub_df):\n    return np.max(sub_df.bytes-sub_df.bytes.mean())\/sub_df.bytes.std()\n\ngc.collect()","ae07498f":"host_port.groupby(by=['port']).apply(normalization).sort_values(ascending=False).head(5)","11d9a26b":"host_port[host_port['port'] == 124].sort_values(by='bytes',ascending=False).head(1)","4565f080":"answers.append('124')\n\ndel host_port\ngc.collect()","b2692fe2":"df[(df.internal_src == 0)].groupby(by=['port']).size().sort_values().head()","25938e27":"answers.append('113')\ngc.collect()","3c16e19a":"internal_edges = df[(df.internal_src==1) & (df.internal_dst ==1)].drop_duplicates(['src', 'dst', 'port'])\ninternal_ports = internal_edges.port.unique()\ngc.collect()","55aace76":"internal_edges.head()","2b5d1334":"from collections import Counter\n\nupper_bounds = []\nfor i in range(len(internal_ports)):\n    edges = set()\n    internal_edges_port = internal_edges[internal_edges['port'] == internal_ports[i]].drop_duplicates(['src','dst'])\n    for s, d in zip(internal_edges_port.src, internal_edges_port.dst):\n        edges.add(min((s, d), (d, s)))\n    degrees = Counter()\n    for (s, d) in edges:\n        degrees[s] += 1\n        degrees[d] += 1\n    mqs = -1\n    min_d = len(degrees)\n    for idx, (node, degree) in enumerate(degrees.most_common()):\n        min_d = min(min_d, degree)\n        if min_d >= idx:\n            mqs = max(mqs, idx+1)\n        if min_d < mqs:\n            break\n    upper_bounds.append((internal_ports[i], mqs))","9746278d":"upper_bounds","d15e3718":"answers.append('83')\ndel internal_edges\ndel degrees\ndel internal_ports\ngc.collect()","9c7baca5":"single_dst = df[(df.internal_src==0) & (df.internal_dst==1)].drop_duplicates(['src','dst'])['src'].value_counts()\ngc.collect()\nsingle_dst","f2396e50":"single_dst = single_dst[single_dst == 1].index.to_list()\nsingle_dst","a8d937ab":"gc.collect()\ndf[(df.internal_src==0) & (df.internal_dst==1) & (df.src.isin(single_dst))].drop_duplicates(['src','dst']).groupby('dst').size()","11526b22":"answers.append('14.45.67.46')","d5c7c45f":"df[(df.internal_src==1) & (df.internal_dst==1) & (df.dst == '14.45.67.46')].drop_duplicates(['src','dst'])","cf38f800":"answers.append('14.51.84.50')","3193e78d":"df[(df.internal_dst == 0)].groupby(by=['port']).agg({'bytes':'mean','src':'size'}).sort_values(by=['src','bytes'],ascending=True).head()","f065153a":"answers.append('51')","06a3f609":"df[(df.internal_src == 1) & (df.internal_dst ==1)].drop_duplicates(['src','dst']).groupby(by=['src']).size().sort_values(ascending=False).head()","7fffb58a":"answers.append('13.42.70.40')\ngc.collect()","d0a8fda0":"ports_destino = df[(df.internal_src == 1) & (df.internal_dst ==1) & (df.src != '13.42.70.40')].drop_duplicates(('src','dst','port')).groupby(['dst','port']).src.apply(list).dropna()\nports_destino","30bced3f":"ips = []\nfor lista in ports_destino:\n    if len(lista) == 1:\n        ips.append(lista[0])\nCounter(ips)","c0592ad5":"answers.append('12.49.123.62')","bc36d1ab":"answers","7c1fbc40":"import hashlib\nanswer_hash = hashlib.md5(':'.join(answers).encode('utf-8')).hexdigest()\nassert answer_hash == 'ec766132cac80b821793fb9e7fdfd763'","7f9834a0":"# Data Analysis for Network Security","429b0c41":"### Question 6: Malware Controller\n\n*We were just blacklisted by an IP reputation service, because some host in our network is behaving badly.  One host is a bot herder receiving C&C callbacks from its botnet, which has little other reason to communicate with hosts in the enterprise.  What is its IP?*","928e3c46":"### Question 2: Discover Data Exfiltration 2\n\n*Another attacker has a job scheduled that export the contents of our internal wiki. One host is sending out much more data during off hours from the enterprise than the others, different from the host in the Question 1. What is its IP?* \n\n","b3570ca0":"### Question 1: Discover Data Exfiltration 1\n\n*Our intellectual property is leaving the building in large chunks. A machine inside is being used to send out all of our widget designs. One host is sending out much more data from the enterprise than the others. What is its IP?*","31701836":"### Question 8: Botnet Inside\n*There is a stealthier botnet in the network, using low frequency periodic callbacks to external C&C, with embedded higher frequency calls.  What port does it use?*","ba42c207":"## Introduction\n\n\u200bYou are a network security administrator for the medium sized business XYZcorp.  You often use network flow data to uncover anomalous security events.  This challenge provides some sample aggregated data on flows, and uses answers from the anomalous events to construct the flag.\n\nKnowledge of network security or protocols is not required.  This challenge requires data stacking, slicing, and\/or anomaly detection.\n\n### Data\n  - timestamp,src,dst,port,bytes\n  - Internal hosts have IPs beginning with 12-14\n  - External IPs include everything else","1dc04d1d":"### Question 7: Infected Host\n\n*One host is part of the botnet from Question 6, what is its IP?*","e1f6d596":"### Question 3: Discover Data Exfiltration 3\n\n*Some assailant is grabbing all the employee and vendor email addresses, and sending them out on a channel normally reserved for other uses. This is similar to attackers abusing DNS for data exfiltration. One host is sending out much more data on a some port from the enterprise than other hosts do, different from the hosts in Questions 1 and 2. What is its port?*\n","4cd12cd5":"### Question 5: Internal P2P\n\n*Sometimes our low-grade infection is visible in other ways.  One particular virus has spread through a number of machines, which now are used to relay commands to each other.  The malware has created an internal P2P network.  What unique port is used by the largest internal clique, of all hosts talking to each other?*","35d0285b":"### Question 10: Lateral Spy\n\n*One host is trying to find a way onto every other host more quietly.  What is its IP?*","83026814":"## Challenges\n\nThe data used here is highly synthetic, so it should be obvious when you get the _right_ answer. ","4b237f67":"## Preprocessing","6e2c354d":"### Question 9: Lateral Brute\n\n*Once a machine is popped, it's often used to explore what else can be reached.  One host is being used to loudly probe the entire enterprise, trying to find ways onto every other host in the enterprise.  What is its IP?*\n","39d6c4d5":"# Checking the answers","14a30619":"### Question 4: Private C&C channel\n\n*We're always running a low-grade infection; some internal machines will always have some sort of malware. Some of these infected hosts phone home to C&C on a private channel. What unique port is used by external malware C&C to marshal its bots?*","14418c2a":"This is the [Wildcard 400 of the 2019 Trendmicro CTF](https:\/\/ctf.trendmicro.com). It's a fun set of exercises!","a4d1698b":"Use the following code to check if your answers are correct."}}