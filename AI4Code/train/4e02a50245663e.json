{"cell_type":{"ab5e93b3":"code","31f7a43b":"code","ba4ef342":"code","ed9de8ae":"code","dfa2b28d":"code","c19088d9":"code","426ee14d":"code","118ed4d3":"code","5e954681":"code","61ef253f":"code","54c8ba62":"code","243a6c5d":"code","019cced7":"code","d8752cea":"code","7fcca170":"code","3ce52d64":"code","82021625":"code","e0a870f4":"code","84266559":"code","d7b15138":"code","83e4d30f":"code","167d80dc":"code","17e369fa":"code","f5860502":"code","db7eba53":"code","e0618ff1":"code","86c416bf":"markdown","0c168f51":"markdown","85652809":"markdown","4898e599":"markdown","0fa13bf0":"markdown","a946ffe0":"markdown","dd8939b2":"markdown","71344e78":"markdown","b994e371":"markdown","24c5c1a6":"markdown","df5b15b1":"markdown","e371654d":"markdown","952e9e0d":"markdown","9988e2b0":"markdown","a10d0b25":"markdown","dbcb71ad":"markdown","15063c60":"markdown","17dc5edd":"markdown","b6c4eff1":"markdown","a8048472":"markdown","dee8ff70":"markdown","facb7e12":"markdown","431b9fa7":"markdown","6ab1eb2d":"markdown","73b63407":"markdown"},"source":{"ab5e93b3":"import pandas as pd\nimport numpy as np \nfrom sklearn.feature_selection import SelectKBest, f_classif\nfrom sklearn.feature_selection import chi2\nimport matplotlib.pyplot as plt\nfrom sklearn.preprocessing import LabelEncoder\nfrom sklearn.preprocessing import OrdinalEncoder\nfrom catboost import Pool, CatBoostClassifier, cv\nfrom sklearn.metrics import accuracy_score\nfrom sklearn.model_selection import train_test_split\nfrom sklearn.metrics import confusion_matrix\nimport seaborn as sns\n%matplotlib inline","31f7a43b":"train_df = pd.read_csv('..\/input\/train_8wry4cB.csv')\ntest_df = pd.read_csv('..\/input\/test_Yix80N0.csv')\n\ntarget = train_df['gender'].copy() ## Target !\ndisplay(train_df.head())\ndisplay(test_df.head())\ndisplay(target.head())\n\n\n#Displaying Train Data !\n#Displaying Test Data !\n#Displaying Target Column !","ba4ef342":"train_df.dtypes","ed9de8ae":"test_df.dtypes","dfa2b28d":"train_df.describe()","c19088d9":"test_df.describe()","426ee14d":"X = train_df.copy()\nX_test = test_df.copy()","118ed4d3":"#Dropping Gender and Session_id Columns.\n\nX.drop(['session_id', 'gender'], axis = 1, inplace = True)\nX_test.drop(['session_id'], axis = 1, inplace = True)\ndisplay(X.head())\ndisplay(X_test.head())\n","5e954681":"# call this to get group of product codes for each user_id\n\ndef product_group(x):\n    prod_list = []\n    for i in x.split(';'):\n        prod_list.append(i.split('\/')[-2])\n    return prod_list\n\n","61ef253f":"# call this to fetch the most frequent D code used.\ndef frequency(List): \n    return max(set(List), key = List.count)\n\n\n# Extracting the D codes. \ndef final_items(x):\n    prod_code = []\n    for i in x:\n        prod_code.append(i[:4])\n    return frequency(prod_code)","54c8ba62":"def CleanIt(data):\n\n    #PRODUCTS\n    data['Category_A'] = data['ProductList'].apply(lambda x : x.split(';')[0].split('\/')[0])\n    data['Category_B'] = data['ProductList'].apply(lambda x : x.split(';')[0].split('\/')[1])\n    data['Category_C'] = data['ProductList'].apply(lambda x : x.split(';')[0].split('\/')[2])\n    \n    #Calling Function on ProductList to populate Product table.\n    data['Items'] =  data['ProductList'].apply(lambda x: product_group(x))\n    data['Product Code'] = data['Items'].apply(lambda x: final_items(x))\n    data['Total_Products_Viewed'] = data['ProductList'].apply(lambda x: len(x.split(';'))) \n    \n    #TIME\n                \n    data['startTime'] = pd.to_datetime(data['startTime'], format = \"%d\/%m\/%y %H:%M\")\n    data['endTime']   = pd.to_datetime(data['endTime'], format = \"%d\/%m\/%y %H:%M\")\n    data['StartHour'] = data['startTime'].dt.hour\n    data['StartMinute'] = data['startTime'].dt.minute\n    data['EndHour'] = data['endTime'].dt.hour\n    data['EndMinute'] = data['endTime'].dt.minute\n    data['Duration_InSeconds']  = (data['endTime']-data['startTime'])\/np.timedelta64(1,'s')\n    \n    \n    return data \n    \n    \n\n","243a6c5d":"trainset = X.copy()\ntestset = X_test.copy()\ntrainset = CleanIt(trainset)\ntestset = CleanIt(testset)\nprint(\"----------------------------- Info on Processed Training Data--------------------\")\ndisplay(trainset.shape)\ndisplay(trainset.dtypes)\ndisplay(trainset.describe())\ndisplay(trainset.info())\ndisplay(trainset.head())\nprint(\"******************************Info on Processed Testing Data***********************\")\ndisplay(testset.shape)\ndisplay(testset.dtypes)\ndisplay(testset.describe())\ndisplay(testset.info())\ndisplay(testset.head())","019cced7":"#Dropping Unecessary Columns now - ProductList and Items.\n\ntrainset.drop(['ProductList', 'Items', 'startTime', 'endTime'], axis = 1 , inplace = True)\ntestset.drop(['ProductList', 'Items', 'startTime','endTime'], axis = 1, inplace = True)\ndisplay(trainset.head())\ndisplay(testset.head())","d8752cea":"trainset1 = trainset.copy()\ntrainset1['gender'] = train_df['gender'].copy()\nplt.figure(figsize=(25,15))\nsns.countplot('Category_A', data = trainset1, hue = 'gender')\nplt.legend(loc = 'center')","7fcca170":"plt.figure(figsize=(25,15))\nsns.countplot('Category_B', data = trainset1.head(30), hue = 'gender')\nplt.legend(loc = 'center')","3ce52d64":"plt.figure(figsize=(15,10))\nsns.countplot('StartHour', data = trainset1, hue = 'gender')\nplt.legend(loc = 'upper left')","82021625":"plt.figure(figsize=(20,5))\nsns.lineplot(x='StartHour', y = 'Total_Products_Viewed', data = trainset1, hue = 'gender')","e0a870f4":"sns.lmplot(x='StartHour', y = 'Total_Products_Viewed', data = trainset1, hue = 'gender')","84266559":"display(trainset1.Duration_InSeconds.describe())\ndisplay(trainset1.Duration_InSeconds.max())\ndisplay(trainset1.Duration_InSeconds.min())","d7b15138":"#You will Get a warning message if you try to index this group with Multiple Keys. Avoid it by passing keys into a list.\n\ngroup_AvgTimeSpend = trainset1.groupby('gender')[['Duration_InSeconds','Total_Products_Viewed']]\n\n#For Males.\ngroup_male = pd.DataFrame(group_AvgTimeSpend.get_group('male'))\ndisplay(group_male.sort_values('Total_Products_Viewed', ascending=False))\nt1 = group_male.sort_values('Total_Products_Viewed', ascending=False)\nplt.figure(figsize=(20,10))\nsns.lineplot(x='Duration_InSeconds', y = 'Total_Products_Viewed', sort = False, data = t1)\nplt.title('For Males')\ndisplay(group_male.sort_values('Duration_InSeconds', ascending = True))\nt2 = group_male.sort_values('Duration_InSeconds', ascending = True)\nsns.lineplot(x='Duration_InSeconds', y = 'Total_Products_Viewed', sort = False, data = t2)","83e4d30f":"group_female = pd.DataFrame(group_AvgTimeSpend.get_group('female'))\ndisplay(group_female.sort_values('Total_Products_Viewed', ascending=False))\nt3 = group_female.sort_values('Total_Products_Viewed', ascending=False)\nplt.figure(figsize=(20,10))\nsns.lineplot(x='Duration_InSeconds', y = 'Total_Products_Viewed', sort = False, data = t3)\nplt.title('For Females')\ndisplay(group_female.sort_values('Duration_InSeconds', ascending = True))\nt4 = group_female.sort_values('Duration_InSeconds', ascending = True)\nsns.lineplot(x='Duration_InSeconds', y = 'Total_Products_Viewed', sort = False, data = t4)\n","167d80dc":"plt.figure(figsize=(10,5))\nsns.lineplot(x='Duration_InSeconds', y = 'Total_Products_Viewed', data = trainset1, hue = 'gender')","17e369fa":"print(trainset.shape, testset.shape)","f5860502":"display(trainset.head())\ndisplay(trainset.dtypes)\ndisplay(testset.head())\ndisplay(trainset.dtypes)\n","db7eba53":"#### MODEL \n\ncate_features_index = np.where(trainset.dtypes != float)[0]\nX1_train, X1_test, y1_train, y1_test = train_test_split(trainset, target, train_size=0.85,random_state=1200)\nfrom catboost import CatBoostClassifier\n\n\ncat = CatBoostClassifier(eval_metric='Accuracy',\n                         use_best_model=True,random_seed=40,loss_function='MultiClass',\n                         learning_rate = 0.674 ,iterations = 700,depth = 4,\n                         bagging_temperature=3,one_hot_max_size=2)\n\n\n\n#Parameters to be tuned :- \n#1. learning Rate\n#2. Training Size(As data is biased)\n#3. Iterations\n#4. OHE size\n#5. depth of tree\n\ncat.fit(X1_train,y1_train ,cat_features=cate_features_index,eval_set=(X1_test,y1_test),use_best_model=True)\nprint('the test accuracy is :{:.6f}'.format(accuracy_score(y1_test,cat.predict(X1_test))))\npredcat = cat.predict(X1_test)\nprint(\"----------------------------------------------------------------------------\")\nprint('Training set score: {:.4f}'.format(cat.score(X1_train, y1_train)))\nprint('Test set score: {:.4f}'.format(cat.score(X1_test, y1_test)))\n\n\nmatrix = confusion_matrix(y1_test, predcat)\nprint(\"--------------------------------------------------------------------------------------------\")\nprint('Confusion matrix\\n\\n', matrix)\nprint('\\nTrue Positives(TP) Females  = ', matrix[0,0])\nprint('\\nTrue Negatives(TN)  Males = ', matrix[1,1])\nprint('\\nFalse Positives(FP) = ', matrix[0,1])\nprint('\\nFalse Negatives(FN) = ', matrix[1,0])","e0618ff1":"preds = cat.predict(testset)\npred1 = preds.flatten()\npredlst = pred1.tolist()\noutput = pd.DataFrame({'session_id': test_df.session_id,'gender': predlst})\noutput.to_csv('cleaned.csv', index=False)\nsns.countplot(predlst)\npd.Series(predlst).value_counts()","86c416bf":"## *************************************** Basic EDA ****************************************************","0c168f51":"* So We Were able to Predict 3742 as females and  758 as males. Which gave us an Model Accuracy of 0.897 ! \n* During The Hackathon We got a public score of 0.86833 and Private Score as of 0.8733 fairly close. \n* The Dataset is unfairly unbalanced, Advanced Feature Engineering and Ensembling may help in Boosting the Accuracy.\n* You Guys can try with Ensembling by stacking up and building a baseline Model.\n","85652809":"#### As, you can see clearly category 'A00002' is mostly preferred category, among females. Whereas Category 'A00001' is favoured by mostly males","4898e599":"#### ******************************************************** THANKS ! ***********************************************************************************","0fa13bf0":"## Model Building****\n\n* We will be using CatBoostClassifier as for training the data and later on we will check how it is performing on the test set. Evaluation and Accuracy will be checked for the model. As, we have Categorical Variables to be dealt with so going with CatBoostClassifier will be good enough, as Catboost handles the Categorical features directly, no explicit OHE or encoding scheme is required.\n\n\n- trainset (Training Data) \n- testset  (Prediction Data)","a946ffe0":"We Have a biased dataset, as you can see in the Gender Column we have 8192 observations only for females. Alongwith, we have 9402 unique products out of which one product has been viewed the most like by 25 users. Also there are users which were viewing same prodcuts at the same time.","dd8939b2":"### Import Packages here - ","71344e78":"### Data Preprocessing","b994e371":"In this also, you can see we have the same product viewed maximum number of times.","24c5c1a6":"##### Also You can Observe before we make final predictions. After evaluation we have found that training set score and test set score is almost equal. Hence We can say there is no Overfitting in the Data.","df5b15b1":"## Problem Statement - \n\nPrediction of User Gender,as the E commerce market is growing and it's necessary to tap in the User Data to enhance their customer services, to provide better product predictions which in turn will help the company to grow in terms of customer base and profit. Hence User Details are very much required. Having said that, we will be working on prediction of gender where we are provided with a set of Categorical Columns to work with.If you are looking for how to handle categorical variables this is a good start !\n\n\n* In the dataset, Column ProductList Contains products seperated by ( ; ) and which in turn every product has a category, sub category and sub sub category which are seperated by (\/) you can refer the notebook to understand clearly.\n\n\n\n- ##### Columns\n   - session_id   :       Object\n   - startTime    :       Object\n   - endTime      :       Object \n   - ProductList  :       Object\n   - gender       :       Object","e371654d":"#### For Males.","952e9e0d":"## Janata Hack - E Commerce Analytics ML Model\n\n#### Contents\n\n- Problem Statement.\n- Import Packages\n- Loading Dataset\n- Data Pre-Processing\n- Basic EDA \n- Model Building\n- Model Evaluation \n- Prediction on Test Data\n- Submissions","9988e2b0":"#### As You can see training data and Testing data are in same order, required for CatBoostClassifier to be in  correct order.","a10d0b25":"#### Basic Analysis.\n\nClearly from the above lineplot you can say that the females users are pretty slow in decision making,as compared to males because the product viewing sessions are long for a few number of products for females. Whereas, males have viewed good number of product in limited time. Hence Female Users Spend more time on the Website than males. So company will have more viewership if invested in products frequently bought and viewed by females, provided such products have been put up to the caraousel.","dbcb71ad":"![](https:\/\/i.imgur.com\/UHbrtdO.png)","15063c60":"### Importing Training Data And Test Data ","17dc5edd":"##### For Females : ","b6c4eff1":"### Results And Analysis -------------- ","a8048472":"### Data Info","dee8ff70":"### Let's Analyse How much reliable customers website have based on time spend amd Viewed Products","facb7e12":"#### For Both ------------------------------------- Analysing Viewing Behaviour----------------------------------------------------","431b9fa7":"### Predictions And Submissions. !","6ab1eb2d":"#### Most Viewership by females is in hour 10th of the day, whereas males prefer pretty late in 20th hour.","73b63407":"#### As, you can see clearly category 'B00001' is mostly preferred category, amongst  females. Also Category 'B00001' is favoured by mostly males, but Category 'B00031' is also preferred by males over female users."}}