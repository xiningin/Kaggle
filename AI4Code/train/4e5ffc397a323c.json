{"cell_type":{"61ad5c18":"code","a99b593b":"code","964d1a06":"code","a301366d":"code","47d93677":"code","4c879501":"code","e1ac1309":"code","6c56eeb8":"code","5375b648":"code","7b14855f":"code","c6b8c46f":"code","f6ed2e86":"code","69ce570a":"code","97349d41":"code","a7b9c15b":"code","32a7f17f":"code","285e665c":"code","66d87fbf":"code","07e56d0a":"code","b43d1e8f":"code","7b7b76ca":"code","58c0316a":"code","0d42c562":"code","f607e626":"code","a838b832":"code","1a62e85b":"code","29de4f4b":"code","ecacc507":"code","75c996d1":"code","3d888b0c":"code","b4a7c3f5":"code","02aa84a3":"code","d1e16d6b":"code","cd0bc97d":"code","0198c471":"code","9708ea8e":"code","cfc5535b":"code","036dbb32":"code","4a87de4e":"code","48637711":"code","b936df09":"code","f0f7575d":"code","be83087c":"code","6a38d146":"code","2b82bf03":"code","eaa809ad":"code","fa948a0b":"code","4b0c6458":"code","febcee87":"code","00aeb4cb":"code","23c6bf85":"code","e2a86b08":"code","ea05508c":"code","71a711b7":"code","0d822fcc":"code","56b68da7":"code","0027e07b":"code","a783ce49":"code","e80b89ef":"code","449c32b2":"code","ac50a6a1":"code","f210aaeb":"code","f6afa3d2":"code","33b76396":"code","f6f5ad3b":"code","cb1790fd":"code","8cf9c2ca":"code","a747e0f4":"code","cad2f7d6":"code","b018fa7f":"code","c44a700c":"code","9755504d":"code","08388518":"code","194ba888":"code","2275036a":"code","6322c4b8":"code","cfa85ce1":"code","289c78ef":"code","9826fc3d":"code","7d5de62a":"code","cc97e4a3":"code","c364db2a":"code","61bf58a9":"code","49f8a390":"code","91827afe":"markdown","b15d9b9c":"markdown","523469ca":"markdown","12ff4550":"markdown","5ff7e773":"markdown","46f0b4be":"markdown","3b05a678":"markdown","69390ec8":"markdown","fb3079af":"markdown","0d4339b1":"markdown","19c59c96":"markdown","ae3f3432":"markdown","6c6f2975":"markdown","6d459d56":"markdown","67f4823d":"markdown","fc2548bc":"markdown","053c44bb":"markdown","5256b5e9":"markdown","c8ed72c2":"markdown","3a8f7639":"markdown","0cc6c821":"markdown","ac452e51":"markdown","b2fd495f":"markdown","fb088dba":"markdown","07431394":"markdown","5ed61d05":"markdown","3eeffba9":"markdown"},"source":{"61ad5c18":"import numpy as np\nimport pandas as pd\nimport seaborn as sns\nimport statsmodels.api as sm\nfrom sklearn.metrics import mean_squared_error\nimport statsmodels.formula.api as smf\nimport matplotlib.pyplot as plt\nimport sqlite3","a99b593b":"import bq_helper\nfrom bq_helper import BigQueryHelper\n# https:\/\/www.kaggle.com\/sohier\/introduction-to-the-bq-helper-package\n\nwdi = bq_helper.BigQueryHelper(active_project=\"patents-public-data\",\n                                   dataset_name=\"worldbank_wdi\")","964d1a06":"bq_assistant = BigQueryHelper(\"patents-public-data\", \"worldbank_wdi\")\nbq_assistant.list_tables()","a301366d":"query_str = \"\"\"SELECT country_code, year, indicator_code, indicator_value from `patents-public-data.worldbank_wdi.wdi_2016` \n               WHERE year BETWEEN 1960 AND 2015 AND \n               indicator_code IN ('SL.UEM.TOTL.NE.ZS','FP.CPI.TOTL.ZG',\n                                     'IC.REG.DURS','GC.TAX.TOTL.GD.ZS','SI.POV.GINI') \n                AND indicator_value<>0\n            \"\"\"","47d93677":"bq_assistant.estimate_query_size(query_str)","4c879501":"wdi_df = wdi.query_to_pandas_safe(query_str)","e1ac1309":"wdi_df.groupby('indicator_code').count()['indicator_value']","6c56eeb8":"wdi_df.head()","5375b648":"wdi_df.shape","7b14855f":"wdi_df_piv = wdi_df.pivot_table(index=['country_code','year'], \n                                columns=['indicator_code'], \n                                values=['indicator_value'], fill_value=np.nan).reset_index()","c6b8c46f":"wdi_df_piv.shape","f6ed2e86":"wdi_df_piv.head()","69ce570a":"wdi_df_piv.columns = ['country_code','year'] + list(wdi_df_piv.columns.droplevel())[2:]","97349d41":"wdi_df_piv.head()","a7b9c15b":"wdi_df_piv.columns","32a7f17f":"wdi_df_mod = wdi_df_piv[['country_code','SI.POV.GINI','year',                                              \n                        'FP.CPI.TOTL.ZG', 'GC.TAX.TOTL.GD.ZS',\n                        'IC.REG.DURS',\n                        'SL.UEM.TOTL.NE.ZS']]","285e665c":"wdi_df_mod.columns = ['CountryCode','Gini','Year', \n                      'Inflat', 'TaxRev', 'BusDay', 'Unempl']","66d87fbf":"wdi_df_mod.head()","07e56d0a":"wdi_df_mod.describe()","b43d1e8f":"wdi_df_mod.groupby(['Year']).count().T","7b7b76ca":"sns.set(rc={'figure.figsize':(11.7,8.27)})","58c0316a":"wdi_corr = wdi_df_mod.iloc[:,1:].corr()\nmask = np.zeros(wdi_corr.shape, dtype=bool)\nmask[np.tril_indices(len(mask))] = True\nsns.heatmap(wdi_corr, annot = True, mask = mask);","0d42c562":"sns.pairplot(wdi_df_mod);","f607e626":"wdi_df_mod['Gini'].mean()","a838b832":"sns.distplot(wdi_df_mod['Gini'].dropna());","1a62e85b":"sns.distplot(np.log(wdi_df_mod['Gini'].dropna()));","29de4f4b":"wdi_df_clean = wdi_df_mod.dropna()","ecacc507":"from sklearn.preprocessing import RobustScaler\nrob_sc = RobustScaler()","75c996d1":"Gini_log = np.log(wdi_df_clean['Gini'])\nX_sc = rob_sc.fit_transform(wdi_df_clean.iloc[:,2:])","3d888b0c":"wdi_sc = pd.concat([wdi_df_clean.iloc[:, 0],\n                    wdi_df_clean.iloc[:, 2], \n                    Gini_log,\n                    pd.DataFrame(X_sc, \n                                index=wdi_df_clean.index,\n                                columns = [x + '_sc' for x in wdi_df_clean.iloc[:,2:].columns])],\n                    axis=1)","b4a7c3f5":"wdi_df_clean.head()","02aa84a3":"wdi_sc.head()","d1e16d6b":"wdi_sc.shape","cd0bc97d":"wdi_corr_sc = wdi_sc.iloc[:,2:].corr()\nmask = np.zeros(wdi_corr_sc.shape, dtype=bool)\nmask[np.tril_indices(len(mask))] = True\nsns.heatmap(wdi_corr_sc, annot = True, mask = mask);","0198c471":"sns.pairplot(wdi_sc.iloc[:,2:]);","9708ea8e":"y = wdi_sc['Gini']","cfc5535b":"ols = smf.ols('Gini ~ Inflat_sc + TaxRev_sc + BusDay_sc + Unempl_sc',\n                     data=wdi_sc)\nolsf = ols.fit()\n# Print out the statistics\nolsf.summary()","036dbb32":"sns.distplot(olsf.resid);","4a87de4e":"sns.regplot(np.exp(olsf.fittedvalues),np.exp(y));","48637711":"sns.regplot(olsf.fittedvalues, olsf.resid, color=\"g\", lowess = True);","b936df09":"fig, axs = plt.subplots(ncols=4, figsize=(30, 5))\nsns.regplot(wdi_sc.iloc[:,4], olsf.resid, ax=axs[0], color=\"r\", lowess = True);\nsns.regplot(wdi_sc.iloc[:,5], olsf.resid, ax=axs[1], color=\"r\", lowess = True);\nsns.regplot(wdi_sc.iloc[:,6], olsf.resid, ax=axs[2], color=\"r\", lowess = True);\nsns.regplot(wdi_sc.iloc[:,7], olsf.resid, ax=axs[3], color=\"r\", lowess = True);","f0f7575d":"import statsmodels.stats.api as sms\nfrom statsmodels.compat import lzip\nname = ['Lagrange multiplier statistic', 'p-value',\n        'f-value', 'f p-value']\ntest = sms.het_breuschpagan(olsf.resid, olsf.model.exog)\nlzip(name, test)","be83087c":"rmse_ols = (np.sqrt(mean_squared_error(np.exp(y), np.exp(olsf.fittedvalues))))\nperformance =  pd.DataFrame([['Simple OLS', rmse_ols, test[1]]], columns=['model','rmse', 'het'])\nperformance","6a38d146":"wdi_res = wdi_sc\nwdi_res['Residuals'] = olsf.resid","2b82bf03":"box = sns.boxplot(x=\"CountryCode\", y=\"Residuals\", data=wdi_res);\nbox.set_xticklabels(box.get_xticklabels(), rotation=90);","eaa809ad":"conn = sqlite3.connect('..\/input\/world-development-indicators\/database.sqlite')","fa948a0b":"country_df = pd.read_sql_query(\"SELECT CountryCode,Region,IncomeGroup FROM Country\", conn)","4b0c6458":"country_df.groupby('IncomeGroup').count()","febcee87":"wdi_res.shape","00aeb4cb":"wdi_region = wdi_res.merge(country_df, left_on='CountryCode', right_on='CountryCode')","23c6bf85":"wdi_region.shape","e2a86b08":"wdi_region.head()","ea05508c":"box = sns.boxplot(x=\"IncomeGroup\", y=\"Residuals\", data=wdi_region,\n                 order=['High income: OECD', 'High income: nonOECD', 'Upper middle income', 'Lower middle income', 'Low income']);\nbox.set_xticklabels(box.get_xticklabels(), rotation=90);","71a711b7":"wdi_region.groupby(['IncomeGroup']).count()","0d822fcc":"wdi_region['IncomeGroup'] = np.where(wdi_region['IncomeGroup']=='Low income', \n                                'Lower middle income',\n                                wdi_region['IncomeGroup'])","56b68da7":"box = sns.boxplot(x=\"IncomeGroup\", y=\"Residuals\", data=wdi_region,\n                 order=['High income: OECD', 'High income: nonOECD', 'Upper middle income', 'Lower middle income']);\nbox.set_xticklabels(box.get_xticklabels(), rotation=90);","0027e07b":"wdi_region.groupby(['IncomeGroup']).count()","a783ce49":"wdi_region.head()","e80b89ef":"mvi = smf.mixedlm(\"Gini ~ Inflat_sc + TaxRev_sc + BusDay_sc + Unempl_sc\", data=wdi_region,\n                 groups=\"IncomeGroup\")\nmvif = mvi.fit()\nprint(mvif.summary())","449c32b2":"mvif.random_effects","ac50a6a1":"sns.regplot(mvif.fittedvalues,mvif.resid, color=\"g\", lowess = True);","f210aaeb":"name = ['Lagrange multiplier statistic', 'p-value',\n        'f-value', 'f p-value']\ntest = sms.het_breuschpagan(mvif.resid, mvif.model.exog)\nlzip(name, test)","f6afa3d2":"rmse_mvi = np.sqrt(mean_squared_error(np.exp(y), np.exp(mvif.fittedvalues)))\nperformance.loc[1] =  ['Income Group, Varying Intercept', rmse_mvi,  test[1]]\nperformance","33b76396":"def plot_df_scatter_columns(df, y_column, grouping, rel_col):\n    for z in df[rel_col]:    \n        sns.lmplot(x = z, y = y_column, data = df, hue = grouping) \n\nrel_col = ['Year_sc', 'Inflat_sc', 'TaxRev_sc',\n       'BusDay_sc', 'Unempl_sc']\n\nplot_df_scatter_columns(wdi_region, 'Gini', \"IncomeGroup\", rel_col)","f6f5ad3b":"mvis = smf.mixedlm(\"Gini ~  Inflat_sc + TaxRev_sc + BusDay_sc + Unempl_sc\", data=wdi_region,\n                 groups=\"IncomeGroup\",\n                  #re_formula=\"~ Inflat_sc + TaxRev_sc + BusDay_sc + Unempl_sc\"\n                  re_formula=\"~ BusDay_sc\"\n                )\nmvisf = mvis.fit()\nprint(mvisf.summary())\n","cb1790fd":"mvisf.random_effects","8cf9c2ca":"sns.regplot(mvisf.fittedvalues, mvisf.resid, color=\"g\", lowess = True);","a747e0f4":"name = ['Lagrange multiplier statistic', 'p-value',\n        'f-value', 'f p-value']\ntest = sms.het_breuschpagan(mvisf.resid, mvisf.model.exog)\nlzip(name, test)","cad2f7d6":"rmse_mvis = np.sqrt(mean_squared_error(np.exp(y), np.exp(mvisf.fittedvalues)))\nperformance.loc[2] =  ['Income Group, Varying Intercept and Slope', rmse_mvis, test[1]]\nperformance","b018fa7f":"from sklearn.ensemble import RandomForestRegressor","c44a700c":"rf = RandomForestRegressor()","9755504d":"rf.fit(wdi_region.iloc[:,4:8], wdi_region['Gini'])","08388518":"Gini_pred = rf.predict(wdi_region.iloc[:,4:8])","194ba888":"rmse_rf = np.sqrt(mean_squared_error(np.exp(y), np.exp(Gini_pred)))","2275036a":"wdi_region.iloc[:,4:8].columns","6322c4b8":"rf.feature_importances_","cfa85ce1":"rmse_rf","289c78ef":"sns.regplot(Gini_pred,y-Gini_pred, color=\"g\", lowess = True);","9826fc3d":"performance.loc[3] =  ['Rf', rmse_rf, np.nan]\nperformance","7d5de62a":"wdi_region.head()","cc97e4a3":"olsd = smf.ols('Gini ~ Inflat_sc + TaxRev_sc + BusDay_sc + Unempl_sc + C(IncomeGroup) ',\n                     data=wdi_region)\nolsdf = olsd.fit()\n# Print out the statistics\nolsdf.summary()","c364db2a":"sns.regplot(olsdf.fittedvalues, olsdf.resid, color=\"g\", lowess = True);","61bf58a9":"name = ['Lagrange multiplier statistic', 'p-value',\n        'f-value', 'f p-value']\ntest = sms.het_breuschpagan(olsdf.resid, olsdf.model.exog)\nlzip(name, test)","49f8a390":"rmse_ols_dummy = (np.sqrt(mean_squared_error(np.exp(y), np.exp(olsdf.fittedvalues))))\nperformance.loc[4] =  ['Income Group Dummy', rmse_ols_dummy, test[1]]\nperformance","91827afe":"### Simple OLS model","b15d9b9c":"The Gini coefficient is a measure of income distribution inequality in a country. Values closer to 100% mean that there is more inequality, while values close to 0 mean that income in a country is more evenly spread. In this notebook we want to study the relationship between the Gini index (World Bank estimate) and different economic indicators in the WDI data set, such as:\n\n* Inflation, consumer prices (annual %)\n* Tax revenue (% of GDP)\n* Time required to start a business (days)\n* Unemployment, total (% of total labor force)\n\nThe outcome is to understand if a change macroeconomic policies can impact the degree of income inequality in a country, as measured by the Gini coeffcient.","523469ca":"Pair plot","12ff4550":"Count missing data per year","5ff7e773":"Correlation","46f0b4be":"## Load and explore data","3b05a678":"In conclusion, the varying intercept and slope model suggest that increasing tax levels, inflation and decreasing the time to register a business have the effect of reducing income distribtion inequality.","69390ec8":"Describe data","fb3079af":"Pivot dataframe so the indicators are on columns","0d4339b1":"Rearrange and rename columns","19c59c96":"Add country-region data from a SQLite database","ae3f3432":"Count how many values we have for each indicator (across all countries and years)","6c6f2975":"The residual plot suggests heteroscedasticity.","6d459d56":"#### Heteroskedasticity test","67f4823d":"Estimate query size","fc2548bc":"## Models","053c44bb":"### Appendix 2 - OLS with Income Group as dummy","5256b5e9":"### Appendix 1 - Random forest model","c8ed72c2":"### Multilevel model with varying intercept and varying slopes by Income Group","3a8f7639":"Load WDI data from BigQuery","0cc6c821":"We want to include income group in the model, but without hot encoding as we don't want to make income group a predictor.","ac452e51":"Distribution of Gini","b2fd495f":"The model is not great. Are we missing something? Is there country variation that we fail to capture?","fb088dba":"Apply log transform on Gini and scale independent variables","07431394":"Correlation and pair plot with transformed data","5ed61d05":"See top rows and size of DataFrame","3eeffba9":"### Multilevel model with varying intercept by Income Group"}}