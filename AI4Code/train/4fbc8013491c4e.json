{"cell_type":{"7a3c4ac9":"code","0c93d88b":"code","e7f4037e":"code","85e973a5":"code","2c14dcb3":"code","3a7c3848":"code","333fddbb":"code","49ed5bc1":"code","85f1defa":"code","dcc6777a":"code","49da3c49":"code","5cd8c85a":"code","0bab3d03":"code","050dab89":"code","8401aeac":"code","755f7456":"code","31162351":"code","9157c608":"code","bd2436ef":"markdown","e172afa5":"markdown","83d7ed8f":"markdown","7cd69af3":"markdown","1933407a":"markdown","4594901d":"markdown","2edd55cd":"markdown","8b95b198":"markdown","6ed818ac":"markdown","e816940a":"markdown","0701d309":"markdown","8f433ba4":"markdown","f56c8e1a":"markdown","4bfed73f":"markdown"},"source":{"7a3c4ac9":"import os\nimport numpy as np\nimport pandas as pd\nfrom scipy import stats\nimport seaborn as sns\nimport matplotlib.pyplot as plt\nfrom collections.abc import Iterable\nimport plotly.graph_objects as go\npd.options.display.max_rows = 100\ntrain = pd.read_csv('..\/input\/osic-pulmonary-fibrosis-progression\/train.csv')\ntest = pd.read_csv('..\/input\/osic-pulmonary-fibrosis-progression\/test.csv')\nsub = pd.read_csv('..\/input\/osic-pulmonary-fibrosis-progression\/sample_submission.csv')\nprint('train shape', train.shape, 'test shape', test.shape)\n\n\n# Plot a timeseries line Weeks x FVC (or %)\ndef plot_timeserie(patient_id, var='FVC'):\n    data = train[train.Patient==patient_id]\n    sex = data.loc[data.index[0], 'Sex']\n    smoke = data.loc[data.index[0], 'SmokingStatus']\n    print(\"Week: {} to {} | Age: {} | Sex: {} | Smoke: {}\".format(\n        data.Weeks.min(), data.Weeks.max(), data.Age.max(), sex, smoke))\n\n    fig, ax = plt.subplots(figsize=(12, 4))\n    p1 = sns.lineplot(x='Weeks', y=var, data=data)\n    for i in data.index:\n        s = \"w{}: {:.0f}\".format(data.loc[i, 'Weeks'], data.loc[i, var])\n        ax.text(data.loc[i, 'Weeks'], data.loc[i, var], s)\n    \n\n# Plot FVC for multiple patients (one line for each)\ndef plot_timeseries(patient_ids, var='FVC'):\n    if not isinstance(patient_ids, Iterable):\n        patient_ids = [patient_ids]\n    \n    plt.figure(figsize=(12, 6))\n    data = train[train.Patient.isin(patient_ids)]\n    p1 = sns.lineplot(x='Weeks', y=var, data=data, hue='Patient')\n    p1.get_legend().remove()","0c93d88b":"train.head()","e7f4037e":"patients = train.Patient.unique()\nprint(\"There are\", len(train), \"records in the training set\")\nprint(\"There are\", len(patients), \"unique patients in the training set\")","85e973a5":"# create curves and buttons for menu\ntraces = []\n\nfor i, patient_id in enumerate(patients):\n    tmp = train[train.Patient == patient_id]\n    traces.append(go.Scatter(x=tmp.Weeks, y=tmp.FVC, text=tmp.FVC, mode='lines+markers', name=patient_id[-5:]))\n    vx = [i == j for j in range(len(patients))]\n\n# create plot\nfig = go.Figure()\nfig.add_traces(traces)\nfig.update_layout(title_text=\"FVC Curve\")","2c14dcb3":"outlier_patients = [\n    \"ID00076637202199015035026\", \"ID00077637202199102000916\", \"ID00082637202201836229724\",\n    \"ID00117637202212360228007\", \"ID00119637202215426335765\", \"ID00126637202218610655908\",\n    \"ID00135637202224630271439\", \"ID00165637202237320314458\", \"ID00170637202238079193844\",\n    \"ID00172637202238316925179\", \"ID00197637202246865691526\", \"ID00218637202258156844710\",\n    \"ID00235637202261451839085\", \"ID00288637202279148973731\", \"ID00323637202285211956970\",\n    \"ID00337637202286839091062\", \"ID00355637202295106567614\"\n]\nfor patient_id in outlier_patients:\n    plot_timeserie(patient_id)","3a7c3848":"metadata = train.groupby('Patient').first()","333fddbb":"plt.figure(figsize=(10,4))\n_ = sns.distplot(metadata.Age, bins=20).set_title(\"Age distribution\")","49ed5bc1":"plt.figure(figsize=(10,4))\n_ = sns.countplot(metadata.SmokingStatus, hue=metadata.Sex).set_title(\"Smoking status and sex distribution\")","85f1defa":"print(metadata.Sex.value_counts(normalize=False))\nprint(metadata.SmokingStatus.value_counts(normalize=False))","dcc6777a":"plt.figure(figsize=(10,4))\n_ = sns.distplot(metadata[metadata.SmokingStatus == 'Ex-smoker'].Age, hist=False).set_title(\"Age by Smoking Status\")\n_ = sns.distplot(metadata[metadata.SmokingStatus == 'Never smoked'].Age, hist=False)\n_ = sns.distplot(metadata[metadata.SmokingStatus == 'Currently smokes'].Age, hist=False)","49da3c49":"plt.figure(figsize=(10,4))\n_ = sns.distplot(train.FVC, bins=20).set_title(\"FVC distribution\")","5cd8c85a":"plt.figure(figsize=(10,4))\n_ = sns.distplot(train[train.Sex == 'Male'].FVC, bins=20).set_title(\"Male (blue) vs Female (orange) FVC distribution\")\n_ = sns.distplot(train[train.Sex == 'Female'].FVC, bins=20)","0bab3d03":"plt.figure(figsize=(10,4))\n_ = sns.distplot(train[train.SmokingStatus == 'Ex-smoker'].FVC, hist=False).set_title(\"FVC by Smoking Status\")\n_ = sns.distplot(train[train.SmokingStatus == 'Never smoked'].FVC, hist=False)\n_ = sns.distplot(train[train.SmokingStatus == 'Currently smokes'].FVC, hist=False)","050dab89":"plot_timeseries(patients, var='FVC')","8401aeac":"plot_timeseries(patients, var='Percent')","755f7456":"smoking_patients = train[train.SmokingStatus == 'Currently smokes'].Patient.unique()\nplot_timeseries(smoking_patients, var='FVC')","31162351":"# get value of first FVC measure for each patient\nidx = train.groupby('Patient').Weeks.idxmin()\nfirst_fvc = train.loc[idx, ['Patient', 'FVC']]\n# Divide in bins (quantiles)\nbin_edges = stats.mstats.mquantiles(first_fvc.FVC, [0.1*i for i in range(1, 11)])\nbin_edges","9157c608":"for i in range(10):\n    if i == 0:\n        tmp = first_fvc[(first_fvc.FVC <= bin_edges[i])]\n    else:\n        tmp = first_fvc[(first_fvc.FVC <= bin_edges[i]) & (first_fvc.FVC > bin_edges[i-1])]\n    plot_timeseries(tmp.Patient, var='FVC')","bd2436ef":"So 1549 exams (FVC measurements) for 176 different patients","e172afa5":"Same, but using Percent column","83d7ed8f":"# Data and imports","7cd69af3":"# 5. Multiple FVC Curves","1933407a":"# 3. Metadata","4594901d":"# 2.1 Outliers\n\nLooking at each patient's individual curve we can see many outliers. There is a high level of uncertainty related to FVC and disease progression. Some examples:","2edd55cd":"### Smoking Patients","8b95b198":"**FVC distribution according to Smoking Status**\n\nBlue: Ex-Smokers\n\nYellow: Never Smoked\n\nGreen: Currently smokes","6ed818ac":"**Age distribution according to Smoking Status**\n\nBlue: Ex-Smokers\n\nYellow: Never Smoked\n\nGreen: Currently smokes","e816940a":"FVC evolution for all 176 patients: one line for each patient","0701d309":"### Trying to group patients by the value of the first FVC measure","8f433ba4":"# 2. FVC Curve for each patient\n\nThe right column has each patient id (last five numbers); double-click to select a single patient, them a single click will add more patients to the visualization. Finally, using double-click again will return to all patients.","f56c8e1a":"# 4. FVC Distribution","4bfed73f":"# 1. Overview"}}