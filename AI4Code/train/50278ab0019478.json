{"cell_type":{"cbc9a5dd":"code","889e86cf":"code","19e971c5":"code","edf12820":"code","9eb80458":"code","fed0af7c":"code","e52bdba2":"code","fb0609ef":"markdown","355a447e":"markdown","052d70f1":"markdown","0120c1fb":"markdown","60572a0a":"markdown","119818ad":"markdown"},"source":{"cbc9a5dd":"# Replace 'kaggle-competitions-project' with YOUR OWN project id here --  \nPROJECT_ID = 'kaggle-bq-geotag' #\n#PROJECT_ID='kaggle-competitions-project'\n\nfrom google.cloud import bigquery\nclient = bigquery.Client(project=PROJECT_ID, location=\"US\")\ndataset = client.create_dataset('bqml_example', exists_ok=True)\n\nfrom google.cloud.bigquery import magics\nfrom kaggle.gcp import KaggleKernelCredentials\nmagics.context.credentials = KaggleKernelCredentials()\nmagics.context.project = PROJECT_ID\n\nimport seaborn as sns\nimport matplotlib.pyplot as plt\n\n# create a reference to our table\ntable = client.get_table(\"kaggle-competition-datasets.geotab_intersection_congestion.train\")\n\n# look at five rows from our dataset\nclient.list_rows(table, max_results=5).to_dataframe()","889e86cf":"%load_ext google.cloud.bigquery","19e971c5":"%%bigquery\nSELECT\n    SUM(pop.population) AS population,\n    pop.minimum_age, \n    pop.maximum_age,\n    pop.gender,\n    zipcd.zipcode,\n    CASE zipcd.state_code\n      WHEN 'MA' THEN 'Boston'\n      WHEN 'IL' THEN 'Chicago'\n      WHEN 'GA' THEN 'Atlanta'\n      WHEN 'PA' THEN 'Philadelphia'\n  END\n    city,\n    zipcd.zipcode_geom\n  FROM\n    `bigquery-public-data.utility_us.zipcode_area` zipcd,\n    `bigquery-public-data.census_bureau_usa.population_by_zip_2010` pop\n  WHERE\n    zipcd.state_code IN ('MA',\n      'IL',\n      'PA',\n      'GA')\n    AND ( zipcd.city LIKE '%Atlanta%'\n      OR zipcd.city LIKE '%Boston%'\n      OR zipcd.city LIKE '%Chicago%'\n      OR zipcd.city LIKE '%Philadelphia%' )\n    AND SUBSTR(CONCAT('000000', pop.zipcode),-5) = zipcd.zipcode\n  GROUP BY\n    pop.minimum_age, \n    pop.maximum_age,\n    pop.gender,\n    zipcd.zipcode,\n    CASE zipcd.state_code\n      WHEN 'MA' THEN 'Boston'\n      WHEN 'IL' THEN 'Chicago'\n      WHEN 'GA' THEN 'Atlanta'\n      WHEN 'PA' THEN 'Philadelphia'\n  END\n    ,\n    zipcd.zipcode_geom\n    limit 100","edf12820":"%%bigquery df\nWITH\n\n  # population per zipcode\n  # (for simplicity ignore gender and age information)\n\n  zip_info AS(\n  SELECT\n    pop.minimum_age, \n    pop.maximum_age,\n    pop.gender,\n    SUM(pop.population) AS population,\n    zipcd.zipcode,\n    CASE zipcd.state_code\n      WHEN 'MA' THEN 'Boston'\n      WHEN 'IL' THEN 'Chicago'\n      WHEN 'GA' THEN 'Atlanta'\n      WHEN 'PA' THEN 'Philadelphia'\n  END\n    city,\n    zipcd.zipcode_geom\n  FROM\n    `bigquery-public-data.utility_us.zipcode_area` zipcd,\n    `bigquery-public-data.census_bureau_usa.population_by_zip_2010` pop\n  WHERE\n    zipcd.state_code IN ('MA',\n      'IL',\n      'PA',\n      'GA')\n    AND ( zipcd.city LIKE '%Atlanta%'\n      OR zipcd.city LIKE '%Boston%'\n      OR zipcd.city LIKE '%Chicago%'\n      OR zipcd.city LIKE '%Philadelphia%' )\n    AND SUBSTR(CONCAT('000000', pop.zipcode),-5) = zipcd.zipcode\n  GROUP BY\n    pop.minimum_age, \n    pop.maximum_age,\n    pop.gender,\n    zipcd.zipcode,\n    CASE zipcd.state_code\n      WHEN 'MA' THEN 'Boston'\n      WHEN 'IL' THEN 'Chicago'\n      WHEN 'GA' THEN 'Atlanta'\n      WHEN 'PA' THEN 'Philadelphia'\n  END\n    ,\n    zipcd.zipcode_geom),\n  \n  # spatial test and train data\n  \n  train_and_test AS (\n  SELECT\n    tr.intersectionId,\n    tr.longitude,\n    tr.latitude,\n    tr.city\n  FROM\n    `kaggle-competition-datasets.geotab_intersection_congestion.train` tr\n  UNION DISTINCT\n  SELECT\n    ts.intersectionId,\n    ts.longitude,\n    ts.latitude,\n    ts.city\n  FROM\n    `kaggle-competition-datasets.geotab_intersection_congestion.test` ts),\n  \n  # Zipcode and Population per Intersection\n  \n  pop_per_intersection AS (\n  SELECT\n    t.intersectionId,\n    zi.population,\n    zi.zipcode,\n    t.city,\n    zi.minimum_age, \n    zi.maximum_age,\n    zi.gender,\n    zi.zipcode_geom\n  FROM\n    train_and_test t,\n    zip_info zi\n  WHERE\n    t.city = zi.city\n    AND ST_CONTAINS( ST_GEOGFROMTEXT(zi.zipcode_geom),\n      ST_GeogPoint(longitude,\n        latitude)))\n  \n# fill empty\/missing zipcodes and population\n\nSELECT\n  t.city,\n  t.intersectionId, \n  p.minimum_age, \n  p.maximum_age,\n  p.gender,\n  coalesce(p.population,\n    round(AVG(p.population) OVER(PARTITION BY t.city, p.minimum_age, p.maximum_age, p.gender))) AS population,\n  coalesce(p.zipcode, 'N\/A') AS zipcode,\n  CASE\n    WHEN p.zipcode IS NULL THEN 1\n  ELSE\n  0\nEND AS zip_code_na\n#--,\n#--ST_GeogPoint(t.longitude,\n#--        t.latitude) intersection_gp,\n#p.zipcode_geom\nFROM\n  train_and_test t\nLEFT OUTER JOIN\n  pop_per_intersection p\nON\n  (t.city = p.city\n    AND t.intersectionId = p.intersectionId);","9eb80458":"df.head()","fed0af7c":"print('Assert, number of unique intersactions as expected:', df.groupby(['city']).intersectionId.nunique().sum()==6381)","e52bdba2":"df.to_csv('pop_zipcode_intersec.csv', index=False)","fb0609ef":"# Loading population and zip code information","355a447e":"Check number of unique intersections:","052d70f1":"Let's have a look at the 2010 population of a zip code area","0120c1fb":"The population is by age and gender. The zip code dataset provides geo information as a polygon.\n\nNext we check which intersection coordinates are within a polygon. So we can match intersection to zip code.","60572a0a":"# About\n\nThis kernel shows how to integrate population and zip code information to the intersections.\n\nThe results are writen to the output **pop_zipcode_intersec.csv** if you want to use it in python right away without BigQuery access. \n\n## Credits\nSome of the ideas are inspired by the following kernels. Please visit them and give them upvotes if you like them.\n- This kernel is a forked from [BigQuery Machine Learning Tutorial](https:\/\/www.kaggle.com\/rtatman\/bigquery-machine-learning-tutorial).","119818ad":"# Export to csv\nMissing population (where zipcode == 'N\/A') is imputed with mean over gender, age and city. Imputed data is flagged in zip_code_na."}}