{"cell_type":{"88138ecd":"code","5edb83c0":"code","697a4a33":"code","ffae8b6a":"code","acf0b4b2":"code","87cc4048":"code","b649044b":"code","c6e6da23":"code","7de82e2d":"code","809e41b1":"code","ed891a56":"code","4618af22":"code","95b46b12":"code","3d2ed4d4":"code","0e6fdf84":"code","58423f56":"code","e530960b":"markdown","90eb03b2":"markdown","250ef0ed":"markdown","ee3ba2e9":"markdown","237c87d8":"markdown","3d6f39f8":"markdown","fde85b21":"markdown"},"source":{"88138ecd":"import numpy as np, pandas as pd, json, folium, geopandas as gpd, branca\nimport matplotlib.pyplot as plt\nfrom matplotlib import animation, colors\nfrom IPython.core.display import HTML, display\n\n!rm -rf COVID-19 ITA* license*\n!git clone https:\/\/github.com\/pcm-dpc\/COVID-19 2>&1 | cat\n!curl https:\/\/data.biogeo.ucdavis.edu\/data\/diva\/adm\/ITA_adm.zip --output ITA_adm.zip -s\n!unzip -q ITA_adm.zip -d ITA_adm\n!rm ITA_adm\/ITA_adm[03].* ITA_adm.zip","5edb83c0":"prov_map = gpd.read_file('.\/ITA_adm\/ITA_adm2.shp').to_crs(epsg='4326')\n\ndef map_rename(mapdf, old, new):\n    for i, oldname in enumerate(old):\n        prov_map.loc[mapdf['NAME_2']==oldname, 'NAME_2'] = new[i]\n\n# fail Sardegna because geodata is outdated\nmap_rename(prov_map,\n    ['Reggio Di Calabria', \"Forli' - Cesena\", \"Reggio Nell'Emilia\", 'Mantua',  \n     'Monza and Brianza',  'Pesaro E Urbino', 'Syracuse', 'Florence', 'Padua',  \n     'Cagliari'], \n    ['Reggio di Calabria', 'Forl\u00ec-Cesena',    \"Reggio nell'Emilia\", 'Mantova', \n     'Monza e della Brianza', 'Pesaro e Urbino', 'Siracusa', 'Firenze', 'Padova', \n     'Sud Sardegna'])\n","697a4a33":"covid_provincial = pd.read_csv('.\/COVID-19\/dati-province\/dpc-covid19-ita-province.csv')\nMAX_DATE = covid_provincial['data'].max()\nMAX_DATE","ffae8b6a":"data = covid_provincial[covid_provincial['data']==MAX_DATE]\\\n    [['denominazione_provincia', 'totale_casi']].dropna()\nmapdata = prov_map.merge(\n    data, \n    how='left', \n    left_on=\"NAME_2\", \n    right_on=\"denominazione_provincia\")[['NAME_2','geometry', 'totale_casi']]\nmapdata.fillna(0, inplace=True)\nmapdata.head()","acf0b4b2":"m = folium.Map(location=[41.89,12.48], zoom_start=6) \n\nLOGVMAX = np.log(covid_provincial['totale_casi'].max())\ncolormap = branca.colormap.LinearColormap(\n    colors=['blue', 'green', 'yellow', 'orange', 'red'],\n    index=np.round(np.exp(np.linspace(0, LOGVMAX, 5))),\n    vmin=0, vmax=np.exp(9),\n    ).to_step(n=12, \n              index=np.round(np.exp(np.linspace(0, LOGVMAX, 12))))\n\nstyle_function = lambda x: {'fillColor': colormap(x['properties']['totale_casi']), \n                            'color':'#000000', 'fillOpacity': 0.5, 'weight': 0.1}\nhighlight_function = lambda x: {'fillColor': '#000000', 'color':'#000000', \n                                'fillOpacity': 0.50, 'weight': 0.1}\n\nprovinces = folium.features.GeoJson(\n    mapdata,\n    style_function=style_function, \n    highlight_function=highlight_function, \n    control=False,\n    tooltip=folium.features.GeoJsonTooltip(\n        fields=['NAME_2', 'totale_casi'],\n        aliases=['province: ', 'total cases: '],\n        style=\"background-color: white; color: #333333;\" +\n               \"font-family: arial; font-size: 12px; padding: 10px;\"\n    )\n)\nm.add_child(provinces)\nm.keep_in_front(provinces)\ncolormap.add_to(m)\nm","87cc4048":"m.save(f'italy_covid_provinces_on_{MAX_DATE}.html')","b649044b":"# read map data and rename regions\nmap_ita = gpd.read_file('.\/ITA_adm\/ITA_adm1.shp')#.to_crs('World_Robinson')\n\ndef map_rename(gpdmap, old, new):\n    for i, oldname in enumerate(old):\n        gpdmap.loc[gpdmap['NAME_1']==oldname, 'NAME_1'] = new[i]\n\nmap_rename(map_ita,\n    ['Reggio Di Calabria', \"Forli' - Cesena\", \"Reggio Nell'Emilia\", 'Mantua',  \n     'Monza and Brianza', 'Pesaro E Urbino', 'Syracuse', 'Florence', 'Padua',  \n     'Cagliari', 'Apulia', 'Sicily', 'Friuli-Venezia Giulia', 'Trentino-Alto Adige'], \n    ['Reggio di Calabria', 'Forl\u00ec-Cesena', \"Reggio nell'Emilia\", 'Mantova', \n     'Monza e della Brianza', 'Pesaro e Urbino', 'Siracusa', 'Firenze', 'Padova', \n     'Sud Sardegna','Puglia', 'Sicilia', 'Friuli Venezia Giulia', 'Trento+Bolzano'])\n\n# read COVID data, rename some cols\ncovid = pd.read_csv('.\/COVID-19\/dati-regioni\/dpc-covid19-ita-regioni.csv')\ncovid.rename(columns={'denominazione_regione':'region', 'data': 'date', \n                      'nuovi_positivi': 'Daily new cases', 'deceduti': 'Total deaths'}, inplace=True)\ndates = sorted(covid['date'].unique())\nMAX_DATE = dates[-1]\nVARIABLES = ['Daily new cases', 'Total deaths']\nCMAP = 'jet'\n\n# sum data for two P.A. regions because we only have 'Trentino-Alto Adige' on map\ndata = covid[ ['date', 'region', 'lat', 'long'] + VARIABLES ].fillna(0)\nx = data[data['region']=='P.A. Bolzano']\ny = data[data['region']=='P.A. Trento']\nz = x.append(y)\naggf = {'id':'min','region':(lambda x:'Trento+Bolzano'), 'lat':'sum', 'long':'sum'}\naggf.update({v: 'sum' for v in VARIABLES})\nz['id'] = z.index.to_series()\nz = z.groupby('date', as_index=False).agg(aggf)\nz = z.set_index(['id'])\nz[['lat', 'long']]\/=2\ndata.loc[x.index] = z\ndata.drop(y.index, inplace=True)\n\n# join map and COVID data on region name\nmapdata2 = map_ita.merge(data, how='left', \n                         left_on=\"NAME_1\", right_on=\"region\")\nmapdata2 = mapdata2[['NAME_1','geometry'] + list(data.columns)]\nmapdata2 = [mapdata2[mapdata2['date']==d] for d in dates]\n\n# log scale up to all-time max\n# so whole country will be green sometime\nvmin, vmax = [1,1], [covid[VARIABLE].max() for VARIABLE in VARIABLES]\n\nfig, axes = plt.subplots(1,2, figsize=(15, 10)) # create figure and axes for Matplotlib\nsubplots = list(zip(VARIABLES, axes, vmin, vmax))\nplt.figtext(.2, .16, 'Source: Italian government data, https:\/\/github.com\/pcm-dpc\/COVID-19', \n             fontsize=14, color='#333333')\n\ndef update(frame):\n    for VARIABLE, ax, vmin, vmax in subplots:\n        ax.set_yticks([]) # remove axes ticks\n        ax.set_xticks([])\n        ax.clear()\n        \n        mapdata2[frame].plot(column=VARIABLE, cmap=CMAP, linewidth=0.7, \n                            ax=ax, edgecolor='0.8',\n                            norm=colors.LogNorm(vmin=vmin, vmax=vmax))\n        for i,x in enumerate(mapdata2[frame].iterrows()):\n            if abs(x[1]['long'] - 12) < 6 and abs(x[1]['lat'] - 42) < 6:\n                ax.annotate(f'{x[1][VARIABLE]:.0f}', (x[1]['long']-.3, x[1]['lat']-.1))\n\n        ax.annotate(mapdata2[frame].iloc[0]['date'][:10], (7,36), fontsize=18)\n        ax.set_title(VARIABLE, \n                     fontdict={'fontsize': '25', 'fontweight' : '4'}, \n                     color='black')\n        \n\nsm = []\nfor VARIABLE, ax, vmin, vmax in subplots:\n\n    # Create colorbar legend\n    cm = plt.cm.ScalarMappable(cmap=CMAP, norm=colors.LogNorm(vmin=vmin, vmax=vmax))\n    sm.append(cm)\n    sm[-1].set_array([])# empty array for the data range, kaggle won't draw without\n    fig.colorbar(sm[-1], ax=ax, shrink=0.55)       # add the colorbar to the axes\n\nplt.tight_layout()\n\nanim = animation.FuncAnimation(fig, update, frames=len(dates), interval=1000, blit=False)\n\nHTML(anim.to_jshtml())","c6e6da23":"# save video\n!apt install -qq -y ffmpeg > \/dev\/null\nfrom matplotlib.animation import FFMpegWriter\nMAX_DATE = dates[-1]\nanim.save(f'italy_covid_regions_upto_{MAX_DATE}.mp4', dpi=96, writer=FFMpegWriter())","7de82e2d":"from io import StringIO\n# Population estmates for 2019 and area data, source: https:\/\/www.citypopulation.de\/en\/italy\/cities\/\npop_stats = pd.read_table(StringIO(\"\"\"region\tcapital\tarea\tpopulation\nAbruzzo\tAquila\t10795\t1311580\nBasilicata\tPotenza\t9992\t562869\nCalabria\tCatanzaro\t15080\t1947131\nCampania\tNapoli\t13595\t5801692\nEmilia-Romagna\tBologna\t22451\t4459477\nFriuli Venezia Giulia\tTrieste\t7907\t1215220\nLazio\tRoma\t17207\t5879082\nLiguria\tGenova\t5421\t1550640\nLombardia\tMilano\t23861\t10060574\nMarche\tAncona\t9366\t1525271\nMolise\tCampobasso\t4438\t305617\nPiemonte\tTorino\t25399\t4356406\nPuglia\tBari\t19363\t4029053\nSardegna\tCagliari\t24090\t1639591\nSicilia\tPalermo\t25707\t4999891\nToscana\tFirenze\t22993\t3729641\nTrento+Bolzano\tTrento\t13607\t1072276\nUmbria\tPerugia\t8456\t882015\nValle d'Aosta\tAosta\t3263\t125666\nVeneto\tVenezia\t18316\t4905854\n\"\"\"))\n\n\n# add data from Italian wikipedia for P.A.'s:\n#    https:\/\/it.wikipedia.org\/wiki\/Provincia_autonoma_di_Trento\n#    https:\/\/it.wikipedia.org\/wiki\/Provincia_autonoma_di_Bolzano\npop_stats=pop_stats.append(\n    pd.DataFrame({\n        'region':['P.A. Bolzano', 'P.A. Trento'], \n        'capital': ['Bolzano', 'Trento'], \n        'area':[7398, 6702], \n        'population': [533050, 541380] \n    }),\n    ignore_index=True\n)\n\npop_stats['density'] = pop_stats['population'] \/ pop_stats['area']\npop_stats = pop_stats.set_index('region')\npop_stats.sort_values('density', ascending=False).head()","809e41b1":"covid = pd.read_csv('.\/COVID-19\/dati-regioni\/dpc-covid19-ita-regioni.csv', parse_dates=True)\ncovid.rename(columns={'denominazione_regione':'region', 'data': 'date', \n                      'nuovi_positivi': 'Daily new cases', 'deceduti': 'Total deaths'}, inplace=True)\ncovid['date'] = pd.to_datetime(covid['date'])\ncovid.set_index(['region', 'date'], inplace=True)\ncovid.head()","ed891a56":"# get series in dataframe rows, show the number of days=columns\ndeaths = covid['Total deaths'].unstack()\nSTARTING_LEVEL = 10\ny = deaths[deaths > STARTING_LEVEL]\nN_days = deaths.shape[1]\nN_days ","4618af22":"# compute stats per 10000 population\ndeaths_per10k = 10000 * deaths.values \/ pop_stats['population'].loc[deaths.index].values.reshape(-1,1)\ndeaths_per10k = pd.DataFrame(deaths_per10k)\ndeaths_per10k.set_index(deaths.index, inplace=True)\nfor ind, row in deaths_per10k.iterrows():\n    deaths_per10k.loc[ind] = deaths_per10k.loc[ind].shift(-(len(row) - len(row[row>0])))\ndeaths_per10k.head()","95b46b12":"import plotly.graph_objs as go\nfrom plotly.offline import init_notebook_mode, iplot\ninit_notebook_mode()\n\ntraces = [go.Scatter(\n                    x = deaths.columns,\n                    y = row,\n                    mode = \"lines+markers\",\n                    name = region,\n                    # marker = dict(color = 'rgba(16, 112, 2, 0.8)'),\n         ) for region, row in deaths.iterrows()]\n\nlayout = dict(title=dict(text='Deaths in Italian regions since '+\n                         f'{str(covid.index.get_level_values(1).min())[:10]}',\n                         font={'size': 24}),\n              xaxis=dict(title= 'days',\n                         ticklen= 5,zeroline= False),\n              yaxis_type=\"log\",\n              legend=dict(x=1.01,y=.5,\n                          font=dict(size=10) ),\n              width=1200, height=800,\n              margin={'r': 180, 'l':0},\n             )\n\nfig1 = dict(data=traces, layout=layout)\niplot(fig1)","3d2ed4d4":"traces = [go.Scatter(\n                    x = deaths_per10k.columns,\n                    y = row,\n                    mode = \"lines+markers\",\n                    name = region,\n                    # marker = dict(color = 'rgba(16, 112, 2, 0.8)'),\n         ) for region, row in deaths_per10k.iterrows()]\n\nlayout['title']['text'] = f'Deaths in Italian regions per 10k population since {STARTING_LEVEL} deaths'\nfig2 = dict(data=traces, layout=layout)\niplot(fig2)","0e6fdf84":"import plotly, sys \n!conda install --quiet --yes --prefix {sys.prefix} -c plotly plotly-orca \nplotly.io.write_image(fig1, 'Deaths_by_region.png')\nplotly.io.write_image(fig2, f'Deaths_per_10k_by_region_since_{STARTING_LEVEL}_deaths.png')","58423f56":"!rm -rf COVID-19 ITA_adm None*.png","e530960b":"## Merge geodata and COVID data","90eb03b2":"\nThis notebook has three sections:\n\n- visualises COVID-19 data for Italy for the latest available date on province map,\n- animates the spread on region map,\n- plots absolute and per capita death graphs by region.\n\nItalian *regions* are composed of *provinces*.\n\nThe COVID-19 data comes from the Italian government GitHub repository at https:\/\/github.com\/pcm-dpc\/COVID-19 (updated daily as of Apr 8, 2020). The map data comes from UC Davis, it has outdated Sardegna province information, and has Trentino-Alto Adige as a single region. `folium` is used for province map, `matplotlib`'s `FuncAnimation` for the animation, and `plotly` for death graphs.","250ef0ed":"# COVID-19 animation by region\n","ee3ba2e9":"# Deaths growth by region, incl per capita","237c87d8":"# Latest COVID-19 map visualisation by province\n\nThis part draws latest total cases data for COVID-19 in Italy by province. Uses `folium`. ","3d6f39f8":"## Load and reproject geodata, normalize province naming","fde85b21":"## Load provincial cases data, show last date"}}