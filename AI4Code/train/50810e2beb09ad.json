{"cell_type":{"f4f21275":"code","281b099d":"code","6f104ebe":"code","ce8734c2":"code","09e91a80":"code","815f0657":"code","666bcffe":"code","be47aa5e":"code","bef78d09":"code","b6b8438d":"code","4c0d4ace":"code","9e35efb7":"code","0d75bf2f":"code","47e4210d":"code","eba4d51e":"code","2ffe9c9d":"code","de65ff26":"code","c9756d23":"code","61686891":"code","df9d16d9":"code","447d5055":"code","5042edf9":"code","eef505fd":"code","7e8ca375":"code","b6710dbb":"code","16b297ac":"code","2849c2f9":"code","feb695a4":"code","bbb66cb9":"code","f3d219bc":"code","39a4f85b":"code","bcea83b6":"code","3221ee0a":"code","289097de":"code","291c63d9":"code","ebfd9d5e":"code","a992b1fc":"code","871ab8e5":"code","5becb212":"code","b3b47443":"code","19cacfd0":"code","9a6e0d0e":"code","e6256f17":"code","d54bcbcc":"code","03396e1b":"code","a94f07fb":"code","33d1f1f4":"markdown","f017f733":"markdown","92c7aa5e":"markdown","c43d54d5":"markdown","3cf7fd0f":"markdown","6003bc9f":"markdown","0342a108":"markdown","7443b8ad":"markdown","b7ca25d4":"markdown","a6825fd8":"markdown","0c203c9e":"markdown","3eda667d":"markdown","31b561ba":"markdown","57136800":"markdown","b4bbbd17":"markdown","82b7f3ba":"markdown","f6319094":"markdown","74f5f3a6":"markdown","3f58a515":"markdown","f55b36c7":"markdown","52a453cc":"markdown","b5c3c16a":"markdown","b41a350e":"markdown","3d11c5f1":"markdown","620cb4dd":"markdown","17bcc2ed":"markdown","ab70599a":"markdown","eae08fcd":"markdown","27d42a00":"markdown","7f2f96ce":"markdown","4b5e87de":"markdown","18507df4":"markdown","f48b25ba":"markdown","1247726d":"markdown","d3864dc8":"markdown","e1e7d293":"markdown"},"source":{"f4f21275":"# This Python 3 environment comes with many helpful analytics libraries installed\n# It is defined by the kaggle\/python docker image: https:\/\/github.com\/kaggle\/docker-python\n# For example, here's several helpful packages to load in \n\nimport numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\nimport seaborn as sns\nimport matplotlib.pyplot as plt\n%matplotlib inline  \n\nimport time\nstart_time = time.time()\nfrom sklearn.model_selection import train_test_split\nimport sys, os, re, csv, codecs, numpy as np, pandas as pd\nnp.random.seed(32)\nos.environ[\"OMP_NUM_THREADS\"] = \"4\"\nfrom keras.preprocessing.text import Tokenizer\nfrom keras.preprocessing.sequence import pad_sequences\nfrom keras.layers import Dense, Input, LSTM, Embedding, Dropout, Activation, Conv1D, GRU\nfrom keras.layers import Bidirectional, GlobalMaxPool1D, MaxPooling1D, Add, Flatten\nfrom keras.layers import GlobalAveragePooling1D, GlobalMaxPooling1D, concatenate, SpatialDropout1D\nfrom keras.models import Model, load_model\nfrom keras import initializers, regularizers, constraints, optimizers, layers, callbacks\nfrom keras import backend as K\nfrom keras.engine import InputSpec, Layer\nfrom keras.optimizers import Adam, RMSprop\nfrom keras.callbacks import EarlyStopping, ModelCheckpoint, LearningRateScheduler\nfrom keras.layers import GRU, BatchNormalization, Conv1D, MaxPooling1D\n\nimport logging\nfrom sklearn.metrics import roc_auc_score\nfrom keras.callbacks import Callback\n\n# Input data files are available in the \"..\/input\/\" directory.\n# For example, running this (by clicking run or pressing Shift+Enter) will list the files in the input directory\n\nimport os\nprint(os.listdir(\"..\/input\"))\n\n# Any results you write to the current directory are saved as output.","281b099d":"tweets = pd.read_csv(\"..\/input\/clinton-trump-tweets\/tweets.csv\")\nembedding_path = \"..\/input\/fasttext-crawl-300d-2m\/crawl-300d-2M.vec\"\ntweets.head()","6f104ebe":"tweets.shape","ce8734c2":"embed_size = 300\nmax_features = 130000\nmax_len = 220\n\ntweets[\"text\"].fillna(\"no comment\")\nlist_classes = [\"toxic\", \"severe_toxic\", \"obscene\", \"threat\", \"insult\", \"identity_hate\"]\nraw_text = tweets[\"text\"].str.lower()\n","09e91a80":"tk = Tokenizer(num_words = max_features, lower = True)\ntk.fit_on_texts(raw_text)\ntweets[\"comment_seq\"] = tk.texts_to_sequences(raw_text)","815f0657":"tweets_pad_sequences = pad_sequences(tweets.comment_seq, maxlen = max_len)","666bcffe":"tweets_pad_sequences.shape","be47aa5e":"tweets_pad_sequences","bef78d09":"def get_coefs(word,*arr): return word, np.asarray(arr, dtype='float32')\nembedding_index = dict(get_coefs(*o.strip().split(\" \")) for o in open(embedding_path))","b6b8438d":"word_index = tk.word_index\nnb_words = min(max_features, len(word_index))\nembedding_matrix = np.zeros((nb_words, embed_size))\nfor word, i in word_index.items():\n    if i >= max_features: continue\n    embedding_vector = embedding_index.get(word)\n    if embedding_vector is not None: embedding_matrix[i] = embedding_vector","4c0d4ace":"model = load_model(\"..\/input\/bi-gru-lstm-cnn-poolings-fasttext\/best_model.hdf5\")","9e35efb7":"pred = model.predict(tweets_pad_sequences, batch_size = 1024, verbose = 1)","0d75bf2f":"pred.max()","47e4210d":"toxic_predictions = pd.DataFrame(columns=list_classes, data=pred)","eba4d51e":"toxic_predictions.head()","2ffe9c9d":"toxic_predictions['id'] = tweets['id'].values\ntoxic_predictions['handle'] = tweets['handle'].values\ntoxic_predictions['text'] = tweets['text'].values","de65ff26":"toxic_predictions.tail()","c9756d23":"Hillary_predictions = toxic_predictions[toxic_predictions['handle'] == 'HillaryClinton']\nTrump_predictions = toxic_predictions[toxic_predictions['handle'] == 'realDonaldTrump']","61686891":"Hillary_predictions[list_classes].describe()","df9d16d9":"Trump_predictions[list_classes].describe()","447d5055":"melt_df = pd.melt(toxic_predictions, value_vars=list_classes, id_vars='handle')","5042edf9":"melt_df.head()","eef505fd":"sns.violinplot(x='variable', y='value', hue='handle', data=melt_df)\nplt.show()","7e8ca375":"melt_df['value'] = np.clip(melt_df['value'].values, 0, 0.2)","b6710dbb":"sns.violinplot(x='variable', y='value', hue='handle', data=melt_df)\nplt.show()","16b297ac":"melt_df['value'] = np.clip(melt_df['value'].values, 0, 0.05)\nsns.violinplot(x='variable', y='value', hue='handle', data=melt_df)\nplt.show()","2849c2f9":"Hillary_predictions.loc[Hillary_predictions['toxic'].idxmax()]['text']","feb695a4":"print(Hillary_predictions.sort_values(by=['toxic'], ascending=False)['text'].head(10).values)","bbb66cb9":"print(Hillary_predictions.sort_values(by=['severe_toxic'], ascending=False)['text'].head(10).values)","f3d219bc":"print(Hillary_predictions.sort_values(by=['obscene'], ascending=False)['text'].head(10).values)","39a4f85b":"Hillary_predictions.loc[Hillary_predictions['threat'].idxmax()]['text']","bcea83b6":"print(Hillary_predictions.sort_values(by=['threat'], ascending=False)['text'].head(10).values)","3221ee0a":"Hillary_predictions.loc[Hillary_predictions['insult'].idxmax()]['text']","289097de":"print(Hillary_predictions.sort_values(by=['insult'], ascending=False)['text'].head(10).values)","291c63d9":"Hillary_predictions.loc[Hillary_predictions['identity_hate'].idxmax()]['text']","ebfd9d5e":"print(Hillary_predictions.sort_values(by=['identity_hate'], ascending=False)['text'].head(10).values)","a992b1fc":"Trump_predictions.loc[Trump_predictions['toxic'].idxmax()]['text']","871ab8e5":"print(Trump_predictions.sort_values(by=['toxic'], ascending=False)['text'].head(10).values)","5becb212":"print(Trump_predictions.sort_values(by=['severe_toxic'], ascending=False)['text'].head(10).values)","b3b47443":"print(Trump_predictions.sort_values(by=['obscene'], ascending=False)['text'].head(10).values)","19cacfd0":"Trump_predictions.loc[Trump_predictions['threat'].idxmax()]['text']","9a6e0d0e":"print(Trump_predictions.sort_values(by=['threat'], ascending=False)['text'].head(10).values)","e6256f17":"Trump_predictions.loc[Trump_predictions['insult'].idxmax()]['text']","d54bcbcc":"print(Trump_predictions.sort_values(by=['insult'], ascending=False)['text'].head(10).values)","03396e1b":"Trump_predictions.loc[Trump_predictions['identity_hate'].idxmax()]['text']","a94f07fb":"print(Trump_predictions.sort_values(by=['identity_hate'], ascending=False)['text'].head(10).values)","33d1f1f4":"Let's look at identity hate:","f017f733":"Seeems that Jeb really got under his skin!","92c7aa5e":"Let's take a closer look at the top 10 worst 'insult' tweets:","c43d54d5":"We see that there are a total of 6444 tweets, and as it will be shown below they are almost evenly distributed between Hillary and Trump. This may seem like a lot of tweets, but for text classification this would be a very small amount of data.","3cf7fd0f":"Seems that back then Fox News was not exactly his favorite TV network. \n\nAnd what about identity hate?","6003bc9f":"Severe toxic:","0342a108":"How about threats?","7443b8ad":"That one really made me LOL. And think. Is he mocking him for his \"identity\" of bing Jeb? Or mommy's boy? Or W's brother? Or a weakling? All of the above? So many choices  ...\n\nLet's take a closer look at the top 10 worst 'identity hate' tweets:","b7ca25d4":"Let's plot the distributions of various values for both Hillary and Trump tweets. We'll use 'violing plots', as they seem very visually intutive and easy to understand.","a6825fd8":"In other words, at nearly 1.0 probability the model seems pretty confident about the \"toxicity\" of some of the tweets.\n\nNow let's put the predictions into a dataframe, so we can have a better view of them and how they relate to the actual tweets.","0c203c9e":"Obscene:","3eda667d":"Now how about threats?","31b561ba":"We will embed words from these tweets into a word-vector space using one of the previously trained word embeddings. Here we use a 300-dimensional vector space that comes curtesy of FastText. We will also limit the length of text to 220 words. This is an overkill for tweets, but for general purpose it is rather small text length. The original was aimed at much longer text sizes, and this was a reasonable length for those purposes. The best embedding that we used in Toxic limited length to 900 words.","57136800":"We see that for each one of the categories the outliers really skew the distributions. Maybe if we clip them we can see how the \"main\" distributions behave:","b4bbbd17":"Nope, still no luck. Looks like the distributions are to some extent \"scale independant\". ","82b7f3ba":"Let's see what's the maximum probability for this model:","f6319094":"\n\nI've been wanting to play with this dataset for a while. I've also been wanting to try to see how do models built on [Toxic Comment Classification Challenge](https:\/\/www.kaggle.com\/c\/jigsaw-toxic-comment-classification-challenge\/) perform on non-competition \"real world\" data. Here I will just use one model that was built inside of a [kernel](https:\/\/www.kaggle.com\/tunguz\/bi-gru-lstm-cnn-poolings-fasttext). The kernel scores in the 0.984x AUC range. It's a respectable score, but well below the top solutions that scored in the 0.988x range. \n\n---- October 22 2018 Update - Added a few distribution plots and a more extensive lists of the most problematic tweets, 10 per topic. ----\n\n---- October 31 2018 Update - Added a few clarifications and explanations. ----","74f5f3a6":"Yeah, definitely insulting. On so many levels. I can't even ...","3f58a515":"Not really toxic, severely toxic, or obscene IMHO. Not very inspiring or humanlike either. As if a chatbot was coming up with these ...","f55b36c7":"This is one big 6444x220 array. We'll now need to construc an embedding index, that puts each one of the words into a 300-dimensional vector space:","52a453cc":"In order for our pretrained models to work, we need to transform the text here into the appropriate vectorized format.","b5c3c16a":"\n\nHow about the most insulting tweet?","b41a350e":"Massive tax increases? yeah, I can see how this could be viewed as threatening.\n\nLet's take a closer look at the top 10 worst 'threat' tweets:","3d11c5f1":"We also need to pad the tweets that are less than 220 words, which is essentially all of them.","620cb4dd":"Now, let's load the data and all the vector embeddings. ","17bcc2ed":"Still very skewed distributions. How about one more clipping?","ab70599a":"Hmm, that's interesting: seem the algorithm has marked Hillary's ReTweet of Trump's tweet. Seems like there is something deep going on here. Or the algorithm is just plain unreliable. \n\nLet's look at the top 10 \"hateful\" Hillary tweets:","eae08fcd":"Ouch. That's definitely below the belt, but in a more indirect kind of way. And yeah, insluting. Good job, predictive modeling!\n\nHere are the top 10 \"insults\"","27d42a00":"Now we'll load the actual trained model and make the predictions on our data.","7f2f96ce":"That's just weird: there is nothign toxic about it. The same tweet has been flagged as the most severly toxic and obscene tweet as well. Not very informative.\n\nBut let's take a closer look at the top 10 flagged tweets in each one of those categories.\n\nFirst toxic:","4b5e87de":"OK, let's move onto Trump. First, his most toxic tweet:","18507df4":"Meh, not really toxic. Seems like the word \"mad\", or the high frequency of special characters, have flagged this tweet as toxic. The same tweet was also marked as the top tweet in both \"severe toxic\" and \"obscene\" categories. \n\nNow let's look at \"threats\":","f48b25ba":"Yeah, not much going on there. As predicted with very low probability of this actually being a threat.","1247726d":"\nIn the end, this exercise shows both the strengths and limitations of algorithmic approach to toxic comment classification. Since the AUC score for the training sets is relatively high (almost 0.99 for  the top models), it is most likely that in the case human insight is even more relevant than for most other ML areas. Furthermore, even though we had a pretty large dataset to work with, it is very likely that in order to get even close to human level toxic text classification, we'd need several orders of magnitude larger training set, and\/or deeper natural text understanding models. ","d3864dc8":"Based on this summary statistics, it would seem that both of them score pretty low on average for all of the \"Toxic\" categories. However, there do seem to be a few notable \"highly probable\" problemeatic tweets in each one of the six categories, with notable exception of \"threat\". Which, I think, is a good thing. For what it's worth (not much at all, IMHO), Hillary's tweets seem to be, on the average, toxic, severaly toxic, and obscene, while Trump's tweets score higher on the average for threat, insult, and identity hate. \n\nLet's see what the \"worst offenders\" are in for both candidates. Let's start with the most toxic Hillary tweet.","e1e7d293":"What's Hillary's worst insult?"}}