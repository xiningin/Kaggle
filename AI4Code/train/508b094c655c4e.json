{"cell_type":{"38fb509d":"code","2b3aa06b":"code","5382b4e6":"code","547708b9":"code","d220fd42":"code","584a2767":"code","a0b746da":"code","88b7a602":"code","8f96b535":"code","c6d9a3a3":"code","24bb6fb7":"code","3fb79dfc":"code","e64e85bf":"code","ac4ea1c1":"code","dbe4ce9c":"code","43ffa60f":"code","e616371f":"code","8a3067f3":"code","dfbd3b4d":"code","4c65883d":"code","91e8f4d8":"code","3de1de68":"code","4ed8657c":"code","1f2bb041":"code","226e0418":"code","ed3d25eb":"code","7e47a68c":"code","a9c5a94c":"code","ad2a01d3":"code","f6e4a1fa":"code","17d3f8a6":"code","26235648":"code","0d1089f3":"code","764f5f27":"code","d5cdaefa":"code","d79b4656":"code","bbfd797a":"code","7e3b09cd":"code","cb2d5226":"code","c9aa3f4b":"code","d1616c0a":"code","c4b9b117":"code","645da853":"markdown","f715cc3a":"markdown","1148486b":"markdown","ef08cc73":"markdown","50b307e9":"markdown","4711b228":"markdown","1c3f2fad":"markdown","d2eaaba2":"markdown","22111598":"markdown","f4960859":"markdown","9303c96f":"markdown","9223626d":"markdown","81cdb745":"markdown","db1ad7e8":"markdown","4e63a370":"markdown","376cb301":"markdown","3c577046":"markdown","4319e442":"markdown","7fd3faff":"markdown","8aa4f412":"markdown","07b99921":"markdown","687cb313":"markdown","7532825f":"markdown","e81a7676":"markdown","1a446f37":"markdown","38d4bc3f":"markdown","0f77da5c":"markdown","9fb81f6a":"markdown","add8f3ba":"markdown","73cf5176":"markdown","d29a969a":"markdown","7e3d00e0":"markdown","dd248756":"markdown","b7ee7323":"markdown","88a6b5a3":"markdown","be8b0b34":"markdown","770d5ef9":"markdown","1aa6b209":"markdown"},"source":{"38fb509d":"\nimport numpy as np \nimport pandas as pd \nimport os\nimport matplotlib.pyplot as pl\nimport seaborn as sns\nimport warnings\nwarnings.filterwarnings('ignore')\ndata = pd.read_csv('..\/input\/insurance\/insurance.csv')\n","2b3aa06b":"data.describe()","5382b4e6":"data.head()","547708b9":"from sklearn.preprocessing import LabelEncoder\n#sex\nle = LabelEncoder()\nle.fit(data.sex.drop_duplicates()) \ndata.sex = le.transform(data.sex)\n# smoker or not\nle.fit(data.smoker.drop_duplicates()) \ndata.smoker = le.transform(data.smoker)\n#region\nle.fit(data.region.drop_duplicates()) \ndata.region = le.transform(data.region)","d220fd42":"data.corr()['charges'].sort_values(ascending=False)","584a2767":"f, ax = pl.subplots(figsize=(10, 8))\ncorr = data.corr()\nsns.heatmap(corr, mask=np.zeros_like(corr, dtype=np.bool), cmap=sns.diverging_palette(240,10,as_cmap=True),\n            square=True, ax=ax)","a0b746da":"f= pl.figure(figsize=(12,5))\n\nax=f.add_subplot(121)\nsns.distplot(data[\"charges\"],color='r',ax=ax)\nax.set_title('Distribution of charges for smokers & non-smokers')","88b7a602":"f= pl.figure(figsize=(12,5))\n\nax=f.add_subplot(121)\nsns.distplot(data[(data.smoker == 1)][\"charges\"],color='c',ax=ax)\nax.set_title('Distribution of charges for smokers')\n\nax=f.add_subplot(122)\nsns.distplot(data[(data.smoker == 0)]['charges'],color='b',ax=ax)\nax.set_title('Distribution of charges for non-smokers')","8f96b535":"\nsns.catplot(x=\"smoker\", kind=\"count\",hue = 'sex', palette=\"pink\", data=data)","c6d9a3a3":"sns.catplot(x=\"sex\", y=\"charges\", hue=\"smoker\",\n            kind=\"violin\", data=data, palette = 'magma')","24bb6fb7":"pl.figure(figsize=(12,5))\npl.title(\"Box plot for charges of women\")\nsns.boxplot(y=\"smoker\", x=\"charges\", data =  data[(data.sex == 1)] , orient=\"h\", palette = 'magma')","3fb79dfc":"pl.figure(figsize=(12,5))\npl.title(\"Box plot for charges of men\")\nsns.boxplot(y=\"smoker\", x=\"charges\", data =  data[(data.sex == 0)] , orient=\"h\", palette = 'rainbow')","e64e85bf":"pl.figure(figsize=(12,5))\npl.title(\"Distribution of age\")\nax = sns.distplot(data[\"age\"], color = 'g')","ac4ea1c1":"pl.figure(figsize=(12,5))\npl.title(\"Box plot for charges 18 years old smokers\")\nsns.boxplot(y=\"smoker\", x=\"charges\", data = data[(data.age == 18)] , orient=\"h\", palette = 'pink')","dbe4ce9c":"g = sns.jointplot(x=\"age\", y=\"charges\", data = data[(data.smoker == 0)],kind=\"kde\", color=\"m\")\ng.plot_joint(pl.scatter, c=\"w\", s=30, linewidth=1, marker=\"+\")\ng.ax_joint.collections[0].set_alpha(0)\ng.set_axis_labels(\"$X$\", \"$Y$\")\nax.set_title('Distribution of charges and age for non-smokers')","43ffa60f":"g = sns.jointplot(x=\"age\", y=\"charges\", data = data[(data.smoker == 1)],kind=\"kde\", color=\"c\")\ng.plot_joint(pl.scatter, c=\"w\", s=30, linewidth=1, marker=\"+\")\ng.ax_joint.collections[0].set_alpha(0)\ng.set_axis_labels(\"$X$\", \"$Y$\")\nax.set_title('Distribution of charges and age for smokers')","e616371f":"#non - smokers\nfrom bokeh.plotting import figure, show, output_file\np = figure(plot_width=500, plot_height=450)\np.circle(x=data[(data.smoker == 0)].age,y=data[(data.smoker == 0)].charges, size=7, line_color=\"navy\", fill_color=\"pink\", fill_alpha=0.9)\nshow(p)","8a3067f3":"#smokers\np = figure(plot_width=500, plot_height=450)\np.circle(x=data[(data.smoker == 1)].age,y=data[(data.smoker == 1)].charges, size=7, line_color=\"navy\", fill_color=\"red\", fill_alpha=0.9)\nshow(p)","dfbd3b4d":"sns.lmplot(x=\"age\", y=\"charges\", hue=\"smoker\", data=data, palette = 'inferno_r', size = 7)\nax.set_title('Smokers and non-smokers')","4c65883d":"pl.figure(figsize=(12,5))\npl.title(\"Distribution of bmi\")\nax = sns.distplot(data[\"bmi\"], color = 'green')","91e8f4d8":"pl.figure(figsize=(12,5))\npl.title(\"Distribution of charges for patients with BMI greater than 30\")\nax = sns.distplot(data[(data.bmi >= 30)]['charges'], color = 'm')","3de1de68":"pl.figure(figsize=(12,5))\npl.title(\"Distribution of charges for patients with BMI less than 30\")\nax = sns.distplot(data[(data.bmi < 30)]['charges'], color = 'b')","4ed8657c":"g = sns.jointplot(x=\"bmi\", y=\"charges\", data = data,kind=\"kde\", color=\"r\")\ng.plot_joint(pl.scatter, c=\"w\", s=30, linewidth=1, marker=\"+\")\ng.ax_joint.collections[0].set_alpha(0)\ng.set_axis_labels(\"$X$\", \"$Y$\")\nax.set_title('Distribution of bmi and charges')\n","1f2bb041":"pl.figure(figsize=(10,6))\nax = sns.scatterplot(x='bmi',y='charges',data=data,palette='magma',hue='smoker')\nax.set_title('Scatter plot of charges and bmi')\n\nsns.lmplot(x=\"bmi\", y=\"charges\", hue=\"smoker\", data=data, palette = 'magma', size = 8)","226e0418":"sns.catplot(x=\"children\", kind=\"count\", palette=\"ch:.25\", data=data, size = 6)","ed3d25eb":"sns.catplot(x=\"smoker\", kind=\"count\", palette=\"rainbow\",hue = \"sex\",\n            data=data[(data.children > 0)], size = 6)\nax.set_title('Smokers and non-smokers who have childrens')","7e47a68c":"from sklearn.linear_model import LinearRegression\nfrom sklearn.model_selection import train_test_split\nfrom sklearn.preprocessing import PolynomialFeatures\nfrom sklearn.metrics import r2_score,mean_squared_error\nfrom sklearn.ensemble import RandomForestRegressor","a9c5a94c":"x = data.drop(['charges'], axis = 1)\ny = data.charges\n\nx_train,x_test,y_train,y_test = train_test_split(x,y, random_state = 0)\nlr = LinearRegression().fit(x_train,y_train)\n\ny_train_pred = lr.predict(x_train)\ny_test_pred = lr.predict(x_test)\n\nprint(lr.score(x_test,y_test))","ad2a01d3":"X = data.drop(['charges','region'], axis = 1)\nY = data.charges\n\n\n\nquad = PolynomialFeatures (degree = 2)\nx_quad = quad.fit_transform(X)\n\nX_train,X_test,Y_train,Y_test = train_test_split(x_quad,Y, random_state = 0)\n\nplr = LinearRegression().fit(X_train,Y_train)\n\nY_train_pred = plr.predict(X_train)\nY_test_pred = plr.predict(X_test)\n\nprint(plr.score(X_test,Y_test))","f6e4a1fa":"poly_names=quad.get_feature_names(X.columns)\npoly_coef=plr.coef_\npoly_function=pd.DataFrame({\"name\":poly_names,\"coef\":poly_coef})","17d3f8a6":"forest = RandomForestRegressor(n_estimators = 100,\n                              criterion = 'mse',\n                              random_state = 1,\n                              n_jobs = -1)\nforest.fit(x_train,y_train)\nforest_train_pred = forest.predict(x_train)\nforest_test_pred = forest.predict(x_test)\n\nprint('MSE train data: %.3f, MSE test data: %.3f' % (\nmean_squared_error(y_train,forest_train_pred),\nmean_squared_error(y_test,forest_test_pred)))\nprint('R2 train data: %.3f, R2 test data: %.3f' % (\nr2_score(y_train,forest_train_pred),\nr2_score(y_test,forest_test_pred)))","26235648":"from sklearn.cluster import KMeans\nfrom yellowbrick.cluster import KElbowVisualizer\n\nfig = pl.figure(figsize=(12,8))\n\n# KNears Neighbors \n#df.head()\n#original_df.head()\n\nX = data\n\n# Instantiate the clustering model and visualizer\nmodel = KMeans()\nvisualizer = KElbowVisualizer(model, k=(2,10))\n\nvisualizer.fit(X)    # Fit the data to the visualizer\nvisualizer.poof()  ","0d1089f3":"kmeans = KMeans(n_clusters=4)  \nkmeans.fit(X)","764f5f27":"pd.DataFrame(kmeans.cluster_centers_,columns=data.columns)","d5cdaefa":"fig = pl.figure(figsize=(12,8))\n\npl.scatter(X.values[:,0], X.values[:,6], c=kmeans.labels_, cmap=\"Set1_r\", s=25)\npl.scatter(kmeans.cluster_centers_[:,0] ,kmeans.cluster_centers_[:,6], color='black', marker=\"x\", s=250)\npl.title(\"Kmeans Clustering \\n Finding Unknown Groups in the Population (Charges vs. Age)\", fontsize=16)\npl.show()","d79b4656":"#colorlist=['m', 'b', 'g', 'r']\nX['label']=kmeans.labels_\nfig = pl.figure(figsize=(12,8))\n\npl.scatter(X.values[:,2], X.values[:,6], c=X['label'], cmap=\"Set1_r\", s=25)\npl.scatter(kmeans.cluster_centers_[:,2] ,kmeans.cluster_centers_[:,6], color='black', marker=\"x\", s=250,label='Center')\npl.title(\"Kmeans Clustering \\n Finding Unknown Groups in the Population (BMI vs. Charges)\", fontsize=16)\npl.legend()\npl.show()","bbfd797a":"from mpl_toolkits.mplot3d import Axes3D","7e3b09cd":"\nthreedee = pl.figure().gca(projection='3d')\nthreedee.scatter(X[(X.smoker == 1)]['bmi'], X[(X.smoker == 1)]['age'], X[(X.smoker == 1)]['charges'],c=X[(X.smoker == 1)]['label'], cmap=\"Set1_r\")\nthreedee.set_xlabel('BMI')\nthreedee.set_ylabel('Age')\nthreedee.set_zlabel('Charges')\npl.show()\n","cb2d5226":"from sklearn.tree import DecisionTreeRegressor # Import Decision Tree \n# Create Decision Tree classifer object\nDTR = DecisionTreeRegressor(max_depth=4)\n\n# Train Decision Tree \nDTR = DTR.fit(x_train,y_train)\n\n#Predict the response for test dataset\ny_pred = DTR.predict(x_test)","c9aa3f4b":"pl.scatter(x_test['age'],y_test, color = \"red\")\npl.scatter(x_test['age'], y_pred, color = \"blue\")\npl.title(\"Truth(Red) or Predict (Blue) by age vs charges\")\npl.xlabel(\"age\")\npl.ylabel(\"charges\")\npl.show","d1616c0a":"from IPython.display import Image","c4b9b117":"print(DTR.score(x_test,y_test))","645da853":"A strong correlation between smoking and our patience.  Well. Let's investigate smoking in more detail.\n![![image.png](attachment:image.png)](https:\/\/media.giphy.com\/media\/l0ExdMHUDKteztyfe\/giphy.gif)","f715cc3a":"hummm. What's these two clusters in smokers' group, which doesn't have the same shape as non-smokers? (We will explore it later)","1148486b":"-**age**: age of primary beneficiary\n\n-**sex**: insurance contractor gender, female, male\n\n-**bmi**: Body mass index, providing an understanding of body, weights that are relatively high or low relative to height, objective index of body weight (kg \/ m ^ 2) using the ratio of height to weight, ideally 18.5 to 24.9\n\n-**children**: Number of children covered by health insurance \/ Number of dependents\n\n-**smoker**: Smoking\n\n-**region**: the beneficiary's residential area in the US, northeast, southeast, southwest, northwest.\n\n-**charges**: Individual medical costs billed by health insurance\n\n\n","ef08cc73":"You may scroll down to the page bottom for viewing the actual decision tree model :) as the picture is too large to display here~\n->Data Sources\n->DTR_VIZ\n->DTR.png","50b307e9":"Now we are going to predict the cost of treatment.\nLet's start with the usual linear regression.","4711b228":"Since we are primarily interested in the amount of costs see what posts are more correlated with charges. For a start, we will encode categorical features into numeriacal ones, i.e. sex can be encoded as 0:non-smoker and 1:smoker. That is also called **one hot encoding**.\n","1c3f2fad":"Did you find the  \"Elbow\"? This is where we have our optimal K ->4. It could be subjective sometimes, but we will use k=4 to have a try! ","d2eaaba2":"We now have the highest accuracy with the simpler model - Less is more. I hope you don't get bored reading this notebook and feel it acceptable as a exploratory reading for data analytics.","22111598":"We obtain the 4 clusters' average profile of customers (for now we will ignore region as it doesn't vary much)\n\nSome takeaway:\n\n\n1.   Group 0: Middle-age customers, tends to smoke -> mid to high medical cost\n2.   Group 1: Young customers, have 1 child on average, very unlikely to smoke -> ver low medical cost\n3.   Group 2: Middle age\/Elders, seldom smoke -> middle medical cost\n4.   Group 3: Middle-age customers, likely to smke, tends to overweight -> high medical cost\n\n\n\n","f4960859":"Good result. But we see a noticeable overfitting as the noticable gap between testing accuracy and training accuracy.","9303c96f":"Remember the two clusters we had on smokers? It seems that the above graph help us to explain, (red\uff09High BMI smoker group is more likely to have high medical cost than (green\/grey) Low BMI smoker group. So, let's meet at gym :)","9223626d":"In non-smokers, the cost of treatment increases with age. That makes sense. So take care of your health, friends!  In smoking people, we do not see such dependence.\nI think that it is not only in smoking but also in the peculiarities of the dataset. Such a strong effect of Smoking on the cost of treatment would be more logical to judge having a set of data with a large number of records and signs.\nBut we work with what we have!\nLet's pay attention to bmi.Are we on a diet for nothing?\n![![image.png](attachment:image.png)](https:\/\/media.giphy.com\/media\/co9IXVaipZ0Yg\/giphy.gif)","81cdb745":"Finally the most lazy model I would like to use\uff01Decision Tree Regressor - it split in every node with a condition - Yes or No to predict the final medical cost for each customers","db1ad7e8":"Will they work? Let's see!","4e63a370":"Let's pay attention to children. First, let's see how many children our customers have.\n","376cb301":"It seems the Kaggle doesn't support a library I used. Nevermind, let's import it from my local program!\n![](http:\/\/)","3c577046":"![![image.png](attachment:image.png)](https:\/\/media.giphy.com\/media\/7vUwiZ4MJRNDy\/giphy.gif)","4319e442":"Already good. Our model predicts well the cost of treatment of patients. I think we could limit ourselves to creating two or three polynomial features, but the data set is so small, so we went the easy way.\nAnd finally try RandomForestRegressor. I've never used this algorithm in regression analysis.","7fd3faff":"Oh oh oh.....\n![![image.png](attachment:image.png)](https:\/\/www.az-jenata.bg\/media\/az-jenata\/files\/galleries\/640x480\/4c0373972cdd156a2e2c008dc5c0a93a.jpg)\nBut I am glad that non-smoking parents are much more!","8aa4f412":"Patients with BMI above 30 spend more on treatment!","07b99921":"<img src=\"https:\/\/media3.giphy.com\/media\/L3nWlmgyqCeU8\/giphy.gif\" width=\"250px\"\/>","687cb313":"Now let's pay attention to the age of the patients.  First, let's look at how age affects the cost of treatment, and also look at patients of what age more in our data set.","7532825f":"Please note that women are coded with the symbol \" 0 \"and men - \"1\". Thus we can notice that more male smokers than women smokers. It can be assumed that the total cost of treatment in men will be more than in women, given the impact of smoking. Maybe we'll check it out later.\nAnd some more useful visualizations. ","e81a7676":"18 years old - a very young age. Does smoking affect the cost of treatment at this age?\n","1a446f37":"Not bad for such a lazy implementation, even without data normalization:D\nAfter all, the data will not always be so \"good\". So don't forget to pre-process the data.\nI'll show you all this later when I try to implement my own linear regression. So don't be mad at me please :)\nNow let's add polynomial signs. And look at the result.","38d4bc3f":"We have patients under 20 in our data set. Im 18 years old. This is the minimum age of patients in our set. The maximum age is 64 years. \nMy personal interest is whether there are smokers among patients 18 years.","0f77da5c":"As the K need to be pre-defined, we first explore how well is the algorithm in spliting our current customers and what's the optimal K to split.","9fb81f6a":"HI ~ This is where we will use machine learning techniques (it's simple! I promise>< ) to predict and learn about customer's medical cost that they have on their health insurance policies. \nWe will look into three methods to play around the data!We will explore only the less-sensitive information, such as BMI, region, age, number of children and smoking habit. \n","add8f3ba":"We will explore three techniques:\n* Linear Regression\n* K-means Clustering\n* Decision Tree","73cf5176":"Still, smoking exhibits a strong correlation among insurance beneficiaries.","d29a969a":"There's something insanely beautiful about this distribution, isn't there?  \nThe average BMI in patients is 30. How about yours?\n![![image.png](attachment:image.png)](http:\/\/1j4g1pasf991x0osxuqz6d10.wpengine.netdna-cdn.com\/wp-content\/uploads\/2017\/03\/BMI-CHART-1024x791.png)\nWith a value equal to 30 starts obesity.  I also calculated my BMI and now I can safely drink bubble tea today. Let's start to explore!\nFirst, let's look at the distribution of costs in patients with BMI greater than 30 and less than 30","7e3d00e0":"It seems that regardless of gender, the medical cost is highly related to smoking habbit with similiar patterns in male and female group","dd248756":"Most patients do not have children. Perfectly that some have 5 children! Children are happiness:)\nI wonder if people who have children smoke.","b7ee7323":"Smoking patients spend more on treatment. But there is a feeling that the number of non-smoking patients is greater. Going to check it.","88a6b5a3":"Now let's look at KMeans. This is an algorithm focusing on clustering similiar data points into K-groups. Let's use it to see who are our customers in a macroview.","be8b0b34":"![![image.png](attachment:image.png)](https:\/\/media.giphy.com\/media\/Nm8ZPAGOwZUQM\/giphy.gif)\n\nOh. As we can see, even at the age of 18 smokers spend much more on treatment than non-smokers. Among non-smokers we are seeing some \" tails.\" I can assume that this is due to serious diseases or accidents.\nNow let's see how the cost of treatment depends on the age of smokers and non-smokers patients.","770d5ef9":"Wow, the prediction (blue) and the real charges(red) are quite close for each datapoint","1aa6b209":"Let's look at the correlation between charges and other beneficiary information"}}