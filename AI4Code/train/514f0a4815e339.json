{"cell_type":{"4b1bff64":"code","ae785821":"code","a5e5c2bd":"code","07da9470":"code","b773ad9f":"code","505c8a40":"code","ca8abf6b":"code","66481bec":"code","0ab8bb22":"code","ba3e01a5":"code","c4c7c9f9":"code","8a5d8b98":"code","61bbda58":"code","8401f2fd":"code","ac31c10f":"code","37db8ea5":"code","b668e8e8":"code","4303e39b":"code","dee041d7":"code","c4b68eb8":"code","aba4b86a":"code","969bc9bd":"code","d3b8561c":"code","656dd90d":"code","2bcf80db":"code","ec6316ce":"code","a5e613b6":"code","0d39b60b":"code","a5c2d4f1":"code","1040c4ba":"code","d073b6ce":"code","62caee5e":"code","2cf4a353":"code","210e3374":"code","4ec22fdd":"code","08167fb9":"code","53f47253":"code","bb816dd7":"code","640150d8":"code","381915e2":"code","6941b362":"code","eeb01cc0":"code","7d1f0917":"code","2396c7d0":"markdown","100e402b":"markdown","9145d323":"markdown","dbb35641":"markdown","75d2c7db":"markdown","5ae92e53":"markdown","7479b750":"markdown","13e678b3":"markdown","55a0f4d1":"markdown","cbabdceb":"markdown"},"source":{"4b1bff64":"%reload_ext autoreload\n%autoreload 2\n%matplotlib inline","ae785821":"from fastai import *\nfrom fastai.vision import *\nfrom fastai.callbacks.hooks import *","a5e5c2bd":"path = Path('\/kaggle\/input\/repository\/alexgkendall-SegNet-Tutorial-bb68b64\/CamVid')","07da9470":"path.ls()","b773ad9f":"fnames = get_image_files(path\/'val')\nfnames[:3]","505c8a40":"lbl_names = get_image_files(path\/'valannot')\nlbl_names[:3]","ca8abf6b":"img_f = fnames[0]\nimg = open_image(img_f)\nimg.show(figsize=(5,5))","66481bec":"def get_y_fn(x): return Path(str(x.parent)+'annot')\/x.name\n\ncodes = array(['Sky', 'Building', 'Pole', 'Road', 'Sidewalk', 'Tree',\n    'Sign', 'Fence', 'Car', 'Pedestrian', 'Cyclist', 'Void'])","0ab8bb22":"mask = open_mask(get_y_fn(img_f))\nmask.show(figsize=(5,5), alpha=1)","ba3e01a5":"src_size = np.array(mask.shape[1:])\nsrc_size,mask.data","c4c7c9f9":"bs,size = 8,src_size\/\/2","8a5d8b98":"src = (SegmentationItemList.from_folder(path)\n       .split_by_folder(valid='val')\n       .label_from_func(get_y_fn, classes=codes))","61bbda58":"data = (src.transform(get_transforms(), tfm_y=True)\n        .databunch(bs=bs, num_workers=0)\n        .normalize(imagenet_stats))","8401f2fd":"data.show_batch(2, figsize=(10,7))","ac31c10f":"name2id = {v:k for k,v in enumerate(codes)}\nvoid_code = name2id['Void']\n\ndef acc_camvid(input, target):\n    target = target.squeeze(1)\n    mask = target != void_code\n    return (input.argmax(dim=1)[mask]==target[mask]).float().mean()","37db8ea5":"metrics=acc_camvid\nwd=1e-2","b668e8e8":"learn = unet_learner(data, models.resnet34, metrics=metrics, wd=wd, model_dir='\/kaggle\/working\/models')","4303e39b":"lr_find(learn)\nlearn.recorder.plot()","dee041d7":"lr=2e-3","c4b68eb8":"learn.fit_one_cycle(1, slice(lr), pct_start=0.8) # 10","aba4b86a":"learn.save('stage-1')","969bc9bd":"del learn\ngc.collect()\n# learn.destroy() # \u91ca\u653e\u5185\u5bb9\uff0c \u4f46\u662f1.0.45\u7248\u672c\u91cc\u6ca1\u6709\u8fd9\u4e2amethod\n# https:\/\/www.kaggle.com\/danielliao\/fastai-tutorial-13-dl-on-a-shoestring\n\nlearn = unet_learner(data, models.resnet34, metrics=metrics, wd=wd, model_dir='\/kaggle\/working\/models')\nlearn.load('stage-1',with_opt=False);","d3b8561c":"learn.unfreeze()","656dd90d":"lrs = slice(lr\/100,lr)","2bcf80db":"learn.fit_one_cycle(1, lrs, pct_start=0.8) # 12","ec6316ce":"learn.save('stage-2');","a5e613b6":"del learn\ngc.collect()\n# learn.destroy() # \u91ca\u653e\u5185\u5bb9\uff0c \u4f46\u662f1.0.45\u7248\u672c\u91cc\u6ca1\u6709\u8fd9\u4e2amethod\n# https:\/\/www.kaggle.com\/danielliao\/fastai-tutorial-13-dl-on-a-shoestring","0d39b60b":"size = src_size\nbs=4","a5c2d4f1":"data = (src.transform(get_transforms(), size=size, tfm_y=True)\n        .databunch(bs=bs, num_workers=0) # \u8bbe\u7f6e\u4e3a0\u5f88\u5173\u952e\n        .normalize(imagenet_stats))","1040c4ba":"learn = unet_learner(data, models.resnet34, metrics=metrics, wd=wd, model_dir=\"\/kaggle\/working\/models\").load('stage-2');","d073b6ce":"lr_find(learn)\nlearn.recorder.plot()","62caee5e":"lr=1e-3","2cf4a353":"learn.fit_one_cycle(1, slice(lr), pct_start=0.8)  #10","210e3374":"learn.save('stage-1-big') # \u8fd9\u91cc\u662fGPU disk \u589e\u52a0\u7684\u539f\u56e0, \n# at Console: go to \/kaggle\/working\/models\/ rm stage-1.pth \u53ef\u4ee5\u91ca\u653eGPU disk ","4ec22fdd":"del learn\ngc.collect()\n# learn.destroy() # \u91ca\u653e\u5185\u5bb9\uff0c \u4f46\u662f1.0.45\u7248\u672c\u91cc\u6ca1\u6709\u8fd9\u4e2amethod\n# https:\/\/www.kaggle.com\/danielliao\/fastai-tutorial-13-dl-on-a-shoestring\n\nlearn = unet_learner(data, models.resnet34, metrics=metrics, wd=wd, model_dir='\/kaggle\/working\/models')\nlearn.load('stage-1-big',with_opt=False);\n# learn.load('stage-1-big');","08167fb9":"learn.unfreeze()","53f47253":"lrs = slice(lr\/1000,lr\/10)","bb816dd7":"learn.fit_one_cycle(1, lrs) # 10","640150d8":"learn.save('stage-2-big')","381915e2":"del learn\ngc.collect()\n# learn.destroy() # \u91ca\u653e\u5185\u5bb9\uff0c \u4f46\u662f1.0.45\u7248\u672c\u91cc\u6ca1\u6709\u8fd9\u4e2amethod\n# https:\/\/www.kaggle.com\/danielliao\/fastai-tutorial-13-dl-on-a-shoestring\n\nlearn = unet_learner(data, models.resnet34, metrics=metrics, wd=wd, model_dir='\/kaggle\/working\/models')\nlearn.load('stage-2-big',with_opt=False);\n# learn.load('stage-2-big');","6941b362":"learn.show_results(rows=3, figsize=(9,11))","eeb01cc0":"# start: 480x360","7d1f0917":"learn.summary()","2396c7d0":"<h1>Table of Contents<span class=\"tocSkip\"><\/span><\/h1>\n<div class=\"toc\"><ul class=\"toc-item\"><li><span><a href=\"#Camvid\u6570\u636e\u7684\u56fe\u7247\u9694\u79bbImage-Segmentation\" data-toc-modified-id=\"Camvid\u6570\u636e\u7684\u56fe\u7247\u9694\u79bbImage-Segmentation-1\"><span class=\"toc-item-num\">1&nbsp;&nbsp;<\/span>Camvid\u6570\u636e\u7684\u56fe\u7247\u9694\u79bbImage Segmentation<\/a><\/span><\/li><li><span><a href=\"#\u6570\u636e-Data\" data-toc-modified-id=\"\u6570\u636e-Data-2\"><span class=\"toc-item-num\">2&nbsp;&nbsp;<\/span>\u6570\u636e Data<\/a><\/span><\/li><li><span><a href=\"#\u6570\u636e\u96c6-Datasets\" data-toc-modified-id=\"\u6570\u636e\u96c6-Datasets-3\"><span class=\"toc-item-num\">3&nbsp;&nbsp;<\/span>\u6570\u636e\u96c6 Datasets<\/a><\/span><\/li><li><span><a href=\"#\u6a21\u578b-Model\" data-toc-modified-id=\"\u6a21\u578b-Model-4\"><span class=\"toc-item-num\">4&nbsp;&nbsp;<\/span>\u6a21\u578b Model<\/a><\/span><\/li><li><span><a href=\"#\u73a9\u70b9\u5927\u7684-Go-Big\" data-toc-modified-id=\"\u73a9\u70b9\u5927\u7684-Go-Big-5\"><span class=\"toc-item-num\">5&nbsp;&nbsp;<\/span>\u73a9\u70b9\u5927\u7684 Go Big<\/a><\/span><\/li><li><span><a href=\"#\u603b\u7ed3\" data-toc-modified-id=\"\u603b\u7ed3-6\"><span class=\"toc-item-num\">6&nbsp;&nbsp;<\/span>\u603b\u7ed3<\/a><\/span><\/li><\/ul><\/div>","100e402b":"One Hundred Layer Tiramisu \u8bba\u6587\u91c7\u7528\u4e86\u7b80\u6613\u7248\u7684Camvid\u6570\u636e\uff08\u66f4\u5c0f\u56fe\u7247\u66f4\u5c11\u5206\u7c7b\uff09\u8fd9\u91cc\u662f\u6a21\u578b\u6240\u5728repo:\n\n    git clone https:\/\/github.com\/alexgkendall\/SegNet-Tutorial.git\n    \nRepo\u4e2d\u7684\u6570\u636e\u88ab\u4e0a\u4f20\u5230\u4e86Kaggle\uff0c\u65b9\u4fbf\u6211\u4eec\u4f7f\u7528\u3002","9145d323":"\u672c\u8282\u8981\u6c42Kaggle kernel \u8dd1\u5f88\u957f\u65f6\u95f4\uff0c\u4f60\u53ef\u4ee5uncommenting the learn.fit_one_cycle \u4ee3\u7801\u8bd5\u8bd5\u3002\n\u4f46\u6211\u5c1d\u8bd5\u7684\u7ed3\u679c\u662fGPU\u5185\u5b58\u4e0d\u591f\u3002","dbb35641":"## \u603b\u7ed3","75d2c7db":"## Camvid\u6570\u636e\u7684\u56fe\u7247\u9694\u79bbImage Segmentation","5ae92e53":"## \u6570\u636e\u96c6 Datasets","7479b750":"\u4f60\u53ef\u80fd\u9700\u8981\u91cd\u542f\u5185\u6838\uff0c\u76f4\u63a5\u8df3\u5230\u8fd9\u4e00\u884c\uff0c\u7ee7\u7eed\u8fd0\u884c\u4ee3\u7801\u3002\u540c\u65f6\u964d\u4f4e `bs` \u7684\u503c","13e678b3":"## \u73a9\u70b9\u5927\u7684 Go Big","55a0f4d1":"## \u6a21\u578b Model","cbabdceb":"## \u6570\u636e Data"}}