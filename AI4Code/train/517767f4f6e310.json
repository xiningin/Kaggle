{"cell_type":{"4c77d307":"code","a5d056d0":"code","87abed32":"code","6f1d2884":"code","e0b28889":"code","9c593f7b":"code","38400b06":"code","cfacef5a":"code","fac49fd4":"code","56e1253f":"code","446b5a1f":"code","af600e65":"code","26d1f0e8":"code","b6b23515":"code","7317eff3":"code","43d99638":"code","65be2ce4":"code","81b2436c":"code","5dd84166":"code","61861093":"code","8ca3df32":"markdown"},"source":{"4c77d307":"import numpy as np\nimport pandas as pd\n\nfrom sklearn.metrics import roc_auc_score\n        \nimport tensorflow as tf\nimport tensorflow.keras.backend as K\nfrom tensorflow.keras.layers import Input, Dense\nfrom sklearn.model_selection import KFold","a5d056d0":"train = pd.read_csv(\n    '\/kaggle\/input\/riiid-test-answer-prediction\/train.csv',\n    usecols=[\n        'timestamp', \n        'user_id', \n        'content_id', \n        'user_answer', \n        'answered_correctly', \n        'prior_question_elapsed_time',\n        'prior_question_had_explanation'\n    ],\n       dtype={\n           'timestamp': 'int64',\n           'user_id': 'int32',\n           'content_id': 'int16',\n           'user_answer': 'int8',\n           'answered_correctly': 'int8',\n           'prior_question_elapsed_time': 'float32', \n           'prior_question_had_explanation': 'boolean'\n       }\n)\ntrain = train.sort_values(['timestamp'], ascending=True)\nquestions = pd.read_csv('\/kaggle\/input\/riiid-test-answer-prediction\/questions.csv')\nlectures = pd.read_csv('\/kaggle\/input\/riiid-test-answer-prediction\/lectures.csv')","87abed32":"train = train.loc[train['answered_correctly'] != -1].reset_index(drop=True)\ntrain","6f1d2884":"train['prior_question_had_explanation'] = train['prior_question_had_explanation'].fillna(value = False).astype(bool)\ntrain","e0b28889":"del train['timestamp']","9c593f7b":"features_df = train.iloc[:int(9 \/10 * len(train))]\ntrain_df = train.iloc[int(9 \/10 * len(train)):]","38400b06":"grouped_by_user_df = features_df.groupby('user_id')\nuser_answers_df = grouped_by_user_df.agg({'answered_correctly': ['mean', 'count', 'std', 'median', 'skew', 'var']}).copy()\nuser_answers_df.columns = ['mean_user_accuracy', 'questions_answered', 'std_user_accuracy', 'median_user_accuracy', 'skew_user_accuracy', 'var_user_accuracy']","cfacef5a":"grouped_by_content_df = features_df.groupby('content_id')\ncontent_answers_df = grouped_by_content_df.agg({'answered_correctly': ['mean', 'count', 'std', 'median', 'skew', 'var']}).copy()\ncontent_answers_df.columns = ['mean_accuracy', 'question_asked', 'std_accuracy', 'median_accuracy', 'skew_accuracy', 'var_accuracy']","fac49fd4":"import gc\ndel features_df\ndel grouped_by_user_df\ndel grouped_by_content_df\n\ngc.collect()","56e1253f":"train_df = train_df.merge(user_answers_df, how='left', on='user_id')\ntrain_df = train_df.merge(content_answers_df, how='left', on='content_id')\ntrain_df","446b5a1f":"features = [\n    'mean_user_accuracy', \n    'questions_answered',\n    'std_user_accuracy', \n    'median_user_accuracy',\n    'skew_user_accuracy',\n    'var_user_accuracy',\n    'mean_accuracy', \n    'question_asked',\n    'std_accuracy', \n    'median_accuracy',\n    'prior_question_elapsed_time', \n    'prior_question_had_explanation',\n    'skew_accuracy',\n    'var_accuracy'\n]\ntarget = 'answered_correctly'","af600e65":"train_df = train_df[features + [target]]\ntrain_df","26d1f0e8":"train_df = train_df.replace([np.inf, -np.inf], np.nan)\ntrain_df = train_df.fillna(0)\ntrain_df","b6b23515":"train_df['prior_question_had_explanation'] = train_df['prior_question_had_explanation'].astype(np.int8)\ntrain_df","7317eff3":"def create_model():\n    model = tf.keras.Sequential([\n        tf.keras.layers.Input(14),\n        tf.keras.layers.BatchNormalization(),\n        tf.keras.layers.Dense(100, activation=\"relu\"),\n        tf.keras.layers.BatchNormalization(),\n        tf.keras.layers.Dropout(0.5),\n        tf.keras.layers.Dense(20, activation=\"relu\"),\n        tf.keras.layers.BatchNormalization(),\n        tf.keras.layers.Dropout(0.2),\n        tf.keras.layers.Dense(1, activation=\"sigmoid\")\n    ])\n    model.compile(optimizer='adam', loss=\"binary_crossentropy\", metrics=['accuracy'])\n    return model","43d99638":"res = pd.DataFrame()\nres['row_id'] = [i for i in range(9927130)]\nres.loc[:, ['answered_correctly']] = 0\nmodels = []\n\nfor n, (tr, te) in enumerate(KFold(n_splits=5, random_state=666, shuffle=True).split(train_df[target])):\n    print(f'Fold {n}')\n    \n    model = create_model()\n    \n    model.fit(\n        train_df[features].values[tr],\n        train_df[target].values[tr],\n        validation_split=0.2,\n        epochs=50, \n        batch_size=2048\n    )\n\n    res.loc[te, ['answered_correctly']] = model.predict(train_df[features].values[te])\n    models.append(model)","65be2ce4":"print('NN score: ', roc_auc_score(train_df[target].values, res[target].values))","81b2436c":"import riiideducation\n\nenv = riiideducation.make_env()","5dd84166":"iter_test = env.iter_test()","61861093":"for (test_df, sample_prediction_df) in iter_test:\n    y_preds = []\n    test_df = test_df.merge(user_answers_df, how = 'left', on = 'user_id')\n    test_df = test_df.merge(content_answers_df, how = 'left', on = 'content_id')\n    test_df['prior_question_had_explanation'] = test_df['prior_question_had_explanation'].fillna(value = False).astype(bool)\n    test_df['prior_question_had_explanation'] = test_df['prior_question_had_explanation'].astype(np.int8)\n    test_df = test_df.replace([np.inf, -np.inf], np.nan)\n    test_df.fillna(value=0, inplace = True)\n\n    for model in models:\n        y_pred = model.predict(test_df[features].values)\n        y_preds.append(y_pred)\n\n    y_preds = sum(y_preds) \/ len(y_preds)\n    test_df['answered_correctly'] = y_preds\n    env.predict(test_df.loc[test_df['content_type_id'] == 0, ['row_id', 'answered_correctly']])","8ca3df32":"<h1><center>Riiid! Answer Correctness Prediction. Keras NN Model.<\/center><\/h1>\n\n<center><img src=\"https:\/\/www.riiid.co\/assets\/opengraph.png\"><\/center>"}}