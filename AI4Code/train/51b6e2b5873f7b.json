{"cell_type":{"23485ba8":"code","86da0878":"code","82c201a1":"code","b9301d12":"code","ceeecb53":"code","5d3ec6f1":"code","411604b7":"code","f2c25715":"code","396c8287":"code","69dc385b":"code","6b941419":"code","8f70c47e":"code","9495d397":"code","0e2c6994":"code","f6ca7ddd":"code","f09ba3fa":"code","e61f898d":"code","20177809":"code","83fb7337":"code","f1ad2b2c":"code","c2778393":"code","b59c843f":"code","c695eb64":"code","535eebe2":"code","db8de904":"markdown","d8d9b76b":"markdown","d2d631fc":"markdown","2bc15782":"markdown","415e3934":"markdown","26acc875":"markdown","ce1228c0":"markdown","c4c9188e":"markdown","1837212e":"markdown","3a4e136e":"markdown","9f5012ce":"markdown","bbd22f2e":"markdown","c5dbfa6e":"markdown","c5439b1d":"markdown","2e23eb66":"markdown","97358533":"markdown","db833a5a":"markdown","6d2b1af7":"markdown","07dd337e":"markdown","91d049bf":"markdown","420c1922":"markdown"},"source":{"23485ba8":"# Importing dependencies\n\nfrom sklearn.model_selection import KFold, train_test_split\n#import cudf\n#from cuml import SVR\nimport numpy as np\nimport pandas as pd\nimport matplotlib.pyplot as plt\nimport pandas as pd\nimport seaborn as sns\n#import joypy\n\nfrom tqdm.notebook import tqdm\nfrom glob import glob\nimport gc\n\nimport nilearn as nl\nimport nilearn.plotting as nlplt\nimport nibabel as nib\n\nimport h5py\n\nimport lightgbm as lgb\n\nfrom scipy.stats import skew, kurtosis\n\nimport os, random\n\nimport tensorflow as tf\nfrom tensorflow.keras.models import Model\nfrom tensorflow.keras.layers import Input, Dense\n\nfrom tensorflow.keras.utils import Sequence","86da0878":"# Loading train scores\n\nMAIN_DATA_PATH = '\/kaggle\/input\/trends-assessment-prediction\/'\n\ntrain_scores_df = pd.read_csv(MAIN_DATA_PATH + 'train_scores.csv')\nicn_numbers_df = pd.read_csv(MAIN_DATA_PATH + 'ICN_numbers.csv')\nloading_df = pd.read_csv(MAIN_DATA_PATH + 'loading.csv')\nfnc_df = pd.read_csv(MAIN_DATA_PATH + 'fnc.csv')\nprint('Train Scores')\nprint(train_scores_df.head())\nprint('ICN Numbers')\nprint(icn_numbers_df.head())\nprint('Loading')\nprint(loading_df.head())\nprint('FNC')\nprint(fnc_df.head())","82c201a1":"# Plot the distribution of the target variables\n\nfig, ax = plt.subplots(1, 5, figsize=(20, 5))\n\nsns.distplot(train_scores_df['age'], ax=ax[0])\nax[0].set_title('Age')\n\nsns.distplot(train_scores_df['domain1_var1'], ax=ax[1])\nax[1].set_title('Domain 1 - Var 1')\n\nsns.distplot(train_scores_df['domain1_var2'], ax=ax[2])\nax[2].set_title('Domain 1 - Var 2')\n\nsns.distplot(train_scores_df['domain2_var1'], ax=ax[3])\nax[3].set_title('Domain 2 - Var 1')\n\nsns.distplot(train_scores_df['domain2_var2'], ax=ax[4])\nax[4].set_title('Domain 2 - Var 2')\n\nfig.suptitle('Target distributions', fontsize=14)","b9301d12":"# Compute statistics\n\nprint(\"Kurtosis (Fisher's definition)\")\ntrain_scores_df.kurtosis()","ceeecb53":"round(train_scores_df.isna().sum() \/ len(train_scores_df) * 100, 2)","5d3ec6f1":"train_scores_df.fillna(train_scores_df.median(), inplace=True)\ntrain_scores_df.isna().sum()","411604b7":"loading_df.head()","f2c25715":"targets = loading_df.columns[1:]\n\nplt.figure(figsize=(16,10), dpi= 80)\nfig, axes = joypy.joyplot(loading_df, column=list(targets), ylim='own', figsize=(14,10))\n\n# Decoration\nplt.title('Source-based morphometry loadings distribution', fontsize=22)\nplt.show()","396c8287":"features_df = pd.merge(train_scores_df, loading_df, on=['Id'], how='left')\nfeatures_df.head()","69dc385b":"fig, ax = plt.subplots(figsize=(20, 20))\ncols = features_df.columns[1:]\nsns.heatmap(features_df[cols].corr(), annot=True, cmap='RdYlGn', ax=ax)","6b941419":"fnc_df.head()","8f70c47e":"# No NaN values in the DataFrame\n\nfnc_df.isna().sum().sum()","9495d397":"features_df = pd.merge(features_df, fnc_df, how='left', on='Id')\nfeatures_df.head()","0e2c6994":"!wget https:\/\/github.com\/Chaogan-Yan\/DPABI\/raw\/master\/Templates\/ch2better.nii","f6ca7ddd":"mask_filename = '..\/input\/trends-assessment-prediction\/fMRI_mask.nii'\nsmri_filename = 'ch2better.nii'\n\nmask_niimg = nl.image.load_img(mask_filename)\n\ndef load_subject(filename, mask_niimg):\n    subject_data = None\n    \n    with h5py.File(filename, 'r') as f:\n        subject_data = f['SM_feature'][()]\n        \n    subject_data = np.moveaxis(subject_data, [0, 1, 2, 3], [3, 2, 1, 0])\n    subject_niimg = nl.image.new_img_like(mask_niimg, subject_data, affine=mask_niimg.affine, copy_header=True)\n    \n    return subject_niimg ","f09ba3fa":"fMRI_train_data_path = '..\/input\/trends-assessment-prediction\/fMRI_train\/'\nfilenames = random.choices(os.listdir(fMRI_train_data_path), k=4)","e61f898d":"for filename in filenames:\n    subject_filename = os.path.join(fMRI_train_data_path, filename)\n    subject_niimg = load_subject(subject_filename, mask_niimg)\n\n    print(\"Image shape is %s\" % (str(subject_niimg.shape)))\n    num_components = subject_niimg.shape[-1]\n    print(\"Detected {num_components} spatial maps\".format(num_components=num_components))\n\n    nlplt.plot_prob_atlas(subject_niimg, \n                          bg_img=smri_filename,\n                          view_type='filled_contours',\n                          draw_cross=False,\n                          title='All %d spatial maps' % num_components,\n                          threshold='auto')","20177809":"filename = random.choice(os.listdir(fMRI_train_data_path))\nsubject_filename = os.path.join(fMRI_train_data_path, filename)\nsubject_niimg = load_subject(subject_filename, mask_niimg)\n\ngrid_size = int(np.ceil(np.sqrt(53)))\nfig, axes = plt.subplots(grid_size, grid_size, figsize=(grid_size*10, grid_size*10))\n[axi.set_axis_off() for axi in axes.ravel()]\nrow = -1 \n\nfor i, cur_img in enumerate(nl.image.iter_img(subject_niimg)):\n    col = i % grid_size\n    if col == 0:\n        row += 1\n    \n    nlplt.plot_stat_map(cur_img,\n                        bg_img=smri_filename,\n                        title='IC %d' % i,\n                        axes=axes[row, col],\n                        threshold=3,\n                        colorbar=False)","83fb7337":"# Loading \nfnc_df = pd.read_csv(\"..\/input\/trends-assessment-prediction\/fnc.csv\")\nloading_df = pd.read_csv(\"..\/input\/trends-assessment-prediction\/loading.csv\")\nlabels_df = pd.read_csv(\"..\/input\/trends-assessment-prediction\/train_scores.csv\")\n\nfnc_features, loading_features = list(fnc_df.columns[1:]), list(loading_df.columns[1:])\ndf = fnc_df.merge(loading_df, on=\"Id\")\nlabels_df[\"is_train\"] = True\n\ndf = df.merge(labels_df, on=\"Id\", how=\"left\")\n\ntarget_cols = ['age', 'domain1_var1', 'domain1_var2', 'domain2_var1', 'domain2_var2']\n\ntest_df = df[df[\"is_train\"] != True].copy()\ntrain_df = df[df[\"is_train\"] == True].copy()","f1ad2b2c":"y_train_df = train_df[target_cols]\ntrain_df = train_df.drop(target_cols + ['is_train'], axis=1)\ntest_df = test_df.drop(target_cols + ['is_train'], axis=1)\n\nFNC_SCALE = 1\/500\ntest_df[fnc_features] *= FNC_SCALE\ntrain_df[fnc_features] *= FNC_SCALE","c2778393":"def metric(y_true, y_pred):\n    return np.mean(np.sum(np.abs(y_true - y_pred), axis=0)\/np.sum(y_true, axis=0))","b59c843f":"param = {'objective':'regression',\n        'metric':'rmse',\n        'bossting_type':'gbdt',\n        'learning_rate':0.005,\n        'max_depth':-1}\n\noutput = pd.DataFrame()\n\nfor target in ['age','domain1_var1','domain1_var2','domain2_var1','domain2_var2']:\n    \n    X_train, X_val, y_train, y_val = train_test_split(train_df.iloc[:,1:], y_train_df[target], test_size=0.25, \n                                                      shuffle=True, random_state=20)\n    train_data = lgb.Dataset(X_train, label=y_train)\n    val_data = lgb.Dataset(X_val, label=y_val)\n    \n    model = lgb.train(param, \n                      train_data, \n                      50000, \n                      #nfold=10,\n                      early_stopping_rounds=500, \n                      valid_sets=[val_data], \n                      verbose_eval=50)\n    \n    temp = pd.DataFrame(test_df['Id'].apply(lambda x:str(x)+ '_'+ target))\n    temp['Predicted'] = model.predict(test_df.iloc[:,1:])\n    output = pd.concat([output,temp])    ","c695eb64":"sample_submission = pd.read_csv(\"\/kaggle\/input\/trends-assessment-prediction\/sample_submission.csv\")\noutput = sample_submission.drop('Predicted',axis=1).merge(output,on='Id',how='left')","535eebe2":"final_sub = pd.DataFrame(data={\n    'id':sample_submission['Id'],\n    'Predicted': 1*output['Predicted'] #+ 0.1*output_svm['Predicted']\n})\nfinal_sub.to_csv(\"submission.csv\", index=False)","db8de904":"The distributions are bell-shaped. Age and domain 2 variables seems to have a slight skew. Furthermore, the kurtosis is small, meaning that there is not much weight in the tails.","d8d9b76b":"Indeed, the target variables are normally-distributed. Note that Fisher's definition means that the kurtosis of a Gaussian distribution is 0.","d2d631fc":"For this model, we will only be using basic features, and not the actual MRI image. As you'll see, the model works decently.","2bc15782":"### <a href='#3-1'> Preparing data<\/a>","415e3934":"For a basic modelling using SVM, I hhave used RAPIDS SVM as shown in Ahmet Erdem's kernel: https:\/\/www.kaggle.com\/aerdem4\/rapids-svm-on-trends-neuroimaging and used feature engineering from https:\/\/www.kaggle.com\/jafarib\/trends-eda-fe-submission","26acc875":"**We know that there is no data leakage between patients since each patient has a unique id.**","ce1228c0":"This dataframe contains static FNC correlation features for both train and test samples.\n\nAs given in the competition data summary,\n\n> The second set are static functional network connectivity (FNC) matrices. These are the subject-level cross-correlation values among 53 component timecourses estimated from group inform guided ICA of resting state functional MRI.","c4c9188e":"### <a href='#3-2'> Training<\/a>","1837212e":"#### Visualize independent components (IC)","3a4e136e":"Credits to: https:\/\/www.kaggle.com\/soham1024\/visualization-using-nilearn","9f5012ce":"### <a href='#2-2'>SBM loadings<\/a>","bbd22f2e":"#### What are functional network connectivity matrices?\n\nFunctional connectivity is the **connectivity between brain regions that share functional properties**. More specifically, it can be defined as the temporal correlation between spatially remote neurophysiological events, expressed as deviation from statistical independence across these events in distributed neuronal groups and areas. This applies to both resting state and task-state studies. While functional connectivity can refer to correlations across subjects, runs, blocks, trials, or individual time points, resting state functional connectivity focuses on connectivity assessed across individual BOLD time points during resting conditions. Functional connectivity has also been evaluated using the perfusion time series sampled with arterial spin labeled perfusion fMRI.\n\nSource: https:\/\/en.wikipedia.org\/wiki\/Resting_state_fMRI#Functional","c5dbfa6e":"### <a href='#2-4'>Visualizing 3D spatial maps<\/a>","c5439b1d":"The train_scores.csv file contains the targets that we need to predict.","2e23eb66":"### <a href='#2-1'>Target distributions<\/a>","97358533":"# TReNDS Neuroimaging - Data exploration","db833a5a":"Let's know build our training set composed of multiple sets of features.","6d2b1af7":"### <a href='#2-3'>FNC correlation<\/a>","07dd337e":"## <a href='#3'>Basic modelling<\/a>","91d049bf":"Using soham1024's function, we change the dimensions of the 4d array that is in the Matlab file. We flip the axes such that the first two axes are the width and height.","420c1922":"Since we still have relatively few features, let's investigate the correlation between target variables and features."}}