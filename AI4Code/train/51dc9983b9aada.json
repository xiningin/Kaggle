{"cell_type":{"f2b9582d":"code","ce1f4904":"code","8d138b61":"code","f25b8dcb":"code","31ed4133":"code","14050d99":"code","a5d321c6":"code","d9bf72f0":"code","73656556":"code","7ec967a8":"code","433422ed":"code","e11c4c98":"code","301f031d":"code","5bc05f0c":"code","430b97c8":"code","12f5a409":"code","56f372a4":"code","ba3eeda6":"code","30aa9545":"code","8c14c446":"code","7259f267":"code","db7b9bd0":"code","88c3f4a7":"code","faed5bfa":"code","a97781b4":"code","51d35fb9":"code","5c9bf108":"code","e98d1feb":"code","79f71c68":"code","e76df56b":"code","8d7f0537":"code","54cd4173":"markdown","ed537d92":"markdown","e8100c4d":"markdown","e0500498":"markdown","471537cb":"markdown","252b92c2":"markdown","2fe4a505":"markdown","5cb5b119":"markdown","4ba08cc2":"markdown","7da4c329":"markdown","6a50eaef":"markdown","1ecbb5fa":"markdown","342b917f":"markdown","eb52fd0f":"markdown","bc13aedc":"markdown","4aaca284":"markdown"},"source":{"f2b9582d":"# Lets import the library and read the dataset\nimport numpy as np\nimport datetime as dt\nimport pandas as pd\nimport seaborn as sns\nimport matplotlib.pyplot as plt\n!pip install openpyxl\n\n        \npd.set_option('display.max_columns', None)\npd.set_option('display.float_format', lambda x: '%.2f' % x)\n\ndf_ = pd.read_excel(\"..\/input\/online-retail-ii-data-set-from-ml-repository\/online_retail_II.xlsx\", sheet_name = \"Year 2010-2011\" )\ndf = df_.copy()\ndf.head()","ce1f4904":"df.shape","8d138b61":"# Are there any missing values?\ndf.isnull().any()\ndf.isnull().sum()","f25b8dcb":"# Filling in missing data\ndf.dropna(inplace=True)","31ed4133":"# Check again\ndf.isnull().sum()","14050d99":"df[\"StockCode\"].nunique()","a5d321c6":"df[\"StockCode\"].value_counts().head()\n","d9bf72f0":"df[\"StockCode\"].value_counts().sort_values(ascending=False).head()","73656556":"df = df[~df[\"Invoice\"].str.contains(\"C\", na = False)]","7ec967a8":"df[\"TotalPrice\"] = df[\"Quantity\"] * df[\"Price\"]","433422ed":"df.head()","e11c4c98":"# the last date of purchase\ndf[\"InvoiceDate\"].max()","301f031d":"# make sure that none of the Recency values become zero\nimport datetime as dt\ntoday_date = dt.datetime(2011, 12, 11)","5bc05f0c":"rfm = df.groupby('Customer ID').agg({'InvoiceDate': lambda InvoiceDate: (today_date - InvoiceDate.max()).days,\n                                     'Invoice': lambda Invoice: Invoice.nunique(),\n                                     'TotalPrice': lambda TotalPrice: TotalPrice.sum()})\n","430b97c8":"rfm.head()","12f5a409":"rfm.columns = ['recency', 'frequency', 'monetary']","56f372a4":"rfm = rfm[rfm[\"monetary\"] > 0]\nrfm.head()","ba3eeda6":"rfm[\"recency_score\"] = pd.qcut(rfm['recency'], 5, labels=[5, 4, 3, 2, 1])\n\n\nrfm[\"frequency_score\"] = pd.qcut(rfm['frequency'].rank(method=\"first\"), 5, labels=[1, 2, 3, 4, 5])\n\nrfm[\"monetary_score\"] = pd.qcut(rfm['monetary'], 5, labels=[1, 2, 3, 4, 5])\n\n\nrfm[\"RFM_SCORE\"] = (rfm['recency_score'].astype(str) +\n                    rfm['frequency_score'].astype(str))","30aa9545":"rfm.head()","8c14c446":"seg_map = {\n    r'[1-2][1-2]': 'hibernating',\n    r'[1-2][3-4]': 'at_Risk',\n    r'[1-2]5': 'cant_loose',\n    r'3[1-2]': 'about_to_sleep',\n    r'33': 'need_attention',\n    r'[3-4][4-5]': 'loyal_customers',\n    r'41': 'promising',\n    r'51': 'new_customers',\n    r'[4-5][2-3]': 'potential_loyalists',\n    r'5[4-5]': 'champions'\n}\n\n\nrfm['segment'] = rfm['RFM_SCORE'].replace(seg_map, regex=True)\n\nrfm[[\"segment\", \"recency\", \"frequency\", \"monetary\"]].groupby(\"segment\").agg([\"mean\", \"count\"])\n\nrfm.head()","7259f267":"champions = rfm[rfm['segment'] == 'champions']\ncant_loose = rfm[rfm['segment'] == 'cant_loose']","db7b9bd0":"champions[['recency','frequency','monetary']].agg(['mean', 'count'])","88c3f4a7":"cant_loose[['recency','frequency','monetary']].agg(['mean', 'count'])","faed5bfa":"loyal_df = pd.DataFrame()\nloyal_df[\"loyal_customer_id\"] = rfm[rfm[\"segment\"] == \"loyal_customers\"].index\nloyal_df.head()\n\nloyal_df.to_excel(\"loyal_customers.xlsx\", sheet_name='Loyal Customers Index')","a97781b4":"import numpy as np\nimport pandas as pd\nimport matplotlib.pyplot as plt\nfrom sklearn.cluster import KMeans\nfrom sklearn.preprocessing import MinMaxScaler\nfrom yellowbrick.cluster import KElbowVisualizer\nfrom scipy.cluster.hierarchy import linkage\nfrom scipy.cluster.hierarchy import dendrogram\nfrom sklearn.preprocessing import StandardScaler\nfrom sklearn.decomposition import PCA\nimport datetime as dt","51d35fb9":"sc = MinMaxScaler((0, 1))\nsegment_df = pd.DataFrame(sc.fit_transform(rfm[[\"recency\", \"frequency\", \"monetary\"]]),\n                            index=rfm.index, columns=[\"Recency\", \"Frequency\", \"Monetary\"])\nsegment_df.reset_index(inplace=True)\nsegment_df.head()","5c9bf108":"kmeans = KMeans()\nelbow = KElbowVisualizer(kmeans, k=(2, 20))\nelbow.fit(segment_df)\nelbow.show()","e98d1feb":"kmeans = KMeans(n_clusters=elbow.elbow_value_).fit(segment_df)\nsegment_df[\"clusters\"] = kmeans.labels_","79f71c68":"segment_df.head()","e76df56b":"segmentation = rfm.merge(segment_df, on=\"Customer ID\")\nsegmentation[[\"segment\", \"clusters\", \"recency\", \"frequency\", \"monetary\"]].groupby([\"clusters\", \"segment\"]).agg([\"mean\"])","8d7f0537":"pd.DataFrame(segmentation[[\"segment\", \"clusters\"]].groupby([\"clusters\", \"segment\"])[\"segment\"].agg(\"count\"))","54cd4173":"*How many of each product are there?*","ed537d92":"*How many unique product are there?*","e8100c4d":"**Comparing RFM metrics with K-Means**","e0500498":"**Data Understanding and Preprocessing**","471537cb":"**Recency :** the number of days between today_date and the last purchase date of this customer\n\n**Frequency :** the number of purchase of this customer\n\n**Monetary :** sum of TotalPrice of this customer","252b92c2":"We need to score these values between 1 and 5. After scoring, we will segment it.","2fe4a505":"We can say that 633 customers bought 6857.96 units by shopping 12 times approximately every 6 days.\nIt is the most special, most loved type of customer. Special calls can be made to these customers. Gift voucher can be defined. Campaigns can be made of buy 1 get 1 free.","5cb5b119":"*Sort the 5 most ordered products from most to least.*","4ba08cc2":"Scale the data","7da4c329":"63 customers bought 897.63 units by shopping twice every 132 days. They spend a good amount of money and they used to be our loyal customers, we can't loose them. There may be pop-ups like we miss you. Continuous reminder notifications can be sent. Special campaigns can be made for your previous shopping.","6a50eaef":"***NOW, USING K-MEANS CLUSTERING***","1ecbb5fa":"Now, we anayze 3 segments which are champions, can't loose and need attention.","342b917f":"*Create a variable named 'TotalPrice' that represents the total earnings per invoice.*","eb52fd0f":"**Calculation of RFM metrics**","bc13aedc":"*The 'C' in the invoices shows the canceled transactions. Since we will not use the canceled transactions, we should remove them.*","4aaca284":"*InvoiceDate represent to 'recency'\nInvoice represent 'frequency'\nTotalPrice represent 'monetary'*\n\n**Lets change the columns names**"}}