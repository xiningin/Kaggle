{"cell_type":{"8f81ce08":"code","4b6a72b8":"code","b721553c":"code","400d64e0":"code","caa51a7d":"code","5757f7fc":"code","f5bf4435":"code","896e9d2c":"code","58891209":"code","25fb594e":"code","87bbc46c":"code","46e0885c":"code","9e1b0373":"code","cd7c4c75":"code","17a551b8":"code","525806a0":"code","0c0f841f":"code","7b2cd1a1":"code","d0a477ca":"code","c9f409c6":"code","ad4969d9":"code","eb1f7923":"code","0b9923b9":"markdown","4d86d443":"markdown","4cb861ae":"markdown","0df96453":"markdown","154b8636":"markdown","25ea7ca0":"markdown","7ca588fa":"markdown"},"source":{"8f81ce08":"# This Python 3 environment comes with many helpful analytics libraries installed\n# It is defined by the kaggle\/python Docker image: https:\/\/github.com\/kaggle\/docker-python\n# For example, here's several helpful packages to load\n\nimport numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\nimport matplotlib.pyplot as plt\n%matplotlib inline\n\n\n# Input data files are available in the read-only \"..\/input\/\" directory\n# For example, running this (by clicking run or pressing Shift+Enter) will list all files under the input directory\nimport os\n\nprint(os.listdir(\"..\/input\"))\n\nfrom joblib import dump, load\nimport collections\nimport random\nimport time\n\nfrom sklearn.metrics import accuracy_score, log_loss\nfrom sklearn.model_selection import train_test_split\nfrom sklearn.preprocessing import StandardScaler\n\nfrom sklearn.multiclass import OneVsRestClassifier\nfrom sklearn.svm import SVC\nfrom sklearn.decomposition import PCA","4b6a72b8":"file_path = \"..\/input\/lish-moa\/\"\n\n#data to fit and evaluate the model\ntrain_data = pd.read_csv(file_path+'train_features.csv')\ndf_train=train_data.copy()\ntarget_data  = pd.read_csv(file_path+'train_targets_scored.csv')\ndf_target=target_data.copy()\n\n#collect data for test submission\ntest_data = pd.read_csv(file_path+'test_features.csv')\ndf_test=test_data.copy()\nsample = pd.read_csv(file_path+'sample_submission.csv')\n\nprint(train_data.shape)\ntrain_data.head()","b721553c":"\n\ndf_train.loc[df_train['cp_type']=='ctl_vehicle','cp_time']= 0\ndf_train.loc[df_train['cp_type']=='ctl_vehicle','cp_dose']= 0\ndf_test.loc[df_train['cp_type']=='ctl_vehicle','cp_time']= 0\ndf_test.loc[df_train['cp_type']=='ctl_vehicle','cp_dose']= 0\n\ndf_train.loc[:, 'cp_dose']=df_train.loc[:, 'cp_dose'].map({'D1': 1, 'D2': 2,0:0})\ndf_train.loc[:, 'cp_type']=df_train.loc[:, 'cp_type'].map({'trt_cp': 1, 'ctl_vehicle': 0})\ndf_train.loc[:,'cp_time']=df_train.loc[:,'cp_time'].map({0:0,24:1,48:2,72:3})\n\ndf_test.loc[:,'cp_dose']=df_test.loc[:,'cp_dose'].map({'D1': 1, 'D2': 2,0:0})\ndf_test.loc[:, 'cp_type']=df_test.loc[:,'cp_type'].map({'trt_cp': 1, 'ctl_vehicle': 0})\ndf_test.loc[:,'cp_time']=df_test.loc[:,'cp_time'].map({0:0,24:1,48:2,72:3})","400d64e0":"df_train.head()","caa51a7d":"df_test.head()","5757f7fc":"#features cp_time, cp_dose and g-, c-\nfeatures=list(df_train.columns)[2:]\ntargets=list(target_data.columns)[1:]","f5bf4435":"for target in targets:\n    count=collections.Counter(target_data.loc[:,target])\n    if count[1]<5:\n        print (target, count)\n\n#remove two few positives (erbb2_inhibitor,atp-sensitive_potassium_channel_antagonist).\n\ntargets.remove('erbb2_inhibitor')\ntargets.remove('atp-sensitive_potassium_channel_antagonist')","896e9d2c":"\ndef PCA_model1(X, components_number):\n    #Apply PCA and return the sum explained variance \n    c=components_number\n    pca = PCA(n_components=c).fit(X)\n    sum_vexp_var=sum(pca.explained_variance_ratio_)\n    return sum_vexp_var\n\ndef PCA_model2(X, components_number):\n    #Apply PCA and return pca fit estimator and the reduce data in form of dataframe \n    c=components_number\n    pca = PCA(n_components=c).fit(X)    \n    reduced_data=pca.transform(X)\n    df_reduced_data=pd.DataFrame((reduced_data),columns=range(0,c))    \n    return pca, df_reduced_data\n    ","58891209":"X=df_train[features]\ny=np.array(df_target[targets])\nX_sample=df_test[features]","25fb594e":"scaler=StandardScaler().fit(X)\nX=scaler.transform(X)\nX_sample=scaler.transform(X_sample)\n#Try a range of components\ncomponents_number=[2,30,40,50,100,200]\nfor c in components_number:\n    print ('PCA with {} components:'.format(c))    \n    sum_vexp_var= PCA_model1(X, c)\n    print( 'sum explained_variance_ratio for {}:'.format(c),sum_vexp_var)\n    print('')   ","87bbc46c":"#Calculate reduced data with 40 components\npca,df_reduced_data= PCA_model2(X,40)","46e0885c":"X=df_reduced_data\ny=np.array(df_target[targets])\nX_sample=pca.transform(X_sample)","9e1b0373":"start=time.time()\nX_train, X_test, y_train, y_test = train_test_split(X, y, random_state=42, test_size=0.2)\nclf=SVC(probability=True)\nclf_fit=OneVsRestClassifier(clf).fit(X_train, y_train)\ny_pred=clf_fit.predict(X_test)\ny_pred_prob=clf_fit.predict_proba(X_test)\nsample_pred_prob=clf_fit.predict_proba(X_sample)\nend=time.time()\nprint('time:',end-start)\nprint(\"accuracy: %0.2f \" % (accuracy_score(y_test,y_pred)))\nprint('')\nprint(\"log_los: %0.3f \" % (log_loss(y_test.ravel(),y_pred_prob.ravel())))","cd7c4c75":"#save model\nfilename='model3_pca_svc4.joblib'\ndump(clf_fit, filename)","17a551b8":"#Introduce results of predictions in this dataframe, put everything to 0.\n#this way removed targets would be put to 0\nsample_null=sample.loc[:,list(target_data.columns)[1:]].transform(lambda x:x*0)\nprint(sample_null.shape)\nsample_null.head()","525806a0":"sample_null.loc[:,targets] = sample_pred_prob\n","0c0f841f":"sample_null.head()","7b2cd1a1":"#check if data with cp_vehicle are predicted to be 0\nsample_vehicle=sample_null.loc[df_test['cp_type']==0]\n#print(list(sample_null.loc[df_test['cp_type']==0].max()))\nsample_vehicle.describe()","d0a477ca":"#change controls to 0. Some targets were not predicted to be 0\nsample_null.loc[df_test['cp_type'] == 0, sample_null.columns] = 0","c9f409c6":"sample_null.head()","ad4969d9":"sample.iloc[:,1:]=sample_null","eb1f7923":"sample.to_csv('submission.csv', index=False)","0b9923b9":"Dimensionality reduction using PCA","4d86d443":"Approach: Dimensionality reduction with PCA and application of SVC.\nControls considered as point 0 (dose=0,time=0)","4cb861ae":"Remove targets with few positives","0df96453":"Apply SVC using the reduced data","154b8636":"Preprocessing of categorical data -use multilabel-","25ea7ca0":"Calculate reduced data with 40 components","7ca588fa":"Calculate PCA explained variance ratio for a range of components"}}