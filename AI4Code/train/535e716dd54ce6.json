{"cell_type":{"9f640e82":"code","cfc807f6":"code","965b6178":"code","ddc1b42c":"code","2bd1dd00":"code","4c7da0c5":"code","6db582b4":"code","fb1c2598":"code","a63692da":"code","8f90bd6d":"code","7ece8c81":"code","c6e3f2ed":"code","9a43d707":"code","5b299530":"code","6caea586":"code","4a23ac48":"code","c52f3479":"code","44001350":"code","9a124aed":"code","de52ac5e":"code","54be2931":"code","42b55f7e":"code","6ff1b8cc":"code","3588748f":"code","67a21169":"code","83555249":"markdown","f518e8aa":"markdown","92cd687f":"markdown","0d065468":"markdown","cf52dd65":"markdown","5808e4ca":"markdown","6fbf453f":"markdown","a8b1fef1":"markdown","aa2fc815":"markdown","eb61ba86":"markdown","cb671052":"markdown","4cd17caa":"markdown","10d76869":"markdown","d63d4b68":"markdown","fa7ffcce":"markdown","531fdd35":"markdown","a33c6faf":"markdown","11ee2e1e":"markdown","824d9d5a":"markdown","087ecf9c":"markdown","0c7112fb":"markdown","b5a35d90":"markdown","21bdd3ec":"markdown","ea147090":"markdown","417cb6e6":"markdown","edddde72":"markdown","49f4cbe0":"markdown","43e0f5ec":"markdown","bdd391ff":"markdown","9a8450d2":"markdown","acfe9bcb":"markdown","cc21f34f":"markdown","c395b374":"markdown","2909a664":"markdown"},"source":{"9f640e82":"import os\nimport json\nimport numpy as np\nimport pandas as pd\nimport matplotlib.pyplot as plt\nimport matplotlib.ticker as ticker\nimport seaborn as sns\ncolor = sns.color_palette()\nplt.style.use('bmh')\nplt.set_cmap('spring')\n%matplotlib inline\nimport bq_helper","cfc807f6":"\n#Here's how we can use the BQHelper library to pull datasets\/tables from BigQuery\nga_bq_train = bq_helper.BigQueryHelper(active_project= \"kaggle-public-datasets\", \n                                       dataset_name = \"ga_train_set\")\nga_bq_test = bq_helper.BigQueryHelper(active_project= \"kaggle-public-datasets\", \n                                       dataset_name = \"ga_test_set\")\n","965b6178":"ga_bq_train.list_tables()[:10]","ddc1b42c":"#columns in train dataset\nga_bq_train.table_schema((ga_bq_train.list_tables()[0]))['name'].tolist()","2bd1dd00":"#Let's check the size of train dataset total number of records\ntotal_train_query = \"\"\"SELECT  COUNT(*) AS COUNT\n  FROM `kaggle-public-datasets.ga_train_set.ga_sessions_*` \"\"\"\ntotal_train = ga_bq_train.query_to_pandas(total_train_query)\nprint('Total number of records in training dataset :',total_train['COUNT'][0])\n\n#Let's check the size of test dataset total number of records\ntotal_test_query = \"\"\"SELECT  COUNT(*) AS COUNT\n  FROM `kaggle-public-datasets.ga_test_set.ga_sessions_*` \"\"\"\ntotal_test = ga_bq_test.query_to_pandas(total_test_query)\nprint('Total number of records in test dataset :',total_test['COUNT'][0])\n","4c7da0c5":"#training data snapshot\nga_bq_train.head(ga_bq_train.list_tables()[0]) #this will show data in first table of bigquery dataset\n","6db582b4":"#exploration of Target Variable using BigQuery\n\ntotalrevenue_per_user_query = \"\"\"SELECT  fullVisitorId, coalesce(SUM( totals.transactionRevenue ),0) AS totalrevenue_per_user\n  FROM `kaggle-public-datasets.ga_train_set.ga_sessions_*` \n  GROUP BY fullVisitorId\n\"\"\"\ntotalrevenue_per_user = ga_bq_train.query_to_pandas_safe(totalrevenue_per_user_query)\n#plot distribution of transactionRevenue\nplt.figure(figsize=(8,6))\n#scatter plot on natural log of totalrevenue per user\n#original code by : SRK kernel(https:\/\/www.kaggle.com\/sudalairajkumar\/simple-exploration-baseline-ga-customer-revenue)\n\nplt.scatter(range(totalrevenue_per_user.shape[0]), np.sort(np.log1p(totalrevenue_per_user[\"totalrevenue_per_user\"].values)))\nplt.xlabel('index', fontsize=12)\nplt.ylabel('totalRevenue', fontsize=12)\nplt.title('Distribution of totalrevenue per user')\nplt.show()","fb1c2598":"traindate_query = \"\"\"SELECT MIN(date) as startdate,MAX(date) as enddate \n    FROM `kaggle-public-datasets.ga_train_set.ga_sessions_*`\"\"\"\ntraindate_result =  ga_bq_train.query_to_pandas_safe(traindate_query)\nprint('Data in training set is for date',traindate_result['startdate'].iloc[0],'to',traindate_result['enddate'].iloc[0])","a63692da":"testdate_query = \"\"\"SELECT MIN(date) as startdate,MAX(date) as enddate \n    FROM `kaggle-public-datasets.ga_test_set.ga_sessions_*`\"\"\"\ntestdate_result =  ga_bq_test.query_to_pandas_safe(testdate_query)\nprint('Data in test set is for date',testdate_result['startdate'].iloc[0],'to',testdate_result['enddate'].iloc[0])","8f90bd6d":"revenue_per_date_query = \"\"\"SELECT  PARSE_DATE('%Y%m%d',date) AS DATE,COUNT(*) AS VISIT_COUNT ,coalesce(SUM( totals.transactionRevenue ),0) AS totalrevenue,\ncoalesce(AVG( totals.transactionRevenue ),0) AS avgrevenue\n  FROM `kaggle-public-datasets.ga_train_set.ga_sessions_*` \n  GROUP BY date\n\"\"\"\nrevenue_per_date = ga_bq_train.query_to_pandas_safe(revenue_per_date_query)\n\nfor i,col in enumerate(['VISIT_COUNT','totalrevenue','avgrevenue']):\n    #fig,axes = plt.subplots(3,1)\n    revenue_per_date.plot(x='DATE',y=col,figsize=(8,6))\n    if col=='VISIT_COUNT' :\n        plt.title('Visits count per day')\n    else :\n        plt.title('Distribution of ' + col + ' per date')\n    plt.xlabel('DATE', fontsize=12)\n    plt.ylabel(col, fontsize=12)\n    ","7ece8c81":"def categorical_countplot(feature):\n    #this function extract usage count of feature passed using BigQuery and visualize the usage of top 10 feature values based on their counts\n    separate_feat = feature.split('.')[1]\n    query = \"\"\"SELECT \"\"\" + feature + \"\"\", COUNT(*) AS COUNT,coalesce(SUM( totals.transactionRevenue ),0) AS TotalRevenue,\n    coalesce(AVG( totals.transactionRevenue ),0) AS AvgRevenue\n      FROM `kaggle-public-datasets.ga_train_set.ga_sessions_*` \n      GROUP BY \"\"\" + feature + \"\"\"\n      ORDER BY COUNT(*) DESC\"\"\"\n    feature_count = ga_bq_train.query_to_pandas_safe(query)\n    print('Total number of ' ,separate_feat, ' :',len(feature_count[separate_feat]))\n    #let's visualize the usage of top 10 feature categories using barplot\n    plt.figure(figsize=(16,6))\n    for i,col in enumerate(['COUNT','TotalRevenue','AvgRevenue']) :\n        ax = plt.subplot(1,3,i+1)\n        sns.barplot(x=separate_feat,y=col,data=feature_count.head(10))\n        if col=='COUNT' :\n            plt.title('Visits count per '  + separate_feat)\n        else :\n            plt.title(col + ' per ' + separate_feat)\n        plt.xticks(rotation=90)","c6e3f2ed":"# exploration of browser variable\ncategorical_countplot('device.browser')\n","9a43d707":"# exploration of operating system\ncategorical_countplot('device.operatingSystem')","5b299530":"categorical_countplot('device.deviceCategory')","6caea586":"categorical_countplot('geoNetwork.continent')","4a23ac48":"categorical_countplot('geoNetwork.subContinent')","c52f3479":"categorical_countplot('geoNetwork.country')","44001350":"categorical_countplot('trafficSource.source')","9a124aed":"categorical_countplot('trafficSource.medium')","de52ac5e":"hits_query = \"\"\"SELECT totals.hits as hits, COUNT(*) AS COUNT,coalesce(SUM( totals.transactionRevenue ),0) AS TotalRevenue,\ncoalesce(AVG( totals.transactionRevenue ),0) AS AvgRevenue\n  FROM `kaggle-public-datasets.ga_train_set.ga_sessions_*` \n  GROUP BY totals.hits ORDER BY totals.hits\"\"\"\n\nhits_count = ga_bq_train.query_to_pandas_safe(hits_query)","54be2931":"#visits per hit\nplt.figure(figsize=(16,8))\nsns.barplot(x='hits',y='COUNT',data=hits_count.head(50),color='green')\nplt.title('Visits count per hits')","42b55f7e":"#effect of hits on total revenue and mean revenue\nplt.figure(figsize=(16,8))\nfor i,col in enumerate(['TotalRevenue','AvgRevenue']) :\n        ax = plt.subplot(1,2,i+1)\n        sns.scatterplot(x='hits',y=col,data=hits_count)\n        plt.title(col + ' per hits')\n        scale_y = 1e6\n        ticks_y = ticker.FuncFormatter(lambda x, pos: '{0:g}'.format(x\/scale_y))\n        ax.yaxis.set_major_formatter(ticks_y)\n        plt.xticks(rotation=90)","6ff1b8cc":"pageviews_query = \"\"\"SELECT CAST(totals.pageviews as INT64) as pageviews, COUNT(*) AS COUNT,coalesce(SUM( totals.transactionRevenue ),0) AS TotalRevenue,\ncoalesce(AVG( totals.transactionRevenue ),0) AS AvgRevenue\n  FROM `kaggle-public-datasets.ga_train_set.ga_sessions_*` \n  GROUP BY totals.pageviews ORDER BY totals.pageviews\"\"\"\n\npageviews_count = ga_bq_train.query_to_pandas_safe(pageviews_query)","3588748f":"#pageviews counts\nplt.figure(figsize=(16,8))\nsns.barplot(x='pageviews',y='COUNT',data=pageviews_count.head(30),color='blue')\nplt.title('Visit count per pageviews')","67a21169":"#effect of pageviews on total revenue and mean revenue\nplt.figure(figsize=(16,8))\nfor i,col in enumerate(['TotalRevenue','AvgRevenue']) :\n        ax = plt.subplot(1,2,i+1)\n        sns.scatterplot(x='pageviews',y=col,data=pageviews_count)\n        plt.title(col + ' per pageviews')\n        scale_y = 1e6\n        ticks_y = ticker.FuncFormatter(lambda x, pos: '{0:g}'.format(x\/scale_y))\n        ax.yaxis.set_major_formatter(ticks_y)\n        plt.xticks(rotation=90)","83555249":"One year of data is present in training dataset(1st August,2016 to 1st August,2017).","f518e8aa":"### Traffic Source","92cd687f":"### Traffic medium","0d065468":"It seems dataset on kaggle is factored on the basis of date. Let's check what all columns are available :","cf52dd65":"#### Continent","5808e4ca":"As we have seen above train and test dataset is grouped into tables by dates. Let's check the time period of data available in train and test dataset using column date and bigquery.","6fbf453f":"__Microsoft Windows__ is leading OS __used__ here but __Mac__ users are __generating more revenue__ than others. Average revenue(__non-zero revenue__) per visit is highest for __Chrome OS__.","a8b1fef1":"From graphs above, we can say that United States is cash-cow for Google. Revenue contributed by United States alone constitutes more than 90% of total revenue genearated by all countries.\nSurprisingly, more non-zero revenue visits are coming from Japan as very less number of visits are coming from Japan.","aa2fc815":"Most widely used browser is __Google Chrome__, then comes Safari and firefox. Other browsers have very low usage. Total revenue for Google chrome is highest but __average revenue(non-zero revenue) for Firefox is highest__! Seems user visits  from firefox are quality visits(generating revenue).","eb61ba86":"## Exploratory Data Analysis","cb671052":"### Sub-continent","4cd17caa":"Visits are coming mostly from North America. Also, North America is major revenue contributor(seems more than 90%) . But more quality visits(non-zero revenue) are coming from South America and Eastern Asia.","10d76869":"Visit counts and totalrevenue is highest from __Americas__ but avgrevenue per visit is significantly higher from __Africa__.Also, number of visits from asia and europe are high but they are contibuting much towards generting revenue.","d63d4b68":"In the first plot for visit count, we can see that visits starts increasing from after Oct 2016 and go to its highest peak near by Chritsmas. But this peak doesn't convert into revenue as per total revenue and avg revenue plots. Instead revenue attains its peak in first quarter of 2017 in february and april.","fa7ffcce":"### Operating System","531fdd35":"There are 186 columns in train dataset which includes columns hidden in json as well.","a33c6faf":"Here in training dataset, 7 Traffic mediums are used. Organic is generating more visits then any other mediums. __Organic__ traffic is Traffic from search engine results that is earned, not paid! I got it from this [link](https:\/\/www.smartbugmedia.com\/blog\/what-is-the-difference-between-direct-and-organic-search-traffic-sources). But __Referral__(traffic that occurs when a user finds you through a site other than a major search engine) traffic is generating more  revenue than other traffic mediums. Although, __CPM__(click-per-impressions) is generating most of the revenue for google merchandise store.","11ee2e1e":"As mentioned in competetion overview and by [SRK](https:\/\/www.kaggle.com\/sudalairajkumar) in his [kernel](https:\/\/www.kaggle.com\/sudalairajkumar\/simple-exploration-baseline-ga-customer-revenue), it is true that\n__\"The 80\/20 rule has proven true for many businesses\u2013only a small percentage of customers produce most of the revenue. As such, marketing teams are challenged to make appropriate investments in promotional strategies.\"__ . The 80\/20 rule is nothing but says that 20% customers produce more than 80% of sales(transactionrevenue in our case). From above plot, it seems even much lower.","824d9d5a":"Here also, similar to hits, same trend is observed i.e. visit count decreases as number of pageviews increaese. Same is the case with graphs for effect of pageviews on totalrevenue and average revenue. ","087ecf9c":"### hits","0c7112fb":"Around 10 months of data is present in test dataset from August 2017 to April 2018.","b5a35d90":"### Country","21bdd3ec":"### pageviews","ea147090":"### deviceCategory","417cb6e6":"### transactionRevenue - the target variable","edddde72":"### Browser ","49f4cbe0":"Next thing, I will try to do some feature engineering using bigquery SQL! Also, any suggestions\/feedbacks are most welcome!","43e0f5ec":"Bar plots are uniform and shows same pattern for usage,totalrevenue and avgrevenue. Most of the visits are from __Desktop computers__ here. So previous graph for operating system also makes sense that usage of Windows and Macintosh OS are significantly higher as comparison to others.","bdd391ff":"We can see that as number of hits increases, the number of visits decreases.Almost, same pattern is observed in graph for total revenue and average revenue.\n\nTotalrevenue steeply decreases with increase in number of hits.","9a8450d2":"## Google Analytics Customer revenue prediction","acfe9bcb":"Here,we need to parse date column to bring it in proper format(yyyy-mm-dd) for visualization first. For it, there is a built-in function [PARSE_DATE](https:\/\/cloud.google.com\/bigquery\/docs\/reference\/standard-sql\/date_functions#parse_date) in google bigquery. Let's use it and convert date into proper format.","cc21f34f":"In this kernel, I have done exploratory data analysis for [Google Analytics customer revenue prediction challenge](https:\/\/www.kaggle.com\/c\/ga-customer-revenue-prediction). Here , we need to analyze a [Google Merchandise Store](https:\/\/www.googlemerchandisestore.com) (also known as GStore, where Google swag is sold) customer dataset to predict revenue per customer. \n\nDatasets provided for training and test are available both in csv as well as google bigquery datasets. Since, I have experience in using SQL for data analytics in professional life, I have tried my hands with __google big query__ for exploratory data analysis here.  I have used some simple SELECT sqls and GROUP BY and aggregage functions like SUM,MIN,MAX & AVG here.\n\n This kernel is inspired from [simple exploration kernel](https:\/\/www.kaggle.com\/sudalairajkumar\/simple-exploration-baseline-ga-customer-revenue) from [SRK](https:\/\/www.kaggle.com\/sudalairajkumar). His kernels always have been a great source inspiration and learning for me!","c395b374":"### date","2909a664":"__Google and youtube__(also owned by google) themselves are major source of visits to its merchandising store. However, __mail.googleplex.com__(seems google own mail server used by its employess, I tried visited it !) is major contributor of revenue.So, __folks working in Google itself are buying more from their merchandise store__. Also, facebook and baidu are not making any significant contributions to revenue(may be google is placing their ads on them!)."}}