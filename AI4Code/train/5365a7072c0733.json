{"cell_type":{"204f3fc5":"code","556a702b":"code","4c3ec1e2":"code","4438016b":"code","bf2af8f9":"code","2601f414":"code","4ba098d5":"code","b64d1b6d":"code","ee403ce2":"code","905d9550":"code","49f62cef":"code","37892dcb":"code","76d13635":"code","85183724":"code","887e37cc":"code","c0ba9d4a":"code","bd802765":"code","c7d2f81e":"code","7b5a5f61":"code","1f61c7ef":"code","b154dff0":"code","7fef138e":"code","895632cd":"code","512e3dbb":"code","816f2261":"code","930ff37c":"code","2913bde7":"code","8f6ee2e9":"code","57a58324":"code","14f33ebf":"code","7bdadc70":"code","95e2a752":"code","9bcf8656":"code","1e202b90":"code","f3ebe9ee":"code","4b0a2dea":"code","a749c95f":"code","c22659cf":"code","814b6fb6":"code","5108adf1":"code","e41603e3":"code","81374648":"code","dfc01cf1":"code","56f689c8":"code","e3089909":"code","1e78fed6":"code","519a7840":"markdown","aed24db2":"markdown","27064afb":"markdown","70a42ba3":"markdown","112765b0":"markdown"},"source":{"204f3fc5":"%reload_ext autoreload\n%autoreload 2\n%matplotlib inline","556a702b":"from fastai.vision import *\nfrom fastai.callbacks.hooks import *\nfrom fastai.utils.mem import *","4c3ec1e2":"path = untar_data(URLs.CAMVID)\npath.ls()","4438016b":"path_lbl = path\/'labels'\npath_img = path\/'images'","bf2af8f9":"fnames = get_image_files(path_img)\nfnames[:3]","2601f414":"lbl_names = get_image_files(path_lbl)\nlbl_names[:3]","4ba098d5":"img_f = fnames[0]\nimg = open_image(img_f)\nimg.show(figsize=(5,5))","b64d1b6d":"get_y_fn = lambda x: path_lbl\/f'{x.stem}_P{x.suffix}'","ee403ce2":"mask = open_mask(get_y_fn(img_f))\nmask.show(figsize=(5,5), alpha=1)","905d9550":"src_size=np.array(mask.shape[1:])\nsrc_size, mask.data","49f62cef":"codes = np.loadtxt(path\/'codes.txt', dtype=str); codes","37892dcb":"size = src_size\/\/2\nfree = gpu_mem_get_free_no_cache()\nif free > 8200: bs=8\nelse:           bs=4\nprint(f\"using bs={bs}, have {free}MB of GPU RAM free\")","76d13635":"src = (SegmentationItemList.from_folder(path_img)\n      .split_by_fname_file('..\/valid.txt')\n      .label_from_func(get_y_fn, classes=codes))","85183724":"data = (src.transform(get_transforms(), size=size, tfm_y=True)\n       .databunch(bs=bs)\n       .normalize(imagenet_stats))","887e37cc":"data.show_batch(2, figsize=(10,7))","c0ba9d4a":"data.show_batch(2, figsize=(10,7), ds_type = DatasetType.Valid)","bd802765":"name2id = {v: k for k,v in enumerate(codes)}\nvoid_code = name2id['Void']\n\ndef acc_camvid(input, target):\n    target = target.squeeze(1)\n    mask = target != void_code\n    return (input.argmax(dim=1)[mask]==target[mask]).float().mean()","c7d2f81e":"metrics = acc_camvid","7b5a5f61":"wd = 1e-2","1f61c7ef":"learn = unet_learner(data, models.resnet34, metrics=metrics, wd=wd)","b154dff0":"lr_find(learn)\nlearn.recorder.plot()","7fef138e":"lr = 3e-3","895632cd":"learn.fit_one_cycle(10, slice(lr), pct_start=0.9)","512e3dbb":"learn.save('stage-1')","816f2261":"learn.load('stage-1');","930ff37c":"learn.show_results(rows=3, figsize=(8,9))","2913bde7":"learn.unfreeze()","8f6ee2e9":"lrs = slice(lr\/400, lr\/4)","57a58324":"learn.fit_one_cycle(12, lrs, pct_start=0.8)","14f33ebf":"learn.save('stage-2');","7bdadc70":"learn.destroy();","95e2a752":"size = src_size\n\nfree = gpu_mem_get_free_no_cache()\n\nif free > 8200:  bs=3\nelse:            bs=1\nprint(f\"using bs={bs}, have {free}MB of GPU RAM free\")","9bcf8656":"data = (src.transform(get_transforms(), size=size, tfm_y=True)\n    .databunch(bs=bs)\n    .normalize(imagenet_stats))","1e202b90":"learn = unet_learner(data, models.resnet34, metrics=metrics, wd=wd)","f3ebe9ee":"learn.load('stage-2');","4b0a2dea":"lr_find(learn)\nlearn.recorder.plot()","a749c95f":"lr = 1e-3","c22659cf":"learn.fit_one_cycle(10, slice(lr), pct_start = 0.8)","814b6fb6":"learn.save('stage-1-big')","5108adf1":"learn.load('stage-1-big');","e41603e3":"learn.unfreeze()","81374648":"lrs = slice(1e-6, lr\/10)","dfc01cf1":"learn.fit_one_cycle(10, lrs)","56f689c8":"learn.save('stage-2-big')","e3089909":"learn.load('stage-2-big');","1e78fed6":"learn.show_results(rows=3, figsize=(10,10))","519a7840":"## Image segmentation with CamVid","aed24db2":"## Go big","27064afb":"## Data","70a42ba3":"## Model","112765b0":"## Dataset"}}