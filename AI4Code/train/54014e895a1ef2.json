{"cell_type":{"0e61283e":"code","386c9305":"code","bfa6b18d":"code","ef56679e":"code","b8572343":"code","9071e691":"code","c4789df2":"code","17eab1c4":"code","7692eaa0":"markdown"},"source":{"0e61283e":"!pip install lofo-importance","386c9305":"import cudf\nimport cuml\n\n\ndf = cudf.read_csv(\"\/kaggle\/input\/lish-moa\/train_features.csv\")\n\nfeatures = [\"cp_time\", \"cp_dose\"]\n\nfor f in features:\n    df[f] = cuml.LabelEncoder().fit_transform(df[f])\n    \ndf = df[df[\"cp_type\"] == \"trt_cp\"]\n\ntarget_df = cudf.read_csv(\"\/kaggle\/input\/lish-moa\/train_targets_scored.csv\")\ntargets = [col for col in target_df.columns if col != \"sig_id\"]\n\ndf = df.merge(target_df, on=\"sig_id\")\ndf.shape","bfa6b18d":"# working on cudf support for LOFO. temporary solution for now:\ndf = df.to_pandas()","ef56679e":"from sklearn.metrics import make_scorer\nimport numpy as np\n\ndef score_func(y_true, y_pred):\n    y_true = y_true[0]\n    \n    y_pred = np.stack([(1 - y[:, 0]) for y in y_pred]).T\n    y_pred = np.clip(y_pred, 0.0005, 0.9995)\n    return ((y_true*np.log(y_pred)) + (1 - y_true)*np.log(1 - y_pred)).mean()\n\n\nscorer = make_scorer(score_func, greater_is_better=True, needs_proba=True, needs_threshold=False)","b8572343":"from lofo import LOFOImportance, Dataset, plot_importance\nimport cuml\n\n\n\ngene_features = [col for col in df.columns if col.startswith(\"g-\")]\ncell_features = [col for col in df.columns if col.startswith(\"c-\")]\n\nfeatures = gene_features + cell_features\n\ndataset = Dataset(df=df, target=targets, features=features)\n\nlofo_imp = LOFOImportance(dataset, cv=4, scoring=scorer, model=cuml.neighbors.KNeighborsClassifier(n_neighbors=1000))\n\nimportance_df = lofo_imp.get_importance()","9071e691":"importance_df.to_csv(\"feature_importance.csv\", index=False)\n\nimportance_df.head()","c4789df2":"plot_importance(importance_df.head(32), figsize=(8, 12), kind=\"box\")","17eab1c4":"plot_importance(importance_df.tail(32), figsize=(8, 12), kind=\"default\")","7692eaa0":"# Fast and Accurate Feature Importance using RAPIDS + LOFO"}}