{"cell_type":{"a9465195":"code","a4650620":"code","39ee8e58":"code","a26943e8":"code","ed958660":"code","1ad44119":"code","0d9c3ed0":"code","f65728f9":"code","b5e9778c":"code","c9b2bfd8":"code","ea1a6f30":"code","e4a56d7b":"markdown","ad5e3b72":"markdown"},"source":{"a9465195":"!conda install -c conda-forge gdcm -y","a4650620":"import glob\nimport pydicom\nimport os\nimport numpy as np\nimport pandas as pd","39ee8e58":"from pydicom.pixel_data_handlers.util import apply_voi_lut, apply_modality_lut\nfrom pydicom import dcmread\nimport matplotlib.pyplot as plt\n%matplotlib inline\n\n# functin to read dicom given the path , considers modality_lut and corrections w.r.t monochromes\ndef read_dicom( filepath ,modality_lut=True, fix_monochrome=True):\n    dcm = pydicom.read_file(filepath)\n    img = dcm.pixel_array\n    if modality_lut == True:\n        img = apply_modality_lut(dcm.pixel_array, dcm)\n    max_img = np.max(img)\n    min_img = np.min(img)\n    if fix_monochrome == True and dcm.PhotometricInterpretation=='MONOCHROME1':\n        img = max_img - img\n\n    img = (img - np.min(img))\/(max_img - min_img)\n    img = (img * 255).astype(np.uint8)\n\n    return img ","a26943e8":"dirs = glob.glob(os.path.join('\/kaggle\/input\/siim-covid19-detection','*'))\ndirs","ed958660":"train_study = pd.read_csv('\/kaggle\/input\/siim-covid19-detection\/train_study_level.csv')\nprint(train_study.columns)\ndf_sub = train_study[train_study['Negative for Pneumonia']==1]\nprint('length of negative for pnemonia',len(df_sub))\ndf_sub = train_study[train_study['Typical Appearance']==1]\nprint('length of Typical Appearance',len(df_sub))\ndf_sub = train_study[train_study['Indeterminate Appearance']==1]\nprint('length of Indeterminate Appearance',len(df_sub))\ndf_sub = train_study[train_study['Atypical Appearance']==1]\nprint('length of Atypical Appearance',len(df_sub))\n\n# train_study['id']","1ad44119":"df_sub = train_study[train_study['Atypical Appearance']==1]\n# df_sub = train_study[train_study['Indeterminate Appearance']==1]\n# df_sub = train_study[train_study['Typical Appearance']==1]\n# df_sub = train_study[train_study['Negative for Pneumonia']==1]\nstudy_id = [ item.split('_')[0] for item in  df_sub['id'].values]\nprint(len(df_sub))\ndf_sub.head()\n# study_id_ap\n","0d9c3ed0":"train_img = pd.read_csv('\/kaggle\/input\/siim-covid19-detection\/train_image_level.csv')\nfiltr  = [val in study_id   for val in train_img['StudyInstanceUID'].values]\ntrain_img = train_img[filtr]","f65728f9":"import ast\nimport json \nimport matplotlib.patches as patches\n\ndef convert_to_list(value):\n    try:\n        return ast.literal_eval(value)\n    except:\n        return []\n\ntrain_img['boxes'] = train_img['boxes'].apply(convert_to_list)\n","b5e9778c":"def process_bounding_boxes(boxes):\n    boxes_list = []\n    for box in boxes:\n        boxes_list.append([box['x'], box['y'], box['width'], box['height']])\n    return boxes_list\n        \ndef read_image_bb_index(train_img, index):\n    df = train_img.iloc[index]\n    study_id = df['StudyInstanceUID']\n    image_id = df['id'].split('_')[0]\n    path1 = '\/kaggle\/input\/siim-covid19-detection\/train\/'+study_id\n    path2 = image_id+'*dcm'\n    imagepath = glob.glob(os.path.join(path1,'*', path2))\n    img = read_dicom(imagepath[0])\n    \n    boxes_list = process_bounding_boxes(df['boxes'])\n    return img, boxes_list\n    \n    \ndef plot_examples(train_img, sz=16):\n#     fig, ax = plt.subplots(nrows=3, ncols=4, figsize=(16,12), gridspec_kw={'height_ratios': [1, 1, 1]})\n    fig, ax = plt.subplots(nrows=4, ncols=4, figsize=(16,16))\n    random_selection = np.random.choice(len(train_img), size=sz, replace=False)\n    for plt_idx,idx in enumerate(random_selection):\n        img, boxes_list = read_image_bb_index(train_img, idx)\n        row = int(plt_idx \/ 4)\n        col = int(plt_idx % 4)\n        ax[row][col].imshow(img, cmap='gray')\n\n        for bb in boxes_list:\n            rect = patches.Rectangle((bb[0], bb[1]), bb[2], bb[3], linewidth=1, \n                                     edgecolor='r', facecolor='none')\n            ax[row][col].add_patch(rect)\n    plt.subplots_adjust(hspace=0.1, wspace=0.2)\n\n    plt.show()\n        \n    ","c9b2bfd8":"plot_examples(train_img)","ea1a6f30":"# def find_empty(item_list):\n#     return len(item_list)\n# num_bb = [ find_empty(item) for item in train_img['boxes'] ]\n# np.any([ item==0  for item in num_bb])\n# filtr = [ item!=0  for item in num_bb]\n# # train_img_ip0 = train_img[filtr]\n# # train_img_ta0 = train_img[filtr]\n# train_img_na0 = train_img[filtr]\n\n# # print(len(num_bb))\n# # num_bb","e4a56d7b":"#### train_study is the dataframe from the Study level. train_img is the dataframe from the image_level. we first select the study pertaining to one of the 4 category, then find the images belongs to all those studies of the selected category.","ad5e3b72":"## Enable the line pertaining to    \"Atypical Appearance\", \"Inderminate Appearance\" , \"Typical Appearance\" , \"Negative for Pnuemonia\""}}