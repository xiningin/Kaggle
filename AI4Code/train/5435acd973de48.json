{"cell_type":{"63a5a902":"code","04ddd475":"code","fe11c842":"code","6466b0d3":"code","95a433e0":"code","cf910e11":"code","2bcb8e25":"code","89852e11":"code","ed17cc4b":"code","0e7177d3":"code","35cb0ae0":"code","22e5c53f":"code","7cd173bf":"code","afe8275d":"code","557f9246":"code","bbd3a34e":"code","0ab9869d":"code","48b95e83":"code","f9255f96":"code","b90b56b5":"code","ce27d3ce":"code","70b98a5a":"code","542b4163":"code","72bbf6c3":"code","308be052":"code","c8517e84":"code","d3b3408c":"code","c3e56ab9":"code","af63189d":"code","d4420b6b":"code","f1d2ba73":"code","bf25786b":"code","031bdf6c":"code","ab3b6470":"code","c20579e2":"code","1971b290":"code","04321f81":"code","9f663c08":"code","92fd02d7":"code","2774600f":"markdown","3d224450":"markdown","d2b859fd":"markdown","1ddde6a5":"markdown","d59ddb64":"markdown","a35dad9b":"markdown","8cb1a0ab":"markdown","45f81608":"markdown","fbf21b41":"markdown","58a221a9":"markdown","2a0492a2":"markdown","def58f39":"markdown","8b3adefb":"markdown","71d255b9":"markdown","0f5ea7ba":"markdown","38dddd87":"markdown","c65306ec":"markdown","fea6459f":"markdown","d30f2a43":"markdown","57ca0a49":"markdown","21cac16b":"markdown","278fac77":"markdown","10ef93e7":"markdown"},"source":{"63a5a902":"import pandas as pd       \nimport matplotlib as mat\nimport matplotlib.pyplot as plt    \nimport numpy as np\nimport seaborn as sns\n%matplotlib inline\n\npd.options.display.max_colwidth = 100\n\nimport random\nimport os\n\nfrom numpy.random import seed\nseed(42)\n\nrandom.seed(42)\nos.environ['PYTHONHASHSEED'] = str(42)\nos.environ['TF_DETERMINISTIC_OPS'] = '1'\n\nfrom sklearn.model_selection import train_test_split\nfrom sklearn import metrics\nfrom sklearn.metrics import accuracy_score\n\nimport tensorflow as tf\nfrom tensorflow import keras\nfrom tensorflow.keras import layers\nfrom tensorflow.keras import callbacks\nfrom tensorflow.keras.models import Model\nfrom tensorflow.keras.preprocessing.image import ImageDataGenerator\n\nimport glob\nimport cv2\n\nfrom tensorflow.random import set_seed\nset_seed(42)\n\nimport warnings\nwarnings.filterwarnings('ignore')","04ddd475":"IMG_SIZE = 224\nBATCH = 32\nSEED = 42","fe11c842":"#main_path = \"..\/input\/chest-xray-pneumonia\/chest_xray\/\"\nmain_path = \"..\/input\/labeled-chest-xray-images\/chest_xray\"\n\n\ntrain_path = os.path.join(main_path,\"train\")\ntest_path=os.path.join(main_path,\"test\")\n\ntrain_normal = glob.glob(train_path+\"\/NORMAL\/*.jpeg\")\ntrain_pneumonia = glob.glob(train_path+\"\/PNEUMONIA\/*.jpeg\")\n\ntest_normal = glob.glob(test_path+\"\/NORMAL\/*.jpeg\")\ntest_pneumonia = glob.glob(test_path+\"\/PNEUMONIA\/*.jpeg\")","6466b0d3":"train_list = [x for x in train_normal]\ntrain_list.extend([x for x in train_pneumonia])\n\ndf_train = pd.DataFrame(np.concatenate([['Normal']*len(train_normal) , ['Pneumonia']*len(train_pneumonia)]), columns = ['class'])\ndf_train['image'] = [x for x in train_list]\n\ntest_list = [x for x in test_normal]\ntest_list.extend([x for x in test_pneumonia])\n\ndf_test = pd.DataFrame(np.concatenate([['Normal']*len(test_normal) , ['Pneumonia']*len(test_pneumonia)]), columns = ['class'])\ndf_test['image'] = [x for x in test_list]","95a433e0":"df_train","cf910e11":"df_test","2bcb8e25":"plt.figure(figsize=(6,4))\n\nax = sns.countplot(x='class', data=df_train, palette=\"viridis\")\n\nplt.xlabel(\"Class\", fontsize= 12)\nplt.ylabel(\"# of Samples\", fontsize= 12)\nplt.ylim(0,5000)\nplt.xticks([0,1], ['Normal', 'Pneumonia'], fontsize = 11)\n\nfor p in ax.patches:\n    ax.annotate((p.get_height()), (p.get_x()+0.30, p.get_height()+300), fontsize = 13)\n    \nplt.show()","89852e11":"plt.figure(figsize=(7,5))\n\ndf_train['class'].value_counts().plot(kind='pie',labels = ['',''], autopct='%1.1f%%', colors = ['blue','salmon'], explode = [0,0.05], textprops = {\"fontsize\":15})\n\nplt.legend(labels=['Pneumonia', 'Normal'])\nplt.show()","ed17cc4b":"plt.figure(figsize=(6,4))\n\nax = sns.countplot(x='class', data=df_test, palette=\"viridis\")\n\nplt.xlabel(\"Class\", fontsize= 12)\nplt.ylabel(\"# of Samples\", fontsize= 12)\nplt.ylim(0,500)\nplt.xticks([0,1], ['Normal', 'Pneumonia'], fontsize = 11)\n\nfor p in ax.patches:\n    ax.annotate((p.get_height()), (p.get_x()+0.32, p.get_height()+20), fontsize = 13)\n    \nplt.show()","0e7177d3":"plt.figure(figsize=(7,5))\n\ndf_test['class'].value_counts().plot(kind='pie',labels = ['',''], autopct='%1.1f%%', colors = ['blue','salmon'], explode = [0,0.05], textprops = {\"fontsize\":15})\n\nplt.legend(labels=['Pneumonia', 'Normal'])\nplt.show()","35cb0ae0":"print('Train Set - Normal')\n\nplt.figure(figsize=(12,12))\n\nfor i in range(0, 12):\n    plt.subplot(3,4,i + 1)\n    img = cv2.imread(train_normal[i])\n    img = cv2.resize(img, (IMG_SIZE,IMG_SIZE))\n    plt.imshow(img)\n    plt.axis(\"off\")\n\nplt.tight_layout()\n\nplt.show()","22e5c53f":"print('Train Set - Pneumonia')\n\nplt.figure(figsize=(12,12))\n\nfor i in range(0, 12):\n    plt.subplot(3,4,i + 1)\n    img = cv2.imread(train_pneumonia[i])\n    img = cv2.resize(img, (IMG_SIZE,IMG_SIZE))\n    plt.imshow(img)\n    plt.axis(\"off\")\n\nplt.tight_layout()\n\nplt.show()","7cd173bf":"print('Test Set - Normal')\n\nplt.figure(figsize=(12,12))\n\nfor i in range(0, 12):\n    plt.subplot(3,4,i + 1)\n    img = cv2.imread(test_normal[i])\n    img = cv2.resize(img, (IMG_SIZE,IMG_SIZE))\n    plt.imshow(img)\n    plt.axis(\"off\")\n\nplt.tight_layout()\n\nplt.show()","afe8275d":"print('Test Set - Pneumonia')\n\nplt.figure(figsize=(12,12))\n\nfor i in range(0, 12):\n    plt.subplot(3,4,i + 1)\n    img = cv2.imread(test_pneumonia[i])\n    img = cv2.resize(img, (IMG_SIZE,IMG_SIZE))\n    plt.imshow(img)\n    plt.axis(\"off\")\n\nplt.tight_layout()\n\nplt.show()","557f9246":"train_df, val_df = train_test_split(df_train, test_size = 0.20, random_state = SEED, stratify = df_train['class'])","bbd3a34e":"train_df","0ab9869d":"val_df","48b95e83":"# https:\/\/vijayabhaskar96.medium.com\/tutorial-on-keras-flow-from-dataframe-1fd4493d237c\n\ntrain_datagen = ImageDataGenerator(rescale=1\/255.,\n                                  zoom_range = 0.1,\n                                  #rotation_range = 0.1,\n                                  width_shift_range = 0.1,\n                                  height_shift_range = 0.1)\n\nval_datagen = ImageDataGenerator(rescale=1\/255.)\n\nds_train = train_datagen.flow_from_dataframe(train_df,\n                                             #directory=train_path, #dataframe contains the full paths\n                                             x_col = 'image',\n                                             y_col = 'class',\n                                             target_size = (IMG_SIZE, IMG_SIZE),\n                                             class_mode = 'binary',\n                                             batch_size = BATCH,\n                                             seed = SEED)\n\nds_val = val_datagen.flow_from_dataframe(val_df,\n                                            #directory=train_path,\n                                            x_col = 'image',\n                                            y_col = 'class',\n                                            target_size = (IMG_SIZE, IMG_SIZE),\n                                            class_mode = 'binary',\n                                            batch_size = BATCH,\n                                            seed = SEED)\n\nds_test = val_datagen.flow_from_dataframe(df_test,\n                                            #directory=test_path,\n                                            x_col = 'image',\n                                            y_col = 'class',\n                                            target_size = (IMG_SIZE, IMG_SIZE),\n                                            class_mode = 'binary',\n                                            batch_size = 1,\n                                            shuffle = False)","f9255f96":"#Setting callbakcs\n\nearly_stopping = callbacks.EarlyStopping(\n    monitor='val_loss',\n    patience=5,\n    min_delta=0.0000001,\n    restore_best_weights=True,\n)\n\nplateau = callbacks.ReduceLROnPlateau(\n    monitor='val_loss',\n    factor = 0.2,                                     \n    patience = 2,                                   \n    min_delt = 0.0000001,                                \n    cooldown = 0,                               \n    verbose = 1\n) ","b90b56b5":"def get_model():\n    \n    #Input shape = [width, height, color channels]\n    inputs = layers.Input(shape=(IMG_SIZE, IMG_SIZE, 3))\n    \n    # Block One\n    x = layers.Conv2D(filters=16, kernel_size=3, padding='valid')(inputs)\n    x = layers.BatchNormalization()(x)\n    x = layers.Activation('relu')(x)\n    x = layers.MaxPool2D()(x)\n    x = layers.Dropout(0.2)(x)\n\n    # Block Two\n    x = layers.Conv2D(filters=32, kernel_size=3, padding='valid')(x)\n    x = layers.BatchNormalization()(x)\n    x = layers.Activation('relu')(x)\n    x = layers.MaxPool2D()(x)\n    x = layers.Dropout(0.2)(x)\n    \n    # Block Three\n    x = layers.Conv2D(filters=64, kernel_size=3, padding='valid')(x)\n    x = layers.Conv2D(filters=64, kernel_size=3, padding='valid')(x)\n    x = layers.BatchNormalization()(x)\n    x = layers.Activation('relu')(x)\n    x = layers.MaxPool2D()(x)\n    x = layers.Dropout(0.4)(x)\n\n    # Head\n    #x = layers.BatchNormalization()(x)\n    x = layers.Flatten()(x)\n    x = layers.Dense(64, activation='relu')(x)\n    x = layers.Dropout(0.5)(x)\n    \n    #Final Layer (Output)\n    output = layers.Dense(1, activation='sigmoid')(x)\n    \n    model = keras.Model(inputs=[inputs], outputs=output)\n    \n    return model","ce27d3ce":"keras.backend.clear_session()\n\nmodel = get_model()\nmodel.compile(loss='binary_crossentropy'\n              , optimizer = keras.optimizers.Adam(learning_rate=0.00003), metrics='binary_accuracy')\n\nmodel.summary()","70b98a5a":"history = model.fit(ds_train,\n          batch_size = BATCH, epochs = 5,\n          validation_data=ds_val,\n          callbacks=[early_stopping, plateau],\n          steps_per_epoch=(len(train_df)\/BATCH),\n          validation_steps=(len(val_df)\/BATCH));","542b4163":"fig, ax = plt.subplots(figsize=(20,8))\nsns.lineplot(x = history.epoch, y = history.history['loss'])\nsns.lineplot(x = history.epoch, y = history.history['val_loss'])\nax.set_title('Learning Curve (Loss)')\nax.set_ylabel('Loss')\nax.set_xlabel('Epoch')\nax.set_ylim(0, 0.5)\nax.legend(['train', 'val'], loc='best')\nplt.show()","72bbf6c3":"fig, ax = plt.subplots(figsize=(20,8))\nsns.lineplot(x = history.epoch, y = history.history['binary_accuracy'])\nsns.lineplot(x = history.epoch, y = history.history['val_binary_accuracy'])\nax.set_title('Learning Curve (Accuracy)')\nax.set_ylabel('Accuracy')\nax.set_xlabel('Epoch')\nax.set_ylim(0.80, 1.0)\nax.legend(['train', 'val'], loc='best')\nplt.show()","308be052":"score = model.evaluate(ds_val, steps = len(val_df)\/BATCH, verbose = 0)\nprint('Val loss:', score[0])\nprint('Val accuracy:', score[1])","c8517e84":"score = model.evaluate(ds_test, steps = len(df_test), verbose = 0)\n\nprint('Test loss:', score[0])\nprint('Test accuracy:', score[1])","d3b3408c":"base_model = tf.keras.applications.ResNet152V2(\n    weights='imagenet',\n    input_shape=(IMG_SIZE, IMG_SIZE, 3),\n    include_top=False)\n\nbase_model.trainable = False\n\ndef get_pretrained():\n    \n    #Input shape = [width, height, color channels]\n    inputs = layers.Input(shape=(IMG_SIZE, IMG_SIZE, 3))\n    \n    x = base_model(inputs)\n\n    # Head\n    x = layers.GlobalAveragePooling2D()(x)\n    x = layers.Dense(128, activation='relu')(x)\n    x = layers.Dropout(0.1)(x)\n    \n    #Final Layer (Output)\n    output = layers.Dense(1, activation='sigmoid')(x)\n    \n    model = keras.Model(inputs=[inputs], outputs=output)\n    \n    return model","c3e56ab9":"keras.backend.clear_session()\n\nmodel_pretrained = get_pretrained()\nmodel_pretrained.compile(loss='binary_crossentropy'\n              , optimizer = keras.optimizers.Adam(learning_rate=0.00005), metrics='binary_accuracy')\n\nmodel_pretrained.summary()","af63189d":"history = model_pretrained.fit(ds_train,\n          batch_size = BATCH, epochs = 1,\n          validation_data=ds_val,\n          callbacks=[early_stopping, plateau],\n          steps_per_epoch=(len(train_df)\/BATCH),\n          validation_steps=(len(val_df)\/BATCH));","d4420b6b":"fig, ax = plt.subplots(figsize=(20,8))\nsns.lineplot(x = history.epoch, y = history.history['loss'])\nsns.lineplot(x = history.epoch, y = history.history['val_loss'])\nax.set_title('Learning Curve (Loss)')\nax.set_ylabel('Loss')\nax.set_xlabel('Epoch')\nax.set_ylim(0, 0.5)\nax.legend(['train', 'val'], loc='best')\nplt.show()","f1d2ba73":"fig, ax = plt.subplots(figsize=(20,8))\nsns.lineplot(x = history.epoch, y = history.history['binary_accuracy'])\nsns.lineplot(x = history.epoch, y = history.history['val_binary_accuracy'])\nax.set_title('Learning Curve (Accuracy)')\nax.set_ylabel('Accuracy')\nax.set_xlabel('Epoch')\nax.set_ylim(0.80, 1.0)\nax.legend(['train', 'val'], loc='best')\nplt.show()","bf25786b":"score = model_pretrained.evaluate(ds_val, steps = len(val_df)\/BATCH, verbose = 0)\nprint('Val loss:', score[0])\nprint('Val accuracy:', score[1])","031bdf6c":"score = model_pretrained.evaluate(ds_test, steps = len(df_test), verbose = 0)\nprint('Test loss:', score[0])\nprint('Test accuracy:', score[1])","ab3b6470":"num_label = {'Normal': 0, 'Pneumonia' : 1}\nY_test = df_test['class'].copy().map(num_label).astype('int')","c20579e2":"ds_test.reset()\npredictions = model_pretrained.predict(ds_test, steps=len(ds_test), verbose=0)\npred_labels= np.where(predictions>0.5, 1, 0)","1971b290":"print(\"Test Accuracy: \", accuracy_score(Y_test, pred_labels))","04321f81":"confusion_matrix = metrics.confusion_matrix(Y_test, pred_labels)\nsns.heatmap(confusion_matrix, annot=True, fmt=\"d\")\n\nplt.xlabel(\"Predicted Label\", fontsize= 12)\nplt.ylabel(\"True Label\", fontsize= 12)\n\nplt.show()","9f663c08":"print(metrics.classification_report(Y_test, pred_labels, labels = [0, 1]))","92fd02d7":"roc_auc = metrics.roc_auc_score(Y_test, predictions)\nprint('ROC_AUC: ', roc_auc)\n\nfpr, tpr, thresholds = metrics.roc_curve(Y_test, predictions)\n\nplt.plot(fpr, tpr, label = 'ROC_AUC = %0.3f' % roc_auc)\n\nplt.xlabel(\"False Positive Rate\", fontsize= 12)\nplt.ylabel(\"True Positive Rate\", fontsize= 12)\nplt.legend(loc=\"lower right\")\n\nplt.show()","2774600f":"First, we need to create a validation set. To do that, we apply a simple stratified split on the original train dataset, using 80% for actual training and 20% for validation purposes.","3d224450":"Let's check the target distribution on each set","d2b859fd":"## <center> If you find this notebook useful, support with an upvote! <center>","1ddde6a5":"# <a id=\"4\">Preparing the Data<\/a> ","d59ddb64":"## <center> If you find this notebook useful, support with an upvote! <center>","a35dad9b":"# <a id=\"5\">Custom CNN<\/a>","8cb1a0ab":"The distributions from these datasets are a little different from each other. Both are slightly imbalanced, having more samples from the positive class (Pneumonia), with the training set being a little more imbalanced.\n\nBefore we move on to the next section, we will take a look at a few examples from each dataset.","45f81608":"Let\u2019s define our first model \u2018from scratch\u2019 and see how it performs.","fbf21b41":"<br>\n<h1 style = \"font-size:30px; font-weight : bold; color : blue; text-align: center; border-radius: 10px 15px;\">Chest X-Ray (Pneumonia): Image Classification w\/Convolutional Neural Networks and Transfer Learning<\/h1>\n<br>\n\n---","58a221a9":"<img src=\"https:\/\/www.collinsdictionary.com\/images\/full\/xray_560923156_1000.jpg\" width=\"620\" height=\"360\" align=\"center\"\/>","2a0492a2":"# <a id=\"6\">Transfer Learning<\/a> ","def58f39":"- https:\/\/vijayabhaskar96.medium.com\/tutorial-on-keras-flow-from-dataframe-1fd4493d237c\n- https:\/\/github.com\/mrdbourke\/tensorflow-deep-learning\/blob\/main\/03_convolutional_neural_networks_in_tensorflow.ipynb\n- https:\/\/www.tensorflow.org\/guide\/keras\/transfer_learning\n- https:\/\/www.tensorflow.org\/api_docs\/python\/tf\/keras\/preprocessing\/image\/ImageDataGenerator\n- https:\/\/keras.io\/api\/applications\/\n- https:\/\/keras.io\/api\/applications\/resnet\/#resnet152v2-function","8b3adefb":"The recall was close to 100%. Even without expertise on the medical field, it\u2019s reasonable to assume that false negatives are more \u2018costly\u2019 than false positives in this case. Reaching such recall with a relatively small dataset for training as this one, while also reaching a pretty good recall, is a good indicative of the model\u2019s capabilities. Such capabilities are also confirmed by the high ROC-AUC value.","71d255b9":"# <a id=\"3\">Exploring the Data<\/a> ","0f5ea7ba":"# <a id=\"2\">Importing Packages and Dataset<\/a> ","38dddd87":"# <a id=\"8\">Performance Metrics<\/a> ","c65306ec":"Now, we\u2019re going to load the images from the folders and prepare them to feed our models. \n\nWe begin by defining the data generators. With Keras Image Data Generator, we can rescale the pixel values and apply random transformation techniques for data augmentation on the fly. We define two different generators. The val_datagen is used to simply rescale the validation and test sets. The train_datagen includes some transformations to augment the train set.\n\nWe apply those generators on each dataset using the flow_from_dataframe method. Apart from the transformations defined in each generator, the images are also resized based on the target_size set.","fea6459f":"# Overview\n\nThe goal of this notebook is to use Convolutional Neural Networks on Chest X-Ray images to determine which samples are from patients with Pneumonia. In this dataset (version 3), there is one folder representing the train set and another one for the test set. The train folder is later split in the notebook into train\/validation sets.\n\nI use three different approaches for image classification: 1) A simple CNN, 2) Transfer Learning, using a pretrained model with frozen layers as the base for feature extraction and 3) Fine Tuning, unfreezing the last layers of the pretrained model.\n\nNote: I\u2019m using the third version of the Chest X-Ray dataset [(link)](https:\/\/www.kaggle.com\/tolgadincer\/labeled-chest-xray-images)","d30f2a43":"# <a id=\"1\">Dataset Information<\/a> \n\nThis dataset contains 5,856 validated Chest X-Ray images. The images are split into a training set and a testing set of independent patients. Images are labeled as (disease:NORMAL\/BACTERIA\/VIRUS)-(randomized patient ID)-(image number of a patient).\n\nChest X-ray images (anterior-posterior) were selected from retrospective cohorts of pediatric patients of one to five years old from Guangzhou Women and Children\u2019s Medical Center, Guangzhou. All chest X-ray imaging was performed as part of patients\u2019 routine clinical care.\n\nFor the analysis of chest x-ray images, all chest radiographs were initially screened for quality control by removing all low quality or unreadable scans. The diagnoses for the images were then graded by two expert physicians before being cleared for training the AI system. In order to account for any grading errors, the evaluation set was also checked by a third expert.","57ca0a49":"# <a id=\"9\">References<\/a> ","21cac16b":"The second approach, called transfer learning, consists of using a pretrained model as a feature extractor. In this notebook, the selected model was the ResNet152V2 available on the Keras Package [(link)](https:\/\/keras.io\/api\/applications\/resnet\/#resnet152v2-function). \n\nThis model was already trained in another dataset (ImageNet). What we do here is to set include_top to false, removing the \u2018head\u2019, responsible for assigning the classes in this other dataset, and keep all the previous layers. Then, we include our last few layers, including the one responsible for generating the output.\n\n","278fac77":"Now, we are ready for the next stage: creating and training the image classification models.","10ef93e7":"# <a id='0'>Content<\/a>\n\u200b\n- <a href='#1'>Dataset Information<\/a>  \n- <a href='#2'>Importing Packages and Dataset<\/a>  \n- <a href='#3'>Exploring the Data<\/a>  \n- <a href='#4'>Preparing the Data<\/a>\n- <a href='#5'>Custom Model<\/a>\n- <a href='#6'>Transfer Learning<\/a>\n- <a href='#7'>Fine Tuning<\/a>\n- <a href='#8'>Performance Metrics<\/a>\n- <a href='#9'>References<\/a>"}}