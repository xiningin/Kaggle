{"cell_type":{"ca44df37":"code","38bda3db":"code","c1e10c1a":"code","9b5945ab":"code","73ab2a37":"code","f4bedef8":"code","55768746":"code","48a3b9f3":"code","b726a017":"code","7f3ddff0":"code","b1705e11":"code","fff51e34":"code","b4e587c0":"markdown","10be0f40":"markdown","f6c9373b":"markdown","64cd90ca":"markdown","7de81de3":"markdown","0dabc027":"markdown","1ebdb889":"markdown","14962514":"markdown"},"source":{"ca44df37":"import pandas as pd \nimport numpy as np\nimport os\nfrom tqdm import tqdm_notebook\nfrom ipywidgets import interact_manual\n\n\nimport plotly.offline as py\nimport plotly.graph_objs as go\nimport plotly.figure_factory as ff\npy.init_notebook_mode(connected=True)\n\npd.options.display.max_columns = 110\npd.options.display.max_rows = 300\n\nimport warnings\nwarnings.simplefilter('ignore')","38bda3db":"# # Next few kernels will quickly clean the data:\n# dtypes\ndtypes = {\n'YEAR':object,\n# 'TRI_FACILITY_ID': object,\n# 'FRS_ID':object,\n# 'FACILITY_NAME':object,\n# # 'STREET_ADDRESS':object,\n'CITY':object,\n'COUNTY':object,\n'ST':'object',\n# 'ZIP':object,\n# 'BIA_CODE':'category',\n# 'TRIBE':object,\n'LATITUDE':object,\n'LONGITUDE':object,\n# 'FEDERAL_FACILITY':'category',\n# 'INDUSTRY_SECTOR_CODE':'category',\n'INDUSTRY_SECTOR':'category',\n# 'PRIMARY_SIC':'category',\n# 'SIC_2':'category',\n# 'SIC_3':'category',\n# 'SIC_4':'category',\n# 'SIC_5':'category',\n# 'SIC_6':'category',\n# 'PRIMARY_NAICS':'category',\n# 'NAICS_2':'category',\n# 'NAICS_3':'category',\n# 'NAICS_4':'category',\n# 'NAICS_5':'category',\n# 'NAICS_6':'category',\n# 'DOC_CTRL_NUM':object,\n'CHEMICAL':'object',\n# 'CAS_#\/COMPOUND_ID':object,\n# 'SRS_ID':object,\n# 'CLEAR_AIR_ACT_CHEMICAL':'category',\n# 'CLASSIFICATION':'category',\n# 'METAL':'category',\n# 'METAL_CATEGORY':int,\n# 'CARCINOGEN':'category',\n# 'FORM_TYPE':'category',\n'UNIT_OF_MEASURE':object,\n# '5.1_FUGITIVE_AIR':object,\n# '5.2_STACK_AIR':float,\n# '5.3_WATER':float,\n# '5.4_UNDERGROUND':float,\n# '5.4.1_UNDERGROUND_CLASS_I':float,\n# '5.4.2_UNDERGROUND_CLASS_II-V':float,\n# '5.5.1_LANDFILLS':float,\n# '5.5.1A_RCRA_C_LANDFILLS':float,\n# '5.5.1B_OTHER_LANDFILLS':float,\n# '5.5.2_LAND_TREATMENT':float,\n# '5.5.3_SURFACE_IMPOUNDMENT':float,\n# '5.5.3A_RCRA_C_SURFACE_IMP.':float,\n# '5.5.3B_Other_SURFACE_IMP.':float,\n# '5.5.4_OTHER_DISPOSAL':float,\n# 'ON-SITE_RELEASE_TOTAL':float,\n# '6.1_POTW-TRANSFERS_FOR_RELEASE':float,\n# '6.1_POTW-TRANSFERS_FOR_TREATM.':float,\n# '6.1_POTW-TOTAL_TRANSFERS':float,\n# '6.2_M10':float,\n# '6.2_M41':float,\n# '6.2_M62':float,\n# '6.2_M71':float,\n# '6.2_M81':float,\n# '6.2_M82':float,\n# '6.2_M72':float,\n# '6.2_M63':float,\n# '6.2_M66':float,\n# '6.2_M67':float,\n# '6.2_M64':float,\n# '6.2_M65':float,\n# '6.2_M73':float,\n# '6.2_M79':float,\n# '6.2_M90':float,\n# '6.2_M94':float,\n# '6.2_M99':float,\n# 'OFF-SITE_RELEASE_TOTAL':float,\n# '6.2_M20':float,\n# '6.2_M24':float,\n# '6.2_M26':float,\n# '6.2_M28':float,\n# '6.2_M93':float,\n# 'OFF-SITE_RECYCLED_TOTAL':float,\n# '6.2_M56':float,\n# '6.2_M92':float,\n# 'OFF-SITE_RECOVERY_TOTAL':float,\n# '6.2_M40':float,\n# '6.2_M50':float,\n# '6.2_M54':float,\n# '6.2_M61':float,\n# '6.2_M69':float,\n# '6.2_M95':float,\n# 'OFF-SITE_TREATED_TOTAL':float,\n'TOTAL_RELEASES':object,\n# '8.1_RELEASES':object,\n# '8.1A_ON-SITE_CONTAINED_REL.':float,\n# '8.1B_ON-SITE_OTHER_RELEASES':float,\n# '8.1C_OFF-SITE_CONTAINED_REL.':float,\n# '8.1D_OFF-SITE_OTHER_RELEASES':float,\n# '8.2_ENERGY_RECOVERY_ON-SITE':float,\n# '8.3_ENERGY_RECOVERY_OFF-SITE':float,\n# '8.4_RECYCLING_ON-SITE':float,\n# ' 8.5_RECYCLING_OFF-SITE':float,\n# '8.6_TREATMENT_ON-SITE':float,\n# # '8.7_TREATMENT_OFF-SITE':float,\n# 'PROD._WASTE_(8.1_THRU_8.7)':float\n# '8.8_ONE-TIME_RELEASE':float,\n# 'PROD_RATIO_OR_ACTIVITY':object,\n# '8.9_PRODUCTION_RATIO':float,\n# 'PARENT_COMPANY_NAME':object,\n# 'PARENT_COMPANY_DB_NUMBER':object,\n}","c1e10c1a":"%%time\ndata_1 = pd.read_csv('..\/input\/basic_data_files.csv', nrows=2548770, low_memory=True, dtype=dtypes, usecols=dtypes.keys())\ndata_2 = pd.read_csv('..\/input\/basic_data_files.csv', skiprows=2548771, low_memory=True, dtype=dtypes, usecols=dtypes.keys())\n\ndata_clean = data_1.append(data_2, ignore_index=True)\ndata_clean = data_clean.drop(index=data_clean[data_clean.YEAR == 'YEAR'].index).reset_index(drop=True)\n\n# redefine data types to speed up manipulation:\ndtypes = {'YEAR': int, 'ST': 'category', 'COUNTY': 'category', 'CITY': 'category', 'CHEMICAL':'category', 'TOTAL_RELEASES': float,\n         'LATITUDE': float, 'LONGITUDE': float, 'INDUSTRY_SECTOR':'category'}\ndata = data_clean.astype(dtypes)","9b5945ab":"data.head()","73ab2a37":"years = [i for i in range(1987, 2016+1)]\n\n# create steps for slider\ndef get_steps(years):\n    steps = []\n    for i in range(0,len(years)):\n        step = dict(method = \"restyle\",\n                    args = [\"visible\", [False]*len(years)],\n                    label = years[i]) \n        step['args'][1][i] = True\n        steps.append(step)\n    return steps\n\n# Sliders layout:\ndef get_sliders(steps):\n    sliders = [dict(active = 10,\n                    currentvalue = {\"prefix\": \"Year: \"},\n                    pad = {\"t\": 50},\n                    steps = steps)]\n    return sliders\n\n# get dataframe of only selected chemical \ndef get_cont_sites(chemicals): \n    return data[data.CHEMICAL.isin([chemicals])]\n\n# make dataframe with values for choropleth colors\ndef get_state_counts(cont_sites):\n    # fill each year column with the number of contaminated sites in each state\n    state_counts = pd.DataFrame(index=data[data.YEAR == 2016].ST.value_counts().sort_index().index.tolist(), columns=years)\n    for i in years: \n        totals_temp = cont_sites[cont_sites.YEAR == i][['ST', 'TOTAL_RELEASES']].groupby(['ST']).sum().unstack()\n        state_counts[i] = pd.DataFrame(index=totals_temp.index.levels[1].tolist(), data=totals_temp.values, columns=[i])\n\n    state_counts.loc['norm'] = state_counts.max().max()\n    return state_counts\n\n\n\nsteps = get_steps(years)\nsliders = get_sliders(steps)\n\ndef plot_choro(Chemical='TETRACHLOROETHYLENE'):\n    cont_sites = get_cont_sites(Chemical)\n    state_counts = get_state_counts(cont_sites)\n\n    # create a list and loop through every year, store the trace in data_bal and then update with a new year\n    data_bal = []\n    for i in years:\n        data_upd = [dict(type='choropleth',\n                         name=i,\n                          colorscale = 'Reds',\n                          reversescale=False,\n                          locations = state_counts[i].index,\n                          z = state_counts[i].values,\n                          locationmode = 'USA-states',\n                          colorbar = dict(title='Pounds Released Per Year')\n                        )\n                   ]\n\n        data_bal.extend(data_upd)\n\n\n    # Set the layout\n    layout = dict(title = 'Total Released ' + Chemical + ' In Pounds',\n                  geo = dict(scope='usa',\n                             projection=dict( type='albers usa')),\n                  sliders = sliders)\n\n    fig = dict(data=data_bal, layout=layout)\n    py.iplot(fig)","f4bedef8":"plot_choro(Chemical='TETRACHLOROETHYLENE')","55768746":"data_2016 = data[(data['CHEMICAL'] == 'TETRACHLOROETHYLENE') & (data['YEAR'] == 2016)]\ndata_2016 = data_2016.groupby(['LATITUDE', 'LONGITUDE', 'INDUSTRY_SECTOR']).agg({'TOTAL_RELEASES': 'sum'}).reset_index()","48a3b9f3":"heat_data = [[row['LATITUDE'],row['LONGITUDE'], row['TOTAL_RELEASES']] for index, row in data_2016.iterrows()]","b726a017":"# folium heatmap:\nimport folium\nfrom folium.plugins import HeatMap\nimport branca.colormap as cm\n\nmap_demo = folium.Map([39.09973, -94.57857], zoom_start=4)\n\n# #define colorbar\n# steps = 20\n# color_map=cm.linear.viridis.scale(0,1).to_step(steps)\n# gradient_map=dict()\n# for i in range(steps):\n#     gradient_map[1\/steps*i] = color_map.rgb_hex_str(1\/steps*i)\n\n# HeatMap(heat_data, gradient = gradient_map).add_to(map_demo)\n\n# color_map.caption = 'Colorbar'\n# map_demo.add_child(color_map)\n\n#Function to change colors\ndef color_change(releases):\n    max_ = max(data['TOTAL_RELEASES'])\n    if(releases < max_ \/ 3):\n        return('green')\n    elif(max_ <= releases < max_):\n        return('orange')\n    else:\n        return('red')\n\nfor lat, lon, weight, sector in zip(data_2016['LATITUDE'], data_2016['LONGITUDE'], data_2016['TOTAL_RELEASES'], data_2016['INDUSTRY_SECTOR']):\n    folium.CircleMarker(location=[lat, lon], radius = 9, popup=sector + \": \" + str(weight)+\" lbs\", \n                        fill_color=color_change(weight)).add_to(map_demo)\n\n\nmap_demo","7f3ddff0":"# folium heatmap:\nimport folium\nfrom folium.plugins import HeatMap\nimport branca.colormap as cm\n\ndata_HM = data[(data['CHEMICAL'] == 'TETRACHLOROETHYLENE') & (data['YEAR'] == 2016)]\ndata_HM = data_HM.groupby(['LATITUDE', 'LONGITUDE']).agg({'TOTAL_RELEASES': 'sum'}).reset_index()\n\nmap_HM = folium.Map([39.09973, -94.57857], zoom_start=4)\n\nheat_data = [[row['LATITUDE'],row['LONGITUDE'], row['TOTAL_RELEASES']] for index, row in data_HM.iterrows()]\n\nHeatMap(heat_data).add_to(map_HM)\nmap_HM","b1705e11":"TCE_data = data[(data['CHEMICAL'] == 'TETRACHLOROETHYLENE')]\nTCE_data = TCE_data.groupby(['YEAR', 'LATITUDE', 'LONGITUDE']).agg({'TOTAL_RELEASES': 'sum'}).reset_index()\nTCE_data = TCE_data.sort_values(by='YEAR', axis=0, ascending=False)\n\n#year 1987:2016\nheat_data = [[[row['LATITUDE'],row['LONGITUDE'], row['TOTAL_RELEASES']] for index, row in TCE_data[TCE_data['YEAR'] == i].iterrows()] for i in range(1987, 2017)]\n\nfrom folium import plugins\ntime_map_HM = folium.Map([39.09973, -94.57857], zoom_start=4)\n\n# Plot it on the map\nhm = plugins.HeatMapWithTime(heat_data,auto_play=True,max_opacity=0.8)\nhm.add_to(time_map_HM)\ntime_map_HM","fff51e34":"#plot chlorinated ethylene releases over time\ntemp = data.groupby(['CHEMICAL', 'YEAR']).agg({'TOTAL_RELEASES': 'sum'})\ntemp = temp.reset_index()\n\ntraces = []\nfor i in ['TETRACHLOROETHYLENE', 'TRICHLOROETHYLENE', '1,2-DICHLOROETHYLENE',\n         'VINYL CHLORIDE']:\n    temp_ = temp[temp['CHEMICAL'] == i]\n    trace = go.Scatter(x=temp_['YEAR'], y=temp_['TOTAL_RELEASES'], name=i)\n    traces.append(trace)\n    \nlayout = go.Layout(title='Chlorinated Ethylene Reported Releases in the US',\n                  yaxis=dict(title='Pounds'), xaxis=dict(title='Year'))    \nfig = go.Figure(data = traces, layout=layout)\npy.iplot(fig)","b4e587c0":"Heat map with time:","10be0f40":"## Bibliography\n        ITRC. (2008). In Situ Bioremediation of Chlorinated Ethene: DNAPL Source Zones, 138.\n\n        Stroo, H. F., Unger, M., Ward, C. H., Kavanaugh, M. C., Vogel, C. M., Leeson, A., \u2026 Smith, B. P. (2003). Remediating: A workshop lists the challenges and research needs., 7.\n\n        Stroo, H. F., West, M. R., Kueper, B. H., Borden, R. C., Major, D. W., & Ward, C. H. (2014). IN SITU Bioremediation Of Chlorinated Ethene Source Zones. In B. H. Kueper, H. F. Stroo, C. M. Vogel, & C. H. Ward (Eds.), Chlorinated Solvent Source Zone Remediation (pp. 395\u2013457). New York, NY: Springer New York. https:\/\/doi.org\/10.1007\/978-1-4614-6922-3_12","f6c9373b":"Out of interest, let's look at the reported releases of the other chlorinated ethylenes:","64cd90ca":"# PCE Contamination By US State\nAuthor: Matan Freedman\n\nChlorinated solvents are one of the most prevalent contaminants of groundwater in North America (ITRC, 2008; Stroo et al., 2003; Stroo et al., 2014). Perchloroethene (a.k.a. perchloroethylene or PCE) and trichloroethene (TCE) are typically found in dry cleaning chemicals, adhesives, shoe polish, spot removers, paint products, degreasers, and many other common products. As a result, they are found at 80% of all Superfund sites and over 3000 U.S. Department of Defence (US DoD) sites. The cost of cleaning up these sites is estimated at several billion dollars, with the US DoD estimated to spend over 100 million dollars with additional life cycle costs that exceed 2 billion dollars dollars (Stroo et al., 2003). PCE and TCE are particularly difficult to clean up because they are highly insoluble and denser than water (DNAPL). Due to their physical properties, once PCE and TCE are introduced to the subsurface, they will migrate down below the water table and remain in the subsurface for a long time. In addition, since the DNAPL is typically very deep, excavation is logistically impossible or otherwise astronomically expensive. Modern remediation strategies for PCE and TCE include in-situ bioremediation (ISB), in-situ chemical oxidation (ISCO), in-situ air sparging, surfactant flushing, cosolvent flushing, and six-phase heating (Stroo et al., 2003). Many remediation strategies produce gas (ex. methane and carbon dioxide) as well as daughter products that can be harmful and volatile. PCE and TCE remediation technologies have a large amount of uncertainty before implementation and are still being studied and developed.\n\nIn this kernel I will use the Toxic Release Inventory dataset provided by the EPA to show the total reported releases in the US over time. ","7de81de3":"Heatmap of TCE toxic releases reported to the US EPA in 2016:","0dabc027":"![](https:\/\/i.imgur.com\/CSRPuEo.png)","1ebdb889":"I've cleaned the data already, below shows the results we are left to work with. The year ranges from 1987 - 2016, with over 600 chemicals and each total release summed in pounds (sum of all total release categories for EPA reporting). There are over 5 million records in this dataset.","14962514":"Below is the choropleth of PCE reported release in pounds in each state for every available year in the dataset."}}