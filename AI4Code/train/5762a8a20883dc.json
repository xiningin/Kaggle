{"cell_type":{"c02550a3":"code","ab11c092":"code","0494f142":"code","bfb532e0":"code","6d9bd746":"code","686ac3f5":"code","eb73c952":"code","78b0aee3":"code","d1e18856":"markdown","b96bc28e":"markdown","7fc13aee":"markdown","92aa80e1":"markdown","83495b4a":"markdown","e4dded1a":"markdown","a01e9011":"markdown","3d8b94fd":"markdown","75dc0971":"markdown","fdbb211c":"markdown"},"source":{"c02550a3":"import numpy as np\nimport pandas as pd\nimport matplotlib.pyplot as plt\n\nimport torch, torchvision\nfrom torchvision import transforms\nfrom torch import nn, optim\nfrom torch.utils.data import Dataset\nfrom torch.utils.data import DataLoader as DL\nfrom torch.nn.utils import weight_norm as WN\nimport torch.nn.functional as F\n\nimport gc\nimport os\nimport cv2\nfrom time import time\n\ntorch.backends.cudnn.deterministic = True\ntorch.backends.cudnn.benchmark = False\n\nseed = 42","ab11c092":"def breaker():\n    print(\"\\n\" + 50*\"-\" + \"\\n\")\n\ndef head(x, no_of_ele=5):\n    print(x[:no_of_ele])\n    \ndef getImages(file_path=None, file_names=None, size=None):\n    images = []\n    for name in file_names:\n        try:\n            image = cv2.imread(file_path + name + \".jpg\", cv2.IMREAD_GRAYSCALE)\n        except AttributeError:\n            print(file_path + name)\n        if size:\n            image = cv2.resize(image, dsize=(size, size), interpolation=cv2.INTER_LANCZOS4)\n        images.append(image.reshape(size, size, 1))\n    return np.array(images)","0494f142":"start_time = time()\n\nss = pd.read_csv(\"..\/input\/ranzcr-clip-catheter-line-classification\/sample_submission.csv\")\n\nts_img_names = ss[\"StudyInstanceUID\"].values\nts_images = getImages(\"..\/input\/ranzcr-clip-catheter-line-classification\/test\/\", \n                      ts_img_names, \n                      size=384)\n\nbreaker()\nprint(\"Time Taken to read data : {:.2f} minutes\".format((time() - start_time)\/60))\nbreaker()","bfb532e0":"class DS(Dataset):\n    def __init__(this, X=None, y=None, transform=None, mode=\"train\"):\n        this.mode = mode\n        this.transform = transform\n        this.X = X\n        if mode == \"train\":\n            this.y = y\n                 \n    def __len__(this):\n        return this.X.shape[0]\n    \n    def __getitem__(this, idx):\n        img = this.transform(this.X[idx])\n        if this.mode == \"train\":\n            return img, torch.FloatTensor(this.y[idx])\n        else:\n            return img","6d9bd746":"class CFG():\n    tr_batch_size = 64\n    # va_batch_size = 128\n    ts_batch_size = 64\n    \n    device = torch.device(\"cuda\" if torch.cuda.is_available() else \"cpu\")\n    \n    in_channels = 1\n    OL = 11\n    \n    def __init__(this, filter_sizes=[64, 128, 256, 512], HL=[2048], epochs=50, n_folds=5):\n        this.filter_sizes = filter_sizes\n        this.HL = HL\n        this.epochs = epochs\n        this.n_folds = n_folds","686ac3f5":"class CNN(nn.Module):\n    def __init__(this, in_channels=1, filter_sizes=None, HL=None, OL=None, use_DP=True, DP=0.50):\n        \n        super(CNN, this).__init__()\n        \n        this.use_DP = use_DP\n        \n        this.DP_ = nn.Dropout(p=DP)\n        this.MP_ = nn.MaxPool2d(kernel_size=2)\n        \n        this.CN1 = nn.Conv2d(in_channels=in_channels, out_channels=filter_sizes[0], kernel_size=3, stride=1, padding=1)\n        this.BN1 = nn.BatchNorm2d(num_features=filter_sizes[0], eps=1e-5)\n        \n        this.CN2 = nn.Conv2d(in_channels=filter_sizes[0], out_channels=filter_sizes[1], kernel_size=3, stride=1, padding=1)\n        this.BN2 = nn.BatchNorm2d(num_features=filter_sizes[1], eps=1e-5)\n        \n        this.CN3 = nn.Conv2d(in_channels=filter_sizes[1], out_channels=filter_sizes[2], kernel_size=3, stride=1, padding=1)\n        this.BN3 = nn.BatchNorm2d(num_features=filter_sizes[2], eps=1e-5)\n        \n        this.CN4 = nn.Conv2d(in_channels=filter_sizes[2], out_channels=filter_sizes[3], kernel_size=3, stride=1, padding=1)\n        this.BN4 = nn.BatchNorm2d(num_features=filter_sizes[3], eps=1e-5)\n        \n        this.CN5 = nn.Conv2d(in_channels=filter_sizes[3], out_channels=filter_sizes[3], kernel_size=3, stride=1, padding=1)\n        this.BN5 = nn.BatchNorm2d(num_features=filter_sizes[3], eps=1e-5)\n        \n        this.CN6 = nn.Conv2d(in_channels=filter_sizes[3], out_channels=filter_sizes[3], kernel_size=3, stride=1, padding=1)\n        this.BN6 = nn.BatchNorm2d(num_features=filter_sizes[3], eps=1e-5)\n        \n        this.CN7 = nn.Conv2d(in_channels=filter_sizes[3], out_channels=filter_sizes[3], kernel_size=3, stride=1, padding=1)\n        this.BN7 = nn.BatchNorm2d(num_features=filter_sizes[3], eps=1e-5)\n        \n        this.FC1 = nn.Linear(in_features=filter_sizes[3] * 3 * 3, out_features=HL[0])\n        this.FC2 = nn.Linear(in_features=HL[0], out_features=OL)\n        \n    def getOptimizer(this, lr=1e-3, wd=0):\n        return optim.Adam(this.parameters(), lr=lr, weight_decay=wd)\n    \n    def getStepLR(this, optimizer=None, step_size=5, gamma=0.1):\n        return optim.lr_scheduler.StepLR(optimizer=optimizer, step_size=step_size, gamma=gamma)\n    \n    def getMultiStepLR(this, optimizer=None, milestones=None, gamma=0.1):\n        return optim.lr_scheduler.MultiStepLR(optimizer=optimizer, milestones=milestones, gamma=gamma)\n    \n    def getPlateauLR(this, optimizer=None, patience=5, eps=1e-8):\n        return optim.lr_scheduler.ReduceLROnPlateau(optimizer=optimizer, patience=patience, eps=1e-8, verbose=True)\n    \n    def forward(this, x):\n        if this.use_DP:\n            x = F.relu(this.MP_(this.BN1(this.CN1(x))))\n            x = F.relu(this.MP_(this.BN2(this.CN2(x))))\n            x = F.relu(this.MP_(this.BN3(this.CN3(x))))\n            x = F.relu(this.MP_(this.BN4(this.CN4(x))))\n            x = F.relu(this.MP_(this.BN5(this.CN5(x))))\n            x = F.relu(this.MP_(this.BN6(this.CN6(x))))\n            x = F.relu(this.MP_(this.BN7(this.CN7(x))))\n            \n            x = x.view(x.shape[0], -1)\n            \n            x = F.relu(this.DP_(this.FC1(x)))\n            x = this.FC2(x)\n            \n            return x\n        else:\n            x = F.relu(this.MP_(this.BN1(this.CN1(x))))\n            x = F.relu(this.MP_(this.BN2(this.CN2(x))))\n            x = F.relu(this.MP_(this.BN3(this.CN3(x))))\n            x = F.relu(this.MP_(this.BN4(this.CN4(x))))\n            x = F.relu(this.MP_(this.BN5(this.CN5(x))))\n            x = F.relu(this.MP_(this.BN6(this.CN6(x))))\n            x = F.relu(this.MP_(this.BN7(this.CN7(x))))\n            \n            x = x.view(x.shape[0], -1)\n            \n            x = F.relu(this.FC1(x))\n            x = this.FC2(x)\n            \n            return x","eb73c952":"def predict_(model=None, dataloader=None, device=None, path=None):\n    if path:\n        model.load_state_dict(torch.load(path))\n\n    model.to(device)\n    model.eval()\n\n    y_pred = torch.zeros(1, 11).to(device)\n\n    for X in dataloader:\n        X = X.to(device)\n        with torch.no_grad():\n            Pred = torch.sigmoid(model(X))\n        y_pred = torch.cat((y_pred, Pred), dim=0)\n    \n    return y_pred[1:].detach().cpu().numpy()","78b0aee3":"cfg = CFG(filter_sizes=[64, 128, 256, 512], HL=[4096], epochs=None, n_folds=None)\n\ntransform = transforms.Compose([transforms.ToTensor(), ])\n\nts_data_setup = DS(X=ts_images, y=None, transform=transform, mode=\"test\")\nts_data = DL(ts_data_setup, batch_size=cfg.ts_batch_size, shuffle=False)\n\nmodel = CNN(filter_sizes=cfg.filter_sizes, HL=cfg.HL, OL=cfg.OL)\n\ny_pred = []\nepochs = [34, 36, 40, 42, 44, 46]\n\nfor epoch in epochs:\n    y_pred.append(predict_(model=model, dataloader=ts_data, device=cfg.device, path=\"..\/input\/rccl-384-train\/Epoch_{}.pt\".format(epoch)))\ny_pred = np.divide(np.sum(np.array(y_pred), axis=0), len(epochs))\ny_pred = np.clip(y_pred, 1e-15, 1-1e-15)\n\nss.iloc[:, 1:] = y_pred\nss.to_csv(\".\/submission.csv\", index=False)\nss.head(5)","d1e18856":"**Setup**","b96bc28e":"# Library Imports","7fc13aee":"# Submission ","92aa80e1":"# Data Handling","83495b4a":"**Dataset Template**","e4dded1a":"**Predict Function**","a01e9011":"# Helper Functions","3d8b94fd":"**Loading Image Data**","75dc0971":"# CNN Configuration and Setup","fdbb211c":"**Config**"}}