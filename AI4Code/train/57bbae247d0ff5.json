{"cell_type":{"1e1b85d3":"code","ab68eba2":"code","9cf221a5":"code","636a33ff":"code","dd40b4cc":"code","05f5073c":"code","fc072b0a":"code","a7f69fed":"code","bb40442a":"code","ae4d3a84":"code","1409fbe1":"code","47f5d47c":"code","513b8224":"code","d7731994":"code","9ff0b464":"code","df4fda96":"code","532c2c77":"code","3aa926ef":"code","20e375de":"code","047c8ca9":"code","f5b52205":"markdown","228ba2ac":"markdown","17b649dc":"markdown","e2e0ba75":"markdown","5e939dbe":"markdown","bfa52437":"markdown","cf238ed0":"markdown"},"source":{"1e1b85d3":"# Load packages\n\nimport pandas as pd\nimport numpy as np\nfrom google.cloud import bigquery\nfrom bq_helper import BigQueryHelper\n\nimport matplotlib.pyplot as plt\nimport seaborn as sns\nplt.style.use('fivethirtyeight')\n\n# import plotly\nimport chart_studio as plotly\nplotly.tools.set_config_file(world_readable=True, sharing='public')\nimport plotly.offline as py\npy.init_notebook_mode(connected=True)\nimport plotly.tools as tls\nimport plotly.graph_objs as go\nimport plotly.tools as tls\nimport plotly.figure_factory as fig_fact\nfrom plotly.subplots import make_subplots\nfrom plotnine import *\n\n\n%matplotlib inline\n\nbq_assistant = BigQueryHelper(\"bigquery-public-data\", \"epa_historical_air_quality\")\npollutants = ['pm25_frm']\n","ab68eba2":"QUERY = \"\"\"\n    SELECT\n        pm25_daily.state_name,\n        avg(pm25_daily.aqi) as pm25_avg_aqi,\n        EXTRACT(YEAR FROM pm25_daily.date_local) AS year\n    FROM\n      `bigquery-public-data.epa_historical_air_quality.pm25_frm_daily_summary` AS pm25_daily\n    WHERE\n      pm25_daily.poc = 1\n      AND EXTRACT(YEAR FROM pm25_daily.date_local) > 1990\n    GROUP BY pm25_daily.state_name,\n       EXTRACT(YEAR FROM pm25_daily.date_local)\n      \n    \n        \"\"\"\ndf_states_pm25 = bq_assistant.query_to_pandas(QUERY)","9cf221a5":"states = {'AL': 'Alabama',\n'AK': 'Alaska',\n'AZ':'Arizona',\n'AR':'Arkansas',\n'CA':'California',\n'CO':'Colorado',\n'CT':'Connecticut',\n'DE':'Delaware',\n'FL':'Florida',\n'GA':'Georgia',\n'HI':'Hawaii',\n'ID':'Idaho',\n'IL':'Illinois',\n'IN':'Indiana',\n'IA':'Iowa',\n'KS':'Kansas',\n'KY':'Kentucky',\n'LA':'Louisiana',\n'ME':'Maine',\n'MD':'Maryland',\n'MA':'Massachusetts',\n'MI':'Michigan',\n'MN':'Minnesota',\n'MS':'Mississippi',\n'MO':'Missouri',\n'MT':'Montana',\n'NE':'Nebraska',\n'NV':'Nevada',\n'NH':'New Hampshire',\n'NJ':'New Jersey',\n'NM':'New Mexico',\n'NY':'New York',\n'NC':'North Carolina',\n'ND':'North Dakota',\n'OH':'Ohio',\n'OK':'Oklahoma',\n'OR':'Oregon',\n'PA':'Pennsylvania',\n'RI':'Rhode Island',\n'SC':'South Carolina',\n'SD':'South Dakota',\n'TN':'Tennessee',\n'TX':'Texas',\n'UT':'Utah',\n'VT':'Vermont',\n'VA':'Virginia',\n'WA':'Washington',\n'WV':'West Virginia',\n'WI':'Wisconsin',\n'WY':'Wyoming'}","636a33ff":"df_states = pd.DataFrame.from_dict(states,orient='index').reset_index()\ndf_states.columns = ['code', 'code_name']\ndf_states_pm25['state_code'] = df_states_pm25['state_name'].map(df_states.set_index('code_name')['code'])","dd40b4cc":"df_states_pm25['pm25_avg_aqi'] = df_states_pm25['pm25_avg_aqi'].round(1)","05f5073c":"df_states_pm25 = df_states_pm25.sort_values(by=['year','state_code'])","fc072b0a":"df_states_pm25.head(10)","a7f69fed":"scl = [[0.0, 'rgb(242,240,247)'],[0.2, 'rgb(218,218,235)'],[0.4, 'rgb(188,189,220)'],[0.6, 'rgb(158,154,200)'],[0.8, 'rgb(117,107,177)'],[1.0, 'rgb(84,39,143)']]\n\ndata = []\n\nyears = sorted(df_states_pm25['year'].unique())\nCOLS = len(years)\n\nlayout = dict(\n        title = 'The average air quality index of pm25 By State<br>(Hover for breakdown)',\n)\n\nfor i in range(len(years)):\n    geo_key = 'geo'+str(i+1) if i != 0 else 'geo'\n    pm25data = list(df_states_pm25[df_states_pm25['year'] == years[i]]['pm25_avg_aqi'].astype(float))\n    # \n    data.append(\n        dict(\n        type = 'choropleth',\n        colorscale = scl,\n        autocolorscale = False,\n        locations = df_states_pm25['state_code'],\n        z = pm25data,\n        zmin = 0,\n        zmax = 70,\n        showscale=True,\n        locationmode = 'USA-states',\n        text =  'Average AQI: ' + df_states_pm25['pm25_avg_aqi'].astype(str), \n        geo = geo_key,\n        marker = dict(\n            line = dict (\n                color = 'rgb(255,255,255)',\n                width = 2\n            ) ),\n        colorbar = dict(\n            title =  \"AQI of pm25\",\n            )\n        )\n    )\n    \n    layout[geo_key] = dict(\n        scope = 'usa',\n        projection=dict( type='albers usa' ),\n        showlakes = True,\n        domain = dict( x = [], y = [] ),\n        lakecolor = 'rgb(255, 255, 255)',\n    )\n    \n    # Year markers\n    data.append(\n        dict(\n            type = 'scattergeo',\n            showlegend = False,\n            lon = [-78],\n            lat = [47],\n            geo = geo_key,\n            text = [years[i]],\n            mode = 'text',\n        )\n    )\n    \nCOLS = 7\nROWS = 3\nz=0     \nfor j in reversed(range(ROWS)):\n    for k in range(COLS):\n        geo_key = 'geo'+str(z+1) if z != 0 else 'geo'\n        layout[geo_key]['domain']['x'] = [k\/COLS,(k+1)\/COLS]\n        layout[geo_key]['domain']['y'] = [j\/ROWS,(j+1)\/ROWS]\n        z = z + 1\n         \nfig = go.Figure(data=data, layout=layout)\n\nfig.show()","bb40442a":"QUERY = \"\"\"\n    SELECT\n        pm25_daily.state_name,\n        avg(pm25_daily.aqi) as pm25_avg_aqi,\n        EXTRACT(YEAR FROM pm25_daily.date_local) AS year,\n        EXTRACT(MONTH FROM pm25_daily.date_local) AS month\n    FROM\n      `bigquery-public-data.epa_historical_air_quality.pm25_frm_daily_summary` AS pm25_daily\n    WHERE\n      pm25_daily.poc = 1\n      AND EXTRACT(YEAR FROM pm25_daily.date_local) > 1990\n    GROUP BY pm25_daily.state_name,\n       EXTRACT(YEAR FROM pm25_daily.date_local),\n       EXTRACT(MONTH FROM pm25_daily.date_local)\n      \n    \n        \"\"\"\ndf_states_pm25_daily = bq_assistant.query_to_pandas(QUERY)","ae4d3a84":"df_states_pm25_daily.dtypes","1409fbe1":"df_states_pm25_daily['state_code'] = df_states_pm25_daily['state_name'].map(df_states.set_index('code_name')['code'])\ndf_states_pm25_daily['date'] = pd.to_datetime(df_states_pm25_daily['year'].astype(str)  + df_states_pm25_daily['month'].astype(str), format='%Y%m')","47f5d47c":"df_states_pm25_daily = df_states_pm25_daily.sort_values(by=['year','month','state_code'])","513b8224":"df_states_pm25_daily.head(3)","d7731994":"plt.subplots(figsize=(25,15))\nsns.scatterplot(x='date',y='pm25_avg_aqi',data=df_states_pm25_daily,palette='inferno',edgecolor=sns.color_palette('dark',7),hue = 'state_code')\nplt.ylabel('Air Quality Index PM2.5', fontsize=20)\nplt.xlim(df_states_pm25_daily.date.min(), df_states_pm25_daily.date.max())\nplt.xticks(rotation=90)\nplt.xlabel('Date', fontsize=20)\nplt.title('Average AQI of PM2.5 By Month', fontsize=24)\nplt.legend(bbox_to_anchor=(1.05, 1), loc=2, borderaxespad=0.)\nplt.show()","9ff0b464":"g = sns.FacetGrid(df_states_pm25_daily, col=\"year\", col_wrap=6, hue=\"state_code\",palette='inferno')\ng.map(plt.scatter, \"month\", \"pm25_avg_aqi\", alpha=.7)\ng.add_legend();\n\n","df4fda96":"g = sns.FacetGrid(df_states_pm25_daily[(df_states_pm25_daily.state_code == 'PA') | (df_states_pm25_daily.state_code ==  'OH')|(df_states_pm25_daily.state_code ==  'IL')|\n                                      (df_states_pm25_daily.state_code ==  'NY')|(df_states_pm25_daily.state_code ==  'MI')|(df_states_pm25_daily.state_code ==  'VT')|\n                                       (df_states_pm25_daily.state_code ==  'IA')], col=\"year\", col_wrap=6, hue=\"state_code\",palette='inferno')\ng.map(plt.scatter, \"month\", \"pm25_avg_aqi\", alpha=.7)\ng.add_legend();\n\n                                       \n                                      ","532c2c77":"bq_assistant_global = BigQueryHelper(active_project=\"bigquery-public-data\", dataset_name=\"openaq\")\n\nQUERY_year = \"\"\"\n    SELECT\n       city,\n       country,\n       pollutant ,\n       value AS pm25,\n       timestamp,\n       unit,\n       latitude,\n       longitude,\n       EXTRACT(YEAR FROM timestamp) AS year,\n       EXTRACT(MONTH FROM timestamp) AS month\n    FROM\n      `bigquery-public-data.openaq.global_air_quality` as globalAQ\n    WHERE\n       country = 'CN' AND pollutant = 'pm25' AND value > 0\n    ORDER BY city,\n       EXTRACT(MONTH FROM timestamp),\n       EXTRACT(YEAR FROM timestamp)\n    #LIMIT 1000;\n\"\"\"\n\ndf_global = bq_assistant_global.query_to_pandas(QUERY_year)\ndf_global.head()","3aa926ef":"df_global['date'] = pd.to_datetime(df_global['year'].astype(str)  + df_global['month'].astype(str), format='%Y%m')\n\ndf_global_avg = df_global.groupby([\"year\",\"month\",\"city\"]).agg({\"pm25\":\"mean\"})\ndf_global_avg.reset_index(inplace=True)\ndf_global_avg","20e375de":"g = sns.FacetGrid(df_global_avg[(df_global_avg.city == 'Beijing') | (df_global_avg.city ==  'Anqing')|\n                         (df_global_avg.city == 'Chizhou') | (df_global_avg.city ==  'Shanghai')|      \n                         (df_global_avg.city == 'Shenyang') | (df_global_avg.city ==  'Wuhu')|      \n                         (df_global_avg.city == 'Xuancheng') | (df_global_avg.city ==  'Bozhou')     \n                               ], col=\"year\", col_wrap=6, hue=\"city\",palette='inferno')\ng.map(plt.scatter, \"month\", \"pm25\", alpha=.7)\ng.add_legend();\ng\n","047c8ca9":"df_global.groupby([\"year\",\"latitude\",\"longitude\"]).agg({\"pm25\":\"mean\"})","f5b52205":"Look at a few mid west states (IL,MI,OH,PA,NY,VT,IA)","228ba2ac":"Plot appears to show a trend of PM2.5 being reduced over time.\n\n**Does PM2.5 change month to month?**\n\nAssumption is that the hotter and colder months would have higer PM2.5 levels due to increased heating and cooling.","17b649dc":"AQI of average AQI PM 2.5 time based by state.\n\nQueary daily PM2.5","e2e0ba75":"Looking at a few mid west and eastern states (IL,MI,OH,PA,NY,VT,IA) there seems to be a pattern of higher vaules in the summer and winter.\n\n**Next, Queary from the global database to look at another Country**","5e939dbe":"Interesting, not a lot of data.","bfa52437":"Query the USA from the 2.5 daily data as a starting point.\n\n","cf238ed0":"Goal of this notebook is to look at PM2.5 pollutant levels across the USA over time.  Later the plan is to query from the global data set to view other country's PM2.5 pollutant levels.\n\n* PM2.5 is particulate matter (PM) that has a diameter less than 2.5 micrometers.  \n* PM2.5 sources include power plants, motor vehicles, airplanes, residential wood burning, forest fires, agricultural burning, volcanic eruptions.\n* PM2.5 can be emitted directly into the air, others are formed when gases and particles interact with one another in the atmosphere.\n* The small size allows the particles to bypass the noise and throat and directly deep into the lungs and can even enter the circulatory system.\n* Long term exposure may lead to plaque deposits in the arteries, causing vascular inflammation and hardening of the arteries.\n* Potential damage from PM2.5 exposure depends on the concentration and the duration of exposure.\n\nWhy the interest, after moving from a low pollutant area, to Shanghai, a rather high concentration location, I have an interest in how the concentrations are changing over time, and how the concentrations change during the year.\n\nRef (https:\/\/blissair.com\/what-is-pm-2-5.htm)\n\nThanks to Mhamed Jabri and Niyamat Ullah for there notebook that provided a great starting point."}}