{"cell_type":{"24e79baf":"code","d2f2e41c":"code","b93a3694":"code","ae117a7d":"code","a6282ee9":"code","1e805336":"code","938b18af":"code","661be2d6":"code","c7ea4391":"code","a1a0076d":"code","7376c3ab":"code","560d61eb":"code","563aded0":"code","9b876628":"code","21e33f23":"code","f271c0ff":"code","775cb16e":"code","b1e3fb4f":"code","5d8206ef":"code","74d268f2":"code","2a04fe61":"code","59ba6ccf":"code","2b246838":"code","4aff2c4a":"code","4a5dd7f5":"code","b26dadea":"code","c45d88cf":"code","ed81a3f7":"code","09b8acbb":"code","8e057938":"code","3fb387ef":"code","aa777dd4":"code","da282352":"code","36bc42a6":"code","759f73f7":"code","0133374b":"code","0cc2afa8":"code","a62fcfae":"code","6fd5ce0d":"code","577d6150":"code","8d4dca53":"code","0eba61e0":"code","c9685205":"code","ddeb02f9":"code","6b23315a":"code","817ae132":"code","2e4752d6":"code","e8ae9218":"code","39a79378":"code","76420d45":"code","22d7164d":"code","007b45e4":"code","3e54a3ed":"code","4ea86e23":"code","35b50c58":"code","99de3831":"code","c207e122":"code","6e2dd8ea":"code","88ea6e64":"code","adf42d1b":"code","0f8924ed":"markdown","2d1fd717":"markdown","8ca10d61":"markdown","265fc8d6":"markdown","f6dc2231":"markdown","6a41b398":"markdown","accc53b0":"markdown","ff614906":"markdown","8a9282fa":"markdown","41439606":"markdown","58399e17":"markdown","77bcd210":"markdown","85ad212e":"markdown","a745ddb5":"markdown","dc74dee4":"markdown","326bb204":"markdown","684f8079":"markdown","36506270":"markdown","8dc24d56":"markdown","14116365":"markdown","b438456a":"markdown","016f042f":"markdown","b69369fa":"markdown","27e36ba8":"markdown","fa1fc070":"markdown","8193d5dd":"markdown","bb0dcb7d":"markdown","64cd50ee":"markdown","2dca4e2b":"markdown","07639a83":"markdown","5895ebf2":"markdown","42f64204":"markdown","523f4a02":"markdown","1602f0ef":"markdown","d51759d2":"markdown","926b99b4":"markdown","9e2a6ee6":"markdown","b66ece0e":"markdown","f9c725d3":"markdown","3aae3101":"markdown","fcb4f5f8":"markdown","3ac82dc1":"markdown","4a3fb7c7":"markdown","c4caa84b":"markdown","03ed0b7c":"markdown","aa5dce35":"markdown","7498a150":"markdown","53dfd270":"markdown","cbccd1c8":"markdown","97b2b7a0":"markdown","122db8b5":"markdown"},"source":{"24e79baf":"import numpy as np \nimport pandas as pd \nimport seaborn as sns\nimport datetime\nimport matplotlib.pyplot as plt\n# from chart_studio.plotly.offline import init_notebook_mode,iplot\n# import plotly.plotly as py\nfrom plotly.offline import init_notebook_mode, iplot\n\nfrom sklearn.preprocessing import LabelEncoder\nfrom sklearn.model_selection import train_test_split\nfrom sklearn.linear_model import LinearRegression,LogisticRegression\nfrom sklearn.tree import DecisionTreeRegressor\nfrom sklearn.ensemble import RandomForestRegressor\nfrom lightgbm import LGBMRegressor\n\nfrom sklearn.metrics import mean_absolute_error\nfrom sklearn.metrics import mean_squared_error\nfrom sklearn.metrics import r2_score\nimport math","d2f2e41c":"data = pd.read_csv(\"..\/input\/spanish-high-speed-rail-system-ticket-pricing\/thegurus-opendata-renfe-trips.csv\",nrows=3579770)","b93a3694":"data = data.drop(columns=['id','seats','meta','company','duration'])\ncols = list(data.columns)\ncols = [cols[-1]] + cols[:-1]\ndata = data[cols]\n\ncolumn_dict = {\n    \"departure\":\"start_date\",\n    \"arrival\":\"end_date\",\n    \"vehicle_type\":\"train_type\",\n    \"vehicle_class\":\"train_class\"\n}\ndata = data.rename(columns = column_dict)\n\ndata.to_csv(\".\/renfe.csv\",index=False)","ae117a7d":"data = pd.read_csv('.\/renfe.csv')\ndata.head()","a6282ee9":"data.info()","1e805336":"data.isnull().sum()","938b18af":"data['price'].fillna(data['price'].mean(),inplace=True)","661be2d6":"data.dropna(inplace=True)","c7ea4391":"data.drop('insert_date',axis=1,inplace=True)","a1a0076d":"data.isnull().sum()","7376c3ab":"fig,ax = plt.subplots(figsize=(15,5))\nax = sns.countplot(data['origin'])\nplt.show()","560d61eb":"fig,ax = plt.subplots(figsize=(15,5))\nax = sns.countplot(data['destination'])\nplt.show()","563aded0":"fig,ax = plt.subplots(figsize=(15,6))\nax = sns.countplot(data['train_type'])\nplt.show()","9b876628":"fig,ax = plt.subplots(figsize=(15,6))\nax = sns.countplot(data['train_class'])\nplt.show()","21e33f23":"fig,ax = plt.subplots(figsize=(15,6))\nax = sns.countplot(data['fare'])\nplt.show()","f271c0ff":"f,ax = plt.subplots(figsize=(15,6))\nax = sns.distplot(data['price'],rug=True)\nplt.show()","775cb16e":"f,ax = plt.subplots(figsize=(15,6))\nax = sns.boxplot(x='train_class',y='price',data=data)\nplt.show()","b1e3fb4f":"f,ax = plt.subplots(figsize=(15,6))\nax = sns.boxplot(x='train_type',y='price',data=data)\nplt.show()","5d8206ef":"data = data.reset_index()","74d268f2":"datetimeFormat = '%Y-%m-%d %H:%M:%S'\ndef fun(a,b):\n    diff = datetime.datetime.strptime(b, datetimeFormat)- datetime.datetime.strptime(a, datetimeFormat)\n    return(diff.seconds\/3600.0)\n    ","2a04fe61":"data['travel_time_in_hrs'] = data.apply(lambda x:fun(x['start_date'],x['end_date']),axis=1) ","59ba6ccf":"data.drop(['start_date','end_date'],axis=1,inplace=True)\ndata.head()","2b246838":"df1 = data[(data['origin']==\"MADRID\") & (data['destination']==\"SEVILLA\")]\ndf1.head()","4aff2c4a":"f,ax = plt.subplots(figsize=(15,6))\nax = sns.barplot(x=\"train_type\",y=\"travel_time_in_hrs\",data=df1)\nplt.show()","4a5dd7f5":"f,ax = plt.subplots(figsize=(15,6))\nax = sns.boxplot(x=\"train_type\",y=\"price\",data=df1)\nplt.show()","b26dadea":"df1 = data[(data['origin']==\"MADRID\") & (data['destination']==\"BARCELONA\")]\ndf1.head()","c45d88cf":"f,ax = plt.subplots(figsize=(15,6))\nax = sns.barplot(x=\"train_type\",y=\"travel_time_in_hrs\",data=df1)\nplt.show()","ed81a3f7":"f,ax = plt.subplots(figsize=(15,6))\nax = sns.boxplot(x=\"train_type\",y=\"price\",data=df1)\nplt.show()","09b8acbb":"df1 = data[(data['origin']==\"MADRID\") & (data['destination']==\"VALENCIA\")]\ndf1.head()","8e057938":"f,ax = plt.subplots(figsize=(15,6))\nax = sns.barplot(x=\"train_type\",y=\"travel_time_in_hrs\",data=df1)\nplt.show()","3fb387ef":"f,ax = plt.subplots(figsize=(15,6))\nax = sns.boxplot(x=\"train_type\",y=\"price\",data=df1)\nplt.show()","aa777dd4":"df1 = data[(data['origin']==\"MADRID\") & (data['destination']==\"PONFERRADA\")]\ndf1.head()","da282352":"f,ax = plt.subplots(figsize=(15,6))\nax = sns.barplot(x=\"train_type\",y=\"travel_time_in_hrs\",data=df1)\nplt.show()","36bc42a6":"f,ax = plt.subplots(figsize=(15,6))\nax = sns.boxplot(x=\"train_type\",y=\"price\",data=df1)\nplt.show()","759f73f7":"data['route'] = data['origin']+' to '+data['destination']\n\nprint('There are {} number of routes in dataframe'.format(data['route'].nunique()))","0133374b":"cnt_ = data['route'].value_counts()\n\nfig = {\n  \"data\": [\n    {\n      \"values\": cnt_.values,\n      \"labels\": cnt_.index,\n      \"domain\": {\"x\": [0, .5]},\n      \"name\": \"Routes\",\n      \"hoverinfo\":\"label+percent+name\",\n      \"hole\": .5,\n      \"type\": \"pie\"\n    },],\n  \"layout\": {\n        \"title\":\"Pie chart of routes\",\n        \"annotations\": [\n            { \"font\": { \"size\": 20},\n              \"showarrow\": False,\n             \"text\": \"Pie Chart\",\n                \"x\": 0.50,\n                \"y\": 1\n            },\n        ]\n    }\n}\niplot(fig)\ncnt_","0cc2afa8":"cnt_ = data['train_type'].value_counts()\n\nfig = {\n  \"data\": [\n    {\n      \"values\": cnt_.values,\n      \"labels\": cnt_.index,\n      \"domain\": {\"x\": [0, .5]},\n      \"name\": \"Train types\",\n      \"hoverinfo\":\"label+percent+name\",\n      \"hole\": .7,\n      \"type\": \"pie\"\n    },],\n  \"layout\": {\n        \"title\":\"Pie chart Train types\",\n        \"annotations\": [\n            { \"font\": { \"size\": 20},\n              \"showarrow\": False,\n             \"text\": \"Pie Chart\",\n                \"x\": 0.50,\n                \"y\": 1\n            },\n        ]\n    }\n}\niplot(fig)\ncnt_","a62fcfae":"data.head()","6fd5ce0d":"lab_en = LabelEncoder()\ndata.loc[:,'origin'] = lab_en.fit_transform(data.loc[:,'origin'])\ndata.loc[:,'destination'] = lab_en.fit_transform(data.loc[:,'destination'])\ndata.loc[:,'train_type'] = lab_en.fit_transform(data.loc[:,'train_type'])\ndata.loc[:,'train_class'] = lab_en.fit_transform(data.loc[:,'train_class'])\ndata.loc[:,'fare'] = lab_en.fit_transform(data.loc[:,'fare'])","577d6150":"data.head()","8d4dca53":"data = data.loc[:,data.columns!='route']\ndata = data.loc[:,data.columns!='index']","0eba61e0":"data.to_csv(\"data_prepared_renfe.csv\",index=False)","c9685205":"def coorelation_matrix_plot(data, title = \"Train Ticket Prediction\", height = 9, width = 12):\n    cor_mat = round(data.corr(method =\"spearman\"), 2)\n    plt.figure(figsize = (width, height))\n    ax = sns.heatmap(cor_mat, annot=True, annot_kws={\"size\": 15}, cmap = sns.color_palette(\"PuOr_r\", 50), \n                     vmin = -1, vmax = 1)\n    ax.axes.set_title(title, fontsize = 30)\n    ax.title.set_position([.5, 1.03])\n    plt.show()\n    \ncoorelation_matrix_plot(data.iloc[:,1:], title = \"Train Ticket Prediction\")","ddeb02f9":"# X = data.iloc[:,[1,2,3,4,6,7]].values\n# Y = data.iloc[:,5].values\n\nX = data.loc[:,data.columns!='price']\nY = data.loc[:,data.columns=='price']","6b23315a":"X_train,X_test,Y_train,Y_test = train_test_split(X,Y,test_size=0.2,random_state=5)","817ae132":"lr = LinearRegression()\nlr.fit(X_train,Y_train)","2e4752d6":"Y_predicted = lr.predict(X_test)\n\nprint(\"R Squared value \",r2_score(Y_test, Y_predicted))\nprint(\"Mean Absolute Error\",mean_absolute_error(Y_test, Y_predicted))\nprint(\"Mean Squared Error \",math.sqrt(mean_squared_error(Y_test, Y_predicted)))\n","e8ae9218":"lg = LGBMRegressor(n_estimators=1000)\nlg.fit(X_train,Y_train)","39a79378":"Y_predicted = lg.predict(X_test)\n\nprint(\"R Squared value \",r2_score(Y_test, Y_predicted))\nprint(\"Mean Absolute Error\",mean_absolute_error(Y_test, Y_predicted))\nprint(\"Mean Squared Error \",math.sqrt(mean_squared_error(Y_test, Y_predicted)))\n","76420d45":"import xgboost as xgb\n\nxg_reg = xgb.XGBRegressor(objective ='reg:linear', colsample_bytree = 0.3, learning_rate = 0.1,\n                max_depth = 5, alpha = 10, n_estimators = 10)\n\nxg_reg.fit(X_train,Y_train)\n\nY_predicted = xg_reg.predict(X_test)\n\n","22d7164d":"\nprint(\"R Squared value \",r2_score(Y_test, Y_predicted))\nprint(\"Mean Absolute Error\",mean_absolute_error(Y_test, Y_predicted))\nprint(\"Mean Squared Error \",math.sqrt(mean_squared_error(Y_test, Y_predicted)))\n","007b45e4":"from sklearn.tree import DecisionTreeRegressor\n\ndtr = DecisionTreeRegressor()\ndtr.fit(X_train,Y_train)\n\nY_predicted = dtr.predict(X_test)","3e54a3ed":"\nprint(\"R Squared value \",r2_score(Y_test, Y_predicted))\nprint(\"Mean Absolute Error\",mean_absolute_error(Y_test, Y_predicted))\nprint(\"Mean Squared Error \",math.sqrt(mean_squared_error(Y_test, Y_predicted)))\n","4ea86e23":"from sklearn.svm import SVR\n\nsvr = SVR()\n","35b50c58":"val = int(X_train.shape[0]\/1000)\nprint(val)\nX_train = X_train.iloc[:val,:]\nY_train = Y_train.iloc[:val,:]","99de3831":"svr.fit(X_train,Y_train)\n","c207e122":"\nX_test = X_test.iloc[:val,:]\nY_test = Y_test.iloc[:val,:]\nY_predicted = svr.predict(X_test)","6e2dd8ea":"\nprint(\"R Squared value \",r2_score(Y_test, Y_predicted))\nprint(\"Mean Absolute Error\",mean_absolute_error(Y_test, Y_predicted))\nprint(\"Mean Squared Error \",math.sqrt(mean_squared_error(Y_test, Y_predicted)))\n","88ea6e64":"from sklearn.ensemble import RandomForestRegressor\n\nrf = RandomForestRegressor()\nrf.fit(X_train,Y_train)\n\nY_predicted = rf.predict(X_test)","adf42d1b":"\nprint(\"R Squared value \",r2_score(Y_test, Y_predicted))\nprint(\"Mean Absolute Error\",mean_absolute_error(Y_test, Y_predicted))\nprint(\"Mean Squared Error \",math.sqrt(mean_squared_error(Y_test, Y_predicted)))\n","0f8924ed":"# Applying Light Gradient Boosting","2d1fd717":"### Travelling from MADRID to VALENCIA","8ca10d61":"### Travelling from MADRID to PONFERRADA","265fc8d6":"## Checking for Null values in the dataset","f6dc2231":"# Applying SVM","6a41b398":"### Different types of train that runs in Spain ","accc53b0":"# Route chart \n\n1. Using Pie chart to visualize the different routes and class of trains available for the same","ff614906":"- AVE and ALVIA are two train_types which takes least amount of time to reach the destination, while MD-LD  takes maximum amount of time.\n- REGIONAL train have minimum ticket fare.\n- AVE is the best train to travel as it is the fastest train with less ticket pricing.","8a9282fa":"### Train_type vs Price","41439606":"# Label Encoding\n\n* Encoding the all columns having categorical values in the form of strings to equivalent numerical code\n","58399e17":"### Distribution of the ticket prices","77bcd210":"# DATA PREPARATION\n\n1. Involves checking for null values\n2. Filling the null values with mean or mode whichever is suitable according to data type\n3. Removing unneccessary data columns not deciding the price of ticket\n","85ad212e":"From the above graph we can visualize that maximum number of the people have **\"Madrid\"** as the station of origin.","a745ddb5":"## Univariate Analysis","dc74dee4":"- The fastest trains on this route are AVE and AVE-TGV as they around 2-3 hours to reach the destination.\n- R.Express takes maximum time i.e. more than 8 hours and it is one of the cheapest one.","326bb204":"### Finding the travel time between the place of origin and destination","684f8079":"# Importing Libraries","36506270":"The average price of the tickets of train_type **AVE and AVE-TGV** are comparatilvely higher as compared to other train types.","8dc24d56":"**\"Turista\"** is the train_class in which people travel in general. ","14116365":"### Number of people boarding from different stations","b438456a":"# Applying Linear Regression","016f042f":"### Number of train of different class","b69369fa":"# Coorelation Matrix\n\n## Observations\n\n1. Price and origin follows weak negative coorelation\n2. Price and destination follows weak negative coorelation\n3. Travel time is positively coorelated to train type","27e36ba8":"* From the above graph we can visualize that also maximum number of people are coming to **\"Madrid\"** as the most of the people have their destination station as **Madrid**.","fa1fc070":"**\"Cama G. Clase\"** is the train class with the highest ticket price, and the tickets of this class are bought by least number of people.","8193d5dd":"# Applying Random Forest","bb0dcb7d":"Dropping irrelevant columns","64cd50ee":"# Analysis of train type column \n\n## Overview of different train types in spain: \n\n**AVE:** In Spain With 3,100km of track the Spanish high-speed AVE trains operate on the longest high-speed network in Europe. Running at speeds of up to 310 km\/h this extensive network allows for fast connections between cities in Spain. Travel from Madrid to Barcelona in less than 3 hours! This modern train system connects many cities across Spain from Madrid and Barcelona, to C\u00f3rdoba, Seville, M\u00e1laga and Valencia.\n\n**ALVIA:** The Spanish Alvia trains combine both a long distance and a high-speed service to connect major cities across Spain. The Alvia offers many routes such as connections from Madrid to Gij\u00f3n, Alicante and Castell\u00f3n and from Barcelona to Bilbao, A Coru\u00f1a and Vigo. With air conditioned carriages and check-in control before boarding the Alvia is comfortable and relaxed way to traverse one of Europe's biggest countries.\n\n**REGIONAL:** Regional and intercity trains in Spain. FEVE trains operate in the north of Spain, connecting cities like Bilbao, Gij\u00f3n, Le\u00f3n and Santander. Cercan\u00edas (suburban trains) is a network of trains that operates in and around the larger Spanish cities including Barcelona and Valencia.\n\n**INTERCITY:** Traditional intercity trains travelling between 160 do 250 km\/h allow you to reach nearly every corner of Spain. You can choose to travel in 2nd class (Turista) or 1st class (Preferente). The comfort of the carriages is close to that of the high-speed AVE trains. All trains are air-conditioned.\n\n**AV City:** The ave city trains are high speed train to complement the AVE to offer lower prices and marketed in economy class (p) and economy plus (p+)\n\n**Less distance(LD) - Medium distance(MD):** The LD-AVE and MD-AVE on the list of trains is for an indirect service that uses a comination of the regular trains (either the LD - Larga Distancia\/Long Distance or the MD - \nMedia Distancia\/Medium Distance). Those trains requires a change (usually in Zaragoza or Valencia) so, due to the change and the lower speed trains on part of the way. The journey is longer but the tickets are cheaper.\n\nThe **LD,AVE-MD,AVE-LD,LD-MD,MD-AVE,MD,LD-AVE** slightly falls under above category.\n","2dca4e2b":"# Splitting the data into training and test set\n\n* Splitting the dataset into 80:20 ratio for training and testing the results","07639a83":"### Number of tickets bought from each category ","5895ebf2":"# Feature Engineering\n\nInvolves extracting the relevant features from the data columns deciding the cost of ticket","42f64204":"# Extrapolatory Data Analysis","523f4a02":"## Dropping irrelevant attributes","1602f0ef":"# Spanish High Speed Rail tickets pricing data analysis \n![](https:\/\/www.seat61.com\/images\/Spain-pato-train-barcelona2.jpg)","d51759d2":"- It takes minimum 4 hours to travel from MADRID to PONFERRADA\n- AVE-MD , AVE-LD , ALVIA they take almost same time which is the minimum time and also their ticket prices are same\n- There is no point travelling via MD-LD as it takes maximum time and have the most expensive tickets.","926b99b4":"# Dataset preparation","9e2a6ee6":"### Removing redundant features","b66ece0e":"### Number of people having the following stations as destination","f9c725d3":"# Loading the dataset","3aae3101":"## Dropping the rows containing Null values in the attributes train_class and fare","fcb4f5f8":"# Applying Decision Tree Regressor","3ac82dc1":"- The fastest train between Madrid and SEVILLA is AVE and even the costliest one and it takes approximately 2-2.4 hrs.\n- The cheapest train is MD-LD , even the slowest one and it takes above 7 hours to reach the destination.","4a3fb7c7":"### Travelling from MADRID to BARCELONA","c4caa84b":"# Introduction:\n### Rail transport in Spain operates on four rail gauges and services are operated by a variety of private and public operators. The total route length in 2012 was 16,026 km (10,182 km electrified)\n\n#### Most railways are operated by Renfe Operadora; metre and narrow-gauge lines are operated by FEVE and other carriers in individual autonomous communities. It is proposed and planned to build or convert more lines to standard gauge,including some dual gauging of broad-gauge lines, especially where these lines link to France, including platforms to be heightened.\n\n### Spain is a member of the International Union of Railways (UIC).","03ed0b7c":"### Train_class vs Price","aa5dce35":"## Filling the Null values in the price column by taking the mean price of the ticket","7498a150":"## Observations\n\n* Most of the train types in our dataset was AVE as these are high speed trains.It occupies 69.4%\n\n* People rarely choosing the MD-AVE,MD,LD-AVE trains because these train journeys are longer in time. \n\n* We can say that spain people like to travel in high speed trains.","53dfd270":"###  Travelling from MADRID to SEVILLA","cbccd1c8":"We can see that **\"AVE\"** are runs maximum in number as compared to other train types.","97b2b7a0":"# Bivariate Analysis","122db8b5":"# Applying XGBoost"}}