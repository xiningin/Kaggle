{"cell_type":{"11b96eb1":"code","ae78cdb8":"code","d993197c":"code","689f8a5d":"code","e68d45a9":"code","814ac0c6":"code","c6b99882":"code","ed87e026":"code","1dfdc30e":"code","c39134ba":"code","4f6e3ecd":"code","c341426c":"code","52d3cb05":"code","c991a6b2":"code","c0afc3df":"code","78cc2459":"code","f13641ac":"code","eb4d93cd":"code","72d39f1f":"code","21a20047":"code","a0e513cd":"code","fa547cb8":"code","5439f810":"code","86ce941e":"code","6f144404":"code","6c8f087c":"code","27a8034c":"code","1550aa2d":"code","34c4313b":"markdown","455b89e9":"markdown","c23fdf0a":"markdown","fa5bb1ca":"markdown","7ab5c1c2":"markdown","2883ac3f":"markdown"},"source":{"11b96eb1":"%matplotlib inline\nimport os\nimport sys\n\nimport multiprocessing as mp\nimport numpy as np\nimport pandas as pd\nimport seaborn as sns\n\nfrom functools import partial\nfrom sklearn.externals import joblib\nfrom sklearn.linear_model import LinearRegression\nfrom tqdm import tqdm_notebook as tqdm\n\napplication = pd.read_csv('..\/input\/application_train.csv')\npos_cash_balance = pd.read_csv('..\/input\/POS_CASH_balance.csv')","ae78cdb8":"def parallel_apply(groups, func, index_name='Index', num_workers=1, chunk_size=100000):\n    n_chunks = np.ceil(1.0 * groups.ngroups \/ chunk_size)\n    indeces, features = [], []\n    for index_chunk, groups_chunk in tqdm(chunk_groups(groups, chunk_size), total=n_chunks):\n        with mp.pool.Pool(num_workers) as executor:\n            features_chunk = executor.map(func, groups_chunk)\n        features.extend(features_chunk)\n        indeces.extend(index_chunk)\n    features = pd.DataFrame(features)\n    features.index = indeces\n    features.index.name = index_name\n    return features\n\ndef add_features_in_group(features, gr_, feature_name, aggs, prefix):\n    for agg in aggs:\n        if agg == 'sum':\n            features['{}{}_sum'.format(prefix, feature_name)] = gr_[feature_name].sum()\n        elif agg == 'mean':\n            features['{}{}_mean'.format(prefix, feature_name)] = gr_[feature_name].mean()\n        elif agg == 'max':\n            features['{}{}_max'.format(prefix, feature_name)] = gr_[feature_name].max()\n        elif agg == 'min':\n            features['{}{}_min'.format(prefix, feature_name)] = gr_[feature_name].min()\n        elif agg == 'std':\n            features['{}{}_std'.format(prefix, feature_name)] = gr_[feature_name].std()\n        elif agg == 'count':\n            features['{}{}_count'.format(prefix, feature_name)] = gr_[feature_name].count()\n        elif agg == 'skew':\n            features['{}{}_skew'.format(prefix, feature_name)] = skew(gr_[feature_name])\n        elif agg == 'kurt':\n            features['{}{}_kurt'.format(prefix, feature_name)] = kurtosis(gr_[feature_name])\n        elif agg == 'iqr':\n            features['{}{}_iqr'.format(prefix, feature_name)] = iqr(gr_[feature_name])\n        elif agg == 'median':\n            features['{}{}_median'.format(prefix, feature_name)] = gr_[feature_name].median()\n    return features\n\ndef chunk_groups(groupby_object, chunk_size):\n    n_groups = groupby_object.ngroups\n    group_chunk, index_chunk = [], []\n    for i, (index, df) in enumerate(groupby_object):\n        group_chunk.append(df)\n        index_chunk.append(index)\n        if (i + 1) % chunk_size == 0 or i + 1 == n_groups:\n            group_chunk_, index_chunk_ = group_chunk.copy(), index_chunk.copy()\n            group_chunk, index_chunk = [], []\n            yield index_chunk_, group_chunk_","d993197c":"POS_CASH_BALANCE_AGGREGATION_RECIPIES = []\nfor agg in ['mean', 'min', 'max', 'sum', 'var']:\n    for select in ['MONTHS_BALANCE', 'SK_DPD', 'SK_DPD_DEF']:\n        POS_CASH_BALANCE_AGGREGATION_RECIPIES.append((select, agg))\nPOS_CASH_BALANCE_AGGREGATION_RECIPIES = [(['SK_ID_CURR'], POS_CASH_BALANCE_AGGREGATION_RECIPIES)]","689f8a5d":"groupby_aggregate_names = []\nfor groupby_cols, specs in tqdm(POS_CASH_BALANCE_AGGREGATION_RECIPIES):\n    group_object = pos_cash_balance.groupby(groupby_cols)\n    for select, agg in tqdm(specs):\n        groupby_aggregate_name = '{}_{}_{}'.format('_'.join(groupby_cols), agg, select)\n        application = application.merge(group_object[select]\n                                 .agg(agg)\n                                 .reset_index()\n                                 .rename(index=str, columns={select: groupby_aggregate_name})\n                                 [groupby_cols + [groupby_aggregate_name]],\n                                 on=groupby_cols,\n                                 how='left')\n        groupby_aggregate_names.append(groupby_aggregate_name)","e68d45a9":"application.head()","814ac0c6":"application_agg = application[groupby_aggregate_names + ['TARGET']]\napplication_agg_corr = abs(application_agg.corr())","c6b99882":"application_agg_corr.sort_values('TARGET', ascending=False)['TARGET']","ed87e026":"features = pd.DataFrame({'SK_ID_CURR': pos_cash_balance['SK_ID_CURR'].unique()})","1dfdc30e":"pos_cash_sorted = pos_cash_balance.sort_values(['SK_ID_CURR', 'MONTHS_BALANCE'])\ngroup_object = pos_cash_sorted.groupby('SK_ID_CURR')['CNT_INSTALMENT_FUTURE'].last().reset_index()\ngroup_object.rename(index=str,\n                    columns={'CNT_INSTALMENT_FUTURE': 'pos_cash_remaining_installments'},\n                    inplace=True)\n\nfeatures = features.merge(group_object, on=['SK_ID_CURR'], how='left')\nfeatures.head()","c39134ba":"pos_cash_balance['is_contract_status_completed'] = pos_cash_balance['NAME_CONTRACT_STATUS'] == 'Completed'\ngroup_object = pos_cash_balance.groupby(['SK_ID_CURR'])['is_contract_status_completed'].sum().reset_index()\ngroup_object.rename(index=str,\n                    columns={'is_contract_status_completed': 'pos_cash_completed_contracts'},\n                    inplace=True)\nfeatures = features.merge(group_object, on=['SK_ID_CURR'], how='left')","4f6e3ecd":"X = application.merge(features, left_on=['SK_ID_CURR'], right_on=['SK_ID_CURR'],\n                                how='left',\n                                validate='one_to_one')\nX = X[features.columns.tolist()+['TARGET']]","c341426c":"engineered_numerical_columns = list(features.columns)\nengineered_numerical_columns.remove('SK_ID_CURR')\ncredit_eng = X[engineered_numerical_columns + ['TARGET']]\ncredit_eng_corr = abs(credit_eng.corr())","52d3cb05":"credit_eng_corr.sort_values('TARGET', ascending=False)['TARGET']","c991a6b2":"sns.heatmap(credit_eng_corr, \n            xticklabels=credit_eng_corr.columns,\n            yticklabels=credit_eng_corr.columns)","c0afc3df":"features.head()","78cc2459":"pos_cash_balance['pos_cash_paid_late'] = (pos_cash_balance['SK_DPD'] > 0).astype(int)\npos_cash_balance['pos_cash_paid_late_with_tolerance'] = (pos_cash_balance['SK_DPD_DEF'] > 0).astype(int)\ngroupby = pos_cash_balance.groupby(['SK_ID_CURR'])","f13641ac":"def last_k_installment_features(gr, periods):\n    gr_ = gr.copy()\n    gr_.sort_values(['MONTHS_BALANCE'], ascending=False, inplace=True)\n\n    features = {}\n    for period in periods:\n        if period > 10e10:\n            period_name = 'all_installment_'\n            gr_period = gr_.copy()\n        else:\n            period_name = 'last_{}_'.format(period)\n            gr_period = gr_.iloc[:period]\n\n        features = add_features_in_group(features, gr_period, 'pos_cash_paid_late',\n                                             ['count', 'mean'],\n                                             period_name)\n        features = add_features_in_group(features, gr_period, 'pos_cash_paid_late_with_tolerance',\n                                             ['count', 'mean'],\n                                             period_name)\n        features = add_features_in_group(features, gr_period, 'SK_DPD',\n                                             ['sum', 'mean', 'max', 'min', 'median'],\n                                             period_name)\n        features = add_features_in_group(features, gr_period, 'SK_DPD_DEF',\n                                             ['sum', 'mean', 'max', 'min','median'],\n                                             period_name)\n    return features","eb4d93cd":"features = pd.DataFrame({'SK_ID_CURR': pos_cash_balance['SK_ID_CURR'].unique()})\nfunc = partial(last_k_installment_features, periods=[1, 10, 50, 10e16])\ng = parallel_apply(groupby, func, index_name='SK_ID_CURR', num_workers=10, chunk_size=10000).reset_index()\nfeatures = features.merge(g, on='SK_ID_CURR', how='left')","72d39f1f":"features.head()","21a20047":"X = application.merge(features, on='SK_ID_CURR',how='left')\nX = X[features.columns.drop('SK_ID_CURR').tolist()+['TARGET']]\n\nX_corr = abs(X.corr())\nX_corr.sort_values('TARGET', ascending=False)['TARGET']","a0e513cd":"def last_loan_features(gr):\n    gr_ = gr.copy()\n    gr_.sort_values(['MONTHS_BALANCE'], ascending=False, inplace=True)\n    last_installment_id = gr_['SK_ID_PREV'].iloc[0]\n    gr_ = gr_[gr_['SK_ID_PREV'] == last_installment_id]\n\n    features={}\n    features = add_features_in_group(features, gr_, 'pos_cash_paid_late',\n                                         ['count', 'sum', 'mean'],\n                                         'last_loan_')\n    features = add_features_in_group(features, gr_, 'pos_cash_paid_late_with_tolerance',\n                                         ['sum', 'mean'],\n                                         'last_loan_')\n    features = add_features_in_group(features, gr_, 'SK_DPD',\n                                         ['sum', 'mean', 'max', 'min', 'std'],\n                                         'last_loan_')\n    features = add_features_in_group(features, gr_, 'SK_DPD_DEF',\n                                         ['sum', 'mean', 'max', 'min', 'std'],\n                                         'last_loan_')\n    return features","fa547cb8":"features = pd.DataFrame({'SK_ID_CURR': pos_cash_balance['SK_ID_CURR'].unique()})\ng = parallel_apply(groupby, last_loan_features, index_name='SK_ID_CURR', num_workers=10, chunk_size=10000).reset_index()\nfeatures = features.merge(g, on='SK_ID_CURR', how='left')","5439f810":"features.head()","86ce941e":"X = application.merge(features, on='SK_ID_CURR',how='left')\nX = X[features.columns.drop('SK_ID_CURR').tolist()+['TARGET']]\n\nX_corr = abs(X.corr())\nX_corr.sort_values('TARGET', ascending=False)['TARGET']","6f144404":"def trend_in_last_k_installment_features(gr, periods):\n    gr_ = gr.copy()\n    gr_.sort_values(['MONTHS_BALANCE'], ascending=False, inplace=True)\n\n    features = {}\n    for period in periods:\n        gr_period = gr_.iloc[:period]\n\n        features = add_trend_feature(features, gr_period,\n                                         'SK_DPD', '{}_period_trend_'.format(period)\n                                         )\n        features = add_trend_feature(features, gr_period,\n                                         'SK_DPD_DEF', '{}_period_trend_'.format(period)\n                                         )\n    return features\n\ndef add_trend_feature(features, gr, feature_name, prefix):\n    y = gr[feature_name].values\n    try:\n        x = np.arange(0, len(y)).reshape(-1, 1)\n        lr = LinearRegression()\n        lr.fit(x, y)\n        trend = lr.coef_[0]\n    except:\n        trend = np.nan\n    features['{}{}'.format(prefix, feature_name)] = trend\n    return features","6c8f087c":"features = pd.DataFrame({'SK_ID_CURR': pos_cash_balance['SK_ID_CURR'].unique()})\nfunc = partial(trend_in_last_k_installment_features, periods=[1,6,12,30,60])\ng = parallel_apply(groupby, func, index_name='SK_ID_CURR', num_workers=10, chunk_size=10000).reset_index()\nfeatures = features.merge(g, on='SK_ID_CURR', how='left')","27a8034c":"features.head()","1550aa2d":"X = application.merge(features, on='SK_ID_CURR',how='left')\nX = X[features.columns.drop('SK_ID_CURR').tolist()+['TARGET']]\n\nX_corr = abs(X.corr())\nX_corr.sort_values('TARGET', ascending=False)['TARGET']","34c4313b":"### Trend features","455b89e9":"### Last loan features","c23fdf0a":"### helper functions\nThese functions are just helpers :)","fa5bb1ca":"## Solution 5\n\n### Hand crafted features","7ab5c1c2":"### Aggregations","2883ac3f":"## Solution 4\n### Hand crafted features"}}