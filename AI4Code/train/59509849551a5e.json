{"cell_type":{"727b0173":"code","f2f62b07":"code","78935f4a":"code","9d344baa":"code","80194269":"code","6522a7d8":"code","81d8e72a":"code","e93a28b9":"code","02968f9c":"code","c1af556e":"code","9a639d8d":"code","740fca90":"code","e813f5c5":"code","5cde158d":"code","503aec9f":"code","f70719e9":"code","12c8f0f5":"markdown","f2bd2fa2":"markdown","b154811f":"markdown","4eb9cda5":"markdown","d54f7f91":"markdown","12f0aa3e":"markdown"},"source":{"727b0173":"# Import necessary libraries\nimport pandas as pd\nimport numpy as np\nfrom sklearn.model_selection import train_test_split\nfrom sklearn.metrics import mean_absolute_error\nimport gc\nimport gresearch_crypto\n\nimport matplotlib.pyplot as plt\n%matplotlib inline\n\n# Constants definition\nDATA_PATH = \"..\/input\/g-research-crypto-forecasting\/train.csv\"\nASSET_DETAILS = \"..\/input\/g-research-crypto-forecasting\/asset_details.csv\"","f2f62b07":"# Read train data\nraw_data = pd.read_csv(DATA_PATH)\nraw_data.head()","78935f4a":"# Read asset information (containing more details about each cryptocurrency)\nasset_data = pd.read_csv(ASSET_DETAILS)\nasset_data.head()","9d344baa":"# Let's join them on Asset_ID\ndata = pd.merge(raw_data, asset_data, on='Asset_ID', how='inner')\ndata.head()","80194269":"# For the visualization we'll only use the bitcoin Cash (which have an asset_id = 2)\nbitcoin_cash_data = data.loc[data['Asset_ID'] == 2][-10000:]","6522a7d8":"print(len(bitcoin_cash_data))\nbitcoin_cash_data.head()","81d8e72a":"# Let's see the pattern of each feature individually\ndef plot_features(df):\n    fig, axs = plt.subplots(3, 2)\n    fig.set_size_inches(18.5, 10.5)\n    axs[0, 0].plot(df[\"timestamp\"], df[\"Open\"], 'tab:blue')\n    axs[0, 0].set_title('Open')\n    axs[0, 1].plot(df[\"timestamp\"], df[\"High\"], 'tab:orange')\n    axs[0, 1].set_title('High')\n    axs[1, 0].plot(df[\"timestamp\"], df[\"Low\"], 'tab:green')\n    axs[1, 0].set_title('Low')\n    axs[1, 1].plot(df[\"timestamp\"], df[\"Close\"], 'tab:red')\n    axs[1, 1].set_title('Close')\n    axs[2, 0].plot(df[\"timestamp\"], df[\"Volume\"], 'tab:red')\n    axs[2, 0].set_title('Volume')\n    axs[2, 1].plot(df[\"timestamp\"], df[\"VWAP\"], 'tab:red')\n    axs[2, 1].set_title('VWAP')","e93a28b9":"plot_features(bitcoin_cash_data)","02968f9c":"# Plot the evolution of bitcoin cash\ndef evolution_split(df, test_size=0.2):\n    split_row = len(df) - int(test_size * len(df))\n    train_data = df.iloc[:split_row]\n    test_data = df.iloc[split_row:]\n    return train_data, test_data\ntrain, test = evolution_split(bitcoin_cash_data, test_size=0.2)\n\ndef plot_evolution(x1, x2, line1, line2, label1=None, label2=None, title='', lw=2):\n    fig, ax = plt.subplots(1, figsize=(13, 7))\n    ax.plot(x1, line1, label=label1, linewidth=lw)\n    ax.plot(x2, line2, label=label2, linewidth=lw)\n    ax.set_ylabel('Target', fontsize=14)\n    ax.set_title(title, fontsize=16)\n    ax.legend(loc='best', fontsize=16)\nplot_evolution(train[\"timestamp\"], test[\"timestamp\"], train[\"Target\"], test[\"Target\"], 'training', 'test', title='')","c1af556e":"def get_features(df):\n    df_feat = df[['Count', 'Open', 'High', 'Low', 'Close', 'Volume', 'VWAP']].copy()\n    df_feat['Upper_Shadow'] = df_feat['High'] - np.maximum(df_feat['Close'], df_feat['Open'])\n    df_feat['Lower_Shadow'] = np.minimum(df_feat['Close'], df_feat['Open']) - df_feat['Low']\n    \n    df_feat['lower_shadow'] = np.minimum(df_feat['Close'], df_feat['Open']) - df_feat['Low']\n    df_feat['high2low'] = df_feat['High'] \/ df_feat['Low']\n    df_feat['volume2count'] = df_feat['Volume'] \/ (df_feat['Count'] + 1)\n    \n    return df_feat","9a639d8d":"def get_data_for_asset(df_train, asset_id):\n   \n    df = df_train[df_train[\"Asset_ID\"] == asset_id]    \n    df_proc = get_features(df)\n    df_proc['y'] = df['Target']\n    df_proc = df_proc.dropna(how=\"any\")\n    \n    X = df_proc.drop(\"y\", axis=1)\n    y = df_proc[\"y\"]\n    \n    return X, y","740fca90":"from sklearn.linear_model import LinearRegression\nfrom sklearn.ensemble import RandomForestRegressor\nfrom sklearn.tree import DecisionTreeRegressor\nfrom xgboost import XGBRegressor\nfrom lightgbm import LGBMRegressor","e813f5c5":"benchmarking_models = {\n    \"lr\": LinearRegression(),\n    \"dt\": DecisionTreeRegressor(max_depth=2),\n    \"rf\": RandomForestRegressor(n_estimators = 2000, random_state = 42),\n    \"xgboost\": XGBRegressor(n_estimators=2000, max_depth=7, eta=0.1, subsample=0.7, colsample_bytree=0.8),\n    \"lgbm\": LGBMRegressor(n_estimators=2000, num_leaves=500, learning_rate=0.1)\n}","5cde158d":"def model_training(X,y, model_name):\n    # Model training\n    model = benchmarking_models[model_name]\n    model.fit(X, y)\n    \n    return model","503aec9f":"%%time\nXs = {}\nys = {}\nmodels = {}\nmodel_name = \"lgbm\" # You can switch to any other model\n\nfor asset_id, asset_name in zip(asset_data['Asset_ID'], asset_data['Asset_Name']):\n    print(f\"Training model for {asset_name:<16} (ID={asset_id:<2})\")\n    X, y = get_data_for_asset(raw_data, asset_id)\n    X_train, X_test, y_train, y_test = train_test_split(X, y.tolist(), test_size=0.2)   \n    model = model_training(X_train,y_train, model_name)\n    Xs[asset_id], ys[asset_id], models[asset_id] = X, y, model\n    preds = model.predict(X_test).squeeze()\n    print(\"MAE of \" +model_name + \"on \" + asset_name+ \"dataset: \", mean_absolute_error(preds, y_test))\n    gc.collect()","f70719e9":"# Prediction and submission\nenv = gresearch_crypto.make_env()\niter_test = env.iter_test()\n\nfor i, (df_test, df_pred) in enumerate(iter_test):\n    for j, row in df_test.iterrows():\n        \n        try:\n            model = models[row['Asset_ID']]\n            x_test = get_features(row)\n            y_pred = model.predict([x_test])[0]\n\n            df_pred.loc[df_pred['row_id'] == row['row_id'], 'Target'] = y_pred\n        \n        except:\n            print(f'{i}-th iteration of the test dataset, {j}-th row - there was the exception, then set Target = 0')\n            df_pred.loc[df_pred['row_id'] == row['row_id'], 'Target'] = 0\n            \n        # Print just one sample row to get a feeling of what it looks like        \n        if i == 0 and j == 0:\n            print('Example of the x_test data')\n            display(x_test)\n    # Display the first prediction dataframe\n    if i == 0:\n        print('Example of the prediction for test data')\n        display(df_pred)\n    df_pred['Target'] = df_pred['Target'].fillna(0)\n\n    # Send submissions\n    env.predict(df_pred)","12c8f0f5":"# Let's discover our data\n\nTo forecast cryptocurrency prices, we should use all the trading features like price, volume, open, high, low values which are presents in the dataset.\n\n* Close Price \u2014 It is the market close price for currency for that particular day.\n* High Price \u2014 It is highest price of currency for the day.\n* Low Price \u2014 It is the lowest price for currency for that day.\n* Open Price \u2014 It is market open price for currency for that day.\n* Volume \u2014 The volume of currency that is being in trade for that day.","f2bd2fa2":"# Submission","b154811f":"We can add cross validation to fine-tune the selected model base on the available hyperparameters for each one.","4eb9cda5":"# Some EDA and visualizations","d54f7f91":"# Prepare features","12f0aa3e":"# Experiment some regression models"}}