{"cell_type":{"4d4381ec":"code","b043624b":"code","9a78620d":"code","98b6a712":"code","4124ad79":"code","11605d7b":"code","6e54e315":"markdown","dccce138":"markdown","ce33e9fd":"markdown","78e17287":"markdown","c8d5c2c0":"markdown","dcee5df5":"markdown"},"source":{"4d4381ec":"import numpy as np, pandas as pd, os\nimport matplotlib.pyplot as plt, cv2\nimport tensorflow as tf, re, math","b043624b":"def decode_image(image, HEIGHT, WIDTH, CHANNELS):\n    image = tf.image.decode_jpeg(image, channels=CHANNELS)\n    image = (tf.cast(image, tf.float32) \/ 127.5) - 1\n    image = tf.reshape(image, [HEIGHT, WIDTH, CHANNELS])\n    return image\n\ndef read_tfrecord(example, HEIGHT, WIDTH, CHANNELS):\n    tfrecord_format = {\n        'image':      tf.io.FixedLenFeature([], tf.string),\n    }\n    example = tf.io.parse_single_example(example, tfrecord_format)\n    image = decode_image(example['image'], HEIGHT, WIDTH, CHANNELS)\n    return image\n\ndef load_dataset(filenames, HEIGHT, WIDTH, CHANNELS=3):\n    dataset = tf.data.TFRecordDataset(filenames)\n    dataset = dataset.map(lambda example: read_tfrecord(example, HEIGHT, WIDTH, CHANNELS), num_parallel_calls=AUTO)      \n    return dataset\n\ndef display_samples(ds, row, col):\n    ds_iter = iter(ds)\n    plt.figure(figsize=(15, int(15*row\/col)))\n    for j in range(row*col):\n        example_sample = next(ds_iter)\n        plt.subplot(row,col,j+1)\n        plt.axis('off')\n        plt.imshow(example_sample[0] * 0.5 + 0.5)\n    plt.show()\n\n\ndef count_data_items(filenames):\n    n = [int(re.compile(r\"-([0-9]*)\\.\").search(filename).group(1)) for filename in filenames]\n    return np.sum(n)\n\n\n# Create TF Records\ndef _bytes_feature(value):\n  \"\"\"Returns a bytes_list from a string \/ byte.\"\"\"\n  if isinstance(value, type(tf.constant(0))):\n    value = value.numpy() # BytesList won't unpack a string from an EagerTensor.\n  return tf.train.Feature(bytes_list=tf.train.BytesList(value=[value]))\n\ndef serialize_example(image):\n  feature = {\n      'image': _bytes_feature(image),\n  }\n  example_proto = tf.train.Example(features=tf.train.Features(feature=feature))\n  return example_proto.SerializeToString()","9a78620d":"PATH = '\/kaggle\/input\/monet-paintings-jpg-berkeley\/'\nIMGS = os.listdir(PATH)\nSIZE = (len(IMGS) \/\/ 5) + 1 # split images into 5 files\nIMAGE_SIZE = [256, 256]\n\nprint(f'Image samples: {len(IMGS)}')","98b6a712":"CT = len(IMGS)\/\/SIZE + int(len(IMGS)%SIZE!=0)\nfor j in range(CT):\n    print(); print('Writing TFRecord %i of %i...'%(j,CT))\n    CT2 = min(SIZE,len(IMGS)-j*SIZE)\n    with tf.io.TFRecordWriter('monet%.2i-%i.tfrec'%(j,CT2)) as writer:\n        for k in range(CT2):\n            img = cv2.imread(PATH+IMGS[SIZE*j+k])\n            img = cv2.cvtColor(img, cv2.COLOR_RGB2BGR)\n            img = cv2.imencode('.jpg', img, (cv2.IMWRITE_JPEG_QUALITY, 94))[1].tostring()\n            name = IMGS[SIZE*j+k].split('.')[0]\n            example = serialize_example(img)\n            writer.write(example)\n            if k%100==0: print(k,', ',end='')","4124ad79":"AUTO = tf.data.experimental.AUTOTUNE\nFILENAMES = tf.io.gfile.glob('monet*.tfrec')\nprint(f'TFRecords files: {FILENAMES}')\nprint(f'Created image samples: {count_data_items(FILENAMES)}')","11605d7b":"display_samples(load_dataset(FILENAMES, *IMAGE_SIZE).batch(1), 6, 6)","6e54e315":"#### Code based on this Chris Deotte kernel [How To Create TFRecords](https:\/\/www.kaggle.com\/cdeotte\/how-to-create-tfrecords)","dccce138":"# Dependencies","ce33e9fd":"# Auxiliar functions","78e17287":"# Validate created TF records","c8d5c2c0":"# Generate TF records","dcee5df5":"# Parameters"}}