{"cell_type":{"bff1f6fd":"code","649000bf":"code","0f7e1729":"code","bf097b9c":"code","cdbc2b8b":"code","e09c419f":"code","2028fb76":"code","6c4d5ea5":"code","3be0081d":"code","129d2e06":"code","703e4be2":"code","3865309b":"code","372e6673":"code","772e2b02":"code","f9685e37":"code","0a04b19e":"code","bb4d6c94":"code","9697e208":"code","8ca37504":"code","b6805843":"code","bd803935":"code","cc52d1f9":"code","0bc812b7":"markdown","78e461ed":"markdown","92c5f92d":"markdown","773dfbd3":"markdown","190a452f":"markdown","944d95c6":"markdown","0afc3eac":"markdown","7ccc7e91":"markdown","511d95d4":"markdown","297b7343":"markdown","dec62cb9":"markdown","246b2102":"markdown","8d92ed01":"markdown","54e57c73":"markdown","85b0ebaf":"markdown","ea0368bd":"markdown","ca520ead":"markdown","9353418a":"markdown","3934cab4":"markdown","95e60a07":"markdown","212ef973":"markdown","30dfb667":"markdown","f104e056":"markdown","e4aadcbd":"markdown","ada02042":"markdown"},"source":{"bff1f6fd":"!pip install -q scanpy\n\nimport scanpy as sc # import scanpy to handle our AnnData \nimport pandas as pd # import pandas to handle dataframes\nimport matplotlib.pyplot as plt # import matplotlib to visualize our qc metrics\n\n# magic incantation to help matplotlib work with our jupyter notebook\n%matplotlib inline ","649000bf":"adata = sc.read('..\/input\/theory-introto-singlecell-rnaseq-images\/brain_raw\/brain_raw.h5ad')","0f7e1729":"adata.obs.head()","bf097b9c":"adata.var.head()","cdbc2b8b":"qc = sc.pp.calculate_qc_metrics(adata, qc_vars = ['ERCC'])# this returns a tuple of (cell_qc_dataframe, gene_qc_dataframe)\n                                 # ask for the percentage of reads from spike ins\n                                \ncell_qc_dataframe = qc[0]\ngene_qc_dataframe = qc[1]\n\nprint('This is the cell quality control dataframe:')\ncell_qc_dataframe.head()","e09c419f":"import seaborn as sns\nsns.jointplot(\n    data=cell_qc_dataframe,\n    x=\"log1p_total_counts\",\n    y=\"log1p_n_genes_by_counts\",\n    kind=\"hex\",\n)","2028fb76":"sns.histplot(cell_qc_dataframe[\"pct_counts_ERCC\"])","6c4d5ea5":"print('This is the gene quality control dataframe:')\ngene_qc_dataframe.head()","3be0081d":"plt.hist(cell_qc_dataframe['total_counts'], bins=1000)\nplt.xlabel('Total counts')\nplt.ylabel('N cells')\nplt.axvline(50000, color='red')","129d2e06":"sum(cell_qc_dataframe['total_counts'] < 50000)","703e4be2":"plt.hist(cell_qc_dataframe['n_genes_by_counts'], bins=100)\nplt.xlabel('N genes')\nplt.ylabel('N cells')\nplt.axvline(1000, color='red')","3865309b":"plt.hist(cell_qc_dataframe['pct_counts_ERCC'], bins=1000)\nplt.xlabel('Percent counts ERCC')\nplt.ylabel('N cells')\nplt.axvline(10, color='red')","372e6673":"low_ERCC_mask = (cell_qc_dataframe['pct_counts_ERCC'] < 10)\nadata = adata[low_ERCC_mask]","772e2b02":"# Filter cells with fewer 750 genes detected.\nprint('Started with: \\n', adata)\nsc.pp.filter_cells(adata, min_genes = 750)\nprint('Finished with: \\n', adata)","f9685e37":"gene_qc_dataframe.head()","0a04b19e":"plt.hist(gene_qc_dataframe['n_cells_by_counts'], bins=1000)\nplt.xlabel('N cells expressing > 0')\nplt.ylabel('log(N genes)') # for visual clarity\nplt.axvline(2, color='red')\nplt.yscale('log') ","bb4d6c94":"sum(gene_qc_dataframe['n_cells_by_counts'] < 2)","9697e208":"plt.hist(gene_qc_dataframe['total_counts'], bins=1000)\nplt.xlabel('Total counts')\nplt.ylabel('log(N genes)') # for visual clarity\nplt.yscale('log') \nplt.axvline(10, color='red')","8ca37504":"sum(gene_qc_dataframe['total_counts'] < 10)","b6805843":"print('Started with: \\n', adata)\nsc.pp.filter_genes(adata, min_cells = 2)\nsc.pp.filter_genes(adata, min_counts = 10)\nprint('Finished with: \\n', adata)","bd803935":"print(adata) ## Final dimensions of the QC'd dataset\nadata.write('brain_qc.h5ad')","cc52d1f9":"!zip \"brain_qc.zip\" \".\/brain_qc.h5ad\"","0bc812b7":"## Spike-ins \n- Another measure of cell quality is the ratio between ERCC spike-in RNAs and endogenous RNAs. This ratio can be used to estimate the total amount of RNA in the captured cells. \n- **Cells with a high level of spike-in RNAs had low starting amounts of RNA, likely due to the cell being dead or stressed which may result in the RNA being degraded.**","78e461ed":"## Cell Filtering based on above analysis\nThere isn't an automatic function for removing cells with a high percentage of ERCC reads, but we can use a mask to remove them like so:\n- Removing cells having ERCC percentage count >= 10\n- Removing cell having gene count < 750","92c5f92d":"From the plot we conclude that most cells have between ~1,000-5,000 detected genes, which is typical for smartseq2 data. However, this varies by experimental protocol and sequencing depth.\n\nThe most notable feature in the above plot is the <b>little peak on the left hand side <\/b>of the distribution. If detection rates were equal across the cells then the distribution should be approximately normal. Thus, we will remove those cells in the tail of the distribution (fewer than ~1000 detected genes).","773dfbd3":"<h1 style = \"font-family: garamond; font-size: 40px; font-style: normal; letter-spcaing: 3px; background-color: #f6f5f5; color :#fe346e; border-radius: 100px 100px; text-align:center\">Introduction<\/h1>\n\n- Once we have our expression matrix, it should be examined to remove poor quality cells which were not detected in the initial processing of the raw reads. Failure to remove low quality cells at this stage may add technical noise which has the potential to obscure the biological signals of interest in the downstream analysis.\n\n- To perform QC we will be looking for cells which are outliers with respect to the rest of the dataset rather than comparing to independent quality standards. Consequently, care should be taken when comparing quality metrics across datasets collected using different protocols.","190a452f":"Around 5k genes are removed.","944d95c6":"# Saving the Quality Controlled adata","0afc3eac":"There are 4432 gene which is having sum_counts < 10","7ccc7e91":"## Detected genes \nIn addition to ensuring sufficient sequencing depth for each sample, we also want to make sure that the reads are distributed across the transcriptome. Thus, we count the total number of unique genes detected in each sample.","511d95d4":"calculate_qc_metrics when ['ERCC'] is inserted, it returns the information of both cells and genes with respect to Spike-ins.","297b7343":"Gives the histogram for **pct_counts_ERCC** - %genes in the cell which are ERCC","dec62cb9":"<h1 style = \"font-family: garamond; font-size: 40px; font-style: normal; letter-spcaing: 3px; background-color: #f6f5f5; color :#fe346e; border-radius: 100px 100px; text-align:center\">Quality Control for Genes<\/h1>\n\nIt is typically a good idea to remove genes whose expression level is considered \"undetectable\". \n- We define a <b>gene as detectable if at least two cells contain more than 5 reads from the gene. <\/b> However, the threshold strongly depends on the sequencing depth. \n- It is important to keep in mind that <b> genes must be filtered after cell filtering <\/b> since some genes may only be detected in poor quality cells.","246b2102":"<h1 style = \"font-family: garamond; font-size: 40px; font-style: normal; letter-spcaing: 3px; background-color: #f6f5f5; color :#fe346e; border-radius: 100px 100px; text-align:center\">Summary<\/h1>\n\n- We calculated the quality control metrices across cells and genes.\n- We did quality control in cells by removing cells with less total gene count, less unique genes and gaving more spike-ins.\n- We did quality control in genes by removing genes which occur in less unique cells as well as those genes having less total cells.\n- Saving the quality controlled data for further pipeline.","8d92ed01":"https:\/\/chanzuckerberg.github.io\/scRNA-python-workshop\/preprocessing\/01-basic-qc.html","54e57c73":"### Loading the data","85b0ebaf":"<h1 style = \"font-family: garamond; font-size: 40px; font-style: normal; letter-spcaing: 3px; background-color: #f6f5f5; color :#fe346e; border-radius: 100px 100px; text-align:center\">Quality Control for Cells<\/h1>\n\n## Library size \nFirst, we consider the total number of reads detected per cell. Cells with few reads are likely to have been broken or failed to capture a cell, and should thus be removed.","ea0368bd":"<h1 style = \"font-family: garamond; font-size: 40px; font-style: normal; letter-spcaing: 3px; background-color: #f6f5f5; color :#fe346e; border-radius: 100px 100px; text-align:center\">Computing quality control metrics<\/h1>\nWe'll compute quality metrics and then filter cells and genes accordingly.\n\nThe calculate_qc_metrics function returns two dataframes: one containing quality control metrics about cells, and one containing metrics about genes. This function is housed in the 'preprocessing' portion of the SCANPY library.","ca520ead":"- \u201ctotal_genes_by_counts\u201d. Number of genes with positive counts in a cell. (total gene count having True ERCC)\n- \u201ctotal_counts\u201d. Total number of counts for a cell.\n- \u201cpct_counts_in_top_50_genes\u201d. Cumulative percentage of counts for 50 most expressed genes in a cell.\n- \u201ctotal_counts_ercc\u201d. Total number of counts for variabes in qc_vars.\n- \u201cpct_counts_ercc\u201d. Proportion of total counts for a cell which are ercc.\n- \u201ctotal_counts\u201d. Sum of counts for a gene.\n- \u201cn_genes_by_counts\u201d. The number of genes with at least 1 count in a cell. Calculated for all cells.\n- \u201cmean_counts\u201d. Mean expression over all cells.\n- \u201cn_cells_by_counts\u201d. Number of cells this expression is measured in.\n- \u201cpct_dropout_by_counts\u201d. Percentage of cells this feature does not appear in.","9353418a":"First, we consider the total number of cell in which a gene is deteted. Genes with few cell count are outliers and should thus be removed.","3934cab4":"![image.png](attachment:9f5d68fc-8c8d-42f3-8816-dc0a3a7dd763.png)","95e60a07":"<br>\n<h1 style = \"font-size:60px; font-family:Garamond ; font-weight : normal; background-color: #f6f5f5 ; color : #fe346e; text-align: center; border-radius: 100px 100px;\">Quality Control<\/h1>\n<br>","212ef973":"Looks like the authors have already removed cells with fewer than 50,000 reads.","30dfb667":"There is 3969 genes which are having n_cells_by_counts < 2","f104e056":"Plot between **log1p_n_genes_by_counts** (log(1+x) where x is count of unique genes in a cell) and **log1p_total_counts** (log(1+x) where x is total count of genes in a cell)\n\nPlots a bivariate histogram using hexagonal bins with marginal histograms.","e4aadcbd":"### Installations","ada02042":"Placing a threshold is always a judgement call. Here, the majority of cells have less than 10% ERCC counts, but there's a <b>long tail of cells that have very high spike-in counts; these are likely dead cells and should be removed.<\/b>"}}