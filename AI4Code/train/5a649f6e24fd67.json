{"cell_type":{"b9b9e5f2":"code","9d3fb706":"code","e0b84a31":"code","36e0fa6d":"code","5914b69a":"code","bb77a96b":"code","a2262216":"code","60cab55c":"code","1e4f3847":"code","523512db":"code","ab0f727b":"code","ec0f3681":"code","d0ecc033":"markdown","87dd5930":"markdown","7170696d":"markdown","956f6061":"markdown","1a10e1a5":"markdown","46305054":"markdown","6defc096":"markdown","aa474ffe":"markdown","8278ebf7":"markdown","ffccce60":"markdown","2a66e1c1":"markdown","27596831":"markdown","a56a02df":"markdown"},"source":{"b9b9e5f2":"import numpy as np\nimport pandas as pd\n\nimport os\nprint(os.listdir(\"..\/input\"))\n\n","9d3fb706":"df_kaggle_test = pd.read_hdf(\n         '..\/input\/save-hdf-full\/test.hdf',\n         key=\"test\"\n)","e0b84a31":"from datetime import datetime\n\ndef add_timestamps(df):\n    datedictAS = np.load('..\/input\/timestamps\/AvSigVersionTimestamps.npy')[()]\n    df['DateAS'] = df['AvSigVersion'].map(datedictAS)  \n\n    datedictOS = np.load('..\/input\/timestamps\/OSVersionTimestamps.npy')[()]\n    df['DateOS'] = df['Census_OSVersion'].map(datedictOS)  \n    # BL timestamp\n    def convert(x):\n        try:\n            d = datetime.strptime(x.split('.')[4],'%y%m%d-%H%M')\n        except:\n            d = np.nan\n        return d\n    df['DateBL'] = df['OsBuildLab'].map(convert)\n    \nadd_timestamps(df_kaggle_test)","36e0fa6d":"df_kaggle_test.query(\"DateAS<'2018-10-26' and DateOS>='2018-10-26'\").shape","5914b69a":"df_kaggle_test.query(\"DateAS<'2018-10-26' and DateBL>='2018-10-26'\").shape","bb77a96b":"df_submission=pd.read_csv(\"..\/input\/nffm-baseline-0-690-on-lb\/nffm_submission.csv\")\ndf_submission.hist(bins=30)\ndf_submission.head()","a2262216":"df_submission.to_csv(\"original_submission.csv\",index=None)","60cab55c":"print(\"using only AvSigVersion Date, private split rows:\",\n      df_submission.loc[(df_kaggle_test.DateAS>=\"2018-10-26\")].shape)\n\nprint(\"using all Dates available, private split rows:\",\n      df_submission.loc[(df_kaggle_test.DateAS>=\"2018-10-26\")\n                  | (df_kaggle_test.DateBL>=\"2018-10-26\")\n                  | (df_kaggle_test.DateOS>=\"2018-10-26\")].shape)","1e4f3847":"df_private_submission=df_submission.copy()\ndf_private_submission.loc[~ ((df_kaggle_test.DateAS>=\"2018-10-26\")\n                  | (df_kaggle_test.DateBL>=\"2018-10-26\")\n                  | (df_kaggle_test.DateOS>=\"2018-10-26\")),\"HasDetections\"]=0\ndf_private_submission.hist(bins=30)\ndf_private_submission.head()\n","523512db":"df_private_submission.to_csv(\"private_lb_submission.csv\",index=None)","ab0f727b":"df_submission.loc[(df_kaggle_test.DateAS>=\"2018-10-26\")\n                  | (df_kaggle_test.DateBL>=\"2018-10-26\")\n                  | (df_kaggle_test.DateOS>=\"2018-10-26\"),\"HasDetections\"]=0\ndf_submission.hist(bins=30)\ndf_submission.head()","ec0f3681":"df_submission.to_csv(\"public_lb_submission.csv\",index=None)","d0ecc033":"# Save original submission for comparison","87dd5930":"# So, what's next?\n\n- makes sense? \n- is private really one day or two days?\n- what can we do with this?\n- thoughts? comments?\n\nthanks!\n","7170696d":"# Add timestamps so that we can zero submission predictions >= 2018-10-26 \n\nReusing snippet in discussion [External (Scrapped Datasets) Useful for EDA :)](https:\/\/www.kaggle.com\/c\/microsoft-malware-prediction\/discussion\/78672)","956f6061":"# Zero predictions in private test rows >=2018-10-26, if submitted result should not be affected in public LB","1a10e1a5":"# Save to compare submissions, final result is same!\n\nin this specific case, scores .688 for both files (actual result depending on nnfm kernel submission)\nfor private_lb_submission public score is .5 auc as expected","46305054":"\n# 2 months train, 1 month public, 1 day private?\n\nThe hypothesis comes mainly from exploring row counts based on Aditya & Chris timestamps mapping on AvSigVersion.\n\nSo,combining all these together we have::\n\n![image.png](https:\/\/i.imgur.com\/7jbVLFu.jpg)\n\nThe test set seems to come from two different distributions, that do overlap on 26-sep to 25-oct. Doing some quick checks if we consider public test <26-oct-2016, would account for ~70% of rows in test. (makes sense not being exactly 66% due to some overlap between 26-sep to 25-oct)\n\nSo could it be that msft built two sets for three splits?\n\n**set 1, with defender reports  from 25-july to 25-october **, produced train (two month) & public test set (one month)\n\nnoting that avsigversion can have dates before this, ex:some systems not getting updated virus definitions.\nfrom this set 1, two months went to training, one month to public leaderboard (66%)\n\n**set 2, may be only one day? defender reports from 25-nov-2018, ** produced final private test set\n\nsame happens, avsigversion can have dates before than this, think that's expected,\njust guessing to be one day (25) because would be a simpler explanation :), although there are really two days (24 & 25)  with similar number of rows, could we be sure? (in progress)\n\nthis set would be the final private lb test set\n\n# Can we test this?\n\nSo if this is the case, any rows >=26 oct 2018 would belong to final private test set and not being used in anyway in the public lb score, so we should be able to zero those predictions and get similar result in the public lb?\n\nLet's see!","6defc096":"# Zero predictions in public test rows <2018-10-26, if submitted public LB result should be really bad","aa474ffe":"# Reusing kernel submission from [NFFM baseline (0.690 on LB)](https:\/\/www.kaggle.com\/guoday\/nffm-baseline-0-690-on-lb) (scores around ~.690) and AvSigVersion, Census_OSVersion timestamps","8278ebf7":"## Seems we can recover a few rows, let's test!","ffccce60":"## Test private split impact, is private  >=26 oct 2018?\n\nIf so, zeroing predictions >= 26-oct-2018, should affect only Private LB and not Public LB (.690)\n\nupdated 19-02-2019, also filter other dates >=26-oct-2018, recover some extra private split rows, result is the same","2a66e1c1":"# Update 19-02-2019, Use other two available dates, if >=2018-10-26, belong to private test? recover a few rows?\n\nnote: this may be system reports with older av definitions, but were reported >=2018-10-26, otherwise they coudlnt have builds with dates after that?","27596831":"# Based on Kernels & Insights from [Aditya Soni](https:\/\/www.kaggle.com\/adityaecdrid), [Chris Deotte](https:\/\/www.kaggle.com\/cdeotte)\n\n- [External (Scrapped Datasets) Useful for EDA :)](https:\/\/www.kaggle.com\/c\/microsoft-malware-prediction\/discussion\/78672)\n- [Time Series EDA - Malware ](https:\/\/www.kaggle.com\/cdeotte\/time-series-eda-malware-0-64)\n- [Best single model](https:\/\/www.kaggle.com\/c\/microsoft-malware-prediction\/discussion\/76384#449402)\n\n# Updated 19-02-2019\n\n- Also use other two available dates to add few more rows to private test split, stil did not reach full 33% of private test set \n- Added private_lb_submission.csv output (all rows I think belong to public lb have prediction forced to zero), as expected score .5 auc","a56a02df":"## Load & Check nnfm predictions (~.690 LB)"}}