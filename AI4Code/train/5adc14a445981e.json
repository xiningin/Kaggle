{"cell_type":{"0c3f6fe6":"code","d1d7461e":"code","48346f43":"code","49762ae1":"code","365e1060":"code","31a5331e":"code","01ba2c59":"code","9bd8e24b":"code","ba12808b":"code","97fa4d01":"code","1f206df3":"code","7f5f81ed":"code","45845cb4":"code","0392ffc3":"code","c0ce91f8":"code","2079d232":"code","fdd6e779":"code","93387a6f":"code","0a28ddee":"code","16914186":"code","23c5a857":"code","1ecbc0cf":"code","a076d28a":"code","86460e22":"code","035d9287":"code","81e78c96":"markdown","01e65487":"markdown","1d32b7ad":"markdown","28264462":"markdown","5273661e":"markdown","17327f7d":"markdown","34ef1be8":"markdown","fce21106":"markdown","e7bfca8a":"markdown","09443a1d":"markdown","380ebc46":"markdown","793bbeb7":"markdown","54c75aea":"markdown","cd39a14a":"markdown","2c0521c3":"markdown"},"source":{"0c3f6fe6":"import os\nimport numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\n\nimport plotly_express as px\nimport plotly.graph_objects as go\nimport matplotlib.pyplot as plt\n\nfrom plotly.subplots import make_subplots","d1d7461e":"%%time\ntrain=pd.read_csv('..\/input\/optiver-realized-volatility-prediction\/train.csv')\nbook_train=pd.read_parquet('..\/input\/optiver-realized-volatility-prediction\/book_train.parquet')\ntrade_train=pd.read_parquet('..\/input\/optiver-realized-volatility-prediction\/trade_train.parquet')\n\nbook_train_path='..\/input\/optiver-realized-volatility-prediction\/book_train.parquet'","48346f43":"print(train.shape)\nprint(book_train.shape)\nprint(trade_train.shape)","49762ae1":"def update_trace_line(fig, x, y, row, col, args=None):\n    if args is None:\n        args={}\n    fig.add_trace(\n        go.Scatter(x=x, y=y, \n                   mode=args.get('mode', None),\n                   line=args.get('line', None),\n                   text=args.get('text', None),\n                   name=args.get('name', None),\n                   hoverinfo=args.get('hoverinfo', None)\n                  ),\n        row=row, col=col\n    )","365e1060":"def visualize_sample(stock_id, time_id):\n    window=3\n\n    sample_book=book_train[(book_train.stock_id==stock_id) & (book_train.time_id==time_id)].copy()\n    sample_book['wap']=(sample_book['bid_price1'] * sample_book['ask_size1']) + (sample_book['ask_price1'] * sample_book['bid_size1'])\n    sample_book['wap']\/=(sample_book['ask_size1'] + sample_book['bid_size1'])\n\n    sample_book['wap_rolling']=sample_book.wap.rolling(window).mean()\n    sample_book['ask_price_rolling1']=sample_book.ask_price1.rolling(window).mean()\n    sample_book['bid_price_rolling1']=sample_book.bid_price1.rolling(window).mean()\n\n    sample_book['ask_size_rolling1']=sample_book.ask_size1.rolling(window).mean()\n    sample_book['bid_size_rolling1']=sample_book.bid_size1.rolling(window).mean()\n\n    sample_book.fillna(0, inplace=True)\n    \n    \n    \n    \n    fig=make_subplots(rows=2, cols=2,\n                      subplot_titles=[\"Price Movements in a Bucket.\", \n                                      \"Rolling Avg Price Movements in Bucket\",\n                                      \"Volume Movements in a Bucket\",\n                                      \"Rolling Avg Movements in a Bucket\"]\n                     )\n\n\n    update_trace_line(fig, sample_book['seconds_in_bucket'], sample_book['ask_price1'], 1, 1, {\n        'mode': 'lines',\n        'line': dict(width=2),\n        'name': 'ask_price1',\n        'hoverinfo': 'name'\n    })\n\n    update_trace_line(fig, sample_book['seconds_in_bucket'], sample_book['bid_price1'], 1, 1, {\n        'mode': 'lines',\n        'line': dict(width=2),\n        'text': 'bid_price1',\n        'hoverinfo': 'text'\n    })\n    update_trace_line(fig, sample_book['seconds_in_bucket'], sample_book['wap'], 1, 1, {\n        'mode': 'lines',\n        'line': dict(width=1),\n        'text': 'wap',\n        'hoverinfo': 'text'\n    })\n\n\n\n    update_trace_line(fig, sample_book['seconds_in_bucket'].values[3:], \n                      sample_book['ask_price_rolling1'].values[3:], \n                      1, 2,\n                      {\n                          'mode': 'lines',\n                          'line': dict(width=2),\n                          'name': 'ask_price_rolling1',\n                          'hoverinfo':'name'\n                      })\n\n    update_trace_line(fig, sample_book['seconds_in_bucket'].values[3:], \n                      sample_book['bid_price_rolling1'].values[3:],\n                      1, 2,\n                      {\n                          'mode': 'lines',\n                          'line': dict(width=2),\n                          'name': 'bid_price_rolling1',\n                          'hoverinfo':'name'\n                      })\n\n    update_trace_line(fig, sample_book['seconds_in_bucket'].values[3:], \n                      sample_book['wap_rolling'].values[3:],\n                      1, 2, \n                      {\n                          'mode': 'lines',\n                          'line': dict(width=1),\n                          'name': 'wap_rolling',\n                          'hoverinfo':'name'\n                      })\n\n\n\n    update_trace_line(fig, sample_book['seconds_in_bucket'], \n                      sample_book['ask_size1'],\n                      2, 1, \n                      {\n                          'mode': 'lines',\n                          'line': dict(width=2),\n                          'name': 'ask_size1',\n                          'hoverinfo':'name'\n                      })\n\n\n    update_trace_line(fig, sample_book['seconds_in_bucket'], \n                      sample_book['bid_size1'],\n                      2, 1, \n                      {\n                          'mode': 'lines',\n                          'line': dict(width=2),\n                          'name': 'bid_size1',\n                          'hoverinfo':'name'\n                      })\n\n\n    update_trace_line(fig, sample_book['seconds_in_bucket'].values[3:],\n                      sample_book['ask_size_rolling1'].values[3:],\n                      2, 2, \n                      {\n                          'mode': 'lines',\n                          'line': dict(width=2),\n                          'name': 'ask_size_rolling1',\n                          'hoverinfo':'name'\n                      })\n\n\n    update_trace_line(fig, sample_book['seconds_in_bucket'].values[3:],\n                      sample_book['bid_size_rolling1'].values[3:],\n                      2, 2,\n                      {\n                          'mode': 'lines',\n                          'line': dict(width=2),\n                          'name': 'bid_size_rolling1',\n                          'hoverinfo':'name'\n                      })\n\n    fig.update_layout(width=1200, height=1000, \n                      title=\"Stock:{}-Bucket:{} <br> Target 10-min realized Volatitlity:{}\".format(stock_id, time_id, \n                                                                                                train[(train.stock_id==stock_id) & (train.time_id==time_id)].target.values[0]\n                                                                                               ))\n    fig.show()","31a5331e":"visualize_sample(0, 5)\nvisualize_sample(56, 25312)\nvisualize_sample(111, 15765)\nvisualize_sample(111, 15770)","01ba2c59":"#print()\nprint(train[(train.stock_id==0) & (train.time_id==5)].target.values[0])\nprint(train[(train.stock_id==56) & (train.time_id==25312)].target.values[0])\nprint(train[(train.stock_id==111) & (train.time_id==15765)].target.values[0])\nprint(train[(train.stock_id==111) & (train.time_id==15770)].target.values[0])","9bd8e24b":"def get_bucket_wap_stat(df):\n    wap_df=df.groupby(['stock_id', 'time_id'])[['wap']].agg([np.mean, np.std, np.min, np.max]).reset_index()\n    wap_df.columns=['stock_id', 'time_id', 'wap_mean', 'wap_std', 'wap_min', 'wap_max']\n    wap_df['wap_ratio']=wap_df['wap_max']\/wap_df['wap_min']\n    return wap_df\n\ndef get_bucket_vol_stat(df):\n    vol_df=df.groupby(['stock_id', 'time_id'])[['bid_size1', 'ask_size1', 'vol_ratio']].mean().reset_index()\n    vol_df.columns=['stock_id', 'time_id', 'mean_bid_size1', 'mean_ask_size1', 'mean_vol_ratio']\n    return vol_df\n\ndef get_bucket_price_stat(df):\n    price_df=df.groupby(['stock_id', 'time_id'])[['bid_price1', 'ask_price1', 'price_ratio']].mean().reset_index()\n    price_df.columns=['stock_id', 'time_id', 'mean_bid_price1', 'mean_ask_price1', 'mean_price_ratio']\n    return price_df\n\ndef get_order_updates(df):\n    update_df=df.groupby(['stock_id', 'time_id'])[['seconds_in_bucket']].count().reset_index().rename(columns={\n        'seconds_in_bucket': 'num_updates'\n    })\n    update_df['num_updates']\/=600\n    return update_df\n\ndef get_relative_volatility(s):\n    s=np.log(s)\n    s=np.diff(s)\n    s=(s**2).sum()\n    s=np.sqrt(s)\n    return s\n\ndef get_bucket_volatility(df):\n    vol_df=df.groupby(['stock_id', 'time_id'])[['wap']].agg(list).reset_index()\n    vol_df['wap']=vol_df.wap.apply(get_relative_volatility)\n    vol_df.rename(columns={'wap': 'realized_volatility'}, inplace=True)\n    return vol_df\n    \ndef get_bucket_stat():\n    all_stat_df=pd.DataFrame()\n    for filepath in os.listdir(book_train_path):\n        path=os.path.join(book_train_path, filepath)\n        stock_id=int(filepath.split('=')[-1])\n        \n        df=pd.read_parquet(path)\n        df['stock_id']=stock_id\n        df['vol_ratio']=df['ask_size1']\/df['bid_size1']\n        df['price_ratio']=df['ask_price1']\/df['bid_price1']\n        \n        df['wap'] = (df['bid_price1'] * df['ask_size1'] + df['ask_price1'] * df['bid_size1'])\n        df['wap'] \/= (df['ask_size1']+df['bid_size1'])\n        \n        wap_df=get_bucket_wap_stat(df)\n        vol_df=get_bucket_vol_stat(df)\n        price_df=get_bucket_price_stat(df)\n        update_df=get_order_updates(df)\n        volatility_df=get_bucket_volatility(df)\n        \n        stat_df=vol_df.merge(wap_df)\n        stat_df=stat_df.merge(price_df)\n        stat_df=stat_df.merge(update_df)\n        stat_df=stat_df.merge(volatility_df)\n        \n        all_stat_df=pd.concat([all_stat_df, stat_df])\n    return all_stat_df","ba12808b":"%%time\nbook_stat=get_bucket_stat()\nbook_stat.head()","97fa4d01":"book_stat=book_stat.merge(train)","1f206df3":"book_stat.sort_values('realized_volatility', ascending=False).head(3)","7f5f81ed":"visualize_sample(30, 30128)\nvisualize_sample(30, 3138)\nvisualize_sample(42, 30128)","45845cb4":"book_stat.sort_values('realized_volatility').head(3)","0392ffc3":"visualize_sample(31, 28959)\nvisualize_sample(31, 16733)\nvisualize_sample(31, 18495)","c0ce91f8":"book_stat.head()","2079d232":"book_stat.num_updates.describe()","fdd6e779":"px.histogram(book_stat, x='num_updates', title=\"% Distribution of number of Updates\")\n","93387a6f":"bucket_vol=[50,70, 90, 100, 120, 130, 140,  150, 160, 170, 180, 200, \n            220, 240, 260, 280, 300, 330, 360, 390,\n            410, 440, 470, 500, 550, 650, 750, 850, \n            1000, 1200, 1400, 1600, 2000, 2200, 2400, 2600, 2800,\n            3000, 3500, 4000, 4500, 5000]\n\ndef get_volume_buckets(x):\n    for i, v in enumerate(bucket_vol):\n        if x<=v:\n            return i\n        \n        if x>v and x>bucket_vol[-1]:\n            return i+1","0a28ddee":"book_stat['bid_vol_bucket1']=book_stat['mean_bid_size1'].apply(get_volume_buckets)\nbook_stat['ask_vol_bucket1']=book_stat['mean_ask_size1'].apply(get_volume_buckets)\n\nbook_stat.head()","16914186":"px.density_heatmap(book_stat,\n                   x='bid_vol_bucket1',\n                   y='ask_vol_bucket1', \n                   z='realized_volatility',\n                   histfunc='avg',\n                   marginal_x='histogram',\n                   marginal_y='histogram',\n                   title=\"Densitly Plots between volumes & Relative Volatilities\"\n                  )","23c5a857":"px.density_heatmap(book_stat,\n                   x='bid_vol_bucket1',\n                   y='ask_vol_bucket1', \n                   z='mean_price_ratio',\n                   histfunc='avg',\n                   marginal_x='histogram',\n                   marginal_y='histogram',\n                   title=\"Densitly Plots between volumes & Relative Volatilities\")","1ecbc0cf":"book_stat[['realized_volatility', 'target']].corr()","a076d28a":"rv_diff=book_stat['target'] - book_stat['realized_volatility']\nrv_diff.describe()","86460e22":"px.box(y=rv_diff)","035d9287":"px.histogram(rv_diff)","81e78c96":"# Bucket Stats","01e65487":"# Bottom-3 volatitlies","1d32b7ad":"1. Diagonal and near diagonal has minimal volatilties\n2. As the differnece between the buckets increases volatitlty also getting increased in most cases.\n3. in the Upper-left Block --> Bid-Sizes < Ask-Sizes --> More Demand than Supply.\n4. Lower-Right Block --> Ask-Sizes < Bid-Sizes --> More Supply than demand\n5. High Volumnes in both Bid & Ask-Sizes --> lower volatilities.\n6. Lower-Right Block has high volatitlies registered than Upper-Left Block.","28264462":"Lets see about the number of updates in 10-min","5273661e":"# Top-3 Realized Volatitlity","17327f7d":"1. Mean Price Ratio -> Avg(ask_price\/bid_price) of bucket \n2. Mean Price ratio is less when Supply(Ask size) is more than Demand(Bid Size) in most cases --> upper-left block\n3. Price Ratios are near 1 around the Diagonal Block","34ef1be8":"1. Price may move up\/down with small changes.\n2. May shoot high suddenly depending on high volumne of bids.\n3. Drops low if ask volumes are more.\n4. May Drop again after the supply meets demand.\n5. can remain almost constant if supply doesn't change much with demand.\n\n\nBased on the movement of the prices , will have different curves.","fce21106":"# Bucket Bid & Ask volumes & Impacts","e7bfca8a":"# Random Sample Visualization","09443a1d":"1. there is a high correlation between the 1st 10-min volatility and for the next 10-min interval\n2. Statistically More than 50% of the samples have the reduced volatility in the next 20-min.\n3. Increase or decrease in the volatitlity depends on the trends and cycles of volumes in the current 10-min window","380ebc46":"Volume of the Bid\/Offers are having impact on the price movements.\n\n**Stock_id:0, Time_id:5**\n\n**Price Movment plots in stock_id:0, time_id:5, we can observe that**\n\n1. WAP will be closer to the ask_price curve if, there is more supply in the market than demand and viceversa.\n2. WAP Movements is closer to ask_price curve and bid price changing with time, and can be interpreted as the market is trying to catch-up the supply and demand.\n3. Around second-400 difference of the bid-price and the offer-price is less, which could represent market-stability at that point.\n4. The Price Movment starts-off from low-high and gradually getting reduced ==> favouring for the more bid sizes at the end of the bucket period.\n\n**Volume Movement- stock_id: 0, time_id:5**\n1. Bid & Ask Volume fluctuations are more in the initial stage of the market, which effects the wap to favour demand or supply curves.\n2. for second-130 there is a peak in the bid_size, leading to the wap towards demand curve.\n3. Volumes of both bid and ask-sizes are reduced as the time increases, resulting in the reduction of the wap at the end of bucket.\n\n\n**Volume had effect on the prices and viceversa as lowering prices from the high-prices will lead to more bid-size**\n\n**Stock_id=0, time_id:5 had the kind of triangular curve**\n\n\n\n\n**Stock_id:111, Time_id:15765**\n\n1. WAP continously decreases from the begining and  ask-sizes are increasing, indicating the fall of the market for this stock in the bucket.\n2. For most of the time in between there is no most price movement in the market and the volumes are much higher.\n3. if we look into the time_id: 15770 of the same stock, both the demand and supply seems to be in relatvely same at the begining, resulting in the less difference between the bid_price and ask_price, but since for some-time before there is more supply than demand the effetive prices got reduced.\n4. As the deamnd gradually meets the supply and then tends to increase, the price movements startup increasing, to much higher values than before.\n\n\n","793bbeb7":"Lets check the price & volume graphs for the top-3 and bottom-3 realized volatitlies","54c75aea":"# Lets us check the relation between the target and Relative Volatility","cd39a14a":"1. Both the Bid & Ask Volumes of the low volatile Buckets are high compared to the high volatile buckets.\n2. And Bid & Ask Prices difference is also high in low-volatile bucket compared to high-volatile bucket.\n3. There is trend in the low-volatile bucket at the end for the Ask-sizes to reach for the bid-Sizes(Figure-3) and Bid-sizes to reach for the Ask-sizes(Figure-1 &2)\n","2c0521c3":"# Visualize a single bucket info"}}