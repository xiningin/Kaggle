{"cell_type":{"c6125ce5":"code","b0b63ae9":"code","05875a0e":"code","67e6eb58":"code","31dec3f6":"markdown"},"source":{"c6125ce5":"import os\nimport numpy\nimport pandas\nimport wgs_ecef","b0b63ae9":"def blend(folder_to_weight):\n    \"\"\" Return a weighted mean of folders' submissions. \n    \n        Assumes equal ordering to submission files' rows.\n    \"\"\"\n    norm = sum(folder_to_weight.values())\n\n    def submissions():\n        for folder, weight in folder_to_weight.items():\n            frame = pandas.read_csv(\n                os.path.join(\"..\/input\/\", folder, \"submission.csv\"),\n                dtype={\n                    \"phone\": str,\n                    \"millisSinceGpsEpoch\": numpy.uint64,\n                    \"latDeg\": numpy.float64,\n                    \"lngDeg\": numpy.float64,\n                })\n            yield frame, weight \/ norm\n\n    subs = submissions()\n\n    # add in ECEF coordinates at 0 altitude\n    example, weight = next(subs)\n    xyz = get_ecef(example) * weight\n\n    for frame, weight in subs:\n        xyz += get_ecef(frame) * weight\n\n    # convert back to WSG, update example in place\n    example.latDeg, example.lngDeg, _ = wgs_ecef.ecef_to_wgs(*xyz)\n\n    return example\n\n\ndef get_ecef(frame):\n    \"\"\" Return ECEF positions from frame WGS at sea level. \"\"\"\n    lat = frame.latDeg\n    lng = frame.lngDeg\n    alt = numpy.zeros_like(frame.latDeg)\n    return numpy.stack(wgs_ecef.wgs_to_ecef(lat, lng, alt))","05875a0e":"submission = blend({\n    \"gsdc-phones-mean-prediction\": 5,\n    \"device-eda-interpolate-by-removing-device-en-ja\": 1,\n    \"gsdc-position-shift\": 1,\n})\n\nsubmission.head()","67e6eb58":"submission.to_csv(\"submission.csv\", index=False)","31dec3f6":"# Average top public notebooks\n\nWeighted mean in cartesian coordinates at equal altitude.\n\n**All credit to the authors of those notebooks; please look at their work:**\n* [GSDC phones mean prediction](https:\/\/www.kaggle.com\/t88take\/gsdc-phones-mean-prediction)\n* [device EDA & Interpolate by removing device[en,ja]](https:\/\/www.kaggle.com\/columbia2131\/device-eda-interpolate-by-removing-device-en-ja)\n* [GSDC: Position shift](https:\/\/www.kaggle.com\/wrrosa\/gsdc-position-shift)"}}