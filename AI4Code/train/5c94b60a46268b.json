{"cell_type":{"e7a1ef8a":"code","d386e0e6":"code","b343406b":"code","395d6e01":"code","eb81b1ee":"code","261b3349":"code","6280de5a":"code","6ea1936d":"code","cea1d627":"code","8b6ae953":"code","33c174ac":"code","2dc31cc2":"code","d2bb2fd3":"code","04a02031":"code","6e470de6":"code","de33e52f":"code","7c77010b":"code","1a131d1a":"code","6216ca9b":"code","980d596e":"code","5afd9e1a":"code","9afce364":"code","75bc1d2b":"code","835b50d4":"code","ae46675f":"code","1fceb251":"code","1c55200c":"code","774648ec":"code","77c39a75":"code","e422e795":"code","503ef578":"code","f6dd7422":"code","4777b83e":"code","1499f6f6":"code","58802c37":"code","25a957ad":"code","533e0bf8":"code","99c4aff1":"code","aa06d460":"code","d7148d21":"code","6ecf4cff":"markdown","6aa6d972":"markdown","6f967b90":"markdown","10e119e0":"markdown","dc6dcf71":"markdown","15b24643":"markdown","1f0ae5cf":"markdown","697f5a78":"markdown","d183f598":"markdown","94a76a89":"markdown","2cfd4806":"markdown","d6a5f507":"markdown","b5eb62cd":"markdown","ff7210e8":"markdown","3d9f98fa":"markdown","19eaedfc":"markdown","212bd463":"markdown","95433cb1":"markdown","11bea0df":"markdown","00845bb9":"markdown","e4497e19":"markdown","9016f5f5":"markdown","8c5413b3":"markdown","8dc86375":"markdown","b9a94e8a":"markdown","c01282ab":"markdown","9589b33d":"markdown"},"source":{"e7a1ef8a":"import numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\nimport math\n\nimport lightgbm as lgb\nfrom sklearn.metrics import mean_squared_error\nfrom sklearn.model_selection import KFold\n\nimport matplotlib.pyplot as plt\nimport seaborn as sns\n\nfrom pydicom import dcmread\nimport cv2\n\npath = \"\/kaggle\/input\/osic-pulmonary-fibrosis-progression\/\"","d386e0e6":"ls \/kaggle\/input\/osic-pulmonary-fibrosis-progression\/","b343406b":"ls \/kaggle\/input\/osic-pulmonary-fibrosis-progression\/train\/ID00007637202177411956430","395d6e01":"train_df  = pd.read_csv(path + \"train.csv\")\ntest_df = pd.read_csv(path + \"test.csv\")\nsubm = pd.read_csv(path + \"sample_submission.csv\")","eb81b1ee":"train_df","261b3349":"train_df.Patient.nunique()","6280de5a":"train_df.Weeks.max()","6ea1936d":"train_df.Weeks.min()","cea1d627":"fig, ax = plt.subplots(1,1)\n\nsns.distplot(train_df[train_df[\"Weeks\"].notna()][\"Weeks\"], ax=ax, color=\"#2222EE\")\nax.set_title(\"distribution of weeks in train\");","8b6ae953":"fig, ax = plt.subplots(1,1)\n\nsns.distplot(train_df[train_df[\"FVC\"].notna()][\"FVC\"], ax=ax, color=\"#22EE22\")\nax.set_title(\"distribution of FVC in train\");","33c174ac":"fig, ax = plt.subplots(1,1)\n\nsns.distplot(train_df[train_df[\"Percent\"].notna()][\"Percent\"], ax=ax, color=\"#EE2222\")\nax.set_title(\"distribution of Percent in train\");","2dc31cc2":"fig, ax = plt.subplots(1,1)\n\nsns.distplot(train_df[train_df[\"Age\"].notna()][\"Age\"], ax=ax, color=\"#992299\")\nax.set_title(\"distribution of Age in train\");","d2bb2fd3":"train_df.Sex.value_counts()","04a02031":"train_df.Sex.value_counts(normalize=True)","6e470de6":"train_df.groupby(\"Patient\")[\"Sex\"].first().value_counts(normalize=True)","de33e52f":"train_df[\"SmokingStatus\"].value_counts()","7c77010b":"train_df[\"SmokingStatus\"].value_counts(normalize=True)","1a131d1a":"test_df","6216ca9b":"def merge_subm_test(subm,test_df):\n    \n    a = subm['Patient_Week'].str.split(\"_\", expand=True)\n    a.columns=[\"Patient\",\"Week\"]\n        \n    test_df = test_df.merge(a, on=\"Patient\")\n\n    return test_df\n\ntest_df = merge_subm_test(subm,test_df)","980d596e":"test_df","5afd9e1a":"test_df.groupby([\"Patient\"])[\"Weeks\"].count()","9afce364":"test_df.groupby([\"Patient\"])[\"Week\"].first()","75bc1d2b":"test_df.groupby([\"Patient\"])[\"Week\"].last()","835b50d4":"ls \/kaggle\/input\/osic-pulmonary-fibrosis-progression\/train\/ID00007637202177411956430\/","ae46675f":"fig, axs = plt.subplots(5, 6,figsize=(20,20))\nfor n in range(0,30):\n    #print(int(n\/6),np.mod(n,6))\n    image = dcmread(\"\/kaggle\/input\/osic-pulmonary-fibrosis-progression\/train\/ID00007637202177411956430\/\" + str(n+1) + \".dcm\")\n    axs[int(n\/6),np.mod(n,6)].imshow(image.pixel_array);","1fceb251":"ls \/kaggle\/input\/osic-pulmonary-fibrosis-progression\/test\/ID00419637202311204720264\/","1c55200c":"fig, axs = plt.subplots(5, 6,figsize=(20,20))\nfor n in range(0,28):\n    #print(int(n\/6),np.mod(n,6))\n    image = dcmread(\"\/kaggle\/input\/osic-pulmonary-fibrosis-progression\/test\/ID00419637202311204720264\/\" + str(n+1) + \".dcm\")\n    axs[int(n\/6),np.mod(n,6)].imshow(image.pixel_array);","774648ec":"train_df  = pd.read_csv(path + \"train.csv\")\ntest_df = pd.read_csv(path + \"test.csv\")\nsubm = pd.read_csv(path + \"sample_submission.csv\")","77c39a75":"def proc_df(df):\n    \n    df = pd.concat([df, pd.get_dummies(df[\"SmokingStatus\"], dtype=int)], axis=1)\n    df.drop([\"SmokingStatus\"],axis=1,inplace=True)\n\n    df['Sex'] = df['Sex'].map({'Female': 0, 'Male': 1})\n\n    return df\n\ntrain_df = proc_df(train_df)","e422e795":"def proc_train(df):\n\n    df_final = pd.DataFrame()\n\n    for patient, df2 in df.groupby('Patient'):\n        \n        df11 = df2[[\"Patient\",\"Weeks\",\"FVC\"]]\n\n\n        df2 = df2.rename(columns={\n            \"FVC\": \"base_FVC\", \n            \"Percent\": \"base_Percent\", \n            \"Weeks\": \"base_Week\"\n        }, errors=\"raise\")\n        \n        df3 = pd.merge(df11, df2, how='outer', on='Patient')\n        df3 = df3.query('Weeks!=base_Week')\n        df3['week_diff'] = df3['base_Week'] - df3['Weeks']\n\n        df_final = pd.concat([df_final, df3])\n        \n    return df_final.reset_index(drop=True)","503ef578":"train_df = proc_train(train_df)","f6dd7422":"a = subm['Patient_Week'].str.split(\"_\", expand=True)\na.columns=[\"Patient\",\"Weeks\"]\na[\"Weeks\"] = a[\"Weeks\"].astype(\"int\")\n    \ntest_df.rename(\n    columns={\n        'Weeks': 'base_Week',\n        'FVC': 'base_FVC',\n        'Percent': 'base_Percent',\n        'Age': 'Age'\n    },\n    inplace=True\n)\n\ntest_df = proc_df(test_df)\n\ntest_df = pd.merge(a, test_df, how='left', on=['Patient'])\ntest_df['week_diff'] = test_df['base_Week'] - test_df['Weeks']\n\ntest_df","4777b83e":"train_df = train_df.drop(set(train_df.columns)-set(test_df.columns)-{'FVC', 'Percent'}, axis=1)\ntest_df = test_df.drop(set(test_df.columns)-set(train_df.columns), axis=1)\n\nX = train_df.drop([\"Patient\",\"FVC\"], axis=1)\ny = train_df[\"FVC\"]\ntest = test_df.drop([\"Patient\"], axis=1)","1499f6f6":"X","58802c37":"test","25a957ad":"num_fold = 5\n\ndef get_lgbm_model(X_train, y_train, X_val, y_val, fold, param_choice, columns):\n    \n    train_data = lgb.Dataset(X_train, label=y_train)\n    val_data = lgb.Dataset(X_val, label=y_val)\n\n    if param_choice == \"normal\":\n        params = {\n            \"metric\":\"rmse\"\n        }\n    elif param_choice == \"quantile1\":\n        params = {\n            \"objective\":\"quantile\",\n            \"alpha\":0.2,\n            \"metric\":\"quantile\"\n        }    \n    elif param_choice == \"quantile2\":\n        params = {\n            \"objective\":\"quantile\",\n            \"alpha\":0.8,\n            \"metric\":\"quantile\"\n        }    \n    \n    model = lgb.LGBMRegressor(**params, n_estimators = 20000, nthread = 4, n_jobs = -1)\n    model.fit(\n        X_train, \n        y_train, \n        eval_set=[(X_train, y_train), (X_val, y_val)], \n        verbose=1000, \n        early_stopping_rounds=100\n    )\n\n    fold_importance = pd.DataFrame()\n    print(columns)\n    print(model.feature_importances_)\n    fold_importance[\"feature\"] = columns\n    fold_importance[\"importance\"] = model.feature_importances_\n    #plot_save_feat_imp(fold_importance, fold)    \n    fold_importance = fold_importance.sort_values(by=['importance'])\n    fold_importance.to_csv('feature_importances_'+ y_train.name + \"_\" + param_choice + str(fold) + '.csv')\n    \n    return model\n\ndef get_lgbm_pred(X, y, test, param_choice):\n    print(\"get_lgbm_pred \", param_choice)\n\n    pred = []\n    pred_val = np.zeros((len(X)))\n            \n    #X_train, X_val, y_train, y_val = train_test_split(X_scaled, y.fillna(0).values, test_size=0.2, shuffle=True, random_state=42)\n    kf = KFold(n_splits=num_fold, random_state=None, shuffle=False)\n    fold = 0\n    score = 0\n    for train_index, test_index in kf.split(X, y):\n        fold += 1\n        print(\"fold \", fold)\n    \n        X_train = X.iloc[train_index, :]\n        X_val = X.iloc[test_index, :]\n        y_train = y[train_index]\n        y_val = y[test_index]\n        \n        model = get_lgbm_model(X_train, y_train, X_val, y_val, fold, param_choice, X_train.columns)\n\n\n        if fold ==1:\n            pred.append(model.predict(test))\n        else:\n            pred += model.predict(test)\n\n        \n        pred_val[test_index] = model.predict(X_val)            \n        score = score + np.sqrt(mean_squared_error(y_val, pred_val[test_index]))\n        print(\"score \", str(score\/fold))\n            \n                    \n    print(\"\\n\\n\\n\")\n\n    f = open(\"score\",\"a+\")\n    f.write(str(score\/num_fold)+\", \")\n    f.close()\n    \n    return pred[0]\/num_fold, pred_val","533e0bf8":"pred_FVC_te, pred_FVC_tr = get_lgbm_pred(X, y, test, \"normal\")\n\npred_FVC_te_q1, pred_FVC_tr_q1 = get_lgbm_pred(X, y, test, \"quantile1\")\npred_FVC_te_q2, pred_FVC_tr_q2 = get_lgbm_pred(X, y, test, \"quantile2\")\n\npred_conf_tr = pred_FVC_tr_q2 - pred_FVC_tr_q1\npred_conf_te = pred_FVC_te_q2 - pred_FVC_te_q1","99c4aff1":"def metric(confidence, fvc, pred_fvc):\n\n    confidence = max(confidence, 70)\n    delta = min(abs(fvc-pred_fvc), 1000)\n    score = -(math.sqrt(2)*(delta\/confidence)) - np.log(math.sqrt(2)*confidence)\n        \n    return score\n\ndef calc_score(confidence, fvc, pred_fvc):\n    \n    score = 0\n    for n in range(len(confidence)):\n        score += (metric(confidence[n], fvc[n], pred_fvc[n]))\n        \n    return score\/len(train_df)\n\nscore = calc_score(pred_conf_tr, train_df.FVC.values, pred_FVC_tr)\nprint(score)","aa06d460":"subm[\"FVC\"] = pred_FVC_te\nsubm[\"Confidence\"] = pred_conf_te\nsubm.to_csv(\"submission.csv\", index=False)","d7148d21":"subm","6ecf4cff":"*change in version 6: change in proc_df*","6aa6d972":"Let's take \"Confidence\" as the difference between 0.1 and 0.9 quantiles:","6f967b90":"First, let's import the necessary modules.","10e119e0":"The Age value distribution:","dc6dcf71":"Let's define the column data types:","15b24643":"Let's arrange dataframes for LightGBM:","1f0ae5cf":"we have 176 patients in train","697f5a78":"<a id=\"section-one\"><\/a>\n# DataFrames","d183f598":"Now, lets have a look at the test dataset:","94a76a89":"<a id=\"section-three\"><\/a>\n# LightGBM","2cfd4806":"Only 21% of the train images are Female.","d6a5f507":"The FVC value distribution:","b5eb62cd":"We have been asked for the estimations of 146 weeks for each patient, starting with -12 and ending with 133.","ff7210e8":"We have csv files for train, test datasets, and their image files. Let's get the train.csv, test.csv, and sample_submission.csv:","3d9f98fa":"We have only five patients, all male, not any \"currently smokes\", all at age 68 and older. Let's merge submission and test files:","19eaedfc":"Calculate the score:","212bd463":"Let's have a look at a patient's CT scan at the base week (train dataset):","95433cb1":"Sex distribution:","11bea0df":"Now, let's have a look at the files:","00845bb9":"Now, et's have a look at a patient's CT scan at the base week, in the test dataset:","e4497e19":"<a id=\"section-two\"><\/a>\n# CT Images","9016f5f5":"<a id=\"section-four\"><\/a>\n# Submission","8c5413b3":"And finally the submission file:","8dc86375":"* [DataFrames](#section-one)\n* [CT Images](#section-two)\n* [LightGBM](#section-three)\n* [Submission](#section-four)","b9a94e8a":"\"Weeks\" are between -5 and 133, and ths distribution of weeks is as in the above graph.","c01282ab":"We have 1549 images in the train dataset.","9589b33d":"The Percent value distribution:"}}