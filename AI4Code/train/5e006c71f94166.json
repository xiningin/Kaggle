{"cell_type":{"fa5ad793":"code","8ca84215":"code","8f86bd42":"code","a4f5aa51":"code","18675c4d":"code","b8ee4e43":"code","628d86c3":"code","52f21ed5":"code","eaa60d3f":"code","3abc3ea7":"code","4a0cd12a":"code","a2e444dc":"code","38155665":"code","2c3b1619":"markdown","05df3469":"markdown","254a030d":"markdown","00c1cc76":"markdown","5198f9f8":"markdown"},"source":{"fa5ad793":"import optuna\nimport janestreet\nimport numpy as np\nimport pandas as pd\nimport lightgbm as lgb\nimport matplotlib.pyplot as plt\nfrom sklearn.model_selection import train_test_split\nfrom sklearn.metrics import roc_auc_score","8ca84215":"%%time\n\ntrain  = pd.read_csv('\/kaggle\/input\/jane-street-market-prediction\/train.csv')\n\nprint(train.shape)\ntrain.head()","8f86bd42":"train = train[train['weight'] != 0]\n\n# train['action'] = ((train['weight'].values * train['resp'].values) > 0).astype('int')\ntrain['action'] = (train['resp'] > 0) * 1","a4f5aa51":"features = train.columns[train.columns.str.contains('feature')]\ntarget = 'action'\n\nprint(len(features))\nprint(features[:2], '...', features[128:])","18675c4d":"train = train.fillna(0.5)\n\nprint(train.isnull().sum().sum())","b8ee4e43":"X_train, X_test, y_train, y_test = train_test_split(train[features], train[target], random_state=666, test_size=0.2)\n\nprint(X_train.shape)\nprint(y_train.shape)\nprint(X_test.shape)\nprint(y_test.shape)","628d86c3":"'''\ndef create_model(trial):\n    num_leaves = trial.suggest_int(\"num_leaves\", 2, 31)\n    n_estimators = trial.suggest_int(\"n_estimators\", 50, 300)\n    max_depth = trial.suggest_int('max_depth', 3, 8)\n    min_child_samples = trial.suggest_int('min_child_samples', 100, 1200)\n    learning_rate = trial.suggest_uniform('learning_rate', 0.0001, 0.99)\n    min_data_in_leaf = trial.suggest_int('min_data_in_leaf', 5, 90)\n    bagging_fraction = trial.suggest_uniform('bagging_fraction', 0.0001, 1.0)\n    feature_fraction = trial.suggest_uniform('feature_fraction', 0.0001, 1.0)\n    subsample = trial.suggest_uniform('subsample', 0.1, 1.0)\n    colsample_bytree = trial.suggest_uniform('colsample_bytree', 0.1, 1.0)\n    tree_method = 'gpu_hist'\n    random_state = 666\n    \n    model = lgb.LGBMClassifier(\n        num_leaves = num_leaves,\n        n_estimators = n_estimators, \n        max_depth = max_depth, \n        min_child_samples = min_child_samples, \n        min_data_in_leaf = min_data_in_leaf,\n        learning_rate = learning_rate,\n        bagging_fraction = bagging_fraction,\n        feature_fraction = feature_fraction,\n        subsample = subsample,\n        colsample_bytree = colsample_bytree,\n        tree_method ='gpu_hist',\n        random_state = 666)\n    \n    return model\n\ndef objective(trial):\n    model = create_model(trial)\n    model.fit(X_train, y_train)\n    score = roc_auc_score(y_test.values, model.predict_proba(X_test)[:,1])\n    return score\n\nstudy = optuna.create_study(direction=\"maximize\")\nstudy.optimize(objective, n_trials=40)\nparams = study.best_params\n\nprint(params)\n\n'''","52f21ed5":"params = {'num_leaves': 30,\n          'n_estimators': 275,\n          'max_depth': 8,\n          'min_child_samples': 171,\n          'learning_rate': 0.5500902321095997,\n          'min_data_in_leaf': 37,\n          'bagging_fraction': 0.7341205951502766,\n          'feature_fraction': 0.983688510908062,\n          'subsample': 0.5509996432272407,\n          'colsample_bytree': 0.11579699523545023,\n          'tree_method': 'gpu_hist',\n          'random_state': 666}","eaa60d3f":"%%time\n\ncls = lgb.LGBMClassifier(**params)\ncls.fit(train[features], train[target])\n\ny_proba = cls.predict_proba(X_test)[:,1]\n\nprint('Score: ', roc_auc_score(y_test, y_proba))","3abc3ea7":"fig,ax = plt.subplots(figsize=(30,30))\nlgb.plot_importance(cls, ax=ax,importance_type='gain',max_num_features=130)\nplt.show()","4a0cd12a":"env = janestreet.make_env()\niter_test = env.iter_test()","a2e444dc":"'''\n%%time\n\nfor (test, sample_prediction) in iter_test:\n    test = test.fillna(0.5)\n    sample_prediction['action'] = cls.predict(test[features])\n    env.predict(sample_prediction)\n    \n'''","38155665":"%%time\n\nfor (test, sample_prediction) in iter_test:\n    test = test.fillna(0.5)\n    \n    if test['weight'].item() > 0:\n        sample_prediction['action'] = cls.predict(test[features])\n    else:\n        sample_prediction['action'] = 0\n    \n    env.predict(sample_prediction)","2c3b1619":"# Submit","05df3469":"# Module","254a030d":"# Preprocess","00c1cc76":"# Dataset","5198f9f8":"# Modeling"}}