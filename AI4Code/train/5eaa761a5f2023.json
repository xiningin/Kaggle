{"cell_type":{"e404cdb2":"code","b0064c0b":"code","fb3b6f05":"code","96e55889":"code","25f0bf2e":"code","78f79642":"code","09c5893f":"code","e66e968e":"code","6c39eda3":"code","8656dd27":"code","dae2a4ac":"code","783d187f":"code","e0b08de3":"code","002ef32a":"code","7ad2206b":"markdown"},"source":{"e404cdb2":"# Imports\n\nimport numpy as np\nimport pandas as pd\nimport tensorflow as tf\nfrom glob import glob # finds all the pathnames matching a specified pattern according to the rules used by the Unix shell\nimport cv2 # computer vision library for reading images\nfrom IPython.display import Image\nimport os, warnings\nimport matplotlib.pyplot as plt\nfrom matplotlib import gridspec\n\n# Tensorflow\nfrom tensorflow import keras\nfrom tensorflow.keras import layers\nfrom tensorflow.keras.layers.experimental import preprocessing\n\n#Keras\nfrom keras import applications\nfrom keras.callbacks import ModelCheckpoint, EarlyStopping, ReduceLROnPlateau\nfrom keras.applications import InceptionResNetV2\nfrom tensorflow.keras.applications.inception_resnet_v2 import preprocess_input\nfrom tensorflow.keras.preprocessing import image\n\nfrom sklearn.model_selection import train_test_split\n\n# Reproducability\ndef set_seed(seed=31415):\n    np.random.seed(seed)\n    tf.random.set_seed(seed)\n    os.environ['PYTHONHASHSEED'] = str(seed)\n    os.environ['TF_DETERMINISTIC_OPS'] = '1'\nset_seed()\n\n# Set Matplotlib defaults\nplt.rc('figure', autolayout=True)\nplt.rc('axes', labelweight='bold', labelsize='large',\n       titleweight='bold', titlesize=18, titlepad=10)\nplt.rc('image', cmap='magma')\nwarnings.filterwarnings(\"ignore\") # to clean up output cells","b0064c0b":"# Path to the data\nPATH = \"..\/input\/dog-breed-identification\"\nTRAIN_PATH = os.path.join(PATH, 'train\/*')\nTEST_PATH = os.path.join(PATH, 'test\/*')\nLABELS_PATH = os.path.join(PATH, 'labels.csv')\nDOG_IMAGES_PATH = os.path.join('..\/input\/dog-images\/*')\n\n# Set the parameters for the Keras model\nSIZE = 299\nNUM_CLASSES = 120\nBATCH_SIZE = 128\nEPOCHS = 50","fb3b6f05":"def build_model():\n    '''\n    Builds a pretrained model on the imagenet dataset\n    Model InceptionRestNetV2 with freezed weights\n    Sets the input shape to (SIZE, SIZE, 3)\n    Sets the output shape to 120 classes\n    '''\n    base_model = InceptionResNetV2(\n    include_top=False,\n    weights=\"imagenet\",\n    input_tensor=None,\n    input_shape=(SIZE, SIZE, 3),\n    pooling=None)\n    base_model.trainable = False\n\n    model = keras.models.Sequential([\n        base_model,\n        keras.layers.GlobalAveragePooling2D(),\n        keras.layers.Dropout(0.2),\n        keras.layers.Dense(120, activation='softmax')\n    ])\n    return model","96e55889":"def read_image(path):\n    '''\n    Read the image.\n    Resize the image.\n    Transform the image in an array.\n    Preprocessing\n    '''\n    img = image.load_img(path, target_size=(SIZE, SIZE))\n    img = image.img_to_array(img)\n    img = preprocess_input(img)\n    # Return 3D image array\n    return img\n\n\ndef parse_data(x, y):\n    x = x.decode()\n    num_class = NUM_CLASSES\n    image = read_image(x)\n    label = [0] * num_class\n    label[y] = 1\n    label = np.array(label)\n    label = label.astype(np.int32)\n    return image, label\n\ndef tf_parse(x, y):\n    x, y = tf.numpy_function(parse_data, [x, y], [tf.float32, tf.int32])\n    x.set_shape((SIZE, SIZE, 3))\n    y.set_shape((NUM_CLASSES))\n    return x, y\n\ndef tf_dataset(x, y):\n    dataset = tf.data.Dataset.from_tensor_slices((x, y))\n    dataset = dataset.map(tf_parse)\n    dataset = dataset.batch(BATCH_SIZE)\n    dataset = dataset.repeat()\n    return dataset","25f0bf2e":"# Get the number of breeds\nlabels_df = pd.read_csv(LABELS_PATH)\nbreed = labels_df['breed'].unique()\nprint('Number of breeds: ', len(breed))","78f79642":"# Set a unique id for each breed\nbreed_to_id = {name: i for i, name in enumerate(breed)}\nid_to_breed = {i: name for i, name in enumerate(breed)}","09c5893f":"# Create a list of labels ids from each image\nids = glob(TRAIN_PATH)\nlabels = []\n\nfor image_id in ids:\n    image_id = image_id.split('\/')[-1].split('.')[0]\n    breed_name = list(labels_df[labels_df.id == image_id]['breed'])[0]\n    breed_idx = breed_to_id[breed_name]\n    labels.append(breed_idx)","e66e968e":"# Split the dataset\nx_train, x_valid, y_train, y_valid = train_test_split(ids, labels, test_size=0.2, random_state=42)","6c39eda3":"# Create the datasets\ntrain_dataset = tf_dataset(x_train, y_train)\nvalid_dataset = tf_dataset(x_valid, y_valid)","8656dd27":"# Instanciate the model\nmodel = build_model()\nmodel.compile(loss='categorical_crossentropy', optimizer='Adam', metrics=['acc'])\nmodel.summary()","dae2a4ac":"# Set callbacks\ncallbacks = [\n    EarlyStopping(\n    patience=5,\n    min_delta=0.001,\n    restore_best_weights=True,\n    ),\n    ModelCheckpoint('model.h5', verbose=1, save_best_only=True),\n    ReduceLROnPlateau(factor=0.1, patience=5, min_lr=1e-6)\n]\ntrain_steps = (len(x_train)\/\/BATCH_SIZE) + 1\nvalid_steps = (len(x_valid)\/\/BATCH_SIZE) + 1\n\n# Training\nhistory = model.fit(train_dataset,\n          steps_per_epoch=train_steps,\n          validation_steps=valid_steps,\n          validation_data=(valid_dataset),\n          epochs=EPOCHS,\n          callbacks=callbacks\n         )","783d187f":"history_frame = pd.DataFrame(history.history)\nhistory_frame.loc[:, ['loss', 'val_loss']].plot()\nhistory_frame.loc[:, ['acc', 'val_acc']].plot();","e0b08de3":"def decode_predictions(preds, top=5, class_list_path=None):\n    results = []\n    top_indices = (-preds).argsort()[0]\n    for i in range(top):\n        breed = id_to_breed.get(top_indices[i])\n        prob = preds[0][top_indices[i]]\n        results.append((breed, prob))\n    return results","002ef32a":"images = glob(DOG_IMAGES_PATH)\n\nfor i in range(len(images)):\n    img_path = images[i]\n    display(Image(filename=img_path, width=SIZE, height=SIZE))\n    x = read_image(img_path)\n    x = np.expand_dims(x, axis=0)\n\n    preds = model.predict(x)\n    print('Predicted:', decode_predictions(preds, top=3))","7ad2206b":"## Testing with friends and family dogs"}}