{"cell_type":{"3e0c6c81":"code","3eefaa4f":"code","d9ef44a7":"code","b22eb7d5":"code","88cafd64":"code","c5847edf":"code","242cc52a":"code","eda87334":"code","5448fe2d":"code","2b4780f4":"code","04eb3133":"code","8b4711af":"code","dc910526":"code","5d67fe8f":"code","d781e4d9":"code","438667df":"code","f5d08a66":"code","109e52a0":"code","f5ba7d85":"code","59240ec3":"code","0c1d749b":"code","f4a0f13e":"code","b0a7a042":"code","647ec204":"code","5c224f97":"code","b3c6aeb7":"code","7246f839":"code","343f8980":"code","f6409160":"code","dd4d634e":"code","84cb0614":"code","5480bc13":"code","985054e6":"code","b51d45d8":"code","d6fd941b":"code","42f4ccf2":"code","27538103":"code","e5a1be57":"code","6690f604":"code","42b7f6c0":"code","be36508a":"code","d8889eac":"code","52e1b09c":"code","061c3db3":"code","4e19826e":"code","744c6856":"code","cc8cc0d6":"code","3bc4078b":"code","910731c1":"code","78571428":"markdown","da8fdcef":"markdown","8875a90c":"markdown","6a3a2c2f":"markdown","6c618d55":"markdown","c9f7d403":"markdown","936ea893":"markdown","ca0ccbc0":"markdown","6e7e38fe":"markdown","bc80be8c":"markdown","228a3c23":"markdown","8420238a":"markdown","d8551214":"markdown","e3dfb66a":"markdown","1766adaf":"markdown","6d5a13fa":"markdown","ea27780b":"markdown","aa93a9ec":"markdown"},"source":{"3e0c6c81":"# \u95ed\u773c\uff0c\u590d\u5236\uff0c\u7c98\u8d34\uff0c\u5c31\u597d\n%reload_ext autoreload\n%autoreload 2\n%matplotlib inline","3eefaa4f":"from fastai.vision import * # \u52a0\u8f7d\u6240\u9700\u7684\u51e0\u4e4e\u6240\u6709\u5de5\u5177\nfrom fastai.metrics import error_rate # \u8865\u5145\u5de5\u5177","d9ef44a7":"# bs = 64 # \u4e00\u6b21\u5904\u740664\u5f20\u56fe\u7247\uff0c\u4f46\u5982\u679c\u5185\u5b58\u4e0d\u591f\uff08bus error)\uff0c\u5219\u9700\u8981\u91cd\u542fkernel, \u5c0664\u7f29\u5c0f\u4e3a16\uff0c\u964d\u4f4e\u5185\u5b58\u9700\u6c42\n# bs = 16 # `0` + `0` = \u91cd\u542fkernel\nbs = 8","b22eb7d5":"# \u4e0b\u8f7d\u89e3\u538b\u6570\u636e\u5305\uff0c\u5e76\u751f\u6210\u6570\u636e\u6587\u4ef6\u5730\u5740\npath = untar_data(URLs.PETS); path","88cafd64":"path.ls() # \u67e5\u770b\u6570\u636e\u6587\u4ef6\u5185\u5bb9","c5847edf":"path_anno = path\/'annotations'\npath_img = path\/'images' # \u8fdb\u4e00\u6b65\u627e\u5230\u76f4\u63a5\u5b58\u6709\u6570\u636e\u6587\u4ef6\u5939","242cc52a":"fnames = get_image_files(path_img) # \u5c06\u6240\u6709\u6570\u636e\u56fe\u7247\uff0c\u505a\u6210\u5730\u5740Path,\u653e\u5165\u4e00\u4e2alist\u4e2d\nfnames[:5] # \u67e5\u770blist","eda87334":"np.random.seed(2) # \u786e\u4fdd\u6bcf\u6b21\u8bad\u7ec3\u540e\uff0c\u6a21\u578b\u90fd\u88ab\u76f8\u540c\u7684\u9a8c\u8bc1\u6570\u636e\u9a8c\u8bc1\npat = r'\/([^\/]+)_\\d+.jpg$' # \u7528re\u4ece\u6587\u4ef6\u540d\u4e2d\u63d0\u53d6\u56fe\u7247label\u6807\u6ce8","5448fe2d":"# \u751f\u6210\u6570\u636e\u96c6\uff08\u5305\u542b\u8bad\u7ec3\u96c6\u548c\u9a8c\u8bc1\u96c6\uff0c\u6d4b\u8bd5\u96c6\u53ef\u9009\uff09\ndata = ImageDataBunch.from_name_re(path_img, # \u56fe\u7247\u6570\u636e\u6587\u4ef6\u5939path\n                                   fnames, # \u56fe\u7247path\u7684list\n                                   pat, # regexpr \n                                   ds_tfms=get_transforms(), # \u56fe\u7247\u6240\u9700\u7684\u5904\u7406\n                                   size=224, # \u56fe\u7247\u88c1\u526a\u5927\u5c0f, but having bus error,\n#                                    size=56, # \u7f29\u5c0f\u56fe\u7247\n                                   bs=bs # \u4e00\u6b21\u5904\u7406\u56fe\u7247\u6570\u91cf\n                                  ).normalize(imagenet_stats) # \u56fe\u7247\u5904\u7406\u7684\u5747\u503c\u4e0e\u65b9\u5dee","2b4780f4":"data.show_batch(rows=3, figsize=(7,6)) # \u5c55\u793a\u6570\u636e","04eb3133":"print(data.classes) # \u6253\u5370\u7c7b\u522b\u540d\u79f0\nlen(data.classes),data.c # \u7c7b\u522b\u603b\u6570","8b4711af":"# \u521b\u5efa\u4e00\u4e2aCNN\u6a21\u578b\uff0c\u4f7f\u7528data\u4f5c\u4e3a\u6570\u636e\uff0c\u4e0b\u8f7d\u548c\u8c03\u7528resnet34\u4f5c\u4e3a\u6a21\u578b\u6846\u67b6\u548c\u53c2\u6570\uff0c\u540c\u65f6\u6253\u5370\u9519\u8bef\u7387\nlearn = create_cnn(data, models.resnet34, metrics=error_rate) ","dc910526":"learn.model # \u67e5\u770b\u6a21\u578b\u5185\u5728\u7ed3\u6784","5d67fe8f":"learn.fit_one_cycle(1) # \u8bad\u7ec3\u6a21\u578b\uff0c\u5b8c\u6574\u8bad\u7ec3\u6570\u636e\u96c6\u4e00\u904d","d781e4d9":"learn.save('\/kaggle\/working\/stage-1') # \u5c06\u6a21\u578b\u4fdd\u5b58\u5728\u5de5\u4f5c\u76ee\u5f55\u4e0b\uff0ccommit\u540e\u53ef\u4e0b\u8f7d","438667df":"interp = ClassificationInterpretation.from_learner(learn)\n\nlosses,idxs = interp.top_losses()\n\nlen(data.valid_ds)==len(losses)==len(idxs)","f5d08a66":"interp.plot_top_losses(9, figsize=(15,11))","109e52a0":"doc(interp.plot_top_losses)","f5ba7d85":"interp.plot_confusion_matrix(figsize=(12,12), dpi=60)","59240ec3":"interp.most_confused(min_val=2)","0c1d749b":"learn.unfreeze()","f4a0f13e":"learn.fit_one_cycle(1)","b0a7a042":"learn.load('\/kaggle\/working\/stage-1');","647ec204":"learn.lr_find()","5c224f97":"learn.recorder.plot()","b3c6aeb7":"learn.unfreeze()\nlearn.fit_one_cycle(1, max_lr=slice(1e-6,1e-4))","7246f839":"learn.save('\/kaggle\/working\/stage-2')","343f8980":"data = ImageDataBunch.from_name_re(path_img, fnames, pat, ds_tfms=get_transforms(),\n                                   size=299, bs=bs\/\/2).normalize(imagenet_stats)","f6409160":"learn = create_cnn(data, models.resnet50, metrics=error_rate)","dd4d634e":"learn.lr_find()\nlearn.recorder.plot()","84cb0614":"learn.fit_one_cycle(1) # 4 \u6b21\u662f\u6b63\u5e38\u6570\u91cf","5480bc13":"learn.save('\/kaggle\/working\/stage-1-50')","985054e6":"learn.unfreeze()\nlearn.fit_one_cycle(1, max_lr=slice(1e-6,1e-4))","b51d45d8":"learn.load('\/kaggle\/working\/stage-2-50');","d6fd941b":"interp = ClassificationInterpretation.from_learner(learn)","42f4ccf2":"interp.most_confused(min_val=2)","27538103":"path = untar_data(URLs.MNIST_SAMPLE); path","e5a1be57":"tfms = get_transforms(do_flip=False)\ndata = ImageDataBunch.from_folder(path, ds_tfms=tfms, size=26)","6690f604":"data.show_batch(rows=3, figsize=(5,5))","42b7f6c0":"learn = create_cnn(data, models.resnet18, metrics=accuracy)\nlearn.fit(1)","be36508a":"df = pd.read_csv(path\/'labels.csv')\ndf.head()","d8889eac":"data = ImageDataBunch.from_csv(path, ds_tfms=tfms, size=28)","52e1b09c":"data.show_batch(rows=3, figsize=(5,5))\ndata.classes","061c3db3":"data = ImageDataBunch.from_df(path, df, ds_tfms=tfms, size=24)\ndata.classes","4e19826e":"fn_paths = [path\/name for name in df['name']]; fn_paths[:2]","744c6856":"pat = r\"\/(\\d)\/\\d+\\.png$\"\ndata = ImageDataBunch.from_name_re(path, fn_paths, pat=pat, ds_tfms=tfms, size=24)\ndata.classes","cc8cc0d6":"data = ImageDataBunch.from_name_func(path, fn_paths, ds_tfms=tfms, size=24,\n        label_func = lambda x: '3' if '\/3\/' in str(x) else '7')\ndata.classes","3bc4078b":"labels = [('3' if '\/3\/' in str(x) else '7') for x in fn_paths]\nlabels[:5]","910731c1":"data = ImageDataBunch.from_lists(path, fn_paths, labels=labels, ds_tfms=tfms, size=24)\ndata.classes","78571428":"<h1>Table of Contents<span class=\"tocSkip\"><\/span><\/h1>\n<div class=\"toc\"><ul class=\"toc-item\"><li><span><a href=\"#\u8bc6\u522b\u4f60\u7684\u5ba0\u7269\uff1a37\u79cd\u732b\u72d7\" data-toc-modified-id=\"\u8bc6\u522b\u4f60\u7684\u5ba0\u7269\uff1a37\u79cd\u732b\u72d7-1\"><span class=\"toc-item-num\">1&nbsp;&nbsp;<\/span><strong>\u8bc6\u522b\u4f60\u7684\u5ba0\u7269\uff1a37\u79cd\u732b\u72d7<\/strong><\/a><\/span><ul class=\"toc-item\"><li><span><a href=\"#\u719f\u6089\u4f60\u7684\u6570\u636e\" data-toc-modified-id=\"\u719f\u6089\u4f60\u7684\u6570\u636e-1.1\"><span class=\"toc-item-num\">1.1&nbsp;&nbsp;<\/span>\u719f\u6089\u4f60\u7684\u6570\u636e<\/a><\/span><\/li><li><span><a href=\"#\u8bad\u7ec3\u6a21\u578bresnet34\" data-toc-modified-id=\"\u8bad\u7ec3\u6a21\u578bresnet34-1.2\"><span class=\"toc-item-num\">1.2&nbsp;&nbsp;<\/span>\u8bad\u7ec3\u6a21\u578bresnet34<\/a><\/span><\/li><li><span><a href=\"#\u8bad\u7ec3\u6210\u679c\" data-toc-modified-id=\"\u8bad\u7ec3\u6210\u679c-1.3\"><span class=\"toc-item-num\">1.3&nbsp;&nbsp;<\/span>\u8bad\u7ec3\u6210\u679c<\/a><\/span><\/li><li><span><a href=\"#\u89e3\u51bb\uff0c\u5fae\u8c03\uff0c\u5b66\u4e60\u7387\" data-toc-modified-id=\"\u89e3\u51bb\uff0c\u5fae\u8c03\uff0c\u5b66\u4e60\u7387-1.4\"><span class=\"toc-item-num\">1.4&nbsp;&nbsp;<\/span>\u89e3\u51bb\uff0c\u5fae\u8c03\uff0c\u5b66\u4e60\u7387<\/a><\/span><\/li><li><span><a href=\"#\u8bad\u7ec3\u6a21\u578b-resnet50\" data-toc-modified-id=\"\u8bad\u7ec3\u6a21\u578b-resnet50-1.5\"><span class=\"toc-item-num\">1.5&nbsp;&nbsp;<\/span>\u8bad\u7ec3\u6a21\u578b resnet50<\/a><\/span><\/li><li><span><a href=\"#\u5176\u4ed6\u5236\u4f5cDataBunch\u7684\u65b9\u6cd5\" data-toc-modified-id=\"\u5176\u4ed6\u5236\u4f5cDataBunch\u7684\u65b9\u6cd5-1.6\"><span class=\"toc-item-num\">1.6&nbsp;&nbsp;<\/span>\u5176\u4ed6\u5236\u4f5c<code>DataBunch<\/code>\u7684\u65b9\u6cd5<\/a><\/span><\/li><\/ul><\/li><\/ul><\/div>","da8fdcef":"## \u719f\u6089\u4f60\u7684\u6570\u636e","8875a90c":"\u6570\u636e\u5b98\u7f51 [Oxford-IIIT Pet Dataset](http:\/\/www.robots.ox.ac.uk\/~vgg\/data\/pets\/)      \n\u6570\u636e\u8bba\u6587 [O. M. Parkhi et al., 2012](http:\/\/www.robots.ox.ac.uk\/~vgg\/publications\/2012\/parkhi12a\/parkhi12a.pdf) \n37\u79cd\u732b\u72d7 = 12 cat breeds + 25 dogs breeds    \n\u6211\u4eec\u6a21\u578b\u7684\u76ee\u6807\u662f\u533a\u5206\u8fd937\u79cd\u4e0d\u540c\u7c7b\u522b\u7684\u732b\u72d7    \n\n---\n\n**\u96be\u5ea6\u8ba4\u77e5**    \n\u968f\u673a\u731c\u7684\u80dc\u7387$1\/37$\uff0c\u8fdc\u4f4e\u4e8e50%\uff1b       \n2012\u5e74\u7684\u5b66\u672f\u9876\u7ea7\u6c34\u5e73\u662f80%\u5de6\u53f3\u7684\u51c6\u786e\u7387\uff1b       \n\u8dd1\u5b8c\u8fd9\u4e2aNotebook\uff0c\u4f60\u4f1a\u60ca\u8bb6\u81ea\u5df1\u4e0e\u9876\u7ea7\u6df1\u5ea6\u5b66\u4e60\u6a21\u578b\u6c34\u51c6\u7684\u8ddd\u79bb\uff0c\u53ea\u6709\u4e00\u4e2afast.ai       \n\n---","6a3a2c2f":"\u73b0\u5728\u6211\u4eec\u6765\u8bad\u7ec3\u66f4\u5927\u7684\u6a21\u578bresnet50(50\u5c42\u800c\u975e34\u5c42\uff09\u66f4\u591a\u7ec6\u8282\u4f1a\u5728\u540e\u7eed\u8bfe\u7a0b\u548c\u8fd9\u7bc7\u8bba\u6587\u4e2d\u4e86\u89e3 [resnet paper](https:\/\/arxiv.org\/pdf\/1512.03385.pdf)).\n\n\u57fa\u672c\u4e0a\uff0cresnet50\u4f1a\u8868\u73b0\u66f4\u597d\uff0c\u56e0\u4e3a\u5b83\u66f4\u6df1\u53c2\u6570\u66f4\u591a\u3002\u91c7\u7528\u66f4\u5927\u7684\u56fe\u7247\u8bad\u7ec3\uff0c\u6a21\u578b\u53ef\u4ee5\u770b\u5230\u66f4\u591a\u7279\u5f81\uff0c\u6709\u5229\u4e8e\u6a21\u578b\u5b66\u4e60\u3002\u540c\u65f6\uff0c\u6211\u4eec\u51cf\u5c11\u4e00\u6b21\u201c\u5582\u7ed9\u201d\u6a21\u578b\u7684\u56fe\u7247\u6570\u91cf\uff0c\u907f\u514dGPU\u5185\u5b58\u67af\u7aed\u3002\n","6c618d55":"\u65e2\u7136\u6a21\u578b\u5de5\u4f5c\u6b63\u5e38\uff0c\u6211\u4eec\u53ef\u4ee5\u5f00\u59cb\u89e3\u51bb\u6a21\u578b\uff0c\u505a\u66f4\u591a\u5c42\u7684\u8bad\u7ec3","c9f7d403":"## \u8bad\u7ec3\u6a21\u578bresnet34","936ea893":"\u5982\u679c\u6548\u679c\u4e0d\u597d\uff0c\u53ef\u4ee5\u8c03\u56de\u4e4b\u524d\u7684\u6a21\u578b\uff0c\u7ee7\u7eed\u8bad\u7ec3","ca0ccbc0":"## \u8bad\u7ec3\u6210\u679c","6e7e38fe":"\u73b0\u5728\u6211\u4eec\u5f00\u59cb\u8bad\u7ec3\u6a21\u578b\u3002\u6a21\u578b\u4e3b\u5e72\u662fCNN [convolutional neural network](http:\/\/cs231n.github.io\/convolutional-networks\/) \u5916\u52a0\u4e00\u4e2a\u5168\u94fe\u63a5\u542b\u4e00\u4e2a\u9690\u85cf\u5c42\u7684\u5206\u7c7b\u5668\u3002\u4e4b\u540e\u8bfe\u7a0b\u4e2d\u6211\u4eec\u4f1a\u6df1\u5165\u5b66\u4e60CNN\uff0c\u73b0\u5728\u53ea\u9700\u8981\u77e5\u9053\u6211\u4eec\u7684\u6a21\u578b\u53ef\u4ee5\u201c\u5403\u8fdb\u201d\u56fe\u7247\u201c\u5410\u51fa\u201d\u79cd\u7c7b\u8bc6\u522b\uff08\u4ece37\u4e2a\u7c7b\u522b\u4e2d\uff09\u3002","bc80be8c":"## \u89e3\u51bb\uff0c\u5fae\u8c03\uff0c\u5b66\u4e60\u7387","228a3c23":"\u6211\u4eec\u770b\u770b\u8bad\u7ec3\u6210\u679c\n\u9996\u5148\uff0c\u770b\u770b\u6a21\u578b\u6700\u5bb9\u6613\u6df7\u6dc6\u7684\u79cd\u7c7b\u3002\u4e5f\u5c31\u662f\u770b\u770b\u51fa\u9519\u662f\u5426\u5728\u60c5\u7406\u4e4b\u4e2d\u3002\u5982\u679c\u9519\u662f\u72af\u5728\u4e86\u5f88\u96be\u5206\u8fa8\u7684\u5730\u65b9\uff0c\u8fd9\u8bf4\u660e\u6a21\u578b\u8fd8\u4e0d\u9519\u3002\n\u7136\u540e\uff0c\u753b\u51faconfusion matrix\uff0c\u53ef\u4ee5\u770b\u51fa\u5206\u5e03\u662f\u4e0d\u5bf9\u79f0\u7684\uff1b\u5982\u679c\u6a21\u578b\u5728\u76f8\u540c\u7684\u5730\u65b9\u53cd\u590d\u72af\u9519\uff0c\u800c\u5176\u4ed6\u7c7b\u522b\u5219\u6ca1\u95ee\u9898\u3002\u8fd9\u610f\u5473\u7740\u6a21\u578b\u53ea\u662f\u9488\u5bf9\u67d0\u4e9b\u7c7b\u522b\u6613\u51fa\u9519\u3002\u4ee5\u4e0a\u90fd\u662f\u5f88\u6b63\u5e38\u7684\u73b0\u8c61\u3002","8420238a":"## \u5176\u4ed6\u5236\u4f5c`DataBunch`\u7684\u65b9\u6cd5","d8551214":"\u5982\u9700\u5b66\u4e60Jupyter Notebook \u5e94\u7528\u6280\u5de7\uff0c\u53ef\u524d\u5f80[JN\u6280\u5de7\u6c47\u603b](https:\/\/www.kaggle.com\/danielliao\/jupypter-notebook)","e3dfb66a":"`pat`\u662f\u5982\u4f55\u63d0\u53d6\u56fe\u7247\u540d\u79f0\u7684\uff1f\u89c1[\u5de5\u4f5c\u539f\u7406](https:\/\/github.com\/EmbraceLife\/shendusuipian\/issues\/62), [notebook\u5b9e\u9a8c](https:\/\/www.kaggle.com\/danielliao\/regexpr-label)","1766adaf":"\n# **\u8bc6\u522b\u4f60\u7684\u5ba0\u7269\uff1a37\u79cd\u732b\u72d7**\n\n[**\u6e90\u81ea fast.ai v3 2019\u8bfe\u7a0b\u4e2d\u6587\u7b14\u8bb0**](https:\/\/forums.fast.ai\/t\/fast-ai-v3-2019\/39325)    \n\u8fd9\u91cc\u662f\u539fNotebook\u7684\u7b80\u6613\u4e2d\u6587\u7248\uff0c\u76ee\u7684\u662f\u5e2e\u52a9\u5927\u5bb6\u5feb\u901f\u4e0a\u624b\u4e86\u89e3\u7b2c\u4e00\u8bfe\u4ee3\u7801\u77e5\u8bc6\u70b9\n\n\n\n\n","6d5a13fa":"## \u8bad\u7ec3\u6a21\u578b resnet50","ea27780b":"\u6b64\u4e2d\u6587\u7248\u672c\u6e90\u4e8efast.ai v3 2019 \u4e2d\u6587\u7b14\u8bb0\uff0c\u5b66\u4e60\u501f\u9274\u4e86[@init27\u7684kernel](https:\/\/forums.fast.ai\/t\/platform-kaggle-kernels\/32569)\u5e76\u5c3d\u53ef\u80fd\u4fdd\u6301\u4e0e\u8bfe\u7a0b[github\u7248\u672cNb](https:\/\/github.com\/fastai\/course-v3\/tree\/master\/nbs\/dl1)\u540c\u6b65\u66f4\u65b0\u3002","aa93a9ec":"\u6a21\u578b\u7684\u7cbe\u786e\u5ea6\u5df2\u7ecf\u4e0d\u9519\u4e86\uff0c\u8981\u77e5\u90532012\u5e74\u7684\u9876\u7ea7\u6c34\u5e73\u662f80%\uff0c\u6211\u4eec\u4ec52\u8f6e\u8bad\u7ec3\u5c31\u9ad8\u8fbe91%"}}