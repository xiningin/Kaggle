{"cell_type":{"c37e912f":"code","b9f161e1":"code","a7c87ceb":"code","56552ae8":"code","5b6a88cf":"code","8c96d619":"code","0f77f939":"code","bc29ff2a":"code","f108c0fe":"code","da5279b4":"code","a5aa0969":"code","794e219b":"code","d524ecda":"code","908fa436":"code","6006663f":"code","6d043fd5":"code","e4e01d5a":"code","93602ad1":"code","37c8a323":"code","a6e04c23":"code","aad79948":"code","0954bbc8":"code","cc914fd2":"code","1b7cea5d":"code","8e6349c9":"code","04965c2d":"code","36aac781":"code","28519bcd":"code","d37a8e46":"markdown","a6dc07d6":"markdown","ce65786f":"markdown","b1c29db0":"markdown","7596f58d":"markdown","4948cb9a":"markdown","60e57c49":"markdown","5e5f4fd1":"markdown","4cd2dba9":"markdown","af2db4ef":"markdown","d75cf176":"markdown","4099eda6":"markdown","65001cbd":"markdown","df616c39":"markdown","802117e1":"markdown","b122e1f0":"markdown"},"source":{"c37e912f":"import numpy as np \nimport pandas as pd \nimport matplotlib.pyplot as plt \nimport tensorflow as tf \nimport tensorflow_datasets as tfds\nimport pathlib\nimport os","b9f161e1":"#training_data_path = pathlib.Path(r\"H:\\AI\\DataSets\\275 Bird Species also see 73 Sports Dataset\\birds_rev2\\train\")\n#validatoin_data_path = pathlib.Path(r\"H:\\AI\\DataSets\\275 Bird Species also see 73 Sports Dataset\\birds_rev2\\valid\")\n#testing_data_path = pathlib.Path(r\"H:\\AI\\DataSets\\275 Bird Species also see 73 Sports Dataset\\birds_rev2\\test\")\n\n#batch_size = 64\n#img_height = 224\n#img_width = 224\n\n#train_image_count = len(list(training_data_path.glob(r'*\\\\*.jpg')))\n\n#train_list_ds = tf.data.Dataset.list_files([str(training_data_path\/'*\/*'), \n#                                           str(validatoin_data_path\/'*\/*'),\n#                                           str(testing_data_path\/'*\/*')], shuffle=False)\n#train_list_ds = train_list_ds.shuffle(train_image_count, reshuffle_each_iteration=False)\n#------------------------------------------------------------------------------------------------------\n#val_image_count = len(list(validatoin_data_path.glob(r'*\\\\*.jpg')))\n\n#val_list_ds = tf.data.Dataset.list_files(str(validatoin_data_path\/'*\/*'), shuffle=False)\n#val_list_ds = val_list_ds.shuffle(val_image_count, reshuffle_each_iteration=False)\n#------------------------------------------------------------------------------------------------------\n#test_image_count = len(list(training_data_path.glob(r'*\\\\*.jpg')))\n\n#test_list_ds = tf.data.Dataset.list_files(str(testing_data_path\/'*\/*'), shuffle=False)\n#test_list_ds = test_list_ds.shuffle(test_image_count, reshuffle_each_iteration=False)","a7c87ceb":"training_data_path = pathlib.Path('..\/input\/100-bird-species\/birds_rev2\/train')\nvalidatoin_data_path = pathlib.Path('..\/input\/100-bird-species\/birds_rev2\/valid')\ntesting_data_path = pathlib.Path('..\/input\/100-bird-species\/birds_rev2\/test')\n\nbatch_size = 64\nimg_height = 150\nimg_width = 150\n\n\nimage_count = len(list(training_data_path.glob(r'*\/*.jpg')))\n\nall_list_ds = tf.data.Dataset.list_files([str(training_data_path\/'*\/*'), \n                                          str(validatoin_data_path\/'*\/*'),\n                                          str(testing_data_path\/'*\/*')], shuffle=False)\nall_list_ds = all_list_ds.shuffle(image_count, reshuffle_each_iteration=False)\n\n\nval_size = int(image_count * 0.2)\n#reduce the training set size fue to the small memory allocated for this notebook\nskip_train = int(image_count * 0.6)\ntrain_ds = all_list_ds.skip(skip_train)\nval_ds = all_list_ds.take(val_size)","56552ae8":"class_names = np.array(sorted([item.name for item in training_data_path.glob('*')]))\nnum_classes = len([item for item in training_data_path.glob('*')])\nprint(\"The number of classes is: {}\".format(num_classes))","5b6a88cf":"print(tf.data.experimental.cardinality(train_ds).numpy())\nprint(tf.data.experimental.cardinality(val_ds).numpy())","8c96d619":"def process_path(file_path):\n    \n    parts = tf.strings.split(file_path, os.path.sep)\n    one_hot = parts[-2] == class_names\n    label = tf.argmax(one_hot)\n    \n    img = tf.io.read_file(file_path)\n    img = tf.io.decode_jpeg(img, channels=3)\n    img = tf.image.resize(img, [img_height, img_width])\n\n    return img, label","0f77f939":"train_ds = train_ds.map(process_path, num_parallel_calls=tf.data.AUTOTUNE)\nval_ds = val_ds.map(process_path, num_parallel_calls=tf.data.AUTOTUNE)","bc29ff2a":"#dead code\n\n#train_ds = train_list_ds.map(process_path, num_parallel_calls=tf.data.AUTOTUNE)\n#val_ds = val_list_ds.map(process_path, num_parallel_calls=tf.data.AUTOTUNE)\n#test_ds = test_list_ds.map(process_path, num_parallel_calls=tf.data.AUTOTUNE)","f108c0fe":"def configure_for_performance(ds):\n    ds = ds.cache()\n    ds = ds.shuffle(buffer_size=1024)\n    ds = ds.batch(batch_size)\n    ds = ds.prefetch(buffer_size=tf.data.AUTOTUNE)\n    return ds\n\n#dead code\n#train_ds = configure_for_performance(train_ds)\n#val_ds = configure_for_performance(val_ds)\n#test_ds = configure_for_performance(test_ds)\n\ntrain_ds = configure_for_performance(train_ds)\nval_ds = configure_for_performance(val_ds)","da5279b4":"image_batch, label_batch = next(iter(train_ds))\n\nplt.figure(figsize=(10, 10))\nfor i in range(9):\n    ax = plt.subplot(3, 3, i + 1)\n    plt.imshow(image_batch[i].numpy().astype(\"uint8\"))\n    label = label_batch[i]\n    plt.title(class_names[label])\n    plt.axis(\"off\")","a5aa0969":"data_augmentation = tf.keras.Sequential([\n    tf.keras.layers.experimental.preprocessing.RandomFlip(\"horizontal_and_vertical\", seed=0),\n    tf.keras.layers.experimental.preprocessing.RandomRotation(0.2, seed=0),\n    tf.keras.layers.experimental.preprocessing.RandomCrop(height=150, width=150, seed=0),\n    tf.keras.layers.experimental.preprocessing.RandomZoom(height_factor=0.3, width_factor=0.3, seed=0)])","794e219b":"#train_ds = train_ds.map(lambda x, y: (data_augmentation(x, training=True), y), \n#                        num_parallel_calls=tf.data.AUTOTUNE)","d524ecda":"baseline_model = tf.keras.models.Sequential()\n\nbaseline_model.add(tf.keras.layers.Conv2D(filters=32, kernel_size=(5, 5), activation='relu', input_shape=(150, 150, 3) ))\nbaseline_model.add(tf.keras.layers.MaxPool2D(pool_size=(2, 2)))\n\nbaseline_model.add(tf.keras.layers.Conv2D(filters=64, kernel_size=(3, 3), activation='relu'))\nbaseline_model.add(tf.keras.layers.MaxPool2D(pool_size=(2, 2)))\n\nbaseline_model.add(tf.keras.layers.Conv2D(filters=128, kernel_size=(3, 3), activation='relu'))\nbaseline_model.add(tf.keras.layers.MaxPool2D(pool_size=(2, 2)))\n\nbaseline_model.add(tf.keras.layers.Conv2D(filters=256, kernel_size=(3, 3), activation='relu'))\nbaseline_model.add(tf.keras.layers.Conv2D(128, (1, 1), padding='same', activation='relu'))\nbaseline_model.add(tf.keras.layers.MaxPool2D(pool_size=(3, 3)))","908fa436":"baseline_model.summary()","6006663f":"baseline_model.add(tf.keras.layers.Flatten())\n\n#dead code\n#baseline_model.add(tf.keras.layers.Dense(1024, activation='relu',\n#                                        kernel_initializer='he_normal'))\n#baseline_model.add(tf.keras.layers.BatchNormalization())\n#baseline_model.add(tf.keras.layers.Dropout(0.4))\n\nbaseline_model.add(tf.keras.layers.Dense(512, activation='relu',\n                                        kernel_initializer='he_normal'))\nbaseline_model.add(tf.keras.layers.BatchNormalization())\nbaseline_model.add(tf.keras.layers.Dropout(0.4))\n\nbaseline_model.add(tf.keras.layers.Dense(275, activation='softmax'))","6d043fd5":"baseline_model.summary()","e4e01d5a":"baseline_model.compile(optimizer='adam',\n                       loss=tf.keras.losses.SparseCategoricalCrossentropy(),\n                       metrics=['accuracy'])\n\nhistory = baseline_model.fit(train_ds, epochs=15, \n                             validation_data=val_ds)","93602ad1":"train_loss = history.history['loss']\nval_loss = history.history['val_loss']\n\n\nplt.plot(history.epoch, train_loss, label='Training Loss')\nplt.plot(history.epoch, val_loss, label='Validation Loss')\nplt.grid(True)\nplt.legend()","37c8a323":"train_acc = history.history['accuracy']\nval_acc = history.history['val_accuracy']\n\nplt.plot(history.epoch, train_acc, label='Training Accuracy')\nplt.plot(history.epoch, val_acc, label='Validation Accuracy')\nplt.grid(True)\nplt.legend()","a6e04c23":"# dead code\n\n#testset_loss, testest_acc = baseline_model.evaluate(test_ds)\n#print(\"The test set loss: {}, Test set Accuracy: {}\".format(testset_loss, testest_acc))","aad79948":"def InceptionBlock(previous_output):\n    \n    kernel_init = tf.keras.initializers.glorot_uniform()\n    \n    conv_1x1_1 = tf.keras.layers.Conv2D(32, (1, 1), padding='same', activation='relu',\n                                        kernel_initializer=kernel_init)(previous_output)\n    \n    conv_3x3 = tf.keras.layers.Conv2D(64, (3, 3), padding='same', activation='relu',\n                                      kernel_initializer=kernel_init)(previous_output)\n    conv_1x1_2 = tf.keras.layers.Conv2D(48, (1, 1), padding='same', activation='relu',\n                                        kernel_initializer=kernel_init)(conv_3x3)\n    \n    conv_5x5 = tf.keras.layers.Conv2D(32, (5, 5), padding='same', activation='relu',\n                                      kernel_initializer=kernel_init)(previous_output)\n    conv_1x1_3 = tf.keras.layers.Conv2D(16, (1, 1), padding='same', activation='relu',\n                                        kernel_initializer=kernel_init)(conv_5x5)\n    \n    conv_1x1_4 = tf.keras.layers.Conv2D(32, (1, 1), padding='same', activation='relu',\n                                        kernel_initializer=kernel_init)(previous_output)\n    maxpool = tf.keras.layers.MaxPool2D((3, 3), strides=(1, 1), padding='same')(conv_1x1_4)\n    \n    concat = tf.keras.layers.concatenate([conv_1x1_1, conv_1x1_2, conv_1x1_3, maxpool], axis=-1)\n    \n    return concat","0954bbc8":"def aux_output(previous_output):\n    \n    \n    conv1 = tf.keras.layers.Conv2D(128, kernel_size=(1, 1), padding='same',\n                                     activation='relu')(previous_output)\n    \n    avg_pooling = tf.keras.layers.AveragePooling2D(5, strides=3)(conv1)\n    \n    x = tf.keras.layers.Flatten()(avg_pooling)\n        \n    x = tf.keras.layers.Dense(512, activation='relu',\n                              kernel_initializer='he_normal')(x)\n    \n    x = tf.keras.layers.BatchNormalization()(x)\n    x = tf.keras.layers.Dropout(0.5)(x)\n\n    aux_out = tf.keras.layers.Dense(275, activation='softmax', name='auxiliary_output')(x)\n    \n    return aux_out","cc914fd2":"model_input = tf.keras.Input(shape=(150, 150, 3))\n\nx = tf.keras.layers.Conv2D(64, (7, 7), strides=(2, 2), activation='relu')(model_input)\nx = tf.keras.layers.MaxPool2D(pool_size=(2, 2), strides=(2, 2))(x)\n\nx = tf.keras.layers.Conv2D(128, (3, 3), strides=(1, 1), activation='relu')(x)\nx = tf.keras.layers.MaxPool2D(pool_size=(2, 2), strides=(1, 1))(x)\n\nx = InceptionBlock(x)\nx = InceptionBlock(x)\naux_out_1 = aux_output(x)\nx = tf.keras.layers.MaxPool2D((3, 3), padding='same', strides=(2, 2))(x)\n\nx = InceptionBlock(x)\nx = InceptionBlock(x)\n\nx = tf.keras.layers.Conv2D(128, (3, 3), activation='relu')(x)\nx = tf.keras.layers.MaxPool2D(pool_size=5)(x)\n\nx = tf.keras.layers.Flatten()(x)\nx = tf.keras.layers.Dense(512, activation='relu',\n                                        kernel_initializer='he_normal')(x)\nx = tf.keras.layers.BatchNormalization()(x)\nx = tf.keras.layers.Dropout(0.5)(x)\nmodel_output = tf.keras.layers.Dense(275, activation='softmax', name='main_output')(x)\n\ninc_model = tf.keras.models.Model(inputs=model_input, outputs=[model_output, aux_out_1])\n","1b7cea5d":"tf.keras.utils.plot_model(inc_model,\n                          show_shapes=True,\n                          show_dtype=True,\n                          show_layer_names=True)","8e6349c9":"inc_model.summary()","04965c2d":"inc_model.compile(optimizer='adam',\n                  loss=[tf.keras.losses.SparseCategoricalCrossentropy(),\n                       tf.keras.losses.SparseCategoricalCrossentropy()],\n                  metrics=['accuracy'])\n\n\n\nhistory = inc_model.fit(train_ds, epochs=25, \n                        validation_data=val_ds)","36aac781":"train_loss = history.history['main_output_loss']\nval_loss = history.history['val_main_output_loss']\n\n\nplt.plot(history.epoch, train_loss, label='Training Loss')\nplt.plot(history.epoch, val_loss, label='Validation Loss')\nplt.grid(True)\nplt.legend()","28519bcd":"train_acc = history.history['main_output_accuracy']\nval_acc = history.history['val_main_output_accuracy']\n\nplt.plot(history.epoch, train_acc, label='Training Accuracy')\nplt.plot(history.epoch, val_acc, label='Validation Accuracy')\nplt.grid(True)\nplt.legend()","d37a8e46":"The output of every Conv2D and MaxPooling2D layer is a 3D tensor of shape (height, width, channels). as we can see\nthe height and the width shrink as we go depper in the network, we can control the number of output channels \nby for each Conv2D by the first argument (e.g., filters=32)\n\nsource: https:\/\/www.tensorflow.org\/tutorials\/images\/cnn","a6dc07d6":"**define the convolutional base using a common pattern: a stack of `Conv2D` and `MaxPooling2D` layers.**\n\nThe CNN takes a tensor of shape (height, width, channels) 3D tensor (R, G, B) without givving it the batch size.\nW will give the input shape to your first layer (180, 180, 3) by passing the argument `input_shape`.\n\nsource: https:\/\/www.tensorflow.org\/tutorials\/images\/cnn","ce65786f":"**Add Dense layers on top**\n\nFinally we will feed the last output tensor from the the convolutional base (of shape (20, 20, 64)) into Dense layers\nthat will perform the classification. First we need to Flatten the 3D tensor to 1D a `Flatten` layer, then we will add \none or more dense layers on top of the flatten layer, we have 275 classes so the final dense layer \nwill have 275 units.\n\n\nsource: https:\/\/www.tensorflow.org\/tutorials\/images\/cnn\n\n\nThe final layer I will use the softmax activations that used for multicalss classification, \nfor the  layer that preceding the final layer I will use 512 units to avoid information bottleneck.\n\n\nAfter the first two layers I will add `BatchNormalization` layer to reduce the danger of **Vanishing\/Exploding Gradient** \nproblems ","b1c29db0":"**Configure dataset for performance** <br>\n\nTo train a model with this dataset you will want the data:<br>\n\n- To be well shuffled.<br>\n- To be batched.<br>\n- Batches to be available as soon as possible.<br>\n\nThese features can be added using the tf.data API. For more details:\n\nhttps:\/\/www.tensorflow.org\/tutorials\/load_data\/images#using_tfdata_for_finer_control\n\n\n`.cache()` keeps the images in memory after they're loaded off disk during the first epoch.\nThis will ensure the dataset does not become a bottleneck while training your model.\nIf your dataset is too large to fit into memory, you can also use this method to create a performant on-disk cache.\n\n`.prefetch()` overlaps data preprocessing and model execution while training.\n\nsource: https:\/\/www.tensorflow.org\/tutorials\/load_data\/images#configure_the_dataset_for_perfor","7596f58d":"# 1- input pipeline using tf.data","4948cb9a":"Set `num_parallel_calls` so multiple images are loaded\/processed in parallel.","60e57c49":"A technique to increase the diversity of your training set by applying random (but realistic) transformations such as image rotation\n\nThere are a variety of preprocessing layers you can use for data augmentation including RandomContrast, RandomCrop, RandomZoom, RandomFlip, RandomRotation and others.\n\nTere are two ways to implement data augmentation usin tensorflow. the first approch is Make the preprocessing layers part of the model, here When you export your model using model.save, the preprocessing layers will be saved along with the rest of your model. this will help us when we deploy the model it will automatically standardize images.The second approch is Apply the preprocessing layers to your dataset\n\nsource: https:\/\/www.tensorflow.org\/tutorials\/images\/data_augmentation\n\nI will use the second option in this notebook.","5e5f4fd1":"**Adding an Auxiliary output for fitting gradient vanishing and for regularization**","4cd2dba9":"**Compile and train the model**","af2db4ef":"**Write a short function that converts a file path to an (img, label) pair:**\n\nFor more details:\n\nhttps:\/\/www.tensorflow.org\/tutorials\/load_data\/images#using_tfdata_for_finer_control","d75cf176":"**Plotting the training and the validation losses and accuracies as a function of the number of iterations**","4099eda6":"# 4- Simple Inception Network","65001cbd":"**Visualize the data**\n\nFor more details:\n\nhttps:\/\/www.tensorflow.org\/tutorials\/load_data\/images#using_tfdata_for_finer_control","df616c39":"# 3- creating a simple model as a baseline","802117e1":"# 2- Data augmentation Using tf.image","b122e1f0":"**Use `Dataset.map` to create a dataset of image, label pairs.**\n\nFor more details:\n\nhttps:\/\/www.tensorflow.org\/tutorials\/load_data\/images#using_tfdata_for_finer_control"}}