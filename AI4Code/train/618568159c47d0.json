{"cell_type":{"78656fdf":"code","ac372f75":"code","a5a7d2a5":"code","3ebf3561":"code","d1627d2c":"code","34a3e126":"code","f9509443":"code","0c66c95c":"code","8b0c062b":"code","52d90def":"code","6edfb916":"code","750a0caa":"code","d20a951c":"code","bf6e763b":"code","0fff81b1":"code","267c1bc3":"code","801e7c76":"code","f6247013":"code","78e24458":"code","0249547f":"code","10d78e00":"code","6a8d485d":"code","0c780ccf":"code","10bdf89f":"code","86f04cbe":"code","aafff3c6":"code","dd9ed02a":"code","3a7ef484":"code","261ba721":"code","e61abae5":"code","e1bbb302":"code","f22357ab":"code","a9c5172a":"code","23efc38c":"code","7682a247":"code","a91ae7c1":"code","780a7fb1":"code","c1bec1a0":"code","e6a9d6de":"code","12060218":"code","4689645f":"code","11e88144":"code","8f8133a2":"code","2c4c100c":"code","87ef1316":"code","676483ba":"code","588dc36c":"code","6361fa2f":"code","62cf0dc1":"code","5e1d81a0":"code","f183273d":"code","ff4f31ff":"code","dcf5a546":"code","c49d85f1":"code","6f51bb6a":"code","9d50ec03":"code","fa8063cc":"code","ac97af7b":"code","d80eadef":"code","6570dc55":"code","eb36f515":"code","dc2b0612":"code","17000f50":"code","a3d34109":"code","de07b47d":"code","8704794b":"code","81970f36":"code","c94a09d9":"code","1e87b8e1":"markdown","7dc50c56":"markdown","0fcce3ce":"markdown","2145cbba":"markdown","bd5965f5":"markdown","00ff55c6":"markdown","c2a4f38d":"markdown","d575f1c9":"markdown","7c8f2e13":"markdown","4ee0477b":"markdown","24637d6c":"markdown","8f8c05a1":"markdown","3cfb05a7":"markdown","676369f6":"markdown","dea62da3":"markdown","9aaf4718":"markdown","e00bacd8":"markdown","fd359d78":"markdown","1ea9bb22":"markdown","c883e777":"markdown","073eada2":"markdown","acbecf0b":"markdown","dc159db5":"markdown","45d03627":"markdown","57af92d8":"markdown","e99ebf9d":"markdown","e4de8939":"markdown","cf2723c7":"markdown","212ce6ab":"markdown","9952bbc5":"markdown","bf8a34e0":"markdown","b686ad56":"markdown","98b44ecb":"markdown","e9b73484":"markdown","b402c4cc":"markdown","ab43af6a":"markdown","45dd1326":"markdown","c34a0c5b":"markdown","6512f78c":"markdown","81a46782":"markdown","51199472":"markdown","187cd49d":"markdown","d0a470d4":"markdown","9010b8ee":"markdown","b5bb1b69":"markdown","9c42bc3e":"markdown","e955b3d6":"markdown","21094812":"markdown","01810afb":"markdown","6371bec8":"markdown","5684c9a3":"markdown","409de69e":"markdown","4bb7ee93":"markdown","51ce6cdd":"markdown","1a167f8c":"markdown","845ea1bd":"markdown","0109af91":"markdown","50a95670":"markdown","1fbfcb06":"markdown","88d0b63a":"markdown","58dc3e06":"markdown","121a058f":"markdown","56fbed43":"markdown","a1981a4b":"markdown","142c79f2":"markdown","765a561b":"markdown","48bfd826":"markdown","f846d604":"markdown","5203be4c":"markdown","2e8d048a":"markdown","558d7b16":"markdown","4f83856c":"markdown","6af36d96":"markdown","42a3d0b3":"markdown","cb2bba17":"markdown","c63b8702":"markdown","6ad960a8":"markdown","43712290":"markdown","2f38c203":"markdown","8a2205fe":"markdown","0238b88e":"markdown","979cd3c1":"markdown","aa7114fd":"markdown","db07e614":"markdown","babc518b":"markdown","119be07a":"markdown","fef4ac69":"markdown","50eb7af4":"markdown","6584ee2e":"markdown","08ae614c":"markdown","f51af3b8":"markdown","6941be96":"markdown","eac2128a":"markdown","39039336":"markdown","13aeca16":"markdown","a0bd654f":"markdown","70f9fdeb":"markdown","c954e2ab":"markdown"},"source":{"78656fdf":"# This Python 3 environment comes with many helpful analytics libraries installed\n# It is defined by the kaggle\/python Docker image: https:\/\/github.com\/kaggle\/docker-python\n# For example, here's several helpful packages to load\n\nimport numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\n\n# Input data files are available in the read-only \"..\/input\/\" directory\n# For example, running this (by clicking run or pressing Shift+Enter) will list all files under the input directory\n\nimport os\nfor dirname, _, filenames in os.walk('\/kaggle\/input'):\n    for filename in filenames:\n        print(os.path.join(dirname, filename))\n\n# You can write up to 5GB to the current directory (\/kaggle\/working\/) that gets preserved as output when you create a version using \"Save & Run All\" \n# You can also write temporary files to \/kaggle\/temp\/, but they won't be saved outside of the current session\nfrom math import radians, cos, sin, asin, sqrt\nfrom sklearn.model_selection import train_test_split\nfrom xgboost import XGBRegressor\nfrom sklearn.metrics import mean_absolute_error\nimport matplotlib.pyplot as plt\nimport seaborn as sns\nimport time\nimport geopandas as gpd\nfrom shapely.geometry import Point, Polygon\nfrom sklearn.metrics import mean_squared_error\nfrom sklearn.metrics import mean_absolute_error\nimport math","ac372f75":"train =  pd.read_csv('..\/input\/new-york-city-taxi-fare-prediction\/train.csv', nrows = 3_000_000)\ntest = pd.read_csv('..\/input\/new-york-city-taxi-fare-prediction\/test.csv')\ntrain.head()","a5a7d2a5":"train.describe()","3ebf3561":"def haversine(lon1_array, lat1_array, lon2_array, lat2_array):\n    \n    distances = []\n    \n    for pos in range(len(lon1_array)):\n        lon1, lat1, lon2, lat2 = map(radians, [lon1_array[pos], lat1_array[pos], lon2_array[pos], lat2_array[pos]])\n        dlon = lon2 - lon1 \n        dlat = lat2 - lat1 \n        a = sin(dlat\/2)**2 + cos(lat1) * cos(lat2) * sin(dlon\/2)**2\n        c = 2 * asin(sqrt(a))*6371\n        distances.append(c)\n    return distances\n\ntrain['dist_km'] = haversine(train['pickup_longitude'].to_numpy(),train['pickup_latitude'].to_numpy(),train['dropoff_longitude'].to_numpy(),train['dropoff_latitude'].to_numpy())\ntest['dist_km'] = haversine(test['pickup_longitude'].to_numpy(),test['pickup_latitude'].to_numpy(),test['dropoff_longitude'].to_numpy(),test['dropoff_latitude'].to_numpy())\ntrain.head(5)","d1627d2c":"train['key'] = pd.to_datetime(train['key'], errors='coerce')\ntest['key'] = pd.to_datetime(test['key'], errors='coerce')\ntrain = train.assign(hour = train.key.dt.hour, month = train.key.dt.month, year = train.key.dt.year, weekday = train.key.dt.weekday)\ntest = test.assign(hour = test.key.dt.hour, month = test.key.dt.month, year = test.key.dt.year, weekday = test.key.dt.weekday)\ntrain","34a3e126":"train.drop(columns=['key','pickup_datetime'],axis=1,inplace=True, errors='ignore')\ntest.drop(columns=['key','pickup_datetime'],axis=1,inplace=True, errors='ignore')\ntrain","f9509443":"plt.figure(figsize=(10,5))\nplt.title('Number of Taxi Trips During Normal Working Days')\nsns.set_style(\"white\")\nsns.countplot(x='hour', data=train.loc[(train.weekday >= 0) & (train.weekday <= 4)],palette='rocket')","0c66c95c":"train.loc[(train.weekday >=0) & (train.weekday <=4)].shape","8b0c062b":"plt.figure(figsize=(10,5))\nplt.title('Number of Taxi Trips During Weekends')\nsns.set_style(\"white\")\nsns.countplot(x='hour', data=train.loc[(train.weekday >= 5) & (train.weekday <= 6)],palette='rocket')","52d90def":"train.loc[(train.weekday >= 5) & (train.weekday <= 6)].shape","6edfb916":"weekdays = train.loc[(train.weekday >= 0) & (train.weekday <= 5)]\nweekends =  train.loc[(train.weekday >= 6) & (train.weekday <= 7)]\nweekdays_fare = weekdays.groupby(['hour']).fare_amount.mean().to_frame().reset_index()\nweekends_fare = weekends.groupby(['hour']).fare_amount.mean().to_frame().reset_index()","750a0caa":"np.array(weekdays_fare.hour)\nnp.array(weekends_fare.fare_amount)","d20a951c":"x = np.array(weekdays_fare.hour)\ny = np.array(weekdays_fare.fare_amount)\nz = np.array(weekends_fare.fare_amount)\n\n\nplt.figure(figsize=(16,8))\nplt.title('Mean Fare Amount During the Day - Working Days vs Weekend')\nplt.xlabel('Hours of the day')\nplt.ylabel('Mean Fare Amount')\nax = plt.subplot(111)\nax.bar(x-0.2, y, width=0.2, color='black', align='center',label = 'Week Days')\nax.bar(x, z, width=0.2, color='gray', align='center', label = 'Weekend')\nplt.xticks(range(0,24))\nplt.legend()\nplt.show()","bf6e763b":"plt.figure(figsize=(16,8))\nsns.set_style(\"whitegrid\")\nplt.title('Distance in Km Distribution')\nplt.xlabel('Distance in Km')\nplt.xlim(-10,200)\nplt.xticks(range(0,200,5))\n\nsnsplot = sns.kdeplot(train[train.dist_km <500 ].dist_km, shade=True)","0fff81b1":"plt.figure(figsize=(16,8))\nsns.set_style(\"whitegrid\")\nplt.title('Fare Amount Distribution')\nplt.xlabel('Fare Amount')\nplt.xlim(-10,200)\nplt.xticks(range(0,200,5))\n\nsnsplot = sns.kdeplot(train[train.fare_amount <500 ].fare_amount, shade=True)","267c1bc3":"fig, axs = plt.subplots(1, 2, figsize=(16,6))\nidx = (train.dist_km < 7500) & (train.fare_amount < 600)\naxs[0].scatter(train[idx].dist_km, train[idx].fare_amount, alpha=0.2)\nplt.ylim(0,200)\naxs[0].set_xlabel('distance km')\naxs[0].set_ylabel('fare $USD')\naxs[0].set_title('All data')\n\n\n# zoom in on part of data\nidx = (train.dist_km < 25) & (train.fare_amount < 300)\naxs[1].scatter(train[idx].dist_km, train[idx].fare_amount, alpha=0.2)\naxs[1].set_xlabel('distance km')\naxs[1].set_ylabel('fare $USD')\naxs[1].set_title('Zoom in on distance < 25 km, fare < $100');","801e7c76":"\nJFK={\"min_long\":-73.81,\n    \"min_lat\":40.63,\n    \"max_long\":-73.77,\n    \"max_lat\":40.67}\nLGA = {\n    \"min_long\":-73.89,\n    \"min_lat\":40.76,\n    \"max_long\":-73.85,\n    \"max_lat\":40.79\n}\n\nJFK_loc = train.loc[(train.pickup_longitude >= JFK['min_long']) & (train.pickup_longitude <= JFK['max_long']) & (train.pickup_latitude >= JFK['min_lat']) & (train.pickup_latitude <= JFK['max_lat'])]\nLGA_loc = train.loc[(train.pickup_longitude >= LGA['min_long']) & (train.pickup_longitude <= LGA['max_long']) & (train.pickup_latitude >= LGA['min_lat']) & (train.pickup_latitude <= LGA['max_lat'])]","f6247013":"fig, axs = plt.subplots(1, 2, figsize=(20,10))\nidx = (JFK_loc.dist_km < 60) & (JFK_loc.fare_amount < 80)\nline_1 = 0.6*(np.arange(0,50))\naxs[0].scatter(JFK_loc[idx].dist_km, JFK_loc[idx].fare_amount, alpha=0.2)\naxs[0].set_xlabel('distance km')\naxs[0].set_ylabel('fare $USD')\naxs[0].set_title('JFK - Pickup or Dropoff')\naxs[0].plot(JFK_loc[idx].dist_km, 1.67*JFK_loc[idx].dist_km,':r',label='y = 1.67*x')\naxs[0].legend()\n\n\nidx = (LGA_loc.dist_km < 60) & (LGA_loc.fare_amount < 80) & (LGA_loc.fare_amount >= 0)\naxs[1].scatter(LGA_loc[idx].dist_km, LGA_loc[idx].fare_amount, alpha=0.2)\naxs[1].set_xlabel('distance km')\naxs[1].set_ylabel('fare $USD')\naxs[1].set_title('LGA - Pickup or Dropoff')\naxs[1].plot(LGA_loc[idx].dist_km, 1.625*LGA_loc[idx].dist_km,':r',label='y = 1.625*x')\naxs[1].legend()","78e24458":"del JFK_loc \ndel LGA_loc","0249547f":"# import street map\nstreet_map = gpd.read_file('..\/input\/ny-map\/geo_export_b5f6f452-87a0-46a0-95eb-2b80c4471a56.shp')\n# designate coordinate system\ncrs = {'init':'espc:4326'}\n\nsampled = train.sample(frac=0.008)\n# zip x and y coordinates into single feature\ngeometry = [Point(xy) for xy in zip(sampled['pickup_longitude'], sampled['pickup_latitude'])]\n# create GeoPandas dataframe\ngeo_df = gpd.GeoDataFrame(sampled,\n crs = crs,\n geometry = geometry)","10d78e00":"# create figure and axes, assign to subplot\nfig, ax = plt.subplots(figsize=(15,15))\n# add .shp mapfile to axes\nstreet_map.plot(ax=ax, alpha=0.4,color='grey')\n\ngeo_df.plot(column='fare_amount',ax=ax,alpha=0.5, legend=True,markersize=10)\nplt.title('Pickup Locations and Fare Amount Relationship', fontsize=15,fontweight='bold')\n\nplt.xlim(-74.05,-73.7)\nplt.ylim( 40.55,40.85)\n# show map\nplt.show()","6a8d485d":"geometry = [Point(xy) for xy in zip(sampled['dropoff_longitude'], sampled['dropoff_latitude'])]\n# create GeoPandas dataframe\ngeo_df = gpd.GeoDataFrame(sampled,\n crs = crs,\n geometry = geometry)\n# create figure and axes, assign to subplot\nfig, ax = plt.subplots(figsize=(15,15))\n# add .shp mapfile to axes\nstreet_map.plot(ax=ax, alpha=0.4,color='grey')\n\ngeo_df.plot(column='fare_amount',ax=ax,alpha=0.5, legend=True,markersize=10)\nplt.title('Dropoff Locations and Fare Amount Relationship', fontsize=15,fontweight='bold')\n\nplt.xlim(-74.05,-73.7)\nplt.ylim( 40.55,40.85)\n# show map\nplt.show()","0c780ccf":"passengers = train['passenger_count'].value_counts().to_frame()\ncount = passengers.passenger_count.sum()\npassengers['passenger_count'] = passengers['passenger_count']\/count*100\nindexes = passengers.index\nplt.figure(figsize=(10,5))\nsns.set_style(\"whitegrid\")\nplt.title('Passenger Count Percentage')\nplt.xlabel(\"Passenger Count\",fontsize=14)\nsns.barplot(indexes,passengers['passenger_count'],palette=\"rocket\")\nplt.ylabel(\"Percentile in Dataset\",fontsize=14)\nplt.show()","10bdf89f":"corrmat = train.corr()\ntop_corr_features = corrmat.index[abs(corrmat[\"fare_amount\"])>0.01]\nsns.set_style(\"white\")\nplt.figure(figsize=(8,8))\ng = sns.heatmap(train.corr(),annot=True,cmap=\"RdYlGn\")\nplt.show()","86f04cbe":"train.isnull().sum()","aafff3c6":"train.dropna(how = 'any', axis = 'rows',inplace = True)\ntrain.shape[0]","dd9ed02a":"train = train.loc[(train.fare_amount >= 2.5)|(train.fare_amount <= 300)]\ntrain","3a7ef484":"same_locations = train[(train['pickup_longitude'] == train['dropoff_longitude']) & (train['pickup_latitude'] == train['dropoff_latitude'])].index\nsame_locations\ntrain[(train['pickup_longitude'] == train['dropoff_longitude']) & (train['pickup_latitude'] == train['dropoff_latitude'])]","261ba721":"train.drop(same_locations,inplace = True,errors='ignore')\nprint(\"Remaining dataset rows: \", train.shape[0])","e61abae5":"train.loc[(train.pickup_latitude > 90) | (train.pickup_latitude < -90) | (train.dropoff_latitude > 90) | (train.dropoff_latitude < -90) | \n          (train.pickup_longitude > 180) | (train.pickup_longitude < -180) | (train.dropoff_longitude > 180) | (train.dropoff_longitude < -180)]","e1bbb302":"wrong_coordinates = train.loc[(train.pickup_latitude > 90) | (train.pickup_latitude < -90) | (train.dropoff_latitude > 90) | (train.dropoff_latitude < -90) | \n          (train.pickup_longitude > 180) | (train.pickup_longitude < -180) | (train.dropoff_longitude > 180) | (train.dropoff_longitude < -180)].index\ntrain.drop(wrong_coordinates,inplace = True,errors='ignore')\ntrain.shape","f22357ab":"train.loc[(train.pickup_longitude == 0) | (train.pickup_latitude == 0) | (train.dropoff_longitude == 0) | (train.dropoff_latitude == 0)\n          | (train.pickup_longitude < -74.76) | (train.pickup_longitude > -71.93) |\n            (train.dropoff_longitude < -74.76) | (train.pickup_longitude > -71.93)|\n            (train.pickup_latitude < 40.56) | (train.pickup_latitude > 42.07) |\n            (train.dropoff_latitude < 40.56) | (train.dropoff_latitude > 42.07)].shape","a9c5172a":"outside_boundaries = train.loc[(train.pickup_longitude == 0) | (train.pickup_latitude == 0) | (train.dropoff_longitude == 0) | (train.dropoff_latitude == 0)\n          | (train.pickup_longitude < -74.76) | (train.pickup_longitude > -71.93) |\n            (train.dropoff_longitude < -74.76) | (train.pickup_longitude > -71.93)|\n            (train.pickup_latitude < 40.56) | (train.pickup_latitude > 42.07) |\n            (train.dropoff_latitude < 40.56) | (train.dropoff_latitude > 42.07)].index\ntrain.drop(outside_boundaries, inplace = True, errors='ignore')\n","23efc38c":"train = train.loc[train.dist_km < 130]","7682a247":"Manhattan_south_96th = {\n    'min_lat': 40.768394,\n    'min_long':-73.993352,\n    'max_lat': 40.795642,\n    'max_long': -73.964942\n}\n\nManhattan_south_96th['min_lat']","a91ae7c1":"temp = train.loc[((train.pickup_latitude > Manhattan_south_96th['min_lat']) & (train.pickup_latitude < Manhattan_south_96th['max_lat']) \n         & (train.pickup_longitude > Manhattan_south_96th['min_long']) & (train.pickup_longitude < Manhattan_south_96th['max_long']))\n         | ((train.dropoff_latitude > Manhattan_south_96th['min_lat']) & (train.dropoff_latitude < Manhattan_south_96th['max_lat'])\n         & (train.dropoff_longitude > Manhattan_south_96th['min_long']) & (train.dropoff_longitude < Manhattan_south_96th['max_long']))]\ntemp","780a7fb1":"\n# import street map\nstreet_map = gpd.read_file('..\/input\/ny-map\/geo_export_b5f6f452-87a0-46a0-95eb-2b80c4471a56.shp')\n# designate coordinate system\ncrs = {'init':'espc:4326'}\n\nsampled = temp.sample(frac=0.01)\n# zip x and y coordinates into single feature\ngeometry = [Point(xy) for xy in zip(sampled['pickup_longitude'], sampled['pickup_latitude'])]\n# create GeoPandas dataframe\ngeo_df = gpd.GeoDataFrame(sampled,\n crs = crs,\n geometry = geometry)\n\nsns.set_style(\"white\")\n# create figure and axes, assign to subplot\nfig, ax = plt.subplots(figsize=(10,10))\n# add .shp mapfile to axes\nstreet_map.plot(ax=ax, alpha=0.4,color='grey')\n\ngeo_df.plot(column='fare_amount',ax=ax,alpha=0.5, legend=True,markersize=10)\nplt.title('96th - South - Pickup\/Dropoff', fontsize=15,fontweight='bold')\n\nplt.xlim(-74.05,-73.925)\nplt.ylim( 40.675,40.85)\n# show map\nplt.show()","c1bec1a0":"train['south_manhattan'] = np.where(((train.pickup_latitude > Manhattan_south_96th['min_lat']) & (train.pickup_latitude < Manhattan_south_96th['max_lat']) \n         & (train.pickup_longitude > Manhattan_south_96th['min_long']) & (train.pickup_longitude < Manhattan_south_96th['max_long']))\n         | ((train.dropoff_latitude > Manhattan_south_96th['min_lat']) & (train.dropoff_latitude < Manhattan_south_96th['max_lat'])\n         & (train.dropoff_longitude > Manhattan_south_96th['min_long']) & (train.dropoff_longitude < Manhattan_south_96th['max_long'])), 1, 0)\ntest['south_manhattan'] = np.where(((test.pickup_latitude > Manhattan_south_96th['min_lat']) & (test.pickup_latitude < Manhattan_south_96th['max_lat']) \n         & (test.pickup_longitude > Manhattan_south_96th['min_long']) & (test.pickup_longitude < Manhattan_south_96th['max_long']))\n         | ((test.dropoff_latitude > Manhattan_south_96th['min_lat']) & (test.dropoff_latitude < Manhattan_south_96th['max_lat'])\n         & (test.dropoff_longitude > Manhattan_south_96th['min_long']) & (test.dropoff_longitude < Manhattan_south_96th['max_long'])), 1, 0)\ndel temp\ndel sampled\ntrain","e6a9d6de":"Manhattan={\n    \"min_long\":-74.02,\n    \"min_lat\":40.70,\n    \"max_long\":-73.93,\n    \"max_lat\":40.85}\n\nJFK={\"min_long\":-73.81,\n    \"min_lat\":40.63,\n    \"max_long\":-73.77,\n    \"max_lat\":40.67}\n","12060218":"train.loc[((train.pickup_latitude > Manhattan['min_lat']) & (train.pickup_latitude < Manhattan['max_lat']) & (train.pickup_longitude > Manhattan['min_long']) \n          & (train.pickup_longitude < Manhattan['max_long'])) & ((train.dropoff_latitude > JFK['min_lat']) & (train.dropoff_latitude < JFK['max_lat'])\n          & (train.dropoff_longitude < JFK['max_long']) & (train.dropoff_longitude > JFK['min_long']))].shape","4689645f":"train.loc[((train.pickup_latitude > JFK['min_lat']) & (train.pickup_latitude < JFK['max_lat']) & (train.pickup_longitude > JFK['min_long']) \n          & (train.pickup_longitude < JFK['max_long'])) & ((train.dropoff_latitude > Manhattan['min_lat']) & (train.dropoff_latitude < Manhattan['max_lat'])\n          & (train.dropoff_longitude < Manhattan['max_long']) & (train.dropoff_longitude > Manhattan['min_long']))].shape","11e88144":"# JFK to Manh or Manh to JFK\ntrain['Manhattan_JFK'] = np.where(((train.pickup_latitude > JFK['min_lat']) & (train.pickup_latitude < JFK['max_lat']) & (train.pickup_longitude > JFK['min_long']) \n          & (train.pickup_longitude < JFK['max_long'])) & ((train.dropoff_latitude > Manhattan['min_lat']) & (train.dropoff_latitude < Manhattan['max_lat'])\n          & (train.dropoff_longitude < Manhattan['max_long']) & (train.dropoff_longitude > Manhattan['min_long'])) \n         | ((train.pickup_latitude > Manhattan['min_lat']) & (train.pickup_latitude < Manhattan['max_lat']) & (train.pickup_longitude > Manhattan['min_long']) \n          & (train.pickup_longitude < Manhattan['max_long'])) & ((train.dropoff_latitude > JFK['min_lat']) & (train.dropoff_latitude < JFK['max_lat'])\n          & (train.dropoff_longitude < JFK['max_long']) & (train.dropoff_longitude > JFK['min_long'])), 1,0)\n\n\ntest['Manhattan_JFK'] = np.where(((test.pickup_latitude > JFK['min_lat']) & (test.pickup_latitude < JFK['max_lat']) & (test.pickup_longitude > JFK['min_long']) \n          & (test.pickup_longitude < JFK['max_long'])) & ((test.dropoff_latitude > Manhattan['min_lat']) & (test.dropoff_latitude < Manhattan['max_lat'])\n          & (test.dropoff_longitude < Manhattan['max_long']) & (test.dropoff_longitude > Manhattan['min_long'])) \n         | ((test.pickup_latitude > Manhattan['min_lat']) & (test.pickup_latitude < Manhattan['max_lat']) & (test.pickup_longitude > Manhattan['min_long']) \n          & (test.pickup_longitude < Manhattan['max_long'])) & ((test.dropoff_latitude > JFK['min_lat']) & (test.dropoff_latitude < JFK['max_lat'])\n          & (test.dropoff_longitude < JFK['max_long']) & (test.dropoff_longitude > JFK['min_long'])), 1,0)\n\ntrain","8f8133a2":"train.loc[(train.Manhattan_JFK == 1) & ((train.hour >=16) & (train.hour <=20) & (train.weekday >= 0) & (train.weekday <=4))].shape","2c4c100c":"train['Manhattan_JFK_rush'] = np.where((train.Manhattan_JFK == 1) & ((train.hour >=16) & (train.hour <=20) & (train.weekday >= 0) & (train.weekday <=4)),1,0)\ntest['Manhattan_JFK_rush'] = np.where((test.Manhattan_JFK == 1) & ((test.hour >=16) & (test.hour <=20) & (test.weekday >= 0) & (test.weekday <=4)),1,0)\ntrain","87ef1316":"LGA = {\n    \"min_long\":-73.89,\n    \"min_lat\":40.76,\n    \"max_long\":-73.85,\n    \"max_lat\":40.79\n}","676483ba":"train.loc[((train.pickup_latitude > LGA['min_lat']) & (train.pickup_latitude < LGA['max_lat']) & (train.pickup_longitude > LGA['min_long'])\n          & (train.pickup_longitude < LGA['max_long'])) | ((train.dropoff_latitude > LGA['min_lat']) & (train.dropoff_latitude < LGA['max_lat']) & (train.dropoff_longitude > LGA['min_long'])\n          & (train.dropoff_longitude < LGA['max_long']))].shape","588dc36c":"train['LGA_pick_drop'] = np.where(((train.pickup_latitude > LGA['min_lat']) & (train.pickup_latitude < LGA['max_lat']) & (train.pickup_longitude > LGA['min_long'])\n          & (train.pickup_longitude < LGA['max_long'])) | ((train.dropoff_latitude > LGA['min_lat']) & (train.dropoff_latitude < LGA['max_lat']) & (train.dropoff_longitude > LGA['min_long'])\n          & (train.dropoff_longitude < LGA['max_long'])),1,0)\ntest['LGA_pick_drop'] = np.where(((test.pickup_latitude > LGA['min_lat']) & (test.pickup_latitude < LGA['max_lat']) & (test.pickup_longitude > LGA['min_long'])\n          & (test.pickup_longitude < LGA['max_long'])) | ((test.dropoff_latitude > LGA['min_lat']) & (test.dropoff_latitude < LGA['max_lat']) & (test.dropoff_longitude > LGA['min_long'])\n          & (test.dropoff_longitude < LGA['max_long'])),1,0)\ntrain.head()","6361fa2f":"train.loc[(train.hour >= 20) | (train.hour <=6)].shape","62cf0dc1":"train['overnight'] = np.where(((train.hour >= 20) | (train.hour <=6)),1,0)\ntest['overnight'] = np.where(((test.hour >= 20) | (test.hour <=6)),1,0)\ntrain.head()","5e1d81a0":"train.loc[((train.hour >= 16) & (train.hour <= 20)) & ((train.weekday >= 0 ) & (train.weekday <=4))].shape","f183273d":"train['rush_hour'] =  np.where(((train.hour >= 16) & (train.hour <= 20)) & ((train.weekday >= 0 ) & (train.weekday <=4)),1,0)\ntest['rush_hour'] =  np.where(((test.hour >= 16) & (test.hour <= 20)) & ((test.weekday >= 0 ) & (test.weekday <=4)),1,0)\ntrain","ff4f31ff":"city_center = {\"long\":-74.0060,\"lat\":40.7128}\nJFK = {\"long\":-73.7781,\"lat\": 40.6413}\nEWR = {\"long\":-74.1745,\"lat\": 40.6895}\nLGR = {\"long\":-73.8740,\"lat\": 40.7769}\nlocations_within_city = [city_center,JFK,EWR,LGR]","dcf5a546":"def haversineMod(lon1,lat1,lon2,lat2):\n    lon1,lat1,lon2,lat2 = map(np.radians, [lon1,lat1,lon2,lat2])\n    dlon = lon2 - lon1\n    dlat = lat2 - lat1\n    a = np.sin(dlat\/2.0)**2 + np.cos(lat1) * np.cos(lat2) * np.sin(dlon\/2.0)**2\n    c = 2 * np.arcsin(np.sqrt(a))\n    distance = 6367 * c\n    return distance\n\npickup_array = ['pickup_to_city_center','pickup_to_jfk','pickup_to_ewr','pickup_to_lgr']\ndropoff_array = ['dropoff_to_city_center','dropoff_to_jfk','dropoff_to_ewr','dropoff_to_lgr']\npickup_array\n\nfor feature in range(len(pickup_array)):\n    train[pickup_array[feature]] = haversineMod(train['pickup_longitude'].to_numpy(), train['pickup_latitude'].to_numpy(), locations_within_city[feature]['long'], locations_within_city[feature]['lat'])\n    train[dropoff_array[feature]] = haversineMod(train['dropoff_longitude'].to_numpy(), train['dropoff_latitude'].to_numpy(), locations_within_city[feature]['long'], locations_within_city[feature]['lat'])\n    test[pickup_array[feature]] = haversineMod(test['pickup_longitude'].to_numpy(), test['pickup_latitude'].to_numpy(), locations_within_city[feature]['long'], locations_within_city[feature]['lat'])\n    test[dropoff_array[feature]] = haversineMod(test['dropoff_longitude'].to_numpy(), test['dropoff_latitude'].to_numpy(), locations_within_city[feature]['long'], locations_within_city[feature]['lat'])\n\ntrain.shape","c49d85f1":"Dutchess = {\"long\":-73.7478,\"lat\":41.7784} #\nOrange = {\"long\":-74.3118,\"lat\":41.3912} #ok\nPutnam = {\"long\":-73.7949,\"lat\": 41.4351} #ok\nRockland = {\"long\":-73.9830,\"lat\": 41.1489} #ok\nSuffolk = {\"long\":-72.6151,\"lat\": 40.9849} #ok \nNassau = {\"long\":-73.5594,\"lat\": 40.6546}  #ok\nWestchester = {\"long\":-73.7949,\"lat\": 41.1220} #ok\n\nlocations_outside = [Dutchess,Orange,Putnam,Rockland,Suffolk,Nassau,Westchester]\npickup_array = ['pickup_to_city_dutchess','pickup_to_orange','pickup_to_putnam','pickup_to_rockland','pickup_to_suffolk','pickup_to_nassau','pickup_to_westchester']\ndropoff_array = ['dropoff_to_city_dutchess','dropoff_to_orange','dropoff_to_putnam','dropoff_to_rockland','dropoff_to_suffolk','dropoff_to_nassau','dropoff_to_westchester']","6f51bb6a":"for feature in range(len(pickup_array)):\n    train[pickup_array[feature]] = haversineMod(train['pickup_longitude'].to_numpy(), train['pickup_latitude'].to_numpy(), locations_outside[feature]['long'], locations_outside[feature]['lat'])\n    train[dropoff_array[feature]] = haversineMod(train['dropoff_longitude'].to_numpy(), train['dropoff_latitude'].to_numpy(), locations_outside[feature]['long'], locations_outside[feature]['lat'])\n    test[pickup_array[feature]] = haversineMod(test['pickup_longitude'].to_numpy(), test['pickup_latitude'].to_numpy(), locations_outside[feature]['long'], locations_outside[feature]['lat'])\n    test[dropoff_array[feature]] = haversineMod(test['dropoff_longitude'].to_numpy(), test['dropoff_latitude'].to_numpy(), locations_outside[feature]['long'], locations_outside[feature]['lat'])","9d50ec03":"train.shape","fa8063cc":"#train['fare_amount'] = y\nindexes = abs(train.corrwith(train['fare_amount'])).index.to_list()\nfeatures = np.array(abs(train.corrwith(train['fare_amount'])))\ndata = {'Feature':indexes,'corr_to_target':features}\ndf = pd.DataFrame(data)\ndf = df.sort_values(by='corr_to_target',ascending = False).reset_index()\ndf.head()","ac97af7b":"plt.figure(figsize=(14,14))\nsns.set_style('whitegrid')\nax = sns.barplot(x='corr_to_target', y='Feature', data=df)\nax.set_xlabel('Correlation to Target', fontsize=14)\nax.set_ylabel('Feature', fontsize=14)\nax.set_title('Absolute Feature Correlation Value With Target Variable')","d80eadef":"# 7. Models Training ","6570dc55":"y = train['fare_amount']\ntrain.drop(columns = ['fare_amount'], axis = 1,inplace=True, errors = 'ignore')\n\nX_train, X_validation, y_train, y_valid = train_test_split(train, y,train_size=0.8, test_size=0.2,random_state=0)","eb36f515":"import time\nmodel_name = []\nelapsed_time = []","dc2b0612":"def runXGB(X_train_clean,y_train_clean,X_validation_clean,y_validation_clean,n_est,learning_r,jobs):\n   \n\n    model = XGBRegressor(n_estimators=n_est, learning_rate=learning_r, n_jobs=jobs)\n    model.fit(X_train_clean, y_train_clean,\n                  early_stopping_rounds=20,\n                  eval_set=[(X_validation_clean, y_validation_clean)],\n                  verbose = False) \n\n    predictions_2 = model.predict(X_validation_clean)\n    mae_2 = mean_absolute_error(predictions_2, y_validation_clean) \n\n    return mae_2,model","17000f50":"mae_approach_1 = []\nmodel_approach_1 = []\n\nstart_time = time.time()\nmae_2, model = runXGB(X_train,y_train,X_validation,y_valid,100,0.1,2)\n\n\npred = model.predict(X_validation)\nmse = mean_squared_error(y_valid, pred)\nrmse = math.sqrt(mse)\nprint(rmse)\nend_time = time.time() - start_time \nmodel_name.append('XBG')\nelapsed_time.append(end_time)","a3d34109":"import lightgbm as lgbm\nparams = {\n        'boosting_type':'gbdt',\n        'objective': 'regression',\n        'nthread': 4,\n        'num_leaves': 31,\n        'learning_rate': 0.06,\n        'max_depth': -1,\n        'subsample': 0.8,\n        'bagging_fraction' : 1,\n        'max_bin' : 5000 ,\n        'bagging_freq': 20,\n        'colsample_bytree': 0.6,\n        'metric': 'rmse',\n        'min_split_gain': 0.5,\n        'min_child_weight': 1,\n        'min_child_samples': 10,\n        'scale_pos_weight':1,\n        'zero_as_missing': True,\n        'seed':0,\n        'num_rounds':500\n    }\n\n\ndef LGBMmodel(X_train,X_test,y_train,y_test,params):\n    matrix_train = lgbm.Dataset(X_train, y_train)\n    matrix_test = lgbm.Dataset(X_test, y_test)\n    model=lgbm.train(params=params,\n                    train_set=matrix_train,\n                    num_boost_round=2, \n                    early_stopping_rounds=400,\n                    verbose_eval=100,\n                    valid_sets=matrix_test)\n    return model\nstart_time = time.time()\nmodel = LGBMmodel(X_train,X_validation,y_train,y_valid,params)","de07b47d":"pred = model.predict(X_validation)\nmse_2 = mean_squared_error(y_valid, pred)\nrmse_2 = math.sqrt(mse_2)\nprint(rmse_2)\nend_time = time.time() - start_time \nmodel_name.append('LGBM')\nelapsed_time.append(end_time)","8704794b":"d = dict(zip(model_name,elapsed_time))\nd","81970f36":"y_pred = model.predict(test)\nsubmission = pd.read_csv('..\/input\/new-york-city-taxi-fare-prediction\/sample_submission.csv')\nsubmission['fare_amount'] = y_pred\nsubmission.to_csv('submission_XGB.csv', index=False)\nsubmission.head(5)","c94a09d9":"data = {'Model':list(d.keys()),'Time Elapsed': [list(d.values())[1],list(d.values())[0]], 'RMSE':[rmse,rmse_2]}\npd.DataFrame(data)","1e87b8e1":"## 5.2 Trips to\/from Airports","7dc50c56":"# 4. Data Cleaning","0fcce3ce":"## 7.2 XGB Regressor","2145cbba":"One hot encoding these locations:","bd5965f5":"## 4.4 Unreal Latitude and Longitude","00ff55c6":"## 5.1 Congestion Surcharge","c2a4f38d":"The data set has 55M rows and some features. They are: \n\n* key - Unique string identifying each row in both the training and test sets. Comprised of pickup_datetime plus a unique integer, but this doesn't matter, it should just be used as a unique ID field. Required in your submission CSV. Not necessarily needed in the training set, but could be useful to simulate a 'submission file' while doing cross-validation within the training set.\n* pickup_datetime - timestamp value indicating when the taxi ride started.\n* pickup_longitude - float for longitude coordinate of where the taxi ride started.\n* pickup_latitude - float for latitude coordinate of where the taxi ride started.\n* dropoff_longitude - float for longitude coordinate of where the taxi ride ended.\n* dropoff_latitude - float for latitude coordinate of where the taxi ride ended.\n* passenger_count - integer indicating the number of passengers in the taxi ride.\n* fare_amount - float dollar amount of the cost of the taxi ride. This value is only in the training set; this is what you are predicting in the test set and it is required in your submission CSV.","d575f1c9":"## 2.2 Converting Timestamps","7c8f2e13":"# 7.4 Predicting Test Set","4ee0477b":"If we can determine the distance between pickup and dropoff points of the city, it would be an useful feature for the model. With that, the actual pickup location could be estimated, and so could the dropoff. Hence, the model could set boundaries on the map and triangulate the locations, making better predictions. ","24637d6c":"![New-York-city-time-square-radial.jpg](attachment:New-York-city-time-square-radial.jpg)","8f8c05a1":"Let's check an histogram of trip distance in Km.","3cfb05a7":"On the weekends, the results are a bit different. We have a great part of the trips ocurring from 0am to 2am. These might be related to airport trips, or people taking taxis to\/from pubs. From 16pm to 20pm we have an increase on the demand. ","676369f6":"# 5 Feature Engineering","dea62da3":"# 1. Reading Data","9aaf4718":"## 4.3 Trips Where The Pickup and The Dropoff Coordinates Are The Same","e00bacd8":"On normal working days, from monday to friday, it can be seen that overnight there is an increase in the mean fare amount, from 20pm to aproximately 6am. This can be related to some tax applied due to the hours, and should be investigated in feature engineering. ","fd359d78":"#### 5.2.1.1 Manhattan\/JFK Rush Hour Surcharge","1ea9bb22":"# Dataset Description","c883e777":"## 3.6 Passenger Count Distribution","073eada2":"## 4.1 Missing Values","acbecf0b":"Many noisy data might be present on the dataset. The main objective here is:\n1. Remove missing values\n2. Remove  200 =< fare_amount <= 2 dolars \n3. Remove trips where the pickup and the dropoff locations are the same\n4. Remove trips where 90 < latitude < -90; 180 < longitude < -180\n5. Remove trips where passenger_count > 6\n6. Remove coordinates that exceed city limits (including counties)","dc159db5":"And how many begin in JFK and end in Manhattan?","45d03627":"* As demonstrated trough the EDA and further feature correlation analysis, we have reached an impressive correlation of the generated features. This is due to a good data cleaning and confirmation of hypothesis. However, we could have removed more outliers, such as the indicated in the section 3.4 and the location points marked in water areas (dist_km went from 0.025 to 0.8 correlation).\n* The models, on the training set, have reached a relatively good RMSE. For further approaches, some analysis taking into consideration a variation on the feature selection, such as selecting higher correlated features, are recommended. It won't help much, but could save time from the model for taking not relevant decisions. \n* We have chosen two robust and famous models due to their good performance with previous tabular data. The difference between them is not enormous, but it is significant to our problem. Let's enlight some reasons why LGBM had a better performance over XGBOOST:\n\n#### 1. As seen experimentaly, LGBM is faster. This can be related to its histogram based algorithm that bins continous features into discrete values, making the training process faster. It is essential, especially for large datasets as ours. \n#### 2. It performs better in terms of RMSE by using what is called as leaf wise split approach. It provides much more complex trees that helps the model making better decisions. \n#### 3. Doing some researches, it can be seen that LGBM is an improvment of XGBoost. The accuracies are comparable, but the time taken is completely different. Besides it, as mentioned, LGBM reaches lower RMSE due to their complex trees. \n#### 4. LGBM uses a gradient based technique (GOSS) to filter data instances finding for a split value, while XGBoost uses a pre-selected algorithm and histogram based algorithm to calculate a better division. In practice, the histogram based algorithm divides all data points in discrete bins, using them to select the histogram split value. Comparing the last one to GOSS results in lower speed for a similar RMSE value.\n\n* For further improvements, we suggest removing more outliers and a better fine-tuning, such as bayesian methods. \n","57af92d8":"The NY government sets the initial fare as 2.5 dolars. So it doesn't make sense to have values lower than that. From the EDA and from the 3.3 section, we know that there might be values that extend far beyond 100 dolars. Let's check how many of them match this condition","e99ebf9d":"One hot encoding the trips that match this condition:","e4de8939":"As illustrated above, after the data cleaning, almost all variables had its correlation values increased. We have now 13 variables with a correlation higher than 0.3. ","cf2723c7":"Empirically, these were the parameter that proved to be the better ones in RSME aspect. Learning rate around 0.06 produces a relatively slow run, but it reaches what it seems to be a global mininum. The early stopping rounds was chosen to be 400 because it takes a very long time to run the model with a higher number of examples. 'gbdt' proved to be the best boosting type for this problem compared to dart. ","212ce6ab":"## 3.5 Distributions of Pickup and Dropoff Points in NYC","9952bbc5":"Calling the haversine method and adding these values to the dataset:","bf8a34e0":"* train.csv - Input features and target fare_amount values for the training set (about 55M rows).\n* test.csv - Input features for the test set (about 10K rows). Your goal is to predict fare_amount for each row.\n* sample_submission.csv - a sample submission file in the correct format (columns key and fare_amount). This file 'predicts' fare_amount to be $11.35 for all rows, which is the mean fare_amount from the training set.","b686ad56":"From the right scatterplot it can be seen that, despite some outliers:\n1. There's a kind of linear relationship between the distance in kilometers and the fare.\n2. There are many points with 0km with a correspondent fare. These could be outliers or trips that begin and end in the same point (a person calls a taxi to do something in the city and gets back home)\n2. There are some trips with very high distance and low fare. These are outliers and should be removed from the dataset. \n3. Next to the 60 dolar fare there are some horizontal lines. They migh be related to trips with fixed fare from specific locations, such as airports.\nTo confirm this hypothesis, let's exclude the rows with the pickup locations refered to the airports:","98b44ecb":"# 2. Basic Feature Generation","e9b73484":"## File Descriptions","b402c4cc":"How many trips begin or end at La Guardia Airport?","ab43af6a":"## 5.5 Distance to Key Locations","45dd1326":"The ideal was to show the impact of changing the number of estimators and the learning rate. However, due to the dataset size, it would take a long time to commit. From previous tests, it was found that n_estimators higher than a hundred wouldn't contribute to a lower RMSE. A learning_rate of 0.08 proved to cause the lowest RMSE values. ","c34a0c5b":"New York is one of the most famous cities in the world. One of its districts, Manhattan, has a high demographic density and concentrates the main shopping centres. Going from one point of the city to another might take some time and cost a bit. Wouldn't it be useful to predict the price using AI?","6512f78c":"![limits_nyc.png](attachment:limits_nyc.png)","81a46782":"From section 3.1.2, we infered that overnight trips have the highest mean fare amount. NYC Gov says\"*Plus 50 cents overnight surcharge 8pm to 6am*\"","51199472":"According to the government website *\"Trips between Manhattan and John F. Kennedy Airport (JFK) in either direction: 52 dolars\"*. So let's define these locations:","187cd49d":"Before we move on to an exploratory data analysis, we first need some features. Let's extract them from the dataset.","d0a470d4":"From the data exploration we've made, we know that airports have fixed fare and Manhattan concentrates most of the trips. Let's create some features based on that.","9010b8ee":"### 5.2.2 Trips to\/from LGA","b5bb1b69":"Setting the approximate coordinates to these city locations:","9c42bc3e":"As one can see above, there are some periods of the day that we should pay attention to. In the morning, from 7am to 9am we can notice an increase in the number of taxi trips. This might be related to the time where people are getting to work. From 16pm to 20pm we have an increase on the demand. These rush hours should be taken into consideration in the feature engineering process. ","e955b3d6":"From the section 3.2, we know that trips beyond 100km should be removed. The biggest distance that could happen should be from NYC to Dutchess county, that doesn't exceed 130Km. ","21094812":"Part of our hypothesis is confirmed. Locations that refer to JFK, from 40 to 60 dolars have a horizontal line, specially in short distace trips and trips between 20 and 30km. Besides it, there's some kind of linear relationship between the distance and the fare amount. There are some outliers beneath the curves. These values could be removed to train a better model.","01810afb":"## 4.5 Coordinates Beyond NYC Boundaries","6371bec8":"## 4.6 Distance Outliers","5684c9a3":"#### 3.1.1.1.2 Weekends","409de69e":"## 1.1 Statistically Describing Data","4bb7ee93":"### 3.1.2 Hours and Mean Fare Amount - Working Weekdays vs Weekends","51ce6cdd":"As can be seen above, most part of the trips vary from aproximately 5Km to 25Km. The least frequent values of distance extend indefinetely even beyond the axis limits we have set. Taking into consideration all the possible trips within and outside NYC, some data cleaning should be made to remove outliers and make the feature 'dist_km' more correlated to the target variable. \n\nAnalyzing the possible trips with google maps, from NYC centre to the most distant possible county, it is about 135km distant. We should remove trips where this limit is exceeded.  ","1a167f8c":"### 5.5.1 Places Within NYC","845ea1bd":"### 5.5.2 Places Outside NYC - Counties","0109af91":"Many factors could influence the fare amount related to a trip, and it might be overwhelming. However, searching in the NYC Government website, many rules can be found (https:\/\/www1.nyc.gov\/site\/tlc\/passengers\/taxi-fare.page). Based on them, and in other aspects related to the trip, some feature generation can be proposed.\n\n1. Haversine Distance between locations\n2. TimeStamps (Weekday, hour, month, year)\n3. Congestion Surcharge \n4. Trips to\/from Manhattan to\/from JFK\n5. Manhattan\/JFK on rush hours\n6. Westchester and Nassau counties\n7. Distance from pickup\/dropoff to key locations","50a95670":"## 3.3 Fare Amount Distribution","1fbfcb06":"#### 3.1.1.1 Normal Working Days","88d0b63a":"# 3. Exploratory Data Analysis","58dc3e06":"## 3.4 Relationship Between Distance and Fare Amount ","121a058f":"So there is more than a million trips in this condition.","56fbed43":"## 7.3 LGBM","a1981a4b":"# 8. Conclusion","142c79f2":"From section 3.1.1, we know that 4-8pm is a rush hour. Besides it, NYC gov says: \"*Plus 1.00 rush hour surcharge from 4pm to 8pm on weekdays, excluding holidays*\"","765a561b":"## 3.2 Distance Distribution","48bfd826":"### 5.2.1 Trips Between Manhattan and JFK Airport","f846d604":"There are a few coordinate values missing. They can be removed from the dataset without affecting significantly the model's learning.","5203be4c":"With a simple search, you can obtain a list of the related counties to our problem. Longitudinally, the coordinates are limited at the right by the Suffolk county, and at the left by the Orange county. Latidudinally and superiorly by de Dutchess county, and inferiorly by the Nassau county. ","2e8d048a":"## 3.7 Correlation Between Variables Before Cleaning","558d7b16":"From these plots (just a sample of the huge dataset), we can infer:\n1. There are a lot of locations in the water. These are outliers. They should be removed based on the water boundaries, distance to destination or fare amount associated. \n2. Most part of the pickup and dropoff locations are in Manhattan, and most of them are cheap. Since it's a very a busy part of the city, there might be some charges due to traffic. Feature generation should take this into consideration. \n3. The density of points in JFK and LGA airports confirm the analysis of fixed fare, from and to that locations. \n4. There are some trips to the counties, so there should be a feature to make it possible to predict these trips.","4f83856c":"The main objective here is to familiarize with the data and investigate some hypothesis. Let's list some of them:\n* Are there specific hours during the day that affect the mean fare amount?\n* Do airport trips have fixed fare?\n* Do overnight trips have an increase in the mean fare amount?\n* How many long\/short trips do we have in the dataset?\n* What is the passenger count distribution?\n* What is the fare amount distribution?\n* What is the trip distance distribution?\n* How do the distance relate to the fare amount?\n","6af36d96":"# Introduction","42a3d0b3":"# References \n[1] https:\/\/www.kaggle.com\/breemen\/nyc-taxi-fare-data-exploration \n[2] https:\/\/medium.com\/analytics-vidhya\/exploratory-data-analysis-of-nyc-taxi-trip-duration-dataset-using-python-257fdef2749e\n[3] https:\/\/towardsdatascience.com\/exploratory-data-analysis-eda-a-practical-guide-and-template-for-structured-data-abfbf3ee3bd9\n[4] https:\/\/towardsdatascience.com\/a-gentle-introduction-to-exploratory-data-analysis-f11d843b8184\n[5] https:\/\/www.kaggle.com\/dster\/nyc-taxi-fare-starter-kernel-simple-linear-model\n[6] https:\/\/www.kaggle.com\/madhurisivalenka\/cleansing-eda-modelling-lgbm-xgboost-starters","cb2bba17":"As seen in the EDA, most part of the trips begin or and at Manhataan. According to the NYC Government website *\"Plus New York State Congestion Surcharge of 2.50 (Yellow Taxi) or 2.75 (Green Taxi and FHV) or 75 cents (any shared ride) for all trips that begin, end or pass through Manhattan south of 96th Street\".* With Google Maps help, we could define a latitude-longitude limitation for the south of the 96th street:","c63b8702":"# 6. Correlation After Feature Engineering","6ad960a8":"EDA shows us some dropoff and pickup locations outside the city. From the government website we know \"*Out of City Rate to Nassau or Westchester.\" The metered fare is double the amount from the City limit to your destination*\". To other points outside the city, \"*The 50 cents MTA State Surcharge must be added to the flat rate for any trip that ends in the following counties: Dutchess, Orange, Putnam, Rockland or Suffolk.*\". Therefore, it is important to calculate the pickup and dropoff locations to these counties. Estimating these locations with Google Maps gives:","43712290":"## 2.1 Haversine Distance Between Locations","2f38c203":"* Zero passengers could be related to deliveries\n* Up to six passengers makes sense. The taxi could be an SUV\n* More than six passengers doesn't make sense. Even though this feature probably doesn't have a high correlation to the target variable, we should drop these values out of the dataset. ","8a2205fe":"# NYC Taxi Fare Prediction\nAuthor: Arthur Dimitri","0238b88e":"## Training Set","979cd3c1":"We have sucessfully extracted the features we need for a basic EDA. After that we dropped the original columns that don't help the model.","aa7114fd":"## 3.1 Hours and Demand","db07e614":"There are some outliers, but our selection makes sense. Most locations are located at the south of the 96th street. Let's one hot encode these locations:","babc518b":"So there are more than 80 thousand rows where this condition is satisfied. It can be related to trips where the person calls a taxi from the current place and uses the taxi as a transport to do whatever they need, and come back to the same pickup place. However, it wouldn't help our model to improve its predictions, therefore we are going to remove them from the dataset. ","119be07a":"How many trips begin in Manhattan and end in the JFK?","fef4ac69":"As can be seen, most trips vary from 2.5 dolars to 20 dolars. There are negative values. The distribution extends for very high fare amount values. In the data cleaning, negative values and fare amounts that go beyond a certain limit (close to a hundred dolars) should be taken out of the dataset. ","50eb7af4":"## 7.1 Data Split","6584ee2e":"## 5.4 Rush Hour","08ae614c":"### 3.1.1 Rush Hours","f51af3b8":"According to Wikipedia, \"*The haversine formula determines the great-circle distance between two points on a sphere given their longitudes and latitudes*\". Let's apply that to our dataset. ","6941be96":"## 4.2 Values Above Mininum Fare Amount","eac2128a":"As can be seen above, there are a few variables with high correlation with the target variable. From now on, we should focus on generating high correlated variables and clean the data to get better correlation values. ","39039336":"Let's one hot encode these cases in a feature called Manhattan_JFK (from\/to JFK from\/to Manhattan)","13aeca16":"From the Rush Hour data exploration, we know that 4-8pm has the highest demand of the dataset. NYC Gov determines: \"*4.50 dolar rush hour surcharge (4pm to 8pm weekdays, excluding legal holidays)\"* Associating that with Manhattan pickup\/dropoff importance, and fixed fare trips from JFK airport, let's see how many match this condition.","a0bd654f":"It could be automated by converting the pixels to coordinates, but with an approximation using Google Maps, latitude and longitude limits were found. \n* -74.76 < latitude < -71.93\n* -74.76 < longitude < -71.93\nBesides it, there might be some coordinates, as seen in the section 2.2, that have a zero value. ","70f9fdeb":"From EDA and from NYC Gov: \"*Trips to and from LaGuardia Airport (LGA) are charged the standard metered fare*\". Let's define the coordinates of LGA airport:","c954e2ab":"## 5.3 Overnight Trips "}}