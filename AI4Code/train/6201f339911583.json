{"cell_type":{"db3e3c1e":"code","e43134c9":"code","993ca875":"code","02cb0883":"code","776fee3d":"code","c18e6188":"code","00b0a182":"code","32169ff6":"code","89ecdefc":"code","f5b2f69d":"code","38acb061":"code","96610faf":"code","30091cd5":"code","2267db8a":"code","016ea86e":"code","e501c9f2":"code","b56c3ec9":"code","c6f4dc9a":"code","a6c5aee0":"code","a86b63c9":"code","2f97aaaa":"code","69f25e0e":"code","224584f2":"code","1f6038a9":"code","b92724ea":"code","55fdb2bb":"code","bcaec9c3":"code","94475321":"code","d8b18b26":"code","ff530e74":"code","ce77107e":"code","f35c2232":"code","f0698831":"code","393ed866":"code","0a7783b1":"code","827530b2":"code","bf7b483d":"code","9d19f350":"code","671c393e":"markdown","29026652":"markdown","d7b50773":"markdown","3d8a2d2c":"markdown","a308140c":"markdown","a7045c54":"markdown","6c4869d7":"markdown","15eac8d6":"markdown","18aa3034":"markdown","9a08efdc":"markdown","cf0a2358":"markdown","b41e84b4":"markdown","ff3a10ba":"markdown","11dbf6f8":"markdown","3252dacd":"markdown","34d5bbf3":"markdown","7b5210f3":"markdown","a503a9e0":"markdown","d3f4253e":"markdown","a467f4ba":"markdown","729eb8cb":"markdown","8f97f7d2":"markdown","2a5d31d1":"markdown","259a4759":"markdown","94677b11":"markdown","698e83b4":"markdown","52fae6ca":"markdown"},"source":{"db3e3c1e":"from datetime import datetime\nimport numpy as np\nimport pandas as pd\nimport geopandas as gpd\nimport geoplot\nimport mapclassify\nimport matplotlib.pyplot as plt\nimport matplotlib.colors as colors\n\n%matplotlib inline\nimport matplotlib.pyplot as pyplot","e43134c9":"fed_inhabitants = pd.read_csv('..\/input\/de-stats\/german-federation-inhabitants.csv', thousands='.', decimal=',')\nfed_inhabitants_2018 = fed_inhabitants[['Bundesland','2018']].rename(columns={'2018':'inhabitants_2018'})","993ca875":"de = gpd.read_file('..\/input\/de-stats\/german-federation-geo-adm1.shp', encoding='utf-8')","02cb0883":"CURRENT_DATA_URL='https:\/\/funkeinteraktiv.b-cdn.net\/current.v4.csv'\nHISTORY_DATA_URL='https:\/\/funkeinteraktiv.b-cdn.net\/history.light.v4.csv'","776fee3d":"df = pd.read_csv(HISTORY_DATA_URL, usecols=['parent', 'label', 'label_parent', 'population', 'date', 'updated', 'confirmed', 'recovered', 'deaths'])\ndf['date'] = pd.to_datetime(df['date'], format=\"%Y%m%d\")\n\nLATEST_DATE = df.date.max() - pd.Timedelta(days=1)\nhistory_df = df[df.date<=LATEST_DATE]","c18e6188":"LATEST_DATE","00b0a182":"de_history_df = history_df.loc[history_df.label_parent=='Deutschland',['label','date','recovered','confirmed','deaths']]\nde_history_df['active'] = de_history_df['confirmed'] - (de_history_df['recovered'] + de_history_df['deaths'])\nde_by_date = de_history_df.groupby('date').sum()","32169ff6":"de_fed_by_date_all = de_history_df.groupby(['date','label']).sum().reset_index()\n#feds = list(de_fed_by_date_all.label.unique())\nfeds = ['Baden-W\u00fcrttemberg',\n 'Bayern',\n 'Berlin',\n 'Brandenburg',\n 'Bremen',\n 'Hamburg',\n 'Hessen',\n 'Mecklenburg-Vorpommern',\n 'Niedersachsen',\n 'Nordrhein-Westfalen',\n 'Rheinland-Pfalz',\n 'Saarland',\n 'Sachsen',\n 'Sachsen-Anhalt',\n 'Schleswig-Holstein',\n 'Th\u00fcringen']\n\nde_fed_by_date = de_fed_by_date_all[de_fed_by_date_all.label.isin(feds)]","89ecdefc":"wi_df = de.merge(fed_inhabitants_2018,right_on='Bundesland', left_on='NAME_1').drop(['ID_0','ISO','NAME_0','NAME_1', 'ID_1', 'TYPE_1','ENGTYPE_1','NL_NAME_1','VARNAME_1'], axis=1)\nwith_inhabitants_and_cases_df = wi_df.merge(de_fed_by_date[de_fed_by_date.date==LATEST_DATE], right_on='label', left_on='Bundesland')","f5b2f69d":"PER_INHABITANTS = 100000","38acb061":"confirmed_per_inhabitants = (with_inhabitants_and_cases_df['confirmed']*PER_INHABITANTS)\/with_inhabitants_and_cases_df['inhabitants_2018']\nactive_per_inhabitants = (with_inhabitants_and_cases_df['active']*PER_INHABITANTS)\/with_inhabitants_and_cases_df['inhabitants_2018']","96610faf":"with_inhabitants_and_cases_df['confirmed_per_inhabitants']=confirmed_per_inhabitants\nwith_inhabitants_and_cases_df['active_per_inhabitants']=active_per_inhabitants\ncases_by_bundesland=with_inhabitants_and_cases_df[['Bundesland','confirmed','confirmed_per_inhabitants','active','active_per_inhabitants']]\ncases_by_bundesland.sort_values(by=['active_per_inhabitants','active'], ascending=False)","30091cd5":"plt.figure(figsize=(14,9))\n\nax = plt.subplot(121, title = \"Absolute Number of Confirmed Cases\")\ngeoplot.choropleth(\n    wi_df, hue=cases_by_bundesland.confirmed, \n    scheme = mapclassify.Quantiles(cases_by_bundesland.confirmed, k=7),\n    cmap='Oranges', legend=True, ax=ax\n);\n\n\nax = plt.subplot(122, title = \"Confirmed Cases per {} inhabitants\".format(PER_INHABITANTS))\ngeoplot.choropleth(\n    wi_df, hue=cases_by_bundesland.confirmed_per_inhabitants, \n    scheme=mapclassify.Quantiles(cases_by_bundesland.confirmed_per_inhabitants, k=7),\n    cmap='Oranges',legend=True, ax=ax\n);","2267db8a":"plt.figure(figsize=(14,18))\n\nax = plt.subplot(122, title = \"Active Cases per {} inhabitants\".format(PER_INHABITANTS))\ngeoplot.choropleth(\n    wi_df, hue=cases_by_bundesland.active_per_inhabitants, \n    scheme=mapclassify.Quantiles(cases_by_bundesland.active_per_inhabitants, k=7),\n    cmap='Reds',legend=True, ax=ax\n);\n\nax = plt.subplot(121, title = \"Confirmed Cases per {} inhabitants\".format(PER_INHABITANTS))\ngeoplot.choropleth(\n    wi_df, hue=confirmed_per_inhabitants, \n    scheme=mapclassify.Quantiles(cases_by_bundesland.confirmed_per_inhabitants, k=7),\n    cmap='Oranges',legend=True, ax=ax\n);\n","016ea86e":"def highlight_new_max(df):\n    num_of_cols = df.size\n    if df['new\/max %'] >= 100:\n        return ['background-color: red']*num_of_cols\n    elif df['new\/max %'] >= 50:\n        return ['background-color: yellow']*num_of_cols\n    else:\n        return ['']*num_of_cols ","e501c9f2":"new_1days_by_state=de_fed_by_date.set_index(['date','label']).groupby('label').diff()['confirmed']\nnew_infections_1days_by_state= pd.DataFrame({'new_infections_1day': new_1days_by_state.groupby('label').last(),'max_new_infections_1day':new_1days_by_state.groupby('label').max()})\nnew_infections_1days_by_state['new\/max %']=new_infections_1days_by_state.new_infections_1day*100\/new_infections_1days_by_state.max_new_infections_1day\n\nnew_infections_1days_by_state.sort_values(by='new\/max %', ascending=False).style.apply(highlight_new_max,axis=1)","b56c3ec9":"plt.figure(figsize=(7,14))\n\nax = plt.subplot(111, title = \"New Infections yesterday\/ max new infections 1day ever %\")\ngeoplot.choropleth(\n    wi_df.set_index('Bundesland'), hue=new_infections_1days_by_state['new\/max %'], \n    cmap='Reds',\n    legend=True, \n    legend_kwargs={'orientation': 'horizontal'},  \n    ax=ax\n);","c6f4dc9a":"de_last = float(de_by_date['confirmed'].diff().tail(1))\nde_max = de_by_date['confirmed'].diff().max()\n\nprint (\"Germany: Last    Day: \", de_last)\nprint (\"Germany: Max per Day: \", de_max)\nprint ()\nprint (\"Germany: Last Day\/Max per Day %: \", de_last*100\/de_max)","a6c5aee0":"def abs_growth_from(df_by_date):\n    return df_by_date.diff().fillna(0)","a86b63c9":"def severity_colors(c):\n    if c >= 200:\n        return 'background-color: darkred'\n    if c >= 150:\n        return 'background-color: red'        \n    if c >= 100:\n        return 'background-color: orange'    \n    if c >= 50:\n        return 'background-color: yellow'       \n    else:\n        return 'background-color: white' \n    \ndef highlight(df):\n    num_of_cols = df.size\n    if df.new_infections_7days_per100k < 1.0:\n        return ['background-color: yellow']*num_of_cols\n    else:\n        return [severity_colors(df['new_infections_7days_per100k'])]*num_of_cols ","2f97aaaa":"state_to_new_infections_7days = {}\nfor fed in feds:\n    fed_by_date = de_fed_by_date[de_fed_by_date.label==fed].set_index('date')\n    abs_growth_fed_by_date =abs_growth_from(fed_by_date.confirmed)\n    abs_growth_fed_by_date_last7days = abs_growth_fed_by_date.rolling(7).sum()\n    state_to_new_infections_7days[fed] = list(abs_growth_fed_by_date_last7days.loc[abs_growth_fed_by_date_last7days.index == LATEST_DATE])\n\nnew_infections_7days_by_state = pd.DataFrame(state_to_new_infections_7days).transpose()\nnew_infections_7days_by_state.columns=['new_infections_7days']\nnew_infections_7days_by_state['new_infections_7days_per100k'] =fed_inhabitants_2018.set_index('Bundesland').merge(new_infections_7days_by_state, left_index=True, right_index=True).apply(lambda r:r['new_infections_7days']*PER_INHABITANTS\/r['inhabitants_2018'], axis=1)\n\nnif7=new_infections_7days_by_state.sort_values(by='new_infections_7days_per100k', ascending=False)\nnif7.style.apply(highlight, axis=1)        ","69f25e0e":"CUT_MAX=100\nnew_infections_7days_by_state['new_infections7days_per100k_cut'] = new_infections_7days_by_state['new_infections_7days_per100k'].apply(lambda v:v if v<CUT_MAX else CUT_MAX)","224584f2":"plt.figure(figsize=(14,18))\n\nax = plt.subplot(221, title = \"New Infections last 7 days per {} inhabitants\".format(PER_INHABITANTS))\ngeoplot.choropleth(\n    wi_df.set_index('Bundesland'), hue=new_infections_7days_by_state.new_infections_7days_per100k, \n    cmap='Reds',\n    legend_kwargs={'orientation': 'horizontal'}, \n    legend=True, \n    ax=ax\n);\n\nax = plt.subplot(222, title = \"New Infections last 7 days per {} inhabitants cut to {}\".format(PER_INHABITANTS, CUT_MAX))\ngeoplot.choropleth(\n    wi_df.set_index('Bundesland'), \n    hue=new_infections_7days_by_state.new_infections7days_per100k_cut, \n    cmap='Reds',\n    legend_kwargs={'orientation': 'horizontal'}, \n    legend=True, \n    ax=ax    \n);","1f6038a9":"def rolling_mean(days, df_confirmed_by_date, fed):\n    fed_confirmed_by_date=df_confirmed_by_date.loc[df_confirmed_by_date.label==fed,['date','confirmed']].set_index('date')\n    fed_confirmed_by_date['rolling_mean'] = fed_confirmed_by_date.rolling(days).mean()    \n    return fed_confirmed_by_date\n\ndef growth_factor_from(df, shift):\n    growth_confirmed = df\n    return (growth_confirmed\/ growth_confirmed.shift(shift))\n\ndef plot_growth_factor(growth_factor_df, max_growth=10, details=\"\"):\n    ax = growth_factor_df.plot(figsize=(12,6), linestyle=':', linewidth=2, title='Growth Factor Confirmed (2nd derivate):' + details, ylim=(0.9,max_growth))\n    ax.axhline(y=1, color='red', linestyle='--')\n    plt.grid(True)\n    plt.ylabel('Delta today\/Delta day before');\n    return ax    ","b92724ea":"# collect latest growth factors per state\nstate_to_gf = {}\nfor fed in feds:\n    fed_confirmed_by_date = rolling_mean(7, de_fed_by_date, fed)\n    gf = growth_factor_from(abs_growth_from(fed_confirmed_by_date), 1)\n    state_to_gf[fed] = list(gf.loc[gf.index == LATEST_DATE, 'rolling_mean'])\n\ngfs_by_state = pd.DataFrame(state_to_gf).transpose()\ngfs_by_state.columns=['gf']\ngfs_by_state.sort_values(by='gf', ascending=False)","55fdb2bb":"wgf_df = de.merge(gfs_by_state, right_index=True, left_on='NAME_1').drop(['ID_0','ISO','NAME_0', 'ID_1', 'TYPE_1','ENGTYPE_1','NL_NAME_1','VARNAME_1'], axis=1)","bcaec9c3":"def min_max(v):\n    min_v = v.min() if v.min()<1 else 0.99\n    max_v = v.max() if v.max()>1 else 1.01\n    return (min_v, max_v)","94475321":"min_v, max_v = min_max(wgf_df.gf)\n\nplt.figure(figsize=(14,14))\ndivnorm = colors.TwoSlopeNorm(vmin=min_v,vcenter=1.0,vmax=max_v)\n\nax = plt.subplot(111, title = \"Growth Rate\")\ngeoplot.choropleth(\n    wgf_df, hue=wgf_df.gf,     \n    cmap='coolwarm', norm = divnorm, legend=True, ax=ax\n);","d8b18b26":"# collect latest growth factors per state\nstate_to_gf4 = {}\nfor fed in feds:\n    fed_confirmed_by_date = rolling_mean(4, de_fed_by_date, fed)\n    gf4 = growth_factor_from(abs_growth_from(fed_confirmed_by_date), 4)\n    # print (fed, gf4)\n    state_to_gf4[fed] = list(gf4.loc[gf4.index == LATEST_DATE, 'rolling_mean'])\n\ngf4s_by_state = pd.DataFrame(state_to_gf4).transpose()\ngf4s_by_state.columns=['gf4']\ngf4s_by_state.sort_values(by='gf4', ascending=False)","ff530e74":"wgf4_df = de.merge(gf4s_by_state, right_index=True, left_on='NAME_1').drop(['ID_0','ISO','NAME_0', 'ID_1', 'TYPE_1','ENGTYPE_1','NL_NAME_1','VARNAME_1'], axis=1)","ce77107e":"min_v, max_v = min_max(wgf4_df.gf4)\n\nplt.figure(figsize=(14,14))\ndivnorm = colors.TwoSlopeNorm(vmin=min_v,vcenter=1.0,vmax=max_v)\n\nax = plt.subplot(111, title = \"R eff\")\ngeoplot.choropleth(\n    wgf4_df, hue=wgf4_df.gf4,     \n    cmap='coolwarm', norm = divnorm, legend=True, ax=ax\n);","f35c2232":"DAYS_BEFORE=4","f0698831":"abs_growth_de = abs_growth_from(de_fed_by_date.groupby('date').sum()['confirmed'])","393ed866":"abs_growth_de_4days = abs_growth_de.rolling(4).sum()\nabs_growth_de_4days.iloc[-1]\/abs_growth_de_4days.iloc[-1-DAYS_BEFORE]","0a7783b1":"state_to_gf7 = {}\nfor fed in feds:\n    fed_by_date = de_fed_by_date[de_fed_by_date.label==fed].set_index('date')\n    abs_growth_fed_by_date =abs_growth_from(fed_by_date.confirmed)\n    abs_growth_fed_by_date_last7days = abs_growth_fed_by_date.rolling(7).sum()\n    state_to_gf7[fed] = abs_growth_fed_by_date_last7days.iloc[-1]\/abs_growth_fed_by_date_last7days.iloc[-1-DAYS_BEFORE]\n\ngf7s_by_state = pd.DataFrame(state_to_gf7, index=['gf7']).transpose().sort_values(by='gf7', ascending=False)\ngf7s_by_state","827530b2":"wgf7_df = de.merge(gf7s_by_state, right_index=True, left_on='NAME_1').drop(['ID_0','ISO','NAME_0', 'ID_1', 'TYPE_1','ENGTYPE_1','NL_NAME_1','VARNAME_1'], axis=1)","bf7b483d":"min_v, max_v = min_max(wgf7_df.gf7)\n\nplt.figure(figsize=(14,14))\ndivnorm = colors.TwoSlopeNorm(vmin=min_v,vcenter=1.0,vmax=max_v)\n\nax = plt.subplot(111, title = \"R7\")\ngeoplot.choropleth(\n    wgf7_df, hue=wgf7_df.gf7,     \n    cmap='coolwarm', norm = divnorm, legend=True, ax=ax\n);","9d19f350":"abs_growth_de_7days = abs_growth_de.rolling(7).sum()\nabs_growth_de_7days.iloc[-1]\/abs_growth_de_7days.iloc[-1-DAYS_BEFORE]","671c393e":"## R<sub>eff<\/sub> for Germany\n(registered in federation states only)","29026652":"#### Note\nAs in Germany it can take up to 7 (or even more) days until the case data are collected by the Robert Koch Institute (RKI), we use a rolling mean of the absolute growth over 7 days to calculate the growth factor:","d7b50773":"## Cases by Federation State","3d8a2d2c":"## R<sub>eff<\/sub> for the Single Federation States","a308140c":"**The statistics are from:**","a7045c54":"### German Federal States","6c4869d7":"### Fed Confirmed\/Active Cases per 10000 Inhabitants","15eac8d6":"## Sum over the last 7 days per State and per State and 100k Inhabitants","18aa3034":"# Corona Cases in Germany - Geo Analysis for Federation States - Hotspots","9a08efdc":"# Links\n\nFor a more detailed geographical case analysis please visit \n- the [Robert Koch-Institut: COVID-19-Dashboard](https:\/\/experience.arcgis.com\/experience\/478220a4c454480e823b17327b2bf1d4)\n- the [Infektionskarte of the Berliner Morgenpost](https:\/\/interaktiv.morgenpost.de\/corona-virus-karte-infektionen-deutschland-weltweit\/)\n\nMy further analyses notebooks can be found at\n- [COVID-19-Germany - Case Overview](https:\/\/www.kaggle.com\/pat777\/covid-19-germany-case-overview\/)\n- [COVID-19-Berlin](https:\/\/www.kaggle.com\/pat777\/covid-19-berlin)","cf0a2358":"## R<sub>7<\/sub> for Germany\n(registered in federation states only)","b41e84b4":"## German Data","ff3a10ba":"# Current State","11dbf6f8":"## Corona Data","3252dacd":"#### Sorted Growth Factors of the single federation states","34d5bbf3":"The plot of the **confirmed** cases per 100000 inhabitant shows, that Hamburg and Saarland are actually quite more effected than the absolute numbers would indicate.\n\nIn Hessen and Niedersachsen the situation seems to be quite better than the absolute numbers tell us.","7b5210f3":"Note: use HISTORY_DATA, because we need more dates for growth calculation","a503a9e0":"# Statistics","d3f4253e":"## Confirmed vs. Active Case in the single German Federation States\n\n`Active Cases = Confirmed Cases - (Recovered Cases + Death)`\n\nLets see, how many cases are actually still active and thus are still infectious and potentially have to be treated in the hospitals.\n\nAs the relative case rates per 100000 inhabitants tell us more about the actual burden, we will now compare the relative numbers instead of the absolute ones.","a467f4ba":"### Absolute Cases by Federation State","729eb8cb":"## Confirmed Case in the single German Federation States","8f97f7d2":"On base of the data the of the [Berliner Morgenpost](https:\/\/interaktiv.morgenpost.de\/corona-virus-karte-infektionen-deutschland-weltweit\/) this notebook analyzes \n- how the Corona spreads out currently in the german federation\n- what the current hotspots are\n- what most likely the upcoming hotspots will be\n\nIt therefore shows\n- how the absolute \n  - confirmed\n  - active \n  covid-19 cases are distributed among the german states\n- how the relative\n  - confirmed \n  - active\n  covid-19 cases per 100000 inhabitants are distributed among the german states.\n- how big the growth factor is in the single german states\n\n### Kudos ..\n\n... to the great Data Team of the [Berliner Morgenpost](https:\/\/interaktiv.morgenpost.de\/corona-virus-karte-infektionen-deutschland-weltweit\/), which tirelessly collects current case data and seems to be the best informed source in Germany!!! \n","2a5d31d1":"## Growth Factor 4 == R<sub>eff<\/sub> of RKI\n\n\n### Definition\nsee [Corona-Pandemie: Die Mathematik hinter den Reproduktionszahlen R](https:\/\/www.heise.de\/newsticker\/meldung\/Corona-Pandemie-Die-Mathematik-hinter-den-Reproduktionszahlen-R-4712676.html)\n\n`gf4 = Reff = (new infections on the 4 days([N-3,N])\/4) \/ (new infections on the 4 days([N-7,N-4])\/4)`","259a4759":"# R<sub>7<\/sub>: 7-days-R of RKI\n\n### Definition\n\n7-Tage-R an. Er vergleicht den 7-Tages-Mittelwert der Neuerkrankungen eines Tages mit dem 7-Tages-Mittelwert **vier** Tage zuvor.\n\n`gf7 = (new infections on the 7 days([N-6,N])\/7) \/ (new infections on the 7 days([N-10,N-4])\/7)`","94677b11":"# New Infections\n## New Infections Yesterday\n### New Infections Yesterday - Federal States","698e83b4":"### New Infections Yesterday - Germany","52fae6ca":"# Case Status Quo\n\n## Growth Factor\n\n\n### Definition\nThe growth factor on day N is the number of confirmed cases on day N minus confirmed cases on day N-1 divided by the number of confirmed cases on day N-1 minus confirmed cases on day N-2. (see also [notebook COVID-19-Germany - Case Overview](https:\/\/www.kaggle.com\/pat777\/covid-19-germany-case-overview)).\n\n`gf = (new infections on day(N) \/ (new infections day(N-1))`\n\n### Concept\nThe growth factor is related to the **reproductive number `R`** of the virus.\n\n![How the virus spreads with R0=2](https:\/\/cdn.newsapi.com.au\/image\/v1\/665b7257930b5c7c472ab0d03743dc42?width=650)\n\nThe idea behind `R` is, that in a would without any measurements (e.g. social distancing) against the virus, the number of infections grows with a basic reproductive number `R0`. For Corona we have `R0 ~ 2.3`, which means, that one person infects 2.3 other persons during his\/her infection. \n\nWith the time more people of the population have been already infected and can not be infected any more (which hopefully also applies to Corona). Also the German government ordered social distancing, thus the effectiv reproductive number `Re` decreases. \n\n**When `Re==1`, we have reached the inflection point:**<br>\nThis is the point, when 1 person only infects one other person during his\/her infection. Now the number of active case stays nearby constant (formula: `active cases = confirmed - (recovered+deaths)), so that e.g. the hospital capacity would not be overloaded (if the rate of intensive care patient keeps stable).\n\nWhen `Re < 1` the epedemic stops spreading.\n\n**Note:**<br>\nFor a more detailed explanation of the reproductive number and about how an epedemic can spread and end please refer to the following ingenious [article in the Washingtonpost](https:\/\/www.washingtonpost.com\/graphics\/2020\/health\/coronavirus-how-epidemics-spread-and-end\/)\n"}}