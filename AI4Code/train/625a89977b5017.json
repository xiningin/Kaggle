{"cell_type":{"b8c04f38":"code","e2919708":"code","5ff350b1":"code","f851886d":"code","08c51a79":"code","5fb3704c":"code","7d387cce":"code","7db1dbd6":"code","209d9548":"code","254a2def":"code","d1da156c":"code","f877e3ec":"code","c418d77e":"code","3a60496d":"code","ec3767da":"code","401b1f08":"code","09ea6a3c":"code","ad804b61":"code","39f8fcae":"code","a051cc81":"code","781717a4":"code","941b7e8f":"code","391591b8":"code","fb86b15b":"code","a4ab3c2b":"code","efd928c4":"code","a6070d8e":"code","c1aa1a7f":"code","ad217e4f":"code","cc2d07bf":"code","ce373556":"code","811b1201":"code","2cbce56a":"code","b1454f19":"code","fadb4734":"code","4400853b":"code","c73cb498":"code","7189cf91":"code","c0ee836a":"code","f759556f":"code","4a58c9c3":"code","41640e02":"code","248614a2":"code","cac84efc":"code","c45e1437":"code","55f381a4":"code","b7c782f8":"code","baf3d805":"code","167d42e7":"code","ac41c1dd":"code","aa68a099":"code","ed7f7047":"code","2e3b87bf":"code","74b7ec9d":"code","f5051aa8":"code","d52b8e08":"code","573a141c":"code","155c1000":"code","64328101":"code","e3496c83":"markdown","b610923d":"markdown","3e577d03":"markdown","84decc93":"markdown","e36beb06":"markdown","bc9de6e6":"markdown","37f6ca0c":"markdown","7425ecc6":"markdown","9638d4d9":"markdown","c56e4449":"markdown","438d2580":"markdown","9a69a655":"markdown"},"source":{"b8c04f38":"!pip show fastai","e2919708":"import numpy as np \nimport pandas as pd \nfrom fastai.vision import *\nfrom fastai.vision.models import *\n\n%matplotlib inline\nimport matplotlib.pyplot as plt\nimport seaborn as sn\nimport pickle\nimport csv\nimport glob\n\nfrom sklearn.metrics import confusion_matrix, classification_report\nimport tensorflow as tf\nfrom PIL import Image\n\nimport shutil, os","5ff350b1":"# SETUP\nMODEL=resnet50\nBATCH = 64\nSIZE = 320\n\nDATA_PATH = '..\/input\/'\nPATH = \"..\/working\/car\/\"","f851886d":"os.makedirs(PATH,exist_ok=False)\nRANDOM_SEED = 42\nnp.random.seed(RANDOM_SEED)","08c51a79":"def accuracy(preds, targs):\n    preds = torch.max(preds, dim=1)[1]\n    return (preds==targs).float().mean()","5fb3704c":"train_df = pd.read_csv(\"..\/input\/train.csv\")\ntest_df = pd.read_csv(\"..\/input\/sample.csv\")\ntrain_df.head()","7d387cce":"train_df.info()","7db1dbd6":"train_df.Category.value_counts()","209d9548":"# \u041f\u0440\u0438\u043c\u0435\u0440 \u043a\u0430\u0440\u0442\u0438\u043d\u043e\u043a\nfig, axs = plt.subplots(1,4,figsize=(15,10))\ni = 0\nfor ax in axs:\n    path_img = DATA_PATH+'train\/train\/'+str(i)\n    fnames = get_image_files(path_img)\n    im = open_image(fnames[0])\n    im.show(ax=ax, title=f'{i}')\n    i+=1","254a2def":"image = Image.open(DATA_PATH+'\/train\/train\/0\/100380.jpg')\nimgplot = plt.imshow(image)\nplt.show()\nimage.size","d1da156c":"#tfms = None\ntfms = get_transforms(max_zoom=1., max_warp=0.2, max_lighting=0.3,\n                     xtra_tfms=[cutout(n_holes=(1,20))]\n                     )","f877e3ec":"data = ImageDataBunch.from_folder(DATA_PATH, train=PATH+'train\/train\/', test='test\/test_upload\/',\n                                  ds_tfms=tfms, padding_mode='zeros',\n                                  valid_pct=0.1, size=SIZE, \n                                  classes=['0','1','2','3','4','5','6','7','8','9'],\n                                  bs=BATCH, num_workers=0).normalize(imagenet_stats)\ndata.path = pathlib.Path(PATH)  ## IMPORTANT for PyTORCH to create tmp directory which won't be otherwise allowed on Kaggle Kernel directory structure","c418d77e":"data","3a60496d":"data.show_batch(rows=4, figsize=(12,9))","ec3767da":"learn = cnn_learner(data, MODEL, metrics=accuracy, model_dir=PATH)","401b1f08":"learn.lr_find()\nlearn.recorder.plot()","09ea6a3c":"learn.fit_one_cycle(5, slice(5e-3))","ad804b61":"learn.recorder.plot_losses()\nlearn.recorder.plot_metrics()\nlearn.recorder.plot()","39f8fcae":"# Test Valid\naccuracy(*learn.get_preds())","a051cc81":"learn.save('stage-1-resnet50')","781717a4":"interp = ClassificationInterpretation.from_learner(learn)\ninterp.plot_top_losses(9, figsize=(15,11))","941b7e8f":"learn.unfreeze()","391591b8":"learn.lr_find()\nlearn.recorder.plot()","fb86b15b":"learn.fit_one_cycle(5, max_lr=slice(1e-7,1e-5),)\nlearn.recorder.plot()\nlearn.recorder.plot_losses()\nlearn.recorder.plot_metrics()","a4ab3c2b":"# Test Valid\naccuracy(*learn.get_preds())","efd928c4":"accuracy(*learn.TTA())","a6070d8e":"learn.freeze()","c1aa1a7f":"learn.save('stage-2-resnet50', return_path=True)","ad217e4f":"learn = cnn_learner(data, MODEL, metrics=accuracy, model_dir=PATH)\nlearn.unfreeze()","cc2d07bf":"learn.lr_find()\nlearn.recorder.plot()","ce373556":"learn.fit_one_cycle(30, max_lr=1e-4)\nlearn.recorder.plot()\nlearn.recorder.plot_losses()\nlearn.recorder.plot_metrics()","811b1201":"# Test Valid\naccuracy(*learn.get_preds())","2cbce56a":"accuracy(*learn.TTA())","b1454f19":"learn.freeze()\nlearn.save('stage-3-resnet50', return_path=True)","fadb4734":"learn.export()","4400853b":"submission = pd.read_csv('..\/input\/sample.csv')\nsubmission.shape","c73cb498":"submission.head()","7189cf91":"data.train_ds.x","c0ee836a":"data.test_ds.x","f759556f":"preds_test, _ = learn.get_preds(DatasetType.Test)","4a58c9c3":"preds_test[:10][0]","41640e02":"preds_test_s = pd.DataFrame(preds_test)\npreds_test_s.to_csv('preds_sub.csv', index=False)\npreds_test_s.shape","248614a2":"preds_test = np.argmax(preds_test, axis=1)\npreds_test = preds_test.numpy()","cac84efc":"preds_test.shape","c45e1437":"preds_test[:10]","55f381a4":"fnames = [f.name for f in learn.data.test_ds.items]\nsubmission = pd.DataFrame({'Id':fnames, 'Category':preds_test}, columns=['Id', 'Category'])","b7c782f8":"submission.to_csv('submission_v23.csv', index=False)","baf3d805":"submission.head()","167d42e7":"preds_test_tta, _ = learn.TTA(ds_type=DatasetType.Test)\n#preds_test_tta_2, = learn.TTA(ds_type=DtasetType.Test)[0]","ac41c1dd":"preds_test_tta_s = pd.DataFrame(preds_test_tta)\npreds_test_tta_s.to_csv('preds_tta_sub.csv', index=False)\npreds_test_tta_s.shape","aa68a099":"preds_test_tta = np.argmax(preds_test_tta, axis=1)\npreds_test_tta = preds_test_tta.numpy()","ed7f7047":"print(preds_test_tta[:15])","2e3b87bf":"fnames = [f.name for f in learn.data.test_ds.items]\nsubmission = pd.DataFrame({'Id':fnames, 'Category':preds_test_tta}, columns=['Id', 'Category'])","74b7ec9d":"submission['Category'] = preds_test_tta\nsubmission.to_csv('tta_submission_v23.csv', index=False)","f5051aa8":"submission.head()","d52b8e08":"print(os.listdir(PATH))","573a141c":"shutil.copy2( PATH+'export.pkl', '..\/working\/export.pkl')","155c1000":"shutil.rmtree(PATH)","64328101":"print(os.listdir('..\/working\/'))","e3496c83":"# \u041f\u043e\u043f\u0440\u043e\u0431\u0443\u0435\u043c \u0441\u0440\u0430\u0437\u0443 \u0440\u0430\u0437\u043c\u043e\u0440\u043e\u0437\u0438\u0442\u044c \u0432\u0435\u0441\u0430","b610923d":"# \u041e\u0431\u0443\u0447\u0438\u043c \u0441\u0442\u0430\u043d\u0434\u0430\u0440\u0442\u043d\u0443\u044e \u043c\u043e\u0434\u0435\u043b\u044c resnet50 \u043f\u0440\u0435\u0434\u043e\u0431\u0443\u0447\u0435\u043d\u0443\u044e \u043d\u0430 imagenet","3e577d03":"## unfreeze layers","84decc93":"# Car classification\n![](http:\/\/img1.joyreactor.cc\/pics\/post\/\u0430\u0432\u0442\u043e\u043f\u0440\u043e\u043c-\u0432\u0430\u0437-\u043b\u0438\u043c\u0443\u0437\u0438\u043d-\u0432\u0430\u0442\u0435\u0440\u043c\u0430\u0440\u043a-351083.jpeg)","e36beb06":"## \u041d\u0430\u043c \u043d\u0443\u0436\u043d\u043e \u043f\u0440\u0435\u0434\u0441\u043a\u0430\u0437\u0430\u0442\u044c **\u043c\u0430\u0440\u043a\u0443 \u0430\u0432\u0442\u043e\u043c\u043e\u0431\u0438\u043b\u044f** \u043d\u0430\u0440\u043e\u0434\u043d\u043e\u0433\u043e \u0430\u0432\u0442\u043e\u043f\u0440\u043e\u043c\u0430)\n![](http:\/\/admem.ru\/content\/images\/1391000424.jpg)**","bc9de6e6":"![](http:\/\/www.ccri.com\/wp-content\/uploads\/2017\/05\/stackMoreLayers.png)","37f6ca0c":"## Submit TTA","7425ecc6":"\u041c\u043e\u0436\u043d\u043e \u043b\u0443\u0447\u0448\u0435 - \u044f \u0437\u043d\u0430\u044e) \u043f\u043e\u043f\u0440\u043e\u0431\u0443\u0435\u043c \u0440\u0430\u0437\u043c\u043e\u0440\u043e\u0437\u0438\u0442\u044c \u0432\u0435\u0441\u0430","9638d4d9":"## Save model & CleanUP","c56e4449":"# Submit","438d2580":"## **\u0412 \u042d\u0442\u043e\u043c \u043d\u043e\u0443\u0442\u0431\u0443\u043a\u0435 \u043f\u043e\u043a\u0430\u0436\u0443 \u043f\u0440\u0438\u043c\u0435\u0440 \u043f\u043e\u0441\u0442\u0440\u043e\u0435\u043d\u0438\u044f \u0431\u044b\u0441\u0442\u0440\u043e\u0433\u043e \u0440\u0435\u0448\u0435\u043d\u0438\u044f.**\n\n\u041e\u0441\u043d\u043e\u0432\u044b\u0432\u0430\u0435\u0442\u0441\u044f \u043d\u0430 \u043b\u0438\u0431\u0435 [Fast.ai](https:\/\/www.fast.ai) \u0443 \u043a\u043e\u0442\u043e\u0440\u043e\u0439 \u043f\u043e\u0434 \u043a\u0430\u043f\u043e\u0442\u043e\u043c PyTorch.\n\u042d\u0442\u0430 \u043b\u0438\u0431\u0430 \u044f\u0432\u043b\u044f\u0435\u0442\u0441\u044f \u043a\u0430\u043a \u0431\u044b \u0434\u043e\u043f\u043e\u043b\u043d\u0435\u043d\u0438\u0435\u043c \u043a \u043a\u0443\u0440\u0441\u0443 \u043f\u043e NN \u043e\u0442 Jeremy Howard, [\u043a\u0441\u0442\u0430\u0442\u0438 \u0440\u0435\u043a\u043e\u043c\u0435\u043d\u0434\u0443\u044e \u043a \u043e\u0437\u043d\u0430\u043a\u043e\u043c\u043b\u0435\u043d\u0438\u044e](https:\/\/course.fast.ai\/videos\/?lesson=1) \u043f\u043e\u0441\u043b\u0435 \u043d\u0435\u0433\u043e \u0441\u0442\u0430\u043d\u043e\u0432\u0438\u0442\u044c\u0441\u044f \u043f\u043e\u043d\u044f\u0442\u043d\u0435\u0439 \u0434\u043b\u044f \u0447\u0435\u0433\u043e \u0442\u0435 \u0438\u043b\u0438 \u0438\u043d\u044b\u0435 \"\u043c\u0430\u0433\u0438\u0447\u0435\u0441\u043a\u0438\u0435 \u0437\u0430\u043a\u043b\u0438\u043d\u0430\u043d\u0438\u044f\".\n\n\u0435\u0435 **\u041f\u043b\u044e\u0441\u044b:**\n+ \u0431\u044b\u0441\u0442\u0440\u044b\u0439 \u0441\u0442\u0430\u0440\u0442\n+ \u043c\u0438\u043d\u0438\u043c\u0443\u043c \u043a\u043e\u0434\u0430\n+ \u0432\u0441\u0442\u0440\u043e\u0435\u043d\u044b \u0438\u043d\u0442\u0435\u0440\u0435\u0441\u043d\u044b\u0435 \u044d\u0432\u0440\u0438\u0441\u0442\u0438\u043a\u0438 \u0438 \u043c\u0435\u0442\u043e\u0434\u044b\n+ \u043d\u0435\u043f\u043b\u043e\u0445\u043e\u0439 \u0440\u0435\u0437\u0443\u043b\u044c\u0442\u0430\u0442\n+ \u0433\u043e\u0442\u043e\u0432\u044b\u0435 \u043a\u0440\u0430\u0441\u0438\u0432\u044b\u0435 \u0433\u0440\u0430\u0444\u0438\u043a\u0438, \u043c\u0435\u0442\u0440\u0438\u043a\u0438 \u0438 \u043f\u0440\u043e\u0447\u0438\u0435 \u043f\u043b\u044e\u0448\u043a\u0438\n\n**\u041c\u0438\u043d\u0443\u0441\u044b:**\n- \u0435\u0441\u043b\u0438 \u0442\u0435\u0431\u0435 \u043d\u0443\u0436\u043d\u043e \u0447\u0442\u043e-\u0442\u043e, \u0447\u0442\u043e \u043d\u0435\u0442 \u0432 \u0441\u0442\u0430\u043d\u0434\u0430\u0440\u0442\u043d\u043e\u043c \u043f\u0440\u0438\u043c\u0435\u0440\u0435 \u043d\u043e\u0443\u0442\u0431\u0443\u043a\u0430, \u0442\u043e \u043b\u0443\u0447\u0448\u0435 \u0441\u0440\u0430\u0437\u0443 \u0438\u0434\u0442\u0438 \u043f\u0438\u0441\u0430\u0442\u044c \u0441\u0432\u043e\u0435 \u0440\u0435\u0448\u0435\u043d\u0438\u044f \u043d\u0430 PyTorch \u0438\u043b\u0438 Keras\n- \u043f\u043b\u043e\u0445\u0430\u044f \u0434\u043e\u043a\u0430 (\u043d\u0430\u0448\u0435\u043b [\u043d\u0435 \u043e\u0444\u0438\u0446\u0430\u043b\u044c\u043d\u0443\u044e](https:\/\/alexiej.github.io\/deepnn\/#basic-functions-2), \u043e\u043d\u0430 \u0438 \u0442\u043e \u043b\u0443\u0447\u0448\u0435)\n- \u043d\u0435 \u0441\u0442\u0430\u0431\u0438\u043b\u044c\u043d\u0430 \u0438 \u043c\u043d\u043e\u0433\u043e \u0431\u0430\u0433\u043e\u0432\n- \u0437\u0430\u043f\u0443\u0442\u0430\u043d\u043d\u044b\u0439 \u043a\u043e\u0434\n- \u043f\u043e\u0441\u0442\u043e\u044f\u043d\u043d\u043e \u043c\u0435\u043d\u044f\u0435\u0442\u0441\u044f (\u0432\u043e\u0437\u043c\u043e\u0436\u043d\u043e \u043f\u043e\u043a\u0430 \u0432\u044b \u044d\u0442\u043e \u0447\u0438\u0442\u0430\u0435\u0442\u0435, \u043a\u043e\u0434 \u0443\u0436\u0435 \u0443\u0441\u0442\u0430\u0440\u0435\u043b \u0438 \u0443 \u0432\u0430\u0441 \u043e\u043d \u043d\u0435 \u0437\u0430\u043f\u0443\u0441\u0442\u0438\u0442\u044c\u0441\u044f :) )\n- \u0440\u0435\u0437\u0443\u043b\u044c\u0442\u0430\u0442 \u043c\u043e\u0436\u043d\u043e \u043f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u043b\u0443\u0447\u0448\u0435 \u0435\u0441\u043b\u0438 \u0441\u043e\u0431\u0438\u0440\u0430\u0442\u044c \u0438 \u0442\u044e\u043d\u0438\u0442\u044c \u0441\u0432\u043e\u0435\n\n\n**\u0421\u0443\u043c\u043c\u0438\u0440\u0443\u044f - \u042d\u0442\u043e \u043d\u0435 \u043f\u043b\u043e\u0445\u0430\u044f \u043b\u0438\u0431\u0430 \u0434\u043b\u044f \u0431\u044b\u0441\u0442\u0440\u043e\u0433\u043e \u043f\u0440\u043e\u0442\u043e\u0442\u0438\u043f\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u044f \u043f\u043e \u0433\u043e\u0442\u043e\u0432\u043e\u043c\u0443 \u043d\u043e\u0443\u0442\u0431\u0443\u043a\u0443 \u0441 \u0434\u043e\u0441\u0442\u0430\u0442\u043e\u0447\u043d\u043e \u043d\u0435 \u043f\u043b\u043e\u0445\u0438\u043c \u0440\u0435\u0437\u0443\u043b\u044c\u0442\u0430\u0442\u043e\u043c \u043d\u0430 '\u0445\u043e\u043b\u043e\u0434\u043d\u043e\u043c' \u0441\u0442\u0430\u0440\u0442\u0435.**\n\n\u041f\u043e\u0435\u0445\u0430\u043b\u0438!\n\n\n","9a69a655":"## \u0418\u043d\u0442\u0435\u0440\u0435\u0441\u043d\u043e, \u043a \u043a\u0430\u043a\u043e\u043c\u0443 \u043a\u043b\u0430\u0441\u0441\u0443 \u043c\u043e\u0434\u0435\u043b\u044c \u043e\u0442\u043d\u0435\u0441\u0435\u0442 \u0432\u043e\u0442 \u044d\u0442\u043e\u0442 \u0430\u0432\u0442\u043e:\n![](http:\/\/kvu.su\/upload\/iblock\/e3a\/e3a32ed064fd71e4ce99b7f57d2de745.jpg)"}}