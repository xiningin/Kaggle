{"cell_type":{"0dfcaa52":"code","cb1523ec":"code","93a2dc57":"code","bb951d54":"code","09344169":"code","7f54f0ad":"code","05d66d79":"code","adf79dcb":"code","4352dcd0":"code","b1846251":"code","4397682e":"code","972359c0":"code","96291538":"code","94f1a055":"markdown","56266fe7":"markdown","c20db3c1":"markdown","a1eecfef":"markdown","07e847a1":"markdown","1cb3288a":"markdown","b61bcfe3":"markdown","09ee327b":"markdown","eaa8d5ab":"markdown","f2240905":"markdown","cdfc5da9":"markdown","885a3db2":"markdown","90f0ca44":"markdown","d54e47aa":"markdown","db3ce008":"markdown","1d32d69b":"markdown","c56f38e0":"markdown"},"source":{"0dfcaa52":"# Input data files are available in the \"..\/input\/\" directory.\n\nimport numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\nimport matplotlib.pyplot as plt\n%matplotlib inline\n\n# For example, running this (by clicking run or pressing Shift+Enter) will list all files under the input directory\n\nimport os\nfor dirname, _, filenames in os.walk('\/kaggle\/input'):\n    for filename in filenames:\n        print(os.path.join(dirname, filename))\n\n# Any results you write to the current directory are saved as output.\n\n","cb1523ec":"global_data = pd.read_csv(\"\/kaggle\/input\/covid19-global-forecasting-week-1\/train.csv\")\nglobal_data.head()","93a2dc57":"# This functions smooths data, thanks to Dan Pearson. We will use it to smooth the data for growth factor.\ndef smoother(inputdata,w,imax):\n    data = 1.0*inputdata\n    data = data.replace(np.nan,1)\n    data = data.replace(np.inf,1)\n    #print(data)\n    smoothed = 1.0*data\n    normalization = 1\n    for i in range(-imax,imax+1):\n        if i==0:\n            continue\n        smoothed += (w**abs(i))*data.shift(i,axis=0)\n        normalization += w**abs(i)\n    smoothed \/= normalization\n    return smoothed\n\ndef growth_factor(confirmed):\n    confirmed_iminus1 = confirmed.shift(1, axis=0)\n    confirmed_iminus2 = confirmed.shift(2, axis=0)\n    return (confirmed-confirmed_iminus1)\/(confirmed_iminus1-confirmed_iminus2)\n\ndef growth_ratio(confirmed):\n    confirmed_iminus1 = confirmed.shift(1, axis=0)\n    return (confirmed\/confirmed_iminus1)\n\n# This is a function which plots (for in input country) the active, confirmed, and recovered cases, deaths, and the growth factor.\ndef plot_country_active_confirmed_recovered(country):\n    \n    # Plots Active, Confirmed, and Recovered Cases. Also plots deaths.\n    country_data = global_data[global_data['Country\/Region']==country]\n    table = country_data.drop(['Id','Province\/State', 'Lat','Long'], axis=1)\n\n    table2 = pd.pivot_table(table, values=['ConfirmedCases','Fatalities'], index=['Date'], aggfunc=np.sum)\n    table3 = table2.drop(['Fatalities'], axis=1)\n   \n    # Growth Factor\n    w = 0.5\n    table2['GrowthFactor'] = growth_factor(table2['ConfirmedCases'])\n    table2['GrowthFactor'] = smoother(table2['GrowthFactor'],w,5)\n\n    # 2nd Derivative\n    table2['2nd_Derivative'] = np.gradient(np.gradient(table2['ConfirmedCases'])) #2nd derivative\n    table2['2nd_Derivative'] = smoother(table2['2nd_Derivative'],w,7)\n\n\n    #Plot confirmed[i]\/confirmed[i-1], this is called the growth ratio\n    table2['GrowthRatio'] = growth_ratio(table2['ConfirmedCases'])\n    table2['GrowthRatio'] = smoother(table2['GrowthRatio'],w,5)\n    \n    #Plot the growth rate, we will define this as k in the logistic function presented at the beginning of this notebook.\n    table2['GrowthRate']=np.gradient(np.log(table2['ConfirmedCases']))\n    table2['GrowthRate'] = smoother(table2['GrowthRate'],0.5,3)\n    \n    # horizontal line at growth rate 1.0 for reference\n    x_coordinates = [1, 100]\n    y_coordinates = [1, 1]\n    #plots\n    table2['Fatalities'].plot(title='Fatalities')\n    plt.show()\n    table3.plot() \n    plt.show()\n    table2['GrowthFactor'].plot(title='Growth Factor')\n    plt.plot(x_coordinates, y_coordinates) \n    plt.show()\n    table2['2nd_Derivative'].plot(title='2nd_Derivative')\n    plt.show()\n    table2['GrowthRatio'].plot(title='Growth Ratio')\n    plt.plot(x_coordinates, y_coordinates)\n    plt.show()\n    table2['GrowthRate'].plot(title='Growth Rate')\n    plt.show()\n\n\n    return \n","bb951d54":"plot_country_active_confirmed_recovered('China')","09344169":"plot_country_active_confirmed_recovered('US')\n","7f54f0ad":"plot_country_active_confirmed_recovered('Germany')","05d66d79":"plot_country_active_confirmed_recovered('Italy')","adf79dcb":"restofworld_data = global_data\nfor country in restofworld_data['Country\/Region']:\n    if country != 'China': \n        restofworld_data['Country\/Region'] = restofworld_data['Country\/Region'].replace(country, \"RestOfWorld\")\n\nplot_country_active_confirmed_recovered('RestOfWorld')","4352dcd0":"world_data = global_data\n\nworld_data['Country\/Region'] = restofworld_data['Country\/Region'].replace(country, \"World Data\")\n\nplot_country_active_confirmed_recovered('World Data')","b1846251":"from scipy.optimize import curve_fit\n","4397682e":"# We want number of confirmed for each date for each country\n#country_data = global_data[global_data['Country\/Region']=='Mainland China']\nglobal_data = pd.read_csv(\"\/kaggle\/input\/covid19-global-forecasting-week-1\/train.csv\")\ncountry_data = global_data[global_data['Country\/Region']=='Italy']\ncountry_data = country_data.drop(['Id','Province\/State', 'Lat','Long'], axis=1)\ncountry_data = pd.pivot_table(country_data, values=['ConfirmedCases','Fatalities'], index=['Date'], aggfunc=np.sum)\ncountry_data.tail()","972359c0":"#country_data['GrowthFactor'] = growth_factor(country_data['Confirmed'])\n\n# we will want x_data to be the number of days since first confirmed and the y_data to be the confirmed data. This will be the data we use to fit a logistic curve\nx_data = range(len(country_data.index))\ny_data = country_data['ConfirmedCases']\n\ndef log_curve(x, k, x_0, ymax):\n    return ymax \/ (1 + np.exp(-k*(x-x_0)))\n\n# Fit the curve\npopt, pcov = curve_fit(log_curve, x_data, y_data, bounds=([0,0,0],np.inf), maxfev=1000)\nestimated_k, estimated_x_0, ymax= popt\n\n\n# Plot the fitted curve\nk = estimated_k\nx_0 = estimated_x_0\ny_fitted = log_curve(x_data, k, x_0, ymax)\nprint(k, x_0, ymax)\n#print(y_fitted)\ny_data.tail()","96291538":"# Plot everything for illustration\nfig = plt.figure()\nax = fig.add_subplot(111)\nax.plot(x_data, y_fitted, '--', label='fitted')\nax.plot(x_data, y_data, 'o', label='Confirmed Data')\n","94f1a055":"### Notice that this predicts Italy hits the inflection point is around day 51 and the number of confirmed cases will max out around 119,874 cases.","56266fe7":"## Germany","c20db3c1":"## Italy","a1eecfef":"\n\n* Define Active Cases as Confirmed minus Recovered minus Deaths.\n* Drop SNo, Province\/State, and Last Update.\n* Plot Active, Confirmed, and Recovered Cases, Deaths, Growth Factor, 2nd_Derivative, and Growth Ratio\n\nThe **growth factor** on day N is the number of confirmed cases on day N minus confirmed cases on day N-1 divided by the number of confirmed cases on day N-1 minus confirmed cases on day N-2.\n\nThe **growth ratio** on day N is the number of confirmed cases on day N divided by the number of confirmed cases on day N-1.\n\nSpecial thanks to Dan Pearson for the smoother function.","07e847a1":"# **Logistic Curve Fitting**\n\nNow that things are smooth, we can fit :-)\n\nWe are going to use scipy.optimize.curve_fit to fit a logistic curve to the number of confirmed cases in China and South Korea.","1cb3288a":"## China","b61bcfe3":"\n## Smoothed vs Unsmoothed Growth Factor\n\nThe growth factor we see above for Rest Of World is smoothed, just for illustration, let's look at smoothed vs unsmoothed.\n\nThe orange plot is the unsmoothed growth factor data for all countries except for china, the blue is the smoothed data. Smoothed data is essentially a weighted average, you can see how we define it above.\n\n![SmoothedVsUnsmoothedGF.png](attachment:SmoothedVsUnsmoothedGF.png)","09ee327b":"# **The Math: Exponential vs Logistic**\n\n### The spread of infectious disease can be modeled using a logistic curve rather than an exponential curve. The growth starts exponentially, but must slow down after some point called the **inflection point**. The inflection point is essentially the midpoint of the spread. We will model the number of confirmed cases using a logistic curve. Let's look at the equation for such a curve, the differential equation for which this curve is a solution, and the graph of the curve.\n\n## Logistic Curve Graph\n\n![LogCurve.png](attachment:LogCurve.png)\n\n## Logistic Function\n\n### A **logistic function** or **logistic curve** is an equation of the form: ![LogisticFunction.png](attachment:LogisticFunction.png)\n### where\n\n### * x_0 = the inflection point,\n### * N = the curve's maximum value, and\n### * k = growth rate or steepness of the curve.\n\nFor reference: https:\/\/en.wikipedia.org\/wiki\/Logistic_function.\n### Actually, the logistic function is just a solution for the following first-order, non-linear ordinary differential equation where f(0) = 0.5: ![LogisticEquation.png](attachment:LogisticEquation.png)\n\n### From the differential equation, stability of solutions and equilibria can be explored. However, let's keep things simple for now and just look at the growth metrics.\n","eaa8d5ab":"## Import Data","f2240905":"Let's now compare China with the rest of the world.","cdfc5da9":"We see a dramatic decrease in growth ratio and growth factor for china, until it stabilizes around 1.0.\n\nWhat's also interesting is that we see that China's confirmed curve and recovered curve already resemble a logistic curve. We should be able to estimate an inflection point for China, and as you will see South Korea. We can maybe then use these to build a model to predict countries like Italy, Germany, Spain, and the United States. Future versions of this kernel will explore this.","885a3db2":"## **Logistic Curve Fitting Confirmed Cases **\n\nPlease watch the following 9-minute video on exponential growth and the spread of disease...https:\/\/www.youtube.com\/watch?v=Kas0tIxDvrg\n","90f0ca44":"# We see here that this predicts that Italy is currently near it's inflection point and should max out around 119,874 confirmed cases. For China and South Korea, the curve underestimated. So this is probably also the case here. Furthermore, for some countries, it is too early to use this method to get a reasonable estimate. For example it is too early for India and the US. *As of March 23nd.","d54e47aa":"# **The Analysis**\n\n### Now that we have seen the math, let's explore the following growth metrics for the confirmed cases for each country:\n### * Growth Factor\n### * Growth Ratio\n### * Growth Rate\n### * 2nd Derivative\n\n### We will use these growth metrics to gain insight into which countries may have already hit their inflection points. For example, if a country's growth factor has stabilized around 1.0 then this can be a sign that that country has reached it's inflection point. We will then use curve fitting to fit a logistic curve (similar to the one above) to the number of confirmed cases for each country. This may help us predict if a country has hit their inflection point, and therefore when they will reach a possible maximum number of confirmed cases.\n\n### **Interestingly, the growth factor just tells us the curvature (from Calculus!) of the data.** If we take our data and take the 2nd derivative, basically all it is telling us is whether the cases are growing at an accelerating or decelerating rate. From calculus you may remember we use the 2nd derivative test to test for concavity and find saddle points. The inflection point is where the curve changes concavity. We can look at these growth metrics\n\n### The bigger picture will be to correlate this with preventative efforts such as quarentines, closing of schools, etc. It will also be interesting to see growth factor as a feature in a ML prediction model. I plan on working on this shortly.","db3ce008":"## US","1d32d69b":"## Rest of the World","c56f38e0":"## World data"}}