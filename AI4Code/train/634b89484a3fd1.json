{"cell_type":{"1b41e121":"code","fac7e01d":"code","34018f7f":"code","2a68a403":"code","72fe325a":"code","3118744b":"code","b3d9dd92":"code","cc567f72":"code","a5cac29f":"markdown","4a613c93":"markdown","9e775917":"markdown","b9d65370":"markdown"},"source":{"1b41e121":"import numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\nimport cv2\nimport os\nimport tensorflow as tf\nimport matplotlib.pyplot as plt\nimport seaborn as sns\nfrom sklearn.model_selection import StratifiedKFold, KFold\nfrom tqdm.autonotebook import tqdm\nimport random","fac7e01d":"ROOT_DIR = '..\/input\/cassava-leaf-disease-classification'\nHEIGHT, WIDTH = 512, 512","34018f7f":"def seed_everything(seed=0):\n    random.seed(seed)\n    np.random.seed(seed)\n    tf.random.set_seed(seed)\n    os.environ['PYTHONHASHSEED'] = str(seed)\n    os.environ['TF_DETERMINISTIC_OPS'] = '1'\n\nSEED = 0\nN_TRAINFILES = 50\nN_FOLDS = 5\nseed_everything(SEED)","2a68a403":"train_df = pd.read_csv(os.path.join(ROOT_DIR, 'train.csv'))\ntrain_df.head()","72fe325a":"train_df['label'].value_counts()","3118744b":"sns.countplot(x='label', data=train_df)","b3d9dd92":"# The following functions can be used to convert a value to a type compatible\n# with tf.train.Example.\n\ndef _bytes_feature(value):\n    \"\"\"Returns a bytes_list from a string \/ byte.\"\"\"\n    if isinstance(value, type(tf.constant(0))):\n        value = value.numpy() # BytesList won't unpack a string from an EagerTensor.\n    return tf.train.Feature(bytes_list=tf.train.BytesList(value=[value]))\n\ndef _float_feature(value):\n    \"\"\"Returns a float_list from a float \/ double.\"\"\"\n    return tf.train.Feature(float_list=tf.train.FloatList(value=[value]))\n\ndef _int64_feature(value):\n    \"\"\"Returns an int64_list from a bool \/ enum \/ int \/ uint.\"\"\"\n    return tf.train.Feature(int64_list=tf.train.Int64List(value=[value]))\n\ndef serialize_example(image, image_name, target):\n    feature = {\n        'image': _bytes_feature(image),\n        'image_name': _bytes_feature(image_name),\n        'target': _int64_feature(target)\n    }\n    # Create a Features message using tf.train.Example.\n\n    example_proto = tf.train.Example(features=tf.train.Features(feature=feature))\n    return example_proto.SerializeToString()\n","cc567f72":"# Create file for training\nskf = StratifiedKFold(n_splits=N_TRAINFILES, shuffle=True, random_state=SEED)\nidx_os = [] \nfor fold, (train_idx, test_idx) in tqdm(enumerate(skf.split(train_df, train_df['label']))):\n    filename = 'ld_train{:02d}-{}.tfrec'.format(fold, len(test_idx))\n#     idx_os.append(test_idx)\n    with tf.io.TFRecordWriter(filename) as writer:\n        for item in test_idx:\n            image_name = train_df.loc[item]['image_id']\n            image = cv2.imread(os.path.join(ROOT_DIR, 'train_images', image_name))\n            image = cv2.resize(image, (HEIGHT, WIDTH))\n            image = cv2.imencode('.jpg', image, (cv2.IMWRITE_JPEG_QUALITY, 100))[1].tostring()\n            target = train_df.loc[item]['label']\n            example = serialize_example(image, image_name.encode(), target)\n            writer.write(example)\n    fold_df = train_df.loc[test_idx]\n    for c in [0, 1, 2, 4]:\n        class_imgnames = fold_df[fold_df['label']==c]['image_id'].values\n        filename = 'class{}_{:02d}-{}.tfrec'.format(c, fold, len(class_imgnames))\n        with tf.io.TFRecordWriter(filename) as writer:\n            for image_name in class_imgnames:\n                image = cv2.imread(os.path.join(ROOT_DIR, 'train_images', image_name))\n                image = cv2.resize(image, (HEIGHT, WIDTH))\n                image = cv2.imencode('.jpg', image, (cv2.IMWRITE_JPEG_QUALITY, 100))[1].tostring()\n                target = c\n                example = serialize_example(image, image_name.encode(), target)\n                writer.write(example)","a5cac29f":"### Write to tfrecord files","4a613c93":"## Label distribution","9e775917":"## Oversample","b9d65370":"Some basic ideas are credited to [DimitreOliveira](https:\/\/www.kaggle.com\/dimitreoliveira) for this [notebook](https:\/\/www.kaggle.com\/dimitreoliveira\/cassava-leaf-disease-stratified-tfrecords-256x256), please upvote it also if you like."}}