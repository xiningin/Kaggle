{"cell_type":{"f24cccd4":"code","c18ab8cc":"code","4053c718":"code","637cd0f9":"code","ebf81b99":"code","e4f01ce4":"code","3613a6c1":"code","c5fa5576":"code","3de086af":"code","a3da09f3":"markdown"},"source":{"f24cccd4":"import os\nimport pandas as pd\nimport numpy as np\nimport matplotlib.pyplot as plt\nfrom sklearn.metrics.pairwise import cosine_similarity","c18ab8cc":"train = pd.read_csv('..\/input\/ventilator-pressure-prediction\/train.csv')\ntrain['RC'] = train['R'].astype(str) + '_' + train['C'].astype(str)","4053c718":"# breath_id \u00d7 u_in(0 - 79)\ntrain['num'] = train.groupby(['breath_id', 'RC']).cumcount()\nu_in_table = pd.pivot_table(train, index=['breath_id', 'RC'], columns='num', values='u_in')\nu_in_table = u_in_table.reset_index()","637cd0f9":"def search_similar_id(target_id, th):\n    \"\"\"\n    Find a breath_id with a similar u_in pattern.\n\n    Parameters\n    ----------\n    target_id : int\n        Target breath_id\n    th : float\n        Cosine similarity threshold\n\n    Returns\n    -------\n    similar_id : list\n        List of ids with similar patterns\n    \"\"\"\n    \n    if target_id in u_in_table['breath_id'].tolist():\n        target_rc = u_in_table[u_in_table['breath_id']==target_id]['RC'].values[0]\n        target_vec = u_in_table[u_in_table['breath_id']==target_id].to_numpy()[:,2:]\n\n        refer_table = u_in_table[(u_in_table['RC']==target_rc) & (u_in_table['breath_id']!=target_id)].reset_index(drop=True)\n        refer_vec = refer_table.to_numpy()[:,2:]\n        breaths = refer_table['breath_id'].unique().tolist()\n        breath_map = {i:b for i,b in enumerate(breaths)}\n\n        cs = cosine_similarity(target_vec, refer_vec)[0]\n        similar_idx = list(np.where(cs>th)[0])\n        similar_id = [breath_map[i] for i in similar_idx]\n    \n    else:\n        similar_id = []\n        \n    return similar_id","ebf81b99":"def viz_similar_id(target_id, th=0.999):\n    \"\"\"\n    Visualize and compare u_in and pressure of breath_id with similar patterns.\n\n    Parameters\n    ----------\n    target_id : int\n        Target breath_id\n    th : float\n        Cosine similarity threshold\n    \"\"\"\n    rc = u_in_table[u_in_table['breath_id']==target_id]['RC'].values[0]\n    similar_ids = search_similar_id(target_id, th)\n    viz_id = [target_id] + similar_ids\n    \n    fig, axes = plt.subplots(figsize=(16, 9), nrows=2,sharex=True)\n    for id_ in viz_id:\n        tmp = train[train['breath_id']==id_].copy()\n        axes[0].plot(tmp['time_step'], tmp['u_in'], label='breath_id : ' + str(id_))\n        axes[1].plot(tmp['time_step'], tmp['pressure'], label='breath_id : ' + str(id_))\n        axes[0].legend(loc='upper right')\n        axes[0].grid(color='g', linestyle=':', linewidth=0.3)\n        axes[0].set_title('u_in')\n        axes[1].legend(loc='upper right')\n        axes[1].grid(color='g', linestyle=':', linewidth=0.3)\n        axes[1].set_title('pressure')\n        fig.suptitle(f'target_id : {target_id}  (RC={rc})')","e4f01ce4":"viz_similar_id(target_id=1)","3613a6c1":"viz_similar_id(target_id=5)","c5fa5576":"viz_similar_id(target_id=2)","3de086af":"viz_similar_id(target_id=2, th=0.998)","a3da09f3":"# searching similar u_in using cosine similarity\nThere are many u_in with very similar shapes.  \nHere, I will use **cosine similarity** to get breath_ids with similar u_in patterns   \nand compare their u_in and pressure.  \n\n[References]  \nhttps:\/\/www.kaggle.com\/marutama\/eda-about-u-in   \n@marutama 's great EDA notebook"}}