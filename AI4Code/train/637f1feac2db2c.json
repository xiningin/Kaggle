{"cell_type":{"6abe5099":"code","d535b36f":"code","053f941d":"code","9f5383d0":"code","3a1ce1f3":"code","f1e226fa":"code","1c713238":"code","57daba09":"code","f0bdbee9":"code","9e6cf99d":"code","594dc7cb":"code","a4cee7ba":"code","f137acd4":"code","9d2c4041":"code","3627488a":"code","56020434":"code","25683cf7":"code","92de8579":"code","43e3b7c8":"code","ad8fc748":"code","a275d67d":"code","d2a9cb2d":"code","0601b05a":"code","9ad2f751":"code","8453a9a8":"code","35cdf900":"markdown","44aff701":"markdown","587f178f":"markdown","04b1e214":"markdown","3064b15e":"markdown","afb309f2":"markdown","e2be2180":"markdown","dba45b6f":"markdown","8cad036e":"markdown","9ca94b67":"markdown","09ec9471":"markdown","51066d53":"markdown","abb21391":"markdown","817a7e56":"markdown","60c21a64":"markdown","3e97e5a0":"markdown","34df4f7d":"markdown","71eb0a7c":"markdown","2c1c2b6f":"markdown","dfc3ddb1":"markdown","5aff7be8":"markdown"},"source":{"6abe5099":"import numpy as np \nimport pandas as pd \nimport pyarrow.parquet as pq\nimport glob\n\nimport os\nimport matplotlib.pyplot as plt\nimport seaborn as sns\nimport warnings\nwarnings.filterwarnings('ignore')","d535b36f":"# load data\ntrain = pd.read_csv(\"..\/input\/optiver-realized-volatility-prediction\/train.csv\", header = 0)\ntrain.head()","053f941d":"book_filepath = \"\/kaggle\/input\/optiver-realized-volatility-prediction\/book_train.parquet\"\ntrade_filepath = \"\/kaggle\/input\/optiver-realized-volatility-prediction\/trade_train.parquet\"\n\n# get filenames in book and trade files\nbook_filenames = os.listdir(book_filepath)\ntrade_filenames = os.listdir(trade_filepath)\n\nprint(book_filenames[:10])","9f5383d0":"# sample book data\nsample = pd.read_parquet(os.path.join(book_filepath, book_filenames[0]))\nsample.head(3)","3a1ce1f3":"# sample train data\nsample2 = pd.read_parquet(os.path.join(trade_filepath, trade_filenames[0]))\nsample2.head(3)","f1e226fa":"# colors \nmycolors = ['#739900', '#b31aff']\nbidask_color = ['#cc0000', '#006699']\nsns.palplot(mycolors)\nsns.palplot(bidask_color)","1c713238":"def log_return(list_stock_prices):\n    return np.log(list_stock_prices).diff() \n\ndef realized_volatility(series_log_return):\n    return np.sqrt(np.sum(series_log_return**2))","57daba09":"def get_book_data(stock_id, filepath):\n    path = os.path.join(filepath, f\"stock_id={stock_id}\".format(stock_id))\n    data = pd.read_parquet(path)\n    data.insert(0, 'stock_id', stock_id)\n    data['wap1'] = (data['bid_price1'] * data['ask_size1'] + data['ask_price1'] * data['bid_size1']) \/ (data['bid_size1']+ data['ask_size1'])\n    data['wap2'] = (data['bid_price2'] * data['ask_size2'] + data['ask_price2'] * data['bid_size2']) \/ (data['bid_size2']+ data['ask_size2'])\n    data['log_return1'] = data.groupby(['time_id'])['wap1'].apply(log_return)\n    data['log_return2'] = data.groupby(['time_id'])['wap2'].apply(log_return)\n    data = data[~data['log_return1'].isnull()]\n    data = data[~data['log_return2'].isnull()]\n    return data\n\ndef get_book_volatility(data):\n    data = data.groupby(['stock_id', 'time_id'])['log_return1', 'log_return2'].agg(realized_volatility).reset_index()\n    data.rename(columns = {'log_return1': 'volatility1', 'log_return2': 'volatility2'}, inplace = True)\n    return data\n\ndef get_trade_data(stock_id, filepath):\n    path = os.path.join(filepath, f\"stock_id={stock_id}\".format(stock_id))\n    data = pd.read_parquet(path)\n    data.insert(0, 'stock_id', stock_id)\n    return data","f0bdbee9":"# define datasets\nbook_0 = get_book_data(0, book_filepath)\nbook_43 = get_book_data(43, book_filepath)\n\ntrade_0 = get_trade_data(0, trade_filepath)\ntrade_43 = get_trade_data(43, trade_filepath)","9e6cf99d":"# stock_id & time_id data\nbook_0_time_5 = book_0[book_0['time_id'] == 5]\nbook_0_time_16 = book_0[book_0['time_id'] == 16]\n\nbook_43_time_5 = book_43[book_43['time_id'] == 5]\nbook_43_time_16 = book_43[book_43['time_id'] == 16]","594dc7cb":"# ask price is always greater than bid price\nplt.figure(figsize = (8, 5))\nax = plt.subplot(1, 1, 1)\nsns.lineplot(data = book_0_time_5, x = 'seconds_in_bucket', y = 'ask_price1', label = 'ask', color = bidask_color[1])\nsns.lineplot(data = book_0_time_5, x = 'seconds_in_bucket', y = 'bid_price1', label = 'bid', color = bidask_color[0])\n\n# bid-ask spread\nbook_0_time_5['spread'] = book_0_time_5['ask_price1'] - book_0_time_5['ask_price2']\n# minimum bid-ask spread\nidx = np.argmin(book_0_time_5['spread'])\n\nplt.axvline(book_0_time_5.iloc[idx, :]['seconds_in_bucket'], linestyle = ':', color = 'green', linewidth = 2)\nplt.text(book_0_time_5.iloc[idx, :]['seconds_in_bucket']+10, 1.0050, 'spread', \n         bbox = dict(facecolor ='none', edgecolor='green', boxstyle='round'))\n\nfor i in ['left', 'right', 'top']:\n    ax.spines[i].set_visible(False)\n\nax.set_axisbelow(True)\nax.grid(axis='y', linestyle='--', alpha = 0.6)\n\nplt.title('Bid and Ask price', fontsize = 20, loc = 'left', pad = 20)\nplt.ylabel('price');\nplt.legend(bbox_to_anchor = (0.5, 0.5, 0.5, 0.5), frameon = False)\nplt.show()","a4cee7ba":"book_0_time_5['net_size'] = book_0_time_5['bid_size1'] - book_0_time_5['ask_size1']\nbook_0_time_5['net'] = ['neg' if x < 0 else 'pos' for x in book_0_time_5['net_size'].values]\n\nbook_0_time_16['net_size'] = book_0_time_16['bid_size1'] - book_0_time_16['ask_size1']\nbook_0_time_16['net'] = ['neg' if x < 0 else 'pos' for x in book_0_time_16['net_size'].values]","f137acd4":"# plot net_size - wap\ndef net_size_data(data, stock_id, time_id):\n    plt.figure(figsize = (8, 5))\n    ax = plt.subplot(1, 1, 1)\n    sns.scatterplot(data = data, x = 'seconds_in_bucket', y = 'wap1',  hue = 'net', hue_order = ['neg', 'pos'],\n                    palette = bidask_color)\n\n    for i in ['left', 'right', 'top']:\n        ax.spines[i].set_visible(False)\n    \n    legend = plt.legend(frameon = False, bbox_to_anchor = (0.5, 0.5, 0.5, 0.5), scatterpoints = 1)\n    legend.legendHandles[0]._sizes = [40]\n    plt.title(f'Stock {stock_id} - time {time_id}: WAP fluctuation', fontsize = 20, pad = 20, loc = 'left')\n    plt.show()","9d2c4041":"net_size_data(book_0_time_5, 0, 5)","3627488a":"net_size_data(book_0_time_16, 0, 16)","56020434":"book_0_list = [book_0_time_5, book_0_time_16]\ncolors_0 = ['#608000', '#99cc00', '#d2ff4d']\n\n\nfig, axes = plt.subplots(figsize = (16, 4), ncols = 2)\nfor i, dat in enumerate(book_0_list):\n    sns.lineplot(data = dat, x = 'seconds_in_bucket', y = 'wap1', label = str('time_')+str(i+1), ax = axes[0], \n                 legend = None, color = colors_0[i])\n    \nfor i, dat in enumerate(book_0_list):\n    sns.lineplot(data = dat, x = 'seconds_in_bucket', y = 'wap2', label = str('time_')+str(i+1), ax = axes[1],\n                color = colors_0[i])\n    \nfor i in ['left', 'right', 'top']:\n    axes[0].spines[i].set_visible(False)\n    axes[1].spines[i].set_visible(False)\n    \naxes[0].grid(axis='y', linestyle='--', alpha = 0.6)\naxes[1].grid(axis='y', linestyle='--', alpha = 0.6)\naxes[1].legend(bbox_to_anchor = (0.7, 0.5, 0.5, 0.5),frameon = False)\n\n\naxes[0].set_title('WAP1', fontsize = 20, pad = 20, loc = 'left')\naxes[1].set_title('WAP2', fontsize = 20, pad = 20, loc = 'left')\nplt.show()","25683cf7":"plt.figure(figsize = (6, 6))\nax = sns.regplot(data = book_0_time_5, x = 'wap1', y = 'wap2', color = bidask_color[1])\n\nfor i in ['right','top']:\n    ax.spines[i].set_visible(False)\n    ax.spines[i].set_visible(False)\n\nax.set_xlabel('wap1', fontsize = 12)\nax.set_ylabel('wap2', fontsize = 12)\nplt.xticks([]); plt.yticks([])\nplt.title('Correlation: wap1 & wap2', fontsize = 20, loc = 'left', pad = 20)\nplt.show()","92de8579":"book_0_list = [book_0_time_5, book_0_time_16]\nbook_43_list = [book_43_time_5, book_43_time_16]\ncolors_43 = ['#660099', '#b31aff', '#eeccff']\n\nfig, axes = plt.subplots(figsize = (12, 8), nrows = 2)\nfor i, dat in enumerate(book_0_list):\n    sns.lineplot(data = dat, x = 'seconds_in_bucket', y = 'wap1', label = str('time_')+str(i+1), ax = axes[0]\n                 , color = colors_0[i])\n    \nfor i, dat in enumerate(book_43_list):\n    sns.lineplot(data = dat, x = 'seconds_in_bucket', y = 'wap2', label = str('time_')+str(i+1), ax = axes[1], color = colors_43[i])\n    \nfor i in ['left', 'right', 'top']:\n    axes[0].spines[i].set_visible(False)\n    axes[1].spines[i].set_visible(False)\n    \naxes[0].grid(axis='y', linestyle='--', alpha = 0.6)\naxes[1].grid(axis='y', linestyle='--', alpha = 0.6)\n\naxes[0].legend(frameon = False)\naxes[1].legend(frameon = False)\n\n\naxes[0].set_title('Stock 0: WAP', fontsize = 20, pad = 20, loc = 'left')\naxes[1].set_title('Stock 43: WAP', fontsize = 20, pad = 20, loc = 'left')\nplt.tight_layout()\nplt.show()","43e3b7c8":"# define trade data\ntrade0_time_5 = trade_0[trade_0['time_id'] == 5]\ntrade0_time_16 = trade_0[trade_0['time_id']==16]\n\ntrade43_time_5 = trade_43[trade_43['time_id'] == 5]\ntrade43_time_16 = trade_43[trade_43['time_id']==16]","ad8fc748":"# get volatility of each stock\nbook0_vol = get_book_volatility(book_0)\nbook43_vol = get_book_volatility(book_43)","a275d67d":"def plot_price_fluc(data1, data2, stock_id, color):\n    plt.figure(figsize = (12, 5))\n    ax = plt.subplot(1, 1, 1)\n    sns.scatterplot(data = data1, x = 'seconds_in_bucket', y = 'price', s = data1['size']\/4\n                , color = color[0], label = 'time_id 5', alpha = 0.6)\n    sns.scatterplot(data = data2, x = 'seconds_in_bucket', y = 'price', s = data2['size']\/4\n                , color = color[1], label = 'time_id 16', alpha = 0.6)\n\n\n\n    for i in ['left', 'right', 'top']:\n        ax.spines[i].set_visible(False)\n    \n    legend = plt.legend(frameon = False, bbox_to_anchor = (0.7, 0.5, 0.5, 0.5), scatterpoints = 1)\n    legend.legendHandles[0]._sizes = [40]\n    legend.legendHandles[1]._sizes = [40]\n    plt.title(f'Stock {stock_id}: price fluctuation', fontsize = 20, pad = 20, loc = 'left')\n    plt.show()\n    \n    \nplot_price_fluc(trade0_time_5, trade0_time_16, 0, colors_0)","d2a9cb2d":"plot_price_fluc(trade43_time_5, trade43_time_16, 43, colors_43)","0601b05a":"book0_vol[(book0_vol['time_id'] == 5)| (book0_vol['time_id'] == 16)]","9ad2f751":"book43_vol[(book43_vol['time_id'] == 5)| (book43_vol['time_id'] == 16)]","8453a9a8":"plt.figure(figsize = (8, 5))\nax = plt.subplot(1, 1, 1)\nsns.kdeplot(book0_vol['volatility1'],fill = True, alpha = 0.6, label = 'stock 0', color = mycolors[0])\nsns.kdeplot(book43_vol['volatility1'], fill = True, alpha = 0.6, label = 'stock 43', color = mycolors[1])\n\nfor i in ['left', 'right', 'top']:\n    ax.spines[i].set_visible(False)\n\nplt.xlabel('Volatility')\nplt.title('Stock 0 vs Stock 43: Volatility', fontsize = 20, loc = 'left', pad = 20)\nplt.legend(frameon = False)\nplt.show()","35cdf900":"When bid size is smaller than ask size(red points), WAP tends to go down generally as you can check in below graph. In opposite case, WAP tends to go up.","44aff701":"## Contents\n1. [Load package and data](#intro)\n2. [Basic Preprocessing](#prepro)\n3. [EDA](#eda)","587f178f":"Compare overall volatility of Stock 0 and Stock 43! <br>\n\n\n#### Volatility\nVolatiliy of Stock 43 tends to be smaller than that of Stock 0, and it's highly dense in volatiliy range between 0 and 0.005.","04b1e214":"## Basic Preprocessing <a class=\"anchor\" id=\"prepro\"><\/a>\n ","3064b15e":"In book data, there are two prices\/sizes for ask and bid each. Therefore I created **wap1, wap2, log_return1, log_return2**, each represents wap and log return from each bid\/ask price field (1 & 2).","afb309f2":"### (2) Comparision between two stocks: Stock 0 vs Stock 43\n\nThere are 112 unique stock_id in book\/trade files...hard to compare all stock_ids! Hence I randomly chose two stock_id 0 and 43 to compare those stocks, just for fun!\n","e2be2180":"# Optimal Realized Volatility Prediction\n\nThe goal of this competition is to predict volatility of stocks. Before we get in to modeling process, let's start with exploring and visualizing given datasets!\n\n\nSimple modeling of this model is in this link:\n<https:\/\/www.kaggle.com\/hyewon328\/lgbm-feature-selection-optimization>","dba45b6f":"Correlation coefficient between wap1 and wap2 under same stock_id\/time_id is **0.78**, which means that wap1 and wap2 are highly correlated.\n\n\nTo summarize, it will be enough to use only wap from bid\/ask price field 1 to predict target volatility, since wap1 and wap2 shows similar patterns.","8cad036e":"In [Basic Preprocessing](#prepro) part, I created **wap1** and **wap2** variable. To check whether wap1 and wap2 show difference, I plotted wap1 and wap2 of stock 0 data.  time_1 denotes time_id = 5, and time_2 denotes time_id = 16.\n\n<br>\n\nComparing graphs, overall fluctuation of wap1 and wap2 under same stock_id\/time_id are very similar!","9ca94b67":"### (1) General understanding of book data\n\n**book data** contains columns related to bid\/ask price and size and we created new variables wap and log return. To well-understand data, let's take a look at **bid & ask**.\n\n\n<br>\n\n#### What is bid & ask ?\nThe **bid price** represents the maximum price that a buyer is willing to pay for a share of stock. The **ask price**(or offer price) represents the minimum price that a seller is willing to take for a share of stock. \nAsk price is always higher than bid price. To check this, I draw price graph for bid & ask price. Now it's clear that ask price is higher than bid price. (I used stock_id = 0 & time_id = 5 to visualize this below graph)\n\n\n#### Bid-Ask spread\nBid-Ask spread represents price difference between bid price and ask price. If bid-ask spread is small, this means that stock's liquidity is high. \nAccording to this [page](https:\/\/www.investor.gov\/introduction-investing\/investing-basics\/glossary\/liquidity-or-marketability), liquidity refers to how easily or quickly a stock can be bought or sold in a secondary market. It's easier to sell stocks with high liquidity. <br>\nIn graph below, the green line represents seconds_in_bucket where bid-ask spread is smallest. At this point, stock 0 is most liquid.","09ec9471":"# Thank you for reading this notebook :)","51066d53":"Let's define variables as below.\n* `book_0`: book data of stock_id = 0\n* `book_43`: book data of stock_id = 43\n* `trade_0`: trade data of stock_id = 0\n* `trade_43`: trade data of stock_id = 43","abb21391":"The graph below shows price fluctuation of stocks that are actually traded. Size of dots denotes **transaction size** of stocks: the bigger the size of dots, more transaction occured.\n\n\n#### Comparision of Stock 0 and Stock 43\n + The overall transaction size of Stock 0 is smaller than that of Stock 43(compare size of dots in each graph!)\n + Trade of Stock 0 happening in stock market is much sparser than that of Stock 43. There is comparatively large distance between transcation points in Stock 0.\n + Volatility is slightly greater in Stock 0 than in Stock 43.","817a7e56":"## 1. Load package and data <a class=\"anchor\" id=\"intro\"><\/a>","60c21a64":"#### Net Size\nNow I defined **net_size**, difference between bid size and ask size: **bid_size - ask_size**\n<br>\n\nWhen the net_size is smaller than 0(bid size < ask size), this means the price is likely to move down because there are more traders selling(ask) than buying(bid). When net size is greater than 0(bid size > ask size), there is more demand than supply and prices tend to go up. \n<br>\n\nI labeled **pos** for data with net_size > 0, and **neg** for data with net_size < 0.","3e97e5a0":"Define functions that calcualted **log_return** and **realized_volatility**. This code is in [tutorial notebook](https:\/\/www.kaggle.com\/jiashenliu\/introduction-to-financial-concepts-and-data).","34df4f7d":"I've used only book data to understand and visualize data. Now let's use trade data to get more interpretations. Each file in trade data has those columns.\n+ price: The average price of executed transactions happening in one second. Prices have been normalized and the average has been weighted by the number of shares traded in each transaction.\n+ size: The sum number of shares traded.\n+ order_count: The number of unique trade orders taking place.","71eb0a7c":"**target** variable in train data represents volatility of stock under same stock_id and time_id. This dataset only contains target variable, so to get more information about dataset, with should take a look at other given datasets.","2c1c2b6f":"## Confusing variables\nIt's quite hard to understand columns in book and trade data at first glance. So I carefully read [tutorial notebook](https:\/\/www.kaggle.com\/jiashenliu\/introduction-to-financial-concepts-and-data) and [Q&A](https:\/\/www.kaggle.com\/c\/optiver-realized-volatility-prediction\/discussion\/249752) to well understand confusing columns in dataset.\n\n### time_id\nRepresents unique 10-minutes trading window. It does not have special meanings, it just seperates data in each trading window. Plus, bigger time_id value does not necessarily mean later time.\n<br>\n### seconds_in_bucket\n#### 1. book \nBriefly, seconds_in_bucket represents the last snapshot of order book update. If `seconds_in_bucket` = 20, it captures last order between 12:00:20 and 12:00:21. If you take a look at **book_train.parquet** data, per time_id, it ranges from 0 to 599, since 10-miutes is same as 600 seconds. There are some missing seconds_in_bucket values in book data which means that there is no related market activities during that second.\n<br>\n#### 2. trade \nUnder same stock_id and time_ida, if seconds_in_bucket=1, this represents aggregation of all individual executed orders between 12:00:00 and 12:00:01. In trade data, there are some gaps between second_in_bucket values. This shows that there is no trade happening in this seconds_in_bucket window.\n<br>\n### target\n**target** in train data is volatility of stock. It is calculated under same equation of **realized volatility** in tutorial notebook","dfc3ddb1":"## EDA <a class=\"anchor\" id=\"eda\"><\/a>\n\nIn EDA part, I'll discuss \n1. General understanding of book data  \n2. Comparision between two stocks (stock_id 0 vs stock_id 43)\n\n\n<br>","5aff7be8":"\nBoth stock 0 and stock 43 shows different WAP fluctuation according to time_id. This is why we have to predict target in test data based on unique (stock_id, time_id) combinations.\n "}}