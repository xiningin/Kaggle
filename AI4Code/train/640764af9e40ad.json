{"cell_type":{"19cdb6a4":"code","477d0408":"code","f43d5170":"code","298a2516":"code","a25ed15a":"code","93c66040":"code","25798e78":"code","435d9ffd":"code","f8caadff":"code","e5792845":"code","f55f0d7f":"code","0ab8148e":"code","53ba94ed":"code","f1ef1573":"code","c2050e3c":"code","494b4f5c":"code","d892092c":"code","1d3d9a0f":"code","d3fc813a":"code","88a1c39a":"code","f7c9b061":"code","76195702":"code","adf8e605":"code","dc936408":"code","072b80b5":"code","5e710532":"code","6924686c":"code","81ca5395":"code","9e9eb5ba":"code","c60eaf61":"code","7b86d3ec":"code","0a8774fc":"code","41018869":"code","3d631caf":"code","c51c7654":"code","9b60a388":"code","a7469eb0":"code","3962b7d2":"code","47a663b7":"code","0c21ed2c":"code","9d05c725":"markdown","04a07ebb":"markdown","bf7a540b":"markdown","6fa84485":"markdown"},"source":{"19cdb6a4":"!nvidia-smi","477d0408":"!git clone https:\/\/github.com\/fizyr\/keras-retinanet.git","f43d5170":"#!pip install --upgrade keras","298a2516":"%cd keras-retinanet\/\n\n!pip install .","a25ed15a":"!python setup.py build_ext --inplace","93c66040":"!pip install gdown\n#!pip install tensorflow-gpu","25798e78":"import numpy as np\nimport tensorflow as tf\nfrom tensorflow import keras\nimport pandas as pd\nimport seaborn as sns\nfrom pylab import rcParams\nimport matplotlib.pyplot as plt\nfrom matplotlib import rc\nfrom pandas.plotting import register_matplotlib_converters\nfrom sklearn.model_selection import train_test_split\nimport urllib\nimport os\nimport csv\nimport cv2\nimport time\nfrom PIL import Image\n\nfrom keras_retinanet import models\nfrom keras_retinanet.utils.image import read_image_bgr, preprocess_image, resize_image\nfrom keras_retinanet.utils.visualization import draw_box, draw_caption\nfrom keras_retinanet.utils.colors import label_color\n\n%matplotlib inline\n%config InlineBackend.figure_format='retina'\n\nregister_matplotlib_converters()\nsns.set(style='whitegrid', palette='muted', font_scale=1.5)\n\nrcParams['figure.figsize'] = 22, 10\n\nRANDOM_SEED = 42\n\nnp.random.seed(RANDOM_SEED)\ntf.random.set_seed(RANDOM_SEED)","435d9ffd":"#!gdown --id 1mTtB8GTWs74Yeqm0KMExGJZh1eDbzUlT --output indian_number_plates.json","f8caadff":"os.makedirs(\"snapshots\", exist_ok=True)","e5792845":"!gdown --id 1wPgOBoSks6bTIs9RzNvZf6HWROkciS8R --output snapshots\/resnet50_csv_10.h5","f55f0d7f":"! ls \/kaggle\/input\/carplates\/vott-csv-export\/","0ab8148e":"plates_df = pd.read_csv('\/kaggle\/input\/carplates\/vott-csv-export\/CarPlates-export.csv')","53ba94ed":"os.makedirs(\"vott-csv-export\", exist_ok=True)","f1ef1573":"plates_df","c2050e3c":"plates_df['newImage'] = '\/kaggle\/input\/carplates\/vott-csv-export\/'+plates_df.image\nplates_df['xmin']=plates_df['xmin'].apply(round)\nplates_df['ymin']=plates_df['ymin'].apply(round)\nplates_df['xmax']=plates_df['xmax'].apply(round)\nplates_df['ymax']=plates_df['ymax'].apply(round)\nplates_df.head()","494b4f5c":"'''\ndataset = dict()\ndataset[\"image_name\"] = list()\ndataset[\"x_min\"] = list()\ndataset[\"y_min\"] = list()\ndataset[\"x_max\"] = list()\ndataset[\"y_max\"] = list()\ndataset[\"class_name\"] = list()\n\ncounter = 0\nfor index, row in plates_df.iterrows():\n    img = urllib.request.urlopen(row[\"content\"])\n    img = Image.open(img)\n    img = img.convert('RGB')\n    img.save(f'number_plates\/licensed_car_{counter}.jpeg', \"JPEG\")\n    \n    dataset[\"image_name\"].append(f'number_plates\/licensed_car_{counter}.jpeg')\n    \n    data = row[\"annotation\"]\n  \n    width = data[0][\"imageWidth\"]\n    height = data[0][\"imageHeight\"]\n\n    dataset[\"x_min\"].append(int(round(data[0][\"points\"][0][\"x\"] * width)))\n    dataset[\"y_min\"].append(int(round(data[0][\"points\"][0][\"y\"] * height)))\n    dataset[\"x_max\"].append(int(round(data[0][\"points\"][1][\"x\"] * width)))\n    dataset[\"y_max\"].append(int(round(data[0][\"points\"][1][\"y\"] * height)))\n    dataset[\"class_name\"].append(\"license_plate\")\n    \n    counter += 1\nprint(\"Downloaded {} car images.\".format(counter))\n'''","d892092c":"df = plates_df.drop('image',axis=1)\ndf = df.iloc[:,[5,0,1,2,3,4]]\ndf.head()","1d3d9a0f":"def show_image_objects(image_row):\n\n  img_path = image_row.newImage\n  box = [\n    image_row.xmin, image_row.ymin, image_row.xmax, image_row.ymax\n  ]\n\n  image = read_image_bgr(img_path)\n\n  draw = image.copy()\n  draw = cv2.cvtColor(draw, cv2.COLOR_BGR2RGB)\n\n  draw_box(draw, box, color=(255, 255, 0))\n\n  plt.axis('off')\n  plt.imshow(draw)\n  plt.show()","d3fc813a":"! pwd","88a1c39a":"show_image_objects(df.iloc[0])","f7c9b061":"show_image_objects(df.iloc[5])","76195702":"df","adf8e605":"train_df, test_df = train_test_split(\n  df, \n  test_size=0.2, \n  random_state=RANDOM_SEED\n)","dc936408":"ANNOTATIONS_FILE = 'annotations.csv'\nCLASSES_FILE = 'classes.csv'","072b80b5":"train_df.to_csv(ANNOTATIONS_FILE, index=False, header=None)","5e710532":"classes = set(['Lplate'])\n\nwith open(CLASSES_FILE, 'w') as f:\n  for i, line in enumerate(sorted(classes)):\n    f.write('{},{}\\n'.format(line,i))","6924686c":"!head classes.csv","81ca5395":"!head annotations.csv","9e9eb5ba":"PRETRAINED_MODEL = '.\/snapshots\/_pretrained_model.h5'\n\nURL_MODEL = 'https:\/\/github.com\/fizyr\/keras-retinanet\/releases\/download\/0.5.1\/resnet50_coco_best_v2.1.0.h5'\nurllib.request.urlretrieve(URL_MODEL, PRETRAINED_MODEL)\n\nprint('Downloaded pretrained model to ' + PRETRAINED_MODEL)","c60eaf61":"!keras_retinanet\/bin\/train.py --freeze-backbone --random-transform --weights {PRETRAINED_MODEL} --batch-size 4 --steps 10 --epochs 10 csv annotations.csv classes.csv","7b86d3ec":"!ls snapshots","0a8774fc":"model_path = os.path.join('snapshots', sorted(os.listdir('snapshots'), reverse=True)[0])\nprint(model_path)\n\nmodel = models.load_model(model_path, backbone_name='resnet50')\nmodel = models.convert_model(model)\n\nlabels_to_names = pd.read_csv(CLASSES_FILE, header=None).T.loc[0].to_dict()","41018869":"def predict(image):\n  image = preprocess_image(image.copy())\n  image, scale = resize_image(image)\n\n  boxes, scores, labels = model.predict_on_batch(\n    np.expand_dims(image, axis=0)\n  )\n\n  boxes \/= scale\n\n  return boxes, scores, labels","3d631caf":"THRES_SCORE = 0.1\n\ndef draw_detections(image, boxes, scores, labels):\n  for box, score, label in zip(boxes[0], scores[0], labels[0]):\n    if score < THRES_SCORE:\n        break\n\n    color = label_color(label)\n\n    b = box.astype(int)\n    draw_box(image, b, color=color)\n\n    caption = \"{} {:.3f}\".format(labels_to_names[label], score)\n    draw_caption(image, b, caption)\n","c51c7654":"def show_detected_objects(image_row):\n  img_path = image_row.newImage\n  \n  image = read_image_bgr(img_path)\n\n  boxes, scores, labels = predict(image)\n\n  draw = image.copy()\n  draw = cv2.cvtColor(draw, cv2.COLOR_BGR2RGB)\n\n  true_box = [\n    image_row.xmin, image_row.ymin, image_row.xmax, image_row.ymax\n  ]\n  draw_box(draw, true_box, color=(255, 255, 0))\n\n  draw_detections(draw, boxes, scores, labels)\n\n  plt.axis('off')\n  plt.imshow(draw)\n  plt.show()","9b60a388":"test_df.head(n=10)","a7469eb0":"show_detected_objects(test_df.iloc[0])","3962b7d2":"show_detected_objects(test_df.iloc[1])","47a663b7":"show_detected_objects(test_df.iloc[2])","0c21ed2c":"test_df","9d05c725":"# Preprocessing","04a07ebb":"# Predictions","bf7a540b":"# Training","6fa84485":"# Loading the trained model"}}