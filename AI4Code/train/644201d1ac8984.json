{"cell_type":{"22757143":"code","13d914e6":"code","4be01943":"code","7163119b":"code","3910d56c":"code","4ccb7712":"code","3852f73e":"code","70f7835a":"code","4a827ff7":"code","0a9bdc40":"code","7e00d8f0":"code","b1ecd0aa":"code","0d1e0312":"code","2e0f4187":"code","8ad9fe16":"code","6f18bb49":"code","4e821635":"code","8bb33f99":"code","a4dedbc1":"code","ad8e3df1":"code","fabdb03a":"code","422c9726":"code","e74636cb":"code","cb4a376f":"code","308c2012":"code","223a8ff6":"code","b0a01a43":"code","04df7518":"code","b89308fb":"code","0be2c273":"code","c7933e16":"code","3ee6f10a":"code","80beaafa":"code","4ff4a969":"code","dc809c20":"code","c35ac326":"markdown","f1d229d1":"markdown","2e4e3b83":"markdown","9b1681d8":"markdown","7a8a76c1":"markdown","c33a0f4b":"markdown","9301bd6d":"markdown","5c288990":"markdown","6c7f3324":"markdown","108b4663":"markdown","28c1d921":"markdown","738a42d1":"markdown","89920cb6":"markdown","18fafc04":"markdown","6060e097":"markdown","1d1324a1":"markdown","c3f12549":"markdown","91e5dc74":"markdown","f26c5610":"markdown"},"source":{"22757143":"# This Python 3 environment comes with many helpful analytics libraries installed\n# It is defined by the kaggle\/python docker image: https:\/\/github.com\/kaggle\/docker-python\n# For example, here's several helpful packages to load in \n\nimport numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\n\n# Input data files are available in the \"..\/input\/\" directory.\n# For example, running this (by clicking run or pressing Shift+Enter) will list all files under the input directory\n\nimport os\nfor dirname, _, filenames in os.walk('\/kaggle\/input'):\n    for filename in filenames:\n        print(os.path.join(dirname, filename))\n\n# Any results you write to the current directory are saved as output.","13d914e6":"import pandas as pd\nimport numpy as np\nimport plotly.express as px\nimport matplotlib.pyplot as plt\n%matplotlib inline\nimport urllib.request\nimport re\nfrom scipy.integrate import odeint\n","4be01943":"#get latest files containing case hospital deaths, by_sex and by_age data\n#ATTN : Timeout error when hitting github, so use uploaded data as of 4\/22\nnyc_file_url = \"https:\/\/raw.githubusercontent.com\/nychealth\/coronavirus-data\/master\/case-hosp-death.csv\"\ndownload_file_chd = \".\/case-hosp-death.csv\"\nnyc_by_sex_url = \"https:\/\/raw.githubusercontent.com\/nychealth\/coronavirus-data\/master\/by-sex.csv\"\ndownload_file_bs = \".\/by_sex.csv\"\nnyc_by_age_url=\"https:\/\/raw.githubusercontent.com\/nychealth\/coronavirus-data\/master\/by-age.csv\"\ndownload_file_ba = \".\/by_age.csv\"","7163119b":"#get pdf file with race data on covid cases\n#ATTN : Timeout error when hitting github, so use uploaded data as of 4\/22\nnyc_by_race_url=\"https:\/\/www1.nyc.gov\/assets\/doh\/downloads\/pdf\/imm\/covid-19-deaths-race-ethnicity-04082020-1.pdf\"\ndownload_file_race=\".\/covid-19-deaths-race-ethnicity-04082020-1.pdf\"\n","3910d56c":"download_file_chd = \"\/kaggle\/input\/nyc-covid-data-422\/\" + download_file_chd.split(\"\/\")[1]\ndownload_file_bs = \"\/kaggle\/input\/nyc-covid-data-422\/\" + download_file_bs.split(\"\/\")[1]\ndownload_file_ba = \"\/kaggle\/input\/nyc-covid-data-422\/\" + download_file_ba.split(\"\/\")[1]\ndownload_file_race = \"\/kaggle\/input\/nyc-covid-data-422\/\" + download_file_race.split(\"\/\")[1]","4ccb7712":"def get_number_dead(race,line):\n    search_substring = line.find(race)\n    if search_substring!= -1:\n        return float(re.findall(r'\\d+\\n',line[search_substring:])[0])","3852f73e":"def get_text_race_table(fn):\n    pdfFileObj = open(fn, 'rb')\n    pdfReader = PyPDF2.PdfFileReader(pdfFileObj)\n    # our file has just 1 page\n    pageObj = pdfReader.getPage(0)\n    pagecontent = pageObj.extractText()\n    #table data after line 5\n    lines = pagecontent.split(\".\",maxsplit=5)\n    return lines[5]","70f7835a":"#setup dataframe for covid rates by age,sex and the general case_hospitalization_death rate\nby_age_df = pd.read_csv(download_file_ba)\nby_sex_df = pd.read_csv(download_file_bs)\nchd_df = pd.read_csv(download_file_chd)","4a827ff7":"def drop_last_row(df):\n    df.drop(df.tail(1).index, inplace = True)","0a9bdc40":"def define_cumulative_case_sum(df, case_col):\n    cum_case_col = \"CUMULATIVE \" + case_col\n    df[cum_case_col] = df[case_col].cumsum()","7e00d8f0":"def plot_rate(df, xcol,ycol,plot_title=\"NYC rate\"):\n    fig = px.bar(df, x=xcol, y=ycol, labels={'x':'DATE'})\n    fig.update_layout(title=plot_title)\n    fig.show()","b1ecd0aa":"def plot_pie(df, values_col, names_col, plot_title=\"NYC Age\/Sex Covid Rate\"):\n    fig = px.pie(df, values = values_col, names = names_col, title=plot_title)\n    fig.show()","0d1e0312":"#Preprocessing\n#Fill unavailable data with 0\nby_age_df = by_age_df.fillna(0)\nby_sex_df = by_sex_df.fillna(0)\nchd_df = chd_df.fillna(0)\ndefine_cumulative_case_sum(chd_df,\"NEW_COVID_CASE_COUNT\" )\ndefine_cumulative_case_sum(chd_df,\"HOSPITALIZED_CASE_COUNT\" )\ndefine_cumulative_case_sum(chd_df,\"DEATH_COUNT\" )\n# Needed to access DATE OF INTEREST as column\nmod_bs = by_sex_df.reset_index()\nmod_ba = by_age_df.reset_index()\nmod_chd = chd_df.reset_index()\n# Needed to remove citywide totals before pie plot generation\ndrop_last_row(mod_bs)\ndrop_last_row(mod_ba)","2e0f4187":"plot_rate(mod_chd,\"DATE_OF_INTEREST\",\"NEW_COVID_CASE_COUNT\", \"NYC Covid New Case Rate\")","8ad9fe16":"plot_rate(mod_chd,\"DATE_OF_INTEREST\",\"CUMULATIVE NEW_COVID_CASE_COUNT\", \"NYC Cumulative Covid Case Rate\")","6f18bb49":"plot_rate(mod_chd,\"DATE_OF_INTEREST\",\"HOSPITALIZED_CASE_COUNT\", \"NYC Covid Hospitalized Case Rate\")","4e821635":"plot_rate(mod_chd,\"DATE_OF_INTEREST\",\"CUMULATIVE HOSPITALIZED_CASE_COUNT\", \"NYC Cumulative Covid Hospitalisation Rate\")","8bb33f99":"plot_rate(mod_chd,\"DATE_OF_INTEREST\",\"DEATH_COUNT\", \"NYC Covid Death Rate\")","a4dedbc1":"plot_rate(mod_chd,\"DATE_OF_INTEREST\",\"CUMULATIVE DEATH_COUNT\", \"NYC Cumulative Covid Death Rate\")","ad8e3df1":"plot_pie(mod_bs, \"COVID_CASE_RATE\",\"SEX_GROUP\",\"NYC Covid Case Rate By Gender\")","fabdb03a":"plot_pie(mod_bs, \"HOSPITALIZED_CASE_RATE\",\"SEX_GROUP\",\"NYC Covid Hopitalized Case Rate By Gender\")","422c9726":"plot_pie(mod_bs, \"DEATH_RATE\",\"SEX_GROUP\", \"NYC Covid Death Rate by Sex\")","e74636cb":"plot_pie(mod_ba, \"COVID_CASE_RATE\",\"AGE_GROUP\", \"NYC Covid Case Rate by Age\")","cb4a376f":"plot_pie(mod_ba, \"HOSPITALIZED_CASE_RATE\",\"AGE_GROUP\", \"NYC Hospitalization Case Rate by Age\")","308c2012":"plot_pie(mod_ba, \"DEATH_RATE\",\"AGE_GROUP\", \"NYC Covid Death Rate by Age\")","223a8ff6":"def plotCaseRate(plotS = False, plotI = False, plotR = False, plotD=False, start=\"03-02-2020t00:00\"):\n    datetime_col = pd.date_range(start, periods=len(t), freq=\"D\")\n    fig = plt.figure(facecolor = 'w')\n    ax = fig.add_subplot(111, axisbelow = True)\n    # replacing t with datetime_col.date in ax.plot\n    if plotS:\n        ax.plot(datetime_col.date, S, 'b', alpha=0.5, lw=2, label = \"Susceptible\")\n    if plotI:\n        ax.plot(datetime_col.date, I, 'r', alpha=0.5, lw=2, label = \"Infected\")\n    if plotR:\n        ax.plot(datetime_col.date, R, 'g', alpha=0.5, lw=2, label = \"Recovered\")\n    if plotD:\n        ax.plot(datetime_col.date, D, 'o', alpha=0.5, lw=2, label = \"Dead\")\n    ax.set_xlabel('Time\/days')\n    ax.set_ylabel('Number of people')\n    ax.yaxis.set_tick_params(length=0)\n    ax.xaxis.set_tick_params(length=0)\n    ax.grid(b=True, which = 'major', c='w', lw=2, ls='-')\n    legend = ax.legend()\n    legend.get_frame().set_alpha(0.5)\n    plt.setp(ax.get_xticklabels(), rotation=30, horizontalalignment='right')\n    for spine in ('top', 'right', 'bottom', 'left'):\n        ax.spines[spine].set_visible(False)\n    plt.show()   ","b0a01a43":"N = 8.7 * 1000000 # population of NYC \nI0, R0 = 1,0\nS0 = N - I0 - R0\n# contact rate - guesstimate start at 0.2,1.0, 0.6\n# recovery rate - 2 weeks for 80 % and 3 to 6 weeks for 20 % approx 17 days\nbeta, gamma = 0.2, 1.\/17\n# Time points in days\nt = np.linspace(0,60, 60)","04df7518":"def derivSIR(y, t, N, beta, gamma):\n    S, I, R = y\n    dSdt = -beta * S * I \/ N\n    dIdt = beta * S * I \/ N - gamma * I\n    dRdt = gamma * I\n    return dSdt, dIdt, dRdt","b89308fb":"# We see from the cumulative infections graph above that in about 45 days total infected is about 120K\n# With beta at 0.35 we see more than 100000 infections after 40 days BUT the rate of growth here is higher than seen\nI0, R0 = 1,0\nS0 = N - I0 - R0\nt = np.linspace(0,60, 60)\nbeta, gamma = 0.35, 1.\/17\ny0 = S0, I0, R0\nret = odeint(derivSIR, y0, t, args =(N, beta, gamma))\nS, I, R = ret.T\nplotCaseRate(False, True, False, False, start=\"03-02-2020t00:00\")","0be2c273":"# With stats on 3\/21, cumulative infected were 20595\n# number of recovered guesstimated using 10% for closed and further 50% of that recovered\nI0, R0 = 20595,1250\nS0 = N - I0 - R0\nt = np.linspace(0,45, 45)\nbeta, gamma = 0.12, 1.\/17\ny0 = S0, I0, R0\nret = odeint(derivSIR, y0, t, args =(N, beta, gamma))\nS, I, R = ret.T\nplotCaseRate(False, True, False, False, start=\"03-21-2020t00:00\")","c7933e16":"def derivSIRD(y, t, N, beta, gamma, mu):\n    S, I, R, D = y\n    dSdt = -beta * S * I \/ N\n    dIdt = beta * S * I \/ N - gamma * I - mu * I\n    dRdt = gamma * I\n    dDdt = mu * I\n    return dSdt, dIdt, dRdt, dDdt","3ee6f10a":"# Adding death numbers to the first model we tried with SIR starting beginning March\n# mu estimated at average mrtality after 5 weeks\nI0, R0, D0 = 1,0, 0\nS0 = N - I0 - R0 - D0\nt = np.linspace(0,60, 60)\nbeta, gamma = 0.35, 1.\/17\nmu = 1.\/35\ny0 = S0, I0, R0, D0\nret = odeint(derivSIRD, y0, t, args =(N, beta, gamma, mu))\nS, I, R, D = ret.T\nplotCaseRate(False, True, False, True)","80beaafa":"# Adding death numbers to the second model for SIR starting about 3\/21\nI0, R0, D0 = 20595,1250,158\nS0 = N - I0 - R0 - D0\nt = np.linspace(0,45, 45)\nbeta, gamma = 0.12, 1.\/17\nmu = 1.\/35\ny0 = S0, I0, R0, D0\nret = odeint(derivSIRD, y0, t, args =(N, beta, gamma, mu))\nS, I, R, D = ret.T\nplotCaseRate(False, True, False, True,start=\"03-21-2020t00:00\")","4ff4a969":"# beta, gamma, mu from reference\nI0, R0, D0 = 20595,1250,158\nS0 = N - I0 - R0 - D0\nt = np.linspace(0,60, 60)\nbeta, gamma = 0.319, 0.16\nmu = 0.0005\ny0 = S0, I0, R0, D0\nret = odeint(derivSIRD, y0, t, args =(N, beta, gamma, mu))\nS, I, R, D = ret.T\nplotCaseRate(False, True, False, False,start=\"03-21-2020t00:00\")\nplotCaseRate(False, False, False, True,start=\"03-21-2020t00:00\")","dc809c20":"# beta, gamma, mu from reference\nI0, R0, D0 = 20595,1250,158\nS0 = N - I0 - R0 - D0\nt = np.linspace(0,365, 365)\nbeta, gamma = 0.319,0.16\nmu = 0.0005\ny0 = S0, I0, R0, D0\nret = odeint(derivSIRD, y0, t, args =(N, beta, gamma, mu))\nS, I, R, D = ret.T\nplotCaseRate(True, True, True, True,start=\"03-21-2020t00:00\")","c35ac326":"We know that there are about 130000 infected in about 45 days, so playing around with the beta values leads us to use beta=0.35 and the infected chart below.\n","f1d229d1":"##  To do\n    1. Redo analysis with the John's Hopkins Data as this is available worldwide and not just NYC\n    2. NYCHealth has added probable deaths - look at how probable and confirmed deaths would need to be modelled together\n    3. Add ARIMA model to predict Infections, deaths","2e4e3b83":"If you have suggestions on how to finetune this model to more accurately reflect how the curve is actually flattening, please let me know\n\nLets look next at a model that also includes the number of dead","9b1681d8":"## Stats and visualizations on status and impact of Covid 19 in NYC\n\nFeel free to skip over the (hidden) setup and code to the visualizations.","7a8a76c1":"## SIR Model and Tuning","c33a0f4b":"By adding the modelling for dead, it appears that the estimated infected seems to be in the mid 100K in Mid April while dead increases significantly more by end April. More importantly, both these curves seem to be increasing too rapidly for the cumulative curves we are seeing now","9301bd6d":"Here by adding the modelling for dead, it appears that the estimated infected is too low and dead too high here. <br> \nWe use the parameters from reference that is based on an assumption of underreporting of cases that are mild","5c288990":"While the number dead seems to lag cumulative death counts a little, this model appears to be closer than the previous one that overestimated deaths.  \nLooking a little more into the assumptions made by these authors, these __parameters correspond to a scenario where the number of infected is estimated to by twenty times the reported numbers and the number of recovered is again estimated to be 40 times what is reported.__ <br>\nInterestingly, there are a __couple of serology studies out in LA that have also similarly found that the number of infected and recovered greatly overexceed documented values.__ <br>\n\n## Update : \nLooks like antibody studies in New York have indeed found a greater number of infected - almost 2 million. Looks like this is a not uncommon scenario and indeed justifies that greater beta and lower gamma and mu values chosen just above: https:\/\/www.cnbc.com\/2020\/04\/23\/new-york-antibody-study-estimates-13point9percent-of-residents-have-had-the-coronavirus-cuomo-says.html\n\nFinally we extend this model out for a year.","6c7f3324":"The SIRD or **S**usceptible - **I**nfectious - **R**ecovered - **D**ead Model is another epidemiologic model. <br>\nIt divides the total population **N** in 4 camps. <br>\n* Susceptible individuals who may yet be infected\n* Infectious individuals or carriers who are currently distributing the dosease\n* Recovered individuals who have recovered and developed immunity\n* Dead individuals who passed away after contracting the infection\n\nThe change in susceptible individuals and recovered individuals is calculated similar to the SIR model <br>\n\nThe change in dead individuals per unit time, is modeled by <br>\n> dDdt = *mu I* <br>\nwhere mu is the death rate determined as 1\/ #number of days after infection that death occurs <br>\n\nThe change in infectious individuals in unit time then is the sum of the newly infected minus the newly recovered and minus the newly dead <br>\n> dIdt = *beta S I \/N - gamma I - mu I* <br>\n\nHere to get mu values we use two methods: <br>\n1. From reports that among patients who have died, the time from symptom onset to outcome ranges from 2-8 weeks, and we took an average of 5 weeks and \n2. from a reference paper \"Data-based analysis, modelling and forecasting of the COVID-19 outbreak\" that models the COVID outbreak using SIRD and has different solutions for the parameters used\n\n","108b4663":"This looks like peak infections should hit soon by May and also coincides with when the number of recovered exceeds those susceptible.","28c1d921":"## NYC Social distancing scorecard by date","738a42d1":"__Wow, the estimated infected is around 4 million by the end of April__.<br>\n\nLuckily, we know that not only did NYC start social distancing, their score had risen to a respectable 'C' by 3\/21. Lets see if we can do better by working in the impact of social distancing - viz, with a reduced beta. Lets try again, but this time, starting after 03\/21 when we had 20595 infected. <br>\n\nFor the recovered count we guesstimate that a third of cases are recovered . Currently, from https:\/\/www.worldometers.info\/coronavirus\/country\/us\/ we see that of the closed cases almost 2\/3rd are recovered, and the closed cases are themselves about 10% of the total cases","89920cb6":"## Introduction\nCovid-19 is a kind of Coronavirus that has to date affected more than 2 million people worldwide and counting. With vaccines still being developed, specfic treatment still at the experimental stage, and limited testing capacity in much of the world, \"social distancing\" has emerged as the prevailing method of containment. Epidemiologic models used by public health officials have played a major role in convincing goverments to adopt this method. <br> <br> In this notebook, we first visualize the spread of Covid-19 in NYC by looking at the new case rate, hospitalization, and death rate as well as look at cumulative counts of the same and finally how they differ by gender, and age. <br>\n\nThen we look at metrics on how much New Yorkers have heeded these calls to social dispancing in the timeframe for which we visualised the Covid impact. <br> \n\nFinally, we fit some simple compartmental models such as SIR, and SIRD and validate for ourselves the impact of social distancing and look at some predictions","18fafc04":"![title](https:\/\/www.asanet.org\/sites\/default\/files\/images\/news-items\/covid.jpg)","6060e097":"## SIRD Model and Tuning","1d1324a1":"## References\n    1. SIR Model in Python - https:\/\/scipython.com\/book\/chapter-8-scipy\/additional-examples\/the-sir-epidemic-model\/\n    2. Gamma estimation via number of days for recovery - https:\/\/www.who.int\/docs\/default-source\/coronaviruse\/who-china-joint-mission-on-covid-19-final-report.pdf\n    3. Mu estimation via number of days for death - https:\/\/www.who.int\/docs\/default-source\/coronaviruse\/who-china-joint-mission-on-covid-19-final-report.pdf\n    4. Unacast social distancing scorecard - https:\/\/www.unacast.com\/covid19\/social-distancing-scoreboard?view=state&fips=36\n    5. SIRD Covid 19 estimate's for China\/Italy and parameter estimation - https:\/\/journals.plos.org\/plosone\/article?id=10.1371\/journal.pone.0230405\n    6. LA Serology study - https:\/\/news.usc.edu\/168987\/antibody-testing-results-covid-19-infections-los-angeles-county\/\n    7. NYChealth github - https:\/\/github.com\/nychealth\/coronavirus-data","c3f12549":"Now with a growth rate of 0.12 this graph too shows the total infected about 30 days after 3\/21 between 100K and 150K. This estimated infected in another 10 days or so by the end of April is a lot less at about 200K, although it still shows this curve increasing instead of levelling off. ","91e5dc74":"Mobile data can be used to create a \"social distancing scoreboard\" to \"measure and understand the efficacy of social distancing initiatives\". One such scoreboard is made available by Unacast which we will use. You can find the link used in the References section.\n\nWe derived the following table from their graph when we searched by the state of New York and match against the infected case count from the section above. <br>\n\n\n<table>\n    <tr>\n        <th> <center> Date <\/center> <\/th>\n        <th> <center> Social distancing grade <\/center> <\/th>\n        <th> <center> Cumulative infected casecount <\/center> <\/th>\n    <\/tr>\n    <tr> \n        <td> 2020-02-29<\/td>\n        <td> F <\/td>\n        <td> 0 <\/td>\n    <\/tr>\n    <tr> \n        <td> 2020-03-07<\/td>\n        <td> F <\/td>\n        <td> 23 <\/td>\n    <\/tr>\n    <tr> \n        <td> 2020-03-14<\/td>\n        <td> D <\/td>\n        <td> 1931 <\/td>\n    <\/tr>\n    <tr> \n        <td> 2020-03-21<\/td>\n        <td> C <\/td>\n        <td> 20595 <\/td>\n    <\/tr>\n    <tr> \n        <td> 2020-03-28<\/td>\n        <td> B <\/td>\n        <td> 48924 <\/td>\n    <\/tr>\n    <tr> \n        <td> 2020-04-04<\/td>\n        <td> B <\/td>\n        <td> 83033 <\/td>\n    <\/tr>\n    <tr> \n        <td> 2020-04-11<\/td>\n        <td> B <\/td>\n        <td> 116408 <\/td>\n    <\/tr>\n    <tr> \n        <td> 2020-04-18<\/td>\n        <td> B <\/td>\n        <td> 132456 <\/td>\n    <\/tr>\n<\/table>","f26c5610":"The SIR or **S**usceptible - **I**nfectious - **R**ecovered Model is an epidemiologic model that divides the total population, **N** in 3 camps.\n* Susceptible individuals who may yet be infected\n* Infectious individuals or carriers who are currently distributing the dosease\n* Recovered individuals who have recovered and developed immunity\n\nThe change in susceptible individuals per unit time, is attributed to the \"newly infected\" and modeled by <br>\n> dSdt = *-beta S I \/ N* <br>\nwhere beta is the rate of communication of the disease, in turn influenced by\n* contact rate of infectious individuals\n* probability of disease transmission\n\nThe change in recovered individuals per unit time, or the \"newly recovered\" is modeled by <br>\n> dRdt = *gamma I* <br>\nwhere gamma is the recovery rate determined as 1\/ #number of days needed to recover <br>\n\nThe change in infectious individuals in unit time then is the sum of the newly infected minus the newly recovered\n> dIdt = *beta S I \/N - gamma I* <br>\n\nHere to estimate gamma we go by the reported median time from onset to clinical recovery for mild cases which is approximately 2 weeks and is 3-6 weeks for patients with severe or critical disease. We assume 80% cases are mild.\n"}}