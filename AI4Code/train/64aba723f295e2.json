{"cell_type":{"6f425914":"code","9c78a460":"code","4ba7bd40":"code","d32a89c2":"code","996a60e7":"code","cb01f57c":"code","52131e71":"code","459c9fa7":"code","308f9555":"code","4398cf74":"code","8e0167ea":"code","ffca96d8":"code","6138fa36":"code","0a6ef7b4":"code","7cace454":"code","2ccfd9b7":"code","7edc481e":"markdown","b0a61bff":"markdown","b9058995":"markdown","7978abc3":"markdown","7edb2a13":"markdown","4227062d":"markdown","43bd3aa7":"markdown","b98f43f0":"markdown","72a3feb8":"markdown","9ca81b1f":"markdown","ffe4aa7c":"markdown","15f14a6a":"markdown","ab683d9c":"markdown","c1fe272b":"markdown","438fe8f8":"markdown","f70d026e":"markdown","490797e3":"markdown","5c5245a7":"markdown"},"source":{"6f425914":"from pandas import read_csv\nimport pandas as pd\nimport matplotlib.pyplot as plt\nfrom matplotlib.pyplot import figure\n\nFILE   = '..\/input\/weatherstats\/weatherstats_vancouver_daily.csv'\noriginalSeries = read_csv(FILE, header=0, index_col=0)\n# print(originalSeries.describe())\n# print(originalSeries.columns)\n\ndailyAveragesOriginal = originalSeries[[\"avg_temperature\", \"avg_relative_humidity\", \n                                        \"avg_wind_speed\", \"avg_pressure_sea\", \"avg_pressure_station\", \n                                        \"avg_health_index\", \"precipitation\"]].copy()\n\n# Reverse time series data so the lasted time is shown last\ndailyAverages = dailyAveragesOriginal.iloc[::-1]\ndailyAverageTimeStamp = dailyAverages\ndailyAverageTimeStamp.index = pd.to_datetime(dailyAverages.index)\n\nprint(dailyAverageTimeStamp.describe())\nprint(dailyAverageTimeStamp.head())\n","9c78a460":"dailyAverageTimeStamp['avg_health_index'].plot(rot=30)\nplt.title(\"Vancouver Daily Average Air Quality Health Index\")\nplt.show()","4ba7bd40":"\n#%% Scale correlated exogenous features to better view trends\n\nfrom sklearn.preprocessing import StandardScaler\n\ndf_correlated = dailyAverageTimeStamp[[\"avg_relative_humidity\", \n                                        \"avg_health_index\", \"precipitation\"]].copy()\n\nscaler = StandardScaler()\ndf_scaled = pd.DataFrame(scaler.fit_transform(df_correlated), columns=[\"avg_relative_humidity\", \n                                        \"avg_health_index\", \"precipitation\"])\ndf_scaled.index = dailyAverageTimeStamp.index\n\n\n#%% Isolated just the AQHI column data\n\ndailyAverageAQHI = dailyAverages[['avg_health_index']].copy()\n# print(dailyAverageAQHI.describe())\n# print(dailyAverageAQHI.head())\n\n#%% Adding time shifts\/back shifts to AQHI data\n\ntimeShiftAQHI = dailyAverages[['avg_health_index']].copy()\nNUM_TIME_STEPS = 5\nfor i in range(1, NUM_TIME_STEPS + 1):\n    columnName = 't-' + str(i)\n    timeShiftAQHI[columnName] = dailyAverages['avg_health_index'].shift(periods=i)\n\n#%% Boxplot of all AQHI data\n\nboxplot = dailyAverageAQHI.boxplot(grid=False)\nhist = dailyAverageAQHI.hist()\n\n","d32a89c2":"#%% Plot correlation matrix as heat map\nimport seaborn as sns\n\ncorr = dailyAverages.corr()\n#print(corr)\nsns.heatmap(corr,\n            xticklabels=corr.columns.values,\n            yticklabels=corr.columns.values, annot=True)\nplt.title(\"Heat Map of Vancouver Climate Features\")\nplt.show()\n","996a60e7":"df_scaled.index = dailyAverageTimeStamp.index\n\nax=df_scaled.tail(200).plot(rot=30)\nax.set_xlabel(\"Month\")\nax.set_ylabel(\"Scaled values\")\nplt.title(\"AQHI, Humidity, and Precipitation\")\nplt.show()\n","cb01f57c":"corr = timeShiftAQHI.corr()\nsns.heatmap(corr,\n            xticklabels=corr.columns.values,\n            yticklabels=corr.columns.values, annot=True)\nplt.title(\"AQHI Time Shifts Correlation\")\nplt.show()\n","52131e71":"#%% Break down AQHI by year and plot to see if there is yearly trend\n\nimport matplotlib.pyplot as plt\nimport seaborn as sns\nimport numpy as np\nfrom pandas import pivot_table\n\nsns.set()\nseason = dailyAverageTimeStamp\nseason['Date'] = dailyAverageTimeStamp.index\nseason['Year'] = season['Date'].dt.year\nseason['Month'] = season['Date'].dt.month\nspivot = pivot_table(season, index='Month', columns = 'Year', values = 'avg_health_index', aggfunc=np.mean)\nspivot.plot(figsize=(20,10), title=\"AQHI by Year\",linewidth=3)\nplt.show()\n\n\n","459c9fa7":"#%% Auto Correlation plot\n\nimport matplotlib.pyplot as plt\n\nAQHIwithDate = dailyAverageTimeStamp.groupby('Date')['Date','avg_health_index'].\\\n    mean().dropna()\n# print(AQHIwithDate)\n# print(dailyAverageTimeStamp['avg_health_index'])\npd.plotting.autocorrelation_plot(AQHIwithDate);\nplt.show()\n","308f9555":"#%% ACF and PACF plot for past 200 days\n\nfrom pandas                     import read_csv\nimport matplotlib.pyplot        as plt\n\n# Plot ACF.\nfrom statsmodels.graphics.tsaplots import plot_acf\nplot_acf(AQHIwithDate, lags=200)\nplt.show()\n\n# Plot PACF.\nfrom statsmodels.graphics.tsaplots import plot_pacf\nplot_pacf(AQHIwithDate, lags=200)\nplt.show()\n","4398cf74":"##################################### 3.Data Treatment #####################################\n#%% Augmented Dickey-Fuller Test (ADF)\n\nfrom statsmodels.graphics.tsaplots import plot_acf, plot_pacf\nimport matplotlib.pyplot as plt\nplt.rcParams.update({'figure.figsize':(9,7), 'figure.dpi':120})\n\nfrom statsmodels.tsa.stattools import adfuller\nresult = adfuller(dailyAverageTimeStamp[\"avg_health_index\"].dropna())\nprint('ADF Statistic: %f' % result[0]) #-18.376868\nprint('p-value: %f' % result[1]) # 0\n","8e0167ea":"!pip install pmdarima\ndf_final = df_correlated\ndf_final[\"avg_health_index_t1\"] = timeShiftAQHI[\"t-1\"]\ndf_final= df_final.dropna()\n\n\nNUM_TEST_DAYS = 10\nX             = df_final[\"avg_health_index\"].values\nsize          = len(X) - NUM_TEST_DAYS\ntrain, test   = X[0:size], X[size:]\n\n# Create a list with the training array.\nhistory       = [x for x in train]\npredictions   = []\n\ndef predict(coef, history):\n    yhat      = 0.0\n    for i in range(1, len(coef) + 1):\n        yhat += coef[i - 1] * history[-i]\n    return yhat \n\nimport pmdarima as pm\n\nfor t in range(len(test)):\n    print(\"History length: \" + str(len(history)))\n    model = pm.auto_arima(history, start_p=1, start_q=1,\n                            test='adf',\n                            max_p=3, max_q=3, m=1,\n                            start_P=0, seasonal=True,\n                            error_action='ignore',\n                            suppress_warnings=True,\n                            stepwise=True)\n    \n    print(model.summary())\n    fc, confint = model.predict(n_periods=1,\n                                return_conf_int=True)\n    yhat = fc[0]\n\n    predictions.append(yhat) \n\n    obs = test[t]       \n    history.append(obs) \n    print('>predicted=%.3f, expected=%.3f' % (yhat, obs))\n    ","ffca96d8":"plt.plot(test, label='Actual', marker='o', color='blue')\nplt.plot(predictions, label='Predictions', marker='o', color='orange')\nplt.legend()\nplt.title(\"ARIMA Model\")\nplt.show()","6138fa36":"from   sklearn.metrics import mean_squared_error\nfrom   math import sqrt\nrmse = sqrt(mean_squared_error(test, predictions))\nprint('Test RMSE: %.3f' % rmse)","0a6ef7b4":"#%% ARIMAX with auto_arima()\n\nNUM_TEST_DAYS = 10\ndfX                  = df_final\nsize                 = len(dfX) - NUM_TEST_DAYS\ntrain, test          = dfX[0:size], dfX[size:]\n\ntrain.tail(NUM_TEST_DAYS)\nhistory     = train.copy()\nhistory_exogenous = train.copy().drop(columns=['avg_health_index'])\npredictions = []\n\nfor i in range(0, len(test)):\n    lenOpen = len(history_exogenous[['precipitation']])\n    print(history.shape)\n\n    model = pm.auto_arima(history[['avg_health_index']],\n                          exogenous=history[['precipitation', 'avg_relative_humidity','avg_health_index_t1']],\n                          start_p=1, start_q=1,\n                          test='adf',       \n                          max_p=3, max_q=3, \n                          m=1,              \n                          d=None,           \n                          seasonal=True,    \n                          start_P=0,\n                          D=0,\n                          trace=True,\n                          error_action='ignore',\n                          suppress_warnings=True,\n                          stepwise=True)\n\n    fc, confint = model.predict(n_periods=1,\n                          exogenous=np.array(\n                          history_exogenous.iloc[lenOpen-1]).reshape(1,-1),\n                          return_conf_int=True)\n\n    predictions.append(fc)\n    avg_health_index        = test.iloc[i]['avg_health_index']\n    precipitation   = test.iloc[i]['precipitation']\n    avg_relative_humidity   = test.iloc[i]['avg_relative_humidity']\n    avg_health_index_t1   = test.iloc[i]['avg_health_index_t1']\n\n    history     = history.append({\"avg_health_index\":avg_health_index, \"precipitation\":precipitation, \n                                  \"avg_relative_humidity\":avg_relative_humidity, \"avg_health_index_t1\":avg_health_index_t1}, \n                                 ignore_index=True)\n\n","7cace454":"plt.plot(test.index, test['avg_health_index'], marker='o', \n         label='Actual', color='blue')\nplt.plot(test.index, predictions, marker='o', \n         label='Predicted', color='orange')\nplt.legend()\nplt.xticks(rotation=70)\nplt.show()","2ccfd9b7":"from sklearn.metrics import mean_squared_error\nfrom math import sqrt\n\nrmse = sqrt(mean_squared_error(test['avg_health_index'], predictions))\nprint('Test RMSE: %.3f' % rmse)\nprint(model.summary())\n","7edc481e":"# Introduction\nIn this time series analysis, we aim to predict the Air Quality Health Index (AQHI) in Metro Vancouver by using daily forecast data from August 25, 2012 to Nov. 11, 2020. The AQHI is a scale designed to measure air quality and its effect on human health. Its value ranges from 1 (low air pollution and low health risk) to 10+ (high air pollution and high health risk). The AQHI takes into consideration ground level Ozone (O3), Particulate Matter (PM2.5\/PM10), and Nitrogen Dioxide (NO2) concentrations. The data used in this analysis can be downloaded [here](https:\/\/vancouver.weatherstats.ca\/download.html).\n\n![](https:\/\/www.canada.ca\/content\/canadasite\/en\/environment-climate-change\/services\/air-quality-health-index\/about\/_jcr_content\/par\/div_0_1\/col_1\/img_0_0\/image.img.jpg\/1506362386403.jpg)\n\n<div align=\"center\">Figure 2 Air Quality Health Index Rating<\/div>","b0a61bff":"## ARIMAX (0, 0, 1)","b9058995":"Using back shifting up to 5 days, we can see that the current AQHI value does correlate well with previous entries. A time lag of 1 day has a 70% positive correlation with current values, and a lag of 2 days has a 50% positive correlation.","7978abc3":"# 1. Problem Definition\n\nAir quality is a factor that affects everyone's heath. Air pollution can lead diseases, hospitalizations, and premature death in at risk populations. The Canadian Government estimates that about [14,600 premature deaths each year](http:\/\/publications.gc.ca\/site\/eng\/9.874080\/publication.html) can be attributed to air pollution. The groups of people that are most affected by air pollution are ones who have lung or heart conditions (such as asthma or heart disease), young children, older adults, or those who are active outdoors. Scientific studies have also shown that air pollution is related to [abnormal fetal growth in pregnant women.](https:\/\/news.yale.edu\/2018\/02\/26\/air-pollutants-linked-abnormal-fetal-growth#:~:text=Chinese%20mothers%20who%20were%20exposed,Public%20Health%20(YSPH)%20study)\n\nThis past summer, Vancouver's AQHI was rated at 10+ (Very High Health Risk), due to forest fires in the United States. People were recommended to stay indoors, avoid physical activity, and use air purifiers. In this time series analysis, we use ARIMA modeling to see if we can predict AQHI and seen when Vancouver residences should prepare for poor air quality.\n\n![Figure 3 Vancouver skyline under heavy haze](https:\/\/api.time.com\/wp-content\/uploads\/2018\/08\/gettyimages-1020992542.jpg?quality=85&w=700crop=1)\n\n<div align=\"center\">Figure 3 Vancouver skyline under heavy haze<\/div>\n","7edb2a13":"The data set contains 2997 AQHIs with a minimum value of 1.2 and a maximum value of 11 (representing a value of 10+ on the AQHI scale). As seen in figure 5 below, most AQHIs are below 3, while there are many outliers in the data shown in the box plot. Generally, air quality health risk in Vancouver is low, but there are several days in the year where spikes happen.\n\n\n<div align=\"center\">Air Quality Health Index Summary<\/div>\n\n\n| Description      | Value |\n| ----------- | ----------- |\n| Mean      | 2.15       |\n| Standard Deviation   | 0.682293        |\n| Min   | 1.2        |\n| Max   | 11        |\n| 25% Quartile   | 1.8       |\n| 50% Quartile   | 2.0        |\n| 75% Quartile   | 2.4        |\n\n<br>\nThe data set contains 2997 AQHIs with a minimum value of 1.2 and a maximum value of 11 (representing a value of 10+ on the AQHI scale). As seen below, most AQHIs are below 3, while there are many outliers in the data shown in the box plot. Generally, air quality health risk in Vancouver is low, but there are several days in the year where spikes happen.\n","4227062d":"From the correlation matrix below, the average health index is slightly negatively correlated with precipitation (13%) and humidity (14%). These exogenous variables were found as part of the Vancouver Climate Data.","43bd3aa7":"In the below graph, the AQHI values are split by year. In the year 2020, 2018, and 2017, there are major spikes in AQHI during the month of August to September. There is also a noticeable trend of increased AQHI during December to March in all years.","b98f43f0":"Since the data is a time series, we want to find how long-ago previous values might be related with current values. In the previous heat map, we had seen that there was positive correlation in the past 5 days of data (5 backshifts). For the entire dataset, running an autocorrelation test produced the above graph. We can see that there are also spikes at ~ 450, 750, and 1200 days ago that have positive correlation.","72a3feb8":"On closer examination of the past 200 days, the Autocorrelation (ACF) graph shows that AQHI has significant correlation to time lags of 10 days. The Partial Autocorrelation (PACF) shows only significant correlation with lags of 1-day prior with the current day AQHI (with some minor significantly correlated values at 40, 55, 95, 115, 125, and 200-day lags).","9ca81b1f":"In the below figure, the values of precipitation, relative humidity, and AQHI are scared around 0 to see if there are any trends related between these features. The heat map shown earlier had negative correlation between precipitation and humidity with AQHI. This is confirmed in this graph as we can see in areas where spikes occur in precipitation and relative humidity, AQHI is at a low, and vice versa. ","ffe4aa7c":"The ARIMAX model had better predictions for the latest 10 days of AQHIs. Although both models were decent in their prediction, including the exogenous variables helped for our ARIMAX results. Shown below are the formulas for both models. Since the ARIMAX model had a p parameter of 0, it lacks the a1yt-1 + a2yt-2 variables that the ARIMA model has. Instead, it contains precipitation, relative humidity, and the time lag variables and their coefficients.","15f14a6a":"# Vancouver Air Pollution: Time Series Analysis\n![](https:\/\/www.vmcdn.ca\/f\/files\/shared\/feeds\/global\/2020\/09\/vancouer-air.jpg;w=600)\n<div align=\"center\">Figure 1 Vancouver Air Smoke vs Regular AQHI<\/div>","ab683d9c":"From the exploratory data analysis, we found that the exogenous (external) variables of precipitation and humidity had a negative correlation with AQHI. In addition, back shifted AQHI data of 1 day had high significant ACF and PACF values so it will also be included in the data set used for modeling. After adding 1 back shifted data column, the row that had the missing value (\u2018NaN\u2019) was dropped. The features are shown below:\n\n| Column | Feature |\n| ----------- | ----------- |\n| Index      | Date Time       |\n| 1.   | Average Air Quality Health Index        |\n| 2.   | One-Day Time Lagged Average Air Quality <br\/> Health Index (exogenous)        |\n| 3.   | Average Relative Humidity (exogenous)        |\n| 4.   | Average Precipitation (exogenous)       |\n\n\n","c1fe272b":"# 3. Data Treatment\nAlthough previously the data appeared to have a cyclic pattern (with increasing AQHI around the Spring\/Summer months), the Augmented Dickey-Fuller Test shows that the data is stationary, meaning there is no repeating patterns. The test ran with an ADF Statistic of -18.37 and a p Value of 0. No differencing on the data (to remove repeating patterns) is needed.\n","438fe8f8":"## ARIMA (2, 0, 1)","f70d026e":"# 4. Model Development and Evaluation\n\nIn this section, both an ARIMA model using only AQHI values and an ARIMX model using the time step, relative humidity, and precipitation exogenous feature were created. Both models were developed using Auto ARIMA to find the most optimal p, d, and q parameters.\n\nThe Auto ARIMA found that the values of **p = 2, d = 0, and q = 1** were best for the ARIMA model with an AIC of 3623.473. For the ARIMAX model, it was determined that **p = 0, d = 0, and q = 1** were best suited, with an AIC of 3549.562.\n\nAll coefficients of the ARIMA model were found to be significant, while all but the precipitation feature of the ARIMAX model were found to be significant. \n\nAfter performing predictions for the lasted 10 days of AQHI values, the ARIMAX model (RMSE: 1.365) outperformed the ARIMA (RMSE: 1.574) model by having a lower error value (RMSE). In the below table, the predicted versus actual values are plotted. \nBoth models had their p, d, and q parameters choose by Auto ARIMA which selected the model with the lowest AIC\/BIC values. The ARIMAX model included exogenous features (external variables) so it produced different results from Auto ARIMA than the ARIMA model. Without these variables, the regular ARIMA model had more influence from the AR (Autoregressive) part of ARIMA, giving the coefficients of ar.L1 and ar.L2. \n\n","490797e3":"## Model Formulas\n\n| Model  | Equation |\n| --------  | :-------- |\n| ARIMA      | Y t = c + a1yt-1 + a2yt-2 + b1\u03b5t-1 <br\/> Y t = 0.1883 + 1.2987 yt-1 - 0.3855yt-2 - 0.6517 \u03b5t-1|\n| ARIMAX (best model)     |Y t = c + m1[precipitation] + m2[relative_humidity] + m2[Y t-1] + b1\u03b5t-1 <br\/>Y t = 1.0027 - 0.0041[precipitation] - 0.0057[relative_humidity] + 0.7527 [Y t-1] - 0.10581\u03b5t-1 |","5c5245a7":"# 2. Exploratory Data Analysis\nThe original data from Vancouver Weather Stats includes daily minimum, hourly average, maximum, and average values for AQHI, temperature, humidity, and multiple other weather factors. For this analysis, we will only be looking at the daily average values for all features.\n\nWe will first import the data and reverse the time series so that the lastest time data is shown last.\n"}}