{"cell_type":{"be58f8bd":"code","4c79f335":"code","58887ab8":"code","59f38283":"code","ccba9f7e":"code","f57f051c":"code","d89fee57":"code","f7009189":"code","dec3ffc7":"code","6547e779":"code","d3dcae12":"code","06cd73fc":"code","3e683b62":"code","88208a01":"code","198b347e":"code","4694252f":"code","304092db":"code","df760921":"code","c38c4485":"code","6d67e573":"code","795cd5da":"code","4e94c11e":"code","8daa9b56":"code","017180c8":"code","4f51d12f":"code","466f81ab":"markdown","cbe184e1":"markdown"},"source":{"be58f8bd":"import numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\nimport torch\nimport torch.nn as nn\nimport torch.nn.functional as F\nimport torchvision\nimport torch.utils.data as data_util\nfrom tqdm import tqdm_notebook, tqdm\nfrom copy import deepcopy\nimport matplotlib.pyplot as plt\n\nimport os\nfor dirname, _, filenames in os.walk('\/kaggle\/input'):\n    for filename in filenames:\n        print(os.path.join(dirname, filename))","4c79f335":"train_df = pd.read_csv('\/kaggle\/input\/Kannada-MNIST\/train.csv')\nval_df = pd.read_csv('\/kaggle\/input\/Kannada-MNIST\/Dig-MNIST.csv')","58887ab8":"train_df.head()","59f38283":"def df_to_image(df):\n    imgs = []\n    labels = []\n    for idx in tqdm_notebook(range(len(df))):\n        row = df.iloc[idx].values\n        label, img = row[0], row[1:]\n        labels.append(label)\n        imgs.append(img.reshape(1, 28, 28).astype('uint8'))\n    \n    imgs = np.concatenate(imgs, axis=0)\n    labels = np.array(labels)\n    \n    return imgs, labels","ccba9f7e":"train_img, train_label = df_to_image(train_df)\nval_img, val_label = df_to_image(val_df)","f57f051c":"def random_plot(images, labels):\n    num = len(images)\n    idxs = np.random.choice(range(num), 9, replace=False)\n    fig, axes = plt.subplots(3, 3)\n    for plot_idx, arch in enumerate(idxs):\n        i = plot_idx % 3 # Get subplot row\n        j = plot_idx \/\/ 3 # Get subplot column\n        img = images[arch]\n#         axes[i, j].imshow(img, cmap='gray')\n        axes[i, j].imshow(img,)\n        axes[i, j].axis('off')\n        axes[i, j].set_title(f'{labels[arch]}')\n    plt.subplots_adjust(wspace=0.1, hspace=0.3)\n    plt.show()","d89fee57":"random_plot(train_img, train_label)","f7009189":"model = torchvision.models.resnet34()\nmodel.fc","dec3ffc7":"model.fc = nn.Linear(512, 10)","6547e779":"model.conv1 = nn.Conv2d(1, 64, kernel_size=(3), stride=1, padding=1) # stride=2","d3dcae12":"class DigDataset(data_util.Dataset):\n    def __init__(self, imgs, labels):\n        super(DigDataset, self).__init__()\n        self.imgs = imgs.reshape(-1, 28, 28, 1)\n        self.labels = labels\n        self.trans = torchvision.transforms.ToTensor()\n        \n    \n        \n    def __len__(self):\n        return len(self.labels)\n    \n    def __getitem__(self, idx):\n        img = self.imgs[idx]\n        label = self.labels[idx]\n        \n        return self.trans(img), torch.tensor(label)","06cd73fc":"# batch_size = 50 # ORIG\nbatch_size = 40\ntrain_set = DigDataset(train_img, train_label)\nval_set = DigDataset(val_img, val_label)\n\ntrain_loader = data_util.DataLoader(train_set, batch_size=batch_size, num_workers=2, pin_memory=True, shuffle=True)\nval_loader = data_util.DataLoader(val_set, batch_size=batch_size, num_workers=2, pin_memory=True, shuffle=False)","3e683b62":"cuda = torch.cuda.is_available()","88208a01":"cuda","198b347e":"def generate_matrix(gt, pre, num_class=10):\n        mask = (gt >= 0) & (gt < num_class)\n        label = num_class * gt[mask].astype('int') + pre[mask]\n        count = np.bincount(label, minlength=num_class**2)\n        confusion_matrix = count.reshape(num_class, num_class)\n        return confusion_matrix","4694252f":"def do_train(model, optim, data_loader, epoch):\n    model.train()\n    confusion_matrix = np.zeros((10, 10))\n    tbar = tqdm_notebook(train_loader)\n    for img, label in tbar:\n        if cuda:\n            img, label = img.cuda(), label.cuda()\n        \n        optim.zero_grad()\n        logit = model(img)\n        loss = F.cross_entropy(logit, label)\n        loss.backward()\n        optim.step()\n        \n        pred = torch.argmax(logit, dim=1)\n        batch_acc = (pred == label).sum() \/ len(pred)\n        tbar.set_description(f'Train loss: {loss.item():.4f} acc: {batch_acc}')\n        confusion_matrix += generate_matrix(label.cpu().numpy(), pred.cpu().numpy())\n    \n    acc = np.diag(confusion_matrix).sum() \/ confusion_matrix.sum()\n    print(f'Epoch: {epoch_idx} acc: {acc}')\n    \ndef do_eval(model, data_loader, epoch):\n    model.eval()\n    confusion_matrix = np.zeros((10, 10))\n    tbar = tqdm_notebook(train_loader)\n    for img, label in tbar:\n        if cuda:\n            img, label = img.cuda(), label.cuda()\n        \n        with torch.no_grad():\n            logit = model(img)\n        loss = F.cross_entropy(logit, label)\n        \n        pred = torch.argmax(logit, dim=1)\n        batch_acc = (pred == label).sum() \/ len(pred)\n        tbar.set_description(f'Val loss: {loss.item():.4f} acc: {batch_acc}')\n        confusion_matrix += generate_matrix(label.cpu().numpy(), pred.cpu().numpy())\n    \n    acc = np.diag(confusion_matrix).sum() \/ confusion_matrix.sum()\n    print(f'Epoch: {epoch_idx} val acc: {acc}')\n    return acc","304092db":"epoch = 20\nif cuda:\n    model = model.cuda()\n    \noptim = torch.optim.Adam(params=model.parameters())\nbst_model = None\nbst_acc = 0.\nfor epoch_idx in range(epoch):\n    do_train(model, optim, train_loader, epoch_idx)\n    \n    val_acc = do_eval(model, val_loader, epoch_idx)\n    \n    if bst_acc < val_acc:\n        bst_model = deepcopy(model)\n        bst_acc = val_acc\n","df760921":"test_df = pd.read_csv('\/kaggle\/input\/Kannada-MNIST\/test.csv')","c38c4485":"test_df.head()","6d67e573":"test_img, ids = df_to_image(test_df)","795cd5da":"test_set = DigDataset(test_img, ids)\ntest_loader = data_util.DataLoader(test_set, batch_size=batch_size, num_workers=2, shuffle=False)","4e94c11e":"submit = {\n    'id': [],\n    'label': []\n}\nif cuda:\n    bst_model = bst_model.cuda()\nfor b_imgs, b_ids in tqdm_notebook(test_loader):\n    if cuda:\n        b_imgs = b_imgs.cuda()\n        \n    with torch.no_grad():\n        logit = bst_model(b_imgs)\n        \n    pred = torch.argmax(logit, dim=1)\n    pred = pred.cpu().numpy()\n    submit['label'].extend(pred.tolist())\n    submit['id'].extend(b_ids.cpu().numpy().tolist())\n    ","8daa9b56":"submit_df = pd.DataFrame(submit)\nsubmit_df.head()","017180c8":"submit_df.to_csv('submission.csv', index=False)","4f51d12f":"!head submission.csv","466f81ab":"#### Build model","cbe184e1":"## Test"}}