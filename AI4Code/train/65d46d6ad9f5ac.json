{"cell_type":{"371a9158":"code","8125ea64":"code","1e122b0e":"code","54e851fd":"code","c7e598f5":"code","4487fafa":"code","287f1662":"code","a070a3a7":"code","f23969b1":"code","32002ce7":"code","885c2618":"code","b63e0789":"code","31615252":"code","d0867e69":"markdown","9de42917":"markdown","4c08491b":"markdown","9029a95d":"markdown","37dfb185":"markdown","abc29209":"markdown","a6f6db20":"markdown","4abe9b74":"markdown","59b1961d":"markdown","633f103c":"markdown","b5f78457":"markdown","4101bf21":"markdown","5bd6a5a4":"markdown","fd7ceb6c":"markdown","1cb00576":"markdown","0ecf2847":"markdown","badab737":"markdown","5bbf4e47":"markdown","c19248e9":"markdown","51c5ba11":"markdown","144dab1d":"markdown","0d40017f":"markdown","f23b6a7d":"markdown","2689970c":"markdown","47a96596":"markdown","b754dbc2":"markdown"},"source":{"371a9158":"! pip install mlcomp","8125ea64":"%%script bash --bg --out script_out\n\n! mlcomp-server start","1e122b0e":"ls ..\/input\/severstal\/severstal\/configs_kaggle","54e851fd":"cat ..\/input\/severstal\/severstal\/configs_kaggle\/catalyst_kaggle.yml","c7e598f5":"cat ..\/input\/severstal\/severstal\/configs_kaggle\/kaggle.yml","4487fafa":"ls ..\/input\/severstal\/severstal","287f1662":"cat ..\/input\/severstal\/severstal\/executors\/preprocess.py","a070a3a7":"cat ..\/input\/severstal\/severstal\/executors\/masks.py","f23969b1":"! mkdir -p ~\/mlcomp\/data\/severstal\n\n! ln -s \/kaggle\/input\/severstal-steel-defect-detection\/ ~\/mlcomp\/data\/severstal\/input\n! ln -s \/kaggle\/working\/ ~\/mlcomp\/db","32002ce7":"! sleep 5\n! mlcomp dag ..\/input\/severstal\/severstal\/configs_kaggle\/kaggle.yml --params=executors\/train\/params\/data_params\/max_count:50 --params=executors\/train\/params\/num_epochs:3","885c2618":"from mlcomp.utils.describe import describe, describe_task_names\ndescribe_task_names(dag=1)","b63e0789":"describe(dag=1, metrics=['loss', 'dice'], wait=True, task_with_metric_count=3, fig_size=(10 ,15))","31615252":"! cp ~\/mlcomp\/tasks\/3\/trace.pth unet_resnet34.pth\n! cp ~\/mlcomp\/tasks\/4\/trace.pth unet_se_resnext50_32x4d.pth\n! cp ~\/mlcomp\/tasks\/5\/trace.pth unet_mobilenet2.pth","d0867e69":"Start MLComp's server","9de42917":"## Severstal DAG execution","4c08491b":"Install MLComp library. It already has Catalyst in the dependencies","9029a95d":"SegmentationModelPytorch here is a wrapper of this library: https:\/\/github.com\/qubvel\/segmentation_models.pytorch\n\nWe are declaring a model, stages, callbacks, criterion, number of epochs, etc. in a special configuration file.\n\nThen, we could run it via catalyst-dl run --config=..\/input\/severstal\/severstal\/configs_kaggle\/catalyst_kaggle.yml","37dfb185":"Catalyst has 2 API: \n\n1. python API, you are importing regular classes\n2. config API, you are declaring an execution process in a special configuration file and run catalyst-dl run --config=PATH_TO_CONFIG","abc29209":"We use the second scenario. Let's have a look at our Catalyst config file","a6f6db20":"But instead of if, we are declaring one additional config for [MLComp](https:\/\/github.com\/catalyst-team\/mlcomp).\n\n[MLComp](https:\/\/github.com\/catalyst-team\/mlcomp) helps to declare DAG and execute it in a parallel.","4abe9b74":"## Basic setup\n\n[MLComp](https:\/\/github.com\/catalyst-team\/mlcomp) is a distributed DAG (Directed acyclic graph) framework for machine learning with UI. It helps to train, manipulate, and visualize.\n\nEvery machine learning pipeline is a Directed acyclic graph. [MLComp](https:\/\/github.com\/catalyst-team\/mlcomp) helps to execute it in a parallel manner, see the results via Web UI and manipulate the process easily.\n\nhttps:\/\/github.com\/catalyst-team\/mlcomp\n\n[Catalyst](https:\/\/github.com\/catalyst-team\/catalyst) helps to train neural networks. It helps to get good positions in the competitions.\n\nFor an example, [yu4u and the others have finished at the 4th place using Catalyst](https:\/\/www.kaggle.com\/c\/recursion-cellular-image-classification\/discussion\/110337#latest-635296)\n\nhttps:\/\/github.com\/catalyst-team\/catalyst","59b1961d":"DAG's element is known as Executor. They are here: preprocess, masks, train\n\nEach executor must be declared somewhere in your project's folder where you are running ```mlcomp dag``` command","633f103c":"That is our project folder. Executors folder contains our executors.","b5f78457":"### Conclusion\n\nWe have seen a short demonstration of MLComp\/Catalyst execution process.\n\nYou can find inference here https:\/\/www.kaggle.com\/lightforever\/severstal-mlcomp-catalyst-infer-0-90672 ","4101bf21":"masks converts masks from csv file to regular png masks","5bd6a5a4":"train executor is a standard executor declared in MLComp library. That is a wrapper of Catalyst.","fd7ceb6c":"The sever has just started. If you run this code locally, you can open web browser and see the control panel: http:\/\/localhost:4201","1cb00576":"### Plan:\n\n1. Basic setup and short discussion about MLComp and Catalyst libraries\n\n2. MLComp and Catalyst short tutorial\n\n3. Severstal DAG execution. Due to Kaggle kernels limit, we will not train final models here. You should train them yourself locally. (the code is the same). All you need to do is to remove extra params from ```mlcomp dag``` command\n\nOr you can download them https:\/\/www.kaggle.com\/lightforever\/severstalmodels\n\n4. You can find inference here https:\/\/www.kaggle.com\/lightforever\/severstal-mlcomp-catalyst-infer-0-90672\n\n**An ensemble of the segmentation models with a postprocessing gives 0.90672 on LB. If you add the classifier from Heng CherKeng's [thread](https:\/\/www.kaggle.com\/c\/severstal-steel-defect-detection\/discussion\/106462#latest-634450)**, you should get 0.9117 on LB**","0ecf2847":"### IMPORTANT \n\nIf you are running this code locally, run only ```mlcomp dag ..\/input\/severstal\/severstal\/configs_kaggle\/kaggle.yml```\n\nThis kernel provides a demo run only. With a limited number of samples and epochs.","badab737":"Dags\n![Dags](https:\/\/github.com\/catalyst-team\/mlcomp\/raw\/master\/docs\/imgs\/dags.png)\n\nComputers\n![Computers](https:\/\/github.com\/catalyst-team\/mlcomp\/raw\/master\/docs\/imgs\/computers.png)\n\nReports\n![Reports](https:\/\/github.com\/catalyst-team\/mlcomp\/raw\/master\/docs\/imgs\/reports.png)\n\nWe have no such an opportunity in a Kaggle kernel. But we can use MLComp's describe module. See below","5bbf4e47":"#### Copy result models\n\nCatalyst has a special mechanism named tracing. You can combine a model and that weights in as a single file.\n\nWe have done it, actually. ( we declared ```trace``` configuration for train executor).\n\nAll we need to do now, is to copy the result files.","c19248e9":"Start DAG","51c5ba11":"Describe the DAG execution status","144dab1d":"![MLComp](https:\/\/raw.githubusercontent.com\/catalyst-team\/catalyst-pics\/master\/pics\/MLcomp.png)\n![Catalyst](https:\/\/raw.githubusercontent.com\/catalyst-team\/catalyst-pics\/master\/pics\/catalyst_logo.png)","0d40017f":"Link Kaggle-specific folders","f23b6a7d":"If you run this kernel, you will see an auto-refreshing describe panel below. (otherwise, you see only the last plot)","2689970c":"You can see here:\n\n1. basic info about DAG in info section\n\n2. declaring DAG's structure in executors section.","47a96596":"## Catalyst\/MLComp short tutorial","b754dbc2":"Preprocess is a standard group K-Fold stratification"}}