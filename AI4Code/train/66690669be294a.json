{"cell_type":{"50f96db7":"code","84a840cd":"code","e5207e17":"code","5edb07a2":"code","0756a5c5":"code","8b835199":"code","16d78626":"code","08b742a6":"code","7c2751af":"code","e271c9d4":"code","d38fcdb7":"code","91c41e37":"code","9074aad5":"code","a91d73ed":"code","41622b0f":"code","52375450":"code","5894bca1":"code","ecfb2ef2":"code","b6eb808e":"code","d9b0110f":"code","ad8ec38c":"code","39def47d":"code","6c3a9b4f":"code","29e1f64b":"code","4c3e56d3":"code","6a87cf36":"code","1e0faa19":"code","4191715b":"code","7e70b31f":"code","d23bd489":"code","261cbc42":"code","4115b9ae":"code","bf51b8d8":"code","76b42594":"code","646ffe22":"code","24ea06fa":"code","91a4b436":"code","ba6c4106":"code","45f5da88":"code","3ded6c75":"markdown","7a6fe41a":"markdown","0cbac58c":"markdown","048e500e":"markdown","0077c3fe":"markdown"},"source":{"50f96db7":"%reload_ext autoreload\n%autoreload 2\n%matplotlib inline","84a840cd":"import os\nimport gc\nimport numpy as np\nimport pandas as pd\nfrom fastai import *\nfrom fastai.vision import * \nfrom fastai.metrics import error_rate,accuracy\nfrom fastai.callbacks.hooks import *","e5207e17":"# \u6211\u4eec\u60f3\u8981\u7684\u6570\u636e\u5df2\u7ecf\u88ab\u653e\u5728\u4e86kaggle\u4e0a\npath = Path('\/kaggle\/input\/repository\/alexgkendall-SegNet-Tutorial-bb68b64\/CamVid')","5edb07a2":"# \u53c2\u770b\u6570\u636e\npath.ls()","0756a5c5":"fnames=get_image_files(path\/\"val\")\nfnames[:3]","8b835199":"lbl_names=get_image_files(path\/\"valannot\")\nlbl_names[:3]","16d78626":"# \u6211\u4eec\u67e5\u770b\u4e00\u4e0b\u7b2c\u4e00\u5f20\u56fe\u7247\nimg_f=fnames[0]\nimg=open_image(img_f)\nimg.show(figsize=(5,5))","08b742a6":"def get_y_fn(x): return Path(str(x.parent)+\"annot\")\/x.name\n\ncodes = array(['Sky', 'Building', 'Pole', 'Road', 'Sidewalk', 'Tree',\n    'Sign', 'Fence', 'Car', 'Pedestrian', 'Cyclist', 'Void'])","7c2751af":"# \u6211\u4eec\u83b7\u5f97img_f\u7684\u50cf\u7d20\u6807\u8bb0\u56fe\u7247\nmask=open_mask(get_y_fn(img_f))\nmask.show(figsize=(5,5),alpha=1)","e271c9d4":"src_size=np.array(mask.shape[1:])\nprint(src_size)   # \u663e\u793a\u6570\u636e\u7684shape\nmask.data  # \u663e\u793a\u6570\u636e\u7684\u5185\u5bb9\n# \u6211\u4eec\u53ef\u4ee5\u53d1\u73b0\u8fd9\u4e2a\u6570\u636e\u5c31\u5728\u56fe\u7247\u7684\u6bcf\u4e2a\u50cf\u7d20\u4e0a\u5bf9\u539f\u6709\u56fe\u7247\u7684\u989c\u8272\u8fdb\u884c\u6807\u8bb0","d38fcdb7":"# \u6211\u4eec\u628a\u6240\u63d0\u53d6\u7684\u56fe\u7247\u7684\u5927\u5c0f\u8bbe\u7f6e\u4e3a\u539f\u6709\u50cf\u7d20\u7684\u4e00\u534a\nbs,size=8,src_size\/\/2","91c41e37":"# data_block\u5efa\u7acbdatabunch\nsrc=(SegmentationItemList.from_folder(path)\n    .split_by_folder(valid=\"val\")\n    .label_from_func(get_y_fn,classes=codes))","9074aad5":"data=(src.transform(get_transforms(),tfm_y=True)   # \u5bf9\u6570\u636e\u96c6\u8fdb\u884c\u589e\u5f3a\n      .databunch(bs=bs)\n      .normalize(imagenet_stats))","a91d73ed":"# \u5c55\u793a\u6570\u636e\ndata.show_batch(2,figsize=(10,7))","41622b0f":"# \u521b\u5efa\u81ea\u5df1\u7684\u8bc4\u4ef7\u6307\u6807\nname2id={v:k for k,v in enumerate(codes)}\nvoid_code=name2id[\"Void\"]\n\ndef acc_camvid(input,target):\n    target=target.squeeze()\n    mask=target!=void_code\n    return (input.argmax(dim=1)[mask]==target[mask]).float().mean()","52375450":"metrics=acc_camvid\nwd=1e-2","5894bca1":"# \u5efa\u6a21\nlearn=unet_learner(data,models.resnet34,metrics=metrics,wd=wd,model_dir=\"\/kaggle\/working\/models\")","ecfb2ef2":"# \u83b7\u5f97\u5b66\u4e60\u7387\u66f2\u7ebf\nlr_find(learn)","b6eb808e":"# \u67e5\u770b\u5b66\u4e60\u7387\u66f2\u7ebf\nlearn.recorder.plot()","d9b0110f":"# \u8bbe\u7f6e\u5b66\u4e60\u7387\nlr=2e-4","ad8ec38c":"learn.fit_one_cycle(10,slice(lr),pct_start=0.8)","39def47d":"learn.save(\"\/kaggle\/working\/stage-1\")","6c3a9b4f":"learn.show_results(3,figsize=(10,15))","29e1f64b":"# \u6211\u4eec\u5bf9\u6a21\u578b\u8fdb\u884c\u89e3\u51bb\uff0c\u5728\u8fdb\u884c\u4e00\u6b21\u8bad\u7ec3\nlearn.load(\"\/kaggle\/working\/stage-1\")\nlearn.unfreeze()\nlearn.fit_one_cycle(10,max_lr=slice(lr\/\/100,lr),pct_start=0.8)","4c3e56d3":"learn.recorder.plot_losses()","6a87cf36":"learn.save(\"\/kaggle\/working\/stage-2-unfreeze\")","1e0faa19":"# \u91ca\u653e\u5185\u5b58\ndel learn\ngc.collect()","4191715b":"size=src_size\nbs=8","7e70b31f":"data=(src.transform(get_transforms(),size=size,tfm_y=True)\n     .databunch(bs=bs)\n     .normalize(imagenet_stats))","d23bd489":"# \u5efa\u7acb\u6a21\u578b\uff0c\u540c\u65f6\u52a0\u8f7d\u4e4b\u524d\u7684\u9884\u8bad\u7ec3\u6a21\u578b\nlearn=unet_learner(data,models.resnet34,metrics=metrics,wd=wd,model_dir=\"\/kaggle\/working\/\").load(\"stage-2-unfreeze\")","261cbc42":"# \u5bfb\u627e\u6700\u4f73\u7684\u5b66\u4e60\u7387\nlearn.lr_find(start_lr=1e-9)","4115b9ae":"learn.recorder.plot()","bf51b8d8":"lr=2e-7\nlearn.fit_one_cycle(10,max_lr=slice(lr\/\/10,lr),pct_start=0.8)","76b42594":"learn.save(\"\/kaggle\/working\/stage-3-big\")","646ffe22":"learn.recorder.plot_losses()","24ea06fa":"learn.unfreeze()\nlearn.fit_one_cycle(1,max_lr=slice(lr\/\/10,lr),pct_start=0.8)","91a4b436":"learn.save(\"\/kaggle\/working\/stage-4-big-unfreeze\")","ba6c4106":"learn.show_results()","45f5da88":"learn.summary()","3ded6c75":"## \u6570\u636eData","7a6fe41a":"git clone https:\/\/github.com\/alexgkendall\/SegNet-Tutorial.git","0cbac58c":"## \u6570\u636e\u96c6Datasets","048e500e":"## \u6a21\u578b Model","0077c3fe":"## \u4f7f\u7528\u66f4\u5927\u7684\u6570\u636e\u8fdb\u884c\u8bad\u7ec3"}}