{"cell_type":{"ffbb48d9":"code","d469e98d":"code","85843f00":"code","ad2e835d":"code","06e884a7":"code","177c2c54":"code","c5fcfe77":"code","2840995a":"code","51e9b4a7":"code","29374614":"code","772433e2":"code","940e304b":"code","36ee1a7c":"code","2190a10f":"code","4f764f74":"code","4af4ecf8":"code","443f4da2":"code","95d2159d":"code","7c05d09a":"code","9bb123f0":"code","a7708576":"code","ac262cf1":"code","c8ca7571":"markdown","b5d46e99":"markdown","64c7856b":"markdown","1b0641d8":"markdown","fa5d46ea":"markdown","fc8c4fca":"markdown","7b7c05da":"markdown","087fd233":"markdown","fd38743e":"markdown","4d967cac":"markdown","01eb15ed":"markdown","9e030b4e":"markdown","a1bbdb5c":"markdown","61e27bea":"markdown","fc630370":"markdown","08d6a30d":"markdown","e11ca42e":"markdown","1bc46717":"markdown","c0888b8d":"markdown","2e843936":"markdown","5713ebe4":"markdown","1fa9771a":"markdown","19051615":"markdown","6c25b15a":"markdown","945017e7":"markdown","927f7cd4":"markdown","f0b71b68":"markdown","ed3e1887":"markdown","f0e47b5e":"markdown","387d879a":"markdown","329ff80e":"markdown"},"source":{"ffbb48d9":"import numpy as np\nimport pandas as pd\n\nimport matplotlib.pyplot as plt\n%matplotlib inline\n\nimport seaborn as sns\n\nimport os\nfor dirname, _, filenames in os.walk('\/kaggle\/input'):\n    for filename in filenames:\n        print(os.path.join(dirname, filename))","d469e98d":"manhattan_taxi = pd.read_csv('..\/input\/taxi-data-set\/manhattan_taxi.csv')\nmanhattan_taxi.head(5)","85843f00":"def pickup_scatter(t):\n    plt.scatter(t['pickup_lon'], t['pickup_lat'], s=2, alpha=0.2)\n    plt.xlabel('Longitude')\n    plt.ylabel('Latitude')\n    plt.title('Pickup locations')\n\nplt.figure(figsize=(8, 16))\npickup_scatter(manhattan_taxi);","ad2e835d":"manhattan_taxi['date'] = pd.to_datetime(manhattan_taxi['pickup_datetime']).dt.date\nmanhattan_taxi.head()","06e884a7":"date_ride_count = manhattan_taxi.groupby('date').count()\ndate_ride_count = pd.DataFrame(date_ride_count['pickup_datetime']).reset_index().rename(columns={'pickup_datetime': 'ride count'})\nplt.plot_date(date_ride_count['date'], date_ride_count['ride count'])\nplt.xticks(rotation=70)\nplt.xlabel('date')\nplt.ylabel('ride count')\nplt.title('Ride Count by Date');","177c2c54":"from datetime import date\n\natypical = [1, 2, 3, 18, 23, 24, 25, 26]\ntypical_dates = [date(2016, 1, n) for n in range(1, 32) if n not in atypical]\ntypical_dates\n\nfinal_taxi = manhattan_taxi[manhattan_taxi['date'].isin(typical_dates)]","c5fcfe77":"import sklearn.model_selection\n\ntrain, test = sklearn.model_selection.train_test_split(final_taxi, train_size=0.8, test_size=0.2, random_state=42)\nprint('Train:', train.shape, 'Test:', test.shape)","2840995a":"train_sorted_dates = train.sort_values('date')\nplt.figure(figsize=(8,4))\nsns.boxplot(data=train_sorted_dates, x='date', y='duration')\nplt.xticks(rotation=90)\nplt.title('Duration by date');","51e9b4a7":"def speed(t):\n    \"\"\"Return a column of speeds in miles per hour.\"\"\"\n    return t['distance'] \/ t['duration'] * 60 * 60\n\ndef augment(t):\n    \"\"\"Augment a dataframe t with additional columns.\"\"\"\n    u = t.copy()\n    pickup_time = pd.to_datetime(t['pickup_datetime'])\n    u.loc[:, 'hour'] = pickup_time.dt.hour\n    u.loc[:, 'day'] = pickup_time.dt.weekday\n    u.loc[:, 'weekend'] = (pickup_time.dt.weekday >= 5).astype(int)\n    u.loc[:, 'period'] = np.digitize(pickup_time.dt.hour, [0, 6, 18])\n    u.loc[:, 'speed'] = speed(t)\n    return u\n    \ntrain = augment(train)\ntest = augment(test)\ntrain.iloc[0,:]","29374614":"period_1 = train[train['period'] == 1]['speed']\nperiod_2 = train[train['period'] == 2]['speed']\nperiod_3 = train[train['period'] == 3]['speed']\n\nplt.figure(figsize=(8,6))\nsns.distplot(period_1, label='Early Morning')\nsns.distplot(period_2, label='Daytime')\nsns.distplot(period_3, label='Night')\nplt.title('Distribution of Speed per Period');\nplt.legend();","772433e2":"D = train[['pickup_lon', 'pickup_lat']].to_numpy()\npca_n = len(train)\npca_means = np.mean(D, axis=0)\nX = (D - pca_means) \/ np.sqrt(pca_n)\nu, s, vt = np.linalg.svd(X, full_matrices=False)\n\ndef add_region(t):\n    \"\"\"Add a region column to t based on vt above.\"\"\"\n    D = t[['pickup_lon', 'pickup_lat']].to_numpy()\n    assert D.shape[0] == t.shape[0], 'You set D using the incorrect table'\n    X = (D - pca_means) \/ np.sqrt(pca_n) \n    first_pc = X @ vt.T[0]\n    t.loc[:,'region'] = pd.qcut(first_pc, 3, labels=[0, 1, 2])\n    \nadd_region(train)\nadd_region(test)","940e304b":"plt.figure(figsize=(8, 16))\nfor i in [0, 1, 2]:\n    pickup_scatter(train[train['region'] == i])","36ee1a7c":"from sklearn.preprocessing import StandardScaler\n\nnum_vars = ['pickup_lon', 'pickup_lat', 'dropoff_lon', 'dropoff_lat', 'distance']\ncat_vars = ['hour', 'day', 'region']\n\nscaler = StandardScaler()\nscaler.fit(train[num_vars])\n\ndef design_matrix(t):\n    \"\"\"Create a design matrix from taxi ride dataframe t.\"\"\"\n    scaled = t[num_vars].copy()\n    scaled.iloc[:,:] = scaler.transform(scaled) # Convert to standard units\n    categoricals = [pd.get_dummies(t[s], prefix=s, drop_first=True) for s in cat_vars]\n    return pd.concat([scaled] + categoricals, axis=1)\n\ndesign_matrix(train).iloc[0,:]","2190a10f":"def rmse(errors):\n    \"\"\"Output: root mean squared error.\"\"\"\n    return np.sqrt(np.mean(errors ** 2))\n\nconstant_rmse = rmse(test['duration'] - np.mean(train['duration']))\nconstant_rmse","4f764f74":"from sklearn.linear_model import LinearRegression\n\nsimple_model = LinearRegression()\nsimple_model = simple_model.fit(train[['distance']], train.loc[:, 'duration'])\n\nsimple_rmse = rmse(test['duration'] - simple_model.predict(test[['distance']]))\nsimple_rmse","4af4ecf8":"linear_model = LinearRegression()\nlinear_model = linear_model.fit(design_matrix(train), train.loc[:, 'duration'])\n\nlinear_rmse = rmse(test['duration'] - linear_model.predict(design_matrix(test)))\nlinear_rmse","443f4da2":"period_model = LinearRegression()\nerrors = []\n\nfor v in np.unique(train['period']):\n    model = period_model.fit(design_matrix(train[train['period'] == v]), train[train['period'] == v].loc[:, 'duration'])\n    errors = np.append(errors, test[test['period'] == v]['duration'] - period_model.predict(design_matrix(test[test['period'] == v])))\n\nperiod_rmse = rmse(np.array(errors))\nperiod_rmse","95d2159d":"speed_model = LinearRegression()\nspeed_model = model.fit(design_matrix(train), train['speed'])\n\n# Speed in miles\/hr. Duration is measured in seconds, and there are 3600 seconds in an hour.\navg = (test['distance'] * 3600) \/ (speed_model.predict(design_matrix(test)))\n\nspeed_rmse = rmse(test['duration'] - avg)\nspeed_rmse","7c05d09a":"speed_model.predict(design_matrix(train))","9bb123f0":"speed_model.score(design_matrix(train), train['duration'])","a7708576":"tree_speed_model = LinearRegression()\nchoices = ['period', 'region', 'weekend']\n\ndef duration_error(predictions, observations):\n    \"\"\"Error between predictions (array) and observations (data frame)\"\"\"\n    return predictions - observations['duration']\n\ndef speed_error(predictions, observations):\n    \"\"\"Duration error between speed predictions and duration observations\"\"\"\n    return duration_error(observations['distance'] * 3600 \/ predictions, observations)\n\ndef tree_regression_errors(outcome='duration', error_fn=duration_error):\n    \"\"\"Return errors for all examples in test using a tree regression model.\"\"\"\n    errors = []\n    for vs in train.groupby(choices).size().index:\n        v_train, v_test = train, test\n        for v, c in zip(vs, choices):\n            v_train = v_train[v_train[c]==v]\n            v_test = v_test[v_test[c]==v]\n            print(v_train.shape, v_test.shape)\n        tree_speed_model.fit(design_matrix(v_train), v_train.loc[:, outcome])\n        errors = np.append(errors, error_fn(tree_speed_model.predict(design_matrix(v_test)), v_test))\n    return errors\n\nerrors = tree_regression_errors()\nerrors_via_speed = tree_regression_errors('speed', speed_error)\ntree_rmse = rmse(np.array(errors))\ntree_speed_rmse = rmse(np.array(errors_via_speed))\nprint('Duration:', tree_rmse, '\\nSpeed:', tree_speed_rmse)","ac262cf1":"models = ['constant', 'simple', 'linear', 'period', 'speed', 'tree', 'tree_speed']\npd.DataFrame.from_dict({\n    'Model': models,\n    'Test RMSE': [eval(m + '_rmse') for m in models]\n}).set_index('Model').plot(kind='barh')\nplt.xlabel('RMSE')\nplt.title('RMSE by Model');","c8ca7571":"A box plot that compares the distributions of taxi trip durations for each day using `train`.","b5d46e99":"RMSE on the test set for a linear regression model fitted to the training set without regularization, using the `design_matrix` defined by the previous design_matrix function.","64c7856b":"After some research, the abnormality near 2016-01-23 is caused by an extreme blizzard on that date. This visualization allows me to identify which dates the blizzard affected in addiction to 2016-01-23.","1b0641d8":"## Exploratory Data Analysis","fa5d46ea":"Adding a column 'date' to the dataframe that contains the date of pickup without the time, formatted as a datetime.date value.","fc8c4fca":"### From our summary bar plot, the last regression model is what should be used to predict taxi ride durations.","7b7c05da":"The period model could possibly outperform the linear regression model because it focuses on less ranges of hours, so there are less covariates and a less complex model. With a less complex model, overfitting is less likely to be a problem.","087fd233":"## Loading the Data","fd38743e":"Finding a different linear regression model for `period`, `region`, and `weekend`, fitting to `speed` on the training set and predicting `speed` on the test set, and finding the RMSE.","4d967cac":"#### Instead of predicting duration directly, an alternative is to predict the average speed of the taxi ride using linear regression, then compute an estimate of the duration from the predicted speed and observed distance for each ride.","01eb15ed":"An overlaid histogram comparing the distributions of average speeds for taxi rides that start in the early morning (period 1), day (period 2), and night (period 3).","9e030b4e":"As especially shown by the Jan 10th, 16th, and 17th weekend dates, the medians are generally lower for weekends compared to weekdays. The upper quartiles of those three date show more distinguishably that the ride durations during weekends are shorter than weekdays. ","a1bbdb5c":"RMSE on the test set for a simple linear regression model that uses only the distance of the taxi ride as a feature and includes an intercept.","61e27bea":"Removing atypical dates.","fc630370":"## Predict Taxi Ride Durations","08d6a30d":"Adding a `region` column to `train` that categorizes each pick-up location as 0, 1, or 2 based on the value of each point's first principal component, such that an equal number of points fall into each region.","e11ca42e":"## Model Selection","1bc46717":"Root mean squared error (RMSE) on the test set for a constant model that always predicts the mean duration of all training set taxi rides.","c0888b8d":"A scatter diagram of the Manhattan taxi rides. It closely resembles the shape of Manhattan Island. There is an empty white rectangle located where Central Park is because cars are not allowed there.","2e843936":"Creating a feature matrix with these features, coverting quantitative features to standard units and categorical features to dummy variables using one-hot encoding. `period` is not included because it is a linear combination of `hour`. `weekend` is not included because it is a linear combination of `day`. `speed` is not included because it was computed from `duration`.","5713ebe4":"The model's goal is to accurately predict the travel time of a taxi in New York. The dataset was too large for me to download, so the current dataset was shortened, consisting of the trips within the month of January 2016 that began and ended on Manhattan Island, New York. This dataset now consists of 82,800 different taxi ride trips.\n\nThe dataset includes:\n\n* `pickup_datetime`: date and time when the meter was engaged\n* `dropoff_datetime`: date and time when the meter was disengaged\n* `pickup_lon`: the longitude where the meter was engaged\n* `pickup_lat`: the latitude where the meter was engaged\n* `dropoff_lon`: the longitude where the meter was disengaged\n* `dropoff_lat`: the latitude where the meter was disengaged\n* `passengers`: the number of passengers in the vehicle (driver entered value)\n* `distance`: trip distance\n* `duration`: duration of the trip in seconds\n\nThe goal is to redict `duration` from the other columns.","1fa9771a":"RMSE in the duration predicted by a model that first predicts speed as a linear combination of features from `design_matrix`, fitted on the training set, then predicts duration from the predicted speed and observed distance.","19051615":"### Train Test Split","6c25b15a":"#### Creating a feature matrix for my linear regression model","945017e7":"RMSE on the test set for a model that first chooses linear regression parameters based on the observed period of the taxi ride, then predicts the duration using those parameters. An unregularized linear regression model is fit for each possible value of `period` in the training set. `design_matrix` was used again for features.","927f7cd4":"**Using the pickup time to add new columns to the `train` and `test` dataframes. Five new columns are added:**\n\n* `hour`: The integer hour of the pickup time. E.g., a 3:45pm taxi ride would have 15 as the hour. A 12:20am ride would have 0.\n* `day`: The day of the week with Monday=0, Sunday=6.\n* `weekend`: 1 if and only if the day is Saturday or Sunday.\n* `period`: 1 for early morning (12am-6am), 2 for daytime (6am-6pm), and 3 for night (6pm-12pm).\n* `speed`: Average speed in miles per hour.","f0b71b68":"Checking for abnormal days.","ed3e1887":"### Choosing which days to include as training data in my regression model.","f0e47b5e":"## Feature Engineering","387d879a":"A summary of the results:","329ff80e":"#### Selecting a regression model to predict the duration of a taxi ride."}}