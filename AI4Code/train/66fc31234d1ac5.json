{"cell_type":{"03c6e8e7":"code","8bb145cc":"code","4363dc35":"code","5e4176d0":"code","1f201433":"code","e33513c6":"code","5c64e596":"code","1f2695be":"code","adcf10b5":"code","b7b40216":"code","60494484":"code","dab680fe":"code","dfc7f487":"code","a7cc5af2":"code","2b0e5a7c":"code","36326b1c":"code","ff1fab42":"code","52f56ac3":"code","ece3bc30":"code","02476f08":"code","2fd21306":"code","41119dd9":"code","ad449c5d":"code","b527d404":"code","064de759":"code","6f03046c":"markdown","a5c9be71":"markdown","5b7728b5":"markdown"},"source":{"03c6e8e7":"import gc\nimport os\nimport numpy as np\nimport pandas as pd\nfrom pylab import rcParams\nimport matplotlib.pyplot as plt\nfrom sklearn.metrics import mean_squared_error\nfrom scipy.stats import probplot\nimport datetime as dt\nfrom datetime import date\nfrom datetime import timedelta\nfrom fbprophet import Prophet\nimport optuna\nimport warnings\n%matplotlib inline\nwarnings.filterwarnings(\"ignore\")","8bb145cc":"data0 = pd.read_csv(\"..\/input\/nepse-data\/data\/ADBL_2000-01-01_2021-12-31.csv\")\nprint(len(data0))\ndata0[-5:]","4363dc35":"data0.info()","5e4176d0":"data0['Date2']=pd.to_datetime(data0['Date'],format='%Y-%m-%d')\ndata0['Date2']\n# minutely data","1f201433":"data0.info()","e33513c6":"data1=data0[['Date2','Close Price']].sort_values('Date2').reset_index(drop=True)\ndata1","5c64e596":"item1=data1[-2000:]\n\nitem1.columns = ['ds','y']\nitem1.y = item1.y.astype('float')\nitem1.ds = item1.ds.astype('datetime64')\nrcParams['figure.figsize'] = 20,5\nplt.plot(item1.ds, item1.y)","1f2695be":"def objective_variable(train, valid):\n\n    def objective(trial):\n            params = {\n                    'changepoint_range' : trial.suggest_discrete_uniform('changepoint_range', 0.80, 0.95, 0.01),\n                    'n_changepoints' : trial.suggest_int('n_changepoints', 20, 35),\n                    'changepoint_prior_scale' : trial.suggest_discrete_uniform('changepoint_prior_scale',0.01, 0.50, 0.01),\n                    'seasonality_prior_scale' : trial.suggest_discrete_uniform('seasonality_prior_scale',1, 25, 0.1),\n            }\n\n            # fit_model\n            model = Prophet(\n                changepoint_range = params['changepoint_prior_scale'],\n                n_changepoints=params['n_changepoints'],\n                changepoint_prior_scale=params['changepoint_prior_scale'],\n                seasonality_prior_scale = params['seasonality_prior_scale'],\n            )\n            print(model)\n\n            model.fit(train)\n            future = model.make_future_dataframe(periods=len(valid))\n            forecast = model.predict(future)\n            valid_forecast = forecast.tail(len(valid))\n            val_mape = np.mean(np.abs((valid_forecast.yhat-valid.y)\/valid.y))*100\n\n            return val_mape\n\n    return objective\n\ndef optuna_parameter(train, valid):\n    study = optuna.create_study(sampler=optuna.samplers.RandomSampler(seed=10))\n    study.optimize(objective_variable(train, valid), timeout=500)\n    optuna_best_params = study.best_params\n\n    return study","adcf10b5":"item1['ds']","b7b40216":"df_train = item1[item1['ds'] < '2018-01-01']\ndf_valid = item1[(item1['ds'] >= '2018-01-01') & (item1['ds'] < '2022-01-01')]\n#df_test = item1[item1['ds'] >= '2022-01-01']\n\nstudy = optuna_parameter(df_train, df_valid)","60494484":"study.trials_dataframe()","dab680fe":"# shows the scores from all trials\noptuna.visualization.plot_optimization_history(study)","dfc7f487":"# interactively visualizes the hyperparameters and scores\noptuna.visualization.plot_parallel_coordinate(study)","a7cc5af2":"# shows the evolution of the search\noptuna.visualization.plot_slice(study)","2b0e5a7c":"# parameter interactions on an interactive chart.\noptuna.visualization.plot_contour(study, params=['changepoint_prior_scale','n_changepoints','seasonality_prior_scale','changepoint_prior_scale'])","36326b1c":"# Visualize parameter importances.\noptuna.visualization.plot_param_importances(study)","ff1fab42":"# Visualize empirical distribution function\noptuna.visualization.plot_edf(study)","52f56ac3":"# before(without) tuning\norg_model=Prophet()\n# after(with) tuning\nbest_model=Prophet(\n    changepoint_range = study.best_params['changepoint_prior_scale'],\n    n_changepoints=study.best_params['n_changepoints'],\n    seasonality_prior_scale = study.best_params['seasonality_prior_scale'],\n    changepoint_prior_scale=study.best_params['changepoint_prior_scale'],\n)","ece3bc30":"Best_trial=study.best_trial.params\nprint(Best_trial)","02476f08":"best_model.fit(item1)\norg_model.fit(item1)","2fd21306":"future=best_model.make_future_dataframe(periods=365*2+2)\nprint(future)\norg_future=org_model.make_future_dataframe(periods=365*2+2)\nprint(org_future)","41119dd9":"forecast=best_model.predict(future)\nfigure = best_model.plot(forecast)\nfigure.show()","ad449c5d":"forecast[['ds','yhat']][-365*2:]","b527d404":"org_forecast=org_model.predict(org_future)\nfigure = org_model.plot(org_forecast)\nfigure.show()","064de759":"org_forecast[['ds','yhat']][-365*2:]","6f03046c":"# ADBL Stock Prediction by Prophet with\/without Optuna\nhttps:\/\/www.kaggle.com\/stpeteishii\/adbl-stock-prediction-prophet-with-without-optuna","a5c9be71":"# Fit and Predict","5b7728b5":"# Optuna tuning"}}