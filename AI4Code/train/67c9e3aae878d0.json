{"cell_type":{"153776c6":"code","dac7adb9":"code","53eb703d":"code","07466745":"code","376dc2f2":"code","d0ad96cd":"code","3cdd0195":"code","39c9f7a7":"code","36762190":"code","9fe8dadb":"code","5783a3df":"code","19760f88":"code","eaa884fc":"code","fb0a5863":"code","31a12f70":"code","c1664dc3":"code","047d62fe":"code","11f34c25":"code","40312b8c":"code","fdb2d52c":"code","7bb08319":"code","a8ad3cdf":"code","432c6c33":"code","0baad304":"code","3b5060ba":"code","aab5ad36":"code","a73104fd":"code","acd0dfb6":"code","7680005b":"code","d8ab0603":"code","b4346fac":"code","8632bdca":"code","49d7b40d":"code","60730ab2":"code","60f7a4a0":"code","1808f795":"code","9ee5162d":"markdown","d537389e":"markdown","517f68b9":"markdown","df5a6e2d":"markdown","da5bdd2c":"markdown","71c5ca0a":"markdown","5b9a25ba":"markdown","59912164":"markdown","8e1aec1e":"markdown","99471094":"markdown","74a8fca8":"markdown"},"source":{"153776c6":"import numpy as np\nimport pandas as pd\nimport matplotlib.pyplot as plt\nimport seaborn as sns\nfrom sklearn import ensemble, metrics\nfrom sklearn import linear_model, preprocessing\nimport xgboost as xgb\n\nparser = lambda date: pd.to_datetime(date, format='%d.%m.%Y')\n\ntrain = pd.read_csv('..\/input\/sales_train.csv', parse_dates=['date'], date_parser=parser)\ntest = pd.read_csv('..\/input\/test.csv')\nitems = pd.read_csv('..\/input\/items.csv')\nitem_cats = pd.read_csv('..\/input\/item_categories.csv')\nshops = pd.read_csv('..\/input\/shops.csv')\nprint('train:', train.shape, 'test:', test.shape, 'items:', items.shape, 'item_cats:', item_cats.shape, 'shops:', shops.shape)","dac7adb9":"train.head()","53eb703d":"test.head()","07466745":"items.head()","376dc2f2":"item_cats.head()","d0ad96cd":"shops.head()","3cdd0195":"print(train['date_block_num'].max())","39c9f7a7":"print(train['item_cnt_day'].describe())","36762190":"test_only = test[~test['item_id'].isin(train['item_id'].unique())]['item_id'].unique()\nprint('test only items:', len(test_only))","9fe8dadb":"# drop duplicates\nsubset = ['date','date_block_num','shop_id','item_id','item_cnt_day']\nprint(train.duplicated(subset=subset).value_counts())\ntrain.drop_duplicates(subset=subset, inplace=True)","5783a3df":"# drop shops&items not in test data\ntest_shops = test.shop_id.unique()\ntest_items = test.item_id.unique()\ntrain = train[train.shop_id.isin(test_shops)]\ntrain = train[train.item_id.isin(test_items)]\n\nprint('train:', train.shape)","19760f88":"from itertools import product\n\n# create all combinations\nblock_shop_combi = pd.DataFrame(list(product(np.arange(34), test_shops)), columns=['date_block_num','shop_id'])\nshop_item_combi = pd.DataFrame(list(product(test_shops, test_items)), columns=['shop_id','item_id'])\nall_combi = pd.merge(block_shop_combi, shop_item_combi, on=['shop_id'], how='inner')\nprint(len(all_combi), 34 * len(test_shops) * len(test_items))\n\n# group by monthly\ntrain_base = pd.merge(all_combi, train, on=['date_block_num','shop_id','item_id'], how='left')\ntrain_base['item_cnt_day'].fillna(0, inplace=True)\ntrain_grp = train_base.groupby(['date_block_num','shop_id','item_id'])","eaa884fc":"# summary count by month\ntrain_monthly = pd.DataFrame(train_grp.agg({'item_cnt_day':['sum','count']})).reset_index()\ntrain_monthly.columns = ['date_block_num','shop_id','item_id','item_cnt','item_order']\nprint(train_monthly[['item_cnt','item_order']].describe())\n# trim count\ntrain_monthly['item_cnt'].clip(0, 20, inplace=True)\n\ntrain_monthly.head()","fb0a5863":"item_grp = item_cats['item_category_name'].apply(lambda x: str(x).split(' ')[0])\nitem_grp = pd.Categorical(item_grp).codes\nitem_cats['item_group'] = item_grp\n#item_cats = item_cats.join(pd.get_dummies(item_grp, prefix='item_group', drop_first=True))\n\nitems = pd.merge(items, item_cats.loc[:,['item_category_id','item_group']], on=['item_category_id'], how='left')\n\ncity = shops.shop_name.apply(lambda x: str.replace(x, '!', '')).apply(lambda x: x.split(' ')[0])\nshops['city'] = pd.Categorical(city).codes","31a12f70":"_ = '''\nfrom sklearn.feature_extraction.text import TfidfVectorizer\n\nfeature_cnt = 25\ntfidf = TfidfVectorizer(max_df=0.6, max_features=feature_cnt, ngram_range=(1, 2))\ntxtFeatures = pd.DataFrame(tfidf.fit_transform(items['item_name']).toarray())\ncols = txtFeatures.columns\nfor i in range(feature_cnt):\n    items['item_name_tfidf_' + str(i)] = txtFeatures[cols[i]]\n'''","c1664dc3":"# By shop,item\ngrp = train_monthly.groupby(['shop_id', 'item_id'])\ntrain_shop = grp.agg({'item_cnt':['mean','median','std'],'item_order':'mean'}).reset_index()\ntrain_shop.columns = ['shop_id','item_id','cnt_mean_shop','cnt_med_shop','cnt_std_shop','order_mean_shop']\nprint(train_shop[['cnt_mean_shop','cnt_med_shop','cnt_std_shop']].describe())\n\ntrain_shop.head()","047d62fe":"# By shop,item_group\ntrain_cat_monthly = pd.merge(train_monthly, items, on=['item_id'], how='left')\ngrp = train_cat_monthly.groupby(['shop_id', 'item_group'])\ntrain_shop_cat = grp.agg({'item_cnt':['mean']}).reset_index()\ntrain_shop_cat.columns = ['shop_id','item_group','cnt_mean_shop_cat']\nprint(train_shop_cat.loc[:,['cnt_mean_shop_cat']].describe())\n\ntrain_shop_cat.head()","11f34c25":"# By month,shop,item At previous\ntrain_prev = train_monthly.copy()\ntrain_prev['date_block_num'] = train_prev['date_block_num'] + 1\ntrain_prev.columns = ['date_block_num','shop_id','item_id','cnt_prev','order_prev']\n\nfor i in [2,12]:\n    train_prev_n = train_monthly.copy()\n    train_prev_n['date_block_num'] = train_prev_n['date_block_num'] + i\n    train_prev_n.columns = ['date_block_num','shop_id','item_id','cnt_prev' + str(i),'order_prev' + str(i)]\n    train_prev = pd.merge(train_prev, train_prev_n, on=['date_block_num','shop_id','item_id'], how='left')\n\ntrain_prev.head()","40312b8c":"# By month,shop,item_group At previous\ngrp = pd.merge(train_prev, items, on=['item_id'], how='left').groupby(['date_block_num','shop_id','item_group'])\ntrain_cat_prev = grp['cnt_prev'].mean().reset_index()\ntrain_cat_prev = train_cat_prev.rename(columns={'cnt_prev':'cnt_prev_cat'})\nprint(train_cat_prev.loc[:,['cnt_prev_cat']].describe())\n\ntrain_cat_prev.head()","fdb2d52c":"train_piv = train_monthly.pivot_table(index=['shop_id','item_id'], columns=['date_block_num'], values='item_cnt', aggfunc=np.sum, fill_value=0)\ntrain_piv = train_piv.reset_index()\ntrain_piv.head()","7bb08319":"# MACD At previous\ncol = np.arange(34)\npivT = train_piv[col].T\nema_s = pivT.ewm(span=12).mean().T\nema_l = pivT.ewm(span=26).mean().T\nmacd = ema_s - ema_l\nsig = macd.ewm(span=9).mean()\n\nema_list = []\nfor c in col:\n  sub_ema = pd.concat([train_piv.loc[:,['shop_id','item_id']],\n      pd.DataFrame(ema_s.loc[:,c]).rename(columns={c:'cnt_ema_s_prev'}),\n      pd.DataFrame(ema_l.loc[:,c]).rename(columns={c:'cnt_ema_l_prev'}),\n      pd.DataFrame(macd.loc[:,c]).rename(columns={c:'cnt_macd_prev'}),\n      pd.DataFrame(sig.loc[:,c]).rename(columns={c:'cnt_sig_prev'})], axis=1)\n  sub_ema['date_block_num'] = c + 1\n  ema_list.append(sub_ema)\n    \ntrain_ema_prev = pd.concat(ema_list)\ntrain_ema_prev.head()","a8ad3cdf":"fig, ax = plt.subplots(nrows=1, ncols=2, figsize=(15, 4))\n\ntrain_monthly.groupby(['date_block_num']).sum().reset_index()['item_cnt'].plot(ax=ax[0])\ntrain_cat_monthly = pd.merge(train_monthly, items, on=['item_id'], how='left')\ntrain_cat_monthly.pivot_table(index=['date_block_num'], columns=['item_group'], values='item_cnt', aggfunc=np.sum, fill_value=0).plot(ax=ax[1], legend=False)","432c6c33":"# Price mean by month,shop,item\ntrain_price = train_grp['item_price'].mean().reset_index()\nprice = train_price[~train_price['item_price'].isnull()]\n\n# last price by shop,item\nlast_price = price.drop_duplicates(subset=['shop_id', 'item_id'], keep='last').drop(['date_block_num'], axis=1)\n\n# null price by shop,item\n'''\nmean_price = price.groupby(['item_id'])['item_price'].mean().reset_index()\nresult_price = pd.merge(test, mean_price, on=['item_id'], how='left').drop('ID', axis=1)\npred_price_set = result_price[result_price['item_price'].isnull()]\n'''\nuitem = price['item_id'].unique()\npred_price_set = test[~test['item_id'].isin(uitem)].drop('ID', axis=1)","0baad304":"_ = '''\n'''\nif len(pred_price_set) > 0:\n    train_price_set = pd.merge(price, items, on=['item_id'], how='inner')\n    pred_price_set = pd.merge(pred_price_set, items, on=['item_id'], how='inner').drop(['item_name'], axis=1)\n    reg = ensemble.ExtraTreesRegressor(n_estimators=25, n_jobs=-1, max_depth=15, random_state=42)\n    reg.fit(train_price_set[pred_price_set.columns], train_price_set['item_price'])\n    pred_price_set['item_price'] = reg.predict(pred_price_set)\n\ntest_price = pd.concat([last_price, pred_price_set], join='inner')\ntest_price.head()","3b5060ba":"price_max = price.groupby(['item_id']).max()['item_price'].reset_index()\nprice_max.rename(columns={'item_price':'item_max_price'}, inplace=True)\nprice_max.head()","aab5ad36":"train_price_a = pd.merge(price, price_max, on=['item_id'], how='left')\ntrain_price_a['discount_rate'] = 1 - (train_price_a['item_price'] \/ train_price_a['item_max_price'])\ntrain_price_a.drop('item_max_price', axis=1, inplace=True)\ntrain_price_a.head()","a73104fd":"test_price_a = pd.merge(test_price, price_max, on=['item_id'], how='left')\ntest_price_a.loc[test_price_a['item_max_price'].isnull(), 'item_max_price'] = test_price_a['item_price']\ntest_price_a['discount_rate'] = 1 - (test_price_a['item_price'] \/ test_price_a['item_max_price'])\ntest_price_a.drop('item_max_price', axis=1, inplace=True)\ntest_price_a.head()","acd0dfb6":"def mergeFeature(source): \n  d = source\n  d = pd.merge(d, items, on=['item_id'], how='left').drop('item_group', axis=1)\n  d = pd.merge(d, item_cats, on=['item_category_id'], how='left')\n  d = pd.merge(d, shops, on=['shop_id'], how='left')\n\n  d = pd.merge(d, train_shop, on=['shop_id','item_id'], how='left')\n  d = pd.merge(d, train_shop_cat, on=['shop_id','item_group'], how='left')\n  d = pd.merge(d, train_prev, on=['date_block_num','shop_id','item_id'], how='left')\n  d = pd.merge(d, train_cat_prev, on=['date_block_num','shop_id','item_group'], how='left')\n  d = pd.merge(d, train_ema_prev, on=['date_block_num','shop_id','item_id'], how='left')\n  \n  d['month'] = d['date_block_num'] % 12\n  days = pd.Series([31,28,31,30,31,30,31,31,30,31,30,31])\n  d['days'] = d['month'].map(days).astype(np.int8)\n  \n  d.drop(['shop_id','shop_name','item_id','item_name','item_category_id','item_category_name','item_group'], axis=1, inplace=True)\n  d.fillna(0.0, inplace=True)\n  return d","7680005b":"train_set = train_monthly[train_monthly['date_block_num'] >= 12]\n\ntrain_set = pd.merge(train_set, train_price_a, on=['date_block_num','shop_id','item_id'], how='left')\ntrain_set = mergeFeature(train_set)\n\ntrain_set = train_set.join(pd.DataFrame(train_set.pop('item_order'))) # move to last column\n\nX_train = train_set.drop(['item_cnt'], axis=1)\nY_train = train_set['item_cnt']\nX_train.head()","d8ab0603":"test_set = test.copy()\ntest_set['date_block_num'] = 34\n\ntest_set = pd.merge(test_set, test_price_a, on=['shop_id','item_id'], how='left')\ntest_set = mergeFeature(test_set)\n\ntest_set['item_order'] = test_set['order_prev']\ntest_set.loc[test_set['item_order'] == 0, 'item_order'] = 1\n\nX_test = test_set.drop(['ID'], axis=1)\nX_test.head()","b4346fac":"#reg = ensemble.ExtraTreesRegressor(n_estimators=25, n_jobs=-1, max_depth=15, random_state=42)\nreg = ensemble.GradientBoostingRegressor(n_estimators=1000, learning_rate=0.05, max_depth=3, \n                                            max_features='sqrt', loss='huber', random_state=42)\n#reg = xgb.XGBRegressor(n_estimators=1000, max_depth=4, learning_rate=0.05, subsample=0.6, colsample_bytree=0.6)\n#reg = xgb.XGBRegressor(n_estimators=25, max_depth=12, learning_rate=0.1, subsample=1, colsample_bytree=0.9, random_state=42, eval_metric='rmse')","8632bdca":"#train_set.corr()['item_cnt'].sort_values(ascending=False)","49d7b40d":"_ = '''\nfrom sklearn.model_selection import cross_val_predict\nfrom sklearn.model_selection import ShuffleSplit\n\nreg = ensemble.ExtraTreesRegressor(n_estimators=25, n_jobs=-1, max_depth=15, random_state=42)\n\n#pred = cross_val_predict(reg, X_train, Y_train, cv=6)\n#print('RMSE:', np.sqrt(metrics.mean_squared_error(np.log1p(Y_train.clip(0.,20.)), np.log1p(pred.clip(0.,20.)))))\n\nss = ShuffleSplit(n_splits=1, test_size=0.03, random_state=42)\nfor train_index, test_index in ss.split(X_train):\n    cnt_sub_scaler = preprocessing.StandardScaler();\n    reg.fit(X_train.iloc[train_index], cnt_sub_scaler.fit_transform(Y_train.iloc[train_index].clip(0.,20.).values.reshape(-1, 1)).ravel())\n    pred_cnt = cnt_sub_scaler.inverse_transform(reg.predict(X_train.iloc[test_index]))\n    \n    #reg.fit(X_train.iloc[train_index], Y_train.iloc[train_index].clip(0.,20.))\n    #pred_cnt = reg.predict(X_train.iloc[test_index])\n    \n    print('RMSE:', np.sqrt(metrics.mean_squared_error(Y_train.iloc[test_index].clip(0.,20.), pred_cnt.clip(0.,20.)))) #1.38235624903\n'''","60730ab2":"_ = '''\n'''\nx1 = train_set[train_set['date_block_num'] < 33]\ny1 = x1['item_cnt']\nx1 = x1.drop(['item_cnt'], axis=1)\n\nx2 = train_set[train_set['date_block_num'] == 33]\ny2 = x2['item_cnt']\nx2 = x2.drop(['item_cnt'], axis=1)\n\nreg.fit(x1, y1)\npred_cnt = reg.predict(x2)\nprint('RMSE:', np.sqrt(metrics.mean_squared_error(y2.clip(0.,20.), pred_cnt.clip(0.,20.)))) #0.20783645197081926\n#reg.fit(x1, np.log1p(y1))\n#pred_cnt = reg.predict(x2)\n#print('RMSE:', np.sqrt(metrics.mean_squared_error(y2.clip(0.,20.), np.expm1(pred_cnt).clip(0.,20.))))\n\ncol = [c for c in train_set.columns if c not in ['item_cnt']]\nfeature_imp = pd.DataFrame(reg.feature_importances_, index=col, columns=[\"importance\"])\nfeature_imp.sort_values(\"importance\", ascending=False).head(30)","60f7a4a0":"assert(X_train.columns.isin(X_test.columns).all())\n\nreg.fit(X_train, Y_train)\npred_cnt = reg.predict(X_test)\n\nresult = pd.DataFrame({\n    \"ID\": test[\"ID\"],\n    \"item_cnt_month\": pred_cnt.clip(0. ,20.)\n})\nresult.to_csv(\"submission.csv\", index=False)","1808f795":"print(len(pred_cnt[pred_cnt > 20]))\nresult.head(30)","9ee5162d":"### Feature creation","d537389e":"## Data preprocessing","517f68b9":"### Lags","df5a6e2d":"## Evaluation","da5bdd2c":"## Predict","71c5ca0a":"### Crosstab","5b9a25ba":"### Discount rate","59912164":"## Data preparation","8e1aec1e":"## Aggregate","99471094":"## Regressor","74a8fca8":"### Item prices"}}