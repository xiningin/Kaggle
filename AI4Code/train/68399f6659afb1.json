{"cell_type":{"ef789db4":"code","ef9d98b9":"code","cc275243":"code","4db27ab9":"code","1e49e70e":"code","95d75d29":"code","38bf8023":"code","8ded22af":"code","557bfc4e":"code","b77af7b5":"markdown","43595688":"markdown","43971100":"markdown","3ed86c2d":"markdown","267f2067":"markdown","7b64a071":"markdown","fbb13926":"markdown","c83d82c4":"markdown","bf2a30a3":"markdown","9e90824c":"markdown"},"source":{"ef789db4":"# 1. Enable Internet in the Kernel (Settings side pane)\n\n# 2. Curl cache may need purged if v0.1.6 cannot be found (uncomment if needed). \n# !curl -X PURGE https:\/\/pypi.org\/simple\/kaggle-environments\n\n# ConnectX environment was defined in v0.1.6\n!pip install 'kaggle-environments>=0.1.6'","ef9d98b9":"from kaggle_environments import evaluate, make, utils\n\nenv = make(\"connectx\", debug=True)\nenv.render()","cc275243":"def my_agent(observation, configuration):\n    PLAYER = observation.mark\n    OPPONENT = 3 - PLAYER\n\n    def make_move(board, move, player):\n        for i in range(5, -1, -1):\n            new_piece = move + 7*i\n            if board[new_piece] == 0:\n                board[new_piece] = player\n                return board, new_piece\n        return None, None # Illegal move\n\n    def check_win(board, move, player):\n        if board[move] != 0: # Full Column\n            return False\n\n        _, new_piece = make_move(board, move, player)\n        # check horizontal spaces\n        for j in range(4):\n            if new_piece + j > 41:\n                break\n            if (new_piece + j) % 7 < 3:\n                continue\n            if board[new_piece + j] == player and board[new_piece + j - 1] == player and board[new_piece + j - 2] == player and board[new_piece + j - 3] == player:\n                return True\n\n        # check vertical spaces\n        for j in range(4):\n            if new_piece + j*7 > 41:\n                break\n            if new_piece +j*7 < 21:\n                continue\n            if board[new_piece + j*7] == player and board[new_piece + j*7 - 7] == player and board[new_piece + j*7 - 14] == player and board[new_piece + j*7 - 21] == player:\n                return True\n\n        # check diagonal descending spaces\n        for j in range(4):\n            if new_piece + j*8 > 41:\n                break\n            if new_piece + j*8 < 24 or (new_piece + j*8) % 7 < 3:\n                continue\n            if board[new_piece + j*8] == player and board[new_piece + j*8 - 8] == player and board[new_piece + j*8 - 16] == player and board[new_piece + j*8 - 24] == player:\n                return True\n\n        # check diagonal ascending spaces\n        for j in range(4):\n            if new_piece + j*6 > 41:\n                break\n            if (new_piece + j*6) % 7 > 3 or new_piece + j*6 < 21:\n                continue\n            if board[new_piece + j*6] == player and board[new_piece + j*6 - 6] == player and board[new_piece + j*6 - 12] == player and board[new_piece + j*6 - 18] == player:\n                return True\n\n        return False\n    \n    move_order = [3, 2, 4, 1, 5, 0, 6]\n    for i in range(configuration.columns):\n        if check_win(observation.board.copy(), i, PLAYER):\n            return i\n        else:\n            for j in range(configuration.columns):\n                new_board, _ = make_move(observation.board.copy(), i, PLAYER)\n                if new_board is not None and i in move_order and check_win(new_board.copy(), j, OPPONENT):\n                    move_order.remove(i)\n\n\n    for i in range(configuration.columns):\n        if check_win(observation.board.copy(), i, OPPONENT):\n            return i\n    \n    # Hardcoding the defense to an early game weakness\n    if observation.board[38] == OPPONENT:\n        if observation.board[37] == OPPONENT and observation.board[39] == 0:\n            return 4\n        elif observation.board[39] == OPPONENT and observation.board[37] == 0:\n            return 2\n    \n    assert move_order is not None\n    for i in move_order:\n        if observation.board[i] == 0:\n            return i\n    \n    # dead end\n    from random import choice\n    return choice([c for c in range(configuration.columns) if observation.board[c] == 0])","4db27ab9":"env.reset()\n# Play as the first agent against default \"random\" agent.\nenv.run([my_agent, \"random\"])\nenv.render(mode=\"ipython\", width=500, height=450)","1e49e70e":"# Play as first position against random agent.\ntrainer = env.train([None, \"random\"])\nobservation = trainer.reset()\n\nwhile not env.done:\n    my_action = my_agent(observation, env.configuration)\n    print(\"My Action\", my_action)\n    observation, reward, done, info = trainer.step(my_action)\n    print(observation, reward)\n    # env.render(mode=\"ipython\", width=100, height=90, header=False, controls=False)\nenv.render()","95d75d29":"def mean_reward(rewards):\n    return sum(r[0] for r in rewards) \/ sum(r[0] + r[1] for r in rewards)\n\n# Run multiple episodes to estimate its performance.\nprint(\"My Agent vs Random Agent:\", mean_reward(evaluate(\"connectx\", [my_agent, \"random\"], num_episodes=1000)))\nprint(\"My Agent vs Negamax Agent:\", mean_reward(evaluate(\"connectx\", [my_agent, \"negamax\"], num_episodes=1)))","38bf8023":"# \"None\" represents which agent you'll manually play as (first or second player).\nenv.play([None, my_agent], width=500, height=450)","8ded22af":"import inspect\nimport os\n\ndef write_agent_to_file(function, file):\n    with open(file, \"a\" if os.path.exists(file) else \"w\") as f:\n        f.write(inspect.getsource(function))\n        print(function, \"written to\", file)\n\nwrite_agent_to_file(my_agent, \"submission.py\")","557bfc4e":"# Note: Stdout replacement is a temporary workaround.\nimport sys\nout = sys.stdout\nsubmission = utils.read_file(\"\/kaggle\/working\/submission.py\")\nagent = utils.get_last_callable(submission)\nsys.stdout = out\n\nenv = make(\"connectx\", debug=True)\nenv.run([agent, agent])\nprint(\"Success!\" if env.state[0].status == env.state[1].status == \"DONE\" else \"Failed...\")","b77af7b5":"# Validate Submission\nPlay your submission against itself.  This is the first episode the competition will run to weed out erroneous agents.\n\nWhy validate? This roughly verifies that your submission is fully encapsulated and can be run remotely.","43595688":"# Test your Agent","43971100":"# Submit to Competition\n\n1. Commit this kernel.\n2. View the commited version.\n3. Go to \"Data\" section and find submission.py file.\n4. Click \"Submit to Competition\"\n5. Go to [My Submissions](https:\/\/kaggle.com\/c\/connectx\/submissions) to view your score and episodes being played.","3ed86c2d":"# Create an Agent\n\nTo create the submission, an agent function should be fully encapsulated (no external dependencies).  \n\nWhen your agent is being evaluated against others, it will not have access to the Kaggle docker image.  Only the following can be imported: Python Standard Library Modules, gym, numpy, scipy, pytorch (1.3.1, cpu only), and more may be added later.\n\n","267f2067":"# Create ConnectX Environment","7b64a071":"# Play your Agent\nClick on any column to place a checker there (\"manually select action\").","fbb13926":"# Debug\/Train your Agent","c83d82c4":"# Write Submission File\n\n","bf2a30a3":"# Install kaggle-environments","9e90824c":"# Evaluate your Agent"}}