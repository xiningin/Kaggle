{"cell_type":{"95bf0e14":"code","db8ca347":"code","1710c146":"code","1bfb5850":"code","ff687d5a":"code","02c02bd4":"code","702ad674":"code","57170f0f":"code","3679a782":"code","466c3189":"code","c9105768":"code","8bd7a0a2":"code","2f81a68a":"code","9a7d7d9f":"code","460c8da4":"code","f57d1448":"code","7778c3c4":"code","7597b82b":"code","bb538d0e":"code","43f4d0b7":"code","ebebe621":"code","eae0a008":"code","f6ee5c8e":"code","e4bf5fd2":"markdown","29928d69":"markdown","1ebea595":"markdown","4227c381":"markdown","c4356087":"markdown","c5867787":"markdown","e27a8729":"markdown","c541f9dc":"markdown","5d829ad4":"markdown","d901ecbe":"markdown","95db31b3":"markdown","f0a1076d":"markdown","820639b3":"markdown","2b18700d":"markdown","554cae9d":"markdown","238ee585":"markdown","ea730b7c":"markdown","508c7495":"markdown","3ec311ae":"markdown","b89bdccb":"markdown","e456883a":"markdown","1c499d85":"markdown","74e8c89a":"markdown","fa1b0cd3":"markdown","1e8cebe0":"markdown","78eec71a":"markdown","e1b58aff":"markdown","494c40df":"markdown","c2e64d7e":"markdown","e90ccb5d":"markdown","828b34b4":"markdown","983b7203":"markdown","4f77ed99":"markdown","1b8f17da":"markdown","27006df4":"markdown","b74af506":"markdown","0e526ff8":"markdown","6fce454e":"markdown","37113b2d":"markdown","50da67e6":"markdown","cd1082df":"markdown","33b5e761":"markdown","e2df720c":"markdown","d1565da8":"markdown","8b4603e1":"markdown","71eacd34":"markdown","fff8c218":"markdown","3b60c3ee":"markdown","0817712e":"markdown","40d5b72e":"markdown","53988f38":"markdown","997dfc4b":"markdown","9949dcb6":"markdown"},"source":{"95bf0e14":"import numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\nimport os\n\n","db8ca347":"from fastai import *\nfrom fastai.vision import *\n\n# useful paths\ninput_path = Path('\/kaggle\/input') \ncovid_xray_path = input_path\/'xraycovid'\npneumonia_path = input_path\/'chest-xray-pneumonia\/chest_xray'\n\ncovid_df = pd.read_csv(covid_xray_path\/'metadata.csv')\ncovid_df.head()","1710c146":"covid_df.dropna(axis=1,inplace=True)\ncovid_df","1bfb5850":"covid_df.groupby('view').count()","ff687d5a":"covid_df.groupby('finding').count()","02c02bd4":"covid_df = covid_df[lambda x: x['view'] == 'PA']\ncovid_df","702ad674":"covid_df['finding'] = covid_df['finding'].apply(lambda x:'positive' if x == 'COVID-19' else 'negative')\ncovid_df","57170f0f":"def makeFilename(x = ''):\n    return covid_xray_path\/f'images\/{x}'\n\ncovid_df['filename'] = covid_df['filename'].apply(makeFilename)\ncovid_df = covid_df[['finding', 'filename']]\ncovid_df","3679a782":"\npneumonia_df = pd.DataFrame([], columns=['finding', 'filename'])\nfolders = ['train\/NORMAL', 'val\/NORMAL', 'test\/NORMAL']\nfor folder in folders:\n    fnames = get_image_files(pneumonia_path\/folder)\n    fnames = map(lambda x: ['negative', x], fnames)\n    df = pd.DataFrame(fnames, columns=['finding', 'filename'])\n    pneumonia_df = pneumonia_df.append(df, ignore_index = True)\n\n\n\nfolders = ['train\/PNEUMONIA', 'val\/PNEUMONIA', 'test\/PNEUMONIA']\nfor folder in folders:\n    fnames = get_image_files(pneumonia_path\/folder)\n    fnames = map(lambda x: ['negative', x], fnames)\n    df = pd.DataFrame(fnames, columns=['finding', 'filename'])\n    pneumonia_df = pneumonia_df.append(df, ignore_index = True)\n\npneumonia_df.info()","466c3189":"\nhealthy_df = pd.DataFrame([], columns=['finding', 'filename'])\nfolders = ['train\/NORMAL', 'val\/NORMAL', 'test\/NORMAL']\nfor folder in folders:\n    fnames = get_image_files(pneumonia_path\/folder)\n    fnames = map(lambda x: ['negative', x], fnames)\n    df = pd.DataFrame(fnames, columns=['finding', 'filename'])\n    healthy_df = healthy_df.append(df, ignore_index = True)\n    \npneumonia_df = pd.DataFrame([], columns=['finding', 'filename'])\nfolders = ['train\/PNEUMONIA', 'val\/PNEUMONIA', 'test\/PNEUMONIA']\nfor folder in folders:\n    fnames = get_image_files(pneumonia_path\/folder)\n    fnames = map(lambda x: ['negative', x], fnames)\n    df = pd.DataFrame(fnames, columns=['finding', 'filename'])\n    pneumonia_df = pneumonia_df.append(df, ignore_index = True)\n\npneumonia_df = pneumonia_df.sample(covid_df.shape[0]).reset_index(drop=True)\n\nhealthy_df = healthy_df.sample(covid_df.shape[0]).reset_index(drop=True)\n\nnegative_df = healthy_df.append(pneumonia_df, ignore_index = True)\n\nnegative_df.head()","c9105768":"df = covid_df.append(healthy_df, ignore_index = True)\ndf = df.sample(frac=1).reset_index(drop=True)\ndf.sample(20)\n","8bd7a0a2":"np.random.seed(42)\ndata = ImageDataBunch.from_df(\n        '\/', \n        df, \n        fn_col='filename',\n        label_col='finding',\n        ds_tfms=get_transforms(), ## data augmentation: flip horizozntally\n        size=224, \n        num_workers=4\n    ).normalize(imagenet_stats)\n\ndata\n","2f81a68a":"data.show_batch(rows=80, figsize=(21,21))","9a7d7d9f":"learn = cnn_learner(data, models.resnet50, metrics=error_rate)","460c8da4":"learn.fit_one_cycle(5)","f57d1448":"learn.fit_one_cycle(5)","7778c3c4":"learn.save('stage-1')","7597b82b":"learn.load('stage-1')\nlearn.unfreeze()\nlearn.lr_find()\nlearn.recorder.plot()","bb538d0e":"learn.fit_one_cycle(10, max_lr=slice(7e-5,2e-4))","43f4d0b7":"learn.save('stage-2')","ebebe621":"learn.fit_one_cycle(2, max_lr=slice(7e-5,2e-4))","eae0a008":"learn.load('stage-2')\ninterp = ClassificationInterpretation.from_learner(learn)\ninterp.plot_confusion_matrix()","f6ee5c8e":"# learn = cnn_learner(data, models.resnet50, metrics=error_rate)\n# learn.load('stage-3')\n# interp = ClassificationInterpretation.from_learner(learn)\nimg = open_image(input_path\/'testimg\/df1053d3e8896b53ef140773e10e26_gallery.jpeg')\nlearn.predict(img)","e4bf5fd2":"Let's first fit 10 cycles and see how it improves","29928d69":"## First case: COVID-19 patients and healthy patients","1ebea595":"That image is taken from https:\/\/radiopaedia.org\/images\/52197348 and it is an image of a positive patient.","4227c381":"# 1. Data Preparation","c4356087":"PA makes up the majority of the datapoints. Let's keep them and remove the rest.","c5867787":"As you can see we have 5856 pictures which is about 60 times larger than our covid_df.  \n\nSince we have 92 pictures in our covid_df, I decided to take an equal number of pictures of healthy patients and an equal number of picture of pneumonia patients. In other words, 92 covid_df images, 92 healthy patient images, and 92 pneumonia affected patients. As far as our analysis goes, we are really only interested in covid positive and covid negative. Therefore, both the healthy and pneumonia patients will be labeled as ```negative```","e27a8729":"Now, we can finally merge our dataframes to get the dataframe needed to build our [ImageDataBunch](https:\/\/docs.fast.ai\/vision.data.html).","c541f9dc":" The longest downward shape is found in the region around ```1e-4``` let's use that as our starting point","5d829ad4":"We are now ready to create the ImageDataBunch.","d901ecbe":"First of all, I would like to incorporate scans from other sources and see if accuracy and generalization might increase.\nToday, while I was about to pusblish this article, I found out that [MIT](https:\/\/www.technologyreview.com\/s\/615399\/coronavirus-neural-network-can-help-spot-covid-19-in-chest-x-ray-pneumonia\/) has released a database containing xrays images of covid patients. Next, I am going to incorporate MIT's database and see where we get.","95db31b3":"Results for the first case were already pretty solid in **Part 2**. We are going to first optimize the results for the first case and then optimize results for the second case. Then, if the two cases accuracy do not differ too much, we will be confident in our result and try to predict random images online.","f0a1076d":"Both cases have an error rate < 3%. Given the scarsity of data, this is a promising first result. Since using both models, covid-19 prediction seems to be consistent, we can be confident enough in its predictions.","820639b3":"learn2.fit_one_cycle(10)","2b18700d":"# Test","554cae9d":"NB: Following great suggestions, I received, I am gonna run the Convolutional Net on two dataBunch:\n\n- The first will have covid_df and healthy_df\n- The second one will have covid_df and pneumonia_df\n\nWe will then compare the perfomances and, hopefully, we will get comparable results so that we can have more confidence in our results.\n","238ee585":"## Second case: COVID-19 patients and pneumonia patients","ea730b7c":"learn2.load('learn2-stage-1')\nlearn2.unfreeze()\nlearn2.fit_one_cycle(4, max_lr=slice(7e-5,1e-4))","508c7495":"For simplicity, let's also rename the elements in column ```finding``` to be ```positive``` if the patient is suffering from COVID-19 and negative otherwise.","3ec311ae":"Looks like the error rate is not really moving. With 3.6% error rate we might be satisfied with this first results. We are going to save and plot the confusion matrix.","b89bdccb":"# 3. Optmize","e456883a":"### How are tests performed?","1c499d85":"The database only contains pictures of patients suffering from COVID-19. In order to build a classifier for xray images we first need to find similar x-ray images of people who are not suffering from the disease.\nIt turns out Kaggle has a database with chest x-ray images of patients suffering of pneumonia and healthy patients. Hence, we are going to use both sources images in our dataset.\n","74e8c89a":"That looks better. We are mainly interested in two columns: ```finding``` and ```filename```. The former tells us wether or not a patient is suffering from the virus whereas the latter tells us the finename. The other interesting column is ```view```. It turns out the view is the angle used when the scan is taken and the most frequently used is PA. PA view stands for Posteroanterior view.","fa1b0cd3":"## COVID-19-xray\n","1e8cebe0":"learn2.fit_one_cycle(10)","78eec71a":"## Second case: COVID-19 patients and pneumonia patients","e1b58aff":"Disclaimer: I am not a doctor nor a medical researcher. This work is only intended as a source of inspiration for further studies.","494c40df":"learn2.load('learn2-stage-1')\n\nlearn2.unfreeze()\n\nlearn2.lr_find()\n\nlearn2.recorder.plot()\n","c2e64d7e":"We notice straight away that we have a large number of NaN, let's remove them and see what we are left with","e90ccb5d":"# Using Deep Learning to detect COVID-19 presence from x-ray scans","828b34b4":"Looks like we can do better, let's run ten cycles more.","983b7203":"Let's run some more cycles","4f77ed99":"learn2.save('learn2-stage-1')\n","1b8f17da":"But first let's import necessary libraries","27006df4":"[Dr. Joseph Paul Cohen, Postdoctoral Fellow at University of Montreal](https:\/\/josephpcohen.com\/w\/), recently open sourced a [database](https:\/\/github.com\/ieee8023\/covid-chestxray-dataset) containing chest x-ray pictures of patients suffering from the COVID-19 disease. \n","b74af506":"It looks good. We are going to keep the 5.5% error for now and try the next data frame\n","0e526ff8":"# 2. Train Network using Fastai","6fce454e":"Since the error rate is 0, the confusion matrix shows we have no errors.","37113b2d":"df2 = covid_df.append(pneumonia_df, ignore_index = True)\ndf2 = df2.sample(frac=1).reset_index(drop=True)\nnp.random.seed(42)\ndata2 = ImageDataBunch.from_df(\n        '\/', \n        df2, \n        fn_col='filename',\n        label_col='finding',\n        ds_tfms=get_transforms(), ## data augmentation: flip horizozntally\n        size=224, \n        num_workers=4\n    ).normalize(imagenet_stats)\n\nlearn2 = cnn_learner(data2, models.resnet50, metrics=error_rate)\nlearn2.fit_one_cycle(5)","50da67e6":"The more the pandemic crisis progresses, the more it gets important that countries perform tests to help understand and stop the spread of COVID-19.\nUnfortunately, the capacity for COVID-19 testing is still low in many countries. ","cd1082df":"That's a nice error rate. Let's save ```learn2``` and starti optimizing","33b5e761":"The notebook is organized as follows:\n\n1. Data Preparation  \n\n2. Train Network using Fastai\n\n3. Optimize Network\n\n4. Test\n\n5. What's Next","e2df720c":"The standard COVID-19 tests are called PCR (Polymerase chain reaction) tests. This family of tests looks for the existence of antibodies of a given infection. Two main issues with this test are:\n\n1. a shortage a tests available worldwide\n2. a patient might be carring the virus without having symptoms. In this case the test fails to identify infected patients","d1565da8":"To my untrained eyes, it looks like the images look consistent. We are going to use a resnet50 and leverage Kaggle free GPU Quota. Let's start training ten cycles.","8b4603e1":"learn2.save('learn2-stage-2')","71eacd34":"Let's take random images from ```data``` to see if they look consistent.","fff8c218":"I obtained the 0% error rate after a updated my notebook on kaggle and used a balanced dataset. This error rate though, is probably due to the fact that I am still collecting data and would require much more images to have an more stable error rate.","3b60c3ee":" The longest downward shape is found in the region around ???????????```1e-4``` let's use that as our starting point","0817712e":"I am going to run the Convolutional Net using two training sets.\nThe first will have  covid_df and healthy_df\nThe second one will have covid_df and pneumonia_df\n\nWe will then compare the perfomances and, hopefully, we will get comparable results so that we can have more confidence in our results.","40d5b72e":"# What's next?","53988f38":"Finally, let's replace the ```filename``` column by the entire system path and keep only the two columns we are more interested in","997dfc4b":"We now need to create a dataframe of the same format using the pictures from the other database. Once we have that dataframe, we can use the mighty [ImageDataBunch](https:\/\/docs.fast.ai\/vision.data.html) methods to create a dataset that we can feed to our convolutional network.  \n\nSince our second database is made up of pictures of both healthy patients and pneumonia suffering patients, we are going to take an equal mix of both. I tried using only images of healthy people from this database but I reflected that since COVID-19 and pneumonia are linked somehow then it might give our network an edge to also contain pneumonia x-rays.\n\nThis is what our ```pneumonia_df``` looks like:","9949dcb6":"Let's import Fastai, create useful paths and create covid_df"}}