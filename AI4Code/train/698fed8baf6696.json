{"cell_type":{"087a4c42":"code","bfc2000f":"code","afdd308a":"code","0fbdfae8":"code","5e4ff332":"code","77ededec":"code","dbdbb3a4":"code","fa013793":"code","0150db69":"code","ed8bc679":"code","d5895c2f":"code","a6fc2033":"code","29fce51e":"code","ab14505b":"code","ec22f3c7":"code","3cee537e":"code","d045d456":"code","314f147e":"code","def05131":"code","49b66e41":"code","6647c0ea":"code","1fab9af1":"code","d25e8196":"code","c3c25453":"code","f1e183e3":"code","51538c74":"code","7be0525f":"code","d3697cc0":"markdown","26f9765f":"markdown","a836bb60":"markdown","b2843731":"markdown"},"source":{"087a4c42":"from fastai.vision.all import *","bfc2000f":"VERSION = 'final'\nnp.random.seed(42)","afdd308a":"def valid_split(frac):\n  df_train['is_valid'] = False\n\n  # df_train['category_id'].value_counts()\n  for i in range(0, 25):\n    idx = df_train[df_train['category_id'] == i].sample(frac=frac).index.values\n    df_train.loc[idx,'is_valid'] = True","0fbdfae8":"DATA_PATH = Path('\/kaggle\/input\/dlub-summer-school-challenge-2021')\nDATA_PATH","5e4ff332":"df_cat = pd.read_csv(DATA_PATH\/'category.csv')\ndf_cat.head()","77ededec":"df_train = pd.read_csv(DATA_PATH\/'train.csv')\ndf_train.head()","dbdbb3a4":"valid_split(0.15)\ndf_train = df_train.merge(df_cat)\nprint(df_train.shape)\nprint(df_train[df_train['is_valid'] == True].shape)\ndf_train.head()","fa013793":"def get_x(r): return DATA_PATH\/'train'\/'train'\/r['filename']\ndef get_y(r): return r['category_name']\n\ndef splitter(df):\n    train = df.index[~df['is_valid']].tolist()\n    valid = df.index[df['is_valid']].tolist()\n    return train,valid\n\ndef get_dls(bs, size):\n    dblock = DataBlock(blocks=(ImageBlock, CategoryBlock),\n                   splitter=splitter,\n                   get_x = get_x, get_y = get_y,\n                   item_tfms=Resize(560),\n                   batch_tfms=aug_transforms(size=size, min_scale=0.75)\n                  #  batch_tfms=[*aug_transforms(size=size, min_scale=0.75),\n                  #              Normalize.from_stats(*imagenet_stats)])\n    )\n    return dblock.dataloaders(df_train, bs=bs)","0150db69":"dls = get_dls(32, 324)\ndls.show_batch(nrows=1, ncols=3)","ed8bc679":"learn = cnn_learner(dls, resnet152, metrics=accuracy, \n                    cbs=MixUp() , loss_func=LabelSmoothingCrossEntropy())","d5895c2f":"learn.fine_tune(40)","a6fc2033":"preds,targs = learn.tta()\naccuracy(preds, targs).item()","29fce51e":"learn.show_results(ds_idx=1, nrows=3, figsize=(6,8))","ab14505b":"interp = ClassificationInterpretation.from_learner(learn)\ninterp.plot_confusion_matrix(figsize=(12,12), dpi=60)","ec22f3c7":"interp.most_confused(min_val=5)","3cee537e":"OUT_FOLDER = Path('.\/')\nlearn.export(OUT_FOLDER\/f'{VERSION}.pkl')","d045d456":"test_items = (DATA_PATH\/'test'\/'test').ls().sorted()\ntst_dl = dls.test_dl(test_items)","314f147e":"res = learn.tta(dl=tst_dl)\nres[0].shape","def05131":"dec_preds = tensor([np.argmax(r) for r in res[0]])\ndec_preds","49b66e41":"dls.vocab","6647c0ea":"im = Image.open(tst_dl.items[1])\nim.to_thumb(128,128)","1fab9af1":"dec_preds[1], dls.vocab[dec_preds[1]]","d25e8196":"df_sub = pd.read_csv(DATA_PATH\/'submission.csv')\nprint(df_sub.shape)\ndf_sub.head()","c3c25453":"for (i, row), pred in zip(df_sub.iterrows(), dec_preds):\n    df_sub.at[i,'category_name'] = dls.vocab[pred]","f1e183e3":"df_sub = df_sub[['filename', 'category_name']]\ndf_sub = df_sub.merge(df_cat)\ndf_sub = df_sub[['filename', 'category_id']]","51538c74":"df_sub.head()","7be0525f":"df_sub.to_csv(OUT_FOLDER\/f'{VERSION}_submission.csv', index=False)","d3697cc0":"## Prepare submission","26f9765f":"## Model Interpretation","a836bb60":"## Train model","b2843731":"## Load data"}}