{"cell_type":{"21ea9dff":"code","3f67edda":"code","fff23c9e":"code","3b17dc2e":"code","b7e70b65":"code","e3151b2f":"code","23e3e6c6":"code","bfe972ff":"code","1e7d6d15":"code","5f426dcb":"code","7bef2a8b":"code","5b332d2b":"code","3ed9a548":"code","06c515d3":"code","8c16b572":"code","feedc4b5":"code","d451d79a":"code","30b82828":"markdown","c7b9a376":"markdown","281911e0":"markdown","f7b5dba1":"markdown","6b0969b2":"markdown","98d1aecb":"markdown","555d2cce":"markdown","fc31ba85":"markdown","9725b0e4":"markdown"},"source":{"21ea9dff":"!pip install -Uqq fastai","3f67edda":"import pandas as pd\nfrom fastai.vision.all import *\n\nimport os","fff23c9e":"try:\n    print(torch.cuda.get_device_name(0))\nexcept Exception as e:\n    print(e)\n    print(\"Please enable gpu to run. Or comment this cell.\")\n","3b17dc2e":"data_path = Path(\"..\/input\/plant-pathology-2021-fgvc8\")","b7e70b65":"str(data_path)","e3151b2f":"train_df = pd.read_csv(\"..\/input\/plant-pathology-2021-fgvc8\/train.csv\")\ntrain_df","23e3e6c6":"def get_x(r):\n    return data_path\/'train_images'\/r['image']\n\ndef get_y(r):\n    return r['labels'].split(' ')","bfe972ff":"def get_data(size=224, bs=128, data_df=train_df):\n    dblock = DataBlock(blocks=(ImageBlock, MultiCategoryBlock),\n                       splitter=RandomSplitter(seed=42),\n                       get_x=get_x,\n                       get_y=get_y,\n                       item_tfms=RandomResizedCrop(128, min_scale=0.35),\n                       batch_tfms = [*aug_transforms(size=size, flip_vert=True), Normalize.from_stats(*imagenet_stats)])\n    return dblock.dataloaders(data_df, bs=bs)","1e7d6d15":"dls = get_data()\ndls.show_batch()","5f426dcb":"learn = cnn_learner(dls, resnet18, metrics=partial(accuracy_multi, thresh=0.2))","7bef2a8b":"learn.model = learn.model.cuda()","5b332d2b":"# learn.lr_find()","3ed9a548":"try:\n    learn.fine_tune(2, base_lr=1e-2, freeze_epochs=4)\nexcept Exception as e:\n    print(e)","06c515d3":"submission_df = pd.read_csv(data_path\/'sample_submision.csv')\nsubmission_df","8c16b572":"test_data_path = submission_df[\"image\"].apply(lambda x: data_path\/'test_images'\/x)\ntst_dl = learn.dls.test_dl(test_data_path)\npredictions = learn.tta(dl=tst_dl, n=10, beta=0)\n\nprint(predictions)\n\nsubmission_df['label'] = np.argmax(predictions[0], axis=1)\nsubmission_df","feedc4b5":"submission_df.to_csv('submission.csv', index=False)","d451d79a":"learn.show_results()","30b82828":"## Import train data","c7b9a376":"So the labels are verbose and sometimes multiple labels are also present in the data.","281911e0":"## Lets take a look","f7b5dba1":"## Creating a learner","6b0969b2":"## Initial setup","98d1aecb":"## Create Dataloaders","555d2cce":"## Make Submission file","fc31ba85":"## Creating a fastai pipeline\n\nAdapted from : https:\/\/www.kaggle.com\/slm37102\/cassava-leaf-disease-classification-fastai","9725b0e4":"## prediction using TTA"}}