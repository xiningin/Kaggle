{"cell_type":{"73ab4332":"code","f9384333":"code","a3884c63":"code","290a9b38":"code","26707f5c":"code","dfcf7706":"code","4c6179a6":"code","399e9b1b":"code","f24e19dd":"code","0bfe1464":"code","695bfd55":"code","9559dd11":"code","f0aefad2":"code","0da3e39b":"code","91dea4a6":"code","59e8d1fa":"code","189dbf1e":"code","f9dbc51a":"code","3617e49a":"code","99ee8804":"code","abb84ef2":"code","3c67bc4e":"code","6c6c4e5a":"code","138abfb7":"code","51396a7d":"code","17cb4257":"code","7bc5870a":"code","faa9dd6d":"code","41267379":"code","e6ac7b0b":"code","8a68cba1":"code","9db2ea6e":"markdown","e463b14e":"markdown","8d41f890":"markdown","ee262f52":"markdown","ffee9c07":"markdown","d63b9020":"markdown","3f43a93f":"markdown","31520b41":"markdown","7d180b45":"markdown","26bc2012":"markdown","fcaa162b":"markdown"},"source":{"73ab4332":"from IPython.display import HTML\nHTML(\"\"\"\n<style>\nh1,h2,h3 {\n\tmargin: 1em 0 0.5em 0;\n\tfont-weight: 600;\n\tfont-family: 'Courier', sans-serif;\n\tposition: relative;  \n\tfont-size: 36px;\n\tline-height: 40px;\n\tpadding: 15px 15px 15px 2.5%;\n\tcolor: #13003A;\n\tbox-shadow: \n\t\tinset 0 0 0 1px rgba(53,86,129, 0.4), \n\t\tinset 0 0 5px rgba(53,86,129, 0.5),\n\t\tinset -285px 0 35px white;\n\tborder-radius: 0 10px 0 15px;\n\tbackground: #fff\n    \n}\n<\/style>\n\"\"\")","f9384333":"import numpy as np\nimport pandas as pd\nimport matplotlib.pyplot as plt\nimport seaborn as sns\nfrom sklearn.preprocessing import LabelEncoder, StandardScaler\nfrom sklearn.preprocessing import OneHotEncoder\nimport category_encoders as ce\nfrom catboost import CatBoostClassifier\nfrom sklearn.model_selection import train_test_split\nfrom sklearn.metrics import log_loss\nfrom sklearn.model_selection import StratifiedKFold\nfrom sklearn import model_selection\nimport lightgbm as lgbm\nimport xgboost as xgb\nfrom lightgbm import LGBMClassifier\nfrom catboost import CatBoostClassifier\nfrom sklearn.ensemble import StackingClassifier, VotingClassifier\nimport optuna\nimport tqdm\nimport warnings\nimport sklearn.exceptions\nwarnings.filterwarnings('ignore', category=DeprecationWarning)\nwarnings.filterwarnings('ignore', category=FutureWarning)\nwarnings.filterwarnings('ignore', category=RuntimeWarning)\nwarnings.filterwarnings('ignore', category=UserWarning)\nwarnings.filterwarnings(\"ignore\", category=sklearn.exceptions.UndefinedMetricWarning)\n","a3884c63":"train = pd.read_csv('..\/input\/tabular-playground-series-jun-2021\/train.csv')\ntest = pd.read_csv('..\/input\/tabular-playground-series-jun-2021\/test.csv')","290a9b38":"train.head()","26707f5c":"test.head()","dfcf7706":"train.info()","4c6179a6":"test.info()","399e9b1b":"print(f'Number of rows in train: {train.shape[0]};  Number of columns in train: {train.shape[1]}')","f24e19dd":"print(f'Number of rows in test: {test.shape[0]};  Number of columns in test: {test.shape[1]}')","0bfe1464":"print(f' missing values: {sum(train.isna().sum())}')","695bfd55":"print(f' missing values: {sum(test.isna().sum())}')","9559dd11":"train.describe().T.style.bar(\n    subset=['mean'],\n    color='#438D80').background_gradient(\n    subset=['std'],cmap='PuBu').background_gradient(subset=['50%'],cmap='PuBu')","f0aefad2":"test.describe().T.style.bar(subset=['mean'], color='#ea9999')\\\n                   .background_gradient(subset=['std'], cmap='YlOrBr')","0da3e39b":"print('Target column basic statistics:')\ntrain['target'].describe()","91dea4a6":"fig, ax = plt.subplots(figsize=(12, 6))\nsns.countplot(x='target', data=train)\nax.set_title('Target Distribution')\n","59e8d1fa":"train.drop(columns=['id']).describe().T.style.bar(subset=['mean'], color='#606ff2')\\\n                            .background_gradient(subset=['std'], cmap='PuBu')\\\n                            .background_gradient(subset=['50%'], cmap='PuBu')","189dbf1e":"test.drop(columns=['id']).describe().T.style.bar(subset=['mean'], color='#606ff2')\\\n                            .background_gradient(subset=['std'], cmap='PuBu')\\\n                            .background_gradient(subset=['50%'], cmap='PuBu')","f9dbc51a":"train=train[:1000000]\ntest=test[:1000000]","3617e49a":"def plot_feature_scatter(df1, df2, features):\n    i = 0\n    sns.set_style('whitegrid')\n    plt.figure()\n    fig, ax = plt.subplots(4,4,figsize=(14,14))\n\n    for feature in features:\n        i += 1\n        plt.subplot(4,4,i)\n        plt.scatter(df1[feature], df2[feature], marker='+' , color = \"#FFB14E\")\n        plt.xlabel(feature, fontsize=9)\n    plt.show();","99ee8804":"features = [feature for feature in train.columns if feature not in ['id', 'target']]\nfeatures = features[:16]","abb84ef2":"plot_feature_scatter(train,test, features)","3c67bc4e":"le = LabelEncoder()\ntrain['target'] = le.fit_transform(train['target'])\ntrain.columns\ncols = list(train.columns)\ncols.remove(\"target\")\ncols.remove(\"id\")","6c6c4e5a":"not_features = ['id', 'target']\nfeatures = []\nfor feat in train.columns:\n    if feat not in not_features:\n        features.append(feat)\nprint(features)","138abfb7":"scaler = StandardScaler()\ntrain[features] = scaler.fit_transform(train[features])\ntest[features] = scaler.transform(test[features])","51396a7d":"X=train.drop(['target','id'],axis=1)\nY=train['target']","17cb4257":"def objective(trial,data=X,target=Y):\n    \n    X_train, X_test, y_train, y_test = train_test_split(data, target, test_size=0.2,random_state=42)\n    params = {'iterations':trial.suggest_int(\"iterations\", 4000, 25000),\n              'od_wait':trial.suggest_int('od_wait', 500, 2300),\n             'loss_function':'MultiClass',\n              'task_type':\"GPU\",\n              'eval_metric':'MultiClass',\n              'leaf_estimation_method':'Newton',\n              'bootstrap_type': 'Bernoulli',\n              'learning_rate' : trial.suggest_uniform('learning_rate',0.02,1),\n              'reg_lambda': trial.suggest_uniform('reg_lambda',1e-5,100),\n              'subsample': trial.suggest_uniform('subsample',0,1),\n              'random_strength': trial.suggest_uniform('random_strength',10,50),\n              'depth': trial.suggest_int('depth',1,15),\n              'min_data_in_leaf': trial.suggest_int('min_data_in_leaf',1,30),\n              'leaf_estimation_iterations': trial.suggest_int('leaf_estimation_iterations',1,15),\n               }\n    model = CatBoostClassifier(**params)  \n    model.fit(X_train,y_train,eval_set=[(X_test,y_test)],early_stopping_rounds=100,verbose=False)\n        \n    y_preds = model.predict_proba(X_test)\n\n\n    log_loss_multi = log_loss(y_test, y_preds)\n    \n    return log_loss_multi","7bc5870a":"OPTUNA_OPTIMIZATION = True\n\nstudy = optuna.create_study(direction='minimize')\nstudy.optimize(objective, n_trials=100)\nprint('Number of finished trials:', len(study.trials))\nprint('Best trial: score {}, params {}'.format(study.best_trial.value, study.best_trial.params))","faa9dd6d":"if OPTUNA_OPTIMIZATION:\n    display(optuna.visualization.plot_optimization_history(study))\n    display(optuna.visualization.plot_slice(study))\n    display(optuna.visualization.plot_parallel_coordinate(study))","41267379":"cat_params = study.best_trial.params\ncat_params['loss_function'] = 'MultiClass'\ncat_params['eval_metric'] = 'MultiClass'\ncat_params['bootstrap_type']= 'Bernoulli'\ncat_params['leaf_estimation_method'] = 'Newton'\ncat_params['random_state'] = 42\ncat_params['task_type']='GPU'\ntest_preds=None\n\nkf = StratifiedKFold(n_splits = 10 , shuffle = True , random_state = 42)\nfor fold, (tr_index , val_index) in enumerate(kf.split(X.values , Y.values)):\n    \n    print(\"-\" * 50)\n    print(f\"Fold {fold + 1}\")\n    \n    x_train,x_val = X.values[tr_index] , X.values[val_index]\n    y_train,y_val = Y.values[tr_index] , Y.values[val_index]\n        \n    eval_set = [(x_val, y_val)]\n    \n    model =CatBoostClassifier(**cat_params)\n    model.fit(x_train, y_train, eval_set = eval_set, verbose = False)\n    \n    train_preds = model.predict(x_train)    \n    val_preds = model.predict_proba(x_val)\n    \n    print(log_loss(y_val, val_preds))\n    \n    if test_preds is None:\n        test_preds = model.predict_proba(test[cols].values)\n    else:\n        test_preds += model.predict_proba(test[cols].values)\n\nprint(\"-\" * 50)\ntest_preds \/= 10","e6ac7b0b":"submission = pd.read_csv(\"..\/input\/tabular-playground-series-jun-2021\/sample_submission.csv\")\nsubmission['Class_1']=test_preds[:,0]\nsubmission['Class_2']=test_preds[:,1]\nsubmission['Class_3']=test_preds[:,2]\nsubmission['Class_4']=test_preds[:,3]\nsubmission['Class_5']=test_preds[:,4]\nsubmission['Class_6']=test_preds[:,5]\nsubmission['Class_7']=test_preds[:,6]\nsubmission['Class_8']=test_preds[:,7]\nsubmission['Class_9']=test_preds[:,8]\nsubmission.head()","8a68cba1":"submission.to_csv(\"sub.csv\",index=False)","9db2ea6e":"<h1 style=\"background-color:#438D80;font-size:20px;color:#000000;font-weight : bold\">Submission:<\/h1>","e463b14e":"![Upvote!](https:\/\/img.shields.io\/badge\/Upvote-If%20you%20like%20my%20work-07b3c8?style=for-the-badge&logo=kaggle)","8d41f890":"<br>\n<h1 style = \"font-size:30px; font-family:Courier ; font-weight : bold; color : #045F5F; text-align: center; border-radius: 10px 15px;\"> Tabular-Playground-Series-jun21 <\/h1>\n<br>","ee262f52":"<h1 style=\"background-color:#438D80;font-size:20px;color:#000000;font-weight : bold\">Basic Data Exploration:<\/h1>","ffee9c07":"<h1 style=\"background-color:#438D80;font-size:20px;color:#000000;font-weight : bold\">Catboost Model:<\/h1>","d63b9020":"<h1 style=\"background-color:#438D80;font-size:20px;color:#000000;font-weight : bold\">Importing Required Libraries<\/h1>","3f43a93f":"<h1 style=\"background-color:#438D80;font-size:20px;color:#000000;font-weight : bold\"> Data Transformation: <\/h1>","31520b41":"<h1 style=\"background-color:#438D80;font-size:20px;color:#000000;font-weight : bold\"> Scatter Plot of Features: <\/h1>","7d180b45":"<h1 style=\"background-color:#438D80;font-size:20px;color:#000000;font-weight : bold\"> Optuna Objective:<\/h1>","26bc2012":"<h1 style=\"background-color:#438D80;font-size:20px;color:#000000;font-weight : bold\"> Traget Column:<\/h1>","fcaa162b":"<h1 style=\"background-color:#438D80;font-size:20px;color:#000000;font-weight : bold\">Basic Statistics:<\/h1>"}}