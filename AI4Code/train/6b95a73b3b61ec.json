{"cell_type":{"f98a6a3e":"code","6bfd1365":"code","6cf6a6c3":"code","3a715da8":"code","b928838e":"code","e731420d":"code","17479772":"code","043fbbd0":"code","8ecba312":"code","00ac725e":"code","fadd21bc":"code","8c95cb15":"code","87d13356":"code","15a5ba68":"code","99f0456d":"code","17c0085d":"code","55572ab8":"code","92889818":"code","631c7a66":"code","1d9ceb48":"code","db77953f":"code","5c0cd160":"code","b36be59a":"code","47a69987":"code","4ef3305e":"code","feccfa60":"markdown","55701023":"markdown","f2f2783c":"markdown","d29d5269":"markdown"},"source":{"f98a6a3e":"#import th\u01b0 vi\u1ec7n fastai\nfrom fastai.vision.all import *","6bfd1365":"#T\u1ea1o \u0111\u01b0\u1eddng d\u1eabn t\u1edbi th\u01b0 m\u1ee5c plant-pathology-2021-fgvc8 trong input\npath = Path(\"..\/input\/plant-pathology-2021-fgvc8\")\n\n#In danh s\u00e1ch th\u01b0 m\u1ee5c con trong th\u01b0 m\u1ee5c plant-pathology-2021-fgvc8\npath.ls()","6cf6a6c3":"#\u0110\u1ecdc d\u1eef li\u1ec7u file  ..\/input\/plant-pathology-2021-fgvc8\/train.csv\ntrain_df = pd.read_csv(path\/\"train.csv\")\n\n#In d\u1eef li\u1ec7u\ntrain_df.head()","3a715da8":"#In k\u00edch th\u01b0\u1edbc c\u1ee7a m\u1ea3ng\ntrain_df.shape","b928838e":"#l\u1ecdc s\u1ed1 l\u01b0\u1ee3ng c\u1ee7a m\u1ed7i label\ntrain_df[\"labels\"].value_counts()","e731420d":"#\u1edf \u0111\u00e2y ch\u00fang ta s\u1ebd \u0111\u01b0a v\u1ec1 k\u00edch th\u01b0\u1edbc \u1ea3nh l\u00e0 128, c\u1eaft k\u00edch th\u01b0\u1edbc \u1ea3nh ng\u1eabu nhi\u00ean t\u1eeb 0.75 d\u1ebfn 1.00 v\u00e0 \u0111\u01b0a v\u1ec1 t\u1ef7 l\u1ec7 1:1 so v\u1edbi \u1ea3nh c\u0169\nitem_tfms = [RandomResizedCrop(128, min_scale=0.75, ratio=(1., 1.))]\nbatch_tfms = [*aug_transforms(size=128, max_warp=0), Normalize.from_stats(*imagenet_stats)]\n\ndls = ImageDataLoaders.from_df(\n    df = train_df,\n    folder = \"..\/input\/resized-plant2021\/img_sz_512\",\n    item_tfms = item_tfms,\n    batch_tfms = batch_tfms,\n    \n    #D\u00f9ng \u0111\u1ec3 ph\u00e2n chia d\u1eef li\u1ec7u 10% d\u1eef li\u1ec7u train v\u00e0 90% d\u1eef li\u1ec7u valid\n    splitter = RandomSplitter(valid_pct=0.1),\n    label_delim = \" \",\n    bs=256\n)","17479772":"dls.show_batch()","043fbbd0":"#t\u1ea1o th\u01b0 m\u1ee5c \"\/root\/.cache\/torch\/hub\/checkpoints\"\n!mkdir -p \/root\/.cache\/torch\/hub\/checkpoints\n\n# m\u00f4 h\u00ecnh ph\u00e2n lo\u1ea1i h\u00ecnh \u1ea3nh resnet18\n!cp ..\/input\/resnet18\/resnet18.pth \/root\/.cache\/torch\/hub\/checkpoints\/resnet18-5c106cde.pth\n#!cp ..\/input\/resnet18\/resnet34.pth \/root\/.cache\/torch\/hub\/checkpoints\/resnet34-333f7ec4.pth\n#!cp ..\/input\/resnet50\/resnet50.pth \/root\/.cache\/torch\/hub\/checkpoints\/resnet50-19c8e357.pth","8ecba312":"# x\u00e2y d\u1ef1ng m\u1ed9t model \nlearn = cnn_learner(\n    dls,\n    resnet18,\n    metrics=[accuracy_multi, F1ScoreMulti()]\n).to_fp16()","00ac725e":"# bi\u1ec3u di\u1ec5n quan h\u1ec7 gi\u1eefa learning_rate v\u00e0 loss. M\u1ee5c \u0111\u00edch \u0111\u1ec3 h\u1ea1n ch\u1ebf vi\u1ec7c ph\u1ecfng \u0111o\u00e1n v\u00e0 t\u00ecm ra \u0111i\u1ec3m kh\u1edfi \u0111\u1ea7u learning_rate t\u1ed1t nh\u1ea5t\nlearn.lr_find()","fadd21bc":"# tinh ch\u1ec9nh l\u1ea1i model\nlearn.fine_tune(\n    7,\n    1e-1,\n    cbs=[\n        #l\u01b0u m\u00f4 h\u00ecnh t\u1ed1t nh\u1ea5t trong qu\u00e1 tr\u00ecnh \u0111\u00e0o t\u1ea1o v\u00e0 load n\u00f3 v\u00e0o cu\u1ed1i\n        SaveModelCallback(),\n        #d\u1eebng l\u1ea1i n\u1ebfu sau 3 epochs m\u00e0 k c\u00f3 c\u1ea3i thi\u1ec7n\n        EarlyStoppingCallback(patience=3),\n    ],\n    freeze_epochs=3\n)","8c95cb15":"# bi\u1ec3u di\u1ec5n bi\u1ec3u \u0111\u1ed3 trainning v\u00e0 validation loss\nlearn.recorder.plot_loss()","87d13356":"#in ra k\u1ebft qu\u1ea3 d\u1ef1 \u0111o\u00e1n\nlearn.show_results()","15a5ba68":"# t\u1ea1o m\u1ed9t \u0111\u1ed1i t\u01b0\u1ee3ng ClassificationInterpretation \u0111\u1ec3 ki\u1ec3m tra c\u00e1c gi\u00e1 tr\u1ecb \ninterp = ClassificationInterpretation.from_learner(learn)","99f0456d":"# in ra 9 loss cao nh\u1ea5t\ninterp.plot_top_losses(9)","17c0085d":"# bi\u1ec3u di\u1ec5n xem c\u00f3 bao nhi\u00eau \u0111i\u1ec3m d\u1eef li\u1ec7u th\u1ef1c s\u1ef1 thu\u1ed9c v\u00e0o m\u1ed9t class, v\u00e0 \u0111\u01b0\u1ee3c d\u1ef1 \u0111o\u00e1n l\u00e0 r\u01a1i v\u00e0o m\u1ed9t class\ninterp.plot_confusion_matrix()","55572ab8":"# \u0111\u1ecdc file sample_submission.csv,l\u00e0 d\u1ea1ng file ch\u00fang ta c\u1ea7n t\u1ea1o \u0111\u1ec3 submit\nsubmission_df = pd.read_csv(path\/\"sample_submission.csv\")\nsubmission_df.head()","92889818":"# \u0111\u1ed5i path cho c\u00e1c item trong submission_df[\"image\"]\ntest_image_path_series = submission_df[\"image\"].apply(lambda x: f\"..\/input\/plant-pathology-2021-fgvc8\/test_images\/{x}\")\ntest_image_path_series.head()","631c7a66":"# \u0111\u01b0a k\u1ebft qu\u1ea3 d\u1ef1 \u0111o\u00e1n (predict) t\u1eeb dataset test_dl\ntest_dl = learn.dls.test_dl(test_image_path_series)\npreds, _ = learn.tta(dl=test_dl)","1d9ceb48":"#in ra predictions\npreds","db77953f":"# c\u00e1c label trong Dataloaders c\u1ee7a model \nvocab = learn.dls.vocab\nvocab","5c0cd160":"# h\u00e0m quy\u1ebft \u0111\u1ecbnh t\u1eeb k\u1ebft qu\u1ea3 d\u1ef1 \u0111o\u00e1n \u0111\u01b0\u1ee3c s\u1ebd x\u1ebfp n\u00f3 l\u00e0 label n\u00e0o, sau \u0111\u00f3 \u0111\u01b0a v\u00e0o m\u1ea3ng labels\nthreshold = 0.5\n\ndef pred_to_labels(pred):\n    labels = []\n    for i, probability in enumerate(pred):\n        if probability > threshold:\n            labels.append(vocab[i])\n            \n    return \" \".join(labels)","b36be59a":"# t\u1ea1o label_list ch\u1ee9a t\u1ea5t c\u1ea3 label m\u00e0 model d\u1ef1 \u0111o\u00e1n \u0111\u01b0\u1ee3c \nlabels_list = [pred_to_labels(pred) for pred in preds]\nlabels_list","47a69987":"# chuy\u1ec3n labels_list v\u00e0o th\u00e0nh c\u1ed9t labels trong submission dataframe \nsubmission_df[\"labels\"] = labels_list\nsubmission_df.head()","4ef3305e":"# chuy\u1ec3n submission_df sang d\u1ea1ng .csv \u0111\u1ec3 submit\nsubmission_df.to_csv(\"submission.csv\", index=False)","feccfa60":"\u1ede \u0111\u00e2y s\u1eed d\u1ee5ng [resized dataset](https:\/\/www.kaggle.com\/ankursingh12\/resized-plant2021) \u0111\u1ec3 ti\u1ebft ki\u1ec7m th\u1eddi gian.  \nn\u1ebfu kh\u00f4ng s\u1eed d\u1ee5ng th\u00ec s\u1ebd m\u1ea5t kh\u00e1 nhi\u1ec1u th\u1eddi gian \u0111\u1ec3 thay \u0111\u1ed5i k\u00edch th\u01b0\u1edbc h\u00ecnh \u1ea3nh...\ud83d\ude05","55701023":"\u1edf \u0111\u00e2y ch\u00fang ta c\u00f3 th\u1ec3 th\u1ea5y \u0111\u01b0\u1ee3c c\u00f3 18632 \u1ea3nh d\u00f9ng \u0111\u1ec3 training","f2f2783c":"B\u00e2y gi\u1edd n\u1ebfu ch\u00fang ta s\u1eed d\u1ee5ng ngay \u1ea3nh n\u00f3i tr\u00ean \u0111\u1ec3 train cho model CNN Classify th\u00ec s\u1ebd b\u1ecb hi\u1ec7n t\u01b0\u1ee3ng Overfit v\u00ec d\u1eef li\u1ec7u nhi\u1ec1u nh\u01b0ng \u0111a ph\u1ea7n gi\u1ed1ng nhau. D\u1eabn \u0111\u1ebfn train s\u1ebd c\u00f3 ch\u1ea5t l\u01b0\u1ee3ng t\u1ed1t nh\u01b0ng khi test s\u1ebd th\u1ea5y kh\u00f4ng \u0111\u01b0\u1ee3c ch\u00ednh x\u00e1c.\n \n Ch\u00fang ta s\u1ebd th\u1ef1c hi\u1ec7n augment d\u1eef li\u1ec7u \u0111\u1ec3 l\u00e0m phong ph\u00fa h\u01a1n d\u1eef li\u1ec7u, t\u0103ng t\u00ednh t\u1ed5ng qu\u00e1t cho model \nb\u1eb1ng RandomResizedCrop v\u00ec n\u00f3 s\u1ebd chia t\u1ef7 l\u1ec7 ng\u1eabu nhi\u00ean h\u00ecnh \u1ea3nh v\u00e0 c\u1eaft n\u00f3, sau \u0111\u00f3 thay \u0111\u1ed5i k\u00edch th\u01b0\u1edbc n\u00f3 th\u00e0nh k\u00edch th\u01b0\u1edbc y\u00eau c\u1ea7u.","d29d5269":"    Ch\u00fang ta c\u00f3 th\u1ec3 th\u1ea5y \u0111\u01b0\u1ee3c 1 kho\u1ea3ng \u0111\u1ed1c xu\u1ed1ng r\u1ed3i \u0111i l\u00ean, th\u00ec khi \u0111\u1ea5y t\u1ec9 l\u1ec7 m\u1ea5t m\u00e1t l\u00e0 nh\u1ecf nh\u1ea5t v\u00e0 t\u1ec9 l\u1ec7 h\u1ecdc t\u1eadp \u1edf m\u1ee9c t\u01b0\u01a1ng \u0111\u1ed1i cao.\n    \n    N\u1ebfu t\u1ef7 l\u1ec7 h\u1ecdc t\u1eadp \u0111\u01b0\u1ee3c \u0111\u1eb7t qu\u00e1 th\u1ea5p, qu\u00e1 tr\u00ecnh \u0111\u00e0o t\u1ea1o s\u1ebd ti\u1ebfn tri\u1ec3n r\u1ea5t ch\u1eadm v\u00ec \u0111ang c\u1eadp nh\u1eadt r\u1ea5t nh\u1ecf c\u00e1c tr\u1ecdng s\u1ed1 trong m\u1ea1ng c\u1ee7a m\u00ecnh. Tuy nhi\u00ean, n\u1ebfu t\u1ef7 l\u1ec7 h\u1ecdc t\u1eadp \u0111\u01b0\u1ee3c \u0111\u1eb7t qu\u00e1 cao, n\u00f3 c\u00f3 th\u1ec3 g\u00e2y ra h\u00e0nh vi kh\u00e1c bi\u1ec7t kh\u00f4ng mong mu\u1ed1n trong ch\u1ee9c n\u0103ng m\u1ea5t m\u00e1t. V\u00ec t\u1ef7 l\u1ec7 h\u1ecdc t\u1eadp t\u1ed1t nh\u1ea5t c\u00f3 li\u00ean quan \u0111\u1ebfn s\u1ef1 s\u1ee5t gi\u1ea3m m\u1ea1nh nh\u1ea5t\n    \n    V\u00ec th\u1ebf \u1edf \u0111\u00e2y ch\u00fang ta s\u1ebd \u0111\u1eb7t t\u1eeb 1e-1"}}