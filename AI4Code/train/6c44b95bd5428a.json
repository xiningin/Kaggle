{"cell_type":{"b0e1bdd2":"code","f151afc2":"code","2add07b5":"code","0c1d95d4":"code","317012b4":"code","6b9f02b1":"code","0ccf348b":"code","65b8553d":"code","0eb73852":"code","2c52871d":"code","1f448dd1":"code","3341f48f":"code","f11932cc":"code","34bdd15f":"code","676c5545":"code","367e8f20":"code","d64a24ef":"code","a568a176":"code","2d29d85e":"code","6cf17db9":"code","b3166d42":"code","4eca6418":"code","40c70136":"code","7e60cbd8":"code","0ca37c69":"code","df4a3c29":"code","da002003":"code","2b20915e":"code","1d71a8de":"code","c86918c8":"code","b3d0a825":"code","47a788bf":"code","0fc5da3b":"code","b322117b":"code","91af43df":"code","1f44a14c":"code","fa68f9fd":"code","fbdfeaef":"markdown"},"source":{"b0e1bdd2":"!pip install tensorflow-addons","f151afc2":"!pip install efficientnet","2add07b5":"\nimport numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\n","0c1d95d4":"train_df=pd.read_csv('\/kaggle\/input\/plant-pathology-2020-fgvc7\/train.csv')\ntrain_df['image_id']=train_df['image_id']+'.jpg'\n#train_df['label']=np.argmax(train_df.iloc[:,1::].values,axis=1).astype('str')\ntrain_df.head()","317012b4":"test_df=pd.read_csv('\/kaggle\/input\/plant-pathology-2020-fgvc7\/test.csv')\ntest_df['image_id']=test_df['image_id']+'.jpg'\n# test_df['healthy']=np.zeros(len(test_df)).astype(int)\n# test_df['multiple_diseases']=np.zeros(len(test_df)).astype(int)\n# test_df['rust']=np.zeros(len(test_df)).astype(int)\n# test_df['scab']=np.zeros(len(test_df)).astype(int)\n\ntest_df.head()","6b9f02b1":"from sklearn.model_selection import train_test_split\ntrain, val = train_test_split(train_df, test_size = 0.2)","0ccf348b":"len(train_df),len(train),len(val)","65b8553d":"train.head()","0eb73852":"val.head()","2c52871d":"from keras_preprocessing.image import ImageDataGenerator\n\ntrain_data_gen= ImageDataGenerator(\n    horizontal_flip=True,\n    vertical_flip=True,\n    rotation_range=10,\n    width_shift_range=0.1,\n    height_shift_range=0.1,\n    zoom_range=.1,\n    rescale=1\/255,\n    fill_mode='nearest',\n    shear_range=0.1,\n    brightness_range=[0.5, 1.5])","1f448dd1":"img_shape=300\nbatch_size=16","3341f48f":"train_generator=train_data_gen.flow_from_dataframe(train,directory='\/kaggle\/input\/plant-pathology-2020-fgvc7\/images\/',\n                                                      target_size=(img_shape,img_shape),\n                                                      x_col=\"image_id\",\n                                                      y_col=['healthy','multiple_diseases','rust','scab'],\n                                                      class_mode='raw',\n                                                      shuffle=False,\n                                                       subset='training',\n                                                      batch_size=batch_size)","f11932cc":"val_generator=train_data_gen.flow_from_dataframe(val,directory='\/kaggle\/input\/plant-pathology-2020-fgvc7\/images\/',\n                                                      target_size=(img_shape,img_shape),\n                                                      x_col=\"image_id\",\n                                                      y_col=['healthy','multiple_diseases','rust','scab'],\n                                                      class_mode='raw',\n                                                      shuffle=False,\n                                                      batch_size=batch_size,\n                                                  )","34bdd15f":"test_generator=train_data_gen.flow_from_dataframe(test_df,directory='\/kaggle\/input\/plant-pathology-2020-fgvc7\/images\/',\n                                                      target_size=(img_shape,img_shape),\n                                                      x_col=\"image_id\",\n                                                      y_col=None,\n                                                      class_mode=None,\n                                                      shuffle=False,\n                                                      batch_size=batch_size)","676c5545":"train_generator.next()[0].shape,train_generator.next()[1].shape","367e8f20":"# from tensorflow.keras.models import Sequential,Model\n# from tensorflow.keras.layers import Activation, Dropout, Flatten, Dense, Conv2D, MaxPool2D, BatchNormalization,Input,MaxPooling2D,GlobalMaxPooling2D,concatenate\n# from tensorflow.keras.layers import GlobalAveragePooling2D\n# from tensorflow.keras.applications.resnet50 import ResNet50\n# from tensorflow.keras.callbacks import ModelCheckpoint\n# import tensorflow as tf","d64a24ef":"from keras.models import Sequential,Model\nfrom keras.layers import Activation, Dropout, Flatten, Dense, Conv2D, MaxPool2D, BatchNormalization,Input,GlobalAveragePooling2D,GlobalMaxPooling2D,concatenate\nfrom keras.layers import GlobalAveragePooling2D\nfrom keras.callbacks import ReduceLROnPlateau\nimport efficientnet.keras as efn \nfrom sklearn.metrics import accuracy_score,f1_score,roc_auc_score\nimport keras","a568a176":"\nmodel =efn.EfficientNetB4(weights = 'imagenet', include_top=False, input_shape = (img_shape,img_shape,3))","2d29d85e":"x = model.output\nx = GlobalAveragePooling2D()(x)\nx = Dense(128, activation=\"relu\")(x)\nx = Dense(64, activation=\"relu\")(x)\npredictions = Dense(4, activation=\"softmax\")(x)","6cf17db9":"model = Model(inputs=model.input, outputs=predictions)","b3166d42":"def custom_loss(y_true, y_pred):\n    return keras.losses.categorical_crossentropy(y_true, y_pred, label_smoothing=0.1)\n","4eca6418":"import tensorflow_addons as tfa","40c70136":"model.compile(optimizer='adam', loss=tfa.losses.SigmoidFocalCrossEntropy(), metrics=['accuracy'])","7e60cbd8":"y_true=val.iloc[:,1::].values","0ca37c69":"results = model.fit_generator(train_generator,epochs=15,\n                              steps_per_epoch=train_generator.n\/batch_size,\n                              validation_data=val_generator,\n                             validation_steps=val_generator.n\/batch_size,\n                              callbacks=[ReduceLROnPlateau(monitor='val_loss', factor=0.3,patience=3, min_lr=0.000001)])","df4a3c29":"model.save_weights('model_weights.h5')","da002003":"import matplotlib.pyplot as plt\n\nplt.plot(results.history['loss'])\nplt.plot(results.history['val_loss'])\nplt.title('model loss')\nplt.ylabel('loss')\nplt.xlabel('epoch')\nplt.legend(['train', 'test'], loc='upper left')\nplt.show()","2b20915e":"#model.load_weights('model.h5')","1d71a8de":"y_pred = model.predict_generator(val_generator,steps=val_generator.n\/batch_size)\ny_pred=y_pred.round().astype(int)\n","c86918c8":"print(accuracy_score(y_true,y_pred))\nprint(f1_score(y_true,y_pred,average='macro'))\nprint(roc_auc_score(y_true,y_pred,average='macro'))","b3d0a825":"y_test=model.predict(test_generator,steps=test_generator.n\/batch_size)","47a788bf":"y_test.shape","0fc5da3b":"sub_df=pd.read_csv('\/kaggle\/input\/plant-pathology-2020-fgvc7\/sample_submission.csv')\nsub_df.head()","b322117b":"len(sub_df),len(y_test)","91af43df":"for i,j in enumerate(['healthy','multiple_diseases','rust','scab']):\n    sub_df[j]=y_test[:,i]","1f44a14c":"sub_df.head()","fa68f9fd":"sub_df.to_csv('submission.csv', index=False)","fbdfeaef":"### Image Data Generator"}}