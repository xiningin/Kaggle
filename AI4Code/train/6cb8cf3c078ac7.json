{"cell_type":{"a0678c30":"code","5e1c5b32":"code","cb835097":"code","9d30d92a":"code","1b9eae26":"code","249c0b23":"code","584c7874":"code","76134c54":"code","073e62ec":"code","a0af90c6":"code","5020b83b":"code","5ca1b155":"code","98349578":"code","1a399087":"code","977d907a":"code","63645cf0":"code","dea40c64":"code","86fe90e0":"code","eb2fb879":"code","1f35f1ab":"code","9685c72e":"code","16080364":"code","2b403d88":"code","f7196c9a":"code","3191eca0":"code","d401f067":"code","5bc6a384":"markdown","f94e5a4b":"markdown","be61a27e":"markdown","48dda743":"markdown","b6db3934":"markdown","936dc2aa":"markdown","8c59cf2a":"markdown","615d60a5":"markdown","bd188375":"markdown","865e5ad5":"markdown","c4f9aad9":"markdown","1d4419f5":"markdown","fc21c88a":"markdown","1c421f9d":"markdown"},"source":{"a0678c30":"import numpy as np \nimport pandas as pd\nimport os\nimport re\n\npd.set_option('display.max_rows', None)\npd.set_option('display.max_columns', None)\n\n# for dirname, _, filenames in os.walk('\/kaggle\/input'):\n#     for filename in filenames:\n#         print(os.path.join(dirname, filename))","5e1c5b32":"# container_dir = '\/kaggle\/input\/march-madness-analytics-2020\/2020DataFiles\/2020DataFiles\/2020-Mens-Data\/MDataFiles_Stage1'\ncontainer_dir = '\/kaggle\/input\/march-madness-analytics-2020\/MDataFiles_Stage2\/'","cb835097":"#loading data Compact data\nregular_compact = pd.read_csv(os.path.join(container_dir, 'MRegularSeasonCompactResults.csv'))\ntourney_compact = pd.read_csv(os.path.join(container_dir, 'MNCAATourneyCompactResults.csv'))\nsecondary_compact = pd.read_csv(os.path.join(container_dir, 'MSecondaryTourneyCompactResults.csv'))","9d30d92a":"#creating identifier fields:;\nregular_compact['identifier'] = 'regular'\ntourney_compact['identifier'] = 'tourney'\nsecondary_compact['identifier'] = 'secondary'\n\n#appending compact dataframes:\nappend_compact = pd.concat([regular_compact, tourney_compact, secondary_compact])","1b9eae26":"#loading detailed data:\nregular_detailed = pd.read_csv(os.path.join(container_dir, 'MRegularSeasonDetailedResults.csv'))\ntourney_detailed = pd.read_csv(os.path.join(container_dir, 'MNCAATourneyDetailedResults.csv'))\n#Note: secondaryDetailed data wasn't delivered.","249c0b23":"#creating detailed identifier fields:\nregular_detailed['identifier'] = 'regular'\ntourney_detailed['identifier'] = 'tourney'\n\n#appending detailed dataframes:\nappend_detailed = pd.concat([regular_detailed, tourney_detailed])","584c7874":"merge_results = append_detailed.merge(append_compact, how = 'outer', on=['Season', 'DayNum', 'WTeamID', 'WScore', 'LTeamID', 'LScore', 'WLoc',\n       'NumOT', 'identifier'])\nmerge_results['game_id'] = np.arange(0, merge_results.shape[0])\nmerge_results['score_diff'] = merge_results.WScore - merge_results.LScore","76134c54":"# renaming columns to unpivot\nmerge_results.rename(columns = {'WTeamID':'Winner','LTeamID': 'Loser'}, inplace = True)\n\nvalue_vars = ['Winner', 'Loser']\nid_vars = [i for i in merge_results.columns if i not in value_vars]\nmelted_results = merge_results.melt(id_vars = id_vars,\n                  value_vars = value_vars,\n                  var_name = 'game_status',\n                  value_name = 'TeamID')","073e62ec":"melted_results.head()","a0af90c6":"mask =  (melted_results.Season== 2003) & (melted_results.DayNum == 10) &(melted_results.TeamID == 1104)\nmelted_results.loc[mask, :]","5020b83b":"mask =  (melted_results.Season== 2003) & (melted_results.DayNum == 10) &(melted_results.TeamID == 1328)\nmelted_results.loc[mask, :]","5ca1b155":"melted_cols = melted_results.columns\n\n# Columns beginning with L\nloser_mask_cols = melted_cols.str.contains('^L')\nloser_cols = melted_cols[loser_mask_cols]\n\n# Columns beginning with W living Wloc aside\nwinner_mask_cols = (melted_cols.str.contains('^W')) & (melted_cols != 'WLoc')\nwinner_cols = melted_cols[winner_mask_cols]\n\ncleaned_cols = winner_cols.str.extract(r'([^W].*)')[0].tolist()\n\nfor winner_col, loser_col, new_col in zip(winner_cols, loser_cols, cleaned_cols):\n    melted_results[new_col] = np.where(melted_results['game_status'] == 'Winner',\n                                      melted_results[winner_col],\n                                      melted_results[loser_col])","98349578":"useless_cols = list(winner_cols)+list(loser_cols)\nmelted_results.drop(useless_cols, axis=1, inplace = True)","1a399087":"melted_results.head()","977d907a":"melted_results['WLoc'] = np.where(melted_results['game_status']== 'Loser' ,\n                                 np.nan,\n                                 melted_results['WLoc'])","63645cf0":"seasons = pd.read_csv(os.path.join(container_dir, 'MSeasons.csv'))","dea40c64":"#Dayzero to datetime\nseasons['DayZero'] = pd.to_datetime(seasons.DayZero)\nday_zeros = seasons.loc[:, ['Season', 'DayZero']].copy()\nresults = melted_results.merge(day_zeros, on='Season', how='inner')\n\n#adding game date:\nresults['date'] = results.DayZero + pd.to_timedelta(results.DayNum, unit='day')","86fe90e0":"# loading cities\ncities = pd.read_csv(os.path.join(container_dir, 'Cities.csv'))\ncities['city_state'] = cities.City + '-' + cities.State\n\n#loading games cities\ngame_cities = pd.read_csv(os.path.join(container_dir, 'MGameCities.csv'))","eb2fb879":"game_cities = game_cities.merge(\n    cities,\n    on = 'CityID',\n    how = 'outer'\n)\ngame_cities.drop('CityID', axis=1, inplace=True)","1f35f1ab":"game_cities.rename(columns = {'WTeamID':'Winner', 'LTeamID':'Loser'}, inplace=True)\nvalue_vars = ['Winner', 'Loser']\nid_vars = [i for i in game_cities.columns if i not in value_vars]\n\ngame_cities_melt = game_cities.melt(\n                    id_vars = id_vars,\n                    value_vars = value_vars,\n                    var_name = 'game_status',\n                    value_name = 'TeamID'\n                    \n)","9685c72e":"game_cities.Season.min() #note we have registers since 2010 so there will be many missing values","16080364":"#merging results with game cities\nresults = results.merge(game_cities_melt, on=['Season', 'DayNum', 'game_status', 'TeamID'], how='outer')\nresults.columns = results.columns.str.lower()","2b403d88":"results.head()","f7196c9a":"def create_derived_cols(games):\n    key_days = [\n                games['daynum'].between(134, 135), games['daynum'].between(136, 137),\n                games['daynum'].between(138, 139),games['daynum'].between(143, 144),\n                games['daynum'].between(145, 146),games['daynum'] == 152,\n                games['daynum'] == 154\n\n               ]\n\n    key_meanings = [\n                'Play In', '64 to 32',\n                '32 to 16','Sweet Sixteen',\n                'Elite Eight', 'Final Four',\n                'Nacional Final'\n\n               ]\n\n    games['season_progress'] = 'regular'\n    for days, meaning in zip(key_days, key_meanings):\n        games['season_progress'] = np.where(\n            days, meaning, games['season_progress']\n    )\n\n    games['season_progress'] = np.where(\n        games.identifier == 'secondary',\n        'secondary',\n        games['season_progress']\n    )\n\n    champ_condition = (games.daynum == 154) &\\\n                        (games.game_status == 'Winner')\n    games['champion'] = np.where(champ_condition, 1, 0)\n\n    champions = games.loc[games.champion==1, ['season', 'teamid', 'champion']].set_index(['season', 'teamid'])\n    games['champion'] = games.set_index(['season', 'teamid']).index.map(champions.champion).fillna(0)\n\n    games['games_played'] = games.loc[games.identifier == 'regular'].groupby(['season', 'teamid']).cumcount() + 1\n\n    # Cumulative loses Till next victory\n    games.sort_values(['season', 'teamid', 'daynum'], inplace=True)\n    winners_cumsum = (games.game_status == 'Winner').cumsum()\n    games['cum_loses'] = games.groupby(winners_cumsum).cumcount()\n    condition = (games.game_status == 'Loser') & (games.cum_loses == 0)\n    games['cum_loses'] = np.where(condition, 1, games.cum_loses)\n\n    # Final stage achieved for current team in current season\n    games['final_stage'] = games.groupby(['season', 'teamid'])['season_progress'].transform('last')\n    games['final_stage'] = pd.Categorical(\n                                games['final_stage'],\n                                categories=['regular']+key_meanings,\n                                ordered=True\n    )\n    games['final_stage'].fillna('regular', inplace=True)\n\n    games.sort_values(['final_stage','games_played','season'], inplace=True)\n    \n    # basic measurments\n    games['off_ratio'] = games['or'] \/ (games['or']+games.dr)\n    games['def_ratio'] = games['dr'] \/ (games['or']+games.dr)\n    games['fgm_efectuation'] = games['fgm'] \/ games['fga']\n    games['fgm_efectuation3'] = games['fgm3'] \/ games['fga3']\n\n    games['score_diff'] = np.where(games.game_status == 'Loser',\n                                  games.score_diff * (-1),\n                                  games.score_diff)\n    games['lose_status'] = games.game_status == 'Loser'\n    \n    return games","3191eca0":"results = create_derived_cols(results)","d401f067":"results.sort_values('city_state').head()","5bc6a384":"## tidy dataframe","f94e5a4b":"Merge dataframes","be61a27e":"# Purpose of the notebook\nIn this notebook we are going to tranform into a __tidy format__ the next dataframes:\n 1. MRegularSeasonCompactResults\n 2. MNCAATourneyCompactResults\n 3. MSecondaryTourneyCompactResults\n 4. MRegularSeasonDetailedResults\n 5. MNCAATourneyDetailedResults\n 6. MSeasons\n 7. cities\n 8. MGameCities\n \n \n \n__Notes:__\n- There are no functions in this notebook for educational purposes. You can play around with each step and feel free to stop and print variables to get a better understanding if needed.\n- This notebook's final result is based on tidy data Hadley Wickham's definition https:\/\/en.wikipedia.org\/wiki\/Tidy_data ","48dda743":"### Fixing Wloc behavior\nWloc columns represents 'Winner's location'. It specifies if the games was played in home ('H'), no-home ('A') and neutral ('N').\nDoesn't make sense to keep filled each 'Loser' register.","b6db3934":"Ok, maybe this looks a little ugly, we have some repeated registers. For example in __season__ 2003, __season day__ 10,  __teams__ 1104 and 1328 were matched. Team 1104 won, so we just need those 'Winner regiters' and drop 'Loser registers' opposite applies to team 1328 ","936dc2aa":"Next step depends on your preferences so I wrote it as a function. You can get rid of that if you want.","8c59cf2a":"Much better!","615d60a5":"# Dataframes with game detail level\nIt's pretty important in a multi-dataframe modelling process take into account the level of detail in each dataframe (also known as granularity). The main idea is avoid duplicate values and keep everything in one place.","bd188375":"### Working with compact data first\nThis dataframes share the same structured, so let's append and merge them.","865e5ad5":"# working with seasons\nFrom this table we can estimate the exactly date for each game.","c4f9aad9":"# Unpivoting data\nThe main idea is try to integrate columns with the same meaning, for example, WTeamID (winner team id) and LTeamID (loser team id). Doesn't make sense keep them  separated so lets join them.\nLet's use **__melt__** to achieve this.","1d4419f5":"# If you find it useful please don't forget __upvote__ and please give me your __feedback__\n","fc21c88a":"Same process for detailed data","1c421f9d":"# working with cities\nFrom this dataframe we can extract city and state.\n\n__first__\nwe need to merge it with game cities to obtain a __game detail level__"}}