{"cell_type":{"7bc6b589":"code","75176e20":"code","cda4dbba":"code","5c40fd1f":"code","07dcfa5b":"code","43b370a9":"code","6b7a49a4":"code","3553a116":"code","a8d90800":"code","4a116f38":"code","8050f3e9":"code","19012551":"code","be84f318":"code","28b389f9":"code","7ec2023f":"code","662a4046":"code","5bbf6720":"code","ef6edbee":"code","f7b500e8":"code","d5f01a4b":"code","64ef3ac0":"code","89103385":"code","de06f6a9":"code","f5bab1f5":"code","1af05df9":"markdown","458636d3":"markdown","e13c0fd3":"markdown","539c1d3d":"markdown","5de27683":"markdown","604788c3":"markdown","b2590798":"markdown","263e687c":"markdown","62829bd1":"markdown","92d814da":"markdown","8fcafe3b":"markdown","8ca95035":"markdown","12905f92":"markdown","d86df903":"markdown","d472fff3":"markdown","d0ffe290":"markdown"},"source":{"7bc6b589":"# This Python 3 environment comes with many helpful analytics libraries installed\n# It is defined by the kaggle\/python Docker image: https:\/\/github.com\/kaggle\/docker-python\n# For example, here's several helpful packages to load\n\nimport numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\n\n# Input data files are available in the read-only \"..\/input\/\" directory\n# For example, running this (by clicking run or pressing Shift+Enter) will list all files under the input directory\n\nimport os\nfor dirname, _, filenames in os.walk('\/kaggle\/input'):\n    for filename in filenames:\n        print(os.path.join(dirname, filename))\n\n# You can write up to 20GB to the current directory (\/kaggle\/working\/) that gets preserved as output when you create a version using \"Save & Run All\" \n# You can also write temporary files to \/kaggle\/temp\/, but they won't be saved outside of the current session","75176e20":"pip install pmdarima","cda4dbba":"import numpy as np \nimport pandas as pd\n\n# visualizations\nimport matplotlib.pyplot as plt\nimport seaborn as sns\nfrom pylab import rcParams\nrcParams['figure.figsize'] = (12,5)\n%matplotlib inline\n\n# time series related \nfrom pmdarima import auto_arima\nfrom statsmodels.tsa.stattools import adfuller\nfrom statsmodels.tools.eval_measures import mse,rmse\nfrom statsmodels.tsa.statespace.varmax import VARMAX,VARMAXResults\n\n# handle warnings\nimport warnings\nwarnings.filterwarnings(action='ignore',category=DeprecationWarning)\nwarnings.filterwarnings(action='ignore',category=FutureWarning)","5c40fd1f":"# Load datasets\ndf = pd.read_csv('\/kaggle\/input\/time-series-data-1\/M2SLMoneyStock.csv',index_col=0, parse_dates=True)\ndf.index.freq = 'MS'\n\nsp = pd.read_csv('\/kaggle\/input\/time-series-data-1\/PCEPersonalSpending.csv',index_col=0, parse_dates=True)\nsp.index.freq = 'MS'","07dcfa5b":"df.head()","43b370a9":"sp.head()","6b7a49a4":"df = df.join(sp)\ndf.head()","3553a116":"# drop the null values if any\ndf.dropna(inplace=True)\ndf.shape","a8d90800":"title = 'M2 Money Stock vs. Personal Consumption Expenditures'\nylabel= 'Billions of dollars'\nxlabel= ''\n\nax = df['Spending'].plot(figsize=(12,5),title=title,legend=True)\nax.autoscale(axis='x',tight=True)\nax.set(xlabel=xlabel, ylabel=ylabel)\ndf['Money'].plot(legend=True);","4a116f38":"auto_arima(df['Money'],maxiter=100)","8050f3e9":"auto_arima(df['Spending'],maxiter=100)","19012551":"df_transformed = df.diff().diff() # 2nd order difference\ndf_transformed = df_transformed.dropna() # remove the NaNs introduced due to differencing\ndf_transformed.head()","be84f318":"len(df_transformed)","28b389f9":"nobs = 12 # The last 12 months will be the test data. At least 1 year would be a good choice\ntrain = df_transformed[0:-nobs]\ntest = df_transformed[-nobs:]","7ec2023f":"model = VARMAX(train, order=(1,2), trend='c') # c indicates a constant trend\nresults = model.fit(maxiter=1000, disp=False)\nresults.summary()","662a4046":"df_forecast = results.forecast(12)\ndf_forecast","5bbf6720":"# Add the most recent first difference from the training side of the original dataset to the forecast cumulative sum\ndf_forecast['Money1d'] = (df['Money'].iloc[-nobs-1]-df['Money'].iloc[-nobs-2]) + df_forecast['Money'].cumsum()\n# Now build the forecast values from the first difference set\ndf_forecast['MoneyForecast'] = df['Money'].iloc[-nobs-1] + df_forecast['Money'].cumsum()","ef6edbee":"# Add the most recent first difference from the training side of the original dataset to the forecast cumulative sum\ndf_forecast['Spending1d'] = (df['Spending'].iloc[-nobs-1]-df['Spending'].iloc[-nobs-2]) + df_forecast['Spending'].cumsum()\n\n# Now build the forecast values from the first difference set\ndf_forecast['SpendingForecast'] = df['Spending'].iloc[-nobs-1] + df_forecast['Spending'].cumsum()","f7b500e8":"df_forecast","d5f01a4b":"pd.concat([df.iloc[-12:],df_forecast[['MoneyForecast','SpendingForecast']]],axis=1)","64ef3ac0":"df['Money'][-nobs:].plot(figsize=(12,5),legend=True).autoscale(axis='x',tight=True)\ndf_forecast['MoneyForecast'].plot(legend=True);","89103385":"df['Spending'][-nobs:].plot(figsize=(12,5),legend=True).autoscale(axis='x',tight=True)\ndf_forecast['SpendingForecast'].plot(legend=True);","de06f6a9":"RMSE1 = rmse(df['Money'][-nobs:], df_forecast['MoneyForecast'])\nprint(f'Money VAR(5) RMSE: {RMSE1:.3f}')","f5bab1f5":"RMSE2 = rmse(df['Spending'][-nobs:], df_forecast['SpendingForecast'])\nprint(f'Spending VAR(5) RMSE: {RMSE2:.3f}')","1af05df9":"Order (1,2) is preferred for VARMA. The last term or the third terms is the differencing which will be applied already using differencing. ","458636d3":"To roll back a first-order difference we take the most recent value on the training side of the original series, and add it to a cumulative sum of forecasted values. When working with second-order differences we first must perform this operation on the most recent first-order difference.\n\nHere we'll use the <tt>nobs<\/tt> variable we defined during the train\/test\/split step.\n\n**This was the toughest part to figure out. Best way is to take a small dataset and try this out manually, come out with the step or formula and generalize on the entire dataframe.**","e13c0fd3":"## Invert the Transformations \nThe data used for prediction was of 2nd order difference. The forecast would also be similar and hence it needs to be inverted to retrieve the true values which we can compare the original Money and Spending in the last 12 months dataframe. ","539c1d3d":"## Plot the data","5de27683":"## Decide the order of the VARMA(p,q) ","604788c3":"# VARMA - Vector Autoregression with Moving Average\nThe only difference with VAR model is that the error terms are given the moving averag representation of order(q)\n\nData Source https:\/\/fred.stlouisfed.org\/series\/M2SL https:\/\/fred.stlouisfed.org\/series\/PCE","b2590798":"Refer the other notebook https:\/\/www.kaggle.com\/prakharprasad\/time-series-vector-autoregression where the test for stationarity was done on both Money as well as the Spending feature. Order 2 difference makes the data stationary. For sake of brevity, I am skipping this step. ","263e687c":"## Import Libraries and Load the Data","62829bd1":"# Summary","92d814da":"## Fit the VARMA(1,2) Model","8fcafe3b":"## Plot the results","8ca95035":"## Test for Stationarity","12905f92":"## Predict the next 12 values","d86df903":"## Model Evaluation","d472fff3":"**The VARMA model fits very poorly for this dataset. Perhaps there is no good relationship between the Spending and and the Personal Disposable Income atleast for the period that I investigated here. Next step could be to compare the results to the ARMA or other models.**","d0ffe290":"## Train Test Split"}}