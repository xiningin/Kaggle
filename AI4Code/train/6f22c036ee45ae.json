{"cell_type":{"ab8ff42e":"code","9bc7af1e":"code","8f45c0fb":"code","01a3eb12":"code","8f7dd23f":"code","48c4eee7":"code","5a571038":"code","97544dac":"code","128f15f7":"code","cb2ec1d1":"code","1e6d605e":"markdown","fe78f24a":"markdown","e02db41d":"markdown","b7752c96":"markdown","893aac64":"markdown","9799dde7":"markdown","782fc279":"markdown","51677e61":"markdown","64aa5f7b":"markdown"},"source":{"ab8ff42e":"import fastai.vision\nimport os\nimport glob\nfrom multiprocessing import Pool\nfrom functools import partial\nimport matplotlib.pyplot as plt\nimport random\nimport numpy as np\nfrom tqdm import tqdm_notebook as tqdm\nimport pandas as pd\nfrom zipfile import ZipFile ","9bc7af1e":"xray_images= fastai.vision.ImageList.from_folder('..\/input\/siimdatasetx128\/siim-datasetx128\/siim-datasetx128\/train\/128\/dicom\/')\nmask_images = fastai.vision.ImageList.from_folder('..\/input\/siimdatasetx128\/siim-datasetx128\/siim-datasetx128\/train\/128\/mask\/')\nprint(len(xray_images),len(mask_images))","8f45c0fb":"def plot_image_mask(img_,mask_):\n    _,axs = plt.subplots(1,3, figsize=(15,7))\n    img_.show(ax=axs[0], title='no mask')\n    img_.show(ax=axs[1], y=mask_, title='masked')\n    mask_.show(ax=axs[2], title='mask only', alpha=1.)\n    \nimg_exemple = fastai.vision.open_image(xray_images.items[2974])\nmask_exemple = fastai.vision.open_mask(mask_images.items[2974])\n\nplot_image_mask(img_exemple,mask_exemple)","01a3eb12":"_ROTATE_DEGREES = -50\n_MAGNITUDE_WRAP = -0.2\n_SCALE_ZOOM = 1.5\n_CHANGE_BRIGHTNESS = 0.8\n_SCALE_CONSTRAST = (2,3)\ntfms_dicom=[\n    fastai.vision.rotate(degrees = _ROTATE_DEGREES),\n    fastai.vision.symmetric_warp(magnitude = _MAGNITUDE_WRAP),\n    fastai.vision.zoom(scale = _SCALE_ZOOM),\n    fastai.vision.brightness(change = _CHANGE_BRIGHTNESS),\n    fastai.vision.contrast(scale = _SCALE_CONSTRAST)]\n\ntfms_mask=[\n    fastai.vision.rotate(degrees = _ROTATE_DEGREES),\n    fastai.vision.symmetric_warp(magnitude = _MAGNITUDE_WRAP),\n    fastai.vision.zoom(scale = _SCALE_ZOOM)]\n\nimg_exemple_generated = img_exemple.apply_tfms(tfms_dicom,padding_mode=\"zeros\")\nmask_exemple_generated = mask_exemple.apply_tfms(tfms_mask,padding_mode=\"zeros\")\n\nplot_image_mask(img_exemple_generated,mask_exemple_generated)\nimg = fastai.vision.open_image(xray_images.items[10620])\nmask = fastai.vision.open_mask(mask_images.items[10620])\nplot_image_mask(img,mask)","8f7dd23f":"fastai.vision.rle_encode(mask.data)","48c4eee7":"img = fastai.vision.open_image(xray_images.items[6])\nmask = fastai.vision.open_mask(mask_images.items[6])\nplot_image_mask(img,mask)","5a571038":"def generate_new_images(img_,mask_):\n    #select random paramters to apply\n    _ROTATE_DEGREES  = random.choices(np.linspace(-60,60,12))[0]\n    _MAGNITUDE_WRAP = random.choices(np.linspace(-0.2,-0.1,3))[0]\n    _SCALE_ZOOM = random.choices(np.linspace(1.1,1.5,6))[0]\n    _CHANGE_BRIGHTNESS = random.choices(np.linspace(0.6,0.8,10))[0]\n    _SCALE_CONSTRAST = random.choices([(i,j) for i,j in zip(np.linspace(2,4,1),np.linspace(4,7,1))])[0]\n    tfms_dicom=[\n        fastai.vision.rotate(degrees = _ROTATE_DEGREES),\n        fastai.vision.symmetric_warp(magnitude = _MAGNITUDE_WRAP),\n        fastai.vision.zoom(scale = _SCALE_ZOOM),\n        fastai.vision.brightness(change = _CHANGE_BRIGHTNESS),\n        fastai.vision.contrast(scale = _SCALE_CONSTRAST)]\n\n    tfms_mask=[\n        fastai.vision.rotate(degrees = _ROTATE_DEGREES),\n        fastai.vision.symmetric_warp(magnitude = _MAGNITUDE_WRAP),\n        fastai.vision.zoom(scale = _SCALE_ZOOM)]\n\n    img_generated = img_.apply_tfms(tfms_dicom,padding_mode=\"zeros\")\n    mask_generated = mask_.apply_tfms(tfms_mask,padding_mode=\"zeros\")\n    #define an ID to save in csv file\n    suffix_imageid = f'_generated_{int(np.abs(_ROTATE_DEGREES))}_{int(np.abs(_MAGNITUDE_WRAP))}_{int(_SCALE_ZOOM)}_{int(_CHANGE_BRIGHTNESS)}_{int(_SCALE_CONSTRAST[0])}_{int(_SCALE_CONSTRAST[1])}'\n    return img_generated,mask_generated, suffix_imageid\n\nimg_generated,mask_generated, suffix_imageid = generate_new_images(img,mask)\n\nplot_image_mask(img_generated,mask_generated)\nprint('MASK GENERATED: {}'.format(fastai.vision.rle_encode(mask_generated.data)))","97544dac":"def generate_new_data(inputdir_dicom,inputdir_mask,outputdir,number_of_data_to_generate):\n    xray_images= fastai.vision.ImageList.from_folder(inputdir_dicom)\n    mask_images = fastai.vision.ImageList.from_folder(inputdir_mask)\n    print(len(xray_images),len(mask_images))\n    outputdir_dicom = outputdir+'dicom\/'\n    outputdir_mask = outputdir+'mask\/'\n    \n    if not os.path.exists(outputdir_dicom):\n        os.makedirs(outputdir_dicom)\n    if not os.path.exists(outputdir_mask):\n        os.makedirs(outputdir_mask)\n    \n    ids_generated = []\n    rle_generated = []\n    number_of_data_to_generate_=number_of_data_to_generate\n    for i in tqdm(range(0,number_of_data_to_generate_)):\n        random_choice = random.randint(0,len(xray_images))\n        img = fastai.vision.open_image(xray_images.items[random_choice])\n        mask = fastai.vision.open_mask(mask_images.items[random_choice])\n        img_generated,mask_generated, suffix_imageid = generate_new_images(img,mask)\n        \n        #plot_image_mask(img_generated,mask_generated)\n        \n        ImageId = os.path.splitext(os.path.basename(xray_images.items[random_choice]))[0]\n        #print(outputdir_dicom+ImageId+suffix_imageid+'.png')\n        #print(outputdir_mask+ImageId+suffix_imageid+'.png')\n        try:\n            rle_encoded = fastai.vision.rle_encode(mask_generated.data)\n        except ValueError:\n            number_of_data_to_generate= number_of_data_to_generate-1 # @TODO: Need to fix this error\n            continue\n        if rle_encoded == '':\n            rle_encoded = ' -1'\n        ids_generated.append(ImageId+suffix_imageid)\n        img_generated.save(outputdir_dicom+ImageId+suffix_imageid+'.png')\n        mask_generated.save(outputdir_mask+ImageId+suffix_imageid+'.png')\n        rle_generated.append(rle_encoded)\n    print('END : {} IMAGE GENERATED'.format(number_of_data_to_generate))\n    df_rle_generated = pd.DataFrame({'ImageId':ids_generated,' EncodedPixels':rle_generated},columns=['ImageId',' EncodedPixels'])\n    df_rle_generated.to_csv('.\/train-rle_generated.csv',index=False, header=True)\n    print('RLE CSV DATA SAVED')\n\ninputdir_dicom = '..\/input\/siimdatasetx128\/siim-datasetx128\/siim-datasetx128\/train\/128\/dicom\/'\ninputdir_mask = '..\/input\/siimdatasetx128\/siim-datasetx128\/siim-datasetx128\/train\/128\/mask\/'\npath_to_save_generated_data = '..\/output_data_generation\/'\n\ngenerate_new_data(inputdir_dicom,inputdir_mask,path_to_save_generated_data,1000)","128f15f7":"def zip_image_generated(path_to_images_folder):\n    images_to_compress = fastai.vision.ImageList.from_folder(path_to_images_folder)\n    if len(images_to_compress) > 1:\n        print('---------------------------')\n        print('{0} Image to compress in {1}'.format(len(images_to_compress),path_to_images_folder))\n        with ZipFile('.\/images_generated\/image_generated.zip','w') as zip: \n        # writing each file one by one \n            for i in range(0,len(images_to_compress)):\n                zip.write(images_to_compress.items[i]) \n        print('{} Image compressed'.format(len(images_to_compress)))\n        print('---------------------------')\n    else:\n        print('No images in {}, please check again'.format(path_to_images_folder))\n        raise ValueError\n\nzip_image_generated('..\/output_data_generation\/images_generated\/dicom\/')\nzip_image_generated('..\/output_data_generation\/images_generated\/mask\/')","cb2ec1d1":"pd.read_csv('.\/train-rle_generated.csv')","1e6d605e":"And now let's try to generate new data from.","fe78f24a":"Let's take a look to original data.","e02db41d":"Please Upvote this kernel if you find it useful.\nMore improvements will follow :-)","b7752c96":"## Generate and save data\nGenerate a certain amounts of new data and save them in a new file","893aac64":"### Lets make it scalable !","9799dde7":"## TEST of transformation","782fc279":"# GENERATE MORE IMAGES TRAINING DATA BASED ON STOCHASTIC DISTRUBUTIONS AND FASTAI\n\nIn this competitions we really need more data, In this kernel I implement a way to generate data. Please do not hesitate to comments and I will make improvements.\n\n\n**Please consider to upvote if you find this kernel interesting or before forked. **\n\nHave fun :-) \n\n![](https:\/\/cdn-images-1.medium.com\/max\/1200\/1*C8hNiOqur4OJyEZmC7OnzQ.png)","51677e61":"### LOAD DATA (x128)","64aa5f7b":"## Compress images to zip"}}