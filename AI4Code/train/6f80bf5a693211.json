{"cell_type":{"a794c044":"code","16917d8f":"code","ef2c77af":"code","0a5cbe89":"code","1e79a370":"code","98a5745b":"code","eed4f4aa":"code","77abb836":"code","2a246b3e":"code","a57d4e14":"code","450438ff":"code","8cb33c11":"code","e2f71488":"code","584c27c4":"code","dd82e7c0":"code","31bc9ed2":"code","b44972e8":"code","2717fb3c":"code","7c8cfb4c":"markdown","4a76139e":"markdown","4b9762c2":"markdown"},"source":{"a794c044":"import gc\nimport random\nimport numpy as np\nimport pandas as pd\nimport cudf\nimport matplotlib.pyplot as plt","16917d8f":"def fast_merge(left, right, key):\n    return cudf.concat([left.reset_index(drop=True), right.reindex(left[key].values).reset_index(drop=True)], axis=1)","ef2c77af":"seed = 1\nrandom.seed(seed)\nnp.random.seed(seed)","0a5cbe89":"a = 2.2\nb = 2.3","1e79a370":"size = 1000000\nsamples = np.random.beta(a, b, size)\nsamples = pd.Series(samples)\nsamples.hist(bins=100)\nplt.show()","98a5745b":"samples.describe()","eed4f4aa":"dtypes = {\n    'row_id': 'int64',\n    'timestamp': 'int64',\n    'user_id': 'int32',\n    'content_id': 'int16',\n    'content_type_id': 'int8',\n    'task_container_id': 'int16',\n    'user_answer': 'int8',\n    'answered_correctly':'int8',\n    'prior_question_elapsed_time': 'float32',\n    'prior_question_had_explanation': 'boolean'\n}","77abb836":"%%time\ntrain = cudf.read_csv('\/kaggle\/input\/riiid-test-answer-prediction\/train.csv', dtype=dtypes)","2a246b3e":"max_timestamp_u = train[['user_id','timestamp']].groupby(['user_id']).max()\nmax_timestamp_u.columns = ['max_timestamp']\nmax_timestamp_u['interval'] = max_timestamp_u.max_timestamp.max() - max_timestamp_u.max_timestamp\n# max_timestamp_u['random'] = np.random.rand(len(max_timestamp_u))\nmax_timestamp_u['random'] = np.random.beta(a, b, len(max_timestamp_u))\nmax_timestamp_u['random_timestamp'] = max_timestamp_u.interval * max_timestamp_u.random\nmax_timestamp_u['random_timestamp'] = max_timestamp_u.random_timestamp.astype(int)\nmax_timestamp_u.drop(['interval', 'random'], axis=1, inplace=True)","a57d4e14":"max_timestamp_u.describe()","450438ff":"train = fast_merge(train, max_timestamp_u, 'user_id')\ntrain['virtual_timestamp'] = train.timestamp + train.random_timestamp\ntrain.set_index(['virtual_timestamp', 'row_id'], inplace=True)\ntrain.sort_index(inplace=True)\ntrain.reset_index(inplace=True)\ntrain.drop(columns=['max_timestamp', 'random_timestamp'], inplace=True)","8cb33c11":"last100m = train[-100000000:]\ninterval = 2500000\nmean_max_timestamp = []\ntarget_means = []\nfor i in range(40):\n    start = i * interval\n    user_list = last100m[start:start+interval].user_id.unique()\n    mean_max_timestamp.append(max_timestamp_u[['max_timestamp']].reindex(user_list).mean())\n    temp = last100m[last100m.answered_correctly != -1]\n    target_means.append(temp[start:start+interval].answered_correctly.mean())\nmean_max_timestamp = cudf.concat(mean_max_timestamp).to_pandas()\ntarget_means = pd.Series(target_means)","e2f71488":"plt.bar(list(range(40)), mean_max_timestamp)\nplt.show()","584c27c4":"target_means.plot()\nplt.show()","dd82e7c0":"last10m = train[-10000000:]\ninterval = 1000000\nmean_max_timestamp = []\ntarget_means = []\nfor i in range(10):\n    start = i * interval\n    user_list = last10m[start:start+interval].user_id.unique()\n    mean_max_timestamp.append(max_timestamp_u[['max_timestamp']].reindex(user_list).mean())\n    temp = last10m[last10m.answered_correctly != -1]\n    target_means.append(temp[start:start+interval].answered_correctly.mean())\nmean_max_timestamp = cudf.concat(mean_max_timestamp).to_pandas()\ntarget_means = pd.Series(target_means)","31bc9ed2":"plt.bar(list(range(10)), mean_max_timestamp)\nplt.show()","b44972e8":"target_means.plot()\nplt.show()","2717fb3c":"val_size = 2500000\nfor cv in range(5):\n    valid = train[-val_size:]\n    train = train[:-val_size]\n    valid.to_parquet(f'cv{cv+1}_valid.parquet')\n    train.to_parquet(f'cv{cv+1}_train.parquet')","7c8cfb4c":"The timestamps are almost the same, but the accuracy rate is lower. It is difficult to make an unbiased CV.\nYou may want to throw away the last 2.5 million.","4a76139e":"The users are slightly biased in the original script.\nPlease see [this notebook](https:\/\/www.kaggle.com\/marisakamozz\/riiid-cv-strategy-users-are-slightly-biased) for details.\nTherefore, I will sample random numbers from the beta distribution instead of the uniform distribution.","4b9762c2":"This script can be run in the kaggle environment.\nGPU accelerator is required.\n\nThe original script is [CV Strategy](https:\/\/www.kaggle.com\/its7171\/cv-strategy)."}}