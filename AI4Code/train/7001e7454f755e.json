{"cell_type":{"2df3b2de":"code","bfab50bf":"code","cf3703c5":"code","7ad0d92d":"code","e958b0cf":"code","22437d39":"code","18a55bea":"code","33e6fb0e":"code","f7cb73be":"code","bbcb83aa":"code","f30d7055":"code","c500ec51":"code","c3455042":"code","e93eb248":"code","80dbdcf7":"code","d6798984":"code","407c3f21":"markdown","4d67c396":"markdown","6b5aba91":"markdown","659694db":"markdown","631e08e6":"markdown","fc467090":"markdown","2146428b":"markdown","64258e43":"markdown","eb9569e4":"markdown","f60593d4":"markdown","6cb0f229":"markdown","46c40f23":"markdown","d6940f72":"markdown","b5c340e1":"markdown","b72d81ca":"markdown","86f50afa":"markdown","c255847f":"markdown","a6d0dacc":"markdown"},"source":{"2df3b2de":"# Support operations for multi-dimentional arrays and matrices\nimport numpy as np\n# Data manipulation and analysis\nimport pandas as pd\n# Area Under the Receiver Operating Characteristic Curve (ROC AUC)\nfrom sklearn.metrics import roc_auc_score","bfab50bf":"# Installing the version 2 of fastai \n!pip install -q fastai2","cf3703c5":"from fastai2.vision.all import *","7ad0d92d":"# Defining the Path\nPATH = Path('\/kaggle\/input\/plant-pathology-2020-fgvc7\/')\nIMAGE_PATH = Path('\/kaggle\/input\/plant-pathology-2020-fgvc7\/images')\n\nLABELS = ['healthy', 'multiple_diseases', 'rust', 'scab']\n\n# Reading the train and test data\ntrain_df = pd.read_csv(PATH \/ 'train.csv')\ntest_df = pd.read_csv(PATH \/ 'test.csv')\n\n#Defining hyperparameters\nVALIDATION_PCT = 0.2\nSEED = 42\nIMAGE_SIZE = 512\nBATCH_SIZE = 16","e958b0cf":"train_df.head()","22437d39":"def get_category(row):\n    for key, value in row[LABELS].items():\n        if value == 1:\n            return key","18a55bea":"train_df['label'] = train_df.apply(get_category, axis=1)","33e6fb0e":"# train_df.head()\ntrain_df.size","f7cb73be":"def load_data():\n    datablock = DataBlock(blocks=(ImageBlock, CategoryBlock(vocab=LABELS)),\n                          getters=[ColReader('image_id', pref=IMAGE_PATH, suff='.jpg'),\n                                   ColReader('label')],\n                          splitter=RandomSplitter(valid_pct = VALIDATION_PCT, seed = SEED),\n                          item_tfms=Resize(IMAGE_SIZE),\n                          batch_tfms=aug_transforms(size = IMAGE_SIZE, max_rotate=40., min_scale=0.80, flip_vert=True, do_flip=True)\n    )\n    return datablock.dataloaders(source=train_df, bs=BATCH_SIZE)","bbcb83aa":"data = load_data()\ndata.show_batch()","f30d7055":"def comp_metric(preds, targs, labels=range(len(LABELS))):\n    targs = np.eye(4)[targs]\n    return np.mean([roc_auc_score(targs[:,i], preds[:,i]) for i in labels])\n\ndef healthy_roc_auc(*args):\n    return comp_metric(*args, labels=[0])\n\ndef multiple_diseases_roc_auc(*args):\n    return comp_metric(*args, labels=[1])\n\ndef rust_roc_auc(*args):\n    return comp_metric(*args, labels=[2])\n\ndef scab_roc_auc(*args):\n    return comp_metric(*args, labels=[3])","c500ec51":"learn = cnn_learner(data, resnet152, metrics=[\n    AccumMetric(healthy_roc_auc, flatten=False),\n    AccumMetric(multiple_diseases_roc_auc, flatten=False),\n    AccumMetric(rust_roc_auc, flatten=False),\n    AccumMetric(scab_roc_auc, flatten=False),\n    AccumMetric(comp_metric, flatten=False)]\n    )\nlearn.fine_tune(50)","c3455042":"interp = ClassificationInterpretation.from_learner(learn)\ninterp.plot_confusion_matrix()","e93eb248":"interp.plot_top_losses(4, nrows=4)","80dbdcf7":"# Creating dataloader for the test data\ntest_dl = data.test_dl(test_df)\n# Predicting the category of each image in test data using the trained model\ntest_preds, _ = learn.get_preds(dl=test_dl)","d6798984":"# Adding the column for the labels to the test data frame\ntest_predictions = pd.concat([test_df, pd.DataFrame(np.stack(test_preds), columns=LABELS)], axis=1)\ntest_predictions.to_csv('submission.csv', index=False)\ntest_predictions.head()","407c3f21":"### Creating the test prediction dataframe and csv file","4d67c396":"Defining a function which can be used to load the data. It uses fastai's **datablock api** which helps in fetching the files from the given Path.","6b5aba91":"### Defining metric functions (ROC AUC) on which the predictions are evaluated","659694db":"### Importing the required libraries","631e08e6":"### Prediction of labels for the test data ","fc467090":"### Let's have a look at the training data.","2146428b":"A new column called 'label' is created. \nThe func get_category() is used to fetch the values for this column from the training data.","64258e43":"# Model","eb9569e4":"###  Installing the version 2 of fastai","f60593d4":"### Importing all the required fastaiv2 functions","6cb0f229":"### Defining all the variables, hyperparameters and loading the data.","46c40f23":"# Data Visualization","d6940f72":"### Interpretting the predictions of the model","b5c340e1":"#  Plant Pathology 2020 - FGVC7\n \nThis is a starter kernel created for the competition [\"Plant Pathology 2020 - FGVC7\"](http:\/\/Plant Pathology 2020 - FGVC7).\n\n## Problem Statement\n\nThere are many benefits in identifying diseases in agricultural crops. These benefits include reduced time, input costs and less adverse environmental impact (due to overuse of chemicals).\n\nIn this competition, we are given 1821 apple leafs to create a model which can detect diseases.\nThe aim is to classify the given test images into different categories like 'healthy', 'multiple_diseases','scab' and 'rust'.\nPlease click on the [link](http:\/\/https:\/\/www.kaggle.com\/c\/plant-pathology-2020-fgvc7\/overview) to find the details of the problem statement.\n\n## Data\n\nLabels : healthy, scab, rust and multiple_diseases\n\n1.  **train.csv** contains image_id, healthy, scab, rust and multiple_diseases\n2.  **test.csv**  contains image_id\n\n3. **images** : A folder containing the test and train images in jpg format. The name of files is in the below format\n\n\n* Test files   : Test_0 to Test_1820 \n* Train files  : Train_0 to Train_1820\n\n## Note\n\nA simple example of Transfer Learning has been shown in the kernel where we use a pretrained model of ResNet152. \n\nThe kernel uses [fastai2](http:\/\/https:\/\/dev.fast.ai\/) APIs which is a wrapper on top of PyTorch.\n\nI'd like to thank the author of the below kernel. The kernel was very useful which creating this kernel.\n\n[Plant Pathology 2020 - EDA + training (fastai2)](http:\/\/https:\/\/www.kaggle.com\/lextoumbourou\/plant-pathology-2020-eda-training-fastai2)\n","b72d81ca":"### Looking at the training data with the newly created column 'label'.","86f50afa":"### Initializing and training our CNN model with the required parameters.","c255847f":"# Prediction","a6d0dacc":"### Creating a function to fetch the label for a specific image."}}