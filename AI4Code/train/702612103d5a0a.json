{"cell_type":{"e0e7e79b":"code","66357add":"code","5116bdfb":"code","49620d6a":"code","d844677a":"code","de57d80c":"code","b4f66f3a":"code","911ce60d":"code","917d3bc2":"code","59dbe941":"code","9fb75faf":"code","9ffe9586":"code","2fd7ba4b":"code","2b39f23a":"code","0c0a91f5":"code","c95dfa77":"code","5edb4ffc":"code","69151c03":"code","5bb4344c":"code","ae0605eb":"code","4926b57d":"code","e46a6465":"code","66c1fcb9":"code","a30658a5":"code","6340930f":"code","a99c326f":"code","f4686256":"code","219b3a07":"code","abb3e873":"code","e252e250":"code","b6833a63":"code","b240ee1d":"code","0c19c15a":"code","0a95a273":"code","0f8fa9b4":"code","37557719":"code","7635ac4d":"code","0e7cca82":"code","c422f725":"code","4a602ca5":"code","f2ab3f67":"code","eeafea91":"code","2efe0e4f":"code","2b2822f3":"code","d1d27462":"code","38645363":"code","f8bd3887":"code","1489aeea":"code","12b1ab84":"code","31280b07":"code","5f480783":"code","db7f8f24":"code","1d09f4e8":"code","ee1f23b0":"code","5825d04d":"code","8d0bbc99":"code","6a2fa654":"code","cf2b6cbd":"code","b882fcb3":"code","88c535f2":"code","382feb2f":"code","b8c8cc03":"code","b7f42de6":"code","9e741e34":"code","1b99484f":"code","490e145a":"markdown","7802f3e3":"markdown","2684d268":"markdown","b1a27b4d":"markdown","aea810e0":"markdown","a8fb0f8d":"markdown","5123d55d":"markdown","8cbc27ba":"markdown","4d33c98c":"markdown","df380bee":"markdown","c376cc9f":"markdown","13d8fc9e":"markdown"},"source":{"e0e7e79b":"import numpy as np\nimport pandas as pd\nimport seaborn as sns\nimport matplotlib.pyplot as plt\nfrom geopy.distance import geodesic\nimport os\nimport zipfile\n\nfrom fbprophet import Prophet\nfrom fbprophet.plot import plot_plotly, plot_components_plotly\n\nimport xgboost as xgb\n\nfrom sklearn.ensemble import RandomForestClassifier\nfrom sklearn.ensemble import IsolationForest\nfrom sklearn.cluster import KMeans\nfrom sklearn.metrics import mean_squared_log_error\nfrom sklearn.model_selection import train_test_split\nfrom sklearn.metrics import mean_squared_error\nfrom sklearn.neural_network import MLPRegressor\n\nfrom tensorflow.keras.models import Sequential\nfrom tensorflow.keras.layers import Dense\nfrom tensorflow.keras.optimizers import Adam\nfrom tensorflow.keras.layers import Dropout\n\n%matplotlib inline","66357add":"for dirname, _, filenames in os.walk('\/kaggle\/input'):\n    for filename in filenames:\n        print(os.path.join(dirname, filename))","5116bdfb":"zf = zipfile.ZipFile('\/kaggle\/input\/nyc-taxi-trip-duration\/train.zip') \ntrain = pd.read_csv(zf.open('train.csv'))\ntrain.head()","49620d6a":"zf = zipfile.ZipFile('\/kaggle\/input\/nyc-taxi-trip-duration\/test.zip') \ntest = pd.read_csv(zf.open('test.csv'))\ntest.head()","d844677a":"zf = zipfile.ZipFile('\/kaggle\/input\/nyc-taxi-trip-duration\/sample_submission.zip') \nsample_submission = pd.read_csv(zf.open('sample_submission.csv'))\nsample_submission.head()","de57d80c":"train.info()","b4f66f3a":"test.info()","911ce60d":"sample_submission.info()","917d3bc2":"def get_distance(source_lat, source_long, dest_lat, dest_long):\n    # Returns the distance in Miles between the source and the destination.\n    \n    distance = geodesic((source_lat, source_long), \n                        (dest_lat, dest_long)).miles\n    return distance","59dbe941":"train['distance'] = train.apply(lambda x: get_distance(x.pickup_latitude, x.pickup_longitude,\n                                                       x.dropoff_latitude, x.dropoff_longitude), axis=1)\n\ntrain.head()","9fb75faf":"test['distance'] = test.apply(lambda x: get_distance(x.pickup_latitude, x.pickup_longitude,\n                                                     x.dropoff_latitude, x.dropoff_longitude), axis=1)\n\ntest.head()","9ffe9586":"sns.set(rc={'figure.figsize':(15, 7)})\nsns.distplot(train['trip_duration'].values, axlabel = 'trip_duration', bins = 500)","2fd7ba4b":"sns.set(rc={'figure.figsize':(15, 5)})\nsns.distplot(train['trip_duration'].values\/3600, axlabel = 'Trip Duration (in Hours)', bins = 75)","2b39f23a":"df_filtered = train[train['distance'] <= 100].copy()\nsns.distplot(df_filtered['distance'].values, axlabel = 'Trip Distance', bins = 20)","0c0a91f5":"df_filtered = test[test['distance'] <= 100].copy()\nsns.distplot(df_filtered['distance'].values, axlabel = 'Trip Distance', bins = 20)","c95dfa77":"df_filtered = train[train['distance'] <= 20].copy()\nsns.distplot(df_filtered['distance'].values, axlabel = 'Trip Distance in Miles (Filtered)', bins = 50)","5edb4ffc":"df_filtered = test[test['distance'] <= 20].copy()\nsns.distplot(df_filtered['distance'].values, axlabel = 'Trip Distance in Miles (Filtered)', bins = 50)","69151c03":"sns.scatterplot(data=train, x=\"distance\", y=\"trip_duration\")","5bb4344c":"clf = IsolationForest(random_state = 42, contamination = 0.01)\ntrain['Anomaly'] = clf.fit_predict(train[['distance', 'trip_duration']])\ntrain.head()","ae0605eb":"train.Anomaly.value_counts()","4926b57d":"plt.title(\"Outlier vs. Normal Trips\")\nplt.rcParams['figure.figsize'] = [15, 7]\n\nplt.scatter(train.loc[train.Anomaly == -1, ['distance']], \n                 train.loc[train.Anomaly == -1, ['trip_duration']], c='red')\nplt.scatter(train.loc[train.Anomaly == 1, ['distance']], \n                 train.loc[train.Anomaly == 1, ['trip_duration']], c='green')\nplt.show()","e46a6465":"train = train.loc[train['Anomaly'] == 1].copy()\nsns.scatterplot(data=train, x=\"distance\", y=\"trip_duration\")","66c1fcb9":"train['pickup_datetime'] = pd.to_datetime(train['pickup_datetime'])\ntrain['dropoff_datetime'] = pd.to_datetime(train['dropoff_datetime'])\ntrain.info()","a30658a5":"test['pickup_datetime'] = pd.to_datetime(train['pickup_datetime'])\ntest['dropoff_datetime'] = pd.to_datetime(train['dropoff_datetime'])\ntest.info()","6340930f":"train['date'] = train['pickup_datetime'].dt.date\ntrain.head()","a99c326f":"test['date'] = test['pickup_datetime'].dt.date\ntest.head()","f4686256":"sns.set(rc={'figure.figsize':(15, 7)})\nsns.lineplot(x=\"date\", y=\"distance\", data=train)","219b3a07":"sns.lineplot(x=\"date\", y=\"trip_duration\", data=train)","abb3e873":"data = train.groupby(['date'])['distance'].agg('sum')\ndata = pd.DataFrame({'date':data.index, 'distance':data.values})\ndata['date'] = pd.to_datetime(data['date'])\ndata.head()","e252e250":"sns.set(rc={'figure.figsize':(15, 7)})\nsns.lineplot(x=\"date\", y=\"distance\", data=data)","b6833a63":"data.rename(columns = {'distance': 'y', 'date': 'ds'}, inplace = True)\nm = Prophet(seasonality_mode='additive').fit(data)\nfuture = m.make_future_dataframe(periods = 30)\nforecast = m.predict(future)\nfig = m.plot(forecast)","b240ee1d":"data = train.groupby(['date'])['trip_duration'].agg('sum')\ndata = pd.DataFrame({'date':data.index, 'trip_duration':data.values})\ndata['date'] = pd.to_datetime(data['date'])\ndata.head()","0c19c15a":"sns.set(rc={'figure.figsize':(15, 7)})\nsns.lineplot(x=\"date\", y=\"trip_duration\", data=data)","0a95a273":"data.rename(columns = {'trip_duration': 'y', 'date': 'ds'}, inplace = True)\nm = Prophet(seasonality_mode='additive').fit(data)\nfuture = m.make_future_dataframe(periods = 30)\nforecast = m.predict(future)\nfig = m.plot(forecast)","0f8fa9b4":"train.head()","37557719":"test.head()","7635ac4d":"kmeans = KMeans(n_clusters=5, random_state=42).fit(train[['pickup_longitude','pickup_latitude']])\npickup_clusters = kmeans.predict(train[['pickup_longitude','pickup_latitude']])\npickup_clusters","0e7cca82":"# kmeans = KMeans(n_clusters=5, random_state=42).fit(train[['pickup_longitude','pickup_latitude']])\npickup_clusters_test = kmeans.predict(test[['pickup_longitude','pickup_latitude']])\npickup_clusters_test","c422f725":"kmeans = KMeans(n_clusters=5, random_state=42).fit(train[['dropoff_longitude','dropoff_latitude']])\ndropoff_clusters = kmeans.predict(train[['dropoff_longitude','dropoff_latitude']])\ndropoff_clusters","4a602ca5":"# kmeans = KMeans(n_clusters=5, random_state=42).fit(train[['dropoff_longitude','dropoff_latitude']])\ndropoff_clusters_test = kmeans.predict(test[['dropoff_longitude','dropoff_latitude']])\ndropoff_clusters_test","f2ab3f67":"train['pickup_clusters'] = pickup_clusters\ntrain['dropoff_clusters'] = dropoff_clusters\ntrain.head()","eeafea91":"test['pickup_clusters'] = pickup_clusters_test\ntest['dropoff_clusters'] = dropoff_clusters_test\ntest.head()","2efe0e4f":"train_backup = train.copy()","2b2822f3":"test_backup = test.copy()","d1d27462":"pickup_clusters_encoded = pd.get_dummies(train['pickup_clusters'], prefix='pickup_cluster')\ndropoff_clusters_encoded = pd.get_dummies(train['dropoff_clusters'], prefix='dropoff_cluster')\nstore_and_fwd_flag_encoded = pd.get_dummies(train['store_and_fwd_flag'], prefix='store_and_fwd_flag')\npassenger_count_encoded = pd.get_dummies(train['passenger_count'], prefix='passenger_count')\nvendor_id_encoded = pd.get_dummies(train['vendor_id'], prefix='vendor_id')\n\npickup_clusters_encoded.head()","38645363":"test_pickup_clusters_encoded = pd.get_dummies(test['pickup_clusters'], prefix='pickup_cluster')\ntest_dropoff_clusters_encoded = pd.get_dummies(test['dropoff_clusters'], prefix='dropoff_cluster')\ntest_store_and_fwd_flag_encoded = pd.get_dummies(test['store_and_fwd_flag'], prefix='store_and_fwd_flag')\ntest_passenger_count_encoded = pd.get_dummies(test['passenger_count'], prefix='passenger_count')\ntest_vendor_id_encoded = pd.get_dummies(test['vendor_id'], prefix='vendor_id')","f8bd3887":"train.drop('pickup_clusters', axis = 1, inplace = True)\ntrain.drop('dropoff_clusters', axis = 1, inplace = True)\ntrain.drop('store_and_fwd_flag', axis = 1, inplace = True)\ntrain.drop('passenger_count', axis = 1, inplace = True)\ntrain.drop('vendor_id', axis = 1, inplace = True)\ntrain.head()","1489aeea":"test.drop('pickup_clusters', axis = 1, inplace = True)\ntest.drop('dropoff_clusters', axis = 1, inplace = True)\ntest.drop('store_and_fwd_flag', axis = 1, inplace = True)\ntest.drop('passenger_count', axis = 1, inplace = True)\ntest.drop('vendor_id', axis = 1, inplace = True)\ntest.head()","12b1ab84":"train = train.join(pickup_clusters_encoded)\ntrain = train.join(dropoff_clusters_encoded)\ntrain = train.join(store_and_fwd_flag_encoded)\ntrain = train.join(passenger_count_encoded)\ntrain = train.join(vendor_id_encoded)\ntrain.head()","31280b07":"test = test.join(test_pickup_clusters_encoded)\ntest = test.join(test_dropoff_clusters_encoded)\ntest = test.join(test_store_and_fwd_flag_encoded)\ntest = test.join(test_passenger_count_encoded)\ntest = test.join(test_vendor_id_encoded)\ntest.head()","5f480783":"train.columns","db7f8f24":"test.columns","1d09f4e8":"train_cols = train.columns\ntest_cols = test.columns\nprint([x for x in train_cols if x not in test_cols])","ee1f23b0":"test['dropoff_cluster_4'] = 0\ntest['passenger_count_7'] = 0\ntest['passenger_count_8'] = 0\nprint([x for x in train.columns if x not in test.columns])\ntest.head()","5825d04d":"X = train.drop(['id', 'pickup_datetime', 'dropoff_datetime', \n              'pickup_longitude', 'pickup_latitude', \n              'dropoff_longitude', 'dropoff_latitude', \n              'date', 'trip_duration', 'Anomaly'], axis = 1).copy()\nX.head()","8d0bbc99":"y = train['trip_duration']\ny.head()","6a2fa654":"reg = xgb.XGBRegressor()\nreg.fit(X.values, y.values)","cf2b6cbd":"X_test = test.drop(['id', 'pickup_datetime', 'dropoff_datetime', \n              'pickup_longitude', 'pickup_latitude', \n              'dropoff_longitude', 'dropoff_latitude', \n              'date'], axis = 1).copy()","b882fcb3":"X.columns","88c535f2":"X_test.columns","382feb2f":"X_test = X_test[['distance', 'pickup_cluster_0', 'pickup_cluster_1', 'pickup_cluster_2',\n               'pickup_cluster_3', 'pickup_cluster_4', 'dropoff_cluster_0',\n               'dropoff_cluster_1', 'dropoff_cluster_2', 'dropoff_cluster_3',\n               'dropoff_cluster_4', 'store_and_fwd_flag_N', 'store_and_fwd_flag_Y',\n               'passenger_count_0', 'passenger_count_1', 'passenger_count_2',\n               'passenger_count_3', 'passenger_count_4', 'passenger_count_5',\n               'passenger_count_6', 'passenger_count_7', 'passenger_count_8',\n               'passenger_count_9', 'vendor_id_1', 'vendor_id_2']]\nX_test.columns","b8c8cc03":"pred = reg.predict(X_test.values)\npred","b7f42de6":"sample_submission.info()","9e741e34":"submission = test['id']\nsubmission = {\"id\":test[\"id\"],\"trip_duration\":pred}\nsubmission = pd.DataFrame(submission)\nsubmission.info()","1b99484f":"submission.to_csv(\"submission.csv\",index=False)","490e145a":"Total Trip Duration Forecasting for the next 30 days using Facebook Prophet","7802f3e3":"## Anomaly Detection and Removal\nDetecting Anomalous Trips using the Distance Column and the Trip Duration Column using Sk-learn Isolation Forest and removing it from the training set.","2684d268":"## Creating Backup Before Model Training","b1a27b4d":"## One-Hot Encoding ","aea810e0":"## Data Visualizations","a8fb0f8d":"## Feature Engineering - Location-based Clustering\nCreating separate clusters based on Pick Up location and  Drop Off location.","5123d55d":"Total Distance Travelled Forecasting for the next 30 days using Facebook Prophet","8cbc27ba":"## Import Python Packages and Environment Setup","4d33c98c":"## Feature Engineering - Total Distance Travelled\nCalculating Distance (in Miles) between the Pick up and Drop off Coordinates and saving it as a separate column in the Train and Test DataFrames.","df380bee":"## Data Preparation for Model Training","c376cc9f":"## Importing and Analyzing the Train, Test, and Sample Submission CSVs","13d8fc9e":"## Trip Duration and Distance Forecasting using Facebook Prophet"}}