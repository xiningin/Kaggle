{"cell_type":{"26ba9d82":"code","02a85045":"code","fe620888":"code","94fe6fcc":"code","dab1defc":"code","eaa881b1":"code","c212c155":"code","301242c7":"code","ce158d62":"code","9628bdf6":"code","95d643a0":"code","c2a8ee24":"code","14a0ed64":"code","82906f44":"code","9e08b12f":"code","f0593951":"code","fb6cfb66":"code","d34caac8":"code","5edc33fe":"code","d15cf4cd":"markdown","d1986706":"markdown","c9334445":"markdown","6ed75d70":"markdown","7f71ade7":"markdown"},"source":{"26ba9d82":"import os\nimport numpy as np\nimport pandas as pd\n\nfrom fastai import *\nfrom fastai.vision import *\n\nfrom pathlib import Path\nfrom PIL import Image","02a85045":"# !rm -rf \/kaggle\/output\n# !mkdir \/kaggle\/output","fe620888":"input_root_path = Path(\"\/kaggle\/input\/digit-recognizer\")\noutput_root_path = Path(\"\/kaggle\/output\")","94fe6fcc":"train_df = pd.read_csv(input_root_path\/'train.csv')\ntest_df = pd.read_csv(input_root_path\/'test.csv')","dab1defc":"train_df.head()","eaa881b1":"def saveDigit(digit, filepath):\n    digit = digit.reshape(28, 28)\n    digit = digit.astype(np.uint8)\n\n    img = Image.fromarray(digit)\n    img.save(filepath)\n    \ndef save_train_images(output_root_path: Path, df: pd.DataFrame, num_classes=10):\n    output_data_path = output_root_path\/'train'\n    os.makedirs(output_data_path)\n    for i in range(num_classes):\n        os.makedirs(output_data_path\/str(i))\n    for index, row in df.iterrows():\n        label,digit = row[0], row[1:]\n\n        folder = output_data_path\/str(label)\n        filename = f\"{index}.jpg\"\n        filepath = folder\/filename\n\n        digit = digit.values\n        saveDigit(digit, filepath)\n        \ndef save_test_images(output_root_path: Path, df: pd.DataFrame):\n    output_data_path = output_root_path\/'test'\n    os.makedirs(output_data_path)\n    for index, row in df.iterrows():\n        filename = f\"{index}.jpg\"\n        filepath = output_data_path\/filename\n        saveDigit(row.values, filepath)","c212c155":"save_train_images(output_root_path, train_df)\nsave_test_images(output_root_path, test_df)","301242c7":"tfms = get_transforms(do_flip=False, max_rotate=20.0, max_warp=0.0)","ce158d62":"data = ImageDataBunch.from_folder(\n    path=output_root_path,\n    train='train',\n    test='test',\n    seed=1234,\n    #validation part\n    valid_pct=0.2,\n    #image size\n    size=28,\n    #data augumentation\n    ds_tfms=tfms\n).normalize()","9628bdf6":"data.show_batch(rows=3, figsize=(5, 5))","95d643a0":"learn = cnn_learner(data, models.resnet152, metrics=accuracy, callback_fns=ShowGraph).mixup()","c2a8ee24":"learn.fit_one_cycle(10)","14a0ed64":"lrf=learn.lr_find()","82906f44":"learn.recorder.plot()","9e08b12f":"learn.save('model')\nlearn.load('model')","f0593951":"learn.unfreeze()\nlearn.fit_one_cycle(10, 1e-02)","fb6cfb66":"class_score, _ = learn.get_preds(DatasetType.Test)\nclass_score = np.argmax(class_score, axis=1)","d34caac8":"# remove file extension from filename\nImageId = [os.path.splitext(path)[0] for path in os.listdir(output_root_path\/'test')]\n# typecast to int so that file can be sorted by ImageId\nImageId = [int(path) for path in ImageId]\n# +1 because index starts at 1 in the submission file\nImageId = [ID+1 for ID in ImageId]","5edc33fe":"pd.DataFrame({\n    \"ImageId\": ImageId,\n    \"Label\": class_score\n}).to_csv(\"submission.csv\", index=False)","d15cf4cd":"## Saving a source data to the fast.ai library format","d1986706":"## Predicting values","c9334445":"## Examples of images ","6ed75d70":"## Loading train and test data","7f71ade7":"## Saving a submission"}}