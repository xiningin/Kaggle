{"cell_type":{"a523b257":"code","56e03ef7":"code","d6414cd1":"code","0563908d":"code","00913b07":"code","9640876c":"code","10e86322":"code","09333561":"code","0bb1f5ee":"code","d4f3b40f":"code","08a18cbb":"code","0d933b00":"code","b3029c25":"code","6a6f14a3":"code","649ee270":"code","1347dbab":"code","2db62070":"code","11667cd8":"code","91cd0d1d":"code","4ddca9ee":"code","6b6d3413":"code","ced2b8ad":"code","33c7ce21":"code","79a8e78f":"markdown","e44693b3":"markdown","fd93aea6":"markdown","8e271f93":"markdown","8b19969b":"markdown","b3079f35":"markdown","34066750":"markdown","55eacf4d":"markdown","56aa2fa8":"markdown","f770cbb8":"markdown","a00c5b49":"markdown","5862fb02":"markdown","d469b1e1":"markdown","f2a0989d":"markdown"},"source":{"a523b257":"import numpy as np\nimport pandas as pd\n\nimport matplotlib.pyplot as plt\nimport seaborn as sns\n\nfrom sklearn.metrics import mean_squared_error\n\nimport warnings\nwarnings.filterwarnings('ignore')\n\nfrom lightgbm import LGBMRegressor\nfrom xgboost import XGBRegressor\n\nimport tensorflow as tf\nfrom tensorflow.keras.layers.experimental import preprocessing\n\nfrom pandas_profiling import ProfileReport\n\nsns.set(style='whitegrid', font_scale=1.5)\n\nINPUT_DIR = '..\/input\/competitive-data-science-predict-future-sales'\n\nTARGET = 'item_cnt_month'\nRANDOM_STATE = 42","56e03ef7":"sales_train_df = pd.read_csv(f'{INPUT_DIR}\/sales_train.csv')\nitem_categories_df = pd.read_csv(f'{INPUT_DIR}\/item_categories.csv')\nitems_df = pd.read_csv(f'{INPUT_DIR}\/items.csv')\nshops_df = pd.read_csv(f'{INPUT_DIR}\/shops.csv')\ntest_df = pd.read_csv(f'{INPUT_DIR}\/test.csv')\nsubmission_df = pd.read_csv(f'{INPUT_DIR}\/sample_submission.csv')","d6414cd1":"sales_train_df.info()\nsales_train_df","0563908d":"profile = ProfileReport(sales_train_df, progress_bar=False, minimal=True)\nprofile.to_file('sales_train_df.html')\nprofile.to_notebook_iframe()","00913b07":"item_categories_df.info()\nitem_categories_df","9640876c":"profile = ProfileReport(item_categories_df, progress_bar=False)\nprofile.to_file('item_categories_df.html')\nprofile.to_notebook_iframe()","10e86322":"items_df.info()\nitems_df","09333561":"profile = ProfileReport(items_df, progress_bar=False)\nprofile.to_file('items_df.html')\nprofile.to_notebook_iframe()","0bb1f5ee":"shops_df.info()\nshops_df.head(15)","d4f3b40f":"profile = ProfileReport(shops_df, progress_bar=False)\nprofile.to_file('items_df.html')\nprofile.to_notebook_iframe()","08a18cbb":"test_df.info()\ntest_df","0d933b00":"pre_df = sales_train_df.copy()\npre_df = pre_df.pivot_table(\n    index=['shop_id', 'item_id'],\n    values=['item_cnt_day'],\n    columns=['date_block_num'],\n    fill_value=0,\n    aggfunc='sum'\n).reset_index()\n\npre_df","b3029c25":"full_train_df = test_df.copy()\nfull_train_df = full_train_df.merge(pre_df, how='left', on=['shop_id', 'item_id']).fillna(0).drop(\n    ['ID', 'shop_id', 'item_id'], axis=1)\n\nfull_train_df","6a6f14a3":"X_train, y_train = full_train_df.values[:,:-2], full_train_df.values[:, -2:-1].ravel()\nX_valid, y_valid = full_train_df.values[:,1:-1], full_train_df.values[:, -1:].ravel()\nX_test = full_train_df.values[:, 2:]\n\nX_train","649ee270":"%%time\n\nxgb_model = XGBRegressor(\n    # learning_rate=0.05,\n    max_depth=16,\n    n_estimators=200,\n    seed=RANDOM_STATE,\n)\n\nxgb_model.fit(X_train, y_train, early_stopping_rounds=10, eval_metric=\"rmse\",\n              eval_set=[(X_train, y_train), (X_valid, y_valid)], verbose=10)","1347dbab":"y_pred = xgb_model.predict(X_valid)\nprint('XGBoost RMSE =', mean_squared_error(y_valid, y_pred, squared=False))","2db62070":"%%time\n\nlgbm_model = LGBMRegressor(\n#     learning_rate=0.05,\n    max_depth=16,\n    n_estimators=200,\n    seed=RANDOM_STATE,\n)\n\nlgbm_model.fit(X_train, y_train, early_stopping_rounds=10, eval_metric=\"rmse\",\n               eval_set=[(X_train, y_train), (X_valid, y_valid.ravel())], verbose=10)","11667cd8":"y_pred = lgbm_model.predict(X_valid)\nprint('LGBM RMSE =', mean_squared_error(y_valid, y_pred, squared=False))","91cd0d1d":"tf.keras.backend.clear_session()\n\nlstm_model = tf.keras.Sequential([\n    tf.keras.layers.Reshape(input_shape=(32,), target_shape=(32, 1,)),\n    tf.keras.layers.LSTM(units=32, input_shape=(32, 1)),\n    tf.keras.layers.Dropout(0.4),\n    tf.keras.layers.Dense(1)\n])\n\nlstm_model.compile(\n    loss='mse',\n    optimizer=tf.keras.optimizers.Adam(0.1),\n    metrics=['mse']\n)\n\nlstm_model.summary()","4ddca9ee":"%%time\n\nearly_stop = tf.keras.callbacks.EarlyStopping(monitor='val_mse', patience=10)\n\nlstm_model.fit(X_train, y_train, batch_size=4096, epochs=30,\n          validation_data=(X_valid, y_valid),\n          callbacks=[early_stop])","6b6d3413":"y_pred = lstm_model.predict(X_valid)\nprint('LSTM RMSE =', mean_squared_error(y_valid, y_pred, squared=False))","ced2b8ad":"result_df = submission_df.copy()\nresult_df['XGB'] = xgb_model.predict(X_test)\nresult_df['LGBM'] = lgbm_model.predict(X_test)\nresult_df['LSTM'] = lstm_model.predict(X_test)\nresult_df","33c7ce21":"# blend\nresult_df[TARGET] = 0.05 * result_df['XGB'] + 0.05 * result_df['LGBM'] + 0.9 * result_df['LSTM']\n\nsubmission_df = result_df[['ID', TARGET]]\nsubmission_df.to_csv(f'output.csv', index=False)\nsubmission_df","79a8e78f":"# <center style=\"background-color:#99bbff; width:60%;\">Preprocessing<\/center>","e44693b3":"## Sales train","fd93aea6":"EOF","8e271f93":"# <center style=\"background-color:#99bbff; width:60%;\">Submit<\/center>","8b19969b":"# <center style=\"background-color:#99bbff; width:60%;\">Load<\/center>","b3079f35":"## XGBoost","34066750":"## LightGBM","55eacf4d":"# <center style=\"background-color:#99bbff; width:60%;\">Train models<\/center>","56aa2fa8":"## Item categories","f770cbb8":"## Test","a00c5b49":"## Shops","5862fb02":"## Items","d469b1e1":"## LSTM","f2a0989d":"<h1>Table of Contents<span class=\"tocSkip\"><\/span><\/h1>\n<div class=\"toc\"><ul class=\"toc-item\"><li><span><a href=\"#Load\" data-toc-modified-id=\"Load-1\"><center style=\"background-color: #99bbff ; width: 60%\">Load<\/center><\/a><\/span><ul class=\"toc-item\"><li><span><a href=\"#Sales-train\" data-toc-modified-id=\"Sales-train-1.1\">Sales train<\/a><\/span><\/li><li><span><a href=\"#Item-categories\" data-toc-modified-id=\"Item-categories-1.2\">Item categories<\/a><\/span><\/li><li><span><a href=\"#Items\" data-toc-modified-id=\"Items-1.3\">Items<\/a><\/span><\/li><li><span><a href=\"#Shops\" data-toc-modified-id=\"Shops-1.4\">Shops<\/a><\/span><\/li><li><span><a href=\"#Test\" data-toc-modified-id=\"Test-1.5\">Test<\/a><\/span><\/li><\/ul><\/li><li><span><a href=\"#Preprocessing\" data-toc-modified-id=\"Preprocessing-2\"><center style=\"background-color: #99bbff ; width: 60%\">Preprocessing<\/center><\/a><\/span><\/li><li><span><a href=\"#Train-models\" data-toc-modified-id=\"Train-models-3\"><center style=\"background-color: #99bbff ; width: 60%\">Train models<\/center><\/a><\/span><ul class=\"toc-item\"><li><span><a href=\"#XGBoost\" data-toc-modified-id=\"XGBoost-3.1\">XGBoost<\/a><\/span><\/li><li><span><a href=\"#LightGBM\" data-toc-modified-id=\"LightGBM-3.2\">LightGBM<\/a><\/span><\/li>\n    <li><span><a href=\"#LSTM\" data-toc-modified-id=\"LSTM-3.3\">LSTM<\/a><\/span><\/li>\n    <\/ul><\/li><li><span><a href=\"#Submit\" data-toc-modified-id=\"Submit-4\"><center style=\"background-color: #99bbff ; width: 60%\">Submit<\/center><\/a><\/span><\/li><\/ul><\/div>"}}