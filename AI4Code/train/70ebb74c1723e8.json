{"cell_type":{"eb7c5dce":"code","e88cdc74":"code","5b91ed8d":"code","a42e4c4e":"code","a9fe8b98":"code","ebdb6083":"code","7ac1bfae":"code","1de16e58":"code","bc2c265f":"code","e932dbaf":"code","cc4897b5":"code","61a853d5":"code","accaa14f":"code","1c95fed4":"code","06076516":"code","e07893bb":"code","0c564d76":"code","83a63cef":"code","d4861d59":"code","5feb6ee7":"code","185c17d6":"code","80fc0545":"code","798c7800":"code","630179a2":"code","ab3d8991":"code","e5df6e65":"markdown","6976a4f6":"markdown","d84565fe":"markdown","6c00c1c7":"markdown","33461e9e":"markdown","fc83f441":"markdown","4a89bbb0":"markdown","1b3e5283":"markdown","bb357b28":"markdown","a7375c55":"markdown","b650a571":"markdown","0900f18c":"markdown","efcfaabd":"markdown"},"source":{"eb7c5dce":"import numpy as np\nimport pandas as pd\nimport matplotlib.pyplot as plt\nimport seaborn as sns\nfrom pylab import rcParams\nfrom keras.models import Sequential\nfrom keras.layers import Dense, LSTM, Activation, Dropout, Bidirectional, GRU\nfrom keras.optimizers import SGD, Adadelta, RMSprop, Adam, Nadam\nfrom keras.regularizers import l1_l2\nfrom keras.callbacks import EarlyStopping\nfrom tqdm import tqdm\n\nrcParams['figure.figsize'] = 12, 7\npd.options.display.max_columns = 50\nimport os\nfor dirname, _, filenames in os.walk('\/kaggle\/input'):\n    for filename in filenames:\n        print(os.path.join(dirname, filename))","e88cdc74":"covid_open_line = pd.read_csv('\/kaggle\/input\/novel-corona-virus-2019-dataset\/COVID19_open_line_list.csv')\n#Drop empty columns\ndrop_list = [i for i in covid_open_line.columns if 'Unnamed' in i] \ncovid_open_line = covid_open_line.drop(columns = drop_list)","5b91ed8d":"covid_open_line.head()","a42e4c4e":"covid_open_line.info()","a9fe8b98":"covid_line = pd.read_csv('\/kaggle\/input\/novel-corona-virus-2019-dataset\/COVID19_line_list_data.csv')\n#Drop empty columns\ndrop_list = [i for i in covid_line.columns if 'Unnamed' in i] \ncovid_line = covid_line.drop(columns = drop_list)","ebdb6083":"len(covid_line.symptom.unique())","7ac1bfae":"covid_line.head()","1de16e58":"covid_line.info()","bc2c265f":"covid = pd.read_csv('\/kaggle\/input\/novel-corona-virus-2019-dataset\/covid_19_data.csv')","e932dbaf":"covid.head()","cc4897b5":"covid.info()","61a853d5":"df = covid.groupby('ObservationDate').agg({'Confirmed':'sum', 'Deaths':'sum', 'Recovered':'sum'}).reset_index()\n\nx=df.ObservationDate.values\ny=[df.Confirmed.values, df.Deaths.values, df.Recovered.values]\n \n# Plot\npal = sns.color_palette(\"Set1\")\n\nplt.stackplot(x,y, labels=['Confirmed','Deaths','Recovered'], colors=pal, alpha=0.7)\nplt.legend(loc='upper left')\nplt.show()\n","accaa14f":"df_china = covid[covid['Country\/Region'] == 'Mainland China'].groupby('ObservationDate').agg({'Confirmed':'sum', 'Deaths':'sum', 'Recovered':'sum'}).reset_index()\n\nx=df_china.ObservationDate.values\ny=[df_china.Confirmed.values, df_china.Deaths.values, df_china.Recovered.values]\n \n# Plot\npal = sns.color_palette(\"Set1\")\n\nplt.stackplot(x,y, labels=['Confirmed','Deaths','Recovered'], colors=pal, alpha=0.7)\nplt.legend(loc='upper left')\nplt.show()\n","1c95fed4":"df['recovered_ratio'] = df['Recovered'] \/ df['Confirmed']\ndf['death_ratio'] = df['Deaths'] \/ df['Confirmed']\n\nsns.lineplot(x=\"ObservationDate\", y=\"recovered_ratio\", data=df)\nsns.lineplot(x=\"ObservationDate\", y=\"death_ratio\", data=df)","06076516":"df_china['recovered_ratio'] = df_china['Recovered'] \/ df_china['Confirmed']\ndf_china['death_ratio'] = df_china['Deaths'] \/ df_china['Confirmed']\n\nsns.lineplot(x=\"ObservationDate\", y=\"recovered_ratio\", data=df_china)\nsns.lineplot(x=\"ObservationDate\", y=\"death_ratio\", data=df_china)","e07893bb":"covid['ObservationDate'] = pd.to_datetime(covid['ObservationDate'])\ncovid_start = covid.groupby(['Country\/Region', 'Province\/State'])['ObservationDate'].min().reset_index()\ncovid_start.columns = ['Country\/Region', 'Province\/State', 'FirstObservation']\ncovid = covid.merge(covid_start, on = ['Country\/Region', 'Province\/State'])","0c564d76":"covid['TimeSinceFirst'] = (covid['ObservationDate'] - covid['FirstObservation']).dt.days\ncovid['RecoveredRatio'] = covid['Recovered'] \/ covid['Confirmed']\ncovid['DeathsRatio'] = covid['Deaths'] \/ covid['Confirmed']","83a63cef":"covid[['Confirmed', 'TimeSinceFirst', 'RecoveredRatio', 'DeathsRatio']].corr()","d4861d59":"(covid.loc[covid['ObservationDate'] == '2020-03-14', 'TimeSinceFirst']).hist()","5feb6ee7":"covid['WeeksSinceFirst'] = round(covid['TimeSinceFirst'] \/ 7)\ncovid_week = covid.groupby(['Country\/Region', 'Province\/State', 'WeeksSinceFirst'])['Confirmed'].max().reset_index(name='LastValueWeek')\n# covid_mean = covid_week.groupby(['WeeksSinceFirst']).agg({'max': [np.mean, np.std]}).reset_index()\n# covid_mean.columns = ['WeeksSinceFirst', 'mean', 'std']\nsns.lineplot(x=\"WeeksSinceFirst\", y=\"LastValueWeek\", data=covid_week)","185c17d6":"def clean_age(x):\n    try:\n        x = int(x)\n    except ValueError:\n        x = np.nan\n    \n    return x","80fc0545":"covid_open_line.age.apply(clean_age).hist()","798c7800":"combinations = covid[['Province\/State', 'Country\/Region']].drop_duplicates().reset_index(drop=True)\nlen(combinations)","630179a2":"TARGETS = ['Confirmed', 'Deaths', 'Recovered']\ncols = ['D-1', 'D-2', 'D-3', 'D-4', 'D-5', 'D-6', 'D-7']\ncols_final = ['ObservationDate', 'Province\/State', 'Country\/Region'] + TARGETS\ndf_final = pd.DataFrame(columns=cols_final)\n\nfor j in tqdm(range(len(combinations))):\n\n    PROVINCE = combinations['Province\/State'][j]\n    COUNTRY = combinations['Country\/Region'][j]\n\n    df_city = pd.DataFrame(columns=['ObservationDate', 'Province\/State', 'Country\/Region'])\n\n    dates = []\n    for i in range(1,32):\n        if i < 10:\n            date = '2020\/03\/0'+str(i)\n        else:\n            date = '2020\/03\/'+str(i)\n        dates.append(date)\n\n    df_city['ObservationDate'] = dates\n    df_city['Province\/State'] = PROVINCE\n    df_city['Country\/Region'] = COUNTRY\n    \n    covid_slice = covid[(covid['Province\/State'] == PROVINCE) & (covid['Country\/Region'] == COUNTRY)]\n    \n    covid_slice = covid_slice.sort_values('ObservationDate').reset_index(drop=True)\n        \n    if (len(covid_slice) < 15) & (len(covid_slice[covid_slice['ObservationDate'] >= '2020-03-01']) < 7):\n        continue\n\n    for TARGET in TARGETS:\n\n        for i in range(1, len(covid_slice)):\n            covid_slice.loc[i, 'D-1'] = covid_slice.loc[i-1, TARGET]\n        for i in range(2, len(covid_slice)):\n            covid_slice.loc[i, 'D-2'] = covid_slice.loc[i-2, TARGET]\n        for i in range(3, len(covid_slice)):\n            covid_slice.loc[i, 'D-3'] = covid_slice.loc[i-3, TARGET]\n        for i in range(4, len(covid_slice)):\n            covid_slice.loc[i, 'D-4'] = covid_slice.loc[i-4, TARGET]\n        for i in range(5, len(covid_slice)):\n            covid_slice.loc[i, 'D-5'] = covid_slice.loc[i-5, TARGET]\n        for i in range(6, len(covid_slice)):\n            covid_slice.loc[i, 'D-6'] = covid_slice.loc[i-6, TARGET]\n        for i in range(7, len(covid_slice)):\n            covid_slice.loc[i, 'D-7'] = covid_slice.loc[i-7, TARGET]\n\n        covid_slice = covid_slice.fillna(0)\n\n        train = covid_slice[covid_slice['ObservationDate'] < '2020-03-01']\n        test = covid_slice[covid_slice['ObservationDate'] >= '2020-03-01']\n\n        X_train = train[cols].values.reshape(len(train), 7, 1)\n        y_train = train[TARGET].values\n\n        X_test = test[cols].values.reshape(len(test), 7, 1)\n        y_test = test[TARGET].values\n\n        reg = l1_l2(l1=0.0015, l2=0.0)\n\n        opt = Adam(lr=0.0015) \n\n        model = Sequential()\n        model.add(Bidirectional(LSTM(140, activation='relu', return_sequences=True, kernel_regularizer=reg, recurrent_regularizer=reg), \n                                input_shape=(X_train.shape[1], X_train.shape[2])))\n        model.add(Bidirectional(LSTM(140, activation='relu', return_sequences=True, kernel_regularizer=reg, recurrent_regularizer=reg)))\n        model.add(Bidirectional(LSTM(140, activation='relu', kernel_regularizer=reg, recurrent_regularizer=reg)))\n        model.add(Dense(28))\n        model.add(Dense(1))\n        model.add(Activation('linear'))\n        model.compile(loss='mean_absolute_error', optimizer=opt)\n\n        history = model.fit(X_train, y_train, epochs=600, batch_size=256, validation_data=(X_test, y_test),\n                            verbose=0, shuffle=False,callbacks=[EarlyStopping(patience=10)])\n\n        df_target = pd.DataFrame(columns=['ObservationDate', 'Province\/State', 'Country\/Region', TARGET])\n\n        for i in range(1,32):\n            if i < 10:\n                date = '2020-03-0'+str(i)\n            else:\n                date = '2020-03-'+str(i)\n\n            if i <= len(X_test):\n                df_slice = covid_slice[covid_slice['ObservationDate'] < date].tail(7).reset_index(drop=True)\n\n            else:\n                df_slice = df_target[df_target['ObservationDate'] < date].tail(7).reset_index(drop=True)\n\n            to_predict = [df_slice[TARGET][6], df_slice[TARGET][5], df_slice[TARGET][4], df_slice[TARGET][3], \n                         df_slice[TARGET][2], df_slice[TARGET][1], df_slice[TARGET][0]]\n\n            to_predict = np.array(to_predict).reshape(1,7,1)\n\n            y_hat = model.predict(to_predict)\n\n            df_target = df_target.append({'ObservationDate': date,'Province\/State': PROVINCE,\n                                        'Country\/Region': COUNTRY, TARGET: round(y_hat[0][0])}, ignore_index=True)\n\n        df_city = df_city.merge(df_target, on = ['ObservationDate', 'Province\/State', 'Country\/Region'])\n    \n    df_city = df_city[cols_final]\n    df_final = df_final[cols_final]\n        \n    df_final = pd.concat([df_final, df_city])","ab3d8991":"df_final.head()","e5df6e65":"### Task Details:\n\nThe outbreak of Covid-19 is developing into a major international crisis, and it's starting to influence important aspects of daily life. For example:\n\n* Travel: Bans have been placed on hotspot countries, corporate travel has been reduced, and flight fares have dropped.\n* Supply chains: International manufacturing operations have often had to throttle back production and many goods solely produced in China have been halted altogether.\n* Grocery stores: In highly affected areas, people are starting to stock up on essential goods.","6976a4f6":"### Let's take a look into the data avaliable","d84565fe":"### Another important factor is age. The disease is worse in the elderly","6c00c1c7":"### We can see that in China there is almost no new cases and the recovered cases are almost the same as the confirmed. ","33461e9e":"### Let's see how the pandemic is growing in the world","fc83f441":"### Let's see how the recovery and death ratio are globally and in China","4a89bbb0":"### We can see that China has a recovery ratio of 80% and increasing, meaning that they already have the spreading under control. Globally the recovery ratio was increasing but new countrys getting infected can be the reason behind this new decline in recovery. Deaths ratio are stable around 3%.\n### Let's see if time since first case and recovery are correlated","1b3e5283":"### We can see that time since first case and recovery are correlated, and that many regions are less that a week away from first case. So spreading time is a important factor. Let's see if we have a pattern","bb357b28":"### As we can see there are little cases between ages 0 and 20, as more from 40 to 60. Unfortunally we only have 14k cases in the open line dataset, so we cant use age for now.","a7375c55":"### We can see that cases evolution are not equal in different places, mostly because of population size, govement measures, etc. that we can't measure with the data.","b650a571":"# Models\n\n### We have data until march, so we are going to leave this last month out for validation","0900f18c":"### RNN 1 week","efcfaabd":"### We can see the confirmed cases are still increasing. We can also see a increase in recovered cases as people from the beggining are healing and a increase in deaths as more people get infected. Let's see how is China (the starting point)."}}