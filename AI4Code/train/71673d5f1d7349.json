{"cell_type":{"bc78d9ca":"code","01f1482c":"code","293b187a":"code","027186e8":"code","85aa3573":"code","659f8a4b":"code","c46a661e":"code","a64dca4e":"code","f4be4104":"code","45a06dcd":"code","5876aa23":"code","2fa0d2bc":"code","122a1a31":"code","756024f8":"code","63ede73f":"code","8c1249c4":"code","7dd2be1d":"code","419b4aa0":"code","6902ad2c":"code","52e51855":"code","c2314df9":"code","c4e125f6":"code","1fe96a9d":"code","459cf5c5":"code","8a5fdfa8":"code","79f89dc0":"code","cf4c1b1b":"code","521bbac6":"code","1adc500f":"code","c3813307":"code","f13b6f10":"code","58ea9954":"code","530af658":"code","16867874":"code","bc3f2cab":"code","bb59bdb0":"code","812cbbb1":"code","12ea6504":"code","08060fbb":"code","2d49e3a6":"code","90182c4d":"code","e96f6e94":"code","9c0b03c0":"code","19afe294":"code","c9cfe841":"code","f272aea9":"code","e0abb25b":"code","9758c271":"code","e6ce5821":"code","d42f629f":"code","2aa63360":"code","7b1f4730":"code","90a47408":"code","a6eb7aa6":"markdown","66c919a4":"markdown","cb37b590":"markdown","b343d20d":"markdown","bb3b8717":"markdown","8891689e":"markdown","4926cafd":"markdown","ea476fcc":"markdown","d1f15787":"markdown","193b17d2":"markdown","462bc720":"markdown","a5de8a9f":"markdown","471f57ed":"markdown","3b6c5823":"markdown","7ac61f58":"markdown","c6857d71":"markdown","adda04f5":"markdown","528a3b26":"markdown","7460856b":"markdown","15b4e4b8":"markdown","a4bba17a":"markdown","8ee62c72":"markdown","69248d5e":"markdown","899ab893":"markdown","3301a9d9":"markdown","9d19f8eb":"markdown","20e0c547":"markdown"},"source":{"bc78d9ca":"# load some default Python modules\nimport numpy as np\nimport pandas as pd\n\nimport matplotlib.pyplot as plt\nimport seaborn as sns\n% matplotlib inline\n\nplt.style.use('seaborn-whitegrid')\n\nimport warnings\nwarnings.filterwarnings('ignore')","01f1482c":"train = pd.read_csv(\"..\/input\/train.csv\", nrows = 5_000_000)\nprint(\"shape of train data\", train.shape)\ntrain.head()","293b187a":"# datatypes\ntrain.dtypes","027186e8":"# Basic Stats of the data set\ntrain.describe()","85aa3573":"print(\"old size: %d\" % len(train))\ntrain = train[train.fare_amount >=0]\nprint(\"New size: %d\" % len(train))","659f8a4b":"# check missing data\ntrain.isnull().sum()","c46a661e":"print(\"old size: %d\" % len(train))\ntrain = train.dropna(how='any', axis=0)\nprint(\"New size after dropping missing value: %d\" % len(train))","a64dca4e":"# Lets see the distribution of fare amount \ntrain.fare_amount.hist(bins=100, figsize = (16,8))\nplt.xlabel(\"Fare Amount\")\nplt.ylabel(\"Frequency\")","f4be4104":"# Lets see the distribution of fare amount less than 100\ntrain[train.fare_amount <100 ].fare_amount.hist(bins=100, figsize = (16,8))\nplt.xlabel(\"Fare Amount\")\nplt.ylabel(\"Frequency\")","45a06dcd":"train[train.fare_amount >100 ].shape","5876aa23":"# Lets see the distribution of fare amount more than 100\ntrain[train.fare_amount >100 ].fare_amount.hist(bins=100, figsize = (16,8))\nplt.xlabel(\"Fare Amount\")\nplt.ylabel(\"Frequency\")","2fa0d2bc":"# checking for passanger count greater than 7\ntrain[train.passenger_count >7].passenger_count.hist(bins=10, figsize = (16,8))\nplt.xlabel(\"Passanger Count\")\nplt.ylabel(\"Frequency\")","122a1a31":"# data for passanger count greater than 7\ntrain[train.passenger_count >7]","756024f8":"# checking for passanger count less than 7\ntrain[train.passenger_count <7].passenger_count.hist(bins=10, figsize = (16,8))\nplt.xlabel(\"Passanger Count\")\nplt.ylabel(\"Frequency\")","63ede73f":"# checking for records where passanger count is 0\ntrain[train.passenger_count ==0].shape","8c1249c4":"plt.figure(figsize= (16,8))\nsns.boxplot(x = train[train.passenger_count< 7].passenger_count, y = train.fare_amount)","7dd2be1d":"train[train.passenger_count <7][['fare_amount','passenger_count']].corr()","419b4aa0":"test = pd.read_csv(\"..\/input\/test.csv\")\nprint(\"shape of test data\", test.shape)\ntest.head()","6902ad2c":"#check for missing value\ntest.isnull().sum()","52e51855":"# checking for basic stats\ntest.describe()","c2314df9":"min(test.pickup_longitude.min(),test.dropoff_longitude.min()), \\\nmax(test.pickup_longitude.max(),test.dropoff_longitude.max())","c4e125f6":"min(test.pickup_latitude.min(),test.dropoff_latitude.min()), \\\nmax(test.pickup_latitude.max(),test.dropoff_latitude.max())","1fe96a9d":"# this function will also be used with the test set below\ndef select_within_test_boundary(df, BB):\n    return (df.pickup_longitude >= BB[0]) & (df.pickup_longitude <= BB[1]) & \\\n           (df.pickup_latitude >= BB[2]) & (df.pickup_latitude <= BB[3]) & \\\n           (df.dropoff_longitude >= BB[0]) & (df.dropoff_longitude <= BB[1]) & \\\n           (df.dropoff_latitude >= BB[2]) & (df.dropoff_latitude <= BB[3])","459cf5c5":"BB = (-74.5, -72.8, 40.5, 41.8)\nprint('Old size: %d' % len(train))\ntrain = train[select_within_test_boundary(train, BB)]\nprint('New size: %d' % len(train))","8a5fdfa8":"def prepare_time_features(df):\n    df['pickup_datetime'] = df['pickup_datetime'].str.slice(0, 16)\n    df['pickup_datetime'] = pd.to_datetime(df['pickup_datetime'], utc=True, format='%Y-%m-%d %H:%M')\n    df['hour_of_day'] = df.pickup_datetime.dt.hour\n#     df['week'] = df.pickup_datetime.dt.week\n    df['month'] = df.pickup_datetime.dt.month\n    df[\"year\"] = df.pickup_datetime.dt.year\n#     df['day_of_year'] = df.pickup_datetime.dt.dayofyear\n#     df['week_of_year'] = df.pickup_datetime.dt.weekofyear\n    df[\"weekday\"] = df.pickup_datetime.dt.weekday\n#     df[\"quarter\"] = df.pickup_datetime.dt.quarter\n#     df[\"day_of_month\"] = df.pickup_datetime.dt.day\n    \n    return df","79f89dc0":"train = prepare_time_features(train)\ntest = prepare_time_features(test)","cf4c1b1b":"# calculate-distance-between-two-latitude-longitude-points-haversine-formula \n# Returns distance in miles\ndef distance(lat1, lon1, lat2, lon2):\n    p = 0.017453292519943295 # Pi\/180\n    a = 0.5 - np.cos((lat2 - lat1) * p)\/2 + np.cos(lat1 * p) * np.cos(lat2 * p) * (1 - np.cos((lon2 - lon1) * p)) \/ 2\n    return 0.6213712 * 12742 * np.arcsin(np.sqrt(a))   # 2*R*asin...","521bbac6":"train['distance_miles'] = distance(train.pickup_latitude, train.pickup_longitude, \\\n                                      train.dropoff_latitude, train.dropoff_longitude)","1adc500f":"test['distance_miles'] = distance(test.pickup_latitude, test.pickup_longitude, \\\n                                      test.dropoff_latitude, test.dropoff_longitude)","c3813307":"def transform(data):\n    # Distances to nearby airports, \n    jfk = (-73.7781, 40.6413)\n    ewr = (-74.1745, 40.6895)\n    lgr = (-73.8740, 40.7769)\n\n    data['pickup_distance_to_jfk'] = distance(jfk[1], jfk[0],\n                                         data['pickup_latitude'], data['pickup_longitude'])\n    data['dropoff_distance_to_jfk'] = distance(jfk[1], jfk[0],\n                                           data['dropoff_latitude'], data['dropoff_longitude'])\n    data['pickup_distance_to_ewr'] = distance(ewr[1], ewr[0], \n                                          data['pickup_latitude'], data['pickup_longitude'])\n    data['dropoff_distance_to_ewr'] = distance(ewr[1], ewr[0],\n                                           data['dropoff_latitude'], data['dropoff_longitude'])\n    data['pickup_distance_to_lgr'] = distance(lgr[1], lgr[0],\n                                          data['pickup_latitude'], data['pickup_longitude'])\n    data['dropoff_distance_to_lgr'] = distance(lgr[1], lgr[0],\n                                           data['dropoff_latitude'], data['dropoff_longitude'])\n    \n    return data\n\ntrain = transform(train)\ntest = transform(test)","f13b6f10":"train[(train['distance_miles']==0)&(train['fare_amount']==0)]","58ea9954":"print(\"old size: %d\" % len(train))\ntrain = train.drop(index= train[(train['distance_miles']==0)&(train['fare_amount']==0)].index, axis=0)\nprint(\"New size: %d\" % len(train))","530af658":"train[train['fare_amount']==0].shape","16867874":"print(\"old size: %d\" % len(train))\ntrain = train.drop(index= train[train['fare_amount']==0].index, axis=0)\nprint(\"New size: %d\" % len(train))","bc3f2cab":"train[train['fare_amount'] < 2.5].shape","bb59bdb0":"print(\"old size: %d\" % len(train))\ntrain = train.drop(index= train[train['fare_amount'] < 2.5].index, axis=0)\nprint(\"New size: %d\" % len(train))","812cbbb1":"train[train.passenger_count >= 7]","12ea6504":"print(\"old size: %d\" % len(train))\ntrain = train.drop(index= train[train.passenger_count >= 7].index, axis=0)\nprint(\"New size: %d\" % len(train))","08060fbb":"train.describe().T","2d49e3a6":"#train data set\npd.cut(train['distance_miles'],np.linspace(0, 70, num = 8)).value_counts()","90182c4d":"# test data set\npd.cut(test['distance_miles'],np.linspace(0, 70, num = 8)).value_counts()","e96f6e94":"# we will deal with it later \nfare_100 = train[train.fare_amount > 100]\nfare_100.shape","9c0b03c0":"fare_100[fare_100.distance_miles <1].shape","19afe294":"# #dropping cases where fare is above 100 dollars and distance is less than 1 miles\n# print(\"old size: %d\" % len(train))\n# train = train.drop(index= train[(train.distance_miles <1) & (train.fare_amount > 100)].index, axis=0)\n# print(\"New size: %d\" % len(train))","c9cfe841":"train.columns","f272aea9":"# create copy of the data set\ndf_train = train.drop(columns= ['key','pickup_datetime'], axis= 1).copy()\ndf_test = test.drop(columns= ['key','pickup_datetime'], axis= 1).copy()\nprint(df_train.shape)\nprint(df_test.shape)","e0abb25b":"from sklearn.model_selection import train_test_split \nX_train, X_test, y_train, y_test = train_test_split(df_train.drop('fare_amount', axis=1),\n                                                    df_train['fare_amount'], test_size=0.2, random_state = 42)\nprint(X_train.shape)\nprint(X_test.shape)\nprint(y_train.shape)\nprint(y_test.shape)","9758c271":"import xgboost as xgb","e6ce5821":"params = {\n   \n    'max_depth': 7,\n    'gamma' :0,\n    'eta':.03, \n    'subsample': 1,\n    'colsample_bytree': 0.9, \n    'objective':'reg:linear',\n    'eval_metric':'rmse',\n    'silent': 0\n}","d42f629f":"def XGBmodel(X_train,X_test,y_train,y_test,params):\n    matrix_train = xgb.DMatrix(X_train,label=y_train)\n    matrix_test = xgb.DMatrix(X_test,label=y_test)\n    model=xgb.train(params=params,\n                    dtrain=matrix_train,num_boost_round=5000, \n                    early_stopping_rounds=10,evals=[(matrix_test,'test')])\n    return model\n\nmodel = XGBmodel(X_train,X_test,y_train,y_test,params)","2aa63360":"prediction = model.predict(xgb.DMatrix(df_test), ntree_limit = model.best_ntree_limit).tolist()","7b1f4730":"test = pd.read_csv(\"..\/input\/test.csv\")\nholdout = pd.DataFrame({'key': test['key'], 'fare_amount': prediction})\nholdout.to_csv('xgb_4m_utc_with_cleaning.csv', index=False)","90a47408":"import matplotlib.pyplot as plt\nfscores = pd.DataFrame({'X': list(model.get_fscore().keys()), 'Y': list(model.get_fscore().values())})\nfscores.sort_values(by='Y').plot.bar(x='X')","a6eb7aa6":"- Now we have sliced the train data records as per the coordinates of the test data","66c919a4":"**There are 1669 records where fare amount is higher than 100 dollars**\n   - I also see than 527 records are such where distance covered  is even less than 1 miles\n   - While researching through few websites (https:\/\/www.introducingnewyork.com\/taxis,  https:\/\/www.taxi-calculator.com\/taxi-rate-new-york-city\/259) i got to know that if taxi waits for passanger additional $30 dollars per hour will be charged depending on the location of the pickup.\n   - Since we don't have such variable where we can get to know the waiting time, we can drop such cases where distance is very less in copare to fare amount charged for the ride","cb37b590":"- we can see here that there are total 1977 trips which are above 100 dollars\n- some of them might be outliers or few of them might be long distance trip from\/to airport, we will see it in later sectionn","b343d20d":"#### Calculating pickup and drop distance from all 3 airports of Air Ports","bb3b8717":"### Manual Feature Engineering\n- Adding distance metrics\n- few time based variables","8891689e":"#### Lets also check passanger count distribution","4926cafd":"- Delete these 15 record where distance covered and fare amount are zero, which won't help our model","ea476fcc":"**following thing that i can notice**\n- Fare amount is negative and it doesn't seem to be realistic\n- few longitude and lattitude entries are off\n- maximum passanger count is 208 which looks odd\n","d1f15787":"**There is very weak correlation (0.013) between fare amount and passanger count**","193b17d2":"There are no missing value in test data set","462bc720":"### Importing Data and Libraries","a5de8a9f":"- Looks like the distribution is highly skewed and frequency above 100 is very less\n- we will plot below 100 and above 100 separately ","471f57ed":"- There are few points between 40 and 60 dollars which has slightly high frequency and that could be airport trips","3b6c5823":"- There is only 11  entry for  passanger count above 7 , rest are below 7\n- we will drop this record in data cleaning section","7ac61f58":"- There are stil 6 records left where passanger count is greater than 7\n- we will delete such cases because we don't  have passanger count greater than 7 in test record","c6857d71":"**There are 36 records where longitud and latitude are missing, we will drop them from the data**","adda04f5":"### Train Test Split","528a3b26":"- There are 24 records where fare amount is zero but distance travelled is greater than 0, we will drop such case","7460856b":"### Lets check the distribution of distance in miles covered for train and test data set","15b4e4b8":"- There are 53 record where fare amount is less than 2.5 dollars (most of them are 0.01 dollars except 3 cases of fare between 1 and 2 dollar ) which doesn't make sense as the base fare for any taxi in new york is 2.5 dollars, we will drop those cases","a4bba17a":"### Lets read the test data","8ee62c72":"**We have 17K such cases where passanger count is zero, there can be two possibility**\n   - Passanger count is incorrectly populated\n   - Taxi was not carrying any passanger, may be taxi was used for goods\n\n**we will look into test data set and finalize whether we should drop these cases or not.**","69248d5e":"## Stay Tuned,  Hyperparameter tuning coming soon","899ab893":"- As we can see from the box plot median price of each passanger counts looks similar except one record, There are few outliers we wil treat in cleaning section\n- we will try to see if there is any relationship between passanger count and fare amount using correlation factor","3301a9d9":"We will store the minimum and maximum of the longitude and latitude from test data set and filter the train data set for those data points","9d19f8eb":"## XG Boost Model","20e0c547":"- Most of the trips are taken by single passanger\n- we will try to see if there is any relation between passanger count and fare amout"}}