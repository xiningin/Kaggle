{"cell_type":{"72888ad8":"code","5ee3df67":"code","f65d76ad":"code","95469a6c":"code","f7444e79":"code","c01e1dea":"code","0971f139":"code","784f4b20":"code","800cccb2":"code","36b1b11d":"code","3f57e28f":"code","03716bd1":"code","daff9ce6":"code","ee513cf2":"code","cf195540":"code","59e1f3c5":"code","22d0b4a6":"code","d6feeb8a":"code","4c794be3":"code","cad585a6":"code","6d65de5b":"code","ee0c872a":"code","b9e7c9df":"code","4f39a017":"code","942a6a34":"code","f6795285":"code","060dcbce":"code","196f280a":"code","467c1fdc":"code","7923dd89":"code","b0d9de4c":"code","1d68894e":"code","413ec485":"code","9f2d946a":"code","0afe2099":"code","f8ccee3a":"code","2a089baf":"markdown","8cdcebcd":"markdown","f01fd1d6":"markdown","3cd71c57":"markdown","657329d0":"markdown","94242c09":"markdown","5e3e5e75":"markdown","57a3ca67":"markdown","d30fc421":"markdown","e0394123":"markdown","fa6c455d":"markdown","51ac995f":"markdown","2c79784b":"markdown","5a4494f3":"markdown","d42fd5e5":"markdown","d4face7c":"markdown","38171c09":"markdown","f8d1b97f":"markdown","1cdcd29c":"markdown","05f1e117":"markdown","da6ed6ff":"markdown","efefab25":"markdown"},"source":{"72888ad8":"%%capture\n!pip install umap-learn[plot]\n!pip install yfinance","5ee3df67":"import yfinance as yf\nimport glob\nimport umap\nimport umap.plot\nimport pandas as pd\nimport numpy as np\nimport seaborn as sns\nimport matplotlib as mpl\nimport matplotlib.pyplot as plt\n\nfrom joblib import Parallel, delayed\nfrom sklearn.manifold import TSNE\nfrom sklearn.preprocessing import minmax_scale\nfrom sklearn.decomposition import PCA\n\n%config InlineBackend.figure_format = 'retina'","f65d76ad":"SPY = yf.Ticker(\"SPY\")\nSPY.info","95469a6c":"import datetime\n\n# get historical market data\nSPY_histo = SPY.history(start=\"2017-01-01\", end=\"2021-07-31\")\n\nSPY_histo.index\n\nplt.figure(figsize=(10,10))\nplt.plot(SPY_histo.index, SPY_histo['Close'])\nplt.xlabel(\"date\")\nplt.ylabel(\"$ price\")\nplt.title(\"Stock Price\")","f7444e79":"tickers = pd.read_html('https:\/\/en.wikipedia.org\/wiki\/S%26P_100')[2].Symbol","c01e1dea":"df_prices_all = yf.download(tickers.to_list(), start='2020-01-01', interval='1h')","0971f139":"df_prices_all.head()","784f4b20":"o = df_prices_all.Open\nh = df_prices_all.High\nl = df_prices_all.Low\nc = df_prices_all.Close\n\n#GARMAN-KLASS rv estimator from OLHC data\nvol = 1\/2 * np.square(np.log(h\/l)) - (2*np.log(2)-1)*np.square(np.log(c\/o))","800cccb2":"df_prices = df_prices_all['Adj Close']","36b1b11d":"from sklearn.preprocessing import MinMaxScaler\nscaler = MinMaxScaler()\n\ncolnames = df_prices.columns\ndates = df_prices.index\n\ndf_prices = pd.DataFrame(scaler.fit_transform(df_prices),index = dates, columns=colnames)\n\ndf_prices = df_prices.fillna(df_prices.mean())\ndf_prices = df_prices.dropna(axis=1, how='any')","3f57e28f":"df_target = (vol\/vol.mean()).mean(axis=1)","03716bd1":"df_target ","daff9ce6":"plt.plot(df_target)","ee513cf2":"%%time\nemb = PCA(n_components=2).fit_transform(df_prices)","cf195540":"plt.figure(figsize=(10, 8))\nplt.scatter(emb[:, 0], emb[:, 1], s=3, c=df_target, edgecolors='none', cmap='jet', norm=mpl.colors.LogNorm());\ncb = plt.colorbar(label='realized volatility', format=mpl.ticker.ScalarFormatter(),\n                  ticks=mpl.ticker.LogLocator(10))\ncb.ax.yaxis.set_minor_formatter(mpl.ticker.ScalarFormatter())\nplt.title('PCA time_id embeddings');","59e1f3c5":"%%time\nemb = TSNE(n_components=2, perplexity=40, learning_rate=50, verbose=1, init='pca', n_iter=2000,\n           early_exaggeration=12).fit_transform(df_prices)","22d0b4a6":"plt.figure(figsize=(10, 8))\nplt.scatter(emb[:, 0], emb[:, 1], s=3, c=df_target, edgecolors='none', cmap='jet', norm=mpl.colors.LogNorm());\ncb = plt.colorbar(label='realized volatility', format=mpl.ticker.ScalarFormatter(),\n                  ticks=mpl.ticker.LogLocator(10))\ncb.ax.yaxis.set_minor_formatter(mpl.ticker.ScalarFormatter())\nplt.title('TSNE time_id embeddings');","d6feeb8a":"%%time\nemb = umap.UMAP(n_neighbors=60, min_dist=0.1, target_metric='euclidean', init='spectral', \n                low_memory=False, verbose=True, spread=0.5, local_connectivity=1, \n                repulsion_strength=1, negative_sample_rate=5).fit_transform(df_prices)","4c794be3":"plt.figure(figsize=(10, 8))\nplt.scatter(emb[:, 0], emb[:, 1], s=3, c=df_target, edgecolors='none', cmap='jet', norm=mpl.colors.LogNorm());\ncb = plt.colorbar(label='realized volatility', format=mpl.ticker.ScalarFormatter(),\n                  ticks=mpl.ticker.LogLocator(10))\ncb.ax.yaxis.set_minor_formatter(mpl.ticker.ScalarFormatter())\nplt.title('UMAP time_id embeddings');","cad585a6":"plt.figure(figsize=(10, 8))\nplt.scatter(emb[:, 0], emb[:, 1], s=3, c=df_target>df_target.quantile(0.9), edgecolors='none', cmap='jet', norm=mpl.colors.LogNorm());\ncb = plt.colorbar(label='realized volatility', format=mpl.ticker.ScalarFormatter(),\n                  ticks=mpl.ticker.LogLocator(10))\ncb.ax.yaxis.set_minor_formatter(mpl.ticker.ScalarFormatter())\nplt.title('UMAP time_id embeddings');","6d65de5b":"import matplotlib.dates as mdates\n\nplt.figure(figsize=(10, 8))\nplt.scatter(emb[:, 0], emb[:, 1], s=3, c=[mdates.date2num(i) for i in df_prices.index], edgecolors='none', cmap='jet');\n\ncb = plt.colorbar(label='date', format=mdates.AutoDateFormatter(mdates.MonthLocator(interval=6)))\ncb.ax.yaxis.set_minor_formatter(mpl.ticker.ScalarFormatter())\n\nplt.title('UMAP time_id embeddings');","ee0c872a":"GE = yf.Ticker(\"GE\")\nGE.info","b9e7c9df":"date = datetime.datetime.fromtimestamp(1627862400)\nprint(\"d2 =\", date.strftime(\"%B %d, %Y\"))","4f39a017":"# get historical market data\nGE_histo = GE.history(start=\"2017-01-01\", end=\"2021-08-31\")\n\nGE_histo.index\n\nplt.figure(figsize=(10,10))\nplt.plot(GE_histo.index, GE_histo['Close'])\nplt.xlabel(\"date\")\nplt.ylabel(\"$ price\")\nplt.title(\"Stock Price\")","942a6a34":"GE.calendar","f6795285":"GE.actions","060dcbce":"list_crypto = ['BCH-USD',\n'BTC-USD',\n'ETH-USD',\n'LTC-USD',\n'XMR-USD',\n'TRX-USD',\n'XLM-USD',\n'ADA-USD',\n'MIOTA-USD',\n'MKR-USD',\n'DOGE-USD']","196f280a":"BTC = yf.Ticker(\"BTC-USD\")\nBTC.info","467c1fdc":"df_prices_crypto = yf.download(list_crypto, start=\"2021-11-04\", end=\"2021-11-06\", interval='1m')","7923dd89":"df_prices_crypto","b0d9de4c":"plt.figure(figsize=(10,10))\nplt.plot(df_prices_crypto.index, df_prices_crypto['Close']\/df_prices_crypto['Close'].iloc[0])\nplt.xlabel(\"date\")\nplt.ylabel(\"$ price\")\nplt.title(\"Stock Price\")","1d68894e":"plt.figure(figsize=(10,10))\nplt.plot(df_prices_crypto.index, np.log(df_prices_crypto['Close']\/df_prices_crypto['Close'].shift()))\nplt.xlabel(\"date\")\nplt.ylabel(\"$ price\")\nplt.title(\"Stock Price\")","413ec485":"scaler = MinMaxScaler()\n\ndf_prices_crypto = df_prices_crypto['Adj Close']\n\ncolnames = df_prices_crypto.columns\ndates = df_prices_crypto.index\n\ndf_prices_crypto = pd.DataFrame(scaler.fit_transform(df_prices_crypto),index = dates, columns=colnames)\n\ndf_prices_crypto = df_prices_crypto.fillna(df_prices_crypto.mean())\ndf_prices_crypto = df_prices_crypto.dropna(axis=1, how='any')\n\nemb = umap.UMAP(n_neighbors=60, min_dist=0.1, target_metric='euclidean', init='spectral', \n                low_memory=False, verbose=True, spread=0.5, local_connectivity=1, \n                repulsion_strength=1, negative_sample_rate=5).fit_transform(df_prices_crypto)\n\nplt.figure(figsize=(10, 8))\nplt.scatter(emb[:, 0], emb[:, 1], s=3, c=df_prices_crypto.mean(axis=1), edgecolors='none', cmap='jet', norm=mpl.colors.LogNorm());\ncb = plt.colorbar(label='avg standardized price', format=mpl.ticker.ScalarFormatter(),\n                  ticks=mpl.ticker.LogLocator(10))\ncb.ax.yaxis.set_minor_formatter(mpl.ticker.ScalarFormatter())\nplt.title('UMAP time_id embeddings');","9f2d946a":"plt.figure(figsize=(10, 8))\nplt.scatter(emb[:, 0], emb[:, 1], s=3, c=dates, edgecolors='none', cmap='jet', norm=mpl.colors.LogNorm());\ncb = plt.colorbar(label='time', format=mpl.ticker.ScalarFormatter())\ncb.ax.yaxis.set_minor_formatter(mpl.ticker.ScalarFormatter())\nplt.title('UMAP time_id embeddings');","0afe2099":"scaler = MinMaxScaler()\n\ndf_ret_crypto = np.log(df_prices_crypto\/df_prices_crypto.shift())\ndf_ret_crypto = df_ret_crypto[~np.isinf(df_ret_crypto).any(axis=1)]\ndf_ret_crypto = df_ret_crypto.fillna(df_ret_crypto.mean(skipna=True))\n\ncolnames = df_ret_crypto.columns\ndates = df_ret_crypto.index\n\ndf_ret_crypto = pd.DataFrame(scaler.fit_transform(df_ret_crypto),index = dates, columns=colnames)\n\nemb = umap.UMAP(n_neighbors=60, min_dist=0.1, target_metric='euclidean', init='spectral', \n                low_memory=False, verbose=True, spread=0.5, local_connectivity=1, \n                repulsion_strength=1, negative_sample_rate=5).fit_transform(df_ret_crypto)\n\nplt.figure(figsize=(10, 8))\nplt.scatter(emb[:, 0], emb[:, 1], s=3, c=df_ret_crypto.mean(axis=1), edgecolors='none', cmap='jet', norm=mpl.colors.LogNorm());\ncb = plt.colorbar(label='avg standardized returns', format=mpl.ticker.ScalarFormatter(),\n                  ticks=mpl.ticker.LogLocator(10))\ncb.ax.yaxis.set_minor_formatter(mpl.ticker.ScalarFormatter())\nplt.title('UMAP time_id embeddings');","f8ccee3a":"plt.figure(figsize=(10, 8))\nplt.scatter(emb[:, 0], emb[:, 1], s=3, c=dates, edgecolors='none', cmap='jet', norm=mpl.colors.LogNorm());\ncb = plt.colorbar(label='time', format=mpl.ticker.ScalarFormatter())\ncb.ax.yaxis.set_minor_formatter(mpl.ticker.ScalarFormatter())\nplt.title('UMAP time_id embeddings');","2a089baf":"# standardised prices","8cdcebcd":"# crypto exploration with UMAP","f01fd1d6":"We can see there is : \n    \n'lastSplitDate': 1627862400,\n'lastSplitFactor': '1:8',","3cd71c57":"# G-research CryptoCurrencies","657329d0":"# Optiver - Stock 31 \nStock 31 has been problematic from the beggining of the optiver competition. From deanonimizing stock price it appeared to be GE.","94242c09":"# Aggregate price\n\nLoading data in bulks.","5e3e5e75":"# get crypto infos","57a3ca67":"# Stock Values - Exemple","d30fc421":"# Packages installation and import","e0394123":"GE splitted between training and testing set. Which is a supplementary problem. ","fa6c455d":"# get prices in bulk","51ac995f":"# Plotting times","2c79784b":"# UMAP","5a4494f3":"It appears that crypto are now on yahoo finance. What a time to be alive.\n\nMissing for now :\n\nBinance Coin\nEOS.IO\nEthereum Classic\n","d42fd5e5":"# Stock info ","d4face7c":"We see the last split that wrecked the LB. \nNext step: other stocks ?","38171c09":"# Loading external data with yfinance, exploration with PCA \/ T-SNE \/ UMAP\n\nIn this notebook I Load and explore external data. \n\nIt was initially built for the Optiver Volatility Forecasting Competition, following the discussion in [The Leak](https:\/\/www.kaggle.com\/c\/optiver-realized-volatility-prediction\/discussion\/256725) discussion and reusing most of the embedding (PCA \/ T-sne \/ UMAP) code from : https:\/\/www.kaggle.com\/stassl\/exploring-time-id-relationships. The goal was to download and visualize embeddings based on historical daily prices of the top 100 sp500 stocks. My contribution were: Installation and usage of yfinance, Collecting and ploting data from a list of tickers, building a GARMAN-KLASS volatility estimator from OLHC data. Discussion with @stassl brought numerous updates: loading tickers from wikipedia, downloading data in bulk, downloading data at 1h intervalls. The idea was to discuss a possible use of time embeddings. I didn't figure how to use them myself but it was at the core of some of the current top results.\n\nRegarding the G-research competition, I just figured that most cryptocurrencies are on yahoo-finance nowadays. So I show how to use yfinance to download relevant crypto data. Those data might be usefull to:\n - extend the training data\n - use additional data for designing CV\n - use additional data for neutralisation\n\nFeel free to upvote the discussion and the notebooks if you find the content interesting.","f8d1b97f":"# market volatility","1cdcd29c":"# PCA","05f1e117":"# log returns","da6ed6ff":"# High volatility days","efefab25":"# TSNE"}}