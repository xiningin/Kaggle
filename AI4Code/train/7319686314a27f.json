{"cell_type":{"396bf5a3":"code","d63d6f90":"code","099100fe":"code","79c8ecce":"code","ead269ab":"code","a9c54004":"code","cca84003":"code","b374f2ab":"code","ea76fa65":"code","6bbfe19e":"code","9d688796":"code","93e7a5e2":"code","7988688b":"code","18c6f9a7":"code","a8199fd8":"code","8fb2e19a":"code","28311070":"code","392d1f79":"code","66453525":"code","65f5d4d9":"code","845b6a15":"code","152598e6":"code","2dfcba07":"code","c30372a9":"code","8991e7d4":"code","152e0afc":"code","fd873ec1":"code","76584c8e":"code","7365d5e9":"code","1c4396f1":"code","3dff9cc6":"code","0c6f8891":"code","355a3e04":"code","72449855":"code","54360d68":"code","d3d04fdc":"code","b3e19133":"code","52a8fa36":"code","9dcebf26":"code","345a5c55":"code","7647eee1":"code","be84ab68":"code","982a9fd0":"code","615fe33f":"code","f42cdce9":"code","97b2d80c":"code","b0d02f50":"code","d0be6c0b":"code","79c736ef":"code","108a2531":"code","6e0856ec":"code","b8199e97":"code","49ca2c2c":"code","2fe4ed76":"code","15b3ee12":"code","862eeff2":"code","7663d1e2":"code","111af10d":"code","47d3b2fd":"code","cc87c449":"code","380413ed":"code","28e15efa":"code","2f726765":"code","acf150b4":"code","2291e160":"code","92d662d2":"code","d0db63a9":"code","f6a29323":"code","0d507d88":"code","0a2f1549":"code","891aa8f1":"code","ddfc7b89":"code","485c89d4":"code","18c975c2":"code","0f166199":"code","caeb990e":"code","e7172099":"code","3e3906d0":"code","a33bdba8":"code","d88199f5":"code","2e7ad8f0":"code","5fff6ebc":"code","402e60a5":"code","96617cca":"markdown","a2097380":"markdown","da74e2c0":"markdown","eef5c54a":"markdown","ab08eab3":"markdown","4281c0e0":"markdown","635775ad":"markdown","7514ead6":"markdown"},"source":{"396bf5a3":"import pandas as pd\nimport numpy as np\nimport sklearn\nimport matplotlib.pyplot as plt\nfrom sklearn.metrics import f1_score,precision_score,recall_score,confusion_matrix\nfrom sklearn.model_selection import train_test_split\n%matplotlib inline","d63d6f90":"df1=pd.read_csv('..\/input\/creditcard.csv')\ndf1.head()","099100fe":"df=df1.drop(columns=['Time','Amount'])\ndf.head()","79c8ecce":"df.describe()","ead269ab":"df_normal=df[df['Class']==0]\ndf_normal.shape","a9c54004":"df_anomaly=df[df['Class']==1]\ndf_anomaly.shape","cca84003":"df_anomaly1,df_anomaly2=train_test_split(df_anomaly,test_size=0.5)\ndf_anomaly1.shape","b374f2ab":"df_train,df_v=train_test_split(df_normal,test_size=0.005)\ndf_v.shape","ea76fa65":"df_v1,df_t1=train_test_split(df_v,test_size=0.5)\ndf_v1.shape","6bbfe19e":"df_val=df_v1.append(df_anomaly1).sample(frac=1)\ndf_val.head()","9d688796":"df_test=df_t1.append(df_anomaly2).sample(frac=1)\ndf_test.head()","93e7a5e2":"print(df_train.shape)\nprint(df_val.shape)\nprint(df_test.shape)","7988688b":"X_train=df_train.iloc[:,:-1].values\nX_val=df_val.iloc[:,:-1].values\ny_val=df_val.iloc[:,-1].values\nX_test=df_test.iloc[:,:-1].values\ny_test=df_test.iloc[:,-1].values","18c6f9a7":"from sklearn.preprocessing import MinMaxScaler","a8199fd8":"sc=MinMaxScaler()","8fb2e19a":"sc.fit(X_train)","28311070":"X_train=sc.transform(X_train)\nX_val=sc.transform(X_val)\nX_test=sc.transform(X_test)","392d1f79":"print(X_train.shape)\nprint(X_val.shape)\nprint(X_test.shape)","66453525":"inputshape=X_train[0].shape\nnum_train_sample=len(X_train)\nnum_val_sample=len(X_val)\nbatchsize=64","65f5d4d9":"from keras.layers import Dense,Dropout,Input\nfrom keras.models import Sequential,Model\nfrom keras.optimizers import Adam\nfrom keras.losses import categorical_crossentropy","845b6a15":"input1=Input(shape=inputshape)\nx1=Dense(16,activation='relu')(input1)\nx2=Dense(8,activation='relu')(x1)\nencoded=Dense(4,activation='relu')(x2)","152598e6":"d1=Dense(8,activation='relu')(encoded)\nd2=Dense(16,activation='relu')(d1)\ndecoded=Dense(28,activation='sigmoid')(d2)","2dfcba07":"autoencoder=Model(inputs=input1,outputs=decoded)","c30372a9":"autoencoder.compile(optimizer='adam',loss='mean_squared_error',metrics=['accuracy'])","8991e7d4":"history = autoencoder.fit(X_train, X_train,\n                    epochs=10,\n                    batch_size=batchsize,\n                    shuffle=True,\n                    validation_data=(X_val, X_val),\n                    verbose=1)","152e0afc":"X_val_pred=autoencoder.predict(X_val)","fd873ec1":"mse = np.mean(np.power(X_val - X_val_pred, 2), axis=1)\nerror_df = pd.DataFrame({'reconstruction_error': mse*1000,'true_class': y_val})\nerror_df.describe()","76584c8e":"threshholds=np.linspace(0,100,300)\nf1score=[]\nfor t in threshholds:\n    y_hat=error_df.reconstruction_error>t\n    f1score.append(f1_score(y_val,y_hat))","7365d5e9":"f1score","1c4396f1":"scores = np.array(f1score)","3dff9cc6":"scores.max()","0c6f8891":"scores.argmax()","355a3e04":"threshholds[scores.argmax()]","72449855":"final_thresh=threshholds[scores.argmax()]","54360d68":"X_test_pred=autoencoder.predict(X_test)\nmse = np.mean(np.power(X_test - X_test_pred, 2), axis=1)\ntest_error_df = pd.DataFrame({'reconstruction_error': mse*1000,'true_class': y_test})\ntest_error_df['y_hat']=test_error_df.reconstruction_error>final_thresh\ntest_error_df.head()","d3d04fdc":"f1_score(y_test,test_error_df.y_hat)","b3e19133":"precision_score(y_test,test_error_df.y_hat)","52a8fa36":"recall_score(y_test,test_error_df.y_hat)","9dcebf26":"confusion_matrix(y_test,test_error_df.y_hat)","345a5c55":"from sklearn.mixture import GaussianMixture","7647eee1":"gmm = GaussianMixture(n_components=3, n_init=4, random_state=42)\ngmm.fit(X_train)\nprint(gmm.score(X_val))\n","be84ab68":"y_scores=gmm.score_samples(X_val)","982a9fd0":"df_erroe_val = pd.DataFrame({'log_prob': y_scores,'true_class': y_val})","615fe33f":"df_erroe_val.describe()","f42cdce9":"threshhold2=np.linspace(-400,96,500)\nf1score_2=[]\nfor t in threshhold2:\n    y_hat=df_erroe_val.log_prob<t\n    f1score_2.append(f1_score(y_val,y_hat))","97b2d80c":"f1score_2=np.array(f1score_2)","b0d02f50":"f1score_2.max()","d0be6c0b":"f1score_2.argmax()","79c736ef":"final_thresh2=threshhold2[f1score_2.argmax()]\nfinal_thresh2","108a2531":"y_scores_test=gmm.score_samples(X_test)","6e0856ec":"y_pred2=y_scores_test<final_thresh2","b8199e97":"print(f1_score(y_test,y_pred2))\nprint(precision_score(y_test,y_pred2))\nprint(recall_score(y_test,y_pred2))","49ca2c2c":"confusion_matrix(y_test,y_pred2)","2fe4ed76":"df.head()","15b3ee12":"X1=df.iloc[:,:-1].values\ny1=df.iloc[:,-1].values","862eeff2":"#X_train3,X_test3,y_train3,y_test3=train_test_split(X1,y1,test_size=0.02)","7663d1e2":"from sklearn.preprocessing import MinMaxScaler\nsc2=MinMaxScaler()\nsc2.fit(X1)","111af10d":"X_train3=sc2.transform(X1)\n","47d3b2fd":"X_train3.shape","cc87c449":"inputshape=X_train3[0].shape\nnum_train_sample=len(X_train3)\nbatchsize=64","380413ed":"from keras.layers import Dense,Dropout,Input\nfrom keras.models import Sequential,Model\nfrom keras.optimizers import Adam\nfrom keras.losses import categorical_crossentropy","28e15efa":"input1=Input(shape=inputshape)\nx1=Dense(16,activation='relu')(input1)\nx2=Dense(8,activation='relu')(x1)\nencoded=Dense(2,activation='relu')(x2)","2f726765":"d1=Dense(8,activation='relu')(encoded)\nd2=Dense(16,activation='relu')(d1)\ndecoded=Dense(28,activation='sigmoid')(d2)","acf150b4":"autoencoder=Model(inputs=input1,outputs=decoded)","2291e160":"autoencoder.compile(optimizer='adam',loss='mean_squared_error',metrics=['accuracy'])","92d662d2":"history = autoencoder.fit(X_train3, X_train3,\n                    epochs=3,\n                    batch_size=batchsize,\n                    shuffle=True,\n                    verbose=1)","d0db63a9":"y1.sum()","f6a29323":"X_train_pred3=autoencoder.predict(X_train3)","0d507d88":"mse3 = np.mean(np.power(X_train3 - X_train_pred3, 2), axis=1)\nerror_df3 = pd.DataFrame({'reconstruction_error': mse3*1000,'true_class': y1})\nerror_df3.describe()","0a2f1549":"y_pred3=error_df3.reconstruction_error>4.13","891aa8f1":"confusion_matrix(y1,y_pred3)","ddfc7b89":"precision_score(y1,y_pred3)","485c89d4":"recall_score(y1,y_pred3)","18c975c2":"f1_score(y1,y_pred3)","0f166199":"from sklearn.mixture import GaussianMixture","caeb990e":"gmm = GaussianMixture(n_components=3, n_init=4, random_state=42)\ngmm.fit(X_train3)\nprint(gmm.score(X_train3))","e7172099":"y_scores=gmm.score_samples(X_train3)","3e3906d0":"df_erroe_val = pd.DataFrame({'log_prob': y_scores,'true_class': y1})\ndf_erroe_val.describe()","a33bdba8":"y_pred3=df_erroe_val.log_prob<52.84","d88199f5":"confusion_matrix(y1,y_pred3)","2e7ad8f0":"precision_score(y1,y_pred3)","5fff6ebc":"recall_score(y1,y_pred3)","402e60a5":"f1_score(y1,y_pred3)","96617cca":"## GaussianMixture\n","a2097380":"## unsupervise anomaly detection","da74e2c0":"## Autoencoder","eef5c54a":"#### Autoencoder","ab08eab3":"#### GaussianMixture","4281c0e0":"### scaling","635775ad":"### prediction on test data","7514ead6":"### prediction on test dataset"}}