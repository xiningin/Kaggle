{"cell_type":{"3e94cabf":"code","dd77a4d3":"code","9043faac":"code","a64f4ea4":"code","f0e75ba1":"code","86f60c43":"code","175bf2ca":"code","a5a5c324":"code","e79d471b":"code","5be2a2ed":"code","7be512e4":"code","d084ecb4":"code","844f5e94":"code","bd47fbcb":"code","9ffe39b1":"code","84675e36":"code","a4e52322":"code","4f73ae02":"code","d21d67d7":"code","6c8745fe":"code","5896157c":"code","76da8162":"code","bf7f5b8e":"code","8701b978":"code","1bdd5e7f":"code","5d020c80":"code","d4b38078":"code","6202db69":"code","a57ccb00":"code","4d645f46":"code","d455bce6":"code","7843a8f6":"code","2a7a97fe":"code","6f32ccd6":"code","2a9e6fda":"code","c097e2db":"code","1dc976a3":"code","2d0ff2e2":"code","b25c34bf":"code","7a0ef6ba":"code","652b8323":"code","40662c14":"code","1ee1e052":"code","f6deb162":"code","bc0848cd":"code","d9ca44d7":"code","22821a7d":"markdown","18598c00":"markdown","fd5fff56":"markdown","9551cff2":"markdown","9b03b2c8":"markdown","3c169fec":"markdown","02f72a46":"markdown","19566033":"markdown","ae4dce58":"markdown","11b05b82":"markdown","228928be":"markdown","b24fb668":"markdown","fa7c6081":"markdown","69d401dc":"markdown","2965250f":"markdown","6c360aed":"markdown","04ef45e4":"markdown","cbc15ce1":"markdown","89c2f216":"markdown","a5f480bb":"markdown","d903b1e3":"markdown","a853b7b8":"markdown","73e18418":"markdown","2f519c4f":"markdown","61d0e81c":"markdown","86679b3c":"markdown","9959759c":"markdown","665bb3ea":"markdown","d519b782":"markdown","33cc3f99":"markdown","1a21b095":"markdown","cb0006b8":"markdown","8125a158":"markdown","236f35e0":"markdown"},"source":{"3e94cabf":"import pandas as pd","dd77a4d3":"# Reading the data:\ndata = pd.read_csv(\"..\/input\/retailtransactiondata\/Retail_Data_Transactions.csv\")","9043faac":"data.head()","a64f4ea4":"# Defining Recency as two of the three columns in data:\nrecency = data[['trans_date', 'customer_id']]","f0e75ba1":"recency.apply(pd.Series.nunique)","86f60c43":"recency.shape","175bf2ca":"import time\n\nrecency['trans_date'] = pd.to_datetime(recency.trans_date)","a5a5c324":"# now refers to the latest date available in the data, to which we will peg our rececny dimensions on:\nnow = max(recency['trans_date'])","e79d471b":"recency = recency.groupby(['customer_id']).max()","5be2a2ed":"recency_days = now - recency['trans_date']","7be512e4":"recency_days = pd.DataFrame(recency_days)\nrecency_days.head()","d084ecb4":"monetary = data[['customer_id', 'tran_amount']]","844f5e94":"monetary = monetary.groupby(['customer_id']).sum()","bd47fbcb":"monetary.head()","9ffe39b1":"frequency = data[['customer_id', 'trans_date']]","84675e36":"frequency = frequency.groupby(['customer_id']).count()","a4e52322":"frequency.head()","4f73ae02":"recency = pd.DataFrame(recency_days['trans_date'].astype('timedelta64[D]'))\nrecency.columns = ['recency']","d21d67d7":"recency.head()\n","6c8745fe":"rfm = pd.concat([recency, frequency, monetary], axis=1)","5896157c":"# Defining the columns:\nrfm.columns=['recency', 'frequency', 'monetary']\n\nrfm.head()","76da8162":"# Plotting for the last day since the customer made a purchase:\n\nimport seaborn as sns\nimport matplotlib.pyplot as plt\n\nplt.figure(figsize=(8,8))\nsns.set_context(\"poster\")\nsns.set_palette(['skyblue'])\nsns.distplot(rfm['recency'])\nplt.xlabel('Days since last purchase')","bf7f5b8e":"# Plotting the number of times the customer has made a purchase:\n\nplt.figure(figsize=(8,8))\nsns.set_context(\"poster\")\nsns.set_palette(['pink'])\nsns.distplot(rfm['frequency'])\n","8701b978":"# Plotting the total revenue that the particular customer brought in to the shop:\n\nplt.figure(figsize=(8,8))\nsns.set_context(\"poster\")\nsns.set_palette(['orange'])\nsns.distplot(rfm['monetary'])\nplt.xlabel('Dollars')","1bdd5e7f":"# Making a copy so that I don't lose my temper over messing up a previously perfect dataframe.\nRFM = rfm.copy()\n\n# Importing KMeans and finding clusters:\nfrom sklearn.cluster import KMeans\n\nkm = KMeans(n_clusters = 4, init = 'k-means++')\n\nnclusters = km.fit_predict(RFM)\n\nclusters = pd.DataFrame(nclusters, columns = ['clusters'], index = RFM.index)\n\n# Concatenating the clusters with the RFM dataframe:\nrfmK= pd.concat([RFM, clusters], axis=1)","5d020c80":"plt.figure(figsize=(8,8))\nsns.scatterplot(data = rfmK, x='frequency', y='monetary', hue='clusters')","d4b38078":"RFMKMEANS = rfmK.copy()\n\nRFMKMEANS['clusters'] = ['SuperFans' if x == 3 else x for x in RFMKMEANS['clusters']]\nRFMKMEANS['clusters'] = ['UsualCustomers' if x == 2 else x for x in RFMKMEANS['clusters']]\nRFMKMEANS['clusters'] = ['FrequentCustomers' if x == 0 else x for x in RFMKMEANS['clusters']]\nRFMKMEANS['clusters'] = ['Thrifters' if x == 1 else x for x in RFMKMEANS['clusters']]","6202db69":"plt.figure(figsize=(15,7))\nsns.set_context(\"poster\", font_scale=0.7)\nsns.set_palette('twilight')\nsns.countplot(RFMKMEANS['clusters'])","a57ccb00":"superfans_df = rfmK.loc[rfmK['clusters'] == 2]\nsuperfans_df.head()","4d645f46":"# Dropping the clusters column because there's just a single value in the whole column:\nsuperfans_df.drop(['clusters'], axis= 1, inplace=True)","d455bce6":"# Lets take a look at the quantile:\nsuperfans_df.quantile([.25, .5, .75, 1], axis=0)","7843a8f6":"# Copying the RFM dataset so that it isn't affected by the changes:\nRFMscores = superfans_df.copy()","2a7a97fe":"# Converting Recency:\n\nRFMscores['recency'] = [4 if x <= 14 else x for x in RFMscores['recency']]\nRFMscores['recency'] = [3 if 14 < x <= 37 else x for x in RFMscores['recency']]\nRFMscores['recency'] = [2 if 37 < x <= 70 else x for x in RFMscores['recency']]\nRFMscores['recency'] = [1 if x > 70 else x for x in RFMscores['recency']]","6f32ccd6":"# Converting Frequency:\n\nRFMscores['frequency'] = [1 if a <= 24 else a for a in RFMscores['frequency']]\nRFMscores['frequency'] = [2 if a == 25 else a for a in RFMscores['frequency']]\nRFMscores['frequency'] = [3 if 27 > a > 25 else a for a in RFMscores['frequency']]\nRFMscores['frequency'] = [4 if a >= 27 else a for a in RFMscores['frequency']]","2a9e6fda":"# Converting Monetary:\n\nRFMscores['monetary'] = [1 if x < 1721 else x for x in RFMscores['monetary']]\nRFMscores['monetary'] = [2 if 1721 <= x < 1808 else x for x in RFMscores['monetary']]\nRFMscores['monetary'] = [3 if 1808 <= x < 1954 else x for x in RFMscores['monetary']]\nRFMscores['monetary'] = [4 if 1954 <= x else x for x in RFMscores['monetary']]","c097e2db":"RFMscores.apply(pd.Series.nunique)","1dc976a3":"RFMscores.head()","2d0ff2e2":"score = pd.DataFrame((RFMscores['recency'] + RFMscores['frequency'] + RFMscores['monetary'])\/3, columns=['AggrScore'])\n","b25c34bf":"# Concatenating the two:\nRFMscores = pd.concat([RFMscores, score], axis = 1)","7a0ef6ba":"RFMscores.head()","652b8323":"# Using Quantiles we find the limit for our top 25% customers:\nRFMscores.quantile([.75], axis=0)","40662c14":"topcustomers = RFMscores['AggrScore'].iloc[[x >= 3 for x in RFMscores['AggrScore']]]","1ee1e052":"MVCs = pd.DataFrame(topcustomers, columns = ['AggrScore'])","f6deb162":"MostValuableCustomers = list(MVCs.index)","bc0848cd":"MostValuableCustomers","d9ca44d7":"rfmK.loc[MVCs.index]","22821a7d":"Since we have a basic idea of what the distribution of the three indicators, lets use quantiles to educate ourselves further with quantiles:","18598c00":"Time to work with dates:","fd5fff56":"Frequency refers to the number of times a customer has made purchases:","9551cff2":"Lets take a look at the clusters:\n","9b03b2c8":"These are the rows of customers who are the most valuable.","3c169fec":"Lets check if we got it right by taking a look at the number of unique values in each column:","02f72a46":"Since, we have the cluster its time to seperate the cluster from the dataframe:","19566033":"The aggregate RFM Score is basically the average of the RFM values in the RFM Scores dataset:","ae4dce58":"# Most Valuable Customers (MVCs):","11b05b82":"Below is the conversion of columns into RFM scores between 1 to 4. These will come handy in calculating the aggregate RFM Score. As per the quantile I have assigned the indices in the columns a value between 1 to 4. \n\n> '4' being great and '1' being poor.\n\n\nApart from that what must be noted is that different columns see this score differently. Such as, the higher the monetary value the higher chance of that value being 4 since more revenue is never a bad thing. While, smaller the value of Recency the more likely it is that the index will be given the value of 1, since the more recent customer is more likely to comeback. In case of Frequency the metrics are the same as Monetary since, higher the Frequency the more beneficial it is for business.","228928be":"# Playing with the Data:","b24fb668":"And thus, we have the names of the customers who love the shop! If you liked the notebook, an upvote would be much appreciated. :-)","fa7c6081":"# KMeans ALgorithm:","69d401dc":"Via Groupby, I use count to count the number of times the customer has made purchases:","2965250f":"# RFM SCORE CARD:","6c360aed":"Importing pandas for working with the data:","04ef45e4":"Okay so, recency refers to the time since the last purchase. So lets find out the number of days:","cbc15ce1":"The groupby function in pandas allows of for grouping of many index column values or as we saw above there were more than one instances of a single customer purchasing so why not combine all their purchases?","89c2f216":"Monetary refers to the total money spent by a customer overtime:","a5f480bb":"Checking the data for the number of unique values:","d903b1e3":"# Aggregate RFM Score:","a853b7b8":"Finally concatenating the dataframes:","73e18418":"Lets take a look at the dimensions of our data:","2f519c4f":"Since it is clear that the cluster with the number 2 as its index has the highest frequency and monetary value, lets use it. The clusters with the index as 1 are the thrifty customers who don't visit the shop that much and don't pay much too. 0 and 3 are in between the extremes.\n","61d0e81c":"Via Groupby here, I sum up all the transactions of every respective customer:","86679b3c":"Since we have the absolute integer values of all the three key elements lets concatenate them:","9959759c":"I think we should take a look at the distribution because plotting can give a really good idea of what is up with the customers:","665bb3ea":"Well, since there are more examples than the number of unique customer ids this means that a lot of customers bought from us more than once,","d519b782":"Taking a look at this beauty:","33cc3f99":"# RFM Analysis:","1a21b095":"I have had this idea in my head for a while now to combine the KMeans algorithm along with RFM Analysis. The steps to identify the superfans of any business being the following:\n\n1) Preprocessing the data to find the three key elements needed:\n        - Recency\n        - Frequency\n        - Monetary Value\n        \n2) Using the KMeans Algorithm to find the cluster of customers with high average monetary value and are highly frequent.\n\n3) The cluster taken out now would be put through RFM Analysis and processed.\n\n4) Customers with the highest Aggregate RFM Scores would be considered the Actual Superfans.","cb0006b8":"The top customers would be the ones who are in the top 25% of the top RFM Scores:","8125a158":"# Importing and Reading Data:","236f35e0":"In this notebook, I will be going through the implementation of RFM or Recency, Frequency and Monetary. This was popularised in the 1960s and 1970s. It might be old but the Wharton's course on Customer Analytics at Coursera teaches this pretty well, so if you feel like checking it out here's the [link](https:\/\/www.google.com\/url?sa=t&rct=j&q=&esrc=s&source=video&cd=&cad=rja&uact=8&ved=2ahUKEwjj4ZeB3bvrAhU16nMBHRuRCJ8QtwIwAXoECAEQAQ&url=https%3A%2F%2Fwww.coursera.org%2Flecture%2Fwharton-customer-analytics%2Fbeyond-period-2-7fduC&usg=AOvVaw3-I-Zc9QAF2OrUWPaAAZGW)."}}