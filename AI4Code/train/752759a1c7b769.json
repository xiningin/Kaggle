{"cell_type":{"95965958":"code","8ec638c5":"code","7c18d75a":"code","5e6bc0a4":"code","a58399a6":"code","df14ce23":"code","b916e4b4":"code","888eea25":"code","99675569":"code","b3fc2ef1":"code","46851ca3":"markdown","e51c8d3a":"markdown","4ce5cc13":"markdown","a813d8ae":"markdown","92c17da3":"markdown","d72685b3":"markdown","21bb3f72":"markdown","2164a4f2":"markdown","6258ccd5":"markdown"},"source":{"95965958":"from kaggle.competitions import twosigmanews\nenv = twosigmanews.make_env()\n\n(market_train_df, news_train_df) = env.get_training_data()","8ec638c5":"market_train_df.returnsOpenPrevRaw1.min()","7c18d75a":"market_train_df[\n    market_train_df.returnsOpenPrevRaw1 == market_train_df.returnsOpenPrevRaw1.min()\n].T","5e6bc0a4":"features = ['time', 'open', 'returnsOpenPrevRaw10', 'returnsOpenPrevMktres10']","a58399a6":"market_train_df[\n    (market_train_df.assetCode == 'PBRa.N') & \n    (market_train_df.time >= '2007-05-01') &\n    (market_train_df.time <= '2007-06-20')\n][features]","df14ce23":"market_train_df['raw_median'] = market_train_df.groupby('time').returnsOpenPrevRaw10.transform('median')","b916e4b4":"market_train_df['xy'] = market_train_df.returnsOpenPrevRaw10 * market_train_df.raw_median\n\nroll = market_train_df.groupby('assetCode').rolling(window=20)\n\nmarket_train_df['cov_xy'] = (\n    (roll.xy.mean() - roll.returnsOpenPrevRaw10.mean() * roll.raw_median.mean()) * 20 \/ 19\n).reset_index(0,drop=True)","888eea25":"market_train_df['var_y'] = roll.raw_median.var().reset_index(0,drop=True)","99675569":"market_train_df['beta'] = (market_train_df['cov_xy'] \/ market_train_df['var_y'])\nmarket_train_df['beta'] = market_train_df.groupby('assetCode')['beta'].shift(1)","b3fc2ef1":"market_train_df[\n    (market_train_df.assetCode == 'PBRa.N') & \n    (market_train_df.time >= '2007-05-01') &\n    (market_train_df.time <= '2007-06-20')\n][features+['beta']]","46851ca3":"Then we calculate the variance of the market:","e51c8d3a":"** Let's find the smallest returnsOpenPrevRaw1**","4ce5cc13":"And calculate beta with shift(1)","a813d8ae":"First, we may approximate market rerurn as median of all returns","92c17da3":" <pre>Cov(x,y) = SUM [(xi - x_mean) * (yi - y_mean)] \/ (n - 1) = \n = (SUM(xi * yi) - SUM(xi * y_mean) - SUM(yi * x_mean) + SUM (x_mean * y_mean)) \/ (n-1) =\n = (MEAN(xi * yi) - x_mean * y_mean - y_mean * x_mean + x_mean * y_mean) * n \/ (n-1) =\n = (MEAN(X * Y) - MEAN(X) * MEAN(Y)) * n \/ (n-1)\n <\/pre>","d72685b3":"As we see, **in 20 days period from 2007-05-18 to 2007-06-15** market residual return is much volative than raw return.\n\nSo, beta may depends on std, variance or covariance. One of the common formula is:\n\n<pre>Beta = Cov (Ra, Rm) \/ Var(Rm)<\/pre>\n\nLet's calculate it for 20 days","21bb3f72":"Let's check results","2164a4f2":"This kernel show some dependencies for beta risk factor and 20-days covariance of returnsOpenPrevRaw10","6258ccd5":"As we see, we have large beta values in the periods where we have large market residual returns. Surely, these formula can not be totally right since we had approximations but it looks reasonable."}}