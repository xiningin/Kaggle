{"cell_type":{"4b6fb4b1":"code","6d294ae6":"markdown"},"source":{"4b6fb4b1":"def link_evidence(oof):\n  if not len(oof):\n    return oof\n  \n  def jn(pst, start, end):\n    return \" \".join([str(x) for x in pst[start:end]])\n  \n  thresh = 1\n  idu = oof['id'].unique()\n  eoof = oof[oof['class'] == \"Evidence\"]\n  neoof = oof[oof['class'] != \"Evidence\"]\n  eoof.index = eoof[['id', 'class']]\n  for thresh2 in range(26, 27, 1):\n    retval = []\n    for idv in tqdm(idu, desc='link_evidence', leave=False):\n      for c in ['Evidence']:\n        q = eoof[(eoof['id'] == idv)]\n        if len(q) == 0:\n          continue\n        pst = []\n        for r in q.itertuples():\n          pst = [*pst, -1,  *[int(x) for x in r.predictionstring.split()]]\n        start = 1\n        end = 1\n        for i in range(2, len(pst)):\n          cur = pst[i]\n          end = i\n          if  ((cur == -1) and ((pst[i + 1] > pst[end - 1] + thresh) or (pst[i + 1] - pst[start] > thresh2))):\n            retval.append((idv, c, jn(pst, start, end)))\n            start = i + 1\n        v = (idv, c, jn(pst, start, end + 1))\n        retval.append(v)\n    roof = pd.DataFrame(retval, columns=['id', 'class', 'predictionstring'])\n    roof = roof.merge(neoof, how='outer')\n    return roof\n","6d294ae6":"The link evidence post deal rule is great!\nhttps:\/\/www.kaggle.com\/kaggleqrdl\/tensorflow-longformer-ner-postprocessing\nBut as there are some reduncy, which make it slow, I remove unnecessry code, as below, it is much faster, hope it helps:)"}}