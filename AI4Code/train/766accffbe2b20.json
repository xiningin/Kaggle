{"cell_type":{"33bdc49e":"code","d240a065":"code","80c8bac4":"code","c5ad2698":"code","5cbf1e8f":"code","a101ab5b":"code","74f5f6a9":"code","0dba7ba9":"code","7aab5825":"code","59d37d11":"code","79f2d146":"code","9baf51ef":"code","98d4caaa":"code","0472c991":"code","fdaff61c":"code","2cd14f3f":"code","e3b845ba":"code","6f3e19fe":"code","a52e91ee":"code","085fed66":"code","8c10eb7a":"code","29d7e4ff":"code","0beb814e":"code","d78b6aa5":"code","0f6e531e":"code","9c9aa96c":"code","ed1f33a9":"code","5181c8ca":"code","9a1a18b1":"code","9d46e39e":"markdown","07d57c74":"markdown","f4fee9a1":"markdown","5f150229":"markdown","c2c736c3":"markdown","6abd8925":"markdown"},"source":{"33bdc49e":"!pip install -q fastai2","d240a065":"from fastai2.vision.all import *","80c8bac4":"path = Path(\"\/kaggle\/input\/plant-pathology-2020-fgvc7\")","c5ad2698":"train_df = pd.read_csv(path\/\"train.csv\")\ntrain_df.head()","5cbf1e8f":"train_df.query(\"image_id == 'Train_5'\")","a101ab5b":"get_image_files(path\/\"images\")[5]","74f5f6a9":"train_df.iloc[0, 1:][train_df.iloc[0, 1:] == 1].index[0]","0dba7ba9":"LABEL_COLS = ['healthy', 'multiple_diseases', 'rust', 'scab']","7aab5825":"def get_data(size=224):\n    return DataBlock(blocks    = (ImageBlock, CategoryBlock),\n                       get_x=ColReader(0, pref=path\/\"images\", suff=\".jpg\"),\n                       get_y=lambda o:o.iloc[1:][o.iloc[1:] == 1].index[0],\n                       splitter=RandomSplitter(seed=42),\n                       item_tfms=Resize(size),\n                       batch_tfms=aug_transforms(flip_vert=True),\n                      )","59d37d11":"dblock = get_data()","79f2d146":"dsets = dblock.datasets(train_df)\ndsets.train[0]","9baf51ef":"BS = (1024 - 256)\/\/8","98d4caaa":"dls = dblock.dataloaders(train_df, bs=BS)\ndls.show_batch()","0472c991":"from sklearn.metrics import roc_auc_score\n\ndef roc_auc(preds, targs, labels=range(4)):\n    # One-hot encode targets\n    targs = np.eye(4)[targs]\n    return np.mean([roc_auc_score(targs[:,i], preds[:,i]) for i in labels])\n\ndef healthy_roc_auc(*args):\n    return roc_auc(*args, labels=[0])\n\ndef multiple_diseases_roc_auc(*args):\n    return roc_auc(*args, labels=[1])\n\ndef rust_roc_auc(*args):\n    return roc_auc(*args, labels=[2])\n\ndef scab_roc_auc(*args):\n    return roc_auc(*args, labels=[3])","fdaff61c":"metric = partial(AccumMetric, flatten=False)\n\nlearn = cnn_learner(dls, resnet152, metrics=[\n            error_rate,\n            metric(healthy_roc_auc),\n            metric(multiple_diseases_roc_auc),\n            metric(rust_roc_auc),\n            metric(scab_roc_auc),\n            metric(roc_auc)]\n        ).to_fp16()","2cd14f3f":"# learn.lr_find()","e3b845ba":"# 1\/0","6f3e19fe":"# del learn","a52e91ee":"# import gc\n# gc.collect()","085fed66":"lr = 3e-3","8c10eb7a":"learn.fine_tune(4, lr)","29d7e4ff":"test_df = pd.read_csv(path\/\"test.csv\")\ntest_df.head()","0beb814e":"tst_dl = learn.dls.test_dl(test_df)","d78b6aa5":"preds, y = learn.get_preds(dl=tst_dl)","0f6e531e":"preds","9c9aa96c":"subm = pd.read_csv(path\/\"sample_submission.csv\")","ed1f33a9":"subm.iloc[:, 1:] = preds","5181c8ca":"subm.to_csv(\"submission.csv\", index=False, float_format='%.2f')","9a1a18b1":"pd.read_csv(\"submission.csv\")","9d46e39e":"# Model","07d57c74":"# Datablock","f4fee9a1":"Thanks this guy for metrics\n\nhttps:\/\/www.kaggle.com\/lextoumbourou\/plant-pathology-2020-eda-training-fastai2\n\nFastai2 docs\n\nhttps:\/\/dev.fast.ai\/","5f150229":"I am using the default size and transforms. I don't know if they are the best for this problem.","c2c736c3":"In the train df all rows have only one label, so it looks like a usual classification.","6abd8925":"# Submission"}}