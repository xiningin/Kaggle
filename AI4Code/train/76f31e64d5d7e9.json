{"cell_type":{"72bb35dc":"code","a5ac87da":"code","df6eaf9d":"code","26867cdb":"code","cb6c24eb":"code","2c845824":"code","c02c6bfa":"code","562636d7":"code","fd4dcc97":"code","970938fc":"code","61479835":"code","05d96566":"code","a943759f":"code","ef4be900":"code","f725660a":"code","1a1fa997":"code","3047643e":"code","f60a0281":"code","eee4a7f4":"code","a1574fc1":"code","0a6fd743":"code","e054013b":"code","e0772947":"code","45a5d9ea":"code","d4f522ef":"code","391e1f8b":"code","6f665b65":"code","f5df0263":"code","2193584c":"code","da0f3fc3":"markdown","b0aec431":"markdown","ff7fdcda":"markdown","c2cac019":"markdown","5a7bcd7e":"markdown","5fa1f53a":"markdown","25898931":"markdown","1debc28c":"markdown","5a74b827":"markdown","60809dc9":"markdown","aa62f544":"markdown","99e6eefe":"markdown","ddaccf63":"markdown","6704d4fc":"markdown","7807142d":"markdown","e08dc532":"markdown","c3fcf717":"markdown","2b038d10":"markdown","c62346af":"markdown","f77a03be":"markdown","876ff519":"markdown","7eb9c901":"markdown","fda2e1d1":"markdown","527ba72a":"markdown","76cfee5d":"markdown","ca15e013":"markdown","a067344b":"markdown","cbe53204":"markdown","6e5089d9":"markdown","f55630fd":"markdown"},"source":{"72bb35dc":"import os, cv2, random\nimport numpy as np\nimport pandas as pd\nimport seaborn as sns\nimport matplotlib.pyplot as plt\nfrom sklearn.model_selection import train_test_split\nfrom sklearn.metrics import classification_report\nfrom tqdm import tqdm\nfrom random import shuffle \nfrom IPython.display import SVG\nfrom keras.utils.vis_utils import model_to_dot\nfrom keras.utils import plot_model\nfrom tensorflow.python.keras.applications import ResNet50\nfrom tensorflow.python.keras.models import Sequential\nfrom tensorflow.python.keras.layers import Dense, Flatten, GlobalAveragePooling2D\n%matplotlib inline ","a5ac87da":"TEST_SIZE = 0.5\nRANDOM_STATE = 2018\nBATCH_SIZE = 64\nNO_EPOCHS = 20\nNUM_CLASSES = 2\nSAMPLE_SIZE = 20000\nPATH = '\/kaggle\/input\/dogs-vs-cats-redux-kernels-edition\/'\nTRAIN_FOLDER = '.\/train\/'\nTEST_FOLDER =  '.\/test\/'\nIMG_SIZE = 224\nRESNET_WEIGHTS_PATH = '\/kaggle\/input\/resnet50\/resnet50_weights_tf_dim_ordering_tf_kernels_notop.h5'","df6eaf9d":"train_image_path = os.path.join(PATH, \"train.zip\")\ntest_image_path = os.path.join(PATH, \"test.zip\")","26867cdb":"import zipfile\nwith zipfile.ZipFile(train_image_path,\"r\") as z:\n    z.extractall(\".\")","cb6c24eb":"with zipfile.ZipFile(test_image_path,\"r\") as z:\n    z.extractall(\".\")","2c845824":"train_image_list = os.listdir(\".\/train\/\")[0:SAMPLE_SIZE]\ntest_image_list = os.listdir(\".\/test\/\")","c02c6bfa":"def label_pet_image_one_hot_encoder(img):\n    pet = img.split('.')[-3]\n    if pet == 'cat': return [1,0]\n    elif pet == 'dog': return [0,1]","562636d7":"def process_data(data_image_list, DATA_FOLDER, isTrain=True):\n    data_df = []\n    for img in tqdm(data_image_list):\n        path = os.path.join(DATA_FOLDER,img)\n        if(isTrain):\n            label = label_pet_image_one_hot_encoder(img)\n        else:\n            label = img.split('.')[0]\n        img = cv2.imread(path,cv2.IMREAD_COLOR)\n        img = cv2.resize(img, (IMG_SIZE,IMG_SIZE))\n        data_df.append([np.array(img),np.array(label)])\n    shuffle(data_df)\n    return data_df","fd4dcc97":"def plot_image_list_count(data_image_list):\n    labels = []\n    for img in data_image_list:\n        labels.append(img.split('.')[-3])\n    sns.countplot(labels)\n    plt.title('Cats and Dogs')\n    \nplot_image_list_count(train_image_list)","970938fc":"plot_image_list_count(os.listdir(TRAIN_FOLDER))","61479835":"train = process_data(train_image_list, TRAIN_FOLDER)","05d96566":"def show_images(data, isTest=False):\n    f, ax = plt.subplots(5,5, figsize=(15,15))\n    for i,data in enumerate(data[:25]):\n        img_num = data[1]\n        img_data = data[0]\n        label = np.argmax(img_num)\n        if label  == 1: \n            str_label='Dog'\n        elif label == 0: \n            str_label='Cat'\n        if(isTest):\n            str_label=\"None\"\n        ax[i\/\/5, i%5].imshow(img_data)\n        ax[i\/\/5, i%5].axis('off')\n        ax[i\/\/5, i%5].set_title(\"Label: {}\".format(str_label))\n    plt.show()\n\nshow_images(train)","a943759f":"test = process_data(test_image_list, TEST_FOLDER, False)","ef4be900":"show_images(test,True)","f725660a":"X = np.array([i[0] for i in train]).reshape(-1,IMG_SIZE,IMG_SIZE,3)\ny = np.array([i[1] for i in train])","1a1fa997":"model = Sequential()\nmodel.add(ResNet50(include_top=False, pooling='max', weights=RESNET_WEIGHTS_PATH))\nmodel.add(Dense(NUM_CLASSES, activation='softmax'))\n# ResNet-50 model is already trained, should not be trained\nmodel.layers[0].trainable = True","3047643e":"model.compile(optimizer='sgd', loss='categorical_crossentropy', metrics=['accuracy'])","f60a0281":"model.summary()","eee4a7f4":"plot_model(model, to_file='model.png')\nSVG(model_to_dot(model).create(prog='dot', format='svg'))","a1574fc1":"X_train, X_val, y_train, y_val = train_test_split(X, y, test_size=TEST_SIZE, random_state=RANDOM_STATE)","0a6fd743":"train_model = model.fit(X_train, y_train,\n                  batch_size=BATCH_SIZE,\n                  epochs=NO_EPOCHS,\n                  verbose=1,\n                  validation_data=(X_val, y_val))","e054013b":"def plot_accuracy_and_loss(train_model):\n    hist = train_model.history\n    acc = hist['acc']\n    val_acc = hist['val_acc']\n    loss = hist['loss']\n    val_loss = hist['val_loss']\n    epochs = range(len(acc))\n    f, ax = plt.subplots(1,2, figsize=(14,6))\n    ax[0].plot(epochs, acc, 'g', label='Training accuracy')\n    ax[0].plot(epochs, val_acc, 'r', label='Validation accuracy')\n    ax[0].set_title('Training and validation accuracy')\n    ax[0].legend()\n    ax[1].plot(epochs, loss, 'g', label='Training loss')\n    ax[1].plot(epochs, val_loss, 'r', label='Validation loss')\n    ax[1].set_title('Training and validation loss')\n    ax[1].legend()\n    plt.show()\nplot_accuracy_and_loss(train_model)","e0772947":"score = model.evaluate(X_val, y_val, verbose=0)\nprint('Validation loss:', score[0])\nprint('Validation accuracy:', score[1])","45a5d9ea":"#get the predictions for the test data\npredicted_classes = model.predict_classes(X_val)\n#get the indices to be plotted\ny_true = np.argmax(y_val,axis=1)","d4f522ef":"correct = np.nonzero(predicted_classes==y_true)[0]\nincorrect = np.nonzero(predicted_classes!=y_true)[0]","391e1f8b":"target_names = [\"Class {}:\".format(i) for i in range(NUM_CLASSES)]\nprint(classification_report(y_true, predicted_classes, target_names=target_names))","6f665b65":"f, ax = plt.subplots(5,5, figsize=(15,15))\nfor i,data in enumerate(test[:25]):\n    img_num = data[1]\n    img_data = data[0]\n    orig = img_data\n    data = img_data.reshape(-1,IMG_SIZE,IMG_SIZE,3)\n    model_out = model.predict([data])[0]\n    \n    if np.argmax(model_out) == 1: \n        str_predicted='Dog'\n    else: \n        str_predicted='Cat'\n    ax[i\/\/5, i%5].imshow(orig)\n    ax[i\/\/5, i%5].axis('off')\n    ax[i\/\/5, i%5].set_title(\"Predicted:{}\".format(str_predicted))    \nplt.show()","f5df0263":"pred_list = []\nimg_list = []\nfor img in tqdm(test):\n    img_data = img[0]\n    img_idx = img[1]\n    data = img_data.reshape(-1,IMG_SIZE,IMG_SIZE,3)\n    predicted = model.predict([data])[0]\n    img_list.append(img_idx)\n    pred_list.append(predicted[1])","2193584c":"submission = pd.DataFrame({'id':img_list , 'label':pred_list})\nsubmission.head()\nsubmission.to_csv(\"submission.csv\", index=False)","da0f3fc3":"### Prepare the model\n\nWe initialize the **ResNet-50** model, adding an additional last layer of type **Dense**, with **softmax** activation function.   \n\nWe also set the first layer of the model to be not trainable, becaise **ResNet-50** model was already trained.","b0aec431":"## <a id=\"52\">Train the model<\/a>\n\nWe are now ready to train our model.","ff7fdcda":"# <a id=\"6\">Prepare the submission<\/a>\n\n### Show test images with predicted class\n\nLet's show few of the test images with the predicted class. For this, we will have to predict the class.\n","c2cac019":"## <a id=\"54\">Validation accuracy per class<\/a>\n\nLet's show the validation accuracy per each class.\n\nWe start by predicting the labels for the validation set.","5a7bcd7e":"# <a id=\"4\">Data exploration<\/a>\n\n\n## <a id=\"41\">Class distribution<\/a>\n\nLet's inspect the train data to check the **cat**\/**dog** distribution.   We show first the split in the reduced train data.","5fa1f53a":"### Split the train data in train and validation\n\nWe split the train data in two parts. One will be reserved for train set, the second for validation set. Only the train subset of the data will be used for training the model; the validation set will be used for validation, during training.","25898931":"Let's show also the class distribution in the full train data set.","1debc28c":"# <a id=\"2\">Load packages<\/a>","5a74b827":"# <a id=\"7\">Conclusions<\/a>\n\nUsing a pretrained model for Keras, ResNet-50, with a Dense model with softmax activation added on top and training with a reduced set of  we were able to obtain quite good model in terms of validation accuracy.   \nThe model was used to predict the classes of the images from the independent test set and results were submitted to test the accuracy of the prediction with fresh data.  \n","60809dc9":"## <a id=\"53\">Validation accuracy and loss<\/a>\n\nLet's show the train and validation accuracy on the same plot. As well, we will represent the train and validation loss on the same graph.","aa62f544":"## <a id=\"42\">Images samples<\/a>\n\nLet's represet some of the images. We start with a selection from the train set. We will show the first 25 images from the train set.\n\nFirst,  we process the train data, reading the images and creating a table with images and labels. If the data is trom train set, the label is the one calculated with one hot encoding; if the data is from test set, the label will be the image number.","99e6eefe":"### Submission file\n\nLet's prepare now the submission file.","ddaccf63":"## Parameters\n\nHere we set few parameters used in the model. The image size is **224**.    \nThe images are stored in two folders, **train** and **test**.  \nThere are two image classes: **Dog** and **Cat**.  \nWe will use a subset of the training data set (**20,000** images).  From the training set, **50%** will be used for training, **50%** for validation.  \nA pre-trained model from **ResNet-50** will be used.  \nA number of **10** epochs will be used for training.  \n\n","6704d4fc":"# <a id=\"8\">References<\/a>\n\n[1] Dogs vs. Cats Redux: Kernels Edition, https:\/\/www.kaggle.com\/c\/dogs-vs-cats-redux-kernels-edition  \n[2] ResNet pretrained models for Keras, https:\/\/www.kaggle.com\/keras\/resnet50  \n\n\n\n","7807142d":"# <a id=\"5\">Model<\/a>\n\n## <a id=\"51\">Prepare the model<\/a>\n\nLet's start by preparing the model.\n\n### Prepare the train data","e08dc532":"<h1><center><font size=\"6\">Cats or Dogs - using CNN with Transfer Learning<\/font><\/center><\/h1>\n\n\n<center><img src=\"https:\/\/www.theladders.com\/wp-content\/uploads\/dog-cat-190709-1000x563.jpg\" width=\"900\"><\/img><\/center>\n\n\n# <a id='0'>Content<\/a>\n\n- <a href='#1'>Introduction<\/a>  \n- <a href='#2'>Load packages and set parameters<\/a>  \n- <a href='#3'>Read the data<\/a>  \n- <a href='#4'>Data exploration<\/a>\n    - <a href='#41'>Class distribution<\/a>\n    - <a href='#42'>Images samples<\/a>\n- <a href='#5'>Model<\/a>  \n    - <a href='#51'>Prepare the model<\/a>  \n    - <a href='#52'>Train the model<\/a>  \n    - <a href='#53'>Validation accuracy and loss<\/a>  \n    - <a href='#54'>Validation accuracy per class<\/a>  \n- <a href='#6'>Prepare submission<\/a>     \n- <a href='#7'>Conclusions<\/a>\n- <a href='#8'>References<\/a>\n\n","c3fcf717":"Then, we plot the image selection.","2b038d10":"We set a function for parsing the image names to extract the first 3 letters from the image names, which gives the label of the image. It will be either a cat or a dog. We are using one hot encoder, storing [1,0] for **cat** and [0,1] for **dog**.","c62346af":"We are defining as well a function to process the data (both train and test set). ","f77a03be":"Let's also show the model graphical representation using **plot_model**.","876ff519":"### Model summary\n\nWe plot the model description. We can see that the **ResNet-50** model represent the 1st layer of our model, of type **Model**.","7eb9c901":"### Compile the model\n\nWe compile the model, using a **sigmoid** optimized, the loss function as **categorical crossentropy** and the metric **accuracy**.","fda2e1d1":"We create two indices, **correct** and **incorrect**, for the images in the validation set with class predicted correctly and incorrectly, respectively.","527ba72a":"Let's also show a selection of the train set. We prepare the test set.","76cfee5d":"# <a id=\"1\">Introduction<\/a>  \n\n\n## Dataset\n\nThe **train** folder contains **25,000** images of **dogs** and **cats**. Each image in this folder has the label as part of the filename. The **test** folder contains **12,500** images, named according to a numeric id.  \nFor each image in the test set, you should predict a probability that the image is a dog (**1** = **dog**, **0** = **cat**).\n\n\n## Method\n\nFor the solution of this problem we will use a pre-trained model, ResNet-50, replacing only the last layer.","ca15e013":"Let's also show the numeric validation accuracy and loss.","a067344b":"# <a id=\"3\">Read the data<\/a>\n\nWe set the train image list.   \nSetting the **SAMPLE_SIZE** value we can reduce\/enlarge the size of the training set.    \nCurrently **SAMPLE_SIZE** is set to **20,000**.\n","cbe53204":"\nWe saw what is the number of correctly vs. incorrectly predicted values in the validation set.    \n\nWe show here the classification report for the validation set, with the accuracy per class and overall.","6e5089d9":"### Test data prediction","f55630fd":"Then, we show a selection of the test set."}}