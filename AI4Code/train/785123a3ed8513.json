{"cell_type":{"9768def0":"code","4588c420":"code","af9f0731":"code","9d956caa":"code","8eb9e7cc":"code","f129e23d":"code","ee71beb6":"code","e039f189":"code","bee004cd":"code","64ade1c6":"code","1d01230a":"code","8083f7cd":"code","cbe369ad":"code","db76afa3":"code","605abf8b":"code","2234e29b":"code","4a7c4e91":"code","85087594":"code","bc321e98":"code","bf88c12a":"code","11c00a6d":"code","34504131":"code","68365ee9":"code","28c2268b":"markdown","3dfa4584":"markdown","7c5dcb5d":"markdown","a9e83fc1":"markdown","4757f78c":"markdown","28424c62":"markdown","fc570976":"markdown","69fd8eda":"markdown","4ee27c06":"markdown","123ab015":"markdown","309884d3":"markdown","31e68813":"markdown","5649b734":"markdown","fe78d06c":"markdown","1e2aeeff":"markdown","9acb78b4":"markdown","09c6912c":"markdown","a9d3aa0e":"markdown","c0adff85":"markdown","1b73f77c":"markdown","7ec7dee3":"markdown","8fcb1d83":"markdown","d2c92348":"markdown","df6795d8":"markdown","16b3843e":"markdown","ee0761d9":"markdown"},"source":{"9768def0":"import numpy as np\nimport pandas as pd\nfrom IPython.display import Image\nfrom scipy.stats import norm\nfrom scipy import interpolate\nfrom catboost import CatBoostRegressor\nimport matplotlib.pyplot as plt\nimport plotly.graph_objs as go","4588c420":"def Garman_Kohlhagen (X, K, rd, rf, vol, T): #(underlying asset, strike, domestic annual risk-free rate in %, \n                                             #foreign annual risk-free rate in %, volatility of the asset in %, time to maturity in years)\n    rd \/= 100.0\n    rf \/= 100.0\n    vol \/= 100.0\n    d1 = ( np.log(X\/K) + (rd - rf + 0.5 * vol ** 2) * T ) \/ ( vol * T ** 0.5 ) #d1 value\n    d2 = d1 - vol * T ** 0.5 #d2 value\n    call_price = X * np.exp(-rf * T) * norm.cdf(d1) - K * np.exp(-rd * T) * norm.cdf(d2) #call price value\n    return call_price, d1\n    ","af9f0731":"def delta_option(rf, d1, T): #delta of the european call option\n    rf \/= 100.0\n    delta = np.exp(-rf * T) * norm.cdf(d1)\n    return delta\n    ","9d956caa":"def gamma_option(X, rf, d1, vol, T): #gamma of the european call option\n    rf \/= 100.0\n    vol \/= 100.0\n    gamma = (np.exp(-rf * T) * norm.pdf(d1) ) \/ (X * vol * T ** 0.5)\n    return gamma\n    ","8eb9e7cc":"def theta_option(X, rd, rf, d1, vol, T, K): #theta of the european call option\n    rd \/= 100.0\n    rf \/= 100.0\n    vol \/= 100.0\n    d2 = d1 - vol * T ** 0.5\n    theta = ( X * np.exp(-rf * T) * norm.pdf(d1) * vol ) \/ (2 * T ** 0.5) + ( -rf * X *  np.exp(-rf * T) *norm.cdf(d1) + rd * K **(-rd * T) * norm.cdf(d2) )\n    return -theta\n","f129e23d":"#We are considering FX options on Usd\/Eur\n#It means that Usd, $ -domestic currency, Eur, \u20ac - foreign currency\n#1) Underlying asset, X_t: 1\u20ac = X_t$ - exchage rate\n#2) Strike, K\n#3) Time to maturity, T = 1y\n#4) Domestic risk-free rate: rd%\/year\n#5) Foreign risk-free rate: rf%\/year\n#6) Volatility of the underlying asset: sigma%\n","ee71beb6":"#2.1 Exchange rate:\nX_0 = 1.172 #25.09.2021 - https:\/\/ru.investing.com\/currencies\/eur-usd","e039f189":"#2.2 Strike:\nK1 = round(X_0 \/ 0.9, 5) # 90% ATM Strike means K * 0.9 = X0\nK2 = round(X_0 \/ 1.1, 5) # 110% ATM Strike means K * 1.1 = X0","bee004cd":"#2.3 Time to maturity\nT = 1.0","64ade1c6":"#2.4 Domestic annual risk-free\nrd = 1.747 #YTM,% of the zero-coupon bond T-bill\n\n#https:\/\/cbonds.com\/bonds\/259183\/\n#Time to maturity = 3712 days\n#Nominal = 100%\n#Price = 83.6422%\n# => YTM = -1 + (100\/83.6422) ^ (1 \/ (3712\/365) = 0.01747","1d01230a":"#2.5 Foreign annual risk-free\nrf = -0.058 #YTM,% of the zero-coupon bond European Union\n\n#https:\/\/cbonds.com\/bonds\/1053153\/\n#Time to maturity = 3571 days\n#Nominal = 100%\n#Price = 100.571%\n# => YTM = -1 + (100\/100.571) ^ (1 \/ (3571\/365) ) = -0.0005818","8083f7cd":"#2.6 Volatility\n\n#2.6.1 - Import the data\ndata = pd.read_csv('..\/input\/task3q\/Data.csv') #input data of T in years, K, Vol in %\ntest = pd.read_csv('..\/input\/task3q\/test.csv') #input data of T = 1y, K, Vol in %\ntest1 = pd.read_csv('..\/input\/task3q\/test1.csv') #predict data of T = 1y, K = K1, K2\n\n#Source: https:\/\/ru.investing.com\/currencies\/forex-options\n\n#2.6.2 - Model for the implied volatility\nX = data.drop(labels = ['sigma'], axis = 'columns') #Make X-input data and Y-target data \nY = data['sigma']\nX = X.iloc[0:50] \nY = Y.iloc[0:50]\n\nmodel = CatBoostRegressor(n_estimators = 800) #Fit the model\nmodel.fit(X, Y)\n\nres = model.predict(test1) #make the predict for K1 and K2\n\n#Since K1 > maxK and K2 < minK out of the sample => we can not do interpolation \n#Make non-linear model sigma = sigma(K,T)","cbe369ad":"S1 = res[0] #expected iv for k1 = 1.3\nS2 = res[1] #expected iv for k2 = 1.06\nprint('IV for K1', K1, 'is', round(S1,6), '%')\nprint('IV for K1', K2, 'is', round(S2,6), '%')","db76afa3":"#Plot the approximation for T = 1 \nstrike = data['K'].iloc[42:49]\nvol = data['sigma'].iloc[42:49]\nvol_hat = model.predict(test)\n\nplt.plot(strike, vol)\nplt.plot(strike, vol_hat)\n\nplt.xlabel('strike, K')\nplt.ylabel('Volatility')\nplt.title('T = 1')\nplt.show()","605abf8b":"#Plot the Implied Volatility surface\nx = [np.zeros(10) * i for i in range(7)]\ny = [np.zeros(10) * i for i in range(7)]\nz = [np.zeros(10) * i for i in range(7)]\n \nX = np.array([1\/52, 2\/52, 1\/12, 2\/12, 3\/12, 6\/12, 12\/12]) #Maturity array\nY = np.arange(1.15, 1.21, (1.21 - 1.15) \/ 10.0) #Strike array\nl = len(X) * len(Y)\n\n\ndata1 = data.copy()\ndata1 = data1.drop(labels = ['sigma'], axis = 'columns')\ndata1 = data1.iloc[0:l] #make the sample of csv table\n\n\nfor i in range(7):\n    for j in range(10):\n        #print(i,j)\n        data1['T'][10*i + j] = X[i] #fill the table with new values\n        data1['K'][10*i + j] = Y[j]\n        x[i][j] = X[i]\n        y[i][j] = Y[j]\n        \np = model.predict(data1) #make the predict\n\nfor i in range(7):\n    for j in range(10):\n        z[i][j] = p[10*i + j]\n \nfig = go.Figure(data=[go.Surface(x = x, y = y, z = z)])\n\nfig.update_layout(title='Implied Volatility Surface', scene = dict( xaxis_title='Maturity, T', yaxis_title='Strike, K',\n                    zaxis_title='Volatility, %'), autosize=True, width=600, height=600)\n\nfig.show()\n\n#Surface has a volatility smile\/skew: K - (K < X0 ) decreases, volatility increases\n#T increases -> volatility increases","2234e29b":"res1 = Garman_Kohlhagen(X_0, K1, rd, rf, S1, T)\nres2 = Garman_Kohlhagen (X_0, K2, rd, rf, S2, T)\nc1 = res1[0]\nc2 = res2[0]\nprint('The price of the option with maturity T = 1y, strike K = 1.3024 is', round(c1,6))\nprint('The price of the option with maturity T = 1y, strike K = 1.0656 is', round(c2,6))","4a7c4e91":"Image(filename=\"..\/input\/task3q\/1.JPG\", width= 700, height=800)","85087594":"#Solve system of the linear equations with respect to p1, p2\n\na = delta_option(rf, res1[1], T) #delta of the option 1\nb = delta_option(rf, res2[1], T) #delta of the option 2\nc = gamma_option(X_0, rf, res1[1], S1, T) #gamma of the option 1\nd = gamma_option(X_0, rf, res2[1], S2, T) #gamma of the option 2\n\nA = np.array([[a-1, -b-1],[c,-d]]) #right part of the eq\nB = np.array([-1, 0]) #left part of the eq\nx = np.linalg.solve(A, B) #solve the eq\nx = np.append(x, (1-np.sum(x))) \n\nprint('Portfolio vector is', x) # where xi is the fraction of the asset i","bc321e98":"Image(filename=\"..\/input\/task3q\/2.JPG\", width= 700, height=800)","bf88c12a":"#Obtain the sum of ni\nCapital = 100000.0\nSum = Capital \/ (c1 * x[0] - c2 * x[1] + X_0 * x[2])\n\n#Obtain n1, n2, n3\nn1 = x[0] * Sum #n1 options to buy\nn2 = x[1] * Sum #n2 options to sell\nn3 = x[2] * Sum #n3 EUR to buy\nprint(round(n1,3), round(n2,3), round(n3,3)) #How many assets should I purchase if my capital equals 100 000 $\n\n#Check:\nif (n1 * c1 - n2 * c2 + n3 * X_0) == Capital: print('True', '\\n')\n\n#Capital allocation\nprint('Purchase price of n1 options =', round(n1*c1,4), '$')\nprint('Selling price of n2 options =', round(n2*c2,4), '$')\nprint('Purchase price of n3 EUR =', round(n3*X_0,4), '$')","11c00a6d":"#Theta of the porftolio (without underlying asset n3)\nTh1 = theta_option(X_0, rd, rf, res1[1], S1, T, K1) #Theta value of the option1\nTh2 = theta_option(X_0, rd, rf, res2[1], S2, T, K2) #Theta value of the option2\nprint('Theta option 1 = ', round(Th1,4), '\\t', 'Theta option 2 =', round(Th2,4), '\\n')\n\n#Theta represents the decreasing the time value of the options\n#Th1 * n1 - Th2 * n2 can represent the daily return\n\nprofit_day = Th1 * n1 - Th2 * n2\nprint('Daily P&L of the our portfolio is', '+',round(profit_day,3), '$')","34504131":"profit_year = profit_day * 365.0 #annual revenue\nHPR = (profit_year - Capital) \/ Capital #holding period return\n\nprint('Annual revenue and HPR according to the options positions are', round(profit_year,2), '$ and', round(HPR * 100,2), '%')","68365ee9":"#What about EUR position?\n#Assume:\n#1) interest rate = 0.0 => FV = PV and we have the same eur amount\n#2) Eur\/Usd is strong pair and exhange rate is approximately const, X_T = X_0 (or if this assumption is very weak we can draw\n# Monte-Carlo simulations as we have GBM model of underlying asset and obtain expected X_T)\n\n#Under all assumptions above revenue = 0.0 according to EUR position \n#OR\n#For ex we can put all eur to the bank account and have r*n3*X_0 profit, r - annual compounding interest rate","28c2268b":"### 2) Define all essential parameters:<a id=\"param\"><\/a>","3dfa4584":"### 3) Expected Revenue of the portfolio<a id=\"rev\"><\/a>","7c5dcb5d":"## Question 2: Construct the portfolio to have delta and gamma zero <a id=\"q2\"><\/a>","a9e83fc1":"### 3) Price the options<a id=\"price\"><\/a>","4757f78c":"[back](#back)","28424c62":"### 3) Solutions<a id=\"sol\"><\/a>","fc570976":"## Question 4: Model's assumptions and it's problems  <a id=\"q4\"><\/a>","69fd8eda":"[back](#back)","4ee27c06":"[back](#back)","123ab015":"[back](#back)","309884d3":"[back](#back)","31e68813":"[back](#back)","5649b734":"## Question 1: Price the options and set the model parameters <a id=\"q1\"><\/a>","fe78d06c":"## Heading<a id=\"back\"><\/a> :\n> [Question 1](#q1)<br>\n>> [Functions definitions](#fun)<br>\n>> [Parameters definitions](#param)<br>\n>> [Price the Options](#price)\n\n\n> [Question 2](#q2)\n\n> [Question 3](#q3)\n>> [Capital allocation](#all)<br>\n>> [Theta Calculation](#th)<br>\n>> [Expected revenue](#rev)<br>\n\n> [Question 4](#q4)\n>> [Assumptions](#as)<br>\n>> [Problems](#pr)<br>\n>> [Solutions](#sol)<br>","1e2aeeff":"###  1) Denote all necessary functions:<a id=\"fun\"><\/a>\n> **Garman_Kohlhagen model**<br>\n\n> **Option Delta**<br>\n\n> **Option Gamma**<br>\n\n> **Option Theta**<br>","9acb78b4":"> 1. Underlying asset has GBM model <br>\n> 2. No transactions costs and short-selling is allowed <br>\n> 3. Interest rates are known and have continuous compounding <br>\n> 4. No arbitrage \n","09c6912c":"## Question 3: Portfolio Theta and Expected revenue <a id=\"q3\"><\/a>","a9d3aa0e":"> Implied volatility surface can be the solution of incorrectness of the Black-Scholes or close relative models\n\n> Change optimization problem: Identify the transaction cost function and apply it to process of delta and gamma neutralizing","c0adff85":"### 1) Assumptions<a id=\"as\"><\/a>","1b73f77c":"[back](#back)","7ec7dee3":"### 2) Problems<a id=\"pr\"><\/a>","8fcb1d83":"### 1) Capital allocation<a id=\"all\"><\/a>","d2c92348":"### Question:\n#### If all investors have the such models as Black-Scholes and Garman Kohlhagen so why there are a lot of different prices for the same securities?<br>\n\n**Answer** The reason is that the different investors have different expectations about the maintane model's parameters, especially volatility. Since true volatility is unkown. <br>\nThere are some ways how to estimate implied volatility... Let's try to construct the implied volatility surface","df6795d8":"[back](#back)","16b3843e":"### 2) Calculate Theta of the portfolio<a id=\"th\"><\/a>","ee0761d9":"**The main problems are:**\n> GBM is not realy good approximation of the underlying asset since it is usually jumps - this is not possible for GBM<br>\n\n> We have constructed delta and gamma neutral portfolio but it is does not mean that after some period of time it will be still delta and gamma neutral. Often it is needed to be adjusted to become optimal again. In practice such portfolio needes to be often reconstructed -> high transactions costs\n\n> Interest rates are not const or known the whole option's expiration time"}}