{"cell_type":{"4c05ea23":"code","2cd49b18":"code","2146b41f":"code","e60b696a":"code","be59ef43":"code","9afe82c9":"code","554d3b50":"code","4d992e83":"code","33b5c703":"code","20437e99":"code","19843292":"code","16555b4d":"code","bdfdbcf5":"code","f7229aad":"code","93e434ff":"code","18d15a1a":"code","39e1ba47":"code","73b2e09a":"code","e64818fb":"code","3ce709fb":"code","0a9bdb2c":"code","9bd73478":"code","f1cc6ed2":"code","32ce87be":"code","17959f7b":"code","a002159d":"code","9b361213":"code","5c1392e1":"code","09a11fb5":"code","2c0c26de":"code","97e2a151":"code","f9531012":"code","1446abef":"markdown","712e0983":"markdown","9e7679b2":"markdown","f2c19188":"markdown","64ece239":"markdown","d914b66c":"markdown"},"source":{"4c05ea23":"import numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\nimport os, gc\nimport random\nimport datetime\n\nfrom tqdm import tqdm_notebook as tqdm\n\n# matplotlib and seaborn for plotting\nimport matplotlib\nimport matplotlib.pyplot as plt\nimport seaborn as sns\n\nfrom pandas.plotting import register_matplotlib_converters\nregister_matplotlib_converters()\n\nfrom sklearn.preprocessing import LabelEncoder\nfrom sklearn.model_selection import KFold, StratifiedKFold\nfrom sklearn import preprocessing\n\nimport lightgbm as lgb","2cd49b18":"path = '..\/input\/ashrae-energy-prediction'\n# Input data files are available in the \"..\/input\/\" directory.\nfor dirname, _, filenames in os.walk(path):\n    for filename in filenames:\n        print(os.path.join(dirname, filename))","2146b41f":"%%time\n# unimportant features (see importance below)\nunimportant_cols = ['wind_direction', 'wind_speed', 'sea_level_pressure']\ntarget = 'meter_reading'\n\ndef load_data(source='train', path=path):\n    ''' load and merge all tables '''\n    assert source in ['train', 'test']\n    \n    building = pd.read_csv(f'{path}\/building_metadata.csv', dtype={'building_id':np.uint16, 'site_id':np.uint8})\n    weather  = pd.read_csv(f'{path}\/weather_{source}.csv', parse_dates=['timestamp'],\n                                                           dtype={'site_id':np.uint8, 'air_temperature':np.float16,\n                                                                  'cloud_coverage':np.float16, 'dew_temperature':np.float16,\n                                                                  'precip_depth_1_hr':np.float16},\n                                                           usecols=lambda c: c not in unimportant_cols)\n    df = pd.read_csv(f'{path}\/{source}.csv', dtype={'building_id':np.uint16, 'meter':np.uint8}, parse_dates=['timestamp'])\n    df = df.merge(building, on='building_id', how='left')\n    df = df.merge(weather, on=['site_id', 'timestamp'], how='left')\n    return df\n\n# load and display some samples\ntrain = load_data('train')\ntrain.sample(7)","e60b696a":"test = load_data('test')\ntest.sample(7)","be59ef43":"# the counts above expose the missing data (Should we drop or refill the missing data?)\nprint(\"Ratio of available data (not NAN's):\")\ndata_ratios = train.count()\/len(train)\ndata_ratios","9afe82c9":"class ASHRAE3Preprocessor(object):\n    @classmethod\n    def fit(cls, df, data_ratios=data_ratios):\n        cls.avgs = df.loc[:,data_ratios < 1.0].mean()\n        cls.pu_le = LabelEncoder()\n        cls.pu_le.fit(df[\"primary_use\"])\n\n    @classmethod\n    def transform(cls, df):\n        df = df.fillna(cls.avgs) # refill NAN with averages\n        df['primary_use'] = np.uint8(cls.pu_le.transform(df['primary_use']))  # encode labels\n\n        # expand datetime into its components\n        df['hour'] = np.uint8(df['timestamp'].dt.hour)\n        df['day'] = np.uint8(df['timestamp'].dt.day)\n        df['weekday'] = np.uint8(df['timestamp'].dt.weekday)\n        df['month'] = np.uint8(df['timestamp'].dt.month)\n        df['year'] = np.uint8(df['timestamp'].dt.year-2000)\n        \n        # parse and cast columns to a smaller type\n        df.rename(columns={\"square_feet\": \"log_square_feet\"}, inplace=True)\n        df['log_square_feet'] = np.float16(np.log(df['log_square_feet']))\n        df['year_built'] = np.uint8(df['year_built']-1900)\n        df['floor_count'] = np.uint8(df['floor_count'])\n        \n        # remove redundant columns\n        for col in df.columns:\n            if col in ['timestamp', 'row_id']:\n                del df[col]\n    \n        # extract target column\n        if 'meter_reading' in df.columns:\n            df['meter_reading'] = np.log1p(df['meter_reading']).astype(np.float32) # comp metric uses log errors\n\n        return df\n        \nASHRAE3Preprocessor.fit(train)","554d3b50":"train = ASHRAE3Preprocessor.transform(train)\ntrain.sample(7)","4d992e83":"train.dtypes","33b5c703":"%%time\nfig, ax = plt.subplots(figsize=(16,8))\n# use a ranked correlation to catch nonlinearities\ncorr = train[[col for col in train.columns if col != 'year']].sample(100100).corr(method='spearman')\n_ = sns.heatmap(corr, annot=True,\n                xticklabels=corr.columns.values,\n                yticklabels=corr.columns.values)","20437e99":"# force the model to use the weather data instead of dates, to avoid overfitting to the past history\nfeatures = [col for col in train.columns if col not in [target, 'year', 'month', 'day']]","19843292":"# Shuffle:\nn = train.shape[0]\nix = np.random.permutation(n)","16555b4d":"# Training data:\nsep = 15000000\ntr_x, tr_y = train[features].iloc[ix[:sep]], train[target][ix[:sep]]\nva_x, va_y = train[features].iloc[ix[sep:]], train[target][ix[sep:]]","bdfdbcf5":"xtr = tr_x.values\nytr = tr_y.values\nxval = va_x.values\nyval = va_y.values","f7229aad":"print(xtr.shape)\nprint(ytr.shape)\nprint(xval.shape)\nprint(yval.shape)","93e434ff":"from sklearn.preprocessing import StandardScaler\nscaler = StandardScaler()\nxtr = scaler.fit_transform(xtr)\nxval = scaler.transform(xval)","18d15a1a":"print(xtr.mean())\nprint(xtr.std())\nprint(xtr.shape)\n\nprint(xval.mean())\nprint(xval.std())\nprint(xval.shape)","39e1ba47":"import tensorflow as tf\nfrom tensorflow import keras","73b2e09a":"from keras import backend as K\n\ndef rmlse(y_true, y_pred):\n    return K.sqrt(K.mean(K.square(K.log(y_pred + 1.0) - K.log(y_true + 1.0))))\n    #return K.sqrt(K.mean(K.square(y_pred - y_true), axis=0))","e64818fb":"model = keras.Sequential(name=\"regresion lineal\")\n\n# model.add(keras.layers.Dense(1, activation=\"linear\", input_shape=(13,)))\nmodel.add(keras.layers.Dense(50, input_shape=(13,)))\nmodel.add(keras.layers.BatchNormalization())\nmodel.add(keras.layers.Dense(500, activation=\"selu\"))\nmodel.add(keras.layers.BatchNormalization())\n# model.add(keras.layers.Dropout(rate=0.5))\nmodel.add(keras.layers.Dense(1, activation=\"linear\"))\n\nmodel.compile(optimizer=keras.optimizers.Adam(1.e-2), loss='mse', metrics=[rmlse])\n\nmodel.summary()\n","3ce709fb":"history = model.fit(xtr, \n                    ytr, \n                    epochs=10, \n                    validation_data=(xval, yval),\n                    batch_size=8000)","0a9bdb2c":"loss_val, acc_val = model.evaluate(xval, yval)\nprint(\"Loss on val set = %f\" % (loss_val))\nprint(\"Accuracy on val set = %f\" % (acc_val))","9bd73478":"val_preds = model.predict(xval)\nprint(val_preds)","f1cc6ed2":"val_preds.shape","32ce87be":"test = ASHRAE3Preprocessor.transform(test)\ntest.sample(7)","17959f7b":"tst_x = test[features].iloc[:]","a002159d":"xtst = tst_x.values\nprint(xtst.shape)","9b361213":"xtst = scaler.transform(xtst)","5c1392e1":"print(xtst.mean())\nprint(xtst.std())\nprint(xtst.shape)","09a11fb5":"tst_preds = model.predict(xtst)\nprint(tst_preds.shape)","2c0c26de":"submission = pd.read_csv(f'{path}\/sample_submission.csv')\nsubmission['meter_reading'] = np.clip(tst_preds, a_min=0, a_max=None) # clip min at zero","97e2a151":"submission.head(9)","f9531012":"submission.to_csv('submission.csv', index=False)","1446abef":"### Test data:","712e0983":"### Data preprocessing:","9e7679b2":"### Train-validation partition:","f2c19188":"### Feature ranked correlation","64ece239":"Based on this notebook: https:\/\/www.kaggle.com\/hmendonca\/starter-eda-and-feature-selection-ashrae3","d914b66c":"### Load data and display samples:"}}