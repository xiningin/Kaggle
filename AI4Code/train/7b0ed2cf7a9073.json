{"cell_type":{"53495654":"code","7c864916":"code","e1ea71d1":"code","88a78bcb":"code","32be692d":"code","268b3e96":"code","64db7656":"code","4bdbe4b0":"code","be7a7a00":"code","c8bb1df9":"code","463f0046":"code","7b00d8d8":"code","d21d24ef":"code","9f83c8cf":"code","475386f1":"code","e6d2926a":"code","b41f4a01":"code","be33d039":"code","2b653c5a":"code","162fcda9":"code","2ce375e3":"code","4c63f705":"code","244cd21d":"code","872640a5":"code","f5694279":"code","f7508af8":"code","e42da9ee":"code","4544e8b5":"code","fc63d5ae":"code","09b2b57f":"code","27a7531e":"code","bc14133d":"code","5231d441":"code","6a6d0757":"code","8ce59568":"code","db0baaf4":"code","14d70427":"code","709fe3ff":"code","95543551":"code","0468a605":"code","49516892":"code","39e9cd1a":"code","5c15e8bf":"code","2f4cd70b":"markdown","71896a15":"markdown","ae131c7c":"markdown","be8c3315":"markdown","f3b7ed0c":"markdown","8736d60b":"markdown","bd076a96":"markdown","bedf06fa":"markdown","7128cae0":"markdown"},"source":{"53495654":"%reload_ext autoreload\n%autoreload 2\n%matplotlib inline","7c864916":"from fastai import *\nfrom fastai.vision import *\nfrom fastai.callbacks.hooks import *","e1ea71d1":"path = Path('\/kaggle\/input\/repository\/alexgkendall-SegNet-Tutorial-bb68b64\/CamVid')","88a78bcb":"path.ls()","32be692d":"fnames = get_image_files(path\/'val')\nfnames[:3]","268b3e96":"lbl_names = get_image_files(path\/'valannot')\nlbl_names[:3]","64db7656":"img_f = fnames[0]\nimg = open_image(img_f)\nimg.show(figsize=(5,5))","4bdbe4b0":"def get_y_fn(x): return Path(str(x.parent)+'annot')\/x.name\n\ncodes = array(['Sky', 'Building', 'Pole', 'Road', 'Sidewalk', 'Tree',\n    'Sign', 'Fence', 'Car', 'Pedestrian', 'Cyclist', 'Void'])","be7a7a00":"mask = open_mask(get_y_fn(img_f))\nmask.show(figsize=(5,5), alpha=1)","c8bb1df9":"src_size = np.array(mask.shape[1:])\nsrc_size,mask.data","463f0046":"bs,size = 8,src_size\/\/2","7b00d8d8":"src = (SegmentationItemList.from_folder(path)\n       .split_by_folder(valid='val')\n       .label_from_func(get_y_fn, classes=codes))","d21d24ef":"data = (src.transform(get_transforms(), tfm_y=True)\n        .databunch(bs=bs, num_workers=0)\n        .normalize(imagenet_stats))","9f83c8cf":"data.show_batch(2, figsize=(10,7))","475386f1":"name2id = {v:k for k,v in enumerate(codes)}\nvoid_code = name2id['Void']\n\ndef acc_camvid(input, target):\n    target = target.squeeze(1)\n    mask = target != void_code\n    return (input.argmax(dim=1)[mask]==target[mask]).float().mean()","e6d2926a":"metrics=acc_camvid\nwd=1e-2","b41f4a01":"learn = unet_learner(data, models.resnet34, metrics=metrics, wd=wd, model_dir='\/tmp\/models')","be33d039":"lr_find(learn)\nlearn.recorder.plot()","2b653c5a":"lr=2e-3","162fcda9":"learn.fit_one_cycle(10, slice(lr), pct_start=0.8)","2ce375e3":"learn.save('stage-1')","4c63f705":"learn.load('stage-1');","244cd21d":"learn.unfreeze()","872640a5":"lrs = slice(lr\/100,lr)","f5694279":"learn.fit_one_cycle(12, lrs, pct_start=0.8)","f7508af8":"learn.save('stage-2');","e42da9ee":"learn=None\ngc.collect()","4544e8b5":"size = src_size\nbs=4","fc63d5ae":"data = (src.transform(get_transforms(), size=size, tfm_y=True)\n        .databunch(bs=bs)\n        .normalize(imagenet_stats))","09b2b57f":"learn = unet_learner(data, models.resnet34, metrics=metrics, wd=wd, model_dir=\"\/tmp\/models\").load('stage-2');","27a7531e":"# lr_find(learn)\n# learn.recorder.plot()","bc14133d":"lr=1e-3","5231d441":"# learn.fit_one_cycle(10, slice(lr), pct_start=0.8)","6a6d0757":"learn.save('stage-1-big')","8ce59568":"learn.load('stage-1-big');","db0baaf4":"learn.unfreeze()","14d70427":"lrs = slice(lr\/1000,lr\/10)","709fe3ff":"# learn.fit_one_cycle(10, lrs)","95543551":"learn.save('stage-2-big')","0468a605":"learn.load('stage-2-big');","49516892":"learn.show_results(rows=3, figsize=(9,11))","39e9cd1a":"# start: 480x360","5c15e8bf":"learn.summary()","2f4cd70b":"## Datasets","71896a15":"This section runs too long to finish in a single Kernel session. If you want to explore it, try uncommenting the learn.fit_one_cycle lines.","ae131c7c":"The One Hundred Layer Tiramisu paper used a modified version of Camvid, with smaller images and few classes. You can get it from the CamVid directory of this repo:\n\n    git clone https:\/\/github.com\/alexgkendall\/SegNet-Tutorial.git\n    \nWe've created a Kaggle Dataset from this Github Repo so you can access the data in the Kernel.","be8c3315":"## Data","f3b7ed0c":"## Go big","8736d60b":"## fin","bd076a96":"You may have to restart your kernel and come back to this stage if you run out of memory, and may also need to decrease `bs`.","bedf06fa":"## Image segmentation with CamVid","7128cae0":"## Model"}}