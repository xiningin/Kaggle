{"cell_type":{"58b123bc":"code","1649365b":"code","cdbcbc08":"code","57dbd298":"code","054594b0":"code","6622636e":"code","17fe5729":"markdown","defc2a37":"markdown","2dc616f3":"markdown","4c11d554":"markdown","3d4980f9":"markdown","10dc3303":"markdown"},"source":{"58b123bc":"import numpy as np\nimport pandas as pd\nimport tqdm.notebook as tqdm\nimport torch\nimport torch.nn as nn\nimport torch.optim as optim\nimport time\nimport os","1649365b":"col_dtypes = {\n    'row_id' : np.object,\n    'time_id' : np.uint16,\n    'investment_id' : np.uint16,\n    'target' : np.float64,\n}\nfor i in range(300):\n    col_dtypes[f\"f_{i}\"] = np.float32","cdbcbc08":"%%time\ntrain = pd.read_csv(\"..\/input\/ubiquant-market-prediction\/train.csv\", dtype=col_dtypes)","57dbd298":"train","054594b0":"pardir = '\/kaggle\/working\/by_time_id'\nos.mkdir(pardir)\n\nkeep_cols = ['investment_id', 'target'] + [f\"f_{i}\" for i in range(300)]\n\nn_inv_id = train.investment_id.max()\nfiller = range(1, n_inv_id+1)\n\nfor group in tqdm.tqdm(train.groupby(by='time_id'), desc='Grouping by time_id'):\n    df = group[1]\n    df['sort'] = df['investment_id']\n    df = df.set_index('sort').reindex(filler).fillna(\n        0).reset_index()[keep_cols]\n    df.to_parquet(\n        pardir+f\"\/train_data_time_id_{group[0]}.parquet\"\n    )","6622636e":"metadata = {'time_id':[], 'paths':[]}\nfor i in tqdm.tqdm(train.time_id.unique()):\n    try:\n        temp = pd.read_parquet(pardir+f\"\/train_data_time_id_{i}.parquet\")\n        metadata['time_id'].append(i)\n        metadata['paths'].append(f\"train_data_time_id_{i}.parquet\")\n    except:\n        print(\"Missing!\")\n        \nmetadata = pd.DataFrame(metadata)\nmetadata.to_csv(\"train_time_id_meta.csv\", index=False)\nmetadata","17fe5729":"# Begin","defc2a37":"Test reading time of parquet batch and saving metadata of batch","2dc616f3":"# Data Loading","4c11d554":"# Batching\nBatches will be generated for each `time_id`. Missing parts of the data (each `investment_id` missing) will be filled with zeros.","3d4980f9":"First, declare the column dtypes:","10dc3303":"Load full train data using declared dtypes to save space."}}