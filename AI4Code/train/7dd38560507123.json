{"cell_type":{"ff02f9cf":"code","25394c05":"code","9b87949a":"code","823166b2":"code","4798da67":"code","7aab5ffa":"code","b40b69cc":"code","ae45317a":"code","c59fdf36":"code","053abb29":"markdown","a0cb8f81":"markdown","2c56100a":"markdown"},"source":{"ff02f9cf":"import numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\n\nimport os\nprint(os.listdir(\"..\/input\"))\nque = pd.read_csv('..\/input\/questions.csv')\nans = pd.read_csv('..\/input\/answers.csv')\npro = pd.read_csv('..\/input\/professionals.csv')","25394c05":"que.shape,ans.shape,pro.shape","9b87949a":"que_ans = que.merge(right=ans, how='inner', left_on='questions_id', right_on='answers_question_id')\nqa_pro = que_ans.merge(right=pro, left_on='answers_author_id', right_on='professionals_id')\nqa_pro.head()\n","823166b2":"qa_pro=qa_pro.sort_values('answers_date_added')\ntrain=qa_pro[:37500]\ntest=qa_pro[37500:]\ntrain.shape,test.shape\n","4798da67":"import re\n\ndef ngrams(string, n=3):\n    string = re.sub(r'[,-.\/]|\\sBD',r'', string)\n    ngrams = zip(*[string[i:] for i in range(n)])\n    return [''.join(ngram) for ngram in ngrams]\n\nprint('All 3-grams in \"McDonalds\":')\nngrams('McDonalds')\n\nimport numpy as np\nfrom scipy.sparse import csr_matrix\n!pip install sparse_dot_topn\nimport sparse_dot_topn.sparse_dot_topn as ct\n\ndef awesome_cossim_top(A, B, ntop, lower_bound=0):\n    # force A and B as a CSR matrix.\n    # If they have already been CSR, there is no overhead\n    A = A.tocsr()\n    B = B.tocsr()\n    M, _ = A.shape\n    _, N = B.shape\n \n    idx_dtype = np.int32\n \n    nnz_max = M*ntop\n \n    indptr = np.zeros(M+1, dtype=idx_dtype)\n    indices = np.zeros(nnz_max, dtype=idx_dtype)\n    data = np.zeros(nnz_max, dtype=A.dtype)\n\n    ct.sparse_dot_topn(\n        M, N, np.asarray(A.indptr, dtype=idx_dtype),\n        np.asarray(A.indices, dtype=idx_dtype),\n        A.data,\n        np.asarray(B.indptr, dtype=idx_dtype),\n        np.asarray(B.indices, dtype=idx_dtype),\n        B.data,\n        ntop,\n        lower_bound,\n        indptr, indices, data)\n\n    return csr_matrix((data,indices,indptr),shape=(M,N))\n\n\ndef get_matches_df(sparse_matrix, name_vector, top=100):\n    non_zeros = sparse_matrix.nonzero()\n    \n    sparserows = non_zeros[0]\n    sparsecols = non_zeros[1]\n    \n    if top:\n        nr_matches = top\n    else:\n        nr_matches = sparsecols.size\n    \n    left_row = np.empty([nr_matches], dtype=object)\n    left_side = np.empty([nr_matches], dtype=object)\n    right_row =np.empty([nr_matches], dtype=object)\n    right_side = np.empty([nr_matches], dtype=object)\n    similairity = np.zeros(nr_matches)\n    \n    for index in range(0, nr_matches):\n        #print(index,sparserows[index],name_vector[sparserows[index]])\n        left_row[index] =sparserows[index]\n        right_row[index] =sparsecols[index]\n        left_side[index] = name_vector[sparserows[index]]\n        right_side[index] = name_vector[sparsecols[index]]\n        similairity[index] = sparse_matrix.data[index]\n    \n    return pd.DataFrame({'left_nr':left_row,\n                        'left_side': left_side,\n                         'right_nr':right_row,\n                          'right_side': right_side,\n                           'similarity': similairity})\n","7aab5ffa":"from sklearn.feature_extraction.text import TfidfVectorizer\n\nTxt=train.questions_title\n\nvectorizer = TfidfVectorizer(min_df=1, analyzer=ngrams)\ntf_idf_matrix = vectorizer.fit_transform(Txt)\ntf_idf_matrix","b40b69cc":"import time\nt1 = time.time()\nmatches = awesome_cossim_top(tf_idf_matrix, tf_idf_matrix.transpose(), 10, 0.75)\nt = time.time()-t1\nprint(\"SELFTIMED:\", t)","ae45317a":"print( matches[:10] )","c59fdf36":"matches_df = get_matches_df(matches, Txt.values, top=100000)\nmatches_df = matches_df[matches_df['similarity'] < 0.99999] # Remove all exact matches\nmatches_df","053abb29":"# WTF why all those doubles ?","a0cb8f81":"# design train test\n* sort on date\n* pick 75% as train 25% as test\n","2c56100a":"# Train profession_id on Title\nlets make the slimmest possible model\nwe just train the professions on title\n"}}