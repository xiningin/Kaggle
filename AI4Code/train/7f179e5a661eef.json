{"cell_type":{"58be9b11":"code","aa4d49ba":"code","039061a6":"code","8a486afd":"code","1bf5c907":"code","2b2c4643":"code","7f8d739b":"code","9273e493":"code","fd0d355b":"code","b1824aaa":"code","34d0815c":"code","2c8bcf76":"code","2429000a":"code","6fb8072c":"code","507cce39":"code","7de1584e":"code","96bb1404":"code","98e4a777":"code","a9a66f07":"code","50615fb5":"code","72bbd1c3":"code","f90baa88":"code","057b0461":"code","e5a9c637":"code","5dbb8e7d":"code","beee6a23":"code","b508e040":"code","0c534225":"code","34050d94":"code","85b1fea9":"code","aeec77b7":"code","eb7318b2":"code","fa0e9006":"code","ef0b3da2":"code","8335f272":"code","f520e76e":"code","fe5e516f":"code","363cd27c":"code","1794d7f3":"code","a0a7eb8b":"code","fb90059c":"code","59989899":"code","2c6f46ee":"code","ff9daa61":"code","ca54da33":"code","db378bbb":"code","dfcbffc2":"code","5a13e974":"code","7100a7bb":"code","b8664c91":"code","42b67025":"code","e1b3c330":"code","ca82bd01":"code","dc22e974":"code","fb597cce":"code","f32b23aa":"code","546002b3":"markdown"},"source":{"58be9b11":"# This Python 3 environment comes with many helpful analytics libraries installed\n# It is defined by the kaggle\/python Docker image: https:\/\/github.com\/kaggle\/docker-python\n# For example, here's several helpful packages to load\n\nimport numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\n\n# Input data files are available in the read-only \"..\/input\/\" directory\n# For example, running this (by clicking run or pressing Shift+Enter) will list all files under the input directory\n\nimport os\nfor dirname, _, filenames in os.walk('\/kaggle\/input'):\n    for filename in filenames:\n        print(os.path.join(dirname, filename))\n        break\n\n# You can write up to 5GB to the current directory (\/kaggle\/working\/) that gets preserved as output when you create a version using \"Save & Run All\" \n# You can also write temporary files to \/kaggle\/temp\/, but they won't be saved outside of the current session","aa4d49ba":"#for dirname, _, filenames in os.walk('..\/input\/humpback-whale-identification\/train'):\n#    for filename in filenames:\n#        print(filename)","039061a6":"%reload_ext autoreload\n%autoreload 2\n%matplotlib inline\nfrom fastai.vision import *\nimport torch\ntorch.cuda.is_available()\n\nimport warnings\nwarnings.filterwarnings(\"ignore\")","8a486afd":"df = pd.read_csv('..\/input\/humpback-whale-identification\/train.csv')\ndf.head()","1bf5c907":"tfm = rand_pad(4, 150)\ntfms = get_transforms(max_lighting =0.1, max_zoom =1.05, max_warp = 0.2, do_flip = True, max_rotate=25)\n","2b2c4643":"np.random.seed(52)\nsrc = (ImageList.from_csv('..\/input\/humpback-whale-identification\/',\n                         'train.csv', folder = 'train').split_by_rand_pct(0.2).label_from_df(label_delim=' '))","7f8d739b":"src","9273e493":"data = (src.transform(tfms, size=(150,300))\n        .databunch().normalize(imagenet_stats))","fd0d355b":"data.show_batch(rows =3, figsize=(12,9))","b1824aaa":"arch = models.resnet101","34d0815c":"learn = cnn_learner(data, arch, metrics=fbeta)","2c8bcf76":"\nlearn.model_dir=\"\/kaggle\/working\"","2429000a":"learn.lr_find()","6fb8072c":"learn.recorder.plot()","507cce39":"lr = 1e-02","7de1584e":"learn.fit_one_cycle(10, slice(lr), wd =1e-02)","96bb1404":"learn.recorder.plot_losses()","98e4a777":"learn.save('whale')","a9a66f07":"learn.load('whale')","50615fb5":"learn.unfreeze()","72bbd1c3":"learn.detach()","f90baa88":"learn.lr_find()","057b0461":"learn.recorder.plot()","e5a9c637":"learn.fit_one_cycle(10, slice(7e-4, (7e-4)\/5), wd = 0.1)","5dbb8e7d":"    learn.recorder.plot_losses()","beee6a23":"learn.save('stage-2-rn50')","b508e040":"learn.load('stage-2-rn50')","0c534225":"data = (src.transform(tfms, size = (350,700))\n       .databunch().normalize(imagenet_stats))\n\nlearn.data = data\ndata.train_ds[0][0].shape","34050d94":"learn.to_fp16()","85b1fea9":"learn.freeze()","aeec77b7":"learn.lr_find()\nlearn.recorder.plot()","eb7318b2":"learn.recorder.plot()","fa0e9006":"lr = 1e-3","ef0b3da2":"learn.fit_one_cycle(5,slice(lr, lr\/5))","8335f272":"learn.recorder.plot_losses()","f520e76e":"learn.save('stage-1 350-rn50')","fe5e516f":"learn.load('stage-1 350-rn50')","363cd27c":"learn.unfreeze()","1794d7f3":"learn.lr_find()","a0a7eb8b":"learn.recorder.plot()","fb90059c":"lr = 1e-4","59989899":"learn.fit_one_cycle(10,slice(lr, lr\/5), wd = 1e-03)","2c6f46ee":"learn.recorder.plot_losses()","ff9daa61":"learn.save('stage-2 350-rn50')","ca54da33":"learn.load('stage-2 350-rn50')","db378bbb":"learn.export('\/kaggle\/working\/export.pkl')","dfcbffc2":"learn.recorder.plot()","5a13e974":"test = ImageList.from_folder('..\/input\/humpback-whale-identification\/test')\nlen(test)","7100a7bb":"learn = load_learner('\/kaggle\/working\/', test=test).to_fp16()\npreds, _ = learn.get_preds(ds_type=DatasetType.Test)","b8664c91":"temp = torch.topk(preds, 5)","42b67025":"labelled_preds = [' '.join([learn.data.classes[p] for i,p in enumerate(pred)]) for pred in temp.indices]","e1b3c330":"learn.data.test_ds.items","ca82bd01":"fnames = [f.name for f in learn.data.test_ds.items]","dc22e974":"df = pd.DataFrame({'image_name':fnames, 'tags':labelled_preds}, columns=['image_name', 'tags'])","fb597cce":"df.to_csv('\/kaggle\/working\/submission.csv', index=False)","f32b23aa":"df1 = pd.DataFrame({'Image':fnames, 'id':labelled_preds}, columns=['Image', 'id'])\ndf1.to_csv('\/kaggle\/working\/submission1.csv', index=False)","546002b3":"# Test"}}