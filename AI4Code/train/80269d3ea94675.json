{"cell_type":{"ef548722":"code","5c9994e4":"code","81ad9033":"code","38382d4c":"code","77f503ac":"code","87e653ab":"code","d1a1ed56":"code","395931d2":"code","9c1903e6":"code","c000bf0b":"code","7f0d19cb":"code","51a65007":"code","d30d3243":"code","ebd57857":"code","3c0dec64":"code","db87ac4c":"code","479890d2":"code","46184a51":"markdown","8113e3ed":"markdown","546b43d1":"markdown","178fd897":"markdown","d2163b0a":"markdown","06c2b567":"markdown","7f4c060c":"markdown","3e7d1bdc":"markdown","ba46d263":"markdown"},"source":{"ef548722":"# Import libraries\nimport numpy as np # linear algebra\nimport pandas as pd # data processing\nimport matplotlib.pyplot as plt # graph\nimport seaborn as sns # advanced graph\nimport math","5c9994e4":"# Import data\ndata = pd.read_csv('\/kaggle\/input\/financial-data-of-french-compagnies\/data_kaggle.csv', nrows=10000)\ndata = data.drop('Unnamed: 0', axis=1)\ncol_info = pd.read_csv('\/kaggle\/input\/financial-data-of-french-compagnies\/Profit and loss - Onthology.csv')","81ad9033":"# Function\ndef obtention_log10(val):\n  \"\"\" Transform a number : 100 000 becomes 5 and -100 becomes -2 \"\"\"\n  if val == np.nan: return np.nan\n  elif (isinstance(val, float)) or (isinstance(val, int)):\n    signe, nb = np.sign(val), np.absolute(val)\n    if nb < 1: return 0\n    else : return math.log10(nb) * signe\n  else: return val\n\ndef division_colonnes(num, den):\n  \"\"\" This function allows you to divide 2 columns \"\"\"\n  if (num == 0): # num\u00e9rateur nul\n    return 0\n  elif den != 0:  # attention aux divisions par z\u00e9ro\n    return num \/ den\n  else :\n    return np.nan\n\ndef filtre(df, col, filtre):\n  \"\"\" Returns the companies containing the filter in a column \"\"\"\n  return df[col].str.contains(filtre, case=False, na=False)","38382d4c":"# lowest level\ncolonnes_enfants = col_info.loc[col_info['Liasse (Id)']\\\n                   .isin(['FJ', 'FM', 'FN', 'FO', 'FP', 'FQ',                     # Produit d'exploitation\n                          'FS', 'FT', 'FU', 'FV', 'FW', 'FX', 'FY', 'FZ', 'GE',   # Charges d'exploitation\n                          'GJ', 'GK', 'GL', 'GM', 'GN', 'GO',                     # Produits financiers\n                          'GQ', 'GR', 'GS', 'GT',                                 # Charges financi\u00e8res\n                          'HA', 'HB', 'HC',                                       # Produits exceptionnels\n                          'HE', 'HF', 'HG'])                                      # Charges exceptionnels\n                   ,'Columns of the profit and loss (FR)']                            \n\n# Niveau parent\ncolonne_parent = col_info.loc[col_info['Liasse (Id)']\\\n                   .isin(['FR', 'GF',         # R\u00e9sultat d'exploitation\n                          'GP', 'GU',         # R\u00e9sultat financier\n                          'HD', 'HH']),       # R\u00e9sultat exceptionnel\n                          'Columns of the profit and loss (FR)']    \n\n# Niveau grand parent\ncolonne_grand_parent = col_info.loc[col_info['Liasse (Id)']\\\n                   .isin(['GG', 'GV','HI']),'Columns of the profit and loss (FR)']\n\n# Niveau arri\u00e8re grand parent\ncolonne_arri\u00e8re_grand_parent = col_info.loc[col_info['Liasse (Id)']\\\n                   .isin(['HN', 'GG', 'GV', 'GH', 'GI', 'HI', 'HJ', 'HK']),'Columns of the profit and loss (FR)']","77f503ac":"colonne_parent","87e653ab":"col_info","d1a1ed56":"# Creation of a DataFrame by percentage: sum(children) \/ parent \ndata_percent = pd.DataFrame()\n# Produit d'exploitation\ncolonnes_produits_exploitation = col_info.loc[col_info['Liasse (Id)']\\\n                   .isin(['FR', 'FJ', 'FM', 'FN', 'FO', 'FP', 'FQ']),:]\nfor col in list(colonnes_produits_exploitation['Columns of the profit and loss (FR)']):\n  data_percent[col] = data.apply(lambda x: division_colonnes(x[col], x['Total des produits d\u2019exploitation']), axis=1)\n\n# Charges d'exploitation\ncolonnes_charges_exploitation = col_info.loc[col_info['Liasse (Id)']\\\n                   .isin(['GF', 'FS', 'FT', 'FU', 'FV', 'FW', 'FX', 'FY', 'FZ', 'GE']),:]\nfor col in list(colonnes_charges_exploitation['Columns of the profit and loss (FR)']):\n  data_percent[col] = data.apply(lambda x: division_colonnes(x[col], x['Total des charges d\u2019exploitation']), axis=1)\n\n# Produits financiers\ncolonnes_produits_financiers = col_info.loc[col_info['Liasse (Id)']\\\n                   .isin(['GP', 'GJ', 'GK', 'GL', 'GM', 'GN', 'GO']),:]\nfor col in list(colonnes_produits_financiers['Columns of the profit and loss (FR)']):\n  data_percent[col] = data.apply(lambda x: division_colonnes(x[col], x['Total des produits financiers']), axis=1)\n\n# Charges financi\u00e8res\ncolonnes_charges_financi\u00e8res = col_info.loc[col_info['Liasse (Id)']\\\n                   .isin(['GU', 'GQ', 'GR', 'GS', 'GT']),:]\nfor col in list(colonnes_charges_financi\u00e8res['Columns of the profit and loss (FR)']):\n  data_percent[col] = data.apply(lambda x: division_colonnes(x[col], x['Total des charges financi\u00e8res']), axis=1)\n\n# Produits exceptionnels\ncolonnes_produits_exceptionnels = col_info.loc[col_info['Liasse (Id)']\\\n                   .isin(['HD', 'HA', 'HB', 'HC']),:]\nfor col in list(colonnes_produits_exceptionnels['Columns of the profit and loss (FR)']):\n  data_percent[col] = data.apply(lambda x: division_colonnes(x[col], x['Total des produits exceptionnels']), axis=1)\n\n# Charges exceptionnels\ncolonnes_charges_exceptionnelles = col_info.loc[col_info['Liasse (Id)']\\\n                   .isin(['HH', 'HE', 'HF', 'HG']),:]\nfor col in list(colonnes_charges_exceptionnelles['Columns of the profit and loss (FR)']):\n  data_percent[col] = data.apply(lambda x: division_colonnes(x[col], x['Total des charges exceptionnelles']), axis=1)\n\n\ndata_percent.describe()","395931d2":"# Creation of a DataFrame by percentage: Difference (parents) = Grand parent \n# R\u00e9sultat d'exploitation\ncolonnes_r\u00e9sultat_exploitation = col_info.loc[col_info['Liasse (Id)']\\\n                   .isin(['GG', 'FR', 'GF']),:]\nfor col in list(colonnes_r\u00e9sultat_exploitation['Columns of the profit and loss (FR)']):\n  data_percent[col] = data.apply(lambda x: division_colonnes(x[col], x['R\u00e9sultat d\\'exploitation']), axis=1)\n\n# R\u00e9sultat financier\ncolonnes_r\u00e9sultat_financier = col_info.loc[col_info['Liasse (Id)']\\\n                   .isin(['GV', 'GP', 'GU']),:]\nfor col in list(colonnes_r\u00e9sultat_financier['Columns of the profit and loss (FR)']):\n  data_percent[col] = data.apply(lambda x: division_colonnes(x[col], x['R\u00e9sultat financier']), axis=1)\n\n# R\u00e9sultat exceptionnel\ncolonnes_r\u00e9sultat_exceptionnel = col_info.loc[col_info['Liasse (Id)']\\\n                   .isin(['HI', 'HD', 'HH']),:]\nfor col in list(colonnes_r\u00e9sultat_exceptionnel['Columns of the profit and loss (FR)']):\n  data_percent[col] = data.apply(lambda x: division_colonnes(x[col], x['R\u00e9sultat exceptionnel']), axis=1)","9c1903e6":"# Creation of a DataFrame by percentage: Sum (grandparents) = Great-grandparent \n# R\u00e9sultat en cours avant imp\u00f4ts\ncolonnes_r\u00e9sultat_avant_impots = col_info.loc[col_info['Liasse (Id)']\\\n                   .isin(['GW', 'GG', 'GV', 'GH', 'GI']),:]\nfor col in list(colonnes_r\u00e9sultat_avant_impots['Columns of the profit and loss (FR)']):\n  data_percent[col] = data.apply(lambda x: division_colonnes(x[col], x['R\u00e9sultat en cours avant imp\u00f4ts']), axis=1)\n\n# B\u00e9n\u00e9fices ou perte (Total des produits \u2010 Total des charges)\ncolonnes_b\u00e9nefices = col_info.loc[col_info['Liasse (Id)']\\\n                   .isin(['HN', 'GW', 'HI', 'HJ', 'HK']),:]\nfor col in list(colonnes_b\u00e9nefices['Columns of the profit and loss (FR)']):\n  data_percent[col] = data.apply(lambda x: division_colonnes(x[col], x['B\u00e9n\u00e9fices ou perte (Total des produits \u2010 Total des charges)']), axis=1)","c000bf0b":"## Application de filtres pour \u00e9liminer les valeurs ab\u00e9rantes\ndata_percent['index'] = data_percent.index\ndata['index'] = data.index\n\n# Application of a filter: children over 200% of their parent are removed, i.e. 72 lines \nindex_anomalies_enfant = data_percent.loc[pd.DataFrame(abs(data_percent.loc[:,colonnes_enfants]) > 2).sum(axis=1) > 0,'index']\n\ndata_percent.drop(list(index_anomalies_enfant), axis=0).describe()","7f0d19cb":"#data_percent_less_than_2.hist(bins=20, figsize=(25, 15))\ndef hist_enfants(col_famille, range=[-0.2,1.1]):\n  \"\"\" Allows the creation of a histogram on the distribution of children compared to parents \"\"\" \n  plt.figure(figsize=(7,7))\n  # identification of family columns\n  df_col_hist = col_famille['Columns of the profit and loss (FR)']\n  # identification dthe parent\n  col_parent = col_famille.loc[filtre(col_famille, 'Columns of the profit and loss (FR)', 'Total'),'Columns of the profit and loss (FR)'].to_numpy()[0]\n  # realization of histograms\n  for col in df_col_hist.loc[df_col_hist!=col_parent]:\n    plt.hist(data_percent[col], range=range, alpha=0.5, label=col, bins=40, density=True,stacked=True)\n  plt.legend(loc=2)\n  plt.title('Histograms of distribution by percentage of children in \\'{}\\' '.format(col_parent))\n  plt.show()\n\nhist_enfants(colonnes_produits_exploitation)\nhist_enfants(colonnes_charges_exploitation)\nhist_enfants(colonnes_produits_financiers)\nhist_enfants(colonnes_charges_financi\u00e8res)\nhist_enfants(colonnes_produits_exceptionnels)\nhist_enfants(colonnes_charges_exceptionnelles)","51a65007":"def hist_zero(df_op, op_add, op_sub, title='',print_hist=True, min=0,max=1):\n    \"\"\" Allows you to perform subtraction and addition operations on a df\n     in order to compare this difference to zero with a histogram\n     \"\"\"\n    df_tot = pd.Series(index=df_op.index, data=0)\n    df_op.fillna(0,inplace=True)\n    \n    if len(op_add) > 0:\n        for col in op_add:\n            df_tot += df_op.loc[:,col]\n    if len(op_sub) > 0:\n        for col in op_sub:\n            df_tot -= df_op.loc[:,col]\n    \n    df_tot_log = df_tot.to_frame().applymap(obtention_log10).copy()\n    if print_hist :\n      df_tot_log.hist(bins=9)\n      plt.title('LOGARITHMIC histogram of the zero position of \\'{}\\''.format(title))\n\n    return pd.DataFrame((df_tot_log >= min) & (df_tot_log <= max)).iloc[:,0], df_tot\nmin, max=-1,1","d30d3243":"def obtention_col(df):\n    \"\"\" very specific function, that provides the list of columns\"\"\"\n    return(';'.join(list(df.loc[df.loc[:,'Calcul'].isna(), 'Columns of the profit and loss (FR)'])))\n\ndf_add_sub = pd.DataFrame(columns=['operation to check', 'op_add', 'op_sub'], index=np.arange(0,11))\ndf_add_sub.loc[0,:] = 'profit or losses (total product - total charges)', ';'.join(['R\u00e9sultat en cours avant imp\u00f4ts', 'R\u00e9sultat exceptionnel']), ';'.join(['B\u00e9n\u00e9fices ou perte (Total des produits \u2010 Total des charges)','Participation des salari\u00e9s aux r\u00e9sultats de l\u2019entreprise','Imp\u00f4ts sur les b\u00e9n\u00e9fices'])\ndf_add_sub.loc[1,:] = 'result in progress before taxes', 'R\u00e9sultat en cours avant imp\u00f4ts', ';'.join(['R\u00e9sultat d\\'exploitation','R\u00e9sultat financier','B\u00e9n\u00e9fice attribu\u00e9 ou perte transf\u00e9r\u00e9e','Perte support\u00e9e ou b\u00e9n\u00e9fice transf\u00e9r\u00e9'])\ndf_add_sub.loc[2,:] = 'operating result', 'Total des produits d\u2019exploitation', ';'.join(['R\u00e9sultat d\\'exploitation','Total des charges d\u2019exploitation'])\ndf_add_sub.loc[3,:] = 'financial result', 'Total des produits financiers', ';'.join(['R\u00e9sultat financier','Total des charges financi\u00e8res'])\ndf_add_sub.loc[4,:] = 'exceptional result', 'Total des produits exceptionnels', ';'.join(['R\u00e9sultat exceptionnel','Total des charges exceptionnelles'])\n\ndf_add_sub.loc[5,:] = 'total of exploitation product', 'Total des produits d\u2019exploitation', obtention_col(df=colonnes_produits_exploitation)\ndf_add_sub.loc[6,:] = 'total financial income', 'Total des produits financiers', obtention_col(df=colonnes_produits_financiers)\ndf_add_sub.loc[7,:] = 'total exceptional products', 'Total des produits exceptionnels', obtention_col(df=colonnes_produits_exceptionnels)\n\ndf_add_sub.loc[8,:] = 'total of exploitation charges', 'Total des charges d\u2019exploitation', obtention_col(df=colonnes_charges_exploitation)\ndf_add_sub.loc[9,:] = 'total financial charges\/load', 'Total des charges financi\u00e8res', obtention_col(df=colonnes_charges_financi\u00e8res)\ndf_add_sub.loc[10,:] = 'total exceptional charges', 'Total des charges exceptionnelles', obtention_col(df=colonnes_charges_exceptionnelles)\n\ndf_add_sub","ebd57857":"for i in range(0,11):\n    mask, df_zero = hist_zero(df_op=data, op_add=df_add_sub.iloc[i,1].split(';'), op_sub=df_add_sub.iloc[i,2].split(';'), title=df_add_sub.iloc[i,0],min=min,max=max)","3c0dec64":"# Correction of null parents\n# We replace null parents with the sum of their children\n# We go through all the families \nfor col_famille in [colonnes_produits_exploitation,\n                    colonnes_charges_exploitation,\n                    colonnes_produits_financiers,\n                    colonnes_charges_financi\u00e8res,\n                    colonnes_produits_exceptionnels,\n                    colonnes_charges_exceptionnelles] :\n    # We identify the parent\n    parent = col_famille.loc[filtre(col_famille, 'Columns of the profit and loss (FR)', 'Total'),'Columns of the profit and loss (FR)'].to_numpy()[0]\n    # We identify the children\n    enfants = list(col_famille.loc[col_famille.loc[:,'Columns of the profit and loss (FR)'] != parent[0],'Columns of the profit and loss (FR)'])\n    print(parent, enfants, '\\n')\n    # We realize the logarithmic histogram of the difference between the parent and the sum of the children\n    # We get the mask on the lines where the parent is null \n    mask, df_zero = hist_zero(df_op=data, op_add=[parent], op_sub=enfants, title=parent, print_hist=False, min=-30,max=-0.5)\n    data['comparaison z\u00e9ro'] = df_zero\n    data['somme des enfants'] = data.loc[:,enfants].sum(axis=1)\n    # On the lines where the parent is zero, we assign it the sum of the children \n    data.loc[:,'correction '+parent] = data.apply(lambda row: row[parent] if int(row[parent]) != 0 else row['somme des enfants'], axis=1)","db87ac4c":"# Verification\nfor col_famille in [colonnes_produits_exploitation,\n                    colonnes_charges_exploitation,\n                    colonnes_produits_financiers,\n                    colonnes_charges_financi\u00e8res,\n                    colonnes_produits_exceptionnels,\n                    colonnes_charges_exceptionnelles] :\n    parent = col_famille.loc[filtre(col_famille, 'Columns of the profit and loss (FR)', 'Total'),'Columns of the profit and loss (FR)'].to_numpy()[0]\n    enfants = list(col_famille.loc[col_famille.loc[:,'Columns of the profit and loss (FR)'] != parent,'Columns of the profit and loss (FR)'])\n    mask, df_zero = hist_zero(df_op=data, op_add=[parent], op_sub=enfants, title=parent,min=-30,max=-0.5)\n    mask, df_zero = hist_zero(df_op=data, op_add=['correction '+parent], op_sub=enfants, title='correction '+parent,min=-30,max=-0.5)","479890d2":"obtention_col(df=colonnes_charges_exploitation)","46184a51":"## Check that the sum of the children is equal to their only parent\nWe make the difference, then a comparison to zero \n![](https:\/\/i.ibb.co\/Sn50b5d\/Capture-d-cran-du-2021-07-17-17-01-17.png)","8113e3ed":"We can observe that most of the parents are equal to the sum of their children. This is good news !\nSome zero position are above or below zero, they need to be corrected.","546b43d1":"## Introduction\nSome columns are the sum or the substraction of others columns. We would like to verify this hypothesis.\nThe parents studied are:\n*     Total des produits d\u2019exploitation\n*     Total des charges d\u2019exploitation\n*     Total des produits financiers\n*     Total des charges financi\u00e8res\n*     Total des produits exceptionnels\n*     Total des charges exceptionnelles\n\nFor instance, we would like to check if 'Total des produits d\u2019exploitation' is equal to the sum of :\n* 'Dotations financi\u00e8res sur amortissements et provisions',\n*  'Int\u00e9r\u00eats et charges assimil\u00e9es',\n*  'Diff\u00e9rences n\u00e9gatives de change',\n*  'Charges nettes sur cessions de valeurs mobili\u00e8res de placement',\n*  'Total des charges financi\u00e8res'\n\n![](https:\/\/i.ibb.co\/f2n18qV\/Capture-d-cran-du-2021-07-17-16-46-37.png)","178fd897":"## Creation of data by percentage according to parents\nCreation of a dataframe containing the data by percentage compared to their parent\n\nFor lines where the parent is absent, the entire line is deleted. It is therefore necessary to remedy the missing values, in particular for the parents. ","d2163b0a":"## Production of histograms on the distribution of children in relation to parents\n","06c2b567":"We have been able to correct some parents. Now the main issues come the right of the graph. The right of the graph shows compagnies where the sum the children is above their parents. Futher investigation need to be done.","7f4c060c":"## Correction of parents equal to zero and not being equal to the sum of their child\nWe decide to correct parents equal to zero and not equal to the sum of their children. These parents will take the sum of their children as a value.","3e7d1bdc":"![](https:\/\/i.ibb.co\/7GHNSk9\/Capture-d-cran-du-2021-07-17-17-09-35.png)","ba46d263":"We can observe that some parents are generally equal to their children:\n* Chiffre d'affaire net = Total Produit d'exploitation\n* Autre int\u00e9r\u00eats et produits assimil\u00e9s = Total des produits financiers\n* int\u00e9r\u00eats et charges assimil\u00e9s = Total des charges financi\u00e8res\n* The Total of exceptional income is often equal to one of its children (Exceptional income on management, capital or load transfer)\n* The total of exceptional expenses is often equal to one of his children (Exceptional income on management, capital or transfer of load)\n\nIt can also be observed that the total operating expenses are well distributed among the children.\n\nit seems that all children are divided between 0 and 100% of their parent. Which is a good sign, it shows the reliability of the database\nMost children have the same sign as their parent"}}