{"cell_type":{"94621722":"code","584e65e2":"code","8c20e223":"code","9f0baa2c":"code","2c39fca3":"code","0c85ae41":"code","2293e7b7":"code","d9f912ad":"code","19a408da":"code","f014de07":"code","59a1d70a":"code","1965c3b3":"code","f0a46f49":"code","a335df2c":"code","d43e56ae":"code","c2ae9ae1":"code","b7a417fc":"code","a482a62b":"code","b1f705c0":"code","eea1221f":"code","5b954ed7":"code","9993c599":"code","0293f835":"code","d76b6b45":"code","323fcfa4":"code","7a573fe1":"code","a1e325c6":"code","13c68054":"code","43b30393":"code","6867b510":"code","aa1fe376":"code","ac250194":"code","91c63f64":"code","e4f5e28f":"code","860ebba6":"code","f74c0d4e":"code","5a41d07a":"code","fb11824d":"code","a1df7504":"code","1cd24034":"code","cedca9db":"code","ad1e87eb":"code","7b5850ea":"code","e8b669b2":"code","31fd563d":"code","d927411a":"code","bf1674b1":"code","e506a83c":"code","9e9e6ef5":"code","d6c5d046":"code","af09d303":"code","1b1b54c4":"code","bbce0297":"code","cb9dcd26":"code","59a996d3":"code","aa25f6b5":"code","4bf38684":"code","87a6891a":"code","37290572":"code","df8e1abd":"code","fbd1bf5a":"code","4793dc93":"code","8fce2880":"code","8513669d":"code","682f087f":"code","f3966483":"code","934c57cb":"code","f308fbfd":"code","57527e0c":"code","d43988b4":"code","e789beac":"code","1ac1cb94":"code","eff216a7":"code","3de62324":"code","438485b8":"code","dae12937":"code","00f2aa89":"code","e4e3dd7d":"markdown","295d139e":"markdown","6e346435":"markdown","e419c362":"markdown","83e29294":"markdown","c7df6dfe":"markdown","bb0865e5":"markdown","a554203a":"markdown","5f1387d1":"markdown","1668d760":"markdown","f70bab66":"markdown","0137499d":"markdown","391036ee":"markdown","4d446a8a":"markdown","b028c09d":"markdown","2b4a0aad":"markdown","0e624a27":"markdown","f9552caa":"markdown","f9e94f91":"markdown","6c23f248":"markdown","358d9e5e":"markdown","f779409d":"markdown","ebc94117":"markdown","7f2cbdfe":"markdown","d2f6f333":"markdown","9f94ec3e":"markdown","5238285b":"markdown","102677dc":"markdown","92ea02b5":"markdown","8fda2119":"markdown","644b669a":"markdown","b9bca2c9":"markdown","7edfcc1b":"markdown","99b09643":"markdown","971f75c5":"markdown","775cb821":"markdown","1235a6ae":"markdown","c0613b1a":"markdown","0eb41c1a":"markdown","e045ad25":"markdown","14a6a63d":"markdown","fd165135":"markdown"},"source":{"94621722":"import numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\nimport matplotlib.pyplot as plt\n%matplotlib inline\nimport seaborn as sns\n\n# Input data files are available in the \"..\/input\/\" directory.\nimport os\nprint(os.listdir(\"..\/input\"))\n\n# Any results you write to the current directory are saved as output.","584e65e2":"# load data\ntrain = pd.read_csv('..\/input\/train.csv')\nprint('Shape of train set {}'.format(train.shape))\ntest = pd.read_csv('..\/input\/test.csv')\nprint('Shape of test set {}'.format(test.shape))","8c20e223":"def histogram(col, data, xlabel):\n    fig = data[col].hist()\n    plt.xlabel(xlabel); plt.ylabel('# households')\n    return fig\n\ndef corr_plot(df, xlabels='auto', ylabels='auto', figsize=(5, 5), fmt='.2f'):\n    plt.figure(figsize=figsize)\n    return sns.heatmap(df.corr(), annot=True, fmt=fmt, \n                       xticklabels=xlabels, yticklabels=ylabels)\n\ndef cal_dependency_rate(df):\n    df['n_dependency'] = df['hogar_total'] - df['hogar_adul']\n    non_zero = (df.hogar_adul != 0)\n    df.loc[non_zero, 'num_dep_rate'] = df.loc[non_zero, 'n_dependency']\/df.loc[non_zero, 'hogar_adul']\n    df.loc[-non_zero, 'num_dep_rate'] = np.nan\n    return df","9f0baa2c":"import math\ndef to_nearest_int(e):\n    floor_int = int(math.floor(e))\n    if e - floor_int < 0.5:\n        return floor_int\n    else:\n        return floor_int + 1\n\ndef round_to_nearest_int(arr):\n    # round each entry of given array to its nearest integer (floor or ceiling)\n    return [to_nearest_int(e) for e in arr]","2c39fca3":"train.dependency.value_counts().head()","0c85ae41":"train = cal_dependency_rate(train)","2293e7b7":"train['num_dep_rate'].describe()","d9f912ad":"train.query('num_dep_rate == 8')['Target']","19a408da":"basic_feats = ['hogar_nin', 'hogar_adul', 'hogar_mayor', 'num_dep_rate', \n                'overcrowding', 'rooms', 'bedrooms']\nbasic_labels = ['n_kids', 'n_adults', 'n_seniors', 'dependency_rate', \n               'overcrowding', 'rooms', 'bedrooms', 'Target']\ncols = basic_feats + ['Target']","f014de07":"corr_plot(df=train.drop_duplicates('idhogar')[cols], figsize=(8, 8), \n          xlabels=basic_labels, ylabels=basic_labels)\nplt.savefig('basic_corr.pdf')","59a1d70a":"print('# households in train set: {}'.format(train.idhogar.nunique()))\nprint('# household heads in train set: {}'.format(sum(train['parentesco1'] == 1)))","1965c3b3":"cols = ['idhogar', 'parentesco1', 'male', 'female'] + ['Target']\ngender_df = train.loc[train.parentesco1 == 1, cols]\ngender_df.loc[gender_df['male'] == 1, 'house_head_gender'] = 'male'\ngender_df.loc[gender_df['female'] == 1, 'house_head_gender'] = 'female'","f0a46f49":"pd.crosstab(gender_df.house_head_gender, gender_df.Target, \n            margins=True).style.background_gradient(cmap='viridis', low=.5, high=0)","a335df2c":"edu_cols = [cc for cc in train.columns if 'instlevel' in cc] + ['escolari']\ncols = ['idhogar', 'parentesco1'] + edu_cols + ['Target']\nedu_df = train.loc[train.parentesco1 == 1, cols]\n\n# convert binary edu levels to numeric values\nfor i in range(1, 10):\n    edu_df.loc[edu_df['instlevel{}'.format(i)] == 1, 'head_edu_level'] = i\n\n# query years of schooling of house head\nedu_df['head_school_years'] = edu_df['escolari']","d43e56ae":"edu_df.head()","c2ae9ae1":"edu_vs_target_cor = edu_df.corr().loc['head_edu_level', 'Target']\nprint('Correlation between education level of household head and financial status: {}'.format(edu_vs_target_cor))","b7a417fc":"# add education data of household head to original data\ntrain = pd.merge(train, edu_df[['idhogar', 'head_edu_level', 'head_school_years']], \n                 how='outer', on='idhogar')\ntrain.shape","a482a62b":"cols = ['meaneduc', 'head_edu_level', 'head_school_years'] + ['Target']\nlabels = ['mean_edu_level', 'head_edu_level', 'head_school_years', 'Target']\ncorr_plot(train[cols], xlabels=labels, ylabels=labels)\nplt.savefig('edu_vs_poverty.pdf')","b1f705c0":"def add_quality(df, componente='pared', component='wall'):\n    for i in [1,2,3]:\n        i_quality = (df['e{}{}'.format(componente, i)] == 1)\n        df.loc[i_quality, '{}_quality'.format(component)] = i\n    return df","eea1221f":"# add wall quality\ntrain = add_quality(train, componente='pared', component='wall')\ncols = ['epared1', 'epared2', 'epared3', 'wall_quality']\ntrain[cols].head()","5b954ed7":"# add roof quality\ntrain = add_quality(train, componente='techo', component='roof')\ncols = ['etecho1', 'etecho2', 'etecho3', 'roof_quality']\ntrain[cols].head()","9993c599":"# add floor quality\ntrain = add_quality(train, componente='viv', component='floor')\ncols = ['eviv1', 'eviv2', 'eviv3', 'floor_quality']\ntrain[cols].head()","0293f835":"# correlation with target\ncols = ['floor_quality', 'roof_quality', 'wall_quality'] + ['Target']\ncorr_plot(train[cols])","d76b6b45":"def to_english(df, sp_pre='pared', eng_pre='wall_', translate=None):\n    '''\n    rename certain columns in specified dataframe from Spanish \n    to English, given the translation\n    '''\n    for sp in translate.keys():\n        spanish_name = sp_pre + '{}'.format(sp)\n        english_name = eng_pre + '{}'.format(translate[sp])\n        df.rename(columns={spanish_name: english_name}, inplace=True)\n    \n    return df","323fcfa4":"# rename columns from Spanish to English\ntranslate = {'blolad': 'block',\n             'zocalo': 'socket',\n             'preb': 'cement',\n             'des': 'waste',\n             'mad': 'wood',\n             'zinc': 'zink',\n             'fibras': 'natural_fibers',\n             'other': 'other'}\ntrain = to_english(train, sp_pre='pared', eng_pre='wall_', \n                   translate=translate)\n\n# add material column\nmaterial = translate.values()\nfor mat in material:\n    is_mat = (train['wall_{}'.format(mat)] == 1)\n    train.loc[is_mat, 'wall_material'] = mat","7a573fe1":"_ = train.drop_duplicates('idhogar')\npd.crosstab(_['wall_material'], _['Target'], \n            normalize=True, margins=True).style.background_gradient(cmap='viridis', low=.5, high=0).format('{:.2%}')","a1e325c6":"# rename columns\ntranslate = { \n    'moscer': 'mosaic',\n    'cemento': 'cement',\n    'other': 'other',\n    'natur': 'natural',\n    'notiene': 'no_floor',\n    'madera': 'wood'\n}\ntrain = to_english(train, sp_pre='piso', eng_pre='floor_', translate=translate)\n\n# add material\nmaterial = translate.values()\nfor mat in material:\n    is_mat = (train['floor_{}'.format(mat)] == 1)\n    train.loc[is_mat, 'floor_material'] = mat","13c68054":"_ = train.drop_duplicates('idhogar')\npd.crosstab(_['floor_material'], _['Target'], \n            normalize=True, margins=True).style.background_gradient(cmap='viridis', low=.5, high=0).format('{:.2%}')","43b30393":"# rename columns\ntranslate = {\n     'zinc': 'zinc',\n     'entrepiso': 'fiber cement',\n     'cane': 'natural fibers',\n     'otro': 'other'\n}\ntrain = to_english(train, sp_pre='techo', eng_pre='roof_', translate=translate)\n# add material\nmaterial = translate.values()\nfor mat in material:\n    is_mat = (train['roof_{}'.format(mat)] == 1)\n    train.loc[is_mat, 'roof_material'] = mat","6867b510":"_ = train.drop_duplicates('idhogar')\npd.crosstab(_['roof_material'], _['Target'], \n            normalize=True, margins=True).style.background_gradient(cmap='viridis', low=.5, high=0).format('{:.2%}')","aa1fe376":"# rename columns \ntranslate = {\n    'guadentro': 'inside_house',\n    'guafuera': 'outside_house',\n    'guano': 'no'\n}\ntrain = to_english(train, sp_pre='abasta', eng_pre='water_provision_', \n                   translate=translate)\n\n# add water_provision category   \nfor cat in translate.values():\n    is_cat = (train['water_provision_{}'.format(cat)] == 1)\n    train.loc[is_cat, 'water_provision'] = cat","ac250194":"pd.crosstab(train['water_provision'], train['Target'], \n            normalize=True, margins=True).style.background_gradient(cmap='viridis', low=.5, high=0).format('{:.2%}')","91c63f64":"translate = {\n    'public': 'public',\n    'planpri': 'private_plan',\n    'noelec': 'no',\n    'coopele': 'cooperate'\n}\ntrain = to_english(train, sp_pre='', eng_pre='electric_', translate=translate)","e4f5e28f":"# refresh data\ntrain = pd.read_csv('..\/input\/train.csv')\nprint('Shape of train set {}'.format(train.shape))\ntest = pd.read_csv('..\/input\/test.csv')\nprint('Shape of test set {}'.format(test.shape))","860ebba6":"test['Target'] = np.nan\ndata_all = pd.concat([train, test])","f74c0d4e":"print('Shape of all data: {}'.format(data_all.shape))\nn_house = data_all['idhogar'].nunique()\nprint('# unique households in data: {}'.format(n_house))","5a41d07a":"is_head = (data_all.parentesco1 == 1)\nhead_df = data_all.loc[is_head, :]\nprint('Shape of head_df: {}'.format(head_df.shape))","fb11824d":"n_head = head_df['Id'].nunique()\nprint('# unique household heads: {}'.format(n_head))","a1df7504":"head_df.loc[head_df['male'] == 1, 'head_gender'] = 'male'\nhead_df.loc[head_df['female'] == 1, 'head_gender'] = 'female'\nprint('Shape of head_df: {}'.format(head_df.shape))","1cd24034":"def onehot_encode(cat_feat, data):\n    '''\n    Encode given categorical feature and add names of new binary columns into the set of features\n    :param cat_feat:\n    :param data:\n    :return:\n    '''\n    encoded = pd.get_dummies(data[cat_feat], prefix=cat_feat, dummy_na=True)\n    res = pd.concat([data.drop(columns=[cat_feat]), encoded], axis='columns')\n    return res","cedca9db":"# one-hot encode head gender\nhead_df = onehot_encode('head_gender', head_df)","ad1e87eb":"head_gender_feats = [cc for cc in head_df.columns if 'head_gender' in cc]\nhead_gender_feats","7b5850ea":"# convert binary edu levels to numeric values\nfor i in range(1, 10):\n    head_df.loc[head_df['instlevel{}'.format(i)] == 1, 'head_edu_level'] = i\n    \nprint(head_df.shape)","e8b669b2":"head_df = head_df.rename(columns={'escolari': 'head_school_years'})","31fd563d":"print(data_all.shape)","d927411a":"# as there are a few households with no head, we need an outer join \n# to avoid missing those houses\ncols = ['idhogar', 'head_school_years', 'head_edu_level'] + head_gender_feats\ndata_all = pd.merge(data_all, head_df[cols], how='outer', on='idhogar')\nprint(data_all.shape)","bf1674b1":"house_head_feats = ['head_school_years', 'head_edu_level'] + head_gender_feats\nhouse_head_feats","e506a83c":"data_all = add_quality(data_all, componente='pared', component='wall')\ndata_all = add_quality(data_all, componente='techo', component='roof')\ndata_all = add_quality(data_all, componente='viv', component='floor')\nprint(data_all.shape)","9e9e6ef5":"# wall\ntranslate = {'blolad': 'block',\n             'zocalo': 'socket',\n             'preb': 'cement',\n             'des': 'waste',\n             'mad': 'wood',\n             'zinc': 'zink',\n             'fibras': 'natural_fibers',\n             'other': 'other'}\ndata_all = to_english(data_all, sp_pre='pared', eng_pre='wall_', \n                   translate=translate)","d6c5d046":"wall_feats = [cc for cc in data_all.columns if 'wall_' in cc]\nwall_feats","af09d303":"# floor\ntranslate = { \n    'moscer': 'mosaic',\n    'cemento': 'cement',\n    'other': 'other',\n    'natur': 'natural',\n    'notiene': 'no_floor',\n    'madera': 'wood'\n}\ndata_all = to_english(data_all, sp_pre='piso', eng_pre='floor_', translate=translate)","1b1b54c4":"floor_feats = [cc for cc in data_all.columns if 'floor_' in cc]\nfloor_feats","bbce0297":"# roof\ntranslate = {\n     'zinc': 'zinc',\n     'entrepiso': 'fiber cement',\n     'cane': 'natural fibers',\n     'otro': 'other'\n}\ndata_all = to_english(data_all, sp_pre='techo', eng_pre='roof_', translate=translate)","cb9dcd26":"roof_feats = [cc for cc in data_all.columns if 'roof_' in cc]\nroof_feats","59a996d3":"print(data_all.shape)","aa25f6b5":"material_feats = roof_feats + wall_feats + floor_feats\nmaterial_feats","4bf38684":"# water\ntranslate = {\n    'guadentro': 'inside_house',\n    'guafuera': 'outside_house',\n    'guano': 'no'\n}\ndata_all = to_english(data_all, sp_pre='abasta', eng_pre='water_provision_', \n                   translate=translate)\n\nwater_feats = [cc for cc in data_all.columns if 'water_provision_' in cc]","87a6891a":"# electricity\ntranslate = {\n    'public': 'public',\n    'planpri': 'private_plan',\n    'noelec': 'no',\n    'coopele': 'cooperate'\n}\ndata_all = to_english(data_all, sp_pre='', eng_pre='electric_', translate=translate)","37290572":"elec_feats = [cc for cc in data_all.columns if 'electric_' in cc]","df8e1abd":"# energy\ntranslate = {\n    'cinar1': 'no',\n    'cinar2': 'electricity',\n    'cinar3': 'gas',\n    'cinar4': 'charcoal'\n}\ndata_all = to_english(data_all, sp_pre='energco', eng_pre='energy_', translate=translate)","fbd1bf5a":"energy_feats = [cc for cc in data_all.columns if 'energy_' in cc]\nenergy_feats","4793dc93":"# toilet\ntranslate = {\n    '1': 'no',\n    '2': 'sewer',\n    '3': 'septic_tank',\n    '5': 'black hole',\n    '6': 'other'\n}\ndata_all = to_english(data_all, sp_pre='sanitario', eng_pre='toilet_', translate=translate)","8fce2880":"toilet_feats = [cc for cc in data_all.columns if 'toilet_' in cc]\ntoilet_feats","8513669d":"# rubbish\ntranslate = {\n    '1': 'tanker truck',\n    '2': 'buried',\n    '3': 'burning',\n    '4': 'throw empty place',\n    '5': 'throw to river',\n    '6': 'other'\n}\ndata_all = to_english(data_all, sp_pre='elimbasu', eng_pre='rubbish_', translate=translate)","682f087f":"rubbish_feats = [cc for cc in data_all.columns if 'rubbish_' in cc]\nrubbish_feats","f3966483":"facility_feats = water_feats + elec_feats + energy_feats + toilet_feats + rubbish_feats","934c57cb":"features = house_head_feats + material_feats + facility_feats + basic_feats\nprint('# features: {}'.format(len(features)))","f308fbfd":"# prepare train and test sets, valid maybe\nfrom sklearn.model_selection import train_test_split, GridSearchCV\nfrom sklearn.metrics import get_scorer","57527e0c":"cols = ['Id'] + features + ['Target']\ntrain = data_all.loc[data_all['Target'].notnull(), cols]\nX_train, y_train = train[features], train['Target']\n\ntest = data_all.loc[data_all['Target'].isnull(), cols]\nX_test = test[['Id'] + features]","d43988b4":"import lightgbm as lgb","e789beac":"gbm = lgb.LGBMRegressor(n_jobs=2, random_state=0)\nparam_grid = {'num_leaves': np.arange(10, 50, 10), \n              'learning_rate': np.arange(0.05, 0.2, 0.05),\n             'n_estimators': np.arange(10, 25, 5)}\nscoring = {'mse': get_scorer('neg_mean_squared_error')}\nmetric = 'mse'","1ac1cb94":"# train and param tuning\ngs = GridSearchCV(gbm,\n                  param_grid=param_grid,\n                  scoring=scoring,\n                  cv=5,\n                  refit=metric,\n                  verbose=True)\ngs.fit(X_train, y_train)","eff216a7":"# dump model\nbest_estimator = gs.best_estimator_\n# json_model = best_estimator.dump_model('model.json')","3de62324":"# predict\ny_pred = best_estimator.predict(X_test[features])","438485b8":"round_pred = round_to_nearest_int(y_pred)\nsubmit = pd.DataFrame({'Id': X_test['Id'], 'Target': round_pred})","dae12937":"submit.to_csv('submisssion.csv', index=False)","00f2aa89":"# feature importance\nprint('Feature importances:', list(best_estimator.feature_importances_))","e4e3dd7d":"`Target` has _positive_ correlation with these interior features, though not very large.","295d139e":"### add quality features","6e346435":"# Material of the house\nWe will explore if there is any relationship between `target` and:\n* quality of wall, roof and floor\n* material of wall, roof and floor","e419c362":"## Helpers\nFirst are some helper functions.","83e29294":"The number of household heads is a bit smaller than the number of households, meaning there are a few households with no heading members :).","c7df6dfe":"# Facility\nWe explore facilities such as water, electricity and their relationships with `target`.","bb0865e5":"## Light GBM with grid search","a554203a":"## Material of interior\n\nAs material is already one-hot encoded with common format: \n\n`{componente}{material}=1`, \n\nwe only need to translate them into English for easier understanding.","5f1387d1":"## Electricity\nformat: `{category}`.\n","1668d760":"Now we are ready to look at correlation of basic features with target variable.","f70bab66":"## Facility","0137499d":"## Education level","391036ee":"# Household basic features\nWe will look at correlations of the basic features such as number of rooms,  overcrowding, number of family members (kids, adult and seniors). An interesting feature is  _dependency rate_, which is the rate of non-working members (kids and seniors) over the number of members in working age (adults).\n\nAlthough _dependency rate_ is there in data, the column has mixing type with both text and numeric values. We thus need to re-compute this via funciton `cal_dependency_rate`.","4d446a8a":"Most households already have water provision inside house. But in better houses (target=4 or 3), inside  water is more dominant than outside house.","b028c09d":"As expected, the house is in `extreme poverty` status.","2b4a0aad":"## Merge data of household heads","0e624a27":"## gender","f9552caa":"### Rename material columns","f9e94f91":"`Target` has positive correlations with all these education features, though not very large.","6c23f248":"Most households have mosaic or cement floor. However, the best households are dominated by mosaic floor (5 times more than cement floor).","358d9e5e":"The plot shows that `Target` has significant:\n* __negative __correlation with:\n    * number of kids\n    * dependency rate\n    * overcrowding\n* __positive__ correlation with:\n    * number of adults\n    * number of rooms\/bedrooms\n\nThese are expected as the higher dependency rate, the heavier burden the family has, thus the worse poverty status.","f779409d":"Roof material is dominated by _zinc_, with no clear relationship with `target`.","ebc94117":"# Transforming & merging data","7f2cbdfe":"# Head of household\nNow we explore features of the head of household, who are marked by `parentesco1 =1`.","d2f6f333":"## Quality of wall, roof and floor\n\nFrom data description, the quality of wall, roof and floor are all measured by three levels (1: bad, 2: regular, 3: good). Their names also have a common format: `e{component}{level}` where `component` is wall, roof or floor in Spanish (e.g. `epared1`, `epared2`, `epared3`). This allows us to define a common function to handle all of them.","9f94ec3e":"Note that the number of house heads is a bit smaller than the number of households, thus there are a few houses with no leader. We may want to have a look at these edge cases later.","5238285b":"### Education vs. Financial Status","102677dc":"The correlation is significantly positive, which is expected as a more educated household head is more likely to get the family to a better financial status.","92ea02b5":"### Wall","8fda2119":"# Light GBM on a minimal set of features","644b669a":"## Gender of household head","b9bca2c9":"### Round predictions as target is integer","7edfcc1b":"This kernel aims at providing useful insights such as:\n* which variables have significant correlation with target\n\nThe kernel will not cover basic things such as target distribution, number of null values in each column, which are already covered by other kernels.\n\nThis kernel is still in progress and will be updated regularly.","99b09643":"## Add gender and education level of household head","971f75c5":"### Floor","775cb821":"## House material","1235a6ae":"75% of households have dependency rate not exceeding 1, meaning that the number of dependent members are no more than that of working-age members. There is some extreme case where the rate is 8, which seems to put a terrible burden on working members of that household. Let us check  that house's `target` value.","c0613b1a":"### Roof","0eb41c1a":"## education level","e045ad25":"It seems that when household head is male, the house is better in financial status (no gender discrimination here). ","14a6a63d":"Most households have walls in block or cement.  However, the best households (`target`=4) are dominated by block walls, which are more than 4 times of cement walls, the second in place.","fd165135":"## Water\ncommon format: `abasta{category}` where `category` is in [guadentro, guafuera, guano]."}}