{"cell_type":{"3cc073e0":"code","60aae3e6":"code","4682634f":"code","29fdb75a":"code","e042c225":"code","1c6b646e":"code","03659543":"code","1edd5fb4":"code","b9cebaff":"code","5f6c9d4f":"code","cfa2f47e":"code","ae920d6f":"code","3cc3166c":"code","24ec7d94":"code","ea754fdd":"code","b8af4843":"code","dcfc2175":"code","3b498de0":"code","c316eb02":"code","e3978515":"code","bbd52a88":"code","183ae3a5":"code","60568bc2":"code","fd72bc52":"code","bee9d198":"code","d442a454":"code","3a1c0b47":"code","0d46e636":"code","f1a1d28a":"code","d39f1433":"code","8940f59c":"code","63785c81":"code","88475280":"code","86169874":"code","73bf2551":"code","126e7638":"markdown","32a39be4":"markdown","d323ecd1":"markdown","b9ceaa8c":"markdown","ff570acc":"markdown","2d9d8910":"markdown","235cf7f1":"markdown","2b621978":"markdown","7e0b1227":"markdown","cdcf724f":"markdown","3fc13661":"markdown","0c29e715":"markdown","8886ae5f":"markdown","44e308d3":"markdown","8835fe33":"markdown","65aac2eb":"markdown","30abce14":"markdown","85aabee3":"markdown","f25eb76b":"markdown","e72e08dd":"markdown","44a8ccf1":"markdown","034221d1":"markdown","bd0ddd7e":"markdown","b89160e5":"markdown","f8e3fa65":"markdown","bc687f07":"markdown","18f83655":"markdown","68844121":"markdown","b7908cc6":"markdown","37e1f03f":"markdown","8ca1fcb1":"markdown","38789661":"markdown","77dd00f3":"markdown","c7d5cbeb":"markdown"},"source":{"3cc073e0":"import pandas as pd\nimport matplotlib.pyplot as plt\nimport seaborn as sns\nimport numpy as np\nfrom sklearn.preprocessing import LabelEncoder\nfrom sklearn.model_selection import train_test_split, cross_val_score, cross_val_predict, StratifiedKFold, KFold, RandomizedSearchCV, GridSearchCV, cross_validate\nfrom sklearn.metrics import mean_squared_error, roc_auc_score, accuracy_score\nfrom sklearn.ensemble import RandomForestClassifier, GradientBoostingClassifier, ExtraTreesClassifier, VotingClassifier\nfrom sklearn.svm import SVC\nimport xgboost as xgb\n\npd.set_option('display.max_rows', None)\npd.set_option('display.max_columns', None)\n\nSEED = 42\nNFOLDS = 10\n\ntrain_ = pd.read_csv(\"..\/input\/titanic\/train.csv\")\ntest_ = pd.read_csv(\"..\/input\/titanic\/test.csv\")","60aae3e6":"test = test_.copy()\ntrain = train_.copy()\ntest_train = pd.concat([test, train], sort=False)\ntrain.head()","4682634f":"def extract_title(x):\n    return x.split(', ')[1].split(\". \")[0].strip()","29fdb75a":"for dataset in [train, test, test_train]:\n    dataset[\"Title\"] = dataset[\"Name\"].apply(extract_title)","e042c225":"def extract_last_name(x):\n    return x.split(\",\")[0].strip()","1c6b646e":"for dataset in [train, test, test_train]:\n    dataset[\"LastName\"] = dataset[\"Name\"].apply(extract_last_name)","03659543":"for dataset in [train, test, test_train]:\n    dataset[\"Age\"] = dataset[\"Age\"].fillna(99)","1edd5fb4":"for dataset in [train, test, test_train]:\n    dataset[\"Fare\"] = dataset[\"Fare\"].fillna(0)","b9cebaff":"for dataset in [train, test, test_train]:\n    dataset[\"Embarked\"] = dataset[\"Embarked\"].fillna(dataset[\"Embarked\"].mode()[0])","5f6c9d4f":"for dataset in [train, test, test_train]:\n    dataset[\"FamilySize\"] = dataset[\"SibSp\"] + dataset[\"Parch\"] + 1\n    \nsns.catplot(x=\"FamilySize\", y=\"Survived\", data=train, kind=\"bar\")\nplt.show()","cfa2f47e":"for dataset in [train, test, test_train]:\n    dataset[\"IsSolo\"] = dataset[\"FamilySize\"] == 1\n\nsns.catplot(x=\"IsSolo\", y=\"Survived\", data=train, kind=\"bar\")\nplt.show()","ae920d6f":"for dataset in [train, test, test_train]:\n    dataset[\"FamilyGroup\"] = dataset[\"Pclass\"].astype(str) + \" - \" + dataset[\"Ticket\"].str[:-1] + \" - \" + dataset[\"Embarked\"] + \" - \" + dataset[\"Fare\"].astype(str)\n    dataset[\"FamilyGroupOld\"] = dataset[\"LastName\"] + \" - \" + dataset[\"Ticket\"].str[:-1]","3cc3166c":"train.loc[train[\"LastName\"] == \"Andersson\"]","24ec7d94":"train.loc[train[\"FamilyGroup\"] == \"3 - 34708 - S - 31.275\"]","ea754fdd":"train.loc[train[\"LastName\"] == \"Vander Planke\"]","b8af4843":"train[train[\"Title\"] == \"Master\"].head()","dcfc2175":"masters = train.loc[(train[\"Title\"] == \"Master\") & (train[\"Age\"] != 99)]\nsns.distplot(masters[\"Age\"].dropna(), bins=7)\nplt.ylabel(\"Density\")\nplt.show()","3b498de0":"masters[\"Age\"].describe()","c316eb02":"boys_without_master = train.loc[(train[\"Age\"] < 18) & (train[\"Sex\"] == \"male\") & (train[\"Title\"] != \"Master\")]\nboys_without_master","e3978515":"len(boys_without_master)","bbd52a88":"test_train_group_count = test_train.loc[(test_train[\"Sex\"] == \"female\") | (test_train[\"Title\"] == \"Master\")].groupby(\"FamilyGroup\").count()[[\"PassengerId\"]].sort_index()\ntest_train_group_count.columns = [\"Train + Test Count\"]\n\ntrain_group_count = pd.merge(train.loc[(train[\"Sex\"] == \"female\") | (train[\"Title\"] == \"Master\")].groupby(\"FamilyGroup\").count()[[\"PassengerId\"]], \n                             train.loc[(train[\"Sex\"] == \"female\") | (train[\"Title\"] == \"Master\")].groupby(\"FamilyGroup\").sum()[[\"Survived\"]], how=\"inner\", on=\"FamilyGroup\")\ntrain_group_count.columns = [\"Train Count\", \"Survived\"]\n\ntest_group_count = test.loc[(test[\"Sex\"] == \"female\") | (test[\"Title\"] == \"Master\")].groupby(\"FamilyGroup\").count()[[\"PassengerId\"]].sort_index()\ntest_group_count.columns = [\"Test Count\"]","183ae3a5":"groups = pd.merge(pd.merge(test_train_group_count, train_group_count, how=\"left\", on=\"FamilyGroup\"), test_group_count, how=\"left\", on=\"FamilyGroup\")\ngroups[\"Train Survival Rate\"] = groups[\"Survived\"] \/ groups[\"Train Count\"]\ngroups = groups.reset_index()\ngroups.head()","60568bc2":"temp = test_train.sort_values(by=\"Ticket\")\nfg_counts1 = temp.groupby(\"FamilyGroup\").count().iloc[:,0]\nfg_counts2 = temp.groupby(\"FamilyGroupOld\").count().iloc[:,0]\n\nfg_comparison = pd.merge(pd.merge(temp[[\"PassengerId\", \"FamilyGroup\", \"FamilyGroupOld\"]], fg_counts1, on=\"FamilyGroup\", how=\"left\"), fg_counts2, on=\"FamilyGroupOld\", how=\"left\")\nfg_comparison.columns = [\"PassengerId\", \"FamilyGroup\", \"FamilyGroupOld\", \"CountFamilyGroup\", \"CountFamilyGroupOld\"]\nfg_comparison[\"CountFamilyGroup\"] = fg_comparison[\"CountFamilyGroup\"].astype(int)\nfg_comparison = fg_comparison.sort_values(by=\"FamilyGroup\")\nfg_comparison[fg_comparison[\"CountFamilyGroup\"] != fg_comparison[\"CountFamilyGroupOld\"]].head()","fd72bc52":"train[train[\"FamilyGroup\"] == \"1 - 11081 - C - 75.25\"]","bee9d198":"train[train[\"FamilyGroup\"] == \"1 - 11378 - S - 151.55\"]","d442a454":"familygroups = groups[groups[\"Train + Test Count\"] > 1][[\"FamilyGroup\"]]\nfamilygroups.head()","3a1c0b47":"families = groups[groups[\"FamilyGroup\"].isin(familygroups[\"FamilyGroup\"])]\nfamilies.head()","0d46e636":"test_males_xmasters_ids = test.loc[(test[\"Sex\"] == \"male\") & (test[\"Title\"] != \"Master\")][\"PassengerId\"]\ntest_females_masters_ids = test.loc[(test[\"Sex\"] == \"female\") | (test[\"Title\"] == \"Master\")][\"PassengerId\"]","f1a1d28a":"test_males_xmasters_preds = pd.DataFrame({\"PassengerId\": test_males_xmasters_ids, \"Survived\": np.zeros(len(test_males_xmasters_ids), dtype=int)})\ntest_males_xmasters_preds.head()","d39f1433":"len(test_males_xmasters_preds)","8940f59c":"test_females_masters = test.loc[test[\"PassengerId\"].isin(test_females_masters_ids)]\ntest_females_masters_rates = pd.merge(test_females_masters, groups, how=\"left\", on=\"FamilyGroup\")[[\"PassengerId\", \"FamilyGroup\", \"Sex\", \"Age\", \"Train + Test Count\", \"Train Count\", \"Survived\", \"Train Survival Rate\"]]\ntest_females_masters_rates[\"Train Survival Rate\"].fillna(-1, inplace=True)\ntest_females_masters_rates.head()","63785c81":"test_females_masters_rates[\"Prediction\"] = np.zeros(len(test_females_masters_rates), dtype=int)\ntest_females_masters_rates.loc[(test_females_masters_rates[\"Sex\"] == \"female\"), \"Prediction\"] = 1\ntest_females_masters_rates.loc[(test_females_masters_rates[\"Train Survival Rate\"] >= 0.5), \"Prediction\"] = 1\ntest_females_masters_rates.loc[(test_females_masters_rates[\"Train Survival Rate\"] < 0.5) & (test_females_masters_rates[\"Train Survival Rate\"] != -1), \"Prediction\"] = 0\ntest_females_masters_rates.head()","88475280":"test_females_masters_preds = test_females_masters_rates[[\"PassengerId\", \"Prediction\"]]\ntest_females_masters_preds.columns = [\"PassengerId\", \"Survived\"]\noutput = pd.concat([test_males_xmasters_preds, test_females_masters_preds]).sort_values(by=\"PassengerId\")\noutput.to_csv(\"submission.csv\", index=False)\noutput.head()","86169874":"np.sum(output[\"Survived\"])","73bf2551":"len(test[test[\"Sex\"] == \"female\"])","126e7638":"The maximum age of passengers with the title \"Master\" is 14 (in the training dataset).","32a39be4":"Thanks so much for reading. I had a lot of fun exploring this strategy and have a few ideas for using a simple decision tree model to generate predictions for the female + master population. If I have any success, I will create a new notebook :)\n\nPlease leave a comment below with your thoughts and ideas to improve the women-child-group strategy.\n\nUntil next time, happy coding.","d323ecd1":"**Embarked**","b9ceaa8c":"### Creating a Submission Output","ff570acc":"As mentioned above, I originally constructed FamilyGroup using passenger last name. However there were a handful of occasions when this resulted in individuals being left out of groups because they had a different last name. For this reason, I selected a different grouping method using Ticket, Embarked and Fare. Below is a comparison of the number of passengers in each new FamilyGroup compared to the original method.","2d9d8910":"We can look at passengers by last name to verify our FamilyGroup feature.","235cf7f1":"**Solo Travelers**","2b621978":"**Title**","7e0b1227":"We're ready to make predictions using our model.\n\nFirst, all males without the title \"Master\" are predicted to die.","cdcf724f":"Greetings! This notebook outlines a somewhat different approach to creating a predictive model using the Titanic dataset.\n\nAfter trying (and failing) to score higher than ~78% using numerous variations of stacked ensembles, I decided to take a step back. Increasing complexity was obviously not increasing model accuracy. Perhaps if I better understood the problem and increased my domain knowledge, I would have a better chance of moving up the leaderboard.\n\nI stumbled across an interesting notebook by [Chris Deotte](https:\/\/www.kaggle.com\/cdeotte) in which he creates a relatively high-scoring model using the Name feature alone: [Titanic using Name only](https:\/\/www.kaggle.com\/cdeotte\/titanic-using-name-only-0-81818). Although parsing his R code was a bit of a challenge, Chris' commentary was extremely clear and logical. The basic premise is that we can infer family groups based on passenger last name, which is extracted from the Name field. Survival within these so-called \"woman-child-groups\" is almost always binary - either all members of the WCG die or all survive. Therefore, if a test case is presented for which we can determine family group status, we should predict survival based on the survival of the family group. Using this group-based strategy in conjunction with the baseline gender-based model in which all men die and all females survive results in an accuracy in the low 80%s. Having spent ages trying to perfect a more complicated stacked ensemble with no improvement, I decided to explore Chris' ideas and implement them in Python. Who knows, maybe I could find an enhancement or two!","3fc13661":"An important part of the grouping strategy is identifying the young boys who traveled with female passengers. These individuals are given the title \"Master\".","0c29e715":"Are there any young men that do not have the title \"Master\"?","8886ae5f":"**Masters**","44e308d3":"### Setup","8835fe33":"That's it! Let's generate a submission output.","65aac2eb":"**Last Name**","30abce14":"### Conclusion","85aabee3":"**Age**","f25eb76b":"**Family Size**","e72e08dd":"### Generating Predictions","44a8ccf1":"Now let's look at FamilyGroup \"1 - 11378 - S - 151.55\" - there should be 4 passengers in the training set, 2 of whom survived:","034221d1":"I decided to add several new features to the dataset to use as diagnostics when grouping families. I've noticed that many notebooks mention how SibSp and Parch are inaccurate, so we'll take any metrics based on these features with a grain of salt.","bd0ddd7e":"In our model, families consist of 2 or more females + masters who share the same FamilyGroup. Let's count the number of such individuals in our training, test and combined dataset. We can then calculate the training survival rate.","b89160e5":"It looks like our counts are correct. Now we can filter for groups of 2 or more passengers.","f8e3fa65":"Let's double check a few family groups to make sure our counting is correct.\n\nFiltering for FamilyGroup \"1 - 11081 - C - 75.25\" - there should be 1 passenger in the training set who survived:","bc687f07":"Next, all females and males with the title \"Master\" follow the fortunes of their group members. If survival rate for the group is greater than 50%, test cases are predicted to survive.","18f83655":"The first thing I wondered is whether the title \"Master\" was only given to young boys. What is the distribution of ages of passengers with the title \"Master\"?","68844121":"As we see, there are 29 young males in the training set who are under 18 years of age but do not have the title \"Master\". We might consider broadening our definition of \"boy\" to include these individuals.","b7908cc6":"### Data Preprocessing","37e1f03f":"**Potential Families**","8ca1fcb1":"We're predicting that 150 individuals survived. Note that this is not the same number of total females in the test dataset, hence our group model has deviated slightly from the baseline gender model.","38789661":"## Titanic - Simple Gender + Family Group Model","77dd00f3":"**Family Groups**\n\nWe can observe that, in general, family groups share a last name, a ticket number and fare amount. However, in some cases, the last digit of the ticket number varies within family groups (ex: Vander Planke family) and occasionally the fare amounts don't match. Deciding how to group families is critical for this strategy to be effective.\n\nOn my first pass, I constructed FamilyGroup using Last Name + Ticket[:-1] (ignoring Fare). This model produced a LB score in the low 80%s. I've left the code in, below, for clarity - labeled FamilyGroupOld.\n\nOn my second pass, I constructed FamilyGroup using Pclass + Ticket[:-1] + Embarked + Fare. This model produced a LB score in the low 81%s. More analysis is needed to determine whether this feature misses any of the information of the original last name-based version. Perhaps both methods should be used in conjuction?","c7d5cbeb":"**Fare**"}}