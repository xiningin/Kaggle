{"cell_type":{"d97b6d66":"code","fc374270":"code","d10d376f":"code","f0e89523":"code","6cd3b62e":"code","6c13b0cd":"code","124d797e":"code","ce6d37fc":"code","7fa4048a":"code","e847beea":"code","303120bc":"code","f08f4cee":"code","0926dca1":"code","ad963617":"code","4ea07fce":"code","a286e3e8":"code","d379e8a8":"code","d64ca673":"code","8e97aab5":"code","846727d7":"code","d928578c":"code","ee4b6dc6":"code","4e22460f":"code","1ac41490":"code","d7dc52cd":"code","08e74a02":"code","995ea197":"code","5d8dad09":"code","49fcfd5c":"code","cdca7bbc":"code","cc6f55ed":"code","e93694ea":"code","fb6f128b":"code","739023cd":"code","c43e38df":"code","c0b97efd":"code","8367cad3":"code","c091c628":"markdown","e28da77a":"markdown","cddfea00":"markdown","a5b22edb":"markdown","c4a160f1":"markdown","bf523de8":"markdown","81d70683":"markdown","68191a85":"markdown","3636a3b0":"markdown","cd3aad25":"markdown","9eb54a33":"markdown","bd3d9f4e":"markdown","dba02343":"markdown","6183576e":"markdown","7c9f05d0":"markdown","573372fe":"markdown","54dc6b83":"markdown","09475e3a":"markdown","41a41f72":"markdown","6afbd210":"markdown","7f7f59f9":"markdown","467a1b06":"markdown","af271bdd":"markdown","61bd3b59":"markdown","655550ee":"markdown","6a7a5f9b":"markdown","7329e77d":"markdown","2acd9a1c":"markdown","7566e395":"markdown","9281351b":"markdown","e85cad57":"markdown","dd26ee11":"markdown","86b2c015":"markdown","b1f6d5f2":"markdown","e9922981":"markdown","ed76ac1f":"markdown","9aaf04ec":"markdown"},"source":{"d97b6d66":"# This Python 3 environment comes with many helpful analytics libraries installed\n# It is defined by the kaggle\/python Docker image: https:\/\/github.com\/kaggle\/docker-python\n# For example, here's several helpful packages to load\n\nimport numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\n\n# Input data files are available in the read-only \"..\/input\/\" directory\n# For example, running this (by clicking run or pressing Shift+Enter) will list all files under the input directory\n\nimport os\nfor dirname, _, filenames in os.walk('\/kaggle\/input'):\n    for filename in filenames:\n        print(os.path.join(dirname, filename))\n\n# You can write up to 5GB to the current directory (\/kaggle\/working\/) that gets preserved as output when you create a version using \"Save & Run All\" \n# You can also write temporary files to \/kaggle\/temp\/, but they won't be saved outside of the current session","fc374270":"import numpy as np\nimport keras\nfrom keras.datasets import mnist\nfrom keras.utils import to_categorical\nfrom keras.models import Sequential\nfrom keras.layers import Dense, Conv2D, Flatten, Activation, Dropout, MaxPooling2D\nimport matplotlib.pyplot as plt\n","d10d376f":"# Download the MNIST dataset and partition train \/ test\n(x_train_orig, y_train_orig), (x_test_orig, y_test_orig) = mnist.load_data()","f0e89523":"# Checking an example\nfirst_image = x_train_orig[0]\nfirst_image = np.array(first_image, dtype='float')\npixels = first_image.reshape((28, 28))\nplt.imshow(pixels, cmap='gray')\nplt.show()","6cd3b62e":"# Shape\nx_train_orig[0].shape","6c13b0cd":"print('Training data shape : ', x_train_orig.shape, y_train_orig.shape)\n\nprint('Testing data shape : ', x_test_orig.shape, y_test_orig.shape)\n","124d797e":"nRows, nCols, nDims = x_train_orig.shape\ninput_shape = (nRows, nCols, nDims)\nx_train = x_train_orig.reshape(60000, nCols, nDims, 1)\nx_test = x_test_orig.reshape(10000, nCols, nDims, 1)","ce6d37fc":"print(nRows, nCols, nDims, 1)","7fa4048a":"x_train = x_train \/ 255\nx_test = x_test \/ 255\n\nnum_classes = 10\ny_train = to_categorical(y_train_orig, num_classes)\ny_test = to_categorical(y_test_orig, num_classes)","e847beea":"y_train[5]","303120bc":"num_classes = 10\n\nmodel = Sequential()\n\nmodel.add(Conv2D(32, kernel_size=(3, 3),\n                 activation='relu',\n                 input_shape=(28,28,1)))\nmodel.add(Conv2D(64, (3, 3), activation='relu'))\nmodel.add(Flatten())\nmodel.add(Dense(num_classes, activation='softmax'))","f08f4cee":"model.compile(optimizer='adam', loss='categorical_crossentropy', metrics=['accuracy'])","0926dca1":"#Entrenamiento del modelo\nn_epochs_onelayer = 9\nmfit_onelayer = model.fit(x_train, y_train,\n                              epochs=n_epochs_onelayer,\n                              verbose=1,\n                              validation_data=(x_test, y_test))\n\nscore = model.evaluate(x_test, y_test, verbose=0)\nprint('Test loss:', score[0])\nprint('Test accuracy:', score[1])","ad963617":"# plot del training loss y el accuracy\ndef plot_prediction(n_epochs, mfit):\n\n    # Plot training & validation loss values\n    plt.plot(mfit.history['loss'])\n    plt.plot(mfit.history['val_loss'])\n    title = 'Model loss (' + str(n_epochs) + ' epochs)'\n    plt.title(title)\n    plt.ylabel('Loss')\n    plt.xlabel('Epoch')\n    plt.legend(['Train', 'Test'], loc='upper left')\n    plt.show()\n    \n    return plt","4ea07fce":"plot_prediction(n_epochs_onelayer, mfit_onelayer)","a286e3e8":"mfit_onelayer","d379e8a8":"# Hacemos la predicci\u00f3n para las 4 primeras im\u00e1genes del set de test\nprint(model.predict(x_test[:4]))\n\n# Mostramos el ground truth para las primeras 4 im\u00e1genes\ny_test[:4]","d64ca673":"y_train = to_categorical(y_train_orig)\ny_test = to_categorical(y_test_orig)","8e97aab5":"def creaModeloRedNeuronalProfunda():\n    num_classes = 10\n\n    model = Sequential()\n\n    ##TODO: A\u00f1adir las capas\n    model.add(Conv2D(32, kernel_size=(3, 3),\n                 activation='relu',\n                 input_shape=(28,28,1)))\n    model.add(Conv2D(64, (3, 3), padding='valid', activation='relu'))\n    model.add(Dropout(0.25))\n    model.add(Flatten())\n    model.add(Dense(128, activation='relu'))\n    model.add(Dropout(0.5))\n    model.add(Dense(num_classes, activation='softmax'))\n    \n    return model\n","846727d7":"batch_size = 128\nn_epochs = 12 \n\ndeep_model = creaModeloRedNeuronalProfunda()\n\ndeep_model.compile(optimizer='adadelta',\n                   loss='categorical_crossentropy',\n                   metrics=['accuracy'])\n\ndeep_model.summary()","d928578c":"mfit = deep_model.fit(x_train, y_train, batch_size=batch_size, epochs=n_epochs, verbose=1, \n                   validation_data=(x_test, y_test))\n\n\n# Evaluation in test\nscore = model.evaluate(x_test, y_test, verbose=0)\nprint('Test loss:', score[0])\nprint('Test accuracy:', score[1])\n","ee4b6dc6":"# Visualizci\u00f3n de la evoluci\u00f3n de la m\u00e9trica accuracy\nplot_prediction(n_epochs, mfit)","4e22460f":"# Prediction\nprint(model.predict(x_test[:4]))\ny_test[:4]","1ac41490":"x_train = x_train_orig[:, ::2, ::2]\nx_test = x_test_orig[:, ::2, ::2]","d7dc52cd":"# Normalizamos los valores de los p\u00edxeles\nx_train = x_train \/ 255.0\nx_test = x_test \/ 255.0\n\ny_train = x_train_orig \/ 255.0\ny_test = x_test_orig \/ 255.0\n\n# Ajustamos las dimensiones de los datos\nx = np.expand_dims(x_train, axis=3)\ny = np.expand_dims(y_train, axis=3)\n\nx_test_final = np.expand_dims(x_test, axis=3)\ny_test_final = np.expand_dims(y_test, axis=3)","08e74a02":"y_test.shape\n","995ea197":"y.shape","5d8dad09":"def creaModeloRedNeuronalConvolucional():\n    num_classes = 10\n\n    model = Sequential()\n\n    # Add layer  \n    model.add(Conv2D(32, kernel_size=(3, 3), padding='same', activation='relu', input_shape=(14, 14, 1)))    \n    model.add(MaxPooling2D(pool_size=(2,2)))\n    model.add(Conv2D(32, (3, 3), padding='same', activation='relu'))\n    # deconvolutional layer\n    model.add(keras.layers.Conv2DTranspose(32, (3, 3), strides=(2, 2), padding='same', activation='relu'))\n    model.add(keras.layers.Conv2DTranspose(1, (3, 3), strides=(2, 2), padding='same', activation='sigmoid'))\n    \n    return model","49fcfd5c":"# Model creation\nconvolutional_network = creaModeloRedNeuronalConvolucional()\n\nconvolutional_network.summary()","cdca7bbc":"#Entrenar y compilar el modelo\nconvolutional_network.compile(loss='binary_crossentropy',\n              optimizer='Adadelta',\n              metrics=['accuracy'])","cc6f55ed":"n_epochs = 12 \nconvolutional_network.fit(x, y, epochs=n_epochs, validation_data=(x_test_final, y_test_final))","e93694ea":"# Predicci\u00f3n de tres im\u00e1genes del conjunto de test\nn_images = 3\nidx_images = np.random.randint(x_test.shape[0], size=n_images)\n\nimages = np.expand_dims(np.stack([x_test[i] for i in idx_images]), axis=3)\n\npred = convolutional_network.predict(images)\n","fb6f128b":"# Ajustamos las dimensiones de las im\u00e1genes predichas al formato adecuado y desnormalizamos los p\u00edxeles\npred = np.squeeze(pred)\npred = pred * 255.0","739023cd":"def drawImage(i, pred, alto, ancho):\n  #Visualizamos la imagen i del dataset\n  first_image = pred[i]\n  first_image = np.array(first_image, dtype='float')\n  pixels = first_image.reshape((alto, ancho))\n  plt.imshow(pixels, cmap='gray')\n  plt.show()","c43e38df":"#Visualizamos la primera imagen \ndrawImage(0, images, 14, 14)\ndrawImage(0, pred, 28, 28)\n","c0b97efd":"#Visualizamos la segunda imagen \ndrawImage(1, images, 14, 14)\ndrawImage(1, pred, 28, 28)\n","8367cad3":"#Visualizamos la tercera imagen \ndrawImage(2, images, 14, 14)\ndrawImage(2, pred, 28, 28)","c091c628":"<div style=\"background-color: #EDF7FF; border-color: #7C9DBF; border-left: 5px solid #7C9DBF; padding: 0.5em;\">\n<strong>Model construction<\/strong>\n<\/div>","e28da77a":"And we normalize the pixel values and adjust the dimensions of the data:","cddfea00":"<div style=\"background-color: #EDF7FF; border-color: #7C9DBF; border-left: 5px solid #7C9DBF; padding: 0.5em;\">\nVisualize the evolution of accuracy in the training and test set according to the times.\n<\/div>","a5b22edb":"<div style=\"background-color: #EDF7FF; border-color: #7C9DBF; border-left: 5px solid #7C9DBF; padding: 0.5em;\">\n<strong>Ejercicio [1 pto.]:<\/strong> Visualizar tres im\u00e1genes al azar del conjunto de test. Mostrar la versi\u00f3n original de la imagen, la versi\u00f3n con resoluci\u00f3n reducida, y la predicci\u00f3n del modelo.\n<\/div>","c4a160f1":"<div style=\"background-color: #EDF7FF; border-color: #7C9DBF; border-left: 5px solid #7C9DBF; padding: 0.5em;\">\n\n<strong> Adjust dimensions in images (X input): <\/strong> Adjust the size of the training and test data using 4 dimensions (the last dimension has to be 1 to indicate that the images are in gray scale). TIP: use the number of training and test data and the size of the images.\n<\/div>","bf523de8":"### 1.4 Model training\n\nWe now train the model. To do this, we will make the model see each image 9 different times, and we will use the test set to validate the process.","81d70683":"<div style=\"background-color: #EDF7FF; border-color: #7C9DBF; border-left: 5px solid #7C9DBF; padding: 0.5em;\">\n<strong>Model creation<\/strong>\n<\/div>","68191a85":"We then compile, train and evaluate the model. For compilation we will use the cost function \"categorical_crossentropy\" and the metric \"accuracy\" again, but in this case we will use the Adadelta optimizer.\n\nWe will train the model for 12 periods, using a batch_size of 128, and the test set to validate. Finally we will also use the test set to evaluate the model.","3636a3b0":"Next we will implement a convolutional neural network of one layer and we will do the training and test on the MNIST dataset. We have 60,000 images to train and 10,000 to test.","cd3aad25":"### 3.2 Predicci\u00f3n de algunas im\u00e1genes del conjunto de test","9eb54a33":"### 1.6 Prediction\n\nFinally we can make the prediction for four of the images in the test set and see if the results are correct or not","bd3d9f4e":"<div style=\"background-color: #C7FCE5; border-color: #61FEBA; border-left: 5px solid #61FEBA; padding: 0.5em;\">\nWe have 'reshaped' x_train_orig and x_test_orig since our CNN will only accept a four-dimensional vector. Also, we set our tuple consisting of:\n     <ul>\n         <li> the 60,000 images that we have in training camp, <\/li>\n         <li> 28 the height of the image, <\/li>\n         <li> 28 the width of the image and <\/li>\n         <li> 1 which will be the number of channels. (1 for grayscale and 3 for RGB colors) <\/li>\n     <\/ul>\n<\/div>","dba02343":"## 2. Deep CNN + Dropout ","6183576e":"By looking at the graphs of the Accuracy measurement of a '* normal convolutional network *' and a deep '* CNN + Dropout *' we can assure that ** this second ** method (CNN + Dropout) has a higher ** accuracy ** comparing it to the first one. In addition, it greatly minimizes the cost function (** loss function **), obtaining much smaller * loss * values. The two layers *** dropout *** probability ** 0.25 and 0.5 ** contribute to the model ** with much more outstanding results, allowing a noticeable increase in the generalizability of the network ** and consequently better results are obtained. On the other hand, ** CNN + Dropout training is much faster ** for each epoch (epoch).\n\nIncreasing the number of intermediate layers can be a possible improvement of the model and an increase in the processing and classification capacity, but we must take into account and adjust the possible over-specialization that this may imply.","7c9f05d0":"<div style=\"background-color: #EDF7FF; border-color: #7C9DBF; border-left: 5px solid #7C9DBF; padding: 0.5em;\">\n<strong>Analysis<\/strong>\n<\/div>","573372fe":"<div style=\"background-color: #EDF7FF; border-color: #7C9DBF; border-left: 5px solid #7C9DBF; padding: 0.5em;\">\n<strong>Training the model<\/strong> \n<\/div>","54dc6b83":"\n\n\n\n# Convolutional Neural Networks with KERAS","09475e3a":"<div style=\"background-color: #EDF7FF; border-color: #7C9DBF; border-left: 5px solid #7C9DBF; padding: 0.5em;\">\n<strong>Coding the Y output tags<\/strong> \n<\/div>","41a41f72":"### 1.3 Build the model\n\nOnce the model is defined, it must be compiled so that Keras prepares the training. For this we are going to use the ADAM optimization algorithm, the cost function \"categorical_crossentropy\" and the \"accuracy\" metric","6afbd210":"In this exercise we will build a convolutional neural network such that, given low resolution images, it allows us to obtain the same images but with a higher resolution. To do this, from the same MNIST dataset we will create low-resolution images with which we will train our model.","7f7f59f9":"In this case we will use a Keras Sequential model again that will consist of:\n- Two convolution layers of 32 and 64 kernels respectively of 3x3 size, and with a reluctance activation function\n- A MaxPooling layer with a size of 2x2\n- A Dropout layer with a rate = 0.25\n- A Flatten layer\n- A dense layer with 128 neurons and a brilliant activation function\n- A Dropout layer with a rate = 0.5\n- A dense layer with softmax activation function","467a1b06":"<div style=\"background-color: #EDF7FF; border-color: #7C9DBF; border-left: 5px solid #7C9DBF; padding: 0.5em;\">\n<strong>Training<\/strong> \n<\/div>","af271bdd":"Here we can observe first the reduced image and secondly the image predicted from our neural network model. Next we will do the same with the other 2 remaining examples.","61bd3b59":"<div style=\"background-color: #EDF7FF; border-color: #7C9DBF; border-left: 5px solid #7C9DBF; padding: 0.5em;\">\n<strong>Development<\/strong> \n<\/div>","655550ee":"### 1.5  Accuracy evolution","6a7a5f9b":"### 3.1 Model creation and training\n","7329e77d":"## 1. Convolutional Neural Network with one layer\n","2acd9a1c":"First we reduce the resolution of the images:","7566e395":"# 0 Initialization and load data\n","9281351b":"<div style=\"background-color: #EDF7FF; border-color: #7C9DBF; border-left: 5px solid #7C9DBF; padding: 0.5em;\">\n<strong> Coding the output (Y output): <\/strong> Coding the values of the output tags into a one-hot vector. For example, the output vector for an image containing a 5 would be: [0., 0., 0., 0., 0., 1., 0., 0., 0., 0.]. TIP: Keras.utils to_categorical function can be used.\n<\/div>","e85cad57":"### 1.2 Model Creation\n\n\nWe are going to use a Keras Sequential model since it is very easy to use. These types of models allow us to build the model layer by layer. Specific:\n\n- The first layer we will add will be a convolutional layer with the following properties:\n\u00a0\u00a0\u00a0\u00a0 - Number of kernels (neurons) first layer: 64 neurons\n\u00a0\u00a0\u00a0\u00a0 - Kernels size: 3x3\n\u00a0\u00a0\u00a0\u00a0 - Activation of kernels: ReLU\n- Next we will add a Flatten layer to connect the output of the convolutional layer with the input of a dense layer.\n- Finally, we will add a dense output layer, and therefore it will have as many neurons as we want to predict classes. The activation of this last layer will be Softmax. The final prediction of the model will then be the class with the highest probability.","dd26ee11":"In the previous exercise we have implemented a single layer convolutional network. Now we are going to implement a deep convolutional neural network and we will see how this translates into better performance in the results. We will initialize and pre-process the data first.","86b2c015":"Next we will create and train the model with the following characteristics:\n\n- A convolutional layer of 32 kernels of 3x3 size, and with a relu activation function.\n- A MaxPooling layer with a size of 2x2.\n- Another convolutional layer of 32 kernels of 3x3 size, and with relu activation function.\n- A deconvolutionary layer with 32 kernels, size 3x3, stride 2x2, and relu activation function.\n- A last deconvolutionary layer with a single kernel of size 3x3, stride 2x2, and activation function sigmoid.\n\nAll convolutional and deconvolutionary layers have to have the padding parameter \"sames\", so that the size of the images is not affected in these layers.","b1f6d5f2":"In this practice, we are going to implement two convolutional neural networks to recognize the digits of the MNIST reference data set. In addition, we will also train a simple super-resolution model. Specifically, the following three points will be implemented:\n\n1. A convolutional neural network of one layer\n2. A deep convolutional neural network with x layers\n3. A super-resolution model\n\nIn all three cases, the Keras library will be used for model implementation, compilation, and training. Next we will also use Keras to predict the image classification of the test set.\n","e9922981":"### 1.1 Pre-processing data\n\nThe first step in training a neural network is to pre-process the training and test data to match the input of the neural network.\n","ed76ac1f":"The following code loads the necessary packages for the practice and also reads the data that we will use to train the neural network. The MNIST Dataset corresponds to images of digits from 0 to 9 of size 28x28 pixels.","9aaf04ec":"## 3. CNN applying for super resolution (encoder-decoder)"}}