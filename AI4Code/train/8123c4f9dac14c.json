{"cell_type":{"687eaf9f":"code","b15c6807":"code","b8fb817f":"code","d603fb0a":"code","c2049f6c":"code","70816882":"code","aafb2e5d":"code","fac51b9b":"code","9ffa712a":"code","b5a93910":"code","2d0e4ba5":"code","fec558c3":"code","8cb78f6b":"code","ffc6c31c":"code","4ed816ef":"code","ea859c03":"code","34e82b56":"code","5d4b0c8f":"code","f5b7f5f9":"code","eda05d7a":"code","617f6c2f":"code","4db7329d":"code","6e927f8b":"code","34fc71d2":"code","a2a7d7b3":"code","1427c344":"code","e945bfd9":"code","63b8cc3e":"code","f9b84e50":"code","1168068f":"code","84023f1b":"code","4a111ef3":"code","a592551b":"code","1f3fff60":"code","93327628":"code","08036a25":"code","284472f4":"code","0409ea5b":"code","59fa0fdc":"code","9a36f3f9":"code","f587433c":"code","57fd21ea":"code","55eb00c6":"code","b8ed2aa7":"code","dce3d953":"code","1e8768c1":"code","b796707e":"code","40f28eb4":"code","a8d812c6":"code","95e467a9":"code","17cf06be":"code","5a52873c":"markdown","3a826ae7":"markdown"},"source":{"687eaf9f":"# This Python 3 environment comes with many helpful analytics libraries installed\n# It is defined by the kaggle\/python Docker image: https:\/\/github.com\/kaggle\/docker-python\n# For example, here's several helpful packages to load\n\nimport numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\n\n# Input data files are available in the read-only \"..\/input\/\" directory\n# For example, running this (by clicking run or pressing Shift+Enter) will list all files under the input directory\n\nimport os\nfor dirname, _, filenames in os.walk('..\/input\/competitive-data-science-predict-future-sales\/'):\n    for filename in filenames:\n        print(os.path.join(dirname, filename))\n\n# You can write up to 20GB to the current directory (\/kaggle\/working\/) that gets preserved as output when you create a version using \"Save & Run All\" \n# You can also write temporary files to \/kaggle\/temp\/, but they won't be saved outside of the current session","b15c6807":"# Basic packages\nimport numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\nimport random as rd # generating random numbers\nimport datetime # manipulating date formats\nimport itertools\n\n# Viz\nimport matplotlib.pyplot as plt # basic plotting\nimport seaborn as sns # for prettier plots\n\nimport plotly\nimport plotly.express as px\nimport plotly.graph_objects as go\n\n#Modeling\nfrom statsmodels.tsa.arima_model import ARIMA\nfrom statsmodels.tsa.statespace.sarimax import SARIMAX\nfrom pandas.plotting import autocorrelation_plot\nfrom statsmodels.tsa.stattools import adfuller, acf, pacf,arma_order_select_ic\nimport statsmodels.formula.api as smf\nimport statsmodels.tsa.api as smt\nimport statsmodels.api as sm\nimport scipy.stats as scs\nfrom fbprophet import Prophet\nfrom math import sqrt\n\n\n#Evaluation\nfrom sklearn.metrics import mean_squared_error\nfrom fbprophet.diagnostics import performance_metrics\nfrom fbprophet.diagnostics import cross_validation\nfrom fbprophet.plot import plot_cross_validation_metric\n\nimport warnings\n\n# settings\nwarnings.filterwarnings('ignore')\npath = '..\/input\/competitive-data-science-predict-future-sales\/'","b8fb817f":"train = pd.read_csv(path + 'sales_train.csv')\ntest = pd.read_csv(path + 'test.csv')\nitem_categories = pd.read_csv(path + 'item_categories.csv')\nitems = pd.read_csv(path + 'items.csv')\nshops = pd.read_csv(path + 'shops.csv')","d603fb0a":"def eda(data):\n    print(\"Data Types\")\n    print(data.dtypes)\n    print(\"Missing value\")\n    print(data.isnull().sum())\n    print(data.isna().sum())","c2049f6c":"eda(train)","70816882":"eda(item_categories)","aafb2e5d":"eda(items)","fac51b9b":"eda(shops)","9ffa712a":"eda(test)","b5a93910":"train = pd.read_csv(path + 'sales_train.csv', parse_dates=['date'], \n                    dtype={'date': 'str', 'date_block_num': 'int32', 'shop_id': 'int32', 'item_id': 'int32', 'item_price': 'float32', 'item_cnt_day': 'int32'})\ntest = pd.read_csv(path + 'test.csv', dtype={'ID': 'int32', 'shop_id': 'int32', 'item_id': 'int32'})\nitem_categories = pd.read_csv(path + 'item_categories.csv', dtype={'item_category_name': 'str', 'item_category_id': 'int32'})\nitems = pd.read_csv(path + 'items.csv', dtype={'item_name': 'str', 'item_id': 'int32', 'item_category_id': 'int32'})\nshops = pd.read_csv(path + 'shops.csv', dtype={'shop_name': 'str', 'shop_id': 'int32'})","2d0e4ba5":"train = pd.merge(train, items, on='item_id', how='inner')\ntrain = pd.merge(train, item_categories, on='item_category_id', how='inner')\ntrain = pd.merge(train, shops, on='shop_id', how='inner')\n\n\ntest = pd.merge(test, items, on='item_id', how='inner')\ntest = pd.merge(test, item_categories, on='item_category_id', how='inner')\ntest = pd.merge(test, shops, on='shop_id', how='inner')","fec558c3":"train","8cb78f6b":"train['total_sales'] = train['item_price'] * train['item_cnt_day']\ntrain.head()","ffc6c31c":"sns.boxplot(x=train[\"item_price\"])","4ed816ef":"train[train[\"item_price\"] > 100000]","ea859c03":"train[train['item_price'] <= 0].count()","34e82b56":"train = train[train['item_price'] > 0]","5d4b0c8f":"sns.boxplot(x=train[\"item_cnt_day\"])","f5b7f5f9":"train[train['item_cnt_day'] <= 0].count()","eda05d7a":"train = train[train['item_cnt_day'] > 0]","617f6c2f":"train","4db7329d":"train_monthly = train[['date', 'date_block_num', 'shop_id', 'item_category_id', 'item_id', 'item_price', 'item_cnt_day']]\n# Group by month in this case \"date_block_num\" and aggregate features.\ntrain_monthly = train_monthly.sort_values('date').groupby(['date_block_num', 'shop_id', 'item_category_id', 'item_id'], as_index=False)\ntrain_monthly = train_monthly.agg({'item_price':['sum', 'mean'], 'item_cnt_day':['sum', 'mean','count']})\n# Rename features.\ntrain_monthly.columns = ['date_block_num', 'shop_id', 'item_category_id', 'item_id', 'item_price', 'mean_item_price', 'item_cnt', 'mean_item_cnt', 'transactions']","6e927f8b":"train_monthly.head()","34fc71d2":"train =  train.set_index('date')\ntrain.head()","a2a7d7b3":"train_arima = train.resample(\"M\").sum() \nts_sales = train_arima[[\"total_sales\"]]\nts_sales.head()","1427c344":"ts_sales = ts_sales[ts_sales.index <= pd.to_datetime('2015-10-31')]\nts_sales.head()","e945bfd9":"plt.figure(figsize=(16,9))\nplt.title('Total Item of the company')\nplt.xlabel('Month')\nplt.ylabel('Item')\nplt.plot(ts_sales['total_sales'])","63b8cc3e":"#?????\ndef test_stationarity(timeseries):\n    \n    #Perform Dickey-Fuller test:\n    print('Results of Dickey-Fuller Test:')\n    dftest = adfuller(timeseries, autolag='AIC')\n    dfoutput = pd.Series(dftest[0:4], index=['Test Statistic','p-value','#Lags Used','Number of Observations Used'])\n    for key,value in dftest[4].items():\n        dfoutput['Critical Value (%s)'%key] = value\n    print (dfoutput)","f9b84e50":"test_stationarity(ts_sales['total_sales'])","1168068f":"item_cnt_dec = sm.tsa.seasonal_decompose(ts_sales['total_sales'],freq=12).plot()","84023f1b":"sales_acf = sm.graphics.tsa.plot_acf(ts_sales['total_sales'], lags=12)","4a111ef3":"sales_acf = sm.graphics.tsa.plot_pacf(ts_sales['total_sales'], lags=12)","a592551b":"p = d = q = range(0, 2)\npdq = list(itertools.product(p, d, q))\nseasonal_pdq = [(x[0], x[1], x[2], 12) for x in list(itertools.product(p, d, q))]\nseasonal_pdq","1f3fff60":"# pdq range(0, 2)\nfor param in pdq:\n    for param_seasonal in seasonal_pdq:\n        try:\n            mod = sm.tsa.statespace.SARIMAX(ts_sales['total_sales'],\n                                            order=param,\n                                            seasonal_order=param_seasonal,\n                                            enforce_stationarity=True,\n                                            enforce_invertibility=True)\n\n            results = mod.fit()\n\n            print('ARIMA{}x{}12 - AIC:{}'.format(param, param_seasonal, results.aic))\n        except:\n            continue","93327628":"ts_sales['total_sales']","08036a25":"#result of pdq range(0, 2)\nmodel = sm.tsa.statespace.SARIMAX(ts_sales['total_sales'],\n                                order=(0,1,0),\n                                seasonal_order=(0, 1, 1, 12),\n                                enforce_stationarity=True,\n                                enforce_invertibility=True)\nresults = model.fit()\nprint(results.summary().tables[1])","284472f4":"results","0409ea5b":"# pdq range(0, 3)\n# for param in pdq:\n#     for param_seasonal in seasonal_pdq:\n#         try:\n#             mod = sm.tsa.statespace.SARIMAX(ts_sales['total_sales'],\n#                                             order=param,\n#                                             seasonal_order=param_seasonal,\n#                                             enforce_stationarity=True,\n#                                             enforce_invertibility=True)\n\n#             results = mod.fit()\n\n#             print('ARIMA{}x{}12 - AIC:{}'.format(param, param_seasonal, results.aic))\n#         except:\n#             continue\n# #result of pdq range(0, 3)\n# model = sm.tsa.statespace.SARIMAX(ts_sales['total_sales'],\n#                                 order=(0,1,0),\n#                                 seasonal_order=(0, 1, 1, 12),\n#                                 enforce_stationarity=True,\n#                                 enforce_invertibility=True)\n# results = model.fit()\n# print(results.summary().tables[1])","59fa0fdc":"results.plot_diagnostics(figsize=(16, 9))\nplt.show()","9a36f3f9":"#predict since Desember 2014\npred = results.get_prediction(start=pd.to_datetime('2014-12-31'), dynamic=False)\npred_ci = pred.conf_int()","f587433c":"ax = ts_sales['2013-01-31':].plot(label = \"observed\", figsize=(16, 9))\npred.predicted_mean.plot(ax=ax, label='Forecast')\nax.fill_between(pred_ci.index,\n                pred_ci.iloc[:, 0],\n                pred_ci.iloc[:, 1], color='k', alpha=.2)\n\nax.set_xlabel('Month')\nax.set_ylabel('Sales')\nplt.legend()\nplt.show()\n\ntrain_sarima_forecasted = pred.predicted_mean\ntrain_sarima_truth = ts_sales['2014-12-31':]\n\n#Menghiung RMSE\nrmse_sarima = sqrt(mean_squared_error(train_sarima_truth, train_sarima_forecasted))\nprint(\"Root Mean Squared Error: \", rmse_sarima)","57fd21ea":"pred_uc = results.get_forecast(steps=3)\npred_ci = pred_uc.conf_int()\nax = ts_sales['2013-01-31':].plot(label='observed', figsize=(16, 9))\npred_uc.predicted_mean.plot(ax=ax, label='Forecast')\nax.fill_between(pred_ci.index,\n                pred_ci.iloc[:, 0],\n                pred_ci.iloc[:, 1], color='k', alpha=.2)\nax.set_xlabel('Date')\nax.set_ylabel('Amount of Sales')\nplt.legend()\nplt.show()","55eb00c6":"#Reset index first to make date into column\nts_sales = ts_sales.reset_index()\n#Pertama kita harus merubah dates menjadi ds dan total_sales menjadi y\nts_sales.rename(columns={'date':'ds','total_sales':'y'},inplace=True)","b8ed2aa7":"# Make predictions with the Prophet\nm_p = Prophet()\nm_p.fit(ts_sales)\nfuture = m_p.make_future_dataframe(periods = 3, freq = 'M')\nprediction = m_p.predict(future)\nprediction.tail(3)","dce3d953":"m_p.plot(prediction)\nplt.show()","1e8768c1":"m_p.plot_components(prediction)\nplt.show()","b796707e":"cv = cross_validation(m_p,initial='720 days', period='120 days', horizon = '240 days')","40f28eb4":"cv.head()","a8d812c6":"df_pm= performance_metrics(cv)\ndf_pm.head()","95e467a9":"plot_cross_validation_metric(cv, metric='rmse')\nplt.show()","17cf06be":"pred_ci","5a52873c":"# Cross validation","3a826ae7":"**[SARIMA\/SARIMAX(Seasonal Autoregressive Integrated Moving Average\/Exogenous Model)]**\n\nSARIMA\ub294 \ub9d0\uadf8\ub300\ub85c \uacc4\uc808\uc131\uc744 \ud3ec\ud568\ud558\ub294 \ubaa8\ud615\uc785\ub2c8\ub2e4. \uacc4\uc808\uc131\uc774\ub77c\ub294 \uac83\uc740 \uc5b4\ub5a4 \ud2b9\uc815\ud55c \ud328\ud134\uc774 \uc8fc\uae30\uc801\uc73c\ub85c \ub098\ud0c0\ub098\ub294 \uac70\uc744 \ub73b\ud569\ub2c8\ub2e4. \uc608\ub97c \ub4e4\uc5b4 \uc6b0\ub9ac\uac00 \uac00\uc9c0\uace0 \uc788\ub294 \uc2dc\uacc4\uc5f4 \ub370\uc774\ud130\uac00 Monthly \ubca0\uc774\uc2a4\ub77c\uba74, 1\ub144 \uc8fc\uae30 \uae30\ubc18 \ud328\ud134\uc774 \ubc1c\uc0dd\ud560 \uac00\ub2a5\uc131\uc774 \ub192\uc2b5\ub2c8\ub2e4. \uc774\ub807\uac8c \uc8fc\uae30\uc801\uc73c\ub85c \ub098\ud0c0\ub0b4\ub294 \ud2b9\uc131\uc740 AR \ubaa8\ud615\uc774\ub098 MA\ubaa8\ud615\ub9cc\uc744 \ud65c\uc6a9\ud574\uc11c \ub098\ud0c0\ub0b4\ub294 \uac83\uc740 \uc5b4\ub835\uc2b5\ub2c8\ub2e4. "}}