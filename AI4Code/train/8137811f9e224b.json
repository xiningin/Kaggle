{"cell_type":{"99100a86":"code","8b21d931":"code","f0fb681b":"code","4ba5bda9":"code","d0daa59d":"code","97b07dda":"code","f0e8101b":"code","db1ccb9f":"code","7b97fe4a":"code","34916316":"code","f594d7d7":"code","eea56a1b":"code","32f5580c":"code","6d1c112e":"code","d7953a46":"code","7d998388":"code","cc0f6934":"code","c323aa0a":"code","7bdea7b9":"code","5e9b14f2":"code","8c4123c0":"markdown","e95b29dd":"markdown"},"source":{"99100a86":"import numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\nimport os\n\nfrom sklearn.preprocessing import LabelEncoder\nfrom keras.utils import to_categorical\nfrom kerastuner.tuners import RandomSearch\n\nimport warnings\nwarnings.filterwarnings(\"ignore\")\n#!pip install iterative-stratification\n\nimport tensorflow as tf\nfrom keras.utils import plot_model\nimport sklearn","8b21d931":"os.listdir(os.getcwd())","f0fb681b":"os.chdir(\"..\/input\/iterstrat\")\nos.getcwd()","4ba5bda9":"from ml_stratifiers import MultilabelStratifiedKFold","d0daa59d":"os.chdir(\"..\/input\/iterstrat\")\nfrom ml_stratifiers import MultilabelStratifiedKFold,RepeatedMultilabelStratifiedKFold,MultilabelStratifiedShuffleSplit","97b07dda":"train_features = pd.read_csv(\"\/kaggle\/input\/lish-moa\/train_features.csv\")\ntrain_targets_scored = pd.read_csv(\"\/kaggle\/input\/lish-moa\/train_targets_scored.csv\")\n#train_targets_unscored = pd.read_csv(\"\/kaggle\/input\/lish-moa\/train_targets_nonscored.csv\")","f0e8101b":"COLS = ['cp_type','cp_dose']\nFE = []\nfor col in COLS:\n    for mod in train_features[col].unique():\n        FE.append(mod)\n        train_features[mod] = (train_features[col] == mod).astype(int)\ndel train_features['sig_id']\ndel train_features['cp_type']\ndel train_features['cp_dose']\nFE+=list(train_features.columns) \ndel train_targets_scored['sig_id']","db1ccb9f":"X = np.array(train_features.to_numpy(), dtype=np.float)\ny = np.array(train_targets_scored.to_numpy(), dtype=np.float)","7b97fe4a":"def add_layers(x,unit,drop):\n    x = tf.keras.layers.Dense(units=unit)(x)\n    x = tf.keras.layers.BatchNormalization()(x)\n    x = tf.keras.layers.Activation('relu')(x)\n    x = tf.keras.layers.Dropout(drop)(x)\n    return x","34916316":"def build_model():\n    inp = tf.keras.layers.Input(shape=(train_features.shape[1],))\n    x = tf.keras.layers.BatchNormalization()(inp)\n    for i in [2048,1024,512]:\n        x = add_layers(x,i,0.4)\n    out = tf.keras.layers.Dense(206, activation=\"sigmoid\")(x)\n    model = tf.keras.models.Model(inputs=inp,outputs=out)\n    model.compile(optimizer='adam', loss='binary_crossentropy', metrics=[\"accuracy\",\"binary_crossentropy\"])\n    return model\nmodel = build_model()\nmodel.summary()","f594d7d7":"# from sklearn.model_selection import GridSearchCV\n# from tensorflow.keras.wrappers.scikit_learn import KerasClassifier\n# model = KerasClassifier(build_fn=build_model, verbose=0)","eea56a1b":"# batch_size = [60, 100]\n# epochs = [10, 50, 100]\n# param_grid = dict(batch_size=batch_size, epochs=epochs)\n# grid = GridSearchCV(estimator=model, param_grid=param_grid, n_jobs=-1, cv=3)\n# grid_result = grid.fit(X, y)\n# # summarize results\n# print(\"Best: %f using %s\" % (grid_result.best_score_, grid_result.best_params_))\n# means = grid_result.cv_results_['mean_test_score']\n# stds = grid_result.cv_results_['std_test_score']\n# params = grid_result.cv_results_['params']\n# for mean, stdev, param in zip(means, stds, params):\n#     print(\"%f (%f) with: %r\" % (mean, stdev, param))","32f5580c":"from skmultilearn.model_selection import iterative_train_test_split\nX_train, y_train, X_val, y_val = iterative_train_test_split(X, y, test_size = 0.1)\nX_train.shape,y_train.shape,X_val.shape,y_val.shape","6d1c112e":"from iterstrat.ml_stratifiers import MultilabelStratifiedKFold\nimport numpy as np\n\n\nmskf = MultilabelStratifiedKFold(n_splits=2, shuffle=True)\n\nfor train_index, test_index in mskf.split(X, y):\n    print(\"TRAIN:\", train_index, \"TEST:\", test_index)\n    X_train, X_test = X[train_index], X[test_index]\n    y_train, y_test = y[train_index], y[test_index]\n    model.fit(X_train,y_test,epochs=50,batch_size=60,verbose=0)\n    pred = model.predict(X_test)\n    print(round(tf.keras.losses.binary_crossentropy(y_test, pred).numpy().mean(),6))","d7953a46":"from iterstrat.ml_stratifiers import RepeatedMultilabelStratifiedKFold\n\nrmskf = RepeatedMultilabelStratifiedKFold(n_splits=2,n_repeats=2, random_state=0)\n\nfor train_index, test_index in rmskf.split(X, y):\n    print(\"TRAIN:\", train_index, \"TEST:\", test_index)\n    X_train, X_test = X[train_index], X[test_index]\n    y_train, y_test = y[train_index], y[test_index]\n    model.fit(X_train,y_test,epochs=50,batch_size=60,verbose=0)\n    pred = model.predict(X_test)\n    print(round(tf.keras.losses.binary_crossentropy(y_test, pred).numpy().mean(),6))","7d998388":"from iterstrat.ml_stratifiers import MultilabelStratifiedShuffleSplit\n\nmsss  = MultilabelStratifiedShuffleSplit(n_splits=3, test_size=0.5, random_state=0)\n\nfor train_index, test_index in msss.split(X, y):\n    print(\"TRAIN:\", train_index, \"TEST:\", test_index)\n    X_train, X_test = X[train_index], X[test_index]\n    y_train, y_test = y[train_index], y[test_index]\n    model.fit(X_train,y_test,epochs=50,batch_size=60,verbose=0)\n    pred = model.predict(X_test)\n    print(round(tf.keras.losses.binary_crossentropy(y_test, pred).numpy().mean(),6))","cc0f6934":"test_features = pd.read_csv(\"\/kaggle\/input\/lish-moa\/test_features.csv\")\n\nsample_submission = pd.read_csv(\"\/kaggle\/input\/lish-moa\/sample_submission.csv\")\nCOLS = ['cp_type','cp_dose']\nFE = []\nfor col in COLS:\n    for mod in test_features[col].unique():\n        FE.append(mod)\n        test_features[mod] = (test_features[col] == mod).astype(int)\ndel test_features['sig_id']\ndel test_features['cp_type']\ndel test_features['cp_dose']","c323aa0a":"pred = model.predict(test_features)","7bdea7b9":"sub = pd.DataFrame(data=pred, columns=train_targets_scored.columns)\nsub.insert(0, column = 'sig_id', value=sample_submission['sig_id'])","5e9b14f2":"sub.to_csv('submission.csv',index=False)","8c4123c0":"# cross validation schema","e95b29dd":"# testing with leader board"}}