{"cell_type":{"3e7b4eb8":"code","eeec7971":"code","106ccfba":"code","bfdb4dc1":"code","c73e35e0":"code","dcc63f54":"code","395083ed":"code","23d47ede":"code","106e52d8":"code","8ca945bf":"code","40a2e1ad":"code","70a7ebbd":"code","f5aee198":"code","aecd2557":"code","d768e5b8":"code","4156d1ac":"code","b57cf258":"code","ee1bc2aa":"code","162421ee":"code","e60935fa":"code","fccc0a16":"code","ecffc24d":"code","aefaacd1":"code","172ba5e1":"code","0915e3cf":"code","d68beeb6":"code","951e38d5":"code","7ee24fbe":"code","bab61725":"code","1cf5f732":"code","d4e98b4e":"code","d9f26829":"code","369fdc2f":"code","4837eca7":"markdown","30f18e44":"markdown","e6223fd7":"markdown","191a5bfc":"markdown","3dd86978":"markdown","e161601e":"markdown","6fd5a30a":"markdown","80f0eefb":"markdown","5610c938":"markdown","55698310":"markdown","42135c36":"markdown","080c4872":"markdown","245408e5":"markdown","b84f315d":"markdown","3595075d":"markdown","5335d8a8":"markdown","4adbdf83":"markdown","dc706698":"markdown","a4e712d4":"markdown","15f502af":"markdown","33c44b42":"markdown","129f4997":"markdown","3686c445":"markdown","136cdf75":"markdown","955ccaf5":"markdown"},"source":{"3e7b4eb8":"import numpy as np\nimport pandas as pd","eeec7971":"train_df = pd.read_csv('\/kaggle\/input\/ventilator-pressure-prediction\/train.csv')","106ccfba":"train_df.head()","bfdb4dc1":"train_df.describe()","c73e35e0":"len(train_df.breath_id.unique())","dcc63f54":"for breath_id in range(1,6):\n    temp_df = train_df[train_df['breath_id'] == breath_id]\n    temp_df[['u_in', 'u_out', 'pressure']].plot(figsize = (20,10), \n                                                title = f\"Breath id: {breath_id}, R: {temp_df['R'].values[0]}, C: {temp_df['C'].values[0]}, R*C: {temp_df['R'].values[0] * temp_df['C'].values[0]}\")\n    ","395083ed":"train_df.pressure.hist(bins = 50, figsize = (20,10))","23d47ede":"train_df.R.hist(bins = 20, figsize = (20,10))","106e52d8":"train_df.C.hist(bins = 20, figsize = (20,10))","8ca945bf":"train_df.u_in.hist(bins = 50, figsize = (20,10))","40a2e1ad":"test_df = pd.read_csv('..\/input\/ventilator-pressure-prediction\/test.csv')","70a7ebbd":"train_df['R*C'] = train_df['R'] * train_df['C']\ntest_df['R*C'] = test_df['R'] * test_df['C']","f5aee198":"u_in_agg = train_df[train_df['u_out'] == 0][['breath_id','u_in','time_step']].groupby(['breath_id']).agg({'u_in': ['max','mean', 'std'], 'time_step': ['mean']})\nu_in_agg.columns = ['u_in_max','u_in_mean', 'u_in_std','time_step_mean']\nu_in_agg_out = train_df[train_df['u_out'] == 1][['breath_id','u_in','time_step']].groupby(['breath_id']).agg({'u_in': ['max','mean', 'std', lambda x: sum(i==0 for i in x)]})\nu_in_agg_out.columns = ['u_in_max_out','u_in_mean_out', 'u_in_std_out','steps_before_in_again']\ntrain_df = train_df.merge(u_in_agg, on = 'breath_id')\ntrain_df = train_df.merge(u_in_agg_out, on = 'breath_id')\n\ntrain_df['max_to_max_u_i_o'] = train_df['u_in_max_out'] \/ train_df['u_in_max']\ntrain_df['max_to_max_u_i_o'] = train_df['u_in_mean_out'] \/ train_df['u_in_mean']","aecd2557":"u_in_agg = test_df[test_df['u_out'] == 0][['breath_id','u_in','time_step']].groupby(['breath_id']).agg({'u_in': ['max','mean', 'std'], 'time_step': ['mean']})\nu_in_agg.columns = ['u_in_max','u_in_mean', 'u_in_std','time_step_mean']\nu_in_agg_out = test_df[test_df['u_out'] == 1][['breath_id','u_in','time_step']].groupby(['breath_id']).agg({'u_in': ['max','mean', 'std', lambda x: sum(i==0 for i in x)]})\nu_in_agg_out.columns = ['u_in_max_out','u_in_mean_out', 'u_in_std_out','steps_before_in_again']\ntest_df = test_df.merge(u_in_agg, on = 'breath_id')\ntest_df = test_df.merge(u_in_agg_out, on = 'breath_id')\n\ntest_df['max_to_max_u_i_o'] = test_df['u_in_max_out'] \/ test_df['u_in_max']\ntest_df['max_to_max_u_i_o'] = test_df['u_in_mean_out'] \/ test_df['u_in_mean']","d768e5b8":"train_df = train_df[train_df['u_out'] == 0]\ntest_df = test_df[test_df['u_out'] == 0]","4156d1ac":"for df in (train_df, test_df):\n    num_in_breath = [1]\n    for i in range(1,len(df)):\n        if df['breath_id'].values[i] == df['breath_id'].values[i-1]:\n            num_in_breath.append(num_in_breath[-1]+1)\n        else:\n            num_in_breath.append(1)\n    df['num_in_breath'] = num_in_breath\n    \n    for lag in range(1,5):\n        df[f'u_in_lag_{lag}'] = np.roll(df['u_in'].values, lag)\n        df[f'u_in_lag_{lag}'][df['num_in_breath'] <= lag] = 0","b57cf258":"for df in (train_df, test_df):\n    mean_u_in_cum = [df['u_in'].values[0]]\n    cum_sum = df['u_in'].values[0]\n    for i in range(1,len(df)):\n        if df['breath_id'].values[i] == df['breath_id'].values[i-1]:\n            cum_sum += df['u_in'].values[i]\n            mean_u_in_cum.append(cum_sum \/ df['num_in_breath'].values[i])\n        else:\n            mean_u_in_cum.append(df['u_in'].values[i])\n            cum_sum = df['u_in'].values[i]\n    df['mean_u_in_cum'] = mean_u_in_cum\n    df['u_in_cum'] = df['mean_u_in_cum'] * df['time_step']","ee1bc2aa":"test_df.head()","162421ee":"train_df.head()","e60935fa":"for df in (train_df, test_df):\n    df['u_in_last_step_change'] = df[f'u_in'] - df[f'u_in_lag_1']\n    df['u_in_delta_mean_cum'] = df[f'u_in'] - df[f'mean_u_in_cum']\n    df['u_in_delta_mean'] = df[f'u_in'] - df[f'u_in_mean']\n    df['u_in_delta_max'] = df[f'u_in'] - df[f'u_in_max']","fccc0a16":"from seaborn import pairplot \nsample_df = train_df.sample(frac = 0.0001)\npairplot(sample_df[['pressure','R', 'C', 'R*C','u_in', 'u_in_lag_4', 'u_in_max', 'u_in_mean', 'mean_u_in_cum', \n                     'u_in_cum', 'u_in_last_step_change', 'u_in_delta_mean_cum', 'u_in_delta_mean','u_in_delta_max', 'u_in_mean_out']])","ecffc24d":"from lightgbm import LGBMRegressor\nmodel = LGBMRegressor(\n    objective = 'regression_l1',\n    n_jobs= -1,\n    n_estimators = 20000,\n    learning_rate = 0.3\n)","aefaacd1":"from sklearn.model_selection import GroupKFold\nkf = GroupKFold(n_splits=7)","172ba5e1":"train_df.columns","0915e3cf":"features = [c for c in train_df.columns if c not in ('id', 'breath_id', 'pressure', 'predictions')]\ntarget = 'pressure'","d68beeb6":"x = train_df[features]\ny = train_df[target]\n\nx_test = test_df[features]\n\ntrain_df['predictions'] = 0\ntest_df['predictions'] = 0","951e38d5":"models = []\nfor train_index, test_index in kf.split(x, groups = train_df['breath_id']):\n        model = model.fit(x.iloc[train_index], y.values[train_index],\n                          eval_set=(x.iloc[test_index], y.values[test_index]),\n                          verbose=1000, early_stopping_rounds=100)\n        models.append(model)\n        train_df['predictions'].iloc[test_index] = model.predict(x.iloc[test_index])\n        test_df['predictions'] += model.predict(x_test[features])\ntest_df['predictions'] \/= len(models)","7ee24fbe":"print(f\"CV MAE: {(train_df['predictions'] - y).abs().mean()}\")","bab61725":"submission_df = pd.read_csv('..\/input\/ventilator-pressure-prediction\/sample_submission.csv')","1cf5f732":"submission_df = submission_df.merge(test_df[['id','predictions']], on = 'id', how = 'outer')","d4e98b4e":"submission_df.predictions.fillna(0, inplace = True)\nsubmission_df['pressure'] = submission_df['predictions']","d9f26829":"submission_df[['id','pressure']].to_csv('submission.csv', index = False)","369fdc2f":"submission_df","4837eca7":"Let's also compute some aggregated statistics for the u_in feature.","30f18e44":"# Train data","e6223fd7":"# Delta features","191a5bfc":"## Breath level features","3dd86978":"# Basic features exploration","e161601e":"Based on the data definition:\n- R is the change in pressure per change in flow\n- C is the change in volume per change in pressure\nSo, it seems that R * C also has some physical meaning - the change in volume per change in flow. Let's use it as a feature.","6fd5a30a":"R and C - are numerical features, but it turned out they have only three unique values each. Probably we can treat them as categorical features in our later analysis, but I prefer to keep them numerical because their values still have physical meaning.","80f0eefb":"In this competition, we need to predict pressure for the expiratory phase only. \nLet's exclude all data related to the expiratory phase (it still can be helpful, but we will ignore it for simplicity in this notebook).","5610c938":"We can see some correlation between features and target, which means we are going in the right direction. Let's train some baseline model.","55698310":"Let's look at some breath_id to understand how our time series look like.","42135c36":"# Correlation analysis ","080c4872":"# Model training","245408e5":"We can see two phases - inspiratory and expiratory.\nPressure is high during the inspiratory phase and then goes down when the expiratory step starts. And we can see that pressure is lagging to u_in changes (we will create some lagging features later in this notebook)","b84f315d":"This notebook contains a simple data analysis and baseline model training for the Google Brain - Ventilator Pressure Prediction competition.","3595075d":"Target variable distribution looks ok (there is some skewness but it doesn't look too bad). We will not change it anyhow for now.","5335d8a8":"# Submission","4adbdf83":"I will train a simple LGBMRegressor without any params optimization.","dc706698":"As I have mentioned before, pressure is lagging to changes in u_in. Let's use this observation and create some u_in lagging features.","a4e712d4":"We have generated plenty of features. Let's look at them. \nLet's visualize the relationship between different features based on the small random subset of data (0.01%)","15f502af":"The dataset contains ~6M rows for 75k different breath_id (80 observations per 1 breath id)","33c44b42":"It is important to use GroupKFold because we don't want rows related to the same breath_id in both train and valid datasets.","129f4997":"We can enrich our features set by adding deltas between u_in and its derivative features.","3686c445":"# Feature generation","136cdf75":"It also seems that pressure depends on some cumulative features, so let's compute them as well.","955ccaf5":"## Lagging features"}}