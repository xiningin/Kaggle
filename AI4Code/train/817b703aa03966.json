{"cell_type":{"ac474920":"code","f2cb1303":"code","ea903575":"code","5ca2b27f":"code","d45fcfef":"code","affc9a25":"code","c5dde735":"code","77871398":"code","46aefd6a":"code","425dae03":"code","b8d6aafa":"code","b762e621":"code","b25c99f6":"code","5598ab9d":"code","0c8de350":"code","274837f5":"code","848aaa46":"code","f2809677":"code","5e33b9e5":"code","d89fdb24":"code","4dfe858a":"code","7f13f888":"code","43818e59":"code","7d28003c":"code","cccfcf68":"code","4a0325c2":"code","1ac782b4":"code","97dc90e4":"code","424c97f3":"code","f434745e":"code","cccf60f1":"code","a08c6622":"code","27ae77b3":"code","615c92b8":"code","a1bdd7b7":"markdown","2b14c31d":"markdown","ed8022b8":"markdown","5bf779aa":"markdown","2631548c":"markdown","8a7bf27d":"markdown","aec523ba":"markdown","5bf1a9fc":"markdown","13adb9c4":"markdown","e73dde2d":"markdown"},"source":{"ac474920":"# This Python 3 environment comes with many helpful analytics libraries installed\n# It is defined by the kaggle\/python docker image: https:\/\/github.com\/kaggle\/docker-python\n# For example, here's several helpful packages to load in \n\nimport numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\n\nfrom datetime import timedelta\nfrom sklearn.linear_model import LinearRegression\n\n# Input data files are available in the \"..\/input\/\" directory.\n# For example, running this (by clicking run or pressing Shift+Enter) will list all files under the input directory\n\nimport os\nfor dirname, _, filenames in os.walk('\/kaggle\/input'):\n    for filename in filenames:\n        print(os.path.join(dirname, filename))\n\n# Any results you write to the current directory are saved as output.","f2cb1303":"N = 5 # Number of previous data points to use to forecast","ea903575":"def get_preds_lin_reg(series, pred_min, H):\n    \"\"\"\n    Given a dataframe, get prediction at timestep t using values from t-1, t-2, ..., t-N.\n    Inputs\n        series     : series to forecast\n        pred_min   : all predictions should be >= pred_min\n        H          : forecast horizon\n    Outputs\n        result: the predictions. The length of result is H. numpy array of shape (H,)\n    \"\"\"\n    # Create linear regression object\n    regr = LinearRegression(fit_intercept=True)\n\n    pred_list = []\n\n    X_train = np.array(range(len(series))) # e.g. [0 1 2 3 4]\n    y_train = np.array(series) # e.g. [2944 3088 3226 3335 3436]\n    X_train = X_train.reshape(-1, 1)     # e.g X_train = \n                                             # [[0]\n                                             #  [1]\n                                             #  [2]\n                                             #  [3]\n                                             #  [4]]\n    # X_train = np.c_[np.ones(N), X_train]              # add a column\n    y_train = y_train.reshape(-1, 1)\n    regr.fit(X_train, y_train)            # Train the model\n    pred = regr.predict(np.array(range(len(series),len(series)+H)).reshape(-1,1))\n    pred = pred.reshape(H,)\n    \n    # If the values are < pred_min, set it to be pred_min\n    pred[pred < pred_min] = pred_min\n        \n    return np.around(pred)","5ca2b27f":"train = pd.read_csv('\/kaggle\/input\/covid19-global-forecasting-week-4\/train.csv')\n\n# Change column names to lower case\ntrain.columns = [col.lower() for col in train.columns]\n\n# Change to date format\ntrain['date'] = pd.to_datetime(train['date'], format='%Y-%m-%d')\n\ntrain","d45fcfef":"test = pd.read_csv('\/kaggle\/input\/covid19-global-forecasting-week-4\/test.csv')\n\n# Change column names to lower case\ntest.columns = [col.lower() for col in test.columns]\n\n# Change to date format\ntest['date'] = pd.to_datetime(test['date'], format='%Y-%m-%d')\n\ntest","affc9a25":"submission = pd.read_csv('\/kaggle\/input\/covid19-global-forecasting-week-4\/submission.csv')\nsubmission","c5dde735":"# Count number of nulls for each column\ntrain.isnull().sum(axis=0)","77871398":"# Get the province_states\nprint(len(train['province_state'].unique()))\ntrain['province_state'].unique()","46aefd6a":"# Get the country_regions\nprint(len(train['country_region'].unique()))\ntrain['country_region'].unique()","425dae03":"# Get amount of data per country\ntrain['country_region'].value_counts()","b8d6aafa":"train[train['country_region']=='Singapore']","b762e621":"# Plot the confirmed cases in Singapore, Malaysia, Indonesia, Thailand\ncountries_list = ['Singapore', 'Malaysia', 'Indonesia', 'Thailand', 'Philippines', 'Brunei', 'Laos', 'Cambodia', 'New Zealand']\ncolor_list = ['r', 'g', 'b', 'k', 'c', 'y', 'm', '0.75', '0.25']\n\nax = train[train['country_region']==countries_list[0]].plot(x='date', y='confirmedcases', style = 'r.-', grid=True, figsize=(10, 6))\n\ni = 1\nfor country in countries_list[1:]:\n    ax = train[train['country_region']==country].plot(x='date', y='confirmedcases', color=color_list[i], marker='.', grid=True, ax=ax, figsize=(10, 6))\n    i = i + 1\n    \nax.set_xlabel(\"date\")\nax.set_ylabel(\"confirmedcases\")\nax.legend(countries_list)","b25c99f6":"# Plot the fatalities in Singapore, Malaysia, Indonesia, Thailand\nax = train[train['country_region']==countries_list[0]].plot(x='date', y='fatalities', style = 'r.-', grid=True, figsize=(10, 6))\n\ni = 1\nfor country in countries_list[1:]:\n    ax = train[train['country_region']==country].plot(x='date', y='fatalities', color=color_list[i], marker='.', grid=True, ax=ax, figsize=(10, 6))\n    i = i + 1\n    \nax.set_xlabel(\"date\")\nax.set_ylabel(\"fatalities\")\nax.legend(countries_list)","5598ab9d":"# Plot the confirmed cases in China, US, India\nax = train[train['country_region']=='China'].groupby(\"date\").agg({\"confirmedcases\": \"sum\"}).plot(marker='.', figsize=(10, 6), grid=True)\nax = train[train['country_region']=='US'].groupby(\"date\").agg({\"confirmedcases\": \"sum\"}).plot(marker='.', figsize=(10, 6), grid=True, ax=ax)\nax = train[train['country_region']=='India'].groupby(\"date\").agg({\"confirmedcases\": \"sum\"}).plot(marker='.', figsize=(10, 6), grid=True, ax=ax)\nax = train[train['country_region']=='Italy'].groupby(\"date\").agg({\"confirmedcases\": \"sum\"}).plot(marker='.', figsize=(10, 6), grid=True, ax=ax)\nax = train[train['country_region']=='France'].groupby(\"date\").agg({\"confirmedcases\": \"sum\"}).plot(marker='.', figsize=(10, 6), grid=True, ax=ax)\nax = train[train['country_region']=='Iran'].groupby(\"date\").agg({\"confirmedcases\": \"sum\"}).plot(marker='.', figsize=(10, 6), grid=True, ax=ax)\n\nax.set_xlabel(\"date\")\nax.set_ylabel(\"confirmedcases\")\nax.legend(['China', 'US', 'India', 'Italy', 'France', 'Iran'])","0c8de350":"# Plot the fatalities in China, US, India\nax = train[train['country_region']=='China'].groupby(\"date\").agg({\"fatalities\": \"sum\"}).plot(marker='.', figsize=(10, 6), grid=True)\nax = train[train['country_region']=='US'].groupby(\"date\").agg({\"fatalities\": \"sum\"}).plot(marker='.', figsize=(10, 6), grid=True, ax=ax)\nax = train[train['country_region']=='India'].groupby(\"date\").agg({\"fatalities\": \"sum\"}).plot(marker='.', figsize=(10, 6), grid=True, ax=ax)\nax = train[train['country_region']=='Italy'].groupby(\"date\").agg({\"fatalities\": \"sum\"}).plot(marker='.', figsize=(10, 6), grid=True, ax=ax)\nax = train[train['country_region']=='France'].groupby(\"date\").agg({\"fatalities\": \"sum\"}).plot(marker='.', figsize=(10, 6), grid=True, ax=ax)\nax = train[train['country_region']=='Iran'].groupby(\"date\").agg({\"fatalities\": \"sum\"}).plot(marker='.', figsize=(10, 6), grid=True, ax=ax)\n\nax.set_xlabel(\"date\")\nax.set_ylabel(\"fatalities\")\nax.legend(['China', 'US', 'India', 'Italy', 'France', 'Iran'])","274837f5":"# Get global number of cases\nax = train.groupby(\"date\").agg({\"confirmedcases\": \"sum\"}).plot(marker='.', figsize=(10, 6), grid=True)\ntrain.groupby(\"date\").agg({\"fatalities\": \"sum\"}).plot(marker='.', figsize=(10, 6), grid=True, ax=ax)","848aaa46":"# Fill nans in province_state with ''\ntrain['province_state'] = train['province_state'].fillna(value = 'nil')\ntrain.head()","f2809677":"# Fill nans in province_state with ''\ntest['province_state'] = test['province_state'].fillna(value = 'nil')\ntest.head()","5e33b9e5":"# Get unique combinations of province_state and country_region\nps_cr_unique = train[['province_state', 'country_region']].drop_duplicates()\nps_cr_unique","d89fdb24":"# Get number of days we need to predict\ndate_max_train = train[(train['province_state']=='nil') & \n                 (train['country_region']=='Singapore')]['date'].max()\n\ndate_max_test = test[(test['province_state']=='nil') & \n                 (test['country_region']=='Singapore')]['date'].max()\n\npred_days = (date_max_test - date_max_train).days\nprint(date_max_train, date_max_test, pred_days)","4dfe858a":"# Specify the country here\nps = 'nil'\ncr = 'Singapore'","7f13f888":"train_sgp = train[(train['province_state']==ps) & (train['country_region']==cr)]\ntrain_sgp[-5:]","43818e59":"# Get predictions \npreds = get_preds_lin_reg(train_sgp['confirmedcases'][-N:], 0, pred_days)\npreds","7d28003c":"# Put into dataframe\ndate_list = []\ndate = pd.date_range(date_max_train+timedelta(days=1), date_max_test)\nresults = pd.DataFrame({'date': date, 'preds':preds})\nresults.head()","cccfcf68":"# Plot the confirmed cases in Singapore and the predictions\nax = train[train['country_region']==cr].plot(x='date', y='confirmedcases', style = 'r.-', grid=True, figsize=(10, 6))\nax = results.plot(x='date', y='preds', style = 'r.', grid=True, figsize=(10, 6), ax=ax)\n    \n\nax.set_xlabel(\"date\")\nax.set_ylabel(\"fatalities\")\nax.legend([cr])","4a0325c2":"# Predict for confirmedcases\nps_list = []\ncr_list = []\ndate_list = []\nconfirmedcasespred_list = []\n\nfor index, row in ps_cr_unique.iterrows():\n    train_temp = train[(train['province_state']==row['province_state']) & (train['country_region']==row['country_region'])]\n    preds = get_preds_lin_reg(train_temp['confirmedcases'][-N:], 0, pred_days)\n    \n    ps_list = ps_list + ([row['province_state']]*pred_days)\n    cr_list = cr_list + ([row['country_region']]*pred_days)\n    date_list = date_list + list(pd.date_range(date_max_train+timedelta(days=1), date_max_test).strftime(\"%Y-%m-%d\"))\n    confirmedcasespred_list = confirmedcasespred_list + list(preds)\n\nresults = pd.DataFrame({'province_state': ps_list,\n                        'country_region': cr_list,\n                        'date': date_list,\n                        'confirmedcases': confirmedcasespred_list})\nresults['date'] = pd.to_datetime(results['date'], format='%Y-%m-%d')\nresults","1ac782b4":"# Merge test with the existing values in train\ntest_merged = test.merge(train[['province_state', 'country_region', 'date', 'confirmedcases', 'fatalities']], \n                         left_on=['province_state', 'country_region', 'date'], \n                         right_on=['province_state', 'country_region', 'date'], \n                         how='left') \ntest_merged","97dc90e4":"# Merge test with the predictions\ntest_merged2 = test_merged.merge(results, \n                                left_on=['province_state', 'country_region', 'date'], \n                                right_on=['province_state', 'country_region', 'date'], \n                                how='left') \ntest_merged2","424c97f3":"# Create column confirmedcases\ntest_merged2['confirmedcases'] = test_merged2.apply(lambda row: row['confirmedcases_x'] if pd.isnull(row['confirmedcases_y']) else row['confirmedcases_y'], axis=1)\ntest_merged2.drop(['confirmedcases_x', 'confirmedcases_y'], axis=1, inplace=True)\ntest_merged2","f434745e":"# Predict for fatalities\nps_list = []\ncr_list = []\ndate_list = []\nfatalities_list = []\n\nfor index, row in ps_cr_unique.iterrows():\n    train_temp = train[(train['province_state']==row['province_state']) & (train['country_region']==row['country_region'])]\n    preds = get_preds_lin_reg(train_temp['fatalities'][-N:], 0, pred_days)\n    \n    ps_list = ps_list + ([row['province_state']]*pred_days)\n    cr_list = cr_list + ([row['country_region']]*pred_days)\n    date_list = date_list + list(pd.date_range(date_max_train+timedelta(days=1), date_max_test).strftime(\"%Y-%m-%d\"))\n    fatalities_list = fatalities_list + list(preds)\n\nresults = pd.DataFrame({'province_state': ps_list,\n                        'country_region': cr_list,\n                        'date': date_list,\n                        'fatalities': fatalities_list})\nresults['date'] = pd.to_datetime(results['date'], format='%Y-%m-%d')\nresults","cccf60f1":"# Merge with the predictions\ntest_merged3 = test_merged2.merge(results, \n                                left_on=['province_state', 'country_region', 'date'], \n                                right_on=['province_state', 'country_region', 'date'], \n                                how='left') \ntest_merged3","a08c6622":"# Create column fatalities\ntest_merged3['fatalities'] = test_merged3.apply(lambda row: row['fatalities_x'] if pd.isnull(row['fatalities_y']) else row['fatalities_y'], axis=1)\ntest_merged3.drop(['fatalities_x', 'fatalities_y'], axis=1, inplace=True)\ntest_merged3","27ae77b3":"# Form the submission dataset\nsubmission = test_merged3.copy()\nsubmission.drop(['country_region', 'province_state', 'date'], axis=1, inplace=True)\nsubmission.rename(columns={'forecastid': 'ForecastId',\n                           'fatalities': 'Fatalities', \n                           'confirmedcases': 'ConfirmedCases'}, inplace=True)\nsubmission","615c92b8":"# Test submission\nsubmission.to_csv(\"submission.csv\", index=False)","a1bdd7b7":"# Common functions","2b14c31d":"# Pre-process train, test","ed8022b8":"# Predictions for fatalities","5bf779aa":"Different country_regions have different amount of data","2631548c":"# EDA","8a7bf27d":"# Predictions for confirmedcases","aec523ba":"# Problem statement\nThis is week 4 of Kaggle's COVID19 forecasting series.","5bf1a9fc":"# Prediction for one country","13adb9c4":"# Prepare submission file","e73dde2d":"# Load data"}}