{"cell_type":{"5cd0081a":"code","01edc418":"code","b0a3eebe":"code","dd30a57c":"code","c2b496d9":"code","61d04b6c":"code","4ca4d6fd":"code","87d1a0fa":"code","58d5c553":"code","b2504738":"code","644ad963":"code","8f411799":"code","cea622ee":"code","b4ea7412":"code","eb2ebde8":"code","d4adbbaa":"code","d41e0b02":"code","96ea26ef":"code","e34a95b1":"code","38032f79":"code","f22eff30":"code","eb23a493":"code","8d9d85a6":"code","24ea1292":"code","f4b3a7e9":"code","39f4c18b":"code","311b8c4e":"code","a24a42c8":"code","6c778146":"code","63f81fc1":"code","395e4b8a":"code","eb802762":"code","7205eede":"markdown","b9f06161":"markdown","175f83af":"markdown","2bd2c97d":"markdown","2d784fb2":"markdown","0e92e205":"markdown","a4f98729":"markdown","30517e26":"markdown","bfa1317e":"markdown","a64e6636":"markdown"},"source":{"5cd0081a":"import os\nimport json\nimport numpy as np\nimport pandas as pd\nfrom scipy.stats import norm\nfrom scipy import stats\nimport bq_helper\nimport matplotlib.pyplot as plt \nfrom plotly.offline import init_notebook_mode, iplot\nimport plotly.graph_objs as go\nfrom plotly import tools\ninit_notebook_mode(connected=True)\nimport warnings\nwarnings.filterwarnings('ignore')\n\nfrom pandas.io.json import json_normalize\nimport matplotlib.pyplot as plt\nimport seaborn as sns\ncolor = sns.color_palette()\n%matplotlib inline\nimport matplotlib\nmatplotlib.style.use('ggplot')\nsns.set_style('whitegrid')\n\nfrom plotly import tools\nimport plotly.offline as py\nfrom plotly.offline import init_notebook_mode, iplot\npy.init_notebook_mode(connected=True)\nimport plotly.graph_objs as go\n\nfrom sklearn import model_selection, preprocessing, metrics\nimport lightgbm as lgb\n\npd.options.mode.chained_assignment = None\npd.options.display.max_columns = 999\nimport os\nprint(os.listdir(\"..\/input\"))","01edc418":"def load_df(csv_path='..\/input\/train.csv', nrows=None):\n    JSON_COLUMNS = ['device', 'geoNetwork', 'totals', 'trafficSource']\n    \n    df = pd.read_csv(csv_path, \n                     converters={column: json.loads for column in JSON_COLUMNS}, \n                     dtype={'fullVisitorId': 'str'}, # Important!!\n                     nrows=nrows)\n    \n    for column in JSON_COLUMNS:\n        column_as_df = json_normalize(df[column])\n        column_as_df.columns = [f\"{column}.{subcolumn}\" for subcolumn in column_as_df.columns]\n        df = df.drop(column, axis=1).merge(column_as_df, right_index=True, left_index=True)\n    return df","b0a3eebe":"%%time\ntrain = load_df()\ntest = load_df(\"..\/input\/test.csv\")","dd30a57c":"#Size of datasets\nprint(\"Size of train data  (Rows, Columns): \",train.shape)\nprint(\"Size of test data  (Rows, Columns): \",test.shape)","c2b496d9":"#general information of data\nprint(\"Train data info: \",train.info())\nprint(\"----------------------------------------------------------------\")\nprint(\"Test data info: \",test.info())","61d04b6c":"train.columns.values","4ca4d6fd":"train.head()","87d1a0fa":"test.head()","58d5c553":"print(\"Datatypes of Train dataset are:\")\nprint(train.dtypes.value_counts())","b2504738":"#function for finding categorial variables\ndef cat_val(df):\n    categorical_variables = df.dtypes.loc[df.dtypes == 'object'].index\n    return categorical_variables\ncat_val(train)","644ad963":"def missing_check(df):\n    total = df.isnull().sum().sort_values(ascending=False)\n    percent = (df.isnull().sum()\/df.isnull().count()).sort_values(ascending=False)*100\n    missing_data = pd.concat([total, percent], axis=1, keys=['Total', 'Percent']) \n    #print(\"Missing check:\",missing_data )\n    return missing_data","8f411799":"missing_train=missing_check(train)\nmissing_train[missing_train['Total']>0]","cea622ee":"missing_test=missing_check(test)\nmissing_test[missing_test['Total']>0]","b4ea7412":"def missing_value_exp(df):\n    missing_values = df.isnull().sum(axis=0).reset_index()\n    missing_values.columns = ['column_name', 'Total']\n    missing_values = missing_values.loc[missing_values['Total']>0]\n    missing_values = missing_values.sort_values(by='Total')\n\n    ind = np.arange(missing_values.shape[0])\n    width = 0.1\n    fig, ax = plt.subplots(figsize=(16,4))\n    rects = ax.barh(ind, missing_values.Total.values, color='r')\n    ax.set_yticks(ind)\n    ax.set_yticklabels(missing_values.column_name.values, rotation='horizontal')\n    ax.set_xlabel(\"Count of Missing Observations\")\n    ax.set_title(\"Missing Categorical Observations in Dataset\")\n    plt.show()\n","eb2ebde8":"missing_value_exp(train)","d4adbbaa":"missing_value_exp(test)","d41e0b02":"print(\"Basic Statistics of Target variable(totals.transactionRevenue): \")\ntrain[\"totals.transactionRevenue\"].astype('float').describe()","96ea26ef":"print(\"Skewness: %f\" % train[\"totals.transactionRevenue\"].astype('float').skew())\nprint(\"Kurtosis: %f\" % train[\"totals.transactionRevenue\"].astype('float').kurt())","e34a95b1":"#histogram and normal probability plot\nsns.distplot(train[\"totals.transactionRevenue\"].astype('float').dropna(), fit=norm);\nfig = plt.figure()\nres = stats.probplot(train[\"totals.transactionRevenue\"].astype('float').dropna(), plot=plt)","38032f79":"train[\"totals.transactionRevenue\"] = train[\"totals.transactionRevenue\"].astype('float')\nvisit = train.groupby(\"fullVisitorId\")[\"totals.transactionRevenue\"].sum().reset_index()\n\nplt.figure(figsize=(10,8))\nplt.scatter(range(visit.shape[0]), np.sort(np.log1p(visit[\"totals.transactionRevenue\"].values)))\nplt.xlabel('index', fontsize=12)\nplt.ylabel('TransactionRevenue', fontsize=10)\nplt.show()","f22eff30":"visit = train.groupby(\"fullVisitorId\")[\"totals.transactionRevenue\"].sum().reset_index()\nnzi = pd.notnull(train[\"totals.transactionRevenue\"]).sum()\nnzr = (visit[\"totals.transactionRevenue\"]>0).sum()\nprint(\"Number of instances in train set with non-zero revenue : \", nzi, \" and ratio is : \", nzi \/ train.shape[0])\nprint(\"Number of unique customers with non-zero revenue : \", nzr, \"and the ratio is : \", nzr \/ visit.shape[0])","eb23a493":"print(\"Number of unique visitors in train set : \",train.fullVisitorId.nunique(), \" out of rows : \",train.shape[0])\nprint(\"Number of unique visitors in test set : \",test.fullVisitorId.nunique(), \" out of rows : \",test.shape[0])\nprint(\"Number of common visitors in train and test set : \",len(set(train.fullVisitorId.unique()).intersection(set(test.fullVisitorId.unique())) ))","8d9d85a6":"#Columns with constant values:\nconst_cols = [i for i in train.columns if train[i].nunique(dropna=False)==1 ]","24ea1292":"const_cols","f4b3a7e9":"device_cols = [\"device.browser\", \"device.deviceCategory\", \"device.operatingSystem\"]\n\ncolors = [\"#d6a5ff\", \"#fca6da\", \"#f4d39c\", \"#a9fcca\"]\ntraces = []\nfor i, col in enumerate(device_cols):\n    t = train[col].value_counts()\n    traces.append(go.Bar(marker=dict(color=colors[i]),orientation=\"h\", y = t.index[:15][::-1], x = t.values[:15][::-1]))\n\nfig = tools.make_subplots(rows=1, cols=3, subplot_titles=[\"Visits: Category\", \"Visits: Browser\",\"Visits: OS\"], print_grid=False)\nfig.append_trace(traces[1], 1, 1)\nfig.append_trace(traces[0], 1, 2)\nfig.append_trace(traces[2], 1, 3)\n\nfig['layout'].update(height=400, showlegend=False, title=\"Visits by Device Attributes\")\niplot(fig)\n\n","39f4c18b":"## convert transaction revenue to float\ntrain[\"totals.transactionRevenue\"] = train[\"totals.transactionRevenue\"].astype('float')\n\ndevice_cols = [\"device.browser\", \"device.deviceCategory\", \"device.operatingSystem\"]\n\nfig = tools.make_subplots(rows=1, cols=3, subplot_titles=[\"Mean Revenue: Category\", \"Mean Revenue: Browser\",\"Mean Revenue: OS\"], print_grid=False)\n\ncolors = [\"red\", \"green\", \"purple\"]\ntrs = []\nfor i, col in enumerate(device_cols):\n    tmp = train.groupby(col).agg({\"totals.transactionRevenue\": \"mean\"}).reset_index().rename(columns={\"totals.transactionRevenue\" : \"Mean Revenue\"})\n    tmp = tmp.dropna().sort_values(\"Mean Revenue\", ascending = False)\n    tr = go.Bar(x = tmp[\"Mean Revenue\"][::-1], orientation=\"h\", marker=dict(opacity=0.5, color=colors[i]), y = tmp[col][::-1])\n    trs.append(tr)\n\nfig.append_trace(trs[1], 1, 1)\nfig.append_trace(trs[0], 1, 2)\nfig.append_trace(trs[2], 1, 3)\nfig['layout'].update(height=400, showlegend=False, title=\"Mean Revenue by Device Attributes\")\niplot(fig)","311b8c4e":"geo_cols = ['geoNetwork.city', 'geoNetwork.continent','geoNetwork.country',\n            'geoNetwork.metro', 'geoNetwork.networkDomain', 'geoNetwork.region','geoNetwork.subContinent']\ngeo_cols = ['geoNetwork.continent','geoNetwork.subContinent']\n\ncolors = [\"#d6a5ff\", \"#fca6da\"]\nfig = tools.make_subplots(rows=1, cols=2, subplot_titles=[\"Visits : GeoNetwork Continent\", \"Visits : GeoNetwork subContinent\"], print_grid=False)\ntrs = []\nfor i,col in enumerate(geo_cols):\n    t = train[col].value_counts()\n    tr = go.Bar(x = t.index[:20], marker=dict(color=colors[i]), y = t.values[:20])\n    trs.append(tr)\n\nfig.append_trace(trs[0], 1, 1)\nfig.append_trace(trs[1], 1, 2)\nfig['layout'].update(height=400, margin=dict(b=150), showlegend=False)\niplot(fig)","a24a42c8":"geo_cols = ['geoNetwork.continent','geoNetwork.subContinent']\nfig = tools.make_subplots(rows=1, cols=2, subplot_titles=[\"Mean Revenue: Continent\", \"Mean Revenue: SubContinent\"], print_grid=False)\n\ncolors = [\"blue\", \"orange\"]\ntrs = []\nfor i, col in enumerate(geo_cols):\n    tmp = train.groupby(col).agg({\"totals.transactionRevenue\": \"mean\"}).reset_index().rename(columns={\"totals.transactionRevenue\" : \"Mean Revenue\"})\n    tmp = tmp.dropna().sort_values(\"Mean Revenue\", ascending = False)\n    tr = go.Bar(y = tmp[\"Mean Revenue\"], orientation=\"v\", marker=dict(opacity=0.5, color=colors[i]), x= tmp[col])\n    trs.append(tr)\n\nfig.append_trace(trs[0], 1, 1)\nfig.append_trace(trs[1], 1, 2)\nfig['layout'].update(height=450, margin=dict(b=200), showlegend=False)\niplot(fig)","6c778146":"fig = tools.make_subplots(rows=1, cols=2, subplot_titles=[\"TrafficSource Campaign (not-set removed)\", \"TrafficSource Medium\"], print_grid=False)\n\ncolors = [\"#d6a5ff\", \"#fca6da\", \"#f4d39c\", \"#a9fcca\"]\nt1 = train[\"trafficSource.campaign\"].value_counts()\nt2 = train[\"trafficSource.medium\"].value_counts()\ntr1 = go.Bar(x = t1.index, y = t1.values, marker=dict(color=colors[3]))\ntr2 = go.Bar(x = t2.index, y = t2.values, marker=dict(color=colors[2]))\ntr3 = go.Bar(x = t1.index[1:], y = t1.values[1:], marker=dict(color=colors[0]))\ntr4 = go.Bar(x = t2.index[1:], y = t2.values[1:])\n\nfig.append_trace(tr3, 1, 1)\nfig.append_trace(tr2, 1, 2)\nfig['layout'].update(height=400, margin=dict(b=100), showlegend=False)\niplot(fig)","63f81fc1":"tmp = train[\"channelGrouping\"].value_counts()\ncolors = [\"#8d44fc\", \"#ed95d5\", \"#caadf7\", \"#6161b7\", \"#7e7eba\", \"#babad1\"]\ntrace = go.Pie(labels=tmp.index, values=tmp.values, marker=dict(colors=colors))\nlayout = go.Layout(title=\"Channel Grouping\", height=400)\nfig = go.Figure(data = [trace], layout = layout)\niplot(fig, filename='basic_pie_chart')","395e4b8a":"\nimport datetime\n\ndef scatter_plot(cnt_srs, color):\n    trace = go.Scatter(\n        x=cnt_srs.index[::-1],\n        y=cnt_srs.values[::-1],\n        showlegend=False,\n        marker=dict(\n            color=color,\n        ),\n    )\n    return trace\n\ntrain['date'] = train['date'].apply(lambda x: datetime.date(int(str(x)[:4]), int(str(x)[4:6]), int(str(x)[6:])))\ncnt_srs = train.groupby('date')['totals.transactionRevenue'].agg(['size', 'count'])\ncnt_srs.columns = [\"count\", \"count of non-zero revenue\"]\ncnt_srs = cnt_srs.sort_index()\n#cnt_srs.index = cnt_srs.index.astype('str')\ntrace1 = scatter_plot(cnt_srs[\"count\"], 'red')\ntrace2 = scatter_plot(cnt_srs[\"count of non-zero revenue\"], 'blue')\n\nfig = tools.make_subplots(rows=2, cols=1, vertical_spacing=0.08,\n                          subplot_titles=[\"Date - Count\", \"Date - Non-zero Revenue count\"])\nfig.append_trace(trace1, 1, 1)\nfig.append_trace(trace2, 2, 1)\nfig['layout'].update(height=800, width=800, paper_bgcolor='rgb(233,233,233)', title=\"Date Plots\")\npy.iplot(fig, filename='date-plots')","eb802762":"def add_date_features(df):\n    df['date'] = df['date'].astype(str)\n    df[\"date\"] = df[\"date\"].apply(lambda x : x[:4] + \"-\" + x[4:6] + \"-\" + x[6:])\n    df[\"date\"] = pd.to_datetime(df[\"date\"])\n    \n    df[\"month\"]   = df['date'].dt.month\n    df[\"day\"]     = df['date'].dt.day\n    df[\"weekday\"] = df['date'].dt.weekday\n    return df \n\ntrain = add_date_features(train)\n\ntmp = train['date'].value_counts().to_frame().reset_index().sort_values('index')\ntmp = tmp.rename(columns = {\"index\" : \"dateX\", \"date\" : \"visits\"})\n\ntr = go.Scatter(mode=\"lines\", x = tmp[\"dateX\"].astype(str), y = tmp[\"visits\"])\nlayout = go.Layout(title=\"Visits by date\", height=400)\nfig = go.Figure(data = [tr], layout = layout)\niplot(fig)\n\n\ntmp = train.groupby(\"date\").agg({\"totals_transactionRevenue\" : \"mean\"}).reset_index()\ntmp = tmp.rename(columns = {\"date\" : \"dateX\", \"totals_transactionRevenue\" : \"mean_revenue\"})\ntr = go.Scatter(mode=\"lines\", x = tmp[\"dateX\"].astype(str), y = tmp[\"mean_revenue\"])\nlayout = go.Layout(title=\"MonthlyRevenue by date\", height=400)\nfig = go.Figure(data = [tr], layout = layout)\niplot(fig)","7205eede":"**GeoNetwork Attributes**","b9f06161":"# 3. Univariate Analysis","175f83af":"# 1. Variables Identification","2bd2c97d":"# 2. Missing Values","2d784fb2":"**Number of visitors and common visitors:**","0e92e205":"**Columns with constant values:**","a4f98729":"**Traffic Attributes**","30517e26":"** Device Attributes**","bfa1317e":"**Target Variable Exploration**:","a64e6636":"**Channel Grouping**"}}