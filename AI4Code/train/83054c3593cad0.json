{"cell_type":{"c28b9f35":"code","8edaf5b7":"code","51f1975c":"code","e79a0980":"code","36dde574":"code","9c187687":"code","8e3a85d3":"code","c53cf3f7":"code","e2049a01":"code","3098912e":"code","6496724d":"code","e910f17e":"code","d5cf8041":"code","f72cee8c":"markdown","e3ea4d22":"markdown","74064f38":"markdown"},"source":{"c28b9f35":"import pandas as pd\nimport matplotlib.pyplot as plt\nplt.style.use('ggplot')\n%matplotlib inline\n\nimport plotly.figure_factory as ff\nfrom plotly import tools\nimport plotly.plotly as py\nimport plotly.graph_objs as go\nfrom plotly.offline import init_notebook_mode, iplot\ninit_notebook_mode()","8edaf5b7":"data = pd.read_csv('..\/input\/bus-breakdown-and-delays.csv', low_memory=False)\ndata.sample(3).T","51f1975c":"data['How_Long_Delayed'].sample(500).unique()","e79a0980":"#### The string is searched for a sequence of numbers, the last is returned.\ndef minutes(x):\n    flag = None\n    num_list = list()\n    num = str()\n    for i in str(x):         \n        if i.isnumeric():\n            flag = 1\n            num += i\n        else:\n            if num:\n                num_list.append(num)\n            flag = 0\n            num = ''\n    return int(num_list[-1]) if num_list else 0\n\ndata['How_Long_Delayed'] = data.How_Long_Delayed.fillna(0)\ndata['How_Long_Delayed'] = data.How_Long_Delayed.str.lower()\ndata['HLD'] = pd.to_numeric(data.How_Long_Delayed, errors='coerce')\n\ndata.loc[\n    data.How_Long_Delayed.str.contains('m|-|in|\/', na=False), \n    'HLD'\n] = data.How_Long_Delayed.apply(minutes)\n#### Sometimes, delay time indicated in hours. Basically - 1 hour.\ndata.loc[data.How_Long_Delayed.str.contains('hr|hour', na=False), 'HLD'] = 60\n#### Explicit errors - equate to 0.\ndata.loc[data.HLD.isna(), 'HLD'] = 0\n#### If the driver has not arrived at all, it may not be considered a delay.\ndata.loc[data.Breakdown_or_Running_Late =='Breakdown', 'HLD'] = 0\n#### A delay of more than 250 minutes is considered an error.\ndata.loc[data.HLD > 250, 'HLD'] = 0","36dde574":"clean_delay = data.loc[data.HLD > 0]","9c187687":"clean_delay['School_Year'] = pd.to_datetime(clean_delay.School_Year.str[:4]).dt.year","8e3a85d3":"delay_years = clean_delay.groupby(\n    'School_Year', \n    as_index=True\n)['HLD'].agg([('m', 'mean'), ('s', 'sum')])\n\ntrace1 = go.Scatter(\n    x=delay_years.index.tolist(),\n    y=delay_years.m.tolist(),\n    showlegend=False\n)\ntrace2 = go.Scatter(\n    x=delay_years.index.tolist(),\n    y=delay_years.s.tolist(),\n    showlegend=False\n)\n\nfig = tools.make_subplots(\n    rows=2, \n    cols=1,\n    subplot_titles=('Mean', 'Sum'), \n    shared_xaxes=True)\n\nfig.append_trace(trace1, 1, 1)\nfig.append_trace(trace2, 2, 1)\n\nfig['layout']['yaxis1'].update(title='Mins')\nfig['layout']['yaxis2'].update(title='Mins')\n\nfig['layout'].update(height=600, width=700, title='\"How long delayed\" by years')\niplot(fig, filename='sss')","c53cf3f7":"mean_del_per_cont = clean_delay.pivot_table(\n    index='Boro', \n    columns='Reason', \n    values='HLD', \n    aggfunc='mean'\n)\n\ny = mean_del_per_cont.index.tolist()\ntraces = list()\nfor col in mean_del_per_cont.columns.tolist():\n    traces.append(go.Bar(\n        y = y,\n        x = mean_del_per_cont[col].tolist(),\n        name = col,\n        showlegend=False,\n        orientation='h'\n    )\n    )\nlayout = go.Layout(barmode='stack',\n                   height=600, \n                   width=700, \n                   title='Mean delay for areas with reasons')\n\nfig = go.Figure(data=traces, layout=layout)\niplot(fig, filename='stacked-bar')\n    ","e2049a01":"sum_del_per_cont = clean_delay.pivot_table(\n    index='Boro', \n    columns='Reason', \n    values='HLD', \n    aggfunc='sum'\n)\n\ny = sum_del_per_cont.index.tolist()\ntraces = list()\nfor col in sum_del_per_cont.columns.tolist():\n    traces.append(go.Bar(\n        y = y,\n        x = sum_del_per_cont[col].tolist(),\n        name = col,\n        showlegend=False,\n        orientation='h'\n    )\n    )\nlayout = go.Layout(barmode='stack',\n                   height=600, \n                   width=700, \n                   title='Sum delay for areas with reasons')\n\nfig = go.Figure(data=traces, layout=layout)\niplot(fig, filename='stacked-bar')","3098912e":"mean_delay_res = clean_delay.pivot_table(\n    index=['Reason'], \n    values='HLD', \n    aggfunc='mean'\n).sort_values(by='HLD')\n\nmean_delay_bor = clean_delay.pivot_table(\n    index=['Boro'], \n    values='HLD', \n    aggfunc='mean'\n).sort_values(by='HLD')\n\n\ntrace1 = go.Bar(\n    x=mean_delay_res.index.tolist(),\n    y=mean_delay_res.HLD.tolist(),\n    showlegend=False\n)\ntrace2 = go.Bar(\n    x=mean_delay_bor.index.tolist(),\n    y=mean_delay_bor.HLD.tolist(),\n    showlegend=False\n)\n\nfig = tools.make_subplots(\n    rows=1, \n    cols=2,\n    subplot_titles=('Reasons', 'Boro'), \n    shared_yaxes=True)\n\nfig.append_trace(trace1, 1, 1)\nfig.append_trace(trace2, 1, 2)\n\nfig['layout']['yaxis1'].update(title='Mins')\n\nfig['layout'].update(height=600, width=700, title='Mean delayed time by:')\niplot(fig, filename='sss')","6496724d":"clean_delay.Created_On =  pd.to_datetime(clean_delay.Created_On)\nclean_delay['Created_On_moun'] = clean_delay.Created_On.map(lambda x: x.strftime('%Y-%m'))\nclean_delay['Created_On_day_of_week'] = clean_delay.Created_On.dt.dayofweek\nclean_delay['Created_On_hour'] = clean_delay.Created_On.dt.hour","e910f17e":"data_day = clean_delay.pivot_table(\n    index='Created_On_moun',\n    columns='Reason',\n    values='HLD',\n    aggfunc='sum'\n)\n\n\nx = data_day.index.tolist()\ntraces = list()\nfor col in data_day.columns.tolist():\n    traces.append(go.Bar(\n        x = x,\n        y = data_day[col].tolist(),\n        name = col,\n        showlegend=False\n    )\n    )\nlayout = go.Layout(barmode='stack',\n                   height=600, \n                   width=700, \n                   title='Total delay by month')\n\nfig = go.Figure(data=traces, layout=layout)\niplot(fig, filename='stacked-bar')","d5cf8041":"delay_hours = clean_delay.groupby(\n    'Created_On_hour', \n    as_index=True\n)['HLD'].agg([('m', 'mean'), ('s', 'sum')])\n\ntrace1 = go.Scatter(\n    x=delay_hours.index.tolist(),\n    y=delay_hours.m.tolist(),\n    showlegend=False\n)\ntrace2 = go.Scatter(\n    x=delay_hours.index.tolist(),\n    y=delay_hours.s.tolist(),\n    showlegend=False\n)\n\nfig = tools.make_subplots(\n    rows=2, \n    cols=1,\n    subplot_titles=('Mean', 'Sum'), \n    shared_xaxes=True)\n\nfig.append_trace(trace1, 1, 1)\nfig.append_trace(trace2, 2, 1)\n\nfig['layout']['yaxis1'].update(title='Mins')\nfig['layout']['yaxis2'].update(title='Mins')\n\nfig['layout'].update(height=600, width=700, title='Mean delay by hours')\niplot(fig, filename='sss')","f72cee8c":"## Let's start the analysis","e3ea4d22":"### To start, I wont to focus on \"How_Long_Delayed\" info. ","74064f38":"#### The data are dirty. But, with some assumptions, it can be used."}}