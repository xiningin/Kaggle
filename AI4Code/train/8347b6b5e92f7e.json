{"cell_type":{"465581e6":"code","bd64a535":"code","beae27a2":"code","40786aa7":"markdown"},"source":{"465581e6":"!pip install binarytree\n!pip install bracketeer==0.2.0","bd64a535":"# https:\/\/www.kaggle.com\/joseleiva\/massey-s-ordinal-s-ordinals\n\nimport numpy as np\nimport pandas as pd\n\ninp = '..\/input\/ncaam-march-mania-2021\/MDataFiles_Stage2\/'\nseason_df = pd.read_csv(inp+'MRegularSeasonCompactResults.csv')\ntourney_df = pd.read_csv(inp+'MNCAATourneyCompactResults.csv')\nordinals_df = pd.read_csv(inp+'MMasseyOrdinals.csv').rename(columns={'RankingDayNum':'DayNum'})\n\n# Get the last available data from each system previous to the tournament\nordinals_df = ordinals_df.groupby(['SystemName','Season','TeamID']).last().reset_index()\n\n# Add winner's ordinals\ngames_df = tourney_df.merge(ordinals_df,left_on=['Season','WTeamID'],\n                          right_on=['Season','TeamID'])\ngames_df.head()\n# Then add losser's ordinals\ngames_df = games_df.merge(ordinals_df,left_on=['Season','LTeamID','SystemName'],\n                          right_on=['Season','TeamID','SystemName'],\n                          suffixes = ['W','L'])\n\n## Add column with 1 if result is correct\ngames_df = games_df.drop(labels=['TeamIDW','TeamIDL'],axis=1)\ngames_df['prediction'] = (games_df.OrdinalRankW<games_df.OrdinalRankL).astype(int)\nresults_by_system = games_df.groupby('SystemName').agg({'prediction':('mean','count')})\n\ngames_df['Wrating'] = 100-4*np.log(games_df['OrdinalRankW']+1)-games_df['OrdinalRankW']\/22\ngames_df['Lrating'] = 100-4*np.log(games_df['OrdinalRankL']+1)-games_df['OrdinalRankL']\/22\ngames_df['prob'] = 1\/(1+10**((games_df['Lrating']-games_df['Wrating'])\/15))\nloss_results = games_df[games_df.Season>=2015].groupby('SystemName')['prob'].agg([('loss',lambda p: -np.mean(np.log(p))),('count','count')])\n\nref_system = 'POM'\nordinals_df['Rating']= 100-4*np.log(ordinals_df['OrdinalRank']+1)-ordinals_df['OrdinalRank']\/22\nordinals_df = ordinals_df[ordinals_df.SystemName==ref_system]\n\n# Get submission file\nsub_df = pd.read_csv(inp+'MSampleSubmissionStage2.csv')\nsub_df['Season'] = sub_df['ID'].map(lambda x: int(x.split('_')[0]))\nsub_df['Team1'] = sub_df['ID'].map(lambda x: int(x.split('_')[1]))\nsub_df['Team2'] = sub_df['ID'].map(lambda x: int(x.split('_')[2]))\nsub_df = sub_df.merge(ordinals_df[['Season','TeamID','Rating']], how='left', left_on = ['Season','Team1'], right_on = ['Season','TeamID'])\nsub_df = sub_df.merge(ordinals_df[['Season','TeamID','Rating']], how='left', left_on = ['Season','Team2'], right_on = ['Season','TeamID'], suffixes=['W','L'])\nsub_df['Pred'] = 1\/(1+10**((sub_df['RatingL']-sub_df['RatingW'])\/15))\nsub_df[['ID', 'Pred']].to_csv('submission.csv', index=False, float_format='%.5g')\n","beae27a2":"from bracketeer import build_bracket\n\nb = build_bracket(\n        outputPath='MNCAA2021.png',\n        teamsPath=inp+'MTeams.csv',\n        seedsPath=inp+'MNCAATourneySeeds.csv',\n        submissionPath='submission.csv',\n        slotsPath=inp+'MNCAATourneySlots.csv',\n        year=2021\n)","40786aa7":"![MNCAA2021](MNCAA2021.png \"MNCAA2021\")"}}