{"cell_type":{"3d273349":"code","89128336":"code","22f68bcd":"code","a76d17cb":"code","5b98fed8":"code","d604e487":"code","93ef8994":"code","c1b896cd":"code","d38b85e3":"code","bcbf64c4":"code","791200ca":"code","12ed250c":"code","b5b587a2":"code","f015116c":"code","f2733852":"code","14d4049c":"code","9f9f5fcc":"code","a70e6161":"code","19314a40":"code","efb763e6":"code","46b6a0e7":"code","3b69b094":"markdown","1871b49b":"markdown","8309d9c3":"markdown","0492c05e":"markdown"},"source":{"3d273349":"import numpy as np \nimport pandas as pd\nfrom sklearn import *\nfrom sklearn.metrics import f1_score\nimport lightgbm as lgb\nimport matplotlib.pyplot as plt\nimport seaborn as sns\nimport time\nimport datetime\n\nsns.set_style(\"whitegrid\")\n\nfrom sklearn.model_selection import KFold\n\n#Constants\nROW_PER_BATCH = 500000\n\nfrom tensorflow import keras\nfrom sklearn.metrics import f1_score, cohen_kappa_score, mean_squared_error\nfrom sklearn.model_selection import KFold, train_test_split","89128336":"train = pd.read_csv(\"..\/input\/liverpool-ion-switching\/train.csv\")\ntest = pd.read_csv(\"..\/input\/liverpool-ion-switching\/test.csv\")\nsub = pd.read_csv(\"..\/input\/liverpool-ion-switching\/sample_submission.csv\", dtype=dict(time=str))","22f68bcd":"seq_len=1000","a76d17cb":"########################## clean train  ###################################\na=500000; b=600000\ntrain['signal_undrifted'] = train.signal\ntrain.loc[train.index[a:b],'signal_undrifted'] = train.signal[a:b].values - 3*(train.time.values[a:b] - 50)\/10.\n\n\ndef f(x,low,high,mid): return -((-low+high)\/625)*(x-mid)**2+high -low\n\nbatch = 7; a = 500000*(batch-1); b = 500000*batch\ntrain.loc[train.index[a:b],'signal_undrifted'] = train.signal.values[a:b] - f(train.time[a:b].values,-1.817,3.186,325)\n# CLEAN TRAIN BATCH 8\nbatch = 8; a = 500000*(batch-1); b = 500000*batch\ntrain.loc[train.index[a:b],'signal_undrifted'] = train.signal.values[a:b] - f(train.time[a:b].values,-0.094,4.936,375)\n# CLEAN TRAIN BATCH 9\nbatch = 9; a = 500000*(batch-1); b = 500000*batch\ntrain.loc[train.index[a:b],'signal_undrifted'] = train.signal.values[a:b] - f(train.time[a:b].values,1.715,6.689,425)\n# CLEAN TRAIN BATCH 10\nbatch = 10; a = 500000*(batch-1); b = 500000*batch\ntrain.loc[train.index[a:b],'signal_undrifted'] = train.signal.values[a:b] - f(train.time[a:b].values,3.361,8.45,475)","5b98fed8":"plt.figure(figsize=(20,5))\nsns.lineplot(train.time[::1000],train.signal[::2000],color='r').set_title('Training Batches 7-10 with Parabolic Drift')\n#plt.figure(figsize=(20,5))\ng = sns.lineplot(train.time[::1000],train.signal_undrifted[::2000],color='g').set_title('Training Batches 7-10 without Parabolic Drift')\nplt.legend(title='Train Data',loc='upper left', labels=['Original Signal', 'UnDrifted Signal'])\nsns.lineplot(train.time[::1000],train.open_channels[::2000],color='b')\nplt.show(g)","d604e487":"############################### clean test  #################################\ntest['signal_undrifted'] = test.signal\n\n# REMOVE BATCH 1 DRIFT\nstart=500\na = 0; b = 100000\ntest.loc[test.index[a:b],'signal_undrifted'] = test.signal.values[a:b] - 3*(test.time.values[a:b]-start)\/10.\nstart=510\na = 100000; b = 200000\ntest.loc[test.index[a:b],'signal_undrifted'] = test.signal.values[a:b] - 3*(test.time.values[a:b]-start)\/10.\nstart=540\na = 400000; b = 500000\ntest.loc[test.index[a:b],'signal_undrifted'] = test.signal.values[a:b] - 3*(test.time.values[a:b]-start)\/10.\n\nstart=560\na = 600000; b = 700000\ntest.loc[test.index[a:b],'signal_undrifted'] = test.signal.values[a:b] - 3*(test.time.values[a:b]-start)\/10.\nstart=570\na = 700000; b = 800000\ntest.loc[test.index[a:b],'signal_undrifted'] = test.signal.values[a:b] - 3*(test.time.values[a:b]-start)\/10.\nstart=580\na = 800000; b = 900000\ntest.loc[test.index[a:b],'signal_undrifted'] = test.signal.values[a:b] - 3*(test.time.values[a:b]-start)\/10.\n\n# REMOVE BATCH 3 DRIFT\ndef f(x):\n    return -(0.00788)*(x-625)**2+2.345 +2.58\na = 1000000; b = 1500000\ntest.loc[test.index[a:b],'signal_undrifted'] = test.signal.values[a:b] - f(test.time[a:b].values)","93ef8994":"#test.head()","c1b896cd":"X_test=test.signal_undrifted.values.reshape(-1, seq_len, 1)","d38b85e3":"X_undrifted=train.signal_undrifted.values.reshape(-1, seq_len, 1)\ny=train.open_channels.values.reshape(-1, seq_len, 1)\nX_train_undrifted, X_valid_undrifted, y_train, y_valid=train_test_split(X_undrifted, y, test_size=0.2, random_state=42)","bcbf64c4":"#X_train_undrifted.shape","791200ca":"#plt.plot(np.arange(1000), X_train_undrifted[0].reshape(-1))\n#plt.plot(np.arange(1000), y_train[0].reshape(-1))","12ed250c":"class macroF1(keras.callbacks.Callback):\n    def __init__(self, model, inputs, targets):\n        self.model=model\n        self.inputs=inputs\n        self.targets=targets.reshape(-1)\n    def on_epoch_end(self, epoch, logs):\n        pred=np.argmax(self.model.predict(self.inputs), axis=-1).reshape(-1)\n        \n        f1_val=f1_score(self.targets, pred, average='macro'\n                       )\n        print ('val_f1_macro_score', f1_val)","b5b587a2":"model_biGRUall=keras.models.Sequential([\n    keras.layers.Dense(256, input_shape=[seq_len, 1], activation='relu'),\n    keras.layers.Bidirectional(keras.layers.GRU(256, return_sequences=True, input_shape=[None, 1])),\n    keras.layers.BatchNormalization(),\n    keras.layers.Bidirectional(keras.layers.GRU(256, return_sequences=True)),\n    keras.layers.Bidirectional(keras.layers.GRU(256, return_sequences=True, input_shape=[None, 1])),\n    keras.layers.BatchNormalization(),\n    keras.layers.Dense(11, activation='softmax')\n])","f015116c":"model_biGRUall.compile(loss='sparse_categorical_crossentropy',optimizer='adam', metrics=['accuracy'] )","f2733852":"checkpoint_cb_biDRU= keras.callbacks.ModelCheckpoint(\"model_biGRU.h5\", save_best_only=True)","14d4049c":"history_biGRUall=model_biGRUall.fit(X_train_undrifted, y_train, epochs=30, batch_size=64, \n                          validation_data=(X_valid_undrifted, y_valid),\n                          callbacks=[macroF1(model_biGRUall, X_valid_undrifted, y_valid), checkpoint_cb_biDRU], verbose=1)","9f9f5fcc":"pd.DataFrame(history_biGRUall.history).plot()","a70e6161":"model=keras.models.load_model('model_biGRU.h5')","19314a40":"#model.load_weights('model.h5')\nvalid_pred = model.predict(X_valid_undrifted, batch_size=64).argmax(axis=-1)\nf1_score(y_valid.reshape(-1), valid_pred.reshape(-1), average='macro')","efb763e6":"test_pred = model.predict(X_test, batch_size=64).argmax(axis=-1)\nsub.open_channels = test_pred.reshape(-1)\nsub.to_csv('submission.csv', index=False)","46b6a0e7":"sub.to_csv('submission-0405.csv', index=False)","3b69b094":"# Submit","1871b49b":"# Load and process data","8309d9c3":"# Modelling","0492c05e":"# Evaluate"}}