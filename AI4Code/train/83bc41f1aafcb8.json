{"cell_type":{"e3d8d67e":"code","52ee0f5f":"code","40037c2e":"code","57985615":"code","6f9ad528":"code","5e6cec10":"code","119f0e98":"code","29e72922":"code","07140f2e":"code","5d235e97":"code","0bc14674":"code","c4479c9a":"code","374c7333":"code","7ab3ebab":"code","aebd17c6":"code","1c965553":"code","76db8932":"code","1f6e76c6":"code","efb2b553":"code","4c916c18":"code","79fad0b6":"code","35a818ec":"code","7bdd450f":"code","fbd5056b":"code","151b7a94":"code","133a8dfc":"code","121418c4":"code","00824f93":"code","0a1e1db6":"code","90bc1836":"code","4fce516f":"code","6ac3942d":"code","a11eefc0":"code","f6ecc093":"code","c084310a":"code","261d08d9":"code","65deb009":"code","60251729":"code","e41d8435":"code","baa6ad79":"code","dbf769b3":"code","9b2924b1":"code","ab249fe5":"code","b118866f":"code","0fa94e9e":"code","151edcb6":"code","b031052b":"markdown","e20c310e":"markdown","d5aa22fe":"markdown","80a83127":"markdown","81733cf3":"markdown","bcfcff20":"markdown","c8583ea0":"markdown","63e4eb36":"markdown"},"source":{"e3d8d67e":"%reload_ext autoreload\n%autoreload 2\n%matplotlib inline","52ee0f5f":"from fastai.vision import *\nfrom fastai.callbacks.hooks import *","40037c2e":"path = untar_data(URLs.CAMVID)\npath.ls()","57985615":"path_lbl = path\/'labels'\npath_img = path\/'images'","6f9ad528":"# path = Path('.\/data\/camvid-small')\n\n# def get_y_fn(x): return Path(str(x.parent)+'annot')\/x.name\n\n# codes = array(['Sky', 'Building', 'Pole', 'Road', 'Sidewalk', 'Tree',\n#     'Sign', 'Fence', 'Car', 'Pedestrian', 'Cyclist', 'Void'])\n\n# src = (SegmentationItemList.from_folder(path)\n#        .split_by_folder(valid='val')\n#        .label_from_func(get_y_fn, classes=codes))\n\n# bs=8\n# data = (src.transform(get_transforms(), tfm_y=True)\n#         .databunch(bs=bs)\n#         .normalize(imagenet_stats))","5e6cec10":"fnames = get_image_files(path_img)\nfnames[:3]","119f0e98":"lbl_names = get_image_files(path_lbl)\nlbl_names[:3]","29e72922":"img_f = fnames[0]\nimg = open_image(img_f)\nimg.show(figsize=(5,5))","07140f2e":"get_y_fn = lambda x: path_lbl\/f'{x.stem}_P{x.suffix}'","5d235e97":"mask = open_mask(get_y_fn(img_f))\nmask.show(figsize=(5,5), alpha=1)","0bc14674":"src_size = np.array(mask.shape[1:])\nsrc_size,mask.data","c4479c9a":"codes = np.loadtxt(path\/'codes.txt', dtype=str); codes","374c7333":"size = src_size\/\/2\nbs=8","7ab3ebab":"src = (SegmentationItemList.from_folder(path_img)\n       .split_by_fname_file('..\/valid.txt')\n       .label_from_func(get_y_fn, classes=codes))","aebd17c6":"data = (src.transform(get_transforms(), size=size, tfm_y=True)\n        .databunch(bs=bs, num_workers=0)\n        .normalize(imagenet_stats))","1c965553":"data.show_batch(2, figsize=(10,7))","76db8932":"data.show_batch(2, figsize=(10,7), ds_type=DatasetType.Valid)","1f6e76c6":"name2id = {v:k for k,v in enumerate(codes)}\nvoid_code = name2id['Void']\n\ndef acc_camvid(input, target):\n    target = target.squeeze(1)\n    mask = target != void_code\n    return (input.argmax(dim=1)[mask]==target[mask]).float().mean()","efb2b553":"metrics=acc_camvid\n# metrics=accuracy","4c916c18":"wd=1e-2","79fad0b6":"learn = unet_learner(data, models.resnet34, metrics=metrics, wd=wd)","35a818ec":"lr_find(learn)\nlearn.recorder.plot()","7bdd450f":"lr=3e-3","fbd5056b":"learn.fit_one_cycle(10, slice(lr), pct_start=0.9)","151b7a94":"learn.save('stage-1')","133a8dfc":"learn.load('stage-1');","121418c4":"learn.show_results(rows=3, figsize=(8,9))","00824f93":"learn.unfreeze()","0a1e1db6":"lrs = slice(lr\/400,lr\/4)","90bc1836":"learn.fit_one_cycle(12, lrs, pct_start=0.8)","4fce516f":"learn.save('stage-2');","6ac3942d":"size = src_size\nbs=3","a11eefc0":"data = (src.transform(get_transforms(), size=size, tfm_y=True)\n        .databunch(bs=bs)\n        .normalize(imagenet_stats))","f6ecc093":"learn = unet_learner(data, models.resnet34, metrics=metrics, wd=wd)","c084310a":"learn.load('stage-2');","261d08d9":"lr_find(learn)\nlearn.recorder.plot()","65deb009":"lr=1e-3","60251729":"learn.fit_one_cycle(10, slice(lr), pct_start=0.8)","e41d8435":"learn.save('stage-1-big')","baa6ad79":"learn.load('stage-1-big');","dbf769b3":"learn.unfreeze()","9b2924b1":"lrs = slice(1e-6,lr\/10)","ab249fe5":"learn.fit_one_cycle(10, lrs)","b118866f":"learn.save('stage-2-big')","0fa94e9e":"learn.load('stage-2-big');","151edcb6":"learn.show_results(rows=3, figsize=(10,10))","b031052b":"## Data","e20c310e":"## Image segmentation with CamVid","d5aa22fe":"## Datasets","80a83127":"You may have to restart your kernel and come back to this stage if you run out of memory, and may also need to decrease `bs`.","81733cf3":"## Model","bcfcff20":"## Subset classes","c8583ea0":"## Go big","63e4eb36":"## fin"}}