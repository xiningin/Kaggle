{"cell_type":{"0808b2e6":"code","3bdb841c":"code","dd5286c6":"code","71a1fe2d":"code","648d5bd5":"code","9994889b":"code","12387026":"code","22c33d27":"code","dc949442":"code","ce540828":"code","9274c4ec":"code","41f3984e":"code","74454f74":"code","4b6adfb2":"code","bd585f3f":"code","4deae0d9":"code","387575d9":"code","9283dcf2":"code","5b2df5a5":"code","c9af2e8d":"code","d1a1d7df":"code","1844d49c":"code","8cc1c890":"code","3ffd7ee3":"code","5bf0123e":"code","8b4244bb":"code","c97bd66b":"code","dd84ef61":"code","5a1135f5":"code","efcb3239":"code","e13e46e1":"code","380c5109":"code","8ab58573":"code","57234209":"code","d246a93b":"code","99d4e53e":"code","6977a399":"code","e0ea06e6":"code","fe81f535":"code","766c4528":"code","c90490a6":"code","45d3b97a":"code","d63090c7":"code","cab4b0c8":"code","6252a579":"code","a182eebe":"code","1189c8eb":"code","c2689af7":"code","53b5d515":"code","cc37c71c":"code","735b11f3":"code","86992233":"code","daca4848":"code","4b519698":"code","cec068ff":"code","5548cc88":"code","daae4754":"code","53c88ac8":"code","ba4fc0a1":"code","d5e5123f":"markdown","bd1d5373":"markdown","d4d15b7e":"markdown","b66f8ca6":"markdown","a2780ae6":"markdown","7bd18e64":"markdown","89735623":"markdown","ba6344b1":"markdown","1b8e7c38":"markdown","afee0f3b":"markdown","5d5946ea":"markdown","71275e35":"markdown","97abb531":"markdown","de58b71a":"markdown","887562ad":"markdown","4d9d0e6e":"markdown","bc235200":"markdown","c5ef6b35":"markdown","0e3675ea":"markdown","41c8afcb":"markdown","fe6ea30a":"markdown","c46710f0":"markdown","3f78d5d4":"markdown","176e9839":"markdown","cf6ea01d":"markdown","2bfcc308":"markdown","1f6026ba":"markdown","c3e7869f":"markdown","eb6e4114":"markdown","c77d548b":"markdown","05cd27b5":"markdown","720df07b":"markdown","df5c39f8":"markdown","0a92ead5":"markdown","b6c93a35":"markdown","9b38e2c8":"markdown"},"source":{"0808b2e6":"# This Python 3 environment comes with many helpful analytics libraries installed\n# It is defined by the kaggle\/python docker image: https:\/\/github.com\/kaggle\/docker-python\n# For example, here's several helpful packages to load in \n\nimport numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\n\n# Input data files are available in the \"..\/input\/\" directory.\n# For example, running this (by clicking run or pressing Shift+Enter) will list the files in the input directory\n\nimport os\nprint(os.listdir(\"..\/input\"))\n\n# Any results you write to the current directory are saved as output.\n\nimport time\nimport matplotlib.pyplot as plt\nimport seaborn as sns\nimport calendar\nimport folium\nimport lightgbm as lgbm","3bdb841c":"start_time = time.time() # track time\ntrain=pd.read_csv(\"..\/input\/train.csv\",nrows=5000000, usecols = [1,2,3,4,5,6,7])\nprint(\"%s seconds\" % (time.time() - start_time))\ntrain.head()","dd5286c6":"train.info()","71a1fe2d":"start_time = time.time() # track time\ntest =  pd.read_csv('..\/input\/test.csv', usecols = [1,2,3,4,5,6])\nprint(\"%s seconds\" % (time.time() - start_time))","648d5bd5":"# check the shape \nprint (test.shape)\nprint (train.shape)\n\n# check the head\nprint (test.head())\nprint (train.head())","9994889b":"#check null value\nprint(test.isnull().sum())\n#check zero value\nprint((test == 0).astype(int).sum(axis=0))","12387026":"# check description\ntest.describe()","22c33d27":"#check null value \nprint(train.isnull().sum())\n#check zero value \nprint((train == 0).astype(int).sum(axis=0))","dc949442":"train.describe()","ce540828":"# Delete null value\nprint(\"old: %d\" %len(train))\ntrain = train.dropna(how = 'any', axis = 'rows')\nprint(\"new: %d\" %len(train)) # track data amount before and after deletion\n\n# Delete zero value\nprint(\"old: %d\" %len(train))\ntrain = train[~(train == 0).any(axis=1)] # or train = train[(train!=0).any(axis=1)]\nprint(\"new: %d\" %len(train)) ","9274c4ec":"mask = train['pickup_longitude'].between(-74.3, -72.9)\nmask &= train['dropoff_longitude'].between(-74.3, -72.9)\nmask &= train['pickup_latitude'].between(40.5, 41.8)\nmask &= train['dropoff_latitude'].between(40.5, 41.7)\nmask &= train['passenger_count'].between(0, 6)\nmask &= train['fare_amount'].between(2.5, 200)\n\nprint(\"old: %d\" %len(train))\ntrain = train[mask]\nprint(\"new: %d\" %len(train)) # track data amount before and after deletion","41f3984e":"def Convert_datetime(df):\n    df['pickup_datetime']=pd.to_datetime(df['pickup_datetime'],format='%Y-%m-%d %H:%M:%S UTC')\n\nConvert_datetime(train)\nConvert_datetime(test)\ntrain.head()\ntest.head()","74454f74":"train.info()","4b6adfb2":"def Divide_date(df):\n    #df['pickup_date']= df['pickup_datetime'].dt.date\n    df['pickup_day']= df['pickup_datetime'].apply(lambda x:x.day)\n    df['pickup_hour']= df['pickup_datetime'].apply(lambda x:x.hour)\n    df['pickup_month']= df['pickup_datetime'].apply(lambda x:x.month)\n    df['pickup_year']= df['pickup_datetime'].apply(lambda x:x.year)\n    #df['pickup_day_of_week']=df['pickup_datetime'].apply(lambda x:calendar.day_name[x.weekday()])\n    df['weekday'] = df['pickup_datetime'].dt.weekday","bd585f3f":"Divide_date(train)\nDivide_date(test)","4deae0d9":"plt.figure(figsize=(8,5))\nsns.kdeplot(train['fare_amount']).set_title(\"Distribution of Trip Fare\")","387575d9":"plt.figure(figsize=(8,5))\nsns.kdeplot(np.log(train['fare_amount'].values)).set_title(\"Distribution of fare amount (log scale)\")","9283dcf2":"#Boundaries of the city\ncity_long_border = (-74.03, -73.75)\ncity_lat_border = (40.63, 40.85)\n\ntrain.plot(kind='scatter', x='dropoff_longitude', y='dropoff_latitude',color='red', s=.02, alpha=.6)\nplt.title(\"Dropoffs\")\n\nplt.ylim(city_lat_border)\nplt.xlim(city_long_border)","5b2df5a5":"train.plot(kind='scatter', x='pickup_longitude', y='pickup_latitude',color='green', s=.02, alpha=.6)\nplt.title(\"Pickups\")\n\nplt.ylim(city_lat_border)\nplt.xlim(city_long_border)","c9af2e8d":"#Round pickup and dropoff lat lng to 3 decimal places\ndef Round3(df):\n    df['pickup_latitude_round3']=df['pickup_latitude'].apply(lambda x:round(x,3))\n    df['pickup_longitude_round3']=df['pickup_longitude'].apply(lambda x:round(x,3))\n    df['dropoff_latitude_round3']=df['dropoff_latitude'].apply(lambda x:round(x,3))\n    df['dropoff_longitude_round3']=df['dropoff_longitude'].apply(lambda x:round(x,3))\n\nRound3(train)\nRound3(test)","d1a1d7df":"pickup_fare_amount = train.groupby(['pickup_latitude_round3','pickup_longitude_round3'])\npickup_fare_amount = pickup_fare_amount['fare_amount'].mean().reset_index().rename(columns={'fare_amount':'avg_fare'})\npickup_fare_amount.head()","1844d49c":"JFK={'min_lng':-73.8352,\n     'min_lat':40.6195,\n     'max_lng':-73.7401, \n     'max_lat':40.6659}\nJFK_center=[40.6437,-73.7900]\n\n# Get all pickups to JFK\nJFK_data=train.loc[(train.pickup_latitude>=JFK['min_lat']) & (train.pickup_latitude<=JFK['max_lat'])]\nJFK_data=JFK_data.loc[(train.pickup_longitude>=JFK['min_lng']) & (train.pickup_longitude<=JFK['max_lng'])]\n\n# Get all dropoffs to JFK\nJFK_dropoff=train.loc[(train.dropoff_latitude>=JFK['min_lat']) & (train.dropoff_latitude<=JFK['max_lat'])]\nJFK_dropoff=JFK_dropoff.loc[(train.dropoff_longitude>=JFK['min_lng']) & (train.dropoff_longitude<=JFK['max_lng'])]","8cc1c890":"plt.figure(figsize=(8,5))\nsns.kdeplot(np.log(JFK_data['fare_amount'].values),label='JFK Pickups')\nsns.kdeplot(np.log(train['fare_amount'].values),label='All Trips in Train data')\nplt.title(\"Fare Amount Distribution\")","3ffd7ee3":"plt.figure(figsize=(8,5))\nsns.kdeplot(np.log(JFK_dropoff['fare_amount'].values),label='JFK Droppoffs')\nsns.kdeplot(np.log(train['fare_amount'].values),label='All Trips in Train data')\nplt.title(\"Dropoffs vs Fare Amount\")","5bf0123e":"del JFK_data\ndel JFK_dropoff","8b4244bb":"## Based on the above, let us create a function to see whether pickup or dropoff is an Airport. \nnyc_airports={'JFK':{'min_lng':-73.8352,\n     'min_lat':40.6195,\n     'max_lng':-73.7401, \n     'max_lat':40.6659},\n              \n    'EWR':{'min_lng':-74.1925,\n            'min_lat':40.6700, \n            'max_lng':-74.1531, \n            'max_lat':40.7081\n\n        },\n    'LaGuardia':{'min_lng':-73.8895, \n                  'min_lat':40.7664, \n                  'max_lng':-73.8550, \n                  'max_lat':40.7931\n    }\n}\ndef isAirport(latitude,longitude,airport_name='JFK'):\n    if latitude>=nyc_airports[airport_name]['min_lat'] and latitude<=nyc_airports[airport_name]['max_lat'] and longitude>=nyc_airports[airport_name]['min_lng'] and longitude<=nyc_airports[airport_name]['max_lng']:\n        return 1\n    else:\n        return 0","c97bd66b":"def JFK(df):\n    df['is_pickup_JFK']=df.apply(lambda row:isAirport(row['pickup_latitude'],row['pickup_longitude'],'JFK'),axis=1)\n    df['is_dropoff_JFK']=df.apply(lambda row:isAirport(row['dropoff_latitude'],row['dropoff_longitude'],'JFK'),axis=1)\ndef EWR(df):\n    df['is_pickup_EWR']=df.apply(lambda row:isAirport(row['pickup_latitude'],row['pickup_longitude'],'EWR'),axis=1)\n    df['is_dropoff_EWR']=df.apply(lambda row:isAirport(row['dropoff_latitude'],row['dropoff_longitude'],'EWR'),axis=1)\ndef LaGuardia(df):\n    df['is_pickup_la_guardia']=df.apply(lambda row:isAirport(row['pickup_latitude'],row['pickup_longitude'],'LaGuardia'),axis=1)\n    df['is_dropoff_la_guardia']=df.apply(lambda row:isAirport(row['dropoff_latitude'],row['dropoff_longitude'],'LaGuardia'),axis=1)","dd84ef61":"JFK(train)\nJFK(test)\nEWR(train)\nEWR(test)\nLaGuardia(train)\nLaGuardia(test)","5a1135f5":"# Define distance in km\ndef dist(pickup_longitude,pickup_latitude,dropoff_longitude,dropoff_latitude):\n    pickup_longitude,pickup_latitude,dropoff_longitude,dropoff_latitude = map(np.radians, [pickup_longitude,pickup_latitude,dropoff_longitude,dropoff_latitude])\n    dlon = dropoff_longitude - pickup_longitude\n    dlat = dropoff_latitude - pickup_latitude\n    a = np.sin(dlat\/2.0)**2 + np.cos(pickup_latitude) * np.cos(dropoff_latitude) * np.sin(dlon\/2.0)**2\n    c = 2 * np.arcsin(np.sqrt(a))\n    distance = 6367 * c\n    return distance","efcb3239":"train['trip_distance']=train.apply(lambda row:dist(row['pickup_longitude'],row['pickup_latitude'],row['dropoff_longitude'],row['dropoff_latitude']),axis=1)\ntest['trip_distance']=test.apply(lambda row:dist(row['pickup_longitude'],row['pickup_latitude'],row['dropoff_longitude'],row['dropoff_latitude']),axis=1)","e13e46e1":"train.head()","380c5109":"sns.kdeplot(np.log(train['trip_distance'].values)).set_title(\"Distribution of Trip Distance (log scale)\")","8ab58573":"plt.scatter(x=train['trip_distance'],y=train['fare_amount'],alpha=0.1)\nplt.xlabel(\"Trip Distance\")\nplt.ylabel(\"Fare Amount\")\nplt.title(\"Trip Distance vs Fare Amount\")","57234209":"non_airport=train.loc[(train['is_dropoff_JFK']==0) & (train['is_dropoff_EWR']==0) & (train['is_dropoff_la_guardia']==0)]\nnon_airport=non_airport.loc[(non_airport['is_pickup_JFK']==0) & (non_airport['is_pickup_EWR']==0) & (non_airport['is_pickup_la_guardia']==0)]","d246a93b":"plt.scatter(x=non_airport['trip_distance'],y=non_airport['fare_amount'],alpha=0.1)\nplt.xlabel(\"Trip Distance\")\nplt.ylabel(\"Fare Amount\")\nplt.title(\"Trip Distance vs Fare Amount (excluding airport rides)\")","99d4e53e":"non_airport_long_trips=non_airport[non_airport['trip_distance']>=80]","6977a399":"drop_map = folium.Map(location = [40.730610,-73.935242],zoom_start = 11.7)\n\nfor index, row in non_airport_long_trips.iterrows():   \n    folium.CircleMarker([row['dropoff_latitude_round3'], row['dropoff_longitude_round3']],\n                        radius=3,\n                        color=\"green\", \n                        fill_opacity=0.9\n                       ).add_to(drop_map)\nfor index, row in non_airport_long_trips.iterrows():\n    folium.CircleMarker([row['pickup_latitude_round3'], row['pickup_longitude_round3']],\n                        radius=3,     \n                        color=\"red\", \n                        fill_opacity=0.9\n                       ).add_to(drop_map)\ndrop_map","e0ea06e6":"nyc_boroughs={\n    'manhattan':{\n        'min_lng':-74.0479,\n        'min_lat':40.6829,\n        'max_lng':-73.9067,\n        'max_lat':40.8820\n    },\n    'queens':{\n        'min_lng':-73.9630,\n        'min_lat':40.5431,\n        'max_lng':-73.7004,\n        'max_lat':40.8007\n    },\n    'brooklyn':{\n        'min_lng':-74.0421,\n        'min_lat':40.5707,\n        'max_lng':-73.8334,\n        'max_lat':40.7395\n    },\n    'bronx':{\n        'min_lng':-73.9339,\n        'min_lat':40.7855,\n        'max_lng':-73.7654,\n        'max_lat':40.9176\n    },\n    'staten_island':{\n        'min_lng':-74.2558,\n        'min_lat':40.4960,\n        'max_lng':-74.0522,\n        'max_lat':40.6490\n    } \n}\ndef getBorough(lat,lng):\n    locs=nyc_boroughs.keys()\n    for loc in locs:\n        if lat>=nyc_boroughs[loc]['min_lat'] and lat<=nyc_boroughs[loc]['max_lat'] and lng>=nyc_boroughs[loc]['min_lng'] and lng<=nyc_boroughs[loc]['max_lng']:\n            return loc\n    return 'others'","fe81f535":"train['pickup_borough']=train.apply(lambda row:getBorough(row['pickup_latitude'],row['pickup_longitude']),axis=1)\ntrain['dropoff_borough']=train.apply(lambda row:getBorough(row['dropoff_latitude'],row['dropoff_longitude']),axis=1)\n\ntest['pickup_borough']=test.apply(lambda row:getBorough(row['pickup_latitude'],row['pickup_longitude']),axis=1)\ntest['dropoff_borough']=test.apply(lambda row:getBorough(row['dropoff_latitude'],row['dropoff_longitude']),axis=1)","766c4528":"plt.figure(figsize=(8,5))\nsns.countplot(train['pickup_borough'])\nplt.title(\"Distribution of Pickup Boroughs\")","c90490a6":"plt.figure(figsize=(16,10))\nplt.title(\"Distribution of Fare Amount Across Buroughs\")\ni=1\nfor key in nyc_boroughs.keys():\n    plt.subplot(3,2,i)\n    sns.kdeplot(np.log(train.loc[train['pickup_borough']==key,'fare_amount'].values),label='Pickup '+ key)\n    sns.kdeplot(np.log(train.loc[train['dropoff_borough']==key,'fare_amount'].values),label='Dropoff'+ key).set_title(\"Fare Amount (log scale) for \"+key)\n    \n    i=i+1","45d3b97a":"plt.figure(figsize=(16,10))\nplt.title(\"Distribution of Trip Distances Across Buroughs\")\ni=1\nfor key in nyc_boroughs.keys():\n    plt.subplot(3,2,i)\n    sns.kdeplot(np.log(train.loc[train['pickup_borough']==key,'trip_distance'].values),label='Pickup '+ key)\n    sns.kdeplot(np.log(train.loc[train['dropoff_borough']==key,'trip_distance'].values),label='Dropoff'+ key).set_title(\"Trip Distance (log scale) for \"+key)\n    i=i+1","d63090c7":"lower_manhattan_boundary={'min_lng': -74.0194,\n                          'min_lat':40.6997,\n                          'max_lng':-73.9716,\n                          'max_lat':40.7427}\n\ndef isLowerManhattan(lat,lng):\n    if lat>=lower_manhattan_boundary['min_lat'] and lat<=lower_manhattan_boundary['max_lat'] and lng>=lower_manhattan_boundary['min_lng'] and lng<=lower_manhattan_boundary['max_lng']:\n        return 1\n    else:\n        return 0","cab4b0c8":"train['is_pickup_lower_manhattan']=train.apply(lambda row:isLowerManhattan(row['pickup_latitude'],row['pickup_longitude']),axis=1)\ntrain['is_dropoff_lower_manhattan']=train.apply(lambda row:isLowerManhattan(row['dropoff_latitude'],row['dropoff_longitude']),axis=1)\n\ntest['is_pickup_lower_manhattan']=test.apply(lambda row:isLowerManhattan(row['pickup_latitude'],row['pickup_longitude']),axis=1)\ntest['is_dropoff_lower_manhattan']=test.apply(lambda row:isLowerManhattan(row['dropoff_latitude'],row['dropoff_longitude']),axis=1)","6252a579":"manhattan=train.loc[(train['pickup_borough']=='manhattan') | (train['dropoff_borough']=='manhattan')]\n\nplt.figure(figsize=(16,10))\nplt.subplot(3,2,1)\nsns.kdeplot(np.log(manhattan.loc[manhattan['is_pickup_lower_manhattan']==1,'fare_amount'].values),label='Lower Manhattan Pickups')\nsns.kdeplot(np.log(manhattan.loc[manhattan['is_pickup_lower_manhattan']==0,'fare_amount'].values),label='Rest of Manhattan Pickups')\nplt.xlabel(\"fare amount (log)\")\nplt.title(\"Distribution of Fare Amount - Manhattan vs Lower Manhattan\")\n\nplt.subplot(3,2,2)\nsns.kdeplot(np.log(manhattan.loc[manhattan['is_dropoff_lower_manhattan']==1,'fare_amount'].values),label='Lower Manhattan Dropoffs')\nsns.kdeplot(np.log(manhattan.loc[manhattan['is_dropoff_lower_manhattan']==0,'fare_amount'].values),label='Rest of Manhattan Dropoffs')\nplt.xlabel(\"fare amount (log)\")\nplt.title(\"Distribution of Fare Amount - Manhattan vs Lower Manhattan\")","a182eebe":"plt.scatter(x=manhattan.loc[manhattan['is_pickup_lower_manhattan']==1,'trip_distance'].values,y=manhattan.loc[manhattan['is_pickup_lower_manhattan']==1,'fare_amount'].values,alpha=0.1)\nplt.xlabel(\"Trip Distance\")\nplt.ylabel(\"Fare Amount\")\nplt.title(\"Trip Distance vs Fare Amount (Lower Manhattan pickups)\")","1189c8eb":"plt.scatter(x=manhattan.loc[manhattan['is_pickup_lower_manhattan']==0,'trip_distance'].values,y=manhattan.loc[manhattan['is_pickup_lower_manhattan']==0,'fare_amount'].values,alpha=0.1)\nplt.xlabel(\"Trip Distance\")\nplt.ylabel(\"Fare Amount\")\nplt.title(\"Trip Distance vs Fare Amount (Rest of Manhattan pickups)\")","c2689af7":"plt.scatter(x=manhattan.loc[manhattan['is_dropoff_lower_manhattan']==1,'trip_distance'].values,y=manhattan.loc[manhattan['is_dropoff_lower_manhattan']==1,'fare_amount'].values,alpha=0.1)\nplt.xlabel(\"Trip Distance\")\nplt.ylabel(\"Fare Amount\")\nplt.title(\"Trip Distance vs Fare Amount (Lower Manhattan dropoffs)\")","53b5d515":"plt.scatter(x=manhattan.loc[manhattan['is_dropoff_lower_manhattan']==0,'trip_distance'].values,y=manhattan.loc[manhattan['is_dropoff_lower_manhattan']==0,'fare_amount'].values, alpha=0.1)\nplt.xlabel(\"Trip Distance\")\nplt.ylabel(\"Fare Amount\")\nplt.title(\"Trip Distance vs Fare Amount (Rest of Manhattan dropoffs)\")","cc37c71c":"trips_year_fareamount=train.groupby(['pickup_year'])['fare_amount'].mean().reset_index().rename(columns={'fare_amount':'avg_fare_amount'})\ntrips_year_fareamount.head()","735b11f3":"sns.barplot(x='pickup_year',y='avg_fare_amount',data=trips_year_fareamount).set_title(\"Average Fare Amount over Years\")","86992233":"#Info : There is a daily 50-cent surcharge from 8pm to 6am.\ntrain['night_hour'] = np.where((train['pickup_hour'] >= 20) | (train['pickup_hour'] <= 6) , 1, 0)\ntest['night_hour'] = np.where((test['pickup_hour'] >= 20) | (test['pickup_hour'] <= 6) , 1, 0)\n\n#Info : There is a $1 surcharge from 4pm to 8pm on weekdays, excluding holidays.\ntrain['peak_hour'] = np.where((train['pickup_hour'] >= 16) \n                              & (train['pickup_hour'] <= 20) \n                              &  (train['weekday'] >= 0) \n                              & (train['weekday'] <= 4) , 1, 0)\n    \ntest['peak_hour'] = np.where((test['pickup_hour'] >= 16) &\n                            (test['pickup_hour'] <= 20) & \n                            (test['weekday'] >=0) &\n                            (test['weekday'] <=4) , 1, 0)","daca4848":"print (test.shape)\nprint (train.shape)","4b519698":"# Check corr of 'fare_amount' to all the other variables\nprint(train.corrwith(train['fare_amount']))","cec068ff":"#We can choose to remove the variables that has the corr less than 0.1\ntrain = train.drop(['passenger_count','pickup_hour','pickup_day','pickup_month','weekday'], axis = 1)\ntest = test.drop(['passenger_count','pickup_hour','pickup_day','pickup_month','weekday'], axis = 1)","5548cc88":"train = train.drop(['pickup_datetime', 'pickup_borough', 'dropoff_borough'], axis = 1)\ntest = test.drop(['pickup_datetime', 'pickup_borough', 'dropoff_borough'], axis = 1)","daae4754":"#Split the train data for model training\nfrom sklearn.model_selection import train_test_split \nX_train, X_test, y_train, y_test = train_test_split(train.drop('fare_amount', axis=1),\n                                                    train['fare_amount'], test_size=0.15, random_state = 111)\n\n# Check shape\nprint(X_train.shape)\nprint(X_test.shape)\nprint(y_train.shape)\nprint(y_test.shape)","53c88ac8":"# Use lightgbm model to do the training.\nparams = {\n        'boosting_type':'gbdt',\n        'objective': 'regression',\n        'nthread': 4,\n        'num_leaves': 31,\n        'learning_rate': 0.05,\n        'max_depth': -1,\n        'subsample': 0.8,\n        'bagging_fraction' : 1,\n        'max_bin' : 5000 ,\n        'bagging_freq': 20,\n        'colsample_bytree': 0.6,\n        'metric': 'rmse',\n        'min_split_gain': 0.5,\n        'min_child_weight': 1,\n        'min_child_samples': 10,\n        'scale_pos_weight':1,\n        'zero_as_missing': True,\n        'seed':0,\n        'num_rounds':50000\n    }\ndef LGBMmodel(X_train,X_test,y_train,y_test,params):\n    matrix_train = lgbm.Dataset(X_train, y_train)\n    matrix_test = lgbm.Dataset(X_test, y_test)\n    model=lgbm.train(params=params,\n                    train_set=matrix_train,\n                    num_boost_round=100000, \n                    early_stopping_rounds=500,\n                    verbose_eval=100,\n                    valid_sets=matrix_test)\n    return model","ba4fc0a1":"# Train the model\n\nmodel = LGBMmodel(X_train,X_test,y_train,y_test,params)","d5e5123f":"New York city is divided into 7 Boroughs. Let us calculate which borough pickup and dropoff points are. And whether that effects the fare","bd1d5373":"Here is the means for computing earth surface distance in km base on longitude and latitude of pickup and dropoff points.","d4d15b7e":"Let us now look at datetime features and their realtionship with Fare Amount","b66f8ca6":"*Apart from Manhattan, we can see heavy pickups and dropoffs near JFK and La Guardia Airport.*","a2780ae6":"**Distribution of Pickup and Dropoff**","7bd18e64":"**Distribution of Trip Fare**","89735623":"The distribution of trip distance and fare amount for Lower Manhattan pickups and dropoffs is very different. Also, slope of linear realtionship for pickups for Lower Manhattan is higher than that for Rest of Manhattan","ba6344b1":"*The fare seems to be fixed for trip distances > 80 km; generally they are dropoffs and pickups from and to airports.*","1b8e7c38":"Dropoffs to Bronx and Staten island are long trips. In Manhattan the pickup and dropoffs fare amount has similar distribution. Let us add a field, is_lower_manhattan as we had seen above that dropoffs to lower manhattan had higher trip distance but lower fare","afee0f3b":"*In the scatter plot, we saw the high density of pickups and dropoffs from and to JFK and La Guardia Airport.\nLet us look at over time how fares are from La Guardia and JFK*","5d5946ea":"Remove observations with useless values base on the test data boundary.\nYou can have some informations about nyc taxi fare from https:\/\/www1.nyc.gov\/site\/tlc\/passengers\/taxi-fare.page\nlike initial charge is $2.50 so data with fare less than this value should be removed.","71275e35":"*We can see that testing data lack one column : 'fare_amount', which is what we are going to predict.*","97abb531":"*There is a significant difference in pickups and dropoffs fare amount for each burough exceept Manhattan. We can see pickups from Queens is expensive compared to pickups from other Buroughs.Very high difference in pickup and dropoff prices for Staten Island.","de58b71a":"*In the plot above, we can see two clusters with linear realtionship between taxi fare and distance. But for trip distances >80 km, though a linear relationship exists, the fare amount is very low. Let us check where these trips originate and end.*","887562ad":"**Check for Missing Values**","4d9d0e6e":"*Info : Normally airports pickup or dropoff have fixed prices. We can define non-airport category to see the effect on fare amount.*","bc235200":"*Most of the long trips dropoffs and pickups are in lower Manhattan. There are a lot of dropoffs in Brooklyn*","c5ef6b35":"* **Distribution of fare amount heatmap**","0e3675ea":"*Distribution of fare amount for both pickup and dropoff to JFK is similar;\nthe fare amount is much higher when pickup or dropoff are from and to JFK.*","41c8afcb":"*Average Fare amount has beern increasing over the years.*","fe6ea30a":"**3. Feature engineering**","c46710f0":"**Reading testing data**","3f78d5d4":"**Date time features**","176e9839":"*By checking the description of test data, we can choose to clean the train data base on these value. In other word, we can delete the values that are out of these boundaries in the train data*","cf6ea01d":"Remove observations with zero or null values ","2bfcc308":"**Compare training data and testing data**","1f6026ba":"Series.dt.date\nReturns numpy array of python datetime.date objects (namely, the date part of Timestamps without timezone information).","c3e7869f":"Convert pickup_datetime from Object to Datetime object","eb6e4114":"Let us look at Geographical Features","c77d548b":"**1. DATA EXPLORATION**","05cd27b5":"*The test data is very clean, with no null value or zero value*","720df07b":"**2.  DATA CLEANING**","df5c39f8":"**4. Prediction**","0a92ead5":"**Training data has 55M rows. In this kernel, we shall only read in 5M rows**","b6c93a35":"*Since we saw above that fare amount is highly skewed, let us take log transformation of the fare amount and plot the distribution.*","9b38e2c8":"*In our training data, there are some wrong values (for example the min of fare_amount is negative & the max value of passenger count is 208). We have to delete this values base on the value boundary in the test data.*"}}