{"cell_type":{"33c48097":"code","0af64ce6":"code","5f23e846":"code","5a02aaac":"code","78fb6740":"code","54bf7c4e":"code","df98273e":"code","16c3f922":"code","0aafc305":"code","30049636":"code","af2455ad":"code","53170c8e":"code","3a7e4533":"code","656c399c":"code","4b114bb4":"code","1ef20685":"code","c8e6722b":"code","8bcb9b70":"code","e9363797":"code","64d54899":"markdown"},"source":{"33c48097":"%reload_ext autoreload\n%autoreload 2\n%matplotlib inline\nfrom fastai.imports import *\nfrom fastai.transforms import *\nfrom fastai.conv_learner import *\nfrom fastai.model import *\nfrom fastai.dataset import *\nfrom fastai.sgdr import *\nfrom fastai.plots import *\nimport numpy as np\nimport pandas as pd\nimport os","0af64ce6":"labels = pd.read_csv(\"..\/input\/labels.csv\")","5f23e846":"## validation data\n#val_idxs = get_cv_idxs(labels.shape[0])","5a02aaac":"PATH = \"..\/input\/\"\nTMP_PATH = \"\/tmp\/tmp\"\nMODEL_PATH = \"\/tmp\/model\/\"","78fb6740":"arch=resnet101\nsz=224\nbs=48","54bf7c4e":"tfms = tfms_from_model(arch, sz, aug_tfms=transforms_side_on, max_zoom=1.1)","df98273e":"data = ImageClassifierData.from_csv(path=PATH, folder=\"train\", csv_fname=f\"{PATH}labels.csv\", tfms=tfms, suffix=\".jpg\", test_name=\"test\",bs=bs,num_workers=4)","16c3f922":"learn = ConvLearner.pretrained(arch, data, precompute=True, tmp_name=TMP_PATH, models_name=MODEL_PATH, ps=0.4)","0aafc305":"lrf = learn.lr_find()\nlearn.sched.plot()\n","30049636":"def get_data(sz,bs):\n    tfms = tfms_from_model(arch, sz, aug_tfms=transforms_side_on, max_zoom = 1.1)\n    data = ImageClassifierData.from_csv(PATH, 'train', f'{PATH}labels.csv', test_name='test', suffix='.jpg',tfms=tfms, bs=bs, num_workers=4)\n    return data if sz > 300 else data.resize(sz, '\/tmp')","af2455ad":"##without augmentation\nlearn.fit(1e-1, 5)\n","53170c8e":"##with augmentation\nlearn.precompute=False\nlearn.fit(1e-1, 5, cycle_len=1)","3a7e4533":"## increase size trick\nlearn.set_data(get_data(299,bs))","656c399c":"##and now resized\nlearn.fit(1e-1, 3, cycle_len=1)","4b114bb4":"learn.fit(1e-1,3,cycle_len=1,cycle_mult=2)","1ef20685":"learn.fit(1e-1, 1, cycle_len=2)","c8e6722b":"## unfreezing doesnt help in this case....","8bcb9b70":"from sklearn.metrics import log_loss\nlog_preds, y = learn.TTA()\nprobs = np.mean(np.exp(log_preds), 0)\naccuracy_np(probs, y), log_loss(y, probs)","e9363797":"log_preds_test, y_test = learn.TTA(is_test=True)\nprobs_test = np.mean(np.exp(log_preds_test), 0)\ndf = pd.DataFrame(probs_test)\ndf.columns = data.classes\ndf.insert(0, \"id\", [e[5:-4] for e in data.test_ds.fnames])\ndf.to_csv(\"submission.csv\", index=False)","64d54899":"### Thanks to authors of these notebooks for helpful examples of how to imitate the fast.ai MOOC code within a kernel\n\nhttps:\/\/www.kaggle.com\/stefanbuenten\/dog-breed-test-with-fastai\n\nhttps:\/\/www.kaggle.com\/hortonhearsafoo\/fast-ai-lesson-1"}}