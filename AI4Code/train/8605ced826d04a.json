{"cell_type":{"f124df4f":"code","5dc838e5":"code","d3c9808a":"code","d91c1fd8":"code","22895e1f":"code","a0feb66a":"code","336cd4c5":"code","8d8ef9a5":"code","44b8ca19":"code","0081ebd8":"code","127cdd8d":"code","7e93fe3b":"code","f29f3f00":"code","cee68d3e":"code","ae22d6b8":"code","8ca0b2c5":"code","b7e97446":"code","d79db711":"code","63486022":"code","7fda2179":"code","c75e02d4":"code","95cb9f9f":"code","03dd7d76":"code","d537c078":"code","2c0eeb7f":"code","88610e85":"code","e34aae0f":"code","81a05d58":"code","b98ee90e":"code","f475b9eb":"code","fc9bb6d2":"code","bb79e4fa":"code","8b85baea":"code","f3961326":"code","1505aee3":"code","11f150dc":"code","d6e1ad6c":"code","b2e2e6ce":"markdown","cbe07b85":"markdown","1faf0279":"markdown","074ebfaa":"markdown","ba00eaaf":"markdown","4160ba81":"markdown","fc2b8ddb":"markdown","6e2c42a3":"markdown","9ce5bf82":"markdown","ce1e48c4":"markdown"},"source":{"f124df4f":"!pip install -q fastai2\n!pip install -q azure-cognitiveservices-search-imagesearch\n!pip install -q jovian","5dc838e5":"#hide\n# from utils import *\nfrom fastai2.vision.widgets import *","d3c9808a":"from fastai2.vision.all import *\nfrom azure.cognitiveservices.search.imagesearch import ImageSearchClient as api\nfrom msrest.authentication import CognitiveServicesCredentials as auth\ndef search_images_bing(key, term, min_sz=128):\n    client = api('https:\/\/api.cognitive.microsoft.com', auth(key))\n    return L(client.images.search(query=term, count=150, min_height=min_sz, min_width=min_sz).value)","d91c1fd8":"from kaggle_secrets import UserSecretsClient\nuser_secrets = UserSecretsClient()\nsecret_value = user_secrets.get_secret(\"bing\")\n\nkey = secret_value","22895e1f":"search_images_bing","a0feb66a":"results = search_images_bing(key, 'grizzly bear')\nims = results.attrgot('content_url')\nlen(ims)","336cd4c5":"bear_types = 'grizzly','black','teddy'\npath = Path('bears')","8d8ef9a5":"if not path.exists():\n    path.mkdir()\n    for o in bear_types:\n        dest = (path\/o)\n        dest.mkdir(exist_ok=True)\n        results = search_images_bing(key, f'{o} bear')\n        download_images(dest, urls=results.attrgot('content_url'))","44b8ca19":"fns = get_image_files(path)\nfns","0081ebd8":"failed = verify_images(fns)\nfailed","127cdd8d":"failed.map(Path.unlink);","7e93fe3b":"bears = DataBlock(\n    blocks=(ImageBlock, CategoryBlock), \n    get_items=get_image_files, \n    splitter=RandomSplitter(valid_pct=0.3, seed=42),\n    get_y=parent_label,\n    item_tfms=Resize(128))","f29f3f00":"dls = bears.dataloaders(path)","cee68d3e":"dls.valid.show_batch(max_n=4, nrows=1)","ae22d6b8":"bears = bears.new(item_tfms=Resize(128, ResizeMethod.Squish))\ndls = bears.dataloaders(path)\ndls.valid.show_batch(max_n=4, nrows=1)","8ca0b2c5":"bears = bears.new(item_tfms=Resize(128, ResizeMethod.Pad, pad_mode='zeros'))\ndls = bears.dataloaders(path)\ndls.valid.show_batch(max_n=4, nrows=1)","b7e97446":"bears = bears.new(item_tfms=RandomResizedCrop(128, min_scale=0.3))\ndls = bears.dataloaders(path)\ndls.train.show_batch(max_n=4, nrows=1, unique=True)","d79db711":"bears = bears.new(item_tfms=Resize(128), batch_tfms=aug_transforms(mult=2))\ndls = bears.dataloaders(path)\ndls.train.show_batch(max_n=8, nrows=2, unique=True)","63486022":"bears = bears.new(\n    item_tfms=RandomResizedCrop(224, min_scale=0.5),\n    batch_tfms=aug_transforms())\ndls = bears.dataloaders(path)","7fda2179":"learn = cnn_learner(dls, resnet18, metrics=error_rate)\nlearn.fine_tune(4)","c75e02d4":"interp = ClassificationInterpretation.from_learner(learn)\ninterp.plot_confusion_matrix()","95cb9f9f":"interp.plot_top_losses(5, nrows=1)","03dd7d76":"cleaner = ImageClassifierCleaner(learn)\ncleaner","d537c078":"#hide\nfor idx in cleaner.delete(): cleaner.fns[idx].unlink()\nfor idx,cat in cleaner.change(): shutil.move(str(cleaner.fns[idx]), path\/cat)","2c0eeb7f":"learn.export()","88610e85":"path = Path()\npath.ls(file_exts='.pkl')","e34aae0f":"learn_inf = load_learner(path\/'export.pkl')","81a05d58":"learn_inf.dls.vocab","b98ee90e":"learn_inf.predict(Path('bears\/teddy\/00000057.jpg'))","f475b9eb":"btn_upload = widgets.FileUpload()\nbtn_upload","fc9bb6d2":"img = PILImage.create(btn_upload.data[0])","bb79e4fa":"out_pl = widgets.Output()\nout_pl.clear_output()\nwith out_pl: display(img.to_thumb(128,128))\nout_pl","8b85baea":"pred,pred_idx,probs = learn_inf.predict(img)","f3961326":"lbl_pred = widgets.Label()\nlbl_pred.value = f'Prediction: {pred}; Probability: {probs[pred_idx]:.04f}'\nlbl_pred","1505aee3":"import jovian","11f150dc":"!ls","d6e1ad6c":"jovian.commit(outputs='export.pkl')","b2e2e6ce":"## Gathering data","cbe07b85":"http:\/\/dev.fast.ai\/vision.augment","1faf0279":"## From data to DataLoaders","074ebfaa":"To download images with Bing Image Search, you should sign up at Microsoft for *Bing Image Search*. You will be given a key, which you can either paste here, replacing \"XXX\":","ba00eaaf":"### Data augmentation","4160ba81":"Below is the utils file which is not included via pip distribution, ignore if youre running from fastai's repo","fc2b8ddb":"## Turning your model into an online application","6e2c42a3":"## Training your model, and using it to clean your data","9ce5bf82":"### Using the model for inference","ce1e48c4":"### Creating a Notebook app from the model"}}