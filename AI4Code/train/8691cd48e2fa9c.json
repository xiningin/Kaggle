{"cell_type":{"f08da895":"code","2d358a7e":"code","6090c3dd":"code","bfa50972":"code","aafa7bce":"code","2a19cc17":"code","4e4fd351":"code","2db8c8ed":"code","bed46d44":"code","b2358986":"code","c83bd874":"code","bb2c5f51":"code","3e7d211a":"code","37e3e9e1":"code","711838df":"code","08d62bdb":"code","fef37c4d":"code","974efcb7":"code","8140521a":"code","067eaa62":"code","ea435b64":"code","0b6fd8ee":"code","9b61f101":"code","9cac60f0":"code","ba0dd5b5":"code","a3ae26e0":"markdown","cd07b4d2":"markdown","03daeef0":"markdown","54a24ccc":"markdown","0823e7af":"markdown","01a86888":"markdown","835e62db":"markdown","82a44958":"markdown"},"source":{"f08da895":"import numpy as np\nimport pandas as pd\nimport matplotlib.pyplot as plt\nimport keras as ks\nimport os\nimport cv2","2d358a7e":"train_dir = \"..\/input\/marble-surface-anomaly-detection-2\/dataset\/train\/\"\ntest_dir = \"..\/input\/marble-surface-anomaly-detection-2\/dataset\/test\/\"","6090c3dd":"def get_image(path):\n    img = cv2.imread(path)\n    print(img.shape)\n    plt.imshow(img)","bfa50972":"image = \"..\/input\/marble-surface-anomaly-detection-2\/dataset\/train\/crack\/_0_0_20210531_17292.jpg\"","aafa7bce":"get_image(image)","2a19cc17":"def datapreprocessing(main_dir,bsize):\n    from tensorflow.keras.preprocessing.image import ImageDataGenerator\n    \n    train_gen = ImageDataGenerator(rescale=1.0\/255,\n                                   zoom_range=0.2,\n                                   shear_range=0.1,\n                                   horizontal_flip=True,\n                                   vertical_flip=True,\n                                   rotation_range=20,\n                                   width_shift_range=0.2,\n                                   height_shift_range=0.2,\n                                   #validation_split=0.3,\n                                   fill_mode='nearest',\n                                  )\n\n    train_generator = train_gen.flow_from_directory(\n        directory=main_dir,\n        target_size=(48,48),\n        batch_size=bsize,\n        color_mode=\"rgb\",\n        shuffle=True,\n        subset=\"training\",\n        class_mode='categorical')\n    \n    \n    \n    return train_generator","4e4fd351":"traingen = datapreprocessing(train_dir,20)\nvalidgen = datapreprocessing(test_dir,20)","2db8c8ed":"labelnames = traingen.class_indices\nlabelnames","bed46d44":"#Function that can build a dataframe on passing folderpath.\ndef getdata(folder_path):\n    sig = pd.DataFrame(columns=['image_abs_path','image_labels'])\n    for key,value in labelnames.items():\n        #print(\"processing for label: {}\".format(label))\n        label_i = folder_path+\"\/\"+str(key)\n        #read directory\n        dirs_label_i =  os.listdir(label_i)\n        idx = 0\n        for image in dirs_label_i:\n            #create a absolute image path\n            sig_i = os.path.join(label_i,image)\n            #print('Absolute path for image no. {} and label {}: {}'\\\n                  #.format(idx,label,flower_i))\n\n            #fill the dataframe with path and label\n            sig = sig.append({'image_abs_path':sig_i,\n                            'image_labels':key},\n                           ignore_index=True)\n            idx += 1\n    return sig","b2358986":"#Create Train Dataframe as repository of paths and labels.\nvalid = getdata(test_dir)","c83bd874":"valid","bb2c5f51":"# Fetch n number of images from train data frame\ndef get_n_images(n,df,label):\n    import warnings\n    warnings.filterwarnings('ignore')\n    train = df[df[\"image_labels\"]==label]\n    print(len(train))\n    i = 0\n    m = n\/2\n    plt.figure(figsize=(12, 6))\n    for path in train['image_abs_path'][0:n]:\n        plt.subplot(2,m,i+1)\n        get_image(path)\n        #plt.title(train['image_labels'][i])\n        i += 1\n    plt.tight_layout()\n    plt.show()","3e7d211a":"def visualize_gen(train_generator):   \n    #Visualising Images Processed\n    plt.figure(figsize=(6, 3))\n    for i in range(0, 10):\n        plt.subplot(2, 5, i+1)\n        for X_batch, Y_batch in train_generator:\n            image = X_batch[0]        \n            plt.axis(\"off\")\n            plt.imshow((image*255).astype(np.uint8))\n            break\n    plt.tight_layout()\n    plt.show()","37e3e9e1":"visualize_gen(traingen)","711838df":"input_shape = traingen.image_shape\ninput_shape","08d62bdb":"def imageclf2(input_shape):\n    from tensorflow import keras as ks\n    #from tensorflow.keras import regularizers\n    model = ks.models.Sequential()\n    #building architecture\n    #Adding layers\n    model.add(ks.layers.Conv2D(8,(3,3),\n                               strides=1,\n                               activation=\"relu\",\n                               padding='same',\n                               name=\"layer1\",\n                               input_shape=input_shape))\n    model.add(ks.layers.MaxPooling2D(pool_size=2,strides=2))\n    model.add(ks.layers.Dropout(0.2))\n    model.add(ks.layers.Conv2D(8,(3,3),strides=1,padding=\"same\",activation=\"relu\",name=\"layer2\"))\n    model.add(ks.layers.MaxPooling2D(pool_size=2,strides=2))\n\n    \n    model.add(ks.layers.Flatten())\n    model.add(ks.layers.Dense(128,activation=\"relu\",\n                              name=\"layer5\"))\n    model.add(ks.layers.Dropout(0.2))\n    \n    model.add(ks.layers.Dense(4,activation=\"softmax\",\n                              name=\"output\"))\n    model.summary()\n    \n    return model\n","fef37c4d":"def compiler2(model,train_generator,valid_generator,epchs,bsize=32,lr=0.0001):\n\n    from tensorflow import keras as ks\n    callbck = ks.callbacks.EarlyStopping(monitor='val_loss',patience=10,\n                                         verbose=2,\n                                         restore_best_weights=True,) \n    \n    opt = ks.optimizers.Adam(learning_rate=lr)\n    \n    model.compile(loss=\"categorical_crossentropy\",\n                      optimizer=opt,\n                      metrics=[\"accuracy\"])\n    history = model.fit(train_generator,\n                        epochs=epchs,\n                        callbacks=[callbck],\n                        validation_data=valid_generator,\n                        verbose = 1,\n                        #steps_per_epoch = train_generator.n \/\/ bsize\n                       )\n    #Visualise curves\n    plt.plot(history.history['accuracy'], label='train_acc')\n    plt.plot(history.history['val_accuracy'], label='valid_acc')\n\n    plt.title('lrate='+str(lr), pad=-50)\n    plt.legend()\n    plt.grid(True)\n    return model,history","974efcb7":"model01 = imageclf2(input_shape)","8140521a":"model_com01 = compiler2(model01,traingen,validgen,100)","067eaa62":"#Visualise loss curves\nhistory = model_com01[1]\nplt.plot(history.history['loss'], label='loss')\nplt.plot(history.history['val_loss'], label='val_loss')\nplt.legend()\nplt.grid()\nplt.show()","ea435b64":"def get_predictions(n):\n    import keras as ks\n    image1= validgen[0][0][n]\n    #print(image1.shape)\n    plt.imshow(image1)\n    input_arr = ks.preprocessing.image.img_to_array(validgen[0][0][n])\n    input_arr = np.array([input_arr])  # Convert single image to a batch.\n    predictions = model_com01[0].predict_classes(input_arr)\n    #our dictionary starts from 1 whereas model has classes from 0.\n    return predictions","0b6fd8ee":"get_predictions(11)","9b61f101":"# Fetch n number of images from train data frame\ndef get_n_images(n,df,label):\n    import warnings\n    warnings.filterwarnings('ignore')\n    train = df[df[\"image_labels\"]==label]\n    print(len(train))\n    i = 0\n    m = n\/2\n    plt.figure(figsize=(12, 6))\n    for path in train['image_abs_path'][0:n]:\n        plt.subplot(2,m,i+1)\n        get_image(path)\n        #plt.title(train['image_labels'][i])\n        i += 1\n    plt.tight_layout()\n    plt.show()","9cac60f0":"#Visualise Predictions\nget_n_images(6,valid,\"crack\")","ba0dd5b5":"# save the model to disk\nmodel = model_com01[0]\nmodel.save('saved_models\/MarbleModel.tf')","a3ae26e0":"- Model has predicted the deformation correctly","cd07b4d2":"## Save the model!","03daeef0":"## Build the Compiler","54a24ccc":"### Get Prediction and visualise the output.","0823e7af":"# Marble Defect Classifier\n- This application of detecting defect on metal surface is an example of how deep learning can be implemented to Industrial Processes. \n- It will reduce the inprocess error and add a middle layer to quality inspection.\n- image dimension 256x256\n- There are four classes of deformations.","01a86888":"## Create Image Data Generator","835e62db":"### Fit Model and Evaluate","82a44958":"## Build Model's Architecture"}}