{"cell_type":{"dabf308d":"code","7e5e2b7a":"code","db49b854":"code","921a4755":"code","197e89b2":"code","cf3c9400":"code","d160f3cf":"code","1ca73e2c":"code","c38ccb12":"code","574417a9":"code","1b64d758":"markdown","8c74711b":"markdown"},"source":{"dabf308d":"import fastai\nfrom fastai.vision import *\nfrom sklearn.model_selection import KFold","7e5e2b7a":"# Copy pretrained model weights to the default path\n!mkdir '\/tmp\/.torch'\n!mkdir '\/tmp\/.torch\/models\/'\n#!cp '..\/input\/resnet18\/resnet18.pth' '\/tmp\/.torch\/models\/resnet18-5c106cde.pth'\n#!cp '..\/input\/densenet121\/densenet121.pth' '\/tmp\/.torch\/models\/densenet121-a639ec97.pth'\n!cp '..\/input\/densenet201\/densenet201.pth' '\/tmp\/.torch\/models\/densenet201-c1103571.pth'","db49b854":"fastai.__version__","921a4755":"data_path = Path('..\/input\/aerial-cactus-identification')\ndf = pd.read_csv(data_path\/'train.csv')\ndf.head()","197e89b2":"sub_csv = pd.read_csv(data_path\/'sample_submission.csv')\nsub_csv.head()","cf3c9400":"def create_databunch(valid_idx):\n    test = ImageList.from_df(sub_csv, path=data_path\/'test', folder='test')\n    data = (ImageList.from_df(df, path=data_path\/'train', folder='train')\n            .split_by_idx(valid_idx)\n            .label_from_df()\n            .add_test(test)\n            .transform(get_transforms(flip_vert=True, max_rotate=20.0), size=128)\n            .databunch(path='.', bs=64)\n            .normalize(imagenet_stats)\n           )\n    return data","d160f3cf":"kf = KFold(n_splits=5, random_state=379)\nepochs = 6\nlr = 1e-2\npreds = []\nfor train_idx, valid_idx in kf.split(df):\n    data = create_databunch(valid_idx)\n    learn = create_cnn(data, models.densenet201, metrics=[accuracy])\n    learn.fit_one_cycle(epochs, slice(lr))\n    learn.unfreeze()\n    learn.fit_one_cycle(epochs, slice(lr\/400, lr\/4))\n    learn.fit_one_cycle(epochs, slice(lr\/800, lr\/8))\n    preds.append(learn.get_preds(ds_type=DatasetType.Test))","1ca73e2c":"ens = torch.cat([preds[i][0][:,1].view(-1, 1) for i in range(5)], dim=1)\nens  = (ens.mean(1)>0.5).long(); ens[:10]","c38ccb12":"sub_csv['has_cactus'] = ens","574417a9":"sub_csv.to_csv('submission.csv', index=False)","1b64d758":"**5 fold ensemble**","8c74711b":"# Cactus Identification fastai baseline"}}