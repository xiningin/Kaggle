{"cell_type":{"9d716f6b":"code","b3977498":"code","a431dd83":"code","49ee819d":"code","df5c72c7":"code","968e7306":"code","d4bbcd1d":"code","b480ea61":"code","19da983a":"code","3fe66f5c":"code","42d53505":"code","bc7b51e3":"code","c556c5c8":"code","b70610ab":"markdown","ce4b2cb5":"markdown","fa7f0703":"markdown","2b319c9b":"markdown","6af548bb":"markdown","c8525692":"markdown","96a7899b":"markdown","dae3a329":"markdown","1e5ad82f":"markdown","d2a5f8b7":"markdown","1328e781":"markdown","f0abd77b":"markdown","67e5223e":"markdown"},"source":{"9d716f6b":"!pip install -q scanpy\n\nimport scanpy as sc\nimport pandas as pd\nfrom sklearn.cluster import KMeans\nfrom sklearn.metrics import adjusted_rand_score\nfrom matplotlib import pyplot as plt\n# magic incantation to help matplotlib work with our jupyter notebook\n%matplotlib inline ","b3977498":"adata = sc.read('..\/input\/theory-introto-singlecell-rnaseq-images\/brain_clusters\/brain_clusters.h5ad')\nraw = pd.DataFrame(data=adata.raw.X, index=adata.raw.obs_names, columns=adata.raw.var_names)","a431dd83":"adata","49ee819d":"print(raw.shape)\nraw.head()","df5c72c7":"adata.obs.cell_ontology_class.unique()","968e7306":"astrocyte_marker = 'Gja1' # define genes of interest\n# housekeeping = 'Chmp2a' \n\ncluster2 = raw[adata.obs['louvain'] == '2'] # Use a mask to subset dataset to cells assigned to cluster 2\nnot_cluster2 = raw[adata.obs['louvain'] != '2'] # All other cells","d4bbcd1d":"cluster2.head()  # Dataframe containing cells belonging to cluster 2","b480ea61":"cluster2_marker_exp = cluster2[astrocyte_marker]  # getting the values for all cells of cluster 2 for the specific gene\nplt.hist(cluster2_marker_exp.values, bins=100, color='lightblue', alpha=0.7, label='Cluster 2') # Plot distribution\n\nnot_cluster2_marker_exp = not_cluster2[astrocyte_marker]  # # getting the values for all cells not belonging to cluster 2 for the specific gene\nplt.hist(not_cluster2_marker_exp, bins=100, color='gray', alpha=0.7, label='Not cluster 2')\n\nplt.ylim(0,100) # Cut off at N=100 for visual clarity\nplt.xlabel('%s expression'%astrocyte_marker) # label our axes\nplt.ylabel('N cells')\nplt.legend()","19da983a":"from scipy.stats import ttest_ind\n\nttest = ttest_ind(cluster2_marker_exp, \n          not_cluster2_marker_exp, \n          equal_var=False, # it's not necessarily fair to assume that these two populations have equal variance\n          nan_policy='omit') # omit NaN values\nprint(ttest)","3fe66f5c":"# Rank genes for characterizing groups\nsc.tl.rank_genes_groups(adata, groupby='cell_ontology_class', use_raw=True, \n                        method='t-test_overestim_var', n_genes=10) # compute differential expression\n# The key of the observations grouping to consider.-> \"cell_ontology_class\"\nsc.pl.rank_genes_groups_tracksplot(adata, groupby='cell_ontology_class')  # Plot ranking of genes using heatmap plot (","42d53505":"adata","bc7b51e3":"sc.tl.rank_genes_groups(adata, groupby='louvain', use_raw=True, \n                        method='t-test_overestim_var', n_genes=10) # compute differential expression\nsc.pl.rank_genes_groups_tracksplot(adata, groupby='louvain') # Plot ranking of genes using heatmap plot (","c556c5c8":"marker_genes = {\n'astrocyte': ['Aldh1l1', 'Slc1a3', 'Aqp4'], \n'oligodendrocyte': ['Mog','Mag'],\n'oligodendrocyte precursor cell': ['Pdgfra','Susd5','Cspg4'],\n'endothelial cell': ['Pecam1','Cldn5','Slco1c1','Ocln'],\n'Bergmann glial cell': ['Gdf10','Vim','Nbl1','A2m'],\n'excitatory neuron': ['Slc17a7','Neurod6','Mab21l1'],\n'inhibitory neuron': ['Gad1','Reln','Calb1'],\n'brain pericyte': ['Des','Mcam','Pdgfrb']\n}\n\nsc.pl.matrixplot(adata, marker_genes, groupby='louvain', use_raw=False)","b70610ab":"<h1 style = \"font-family: garamond; font-size: 40px; font-style: normal; letter-spcaing: 3px; background-color: #f6f5f5; color :#fe346e; border-radius: 100px 100px; text-align:center\">Comparing distributions <\/h1>\n\n- Differential expression algorithms represent various approaches to comparing the distribution of gene expression in one group versus another group. \n- Unlike bulk RNA-seq, we generally have a large number of samples (i.e. cells) for each group we are comparing in single-cell experiments. \n- Thus, **we can take advantage of the whole distribution of expression values in each group to identify differences between groups rather than only comparing estimates of mean-expression as is standard for bulk RNASeq..**\n\n# Building intuition \nLet's revisit some foundational statistics to build some intuition.\n\nIn this example, we have a cluster of interest, and we want to determine if they are astrocytes. Let's start by plotting the distibution of a marker gene's expression in the cluster compared to the rest of the dataset.","ce4b2cb5":"https:\/\/chanzuckerberg.github.io\/scRNA-python-workshop\/analysis\/05-diffexp.html","fa7f0703":"<br>\n<h1 style = \"font-size:60px; font-family:Garamond ; font-weight : normal; background-color: #f6f5f5 ; color : #fe346e; text-align: center; border-radius: 100px 100px;\">Differential expression & cluster annotation<\/h1>\n<br>\n\nNow that we've assigned cells into clusters, we'd like to understand **what makes each cluster different from other cells in the dataset, or to annotate clusters according to their cell types (as has been previously done for this dataset).**\n\nThere are several approaches to this task:\n\n- **Look for upregulation of marker genes for cell types of interest (compared to the rest of the dataset)**\n- **Compare the complete gene expression profiles between groups**\n- **Use automated methods to compare cells of interest to databases of cell type expression profiles to combine clustering and annotation**\n- Automated methods are a promising advance, but are not yet able to replace careful human curation.\n\n**For well-defined cell types, we expect marker genes to show large differences in expression between the cell type of interest and the rest of the dataset, allowing us to use simple methods.** We'll focus on this approach.","2b319c9b":"**Just by eyeballing the two distributions we can see that:**\n- Cells in this **cluster express more of the marker gene than other cells** in the dataset. \n- However, we also see that these distributions overlap: **some cells in the cluster don't express the gene at all, and some cells outside the cluster express it relatively highly.**\n\n**So, how do we decide whether this cluster is actually \"differentially expressing\" our marker gene?**\n- Because we expect the differences in expression to be relatively large for marker genes, we can use straightforward hypothesis testing methods to ask for the probability (p-value) that we would observe this level of differential expression if all these cells were, in fact, the same population (i.e., if the null hypothesis were true).","6af548bb":"### T-test\nSuppose we observe two independent samples, e.g. flower petal lengths, and we are considering whether the two samples were drawn from the same population (e.g. the same species of flower or two species with similar petal characteristics) or two different populations.\n\n- The t-test quantifies the difference between the arithmetic means of the two samples. The p-value quantifies the probability of observing as or more extreme values assuming the null hypothesis, that the samples are drawn from populations with the same population means, is true. \n- A p-value larger than a chosen threshold (e.g. 5% or 1%) indicates that our observation is not so unlikely to have occurred by chance. Therefore, we do not reject the null hypothesis of equal population means. If the p-value is smaller than our threshold, then we have evidence against the null hypothesis of equal population means.\n- A t-test compares our data to the null hypothesis that the means of two distributions are **equal**. This accounts for the mean, standard deviation, and sample size of the two distributions. However, a p-value alone does not tell us anything about the *magnitude* of that difference: with large N, even very small (and biologically meaningless) differences in expression values can still return very \"statistically significant\" p-values.","c8525692":"<h1 style = \"font-family: garamond; font-size: 40px; font-style: normal; letter-spcaing: 3px; background-color: #f6f5f5; color :#fe346e; border-radius: 100px 100px; text-align:center\">Comparing to \"known\" marker genes <\/h1>\n\n\nWe can also compare these data-driven marker genes to those considered by the field to be classic indicators of cell type.","96a7899b":"#### Computing differential expression vai using \"louvain\" clusters","dae3a329":"<br>\n<h1 style = \"font-size:60px; font-family:Garamond ; font-weight : normal; background-color: #f6f5f5 ; color : #fe346e; text-align: center; border-radius: 100px 100px;\">Summary<\/h1>\n<br>\n\n- Building intuition of differential expression\n- Ttest\n- Working with whole dataset using original labels - \"cell_ontology_class\"\n- Working with whole dataset using \"louvain\" clusters\n- Comapring to known marker genes of call classes","1e5ad82f":"<h1 style = \"font-family: garamond; font-size: 40px; font-style: normal; letter-spcaing: 3px; background-color: #f6f5f5; color :#fe346e; border-radius: 100px 100px; text-align:center\">Working with the whole dataset <\/h1>\n\n- **Scanpy has a very useful function for repeating this process of subsetting the dataset to one group and comparing it to the rest of the dataset.** \n- It then **returns the genes that are most differentially expressed between that group and all others**. Let's look at the genes that are most cell-type specific.","d2a5f8b7":"### Load Data\n\n<b>Important note! For differential expression, we need to use the raw values stored in adata.raw. <\/b>\n\nWith differential expression, we want to account for both the center and spread of the expression in each group. Recall that when we normalized our values, we standardized the distribution of each gene across cells to be centered at 0 and scaled with variance 1. So, when calculating differential expression, **we should use the raw values (post-QC, pre-normalization). We saved these in adata.raw earlier on.**","1328e781":"### Installations","f0abd77b":"#### Computing differential expression vai using \"cell_ontology_class","67e5223e":"- This result tells you that we would be very surprised if these two populations had no true difference in mean expression, given the observed sample.\n- Notably, although many cells in this cluster express the marker gene, there are many that don't. We should be careful before assuming that a cluster == a cell type!"}}