{"cell_type":{"b62ae862":"code","32f4d469":"code","802cce90":"code","55061dde":"code","1cad9702":"code","1586fdb1":"code","4e6fb238":"code","79680581":"code","76f62724":"code","8d0f93a5":"code","9acb6a93":"code","b1800d7a":"code","bc81db65":"code","d57f46c6":"code","6c3b5d18":"code","11885dcb":"code","c93472a0":"code","c06e3189":"code","e75933f9":"code","d997430d":"code","cb570931":"code","45ed212c":"code","7b946e08":"code","e62850d5":"code","fc5dc4e3":"code","d8bd1ba2":"code","70bfb959":"code","ee8f5c83":"code","9b91b891":"code","c876c4db":"code","cd4a71b7":"code","6be01948":"code","8d0512d1":"markdown","13d0d44b":"markdown","eddb1d5d":"markdown","90445958":"markdown","3e7ea78f":"markdown","e2aab702":"markdown","b8bab4b9":"markdown","2e01704c":"markdown","9845cd47":"markdown","b2501545":"markdown","2ef4ba4d":"markdown","adeb8ab9":"markdown","3f31f50a":"markdown","93a97df6":"markdown","e108596c":"markdown","1319fe21":"markdown","7aced9f0":"markdown","2fc257c7":"markdown","4d26e118":"markdown","27aa3f8b":"markdown","2f370e19":"markdown","13711867":"markdown","2e1dbc5f":"markdown","a6693281":"markdown","6cf137d7":"markdown","e9a75b36":"markdown","1ec7b810":"markdown","e597aff1":"markdown","7d5f3d13":"markdown","ba9131e2":"markdown"},"source":{"b62ae862":"%matplotlib inline\n%reload_ext autoreload\n%autoreload 2","32f4d469":"from fastai.tabular import *\nfrom pandas import *\nfrom scipy import *\nfrom matplotlib import gridspec\nfrom scipy.fftpack import fft\nfrom scipy.optimize import leastsq\nfrom scipy import signal\n\nimport scipy.fftpack\nimport matplotlib.pyplot as plt\nimport scipy as sp\nimport pandas as pd\nimport numpy as np","802cce90":"df = pd.read_csv(\"..\/input\/train.csv\")","55061dde":"len(df)","1cad9702":"df.head()","1586fdb1":"def get_data(crew, exp, seat):\n    return df[(df.crew == crew) & (df.seat == seat) & (df.experiment == exp)].sort_values(by=['time'])\n\ndef trim_data(x, from_pt, secs):\n    return x[(x.time >= from_pt) & (x.time < (from_pt + secs))]\n\ncrew_1_all = df[(df.crew == 1) & (df.seat == 0)].sort_values(by=['time'])\ncrew_1_ca = get_data(1, 'CA', 0)\ncrew_1_ss = get_data(1, 'SS', 0)\ncrew_1_da = get_data(1, 'DA', 0)","4e6fb238":"len(crew_1_all), len(crew_1_ca), len(crew_1_ss), len(crew_1_da)","79680581":"(crew_1_all.time.min(), crew_1_all.time.max()), (crew_1_ca.time.min(), crew_1_ca.time.max()), (crew_1_ss.time.min(), crew_1_ss.time.max()), (crew_1_da.time.min(), crew_1_da.time.max()),","76f62724":"plt.plot(crew_1_ca.time, crew_1_ca.event);\nplt.plot(crew_1_ss.time, crew_1_ss.event);\nplt.plot(crew_1_da.time, crew_1_da.event);","8d0f93a5":"crew_to_use = crew_1_ca\nsecs = 10\ncrew_trim = trim_data(crew_to_use, 120.0, secs) # 10 secs of data from 2min in","9acb6a93":"plt.plot(crew_trim.time, crew_trim.ecg);","b1800d7a":"plt.plot(crew_1_da.time, crew_1_da.ecg);","bc81db65":"len(crew_trim), (len(crew_trim) \/ secs)","d57f46c6":"crew_trim.head()","6c3b5d18":"plt.plot(crew_trim.time, crew_trim.ecg.rolling(8).mean());","11885dcb":"plt.plot(crew_trim.time, crew_trim.gsr);","c93472a0":"plt.plot(crew_to_use.time, crew_to_use.gsr);","c06e3189":"plt.plot(crew_trim.time, crew_trim.r);","e75933f9":"plt.plot(crew_trim.time, crew_trim.ecg.rolling(256).mean());","d997430d":"cleared = crew_trim.ecg.rolling(8).mean() - crew_trim.ecg.rolling(256).mean()\nplt.plot(crew_trim.time, cleared);","cb570931":"y0 = crew_trim['eeg_f8']\ny1 = crew_trim['eeg_f8'].rolling(8).mean()\nx = crew_trim.time\n\n# graph it!\nfig = plt.figure()\ngs = gridspec.GridSpec(2, 1)\n\nax0 = plt.subplot(gs[0])\nline0, = ax0.plot(x, y0, color='r')\n\nax1 = plt.subplot(gs[1], sharex = ax0)\nline1, = ax1.plot(x, y1, color='b')\n\nplt.setp(ax0.get_xticklabels(), visible=False)\n\nyticks = ax1.yaxis.get_major_ticks()\nyticks[-1].label1.set_visible(False)\n\nplt.subplots_adjust(hspace=.0)\nplt.show()","45ed212c":"ordered_fields = [['eeg_fp1', 'eeg_f3', 'eeg_c3', 'eeg_p3', 'eeg_o1'], \n                  ['eeg_fp2', 'eeg_f4', 'eeg_c4', 'eeg_p4', 'eeg_o2'],\n                  ['eeg_f7',  'eeg_t3', 'eeg_t5'],\n                  ['eeg_f8',  'eeg_t4', 'eeg_t6'],\n                  ['eeg_fz',  'eeg_cz', 'eeg_pz', 'eeg_poz']]\n\ncolours = ['darkslateblue', 'cadetblue', \n           'rebeccapurple', 'teal', 'chocolate']","7b946e08":"fig = plt.figure(figsize=(12,12))\nfld_cnt = sum([len(x) for x in ordered_fields])\ngs = gridspec.GridSpec(fld_cnt, 1)\n\nx = crew_trim.time\nax0 = None\naxL = None\n\nspines = [\"top\", \"right\", \"left\", \"bottom\"]\n\ni = 0\nfor arr, col in zip(ordered_fields, colours):\n    for fld in arr:\n        ax = plt.subplot(gs[i])\n        ln = ax.plot(x, crew_trim[fld].rolling(8).mean(), color=col)\n        \n        ax.set_yticks([])        \n        ax.set(ylabel=fld.replace(\"eeg_\", \"\"))\n        ax.yaxis.label.set_rotation(0)\n        ax.xaxis.grid(which=\"major\")\n        \n        plt.setp(ax.get_xticklabels(), visible=False)\n        plt.setp(ax.get_yticklabels(), visible=False)\n        \n        for s in spines: ax.spines[s].set_visible(False)\n        if i == 0: ax0 = ax\n            \n        axL = ax\n        i = i+1\n\nplt.setp(axL.get_xticklabels(), visible=True)\nplt.subplots_adjust(hspace=.0)\nplt.show()","e62850d5":"x = crew_trim.r.values\navg = mean(x)\nx = x - avg\n\npeaks, _ = scipy.signal.find_peaks(x, distance=500)\npeaks\nplt.plot(x)\nplt.plot(peaks, x[peaks], \"x\")\nplt.plot(np.zeros_like(x), \"--\", color=\"gray\")\nplt.show();","fc5dc4e3":"peak_times = crew_trim.time.values[peaks]\npeak_diffs = [peak_times[n] - peak_times[n-1] for n in range(1, len(peak_times))]\nrolling_rr = [60\/n for n in peak_diffs]\n\n# Buff out the rolling RR as we don't have RR initially\n# we just duplicate the initial value here, we could use zero if we wanted\nrolling_rr.insert(0, rolling_rr[0])\npeaks, peak_times, peak_diffs, rolling_rr","d8bd1ba2":"expanded_rr = [0] * len(x)\nnext_rr = 0\nfor i in range(0, len(x)):\n    expanded_rr[i] = rolling_rr[next_rr]\n    if (i == peaks[next_rr]) & (next_rr < (len(rolling_rr)-1)):\n        next_rr = next_rr+1\nplt.plot(crew_trim.time, expanded_rr);","70bfb959":"def peak_rate(times, vals, d=None, p=None, w=None, h=None):\n    avg = mean(vals[~np.isnan(vals)])\n    vals = vals - avg\n    peaks, _ = scipy.signal.find_peaks(vals, \n                                    distance=d, \n                                    prominence=p,\n                                    width=w,\n                                    height=h)\n    peak_times = times.values[peaks]\n    peak_diffs = [peak_times[n] - peak_times[n-1] for n in range(1, len(peak_times))]\n    minute_rates = [60\/n for n in peak_diffs]\n    expanded_rates = [0] * len(vals)\n    # Buff out the rolling rate as we don't have rate initially\n    if len(minute_rates) > 0:\n        minute_rates.insert(0, minute_rates[0])\n        n = 0\n        for i in range(0, len(vals)):\n            expanded_rates[i] = minute_rates[n]\n            if (i == peaks[n]) & (n < (len(minute_rates)-1)):\n                n = n+1\n    return pd.Series(expanded_rates)","ee8f5c83":"def plot_rate(x, y, d=None, p=None, w=None, h=None):\n    rates = peak_rate(x, y, d, p, w, h)\n    # 7680 = 256*30 = average every 30 seconds?\n    rolling_rate = rates.rolling(7680).mean()\n    plt.plot(x, rates, color='lightgray');\n    plt.plot(x, rolling_rate);","9b91b891":"plot_rate(crew_to_use.time, crew_to_use.r, d=500)","c876c4db":"x = crew_trim.ecg.rolling(48).mean().values #\navg = mean(x[~np.isnan(x)])\nx = x - avg\n\npeaks, _ = sp.signal.find_peaks(x, distance=64, prominence=1, width=1, height=50)\nplt.plot(x)\nplt.plot(peaks, x[peaks], \"x\")\n#plt.plot(np.zeros_like(x), \"--\", color=\"gray\")\nplt.show();","cd4a71b7":"plot_rate(crew_to_use.time, crew_to_use.ecg, d=64, p=1, w=1)","6be01948":"plot_rate(crew_to_use.time, crew_to_use.ecg, d=64, p=1, w=1, h=50)","8d0512d1":"# ECG Fourier Transforms\n\nI tried various packages including wavelets and scipy to do a low-pass & high-pass filters of the ECG data, but could not get any to work.  I'd be interested to hear if anyone got it working.  Therefore, this section is still blank","13d0d44b":"# EEG\n\nHaving a look at the EEG data now, we have these fields\n\neeg_fp1\neeg_f7\neeg_f8\neeg_t4\neeg_t6\neeg_t5\neeg_t3\neeg_fp2\neeg_o1\neeg_p3\neeg_pz\neeg_f3\neeg_fz\neeg_f4\neeg_c4\neeg_p4\neeg_poz\neeg_c3\neeg_cz\neeg_o2\n\nEEG reference: https:\/\/en.wikipedia.org\/wiki\/Electroencephalography\n\nProbe placement: https:\/\/en.wikipedia.org\/wiki\/10%E2%80%9320_system_(EEG)\n\nStandard ordering?: https:\/\/en.wikipedia.org\/wiki\/Electroencephalography#\/media\/File:Human_EEG_without_alpha-rhythm.png\n\nBrain layout: https:\/\/en.wikipedia.org\/wiki\/10%E2%80%9320_system_(EEG)#\/media\/File:21_electrodes_of_International_10-20_system_for_EEG.svg\n\nI have decided to follow this ordering: http:\/\/pediatrics.aappublications.org\/content\/pediatrics\/129\/3\/e748\/F2.large.jpg","eddb1d5d":"The code here is pretty rough, but just trying to replicate what an EEG printout looks like e.g., http:\/\/pediatrics.aappublications.org\/content\/pediatrics\/129\/3\/e748\/F2.large.jpg","90445958":"The interesting thing I have noticed with this is a bit of a wave in theh baseline, which seems to correlate with the respiratory rate as seen below.  ECGs should be a flatline, so I believe this really needs to be fixed up","3e7ea78f":"As we can see above, the RR in this slice is around 21-24 (per minute).  We can easily calculate this over the whole data set, and would provide a cleaner\/simpler piece of data than the actual signals","e2aab702":"Below we can see the various experiments use the same time periods (0 --> x) so it appears we have made the correct split","b8bab4b9":"Now we need to buff out the averages so it can stay consistent with the rest of the dataset.  We do 2 important things here that can be tweaked,\n\n- Start with the first RR.  We could do something else if we wanted (e.g., 0)\n- Trail with the last values.  As above, we could do whatever here too","2e01704c":"![](http:\/\/)This notebook is a small dive into looking at the data provided for this comp.  The main focus is on looking at the EEG and ECG data.  The data was much noisier and difficult to interpret than I hoped, so this evaluation kind of went nowhere.  It was still interesting to look at some EEG, ECG, and RR data.","9845cd47":"# ECG\n\nNow I can plot the ECG for a 10 second period.  Given a normal HR (heart rate) is 60-100 bpm (beats per minute), we would expect between 10 and 17 beats in this window.  It should be easy to visual this count of beats.  If the pilot is stressed, we may see up to 30 beats in the period I guess, but it is a manageable amount","b2501545":"We can also see the event changes in each series, which appears to validate the assumption events happen periodically in an experiment.  However it is kinda disappointing that we basically have 1 event for both the CA & SS experiments","2ef4ba4d":"This is nice validation, they said it is sampled at 256Hz and we have verified it here with the size of this sample.\n\nOnce again just looking at the data, it seems normal enough.  However there are some anomalies I have noticed, as e.g., below for crew 1 DA experiement there is no ECG...","adeb8ab9":"Above shows the resp rate for this crew_1 set, sitting around 22 the whole time.  Pretty high! but seems to be correct.  I would be feeding these numbers into a network, rather than the raw signals, as the RR is really what you are after.  Anything else in the RR signal is noise.\n\nWe could correlate this with events if desired.  This experiment we chose does not change event so it's probably pointless","3f31f50a":"# Approximating the Respiratory Rate\n\nWill try to work out the respiratory rate (RR) based on the signal we have.\n\nUsing some basic peak detection, we can see below we can easily find the peaks","93a97df6":"The peak detection is picking up noise.  We can use the same function as the RR for the HR calc, as the method is identical.  We can see below that the HR is really high - over 150 constantly.  This is way too high, likely due to the noise.  However it seems very difficult to filter out the noise reliably.\n\nUsing the `.rolling(48).mean()` does not lower the HR either.","e108596c":"Here we can see we have nearly 5million records, and the data looks pretty standard","1319fe21":"# Download and browse\n\nI have downloaded the data using the API via `kaggle competitions download -c reducing-commercial-aviation-fatalities`.  I have then extracted it and had to `chmod 666 train.csv` to get reading it working","7aced9f0":"Once again sanity checking the data, we now are down around 100k records for a single crew member in an experiment","2fc257c7":"## Cleaning the ECG\n\nDoing a larger rolling average sort of shows the same waves appearing in the ECG.  We need to put this through a low pass filter","4d26e118":"As you can see in the plot, it is really hard to make out a standard QRS complex \/ heartbeat.  It looks close but just is all over the shop.  I reckon there is about 14 beats in this sample, with a lot of noise to clean up","27aa3f8b":"In fact, as seen below, the GSR data just seems a bit strange overall.  This article https:\/\/imotions.com\/blog\/gsr\/ seems to suggest it should fluctuate a bit more consistently.  I will need to look into this further on its own","2f370e19":"It was difficult to clearly see what the 'key' for the data is.  But my belief is that it is continuous for a crew member (`crew` + `seat`) within a single `experiment`.  This seems to make sensible data.\n\nEach `experiment` has different `event` states","13711867":"Now, we can easily look up the time of the peaks and calculate a rolling respiratory rate","2e1dbc5f":"## Resp Rate\n\nThe respiratory rate data looks pretty good - could calculate a rolling RR off this.  Perhaps detect the peak and record time since last\/next breath?  We will do this later on.","a6693281":"## GSR Sidetrack\n\nThe GSR data looks a bit strange, continuously increasing? It doesn't seem correct, or at least not useful?","6cf137d7":"# ECG peak detection for heart rate\n\nWe will try the same method as the RR to calculate a RR.  The ECG data is very noisy though so we will use a rolling average immediately","e9a75b36":"The time is in seconds, so the experiment seems to run for 360 seconds (6 minutes).  I'm now taking a sample from a random point in the data (in this case 120 seconds in) and taking a small sample (10 seconds) to try to look at the ECG data.\n\nThe ECG is the data I am most interested in analysing here","1ec7b810":"By setting the height it drops to more expected values, however it still seems far too noisy","e597aff1":"My uneducated opinion is that the plot looks pretty normal.  If you don't use the rolling average, it is very noisy.  I think basically all this data needs to be smoothed, but I have no idea wheter NN's and whatever frameworks can handle the data being that noisy.\n\nYou can see above how a lot of the signals are very similar.  I would expect to see them highly correlated in a correlation plot (e.g., like the dendogram from the fastai course)","7d5f3d13":"The plot below shows how noisy some of the EEG data is.  Once again I am plotting the moving average to smooth it out as per the ECG data.  I have not spent much time looking into better smoothing though","ba9131e2":"Here I do a really rough subtraction of the lower frequency MA from the higher frequency MA.  It seems to do what I want and level out the ECG, but I am still not happy with it.  The peaks are far too irregular and frequent - I believe further cleaning must be done.\n\nLet's try proper fourier transforms & filtering, further in the analysis.  For now, I will leave this here."}}