{"cell_type":{"776536cd":"code","369b5c62":"code","06642e34":"code","37c8f905":"code","b6898114":"code","d398662e":"code","59e24887":"code","78f5aff3":"code","638eeb35":"code","886ace76":"code","2c791936":"code","ce680f29":"code","d6cde70c":"code","2400a531":"code","325bc8a6":"code","810c2645":"code","1a5b6fac":"code","e3b9faaa":"code","753c485d":"markdown","029b03cd":"markdown","f5ad35ef":"markdown","f2f61e14":"markdown","d05335e2":"markdown","9dd6d137":"markdown","a8db8a70":"markdown","b6376c71":"markdown","72452d44":"markdown","579a5eed":"markdown","e08fabfc":"markdown","18b49d19":"markdown","5f0fd297":"markdown","2e83522d":"markdown","a48bb360":"markdown","5a4e60df":"markdown"},"source":{"776536cd":"import datetime\nimport pandas as pd\nfrom tqdm.notebook import tqdm\nimport requests\nimport time","369b5c62":"# rank_df = pd.read_csv(\"..\/input\/rps-1129-rank\/rock-paper-scissors-publicleaderboard.csv\")\n# rank_df = rank_df.sort_values(\"Score\", ascending=False)\n# rank_df.head()\n\n# list_url = 'https:\/\/www.kaggle.com\/requests\/EpisodeService\/ListEpisodes'\n# episode_list = list()\n\n# for tid, tname in tqdm(rank_df[[\"TeamId\", \"TeamName\"]].values):\n    \n#     t = requests.post(list_url, json={'TeamId': tid})\n    \n#     # Too Many Requests\n#     # Inevitable\n#     if t.status_code == 429:\n#         print(tid)\n#         break\n    \n#     t = t.json()\n        \n    \n#     for ep in t[\"result\"][\"episodes\"]:\n#         try:\n#             create_time_second = ep['createTime'][\"seconds\"]\n#             create_time_nano = ep['createTime'][\"nanos\"]\n#             end_time_second = ep['endTime'][\"seconds\"]\n#             end_time_nano = ep['endTime'][\"nanos\"]\n\n#             player_1_submission_id = ep['agents'][0][\"submissionId\"]\n#             player_1_init_score = ep['agents'][0][\"initialScore\"]\n#             player_1_update_score = ep[\"agents\"][0][\"updatedScore\"]\n#             player_2_submission_id = ep['agents'][1][\"submissionId\"]\n#             player_2_init_score = ep['agents'][1][\"initialScore\"]\n#             player_2_update_score = ep[\"agents\"][1][\"updatedScore\"]\n\n\n#             episode_list.append([\n#                 create_time_second,\n#                 create_time_nano,\n#                 end_time_second,\n#                 end_time_nano,\n#                 player_1_submission_id,\n#                 player_1_init_score,\n#                 player_1_update_score,\n#                 player_2_submission_id,\n#                 player_2_init_score,\n#                 player_2_update_score,\n#             ])\n\n#         except:\n#             print(tid)\n#             break\n        \n# episode_df = pd.DataFrame(episode_list, columns=[\"createTimeSecond\", \"createTimeNano\", \"endTimeSecond\", \"endTimeNano\", \"Player1SID\", \"Player1InitScore\", \"Player1UpdateScore\", \"Player2SID\", \"Player2InitScore\", \"Player2UpdateScore\"])","06642e34":"# ALL GAMES BEFORE 29 Nov 2020\n# Some may be missing.\nepisode = pd.concat([\n    pd.read_csv(\"..\/input\/episode1129\/episode_1.csv\"),\n    pd.read_csv(\"..\/input\/episode1129\/episode_2.csv\"),\n    pd.read_csv(\"..\/input\/episode1129\/episode_3.csv\"),\n    pd.read_csv(\"..\/input\/episode1129\/episode_4.csv\"),\n    pd.read_csv(\"..\/input\/episode1129\/episode_5.csv\"),\n    pd.read_csv(\"..\/input\/episode1129\/episode_6.csv\"),\n], axis=0)","37c8f905":"# print(len(episode))\nepisode = episode[~episode.duplicated()].reset_index(drop=True)\n# print(len(episode))\nepisode_change_12 = episode.copy()\nepisode_change_12.columns = [\n    'createTimeSecond', \n    'createTimeNano', \n    'endTimeSecond', \n    'endTimeNano',\n    'Player2SID', \n    'Player2InitScore', \n    'Player2UpdateScore', \n    'Player1SID',\n    'Player1InitScore', \n    'Player1UpdateScore'\n]\nepisode = pd.concat([episode, episode_change_12], axis=0)\n# print(len(episode))\nepisode = episode[~episode.duplicated()].reset_index(drop=True)\n# print(len(episode))","b6898114":"episode[\"createTimeSecond\"] = episode[\"createTimeSecond\"].apply(datetime.datetime.fromtimestamp)\nepisode[\"endTimeSecond\"] = episode[\"endTimeSecond\"].apply(datetime.datetime.fromtimestamp)\nepisode = episode.sort_values([\"Player1SID\", \"endTimeSecond\"])\nepisode = episode[episode[\"createTimeSecond\"] < \"2020-11-29\"].reset_index(drop=True)","d398662e":"# 16 Nov 2020\nbfr_update_top100_submit = episode[episode[\"endTimeSecond\"] < \"2020-11-17\"].groupby(\"Player1SID\")[\"Player1UpdateScore\"].apply(\n    lambda x: x.tail(1).values[0]\n).to_frame().sort_values(\"Player1UpdateScore\", ascending=False).head(100)\nbfr_update_top100_submit","59e24887":"bfr_top100_submit_id = bfr_update_top100_submit.index.tolist()\nbfr_update_top100_history = episode[episode[\"Player1SID\"].isin(bfr_top100_submit_id)].pivot_table(index=\"endTimeSecond\", columns=\"Player1SID\", values=\"Player1UpdateScore\")","78f5aff3":"# 29 Nov 2020\naft_update_top100_submit = episode.groupby(\"Player1SID\")[\"Player1UpdateScore\"].apply(\n    lambda x: x.tail(1).values[0]\n).to_frame().sort_values(\"Player1UpdateScore\", ascending=False).head(100)\naft_update_top100_submit","638eeb35":"aft_top100_submit_id = aft_update_top100_submit.index.tolist()\naft_update_top100_history = episode[episode[\"Player1SID\"].isin(aft_top100_submit_id)].pivot_table(index=\"endTimeSecond\", columns=\"Player1SID\", values=\"Player1UpdateScore\")","886ace76":"import matplotlib.pyplot as plt\n%matplotlib inline\nfig, ax = plt.subplots(figsize=(20, 10))\n\nfor sub in bfr_update_top100_history.columns:\n    if sub in aft_update_top100_history.columns:\n        bfr_update_top100_history[bfr_update_top100_history[sub].notnull()][sub].plot(ax=ax, color=\"red\")\n    else:\n        bfr_update_top100_history[bfr_update_top100_history[sub].notnull()][sub].plot(ax=ax, color=\"grey\")\nplt.vlines([datetime.datetime(2020, 11, 17, 0, 0, 0)], 500, 1300, \"blue\", linestyle=\"dashed\")\nplt.hlines([950.781712], datetime.datetime(2020, 11, 1, 0, 0, 0), datetime.datetime(2020, 11, 29, 0, 0, 0), \"blue\", linestyle=\"dashed\")\nplt.title(\"Top 100 Rate just before the update(Red: Now Top 100, Grey: Other)\")","2c791936":"print(\"Mean Rate of Top 100 Before Update\", bfr_update_top100_submit[\"Player1UpdateScore\"].mean())\nprint(\"Mean Now Rate of Top 100 Rate Before Update\",episode[episode[\"Player1SID\"].isin(bfr_top100_submit_id)].groupby(\"Player1SID\")[\"Player1UpdateScore\"].apply(lambda x: x.head(1).values[0]).mean())","ce680f29":"import matplotlib.pyplot as plt\n%matplotlib inline\nfig, ax = plt.subplots(figsize=(20, 10))\n\n# update date\nplt.vlines([datetime.datetime(2020, 11, 17, 0, 0, 0)], 500, 1300,  \"blue\" , linestyle=\"dashed\")\n\n# before update date rank 100 score\nplt.hlines([1049.045015], datetime.datetime(2020, 11, 1, 0, 0, 0), datetime.datetime(2020, 11, 29, 0, 0, 0), \"blue\", linestyle=\"dashed\")\nfor sub in aft_update_top100_history.columns:\n    if sub in bfr_update_top100_history.columns:\n        aft_update_top100_history[aft_update_top100_history[sub].notnull()][sub].plot(ax=ax, color='r')\n    else:\n        aft_update_top100_history[aft_update_top100_history[sub].notnull()][sub].plot(ax=ax, color='grey')\nplt.title(\"Now Top 100 Rate(Red: Top 100 just before the update, Grey: Other)\")","d6cde70c":"aft_update_top_100_create_date = episode[episode[\"Player1SID\"].isin(aft_top100_submit_id)].groupby(\"Player1SID\")[\"createTimeSecond\"].min().reset_index()\naft_update_top_100_create_date[\"is_before_update_top_100\"] = aft_update_top_100_create_date[\"Player1SID\"].apply(lambda x: (x in bfr_top100_submit_id)*1)\naft_update_top_100_create_date[\"is_before_update_submit\"] = aft_update_top_100_create_date[\"createTimeSecond\"].apply(lambda x: x < datetime.datetime(2020, 11, 17))\npd.crosstab(aft_update_top_100_create_date[\"is_before_update_submit\"], aft_update_top_100_create_date[\"is_before_update_top_100\"])","2400a531":"def plot_related_with_battle_and_score(base):\n    fig, ax1 = plt.subplots(figsize=(20, 10))\n    ax2 = ax1.twinx()\n\n    ax1.bar(base[\"index\"], base[\"Player1UpScore\"], label=\"Up(win) or Down(lose) Rate\")\n    ax2.scatter(base[\"index\"], base[\"Player1InitScore\"], c=\"r\", label=\"My Rate (right label)\")\n    ax2.scatter(base[\"index\"], base[\"Player2InitScore\"], c=\"blue\", label=\"Opponent Rate (right label)\")\n    handler1, label1 = ax1.get_legend_handles_labels()\n    handler2, label2 = ax2.get_legend_handles_labels()\n    ax1.legend(handler1 + handler2, label1 + label2, loc=1, borderaxespad=0.)","325bc8a6":"# Top 1 before update rate logic\nn1_17901899 = episode[episode[\"Player1SID\"] == 17901899].reset_index(drop=True)\nn1_17901899[\"Player1UpScore\"] = n1_17901899[\"Player1UpdateScore\"] - n1_17901899[\"Player1InitScore\"]\nn1_17901899 = n1_17901899.reset_index()","810c2645":"plot_related_with_battle_and_score(n1_17901899)","1a5b6fac":"# Top 1 after update rate logic\nn1_18317942 = episode[episode[\"Player1SID\"] == 18317942].reset_index(drop=True)\nn1_18317942[\"Player1UpScore\"] = n1_18317942[\"Player1UpdateScore\"] - n1_18317942[\"Player1InitScore\"]\nn1_18317942 = n1_18317942.reset_index()","e3b9faaa":"plot_related_with_battle_and_score(n1_18317942)","753c485d":"https:\/\/en.wikipedia.org\/wiki\/Elo_rating_system\n\nhttps:\/\/en.wikipedia.org\/wiki\/Glicko_rating_system","029b03cd":"## Now(29 Nov) Top 100","f5ad35ef":"# N1 analyze","f2f61e14":"## Other Rating System","d05335e2":"The score of the agent who was in the top 100 just before the update has dropped by about 250 points since then.","9dd6d137":"Only 18% of the top agents before the update are still in the top 100\n\n50% agents submitted after update","a8db8a70":"## Top 100 just before the update","b6376c71":"Compare Top 100 agent before and before updating rating system.\n\nRating system is changed in 16~17 Nov.","72452d44":"# Preparation","579a5eed":"The rate of decrease when defeated by a low-rate agent is too small?\n\nThe key to the competition is how lucky you can win in the first few games","e08fabfc":"I don't know the optimal rating system, but there is something like this","18b49d19":"https:\/\/www.kaggle.com\/c\/rock-paper-scissors\/overview\/evaluation","5f0fd297":"## This Competition Rating System","2e83522d":"And more...","a48bb360":"# Rating System","5a4e60df":"# Summarize Before and After Update Top 100"}}