{"cell_type":{"68fd5ba5":"code","c0f19ca1":"code","cd61ab4e":"code","3e0dfaac":"code","1111d803":"code","98bec521":"code","5ab8a967":"code","31ed2666":"code","29a2651d":"code","f9172e86":"code","ef917981":"markdown","9dc1ec02":"markdown","b99283da":"markdown","f6ece239":"markdown","429c08fc":"markdown","42113e18":"markdown","b779a961":"markdown","5da2caf5":"markdown","30088959":"markdown","26cf4dd7":"markdown","1b44b33d":"markdown"},"source":{"68fd5ba5":"import matplotlib.pyplot as plt\nimport numpy as np\nimport pandas as pd\nimport statsmodels.api as sm\nfrom scipy.special import expit, logit\nfrom sklearn.decomposition import PCA\nfrom sklearn.preprocessing import scale\n\nnp.random.seed(1)\npd.set_option('display.max_rows', 100)\npd.set_option('display.max_columns', None)","c0f19ca1":"# load\ndf = pd.read_pickle('..\/input\/passnyc-model-1\/schools2017.pkl')\n\n# select columns\ndf = df[[        \n    'Mean Scale Score - ELA',\n    '% Level 2 - ELA',\n    '% Level 3 - ELA',\n    '% Level 4 - ELA',\n    'Mean Scale Score - Math',\n    '% Level 2 - Math',\n    '% Level 3 - Math',\n    '% Level 4 - Math',\n    \n    '# Students in HS Admissions',\n    '# SHSAT Testers',\n    '% SHSAT Testers',\n]].copy()\nprint(df.shape[0], \"schools\")\n\n# drop schools with missing test data\ndf = df[df.loc[:, 'Mean Scale Score - ELA':'% Level 4 - Math'].notnull().all(axis=1)]\nprint(df.shape[0], \"schools after dropping missing test data\")\n\n# schools with 0-5 SHSAT testers have this value set to NaN\napplicantsok = df['# SHSAT Testers'].notnull()\n\n# convert percentages to the (0, 1) range\nbad_pct_c = [\n    '% Level 2 - ELA',\n    '% Level 3 - ELA',\n    '% Level 4 - ELA',\n    '% Level 2 - Math',\n    '% Level 3 - Math',\n    '% Level 4 - Math',\n]\ndf.loc[:, bad_pct_c] = df.loc[:, bad_pct_c] \/ 100.0\n\n# standardize score columns (algorithm stability)\nscore_c = ['Mean Scale Score - ELA', 'Mean Scale Score - Math']\ndf.loc[:, score_c] = scale(df.loc[:, score_c])","cd61ab4e":"base_df = df[[  # explanatory variables\n    'Mean Scale Score - ELA',\n    '% Level 2 - ELA',\n    '% Level 3 - ELA',\n    '% Level 4 - ELA',\n    'Mean Scale Score - Math',\n    '% Level 2 - Math',\n    '% Level 3 - Math',\n    '% Level 4 - Math',\n]]\n\nn_components = 4  # from local cross-validation\npca = PCA(n_components)\ntransformed = pca.fit_transform(base_df)\ntransformed = pd.DataFrame(transformed, index=base_df.index, columns=[\"PC{}\".format(i+1) for i in range(n_components)])\ntransformed.head()\n\ninputs = transformed\ninputs.insert(0, 'Constant', 1.0)","3e0dfaac":"#data\ninputs_fit = inputs[applicantsok]\noutputs_fit = logit(df['% SHSAT Testers'][applicantsok])\ninputs_predict = inputs\n\n# fit\nmodel = sm.RLM(outputs_fit, inputs_fit, M=sm.robust.norms.HuberT())\nresults = model.fit()\n\n# predict\npredictions = model.predict(results.params, exog=inputs_predict)\npredictions = pd.Series(predictions, index=inputs_predict.index)\npredictions.name = 'Predictions'","1111d803":"xs = expit(predictions[applicantsok])  # expit function is the inverse of the logit\nys = expit(outputs_fit)\n\nplt.figure(figsize=(12, 8))\nplt.scatter(xs, ys, s=10)\nplt.plot([0, 1], [0, 1], '--')\nplt.xlim(0, 1)\nplt.ylim(0, 1)\nplt.title(\"Percentage of SHSAT Applicants\")\nplt.xlabel(\"Expected Percentage\")\nplt.ylabel(\"Actual Precentage\");","98bec521":"def from_counts(shsat_counts, hs_counts):\n    return pd.DataFrame({\n        'logit': logit(shsat_counts \/ hs_counts),\n        'pct': shsat_counts \/ hs_counts,\n        'cnt': shsat_counts,\n    })\n\ndef from_logits(shsat_logits, hs_counts):\n    return pd.DataFrame({\n        'logit': shsat_logits,\n        'pct': expit(shsat_logits),\n        'cnt': expit(shsat_logits) * hs_counts,\n    })","5ab8a967":"# actual values  ---\n\n# schools with 0 to 5 applicants\nhs_counts = df[~applicantsok]['# Students in HS Admissions']\nmax_v = from_counts(5, hs_counts)\n\n# schools with 6 or more applicants\nshsat_counts = df[applicantsok]['# SHSAT Testers']\nhs_counts = df[applicantsok]['# Students in HS Admissions']\npontual_v = from_counts(shsat_counts, hs_counts)\n\n\n# expected values  ---\n\nshsat_logits = predictions\nhs_counts = df['# Students in HS Admissions']\nexpected_v = from_logits(shsat_logits, hs_counts)\n\n\n# differences  ---\n\nmax_diff = (max_v - expected_v).dropna()\npontual_diff = (pontual_v - expected_v).dropna()\n\n\n# join everything  ---\n\neverything = pd.DataFrame({\n    'Actual #': pd.concat([max_v, pontual_v])['cnt'],\n    'Estimated #': expected_v['cnt'],\n    'Difference #': pd.concat([max_diff, pontual_diff])['cnt'],\n            \n    'Actual %': pd.concat([max_v, pontual_v])['pct'],\n    'Estimated %': expected_v['pct'],\n    'Difference %': pd.concat([max_diff, pontual_diff])['pct'],\n})\neverything['Difference Ratio'] = everything['Difference #'] \/ everything['Actual #']\n\neverything = everything.sort_index()\neverything.head().style. \\\n    format('{:.0f}', subset=pd.IndexSlice[:, 'Actual #':'Difference #']). \\\n    format('{:.0%}', subset=pd.IndexSlice[:, 'Actual %':'Difference %']). \\\n    format('{:.2f}', subset=['Difference Ratio'])","31ed2666":"# load dataframes\n# 'vis' are easier to visualize\n\nschools = pd.read_pickle('..\/input\/passnyc-model-1\/schools2017.pkl')\nschools = schools[schools.loc[:, 'Mean Scale Score - ELA':'% Level 4 - Math'].notnull().all(axis=1)]  # drop na\nscore_c = ['Mean Scale Score - ELA', 'Mean Scale Score - Math']  # standardize columns\nschools.loc[:, score_c] = scale(schools.loc[:, score_c])  # standardize columns\n\nschools_vis = pd.read_pickle('..\/input\/passnyc-model-1\/schools2017_vis.pkl')\nresults_vis = pd.read_pickle('..\/input\/passnyc-model-1\/model1_results_vis.pkl')\nvis = schools_vis.join(results_vis, how='inner')","29a2651d":"index = everything.sort_values('Difference Ratio').index\nvis.reindex(index).head()","f9172e86":"vis.loc['84M353']","ef917981":"## Fit\/Predict","9dc1ec02":"# Prepare the data","b99283da":"# Arrange results\n\nHere I arrange the results into a table that I believe is gonna be useful for PASSNYC.\n\nInstead of keeping track of minimum and max values, I will just assume that exactly 5 students take the SHSAT in schools with missing information.","f6ece239":"The model estimated 25 students taking the test, while the actual number is at most 5! It is a good school to help.","429c08fc":"For example, let's say we want to find schools which have a good unexplored potential of SHSAT test takers.","42113e18":"This reveals lots of schools that may be good candidates for PASSNYC intervention. Just exemplifying the first one:","b779a961":"# Create the model\n\nWe will use a robust linear regression over the logits.\n\n- A robust regression improves the detection of outliers.<sup> 1<\/sup>\n- Output probabilities are transformed to logits, making the model a [logit regression][1].\n\n<sub>1: The objective of the analysis is not exactly outlier detection, but could be expressed as so: we want to find schools whose rates of applicants are *far away* from what would be expected given their students scores.<\/sub>\n    \n[1]: https:\/\/en.wikipedia.org\/wiki\/Logistic_regression","5da2caf5":"# Example usage of the table","30088959":"This table in itself is a nice deliverable to PASSNYC. It provides an estimate of the gap of applicants in each school, a strong indicator of where resources may be harnessed best.","26cf4dd7":"# Locating schools with a shortage of applicants (abandoned)\n\n*please see comment below this kernel*\n\n## Objective\n\nHere is a quote from Max Brawer, researcher who works along with PASSNYC:\n\n> \"Only a third (roughly) of eligible students take the SHSAT, and our goal is to drive more test takers (you can't get in if you don't sit for the test!).\"\n\nIt briefly summarizes main objective of PASSNYC, that is, bringing new students into taking SHSAT.\n\nBut, where should PASSNYC put its efforts? In this notebook I make recommendations about this, indicating schools where the actual amount of SHSAT test takers was far below what would be from its students.\n\n## Method\n\nFirst, I create a model that predicts the percentage of SHSAT applicants of a school, given its distribution of grades on the New York State tests.\n\nBased on this model, I estimate what would be expected for each school and calculate the difference between the actual number of applicants and the expected number of applicants. This difference is a good indicator of the gap between potential applicants in a school and actual applicants.\n\n## Model\n\nThe percentage of SHSAT takers of each school is estimated using a robust logit regression. Only schools with a known outcome are used to fit the model.\n\nInputs are preprocessed using PCA (Principal Component Analysis). I do so to remove redundancy from the model.\n\n## Data\n\nThe data used here follows a group of students that took the NYS tests and SHSAT in 2017.\n\nSources:\n- https:\/\/infohub.nyced.org\/reports-and-policies\/citywide-information-and-data\/test-results\n- https:\/\/data.cityofnewyork.us\/Education\/2017-2018-SHSAT-Admissions-Test-Offers-By-Sending-\/vsgi-eeb5\/\n\n## Results\n\nThis model is good, but not perfect. I intend to do additional work to improve it, all the while trying to provide more explanation of what is being done.\n\nFor a pretty well written kernel that uses the same principle as this, check [Diamonds in the Rough with Machine Learning][1].\n\n[1]: https:\/\/www.kaggle.com\/bensolucky\/diamonds-in-the-rough-with-machine-learning","1b44b33d":"## Transform the inputs"}}