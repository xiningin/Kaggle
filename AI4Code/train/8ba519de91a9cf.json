{"cell_type":{"a2c6a4db":"code","15cba1a8":"code","c4723329":"code","cb5faddb":"code","20aa7cd8":"code","57f1c136":"code","77d3744e":"code","0b323b59":"code","2ad2690e":"code","57bbdfa6":"code","ad577046":"code","003f0560":"code","a00a3a4f":"code","183797d6":"code","9a396f78":"code","130c4c30":"code","d2cd653b":"code","ab7429bd":"code","4c24f144":"code","ce11c43a":"code","3ab06b43":"code","e9f03c24":"code","e09a16cb":"code","f3fcfcd9":"code","725dc75a":"code","d7d762e7":"code","6f8ac6d5":"code","65e183c4":"code","6b4cc526":"code","9eed59b8":"code","a53de514":"code","42101057":"code","2d73c8be":"code","8769c4a2":"code","bf474fbe":"code","96df95b1":"code","256b7b72":"code","65e11671":"code","2add7e30":"code","cafc0106":"code","3fe33132":"code","f0d1cac8":"code","1a044617":"code","c4d50ee5":"code","7aaf5edc":"code","62a0933e":"code","5c6052fd":"code","1faf2ab8":"code","213e42d5":"code","85b9a72d":"markdown","a8739cc8":"markdown","aa99d11d":"markdown","6a468efe":"markdown","25c69247":"markdown","cecf516d":"markdown","a020b856":"markdown","0762b57f":"markdown","ff7eeba6":"markdown","cedef68b":"markdown","18d6e2b9":"markdown","82cafff4":"markdown","32628837":"markdown","b5fa6ea8":"markdown","aea55acf":"markdown","5659a9e3":"markdown","450a42d6":"markdown","d21474dd":"markdown","de9d45a6":"markdown"},"source":{"a2c6a4db":"# This Python 3 environment comes with many helpful analytics libraries installed\n# It is defined by the kaggle\/python Docker image: https:\/\/github.com\/kaggle\/docker-python\n# For example, here's several helpful packages to load\n\nimport numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\npd.options.mode.chained_assignment = None\nfrom torch.utils.data import Dataset, DataLoader, Subset\nimport torch\nimport torchvision\nimport matplotlib.pyplot as plt\nimport seaborn as sns\nfrom matplotlib.pylab import rcParams\nimport cv2\nimport gc\nimport plotly.express as ex\nimport plotly.graph_objects as go\nfrom plotly.offline import iplot\n#cufflinks to link pandas to plotly\nimport cufflinks as cf\ncf.go_offline()\ncf.set_config_file(offline=False, world_readable=True)\n%matplotlib inline\nsns.set(style='whitegrid', palette='muted')\nrcParams['figure.figsize'] = 14,8\nimport torchvision.transforms as transforms\n# Input data files are available in the read-only \"..\/input\/\" directory\n# For example, running this (by clicking run or pressing Shift+Enter) will list all files under the input directory\n\nimport os\n# for dirname, _, filenames in os.walk('\/kaggle\/input'):\n#     for filename in filenames:\n#         print(os.path.join(dirname, filename))\n\n# You can write up to 5GB to the current directory (\/kaggle\/working\/) that gets preserved as output when you create a version using \"Save & Run All\" \n# You can also write temporary files to \/kaggle\/temp\/, but they won't be saved outside of the current session","15cba1a8":"root_dir = '..\/input\/siim-isic-melanoma-classification\/'\n\ntrain = pd.read_csv(root_dir + 'train.csv')\n\ntrain.head()\n\n\ntest = pd.read_csv(root_dir + 'test.csv')\n\ntest.head()","c4723329":"print('Total number of entries in train dataset: ', len(train))\nprint('Unique patients in train dataset: ',train['patient_id'].nunique())\n\nprint('Total number of entries in test dataset: ', len(test))\nprint('Unique patients in test dataset: ',test['patient_id'].nunique())","cb5faddb":"#Missing values in train\nprint('Number of missing age values in train data is :',train['age_approx'].isnull().sum())\nprint('Number of missing age values in test data is :',test['age_approx'].isnull().sum())","20aa7cd8":"def show_age_dist(series, bins = None):\n    fig = go.Figure()\n    hist = go.Histogram(x = series, nbinsx=50)\n    fig.add_trace(hist)\n    fig.update_layout(title_text = 'Age distribution')\n    fig.update_yaxes(title_text='Number of Patients')\n    fig.update_xaxes(title_text='Age')\n    fig.show()\n#     return hist.xbins\n    ","57f1c136":"group_age_train = train.groupby('patient_id')['age_approx'].mean()\ngroup_age_test = test.groupby('patient_id')['age_approx'].mean()","77d3744e":"sns.distplot(group_age_train,bins=50, kde = True).set_title('Age distribution in train dataset')","0b323b59":"sns.distplot(group_age_test,bins=50, kde = True).set_title('Age distribution in test dataset')","2ad2690e":"train_withAge = train[train['age_approx']>0]","57bbdfa6":"train_withAge['age_approx'].corr(train_withAge['target'])","ad577046":"print('Number of records with missing gender information in training set: ', train['sex'].isnull().sum())\nprint('Number of records with missing gender information in test set: ', test['sex'].isnull().sum())","003f0560":"def show_gender_dist(series, title):\n    fig = go.Figure()\n    df_ = series.value_counts(normalize = True)\n    bar_graph = go.Bar(x = df_.index, y = df_.values, width=[0.1,0.1])\n    fig.add_trace(bar_graph)\n    fig.update_layout(title_text = title, bargap=0.1)\n    fig.update_yaxes(title_text='Gender count percentage')\n    fig.update_xaxes(title_text='Gender')\n    fig.show()\n#     return hist.xbins\n    ","a00a3a4f":"show_gender_dist(train['sex'], 'Gender Distribution for Train set')","183797d6":"show_gender_dist(test['sex'], 'Gender Distribution for Test set')","9a396f78":"def show_gender_target_dist(df, title):\n    gender_target_df = df.groupby(['sex', 'target'])['benign_malignant'].count().to_frame().reset_index()\n    gender_target_df.target = gender_target_df.target.replace({0:'Benign', 1:'Malignant'})\n    fig = go.Figure()\n    fig.add_trace(go.Bar(x = gender_target_df[gender_target_df['sex']=='female'].target, \n                         y = gender_target_df[gender_target_df['sex']=='female'].benign_malignant, \n                         name='Female',\n                         marker_color='indianred',\n                         text = gender_target_df[gender_target_df['sex']=='female'].benign_malignant, \n                         textposition = 'auto',\n                         width=[0.25,0.25]))\n\n    fig.add_trace(go.Bar(x = gender_target_df[gender_target_df['sex']=='male'].target, \n                         y = gender_target_df[gender_target_df['sex']=='male'].benign_malignant, \n                         name='Male',\n                         marker_color='lightsalmon',\n                         text = gender_target_df[gender_target_df['sex']=='male'].benign_malignant, \n                         textposition = 'auto',\n                         width=[0.25,0.25]))\n\n\n    fig.update_layout(barmode='group', title=title, bargap=0)\n    fig.update_yaxes(title_text='Count')\n    fig.update_xaxes(title_text='Benign vs Malignant')\n    fig.show()","130c4c30":"show_gender_target_dist(train, 'Gender-Target distirbution of Train set')","d2cd653b":"lesion_loc = train['anatom_site_general_challenge'].value_counts(normalize=True).sort_values(ascending=False)\nlesion_loc.iplot(kind='bar', \n                 xTitle='Percentage', \n                 text = lesion_loc.values.tolist(),\n                 \n                 textposition='outside',\n                 title='Distribution of lesion location across train dataset')","ab7429bd":"lesion_loc = test['anatom_site_general_challenge'].value_counts(normalize=True).sort_values(ascending=False)\nlesion_loc.iplot(kind='bar', \n                 xTitle='Percentage', \n                 text = lesion_loc.values.tolist(),\n                 \n                 textposition='outside',\n                 title='Distribution of lesion location across test dataset')","4c24f144":"def show_location_target_dist(df, title):\n    df.dropna(subset = [\"anatom_site_general_challenge\"], inplace=True)\n    loc_target_df = df.groupby(['anatom_site_general_challenge', 'target'])['benign_malignant'].count().to_frame().reset_index()\n    loc_target_df.target = loc_target_df.target.replace({0:'Benign', 1:'Malignant'})\n    locations = df['anatom_site_general_challenge'].unique()\n    total_benign = loc_target_df[loc_target_df['target']=='Benign'].benign_malignant.sum()\n    total_malignant = loc_target_df[loc_target_df['target']=='Malignant'].benign_malignant.sum()\n    fig = go.Figure()\n    for l in locations:\n#         print(l)\n        percent_text = round((loc_target_df[loc_target_df['anatom_site_general_challenge']==l].benign_malignant\/[total_benign,total_malignant ])*100, 2)\n        percent_text = [str(t)+\"%\" for t in percent_text]\n        fig.add_trace(go.Bar(x = loc_target_df[loc_target_df['anatom_site_general_challenge']==l].target, \n                             y = loc_target_df[loc_target_df['anatom_site_general_challenge']==l].benign_malignant, \n                             name=l,\n                             text = percent_text, \n                             textposition = 'outside'\n                            ))\n\n\n\n\n    fig.update_layout(barmode='group', title=title, bargap=0.1)\n    fig.update_yaxes(title_text='Count')\n    fig.update_xaxes(title_text='Benign vs Malignant')\n    fig.show()","ce11c43a":"show_location_target_dist(train, 'Location ditribution relative to Target ')","3ab06b43":"def show_location_malignant_dist(df, title):\n    df.dropna(subset = [\"anatom_site_general_challenge\"], inplace=True)\n    loc_target_df = df.groupby(['anatom_site_general_challenge', 'target'])['benign_malignant'].count().to_frame().reset_index()\n    loc_target_df.target = loc_target_df.target.replace({0:'Benign', 1:'Malignant'})\n    loc_target_df = loc_target_df[loc_target_df['target']=='Malignant']\n    locations = df['anatom_site_general_challenge'].unique()    \n    total_malignant = loc_target_df[loc_target_df['target']=='Malignant'].benign_malignant.sum()\n    fig = go.Figure()\n    for l in locations:\n#         print(l)\n        percent_text = round((loc_target_df[loc_target_df['anatom_site_general_challenge']==l].benign_malignant\/total_malignant)*100, 2)\n        percent_text = [str(t)+\"%\" for t in percent_text]\n        fig.add_trace(go.Bar(x = loc_target_df[loc_target_df['anatom_site_general_challenge']==l].target, \n                             y = loc_target_df[loc_target_df['anatom_site_general_challenge']==l].benign_malignant, \n                             name=l,\n                             text = percent_text, \n                             textposition = 'outside'\n                            ))\n\n\n\n\n    fig.update_layout(barmode='group', title=title, bargap=0.1)\n    fig.update_yaxes(title_text='Count')\n    fig.update_xaxes(title_text='Malignant')\n    fig.show()","e9f03c24":"show_location_malignant_dist(train, 'Location ditribution relative to Malignant lesions')","e09a16cb":"def show_diagnosis_dist(df):\n    diagnosis = df['diagnosis'].value_counts().sort_values(ascending=False)\n    \n    fig = go.Figure()\n    fig.add_trace(go.Bar( x = diagnosis.index,\n                         y = diagnosis.values,\n                         text = diagnosis.values.tolist(),\n                         textposition = 'outside'\n    \n    ))\n    fig.update_layout(title='Diagnosis distribution')\n    fig.update_yaxes(title_text='Count')\n    fig.update_xaxes(title_text='Diagnosis')\n    fig.show()","f3fcfcd9":"show_diagnosis_dist(train)","725dc75a":"class MelanomaDataset(Dataset):\n    def __init__(self, df: pd.DataFrame, im_folder: str, train: bool = True, transforms = None):\n        \"\"\"\n        Class initialization\n        Args:\n            df (pd.DataFrame): DataFrame with data description\n            im_folder (str): folder with images\n            train (bool): flag of whether a training dataset is being initialized or testing one\n            transforms: image transformation method to be applied\n            \n        \"\"\"\n        self.df = df\n        self.transforms = transforms\n        self.train = train\n        self.im_folder = im_folder\n        \n    def __getitem__(self, index):\n        im_path = os.path.join(self.im_folder, self.df.iloc[index]['image_name'] + '.jpg')\n        x = cv2.imread(im_path)\n        x = cv2.cvtColor(x, cv2.COLOR_BGR2RGB)\n        if self.transforms:\n            x = self.transforms(x)\n            \n        if self.train:\n            y = self.df.iloc[index]['target']\n            return x, y\n        else:\n            return x\n    \n    def __len__(self):\n        return len(self.df)","d7d762e7":"melanoma_dataset = MelanomaDataset(train, root_dir+'jpeg\/train\/', True)\n\nmelanoma_dataloader = DataLoader(dataset = melanoma_dataset, batch_size=1, shuffle=False, num_workers=10)","6f8ac6d5":"%%time\nfrom tqdm import tqdm\npixels = []\nmean_color = []\ntargets_temp = []\nwidths = []\nheights = []\nfor i, (img, target_) in enumerate(tqdm(melanoma_dataloader)):\n    img = img.squeeze()\n    target_ = target_.squeeze()\n#     print(target_.shape)\n    h,w = img.shape[0], img.shape[1]\n    pixels.append(h*w)\n    widths.append(w)\n    heights.append(h)\n    mean_color.append(np.mean(img.numpy()))\n    targets_temp.append(int(target_.numpy()))\n    del img\n    gc.collect()\n    if(i==1500):\n        break","65e183c4":"# plt.scatter(widths, heights, c = targets_temp, cmap = plt.cm.autumn, alpha = 0.5)\nfig = go.Figure()\nfig.add_trace(go.Scatter(x=widths, y=heights, mode='markers', marker = dict(color=targets_temp)))\nfig.update_xaxes(title_text='Widhts')\nfig.update_yaxes(title_text='Heights')\nfig.show()","6b4cc526":"targets_temp = np.array(targets_temp)\nwidths = np.array(widths)\nheights = np.array(heights)\nmalignant_indices = np.where(targets_temp==1)","9eed59b8":"benign_indices = np.where(targets_temp==0)\n\npixels = np.array(pixels)","a53de514":"sns.distplot(pixels[malignant_indices]).set_title('Resolution distribution for Malignant Lesions')","42101057":"sns.distplot(pixels[benign_indices]).set_title('Resolution distribution for Benign Lesions')","2d73c8be":"!pip install chart_studio","8769c4a2":"import chart_studio.plotly as py\nimport plotly.figure_factory as ff","bf474fbe":"def density_plot_resolution(indices, title):\n    fig = go.Figure()\n    fig.add_trace(go.Histogram2dContour(x=widths[indices], y=heights[indices], histfunc='count', colorscale='blues'))\n    fig.add_trace(go.Scatter(x=widths[indices], y=heights[indices], mode='markers'))\n    fig.add_trace(go.Histogram(\n            y = heights[indices],\n            xaxis = 'x2',\n    \n        ))\n    fig.add_trace(go.Histogram(\n            x = widths[indices],\n            yaxis = 'y2',\n   \n        ))\n\n    fig.update_layout(\n\n        xaxis = dict(\n            zeroline = False,\n            domain = [0,0.85],\n            showgrid = False\n        ),\n        yaxis = dict(\n            zeroline = False,\n            domain = [0,0.85],\n            showgrid = False\n        ),\n        xaxis2 = dict(\n            zeroline = False,\n            domain = [0.85,1],\n            showgrid = False\n        ),\n        yaxis2 = dict(\n            zeroline = False,\n            domain = [0.85,1],\n            showgrid = False\n        ),\n\n        bargap = 0,\n        hovermode = 'closest',\n        showlegend = False,\n        title = title\n    )\n    fig.update_xaxes(title_text='Widhts')\n    fig.update_yaxes(title_text='Heights')\n    fig.show()\n","96df95b1":"density_plot_resolution(benign_indices, 'Density plot of resolution for Benign Lesions')","256b7b72":"density_plot_resolution(malignant_indices, 'Density plot of resolution for Malignant Lesions')","65e11671":"mean_color = np.array(mean_color)\n# fig = go.Figure()\nfig=(ff.create_distplot([mean_color[benign_indices], mean_color[malignant_indices]], group_labels=['Mean color for Benign', 'Mean color for Malignant']))\nfig.show()","2add7e30":"# Corelation calculation:\npixels_series = pd.Series(pixels)\nmean_color_series = pd.Series(mean_color)\ntargets_temp_series = pd.Series(targets_temp)\nprint('Correlation between Image resolution and targets is :', pixels_series.corr(targets_temp_series))\nprint('Correlation between Mean color of images and targets is :', mean_color_series.corr(targets_temp_series))","cafc0106":"np.save('widths.npy', widths)\nnp.save('heights.npy', heights)\nnp.save('targets_temp.npy', targets_temp)\nnp.save('mean_color.npy', mean_color)\nnp.save('pixels.npy',pixels)","3fe33132":"transform_basic = transforms.Compose([\n    transforms.ToPILImage(),\n    transforms.Resize((256,256)),\n    transforms.ToTensor()\n    ])\n\nmelanoma_dataset = MelanomaDataset(train, root_dir+'jpeg\/train\/', True, transform_basic)\n\nmelanoma_dataloader = DataLoader(dataset = melanoma_dataset, batch_size=10, shuffle=False)\n\ndef imshow(img):\n    img = img.squeeze()\n    plt.imshow(img)","f0d1cac8":"dataiter = iter(melanoma_dataloader)\n\nimages, targets = dataiter.next()\nimages = images.permute(0,2,3,1)\nimages = images.numpy()\ntargets = targets.numpy()\nfig = plt.figure(figsize=(25, 10))\n# display 10 images\nfor idx in np.arange(10):\n    ax = fig.add_subplot(2, 10\/2, idx+1, xticks=[], yticks=[])\n    imshow(images[idx])\n    ax.set_title(targets[idx])","1a044617":"show_diagnosis_dist(train)","c4d50ee5":"def display_images_diagnosis(diagnosis, title):\n    \n    train_temp = train[train['diagnosis']==diagnosis]\n    random_indices = np.random.randint(0, len(train_temp), 5)\n    \n    fig = plt.figure(figsize=(25, 10))\n    for idx in np.arange(5):\n        img = cv2.imread(root_dir+'jpeg\/train\/'+train_temp.iloc[random_indices[idx]].image_name+'.jpg')\n        img = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)\n        img = cv2.resize(img,(256,256))\n        target = train_temp.iloc[random_indices[idx]].target\n        ax = fig.add_subplot(2, 5, idx+1, xticks=[], yticks=[])\n        imshow(img)\n        ax.set_title(target) \n    plt.suptitle(title)","7aaf5edc":"display_images_diagnosis('nevus', 'Lesions diagnosed as Nevus')","62a0933e":"display_images_diagnosis('melanoma', 'Lesions diagnosed as Melanoma')","5c6052fd":"display_images_diagnosis('seborrheic keratosis', 'Lesions diagnosed as Seborrheic Keratosis')","1faf2ab8":"display_images_diagnosis('lentigo NOS', 'Lesions diagnosed as Lentigo NOS')","213e42d5":"display_images_diagnosis('lichenoid keratosis', 'Lesions diagnosed as Lichenoid keratosis')","85b9a72d":"** Anatomy Site EDA **","a8739cc8":"Let's take a deeper look at location distribution for Malignant lesions","aa99d11d":"** Data Leak through Image resolution: ** Images with high resolution have more pixels, so lets use this intuition and calculate coorelation between image resolution and target. Record with high number of pixels implies that it has high resolution","6a468efe":"Since the correlation is very low between 'target' and 'age', we can deduce that age is not a significant factor for Melanoma","25c69247":"Remember the distribution on diagnosis? Let's analyse that","cecf516d":"** Diagnosis EDA **","a020b856":"Lets check its correlation with \"Target\" variable","0762b57f":"So lot of records have unknown diagnosis. However, this information is only available for train dataset","ff7eeba6":"From the above images, it can be seen that Nevus lesions have some sort of pinkish shade all over ( No matter how many random indices were picked all nevus images somehow has same shade). Could model easily capture this? The rest of the types i.e. Melanoma, Seborrheic Kertosis, Lentigo NOS, Lichenoid Keratosis etc seem to display similar characteristics at the first glance. To distinguish between them, model has to capture more insighful features like the ones described in ABCDE, 7-point derma checklist etc.","cedef68b":"# Image Visualization Analysis","18d6e2b9":"Though there is no direct correlation of resolution & mean-color with Target i.e. no linear relationship, the density plots indicate a possible non-linear relationship which can be captured by a neural network model as malignant and benign lesions have different resolution distributions","82cafff4":"# EDA on images","32628837":"** Gender Distribution **","b5fa6ea8":"So, Torso, which is the trunk of human body has more chances to have malignant lesions. For that matter, any lesion since even it has higher percentage share for benign lesions as well","aea55acf":"## Data Leak?\nOne of interesting discussions on forum is possible data leak through image resolution and image mean color. Is it really true? Let's check it now","5659a9e3":"# Meta Data Analysis","450a42d6":"**Age Analysis for both train and test**","d21474dd":"Although the difference is not huge, but is noticeable enough that male patients have higher malignant cases compared to female patients","de9d45a6":"**To be continued ...**"}}