{"cell_type":{"790841dc":"code","030475e3":"code","8d9e0826":"code","bc981035":"code","5a3acd63":"code","03bc3bb7":"code","cb77c898":"markdown","b2e58683":"markdown"},"source":{"790841dc":"import sys\nsys.path.append('..\/input\/cowboy-detection')\n\n!pip install pycocotools\n!nvidia-smi","030475e3":"import json\n\nimport torch\nfrom tqdm import tqdm\nimport os\n\n\nimport modeling\nfrom coco_eval import coco_eval\nfrom data_process import CocoDataLoader\nfrom evaluate import Pipeline, preds2coco_eval_result\nfrom train import Trainer\n","8d9e0826":"class Args:\n    num_epochs = 1\n    device = 'cuda:0'\n    model_name = 'm28'\n    best_epoch = 0\n    lr = 0.005\n    momentum = 0.9\n    weight_decay = 0.01\n    \n    data_dir = '..\/input\/cowboyoutfits'\n    model_out = f'\/kaggle\/working\/models\/faster_rcnn\/{model_name}'\n    log_dir = f'\/kaggle\/working\/runs\/faster_rcnn\/{model_name}'\n\n    best_model_path = f'{model_out}\/e{best_epoch}.pt'\n    outfile_name = f'faster_rcnn_{model_name}e{best_epoch}.json'\n    eval_coco_path = f'\/kaggle\/working\/{outfile_name}'\n    \nargs = Args()","bc981035":"\n\ncdl = CocoDataLoader(args.data_dir, from_cache=False)\ntrain_data = cdl.train_95\ndev_data = cdl.dev_05\n\nmodel = modeling.get_fasterrcnn_resnet50_model(num_classes=6)\n\nparams = [p for p in model.parameters() if p.requires_grad]\noptimizer = torch.optim.SGD(params, lr=args.lr, momentum=args.momentum, weight_decay=args.weight_decay)\n\ntrainer = Trainer(args=args,\n                  model=model,\n                  optimizer=optimizer,\n                  train_data=train_data,\n                  dev_data=dev_data)\ntrainer.train()\n","5a3acd63":"pipeline = Pipeline(args.best_model_path, args.device)\n\ntest_data = cdl.test_all\nidx2str = cdl.idx2str\nidx2label = cdl.idx2label\n\npreds = []\nimage_ids = []\n\nfor batched_imgs, batched_targets in tqdm(test_data):\n    batched_preds = pipeline(batched_imgs)\n\n    preds += batched_preds\n    image_ids += [_[0]['image_id'] for _ in batched_targets]\n\ncoco_result = preds2coco_eval_result(preds, image_ids, idx2label)\n","03bc3bb7":"\nwith open(args.eval_coco_path, 'w') as fout:\n    json.dump(coco_result, fout)\n\nfrom pycocotools.coco import COCO\nfrom pycocotools.cocoeval import COCOeval\n\n\ndef coco_eval(res_path):\n    coco_gt = COCO( '..\/input\/cowboyoutfits\/train.json')\n    coco_dt = coco_gt.loadRes(res_path)\n    ce = COCOeval(coco_gt, coco_dt, \"bbox\")\n    ce.evaluate()\n    ce.accumulate()\n    ce.summarize()\n\ncoco_eval(args.eval_coco_path)","cb77c898":"## train","b2e58683":"## validation"}}