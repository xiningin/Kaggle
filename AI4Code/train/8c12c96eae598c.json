{"cell_type":{"46bf2f34":"code","7cbbf3cc":"code","22ed2468":"code","bf8c7652":"code","9cd2b4b9":"code","5d3eeea0":"markdown","1a6427b5":"markdown","73d1acf1":"markdown","d55cd073":"markdown","369b072c":"markdown"},"source":{"46bf2f34":"from pydub import AudioSegment\nimport matplotlib.pyplot as plt\nfrom scipy.io import wavfile\nfrom tempfile import mkstemp\nimport numpy as np\nfrom pydub.utils import make_chunks\nimport glob, os\nfrom PIL import Image","7cbbf3cc":"def create_spectrograms(filename):\n    print('.\/' + filename)\n    mp3_audio = AudioSegment.from_ogg('\/' + filename)\n\n    sample = 0\n\n    chunk_length_ms = 5000\n    chunks = make_chunks(mp3_audio, chunk_length_ms)\n\n    for i, chunk in enumerate(chunks):\n        sample = sample + 1\n        if sample > 5:\n            sample = 0\n            break\n        fd, wname = mkstemp('.wav')\n        os.unlink(wname)\n        chunk.export(wname, format=\"wav\")\n        FS, data = wavfile.read(wname)\n        os.close(fd)\n        \n        data_size = np.array(data.shape).shape[0]\n        if data_size > 1:\n            plt.specgram(data[:, 0], Fs=FS, NFFT=128, noverlap=0)\n        else:\n            plt.specgram(data, Fs=FS, NFFT=128, noverlap=0)\n\n        plt.axis('off')\n        plt.savefig('spectrograms\/' + fnames[5] + '\/' + fnames[6].replace('.ogg', '_') + str(i * 5 + 5) + '.png',\n                    bbox_inches='tight')\n        plt.close()","22ed2468":"failed = 0\ncount = 0\nold_path = ''\n\ntry:\n    os.mkdir('spectrograms\/')\nexcept OSError:\n    print('Could not create spectrograms directory')\n\nfor filename in glob.iglob('\/kaggle\/input\/birdclef-2021\/train_short_audio\/**', recursive=True):\n    if os.path.isfile(filename):\n        fnames = filename.split('\/')\n\n        if old_path != fnames[5]:\n            # THIS IS ONLY TO ENSURE WE JUST LOOK AT THE FIRST FIVE SPECIES. \n            # YOU DON'T WANT THAT IN YOUR CODE FROM HERE...\n            count += 1\n            if count > 5:\n                break\n            old_path = fnames[5]\n            # TO HERE\n                \n            try:\n                os.mkdir('spectrograms\/' + fnames[5])\n            except OSError:\n                failed = failed + 1\n        else:   # THIS IS ONLY TO ENSURE WE JUST LOOK AT THE FIRST SAMPLE OF EACH SPECIES. \n                # YOU DON'T WANT THAT IN YOUR CODE. FROM HERE...\n            continue\n            # TO HERE\n\n        create_spectrograms(filename)\n\nprint('All done...')","bf8c7652":"plt.imshow(Image.open('spectrograms\/bongul\/XC516224_20.png'))","9cd2b4b9":"plt.imshow(Image.open('spectrograms\/rthhum\/XC319184_10.png'))","5d3eeea0":"With that of the Ruby-throated Hummingbird:","1a6427b5":"Ok, now the final part which is the main part of the logic. Here we loop through the files one by one. If we encounter a new directory we create it in the spectrograms folder as well for easy training later. Otherwise it is a simpple matter of creating a thread with create_spectrograms, passing the file name we've reached.","73d1acf1":"This is my attempt at visualizing the bird sounds. Send these spectrograms through your trusted CNN of choice coupled with a branch for the metadata and you should have a good starting point for a great result in this competition.\n\nThis version solves the performance issues I encountered before, so threading has been removed :-)\n\nOk. First the libraries:","d55cd073":"Next the function that actually creates the spectrograms. This is what is called in a separate thread (one at a time in this implementation).\n\nFirst we read the .ogg file, then we break it up in 5 second chunks in the loop.\nI have implemented a check that we don't want to save more than 5 spectrograms from each file to speed it up a bit.\nLastly we use pyplot to render and save the spectrogram.","369b072c":"So now we can see the intricate details of the bird song (and train our network in recognizing these details).\n\nCompare for example the call of Bonaparte's Gull:"}}