{"cell_type":{"21b58481":"code","e4bed62a":"code","050de2b6":"code","eab3033a":"code","4ca6560b":"code","68a94350":"code","33ca0dc5":"code","ec086efd":"code","508e71fb":"code","62f7edbc":"code","db7d1678":"code","861ee8da":"code","c0c5825c":"code","1f200ce9":"code","b979c166":"code","1cc216f4":"code","61ede2c1":"code","280202d9":"code","3ef24ca2":"code","d3f9b1aa":"code","916bd182":"code","cb664b44":"code","2744b7d1":"code","aa2ea530":"code","93124bef":"code","323c3db5":"code","e8a5f093":"code","6c3b67a1":"code","e4ee0092":"code","849c83c9":"code","a0dbf284":"code","a5f4414f":"code","23c714ae":"code","074d5fc8":"markdown","54eaca4d":"markdown","cdb1d980":"markdown","9d244003":"markdown","9c862f59":"markdown","d32ae587":"markdown","d4207790":"markdown","077b4faa":"markdown","acd58057":"markdown","d270d77a":"markdown","7d1a9d31":"markdown","69fbf105":"markdown","6d29ce97":"markdown"},"source":{"21b58481":"from IPython.display import YouTubeVideo,HTML\nYouTubeVideo(\"IAQp2Zuqevc\", width=800, height=500)","e4bed62a":"# importing libraries\nimport os\nfrom glob import glob\nimport pandas as pd\nimport numpy as np\nimport cv2\nimport shutil\nimport matplotlib.pyplot as plt\n%matplotlib inline\n\n# nn\nfrom keras.layers.core import Dense, Activation\nfrom keras.layers.convolutional import Conv2D, MaxPooling2D, AveragePooling2D, ZeroPadding2D\nfrom keras.layers.normalization import BatchNormalization\nfrom keras.layers import GlobalAveragePooling2D, Input, Concatenate, Dropout\nfrom keras.models import Model\nfrom keras.preprocessing.image import img_to_array\nfrom keras.preprocessing import image\nfrom PIL import Image\nfrom keras.preprocessing.image import ImageDataGenerator\nfrom keras.optimizers import Adam\nfrom keras import backend as K\nfrom keras.regularizers import l2\nfrom keras.callbacks import ReduceLROnPlateau, Callback\n\n#bokeh\nfrom bokeh.models import ColumnDataSource, HoverTool, Panel, FactorRange\nfrom bokeh.plotting import figure\nfrom bokeh.io import output_notebook, show, output_file\nfrom bokeh.palettes import Spectral6\n\nimport warnings\nwarnings.filterwarnings('ignore')","050de2b6":"# setup file structure\nbase_dir = \"..\/input\/chest-xray-pneumonia\/chest_xray\/\"\ntrain_dir = os.path.join(base_dir, \"train\/\")\ntest_dir = os.path.join(base_dir, \"test\/\")\nval_dir = os.path.join(base_dir, \"val\/\")","eab3033a":"print(\"Number of images in Train is {}\".format(len(glob(train_dir + \"*\/*\"))))\nprint(\"Number of images in Test is {}\".format(len(glob(test_dir + \"*\/*\"))))\nprint(\"Number of images in Validation is {}\".format(len(glob(val_dir + \"*\/*\"))))","4ca6560b":"# Distribution of images with different category\nCategories = [\"Train\", \"Test\", \"Validation\"]\nSubcategories = ['Normal', 'Pneumonia']\n\nTrain = [1341, 390]\nTest = [3875, 8]\nValidation = [234, 8]\n\ndata = {'Categories':Categories,\n        'Train':Train,\n        'Test':Test,\n        'Validation':Validation}\n\nx = [(categories, subcategories) for categories in Categories for subcategories in Subcategories]\ncounts = sum(zip(data['Train'], data['Test'], data['Validation']), ())\n\nsource = ColumnDataSource(data=dict(x=x, counts=counts, color=Spectral6))\n\np = figure(x_range=FactorRange(*x), plot_height=400, plot_width=800, title=\"Distribution of images with different category\",\n           tools=\"hover, pan, box_zoom, wheel_zoom, reset, save\", tooltips= (\"@x: @counts\"))\n\np.vbar(x='x', top='counts', width=0.9, color='color', legend_field=\"x\", source=source)\n\np.xgrid.grid_line_color = None\np.legend.orientation = \"horizontal\"\np.legend.location = \"top_center\"\noutput_notebook()\nshow(p)","68a94350":"Normal = glob(train_dir + \"NORMAL\/*\")\nPneumonia = glob(test_dir + \"PNEUMONIA\/*\")","33ca0dc5":"# Extract 9 random images from normal\nrandom_images = [Normal[i] for i in range(9)]\n\nprint('Display Normal Images')\n\n# Adjust the size of your images\nplt.figure(figsize=(10,8))\n\n# Iterate and plot random images\nfor i in range(9):\n    plt.subplot(3, 3, i + 1)\n    img = plt.imread(random_images[i])\n    plt.imshow(img, cmap='gray')\n    plt.axis('off')\n    \n# Adjust subplot parameters to give specified padding\nplt.tight_layout()  ","ec086efd":"# Extract 9 random images from Pneumonia\nrandom_images = [Pneumonia[i] for i in range(9)]\n\nprint('Display Pneumonia Images')\n\n# Adjust the size of your images\nplt.figure(figsize=(10,8))\n\n# Iterate and plot random images\nfor i in range(9):\n    plt.subplot(3, 3, i + 1)\n    img = plt.imread(random_images[i])\n    plt.imshow(img, cmap='gray')\n    plt.axis('off')\n    \n# Adjust subplot parameters to give specified padding\nplt.tight_layout()  ","508e71fb":"images_shape = []\n\nfor k, image_path in enumerate(glob(train_dir + \"*\/*\")):\n    image = Image.open(image_path)\n    images_shape.append(image.size)\n\nimages_shape_df = pd.DataFrame(data = images_shape, columns = ['H', 'W'], dtype='object')\nimages_shape_df['Size'] = '[' + images_shape_df['H'].astype(str) + ',' + images_shape_df['W'].astype(str) + ']'","62f7edbc":"images_shape_df.head()","db7d1678":"print(\"We have {} types of different shapes in training images\".format(len(list(images_shape_df['Size'].unique()))))","861ee8da":"Normal = glob(train_dir + \"NORMAL\/*\") + glob(test_dir + \"NORMAL\/*\") + glob(val_dir + \"NORMAL\/*\")\nPneumonia = glob(train_dir + \"PNEUMONIA\/*\") + glob(test_dir + \"PNEUMONIA\/*\") + glob(val_dir + \"PNEUMONIA\/*\")","c0c5825c":"print(\"We have total {} Normal Images\".format(len(Normal)))\nprint(\"We have total {} Pneumonia Images\".format(len(Pneumonia)))","1f200ce9":"# For all normal images\nTrain_normal = Normal[:1266]\nTest_normal = Normal[1266:1424]\nValidation_normal = Normal[1424:]\n\n# For all pneumonia images\nTrain_pneumonia = Pneumonia[:3418]\nTest_pneumonia = Pneumonia[3418:3845]\nValidation_pneumonia = Pneumonia[3845:]","b979c166":"# Make new directory to store our balanced data\n\"\"\"\nTrain\n    Normal\n    Pneumonia\nTest\n    Normal\n    Pneumonia\nValidation\n    Normal\n    Pneumonia\n\"\"\"\n\n!mkdir Train\n!mkdir Test\n!mkdir Validation\n!mkdir Train\/Normal\n!mkdir Train\/Pneumonia\n!mkdir Test\/Normal\n!mkdir Test\/Pneumonia\n!mkdir Validation\/Normal\n!mkdir Validation\/Pneumonia","1cc216f4":"# copy all images from Train_pneumonia to Train\/Pneumonia\nfor i in Train_pneumonia:\n    shutil.copy(i, \"Train\/Pneumonia\/\")\nprint(\"Copied all images from Train_pneumonia to Train\/Pneumonia\")\n    \n# copy all images from Test_pneumonia to Test\/Pneumonia\nfor i in Test_pneumonia:\n    shutil.copy(i, \"Test\/Pneumonia\/\")\nprint(\"Copied all images from Test_pneumonia to Test\/Pneumonia\")\n    \n# copy all images from Validation_pneumonia to Validation\/Pneumonia\nfor i in Validation_pneumonia:\n    shutil.copy(i, \"Validation\/Pneumonia\/\")\nprint(\"Copied all images from Validation_pneumonia to Validation\/Pneumonia\")\n\n# copy all images from Train_normal to Train\/Normal\nfor i in Train_normal:\n    shutil.copy(i, \"Train\/Normal\/\")\nprint(\"Copied all images from Train_normal to Train\/Normal\")\n\n# copy all images from Test_normal to Test\/Normal\nfor i in Test_normal:\n    shutil.copy(i, \"Test\/Normal\/\")\nprint(\"Copied all images from Test_normal to Test\/Normal\")\n    \n# copy all images from Validation_normal to Validation\/Normal\nfor i in Validation_normal:\n    shutil.copy(i, \"Validation\/Normal\/\")\nprint(\"Copied all images from Validation_normal to Validation\/Normal\")","61ede2c1":"# setup file structure\ntrain_dir = \"Train\/\"\ntest_dir = \"Test\/\"\nval_dir = \"Validation\/\"","280202d9":"# check new data distribution\nprint(\"Number of images in Train is {}\".format(len(glob(train_dir + \"*\/*\"))))\nprint(\"Number of images in Test is {}\".format(len(glob(test_dir + \"*\/*\"))))\nprint(\"Number of images in Validation is {}\".format(len(glob(val_dir + \"*\/*\"))))","3ef24ca2":"# Distribution of images with different category\nCategories = [\"Train\", \"Test\", \"Validation\"]\nSubcategories = ['Normal', 'Pneumonia']\n\nTrain = [1266, 427]\nTest = [3418, 159]\nValidation = [158, 428]\n\ndata = {'Categories':Categories,\n        'Train':Train,\n        'Test':Test,\n        'Validation':Validation}\n\nx = [(categories, subcategories) for categories in Categories for subcategories in Subcategories]\ncounts = sum(zip(data['Train'], data['Test'], data['Validation']), ())\n\nsource = ColumnDataSource(data=dict(x=x, counts=counts, color=Spectral6))\n\np = figure(x_range=FactorRange(*x), plot_height=400, plot_width=800, title=\"Distribution of images with different category\",\n           tools=\"hover, pan, box_zoom, wheel_zoom, reset, save\", tooltips= (\"@x: @counts\"))\n\np.vbar(x='x', top='counts', width=0.9, color='color', legend_field=\"x\", source=source)\n\np.xgrid.grid_line_color = None\np.legend.orientation = \"horizontal\"\np.legend.location = \"top_center\"\noutput_notebook()\nshow(p)","d3f9b1aa":"# image preprocessing\ntrain_datagen = ImageDataGenerator(rotation_range = 30,\n                                   zoom_range = 0.2,\n                                   width_shift_range = 0.1,\n                                   height_shift_range = 0.1,\n                                   horizontal_flip = True,\n                                   rescale = 1.\/255)\nval_datagen = ImageDataGenerator(rescale = 1.\/255)\ntest_datagen = ImageDataGenerator(rescale = 1.\/255)","916bd182":"batch_size = 16\ntraining_set = train_datagen.flow_from_directory(train_dir,\n                                                 target_size = (224, 224), \n                                                 batch_size = batch_size, \n                                                 class_mode = \"binary\")\nval_set = val_datagen.flow_from_directory(val_dir,\n                                          target_size = (224, 224),\n                                          batch_size = batch_size,\n                                          class_mode = 'binary')\ntest_set = test_datagen.flow_from_directory(test_dir,\n                                            target_size = (224, 224),\n                                            batch_size = batch_size,\n                                            class_mode = 'binary')","cb664b44":"def dense_block(x, blocks, name):\n    for i in range(blocks):\n        x = conv_block(x, 32, name=name + '_block' + str(i + 1))\n    return x","2744b7d1":"def transition_block(x, reduction, name):\n    bn_axis = 3\n    if K.image_data_format() == \"channels_first\":\n        bn_axis = 1\n    x = BatchNormalization(axis = bn_axis, epsilon=1.001e-5, name = name + '_bn')(x)\n    x = Activation('relu', name = name + '_relu')(x)\n    x = Conv2D(int(K.int_shape(x)[bn_axis] * reduction), 1, use_bias = False, \n               name = name + '_conv')(x)\n    x = AveragePooling2D(2, strides = 2, name = name + '_pool')(x)\n    return x","aa2ea530":"def conv_block(x, growth_rate, name):\n    bn_axis = 3\n    if K.image_data_format() == \"channels_first\":\n        bn_axis = 1\n    \n    x1 = BatchNormalization(axis = bn_axis, epsilon = 1.001e-5,\n                            name = name + '_0_bn')(x)\n    x1 = Activation('relu', name = name + '_0_relu')(x1)\n    x1 = Conv2D(4 * growth_rate, 1, use_bias = False,\n                name = name + '_1_conv')(x1)\n    \n    x1 = BatchNormalization(axis = bn_axis, epsilon = 1.001e-5, name = name + '_1_bn')(x1)\n    x1 = Activation('relu', name = name + '_1_relu')(x1)\n    x1 = Conv2D(growth_rate, 3, padding = 'same', use_bias = False,\n                name = name + '_2_conv')(x1)\n    \n    x = Concatenate(axis = bn_axis, name = name + '_concat')([x, x1])\n    return x","93124bef":"def DenseNet121(blocks, input_shape = (224, 224, 3), classes = 1):\n    \n    # Determine proper input shape\n    img_input = Input(shape=input_shape)\n    bn_axis = 3\n    if K.image_data_format() == \"channels_first\":\n        bn_axis = 1\n\n    x = ZeroPadding2D(padding = ((3, 3), (3, 3)))(img_input)\n    x = Conv2D(64, 7, strides = 2, use_bias = False, name = 'conv1\/conv')(x)\n    x = BatchNormalization(axis = bn_axis, epsilon = 1.001e-5, name = 'conv1\/bn')(x)\n    x = Activation('relu', name = 'conv1\/relu')(x)\n    x = ZeroPadding2D(padding = ((1, 1), (1, 1)))(x)\n    x = MaxPooling2D(3, strides = 2, name = 'pool1')(x)\n\n    x = dense_block(x, blocks[0], name = 'conv2')\n    x = transition_block(x, 0.5, name = 'pool2')\n    x = dense_block(x, blocks[1], name = 'conv3')\n    x = transition_block(x, 0.5, name = 'pool3')\n    x = dense_block(x, blocks[2], name = 'conv4')\n    x = transition_block(x, 0.5, name = 'pool4')\n    x = dense_block(x, blocks[3], name = 'conv5')\n\n    x = BatchNormalization(axis = bn_axis, epsilon = 1.001e-5, name = 'bn')(x)\n    x = Activation('relu', name = 'relu')(x)\n    \n    basemodel = Model(img_input, x, name='basedensenet121')\n    basemodel.load_weights(\"..\/input\/densenet-keras\/DenseNet-BC-121-32-no-top.h5\")\n    \n    x = basemodel.output\n    x = GlobalAveragePooling2D(name = 'avg_pool')(x)\n    x = Dropout(0.5)(x)\n    x = Dense(classes, activation = 'sigmoid', name = 'fc1')(x)\n    \n    model = Model(img_input, x, name='densenet121')\n    return model","323c3db5":"model = DenseNet121(blocks = [6, 12, 24, 16], input_shape = (224, 224, 3), classes = 1)\nmodel.summary()","e8a5f093":"# compile the model\nopt = Adam(lr = 0.001)\nmodel.compile(loss = \"binary_crossentropy\", optimizer = opt, metrics = [\"accuracy\"])","6c3b67a1":"# this will help in reducing learning rate by factor of 0.1 when accuarcy will not improve\nreduce_lr = ReduceLROnPlateau(monitor = 'val_accuracy', patience = 2, verbose = 1,\n                                            factor = 0.3, min_lr = 0.000001)","e4ee0092":"class myCallback(Callback):\n\tdef on_epoch_end(self, epoch, logs={}):\n\t\tif(logs.get('val_accuracy') > 0.93):\n\t\t\tprint(\"\\nReached 93% accuracy so cancelling training!\")\n\t\t\tself.model.stop_training = True\n\ncallbacks = myCallback()","849c83c9":"H = model.fit_generator(training_set,\n                        steps_per_epoch = training_set.samples\/\/batch_size,\n                        validation_data = val_set,\n                        epochs = 15,\n                        validation_steps = val_set.samples\/\/batch_size,\n                        callbacks = [reduce_lr, callbacks])","a0dbf284":"print(\"Loss of the model is - \" , model.evaluate(test_set)[0])\nprint(\"Accuracy of the model is - \" , model.evaluate(test_set)[1]*100 , \"%\")","a5f4414f":"# Extract 9 random images from normal\nimageset = glob(test_dir + \"*\/*\")\nrandom_images = [np.random.choice(imageset) for i in range(9)]\n\nprint('Display Random Images')\n\n# Adjust the size of your images\nplt.figure(figsize=(10,8))\n\n# Iterate and plot random images\nfor i in range(9):\n    plt.subplot(3, 3, i + 1)\n    img = cv2.imread(random_images[i])\n    orig = img.copy()\n    img = cv2.resize(img, (299,299))\n    img = img_to_array(img)\n    img = np.expand_dims(img, axis=0)\n    img = img\/255\n    prediction = model.predict(img)\n    \n    if (prediction < 0.5):\n        plt.title(\"Normal\", fontdict = {'fontsize' : 30})\n    \n    else:\n        plt.title(\"Pneumonia\", fontdict = {'fontsize' : 30})\n    plt.imshow(orig, cmap='gray')\n    plt.axis('off')\n    \n# Adjust subplot parameters to give specified padding\nplt.tight_layout()  ","23c714ae":"# Let's try this one more time\nimageset = glob(train_dir + \"*\/*\")\nrandom_images = [np.random.choice(imageset) for i in range(9)]\n\nprint('Display Random Images')\n\n# Adjust the size of your images\nplt.figure(figsize=(10,8))\n\n# Iterate and plot random images\nfor i in range(9):\n    plt.subplot(3, 3, i + 1)\n    img = cv2.imread(random_images[i])\n    orig = img.copy()\n    img = cv2.resize(img, (299,299))\n    img = img_to_array(img)\n    img = np.expand_dims(img, axis=0)\n    img = img\/255\n    prediction = model.predict(img)\n    \n    if (prediction < 0.5):\n        plt.title(\"Normal\", fontdict = {'fontsize' : 30})\n    \n    else:\n        plt.title(\"Pneumonia\", fontdict = {'fontsize' : 30})\n    plt.imshow(orig, cmap='gray')\n    plt.axis('off')\n    \n# Adjust subplot parameters to give specified padding\nplt.tight_layout()  ","074d5fc8":"## Visualize the Dataset","54eaca4d":"## What is Pneumonia\n\nPneumonia is a lung infection that can range from mild to so severe that you have to go to the hospital.\n\nIt happens when an infection causes the air sacs in your lungs (your doctor will call them alveoli) to fill with fluid or pus. That can make it hard for you to breathe in enough oxygen to reach your bloodstream.\n\nAnyone can get this lung infection. But infants younger than age 2 and people over age 65 are at higher risk. That\u2019s because their immune systems might not be strong enough to fight it.\n\nYou can get pneumonia in one or both lungs. You can also have it and not know it. Doctors call this walking pneumonia. Causes include bacteria, viruses, and fungi.  If your pneumonia results from bacteria or a virus, you can spread it to someone else. \n\n### Symptoms of Pneumonia\n\n<img src=\"https:\/\/assets-global.website-files.com\/5862e65e743316b605bc7fa4\/5c4fcdb8a6ea9c009b759bce_20190128-29-main-symptoms-of-infectious-pneumonia.jpg\">\n\nYour symptoms can vary depending on what\u2019s causing your pneumonia, your age, and your overall health. They usually develop over several days.\n\nCommon pneumonia symptoms include:\n\n1. Chest pain when you breathe or cough\n2. Cough that produces phlegm or mucus\n3. Fatigue and loss of appetite\n4. Fever, sweating, and chills\n5. Nausea, vomiting, and diarrhea\n6. Shortness of breath\n\n### Causes of Pneumonia\n\nBacteria, viruses, or fungi can cause pneumonia.\n\nCommon causes include:\n\n1. Flu viruses\n2. Cold viruses\n3. RSV virus (the top cause of pneumonia in babies age 1 or younger)\n4, Bacteria called Streptococcus pneumoniae and Mycoplasma pneumoniae\n\n### Pneumonia Diagnosis\n\nYour doctor will start with questions about your symptoms and your medical history, like whether you smoke and whether you\u2019ve been around sick people at home, school, or work. Then, they\u2019ll listen to your lungs. If you have pneumonia, they might hear cracking, bubbling, or rumbling sounds when you breathe in.\n\nIf your doctor thinks you might have pneumonia, they\u2019ll probably give you tests, including:\n\n1. Blood tests to look for signs of a bacterial infection\n2. A chest X-ray to find the infection in your lungs and how far it\u2019s spread\n3. Pulse oximetry to measure the level of oxygen in your blood\n4. A sputum test to check the fluid in your lungs for the cause of an infection\n\nIf your symptoms started in the hospital or you have other health problems, your doctor might give you more tests, such as:\n\n1. An arterial blood gas test to measure the oxygen in a small amount of blood taken from one of your arteries\n2. Bronchoscopy to check your airways for blockages or other problems\n3. A CT scan to get a more detailed image of your lungs\n4. A pleural fluid culture, in which the doctor removes a small amount of fluid from the tissues around your lungs to look for bacteria that might cause pneumonia\n\nLet's watch a video\n","cdb1d980":"## Importing libraries","9d244003":"> We have way more images that are classified as pneumonia than normal. This shows that we have a subcategory imbalance in our data. We will handle this too in later stage","9c862f59":"## Handle Imbalnce dataset","d32ae587":"## Data Augmentation\n\nIn order to avoid overfitting problem, we need to perform augmentation on our dataset. We can make existing dataset even larger in this way. I am using ImageDataGenerator class to augment dataset. The methods used for Augmentation are rotation, zoom, width_shift, height_shift, horizontal_flip and rescale. Rescale is necessary for image normalization.   ","d4207790":"In next some code blocks we will split the data in Train, Validation and Testing in ratio of 80% for Training, 10% for Validation, and 10% for Testing","077b4faa":"From the above two distribution, we can see that Images are not having same shape. Let's find out images shape ditribution within training folder","acd58057":"## Training the Model","d270d77a":"## Load the data and initialize data directory","7d1a9d31":"That's all for this notebook. If you like my work please upvote this... This motivate me.","69fbf105":"We have data splitted in Train, Test and Validation folders. All three folders have Normal and Pneumonia Images. We have only 16 validation images which is not sufficient for better training, We will handle this imbalnce in later stage. Let's visualize how many images are there in each folder and category.","6d29ce97":"## Traning  Convolution Neural Network\n\nI am trying DenseNet121 for 10 epochs with data we just created. To make our model more easier to understand, next some code blocks will define network architecture for densenet121. You can find more details about DenseNet at [here](https:\/\/arxiv.org\/pdf\/1608.06993.pdf) and implementation in keras at [here](https:\/\/github.com\/keras-team\/keras-applications\/blob\/master\/keras_applications\/densenet.py)"}}