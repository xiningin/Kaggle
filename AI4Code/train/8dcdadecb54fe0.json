{"cell_type":{"af03bb08":"code","1243c1fc":"code","e4ae5a40":"code","dc320113":"code","38c58293":"code","89a94572":"code","05f1d733":"code","b7b3d7a4":"code","208bc23a":"code","4550ca1c":"code","87d5b5df":"code","dbe1d184":"code","c9dba813":"code","a9d4e33d":"code","8d3744af":"code","009d4b57":"code","1bcad52f":"code","52be2d2f":"code","7db454a0":"code","3d700c35":"code","df96a682":"code","b97cb365":"code","ccbf7485":"code","99239efd":"code","e7b218fe":"code","98f455d6":"code","dd1c64d7":"code","37b33a2e":"code","a7872175":"code","9618b578":"code","806511b3":"code","21c27f2f":"code","172c04f9":"code","85de1757":"code","225faf83":"code","4730efdb":"code","3aee0913":"code","ccb56d40":"markdown","1b468fda":"markdown","4f593fe2":"markdown","797f1e36":"markdown","3f74baee":"markdown","7eef2766":"markdown","326c884a":"markdown","7ac79b65":"markdown","ac5fd07c":"markdown","092298b3":"markdown","17f8ecc5":"markdown","39434f17":"markdown","73fd98c4":"markdown","0d4ad32b":"markdown","3ae62535":"markdown","e2fb09c1":"markdown","ec9e67b7":"markdown","c5dc9d4b":"markdown","3b673e2a":"markdown","d9e5d9c8":"markdown","f75792de":"markdown","025659fa":"markdown","39e528fb":"markdown","6cba02c3":"markdown","af957d7d":"markdown","fa5e7311":"markdown","2e7eb260":"markdown","18446da4":"markdown","915e0a10":"markdown","524a5ef3":"markdown","00e03f40":"markdown","cb4c56fc":"markdown","4464d018":"markdown","8cd67fb4":"markdown","f0126f82":"markdown","86628dbf":"markdown","5956d5c8":"markdown","a4660bf3":"markdown"},"source":{"af03bb08":"# This Python 3 environment comes with many helpful analytics libraries installed\n# It is defined by the kaggle\/python Docker image: https:\/\/github.com\/kaggle\/docker-python\n# For example, here's several helpful packages to load\n\nimport numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\n\n# Input data files are available in the read-only \"..\/input\/\" directory\n# For example, running this (by clicking run or pressing Shift+Enter) will list all files under the input directory\n\nimport os\nfor dirname, _, filenames in os.walk('\/kaggle\/input'):\n    for filename in filenames:\n        print(os.path.join(dirname, filename))\n\n# You can write up to 20GB to the current directory (\/kaggle\/working\/) that gets preserved as output when you create a version using \"Save & Run All\" \n# You can also write temporary files to \/kaggle\/temp\/, but they won't be saved outside of the current session","1243c1fc":"import os\nimport re\nimport matplotlib.pyplot as plt\nfrom os.path import join\nfrom urllib.request import urlopen\nimport json\n\nfrom shapely.geometry import Point\nfrom shapely.geometry.polygon import Polygon\n\nimport spacy \nnlp = spacy.load(\"en_core_web_sm\") \n\nfrom tqdm.auto import tqdm\ntqdm.pandas()\n\npd.set_option(\"max_colwidth\", None)","e4ae5a40":"root_dir = \"..\/input\/cdp-unlocking-climate-solutions\"\nsupp_root_dir = \"..\/input\/supplementary-data-for-cdp-analytics-competition\"\n#root_dir = \".\"\n\n# import cities response df\ncities_df = pd.read_csv(os.path.join(root_dir, \"Cities\/Cities Responses\/2020_Full_Cities_Dataset.csv\"))\ncities_meta_df = pd.read_csv(os.path.join(root_dir, \"Cities\/Cities Disclosing\/2020_Cities_Disclosing_to_CDP.csv\"))\n\ncities_df = pd.merge(cities_df,\n                     cities_meta_df[['Account Number', 'City']],\n                     on='Account Number',\n                     how='left'\n                    )\n\ncities_df['City'] = cities_df['City'].fillna(cities_df['Organization'])\nus_cities = cities_df[cities_df['Country']=='United States of America']['City'].unique()\nus_cities_household_size = pd.read_csv(join(supp_root_dir, \"persons_per_household.tsv\"), header=None, names=['city', 'persons_per_household'], sep='\\t')\n\ndef find_matching_city(city):\n    for city_name in us_cities:\n        if city in city_name:\n            return city_name\n    return None\n\nus_cities_household_size['matching_city'] = us_cities_household_size['city'].apply(find_matching_city)\ndf_us_cities_household = us_cities_household_size[~pd.isnull(us_cities_household_size['matching_city'])][['matching_city', 'persons_per_household']].rename(columns={'matching_city':'city'})\n\ncols = ['Account Number','Organization', 'Country', 'City','CDP Region', 'Response Answer']\npopulations = cities_df[(cities_df['Question Number']==\"0.5\")&(cities_df['Column Name']==\"Current population\")][cols].rename(columns={'Response Answer': 'population'})\n","dc320113":"q_num = '8.1'\ncols = ['Geothermal', 'Hydro', 'Coal', 'Biomass', 'Oil', 'Solar', 'Wind', 'Gas', 'Other sources', 'Nuclear']\n\ndef pivot_data(df):\n    return df[['Column Name', 'Response Answer']].set_index('Column Name').transpose()\n\nq_num_cond = (cities_df['Question Number']==q_num)&(cities_df['Column Name'].isin(cols))\ndf_elec_mix_summary = cities_df[q_num_cond].groupby(['Account Number']).apply(pivot_data).droplevel(1)\n\ndf_elec_mix_summary = df_elec_mix_summary.astype(float)\ndf_elec_mix_summary.fillna(0.0, inplace=True)\ndf_elec_mix_summary['total'] = df_elec_mix_summary.sum(axis=1)\ndf_elec_mix_summary['Unknown'] = df_elec_mix_summary['total'].apply(lambda x: 100-np.rint(x))\ndf_elec_mix_final = pd.merge(df_elec_mix_summary.reset_index(),\n                             cities_df[['Account Number', 'City']].drop_duplicates(),\n                             on='Account Number',\n                             how='left')\n\nus_elec_mix = df_elec_mix_final[df_elec_mix_final['City'].isin(us_cities)].copy()\n#print(\"Number of cities:\", len(us_elec_mix))\ncols = ['Coal', 'Gas', 'Oil', 'Biomass', 'Nuclear', 'Solar', 'Geothermal', 'Wind', 'Hydro', 'Other sources', 'Unknown']\ntmp = us_elec_mix.set_index(\"City\")[cols].sort_values(by=['Coal', 'Gas', 'Oil', 'Unknown'], ascending=[True, True, True, False])\nplt.rcParams[\"axes.prop_cycle\"] = plt.cycler(\"color\", plt.cm.tab20c.colors)  # TODO: tweak color wheel to make it more intuitive\ntmp.plot.barh(stacked=True, figsize=(6, 15 * (len(tmp)\/40)), title='US cities')\nplt.xlabel(\"electricity source\")\nplt.legend(loc=(1.04,0))\nplt.show()","38c58293":"with urlopen('https:\/\/raw.githubusercontent.com\/plotly\/datasets\/master\/geojson-counties-fips.json') as response:\n    counties = json.load(response)\n\ndef location_to_tuple(text):\n    if isinstance(text, str):\n        point = text.split(' ')[1:]\n        point[0] = float(point[0].replace(\"(\", \"\"))\n        point[1] = float(point[1].replace(\")\", \"\"))\n        return point\n    return None\n\n#location_to_tuple(cities_meta_df.iloc[0]['City Location'])\n# latitude is 36, longitude is -86    \n\n#point = Point(-86.7816, 36.1627)\n#polygon = Polygon([(0, 0), (0, 1), (1, 1), (1, 0)])\n#print(polygon.contains(point))\n\ndepth = lambda L: isinstance(L, list) and max(map(depth, L))+1\n\ndef count(l):\n    return sum(1+count(i) for i in l if isinstance(i,list))\n\ndef find_county(longitude, latitude):\n    the_point = Point(longitude, latitude)\n    for county in counties['features']:\n        if depth(county['geometry']['coordinates']) == 3: \n            poly = county['geometry']['coordinates'][0]\n            county_polygon = Polygon(poly)\n            if county_polygon.contains(the_point):\n                return county['id']\n        elif depth(county['geometry']['coordinates']) == 4:\n            for region in county['geometry']['coordinates']:\n                poly = region[0]\n                county_polygon = Polygon(poly)\n                if county_polygon.contains(the_point):\n                    return county['id']                \n    return None\n\n#find_county(-86.7816, 36.1627)\n#find_county(-118.481, 34.0219)\n\ndef find_county_df(x):\n    return find_county(*x) if x else None\n\n# from Google\nsupplement_city_locations = pd.DataFrame([(\"San Luis Obispo\", \"POINT (-120.6596 35.2828)\"),\n(\"City of Aurora, IL\", \"POINT (-88.3201 41.7606)\"),\n(\"Orange County, NC\", \"POINT (-79.1097 36.0263)\"),\n(\"Summit County, UT\", \"POINT (-110.9984 40.8298)\"),\n(\"City of Omaha\", \"POINT (-95.9345 41.2565)\"),\n(\"City of St. Petersburg\", \"POINT (-82.6403 27.7676)\"),\n(\"Town of Princeton, NJ\", \"POINT (-74.6672 40.3573)\"),\n(\"City of South Bend, IN\", \"POINT (-86.2520 41.6764)\"),\n(\"Town of Breckenridge, CO\", \"POINT (-106.0384 39.4817)\"),\n(\"City of Eau Claire, WI\", \"POINT (-91.4985 44.8113)\"),\n(\"City of Birmingham\", \"POINT (-86.8104 33.5186)\"),\n(\"City of Berkeley\", \"POINT (-122.2730 37.8715)\"),\n(\"City of Highland Park, IL\", \"POINT (-87.8003 42.1817)\"),\n(\"City of Grand Rapids\", \"POINT (-85.6681 42.9634)\"),\n(\"City of Beverly, MA\", \"POINT (-70.8800 42.5584)\"),\n(\"City of Key West, FL\", \"POINT (-81.7800 24.5551)\"),\n(\"Village of South Barrington, IL\", \"POINT (-88.1535 42.0881)\"),\n(\"City of Henderson\", \"POINT (-114.9817 36.0395)\"),\n(\"City of Albuquerque\", \"POINT (-106.6504 35.0844)\"),\n(\"City of Alameda\", \"POINT (-122.2822 37.7799)\"),\n(\"Town of York, ME\", \"POINT (-70.6483 43.1617)\"), \n(\"Village of Park Forest, IL\", \"POINT (-87.6745 41.4914)\"),\n(\"City of Holland, MI\", \"POINT (-86.1089 42.7875)\"),\n(\"Arlington, VA\", \"POINT (-77.0910 38.8816)\"),\n#                                           (\"City of Milwaukie, OR\", ),\n#                                           (\"Dane County\", ),\n#                                           (\"City of Racine, WI\", ),\n#                                           (\"City of Spokane\", ),\n#                                           (\"City of Greenbelt, MD\", )\n#                                           (\"City of Wilmington, NC\", ),\n#                                           (\"Town of Guilford, VT\", ),\n#                                           (\"City of Ashland, OR\", ),\n(\"Cuyahoga County\", \"POINT (-81.6758 41.4339)\"),\n                                         ], columns=['Organization', 'City Location'])\n#supplement_city_locations","89a94572":"renewable_cols = ['Biomass', 'Nuclear', 'Solar', 'Geothermal', 'Wind', 'Hydro', 'Other sources']\nus_elec_mix['total_renewable'] = us_elec_mix[renewable_cols].sum(axis=1)\ncities_meta_df['City Location tuple'] = cities_meta_df['City Location'].apply(location_to_tuple)\ncities_meta_df['county_id'] = cities_meta_df['City Location tuple'].progress_apply(find_county_df)\n\nknown_mix = (us_elec_mix['total']==100)\nus_elec_mix_with_county_id = pd.merge(us_elec_mix[known_mix], cities_meta_df, on='Account Number')[['Account Number', 'Organization','county_id', 'total_renewable']]\n#pd.isnull(us_elec_mix_with_county_id['county_id']).sum() \/ len(us_elec_mix_with_county_id)\n\ndf_supplement_city_loc = pd.merge(cities_meta_df[['Account Number', 'Organization']].drop_duplicates(),#us_elec_mix_with_county_id,\n                                  supplement_city_locations,\n                                  on='Organization')\n\nfor i,row in df_supplement_city_loc.iterrows():\n    cities_meta_df.loc[cities_meta_df['Account Number']==row['Account Number'], 'City Location'] = row['City Location']\n    \ncities_meta_df['City Location tuple'] = cities_meta_df['City Location'].apply(location_to_tuple)\ncities_meta_df['county_id'] = cities_meta_df['City Location tuple'].progress_apply(find_county_df)    ","05f1d733":"# get state name (needed for later)\n# https:\/\/www.kaggle.com\/c\/cdp-unlocking-climate-solutions\/discussion\/199694\nfrom geopy.geocoders import Nominatim\n\ngeolocator = Nominatim(user_agent=\"geoapiExercises\")\ndef city_state_country(coord):\n    location = geolocator.reverse(coord, exactly_one=True)\n    address = location.raw['address']\n    #city = address.get('city', '')\n    state = address.get('state', '')\n    #country = address.get('country', '')\n    return state\n\n#print(city_state_country(\"44.4938, 11.3387\")) #Account number=36274 and point=(11.3387 44.4938)\n\ndef get_state(city_location_tuple):\n    if city_location_tuple:\n        try:\n            return city_state_country(str([el for el in reversed(city_location_tuple)]).replace(\"[\",\"\").replace(\"]\",\"\"))\n        except:\n            print(\"Unknown address\")\n    return None\n\ncities_meta_df['State'] = cities_meta_df['City Location tuple'].progress_apply(get_state)\n\ncities_meta_df['City'] = cities_meta_df['City'].fillna(cities_meta_df['Organization'])\n\nus_elec_mix_with_county_id = pd.merge(us_elec_mix[known_mix], cities_meta_df, on='Account Number')[['Account Number', 'Organization','county_id', 'total_renewable']]\n","b7b3d7a4":"import plotly.express as px\nfig = px.choropleth(us_elec_mix_with_county_id[~pd.isnull(us_elec_mix_with_county_id['county_id'])][['county_id', 'total_renewable', 'Organization']],\n                    geojson=counties, locations='county_id', color='total_renewable',\n                    #color_continuous_scale=\"Viridis\",\n                    color_continuous_scale=['red', 'yellow', 'green'],\n                    range_color=(0, 100),\n                    #scope=\"north america\",\n                    scope='usa',\n                    hover_data=['Organization', 'total_renewable'],\n                    labels={'total_renewable':'renewable elec. source %'},\n                    #title='Percentage of electricity from renewable sources'\n                          )\n#fig.update_geos(resolution=50)\n\nfig.update_layout(margin={\"r\":0,\"t\":0,\"l\":0,\"b\":0})\nfig.show()","208bc23a":"q_num=\"4.6a\"\n# 4.6a The Global Covenant of Mayors requires committed cities to report their inventories in the format of the new \n# Common Reporting Framework, to encourage standard reporting of emissions data. Please provide a breakdown of your \n# city-wide emissions by sector and sub-sector in the table below. Where emissions data is not available, please use \n# the relevant notation keys to explain the reason why.\n\ncol = \"Direct emissions (metric tonnes CO2e)\"\n\ndef pivot_data(df):\n    return df[['Row Name', 'Response Answer']].set_index('Row Name').transpose()\n\nq_num_cond = (cities_df['Question Number']==q_num)&(cities_df['Column Name']==col)\nrow_cond = (cities_df['Row Name'].str.contains(\"Total\"))\ndf_ghg_breakdown_summary = cities_df[q_num_cond&row_cond].groupby(['Account Number']).apply(pivot_data).droplevel(1)\n#len(df_ghg_breakdown_summary)\n\ndf_ghg_breakdown_summary = df_ghg_breakdown_summary[df_ghg_breakdown_summary['Total Transport']!='Question not applicable'].copy()\ndf_ghg_breakdown_summary.fillna(0, inplace=True)\ndf_ghg_breakdown_summary = df_ghg_breakdown_summary.astype(float)\n\n# number of cities with a ghg summary\n#na_cities = cities_df[cities_df['CDP Region']==\"North America\"]\n#len(na_cities['Organization'].unique()), df_ghg_breakdown_summary.index.isin(na_cities['Account Number'].unique()).sum()\n\ncols = ['Total IPPU', 'Total Stationary Energy', 'Total Transport', 'Total Waste', 'Total AFOLU']\ndf_ghg_breakdown_summary['check_diff'] = df_ghg_breakdown_summary['Total Emissions (excluding generation of grid-supplied energy)'] - df_ghg_breakdown_summary[cols].sum(axis=1)\n\n# number of cities with a consistent GHG breakdown\nconsistent_ghg_total = df_ghg_breakdown_summary['check_diff'].abs() <20\n\ndf_ghg_summary_final = pd.merge(df_ghg_breakdown_summary[consistent_ghg_total].reset_index(),\n                                cities_df[['Account Number', 'City']].drop_duplicates(),\n                                on='Account Number',\n                                how='left')\n\ntotal_col = 'Total Emissions (excluding generation of grid-supplied energy)'\nghg_summary_for_plot = df_ghg_summary_final[df_ghg_summary_final[total_col]>0].set_index('City').sort_values([total_col]).loc[:, cols]\n\nus_direct_ghg_summary = ghg_summary_for_plot[ghg_summary_for_plot.index.isin(us_cities)]\n#print(\"Total number of cities:\", len(us_cities))\n#print(\"Total number with summary:\", len(us_direct_ghg_summary))\nplt.rcParams[\"axes.prop_cycle\"] = plt.cycler(\"color\", plt.cm.tab10.colors)\nus_direct_ghg_summary.plot.barh(stacked=True, figsize=(6, 15 * (len(us_direct_ghg_summary)\/40)), title='US cities')\nplt.xlabel(\"GHG emissions (excl. grid energy gen) (metric tonnes CO2e)\")\nplt.legend(loc=(1.04,0))\nplt.show()","4550ca1c":"us_direct_ghg_summary_per_capita = pd.merge(us_direct_ghg_summary.reset_index(),\n                                            populations[['City', 'population']],\n                                            on='City',\n                                            how='left')\n    \nus_direct_ghg_summary_per_capita.set_index('City', inplace=True)\nus_direct_ghg_summary_per_capita = us_direct_ghg_summary_per_capita.astype(float)\nus_direct_ghg_summary_per_capita = us_direct_ghg_summary_per_capita.div(us_direct_ghg_summary_per_capita['population'],axis='rows').drop(['population'], axis=1)\nus_direct_ghg_summary_per_capita['total'] = us_direct_ghg_summary_per_capita.astype(float).sum(axis=1)\nus_direct_ghg_summary_per_capita.sort_values(by='total')[us_direct_ghg_summary_per_capita.columns[:-1]].plot.barh(stacked=True,  \n                                                                                                                  figsize=(6, 15 * (len(us_direct_ghg_summary_per_capita)\/40)),                                                                             \n                                                                                                                  title='US cities')\n\nplt.xlabel(\"Direct GHG emissions per capita\")\nplt.legend(loc=(1.04,0))\nplt.show()","87d5b5df":"# what is the sector breakdown of the stationary energy\n\nrow_cond = (cities_df['Row Name'].str.contains(\"Stationary energy > \"))\ndf_direct_stationary_breakdown = cities_df[q_num_cond&row_cond].groupby(['Account Number']).apply(pivot_data).droplevel(1)\n\ndf_direct_stationary_breakdown = df_direct_stationary_breakdown[df_direct_stationary_breakdown['Stationary energy > Residential buildings']!='Question not applicable'].astype(float).fillna(0)\ndf_direct_stationary_breakdown_final = pd.merge(df_direct_stationary_breakdown.reset_index(),\n                                                cities_df[['Account Number', 'City']].drop_duplicates(),\n                                                on='Account Number',\n                                                how='left')\nus_direct_stationary_breakdown = df_direct_stationary_breakdown_final[df_direct_stationary_breakdown_final['City'].isin(us_cities)]\nus_direct_stationary_breakdown = pd.merge(us_direct_stationary_breakdown,\n                                          us_direct_ghg_summary.reset_index(),\n                                          on='City')\nstat_columns = ['Stationary energy > Residential buildings',\n                'Stationary energy > Commercial buildings & facilities',\n                'Stationary energy > Industrial buildings & facilities',\n                'Stationary energy > Agriculture',\n                'Stationary energy > Institutional buildings & facilities',\n                'Stationary energy > Fugitive emissions']\n\nus_direct_stationary_breakdown = us_direct_stationary_breakdown.set_index('City')[stat_columns]\nus_direct_stationary_breakdown_norm = us_direct_stationary_breakdown.div(us_direct_stationary_breakdown.sum(axis=1), axis=0)\nus_direct_stationary_breakdown_norm.dropna().sort_values(by=['Stationary energy > Residential buildings']).plot.barh(stacked=True,  \n                                                                                                                         figsize=(6, 15 * (len(us_direct_stationary_breakdown_norm)\/40)),\n                                                                                                                         title='Direct stationary emission sub-sector proportion')\nplt.xlabel(\"Proportion of all direct stationary emissions\")\nplt.legend(loc=(1.04,0))\nplt.show()","dbe1d184":"q_num=\"4.6a\"\ncol = \"Direct emissions (metric tonnes CO2e)\"\n    \ndef pivot_data(df):\n    return df[['Row Name', 'Response Answer']].set_index('Row Name').transpose()\n\nq_num_cond = (cities_df['Question Number']==q_num)&(cities_df['Column Name']==col)\nrow_cond = (cities_df['Row Name'].str.contains(\"Residential\"))\ndf_res_stat = cities_df[q_num_cond&row_cond].groupby(['Account Number']).apply(pivot_data).droplevel(1)\n\ncol_name = 'Stationary energy > Residential buildings'\ndf_res_stat_valid = df_res_stat[(~pd.isnull(df_res_stat[col_name]))&(df_res_stat[col_name]!='Question not applicable')]\ndf_us_res_stat = pd.merge(df_res_stat_valid.reset_index(),\n                                       cities_df[cities_df['Country']=='United States of America'][['City', 'Account Number']].drop_duplicates(),\n                                       on=['Account Number'],\n                                      )[['City', col_name]].set_index(\"City\")\ndf_us_res_stat = df_us_res_stat.astype(float)\n\ndf_us_res_stat_per_capita = pd.merge(df_us_res_stat,\n                                     populations[['City', 'population']],                                     \n                                     left_index=True,\n                                     right_on='City',\n                                     how='left')\ndf_us_res_stat_per_capita.set_index('City', inplace=True)\ndf_us_res_stat_per_capita = df_us_res_stat_per_capita.astype(float)\ndf_us_res_stat_per_capita = df_us_res_stat_per_capita.div(df_us_res_stat_per_capita['population'],axis='rows').drop(['population'], axis=1)\n#df_us_res_stat_per_capita.sort_values(by=col_name).plot.barh(stacked=True, figsize=(6, 15), title=\"US cities\")\n#plt.xlabel(\"Stationary energy direct GHG emissions > Residential sector\")\n\n# can convert this to household (US average is 2.52 persons per household)\nres_stat_persons_per_household = pd.merge(df_us_res_stat_per_capita.reset_index(),\n                                 df_us_cities_household,\n                                 left_on='City',\n                                 right_on='city', how='left')['persons_per_household'].fillna(2.52) # US average\nres_stat_persons_per_household = res_stat_persons_per_household.astype(float)\ndf_us_res_stat_per_household = df_us_res_stat_per_capita.multiply(list(res_stat_persons_per_household), axis=0)\ndf_us_res_stat_per_household.sort_values(by=col_name).plot.barh(stacked=True, figsize=(6, 15), title=\"US cities\")\nplt.xlabel(\"Residential stationary energy direct GHG emissions per household.\")\nplt.show()","c9dba813":"q_num=\"4.6a\"\ncol = \"Indirect emissions from the use of grid-supplied electricity, heat, steam and\/or cooling (metric tonnes CO2e)\"\n\nrow_cond = (cities_df['Row Name'].str.contains(\"Stationary energy > \"))\ndf_indirect_stationary_breakdown = cities_df[q_num_cond&row_cond].groupby(['Account Number']).apply(pivot_data).droplevel(1)\n\ndf_indirect_stationary_breakdown = df_indirect_stationary_breakdown[df_indirect_stationary_breakdown['Stationary energy > Residential buildings']!='Question not applicable'].astype(float).fillna(0)\ndf_indirect_stationary_breakdown_final = pd.merge(df_indirect_stationary_breakdown.reset_index(),\n                                                cities_df[['Account Number', 'City']].drop_duplicates(),\n                                                on='Account Number',\n                                                how='left')\nus_indirect_stationary_breakdown = df_indirect_stationary_breakdown_final[df_indirect_stationary_breakdown_final['City'].isin(us_cities)]\nus_indirect_stationary_breakdown = pd.merge(us_indirect_stationary_breakdown,\n                                          us_direct_ghg_summary.reset_index()[['City']],\n                                          on='City')\nus_indirect_stationary_breakdown\n#stat_columns = [el for el in us_indirect_stationary_breakdown.columns if \">\" in el]\n#tat_columns = [stat_columns[4]] + stat_columns[0:4] + stat_columns[5:]\nstat_columns = ['Stationary energy > Residential buildings',\n                'Stationary energy > Commercial buildings & facilities',\n                'Stationary energy > Industrial buildings & facilities',\n                'Stationary energy > Agriculture',\n                'Stationary energy > Institutional buildings & facilities',\n                'Stationary energy > Fugitive emissions']\nus_indirect_stationary_breakdown = us_indirect_stationary_breakdown.set_index('City')[stat_columns]\nus_indirect_stationary_breakdown_norm = us_indirect_stationary_breakdown.div(us_indirect_stationary_breakdown.sum(axis=1), axis=0)\nus_indirect_stationary_breakdown_norm.dropna().sort_values(by=['Stationary energy > Residential buildings']).plot.barh(stacked=True,  \n                                                                                                                         figsize=(6, 15 * (len(us_direct_stationary_breakdown_norm)\/40)),\n                                                                                                                         title='Indirect stationary emission sub-sector proportion')\nplt.xlabel(\"Proportion of all indirect stationary emissions\")\nplt.legend(loc=(1.04,0))\nplt.show()","a9d4e33d":"q_num_cond = (cities_df['Question Number']==q_num)&(cities_df['Column Name']==col)\nrow_cond = (cities_df['Row Name'].str.contains(\"Residential\"))\ndf_res_stat_indirect = cities_df[q_num_cond&row_cond].groupby(['Account Number']).apply(pivot_data).droplevel(1)\n\ncol_name = 'Stationary energy > Residential buildings'\ndf_res_stat_indirect_valid = df_res_stat_indirect[(~pd.isnull(df_res_stat_indirect[col_name]))&(df_res_stat_indirect[col_name]!='Question not applicable')]\n\ndf_us_res_stat_indirect = pd.merge(df_res_stat_indirect_valid.reset_index(),\n                                   cities_df[cities_df['Country']=='United States of America'][['City', 'Account Number']].drop_duplicates(),\n                                   on=['Account Number'],\n                                  )[['City', col_name]].set_index(\"City\")\n\ndf_us_res_stat_indirect = df_us_res_stat_indirect.astype(float)\n\ndf_us_res_stat_indirect_per_capita = pd.merge(df_us_res_stat_indirect,\n                                     populations[['City', 'population']],                                     \n                                     left_index=True,\n                                     right_on='City',\n                                     how='left')\ndf_us_res_stat_indirect_per_capita.set_index('City', inplace=True)\ndf_us_res_stat_indirect_per_capita = df_us_res_stat_indirect_per_capita.astype(float)\ndf_us_res_stat_indirect_per_capita = df_us_res_stat_indirect_per_capita.div(df_us_res_stat_indirect_per_capita['population'],axis='rows').drop(['population'], axis=1)\n\nres_stat_indirect_persons_per_household = pd.merge(df_us_res_stat_indirect_per_capita.reset_index(),\n                                                   df_us_cities_household,\n                                                   left_on='City',\n                                                   right_on='city', how='left')['persons_per_household'].fillna(2.52) # US average\nres_stat_indirect_persons_per_household = res_stat_indirect_persons_per_household.astype(float)\ndf_us_res_stat_indirect_per_household = df_us_res_stat_indirect_per_capita.multiply(list(res_stat_indirect_persons_per_household), axis=0)\n\ndf_us_res_stat_indirect_per_household.sort_values(by=col_name).plot.barh(stacked=True, figsize=(6, 15), title=\"US cities\")\nplt.xlabel(\"Residential stationary energy indirect GHG emissions per household.\")\nplt.show()","8d3744af":"q_num=\"4.6a\"    \ncol = \"Direct emissions (metric tonnes CO2e)\"\n\nq_num_cond = (cities_df['Question Number']==q_num)&(cities_df['Column Name']==col)\nrow_cond = (cities_df['Row Name'].str.contains(\"On-road\"))\ndf_onroad_trans = cities_df[q_num_cond&row_cond].groupby(['Account Number']).apply(pivot_data).droplevel(1)\n    \ncol_name = 'Transportation > On-road'\ndf_onroad_trans_valid = df_onroad_trans[(~pd.isnull(df_onroad_trans[col_name]))&(df_onroad_trans[col_name]!='Question not applicable')]\n\ndf_us_onroad_trans = pd.merge(df_onroad_trans_valid.reset_index(),\n                              cities_df[cities_df['Country']=='United States of America'][['City', 'Account Number']].drop_duplicates(),\n                              on=['Account Number'],\n                             )[['City', col_name]].set_index(\"City\")\n\ndf_us_onroad_trans = df_us_onroad_trans.astype(float)\n\n# providence looks off by two orders of magnitude, according to \n# https:\/\/www.providenceri.gov\/wp-content\/uploads\/2019\/01\/Providence-Citywide-GHG-Inventory_9.25.2019-1.pdf\n# manually correct it\ndf_us_onroad_trans.loc['Providence', 'Transportation > On-road'] = df_us_onroad_trans.loc['Providence', 'Transportation > On-road'] * 0.01\n\ndf_us_onroad_trans_per_capita = pd.merge(df_us_onroad_trans,\n                                         populations[['City', 'population']],                                     \n                                         left_index=True,\n                                         right_on='City',\n                                         how='left')\ndf_us_onroad_trans_per_capita.set_index('City', inplace=True)\ndf_us_onroad_trans_per_capita = df_us_onroad_trans_per_capita.astype(float)\ndf_us_onroad_trans_per_capita = df_us_onroad_trans_per_capita.div(df_us_onroad_trans_per_capita['population'],axis='rows').drop(['population'], axis=1)\n\nonroad_trans_persons_per_household = pd.merge(df_us_onroad_trans_per_capita.reset_index(),\n                                              df_us_cities_household,\n                                              left_on='City',\n                                              right_on='city', how='left')['persons_per_household'].fillna(2.52) # US average\nonroad_trans_persons_per_household = onroad_trans_persons_per_household.astype(float)\ndf_us_onroad_trans_per_household = df_us_onroad_trans_per_capita.multiply(list(onroad_trans_persons_per_household), axis=0)\n\n\n# US average: 50% of this comes from passenger vehicles\n# https:\/\/nepis.epa.gov\/Exe\/ZyPDF.cgi?Dockey=P100ZK4P.pdf\ndf_us_passenger_vehicle_per_household = df_us_onroad_trans_per_household * 0.5\ndf_us_passenger_vehicle = df_us_onroad_trans * 0.5\n\n#df_us_onroad_trans_per_household.sort_values(by=col_name).plot.barh(stacked=True, figsize=(6, 15), title=\"US cities\")\n#plt.xlabel(\"Transportation GHG emissions > On-road\")\n","009d4b57":"q = \"What is the mode share of each transport mode in your city for passenger transport?\"\nq_num = \"10.1\"\n\ndef pivot_data(df):\n    return df[['Column Name', 'Response Answer']].set_index('Column Name').transpose()\n\nq_num_cond = (cities_df['Question Number']==q_num)\ndf_transport_mode_share = cities_df[q_num_cond].groupby(['Account Number']).apply(pivot_data).droplevel(1)\ndf_transport_mode_share = df_transport_mode_share[df_transport_mode_share['Other']!='Question not applicable']\ndf_transport_mode_share.fillna(0, inplace=True)\ndf_transport_mode_share = df_transport_mode_share.astype(float)\ndf_transport_mode_share['total'] = df_transport_mode_share.sum(axis=1)\ndf_transport_mode_share['unaccounted'] = 100 - df_transport_mode_share['total']\nreasonable_total = (df_transport_mode_share['total']<=100)&(df_transport_mode_share['total']>=90)\ndf_transport_mode_share = pd.merge(df_transport_mode_share[reasonable_total].reset_index(),\n                                   cities_df[cities_df['City'].isin(us_cities)][['Account Number', 'City']].drop_duplicates(),\n                                   on='Account Number',\n                                   how='inner')\ntransport_share_for_plot = df_transport_mode_share.set_index('City').loc[:, list(df_transport_mode_share.columns[1:-3]) + ['unaccounted']].sort_values(['Private motorized transport'])\n\ncol_order = ['Private motorized transport', 'Buses (including BRT)', 'Rail\/Metro\/Tram', \n             'Taxis or For Hire Vehicles', 'Ferries\/ River boats',  'Micro-Mobility', 'Cycling', 'Walking', \n             'Other', 'unaccounted']\ntransport_share_for_plot[col_order].sort_values(by=['Private motorized transport'], ascending=[True])\\\n    .plot.barh(stacked=True, \n               figsize=(6, 15 * (len(transport_share_for_plot)\/40)),\n               title='Passenger transit mode')\nplt.xlabel(\"Passenger transit mode\")\nplt.legend(loc=(1.04,0))\nplt.show()","1bcad52f":"df_all_residential_ghg_emissions = pd.merge(df_us_passenger_vehicle,\n                                            df_us_res_stat_indirect,\n                                            left_index=True,\n                                            right_index=True\n                                           ).rename(columns={'Transportation > On-road': 'passenger vehicle',\n                                                             'Stationary energy > Residential buildings': 'indirect residential stationary'\n                                                            })\ndf_all_residential_ghg_emissions = pd.merge(df_all_residential_ghg_emissions,\n                                            df_us_res_stat,\n                                            left_index=True,\n                                            right_index=True                                                          \n                                           ).rename(columns={'Stationary energy > Residential buildings': 'direct residential stationary'})\n\n#df_all_residential_ghg_emissions\ndf_all_residential_ghg_emissions['total'] = df_all_residential_ghg_emissions.astype(float).sum(axis=1)\n\ndf_all_residential_ghg_emissions.sort_values(by='total')[df_all_residential_ghg_emissions.columns[:-1]].plot.barh(stacked=True,  \n                                                                                                                  figsize=(6, 15 * (len(df_all_residential_ghg_emissions)\/40)),\n                                                                                                                  title='Annual residential emissions',\n                                                                                                                 )\nplt.xlabel(\"Annual GHG emissions (metric tons CO2e)\")\nplt.legend(loc=(1.04,0))\nplt.show()","52be2d2f":"df_all_residential_ghg_emissions_per_household = pd.merge(df_us_passenger_vehicle_per_household,\n                                                          df_us_res_stat_indirect_per_household,\n                                                          left_index=True,\n                                                          right_index=True\n                                                         ).rename(columns={'Transportation > On-road': 'passenger vehicle',\n                                                                           'Stationary energy > Residential buildings': 'indirect residential stationary'\n                                                                          })\ndf_all_residential_ghg_emissions_per_household = pd.merge(df_all_residential_ghg_emissions_per_household,\n                                                          df_us_res_stat_per_household,\n                                                          left_index=True,\n                                                          right_index=True                                                          \n                                                         ).rename(columns={'Stationary energy > Residential buildings': 'direct residential stationary'})\n\n#df_all_residential_ghg_emissions_per_household\n\n\ndf_all_residential_ghg_emissions_per_household['total'] = df_all_residential_ghg_emissions_per_household.astype(float).sum(axis=1)\ndf_all_residential_ghg_emissions_per_household.sort_values(by='total')[df_all_residential_ghg_emissions_per_household.columns[:-1]].plot.barh(stacked=True,  \n                                                                                                                                              figsize=(6, 15 * (len(df_all_residential_ghg_emissions_per_household)\/40)),\n                                                                                                                                              title='Annual residential emissions per household',)\nplt.xlabel(\"Annual GHG emissions (metric tons CO2e)\")\nplt.legend(loc=(1.04,0))\nplt.show()","7db454a0":"list(pd.merge(df_all_residential_ghg_emissions.sort_values(by='total', ascending=False).head(10),\n         df_all_residential_ghg_emissions_per_household.sort_values(by='total', ascending=False).head(10),\n         left_index=True,\n         right_index=True\n        ).index.values)","3d700c35":"# normalized\nresidential_ghg_per_household_norm = df_all_residential_ghg_emissions_per_household.sort_values(by='total')[df_all_residential_ghg_emissions_per_household.columns[:-1]]\nresidential_ghg_per_household_norm = residential_ghg_per_household_norm.div(residential_ghg_per_household_norm.sum(axis=1), axis=0)\nresidential_ghg_per_household_norm.sort_values(by=['passenger vehicle', 'indirect residential stationary']).plot.barh(stacked=True,  \n                                              figsize=(6, 15 * (len(residential_ghg_per_household_norm)\/40)),\n                                              title='Residential emissions per household',)\nplt.xlabel(\"Proportion of residential annual GHG emissions\")\nplt.legend(loc=(1.04,0))\nplt.show()","df96a682":"!pip install numpy_financial\nimport numpy_financial as npf\n\ninterest_rate=0.10\/12\nmortgage_amount=18000\nn_periods = 5*12\nm_payment = npf.pmt(interest_rate, n_periods, mortgage_amount)\nm_payment","b97cb365":"average_annual_sunshine = pd.read_csv(join(supp_root_dir,\"average_annual_sunshine.txt\"), sep='\\t')\naverage_annual_sunshine['average_monthly_hours'] = average_annual_sunshine['Total Hours'].astype(float)\/12\naverage_annual_sunshine['average_monthly_peak_hours'] = average_annual_sunshine['average_monthly_hours']*0.5\naverage_annual_sunshine['solar_energy_kwh_per_month'] = average_annual_sunshine['average_monthly_peak_hours'] * 6\n\nelectricity_rate = pd.read_csv(join(supp_root_dir,\"average_monthly_electric_bill.txt\"), sep='\\t')\n\nsolar_energy_per_month_vs_elec = pd.merge(average_annual_sunshine,\n                                          electricity_rate,\n                                          on='State',\n                                          how='left')\nsolar_energy_per_month_vs_elec['energy_balance'] = solar_energy_per_month_vs_elec['Average Monthly Consumption (kWh)'].apply(lambda x: x.replace(\",\", \"\")).astype(float) - solar_energy_per_month_vs_elec['solar_energy_kwh_per_month']\nsolar_energy_per_month_vs_elec['cost_balance'] = solar_energy_per_month_vs_elec['energy_balance'] * solar_energy_per_month_vs_elec['Average Price (cents\/kWh)'].astype(float) \/ 100\nsolar_energy_per_month_vs_elec[['State', 'cost_balance']].set_index('State').sort_values(by=['cost_balance'], ascending=False).plot.barh(figsize=(6, 15 * (len(solar_energy_per_month_vs_elec)\/40)), title='Average monthly electricity bill difference after solar PV')\nplt.xlabel(\"Average change in monthly elecitricty bill ($)\")\n\nstate_abbrev = pd.read_csv(join(supp_root_dir,\"state_abbrev.txt\"), sep='\\t')\nsolar_energy_per_month_vs_elec = pd.merge(solar_energy_per_month_vs_elec,\n                                          state_abbrev,\n                                          left_on='State',\n                                          right_on='State\/District',\n                                          how='left'\n                                         )\n","ccbf7485":"household_income = pd.read_csv(join(supp_root_dir,\"household_income_dist.tsv\"), sep='\\t')\n# From US census website\nsupplement = [\n    {'Metro Name':'Lakewood, CO', 'Median HHI': 64100},\n    {'Metro Name':'Santa Monica, CA', 'Median HHI': 93865},\n    {'Metro Name':'Flagstaff, AZ', 'Median HHI': 56015},\n    {'Metro Name':'West Palm Beach, FL', 'Median HHI': 51635},\n    {'Metro Name':'Carmel, IN', 'Median HHI': 116867},\n    {'Metro Name':'Abington, PA', 'Median HHI': 91636},\n    {'Metro Name':'Somerville, MA', 'Median HHI': 91168},\n    {'Metro Name':'New Bedford, MA', 'Median HHI': 43989},\n    {'Metro Name':'San Leandro, CA', 'Median HHI': 70723},\n    {'Metro Name':'Evanston, IL', 'Median HHI': 77848},\n    {'Metro Name':'Emeryville, CA', 'Median HHI': 100568},\n    {'Metro Name':'Lexington, MA', 'Median HHI': 172750},\n    {'Metro Name':'Cuyahoga County, OH', 'Median HHI': 48435},\n    {'Metro Name':'Alameda, CA', 'Median HHI': 92574},\n    {'Metro Name':'City of Highland Park, IL', 'Median HHI': 147962},\n    {'Metro Name':'Boynton Beach, FL', 'Median HHI': 53504},\n    {'Metro Name':'Orange County, NC', 'Median HHI': 68211},\n    {'Metro Name':'City of Eau Claire, WI', 'Median HHI': 50940},\n    {'Metro Name':'Town of York, ME', 'Median HHI': 89962},\n\n]\nhousehold_income = household_income.append(supplement, ignore_index=True)\nhousehold_income['City'] = household_income['Metro Name'].apply(lambda x: x.rsplit(',', 1)[0].strip())\nhousehold_income['State'] = household_income['Metro Name'].apply(lambda x: x.rsplit(',', 1)[1].strip())\n\nus_household_income_distribution = pd.read_csv(join(supp_root_dir,\"household_us_income_distribution.tsv\"), sep='\\t')\nus_household_income_distribution['2020'] = us_household_income_distribution['2020'].apply(lambda x: float(x.replace(\"$\", \"\").replace(\",\", \"\")))\nus_household_income_distribution['Household Income Percentile'] = us_household_income_distribution['Household Income Percentile'].apply(lambda x: float(x.replace(\"%\", \"\")))\n","99239efd":"household_income = household_income[~household_income['Metro Name'].str.contains(\"Columbus, GA\/AL\")]\nhousehold_income = household_income[~household_income['Metro Name'].str.contains(\"Cleveland, TN\")]","e7b218fe":"tmp = df_all_residential_ghg_emissions_per_household.reset_index()\n\ndef find_city_name(city_name):\n    city_name = city_name.replace(\" City\", \"\").replace(\"\u00e9\", \"e\")\n    for i, row in household_income.iterrows():\n        if ',' in city_name:\n            city, state = city_name.split(\",\")\n            if city in row['City'] and state.strip() in row['State']:\n                return row['City']\n        elif city_name in row['City']:\n            return row['City']\n    return None\n\ntmp['city_alternate_name'] = tmp['City'].apply(find_city_name)\nghg_emissions_per_household_vs_income = pd.merge(tmp,\n                                                 household_income.rename(columns={'City': 'city_alternate_name'}),\n                                                 on=['city_alternate_name'],\n                                                 how='left'\n                                                )\n\nghg_emissions_per_household_vs_income.loc[ghg_emissions_per_household_vs_income['City']=='Chicago', 'State'] = 'IL'\nghg_emissions_per_household_vs_income.loc[ghg_emissions_per_household_vs_income['City']=='New York City', 'State'] = 'NY'\nghg_emissions_per_household_vs_income.loc[ghg_emissions_per_household_vs_income['City']=='Washington, DC', 'State'] = 'DC'\nghg_emissions_per_household_vs_income.loc[ghg_emissions_per_household_vs_income['City']=='Philadelphia', 'State'] = 'PA'\nghg_emissions_per_household_vs_income.loc[ghg_emissions_per_household_vs_income['City']=='Boston', 'State'] = 'MA'\nghg_emissions_per_household_vs_income.loc[ghg_emissions_per_household_vs_income['City']=='Minneapolis', 'State'] = 'MN'\n#ghg_emissions_per_household_vs_income.loc[ghg_emissions_per_household_vs_income['Metro Name']=='Columbus, GA\/AL', 'State'] = 'GA'\nghg_emissions_per_household_vs_income.loc[ghg_emissions_per_household_vs_income['City']=='Providence', 'State'] = 'RI'\nghg_emissions_per_household_vs_income.loc[ghg_emissions_per_household_vs_income['City']=='Louisville', 'State'] = 'KY'\nghg_emissions_per_household_vs_income.loc[ghg_emissions_per_household_vs_income['City']=='Cambridge, MA', 'State'] = 'MA'\n\n\ncost_balance_vs_household_income = pd.merge(ghg_emissions_per_household_vs_income,\n                                            solar_energy_per_month_vs_elec.drop(columns=['State']),\n                                            left_on='State',\n                                            right_on='Postal Code',\n                                            how='left'\n                                           )[['City', 'State', 'cost_balance', 'Median HHI']]\n\ncost_balance_vs_household_income['median_hhi_relative_to_us_median'] = cost_balance_vs_household_income['Median HHI']\/ 68400\ncost_balance_vs_household_income['annual_cost_balance'] = cost_balance_vs_household_income['cost_balance'] * 12\n\ndef get_P_pv(row, balance_col='annual_cost_balance'):\n    if row[balance_col] <=0: \n        return 1\n    city_household_income_distribution = us_household_income_distribution.copy()\n    city_household_income_distribution['2020'] = city_household_income_distribution['2020'] * row['median_hhi_relative_to_us_median']\n    # get the percentile of the population for which the annual cost balance is less than 5% of their income\n    can_afford = city_household_income_distribution[city_household_income_distribution['2020'].apply(lambda x: x*0.05 > row[balance_col])]\n    if len(can_afford)>0:\n        percentage_cannot_afford = can_afford.iloc[0]['Household Income Percentile'] - 1\n        return 1.0 - percentage_cannot_afford\/100 \n    return None\n\ncost_balance_vs_household_income['P_PV'] = cost_balance_vs_household_income.apply(get_P_pv, axis=1)\n\ncost_balance_vs_household_income[['City', 'P_PV']].sort_values(by='P_PV', ascending=False).set_index('City').plot.barh(figsize=(6, 15 * (len(solar_energy_per_month_vs_elec)\/40)),title=\"$P_{PV}$\")\nplt.show()","98f455d6":"tmp = pd.merge(df_all_residential_ghg_emissions_per_household,\n         us_elec_mix,\n         left_index=True,\n         right_on='City',\n         how='left')\n\nsolar_abatement = pd.merge(tmp,\n         cities_meta_df,\n         on='City',\n         how='left',\n         #indicator=True\n        )\n\nsolar_abatement = pd.merge(solar_abatement,\n                           solar_energy_per_month_vs_elec, \n                           on='State',\n                           how='left',\n                           #indicator=True\n                          )\n#solar_abatement[solar_abatement['_merge']=='left_only'][['City', 'State']]\nsolar_abatement[['City', 'Postal Code','solar_energy_kwh_per_month', 'Average Monthly Consumption (kWh)']]\nsolar_abatement['fraction of monthly consumption solarized'] = solar_abatement.apply(lambda row: min(1, row['solar_energy_kwh_per_month']\/float(row['Average Monthly Consumption (kWh)'].replace(\",\", \"\"))), axis=1)\n\n# calculate f_{PV} and V_{PV}.\n\nsolar_enablement = pd.merge(cost_balance_vs_household_income,\n                            solar_abatement,\n                            on='City',\n                           )[['City', 'Postal Code','P_PV', 'fraction of monthly consumption solarized']]\nsolar_enablement['f_PV'] = solar_enablement.apply(lambda row: row['P_PV']*row['fraction of monthly consumption solarized'], axis=1)\nsolar_enablement[['City', 'f_PV']].set_index('City').sort_values(by='f_PV').plot.barh(figsize=(6, 15 * (len(solar_energy_per_month_vs_elec)\/40)),title=\"$f_{PV}$\")\nplt.show()","dd1c64d7":"num_solar_installations = pd.read_csv(join(supp_root_dir,\"number_solar_installations.txt\"), sep='\\t', header=None, names=['State', 'num_installs'])\nnum_solar_installations['num_installs'] = num_solar_installations['num_installs'].apply(lambda x: int(x.replace(\",\", \"\")))\nnum_solar_installations.loc[num_solar_installations['State']=='Washington DC', 'State'] = 'District of Columbia'\n#num_solar_installations\nnum_households_per_state = pd.read_csv(join(supp_root_dir,\"number_households_per_state.txt\"),sep='\\t')\nnum_households_per_state['Value'] = num_households_per_state['Value'].apply(lambda x: int(x.replace(\",\", \"\")))\nsolar_installations = pd.merge(num_solar_installations,\n                               num_households_per_state,\n                               on='State',\n                               how='outer')\nsolar_installations['frac'] = solar_installations.apply(lambda row: row['num_installs'] \/ (row['Value']*0.8), axis=1)\nsolar_installations_with_state = pd.merge(solar_installations,\n                                          state_abbrev,\n                                          left_on='State',\n                                          right_on='State\/District')[['Postal Code', 'num_installs', 'Value', 'frac']]\npv_progress = pd.merge(solar_enablement,\n                       solar_installations_with_state, \n                       on='Postal Code')\n\npv_progress['pv_progress'] = pv_progress['frac'] \/ pv_progress['f_PV']\npv_progress[['City','pv_progress']].set_index('City').sort_values(by='pv_progress').plot.barh(figsize=(6, 15 * (len(solar_energy_per_month_vs_elec)\/40)),title=\"$PV_{progress}$\")\nplt.show()","37b33a2e":"solar_enablement_with_emission = pd.merge(solar_enablement,\n                                          df_all_residential_ghg_emissions_per_household.reset_index(),\n                                          on='City')\nsolar_enablement_with_emission['V_PV'] = solar_enablement_with_emission.apply(lambda row: row['f_PV']*row['indirect residential stationary'], axis=1)\n\nsolar_enablement_with_emission[['City', 'V_PV']].set_index('City').sort_values(by='V_PV').plot.barh(figsize=(6, 15 * (len(solar_energy_per_month_vs_elec)\/40)),title=\"$V_{PV}$\")\nplt.xlabel(\"Potential GHG emissions abated per household (metric tons CO2e)\")\n\n#solar_enablement_with_emission.head()\nplt.show()","a7872175":"interest_rate=0.10\/12\nmortgage_amount=9000\nn_periods = 5*12\nm_payment = npf.pmt(interest_rate, n_periods, mortgage_amount)\nm_payment","9618b578":"natural_gas_usage = pd.read_csv(join(supp_root_dir,\"natural_gas_usage.txt\"), sep='\\t')\n\nnatural_gas_usage = pd.merge(natural_gas_usage.reset_index().rename(columns={'index':'State'}),\n                             num_households_per_state,\n                             on='State',\n                             how='outer')\n\nnatural_gas_usage['2019'] = natural_gas_usage['2019'].apply(lambda x: float(x.replace(\",\", \"\")))\nnatural_gas_usage = natural_gas_usage[natural_gas_usage['State']!='U.S.']\nnatural_gas_usage['mil_cf_per_household'] = natural_gas_usage.apply(lambda row: row['2019']\/row['Value'],axis=1)\nnatural_gas_usage['kwh_per_household'] = natural_gas_usage['mil_cf_per_household'] * 292.88 * 1000\nnatural_gas_usage['kwh_per_household_per_month'] = natural_gas_usage['kwh_per_household'] \/12\n\n# dollars per mcf\ngas_price = pd.read_csv(join(supp_root_dir,\"natural_gas_price.txt\"), sep='\\t').reset_index().rename(columns={'index':'State'})[['State', '2019']]\ngas_price = gas_price[gas_price['State']!='U.S.']\ngas_price.rename(columns={'2019':'cost_dollars_per_mcf'}, inplace=True)\n\nnatural_gas_usage = pd.merge(natural_gas_usage,\n                             gas_price,\n                             on='State')\n\n# assume efficiency factor of 0.6 for natural gas water heater\nnatural_gas_usage['monthly_water_cost'] = natural_gas_usage['cost_dollars_per_mcf'] * 1.248 \/ 0.6\n\n\nnatural_gas_usage['kwh_per_household_per_month_heating'] = natural_gas_usage['kwh_per_household_per_month'] - 366\n\nnatural_gas_usage['monthly_heating_cost'] = natural_gas_usage.apply(lambda row: row['kwh_per_household_per_month_heating']*row['cost_dollars_per_mcf']\/292.88, axis=1)\n\nnatural_gas_usage['total_monthly_cost'] = natural_gas_usage['monthly_water_cost'] + natural_gas_usage['monthly_heating_cost']\n\nelectric_price = pd.read_csv(join(supp_root_dir,\"average_elec_price.txt\"), sep='\\t').rename(columns={\"Name\": \"State\"})\n# water heat is about 366 kWh (or 1,248,452 BTU or 1.248 mcf) per month.\n# assume heat pump water heater efficiency factor of 2\nelectric_price['monthly_water_cost'] = electric_price['Average retail price (cents\/kWh)'] * 366 \/ 2 \/ 100\n\n# assume gas furnace is 100% efficient (so that we use \"kwh_per_household_per_month_heating\" \n# directly).  The COP of a standard air-source heat pump is 3.0.  \n\nelectric_price = pd.merge(electric_price,\n                          natural_gas_usage[['State','kwh_per_household_per_month_heating']],\n                          on='State')\nelectric_price['monthly_heating_cost'] = electric_price.apply(lambda row: row['kwh_per_household_per_month_heating']*row['Average retail price (cents\/kWh)']\/3\/100, axis=1)\nelectric_price['total_monthly_cost'] = electric_price['monthly_water_cost'] + electric_price['monthly_heating_cost']\n\n\ncompare_heating_cost = pd.merge(electric_price[['State', 'total_monthly_cost']],\n                                natural_gas_usage[['State', 'total_monthly_cost']],\n                                on='State',\n                                suffixes=['_elec', '_gas']\n                               )\ncompare_heating_cost['hp_monthly_diff'] = compare_heating_cost['total_monthly_cost_elec'] - compare_heating_cost['total_monthly_cost_gas']\n#compare_heating_cost.head()\n\ncompare_heating_cost = pd.merge(compare_heating_cost,\n                                state_abbrev,\n                                left_on=['State'],\n                                right_on=['State\/District'])\n\ncities_compare_heating_cost = pd.merge(ghg_emissions_per_household_vs_income[['City', 'State']],\n                                       compare_heating_cost,\n                                       left_on='State',\n                                       right_on='Postal Code')\ncities_compare_heating_cost[['City', 'hp_monthly_diff']].set_index(\"City\").sort_values(by='hp_monthly_diff', ascending=False).plot.barh(figsize=(6, 15 * (len(solar_energy_per_month_vs_elec)\/40)),title=\"average monthly utility bill differnce\")\nplt.xlabel(\"Dollars\")\nplt.show()","806511b3":"cities_compare_heating_cost['hp_monthly_diff_plus_loan'] = cities_compare_heating_cost['hp_monthly_diff'] + 191\ncities_compare_heating_cost[['City', 'hp_monthly_diff_plus_loan']].set_index(\"City\").sort_values(by='hp_monthly_diff_plus_loan').plot.barh(figsize=(6, 15 * (len(solar_energy_per_month_vs_elec)\/40)),title=\"Average extra monthly charge for heat pump\")\nplt.xlabel(\"Dollars\")\nplt.legend(loc=(1.04,0))\nplt.show()","21c27f2f":"cities_compare_heating_cost['hp_annual_diff_plus_loan'] = cities_compare_heating_cost['hp_monthly_diff_plus_loan'] * 12\n# what is the fraction of the population that can afford this?\n\ncost_balance_hp = pd.merge(cities_compare_heating_cost[['City', 'State_x','hp_annual_diff_plus_loan']],\n                           cost_balance_vs_household_income[['City', 'State', 'median_hhi_relative_to_us_median']],\n                           left_on=['City', 'State_x'], right_on=['City', 'State'])\n\ncost_balance_hp['P_HP'] = cost_balance_hp.apply(lambda row: get_P_pv(row, 'hp_annual_diff_plus_loan'), axis=1)\ncost_balance_hp[['City', 'P_HP']].sort_values(by='P_HP', ascending=False).set_index('City').plot.barh(figsize=(6, 15 * (len(cost_balance_hp)\/40)),title=\"$P_{HP}$\")\nplt.gca().tick_params(labeltop=True)","172c04f9":"space_heating_proportion = pd.read_csv(join(supp_root_dir,\"space_heating_2015_recs_survey.txt\"), sep='\\t').rename(columns={'Unnamed: 0': 'index'}).set_index('index')\nspace_heating_proportion_2 = pd.read_csv(join(supp_root_dir,\"space_heating_2015_recs_survey_2.txt\"), sep='\\t').rename(columns={'Unnamed: 0': 'index'}).set_index('index')\nspace_heating_prop = pd.concat([space_heating_proportion,space_heating_proportion_2], axis=1).transpose().reset_index().rename(columns={'index':'Region'})[['Region','All homes', 'Heat pump']]\nspace_heating_prop['heat_pump_frac'] = space_heating_prop.apply(lambda row: float(row['Heat pump'])\/float(row['All homes']) if row['Heat pump']!='Q' else 0, axis=1)\n\neia_census_regions = pd.read_csv(join(supp_root_dir,\"eia_census_regions.txt\"), sep='\\t', header=None, names=['Division', 'Region', 'State'])\neia_census_regions\nspace_heating_prop = pd.merge(space_heating_prop, eia_census_regions, on='Region')\n\nspace_heating_prop = pd.merge(space_heating_prop,\n                              state_abbrev,\n                              left_on='State',\n                              right_on='State\/District')\n\nprogress_space_hp = pd.merge(cost_balance_hp,\n                             space_heating_prop,\n                             left_on=['State'],\n                             right_on=['Postal Code'])\n\nprogress_space_hp['progress_space_hp'] = progress_space_hp.apply(lambda row: row['heat_pump_frac']\/row['P_HP'], axis=1)\nprogress_space_hp[['City', 'progress_space_hp']].sort_values(by='progress_space_hp', ascending=False).set_index('City').plot.barh(figsize=(6, 15 * (len(cost_balance_hp)\/40)),title=\"$HP^{space}_{progress}$\")\n\nplt.show()","85de1757":"# V_HP\n\nhp_enablement_with_emission = pd.merge(cost_balance_hp,\n                                       df_all_residential_ghg_emissions_per_household.reset_index(),\n                                       on='City')\nhp_enablement_with_emission['V_HP'] = hp_enablement_with_emission.apply(lambda row: row['P_HP']*row['direct residential stationary'], axis=1)\nhp_enablement_with_emission[['City', 'V_HP']].set_index('City').sort_values(by='V_HP').plot.barh(figsize=(6, 15 * (len(hp_enablement_with_emission)\/40)),title=\"$V_{HP}$\")\nplt.xlabel(\"Potential GHG emissions abated per household (metric tons CO2e)\")\nplt.show()","225faf83":"import warnings\nwarnings.filterwarnings(\"ignore\", 'This pattern has match groups')\npace_mask = cities_df['Response Answer'].str.contains(r\"(\\bPACE\\b)|(Property Assessed Clean Energy)\", na=False)\ncities_df_pace = cities_df[pace_mask&(cities_df['Country']==\"United States of America\")]\n\ndef extract_pace_sentence(text):\n    doc = nlp(text)\n    pace_sentences = []\n    for sentence in doc.sents:\n        if \"property assessed clean energy\" in sentence.text.lower():\n            pace_sentences.append(sentence.text)\n        else:\n            for token in list(sentence):\n                if token.text == \"PACE\":\n                    pace_sentences.append(sentence.text)\n                    break\n    return pace_sentences\n    \ndef extract_pace_sentences(s):\n    #display(s.to_frame())\n    return [el for l in s.apply(extract_pace_sentence).to_list() for el in l]\n\ncities_df_pace_sents = cities_df_pace.groupby('Organization')['Response Answer'].apply(extract_pace_sentences)\n# these were not talking about PACE in their cities\ncities_df_pace_sents = cities_df_pace_sents[~cities_df_pace_sents.index.isin([\"City of Boulder\",\"Metropolitan Government of Nashville and Davidson County\"])]\ncities_df_pace_sents_res = cities_df_pace_sents.apply(lambda l: [el for el in l if 'residential' in el.lower()])\ncities_df_pace_sents_res[cities_df_pace_sents_res.apply(lambda l: len(l)>0)].to_frame()","4730efdb":"corps_df = pd.read_csv(os.path.join(root_dir, \"Corporations\/Corporations Responses\/Climate Change\/2020_Full_Climate_Change_Dataset.csv\"))\ncorps_info_df = pd.read_csv(os.path.join(root_dir, \"Corporations\/Corporations Disclosing\/Climate Change\/2020_Corporates_Disclosing_to_CDP_Climate_Change.csv\"))\ncorps_all_df = pd.merge(corps_df, corps_info_df, on='account_number')\n\ngreen_bond_mask = corps_all_df['response_value'].str.contains(r\"green bond\", na=False, case=False)\ncorps_green_bond_df = corps_all_df[green_bond_mask]\n\nq_num=\"C4.5a\"\nusa = corps_green_bond_df['country']=='United States of America'\nquestion = corps_green_bond_df['question_number']==q_num\ngb1 = corps_green_bond_df[usa&question]['organization_x'].value_counts()\nq_num=\"C4.2b\"\nquestion = corps_green_bond_df['question_number']==q_num\ngb2 = corps_green_bond_df[usa&question]['organization_x'].value_counts()\n","3aee0913":"pd.DataFrame(pd.concat([gb1,gb2]).index, columns=['Corporation']).sort_values(by='Corporation')","ccb56d40":"## On-road transportation GHG emissions\n\nFor completeness, we show as well the direct emissions coming from passenger transport.  Though it will not be considered in our KPIs, it is useful for understanding the full picture of residential emissions.  We first show the transport mode share of each city.","1b468fda":"### Residential stationary energy direct GHG emissions\n\nFinally, we plot the per household direct emissions from residential stationary energy for each city.","4f593fe2":"## Direct emissions\n\nDirect emissions come from activities such as the burning of natural gas for space and water heating or petroleum for transport.  This is each city's breakdown of direct emissions by sector:","797f1e36":"Clearly, private vehicle use dominates the transit mode of most residents in the US, contributing to about 50% of all transport emissions [5].","3f74baee":"# References\n\n[1] https:\/\/www.ipcc.ch\/reports\/\n\n[2] https:\/\/www.un.org\/en\/climatechange\/reports\n\n[3] \"Rewiring America\" by Saul Griffith, Sam Calisch, and Laura Fraser. https:\/\/www.rewiringamerica.org\/\n\n[4] https:\/\/theicct.org\/sites\/default\/files\/publications\/EV-cities-update-aug2020.pdf\n\n[5] https:\/\/nepis.epa.gov\/Exe\/ZyPDF.cgi?Dockey=P100ZK4P.pdf\n\n[6] About 80% of households live in a house, according to https:\/\/www.quora.com\/What-percentage-of-the-American-population-lives-apartments-and-what-percent-in-houses).\n\n[7] https:\/\/www.homeadvisor.com\/cost\/roofing\/install-a-roof\/\nObtained from US census bureau.\n\n[8] https:\/\/www.nrel.gov\/docs\/fy08osti\/42306.pdf\nPV access factors (how much roof space is available)\n27% for warm climate states and 22% for cold climate states ( say 25%)\n\n[9] https:\/\/news.energysage.com\/how-much-does-the-average-solar-panel-installation-cost-in-the-u-s\/#:~:text=Solar%20panel%20costs%20for%20an,ranges%20from%20%242.51%20to%20%243.31.\n\n[10] https:\/\/www.experian.com\/blogs\/ask-experian\/research\/personal-loan-study\/\n\n[11] https:\/\/www.seia.org\/states-map\nOnly state level. Also, these figures include solar from utilities though. Actual number of residentail installations is much lower (maybe 30% of all installations, depends on state). Should consider only residential installations.  Must refer to fact sheet for each state.\n\n[12] https:\/\/www.homeadvisor.com\/cost\/heating-and-cooling\/install-a-heat-pump\/\n\n[13] https:\/\/www.remodelingexpense.com\/costs\/cost-of-heat-pump-water-heaters\/\n\n[14] https:\/\/www.energy.gov\/energysaver\/estimating-costs-and-efficiency-storage-demand-and-heat-pump-water-heaters\n\n[15] https:\/\/www.energy.gov\/eere\/slsc\/property-assessed-clean-energy-programs\n\n[16] https:\/\/www.nga.org\/wp-content\/uploads\/2019\/10\/10.-Shades-of-Green-in-Financing.pdf","7eef2766":"# Overview\n\nTwo of the main take-aways from the multitude of climate mitigation and adaptation reports in the past several years [1,2] have been:\n1. We must get off of fossil fuels as quickly as possible to reach the IPCC target of 1.5\u00b0C global warming.\n2. We can significantly reduce our carbon footprint with the **technology we have today** and **without altering our quality of life** through the rapid switch to renewable energy sources and by electrifying nearly every aspect of our lives, including our transportation and heating needs.  \n\nOne estimate projects that the primary energy usage needs of the US will be reduced by over half if the second point above is achieved [3]. This, in turn, makes the the first point much more attainable. In this notebook, we develop a set of KPIs focusing on the US market that center around the ability for the residents of a city to make this transition. Specifically, we focus on the following questions:\n* What impact (in terms of GHG emissions reductions) can a city have in electrifying its residential electricity and heating sector given its current electricity source portfolio and heating needs? \n* To what extent is a city enabling its residents to make this transition?\n\nTo answer these questions, we attempt in this notebook to give an estimate of the following quantities:\n\n* **Residential renewable electricity affordability**: The proportion of households in a city that can reasonably afford to install solar panels.\n* **Residential heating electrification affordability**: The proportion of households in a city that can reasonably afford to switch to electric heat pumps for space and water heating.\n* **Residential renewable electricity impact**: The extent to which a city's indirect GHG emissions from electiricy use can be abated through solar PV installations. \n* **Residential heating electrification impact**: The extent to which a city's direct GHG emissions from residential heating can be abated through electrification. \n\nThe latter two indicators depend on estimates for the former two indicators. Based on these indicators, we consider two KPIs that aim to measure the market penetration of solar panels and heat pumps relative to the affordability of these technologies.\n\nA corresponding set of metrics focusing on electric vehicle enablement was also considered. This however requires a more careful modeling of household car finances in the US as well as more comprehensive accounting of existing federal\/state\/municipal\/utility-level incentives that is beyond the scope of this notebook.  We defer to the highly in-depth city-level EV adoption study by Bui et. al [4] for more details and inspiration.\n\nFinally, we must note that there are many assumptions and approximations that will feed into the estimates of the quantities (and therefore the KPIs) described above. We believe that, though the estimates may be a good starting point for framing the discussion around the state of household electrification in the US, there is much that will need to be refined for these to more accurately and comprehensively represent a city's electrification impact and progress. We discuss some of these uncertainties at the end. ","326c884a":"![Screen%20Shot%202020-12-01%20at%209.21.58%20PM.jpg](attachment:Screen%20Shot%202020-12-01%20at%209.21.58%20PM.jpg)\nUS energy Sankey diagram from http:\/\/www.departmentof.energy\/.","7ac79b65":"# The enablement of household electrification in the US","ac5fd07c":"# GHG emissions\n\nWe next consider the GHG emissions reported by eacy city.","092298b3":"## All residential stationary and transport emissions","17f8ecc5":"We can see that much of the west coast and New England areas have a high renewable source electricity portfolio. The electricity source mix is a factor in the determination of the residential renewable enablement metrics. ","39434f17":"# Electricity Source Mix","73fd98c4":"There is significant opportunity for cities across the US to implement and promote such programs for the residential sector.","0d4ad32b":"Then we add to this difference the cost of financing the heat pump and, as before, we compute the fraction of the population that can afford this change.","3ae62535":"These cities that are in the top 10 of both graphs.","e2fb09c1":"## Indirect emissions\n\nIndirect emissions come almost entirely from the stationary energy sector.  The breakdown among sub-sectors is similarly dominated by residential and commercial sub-sectors.","ec9e67b7":"In contrast to solar PV installations, the measure $P_{HP}$ of the affordability of electric heat pumps is on average significantly lower than 1 and varies substantially from one city to the next.  This indicates the need for cities to offer additional incentives (or lower-interest financial loans) to making heat pumps more cost-effective for their residents. \n\nWe can compare this proportion to the actual proportion of households that use a heat pump:\n\\begin{equation*}\nHP_{progress} = \\frac{f_{installed}}{P_{HP}}\n\\end{equation*}\n\nFor this, we use the region-level numbers of space-heating heat pumps from the Residential Energy Consumption Survey.","c5dc9d4b":"Thus, in terms of emissions, Park City, Highland Park City, and Las Vegas have the highest potential in indirect emissions reductions per household via solar PV installations.  ","3b673e2a":"Per capita, we get the following picture:","d9e5d9c8":"For nearly all cities for which we have consistent and complete reporting, we can see that stationary energy and transport makes up nearly all of the GHG emissions.  As we are focused on the stationary sector in our metrics, we take a look at the subsector breakdown.  ","f75792de":"Finally, we show the per city breakdown of emissions by each residential sub-sector.","025659fa":"## Renewable electricity enablement\n\nLet $E_{indirect}$ be the annual indirect stationary emissions per household (i.e. from fossil-fuel-based electricity).  We want to estimate the average annual emissions abated by a solar PV installation, $E_{PV}$. We begin by assuming the average roof size in US of 1700 square feet [7].  On average, about 25% of a household rooftop is available for solar panel installation [8]. This includes considerations such as the amount of shading, roof tilt, and orientation. So that's 425 square feet available per house. The power density of mass-produced solar panel is about $150~W\/m^2$ or $13.9~W\/ f^2$. So in total that's about $6~KW$ per house.\n\nThe average cost of solar installation is about \\\\$3 per watt in the US [9]. To maximize the potential $6~KW$ of solar power would therefore cost about **\\\\$18K** per house for solar PV installation. What percentage of households can afford this upgrade? Assuming a personal loan of \\\\$18K with a loan term of 5 years at an average interest rate of 10% results in a monthly payment amount of \\\\$380 (code below) [10]. \n\nFirst we see how this amount compares with the average residential monthly electricity bill.  We factor into this calculation the average annual peak hours of sunshine per state. ","39e528fb":"In many cities, rooftop solar installations are both cost effective to the majority of residents and will completely offset the city's indirect emissions. \n\nFinally, we estimate the progress of a city's residential renewable electricity transition as:\n\\begin{equation*}\nPV_{progress} = \\frac{f_{installed}}{f_{PV}} ,\n\\end{equation*}\nwhere $f_{installed}$ is the fraction of households that have a PV installation [11].  We use $f_{PV}$ instead of $P_{PV}$ as the baseline, since the factor $K_{PV}$ acts as a discounting factor (the less solar PV can cover the electricity consumption, the less useful it is to a resident).","6cba02c3":"So areas such as Miami Beach and Louisville have high heat pump penetration, whereas most other places are well below their ideal market penetration based on affordability.\n\nFinally, the possible energy reduction per household is then $V_{HP} = P_{HP}\\cdot E_{direct}$:","af957d7d":"We start by considering the electricity source mix of each city.","fa5e7311":"As expected, the per household indirect emissions is largest where electricity source is mostly fossil-fuel based. Conversely, cities on the west coast have the lowest per household indirect emissions.","2e7eb260":"## The role of corporations\n\nThe private sector can play a driving role in the success of a municipality's large-scale residential and commercial efficiency upgrade goals. For example, corporations and private lenders are a key source of funding for PACE programs. In return, the issued bonds offer a long-term, low-risk source of income to the lenders. The growing availability of green bonds [16], as well as the nascent PACE securitization market, may help to spur this development.\n\nFrom the corporations dataset, we can get a sense of companies involved with green bonds:","18446da4":"We can view the percentage of electricity from renewable sources on a map of the US.","915e0a10":"Californian cities lead the way, but overall the progress is still at the percent level. More needs to be done to incentivize and educate, particularly if the net cost to the household is zero or better.\n\nFinally, we look at the potential energy reduction per household $V_{PV}$:","524a5ef3":"# Financing a carbon-neutral future\n\nWhat financial aid is available within a municipality to offset the high upfront costs of adding solar PV panels and replacing gas furnaces with electric heat pumps?  While rebates can help to offset some of the upfront cost, many households (particularly low-income households) will be forced to take a loan.\n\nIn the above analysis, we assumed that households would take a personal loan to finance their installations.  Such loans, however, often come with a relatively high interest rate, which, as we've seen above, can more than offset any potential savings from the efficiency upgrades. One of the most promising alternative forms of financing is the Property Assessed Clean Energy (PACE) loan [15]. The typical interest rate of a PACE loan is similar to that of a mortgage and the loan is spread over an equally long time frame (~20 years). Payments are made through the property tax bill the loan is tied to the property, rather than the owner, upon sale of the property. \n\nUnfortunately, from the city responses, there are currently only 4 cities that offer residential PACE programs:","00e03f40":"The idea is that when a city's emissions is dominated by the orange component, the most impactful change comes from the switch to renewable sources of electricty. If the emissions is dominated by the green component, the electrification of heating becomes the most pressing need.  Finally, if blue dominates, the electrification of transportation is the most urgent change required.","cb4c56fc":"## Heating electrification enablement\n\nLet $E_{direct}$ be the annual direct emissions per household (i.e. predominantly from space and water heating). We want to know the fraction $P_{HP}$ of households that can afford to switch to electric heat pumps for space and water heating. Again, we use an estimate of the city's household income distribution together with the average cost of an electric heat pump to estimate this quantity.  \n\nThe cost of an electric heat pump is about \\\\$6000 [12], while a heat pump water heater costs \\\\$3000 on average [13], for a total of **\\\\$9K** per household.  For a 5-year personal loan at 10% interest rate, that amounts to \\\\$191 per month.\n\nWhat is the difference between the average gas bill and the electricity cost of the heat pumps?  To compute this, we assume the following efficiency factors:\n\n|Device|Eficiency factor|\n|--|--|\n|Natural gas furnace | 1 |\n|Electric heat pump | 3 |\n|Natural gas water heater | 0.6 | \n|Heat Pump water heater | 2 |\n\nFor hot water, we assume a daily usage of 12 kWh or 41045 BTU daily household hot water usage [14], while average total gas usage, gas price, and electricity price per state is obtained from the EIA website.","4464d018":"How much emissions $V_{PV}$ would be abated? For a household that installs solar panels, the emissions abatement $E_{PV}$ will then be $E_{indirect}\\cdot K_{PV}$, where $K_{PV}$ is the proportion of monthly electricity consumption that can be coverd by rooftop solar PVs (with a maximum value of 1). Thus, the possible energy reduction per household is $V_{PV}= P_{PV}\\cdot E_{PV} =P_{PV}\\cdot K_{PV}\\cdot E_{indirect}$. A low $V_{PV}$ means that either that most of the population cannot afford the extra cost of solar PV installation, that solar cannot sufficiently cover the monthly electricity consumption of an average household, or simply that much of the electricity mix is already from renewable sources. \n\nThe factor $f_{PV} = P_{PV}\\cdot K_{PV}$ measures the extent to which a city's residential indirect emissions can be reduced through rooftop solar. ","8cd67fb4":"So now we calculate the fraction $P_{PV}$ of households that can afford such a change in electric bill. We say a household can \"afford\" to foot the difference if it is less than 5% of the monthly household income. If the difference is _negative_ (as is the case for the top states in that plot above), then we assume that all households can undergo solar PV installations ($P_{PV}=1$).","f0126f82":"### Residential stationary energy indirect GHG emissions","86628dbf":"# Conclusion and Areas of improvement\n\nIn this notebook, we explored several metrics aimed at measuring the ability of households within a city to switch to a renewable source of electricity and to electrify their heating needs. Ultimately, we were interested in knowing the impact that such a transition would have on the city's emissions and measuring how far along a city was in attaining this potential.  \n\nThroughout the process, many simplifying assumptions were made.  Several potential improvements include:\n* Better modeling of household income distribution per locality\n* City-specific installation cost offsets (e.g. rebates and other incentives)\n* Better definition of affordability\n\nIn addition, we should also take into account the proportion of households that do not live in houses. Finally, many cities failed to report their electricity source mix and GHG emissions, or presented some inconsistencies in their accounting of all the sources of emissions.  Improving the coverage and quality of the data will help to build a more comprehensive comparison of cities.","5956d5c8":"# Residential enablement metrics\n\nIn the metrics developed below, we focus on the fraction of households that reside in houses [6]. These households have more direct control over their heating mechanism and electricity source.","a4660bf3":"We illustrate the calculation of $P_{PV}$ with Chicago as an example.\n\nThe median annual income in Chicago is \\\\$40,750, while the federal median annual household income is \\\\$68,400. That is a factor of 0.6, which we use to shift the emperical US income distribution to estimate the income distribution for Chicago. Thus, with the cost balance in Illinois being +\\\\$8.76 per month, the percentage of the population for which the annual cost balance of \\\\$8.76*12=\\\\$105 is less than 5% of the household annual income (\\\\$2,100 a year) starts at the 3rd percentile. So 2% of the population cannot afford this change, or, in other words, $P_{PV} = 0.98$."}}