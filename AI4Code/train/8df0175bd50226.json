{"cell_type":{"177fea52":"code","5055f16d":"code","96564197":"code","b8024d2a":"code","745f7bd0":"code","14b7119b":"code","db3073ee":"code","e5e6bce4":"code","f9ebe76d":"code","382b7a51":"code","8ee8af31":"code","7874ef08":"code","0ca99827":"code","57e0609a":"code","1c252f37":"code","7f9cf481":"code","69996ef3":"code","76015f95":"code","4bcd53e2":"code","b9c3066f":"code","b932fdb7":"markdown","b2c6a6a5":"markdown","8ed093de":"markdown","b221e942":"markdown","370b297c":"markdown","c6321e61":"markdown","dd07d6e8":"markdown","2350d04e":"markdown","8e2cdc0e":"markdown","b7460f85":"markdown","3005cac7":"markdown","a0a9c5d2":"markdown","a01e7b39":"markdown","7162a5aa":"markdown","0278dc79":"markdown","d2d826a7":"markdown"},"source":{"177fea52":"import numpy as np\nimport pandas as pd\nimport os\nimport matplotlib.pyplot as plt\nimport glob\n%matplotlib inline\nfrom fastai.vision.all import *\nfrom fastai import *\n\nset_seed(42) #Set random seed to a constant so tests are reproducible\n","5055f16d":"path = Path('..\/input\/cassava-leaf-disease-classification')\npath.ls()","96564197":"train_df = pd.read_csv(path\/'train.csv')\ntrain_df.head()","b8024d2a":"train_df['image_id'] = 'train_images\/' + train_df['image_id']\ntrain_df.head()","745f7bd0":"import json\nwith open(path\/'label_num_to_disease_map.json') as json_file:\n    data = json.load(json_file)\n    print(data)","14b7119b":"labels_dic = {0: 'Bacterial Blight',\n1: 'Brown Streak Disease',\n2: 'Green Mottle',\n3: 'Mosaic Disease',\n4: 'Healthy'\n}\ntrain_df['qual_label'] = train_df['label'].map(labels_dic)\ntrain_df.head()","db3073ee":"def get_x(row):\n    return path\/row['image_id']\n\ndef get_y(row):\n    return row['label']","e5e6bce4":"CassavaBlock = DataBlock(\n    blocks = (ImageBlock, CategoryBlock), \n    splitter = RandomSplitter(valid_pct=0.2, seed=42),\n    get_x = get_x,\n    get_y = get_y,\n    item_tfms = Resize(448),\n    batch_tfms = [RandomResizedCropGPU(224), *aug_transforms(), Normalize.from_stats(*imagenet_stats)] #Data augmentation\n)","f9ebe76d":"dls = CassavaBlock.dataloaders(train_df, batch_size=64)\ndls.valid.show_batch(max_n=4, nrows=1)","382b7a51":"if not os.path.exists('\/root\/.cache\/torch\/hub\/checkpoints\/'):\n        os.makedirs('\/root\/.cache\/torch\/hub\/checkpoints\/')\n!cp '..\/input\/resnet50\/resnet50.pth' '\/root\/.cache\/torch\/hub\/checkpoints\/resnet50-19c8e357.pth'","8ee8af31":"learn = cnn_learner(dls, resnet50, metrics=accuracy, loss_func = LabelSmoothingCrossEntropy(), opt_func = ranger)\nlearn.fine_tune(10)","7874ef08":"interp = ClassificationInterpretation.from_learner(learn)\ninterp.plot_confusion_matrix()","0ca99827":"interp.plot_top_losses(5, nrows=5)","57e0609a":"sample_df = pd.read_csv(path\/'sample_submission.csv') #Read csv\nsample_df_copy = sample_df.copy() #Make copy so that when uploading original, image ids are unchanged.\nsample_df_copy.head()","1c252f37":"sample_df_copy['image_id'] = 'test_images\/' + sample_df_copy['image_id'] #Add path to image ids","7f9cf481":"test_dl = dls.test_dl(sample_df_copy) #Data loader\ntest_dl.show_batch()","69996ef3":"preds = learn.tta(dl=test_dl, n=8, beta=0) #Predictions for each class (probability)","76015f95":"sample_df['label'] = np.argmax(preds[0], axis=1) #Add prediction to original dataframe - maximum probability","4bcd53e2":"sample_df.head()","b9c3066f":"sample_df.to_csv('submission.csv', index=False) #Dataframe to csv","b932fdb7":"Plot confusion matrix.","b2c6a6a5":"Create the model and fine tune to our data, with 7 epochs.","8ed093de":"### Datablock","b221e942":"### Set paths","370b297c":"Show worst 5 images in terms of loss - i.e. the images which the model is not predicting well on.","c6321e61":"### Add 'train_images\/' to image_id column to easily access directory","dd07d6e8":"Functions to obtain x and y - image paths and labels.","2350d04e":"The compeition does not allow internet access. Normally FastAI can obtain weights for ResNet-50 from the Internet, but now it must be done offline. Obtain weights from Kaggle dataset then copy the file over to the directory at which FastAI will expect it.","8e2cdc0e":"Data loaders. Show 4 images.","b7460f85":"### Read training data csv","3005cac7":"### Predictions","a0a9c5d2":"Create data block with validation set of 20%, transforming each item to 448x448px and then randomly cropping batches to 224x224px. Other data augmentation also applied to batches, which should improve the accuracy.","a01e7b39":"### Add qualitative labels","7162a5aa":"From the above, the predictor is confusing Mosaic Disease with other diseases, namely Brown Steak Disease and Green Mottle. An expert in Cassava plants, and plants in general, would be able to provide insight into this - further reading required.","0278dc79":"### Training","d2d826a7":"### Imports"}}