{"cell_type":{"3cfa7cb5":"code","aef6f552":"code","86e97a2d":"code","380eb912":"code","4a7eab01":"code","13296680":"code","b566c936":"code","4b5da4c3":"code","029c983b":"code","9fdff2d5":"code","d4d304b6":"code","5ef1bb63":"code","32889a58":"code","947928c3":"code","55b65b9c":"code","edcc6e96":"code","07bcbb51":"code","9691320d":"code","da55f73c":"code","63c83ed4":"code","72111dd9":"code","0c1aa21a":"code","be9e2887":"code","a80aa61d":"code","07b0265c":"code","02ef8cc9":"code","c8c3e574":"code","b8cf3926":"code","86414d2f":"code","93526276":"code","34fed6b9":"code","7ce635d3":"code","ff577610":"code","76a3ffea":"code","8282535b":"code","b9220bea":"code","f68845d5":"code","4f4d2642":"code","60360b8b":"code","2c683999":"code","5a41d744":"code","cda1d09b":"code","d9c70e2f":"code","02ee9100":"code","74f8e66d":"code","a03642ee":"code","d5b22850":"code","5802b825":"code","3c56e57f":"markdown","becf5b48":"markdown","e3f0b324":"markdown","3a42af41":"markdown","bac19cd1":"markdown","cb906e37":"markdown","eb3fc916":"markdown","48dda7c4":"markdown","72fd5e80":"markdown","0dca86ba":"markdown","7b6dc9e0":"markdown","4d89777d":"markdown","30c4efee":"markdown"},"source":{"3cfa7cb5":"!pip install --upgrade seaborn","aef6f552":"import numpy as np, pandas as pd\nfrom glob import glob\nimport shutil, os\nimport matplotlib.pyplot as plt\nfrom sklearn.model_selection import GroupKFold\nfrom tqdm.notebook import tqdm\nimport seaborn as sns","86e97a2d":"# fold = 0","380eb912":"train_df = pd.read_csv(f'..\/input\/siim-covid19-detection\/train_image_level.csv')\ntrain_df.head()","4a7eab01":"train_df.id = train_df.id.str[:-6]\ntrain_df.head()","13296680":"duplicates = ['11f46d9df786',\n 'ba57c39bc15d',\n 'bd4b6cfeddee',\n '82c84d5079b7',\n 'a27a126be5c1',\n '3d12cb6aad8b',\n 'b814a1e29517',\n '09236f094647',\n '36b995a9575c',\n '9cdc2af4fbb0',\n '779f0040d1b2',\n 'ef6e312ca719',\n 'b97c6b32105e',\n '93301812b0e7',\n '4c414b793562',\n 'e6cc65d9de1d',\n '9fcbe25a88e0',\n 'f228350bd770',\n '59bd5a00b33e',\n 'fa5e3f933004',\n 'a8e019dcf085',\n 'd205dc170ccc',\n 'a5a364383f34',\n '9939f63af4ff',\n '646a6a0a9bf2',\n '581fd56bc4bf',\n '629c9a257b43',\n '2ebe16a053fe',\n '173c23887f9b',\n 'ea2117b53323',\n '57bf106a9e2e',\n 'b989acc3c046',\n '12fe8eadded1',\n '7f9c98b88aec',\n 'c00c7e8b673c',\n 'a5bbd30ed109',\n 'b622f84403da',\n 'ba375ad92c5f',\n 'b0fd33e251f5',\n 'c6e92e59a0ae',\n 'ef690fe6f288',\n '6970c59656c9',\n 'ab55abb953d1',\n 'd540d6c2a425',\n '262dc03560d6',\n 'fc44ab5de22c',\n 'ce51b397b1a6',\n '6e9fad584bff',\n 'a2429a60f3ea',\n 'b0866caa201a',\n '7e4a4ef3ff9f',\n '3577ee4f26c4',\n '6f54e9cbd180',\n '57faddfc733e',\n '6a93346150a4',\n '611348a721f7',\n 'c4b2940d2334',\n 'e007bc90c441',\n '3cde0ddf01c7',\n '296aaf716ae0',\n 'b7eb26ddf5a3',\n 'e738c549fe8e',\n '39d52f244db3',\n 'a9704ce54780',\n '1701be774ecb',\n '221ff464c9fc',\n 'e3f8e3a3baa3',\n 'be65d1a22de5',\n '103bd9ed3929',\n '9108cdfd43dc',\n '3d2224cb6bb7',\n 'c4b68b29a072',\n '6d36ffbc7864',\n '35da4a5a0201',\n '341787fb81c7',\n '6ff218d10741',\n '68fcf433c6fe',\n '25400558ba1e',\n '149356f04849',\n '39cd89772e5e',\n '99f3642f50f5',\n 'c72e26e9ecae',\n '4b310bbd3cb1',\n 'f208dc529d16',\n '4024e564722b',\n 'cc708f2aaffe',\n 'dcb374d8387e',\n '7f1924880cf8',\n '961f9c368664',\n '1ea01196514a',\n '725328925e0f',\n '35ea2c9841c0',\n '72e5fbd61953',\n '75b52bec817f',\n 'd27bca58e388',\n '44d7b2e7b0f9',\n '830063223a31',\n '0b020a7aff0a',\n '9d8ccbfb99b7',\n '082d3af6ecc0',\n 'eef757610245',\n 'b77430575510',\n '321c93d6503f',\n '0a990c89256a',\n 'c9a028b48504',\n 'c636ac67c19a',\n '76c66ee8e58d',\n 'cdd9e3aaf45a',\n '9a9d89ca4aa0',\n '8b55ea197c78',\n '30b18db28900',\n 'a57bf6dd6119',\n 'e4a78ff8fa73',\n 'e01d23a04187',\n '66dabc6f972d',\n '4cebe94f1fa3',\n '6792b9b0329d',\n 'ddff141123c1',\n '550f057ee0b0',\n '0102b5cac730',\n 'e7e072c73e1d',\n '00e3a7e91a34',\n '8cbf85033da8',\n '6f749e2783e1',\n '4b2f144a1a8b',\n '783b1efb5675',\n 'e96133d06736',\n '869476b0763a',\n 'e496735126c2',\n '00c1515729a8',\n '9a335ce0bca4',\n '9b1de1c45491',\n 'd9456aadecbe',\n '51d04316f2c9',\n 'fb1e24bf6698',\n 'b3ffe59e37c7',\n '16bd0ff2f0cd',\n '8d4b3609ed92',\n 'a174a4f6c807',\n '2a7a456d367e',\n '1b92142f4362',\n 'bfefe70b56ca',\n 'e5fc2fa92e65',\n '8a38c00672d5',\n 'a94171e98807',\n '61d0f2ca0ddd',\n '0bd6cd815ba9',\n '1de0ad5314cc',\n 'e897ef5c203c',\n '0acec7010081',\n '3b6ad60071d4',\n 'b61f3493c551',\n '267a250932bc',\n 'a8013eaf16c1',\n 'e704aebd4ca5',\n '04cc2f7f4c4b',\n '3e7b2ffc97db',\n 'e0e1e1462e56',\n 'b5aa6189d142',\n 'cbf0a27f993e',\n 'ea2688741043',\n '2204baf77803',\n '56ff7c4e1f41',\n '156cb1f5c689',\n '05c063f5cef5',\n 'c3a09e8a600d',\n 'f577c6fb0f49',\n '8093df07a5d0',\n '6728e11290af',\n 'efc93a3917b6',\n 'c843d08b49b8',\n '717ea5155b46',\n '343d445230a1',\n '50f29acd37a6',\n 'ea516e218fe6',\n '582c442e440b',\n 'f9a92f1ba934',\n 'bdd3115879aa',\n '68ad4b624a6d',\n 'a323f1604ae2',\n 'bb52c80c7f45',\n '0b858129adb4',\n '26c6c25e9467',\n '91f72df96e13',\n '19c6397cdec9',\n '6861c5992717',\n 'deea6d6f81a5',\n '106632672b95',\n '6534a837497d',\n '684230477525',\n 'df3d32c8df06',\n '3f0879b045e7',\n '505693d77a18',\n 'a39667fe9a81',\n '2c130ee08736',\n 'c9a9e5e120bd',\n 'bb36f3d3ac71',\n '1c96d9b08487',\n 'daa9bddc5fe6',\n 'e73f2cc047ad',\n 'e60a47d36e62',\n '6366191bfe49',\n 'd180fed57716',\n '866e3622cb24',\n '55839276a9c9',\n 'fa3a7fe547ca',\n '59bc532be971',\n '424118f1afc8',\n '6ddf030ec946',\n '3d0bac303fc8',\n 'f689d30c2f86',\n '8c7bdccb65ed',\n 'df4f1240317e',\n '25ff5d625b35',\n '75f207c4945d',\n '35e398a5a431',\n '5d395fff6278',\n 'e3e2f20e0264',\n '99e8636292c9',\n 'de94a43e947f',\n 'a5beac3d9fb4',\n 'd19ed8d811ad',\n 'bf2417586cf2',\n '72cf260ddf4c',\n 'f5451a98d684',\n 'aad814e52627',\n '32222cc776a2',\n '608d574388ba',\n '9872a8a48f23',\n 'f7f759f7a4f1',\n '88e7702b49c4',\n 'dfd9078a4c6d',\n 'd4131bd4e64a',\n '1a0e966f2d57',\n '9f50edab452b',\n '4cf41c062d0c',\n '13bf9d719ad1',\n '0eb641cb0dcd',\n 'a2ee4b862182',\n '61e618dc7f9a',\n '467f412db5c4',\n '990216aa9f08',\n '3d047361508c',\n '08acae0bf785',\n '0dd32589bdc3',\n '9f180629878a',\n '6e5946091b8a',\n 'f3ce7a4cfd20',\n 'f85fe770048a',\n 'cf0cdff4ef2e',\n 'df2bb22fa871',\n '0d4d6acc9ed3',\n '45ff2dfff073',\n 'd54f6204b044',\n 'eea3a910fa9e',\n '3d19da0d4ee6',\n 'c3510a436bff',\n '4cbc17936e7d',\n 'b121806162c3',\n 'e5380eb2d925',\n '2f973757eaa4',\n 'b5a415f70aa9',\n 'cc69791740bb',\n 'a1fa5f79671d',\n 'dbc311ed04b5',\n '744427c7dff8',\n '49664f078f0e',\n 'bee62c601ae9',\n 'e441b1fb74ee',\n '8df453b7557c',\n '7626c521cad7',\n '33a72bfb5ddb',\n '56ed68c28819',\n '04a0b90d7875',\n '08932dca1447',\n 'daae293a8b40',\n 'c0400d0e413d',\n 'ddb051c1233b',\n 'f13f9ace0a9a',\n '9c0633ef606b']","b566c936":"len(duplicates)","4b5da4c3":"all_files = list(train_df.id.values)","029c983b":"for i in duplicates:\n    all_files.remove(i)","9fdff2d5":"len(all_files)","d4d304b6":"final_df = pd.DataFrame({'id':all_files})","5ef1bb63":"final_df","32889a58":"train_df = pd.merge(final_df, train_df, how='left', on='id')","947928c3":"len(train_df)","55b65b9c":"train_df.head()","edcc6e96":"study_df = pd.read_csv('..\/input\/siim-covid19-detection\/train_study_level.csv'); print(study_df.shape)\nstudy_df['StudyInstanceUID'] = study_df['id'].apply(lambda x: x.replace('_study', ''))\ndel study_df['id']","07bcbb51":"def hot_to_sparse(row):\n    return(row.index[row.apply(lambda x: x==1)][0])\nstudy_df['diagnosis'] = study_df.apply(lambda row:hot_to_sparse(row), axis=1)\ncls = {\n    'Typical Appearance':1,                    \n    'Negative for Pneumonia':0,                \n    'Indeterminate Appearance':2,                     \n    'Atypical Appearance':3,    \n}\nstudy_df['sparse_gt'] = study_df.diagnosis.map(cls)","9691320d":"study_df.head()","da55f73c":"train = train_df.merge(study_df, on='StudyInstanceUID')\ntrain['id'] = train['id'].apply(lambda x: x.replace('_image', ''))","63c83ed4":"train.head()","72111dd9":"train.shape","0c1aa21a":"train = train.reset_index(drop=True)","be9e2887":"train.head()","a80aa61d":"# from sklearn.model_selection import StratifiedKFold\n\n# skf = StratifiedKFold(n_splits=5, shuffle=True, random_state=9)\n# for index, (train_index, val_index) in enumerate(skf.split(X=train.index, y=train.sparse_gt)):\n#     train.loc[val_index, 'fold'] = index\n    \n# print(train.groupby(['fold', train.sparse_gt]).size())","07b0265c":"train_df = train","02ef8cc9":"!ls '..\/input'","c8c3e574":"train_df['image_path'] = f'\/kaggle\/input\/covid19-detection-890pxpng-study\/train\/' + train_df.id + '.png'\ntrain_df.head()","b8cf3926":"classes = ['0. opacity']","86414d2f":"from sklearn.model_selection import train_test_split\nX_train, X_valid = train_test_split(train_df, test_size=0.1, stratify=train_df['sparse_gt'], random_state=9)","93526276":"X_train.head()","34fed6b9":"X_train.sparse_gt.value_counts(), X_train.shape","7ce635d3":"X_valid.sparse_gt.value_counts(), X_valid.shape","ff577610":"train_files = []\nval_files   = []\ntrain_files += list(X_train.image_path.unique())\nval_files += list(X_valid.image_path.unique())\nlen(train_files), len(val_files)","76a3ffea":"os.makedirs('\/kaggle\/working\/siim-cov19\/labels\/train', exist_ok = True)\nos.makedirs('\/kaggle\/working\/siim-cov19\/labels\/val', exist_ok = True)\nos.makedirs('\/kaggle\/working\/siim-cov19\/images\/train', exist_ok = True)\nos.makedirs('\/kaggle\/working\/siim-cov19\/images\/val', exist_ok = True)\nlabel_dir = '\/kaggle\/input\/siim-covid-19-yolo-txt'\nfor file in tqdm(train_files):\n    shutil.copy(file, '\/kaggle\/working\/siim-cov19\/images\/train')\n    filename = file.split('\/')[-1].split('.')[0]\n    shutil.copy(os.path.join(label_dir, filename+'.txt'), '\/kaggle\/working\/siim-cov19\/labels\/train')\n    \nfor file in tqdm(val_files):\n    shutil.copy(file, '\/kaggle\/working\/siim-cov19\/images\/val')\n    filename = file.split('\/')[-1].split('.')[0]\n    shutil.copy(os.path.join(label_dir, filename+'.txt'), '\/kaggle\/working\/siim-cov19\/labels\/val')","8282535b":"classes = ['0. opacity']","b9220bea":"from os import listdir\nfrom os.path import isfile, join\nimport yaml\n\ncwd = '\/kaggle\/working\/'\n\nwith open(join( cwd , 'train.txt'), 'w') as f:\n    for path in glob('\/kaggle\/working\/siim-cov19\/images\/train\/*'):\n        f.write(path+'\\n')\n            \nwith open(join( cwd , 'val.txt'), 'w') as f:\n    for path in glob('\/kaggle\/working\/siim-cov19\/images\/val\/*'):\n        f.write(path+'\\n')\n\ndata = dict(\n    train =  join( cwd , 'train.txt') ,\n    val   =  join( cwd , 'val.txt' ),\n    nc    = 1,\n    names = classes\n    )\n\nwith open(join( cwd , 'siim-cov19.yaml'), 'w') as outfile:\n    yaml.dump(data, outfile, default_flow_style=False)\n\nf = open(join( cwd , 'siim-cov19.yaml'), 'r')\nprint('\\nyaml:')\nprint(f.read())","f68845d5":"!ls '..\/input'","4f4d2642":"# https:\/\/www.kaggle.com\/ultralytics\/yolov5\n# !git clone https:\/\/github.com\/ultralytics\/yolov5  # clone repo\n# %cd yolov5\nshutil.copytree('\/kaggle\/input\/yolov5-official-v31-dataset\/yolov5', '\/kaggle\/working\/yolov5')\nos.chdir('\/kaggle\/working\/yolov5')\n# %pip install -qr requirements.txt # install dependencies\n\nimport torch\nfrom IPython.display import Image, clear_output  # to display images\n\nclear_output()\nprint('Setup complete. Using torch %s %s' % (torch.__version__, torch.cuda.get_device_properties(0) if torch.cuda.is_available() else 'CPU'))","60360b8b":"# !WANDB_MODE=\"dryrun\" python train.py --img 640 --batch 16 --epochs 3 --data coco128.yaml --weights yolov5s.pt --nosave --cache\n!WANDB_MODE=\"dryrun\" python train.py --img 640 --batch 32 --epochs 50 --data \/kaggle\/working\/siim-cov19.yaml --hyp \/kaggle\/input\/yolov5-1-yaml\/hyp.scratch.yaml --weights yolov5m.pt --cache","2c683999":"# plt.figure(figsize = (20,20))\n# plt.axis('off')\n# plt.imshow(plt.imread('runs\/train\/exp\/labels_correlogram.jpg'));","5a41d744":"plt.figure(figsize = (20,20))\nplt.axis('off')\nplt.imshow(plt.imread('runs\/train\/exp\/labels.jpg'));","cda1d09b":"import matplotlib.pyplot as plt\nplt.figure(figsize = (15, 15))\nplt.imshow(plt.imread('runs\/train\/exp\/train_batch0.jpg'))\n\nplt.figure(figsize = (15, 15))\nplt.imshow(plt.imread('runs\/train\/exp\/train_batch1.jpg'))\n\nplt.figure(figsize = (15, 15))\nplt.imshow(plt.imread('runs\/train\/exp\/train_batch2.jpg'))","d9c70e2f":"fig, ax = plt.subplots(3, 2, figsize = (2*5,3*5), constrained_layout = True)\nfor row in range(3):\n    ax[row][0].imshow(plt.imread(f'runs\/train\/exp\/test_batch{row}_labels.jpg'))\n    ax[row][0].set_xticks([])\n    ax[row][0].set_yticks([])\n    ax[row][0].set_title(f'runs\/train\/exp\/test_batch{row}_labels.jpg', fontsize = 12)\n    \n    ax[row][1].imshow(plt.imread(f'runs\/train\/exp\/test_batch{row}_pred.jpg'))\n    ax[row][1].set_xticks([])\n    ax[row][1].set_yticks([])\n    ax[row][1].set_title(f'runs\/train\/exp\/test_batch{row}_pred.jpg', fontsize = 12)","02ee9100":"plt.figure(figsize=(30,15))\nplt.axis('off')\nplt.imshow(plt.imread('runs\/train\/exp\/results.png'));","74f8e66d":"plt.figure(figsize=(30,15))\nplt.axis('off')\nplt.imshow(plt.imread('runs\/train\/exp\/confusion_matrix.png'));","a03642ee":"!python detect.py --weights 'runs\/train\/exp\/weights\/best.pt'\\\n--img 512\\\n--conf 0.1\\\n--iou 0.5\\\n--source \/kaggle\/working\/siim-cov19\/images\/val\\\n--exist-ok","d5b22850":"import matplotlib.pyplot as plt\nfrom mpl_toolkits.axes_grid1 import ImageGrid\nimport numpy as np\nimport random\nimport cv2\nfrom glob import glob\nfrom tqdm import tqdm\n\nfiles = glob('runs\/detect\/exp\/*')\nfor _ in range(3):\n    row = 4\n    col = 4\n    grid_files = random.sample(files, row*col)\n    images     = []\n    for image_path in tqdm(grid_files):\n        img          = cv2.cvtColor(cv2.imread(image_path), cv2.COLOR_BGR2RGB)\n        images.append(img)\n\n    fig = plt.figure(figsize=(col*5, row*5))\n    grid = ImageGrid(fig, 111,  # similar to subplot(111)\n                     nrows_ncols=(col, row),  # creates 2x2 grid of axes\n                     axes_pad=0.05,  # pad between axes in inch.\n                     )\n\n    for ax, im in zip(grid, images):\n        # Iterating over the grid returns the Axes.\n        ax.imshow(im)\n        ax.set_xticks([])\n        ax.set_yticks([])\n    plt.show()","5802b825":"shutil.rmtree('\/kaggle\/working\/siim-cov19')\nshutil.rmtree('runs\/detect')\nfor file in (glob('runs\/train\/exp\/**\/*.png', recursive = True)+glob('runs\/train\/exp\/**\/*.jpg', recursive = True)):\n    os.remove(file)","3c56e57f":"# GT Vs Pred","becf5b48":"# Train","e3f0b324":"# Inference Plot","3a42af41":"# (Loss, Map) Vs Epoch","bac19cd1":"# Class Distribution","cb906e37":"# Confusion Matrix","eb3fc916":"## Pretrained Checkpoints:\n\n| Model | AP<sup>val<\/sup> | AP<sup>test<\/sup> | AP<sub>50<\/sub> | Speed<sub>GPU<\/sub> | FPS<sub>GPU<\/sub> || params | FLOPS |\n|---------- |------ |------ |------ | -------- | ------| ------ |------  |  :------: |\n| [YOLOv5s](https:\/\/github.com\/ultralytics\/yolov5\/releases\/tag\/v3.0)    | 37.0     | 37.0     | 56.2     | **2.4ms** | **416** || 7.5M   | 13.2B\n| [YOLOv5m](https:\/\/github.com\/ultralytics\/yolov5\/releases\/tag\/v3.0)    | 44.3     | 44.3     | 63.2     | 3.4ms     | 294     || 21.8M  | 39.4B\n| [YOLOv5l](https:\/\/github.com\/ultralytics\/yolov5\/releases\/tag\/v3.0)    | 47.7     | 47.7     | 66.5     | 4.4ms     | 227     || 47.8M  | 88.1B\n| [YOLOv5x](https:\/\/github.com\/ultralytics\/yolov5\/releases\/tag\/v3.0)    | **49.2** | **49.2** | **67.7** | 6.9ms     | 145     || 89.0M  | 166.4B\n| | | | | | || |\n| [YOLOv5x](https:\/\/github.com\/ultralytics\/yolov5\/releases\/tag\/v3.0) + TTA|**50.8**| **50.8** | **68.9** | 25.5ms    | 39      || 89.0M  | 354.3B\n| | | | | | || |\n| [YOLOv3-SPP](https:\/\/github.com\/ultralytics\/yolov5\/releases\/tag\/v3.0) | 45.6     | 45.5     | 65.2     | 4.5ms     | 222     || 63.0M  | 118.0B","48dda7c4":"# Inference","72fd5e80":"# YOLOv5 Stuff","0dca86ba":"# Copying Files","7b6dc9e0":"# Batch Image","4d89777d":"# Selecting Models\nIn this notebok I'm using `v5s`. To select your prefered model just replace `--cfg models\/yolov5s.yaml --weights yolov5s.pt` with the following command:\n* `v5s` : `--cfg models\/yolov5s.yaml --weights yolov5s.pt`\n* `v5m` : `--cfg models\/yolov5m.yaml --weights yolov5m.pt`\n* `v5l` : `--cfg models\/yolov5l.yaml --weights yolov5l.pt`\n* `v5x` : `--cfg models\/yolov5x.yaml --weights yolov5x.pt`","30c4efee":"# Get Class Name"}}