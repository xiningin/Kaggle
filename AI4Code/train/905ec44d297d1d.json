{"cell_type":{"88bc580e":"code","7e8f1223":"code","e7072675":"code","d46999b6":"code","21b2f5cb":"code","9ad358fd":"code","93618cce":"code","a2795c3c":"code","e30834ce":"code","e2c7dc3e":"code","3d6a20a8":"code","6613661e":"code","445cb865":"code","52734a27":"code","613f9444":"code","8db1125e":"code","13a84767":"code","d3d3da29":"code","f713026c":"code","95c9e4d9":"code","07d5d1f1":"code","1b304255":"code","e7aa413b":"code","b5f8cb83":"code","929c334e":"code","137e179e":"code","927f579a":"code","3a232ac0":"code","1a1e13b5":"code","1c4f0686":"markdown","ebe565f3":"markdown","5c8c48ee":"markdown","f8ba5262":"markdown","17c0f21c":"markdown","fd509884":"markdown","9477df7c":"markdown","73e0b00f":"markdown","98203e50":"markdown","01a72d09":"markdown","069b4210":"markdown","84ce18c9":"markdown","140a55e2":"markdown","71bc0eb8":"markdown","98935e82":"markdown","4ffce5af":"markdown","c79deca4":"markdown","10c72eed":"markdown","8d105664":"markdown","047d5a40":"markdown","ce2d815c":"markdown","c29470c3":"markdown","2617f207":"markdown","0020ede1":"markdown","76631e52":"markdown","035199fd":"markdown","88347767":"markdown","e3270ae9":"markdown","0e760a2c":"markdown","2d21b673":"markdown","177e36fe":"markdown","a761cb70":"markdown","878370bb":"markdown"},"source":{"88bc580e":"import pandas as pd               # for data manipulation\nimport matplotlib.pyplot as plt   # for plotting \nimport seaborn as sns             # an extension of matplotlib for statistical graphics","7e8f1223":"orders = pd.read_csv('..\/input\/orders.csv' )\norder_products_prior = pd.read_csv('..\/input\/order_products__prior.csv')\nproducts = pd.read_csv('..\/input\/products.csv')","e7072675":"prd = pd.merge(orders, order_products_prior, on='order_id', how='inner')\nprd.head(100)","d46999b6":"prd[prd.user_id==1].head(45)","21b2f5cb":"prd['order_number_back'] = prd.groupby('user_id')['order_number'].transform(max) - prd.order_number +1 \nprd.head(15)","9ad358fd":"prd[prd.user_id==30].head(10)","93618cce":"prd5 = prd[prd.order_number_back <= 5]\nprd5.head(15)","a2795c3c":"last_five = prd5.groupby(['user_id','product_id'])[['order_id']].count()\nlast_five.columns = ['times_last5']\nlast_five.head(10)","e30834ce":"last_five['times_last5_ratio'] = last_five.times_last5 \/ 5\nlast_five.head(10)","e2c7dc3e":"prd[prd.user_id==5]","3d6a20a8":"#Solution 1.1\n#prd5_with_five_orders = prd5.groupby('user_id').filter(lambda x: x.order_number_back.max() == 5)\n#Solution 1.2\n#prd5_with_five_orders = prd5.groupby('user_id').filter(lambda x: x.order_number_back.max() > 4)","6613661e":"#Solution 2.1\n#prd5_with_five_orders = prd5.groupby('user_id').filter(lambda x: x.order_number.max() == 5)\n#Solution 2.1\n#prd5_with_five_orders = prd5.groupby('user_id').filter(lambda x: x.order_number_back.max() > 4)","445cb865":"# Solution 3\nprd5_with_five_orders = prd5.groupby('user_id').filter(lambda x: x.order_id.nunique() == 5)","52734a27":"#sanity check\nprd5_with_five_orders[prd5_with_five_orders.user_id==5]","613f9444":"last_five_top = last_five[last_five.times_last5_ratio == 1].groupby('product_id')[['times_last5_ratio']].count()\nlast_five_top.columns = ['total_users']\nlast_five_top.head()","8db1125e":"last_five_top = last_five_top.sort_values(by='total_users', ascending=False)\nlast_five_top = last_five_top.iloc[0:20]\nlast_five_top = last_five_top.reset_index()\nlast_five_top","13a84767":"last_five_top_names = pd.merge(last_five_top, products, how='left')\nlast_five_top_names","d3d3da29":"plt.figure(figsize=(12,8))\nsns.barplot(last_five_top_names.total_users, last_five_top_names.product_name)\n# add label to x-axis\nplt.xlabel('Number of users', size=15)\n# keep y-axis free of label\nplt.ylabel('  ')\n#put a title\nplt.title('Top 20 products that have been ordered by most users on their last 5 orders ', size=15)\nplt.xticks(fontsize=15)\nplt.yticks(fontsize=15)\nplt.show()","f713026c":"times = prd.groupby(['user_id', 'product_id'])[['order_id']].count()\ntimes.columns = ['Times_Bought_N']\ntimes.head()","95c9e4d9":"total_orders = prd.groupby('user_id')[['order_number']].max()\ntotal_orders.columns = ['total_orders']\ntotal_orders.head()","07d5d1f1":"first_order_number = prd.groupby(['user_id', 'product_id'])[['order_number']].min()\nfirst_order_number.columns = ['first_order_number']\nfirst_order_number.head()","1b304255":"first_order_number_reset = first_order_number.reset_index()\nfirst_order_number_reset.head()","e7aa413b":"span = pd.merge(total_orders, first_order_number_reset, on='user_id', how='right')\nspan.head(20)","b5f8cb83":"span['Order_Range_D'] = span.total_orders - span.first_order_number + 1\nspan.head(30)","929c334e":"order_ratio = pd.merge(times, span, on=['user_id', 'product_id'], how='left')\norder_ratio.head()","137e179e":"order_ratio['Order_Ratio_user_id_X_product_id'] = order_ratio.Times_Bought_N \/ order_ratio.Order_Range_D\norder_ratio.head()","927f579a":"plt.figure(figsize=(15,5))\norder_ratio[order_ratio.product_id == 24852].Order_Ratio_user_id_X_product_id.hist(bins=50)\nplt.xlabel('order_ratio', size=10)\nplt.ylabel('Number of customers')\nplt.title('The distribution of order_ratio for bananas', size=10)\nplt.xticks(fontsize=10)\nplt.yticks(fontsize=10)\nplt.show()","3a232ac0":"plt.figure(figsize=(15,5))\norder_ratio[order_ratio.product_id == 24852].Order_Ratio_user_id_X_product_id.hist(cumulative=True, bins=50)\nplt.xlabel('order_ratio', size=10)\nplt.ylabel('Number of customers')\nplt.title('The CDF of order_ratio for bananas', size=10)\nplt.xticks(fontsize=10)\nplt.yticks(fontsize=10)\nplt.show()","1a1e13b5":"order_ratio = order_ratio.set_index(['user_id','product_id'])\norder_ratio.head()","1c4f0686":"So we can succesfully merge the DataFrames. As total_orders refers to all users, where first_order_number refers to unique combinations of user & product, we perform a right join:","ebe565f3":"## 1.3 Perform a .groupby( ) on users and products to get how many times each customer bought every product.\nHaving kept the last 5 orders for each user, we perform a .groupby( ) on user_id & product_id. With .count( ) we get how many times each customer bought a product.","5c8c48ee":"## 1.2 Keep only the last five orders for each customer\nWith the use of order_number_back we can now select to keep only the last five orders of each customer:","f8ba5262":"Finally, we visualize the results:","17c0f21c":"Moreover, we load the .csv files in DataFrames:","fd509884":"We get the name of the products from the products DataFrame:","9477df7c":"## 2.1 Calculating the numerator\n### 2.1.1 How many times a customer bought a product? ('Times_Bought_N')\nTo answer this question we simply .groupby( ) user_id & product_id and we count the order_id for each group","73e0b00f":"# 2 How frequently a customer bought a product after its first purchase ?\nIn this business insight we want to calculate the following ratio for each customer and every product that has purchased.\n\n![Order Ratio](https:\/\/latex.codecogs.com\/gif.latex?%5Cdpi%7B120%7D%20Order%5C%20Ratio%5C%20%28of%5C%20a%5C%20purchased%5C%20product%5C%20from%5C%20a%5C%20user%29%20%3D%20%5Cfrac%7BTimes%5C%20a%5C%20user%5C%20bought%5C%20a%5C%20product%7D%7BNumber%5C%20of%5C%20orders%5C%20placed%5C%20since%5C%20first%5C%20purchase%7D)\n\nIn this way we can create a metric that describes how many times a user bought a product out of how many times he or she had the chance to a buy it (starting from its first purchase).\n\nTo clarify this, we examine the user_id 1 and the product_id 13032:\n- User 1 has made 10 orders in total\n- Has bought the product_id 13032 for first time in its 2nd order & has bought the same product 3 times in total.\n\nThen:\nUser was able to buy the product for 9 times (starting from its 2nd order to his last order).\nSo this means that has bought it 3 out of 9 times, which equals 3\/9= 0,333.\n\nA higher ratio means that the customer bought more frequently a product since its first purchase.\n\nBefore we show how we can create the above ratio we declare the following variables:\n* How many times a customer bought a product? ('Times_Bought_N')\n* For each product get the total orders placed since its first order ('Order_Range_D')\n\nSo our desired ratio is defined as:\n\n![Order_Ratio_user_id_X_product_id](https:\/\/latex.codecogs.com\/gif.latex?Order%5C_Ratio%5C%28user%5C_id%5C%20%2C%5C%20product%5C_id%29%20%3D%20%5Cfrac%7BTimes%5C_Bought%5C_N%7D%7BOrder%5C_Range%5C_D%7D)\n\nWhere Order_Range_D is created throught two supportive variables:\n* The total number of orders for each customer ('total_orders')\n* The order number where the customer bought a product for first time ('first_order_number')\n\nWhere\n![Order_Range_D](https:\/\/latex.codecogs.com\/gif.latex?%5Cdpi%7B120%7D%20%5C%20%5C%20%5C%20%5C%20%5C%20Order%5C_Range%5C_D%28user%5C_id%2C%20product%5C_id%29%20%3D%20%5Cnewline%20%3D%5C%20total%5C_orders%28user%5C_id%29%20-%20first%5C_order%5C_number%28user%5C_id%2C%20product%5C_id%29%20&plus;%201)\n\nIn the next blocks we show how we create:\n1. The numerator 'Times_Bought_N'\n2. The supportive variables 'total_orders' & 'first_order_number' \n3. The denumerator 'Order_Range_D' with the use of the supportive variables\n4. Our final ratio 'Order_Ratio_user_id_X_product_id'","98203e50":"As our goal is to create the Order_Range_D, we need to merge total_orders with first_order_number DataFrame. For this reason we request to turn the multiple index of first_order_number as columns:","01a72d09":"####  2.2.4.2 Perform the final division\nNow we divide theTimes_Bought_N by the Order_Range_D for each user and product.","069b4210":"## 1.1 Create a new variable ('order_number_back') which keeps the order_number for each order in reverse order\nIn this step we show how we create a reverse order_number for each customer. <br>\nHave a look at the orders of customer 1 (user_id == 1)","84ce18c9":"# Import data into Python\nWe load the required packages:","140a55e2":"And now we create a Cumulative Distribution Function (CDF) for the same ratio:","71bc0eb8":"### 2.2.4 Create the final ratio Order_Ratio_user_id_X_product_id\n####  2.2.4.1 Merge the DataFrames of numerator & denumerator\nIn this stage we select to merge times DataFrame which contains the numerator & span which contains the denumerator of our desired ratio. **As both variables derived from the combination of users & products, any type of join will keep all the combinations.**","98935e82":"## 1.6 Find which products have been bought by the most users on all of their last five orders\nTo get this insight we will keep only the rows that have ratio == 1. On the rows, we will perform a .groupby( ) using the product_id and we will count the number of observations","4ffce5af":"## 1.4 Create the final ratio\nTo create the final ratio, we simply divide the new column by 5:","c79deca4":"Now we sort them in descending order by the total_users. We keep the 20 top products, and we reset the index of the DataFrame:","10c72eed":"Where we can conclude that 40.000 customers, bought bananas on less than their half orders (since the first time they ordered bananas), where around to (75.000-40.000=) 35.000 customers bought bananas on more than their half orders . Note that we refer to unique customers (customers who bought bananas even once) and not on all customers (206.209)","8d105664":"## 2.4 Setting index\nAs the combination of user_id & product_id are identical, we set them as the index of our order_ratio DataFrame:","047d5a40":"### 2.2.3 For each product get the total orders placed since its first order ('Order_Range_D')\nThe denominator now can be created with simple operations between the columns of results DataFrame:","ce2d815c":"Check that the formula has been applied to all users. Here we check the new column for a random user (user_id== 30):","c29470c3":"# 1 How many times a customer bought a product on its last 5 orders ?(times_last_5 & times_last_5_ratio)\n\nIn this business insight, we want to keep the last five orders for each customer and get how many times bought any product on them. To achieve this we need to:\n* Create a new variable ('order_number_back') which keeps the order_number for each order in reverse order\n* Keep only the last five orders for each order\n* Perform a .groupby( ) on users and products to get how many times each customer bought a product.\n* Create the following ratio:\n![](https:\/\/latex.codecogs.com\/gif.latex?times%5C%20last%20%5C5%5C%20%28of%5C%20a%5C%20purchased%5C%20product%5C%20from%5C%20a%5C%20user%29%3D%5Cfrac%7BTimes%5C%20a%5C%20user%5C%20bought%5C%20a%5C%20product%5C%20on%5C%20its%5C%20last%5C%205%5C%20orders%7D%7BTotal%5C%20orders%5C%20%3D5%7D)","2617f207":"## 2.2 Calculating the denumerator\nTo calculate the denumerator, we have first to calculate the total orders of each user & first order number for each user and every product purchase\n### 2.2.1 The total number of orders for each customer ('total_orders')\nHere we .groupby( ) only by the user_id, we keep the column order_number and we get its highest value with the aggregation function .mean()","0020ede1":"Now we show how we can perform the procedure on all users. We .groupby( ) prd by the user_id and we select the column order_number. With .transform(max) we request to get the highest number of the column order_number for each group & with minus (-) prd.order_number we substract the order_number of each row. Finally we add 1 for the reason mentioned above.\n\n> .transform( ) perform some group-specific computations and return a like-indexed object. ","76631e52":"## 2.3 Visualizing the order_ratio for a product\nHere we show the distribution of order_ratio for product 24852; bananas , a product with 73956 unique customers.","035199fd":"# 1.5 Your Turn \ud83d\udcda\ud83d\udcdd\nHave a look on the orders of the customer with user_id == 5:","88347767":"# Introduction\nThis kernel has been created by the [Information Systems Lab](http:\/\/islab.uom.gr) at the University of Macedonia, Greece for the needs of the elective course Special Topics of Information Systems I at the [Business Administration](http:\/\/www.uom.gr\/index.php?tmima=2&categorymenu=2) department of the University of Macedonia, Greece.\n\nIn this Instacart Notebook, we will get insights regarding how each customer behave towards the products that has ordered in the past. <br>\nTo be more specific, we create variables that describe each possible combination of user (user_id) with product (product_id) from prior orders.\n\n# Business Insights\n* How many times a customer bought a product on its last 5 orders?\n - Find which products have been bought by the most users on all of their last five orders\n* How frequently a customer bought a product after its first purchase?\n - How many times a customer bought a product?\n\n# Python Skills\n* Transform columns with .groupby( )\n* Filter orders\n* Calculate range of orders for a product\n\n# Packages \n* pandas: .transform( ), .max( ) , .min( ), .hist(cumulative=True), .set_index( )","e3270ae9":"Perform the appropriate sanity check to check your results.","0e760a2c":"What we want to create, is a new column ('order_number_back') which indicates the last order as first, the second from the end as second and so on. To achieve this, we get the highest order_number (max) for user_id==1 and we subtract the order_number of each order from it. Thus for last order (order_number == 10) that will be: \n<br>\n<br>\n\n![order_number_back](https:\/\/latex.codecogs.com\/png.latex?%5Cdpi%7B200%7D%20%5Ctiny%20%5Cfontsize%7B%20%7D%7Bbaselineskip%7D%20order%5C_number%5C_back%28x%29%3D%20order%5C_number.max%28%29%20-order%5C_number%28x%29%3D10%20-%2010%20%3D%200)\n\nAnd as we want the last order to be marked as first, rather than zeroth, the previous formula will be:\n\n![](https:\/\/latex.codecogs.com\/png.latex?%5Cdpi%7B200%7D%20%5Ctiny%20%5Cfontsize%7B%20%7D%7Bbaselineskip%7D%20order%5C_number%5C_back%28x%29%3D%20order%5C_number.max%28%29%20-order%5C_number%28x%29%3D10%20-%2010%20&plus;1%3D%201)\n\n> Note that order_number.max( ) is a single value, where order_number is a 1-D array (column\/Series)\n\nBy applying the above formula to the orders of user_id == 1 we get the following results:\n![](https:\/\/i.imgur.com\/toda8ay.png)","2d21b673":"![](http:\/\/)So for user_id==1, the product 196 has been ordered on all of its last five orders, where the product 35951 has been ordered only one time.","177e36fe":"As you can see, the customer with user_id==5 has placed 4 orders in total. How can filter out the customers with less than 5 orders?","a761cb70":"The data that we use in this notebook come from both the orders and products purchased from each customer, so we create the **prd** DataFrame:","878370bb":"### 2.2.2 The order number where the customer bought a product for first time ('first_order_number')\nWhere for first_order_number we .groupby( ) by both user_id & product_id. As we want to get the order when a product has been purchases for first time, we select the order_number column and we retrieve with .min( ) aggregation function, the earliest order."}}