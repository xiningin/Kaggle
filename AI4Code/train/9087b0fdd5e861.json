{"cell_type":{"dcd9c0b9":"code","2f44c49f":"code","3b86afdc":"code","0e0f21e5":"code","51eddddc":"code","1ad00af4":"code","cf0502a0":"code","451e2272":"code","cf0e296c":"code","b0e09766":"code","0f59c2c6":"code","a79887f0":"code","e89a7874":"code","dd5dc67e":"code","df0128eb":"markdown","eaefe41f":"markdown","aac1beeb":"markdown","a463ee0b":"markdown"},"source":{"dcd9c0b9":"import os,io,pathlib,pylab as pl\nimport scipy.misc,numpy as np\nfrom six import BytesIO\nfrom PIL import Image,ImageDraw,ImageFont\nfrom six.moves.urllib.request import urlopen\nimport tensorflow as tf,tensorflow_hub as hub\ntf.get_logger().setLevel('ERROR')","2f44c49f":"!python -m pip install --upgrade pip \\\n--user --quiet --no-warn-script-location\n!git clone --depth 1 https:\/\/github.com\/tensorflow\/models --quiet ","3b86afdc":"%%bash\npip install protobuf-compiler --user --quiet\ncd models\/research\/\nprotoc object_detection\/protos\/*.proto --python_out=.\ncp object_detection\/packages\/tf2\/setup.py .\npython -m pip install . --user --quiet","0e0f21e5":"spath='root\/.local\/bin'\nimport sys; sys.path.append(spath)","51eddddc":"from object_detection.utils import \\\nlabel_map_util,ops as utils_ops,\\\nvisualization_utils as viz_utils\nlabel_map='.\/models\/research\/object_detection\/'+\\\n          'data\/mscoco_label_map.pbtxt'\ncategory_index=label_map_util\\\n.create_category_index_from_labelmap(\n    label_map,use_display_name=True)","1ad00af4":"all_models={\n'CenterNet HourGlass104 512x512':\n    'https:\/\/tfhub.dev\/tensorflow\/centernet\/hourglass_512x512\/1',\n'CenterNet HourGlass104 Keypoints 512x512':\n    'https:\/\/tfhub.dev\/tensorflow\/centernet\/hourglass_512x512_kpts\/1',\n'CenterNet HourGlass104 1024x1024':\n    'https:\/\/tfhub.dev\/tensorflow\/centernet\/hourglass_1024x1024\/1',\n'CenterNet HourGlass104 Keypoints 1024x1024':\n    'https:\/\/tfhub.dev\/tensorflow\/centernet\/hourglass_1024x1024_kpts\/1',\n'CenterNet Resnet50 V1 FPN 512x512':\n    'https:\/\/tfhub.dev\/tensorflow\/centernet\/resnet50v1_fpn_512x512\/1',\n'CenterNet Resnet50 V1 FPN Keypoints 512x512':\n    'https:\/\/tfhub.dev\/tensorflow\/centernet\/resnet50v1_fpn_512x512_kpts\/1',\n'CenterNet Resnet101 V1 FPN 512x512':\n    'https:\/\/tfhub.dev\/tensorflow\/centernet\/resnet101v1_fpn_512x512\/1',\n'CenterNet Resnet50 V2 512x512':\n    'https:\/\/tfhub.dev\/tensorflow\/centernet\/resnet50v2_512x512\/1',\n'CenterNet Resnet50 V2 Keypoints 512x512':\n    'https:\/\/tfhub.dev\/tensorflow\/centernet\/resnet50v2_512x512_kpts\/1',\n'EfficientDet D0 512x512':\n    'https:\/\/tfhub.dev\/tensorflow\/efficientdet\/d0\/1',\n'EfficientDet D1 640x640':\n    'https:\/\/tfhub.dev\/tensorflow\/efficientdet\/d1\/1',\n'EfficientDet D2 768x768':\n    'https:\/\/tfhub.dev\/tensorflow\/efficientdet\/d2\/1',\n'EfficientDet D3 896x896':\n    'https:\/\/tfhub.dev\/tensorflow\/efficientdet\/d3\/1',\n'EfficientDet D4 1024x1024':\n    'https:\/\/tfhub.dev\/tensorflow\/efficientdet\/d4\/1',\n'EfficientDet D5 1280x1280':\n    'https:\/\/tfhub.dev\/tensorflow\/efficientdet\/d5\/1',\n'EfficientDet D6 1280x1280':\n    'https:\/\/tfhub.dev\/tensorflow\/efficientdet\/d6\/1',\n'EfficientDet D7 1536x1536':\n    'https:\/\/tfhub.dev\/tensorflow\/efficientdet\/d7\/1',\n'SSD MobileNet v2 320x320':\n    'https:\/\/tfhub.dev\/tensorflow\/ssd_mobilenet_v2\/2',\n'SSD MobileNet V1 FPN 640x640':\n    'https:\/\/tfhub.dev\/tensorflow\/ssd_mobilenet_v1\/fpn_640x640\/1',\n'SSD MobileNet V2 FPNLite 320x320':\n    'https:\/\/tfhub.dev\/tensorflow\/ssd_mobilenet_v2\/fpnlite_320x320\/1',\n'SSD MobileNet V2 FPNLite 640x640':\n    'https:\/\/tfhub.dev\/tensorflow\/ssd_mobilenet_v2\/fpnlite_640x640\/1',\n'SSD ResNet50 V1 FPN 640x640 (RetinaNet50)':\n    'https:\/\/tfhub.dev\/tensorflow\/retinanet\/resnet50_v1_fpn_640x640\/1',\n'SSD ResNet50 V1 FPN 1024x1024 (RetinaNet50)':\n    'https:\/\/tfhub.dev\/tensorflow\/retinanet\/resnet50_v1_fpn_1024x1024\/1',\n'SSD ResNet101 V1 FPN 640x640 (RetinaNet101)':\n    'https:\/\/tfhub.dev\/tensorflow\/retinanet\/resnet101_v1_fpn_640x640\/1',\n'SSD ResNet101 V1 FPN 1024x1024 (RetinaNet101)':\n    'https:\/\/tfhub.dev\/tensorflow\/retinanet\/resnet101_v1_fpn_1024x1024\/1',\n'SSD ResNet152 V1 FPN 640x640 (RetinaNet152)':\n    'https:\/\/tfhub.dev\/tensorflow\/retinanet\/resnet152_v1_fpn_640x640\/1',\n'SSD ResNet152 V1 FPN 1024x1024 (RetinaNet152)':\n    'https:\/\/tfhub.dev\/tensorflow\/retinanet\/resnet152_v1_fpn_1024x1024\/1',\n'Faster R-CNN ResNet50 V1 640x640':\n    'https:\/\/tfhub.dev\/tensorflow\/faster_rcnn\/resnet50_v1_640x640\/1',\n'Faster R-CNN ResNet50 V1 1024x1024':\n    'https:\/\/tfhub.dev\/tensorflow\/faster_rcnn\/resnet50_v1_1024x1024\/1',\n'Faster R-CNN ResNet50 V1 800x1333':\n    'https:\/\/tfhub.dev\/tensorflow\/faster_rcnn\/resnet50_v1_800x1333\/1',\n'Faster R-CNN ResNet101 V1 640x640':\n    'https:\/\/tfhub.dev\/tensorflow\/faster_rcnn\/resnet101_v1_640x640\/1',\n'Faster R-CNN ResNet101 V1 1024x1024':\n    'https:\/\/tfhub.dev\/tensorflow\/faster_rcnn\/resnet101_v1_1024x1024\/1',\n'Faster R-CNN ResNet101 V1 800x1333':\n    'https:\/\/tfhub.dev\/tensorflow\/faster_rcnn\/resnet101_v1_800x1333\/1',\n'Faster R-CNN ResNet152 V1 640x640':\n    'https:\/\/tfhub.dev\/tensorflow\/faster_rcnn\/resnet152_v1_640x640\/1',\n'Faster R-CNN ResNet152 V1 1024x1024':\n    'https:\/\/tfhub.dev\/tensorflow\/faster_rcnn\/resnet152_v1_1024x1024\/1',\n'Faster R-CNN ResNet152 V1 800x1333':\n    'https:\/\/tfhub.dev\/tensorflow\/faster_rcnn\/resnet152_v1_800x1333\/1',\n'Faster R-CNN Inception ResNet V2 640x640':\n    'https:\/\/tfhub.dev\/tensorflow\/faster_rcnn\/inception_resnet_v2_640x640\/1',\n'Faster R-CNN Inception ResNet V2 1024x1024':\n    'https:\/\/tfhub.dev\/tensorflow\/faster_rcnn\/inception_resnet_v2_1024x1024\/1',\n'Mask R-CNN Inception ResNet V2 1024x1024':\n    'https:\/\/tfhub.dev\/tensorflow\/mask_rcnn\/inception_resnet_v2_1024x1024\/1'}","cf0502a0":"model_display_name='CenterNet HourGlass104 1024x1024'\nmodel_handle=all_models[model_display_name]\nprint('selected model: %s'%model_display_name)\nprint('model handle at TensorFlow Hub: %s'%model_handle)\nprint('loading model...')\nhub_model=hub.load(model_handle)\nprint('model loaded!')","451e2272":"def load_image_into_numpy_array(path):\n    img=None\n    if (path.startswith('http')):\n        response=urlopen(path)\n        img_data=response.read()\n        img_data=BytesIO(img_data)\n        img=Image.open(img_data)\n    else:\n        img_data=tf.io.gfile.GFile(path,'rb').read()\n        img=Image.open(BytesIO(img_data))\n    (img_width,img_height)=img.size\n    return np.array(img.getdata()).reshape(\n        (1,img_height,img_width,3)).astype(np.uint8)\n%matplotlib inline","cf0e296c":"COCO17_HUMAN_POSE_KEYPOINTS=\\\n[(0,1),(0,2),(1,3),(2,4),(0,5),(0,6),\n (5,7),(7,9),(6,8),(8,10),(5,6),(5,11),\n (6,12),(11,12),(11,13),(13,15),(12,14),(14,16)]","b0e09766":"file_path='https:\/\/olgabelitskaya.gitlab.io\/images\/'\nimages_dict={\n    'squirrel':file_path+'01_024.png',\n    'urban lights':file_path+'01_026.png',\n    'ducks':file_path+'01_027.png',\n    'science lesson':file_path+'01_028.png',\n    'butterflies':file_path+'01_030.png',\n    'insects':file_path+'01_031.png',\n    'illuminations':file_path+'01_033.png',\n    'dusk':file_path+'01_035.png'\n}","0f59c2c6":"selected_img='dusk'\nflip_image_horizontally=False\nconvert_image_to_grayscale=False\nrotate_image_90=0\nimg_path=images_dict[selected_img]\nimg_np=load_image_into_numpy_array(img_path)\nif (flip_image_horizontally):\n    img_np[0]=np.fliplr(img_np[0]).copy()\nif (convert_image_to_grayscale):\n    img_np[0]=np.tile(\n        np.mean(img_np[0],2,keepdims=True),(1,1,3))\\\n    .astype(np.uint8)\nfor i in range(rotate_image_90):\n    img_np=tf.image.rot90(img_np).numpy().copy()\npl.figure(figsize=(8,12))\npl.imshow(img_np[0])\npl.tight_layout(); pl.show()","a79887f0":"results=hub_model(img_np)\nresult={key:value.numpy() for key,value in results.items()}\nprint(result.keys())\nprint(result['detection_classes'][0])","e89a7874":"label_id_offset=0\nimg_np_detections=img_np.copy()\nkeypoints,keypoint_scores=None,None\nif 'detection_keypoints' in result:\n    keypoints=result['detection_keypoints'][0]\n    keypoint_scores=result['detection_keypoint_scores'][0]\nviz_utils.visualize_boxes_and_labels_on_image_array(\n      img_np_detections[0],\n      result['detection_boxes'][0],\n      (result['detection_classes'][0]+\\\n       label_id_offset).astype(int),\n      result['detection_scores'][0],\n      category_index,\n      use_normalized_coordinates=True,\n      max_boxes_to_draw=100,\n      min_score_thresh=.2,\n      agnostic_mode=False,\n      keypoints=keypoints,\n      keypoint_scores=keypoint_scores,\n      keypoint_edges=COCO17_HUMAN_POSE_KEYPOINTS)\npl.figure(figsize=(10,14))\npl.imshow(img_np_detections[0])\npl.tight_layout(); pl.show()","dd5dc67e":"img_np_mask=img_np.copy()\nif 'detection_masks' in result:\n    detection_masks=tf.convert_to_tensor(\n        result['detection_masks'][0])\n    detection_boxes=tf.convert_to_tensor(\n        result['detection_boxes'][0])\n    detection_masks_reframed=\\\n    utils_ops.reframe_box_masks_to_image_masks(\n        detection_masks, detection_boxes,\n        img_np.shape[1],img_np.shape[2])\n    detection_masks_reframed=\\\n    tf.cast(detection_masks_reframed>.5,tf.uint8)\n    result['detection_masks_reframed']=detection_masks_reframed.numpy()\nviz_utils.visualize_boxes_and_labels_on_image_array(\n      img_np_mask[0],\n      result['detection_boxes'][0],\n      (result['detection_classes'][0]+\\\n       label_id_offset).astype(int),\n      result['detection_scores'][0],\n      category_index,\n      use_normalized_coordinates=True,\n      max_boxes_to_draw=100,\n      min_score_thresh=.2,\n      agnostic_mode=False,\n      instance_masks=result.get('detection_masks_reframed',None),\n      line_thickness=5)\npl.figure(figsize=(10,14))\npl.imshow(img_np_mask[0])\npl.tight_layout(); pl.show()","df0128eb":"## \u2712\ufe0f Object Detection","eaefe41f":"## \u2712\ufe0f Code Modules & Settings","aac1beeb":"## \u2712\ufe0f Models","a463ee0b":"## \u2712\ufe0f Images"}}