{"cell_type":{"60325fc9":"code","60ebc53d":"code","9a4ad432":"code","10a990de":"code","49e864a7":"code","7e9a786a":"code","c33077c3":"code","46aeb839":"code","1c8e1ccf":"code","f5068537":"code","b9b6508c":"code","649dad34":"code","7799e9be":"code","edf97309":"code","f42cc170":"code","cba04183":"code","78863b17":"code","729b8003":"code","d826b60a":"code","2d6e2a8c":"code","fa131ecc":"code","fe1fb73b":"code","9d08e80e":"code","8b775087":"code","77e4c897":"code","aa2a70f2":"code","81bb1cd4":"code","2e348cdf":"code","24f492ef":"code","33100950":"code","89d863e1":"code","a51aafa6":"code","7055ef97":"code","222193af":"code","d30f45be":"code","8e50377d":"code","e05958fb":"code","4e3b98a4":"code","16898f1f":"code","472edc28":"code","142de146":"code","ad9868a0":"code","cb0aab6a":"code","c26f541f":"markdown","ddd20a34":"markdown","b9d0b67e":"markdown","b8c7a28e":"markdown","47458706":"markdown","7646355b":"markdown","77d06db4":"markdown","f00832cb":"markdown","50d75e96":"markdown","bd4b6e33":"markdown","1470035d":"markdown","54a126e6":"markdown","e468425c":"markdown","90a55a9d":"markdown","8666ee30":"markdown","28eaf02b":"markdown","adcbcb1b":"markdown","f6349a15":"markdown","eb39b06f":"markdown","bf7bf90a":"markdown","3a179a98":"markdown","b0be5c54":"markdown","38d0c0b8":"markdown","ef7c4c84":"markdown","e1e2ce17":"markdown","64ca09bc":"markdown","25decb6c":"markdown"},"source":{"60325fc9":"import numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\n\nimport os\nprint(os.listdir(\"..\/input\"))\n\nimport matplotlib.pyplot as plt\n\nimport math","60ebc53d":"def shaking(x):\n    return x + np.random.random(len(x))","9a4ad432":"train_df = pd.read_csv(\"..\/input\/train.csv\")\ntest_df = pd.read_csv(\"..\/input\/test.csv\")","10a990de":"print(\"Train rows %s\" % train_df.shape[0])\nprint(\"Test rows %s\" % test_df.shape[0])\nprint(\"Features %s\" % len(test_df.columns.values))","49e864a7":"train_df.sample(5)","7e9a786a":"one_hot_columns = {\n    'wall_material' : ['paredblolad', 'paredzocalo','paredpreb','pareddes','paredmad','paredzinc', 'paredfibras','paredother'],\n    'floor_material' : ['pisomoscer', 'pisocemento', 'pisoother','pisonatur','pisonotiene','pisomadera'],\n    'roof_material' : ['techozinc', 'techoentrepiso', 'techocane', 'techootro'],\n    'water_provision' : ['abastaguadentro', 'abastaguafuera', 'abastaguano'],\n    'electricity' : ['public','planpri', 'noelec', 'coopele'],\n    'toilet' : ['sanitario1','sanitario2', 'sanitario3', 'sanitario5', 'sanitario6'],\n    'cooking_energy_source' : ['energcocinar1', 'energcocinar2', 'energcocinar3', 'energcocinar4'],\n    'rubish_disposal' : ['elimbasu1', 'elimbasu2', 'elimbasu3', 'elimbasu4', 'elimbasu5', 'elimbasu6'],\n    'wall' : ['epared1', 'epared2', 'epared3'],\n    'roof' : ['etecho1', 'etecho2', 'etecho3'], \n    'floor' : ['eviv1', 'eviv2', 'eviv3'],\n    'sex' : ['male', 'female'],\n    'family_membership_status' : ['parentesco1','parentesco2','parentesco3','parentesco4','parentesco5','parentesco6','parentesco7','parentesco8','parentesco9','parentesco10','parentesco11','parentesco12'],\n    'marital_status': ['estadocivil1', 'estadocivil2', 'estadocivil3', 'estadocivil4', 'estadocivil5', 'estadocivil6', 'estadocivil7'],\n    'education' : ['instlevel1', 'instlevel2', 'instlevel3', 'instlevel4', 'instlevel5', 'instlevel6', 'instlevel7', 'instlevel8', 'instlevel9'],\n    'dwelling_status' : ['tipovivi1', 'tipovivi2', 'tipovivi3', 'tipovivi4', 'tipovivi5'],\n    'region' : ['lugar1','lugar2', 'lugar3', 'lugar4', 'lugar5', 'lugar6'], \n    'urban_rural' : ['area1', 'area2']\n}","c33077c3":"def merge_one_hot(df):\n    all_one_hot = sum(one_hot_columns.values(), [])\n    rest_df = df.drop(columns = all_one_hot)\n    \n    for name, group in one_hot_columns.items():\n        rest_df[name] = (df[group] == 1).idxmax(1).astype('category')\n    \n    return rest_df","46aeb839":"train_df = merge_one_hot(train_df)\ntest_df = merge_one_hot(test_df)","1c8e1ccf":"print(\"%s features\" % len(test_df.columns.values))","f5068537":"train_df.head()","b9b6508c":"train_df.columns[train_df.isnull().any()].values","649dad34":"train_df.v2a1.describe()","7799e9be":"train_df.v2a1.isna().sum()","edf97309":"display(train_df.groupby(\"dwelling_status\").v2a1.apply(lambda x: x.isna().sum()))\ntrain_df.groupby(\"dwelling_status\").v2a1.apply(lambda x: x.isna().sum()).plot.bar()","f42cc170":"train_df.loc[train_df.v2a1.isna(), 'v2a1'] = 0.0\ntest_df.loc[test_df.v2a1.isna(), 'v2a1'] = 0.0","cba04183":"((train_df.v18q == 0) == (train_df.v18q1.isna())).mean() == 1.0","78863b17":"train_df.v18q1.fillna(0.0, inplace=True)\ntest_df.v18q1.fillna(0.0, inplace=True)","729b8003":"train_df.rez_esc.unique()","d826b60a":"train_df[['age', 'rez_esc']].apply(lambda x: x + np.random.random(len(x))*0.5).plot.scatter(x='age', y='rez_esc', s=1)","2d6e2a8c":"def get_primary_school_years(escolari, education, rez_esc):\n    if education not in ['instlevel1', 'instlevel2']:\n        return 6 # if somebody have primary education, he studied in primary school 6 years\n    if np.isnan(rez_esc):\n        return escolari\n    return rez_esc\n\ndef get_secondary_school_years(escolari, education, rez_esc):\n    if education in ['instlevel1', 'instlevel2', 'instlevel3']:\n        return 0\n    if education in ['instlevel4', 'instlevel5', 'instlevel6', 'instlevel7']:\n        if np.isnan(rez_esc):\n            return max(escolari - 6, 0)\n        return rez_esc\n    return 6\n\ndef get_high_school_years(escolari, education, rez_esc):\n    if education not in ['instlevel8', 'instlevel9']:\n        return 0\n    return max(escolari - 12, 0)\n\ndef fill_education(df):\n    df['primary_school_years'] = df[['escolari', 'education', 'rez_esc']].apply(lambda x: get_primary_school_years(*x), axis = 1)\n    df['secondary_school_years'] = df[['escolari', 'education', 'rez_esc']].apply(lambda x: get_secondary_school_years(*x), axis = 1)\n    df['high_school_years'] = df[['escolari', 'education', 'rez_esc']].apply(lambda x: get_high_school_years(*x), axis = 1)\n    df['escolari'] = df.primary_school_years + df.secondary_school_years + df.high_school_years\n    return df.drop(columns = ['rez_esc'])\n\ntrain_df = fill_education(train_df)\ntest_df = fill_education(test_df)","fa131ecc":"train_df[['idhogar', 'meaneduc']].head(15)","fe1fb73b":"train_df[['idhogar', 'meaneduc', 'age', 'primary_school_years', 'secondary_school_years']][train_df.meaneduc.isna()]","9d08e80e":"train_df.meaneduc.fillna(0.0, inplace=True)\ntest_df.meaneduc.fillna(0.0, inplace=True)","8b775087":"train_df['SQBmeaned'] = train_df.meaneduc ** 2\ntest_df['SQBmeaned'] = test_df.meaneduc ** 2","77e4c897":"train_df.columns[(train_df.dtypes == object)]","aa2a70f2":"train_df[['dependency', 'age', 'idhogar']].head(30)","81bb1cd4":"train_df.loc[train_df.idhogar.isin(train_df.idhogar[train_df.dependency == 'yes'].unique()), ['idhogar', 'age']].head(10)","2e348cdf":"def calc_dependency(df):\n    households_dependencies = df.groupby('idhogar')\\\n        .apply(lambda household: \n               ((household.age < 19) | (household.age > 64)).sum() \/ \n               household.age.apply(lambda a: (a > 18) & (a < 65)).sum())\n    df['dependency'] = df.idhogar.map(households_dependencies).apply(lambda v: 8 if np.isinf(v) else v)\n\ncalc_dependency(train_df)\ncalc_dependency(test_df)","24f492ef":"train_df.loc[\n    (train_df.family_membership_status == 'parentesco1') & \n    train_df.edjefe.isin(['yes', 'no']) & \n    train_df.edjefa.isin(['yes', 'no']) , \n    ['idhogar', 'sex', 'edjefe', 'edjefa', 'primary_school_years', 'secondary_school_years']\n].sample(10)","33100950":"train_df.loc[\n    (train_df.family_membership_status == 'parentesco1') & \n    ((~train_df.edjefe.isin(['yes', 'no'])) |\n    (~train_df.edjefa.isin(['yes', 'no']))) , \n    ['idhogar', 'sex', 'edjefe', 'edjefa', 'primary_school_years', 'secondary_school_years']\n].sample(10)","89d863e1":"def calc_head_escolari(df):\n    heads_escolari = df.loc[df.family_membership_status == 'parentesco1', ['idhogar', 'escolari']].set_index('idhogar').escolari\n    df['heads_escolari'] = df.idhogar.map(heads_escolari)\n    df.heads_escolari.fillna(0, inplace = True)\n    df.drop(columns = ['edjefa', 'edjefe'], inplace = True)\n    \ncalc_head_escolari(train_df)\ncalc_head_escolari(test_df)","a51aafa6":"train_df.columns.values","7055ef97":"import seaborn as sns\ncorr = train_df[['mobilephone', 'qmobilephone', 'Target']]\\\n    .assign(mobilephone_per_person = train_df.qmobilephone\/train_df.hogar_total)\\\n    .assign(person_per_mobilephone = train_df.hogar_total\/train_df.qmobilephone)\\\n    .corr()\nsns.heatmap(corr, \n            xticklabels=corr.columns.values,\n            yticklabels=corr.columns.values,\n            annot=True)","222193af":"train_df['person_per_mobilephone'] = train_df.hogar_total \/ train_df.qmobilephone\ntest_df['person_per_mobilephone'] = test_df.hogar_total \/ test_df.qmobilephone","d30f45be":"import seaborn as sns\ncorr = train_df[['v18q1', 'v18q', 'Target']]\\\n    .assign(tablet_per_person = train_df.v18q1\/train_df.hogar_total)\\\n    .assign(person_per_tablet = train_df.hogar_total\/train_df.v18q1)\\\n    .corr()\nsns.heatmap(corr, \n            xticklabels=corr.columns.values,\n            yticklabels=corr.columns.values,\n            annot=True)","8e50377d":"(train_df.hogar_total != train_df.tamhog).sum()","e05958fb":"train_df.drop(columns=['tamhog'], inplace = True)\ntest_df.drop(columns=['tamhog'], inplace = True)","4e3b98a4":"(train_df.groupby('idhogar').apply(lambda df: (df.tamviv - df.hogar_total).mean()) != 0).sum()","16898f1f":"train_df.assign(guests = train_df.tamviv - train_df.hogar_total)[['tamviv', 'guests', 'hogar_total', 'Target']].corr()","472edc28":"corr = train_df\\\n    .assign(devices = train_df.computer + train_df.refrig + train_df.qmobilephone + train_df.v18q1 + train_df.television)\\\n    .assign(dev_per_person = lambda df: df.devices\/df.hogar_total)\\\n    .assign(person_per_dev = lambda df: df.hogar_total\/df.devices)[[\n        'devices', 'dev_per_person', 'person_per_dev', 'computer', 'refrig', 'qmobilephone', 'v18q1', 'television', 'Target'\n    ]].corr()\nsns.heatmap(corr, \n            xticklabels=corr.columns.values,\n            yticklabels=corr.columns.values,\n            annot=True)","142de146":"fig, ax = plt.subplots(1, 2)\nfig.suptitle(\"Rooms and bedrooms\")\ntrain_df.rooms.plot.hist(ax=ax[0], bins = len(train_df.rooms.unique()))\ntrain_df.bedrooms.plot.hist(ax=ax[1], bins = 8)","ad9868a0":"fig, ax = plt.subplots(1, 2)\nfig.set_figwidth(14)\nfig.set_figheight(7)\nfig.suptitle(\"Rooms and bedrooms by total undividuals\")\nfig.legend()\ncolors = {1:'red', 2:'blue', 3:'green', 4:'black'}\ntrain_df[['hogar_total', 'rooms']]\\\n    .apply(lambda x: shaking(x)*0.1)\\\n    .plot.scatter(x = 'hogar_total', y = 'rooms', ax = ax[0], s = 2, c=train_df.Target.apply(lambda x: colors[x]))\ntrain_df[['hogar_total', 'bedrooms']]\\\n    .apply(lambda x: shaking(x)*0.1)\\\n    .plot.scatter(x = 'hogar_total', y = 'bedrooms', ax = ax[1], s = 2, c=train_df.Target.apply(lambda x: colors[x]))","cb0aab6a":"import seaborn as sns\ncorr = train_df[['rooms', 'bedrooms', 'hogar_total','overcrowding', 'Target']].assign(rooms_per_person = lambda df: df.hogar_total \/ (df.rooms - df.bedrooms)).corr()\nsns.heatmap(corr, \n            xticklabels=corr.columns.values,\n            yticklabels=corr.columns.values,\n            annot=True)\n# plt.matshow(train_df[['rooms', 'bedrooms', 'hogar_total', 'Target']].corr())\n# (train_df.bedrooms\/train_df.hogar_total).plot.bar()","c26f541f":"It looks like households, that has their own house, or lives in it for some precarious reasons doesn't pay a rent. So let fill the values with zeros.","ddd20a34":"There are lots of columns. But some of them simply **one hot encoding** representation of some feature. Lets union them back.","b9d0b67e":"**dependency** Dependency rate, calculated = (number of members of the household younger than 19 or older than 64)\/(number of member of household between 19 and 64)","b8c7a28e":"As we see, it doesn't imporove any correlations.","47458706":"As we see, the column have same values inside household.","7646355b":"# Data exploring","77d06db4":"Lets calculate average \"device quantity\" per person. Devices are fridge, phones, tv, computer, tablets.","f00832cb":"**meaneduc** is average years of education. What it means?","50d75e96":"# Columns with mixed data","bd4b6e33":"**v2a1** is monthly rent payment. Lets check, how it associated with other columns.","1470035d":"**person_per_mobilephone** gives highest correlation with Target. Add this column.****","54a126e6":"Repeat the same with tablets.","e468425c":"Very low correlation. Skip it.","90a55a9d":"There are 112 households, with some stange *guests*. Add as column?","8666ee30":"**qmobilephone** per person?","28eaf02b":"**rez_esc** is Years behind in school. It makes sense, that the column is associated with **escolari** years of schooling.\nFrom wikipedia:\n> Education in Costa Rica is divided in 3 cycles: pre-education (before age 7), primary education (from 6-7 to 12-13), and secondary school (from 12-13 to 17-18), which leads to higher education.\nThe primary education lasts six years and is divided in two cycles.\nThe secondary education is divided in two cycles of three years. The first cycle is dedicated to general education. The second cycle, while keeping a core curriculum, implies a specialization. Specializations can be academic or technical.","adcbcb1b":"Look likes, value is not filled for households without adults. Lets fill it with zero.","f6349a15":"As we see, **tamhog** and **hogar_total** are equals. Delete one. What about **tamviv**?","eb39b06f":"Looks like simpy uncalculated values. Lets calculate it ourself.","bf7bf90a":"# The problem\nPrediction of Costa Ricon households poverty levels. The levels are varies from 1 to 4, where 1 stands for extreme poverty households and 4 stands for non vulnerable households.","3a179a98":"Lots of unfilled values. Look how unfilled rent distributed over welling status (owned, rented, etc).","b0be5c54":"**SQBmeaned** the previous value, but squared.","38d0c0b8":"**edjefe** and **edjefa**\nedjefe, years of education of male head of household, based on the interaction of escolari (years of education), head of household and gender, yes=1 and no=0\nedjefa, years of education of female head of household, based on the interaction of escolari (years of education), head of household and gender, yes=1 and no=0","ef7c4c84":"Looks like *no* stands for *0*. But what means *yes*?","e1e2ce17":"# Nullable columns","64ca09bc":"Strange columns. Replace it with education years of household head.","25decb6c":"**v18q1** number of tablets, household have. As **v18q** indicates the fact of owning the tablet, we can suppose, that NaN means there are no tablets."}}