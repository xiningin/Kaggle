{"cell_type":{"c573e087":"code","af1b694e":"code","6a9b04f1":"code","807c6486":"code","faed72c0":"code","b4f8047f":"code","37d4b976":"code","23a1a69a":"code","2c694683":"code","07d601d5":"code","73e72d11":"code","277d2fe8":"code","b708a6dd":"code","e141d4d8":"code","a35053d3":"code","d41bc98c":"code","3e817dae":"code","a79583ef":"code","e4815ee1":"code","82774130":"code","fd6b307f":"code","a13a3a68":"code","e117be93":"code","36a3e3c0":"markdown","4e5a6f83":"markdown","6f117325":"markdown","00f68b62":"markdown","a96355b9":"markdown","eda6ea69":"markdown","eca3276a":"markdown","a4fb6bb7":"markdown"},"source":{"c573e087":"import pandas as pd\nfrom google.cloud import bigquery\nimport warnings\nwarnings.filterwarnings('ignore')\n\n# Create a \"Client\" object\nclient = bigquery.Client()\n\n# Construct a reference to the \"census_bureau_usa\" dataset\ndataset_ref = client.dataset(\"census_bureau_usa\", project=\"bigquery-public-data\")\n\n# API request - fetch the dataset\ndataset = client.get_dataset(dataset_ref)","af1b694e":"query = \"\"\"SELECT\n  zipcode AS zip, # we rename it to simplify the merge with another dataset later\n  population\n  FROM\n    `bigquery-public-data.census_bureau_usa.population_by_zip_2010`\n    WHERE gender IS NULL # to get general data, separate data on female and male population is also available\nORDER BY\n  population DESC\n        \"\"\"","6a9b04f1":"population = client.query(query).result().to_dataframe()\npopulation","807c6486":"population.info()","faed72c0":"df = pd.read_csv('..\/input\/us-zip-codes\/uszips.csv')\ndf","b4f8047f":"df.info()","37d4b976":"population[\"zip\"] = pd.to_numeric(population[\"zip\"])","23a1a69a":"df_merged = pd.merge(population,df[['zip', 'city', 'state_id', 'population', 'lat', 'lng']], on='zip')","2c694683":"df_merged","07d601d5":"# Many places have the same name, but are located in different states,\n# we need to extend city names with state ids before we group by city name\ndf_merged['city'] = df_merged['city'] + ' - ' + df_merged['state_id']\ndf_merged","73e72d11":"cities = df_merged.groupby(['city']).population_y.sum()\ncities = cities.to_frame()\ncities = cities.reset_index()\ncities","277d2fe8":"# We need to drop duplicates in the df_merged table and take only geolocation data from it\ncities = cities.merge(df_merged[['city', 'lat', 'lng']].drop_duplicates(['city']), on='city')","b708a6dd":"cities.sort_values(by='population_y', ascending=False)","e141d4d8":"cities2 = df_merged.groupby(['city']).population_x.sum()\ncities2 = cities2.to_frame()\ncities2 = cities2.reset_index()\ncities2","a35053d3":"cities2 = cities2.merge(df_merged[['city', 'lat', 'lng']].drop_duplicates(['city']), on='city')\ncities2.sort_values(by='population_x', ascending=False)","d41bc98c":"cities_merged = pd.merge(cities[['city', 'population_y']], cities2, on='city')","3e817dae":"cities_merged.info()","a79583ef":"cities_merged['population_y'] = cities_merged['population_y'].astype('int64')\ncities_merged['population_diff'] = (cities_merged['population_y'] - cities_merged['population_x'])","e4815ee1":"cities_merged","82774130":"# We concatenate tables with the top 20 cities which gained population\n# and the top 20 cities which lost population\nincrease = cities_merged.sort_values(by='population_diff', ascending=False).head(20)\ndecline = cities_merged.sort_values(by='population_diff').head(20)\nbig_change = pd.concat([increase, decline])\nbig_change","fd6b307f":"import folium\nfrom folium import Choropleth, Circle, Marker\nfrom folium.plugins import HeatMap, MarkerCluster","a13a3a68":"# Create a base map\nm_1 = folium.Map(location=[42.32,-81.0589], tiles='cartodbpositron', zoom_start=3)\n\n# Cities which gained more than 1000 people have a green dot\n# Cities which lost more than 1000 people have a red dot\n# The rest is gray\ndef color_producer(population_diff):\n    if population_diff > 1000:\n        return 'forestgreen'\n    if population_diff < -1000:\n        return 'darkred'\n    else:\n        return 'gray'\n\n# Add a bubble map to the base map\nfor i in range(0,len(cities_merged)):\n    Circle(\n        location=[cities_merged.iloc[i]['lat'], cities_merged.iloc[i]['lng']],\n        radius=20,\n        color=color_producer(cities_merged.iloc[i]['population_diff'])).add_to(m_1)\n\n# Display the map\nm_1","e117be93":"# On this map we put only the top 20 cities which gained population\n# and the top 20 cities which lost population\nm_2 = folium.Map(location=[42.32,-81.0589], tiles='cartodbpositron', zoom_start=3)\n\ndef color_producer(population_diff):\n    if population_diff > 0:\n        return 'forestgreen'\n    if population_diff < 0:\n        return 'darkred'\n\nfor i in range(0,len(big_change)):\n    Circle(\n        location=[big_change.iloc[i]['lat'], big_change.iloc[i]['lng']],\n        radius=1000,\n        color=color_producer(big_change.iloc[i]['population_diff'])).add_to(m_2)\n    \nm_2","36a3e3c0":"We see that most cities which **lost population** are in **Puerto Rico**, the uninorporated territory of the United States.\n\nGraphs on [Woldometers' site](https:\/\/www.worldometers.info\/world-population\/puerto-rico-population\/) confirm that our findings are generally correct.","4e5a6f83":"![](https:\/\/images.unsplash.com\/photo-1579036324788-8fae0f089e1d?ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&ixlib=rb-1.2.1&auto=format&fit=crop&w=1079&q=80)","6f117325":"For this notebook we'll use the 'population_by_zip_2010' table from the 'census_bureau_usa' dataset on Kaggle and a similar table on https:\/\/simplemaps.com\/data\/us-zips with data updated as of August 10, 2021.\n\nWe'd like to check which cities have had **the biggest population gain** or loss since the 2010 Census.","00f68b62":"# 1. Extract Data and Clean Tables","a96355b9":"# 2. Cities with the biggest gain or loss","eda6ea69":"# 4. Conclusion","eca3276a":"# 3. Cities on map","a4fb6bb7":"Because **New York City is divided into its boroughs** in the zipcodes dataset on https:\/\/simplemaps.com\/data\/us-zips, we don't have it at the top of our table (**only Brooklyn** is in the Top20). Without New York City the **top 3** cities with the population gain are in **Texas** and an article in the [local newspaper](https:\/\/www.mysanantonio.com\/news\/local\/article\/2020-census-Texas-San-Antonio-Austin-New-Braunfels-16383410.php) explains where the growth comes from."}}