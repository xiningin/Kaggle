{"cell_type":{"8844afdc":"code","c5bbc76e":"code","60fbe87f":"code","d94d7991":"code","e928badf":"code","d172c7cf":"code","8a45e2da":"code","9e1b1ae1":"code","e196b50d":"code","b52c550e":"code","f31b8be4":"markdown","82525e98":"markdown"},"source":{"8844afdc":"import numpy as np\nimport pandas as pd\nimport altair as alt\n\nimport matplotlib.pyplot as plt\nimport seaborn as sns\n\nfrom IPython.display import set_matplotlib_formats\nsns.set(palette='cubehelix')\nset_matplotlib_formats('retina')\n\nfrom google.cloud import bigquery\nimport warnings\nwarnings.filterwarnings('ignore')","c5bbc76e":"client = bigquery.Client()\n\ndataset_ref = client.dataset('google_analytics_sample',\n                     project='bigquery-public-data')\n\ndataset = client.get_dataset(dataset_ref)\n\ntables=[table.table_id for table in client.list_tables(dataset)]\ntables[:5]","60fbe87f":"summary_ref = dataset_ref.table('ga_sessions_20170720')\nsummary = client.get_table(summary_ref)\nsummary_frame = client.list_rows(summary,max_results=5).\\\nto_dataframe()\nsummary_frame","d94d7991":"query = \"\"\"\nselect fullVisitorId,totals.visits,totals.hits,\ntotals.pageviews,visitNumber, channelGrouping,\nparse_date(\"%Y%m%d\",date) as date,device.browser,socialEngagementType\nfrom `bigquery-public-data.google_analytics_sample.ga_sessions_20160801`\n\nunion all\n\nselect fullVisitorId,totals.visits,totals.hits,\ntotals.pageviews,visitNumber, channelGrouping,\nparse_date(\"%Y%m%d\",date) as date,device.browser,socialEngagementType\nfrom `bigquery-public-data.google_analytics_sample.ga_sessions_20160802`\n\nunion all\n\nselect fullVisitorId,totals.visits,totals.hits,\ntotals.pageviews,visitNumber, channelGrouping,\nparse_date(\"%Y%m%d\",date) as date,device.browser,socialEngagementType\nfrom `bigquery-public-data.google_analytics_sample.ga_sessions_20160803`\n\nunion all\n\nselect fullVisitorId,totals.visits,totals.hits,\ntotals.pageviews,visitNumber, channelGrouping,\nparse_date(\"%Y%m%d\",date) as date,device.browser,socialEngagementType\nfrom `bigquery-public-data.google_analytics_sample.ga_sessions_20160804`\n\nunion all\n\nselect fullVisitorId,totals.visits,totals.hits,\ntotals.pageviews,visitNumber, channelGrouping,\nparse_date(\"%Y%m%d\",date) as date,device.browser,socialEngagementType\nfrom `bigquery-public-data.google_analytics_sample.ga_sessions_20160805`\n\nunion all\n\nselect fullVisitorId,totals.visits,totals.hits,\ntotals.pageviews,visitNumber, channelGrouping,\nparse_date(\"%Y%m%d\",date) as date,device.browser,socialEngagementType\nfrom `bigquery-public-data.google_analytics_sample.ga_sessions_20160806`\n\nunion all\n\nselect fullVisitorId,totals.visits,totals.hits,\ntotals.pageviews,visitNumber, channelGrouping,\nparse_date(\"%Y%m%d\",date) as date,device.browser,socialEngagementType\nfrom `bigquery-public-data.google_analytics_sample.ga_sessions_20160807`\n\nunion all\n\nselect fullVisitorId,totals.visits,totals.hits,\ntotals.pageviews,visitNumber, channelGrouping,\nparse_date(\"%Y%m%d\",date) as date,device.browser,socialEngagementType\nfrom `bigquery-public-data.google_analytics_sample.ga_sessions_20160808`\n\nunion all\n\nselect fullVisitorId,totals.visits,totals.hits,\ntotals.pageviews,visitNumber, channelGrouping,\nparse_date(\"%Y%m%d\",date) as date,device.browser,socialEngagementType\nfrom `bigquery-public-data.google_analytics_sample.ga_sessions_20160809`\n\nunion all\n\nselect fullVisitorId,totals.visits,totals.hits,\ntotals.pageviews,visitNumber, channelGrouping,\nparse_date(\"%Y%m%d\",date) as date,device.browser,socialEngagementType\nfrom `bigquery-public-data.google_analytics_sample.ga_sessions_20160810`\n\nunion all\n\nselect fullVisitorId,totals.visits,totals.hits,\ntotals.pageviews,visitNumber, channelGrouping,\nparse_date(\"%Y%m%d\",date) as date,device.browser,socialEngagementType\nfrom `bigquery-public-data.google_analytics_sample.ga_sessions_20160811`\n\nunion all\n\nselect fullVisitorId,totals.visits,totals.hits,\ntotals.pageviews,visitNumber, channelGrouping,\nparse_date(\"%Y%m%d\",date) as date,device.browser,socialEngagementType\nfrom `bigquery-public-data.google_analytics_sample.ga_sessions_20160812`\n\nunion all\n\nselect fullVisitorId,totals.visits,totals.hits,\ntotals.pageviews,visitNumber, channelGrouping,\nparse_date(\"%Y%m%d\",date) as date,device.browser,socialEngagementType\nfrom `bigquery-public-data.google_analytics_sample.ga_sessions_20160813`\n\nunion all\n\nselect fullVisitorId,totals.visits,totals.hits,\ntotals.pageviews,visitNumber, channelGrouping,\nparse_date(\"%Y%m%d\",date) as date,device.browser,socialEngagementType\nfrom `bigquery-public-data.google_analytics_sample.ga_sessions_20160814`\n\nunion all\n\nselect fullVisitorId,totals.visits,totals.hits,\ntotals.pageviews,visitNumber, channelGrouping,\nparse_date(\"%Y%m%d\",date) as date,device.browser,socialEngagementType\nfrom `bigquery-public-data.google_analytics_sample.ga_sessions_20160815`\n\nunion all\n\nselect fullVisitorId,totals.visits,totals.hits,\ntotals.pageviews,visitNumber, channelGrouping,\nparse_date(\"%Y%m%d\",date) as date,device.browser,socialEngagementType\nfrom `bigquery-public-data.google_analytics_sample.ga_sessions_20160816`\n\nunion all\n\nselect fullVisitorId,totals.visits,totals.hits,\ntotals.pageviews,visitNumber, channelGrouping,\nparse_date(\"%Y%m%d\",date) as date,device.browser,socialEngagementType\nfrom `bigquery-public-data.google_analytics_sample.ga_sessions_20160817`\n\nunion all\n\nselect fullVisitorId,totals.visits,totals.hits,\ntotals.pageviews,visitNumber, channelGrouping,\nparse_date(\"%Y%m%d\",date) as date,device.browser,socialEngagementType\nfrom `bigquery-public-data.google_analytics_sample.ga_sessions_20160818`\n\nunion all\n\nselect fullVisitorId,totals.visits,totals.hits,\ntotals.pageviews,visitNumber, channelGrouping,\nparse_date(\"%Y%m%d\",date) as date,device.browser,socialEngagementType\nfrom `bigquery-public-data.google_analytics_sample.ga_sessions_20160819`\n\nunion all\n\nselect fullVisitorId,totals.visits,totals.hits,\ntotals.pageviews,visitNumber, channelGrouping,\nparse_date(\"%Y%m%d\",date) as date,device.browser,socialEngagementType\nfrom `bigquery-public-data.google_analytics_sample.ga_sessions_20160820`\n\nunion all\n\nselect fullVisitorId,totals.visits,totals.hits,\ntotals.pageviews,visitNumber, channelGrouping,\nparse_date(\"%Y%m%d\",date) as date,device.browser,socialEngagementType\nfrom `bigquery-public-data.google_analytics_sample.ga_sessions_20160821`\n\nunion all\n\nselect fullVisitorId,totals.visits,totals.hits,\ntotals.pageviews,visitNumber, channelGrouping,\nparse_date(\"%Y%m%d\",date) as date,device.browser,socialEngagementType\nfrom `bigquery-public-data.google_analytics_sample.ga_sessions_20160822`\n\nunion all\n\nselect fullVisitorId,totals.visits,totals.hits,\ntotals.pageviews,visitNumber, channelGrouping,\nparse_date(\"%Y%m%d\",date) as date,device.browser,socialEngagementType\nfrom `bigquery-public-data.google_analytics_sample.ga_sessions_20160823`\n\nunion all\n\nselect fullVisitorId,totals.visits,totals.hits,\ntotals.pageviews,visitNumber, channelGrouping,\nparse_date(\"%Y%m%d\",date) as date,device.browser,socialEngagementType\nfrom `bigquery-public-data.google_analytics_sample.ga_sessions_20160824`\n\nunion all\n\nselect fullVisitorId,totals.visits,totals.hits,\ntotals.pageviews,visitNumber, channelGrouping,\nparse_date(\"%Y%m%d\",date) as date,device.browser,socialEngagementType\nfrom `bigquery-public-data.google_analytics_sample.ga_sessions_20160825`\n\nunion all\n\nselect fullVisitorId,totals.visits,totals.hits,\ntotals.pageviews,visitNumber, channelGrouping,\nparse_date(\"%Y%m%d\",date) as date,device.browser,socialEngagementType\nfrom `bigquery-public-data.google_analytics_sample.ga_sessions_20160826`\n\nunion all\n\nselect fullVisitorId,totals.visits,totals.hits,\ntotals.pageviews,visitNumber, channelGrouping,\nparse_date(\"%Y%m%d\",date) as date,device.browser,socialEngagementType\nfrom `bigquery-public-data.google_analytics_sample.ga_sessions_20160827`\n\nunion all\n\nselect fullVisitorId,totals.visits,totals.hits,\ntotals.pageviews,visitNumber, channelGrouping,\nparse_date(\"%Y%m%d\",date) as date,device.browser,socialEngagementType\nfrom `bigquery-public-data.google_analytics_sample.ga_sessions_20160828`\n\nunion all\n\nselect fullVisitorId,totals.visits,totals.hits,\ntotals.pageviews,visitNumber, channelGrouping,\nparse_date(\"%Y%m%d\",date) as date,device.browser,socialEngagementType\nfrom `bigquery-public-data.google_analytics_sample.ga_sessions_20160829`\n\nunion all\n\nselect fullVisitorId,totals.visits,totals.hits,\ntotals.pageviews,visitNumber, channelGrouping,\nparse_date(\"%Y%m%d\",date) as date,device.browser,socialEngagementType\nfrom `bigquery-public-data.google_analytics_sample.ga_sessions_20160830`\n\norder by date\n\n\"\"\"\nsafe_config = bigquery.QueryJobConfig(maximum_bytes=10e11)\nquery_all = client.query(query, job_config=safe_config)\nframe = query_all.to_dataframe()\nframe.head()","e928badf":"source = frame.groupby(['channelGrouping',\n            'date'])['pageviews'].sum().reset_index()\nsource['date'] = pd.to_datetime(source['date'])\n\nalt.Chart(source).mark_circle(\n    opacity=0.8,\n    stroke='black',\n    strokeWidth=1\n).encode(\n    alt.X('monthdate(date):N', title='date',\n          axis=alt.Axis(labelAngle=45)),\n    alt.Y('channelGrouping:N'),\n    alt.Size('pageviews:Q',\n        scale=alt.Scale(range=[0, 1800]),\n        legend=alt.Legend(title='No. of views')\n    ),\n    alt.Color('channelGrouping:N', legend=None)\n).properties(\n    title='Day-by-Day views Splitted by Channel',\n    height=600\n).transform_filter(\n    alt.datum.Entity != ''\n)","d172c7cf":"source = frame.groupby(['browser',\n            'date'])['pageviews'].sum().reset_index()\nsource['date'] = pd.to_datetime(source['date'])\n\nchart = alt.Chart(source).mark_circle(\n    opacity=0.8,\n    stroke='black',\n    strokeWidth=1\n).encode(\n    alt.X('monthdate(date):N', title='date',\n          axis=alt.Axis(labelAngle=45)),\n    alt.Y('browser:N'),\n    alt.Size('pageviews:Q',\n        scale=alt.Scale(range=[0, 1770]),\n        legend=alt.Legend(title='No. of views')\n    ),\n    alt.Color('browser:N', legend=None)\n).properties(\n    title='Day-by-Day Views Splitted by Browser',\n).transform_filter(\n    alt.datum.Entity != ''\n)\n\nalt.layer(chart)","8a45e2da":"frame.head()","9e1b1ae1":"source = frame.groupby('date')[\n    ['visits','hits','pageviews']].sum().reset_index()\nsource['date'] = pd.to_datetime(source['date'])\nsource = source.reset_index().melt('date', \n    var_name='category', value_name='y')\n\nnearest = alt.selection(type='single', nearest=True,\n            on='mouseover', fields=['date'], empty='none')\n\ncls_ = ['#001f3f','#FF4136','#0074D9']\ndomain = ['visits','hits','pageviews']\n\nline = alt.Chart(source).mark_line(interpolate='monotone').encode(\n    alt.X('monthdate(date):N', title='date',\n          axis=alt.Axis(labelAngle=45)),\n    alt.Y('y:Q',title='Number of Actions',\n         axis=alt.Axis(gridOpacity=.5)),\n    color=alt.Color('category:N',\n        scale=alt.Scale(domain=domain,range=cls_)\n                   ),\n    opacity=alt.value(.75)\n).properties(title='Day-by-day changing in number of visits, hits & pageviews')\n\nselectors = alt.Chart(source).mark_point().encode(\n    x='monthdate(date):N',\n    opacity = alt.value(0)\n).add_selection(nearest)\n\npoints = line.mark_point().encode(\n    opacity=alt.condition(\n        nearest,alt.value(1), alt.value(0))\n)\n\ntext = line.mark_text(align='left',dx=5,dy=-13).encode(\n    text=alt.condition(nearest,'y:Q', alt.value(''))\n).transform_filter(nearest)\n\nrule = alt.Chart(source).mark_rule(color='basis').encode(\n    x='monthdate(date):N'\n).transform_filter(nearest)\n\nalt.layer(\n    line, selectors, points, text, rule).properties(\n        height=300, width=800)","e196b50d":"pd.crosstab(frame.channelGrouping,[frame.socialEngagementType,\n            frame.browser], margins=True)","b52c550e":"sns.clustermap(pd.crosstab(frame.browser,\n    frame.channelGrouping), cmap='binary',annot=True,\n        linewidth=1, linecolor='black')\nplt.show()","f31b8be4":"## Brief EDA & Visualisations\n-------","82525e98":"## BigQuery Load\n-------"}}