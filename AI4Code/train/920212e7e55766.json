{"cell_type":{"471f72ae":"code","cb9e4421":"code","c029a3ce":"code","868720b1":"code","b4d43000":"code","f5921703":"code","d9e9a4ed":"code","ba783974":"code","ea15742a":"code","34777fe6":"markdown","afdf1fac":"markdown","df7a211a":"markdown","c212e2c7":"markdown","a32ccba3":"markdown","bf6fdaaf":"markdown","9de4c8a0":"markdown","3c53b070":"markdown","e7f6d90d":"markdown"},"source":{"471f72ae":"# -*- coding: utf-8 -*-\n\"\"\"\nCreated on Thu Apr  2 09:08:53 2020\n\n@author: lucas\n\"\"\"\n\n### Load the package\n\nimport pandas as pd\nimport numpy as np\nfrom datetime import date\nimport matplotlib.pyplot as plt\n%matplotlib inline \n\n\n# Load the dataset\n\ndata_corona=pd.read_csv(\"..\/input\/novel-corona-virus-2019-dataset\/covid_19_data.csv\", index_col=0)\n\n","cb9e4421":"# Data cleaning\n\ndf = data_corona.drop('Last Update',axis=1)\ntoday = date.today() # load the data now\n\n# Change data format\nfor i in df.index:\n    data = df['ObservationDate'][i]\n    new_data= date(int(data.split('\/')[2]),int(data.split('\/')[0]),int(data.split('\/')[1]))\n    df.loc[i,'ObservationDate']=new_data\n    \n    \n# Sorting the data\ndf=df.sort_values(['Country\/Region','ObservationDate'],ascending =  [True ,False])\ndf.index = range(len(df))# redefinindo os \u00edndices ap\u00f3s colocar em ordem alfab\u00e9tica\n\n# Bringing together different provinces from the same country\nfor i in df['Country\/Region'].unique():\n    aux = df.loc[df['Country\/Region']==i]\n    if aux['Province\/State'].isna().sum()==0:\n        for j in aux['ObservationDate'].unique():\n            aux2 = aux.loc[aux['ObservationDate']==j]\n            df  = df.append({'ObservationDate':j,'Country\/Region':i,'Confirmed':\\\n                             aux2['Confirmed'].sum(),'Deaths': aux2['Deaths'].sum(), \\\n                                 'Recovered': aux2['Recovered'].sum()}, ignore_index= True)\n                \ndf = df.loc[df['Province\/State'].isnull()]\ndf = df.drop('Province\/State',axis=1)\n    \ndf=df.sort_values(['Country\/Region','ObservationDate'],ascending =  [True ,False])\ndf.index = range(len(df))# set the index\n\n# Changing the date, instead of entering the date, the day since the first infection will be placed\nfor i in df['Country\/Region'].unique():\n    aux = df.loc[df['Country\/Region']==i]\n    data_primeiro_caso = aux.loc[aux['Confirmed']!=0]['ObservationDate'].min()\n    for j in aux.index:\n        df.loc[j,'ObservationDate'] =(df['ObservationDate'][j] - data_primeiro_caso).days \n\n# Remove lines before the first case\ndf = df.drop(df[df['ObservationDate']<0].index)\n\ndf = df.set_index('Country\/Region')\n\n# Set the name of United States and China\ndf= df.rename({'US':'United States'})\ndf= df.rename({'Mainland China':'China'})\ndf ['Active cases']= df['Confirmed']- df['Deaths']-df['Recovered']\ndf['Country\/Region'] = df.index\n\n\n","c029a3ce":"# Dinamics of some countries and Brazil\n\n\npaises_analisados = ['China','Brazil','Italy','France',\\\n                     'Germany']\n\nfig, ax = plt.subplots()\nfor i in paises_analisados:\n    aux = df.loc[df['Country\/Region']==i]\n    plt.plot(aux['ObservationDate'],aux['Active cases'], label = i)\n    \n\nplt.legend(loc='best')\nplt.xlabel('Days')\nplt.grid('True')\n\nplt.ylabel('Number of active cases')\nplt.title('Active cases of corona virus')\nplt.show()","868720b1":"\ndf2=df\ndf2.index = range(len(df2))# redefinindo os \u00edndices ap\u00f3s colocar em ordem alfab\u00e9tica\n\ndf2=df2.sort_values(['Country\/Region','ObservationDate'],ascending =  [True ,False])\ndf2.index = range(len(df2))# redefinindo os \u00edndices ap\u00f3s colocar em ordem alfab\u00e9tica\n\n# Remove countries with little data\nnumero_dados_minimo = 10\nfor i in df2['Country\/Region'].unique():\n    aux= df2.loc[df2['Country\/Region']==i]\n    if len(aux)<numero_dados_minimo:\n        for j in aux.index:\n            df2 = df2.drop(j)\ndf2=df2.sort_values(['Country\/Region','ObservationDate'],ascending =  [True ,False])\ndf2.index = range(len(df2))","b4d43000":"# Create feature first derivative\ndf2['Primeira derivada']=0\nfor i in df2['Country\/Region'].unique():\n    aux= df2.loc[df2['Country\/Region']==i]\n    for j in aux.index[0:len(aux.index)-3]:\n        df2.loc[j,'Primeira derivada']= -aux['Active cases'].diff()[j+2]\n        \n#Create feature second derivative       \ndf2['Segunda derivada']=0\nfor i in df2['Country\/Region'].unique():\n    aux= df2.loc[df2['Country\/Region']==i]\n    for j in aux.index[0:len(aux.index)-3]:\n        df2.loc[j,'Segunda derivada']= -aux['Primeira derivada'].diff()[j+2]\n        \n    \n","f5921703":"# Criando  media segunda derivada   \nwindow_size = 4\ndf2['Media primeira derivada'] = 0\nfor i in df2['Country\/Region'].unique():\n    aux= df2.loc[df2['Country\/Region']==i]\n    for j in aux.index:\n        if j+window_size-1<(aux.index[len(aux.index)-1]):\n            df2.loc[j,'Media primeira derivada']=aux['Primeira derivada'].rolling(window_size).mean()[j+3]\n        else:\n            df2.loc[j,'Media primeira derivada']=0\n            \ndf2['Media segunda derivada'] = 0\nfor i in df2['Country\/Region'].unique():\n    aux= df2.loc[df2['Country\/Region']==i]\n    for j in aux.index:\n        if j+window_size-1<(aux.index[len(aux.index)-1]):\n            df2[j,'Media segunda derivada']=aux['Segunda derivada'].rolling(window_size).mean()[j+3]\n        else:\n            df2[j,'Media segunda derivada']=0\n","d9e9a4ed":"df2['Valor anterior'] = 0\nfor i in df2['Country\/Region'].unique():\n    aux= df2.loc[df2['Country\/Region']==i]\n    for j in aux.index:\n        if j+1<(aux.index[len(aux.index)-1]):\n            df2.loc[j,'Valor anterior']=aux['Active cases'][j+1]\n        else:\n            df2.loc[j,'Valor anterior']=0           \n","ba783974":"## Machine learning\n\ny  = df2['Active cases']\n\nx= df2[['ObservationDate','Media primeira derivada','Media segunda derivada', 'Valor anterior','Primeira derivada', 'Segunda derivada']]\n\n\n# Feature scaling\nfrom sklearn import preprocessing\n\nscaler = preprocessing.MinMaxScaler()\nscaled_df = scaler.fit_transform(x)\nscaled_df = pd.DataFrame(scaled_df, columns=['ObservationDate', 'Media primeira derivada'\\\n                                             , 'Media segunda derivada','Valor anterior'\\\n                                                 ,'Primeira derivada', 'Segunda derivada'])\n\n\nx=scaled_df\n\n\n\nfrom sklearn.preprocessing import PolynomialFeatures \nfrom sklearn.linear_model import LinearRegression \nlin = LinearRegression() \n  \nlin.fit(x, y)  \n\n\n\n \npoly = PolynomialFeatures(degree = 2)\nX_poly = poly.fit_transform(x) \n  \npoly.fit(X_poly, y) \nlin2 = LinearRegression() \nlin2.fit(X_poly, y) \n\n\n\n\n\n\n## Forecast to brazil\n\nx_brasil = x.loc[df2['Country\/Region']=='Brazil']\ny_brasil = y.loc[df2['Country\/Region']=='Brazil']\ndf2_brasil = df2.loc[df2['Country\/Region']=='Brazil']\n\ndayx = df2_brasil['ObservationDate'].max()\nnumero_dias_previsto = 60\n\n\nfor i in range(1,numero_dias_previsto):\n    # Retroalimenta\u00e7\u00e3o\n    df2_brasil = df2.loc[df2['Country\/Region']=='Brazil']\n    df2_brasil=df2_brasil.sort_values(['ObservationDate'],ascending =  [False])\n    df2_brasil.index = range(len(df2_brasil))# redefinindo os \u00edndices ap\u00f3s colocar em ordem alfab\u00e9tica \n    data_ultimo_dia = df2_brasil[df2_brasil['ObservationDate']==df2_brasil['ObservationDate'].max()].copy()\n\n    data_ultimo_dia['ObservationDate']+=1\n    data_ultimo_dia['Primeira derivada']=df2_brasil['Active cases'][df2_brasil.index[0]]-df2_brasil['Active cases'][df2_brasil.index[1]]\n    data_ultimo_dia['Segunda derivada'] = df2_brasil['Primeira derivada'][df2_brasil.index[0]]-df2_brasil['Primeira derivada'][df2_brasil.index[1]]\n    \n    df2_brasil= df2_brasil.append(data_ultimo_dia)\n    df2_brasil=df2_brasil.sort_values(['ObservationDate'],ascending =  [False])\n    df2_brasil.index = range(len(df2_brasil))# redefinindo os \u00edndices ap\u00f3s colocar em ordem alfab\u00e9tica \n    \n    df2_brasil.loc[0,'Media primeira derivada'] = df2_brasil['Media primeira derivada'].rolling(window_size).mean()[3] \n    df2_brasil.loc[0,'Media segunda derivada'] = df2_brasil['Media segunda derivada'].rolling(window_size).mean()[3] \n    df2_brasil.loc[0,'Valor anterior']= df2_brasil['Active cases'][1]\n    df2= df2.append(df2_brasil.iloc[0])\n    # valores_maximos = df2.max(axis=0)\n    df2=df2.sort_values(['Country\/Region','ObservationDate'],ascending =  [True ,False])\n    df2.index = range(len(df2))# redefinindo os \u00edndices ap\u00f3s colocar em ordem alfab\u00e9tica \n    \n\n    \n    \n    \n    \n    #Normalize the data again\n    x_teste= df2[['ObservationDate','Media primeira derivada','Media segunda derivada', 'Valor anterior','Primeira derivada', 'Segunda derivada']]\n    \n    scaler = preprocessing.MinMaxScaler()\n    scaled_df = scaler.fit_transform(x_teste)\n    scaled_df = pd.DataFrame(scaled_df, columns=['ObservationDate', 'Media primeira derivada'\\\n                                             , 'Media segunda derivada','Valor anterior'\\\n                                                 ,'Primeira derivada', 'Segunda derivada'])\n    x_teste=scaled_df\n    x_teste_brasil = x_teste[df2['Country\/Region']=='Brazil']\n\n    # Forecast results\n    prev=lin2.predict(poly.fit_transform(pd.DataFrame( x_teste_brasil.head(1)) ))\n    index_change = df2[df2['Country\/Region']=='Brazil'].index[0]\n    df2.loc[index_change,'Active cases'] = prev[0]\n# df2[df2['Active cases']<0]=0\n\n\n# Plot the results\n    \ninteirar = lambda t: int(t)\ny_pred = np.array([inteirar(xi) for xi in df2_brasil['Active cases']])\ny_pred = y_pred[::-1]\n\n\ndef date_linspace(start, end, steps):\n  delta = (end - start) \/ steps\n  increments = range(0, steps) * np.array([delta]*steps)\n  return start + increments\n\n\n\ndata_first_case_brasil = date(2020,2,26)\nlabel_days = date_linspace(data_first_case_brasil ,date(today.year,today.month+2,today.day),len(y_pred))\nlabel_days = [str(str(i).split('-')[2]+'\/'+str(i).split('-')[1]) for i in label_days]\n\n\naaa=[label_days[i] for i in np.arange(0, len(label_days), 16)]\n\ny_pred = pd.Series(y_pred)\ny_pred.index = label_days\n\n\n\nfig, ax = plt.subplots()\nax.plot(y_pred)\nax = plt.gca()\nlocs, labels=plt.xticks()\nlocs = [locs[i] for i in np.arange(0, len(locs), 16)]\nnew_xticks=aaa\nplt.xticks(locs,new_xticks, rotation=45)\nplt.xlabel('Date')\nplt.ylabel('Number of active cases')\nplt.title('Forecast of corona virus in Brazil')\nplt.grid('True')\nplt.show()\n","ea15742a":"y_pred[dayx+1:].head(numero_dias_previsto)\n","34777fe6":" ## Features extraction\n\nAs can be seen in the image above, the time since the incidence of the first case has a great influence on the dynamics of the virus. Another interesting variable is the growth rate of the virus, that is, the derivative. The second derivative is also an interesting factor, because when it is positive it indicates that we are still on the exponential part of the infection curve. Soon these two variables will be used as feactures, as well as the time in days since the first case in the country.\n","afdf1fac":"Given the six input features (first derivative, second derivative, moving average of the first derivative, moving average of the second derivative, value of the previous day and number of days), a second degree polynomial regression was performed to try to predict the number of cases active in Brazil","df7a211a":"To understand a little more about the dynamics of infection with the corona virus, it is important to assess what has already happened in some countries that have suffered the impact of the virus before and are ahead of the contagion curve. \n\nthe following image shows the curve of active (infected - recovered - dead) cases of the corona virus in several countries from the first day of contagion.\n\nAnalyzing this image, we can see that the curve starts to grow slowly in the first days, then goes through an exponential growth, until it reaches a peak and then decreases.","c212e2c7":"# <font color='black'>Using derivative and second derivative for forecast corona virus <\/font>\n\n","a32ccba3":"Another way to see the forecast at each data:","bf6fdaaf":"# ## Dinamics of some countries and Brazil\n\n","9de4c8a0":"To mitigate the effect of large daily fluctuations caused by unforeseen external factors, the moving average of the first and second derivative was calculated, and this average as a feature as well.","3c53b070":"The value of infections from the previous day is also a useful feature, as it can help indicate the point on the curve of the predicted day","e7f6d90d":"This notebook is an attempt to forecast the incidence of corona virus in Brazil during April and May. The data used to create this data model are availabre at https:\/\/www.kaggle.com\/sudalairajkumar\/novel-corona-virus-2019-dataset. The project can be found in https:\/\/github.com\/lucasarielrc\/Corona-virus"}}