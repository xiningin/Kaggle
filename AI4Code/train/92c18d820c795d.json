{"cell_type":{"1f03a736":"code","0c6dbe00":"code","c3743154":"code","030f7eea":"code","91adde48":"code","a730772c":"code","591d7024":"code","2bf5796f":"code","cad7a89f":"code","640e87f0":"code","b8743cb1":"markdown","a5526a00":"markdown","a0de6ba7":"markdown"},"source":{"1f03a736":"import numpy as np\nimport tensorflow as tf\nimport math\nimport pandas as pd\nimport glob\nimport os","0c6dbe00":"def read_submission_file(input_path, alpha=0.5):\n    files_paths = glob.glob(input_path + 'test\/*\/*\/*\/*')\n    mapping = {}\n    for path in files_paths:\n        mapping[path.split('\/')[-1].split('.')[0]] = path\n    df = pd.read_csv(input_path + 'sample_submission.csv')\n    df['path'] = df['id'].map(mapping)\n    df['label'] = -1\n    df['prob'] = -1\n    return df\n\ndef read_train_file(input_path, alpha=0.5):\n    files_paths = glob.glob(input_path + 'train\/*\/*\/*\/*')\n    mapping = {}\n    for path in files_paths:\n        mapping[path.split('\/')[-1].split('.')[0]] = path\n    df = pd.read_csv(input_path + 'train.csv')\n    df['path'] = df['id'].map(mapping)\n    \n    counts_map = dict(df.groupby('landmark_id')['path'].agg(lambda x: len(x)))\n    df['counts'] = df['landmark_id'].map(counts_map)\n    df['prob'] = ((1\/df.counts**alpha) \/ (1\/df.counts**alpha).max()).astype(np.float32)\n    uniques = df['landmark_id'].unique()\n    df['label'] = df['landmark_id'].map(dict(zip(uniques, range(len(uniques)))))\n    return df, dict(zip(range(len(uniques)), uniques))\n\n\nsubmission_df = read_submission_file('..\/input\/landmark-recognition-2020\/')\ntrain_df, mapping = read_train_file('..\/input\/landmark-recognition-2020\/')\n","c3743154":"train_df","030f7eea":"dataset = train_df.iloc[:1000,:]","91adde48":"# The following functions can be used to convert a value to a type compatible\n# with tf.Example.\n\ndef _bytes_feature(value):\n  \"\"\"Returns a bytes_list from a string \/ byte.\"\"\"\n  if isinstance(value, type(tf.constant(0))):\n    value = value.numpy() # BytesList won't unpack a string from an EagerTensor.\n  return tf.train.Feature(bytes_list=tf.train.BytesList(value=[value]))\n\ndef _float_feature(value):\n  \"\"\"Returns a float_list from a float \/ double.\"\"\"\n  return tf.train.Feature(float_list=tf.train.FloatList(value=[value]))\n\ndef _int64_feature(value):\n  \"\"\"Returns an int64_list from a bool \/ enum \/ int \/ uint.\"\"\"\n  return tf.train.Feature(int64_list=tf.train.Int64List(value=[value]))\n","a730772c":"# Create a dictionary with features that may be relevant.\ndef image_example(image_string, label):\n  image_shape = tf.image.decode_jpeg(image_string).shape\n\n  feature = {\n      'height': _int64_feature(image_shape[0]),\n      'width': _int64_feature(image_shape[1]),\n      'depth': _int64_feature(image_shape[2]),\n      'label': _int64_feature(label),\n      'image_raw': _bytes_feature(image_string),\n  }\n\n  return tf.train.Example(features=tf.train.Features(feature=feature))","591d7024":"# code for generating tfrecord file\nrecord_file = 'train00.tfrecords'\nwith tf.io.TFRecordWriter(record_file) as writer:\n  for i in range(len(dataset)):\n    path = dataset.path[dataset.index[i]]\n    label = dataset.label[dataset.index[i]]\n    image_string = tf.io.read_file(path)\n    tf_example = image_example(image_string, label)\n    writer.write(tf_example.SerializeToString())","2bf5796f":"def read_labeled_tfrecord(example):\n    tfrec_format = {\n    'height': tf.io.FixedLenFeature([], tf.int64),\n    'width': tf.io.FixedLenFeature([], tf.int64),\n    'depth': tf.io.FixedLenFeature([], tf.int64),\n    'label': tf.io.FixedLenFeature([], tf.int64),\n    'image_raw': tf.io.FixedLenFeature([], tf.string),\n        }\n    return tf.io.parse_single_example(example, tfrec_format)","cad7a89f":"ds = tf.data.TFRecordDataset('.\/train00.tfrecords')\nds = ds.map(read_labeled_tfrecord)","640e87f0":"import IPython.display as display\nfor feature in ds.take(3):\n  image_raw = feature['image_raw'].numpy()\n  display.display(display.Image(data=image_raw))","b8743cb1":"for simplicity only 1000 images are taken","a5526a00":"Tfrecord store the features height, width, depth, label, image","a0de6ba7":"**Reading the tfrecord files**"}}