{"cell_type":{"a4b612b8":"code","95b401f6":"code","66b73e9f":"code","47369182":"code","9e1d6b90":"code","d7bbd5f8":"code","bf0d04f0":"code","43ad7087":"code","0528f729":"code","4439a50e":"code","d083a985":"code","c09ddb36":"code","3d85cced":"code","c07da76a":"code","f043966b":"code","249af3d3":"code","4938ba9a":"code","6ca56ff4":"code","0bd9aaf3":"code","783a5deb":"code","08fc9cda":"code","61b92775":"code","0a68a5ef":"code","8dd4f285":"code","655d8cea":"code","3915f51f":"code","2a18c7dd":"code","df227c31":"code","af18f538":"code","cd5838e3":"code","6d6795a9":"code","56c83c19":"code","45dddb42":"code","4b1e12c6":"code","4091e645":"code","ade1431b":"code","95f222fa":"code","2515a54a":"code","e01b22bd":"markdown","a5097401":"markdown","5cffd746":"markdown","bbb6c4b6":"markdown","7cbfe8c0":"markdown","90b62cb7":"markdown","9a4f8731":"markdown"},"source":{"a4b612b8":"%reload_ext autoreload\n%autoreload 2\n%matplotlib inline","95b401f6":"import os\nimport numpy as np\nimport pandas as pd\nimport fastai.vision as fa # \u8f7d\u5165\u5de5\u5177\nfrom fastai.metrics import error_rate  # \u8865\u5145\u5de5\u5177\n\nprint(os.listdir())","66b73e9f":"# batch_size\uff0c\u7531\u4e8e\u6211\u4eec\u7684\u5185\u5b58\u4e0d\u591f\uff0c\u6240\u4ee5\u6211\u4eec\u8bbe\u7f6e\u4e3a8\nbs=32","47369182":"# \u4e0b\u8f7d\u6570\u636e\u5305\uff0c\u5e76\u751f\u6210\u6570\u636e\u6587\u4ef6\u5730\u5740\npath=fa.untar_data(fa.URLs.PETS)\npath","9e1d6b90":"# \u67e5\u770b\u6570\u636e\u6587\u4ef6\u5185\u5bb9\npath.ls()","d7bbd5f8":"# \u8fdb\u4e00\u6b65\u67e5\u627e\u76f4\u63a5\u7684\u6570\u636e\u6587\u4ef6\npath_anno=path\/'annotations'\npath_img=path\/'images'","bf0d04f0":"# \u5c06\u6240\u6709\u6570\u636e\u56fe\u7247\u505a\u6210\u5730\u5740path\uff0c\u653e\u5728\u4e00\u4e2alist\u4e2d\nfnames=fa.get_image_files(path_img)\nfnames[:5]","43ad7087":"# \u8bbe\u7f6e\u968f\u673a\u6570\u79cd\u5b50\uff0c\u4fdd\u8bc1\u6bcf\u6b21\u7684\u7ed3\u679c\u662f\u4e00\u6837\u7684\nnp.random.seed(2)\n# \u4f7f\u7528\u6b63\u5219\u8868\u8fbe\u5f0f\u4ece\u6587\u4ef6\u4e2d\u63d0\u53d6\u56fe\u7247\u7684label\u6807\u6ce8\npat=r'\/([^\/]+)_\\d+.jpg$'","0528f729":"# \u751f\u6210\u6570\u636e\u96c6\uff0c\u5e76\u4e14\u5bf9\u56fe\u7247\u505a\u6807\u51c6\u5316\u5904\u7406\ndata=fa.ImageDataBunch.from_name_re(path=path_img,fnames=fnames,pat=pat,\n                                ds_tfms=fa.get_transforms(),\n                                 size=224,bs=bs).normalize(fa.imagenet_stats)","4439a50e":"# \u663e\u793a\u56fe\u7247\uff0c\u663e\u793a\u7684\u56fe\u7247\u662f\u968f\u673a\u7684\ndata.show_batch(rows=3,figsize=(7,6))","d083a985":"# \u6253\u5370\u7c7b\u522b\u540d\u79f0\nprint(data.classes)\n# \u663e\u793a\u7c7b\u522b\u7684\u4e2a\u6570\uff0c\u6709\u4e24\u79cd\u65b9\u6cd5\u53ef\u4ee5\u663e\u793a\nlen(data.classes),data.c","c09ddb36":"# \u5e8a\u67b6\u4e00\u4e2acnn\u6a21\u578b\uff0c\u4f7f\u7528data\u4f5c\u4e3a\u6570\u636e\uff0c\u4e0b\u8f7d\u548c\u8c03\u7528resnet34\uff0c\n# \u4f5c\u4e3a\u6a21\u578b\u7684\u53c2\u6570\u548c\u6846\u67b6\uff0c\u5e76\u8f93\u51fa\u9519\u8bef\u7387\nlearn=fa.create_cnn(data=data,base_arch=fa.models.resnet34,metrics=error_rate)","3d85cced":"# \u67e5\u770b\u6a21\u578b\u7684\u5185\u90e8\u7ed3\u6784\nlearn.model","c07da76a":"# \u8bad\u7ec3\u6a21\u578b\nlearn.fit_one_cycle(1)","f043966b":"# \u4fdd\u5b58\u6a21\u578b\uff0c\u5c06\u6a21\u578b\u4fdd\u5b58\u5728\u5de5\u4f5c\u76ee\u5f55\u4e0b\nlearn.save(\"\/kaggle\/working\/stage-1\")","249af3d3":"# \u6211\u4eec\u67e5\u770b\u6a21\u578b\u7684\u8bad\u7ec3\u7ed3\u679c\nintrep=fa.ClassificationInterpretation.from_learner(learn)\nlosses,idxs=intrep.top_losses()\n\nlen(data.valid_ds)==len(losses)==len(idxs)","4938ba9a":"# \u8f93\u51fa\u8bad\u7ec3\u635f\u5931\u524d9\u4e2a\uff0c\u8bf4\u660e\u8fd9\u4e9b\u79cd\u7c7b\u6bd4\u8f83\u96be\u5206\u7c7b\nintrep.plot_top_losses(9,figsize=(15,11))","6ca56ff4":"# \u6211\u4eec\u53ef\u4ee5\u901a\u8fc7doc\u67e5\u770b\u67d0\u4e2a\u51fd\u6570\u7684\u6e90\u4ee3\u7801\nfa.doc(intrep.plot_top_losses)","0bd9aaf3":"# \u6211\u4eec\u53ef\u4ee5\u8f93\u51fa\u9a8c\u8bc1\u6837\u672c\u7684\u6df7\u6dc6\u77e9\u9635\nintrep.plot_confusion_matrix(figsize=(12,12),dpi=60)\n# \u6211\u4eec\u53ef\u4ee5\u53d1\u73b0\u8bad\u7ec3\u4e2d\u7684\u635f\u5931\u8d8a\u9ad8\uff0c\u5728\u6df7\u6dc6\u77e9\u9635\u4e2d\u5c31\u8d8a\u5bb9\u6613\u5206\u7c7b\u9519\u8bef","783a5deb":"# \u6211\u4eec\u8f93\u51fa\u6700\u5bb9\u6613\u5206\u7c7b\u9519\u8bef\u7684\u51e0\u4e2a\u7c7b\n# \u5206\u7c7b\u9519\u8bef\u7684\u6570\u91cf\u5927\u4e8e2\nintrep.most_confused(min_val=2)","08fc9cda":"# \u65e2\u7136\u6a21\u578b\u8bad\u7ec3\u6b63\u5e38\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u5bf9\u6a21\u578b\u8fdb\u884c\u89e3\u51bb\uff0c\u4f7f\u7528\u66f4\u591a\u5c42\u8fdb\u884c\u8bad\u7ec3\nlearn.unfreeze()","61b92775":"# \u4f7f\u7528\u66f4\u591a\u5c42\u8fdb\u884c\u8bad\u7ec3\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u6548\u679c\u53cd\u800c\u53d8\u5dee\u4e86\nlearn.fit_one_cycle(1)","0a68a5ef":"# \u8f7d\u5165\u6a21\u578b\nlearn.load(\"\/kaggle\/working\/stage-1\")","8dd4f285":"# \u83b7\u5f97\u6a21\u578b\u7684\u5b66\u4e60\u7387\nlearn.lr_find()","655d8cea":"# \u6211\u4eec\u5bf9\u6a21\u578b\u7684\u5b66\u4e60\u7387\u8fdb\u884c\u753b\u56fe\nlearn.recorder.plot()","3915f51f":"# \u6211\u4eec\u9009\u62e9\u5b66\u4e60\u7387\u5b501e-6\u548c1e-4\u4e4b\u95f4\uff0c\u91cd\u65b0\u8bad\u7ec3\u6a21\u578b\nlearn.unfreeze()\nlearn.fit_one_cycle(cyc_len=1,max_lr=slice(1e-6,1e-4))","2a18c7dd":"# \u4fdd\u5b58\u6a21\u578b\nlearn.save(\"\/kaggle\/working\/stage-1\")","df227c31":"learn50=fa.create_cnn(data=data,base_arch=fa.models.resnet50,metrics=error_rate)","af18f538":"# \u67e5\u770b\u6a21\u578b\u7ed3\u6784\nlearn50.model","cd5838e3":"# \u5bf9\u4e8e\u6a21\u578b\u8fdb\u884c\u8bad\u7ec3\nlearn50.fit_one_cycle(1)","6d6795a9":"# \u4fdd\u5b58\u6a21\u578b\nlearn50.save(\"kaggle\/working\/stage-2\")","56c83c19":"# \u67e5\u770b\u6df7\u6dc6\u77e9\u9635\ninterp=fa.ClassificationInterpretation.from_learner(learn50)","45dddb42":"# \u8f93\u51fal\u635f\u5931\u6700\u9ad8\u7684\u524d9\u4e2a\u6837\u672c\ninterp.plot_top_losses(9,figsize=(15,11))","4b1e12c6":"# \u753b\u51fa\u6837\u672c\u7684\u6df7\u6dc6\u77e9\u9635\ninterp.plot_confusion_matrix(figsize=(12,12))","4091e645":"# \u83b7\u5f97\u5b66\u4e60\u7387\u66f2\u7ebf\nlearn50.lr_find()","ade1431b":"learn50.recorder.plot()","95f222fa":"# \u89e3\u51bb\u3001\u4f7f\u7528\u5b66\u4e60\u7387\u66f2\u7ebf\nlearn50.unfreeze()\nlearn50.fit_one_cycle(1,max_lr=slice(1e-6,1e-4)) # \u8fd9\u91cc\u7684\u6548\u679c\u6bd4\u4e4b\u524d\u7684\u6a21\u578b\u8981\u597d","2515a54a":"# \u4fdd\u5b58\u6a21\u578b\nlearn50.save(\"\/kaggle\/working\/stage-2\")","e01b22bd":"## \u6211\u4eec\u5c1d\u8bd5\u4f7f\u7528resnet50","a5097401":"\u6211\u4eec\u7684\u6570\u636e\u670937\u79cd\u732b\u72d7=12\u79cd\u732b+25\u79cd\u72d7\uff0c\u6211\u4eec\u7684\u6a21\u578b\u7684\u76ee\u6807\u662f\u533a\u5206\u8fd937\u79cd\u4e0d\u540c\u7c7b\u522b\u7684\u732b\u72d7\u3002","5cffd746":"## \u719f\u6089\u4f60\u7684\u6570\u636e","bbb6c4b6":"## \u8bad\u7ec3\u6210\u679c","7cbfe8c0":"## \u89e3\u51bb\u3001\u5fae\u8c03\u3001\u5b66\u4e60\u7387","90b62cb7":"## \u8bad\u7ec3resnet34\u6a21\u578b","9a4f8731":"# \u8bc6\u522b\u4f60\u7684\u5ba0\u7269\uff1a37\u79cd\u732b"}}