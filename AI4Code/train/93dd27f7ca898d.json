{"cell_type":{"3a564f3a":"code","1bf3e1f9":"code","b2298e3c":"code","7f29477a":"code","1c29a828":"code","934b4cd0":"code","dbe33bd5":"code","2c7d5ad2":"code","60d7774c":"code","ce1a4539":"code","83deb0f1":"code","75ba8cf6":"code","fa285c96":"code","077286d9":"code","327cd500":"code","68ff72d5":"code","0f19751c":"code","5e35f1b8":"code","251eaf52":"code","1c5b1b5b":"code","d698a888":"code","fdf3363e":"code","2b3e6754":"code","c7dd700a":"code","a1e16317":"code","49f386ee":"code","f9f1d415":"code","6fa44885":"code","e07d02fa":"code","3e25b9e4":"code","b14708a3":"code","731e5871":"code","04119137":"markdown","ba129d4d":"markdown","273b1dfe":"markdown","b6ecaaff":"markdown","7158a38d":"markdown","d014f697":"markdown","5bf5d857":"markdown","41f08bfd":"markdown","922b331e":"markdown","e9a53476":"markdown","bdb6d794":"markdown","9d6ee0b4":"markdown","79490ee9":"markdown","03ac2fce":"markdown","fce62ef8":"markdown","76a5b2b5":"markdown","fd502fce":"markdown","81d2b064":"markdown","4e8107f9":"markdown","945d2453":"markdown","9e87bc78":"markdown","018a2c53":"markdown","4997f469":"markdown","7c531e21":"markdown","97fb8ef8":"markdown","8463c89c":"markdown","01dcfaf0":"markdown"},"source":{"3a564f3a":"import os\n\nimport numpy as np\nimport pandas as pd\nimport matplotlib.pyplot as plt\nimport seaborn as sns\n\nfrom sklearn.model_selection import StratifiedKFold\nfrom sklearn.model_selection import cross_val_score\nfrom sklearn.linear_model import LogisticRegression","1bf3e1f9":"data_dir = '..\/input\/google-cloud-ncaa-march-madness-2020-division-1-mens-tournament\/MDataFiles_Stage1\/'","b2298e3c":"team = pd.read_csv(data_dir + 'MTeams.csv')\n\nprint(team.shape)\ndisplay(team.head(3))\ndisplay(team.describe().transpose())","7f29477a":"season = pd.read_csv(data_dir + 'MSeasons.csv')\n\nprint(season.shape)\ndisplay(season.head(3))\ndisplay(season.describe().transpose())","1c29a828":"# format date\nseason['DayZero'] = pd.to_datetime(season['DayZero'])\ndisplay(season[['DayZero']].describe())","934b4cd0":"seed = pd.read_csv(data_dir + 'MNCAATourneySeeds.csv')\n\nprint(seed.shape)\ndisplay(seed.head(3))\ndisplay(seed.describe().transpose())","dbe33bd5":"season_result = pd.read_csv(data_dir + 'MRegularSeasonCompactResults.csv')\n\nprint(season_result.shape)\ndisplay(season_result.head(3))\ndisplay(season_result.describe().transpose()[['min', 'max']])","2c7d5ad2":"print('seasons without results:')\n\nseason.loc[~season['Season'].isin(season_result['Season'])]","60d7774c":"# add game date (we can use DayZero + DayNum to get the actual GameDate)\n\ndef apply_column_offset(df, date_col, offset_col):\n    \n    # source: https:\/\/stackoverflow.com\/questions\/48210892\/pandas-date-difference-using-column-as-offset\n    \n    df = df.copy()\n    df['NewDate'] = df[date_col].values.astype('datetime64[D]') + \\\n                    df[offset_col].add(1).values.astype('timedelta64[D]') - \\\n                    np.array([1], dtype='timedelta64[D]')\n    return df['NewDate']\n\nseason_result = pd.merge(season_result,\n                         season[['Season', 'DayZero']],\n                         on='Season',\n                         how='inner')\n            \nseason_result['GameDate'] = apply_column_offset(season_result, 'DayZero', 'DayNum')\nseason_result.head(3)","ce1a4539":"tourney_result = pd.read_csv(data_dir + 'MNCAATourneyCompactResults.csv')\n\nprint(tourney_result.shape)\ndisplay(tourney_result.head(3))\ndisplay(tourney_result.describe().transpose()[['min', 'max']])","83deb0f1":"print('seasons without results:')\n\nseason.loc[~season['Season'].isin(tourney_result['Season'])]","75ba8cf6":"# add game date (we can use DayZero + DayNum to get the actual GameDate)\n\ntourney_result = pd.merge(tourney_result,\n                          season[['Season', 'DayZero']],\n                          on='Season',\n                          how='inner')\n\ntourney_result['GameDate'] = apply_column_offset(tourney_result, 'DayZero', 'DayNum')\ntourney_result.head(3)","fa285c96":"sample_submission = pd.read_csv(data_dir + '..\/MSampleSubmissionStage1_2020.csv')\n\nprint(sample_submission.shape)\ndisplay(sample_submission.head())","077286d9":"sample_submission['Season'] = sample_submission['ID'].apply(lambda x: x.split('_')[0]).astype(int)\n\nsample_submission['Season'].value_counts().sort_index()","327cd500":"68 * 67 \/ 2","68ff72d5":"test = tourney_result.loc[tourney_result['Season'] >= 2015].copy()\n\nprint(test.shape)\ntest.head()","0f19751c":"def create_ID(row):\n    # source: https:\/\/www.kaggle.com\/catadanna\/delete-leaked-from-training-ncaam-ncaaw-stage1\n    if row['WTeamID'] < row['LTeamID']:\n        ID = str(row['Season'])+\"_\"+str(row['WTeamID'])+\"_\"+str(row['LTeamID'])\n    else:\n        ID = str(row['Season'])+\"_\"+str(row['LTeamID'])+\"_\"+str(row['WTeamID'])\n    return ID\n\ntest['ID'] = test.apply(create_ID, axis = 1)\ntest.head()","5e35f1b8":"print('number of rows with true labels (had actual games):')\nsample_submission['ID'].isin(test['ID']).sum()","251eaf52":"test = sample_submission.copy()\n\ntest['Team1'] = test['ID'].apply(lambda x: x.split('_')[1]).astype(int)\ntest['Team2'] = test['ID'].apply(lambda x: x.split('_')[2]).astype(int)\n\nprint(test.shape)\ntest.head()","1c5b1b5b":"# remove future data\ntrain = tourney_result.loc[tourney_result['Season'] < 2015].copy()\n\n# assign Team1 and Team2\nrename_dict = {\n    'WTeamID': 'Team1',\n    'LTeamID': 'Team2',\n    'WScore': 'Score1',\n    'LScore': 'Score2',\n    'WLoc': 'Loc1'\n}\ntrain = train.rename(columns=rename_dict)\n\n# target is 1 when Team1 is the winner\ntrain['target'] = 1\n\nprint(train.shape)\ntrain.head(3)","d698a888":"# add flipped train set for perspective of other team\n\ntrain_flipped = train.copy()\n\nrename_dict = {\n    'Team1': 'Team2',\n    'Team2': 'Team1',\n    'Score1': 'Score2',\n    'Score2': 'Score1'\n}\n\ntrain_flipped = train_flipped.rename(columns=rename_dict)\ntrain_flipped['target'] = 0\n\ntrain = pd.concat([train, train_flipped], sort=True)\nprint(train.shape)\ntrain.head(3)","fdf3363e":"print('train samples:', train.shape[0])\ntrain['target'].value_counts()","2b3e6754":"train_orig = train.copy()\ntrain = train_orig.copy()\nteam_nums = ['Team1', 'Team2']","c7dd700a":"# Team1 and Team2 seeds\n\nfor i, team_num in enumerate(team_nums):\n\n    train = pd.merge(train, \n                     seed, \n                     left_on=['Season', team_num ], \n                     right_on=['Season', 'TeamID'], \n                     how='left')\n\n    train['var_seed{}'.format(i + 1)] = train['Seed'].apply(lambda x: x[1:3]).astype(int)\n    train = train.drop(['Seed', 'TeamID'], axis=1)\n\nprint(train.shape)\ntrain.head()","a1e16317":"# do the same for test\n\nfor i, team_num in enumerate(team_nums):\n\n    test = pd.merge(test, \n                     seed, \n                     left_on=['Season', team_num ], \n                     right_on=['Season', 'TeamID'], \n                     how='left')\n\n    test['var_seed{}'.format(i + 1)] = test['Seed'].apply(lambda x: x[1:3]).astype(int)\n    test = test.drop(['Seed', 'TeamID'], axis=1)\n\nprint(test.shape)\ntest.head()","49f386ee":"# seed difference\n\ntrain['var_seed_diff'] = train['var_seed1'] - train['var_seed2']\ntrain.head()","f9f1d415":"# do the same for test\n\ntest['var_seed_diff'] = test['var_seed1'] - test['var_seed2']\ntest.head()","6fa44885":"features = [x for x in train.columns if 'var_' in x]\nfeatures","e07d02fa":"features = \\\n['var_seed1',\n # 'var_seed2',\n 'var_seed_diff'\n]\n\n# using either one of var_seed1 and var_seed_diff produces the same CV log_loss","3e25b9e4":"%%time\n\n# define model\nclf = LogisticRegression(random_state=2020)\n\n# define K-folds\nskf = StratifiedKFold(n_splits=5, \n                      shuffle=True, \n                      random_state=2020)\n\n# perform cross validation\nprint('training w\/ {} features...'.format(len(features)))\nscores = cross_val_score(clf,\n                         train[features],\n                         train['target'],\n                         scoring='neg_log_loss',\n                         cv=skf,\n                         n_jobs=2)\n\n# print roc_auc\nprint('\\n', scores, '\\n')\n\nprint(\"avg log_loss:\", round(-scores.mean(), 4))\nprint(\"std log_loss:\", round(scores.std(), 4,), '\\n')","b14708a3":"# fit on all train data\n\nclf.fit(train[features], train['target'])","731e5871":"submission = pd.DataFrame()\nsubmission['ID'] = test['ID']\nsubmission['pred'] = clf.predict_proba(test[features])[:, 1:]\n\nsubmission.to_csv('submission.csv', index=False)\n\nprint(submission.shape)\nsubmission.head()","04119137":"## Teams","ba129d4d":"# Create Submission","273b1dfe":"- __we have Seasons from 1985 to 2020__","b6ecaaff":"# Logistic Regression\n- here we apply train a simple Logistic Regresison model and evaluate via 5-fold cross validation","7158a38d":"- __not all TeamIDs have seed data (max TeamID 1467 from above)__","d014f697":"## Seed\n- we can use the Season and TeamId to extract Seed data from MNCAATourneySeeds.csv","5bf5d857":"## Sample Submission\n- let's see how many possible matchups there are per year","41f08bfd":"# NCAAM2020 - Logistic Regression Baseline [CV 0.55]","922b331e":"## Tourney Results","e9a53476":"## Seasons","bdb6d794":"- __the current tourney has no results yet of course__","9d6ee0b4":"## Import Libraries","79490ee9":"## Seeds","03ac2fce":"- we hope to get a log_loss close to 0.5533 in the LB (leaderboard)","fce62ef8":"- we have 335 tourney games since 2015","76a5b2b5":"In this notebook, I trained a baseline Logistic Regression model using seed data (seed number and seed difference) from tourney games before 2015. Before that, I explored the data a bit, simulated the test set, and prepared a train set (without leakage and has opposite team perspectives).\n\nReferences:\n- [Delete Leaked from Training NCAAM\/NCAAW - Stage1](https:\/\/www.kaggle.com\/catadanna\/delete-leaked-from-training-ncaam-ncaaw-stage1) by [Catadanna](https:\/\/www.kaggle.com\/catadanna)\n- [How to score 0 and why you should not do this](https:\/\/www.kaggle.com\/c\/google-cloud-ncaa-march-madness-2020-division-1-mens-tournament\/discussion\/131539) by [Roman](https:\/\/www.kaggle.com\/nroman)\n- [Jump Shot to Conclusions - March Madness EDA](https:\/\/www.kaggle.com\/headsortails\/jump-shot-to-conclusions-march-madness-eda) by [Heads or Tails](https:\/\/www.kaggle.com\/headsortails)","fd502fce":"As mentioned by [Roman](https:\/\/www.kaggle.com\/nroman) in [How to score 0 and why you should not do this](https:\/\/www.kaggle.com\/c\/google-cloud-ncaa-march-madness-2020-division-1-mens-tournament\/discussion\/131539**), only 335 rows in the test set matter as they are the only ones with true labels (had actual games).\n\nAll 335 tourney games since 2015 are in the test set, so that means that we can't use any data present since this time (except perhaps 2015 regular season data) if we don't want any leaks.","81d2b064":"- as mentioned in [data](https:\/\/www.kaggle.com\/c\/google-cloud-ncaa-march-madness-2020-division-1-mens-tournament\/data), each year has \"68\\*67\/2=2,278\" possible tourney matchups","4e8107f9":"- __we have TeamIDs from 1101 to 1467__\n- __we have D1Seasons from 1985 to 2020__","945d2453":"- __the current season has no results yet__","9e87bc78":"In [Data](http:\/\/https:\/\/www.kaggle.com\/c\/google-cloud-ncaa-march-madness-2020-division-1-mens-tournament\/data) > Data Section 1 file: MSampleSubmissionStage1.csv, it was mentioned that:\n\n\"However, our evaluation utility will automatically infer the winning percentage in the other direction, so a 47% prediction for Arizona to win also means a 53% prediction for Duke to win.\"\n\nTo simulate this in the train set, we can add a flipped train set (like in [Jump Shot to Conclusions - March Madness EDA](https:\/\/www.kaggle.com\/headsortails\/jump-shot-to-conclusions-march-madness-eda) > Baseline Model) for the perspective of the other team:","018a2c53":"# Feature Engineering","4997f469":"## Season Results","7c531e21":"# Explore Data\n- for now we only explore and use Section 1 - The Basics","97fb8ef8":"# Prepare Train Data\n- for this baseline I will only be using tourney (seed) data, so I will drop all data since 2015 to avoid leakage","8463c89c":"# Simulate Test Data\n- for tourney games since 2015, let's create game IDs with the same format in the sample submission and look at the actual matchups that happened","01dcfaf0":"# Test Submission\n- later on we can prepare the test data in the same way as the train data is prepared below, but for now I just used the sample submission"}}