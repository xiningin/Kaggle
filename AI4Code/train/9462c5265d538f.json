{"cell_type":{"e8253402":"code","23af8120":"code","edded10c":"code","fd19a6ab":"code","6e3e4ff0":"code","9d1ea313":"code","ee13cff2":"markdown","74efb88b":"markdown"},"source":{"e8253402":"import json\nimport numpy as np\nimport pandas as pd\nfrom tqdm.notebook import tqdm\n\nwith open('\/kaggle\/input\/scl-2021-da\/contacts.json') as f:\n    data = json.load(f)","23af8120":"df = pd.DataFrame(data)\ndf = df.replace('', np.NaN)\ndf","edded10c":"%%time\n\nemail_group = df.groupby('Email').Id.agg(lambda x: set(x))\nphone_group = df.groupby('Phone').Id.agg(lambda x: set(x))\norder_group = df.groupby('OrderId').Id.agg(lambda x: set(x))\n\nd = {i: set() for i in df.Id}\n\nfor ids in email_group:\n    for id in ids:\n        d[id] |= set(ids)\nfor ids in phone_group:\n    for id in ids:\n        d[id] |= set(ids)\nfor ids in order_group:\n    for id in ids:\n        d[id] |= set(ids)\n\n# Merge across groups again\nfor i in tqdm(range(3)):\n    for id, ids in d.items():\n        for id_ in list(ids):\n            d[id] |= d[id_]","fd19a6ab":"id_to_contact = df.set_index('Id').Contacts.to_dict()\n\ndef get_sum_contact(ids_set):\n    return sum([id_to_contact[id] for id in ids_set])","6e3e4ff0":"df['set'] = df.Id.apply(lambda x: d[x])\ndf['trace'] = df.set.apply(lambda x: '-'.join(map(str, sorted(list(x)))))\ndf['n_con'] = df.set.apply(lambda x: str(get_sum_contact(x)))\ndf['out'] = df.trace + ', ' + df.n_con\nout = df[['Id', 'out']]\nout.columns = ['ticket_id', 'ticket_trace\/contact']\nout","9d1ea313":"out.to_csv('out.csv', index=False)","ee13cff2":"## Group tickets","74efb88b":"## Replace empty string with NaN"}}