{"cell_type":{"d2729ac4":"code","661e9d51":"code","74892f28":"code","77d1678c":"code","860241ea":"code","8a0319b8":"code","53d025c0":"code","603e99c5":"code","eea96ffd":"code","34e106c1":"code","6af80203":"code","9d159348":"code","9269d8f3":"code","c83d0abc":"code","0048ec7c":"code","abbf5f62":"code","a09e97da":"code","f90bce00":"markdown","443a3998":"markdown"},"source":{"d2729ac4":"# This Python 3 environment comes with many helpful analytics libraries installed\n# It is defined by the kaggle\/python docker image: https:\/\/github.com\/kaggle\/docker-python\n# For example, here's several helpful packages to load in \n\nimport numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\n\n# Input data files are available in the \"..\/input\/\" directory.\n# For example, running this (by clicking run or pressing Shift+Enter) will list the files in the input directory\nimport os\nimport tensorflow as tf\nimport cv2\nimport matplotlib.pyplot as plt\n\n# Any results you write to the current directory are saved as output.","661e9d51":"df = pd.read_csv(\"..\/input\/severstal-steel-defect-detection\/train.csv\")\ndf[\"image_id\"] = df[\"ImageId_ClassId\"].apply(lambda val: val.split(\"_\")[0])\ndf[\"class_id\"] = df[\"ImageId_ClassId\"].apply(lambda val: val.split(\"_\")[1])\ndf = df.rename(columns={\"EncodedPixels\": \"encoded_pixels\"})\ndf = df[[\"image_id\", \"class_id\", \"encoded_pixels\"]]\n\n# compute test\/train split\nvals = np.random.uniform(0, 1, len(df))\ntrain_idx = vals < 0.8\nval_idx = vals >= 0.8\n\ndf[\"train\"] = False\ndf[\"train\"][train_idx] = True\n\ndf.head()","74892f28":"with_pixels = df.dropna()\nwith_pixels.head()","77d1678c":"filename, class_id = with_pixels.iloc[0].image_id, with_pixels.iloc[0].class_id\nprint(filename, class_id)","860241ea":"def compute_mask(row, shape):\n    width, height = shape\n    \n    mask = np.zeros(width * height, dtype=np.uint8)\n    pixels = np.array(list(map(int, row.encoded_pixels.split())))\n    mask_start = pixels[0::2]\n    mask_length = pixels[1::2]\n        \n    for s, l in zip(mask_start, mask_length):\n        mask[s:s + l] = 255\n        \n    mask = np.flipud(np.rot90(mask.reshape((height, width))))\n    return mask","8a0319b8":"def mask_to_image(mask):\n    return np.transpose(np.array([mask, mask, mask]), [1, 2, 0])","53d025c0":"!ls ..\/input\/severstal-steel-defect-detection\/\n","603e99c5":"def show_image(axis, filename, df, colours):\n    row_ids = np.where(df[\"image_id\"] == filename)[0]\n    if not row_ids.size:\n        raise ValueError(f\"Cannot find image {filename}\")\n        \n    assert len(row_ids) <= len(colours)\n    \n    \n    combined_image = None\n    for i, (row_id, colour) in enumerate(zip(row_ids, colours)):\n        row = df.iloc[row_id]\n        \n        filename = os.path.join(\"..\", \"input\", \"severstal-steel-defect-detection\", \"train_images\", row.image_id)\n        assert os.path.isfile(filename)\n\n        data = cv2.imread(filename)\n        data = cv2.cvtColor(data, cv2.COLOR_BGR2RGB)\n        if i == 0:\n            combined_image = data\n\n        if not isinstance(row.encoded_pixels, str):\n            continue    \n\n        width, height, _ = data.shape\n        \n        mask = compute_mask(row, (width, height))\n        \n        full_mask = np.array([\n            mask * colour[0],\n            mask * colour[1],\n            mask * colour[2],\n        ])\n        mask = np.transpose(full_mask, [1, 2, 0]).astype(np.uint8)\n        \n        combined_image = cv2.addWeighted(mask, 0.3, combined_image, 0.7, 0)\n    \n    axis.imshow(combined_image)\n    \ntest_filename = with_pixels.iloc[5].image_id\ncolours = [(1.0, 0.0, 0.0), (0.0, 1.0, 0.0), (0.0, 0.0, 1.0), (1.0, 0.0, 1.0)]\n\nfig, axis = plt.subplots(figsize=(22, 8))\nshow_image(axis, test_filename, df, colours)","eea96ffd":"!pip install git+https:\/\/github.com\/mindriot101\/Mask_RCNN","34e106c1":"from mrcnn.utils import Dataset\nfrom mrcnn.config import Config\nfrom mrcnn.model import MaskRCNN","6af80203":"class MyConfig(Config):\n#     BACKBONE = \"resnet50\"\n    NAME = \"steel\"\n    IMAGES_PER_GPU = 1\n    GPU_COUNT = 1\n    NUM_CLASSES = 1 + 4\n    STEPS_PER_EPOCH = 250\n    VALIDATION_STEPS = 10\n    \nmodelconfig = MyConfig()\nmodelconfig.display()","9d159348":"class MyDataset(Dataset):\n    \n    SHAPE = (1600, 256)\n    \n    def load_from(self, df):\n        self.df = df\n        \n        self.add_class(\"\", 1, \"class 1\")\n        self.add_class(\"\", 2, \"class 2\")       \n        self.add_class(\"\", 3, \"class 3\")\n        self.add_class(\"\", 4, \"class 4\")\n        \n        for image_id, g in df.groupby(\"image_id\"):\n            filename = os.path.join(\"..\", \"input\", \"severstal-steel-defect-detection\", \"train_images\", image_id)\n            assert os.path.isfile(filename)\n            self.add_image(\"\", image_id, filename)\n            \n    def load_mask(self, image_idx):\n        width, height = self.SHAPE\n        \n        image_id = self.image_info[image_idx][\"id\"]\n        \n        selection = self.df.query(\"image_id == @image_id\") \n        assert len(selection)\n    \n        total_mask = np.zeros((height, width, 4))\n        class_ids = []\n        for i, (_, row) in enumerate(selection.iterrows()):\n            if not isinstance(row.encoded_pixels, str):\n                continue\n\n            class_ids.append(int(row.class_id))\n\n            mask = np.zeros(width * height, dtype=np.uint8)\n            pixels = np.array(list(map(int, row.encoded_pixels.split())))\n            mask_start = pixels[0::2]\n            mask_length = pixels[1::2]\n\n            for s, l in zip(mask_start, mask_length):\n                mask[s:s + l] = 255\n\n            mask = np.flipud(np.rot90(mask.reshape((width, height))))\n            total_mask[:, :, i] = mask\n            \n        return total_mask, np.array([1, 2, 3, 4])","9269d8f3":"dataset_train = MyDataset()\ndataset_train.load_from(df[df.train == True])\ndataset_train.prepare()\n\ndataset_val = MyDataset()\ndataset_val.load_from(df[df.train == False])\ndataset_val.prepare()","c83d0abc":"def investigate_mask(idx):\n    mask, class_ids = dataset_train.load_mask(idx)\n    if not mask.any():\n        print(\"No regions found\")\n        return\n    \n    fig, axes = plt.subplots(len(class_ids), 1, figsize=(22, 8))\n    try:\n        axes = axes.ravel()\n    except AttributeError:\n        axes = [axes]\n    for i, (c, ax) in enumerate(zip(class_ids, axes)):\n        m = mask[:, :, i]\n        ax.imshow(m, cmap=\"gray\")\n        \n    \ninvestigate_mask(0)","0048ec7c":"!curl -LO https:\/\/github.com\/matterport\/Mask_RCNN\/releases\/download\/v2.0\/mask_rcnn_coco.h5","abbf5f62":"# Load the model\nconfig = tf.ConfigProto()\nconfig.gpu_options.allow_growth = True\nsession = tf.Session(config=config)\n\nsession.run(tf.global_variables_initializer())\nsession.run(tf.local_variables_initializer())\nmodel = MaskRCNN(mode=\"training\", config=modelconfig, model_dir=\"modeldir\")\nmodel.load_weights(\"mask_rcnn_coco.h5\", by_name=True, exclude=[\"mrcnn_bbox_fc\", \"mrcnn_class_logits\", \"mrcnn_mask\", \"mrcnn_bbox\"])","a09e97da":"%time model.train(dataset_train, dataset_val, epochs=40, layers=\"heads\", learning_rate=modelconfig.LEARNING_RATE)","f90bce00":"# Training","443a3998":"## Mask R-CNN model\n\nNow we construct the model based on the mrcnn package."}}