{"cell_type":{"23a6c7bb":"code","0fe15992":"code","43398c1e":"code","11314e55":"code","3e8cad7d":"code","3835ad27":"code","79f591f1":"code","eae02503":"code","fa20d900":"code","b897817e":"code","32d1e78a":"code","5ceeef92":"code","06e3390a":"code","56f45c6a":"code","11513389":"code","cb6ae653":"code","98e9cac6":"code","cf6a39bf":"code","f253e8b7":"code","a663537b":"code","9b25993c":"code","ae354b9f":"code","8aac980b":"code","b74e3f77":"code","8918a9a8":"code","ed09a092":"code","9071f278":"markdown","6a7866ae":"markdown","eeae744f":"markdown"},"source":{"23a6c7bb":"import pandas as pd\nimport numpy as np\nfrom typing import List\nfrom tqdm.notebook import tqdm\nfrom io import StringIO","0fe15992":"DIR = \"..\/input\/nfl-big-data-bowl-2022\"\ndf_games = pd.read_csv(f\"{DIR}\/games.csv\")\ndf_plays = pd.read_csv(f\"{DIR}\/plays.csv\")\ndf_players = pd.read_csv(f\"{DIR}\/players.csv\")\ndf_pff = pd.read_csv(f\"{DIR}\/PFFScoutingData.csv\")","43398c1e":"pff_jersey_cols = [\n    \"missedTackler\",\n    \"assistTackler\",\n    \"tackler\",\n    \"gunners\",\n    \"puntRushers\",\n    \"specialTeamsSafeties\",\n    \"vises\",\n]\npff_jersey_out_cols = [\n    \"gameId\",\n    \"playId\",\n    \"teamCode\",\n    \"jerseyNumber\",\n    \"role\",\n]\n\n\ndef split_jersey_list(raw: str, **kwargs) -> List[str]:\n    if pd.isna(raw):\n        return []\n    return raw.split(\"; \")\n\n\ndef get_jersey_part(raw: str, part: int, **kwargs) -> List[str]:\n    if pd.isna(raw):\n        return None\n    return raw.split(\" \")[part]\n\n\ndef get_pff_player_jerseys(df_pff: pd.DataFrame) -> pd.DataFrame:\n    df = df_pff.copy()\n    for col in pff_jersey_cols:\n        df[col] = df[col].apply(split_jersey_list)\n    dfs = []\n    for col in pff_jersey_cols:\n        df[\"role\"] = col\n        df_role = df.explode(col)\n        df_role[\"teamCode\"] = df_role[col].apply(get_jersey_part, args=(0,))\n        df_role[\"jerseyNumber\"] = df_role[col].apply(get_jersey_part, args=(1,))\n        df_role = df_role.dropna(subset=[\"teamCode\", \"jerseyNumber\"])\n        dfs.append(df_role[pff_jersey_out_cols])\n    df_all = pd.concat(dfs)\n    df_all[\"jerseyNumber\"] = df_all[\"jerseyNumber\"].astype(int)\n    return df_all","11314e55":"def get_team_code(row: pd.Series, **kwargs) -> str:\n    team = row[\"team\"]\n    if pd.isna(team) or team == \"football\":\n        return None\n    return row[team]\n\n\ndef augment_with_team_code(df: pd.DataFrame) -> pd.DataFrame:\n        df[\"jerseyNumber\"] = df[\"jerseyNumber\"].astype(float)\n        game_to_team_code = df_games \\\n            .rename(columns={\n                \"homeTeamAbbr\": \"home\",\n                \"visitorTeamAbbr\": \"away\",\n            }) \\\n            [[\"gameId\", \"home\", \"away\"]] \\\n            .set_index(\"gameId\")\n        df = df.join(game_to_team_code, on=[\"gameId\"])\n        with pd.option_context(\"mode.chained_assignment\", None):\n            df[\"teamCode\"] = df.apply(get_team_code, axis=\"columns\")\n        return df\n\n\ndef read_tracking_data(seasons: List[int], progress=False, **kwargs) -> pd.DataFrame:\n    readers = [\n        pd.read_csv(\n            f\"{DIR}\/tracking{season}.csv\",\n            iterator=True,\n            chunksize=10**5,\n            **kwargs\n        )\n        for season in\n        seasons\n    ]\n    \n    dfs = []\n    for i, reader in enumerate(readers):\n        progress_bar = tqdm(reader, desc=f\"{seasons[i]} Season\") if progress else reader\n        for chunk in progress_bar:\n            dfs.append(chunk)\n            \n    return pd.concat(dfs)","3e8cad7d":"SEASONS = [2018, 2019, 2020]\ntracking_cols = [\n    \"gameId\",\n    \"playId\",\n    \"team\",\n    \"jerseyNumber\",\n    \"nflId\",\n    \"displayName\",\n    \"position\",\n]","3835ad27":"df_tracking = read_tracking_data(\n    seasons=SEASONS,\n    progress=True,\n    usecols=tracking_cols\n).drop_duplicates().dropna()\nprint(f\"Tracking data contains {len(df_tracking):,d} player-play records.\\n\")\ndf_tracking.head()","79f591f1":"df_tracking_players = augment_with_team_code(df_tracking)\nprint(f\"Player data from tracking contains {len(df_tracking_players):,d} player-play records.\\n\")\ndf_tracking_players.head()","eae02503":"join_cols = [\n    \"gameId\",\n    \"playId\",\n    \"teamCode\",\n    \"jerseyNumber\"\n]\ndf_pff_players = get_pff_player_jerseys(df_pff)\ndf_pff_players_no_roles = df_pff_players.groupby(join_cols)\nprint(f\"PFF data contains {len(df_pff_players):,d} player-play-role records.\\n\")\nprint(f\"PFF data contains {len(df_pff_players_no_roles):,d} player-play records.\\n\")\ndf_pff_players.head()","fa20d900":"df_pff_track = df_pff_players.join(df_tracking_players.set_index(join_cols), on=join_cols)\ndf_pff_track_no_roles = df_pff_track.groupby(join_cols)\nprint(f\"Post-join, PFF player role data contains {len(df_pff_track):,d} player-play-role records.\\n\")\nprint(f\"Post-join, PFF player role data contains {len(df_pff_track_no_roles):,d} player-play records.\\n\")\ndf_pff_track.head()","b897817e":"play_keys = [\"gameId\", \"playId\"]\nplay_cols = play_keys + [\"specialTeamsPlayType\", \"specialTeamsResult\"]\ndf_pff_track_explosion = df_pff_track \\\n    [join_cols + [\"nflId\"]] \\\n    .drop_duplicates() \\\n    .groupby(join_cols) \\\n    .count() \\\n    .reset_index() \\\n    .join(df_plays[play_cols].set_index(play_keys), on=play_keys) \\\n    .rename(columns={ \"nflId\": \"tracking_matches\" }) \\\n    .query(\"tracking_matches > 1\") \\\n    .sort_values(by=\"tracking_matches\", ascending=False)\nprint(f\"Post-join, {len(df_pff_track_explosion):,d} player-play records had multiple tracking matches.\")\ndf_pff_track_explosion.head()","32d1e78a":"df_tracking \\\n    .query(\"team == 'away' and jerseyNumber == 44 and gameId == 2020092004 and playId == 279\")","5ceeef92":"df_missing_from_pff = df_pff_track[df_pff_track[\"nflId\"].isna()]\ndf_missing_from_pff = df_missing_from_pff.join(df_plays[play_cols].set_index(play_keys), on=play_keys)\nwith pd.option_context(\"mode.chained_assignment\", None):\n    df_missing_from_pff[\"season\"] = df_missing_from_pff[\"gameId\"].apply(lambda d: int(str(d)[:4]))\nprint(f\"{len(df_missing_from_pff):,d} PFF player-play-role records are not found in tracking data.\\n\")\ndf_missing_from_pff.head()","06e3390a":"df_tracking_players.query(\"gameId == 2019111711 and playId == 3643 and teamCode == 'LA' and jerseyNumber == 38\")","56f45c6a":"df_missing_from_pff.groupby(\"specialTeamsPlayType\")[\"playId\"].count().reset_index()","11513389":"df_missing_from_pff.groupby(\"season\")[\"playId\"].count().reset_index()","cb6ae653":"df_missing_from_pff.groupby([\"season\", \"specialTeamsPlayType\"])[\"playId\"].count().reset_index()","98e9cac6":"df_missing_from_pff.groupby([\"season\", \"specialTeamsPlayType\", \"role\"])[\"playId\"].count().reset_index()","cf6a39bf":"df_missing_from_pff.query(\"season == 2020 and specialTeamsPlayType == 'Punt' and role == 'vises'\")","f253e8b7":"df_missing_from_pff \\\n    .query(\"role == 'gunners' or role == 'vises'\") \\\n    .groupby([\"teamCode\", \"jerseyNumber\"]) \\\n    [\"playId\"].count() \\\n    .reset_index() \\\n    .rename(columns={ \"playId\": \"playCount\" }) \\\n    .sort_values(by=\"playCount\", ascending=False)","a663537b":"out_cols = [\"gameId\", \"playId\", \"teamCode\", \"jerseyNumber\", \"role\"]\nbuffer = StringIO()\ndf_missing_from_pff[out_cols].to_csv(buffer, index=False)","9b25993c":"buffer.getvalue()","ae354b9f":"raw_missing_players = 'gameId,playId,teamCode,jerseyNumber,role\\n2019111711,3643,LA,38,missedTackler\\n2018120600,1607,TEN,47,tackler\\n2018120600,1607,TEN,47,gunners\\n2018120600,3309,TEN,47,gunners\\n2018122400,542,OAK,14,gunners\\n2019090805,326,NYJ,25,gunners\\n2019090805,666,BUF,29,gunners\\n2019090805,1006,NYJ,23,gunners\\n2019090805,1006,NYJ,25,gunners\\n2019090805,1159,BUF,29,gunners\\n2019090805,1436,NYJ,25,gunners\\n2019090805,1802,NYJ,25,gunners\\n2019090805,2441,NYJ,25,gunners\\n2019090805,3298,NYJ,25,gunners\\n2019090805,3724,NYJ,25,gunners\\n2019090805,4435,BUF,29,gunners\\n2018093011,1761,NO,27,puntRushers\\n2019090805,4435,NYJ,23,puntRushers\\n2019112400,3811,ATL,55,puntRushers\\n2020091312,3370,DAL,59,puntRushers\\n2020091312,3822,DAL,59,puntRushers\\n2020092004,279,BUF,40,puntRushers\\n2020092004,1033,BUF,40,puntRushers\\n2020092004,1353,BUF,40,puntRushers\\n2020092004,1862,BUF,40,puntRushers\\n2020092004,3716,BUF,40,puntRushers\\n2020092708,1811,IND,33,puntRushers\\n2020092708,2190,IND,33,puntRushers\\n2020092708,2556,IND,33,puntRushers\\n2020092708,2665,NYJ,37,puntRushers\\n2020092708,3050,IND,33,puntRushers\\n2020092708,3271,NYJ,37,puntRushers\\n2020092711,2619,DEN,91,puntRushers\\n2020092711,3538,DEN,91,puntRushers\\n2018090903,3713,MIA,30,specialTeamsSafeties\\n2018091613,778,NYG,23,specialTeamsSafeties\\n2018091613,1035,NYG,23,specialTeamsSafeties\\n2018091613,1575,NYG,23,specialTeamsSafeties\\n2018102100,3461,TEN,25,specialTeamsSafeties\\n2019090805,2219,BUF,29,specialTeamsSafeties\\n2019090805,2481,BUF,29,specialTeamsSafeties\\n2019090805,3125,BUF,29,specialTeamsSafeties\\n2019090805,3551,BUF,29,specialTeamsSafeties\\n2019090805,4017,BUF,29,specialTeamsSafeties\\n2019091507,36,SEA,24,specialTeamsSafeties\\n2019091507,1491,SEA,24,specialTeamsSafeties\\n2019091507,2703,SEA,24,specialTeamsSafeties\\n2019091507,3074,SEA,24,specialTeamsSafeties\\n2019091507,3732,SEA,24,specialTeamsSafeties\\n2019111711,54,LA,38,specialTeamsSafeties\\n2019111711,1153,LA,38,specialTeamsSafeties\\n2019111711,1663,LA,38,specialTeamsSafeties\\n2019111711,3643,LA,38,specialTeamsSafeties\\n2020092708,3513,IND,33,specialTeamsSafeties\\n2020100400,40,CAR,20,specialTeamsSafeties\\n2020100400,613,CAR,20,specialTeamsSafeties\\n2020100400,939,CAR,20,specialTeamsSafeties\\n2018090903,1257,MIA,30,vises\\n2018090903,3163,MIA,30,vises\\n2018091613,2608,NYG,23,vises\\n2018120600,1699,TEN,47,vises\\n2018122400,744,OAK,14,vises\\n2018122400,1634,OAK,14,vises\\n2018122400,2467,OAK,14,vises\\n2019090805,1159,NYJ,25,vises\\n2019090805,4435,NYJ,25,vises\\n2019091507,115,SEA,24,vises\\n2019091507,315,SEA,24,vises\\n2019091507,786,SEA,24,vises\\n2019091507,1571,SEA,24,vises\\n2019100700,3613,CLE,25,vises\\n2019111711,1240,LA,38,vises\\n2019111711,2587,LA,38,vises\\n2019111711,2829,LA,38,vises\\n2019111711,3159,LA,38,vises\\n2019111711,3382,LA,38,vises\\n2020100400,169,CAR,20,vises\\n2020100400,698,CAR,20,vises\\n2020100400,1096,CAR,20,vises\\n'\npd.read_csv(StringIO(raw_missing_players))","8aac980b":"raw_pff_patches = 'role,pffJersey,trackingJersey\\ntackler,TEN 47,TEN 46\\nmissedTackler,LA 38,LA 21\\ngunners,TEN 47,TEN 46\\ngunners,OAK 14,OAK 38\\ngunners,NYJ 25,NYJ 40\\ngunners,BUF 29,BUF 36\\ngunners,NYJ 23,NYJ 37\\nvises,CAR 20,CAR 41\\nvises,CLE 25,CLE 35\\nvises,LA 38,LA 21\\nvises,MIA 30,MIA 23\\nvises,NYG 23,NYG 37\\nvises,NYJ 25,NYJ 40\\nvises,BUF 29,BUF 36\\nvises,OAK 14,OAK 38\\nvises,SEA 24,SEA 8\\nvises,TEN 47,TEN 46\\npuntRushers,ATL 55,ATL 62\\npuntRushers,DAL 59,DAL 53\\npuntRushers,DEN 91,DEN 58\\npuntRushers,IND 33,IND 36\\npuntRushers,NO 27,NO 36\\npuntRushers,NYJ 23,NYJ 37\\npuntRushers,NYJ 37,NYJ 43\\nspecialTeamsSafeties,BUF 29,BUF 36\\nspecialTeamsSafeties,CAR 20,CAR 41\\nspecialTeamsSafeties,IND 33,IND 36\\nspecialTeamsSafeties,LA 38,LA 21\\nspecialTeamsSafeties,MIA 30,MIA 23\\nspecialTeamsSafeties,NYG 23,NYG 37\\nspecialTeamsSafeties,SEA 24,SEA 8\\nspecialTeamsSafeties,TEN 25,TEN 41\\n'\ndf_pff_patches = pd.read_csv(StringIO(raw_pff_patches))\ndf_pff_patches.head()","b74e3f77":"def apply_pff_patches(df_pff: pd.DataFrame, df_patches: pd.DataFrame) -> pd.DataFrame:\n    df_out = df_pff.copy()\n    for _, patch in df_patches.iterrows():\n        role = patch[\"role\"]\n        old_jersey = patch[\"pffJersey\"]\n        new_jersey = patch[\"trackingJersey\"]\n        df_out[role] = np.where(\n            df_out[role].str.contains(old_jersey),\n            df_out[role].str.replace(old_jersey, new_jersey),\n            df_out[role]\n        )\n    return df_out\n\n\ndef get_tracking_jersey_patches(df: pd.DataFrame) -> pd.Series:\n    return np.where(\n        (\n            (df[\"gameId\"] == 2020092004)\n            & (df[\"team\"] == \"away\")\n            & (df[\"nflId\"] == 40657)\n        ),\n        40,\n        df[\"jerseyNumber\"]\n    )","8918a9a8":"df_pff_patched = apply_pff_patches(df_pff, df_pff_patches)","ed09a092":"df_tracking[\"jerseyNumber\"] = get_tracking_jersey_patches(df_tracking)","9071f278":"# Patches","6a7866ae":"# PFF Players Missing From Tracking Data\n\nWhile reconciling the PFF data and tracking data, I found two problems:\n\n1. PFF data lists jersey numbers that do not exist in the tracking data for the corresponding play\n2. Tracking data has one game where two teammates have the same jersey number on the same plays\n\nThis notebook identifies those cases and provides [patches](#patches) to fix the source data.\n\nThis data cleaning operation will not cover whether the PFF annotations are valid or not, only cover the cases where the PFF jersey number cannot be conclusively matched to a single jersey number in the tracking data.\n\nI used [this notebook](https:\/\/www.kaggle.com\/vingkan\/finding-missing-players-2021-12-31) to manually view each of the affected plays and determine the correct jersey number present in the tracking data.\n\nFrom looking at the data, here are some possible causes for the mismatches:\n\n- Human error in recording the jersey number\n- Players who changed their jersey number during the season (and NGS and PFF have different ways of choosing)\n\nIn all the examples I looked at, each **missing player** had the same jersey number in the tracking data across all their plays.","eeae744f":"## Raw PFF Patches\n\n```\nrole,pffJersey,trackingJersey\\ntackler,TEN 47,TEN 46\\nmissedTackler,LA 38,LA 21\\ngunners,TEN 47,TEN 46\\ngunners,OAK 14,OAK 38\\ngunners,NYJ 25,NYJ 40\\ngunners,BUF 29,BUF 36\\ngunners,NYJ 23,NYJ 37\\nvises,CAR 20,CAR 41\\nvises,CLE 25,CLE 35\\nvises,LA 38,LA 21\\nvises,MIA 30,MIA 23\\nvises,NYG 23,NYG 37\\nvises,NYJ 25,NYJ 40\\nvises,BUF 29,BUF 36\\nvises,OAK 14,OAK 38\\nvises,SEA 24,SEA 8\\nvises,TEN 47,TEN 46\\npuntRushers,ATL 55,ATL 62\\npuntRushers,DAL 59,DAL 53\\npuntRushers,DEN 91,DEN 58\\npuntRushers,IND 33,IND 36\\npuntRushers,NO 27,NO 36\\npuntRushers,NYJ 23,NYJ 37\\npuntRushers,NYJ 37,NYJ 43\\nspecialTeamsSafeties,BUF 29,BUF 36\\nspecialTeamsSafeties,CAR 20,CAR 41\\nspecialTeamsSafeties,IND 33,IND 36\\nspecialTeamsSafeties,LA 38,LA 21\\nspecialTeamsSafeties,MIA 30,MIA 23\\nspecialTeamsSafeties,NYG 23,NYG 37\\nspecialTeamsSafeties,SEA 24,SEA 8\\nspecialTeamsSafeties,TEN 25,TEN 41\\n\n```\n\n## Tracking Data Patch\n\nIn the 2020 tracking data, both Deon Lacey and Tyler Matakevich on the Buffalo Bills have jersey number 44. In that game, Matakevich was 44 and Lacey should be number 40.\n\n```\ngameId = 2020092004\nteam = away\nnflId = 40657\njerseyNumber = 40 (corrected)\n```"}}