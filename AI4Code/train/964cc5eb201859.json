{"cell_type":{"70514f77":"code","846896d6":"code","6ff8d399":"code","e4c54b1e":"code","a76d879a":"code","6dee91f2":"code","80186be6":"code","558139f5":"code","8c49035c":"code","1f5865d1":"code","183c454f":"markdown","df407fbe":"markdown","3e6cf2e5":"markdown","a688808b":"markdown","7527398b":"markdown","497343a4":"markdown","dd721294":"markdown"},"source":{"70514f77":"import numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)","846896d6":"# Set your own project id here\nPROJECT_ID = 'kmiki-kaggle'\nfrom google.cloud import bigquery\nbigquery_client = bigquery.Client(project=PROJECT_ID)\n#from google.cloud import storage\n#storage_client = storage.Client(project=PROJECT_ID)\n#from google.cloud import automl_v1beta1 as automl\n#automl_client = automl.AutoMlClient()","6ff8d399":"\n%%bigquery --project $PROJECT_ID\nSELECT\n*\nFROM\n`kaggleworkshops.google_analytics_sample.train`\nLIMIT 5","e4c54b1e":"%%bigquery --project $PROJECT_ID\nSELECT\n*\nFROM\n`kaggleworkshops.google_analytics_sample.test`\nLIMIT 5","a76d879a":"%%bigquery --project $PROJECT_ID\nCREATE OR REPLACE MODEL bqmlretail.logreg_sample\nTRANSFORM(\n  LOWER(country) country_lower,\n  totalPageviews,\n  addedToCart\n)\nOPTIONS(\n  model_type='logistic_reg', \n  INPUT_LABEL_COLS=[\"addedToCart\"]) AS\nSELECT \n  country,\n  totalPageViews,\n  addedToCart\nFROM\n  `kaggleworkshops.google_analytics_sample.train`\nWHERE date BETWEEN TIMESTAMP(\"2016-08-01\")\n  AND TIMESTAMP(\"2016-08-31\")","6dee91f2":"sqlquery = \"\"\"\nCREATE OR REPLACE MODEL bqmlretail.logreg_sample\nTRANSFORM(\n  LOWER(country) country_lower,\n  totalPageviews,\n  addedToCart\n)\nOPTIONS(\n  model_type='logistic_reg', \n  INPUT_LABEL_COLS=[\"addedToCart\"]) AS\nSELECT \n  country,\n  totalPageViews,\n  addedToCart\nFROM\n  `kaggleworkshops.google_analytics_sample.train`\nWHERE date BETWEEN TIMESTAMP(\"2016-08-01\")\n  AND TIMESTAMP(\"2016-08-31\")\n\"\"\"\n\njob_config = bigquery.QueryJobConfig()\nbigquery_client.query(sqlquery, job_config=job_config)  # Make an API request. ","80186be6":"#List models\ndataset_id = \"bqmlretail\"\nmodels = bigquery_client.list_models(dataset_id)\nprint(\"Listing Trained BigQuery ML Models:\")\nprint([\"{}.{}\".format(model.dataset_id, model.model_id) for model in models])","558139f5":"%%bigquery pred --project $PROJECT_ID\n\nSELECT\n  sessionId, \n  prob as addedToCart\nFROM\n  ML.PREDICT(MODEL bqmlretail.logreg_sample, ## replace model name\n    (\n    SELECT \n      CONCAT(fullVisitorId, CAST(visitStartTime as string)) as sessionId, \n      *\n    FROM\n    `kaggleworkshops.google_analytics_sample.test`\n  )),\nUNNEST(predicted_addedToCart_probs)\nWHERE label = 1","8c49035c":"## Check results in dataframe\npred.head()","1f5865d1":"## Save predictions as CSV\npred.to_csv(\"logregsample.csv\", index=False)\n!ls","183c454f":"\u30ce\u30fc\u30c8\u30d6\u30c3\u30af\u53f3\u4e0a\u306e[Data]\u3092\u958b\u304d\u3001CSV\u30d5\u30a1\u30a4\u30eb\u306b\u30ab\u30fc\u30bd\u30eb\u3092\u5408\u308f\u305b\u30013\u3064\u306e\u30c9\u30c3\u30c8\u3092\u30af\u30ea\u30c3\u30af\u3057\u3066\u3001\u30d5\u30a1\u30a4\u30eb\u3092\u30b3\u30f3\u30d4\u30e5\u30fc\u30bf\u30fc\u306b\u30c0\u30a6\u30f3\u30ed\u30fc\u30c9\u3057\u307e\u3059\u3002\n\n\u6b21\u306b\u3001[\u9001\u4fe1]\u30da\u30fc\u30b8\u304b\u3089\u4e88\u6e2c\u3092\u9001\u4fe1\u3057\u307e\u3059\u3002","df407fbe":"ML.PREDICT\u306b\u3088\u308b\u4e88\u6e2c","3e6cf2e5":"\u30c6\u30b9\u30c8\u30c7\u30fc\u30bf\u78ba\u8a8d","a688808b":"\u30e2\u30c7\u30eb\u306e\u975e\u540c\u671f\u30c8\u30ec\u30fc\u30cb\u30f3\u30b0","7527398b":"\u63d0\u51fa\u30d5\u30a1\u30a4\u30eb\u751f\u6210","497343a4":"\u30c8\u30ec\u30fc\u30cb\u30f3\u30b0\u30c7\u30fc\u30bf\u78ba\u8a8d","dd721294":"\u30c8\u30ec\u30fc\u30cb\u30f3\u30b0\u304c\u5b8c\u4e86\u3057\u3066\u3044\u308b\u304b\u78ba\u8a8d"}}