{"cell_type":{"88951f98":"code","9f75d476":"code","4168d679":"code","42e6f948":"code","317c1960":"code","f63bd9e4":"code","0ff0ddd1":"code","23e6ee89":"code","596510cc":"code","15c57f68":"code","24923e7d":"code","63756c62":"markdown","c717fc6b":"markdown","c93e7ddb":"markdown","68ae3f6a":"markdown","51a50a5e":"markdown","3cadd2c4":"markdown","412275f9":"markdown","8dd1765f":"markdown","60302428":"markdown","914edd6d":"markdown"},"source":{"88951f98":"import os\nimport numpy as np\nimport pandas as pd\nimport xgboost as xgb\nimport collections\nimport seaborn as sns\nfrom xgboost import DMatrix\nimport matplotlib.pyplot as plt\nfrom xgboost import plot_importance, plot_tree\nfrom sklearn.metrics import mean_squared_error\nfrom sklearn.preprocessing import MinMaxScaler\nfrom sklearn.model_selection import train_test_split, GridSearchCV\nfrom sklearn.metrics import confusion_matrix, recall_score\nfrom sklearn.metrics import cohen_kappa_score\nimport lightgbm as lgb\nfrom sklearn.metrics import accuracy_score\nfrom tqdm import tqdm\nfrom scipy import signal\nimport matplotlib.pyplot as plt\nimport random\nimport numpy as np\nfrom scipy.stats import zscore\nfrom statistics import mean, mode\n# \u30c1\u30e3\u30fc\u30c8\u7528\u8a2d\u5b9a\n# setting for chart\nimport plotly as py\nimport plotly.io as pio\nimport plotly.graph_objects as go\nfrom plotly.subplots import make_subplots\nfrom plotly.offline import download_plotlyjs, init_notebook_mode, plot, iplot\nfrom warnings import simplefilter\nsimplefilter(action='ignore', category=FutureWarning)\nsimplefilter(action='ignore', category=DeprecationWarning)\n\ninit_notebook_mode(connected=True)\nlayout=go.Layout(paper_bgcolor='rgba(0,0,0,0)', plot_bgcolor='rgba(250,250,250,0.8)')\nfig = go.Figure(layout=layout)\ntemplated_fig = pio.to_templated(fig)\npio.templates['my_template'] = templated_fig.layout.template\npio.templates.default = 'my_template'","9f75d476":"def sma_and_flag(df):\n    for num in ['5', '10', '15', '30']:\n        # \u79fb\u52d5\u5e73\u5747\u7dda\u3068\u79fb\u52d5\u6a19\u6e96\u504f\u5dee\n        # moving average and std of it\n        df['SMA_' + num] = df['Close'].rolling(int(num)).mean().shift()\n        df['SMA_' + num + '_std'] = df['Close'].rolling(int(num)).std().shift()\n        col_name = 'SMA_' + num + '_sub'\n        today_col_name = 'flag_today_sma_' + num\n        yesterday_col_name = 'flag_yesterday_sma_' + num\n        df[col_name] = df['Close'].rolling(int(num)).mean().shift()\n        df.loc[df[col_name] < df['Close'], today_col_name] = 1\n        df.loc[df[col_name] >= df['Close'], today_col_name] = 0\n        df[yesterday_col_name] = df[today_col_name].shift(1)\n        # \u30d5\u30e9\u30b0\u3092\u4f5c\u6210\n        # make flag\n        df.loc[(df[yesterday_col_name] == 0) & (df[today_col_name] == 1), \"flag_sma_under_\" + num] = 1\n        df.loc[~((df[yesterday_col_name] == 0) & (df[today_col_name] == 1)), \"flag_sma_under_\" + num] = 0\n        df.loc[(df[yesterday_col_name] == 1) & (df[today_col_name] == 0), \"flag_sma_over_\" + num] = 1\n        df.loc[~((df[yesterday_col_name] == 1) & (df[today_col_name] == 0)), \"flag_sma_over_\" + num] = 0\n        df = df.drop([col_name, yesterday_col_name, today_col_name], 1)\n    up_flag = {'5' : 0, '10': 0, '15' : 0, '30' : 0}\n    down_flag = {'5' : 0, '10': 0, '15' : 0, '30' : 0}\n    # \u30d5\u30e9\u30b0\u304b\u3089\u7279\u5b9a\u306e\u8ddd\u96e2\u306b\u3042\u308b\u304b\u30c1\u30a7\u30c3\u30af\n    # check distance from flag\n    for i in range(len(df)):\n        for num in ['5', '10', '15', '30']:\n            up_column = \"up_flag_distance_\" + num\n            down_column = \"down_flag_distance_\" + num\n            df.loc[i, up_column] = 0\n            df.loc[i, down_column] = 0\n            if up_flag[num] > int(num):\n                up_flag[num] = 0\n                df.loc[i, \"up_flag_distance_\" + num] = 0\n            elif up_flag[num] > 0:\n                df.loc[i, \"up_flag_distance_\" + num] = up_flag[num]\n                up_flag[num] += 1\n\n            if down_flag[num] > int(num):\n                down_flag[num] = 0\n                df.loc[i, \"down_flag_distance_\" + num] = 0\n            elif down_flag[num] > 0:\n                df.loc[i, \"down_flag_distance_\" + num] = down_flag[num]\n                down_flag[num] += 1\n\n            if df.loc[i, \"flag_sma_under_\" + num] == 1:\n                df.loc[i, \"down_flag_distance_\" + num] = 1\n                down_flag[num] = 2\n            if df.loc[i, \"flag_sma_over_\" + num] == 1:\n                df.loc[i, \"up_flag_distance_\" + num] = 1\n                up_flag[num] = 2\n    for num in ['5', '10', '15', '30']:\n        df = df.drop([\"flag_sma_over_\" + num, \"flag_sma_under_\" + num], 1)\n    return df","4168d679":"def relative_strength_idx(df, close_column = \"Close\", n=14):\n    close = df[close_column]\n    delta = close.diff()\n    delta = delta[1:]\n    pricesUp = delta.copy()\n    pricesDown = delta.copy()\n    pricesUp[pricesUp < 0] = 0\n    pricesDown[pricesDown > 0] = 0\n    rollUp = pricesUp.rolling(n).mean()\n    rollDown = pricesDown.abs().rolling(n).mean()\n    rs = rollUp \/ rollDown\n    rsi = 100.0 - (100.0 \/ (1.0 + rs))\n    return rsi","42e6f948":"def wt( data ):\n    widths = np.arange(1, 100)\n    return signal.cwt( data, signal.ricker, widths )","317c1960":"def change_rate(df):\n    # \u8a55\u4fa1\u306b\u7d42\u5024\u306e\u5909\u5316\u7387\u3092\u4f7f\u3046\u305f\u3081\n    # qualtile([0.2, 0.4, 0.6, 0.8])\u3067\u95be\u5024\u3092\u6c7a\u5b9a\n    # \u5927\u304d\u306a\u30d7\u30e9\u30b9\u30922\u3068\u3057\u3066\u3001\u5c0f\u3055\u306a\u30d7\u30e9\u30b9\u30921 \u2192\u3000\u5927\u304d\u306a\u30de\u30a4\u30ca\u30b9\u3092-2\n    \n    # objective variable is change rate of close\n    # devide change rate to label by quantile\n    # big plus is 2 and small plus is 1 ... bug minus is -2\n    df['Change_rate'] = df['Close'].pct_change() \/ df['SMA_30_std']\n    divide = df.loc[:2345]['Change_rate'].quantile([0, 0.2, 0.4, 0.6, 0.8, 1.0])\n    # 0.4%\u306f\u3067\u304b\u3044, 0.1%\u304c\n    df.loc[(df['Change_rate'] > divide[0.4]) & (df['Change_rate'] < divide[0.6]), 'Change_label'] = 0\n    df.loc[(df['Change_rate'] > divide[0.4]) & (df['Change_rate'] < divide[0.6]), 'weight'] = 1\n    df.loc[(df['Change_rate'] >= divide[0.2]) & (df['Change_rate'] <= divide[0.4]), 'Change_label'] = -1\n    df.loc[(df['Change_rate'] >= divide[0.2]) & (df['Change_rate'] <= divide[0.4]), 'weight'] = 1.2\n    df.loc[df['Change_rate'] < divide[0.2], 'Change_label'] = -2\n    df.loc[df['Change_rate'] < divide[0.2], 'weight'] = 1.5\n    df.loc[(df['Change_rate'] <= divide[0.8]) & (df['Change_rate'] >= divide[0.6]), 'Change_label'] = 1\n    df.loc[(df['Change_rate'] <= divide[0.8]) & (df['Change_rate'] >= divide[0.6]), 'weight'] = 1.2\n    df.loc[df['Change_rate'] > divide[0.8], 'Change_label'] = 2\n    df.loc[df['Change_rate'] > divide[0.8], 'weight'] = 1.5\n    df = df.reset_index()\n    return df.drop('index', 1)","f63bd9e4":"pairs = [['MACD', 'MACD_signal'], ['SMA_25', 'SMA_75'], ['SMA_25', 'SMA_200'], ['SMA_75', 'SMA_200']]\ndef flag_features(df):\n    EMA_12 = pd.Series(df['Close'].ewm(span=12, min_periods=12).mean())\n    EMA_26 = pd.Series(df['Close'].ewm(span=26, min_periods=26).mean())\n    df['MACD'] = pd.Series(EMA_12 - EMA_26)\n    df['MACD_signal'] = pd.Series(df.MACD.ewm(span=9, min_periods=9).mean())\n    df['SMA_25'] = df['Close'].rolling(int(25)).mean().shift()\n    df['SMA_75'] = df['Close'].rolling(int(75)).mean().shift()\n    df['SMA_200'] = df['Close'].rolling(int(200)).mean().shift()\n    for column in ['MACD', 'MACD_signal', 'SMA_25', 'SMA_75', 'SMA_200']:\n        df[\"yesterday_\" + column]= df[column].shift()\n    for pair in pairs:\n        df = make_flag(df, pair[0], pair[1], True, 20)\n        df = make_flag(df, pair[1], pair[0], False, 20)\n    return df.drop(['yesterday_MACD', 'yesterday_MACD_signal', 'yesterday_SMA_25', 'yesterday_SMA_75', 'yesterday_SMA_200'], 1)\n\ndef make_flag(df, up_column, down_column, up, term):\n    if up:\n        direction = \"up\"\n    else:\n        direction = \"down\"\n    flag_column = \"up_\" + up_column + '_down_' + down_column + '_price_' + direction + '_flag'\n    count_column = \"flag_distance_up_is_\" + up_column + '_down_is_' + down_column + '_price_' + direction\n    df.loc[(df['yesterday_' + down_column] > df['yesterday_' + up_column]) & (df[down_column] < df[up_column]), flag_column] = 1\n    df.loc[~((df['yesterday_' + down_column] > df['yesterday_' + up_column]) & (df[down_column] < df[up_column])), flag_column] = 0\n    flag_distance = 0\n    for i in range(len(df)):\n        df.loc[i, count_column] = 0\n        if df.loc[i, flag_column] == 1:\n            df.loc[i, count_column] = 1\n            flag_distance = 2\n            continue\n        \n        if flag_distance > term:\n            flag_distance = 0\n        elif flag_distance > 0:\n            df.loc[i, count_column] = flag_distance\n            flag_distance += 1\n    return df.drop(flag_column, 1)","0ff0ddd1":"def ready_features(df, train = True):\n    # \u30c7\u30fc\u30bf\u306e\u8aad\u307f\u8fbc\u307f\n    # read csv and modify type of columns\n#     df['Date'] = pd.to_datetime(df['Date'])\n    df[\"Close\"] = df['Close'].astype(float)\n    for index_fund in index_funds:\n        df[index_fund+\"_Close\"] = df[index_fund+\"_Close\"].astype(float)\n    # \u6307\u6570\u5e73\u6ed1\u79fb\u52d5\u5e73\u5747\n    # Exponential Moving Average\n    # \u6307\u6570\u5e73\u6ed1\u79fb\u52d5\u5e73\u5747\u306e\u65e5\u672c\u8a9e\u306e\u8aac\u660e\u2193\n    # https:\/\/media-kojirokousi.com\/exponential-moving-average\/#:~:text=%E6%8C%87%E6%95%B0%E5%B9%B3%E6%BB%91%E7%A7%BB%E5%8B%95%E5%B9%B3%E5%9D%87%E7%B7%9A(EMA)%E3%81%AF%E3%80%81%E5%BE%93%E6%9D%A5%E3%81%AE,EMA%E3%81%A8%E5%91%BC%E3%81%B0%E3%82%8C%E3%81%BE%E3%81%99%E3%80%82\n    df['EMA_9'] = df['Close'].ewm(9).mean().shift()\n    df['EMA_9_std'] = df['Close'].ewm(9).std().shift()\n    # MACD\n    # MACD\u306e\u65e5\u672c\u8a9e\u306e\u8aac\u660e\u2193\n    # https:\/\/www.sevendata.co.jp\/shihyou\/technical\/macd.html\n    df = flag_features(df)\n    df['RSI'] = relative_strength_idx(df).fillna(0)\n    df = sma_and_flag(df)\n    df = change_rate(df)\n    #\u2193\u4ed6\u306e\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u30d5\u30a1\u30f3\u30c9\u306e\u30c7\u30fc\u30bf\u3082\u540c\u69d8\u306e\u7279\u5fb4\u91cf\u3092\u751f\u6210\u3057\u3066\u3044\u308b\n    #\u2193create same features from other index-fund data\n    for index_fund in index_funds:\n        close_column = index_fund+\"_Close\"\n        rsi_column = index_fund +\"_RSI\"\n        df[index_fund + '_EMA_9'] = df[close_column].ewm(9).mean().shift()\n        df[index_fund + '_EMA_9_std'] = df[close_column].ewm(9).std().shift()\n        EMA_12 = pd.Series(df[close_column].ewm(span=12, min_periods=12).mean())\n        EMA_26 = pd.Series(df[close_column].ewm(span=26, min_periods=26).mean())\n        df[rsi_column] = relative_strength_idx(df, close_column).fillna(0)\n        column_wave = wt(df[close_column])\n        for num in ['1', '2', '3', '5', '8', '10', '12','15', '30']:\n            df[close_column + '_wave_' + num] = column_wave[int(num)]\n        rsi_wave = wt(df[rsi_column])\n        for num in ['1', '2', '3', '5', '8', '10', '12','15', '30']:\n            df[rsi_column + '_wave_' + num] = rsi_wave[int(num)]\n\n    # wavelet\u89e3\u6790\n    # wavelet\n    for column in ['Close', 'RSI']:\n        column_wave = wt(df[column])\n        for num in ['1', '2', '3', '5', '8', '10', '12','15', '30', '45']:\n            df[column + '_wave_' + num] = column_wave[int(num)]\n    return df","23e6ee89":"def ready_data_for_train(df_for_ready, train = True):\n    # \u524d\u65e5\u306e\u30c7\u30fc\u30bf\u304b\u3089\u3001\u7fcc\u65e5\u306e\u7d42\u5024\u3092\u4e88\u6e2c\u3059\u308b\u305f\u3081\u3001Change_label, Change_rate, weight\u3092shift\u3057\u3066\u3044\u308b\u3002\n    # \u2193we would like to predict tommorow's movement\n    df_for_ready = df_for_ready.copy()\n    df_for_ready['Change_label'] = df_for_ready['Change_label'].shift(-1)\n    df_for_ready['Change_rate'] = df_for_ready['Change_rate'].shift(-1)\n    df_for_ready['weight'] = df_for_ready['weight'].shift(-1)\n#     if train:\n#         df_for_ready = df_for_ready[:-1]      # Because of shifting\n    df_for_ready[\"Change_label\"] = df_for_ready[\"Change_label\"].fillna(0).astype('int')\n    return df_for_ready","596510cc":"currency_hises = pd.read_csv(\"\/kaggle\/input\/new-his-data\/his_data.csv\", names=(\"Date\", \"JPY\", \"NZD\", \"AUD\", \"EUR\", \"GBP\", \"HKD\", \"BRL\", \"DKK\", \"INR\", \"CAD\", \"CHF\")).drop(0)\ncurrency_hises['Date'] = currency_hises['Date'].astype('string')\n# currency_hises['Date'] = currency_hises[\"Date\"].str[:4] + \"-\" + currency_hises[\"Date\"].str[4:6] + \"-\" + currency_hises[\"Date\"].str[6:8]\n# index_funds = ['N225', 'GSPC', 'EZU', 'GSPTSE', 'GDAXI', 'FCHI', 'EWQ', 'EWG', 'EWC', 'GCF', 'CLF']\nindex_funds = []\nfor index_fund in index_funds:\n    index_df = pd.read_csv(\"\/kaggle\/input\/stock-price-datas\/\" + index_fund + \".csv\", names=(\"Date\", \"Open\", \"High\", \"Low\", index_fund+\"_Close\", \"Adj Close\", \"Volume\")).drop(0)\n    index_df = index_df.drop([\"Open\", \"High\", \"Low\", \"Adj Close\", \"Volume\"], 1)\n    index_df[\"Date\"] = index_df[\"Date\"]\n    currency_hises = pd.merge(currency_hises, index_df, on=\"Date\", how='left')\n    if (index_fund != 'N225'):\n        currency_hises[index_fund+\"_Close\"] = currency_hises[index_fund+\"_Close\"].shift()\ncurrency_hises = currency_hises[1:]      # Because of shifting close price\ncurrency_hises = currency_hises.reset_index().drop(\"index\", 1)","15c57f68":"currencies = ['JPY', 'NZD', 'AUD', 'EUR', 'GBP', 'HKD', 'BRL', 'DKK', 'INR', 'CAD', 'CHF']\n# currencies = ['JPY']\nfor currency in tqdm(currencies):\n    df_for_currency = pd.DataFrame(columns = ['Date', 'Close'])\n    df_for_currency[\"Date\"] = currency_hises[\"Date\"]\n    df_for_currency[\"Close\"] = currency_hises[currency]\n    df_for_currency[\"Close\"] = zscore(df_for_currency['Close'].astype('float'))\n    for index_fund in index_funds:\n        df_for_currency[index_fund + \"_Close\"] = currency_hises[index_fund + \"_Close\"]\n    df_for_currency = ready_features(df_for_currency)\n    df_for_currency = ready_data_for_train(df_for_currency)\n    df_for_currency.to_csv(currency + \".csv\")","24923e7d":"# currencies = ['JPY', 'NZD', 'AUD', 'EUR', 'GBP', 'HKD', 'BRL', 'DKK', 'INR', 'CAD', 'CHF']\n# currencies = ['JPY']\n# currency_hises = pd.read_csv(\"\/kaggle\/input\/group3data\/his_data.csv\", names=(\"Date\", \"JPY\", \"NZD\", \"AUD\", \"EUR\", \"GBP\", \"HKD\", \"BRL\", \"DKK\", \"INR\", \"CAD\", \"CHF\")).drop(0)\n# new_record = currency_hises[-1:]\n# currency_hises = currency_hises[:-1]\n# currency_hises = currency_hises.append(new_record)\n# currency_hises['Date'] = currency_hises['Date'].astype('string')\n# currency_hises['Date'] = currency_hises[\"Date\"].str[:4] + \"-\" + currency_hises[\"Date\"].str[4:6] + \"-\" + currency_hises[\"Date\"].str[6:8]\n# # currency_hises.to_csv(\"his_data.csv\")\n# for currency in tqdm(currencies):\n#     df_for_currency = pd.DataFrame(columns = ['Date', 'Close'])\n#     df_for_currency[\"Date\"] = currency_hises[\"Date\"]\n#     df_for_currency[\"Close\"] = currency_hises[currency]\n#     df_for_currency[\"Close\"] = zscore(df_for_currency['Close'].astype('float'))\n#     df_for_currency = df_for_currency[-201:].reset_index().drop('index', 1)\n#     df_for_currency = ready_features(df_for_currency)\n#     df_for_currency = ready_data_for_train(df_for_currency, False)\n#     old_data = pd.read_csv('\/kaggle\/input\/train-feature\/' + currency + \".csv\", index_col=0)\n#     old_data = old_data.append(df_for_currency[-1:]).reset_index().drop('index', 1)\n#     old_data.to_csv(currency + \"2.csv\")","63756c62":"### MACD, MACD signal\u30d5\u30e9\u30b0\n- up signal \nmacd\u304csignal\u3092\u4e0b\u304b\u3089\u4e0a\u306b\u629c\u3044\u305f\u6642\nyesterday macd < macd signal && today macd > macd signal\n- down signal \nmacd\u304csignal\u3092\u4e0a\u304b\u3089\u4e0b\u306b\u629c\u3044\u305f\u6642\nyesterday macd > macd signal && today macd < macd signal","c717fc6b":"## ready features","c93e7ddb":"### make objective variable \/ \u76ee\u7684\u5909\u6570\u306b\u4f5c\u6210\nmake objective variable and assign weight based on objective variable(change label)  \n\u76ee\u7684\u95a2\u6570\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\u307e\u305f\u3001\u5909\u5316\u7387\u306b\u57fa\u3065\u3044\u3066\u5b66\u7fd2\u306e\u91cd\u307f\u4ed8\u3051\u3092\u884c\u3044\u307e\u3059\u3002\n\n#### weight\nbig change rate gives me big profit(or loss).  \nwe must focus on big change.  \nset heavy weight on big change.  \n\n\u5927\u304d\u306a\u5909\u5316\u306f\u5927\u304d\u306a\u5229\u76ca\u3084\u640d\u5931\u3092\u3082\u305f\u3089\u3059\u305f\u3081\u3001\u9593\u9055\u3048\u305f\u6642\u306e\u30ea\u30b9\u30af\u304c\u5927\u304d\u3044\u3067\u3059\u3002  \n\u3088\u3063\u3066\u3001\u5927\u304d\u306a\u5909\u5316\u307b\u3069\u4e88\u6e2c\u6027\u80fd\u304c\u3042\u304c\u308b\u3088\u3046\u306b\u91cd\u307f\u4ed8\u3051\u3092\u3057\u307e\u3059\u3002","68ae3f6a":"### wavelet analysis \/ \u30a6\u30a7\u30fc\u30d6\u30ec\u30c3\u30c8\u89e3\u6790\nWavelet coefficient represents periodic nature of time-series data.  \n\u30a6\u30a7\u30fc\u30d6\u30ec\u30c3\u30c8\u4fc2\u6570\u306f\u6642\u7cfb\u5217\u30c7\u30fc\u30bf\u306e\u5468\u671f\u7684\u306a\u6027\u8cea\u3092\u8868\u3057\u3066\u3044\u307e\u3059\u3002","51a50a5e":"### RSI \/ \u76f8\u5bfe\u529b\u6307\u6570\n\u76f8\u5bfe\u7684\u306b\u4e0a\u6607\u65b9\u5411\u306a\u306e\u304b\u4e0b\u964d\u65b9\u5411\u306a\u306e\u304b\u3092\u793a\u3059\u6307\u6570\u3067\u3059\u3002  \nrelative strength of up or down","3cadd2c4":"### \u30d5\u30e9\u30b0\u306e\u4f5c\u6210 \/ make flag\n\u30b4\u30fc\u30eb\u30c7\u30f3\u30af\u30ed\u30b9\u306e\u7c21\u6613\u7248\u3067\u3059  \nsimple version of golden cross  ","412275f9":"## \u4e00\u884c\u4e00\u884c\u8ffd\u52a0\u3059\u308b\u5834\u5408","8dd1765f":"# creating features for currency price prediction \n![](https:\/\/miro.medium.com\/max\/2560\/0*R5pC0bAlYxH_nTlF.jpg)","60302428":"### ready simple features \/ \u5358\u7d14\u306a\u8aac\u660e\u5909\u6570\u306e\u4f5c\u6210\nMACD and EMA... is very easy to create.\nIn this method we make easy features.\n\n\u7c21\u5358\u306b\u4f5c\u6210\u3067\u304d\u308b\u7279\u5fb4\u91cf\u306f\u3053\u3053\u3067\u4f5c\u6210\u3057\u3066\u3044\u307e\u3059\u3002","914edd6d":"## \u30c7\u30fc\u30bf\u30a4\u30f3\u30dd\u30fc\u30c8\/import"}}