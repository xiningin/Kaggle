{"cell_type":{"3e42056b":"code","4ba7787b":"code","040e5a71":"code","12b45276":"code","52658454":"code","6e506f30":"code","429f5a76":"markdown","d3db64ee":"markdown","c7a9aabd":"markdown","29e2778a":"markdown","ab57b289":"markdown"},"source":{"3e42056b":"import numpy as np\nimport pandas as pd\nimport plotly.express as px\nimport IPython\nimport glob\nimport plotly.graph_objects as go\nfrom plotly.subplots import make_subplots\ndsp = IPython.display.display\n\n\ndef book_path(stock_id):\n    return f'..\/input\/optiver-realized-volatility-prediction\/book_train.parquet\/stock_id={stock_id}'\n\ndef open_book(stock_id, time_id=None):\n    '''Opens the 2nd order order-books'''\n    book = pd.read_parquet(book_path(stock_id))\n    book.loc[:,'stock_id'] = stock_id\n    book = book.sort_values(['time_id', 'seconds_in_bucket'])\n    if time_id is None:\n        return book\n    return book[book['time_id']==time_id]\n\ndef trade_path(stock_id):\n    return f'..\/input\/optiver-realized-volatility-prediction\/trade_train.parquet\/stock_id={stock_id}'\n\ndef open_trades(stock_id, time_id=None):\n    '''Open the trade books'''\n    book = pd.read_parquet(trade_path(stock_id))\n    book.loc[:,'stock_id'] = stock_id\n    if time_id is None:\n        return book\n    return book[book['time_id']==time_id]\n\n\ndef set_wap(df):\n    df.loc[:, 'wap'] = (\n        (  df['bid_price1'] * df['ask_size1']\n         + df['ask_price1'] * df['bid_size1'])\n        \/ (df['bid_size1'] + df['ask_size1']))\n\ndef set_log_return(df):\n    if 'wap' not in df.columns:\n        df.set_wap()\n    df.loc[:, 'log_return'] = np.log(df['wap']).diff()\n    df = df[~df['log_return'].isnull()]\n\ndef log_return_volatility(df):\n    if 'log_return' not in df.columns:\n        df.set_log_return()\n    return df['log_return'].volatility()\n\ndef volatility(serie):\n    return np.sqrt(np.sum(serie ** 2))\n\ndef get_time_id(df, time_id):\n    return df[df.time_id == time_id]\n\ndef get_third(df, n):\n    third = 600 \/ 3\n    return df[(df.seconds_in_bucket > n * third)\n              & (df.seconds_in_bucket < (n + 1) * third)]\n\n\ndef get_merge(book, trades, time_id):\n    _b = book.get_tId(time_id).copy().sort_values(['stock_id', 'time_id', 'seconds_in_bucket'])\n    _t = trades.get_tId(time_id).copy().sort_values(['stock_id', 'time_id', 'seconds_in_bucket'])\n    _b.set_log_return()\n    df = pd.concat([_t, _b])\n    return df\n\n\npd.DataFrame.get_third = get_third\npd.DataFrame.get_tId = get_time_id\npd.DataFrame.set_wap = set_wap\npd.DataFrame.set_log_return = set_log_return\npd.DataFrame.log_return_volatility = log_return_volatility\npd.Series.volatility = volatility","4ba7787b":"data_path = '..\/input\/optiver-realized-volatility-prediction\/'\ntrain_stock_ids = sorted([int(p.split('=')[1])\n                         for p in glob.glob(\n                             data_path + '\/book_train.parquet\/*')])\n\ntest_stock_ids = sorted([int(p.split('=')[1])\n                         for p in glob.glob(\n                             data_path + '\/book_test.parquet\/*')])\n\n# These are the values to predict (future 10 minute volatility)\nfut_vol = pd.read_csv('..\/input\/optiver-realized-volatility-prediction\/train.csv')\nfut_vol = fut_vol.set_index(['stock_id', 'time_id'])\ndsp(fut_vol.head())","040e5a71":"for stock_id in range(5,7):\n\n    book = open_book(stock_id)\n    trades = open_trades(stock_id)\n    time_ids = book.time_id.unique()[:10]\n\n\n    # Create general figure\n    fig = make_subplots(rows=3, cols=1,\n                        row_heights=[.15, .7, .15],\n                        vertical_spacing = 0.02,\n                        shared_yaxes=False,\n                        shared_xaxes=True,\n                        specs=[[{\"secondary_y\": False}], [{\"secondary_y\": False}], [{\"secondary_y\": True}]] )\n\n    # Add visible and hidden traces to figure\n    for time_id in time_ids:\n        df = get_merge(book, trades, time_id)\n        fig.add_trace(  # TOP GRAPH\n            go.Scatter(x=df.seconds_in_bucket, y=df['ask_size1'],\n                       name='ask_size1', fill='tozeroy',\n                       line=dict(color=('rgba(0, 200, 0, 0.3)')),\n                       visible=False),\n            row=1, col=1)\n        fig.add_trace(\n            go.Scatter(x=df.seconds_in_bucket, y=df['ask_size1'] + df['ask_size2'],\n                       name='ask_size1&2', fill='tonexty',\n                       line=dict(color=('rgba(0, 200, 0, 0.3)')),\n                       visible=False),\n            row=1, col=1)\n        fig.add_trace(\n            go.Scatter(x=df.seconds_in_bucket, y=-df['bid_size1'],\n                       name='bid_size1', fill='tozeroy',\n                       line=dict(color=('rgba(200, 0, 0, 0.3)')),\n                       visible=False),\n            row=1, col=1)\n        fig.add_trace(\n            go.Scatter(x=df.seconds_in_bucket, y=-df['bid_size1'] - df['bid_size2'],\n                       name='bid_size1&2', fill='tonexty',\n                       line=dict(color=('rgba(200, 0, 0, 0.3)')),\n                       visible=False),\n            row=1, col=1)\n        fig.add_trace(  # MIDDLE GRAPH\n            go.Scatter(x=df.seconds_in_bucket, y=df['ask_price1'], name='ask_price1',\n                       line=dict(color=('rgba(0, 100, 0, .9)')),\n                       visible=False),\n            row=2, col=1)\n        fig.add_trace(\n            go.Scatter(x=df.seconds_in_bucket, y=df['ask_price2'], name='ask_price2',\n                       line=dict(color=('rgba(0, 200, 0, .9)')),\n                       visible=False),\n            row=2, col=1)\n        fig.add_trace(\n            go.Scatter(x=df.seconds_in_bucket, y=df['bid_price1'], name='bid_price1',\n                       line=dict(color=('rgba(150, 0, 0, 0.9)')),\n                       visible=False),\n            row=2, col=1)\n        fig.add_trace(\n            go.Scatter(x=df.seconds_in_bucket, y=df['bid_price2'], name='bid_price2',\n                       line=dict(color=('rgba(200, 0, 0, 0.9)')),\n                       visible=False),\n            row=2, col=1)\n        fig.add_trace(\n            go.Scatter(x=df.seconds_in_bucket, y=df['price'],\n                       name='price', mode='markers',\n                       line=dict(color=('rgba(0, 0, 200, 0.4)')),\n                       marker=dict(size=np.log(df.fillna(1)['size']*1e3)),\n                       visible=False),\n            row=2, col=1)\n        fig.add_trace(  # BOTTOM GRAPH\n            go.Scatter(x=df.seconds_in_bucket, y=df['log_return'],\n                       name='ask_size1', fill='tozeroy',\n                       line=dict(color=('rgba(0, 0, 20, 0.6)')),\n                       visible=False),\n            row=3, col=1)\n        df_vol = df.log_return_volatility()\n        f_vol = fut_vol.loc[stock_id, time_id].target\n        c = df.seconds_in_bucket.max()\n        fig.add_trace(\n            go.Scatter(x=[c-10,c,c+10,c,c-10], y=[0,df_vol,0,-df_vol,0],\n                       name='log_volatility',\n                       fill=\"toself\",\n                       visible=False),\n            row=3, col=1, secondary_y=True)\n        fig.add_trace(\n            go.Scatter(x=[c,c+10,c+20,c+10,c], y=[0,f_vol,0,-f_vol,0],\n                       name='log_volatility',\n                       fill=\"toself\",\n                       visible=False),\n            row=3, col=1, secondary_y=True)\n\n    for i in range(13):\n        fig.data[i].visible = True\n\n    # Create and add slider\n    steps = []\n    for i in range(int(len(fig.data) \/ 12)):\n        step = dict(\n            method=\"update\",\n            args=[{\"visible\": [False] * len(fig.data)},\n                  {\"title\": \"time_id: \" + str(i)}],  # layout attribute\n        )\n        for j in range(i * 12, (i+1) * 12):\n            step[\"args\"][0][\"visible\"][j] = True  # Toggle i'th trace to \"visible\"\n        steps.append(step)\n\n\n    fig.update_layout(\n        sliders=[dict(\n            active=25,\n            currentvalue={\"prefix\": \"time_id: \"},\n            pad={\"t\": 50},\n            steps=steps)],\n        autosize=False, width=1200, height=700\n    )\n\n    fig.show()","12b45276":"book_feat = pd.DataFrame()\nfor stock_id in train_stock_ids[:]:\n    book = open_book(stock_id)\n    trades = open_trades(stock_id)\n    time_ids = book.time_id.unique()\n\n    time_id = time_ids[0]\n\n    def get_feat(book):\n        book = book.sort_values(['stock_id', 'time_id'])\n        return pd.Series({\n            'npts': len(book),\n            'lrv': book.log_return_volatility(),\n            'lrv1': book.get_third(0).log_return_volatility(),\n            'lrv2': book.get_third(1).log_return_volatility(),\n            'lrv3': book.get_third(2).log_return_volatility(),\n            'wapM': book.wap.mean(),\n            'lrM': book.log_return.mean(),\n            'ap1v': volatility(book.ask_price1),\n            'ap2v': volatility(book.ask_price2),\n            'bp1v': volatility(book.bid_price1),\n            'bp2v': volatility(book.bid_price2),\n            'as1m': book.ask_size1.mean(),\n            'as2m': book.ask_size2.mean(),\n            'bs1m': book.bid_size1.mean(),\n            'bs2m': book.bid_size2.mean()})\n\n    book_feat = pd.concat([\n        book.groupby(['stock_id', 'time_id']).apply(get_feat),\n        book_feat\n    ])\n\nbook_feat = book_feat.join(fut_vol)","52658454":"fig = px.scatter_matrix(book_feat)\nfig.update_layout(autosize=False, width=1200, height=700)\nfig.show()\nbook_feat.corr()['target']","6e506f30":"book_feat.to_parquet('test_out.parket')","429f5a76":"# Create interactive data visualization\nGraph shows ask\/bid price\/size of different time_ids and stock_ids","d3db64ee":"# Initiate variables\n- Open training target\n- Get train\/test stock_ids","c7a9aabd":"# Extract some features...","29e2778a":"# Import libraries and create helper functions\nFunctions do:\n- Compute **Weighted-Average-Price (WAP)**\n- Compute **log_return** of WAP\n- Compute **volatility** of WAP_log_return\n- Compute **Volatility** of a list\n- Open **books and trades**\n- **Merge** book and trade on given **time_id**","ab57b289":"# Plot Book-features correlation"}}