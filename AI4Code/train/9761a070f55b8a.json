{"cell_type":{"9f38035c":"code","f1dd1ffb":"code","10c650fa":"code","dbfcb06f":"code","3f4691e8":"code","f8f338b7":"code","107cc90b":"code","70e2e304":"code","fe385b7d":"code","783d658d":"code","c484a635":"code","2c950112":"code","0ac9fed6":"code","ab1aed07":"code","d72e7877":"code","50772ace":"code","475831f2":"code","35062334":"code","79f2c410":"code","431d4f34":"code","524512c5":"code","1d023cc3":"code","67f7e330":"code","31d952d9":"code","29801f5a":"code","755926b5":"markdown","49e7f665":"markdown","cc26bd66":"markdown","16145e94":"markdown","c3619500":"markdown","b004dc78":"markdown","868af1c7":"markdown","c25c019e":"markdown","266b3b75":"markdown","b854ecc6":"markdown","760e619c":"markdown","a55de4db":"markdown","7cc864a7":"markdown","4d6dcf00":"markdown","3649416f":"markdown","5b618174":"markdown","2859b3a4":"markdown","2180cab6":"markdown","68b8b9f7":"markdown","f92b87d5":"markdown","e34a7599":"markdown","387aca15":"markdown","0024c81f":"markdown","192dea62":"markdown","9ee3d6de":"markdown","3899d537":"markdown","54aa8d52":"markdown"},"source":{"9f38035c":"import numpy as np\nimport pandas as pd\nimport seaborn as sns\nimport matplotlib.pyplot as plt\n\nfrom sklearn.linear_model import LinearRegression\n\nsns.set()","f1dd1ffb":"df_covid = pd.read_csv('..\/input\/novel-corona-virus-2019-dataset\/covid_19_data.csv')","10c650fa":"cols = df_covid.columns\ndf_covid.columns = [col.lower() for col in cols]","dbfcb06f":"df_covid.rename(columns={\n    'observationdate' : 'observation_date',\n    'country\/region' : 'country',\n    'province\/state' : 'province_state', \n    'last update' : 'last_update',\n}, inplace=True)","3f4691e8":"df_covid['observation_date'] = pd.to_datetime(df_covid['observation_date'])\n\ndf_covid.sort_values('observation_date', inplace=True)","f8f338b7":"df_covid['diseased'] = df_covid['confirmed'] - df_covid['recovered'] - df_covid['deaths']\n\ndf_series = df_covid.groupby('observation_date').agg({\n    'country' : 'nunique',\n    'confirmed' : 'sum',\n    'deaths' : 'sum',\n    'recovered' : 'sum',\n    'diseased' : 'sum',\n})","107cc90b":"df_covid.drop(['sno', 'last_update'], axis=1, inplace=True)","70e2e304":"for i in range(7, 15):\n    df_series[f'confirmed_lag_{i}'] = df_series['confirmed'].shift(i)\n    df_series[f'deaths_lag_{i}'] = df_series['deaths'].shift(i)\n    df_series[f'recovered_lag_{i}'] = df_series['recovered'].shift(i)\n    df_series[f'diseased_lag_{i}'] = df_series['diseased'].shift(i)","fe385b7d":"sns.set(style=\"white\")\n\nfig, ax = plt.subplots(figsize=(11, 9))\n\n# Create correlation matrix\ncorr = df_series.corr()\n\n# Generate a mask for the upper triangle\nmask = np.triu(np.ones_like(corr, dtype=np.bool))\n\n# Generate a custom diverging colormap\ncmap = sns.diverging_palette(220, 20, sep=20, as_cmap=True)\n\n# Plot correlation matrix without the diagonal and upper part\nsns.heatmap(corr, mask=mask, cmap=cmap, linewidths=.5)","783d658d":"sns.set()\n\n# Get percentages of recovered, deaths and diseased\ndf_series['pct_recovered'] = round(df_series['recovered'] \/ df_series['confirmed'], 4)\ndf_series['pct_deaths'] = round(df_series['deaths'] \/ df_series['confirmed'], 4)\ndf_series['pct_diseased'] = round(df_series['diseased'] \/ df_series['confirmed'], 4)","c484a635":"df_series['country_pct_change'] = df_series['country'].pct_change()\ndf_series['recovered_pct_change'] = df_series['recovered'].pct_change()\ndf_series['deaths_pct_change'] = df_series['deaths'].pct_change()\ndf_series['diseased_pct_change'] = df_series['diseased'].pct_change()","2c950112":"df_country = df_covid.groupby(['country', 'observation_date']).sum().reset_index()\n\ndf_country['confirmed_log'] = np.log10(df_country['confirmed'])\ndf_country['deaths_log'] = np.log10(df_country['deaths'])","0ac9fed6":"df_country['day_cnt'] = 0 \nfor country in df_country['country'].unique():\n    day_cnt = [i for i in range(1, df_country[df_country['country'] == country][df_country['confirmed'] > 0].shape[0] + 1)]\n    \n    df_country.loc[(df_country['country'] == country) & (df_country['confirmed'] > 0) , 'day_cnt'] = day_cnt","ab1aed07":"# Column to plot\ntarget = 'confirmed_log'\n\n# It'd be better if this dataframe was outside this cell, but that's fine\ncountries_to_plot = df_country.groupby('country').sum().sort_values(target, ascending=False).index[:10]\n\n# Plot top 10\nplt.figure(figsize=(13, 11))\nsns.lineplot(x='day_cnt', y=target, hue='country', data=df_country[df_country[target] > 0][df_country['country'].isin(countries_to_plot)])\n\nplt.show()","d72e7877":"# Column to plot\ntarget = 'deaths'\n\n# It'd be better if this dataframe was outside this cell, but that's fine\ncountries_to_plot = df_country.groupby('country').sum().sort_values(target, ascending=False).index[:10]\n\n# Plot top 10\nplt.figure(figsize=(13, 11))\nsns.lineplot(x='day_cnt', y=target, hue='country', data=df_country[df_country[target] > 0][df_country['country'].isin(countries_to_plot)])\n\nplt.show()","50772ace":"df_series[['deaths_pct_change', 'country_pct_change']].plot(figsize=(14, 5))","475831f2":"df_series.dropna().shape","35062334":"train_cols = [col for col in df_series.columns if 'deaths_lag_' in col] \n\n# Just to see if i'm not cheating ;D\n', '.join(train_cols) ","79f2c410":"num_split = 7\n\nX = np.log10(df_series.dropna()[train_cols])\ny = np.log10(df_series.dropna()['deaths'])\n\nX_train = X[:-num_split]\ny_train = y[:-num_split]\nX_test = X[-num_split:]\ny_test = y[-num_split:]","431d4f34":"model = LinearRegression()\nmodel.fit(X_train, y_train)","524512c5":"predictions = model.predict(X_test)\n\ndf_predictions = pd.DataFrame()\ndf_predictions['y_pred_log'] = predictions\ndf_predictions['y_true_log'] = y_test.values\ndf_predictions['y_pred'] = 10 ** predictions\ndf_predictions['y_true'] = 10 ** y_test.values\n\ndf_predictions['absolute_pct_error'] = abs((df_predictions['y_pred'] - df_predictions['y_true']) \/ df_predictions['y_true']) * 100","1d023cc3":"f\"MAPE: {round(df_predictions['absolute_pct_error'].mean())}%\"","67f7e330":"fig, ax = plt.subplots(figsize=(14, 5))\n\nax.plot(y_train, 'bo--')\nax.plot(y_test, 'go--')\nax.plot(pd.Series(predictions, index = y_test.index), 'ro--')\n\nplt.title('Log10 values')\nplt.show()","31d952d9":"fig, ax = plt.subplots(figsize=(14, 5))\n\nax.plot(10 ** y_train, 'bo--')\nax.plot(10 ** y_test, 'go--')\nax.plot(10 ** pd.Series(predictions, index = y_test.index), 'ro--')\n\nplt.title('Absolute values')\nplt.show()","29801f5a":"df_predictions['y_pred'] = round(df_predictions['y_pred'])\ndf_predictions","755926b5":"### Series for top 10 countries","49e7f665":"# Exploring data and preprocessing","cc26bd66":"## Forecast\n\nWe're going to use multiple linear regression to predict the number of deaths for the next week.","16145e94":"#### Confirmed cases","c3619500":"### Predictions and error individually","b004dc78":"## Create lags","868af1c7":"### MAPE\n\nMean absolute percentage error","c25c019e":"#### Log values","266b3b75":"## Force columns to be snake case","b854ecc6":"## Create percentage change columns\n\nAlso, I do like to see how was the percentage change between the observation and the value in the last observation. Don't use this column in your forecast, that would be cheating!","760e619c":"## Deaths percentage change with countries \n\nI wanted to see two things with the following plot\n\n1. Growth of number of deaths; \n2. How the number of countries is affecting my growth of deaths;\n\nAfter adding the country_pct_change i've looked that in the first few rows my number of countries deacresed, making no sense, this is probably an error of collected data due that it should be cummulative","a55de4db":"## Transform date column to date format\n\nEven that the dataset looks sorted by date, there's no harm in sorting it again","7cc864a7":"## Diagonal correlation matrix","4d6dcf00":"## Read data","3649416f":"As expected, we can see that there is correlation between number of deaths and cases confirmed, among other corelations. It looks like our country information it's a little bit naive since countries have different density of people and also different months since first covid-19 occurence.","5b618174":"## Evaluate model","2859b3a4":"## Create percentage columns\n\nI do always like to see percentage values, absolute values sometimes is hard to infere anything because you don't have a scale in your head","2180cab6":"#### Absolute values","68b8b9f7":"#### Get column with number of days since the first occurency","f92b87d5":"## Divide in train and test","e34a7599":"## Drop unwanted columns","387aca15":"Well, I'd not recommend it for any application in real life! Let's see how it did individually","0024c81f":"## Deaths","192dea62":"### Plot prediction vs true value","9ee3d6de":"## Group by day\n\nThis notebook intend to prepare data for worldwide daily forecast. Therefore, we're going to group by day without worring much of different countries and number of days since fist occurence. ","3899d537":"# Time series forecasting\n\nLet's forecast the number of deaths for the next 7 days for worlwide just for fun.","54aa8d52":"Prediction might be better if we try to do one day validation for 7 days or use more features (after doing tsa). Also, it's always good to remember that this is just a biased validation for demonstration purposes. In cases that you really want to validate your forecast, I'd recommend implementing a time series cross-validation (not same as regular cross val)"}}