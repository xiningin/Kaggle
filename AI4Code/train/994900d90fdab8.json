{"cell_type":{"b3c4ed84":"code","238d1bf7":"code","90dd25b9":"code","24a43548":"code","ede565aa":"code","bbb05bb2":"code","dbf0cfc3":"code","d428ca71":"markdown"},"source":{"b3c4ed84":"!pip install lofo-importance","238d1bf7":"import numpy as np\nimport pandas as pd\nfrom tqdm import tqdm\nimport os, sys\nimport torch\n\nPATH = \"..\/input\/ventilator-pressure-prediction\"\n\n\ndf = pd.read_csv(f\"{PATH}\/train.csv\")\nprint(df.shape)\ndf.head()","90dd25b9":"def engineer_features(df):\n    df[\"u_in_sum\"] = df.groupby(\"breath_id\")[\"u_in\"].transform(\"sum\")\n    df[\"u_in_cumsum\"] = df.groupby(\"breath_id\")[\"u_in\"].cumsum()\n    df[\"u_in_std\"] = df.groupby(\"breath_id\")[\"u_in\"].transform(\"std\")\n    df[\"u_in_min\"] = df.groupby(\"breath_id\")[\"u_in\"].transform(\"min\")\n    df[\"u_in_max\"] = df.groupby(\"breath_id\")[\"u_in\"].transform(\"max\")\n    df[\"u_in_cumsum_reverse\"] = df[\"u_in_sum\"] - df[\"u_in_cumsum\"]\n    \n    df[\"u_in_first\"] = df.groupby(\"breath_id\")[\"u_in\"].transform(\"first\")\n    df[\"u_in_last\"] = df.groupby(\"breath_id\")[\"u_in\"].transform(\"last\")\n    \n    df[\"u_in_lag1\"] = df.groupby(\"breath_id\")[\"u_in\"].shift(1)\n    df[\"u_in_lead1\"] = df.groupby(\"breath_id\")[\"u_in\"].shift(-1)\n    df[\"u_in_lag1_diff\"] = df[\"u_in\"] - df[\"u_in_lag1\"]\n    df[\"u_in_lead1_diff\"] = df[\"u_in\"] - df[\"u_in_lead1\"]\n    \n    df[\"u_out_sum\"] = df.groupby(\"breath_id\")[\"u_out\"].transform(\"sum\")\n    \n    df[\"time_passed\"] = df.groupby(\"breath_id\")[\"time_step\"].diff()\n    \n    return df\n    \ndf = engineer_features(df)","24a43548":"in_df = df[df[\"u_out\"] == 0].reset_index(drop=True)\nin_df.shape","ede565aa":"from lofo import Dataset, LOFOImportance, plot_importance\nfrom sklearn.model_selection import GroupKFold\n\n\ncv = list(GroupKFold(n_splits=4).split(in_df, in_df[\"pressure\"], groups=in_df[\"breath_id\"]))\n\nfeatures = [\"time_step\", \"u_in\", \"R\", \"C\",\n            \"u_in_sum\", \"u_in_cumsum\", \"u_in_std\", \"u_in_min\", \"u_in_max\", \"u_in_cumsum_reverse\",\n            \"u_in_lead1\", \"u_in_lag1\", \"u_in_lag1_diff\", \"u_in_lead1_diff\",\n            \"u_out_sum\", \"time_passed\", \"u_in_first\", \"u_in_last\"]\n\nds = Dataset(in_df, target=\"pressure\", features=features,\n    feature_groups=None,\n    auto_group_threshold=0.9\n)","bbb05bb2":"lofo_imp = LOFOImportance(ds, cv=cv, scoring=\"neg_mean_absolute_error\")\n\nimportance_df = lofo_imp.get_importance()\nimportance_df","dbf0cfc3":"plot_importance(importance_df, figsize=(8, 8))","d428ca71":"# Google Ventilator Feature Importance with LOFO\n\n![](https:\/\/raw.githubusercontent.com\/aerdem4\/lofo-importance\/master\/docs\/lofo_logo.png)\n\n**LOFO** (Leave One Feature Out) Importance calculates the importances of a set of features based on **a metric of choice**, for **a model of choice**, by **iteratively removing each feature from the set**, and **evaluating the performance** of the model, with **a validation scheme of choice**, based on the chosen metric.\n\nLOFO first evaluates the performance of the model with all the input features included, then iteratively removes one feature at a time, retrains the model, and evaluates its performance on a validation set. The mean and standard deviation (across the folds) of the importance of each feature is then reported.\n\nWhile other feature importance methods usually calculate how much a feature is used by the model, LOFO estimates how much a feature can make a difference by itself given that we have the other features. Here are some advantages of LOFO:\n* It generalises well to unseen test sets since it uses a validation scheme.\n* It is model agnostic.\n* It gives negative importance to features that hurt performance upon inclusion.\n* It can group the features. Especially useful for high dimensional features like TFIDF or OHE features. It is also good practice to group very correlated features to avoid misleading results.\n* It can automatically group highly correlated features to avoid underestimating their importance.\n\nhttps:\/\/github.com\/aerdem4\/lofo-importance"}}