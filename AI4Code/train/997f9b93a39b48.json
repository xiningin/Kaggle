{"cell_type":{"b76d2aa0":"code","3a16de5f":"code","ada21f25":"code","6e7918b2":"code","4c6f9985":"code","97052759":"code","73866246":"code","23d3f08f":"code","dbbd8e09":"code","a3a5ced7":"code","2d9b2414":"code","63eebc48":"code","bcc1e4d2":"code","2f582f17":"code","99819764":"code","ff5f18ef":"code","5c43b3d5":"code","ddd41b40":"code","fb8b47dd":"code","d11bc9da":"code","6927fcd8":"code","064364d8":"code","47068181":"code","ec571abb":"code","0ea3a9c4":"code","5ec4ba4a":"code","88614a55":"code","6d1bc998":"code","c390a5c0":"code","d866fc47":"code","24fe867f":"code","dc282e64":"code","5f983118":"code","06310577":"markdown","ca0e02e8":"markdown","520ffec7":"markdown","f83ded1d":"markdown","e3d9ecc1":"markdown","a9de7618":"markdown","545f18fb":"markdown","52ada34a":"markdown","89599d5f":"markdown","45146f5e":"markdown","e52e9515":"markdown","d7f91b22":"markdown","67fbfe5e":"markdown","2ea8acb2":"markdown","00da20b5":"markdown"},"source":{"b76d2aa0":"# import necessary modules\nimport numpy as np \nimport pandas as pd \nimport seaborn as sns \nimport matplotlib.pyplot as plt\nimport os\nimport warnings\nfrom datetime import datetime\nfrom scipy import stats\nfrom scipy.stats import norm, skew, probplot \n\nwarnings.filterwarnings('ignore')","3a16de5f":"dftrain = pd.read_csv('..\/input\/covid19-global-forecasting-week-2\/train.csv', parse_dates=['Date']).sort_values(by=['Country_Region', 'Date']).fillna('None')\ndftest = pd.read_csv('..\/input\/covid19-global-forecasting-week-2\/test.csv', parse_dates=['Date']).sort_values(by=['Country_Region', 'Date']).fillna('None')\ndfsubm = pd.read_csv('..\/input\/covid19-global-forecasting-week-2\/submission.csv')#, parse_dates=['Date']).sort_values(by=['Country_Region', 'Date'])","ada21f25":"dftrain.head(2)","6e7918b2":"dftrain.tail(2)","4c6f9985":"dftest.head(2)","97052759":"dftest.tail(2)","73866246":"dfsubm.head(2)","23d3f08f":"starttest = dftest['Date'].min() ; endtest = dftest['Date'].max() ; datetest = dftest['Date'].unique()","dbbd8e09":"confirmed = pd.read_csv('https:\/\/raw.githubusercontent.com\/CSSEGISandData\/COVID-19\/master\/csse_covid_19_data\/csse_covid_19_time_series\/time_series_covid19_confirmed_global.csv').sort_values(by='Country\/Region')#.set_index('Country\/Region')\ndeaths = pd.read_csv('https:\/\/raw.githubusercontent.com\/CSSEGISandData\/COVID-19\/master\/csse_covid_19_data\/csse_covid_19_time_series\/time_series_covid19_deaths_global.csv')#.set_index('Country\/Region')\nrecovered = pd.read_csv('https:\/\/raw.githubusercontent.com\/CSSEGISandData\/COVID-19\/master\/csse_covid_19_data\/csse_covid_19_time_series\/time_series_covid19_recovered_global.csv')#.set_index('Country\/Region')","a3a5ced7":"confirmed['Country_Region'] = confirmed['Country\/Region']\nconfirmed['Province_State'] = confirmed['Province\/State']\nconfirmed.head()","2d9b2414":"dftrain = dftrain.join(confirmed[['Country_Region', 'Province_State', 'Lat', 'Long']].set_index(['Province_State', 'Country_Region']), on=['Province_State', 'Country_Region'])#, how='outer')#.set_index(['Province_State', 'Country_Region']))","63eebc48":"dftrain['Dayofyear'] = dftrain['Date'].dt.dayofyear\ndftest['Dayofyear'] = dftest['Date'].dt.dayofyear","bcc1e4d2":"def transpose_df(df):\n    df = df.drop(['Lat','Long'],axis=1).groupby('Country\/Region').sum().T\n    df.index = pd.to_datetime(df.index)#.date\n    return df","2f582f17":"confirmedT = transpose_df(confirmed)\ndeathsT = transpose_df(deaths)\nrecoveredT = transpose_df(recovered)\nmortalityT = deathsT\/confirmedT","99819764":"def add_day(df):\n    df['Date'] = df.index\n    df['Dayofyear'] = df['Date'].dt.dayofyear\n    return df","ff5f18ef":"confirmedT, deathsT, recoveredT, mortalityT = add_day(confirmedT), add_day(deathsT), add_day(recoveredT), add_day(mortalityT)","5c43b3d5":"allcountries_ordered = confirmed.set_index(['Country_Region']).iloc[:,-2].sort_values(ascending=False).index.tolist()","ddd41b40":"confirmed.set_index(['Country_Region']).iloc[:,-2].sort_values(ascending=False).to_csv('confirmed_countries.csv')","fb8b47dd":"#\ndef df_day1(df, confirmed):\n    df_day1 = pd.DataFrame({'Days since 100 cases' : np.arange(1000)}).set_index('Days since 100 cases')\n    countries_df = df.columns.tolist()[:-2]\n    countries_conf = confirmed.columns.tolist()[:-2]\n    #print(len(countries_df), len(confirmed.columns.tolist()[:-2]))\n    for ic, country in enumerate(countries_df):\n        for ic2, country2 in enumerate(countries_conf):\n            if country == country2:\n                dfsub = df[confirmed[country] > 100.][country]\n                df_day1[country] = np.nan\n                df_day1.loc[:len(dfsub)-1,country] = (dfsub).tolist()\n        #try:\n        #except:\n        #    pass\n    df_day1 = df_day1.dropna(how='all')\n    #df_day1 = df_day1.fillna(0.)\n    return df_day1","d11bc9da":"confirmed_day1 = df_day1(confirmedT, confirmedT)\ndeaths_day1 = df_day1(deathsT, confirmedT)\nrecovered_day1 = df_day1(recoveredT, confirmedT)\nmortality_day1 = df_day1(mortalityT, confirmedT)\nconfirmednorm_day1 = confirmed_day1\/confirmed_day1.loc[0,:]\nmaxday = confirmed_day1.shape[0]","6927fcd8":"date_day1 = confirmedT.copy()\nfor column in date_day1:\n    date_day1[column] = confirmedT.index.tolist()\ndate_day1 = df_day1(date_day1, confirmedT)","064364d8":"date_day1.T.sort_values(by=0).head()","47068181":"allcountries = dftrain['Country_Region'].unique().tolist()\n#allcountries_confirmed = confirmed['Country\/Region'].unique().tolist()\n#allcountries_deaths = deaths['Country\/Region'].unique().tolist()\n#allcountries_recovered = confirmed['Country\/Region'].unique().tolist()\n#countries = ['France', 'Italy', 'Spain', 'US', 'Germany', 'United Kingdom', 'China']","ec571abb":"def logistic_curve(x, k, x_0, ymax):\n    return ymax \/ (1 + np.exp(-k*(x-x_0)))","0ea3a9c4":"def logistic_curve2(x, k1, k2, x_0, ymax):\n    return ymax \/ (1 + np.exp(-k1*(x-x_0)) + np.exp(-k2*(x-x_0)))","5ec4ba4a":"#\nlist_countries = dftrain[dftrain['Date'] == '2020-01-22']['Country_Region'].tolist()\nlist_states = dftrain[dftrain['Date'] == '2020-01-22']['Province_State'].tolist()\ndatenow = datetime.now()","88614a55":"list_date_pand = [] ; list_maxcases = []; list_maxfat = []\nfor country, state in list(zip(list_countries, list_states)):\n    df2 = dftrain.loc[(dftrain['Country_Region'] == country) & (dftrain['Province_State'] == state)].fillna('None')\n    maxcases, maxfat = df2['ConfirmedCases'].max(), df2['Fatalities'].max()\n    date_pand2 = []\n    date_pand = df2[df2['ConfirmedCases'] > 100.]['Date'].tolist()#[0]\n    try:\n        list_date_pand.append(pd.to_datetime(date_pand[0]))\n    except:\n        list_date_pand.append(pd.to_datetime(datenow))\n    list_maxcases.append(maxcases) ; list_maxfat.append(maxfat)\n#\ndfstartpand = pd.DataFrame(np.array([list_countries, list_states, list_date_pand, list_maxcases, list_maxfat]).T, \n                           columns=['Country_Region', 'Province_State', 'Start_Pandemic', 'ConfirmedCases', 'Fatalities'])\ndfstartpand['Start_Pandemic'] = dfstartpand['Start_Pandemic'].dt.date","6d1bc998":"#\ndfstartpand_ordered = dfstartpand.sort_values(by=['Start_Pandemic', 'ConfirmedCases', 'Fatalities'], ascending=[True, False, False])#.head(5)\ncountry_state_ordered = list(zip(dfstartpand_ordered['Country_Region'].tolist(), dfstartpand_ordered['Province_State']))\n#country_state_ordered = list(zip(dfstartpand_ordered[['Country_Region', 'Province_State']]))\n#\ndatetrain = dftrain['Date'].unique()#.dt.date\ndatetest = dftest['Date'].unique()#.dt.date","c390a5c0":"from scipy.optimize import curve_fit\nimport math\n#\ndftest['ConfirmedCases_logreg'] = 0.0 ; dftrain['ConfirmedCases_logreg'] = 0.0\ndftest['Fatalities_logreg'] = 0.0 ; dftrain['Fatalities_logreg'] = 0.0\np0 = 1\n#\nfor country, state in country_state_ordered:\n    #print(country+' '+state)\n    #country2plot = 'Italy' ; state2plot = 'None'\n    masktrain = (dftrain['Country_Region'] == country) & (dftrain['Province_State'] == state)\n    masktrain2 = (dftrain['Country_Region'] == country) & (dftrain['Province_State'] == state) & (dftrain['Date'] <= '2020-03-31') & (dftrain['Date'] >= starttest) \n    masktest = (dftest['Country_Region'] == country) & (dftest['Province_State'] == state)\n    masktest2 = (dftest['Country_Region'] == country) & (dftest['Province_State'] == state) & (dftest['Date'] <= '2020-03-31')\n    df2plot = dftrain[masktrain].set_index('Date')\n    #print(len(dftrain[masktrain2]))\n    #\n    X = np.arange(len(df2plot))\n    X_test = (np.timedelta64(datetest[0]-datetrain[0], 'D')).astype(float)+np.arange(0,len(datetest))\n    #\n    try:\n        y = df2plot['ConfirmedCases']\n        p0_cases = [1\/(len(X)\/2.), X[-1], y.max()]\n        popt, pcov = curve_fit(logistic_curve, X, y, p0=p0_cases,bounds=([0,0,0],np.inf), maxfev=1000)\n        k_cases, x_0_cases, ymax_cases = popt\n        cases_train_fc = pd.Series(logistic_curve(X, k_cases, x_0_cases, ymax_cases),index=df2plot.index)\n        cases_test_fc = pd.Series(logistic_curve(X_test, k_cases, x_0_cases, ymax_cases),index=datetest)\n        #\n        dftest.loc[masktest,'ConfirmedCases_logreg'] = cases_test_fc.tolist()\n        dftrain.loc[masktrain,'ConfirmedCases_logreg'] = cases_train_fc.tolist()\n    except:\n        print(country+' '+state+' Unable to fit the confirmed cases')\n        dftest.loc[masktest,'ConfirmedCases_logreg'] = dftrain.loc[masktrain,'ConfirmedCases'].iloc[-1]#cases_test_fc.tolist()\n        dftrain.loc[masktrain,'ConfirmedCases_logreg'] = dftrain.loc[masktrain,'ConfirmedCases']\n    try:\n        y = df2plot['Fatalities']#.rolling(3).mean()\n        p0_deaths = [1\/(len(X)\/2.), X[-1], y.max()]\n        popt, pcov = curve_fit(logistic_curve, X, y, p0=p0_deaths,bounds=([0,0,0],np.inf), maxfev=1000)\n        k_deaths, x_0_deaths, ymax_deaths = popt\n        deaths_train_fc = pd.Series(logistic_curve(X, k_deaths, x_0_deaths, ymax_deaths),index=datetrain)\n        deaths_test_fc = pd.Series(logistic_curve(X_test, k_deaths, x_0_deaths, ymax_deaths),index=datetest)\n        #\n        dftest.loc[masktest,'Fatalities_logreg'] = deaths_test_fc.tolist()\n        dftrain.loc[masktrain,'Fatalities_logreg'] = deaths_train_fc.tolist()\n    except:\n        print(country+' '+state+' Unable to fit the fatalities')\n        dftest.loc[masktest,'Fatalities_logreg'] = dftrain.loc[masktrain,'Fatalities'].iloc[-1] #deaths_test_fc.tolist()\n        dftrain.loc[masktrain,'Fatalities_logreg'] = dftrain.loc[masktrain,'Fatalities']\n    dftest.loc[masktest2,'ConfirmedCases_logreg'] = dftrain.loc[masktrain2,'ConfirmedCases'].tolist()\n    dftest.loc[masktest2,'Fatalities_logreg'] = dftrain.loc[masktrain2,'Fatalities'].tolist()","d866fc47":"country2plot = 'Norway' ; state2plot = 'None'\nmasktrain = (dftrain['Country_Region'] == country2plot) & (dftrain['Province_State'] == state2plot)\nmasktest = (dftest['Country_Region'] == country2plot) & (dftest['Province_State'] == state2plot)\ntrain2plot = dftrain[masktrain].set_index('Date')\ntest2plot = dftest[masktest].set_index('Date')\n#\nfig = plt.figure(0,figsize=[20,5])\nfig.subplots_adjust(wspace=0.25, hspace=0.45)\nax = fig.add_subplot(1,4,1)\nax.set_ylabel('Total number of confirmed cases')\nax = train2plot['ConfirmedCases'].rolling(1).mean().plot()\nax = train2plot['ConfirmedCases_logreg'].plot()\nax = test2plot['ConfirmedCases_logreg'].plot()\n#\nax = fig.add_subplot(1,4,2)\nax.set_ylabel('Total number of fatalities')\nax = train2plot['Fatalities'].rolling(1).mean().plot()\nax = train2plot['Fatalities_logreg'].plot()\nax = test2plot['Fatalities_logreg'].plot()\n#\nax = fig.add_subplot(1,4,3)\nax.set_ylabel('Confirmed cases per day')\nax = train2plot['ConfirmedCases'].diff().rolling(1).mean().plot()\nax = train2plot['ConfirmedCases_logreg'].diff().plot()\nax = test2plot['ConfirmedCases_logreg'].diff().plot()\n#\nax = fig.add_subplot(1,4,4)\nax.set_ylabel('Fatalities per day')\nax = train2plot['Fatalities'].diff().rolling(1).mean().plot()\nax = train2plot['Fatalities_logreg'].diff().plot()\nax = test2plot['Fatalities_logreg'].diff().plot()","24fe867f":"dfsubm['ConfirmedCases'] = dftest['ConfirmedCases_logreg']#.tol\ndfsubm['Fatalities'] = dftest['Fatalities_logreg']#.tolist()","dc282e64":"dfsubm.head(5)","5f983118":"dfsubm.to_csv('submission.csv', index=False)","06310577":"## 1.1. Read csv files","ca0e02e8":"#### Sort the summary table as function of pandemic start\n","520ffec7":"#### Transpose the CSSE dataframes ","f83ded1d":"#### Create a summary table with date of pandemic start (i.e. > 100 cases), total number of confirmed cases and deaths\n","e3d9ecc1":"## 1.3 Read other useful dataframes","a9de7618":"#### Read the csv files on the Johns Hopkins CSSE database on github.","545f18fb":"#### Read the csv files from kaggle.","52ada34a":"# 1. Data Importation and cleaning","89599d5f":"#### Create dataframe listing the distance between all countries and regions using the haversine function.","45146f5e":"#### Compute the distance between all countries from the Haversine formula using their latitude and longitude.","e52e9515":"#### Create dataframes as function of days from \"Day 1\" of the epidemic, defined here as day when 100 cases have been confirmed in each country","d7f91b22":"## 1.2 Clean the input dataframes","67fbfe5e":"Different approaches can be tried:\n- Logistic regression as function of days since number of confirmed cases or deaths is expected to follow this trend. However, most countries are still in the beginning of the curve, so unable to fit properly\n- Auto-regressive linear regression, i.e. linear regression of lags, tends to deviate rapidly\n- ARIMA model on confirmed\/daths.diff().diff(), i.e. difference of daily new cases w.r.t. previous day, smoothed over a week to make the TS more stationary \n- Linear regression of total number of daily new numbers with countries that entered in the epidemic phase previously as independent variables ","2ea8acb2":"# 3. ML modelling","00da20b5":"## 3.1 Logistic Regression"}}