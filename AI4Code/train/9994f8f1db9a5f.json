{"cell_type":{"03f886fc":"code","042f0e72":"code","bb4eb3e7":"code","4eb7a7f9":"code","2856ca12":"code","2b30cfa8":"code","752aa5c1":"code","406219b5":"code","4e0b2f0d":"code","86986497":"code","13248e32":"code","35e3a36d":"code","e084ef92":"code","9e672325":"code","3a8243e3":"code","72bb99fe":"code","7a9e481a":"code","3ce45f5d":"code","ad36ec56":"code","966bf463":"code","177b1f08":"markdown","81273c27":"markdown","64cd8880":"markdown","9a42acaa":"markdown","0a91b451":"markdown","8a57c6f2":"markdown","e6c8d8da":"markdown"},"source":{"03f886fc":"import os\n\ndef list_all_files_in(dirpath):\n    for dirname, _, filenames in os.walk(dirpath):\n        for filename in filenames:\n            print(os.path.join(dirname, filename))\n\nlist_all_files_in('..\/input')","042f0e72":"# Dataframes\nimport pandas as pd\n\n# Linear algebra\nimport numpy as np\n\n# Visualization\nimport matplotlib.pyplot as plt\nimport seaborn as sns\n\n# List shifting\nfrom collections import deque\n\n# Sparse matrices\nfrom scipy import sparse\n\n# Implicit\nimport implicit\n\n# Displaying stuff\nfrom IPython.display import display\n\n# ZIP I\/O\nimport zipfile\n\n# Paths\nfrom pathlib import Path\n\n# Timing\nimport time\n\n# Disable warnings\nimport warnings; warnings.simplefilter('ignore')","bb4eb3e7":"df_coupon_list_train = pd.read_csv('..\/input\/coupon-purchase-prediction-translated\/coupon_list_train_translated.csv')\n# df_coupon_area_train = pd.read_csv('..\/input\/coupon-purchase-prediction-translated\/coupon_area_train_translated.csv')\ndf_coupon_detail_train = pd.read_csv('..\/input\/coupon-purchase-prediction-translated\/coupon_detail_train_translated.csv')\n# df_coupon_visit_train = pd.read_csv('..\/input\/coupon-purchase-prediction-translated\/coupon_visit_train_translated.csv')\n\ndf_coupon_list_test = pd.read_csv('..\/input\/coupon-purchase-prediction-translated\/coupon_list_test_translated.csv')\n# df_coupon_area_test = pd.read_csv('..\/input\/coupon-purchase-prediction-translated\/coupon_area_test_translated.csv')\n\ndf_user_list = pd.read_csv('..\/input\/coupon-purchase-prediction-translated\/user_list_translated.csv')\n# df_prefecture_locations = pd.read_csv('..\/input\/coupon-purchase-prediction-translated\/prefecture_locations_translated.csv')\n# df_submission = pd.read_csv('..\/input\/coupon-purchase-prediction-translated\/sample_submission.csv')","4eb7a7f9":"df_purchased_coupons_train = df_coupon_detail_train.merge(df_coupon_list_train, on='COUPON_ID_hash', how='inner')","2856ca12":"features = ['COUPON_ID_hash', 'USER_ID_hash', 'GENRE_NAME', 'DISCOUNT_PRICE', 'large_area_name', 'ken_name', 'small_area_name']\ndf_purchased_coupons_train = df_purchased_coupons_train[features]\ndf_purchased_coupons_train","2b30cfa8":"df_coupon_list_test['USER_ID_hash'] = 'dummyuser'\ndf_coupon_list_test = df_coupon_list_test[features]\ndf_coupon_list_test","752aa5c1":"df_combined = pd.concat([df_purchased_coupons_train, df_coupon_list_test], axis=0)\ndf_combined['DISCOUNT_PRICE'] = 1 \/ np.log10(df_combined['DISCOUNT_PRICE'])\nfeatures.extend(['DISCOUNT_PRICE'])\ndf_combined","406219b5":"categoricals = ['GENRE_NAME', 'large_area_name', 'ken_name', 'small_area_name']\ndf_combined_categoricals = df_combined[categoricals]\ndf_combined_categoricals = pd.get_dummies(df_combined_categoricals, dummy_na=False)\ndf_combined_categoricals","4e0b2f0d":"continuous = list(set(features) - set(categoricals))\ndf_combined = pd.concat([df_combined[continuous], df_combined_categoricals], axis=1)\nprint(df_combined.isna().sum())\nNAN_SUBSTITUTION_VALUE = 1\ndf_combined = df_combined.fillna(NAN_SUBSTITUTION_VALUE)\ndf_combined","86986497":"df_train = df_combined[df_combined['USER_ID_hash'] != 'dummyuser']\ndf_test = df_combined[df_combined['USER_ID_hash'] == 'dummyuser']\ndf_test = df_test.drop('USER_ID_hash', axis=1)\ndisplay(df_train)\ndisplay(df_test)","13248e32":"df_train_dropped_coupons = df_train.drop('COUPON_ID_hash', axis=1)\ndf_user_profiles = df_train_dropped_coupons.groupby('USER_ID_hash').mean()\ndf_user_profiles","35e3a36d":"FEATURE_WEIGHTS = {\n    'GENRE_NAME': 2,\n    'DISCOUNT_PRICE': 2,\n    'large_area_name': 0.5,\n    'ken_name': 1.5,\n    'small_area_name': 5\n}","e084ef92":"def find_appropriate_weight(weights_dict, colname):\n    for col, weight in weights_dict.items():\n        if col in colname:\n            return weight\n    raise ValueError","9e672325":"W_values = [find_appropriate_weight(FEATURE_WEIGHTS, colname)\n            for colname in df_user_profiles.columns]\nW = np.diag(W_values)\nW","3a8243e3":"df_test_only_features = df_test.drop('COUPON_ID_hash', axis=1)\nsimilarity_scores = np.dot(np.dot(df_user_profiles, W), df_test_only_features.T)\nsimilarity_scores","72bb99fe":"s_coupons_ids = df_test['COUPON_ID_hash']\nindex = df_user_profiles.index\ncolumns = pd.Series([s_coupons_ids[i] for i in range(0, similarity_scores.shape[1])], name='COUPON_ID_hash')\ndf_results = pd.DataFrame(index=index, columns=columns, data=similarity_scores)\ndf_results","7a9e481a":"def get_top10_coupon_hashes_string(row):\n    sorted_row = row.sort_values()\n    return ' '.join(sorted_row.index[-10:][::-1].tolist())","3ce45f5d":"output = df_results.apply(get_top10_coupon_hashes_string, axis=1)\noutput","ad36ec56":"df_output = pd.DataFrame(data={'USER_ID_hash': output.index, 'PURCHASED_COUPONS': output.values})\ndf_output","966bf463":"df_output_all = pd.merge(df_user_list, df_output, how='left', on='USER_ID_hash')\ndf_output_all.to_csv('cosine_sim_python.csv', header=True, index=False, columns=['USER_ID_hash', 'PURCHASED_COUPONS'])\ndf_output_all","177b1f08":"Reproduction of [Maxim Kurnikov's script](https:\/\/www.kaggle.com\/mkurnikov\/modified-cos-similarity-python-edition)","81273c27":"# Imports","64cd8880":"# Weighted Cosine Similarity","9a42acaa":"# Load Dataset","0a91b451":"# Preprocessing","8a57c6f2":"# Generate Submisison","e6c8d8da":"# Paths"}}