{"cell_type":{"a5bed868":"code","e7dce54c":"code","e5ade6ae":"code","b4d64aec":"code","6310a753":"code","b8e97b80":"code","fc616408":"code","03801d94":"code","73410109":"code","cf19121b":"code","e9304255":"code","b3f20bc2":"code","631d5a41":"code","a34e7e9b":"code","e0c55972":"code","9fd1ce8c":"code","ffcf940a":"code","07d6dea5":"code","9f2e6732":"code","dd385961":"code","889125ec":"code","78ecd479":"code","020bafa8":"code","66045903":"code","d4d72e09":"code","823cb5e3":"code","144843aa":"code","aa9977df":"code","89dee1e6":"code","e99b1a21":"code","0a5834ff":"code","7413b752":"code","6d2aa3a4":"markdown"},"source":{"a5bed868":"%matplotlib inline\nimport os\nimport numpy as np\nimport pandas as pd\nimport matplotlib.pyplot as plt\nimport seaborn as sns\nimport matplotlib\nfrom scipy import stats\nfrom scipy.stats import norm, skew\nfrom sklearn import preprocessing\nfrom sklearn.metrics import r2_score\nfrom sklearn.metrics import mean_squared_error\nfrom sklearn.model_selection import train_test_split\nfrom xgboost import XGBRegressor, plot_importance\nfrom sklearn.model_selection import GridSearchCV\nfrom sklearn.model_selection import RandomizedSearchCV\nfrom sklearn.model_selection import RepeatedStratifiedKFold\nfrom sklearn.model_selection import StratifiedKFold\nfrom sklearn.model_selection import KFold\nimport lightgbm as lgbm\nimport xgboost as xgb\n\nfor dirname, _, filenames in os.walk('\/kaggle\/input'):\n    for filename in filenames:\n        print(os.path.join(dirname, filename))","e7dce54c":"df = pd.read_csv('\/kaggle\/input\/new-york-city-taxi-fare-prediction\/train.csv', nrows = 4000000)\ntest_df = pd.read_csv('\/kaggle\/input\/new-york-city-taxi-fare-prediction\/test.csv')\ndf.shape, test_df.shape","e5ade6ae":"df.head()","b4d64aec":"df.isnull().sum().sort_index()\/len(df)","6310a753":"df.dropna(subset=['dropoff_latitude', 'dropoff_longitude'], inplace = True)","b8e97b80":"df.describe()","fc616408":"df.drop(df[df['fare_amount'] < 2.5].index, axis=0, inplace = True)\ndf.drop(df[df['fare_amount'] > 500].index, axis=0, inplace = True)","03801d94":"test_df.describe()","73410109":"df[df['passenger_count'] > 5].sort_values('passenger_count')","cf19121b":"df.drop(df[df['pickup_longitude'] == 0].index, axis=0, inplace = True)\ndf.drop(df[df['pickup_latitude'] == 0].index, axis=0, inplace = True)\ndf.drop(df[df['dropoff_longitude'] == 0].index, axis=0, inplace = True)\ndf.drop(df[df['dropoff_latitude'] == 0].index, axis=0, inplace = True)\ndf.drop(df[df['passenger_count'] == 208].index, axis=0, inplace = True)\ndf.drop(df[df['passenger_count'] > 5].index, axis=0, inplace = True)\ndf.drop(df[df['passenger_count'] == 0].index, axis=0, inplace = True)","e9304255":"df['key'] = pd.to_datetime(df['key'])\nkey = test_df.key\ntest_df['key'] = pd.to_datetime(test_df['key'])\ndf['pickup_datetime']  = pd.to_datetime(df['pickup_datetime'])\ntest_df['pickup_datetime']  = pd.to_datetime(test_df['pickup_datetime'])","b3f20bc2":"df['Year'] = df['pickup_datetime'].dt.year\ndf['Month'] = df['pickup_datetime'].dt.month\ndf['Date'] = df['pickup_datetime'].dt.day\ndf['Day of Week'] = df['pickup_datetime'].dt.dayofweek\ndf['Hour'] = df['pickup_datetime'].dt.hour\ndf.drop('pickup_datetime', axis = 1, inplace = True)\ndf.drop('key', axis = 1, inplace = True)\n\ntest_df['Year'] = test_df['pickup_datetime'].dt.year\ntest_df['Month'] = test_df['pickup_datetime'].dt.month\ntest_df['Date'] = test_df['pickup_datetime'].dt.day\ntest_df['Day of Week'] = test_df['pickup_datetime'].dt.dayofweek\ntest_df['Hour'] = test_df['pickup_datetime'].dt.hour\ntest_df.drop('pickup_datetime', axis = 1, inplace = True)\ntest_df.drop('key', axis = 1, inplace = True)","631d5a41":"df.dropna(inplace=True)\n\ndf.drop(df.index[(df.pickup_longitude < -75) | \n           (df.pickup_longitude > -72) | \n           (df.pickup_latitude < 40) | \n           (df.pickup_latitude > 42)],inplace=True)\ndf.drop(df.index[(df.dropoff_longitude < -75) | \n           (df.dropoff_longitude > -72) | \n           (df.dropoff_latitude < 40) | \n           (df.dropoff_latitude > 42)],inplace=True)","a34e7e9b":"df.describe()","e0c55972":"import geopy.distance\n\ndef geodesic_dist(trip):\n    pickup_lat = trip['pickup_latitude']\n    pickup_long = trip['pickup_longitude']\n    dropoff_lat = trip['dropoff_latitude']\n    dropoff_long = trip['dropoff_longitude']\n    distance = geopy.distance.geodesic((pickup_lat, pickup_long), \n                                       (dropoff_lat, dropoff_long)).miles\n    try:\n        return distance\n    except ValueError:\n        return np.nan\n    \ndef circle_dist(trip):\n    pickup_lat = trip['pickup_latitude']\n    pickup_long = trip['pickup_longitude']\n    dropoff_lat = trip['dropoff_latitude']\n    dropoff_long = trip['dropoff_longitude']\n    distance = geopy.distance.great_circle((pickup_lat, pickup_long), \n                                       (dropoff_lat, dropoff_long)).miles\n    try:\n        return distance\n    except ValueError:\n        return np.nan","9fd1ce8c":"def jfk_dist(trip):\n    jfk_lat = 40.6413\n    jfk_long = -73.7781\n    dropoff_lat = trip['dropoff_latitude']\n    dropoff_long = trip['dropoff_longitude']\n    jfk_distance = geopy.distance.geodesic((dropoff_lat, dropoff_long), (jfk_lat, jfk_long)).miles\n    return jfk_distance\n\ndef lga_dist(trip):\n    lga_lat = 40.7769\n    lga_long = -73.8740\n    dropoff_lat = trip['dropoff_latitude']\n    dropoff_long = trip['dropoff_longitude']\n    lga_distance = geopy.distance.geodesic((dropoff_lat, dropoff_long), (lga_lat, lga_long)).miles\n    return lga_distance\n\ndef ewr_dist(trip):\n    ewr_lat = 40.6895\n    ewr_long = -74.1745\n    dropoff_lat = trip['dropoff_latitude']\n    dropoff_long = trip['dropoff_longitude']\n    ewr_distance = geopy.distance.geodesic((dropoff_lat, dropoff_long), (ewr_lat, ewr_long)).miles\n    return ewr_distance\n\ndef tsq_dist(trip):\n    tsq_lat = 40.7580\n    tsq_long = -73.9855\n    dropoff_lat = trip['dropoff_latitude']\n    dropoff_long = trip['dropoff_longitude']\n    tsq_distance = geopy.distance.geodesic((dropoff_lat, dropoff_long), (tsq_lat, tsq_long)).miles\n    return tsq_distance\n\ndef cpk_dist(trip):\n    cpk_lat = 40.7812\n    cpk_long = -73.9665\n    dropoff_lat = trip['dropoff_latitude']\n    dropoff_long = trip['dropoff_longitude']\n    cpk_distance = geopy.distance.geodesic((dropoff_lat, dropoff_long), (cpk_lat, cpk_long)).miles\n    return cpk_distance\n\ndef lib_dist(trip):\n    lib_lat = 40.6892\n    lib_long = -74.0445\n    dropoff_lat = trip['dropoff_latitude']\n    dropoff_long = trip['dropoff_longitude']\n    lib_distance = geopy.distance.geodesic((dropoff_lat, dropoff_long), (lib_lat, lib_long)).miles\n    return lib_distance\n\ndef gct_dist(trip):\n    gct_lat = 40.7527\n    gct_long = -73.9772\n    dropoff_lat = trip['dropoff_latitude']\n    dropoff_long = trip['dropoff_longitude']\n    gct_distance = geopy.distance.geodesic((dropoff_lat, dropoff_long), (gct_lat, gct_long)).miles\n    return gct_distance\n\ndef met_dist(trip):\n    met_lat = 40.7794\n    met_long = -73.9632\n    dropoff_lat = trip['dropoff_latitude']\n    dropoff_long = trip['dropoff_longitude']\n    met_distance = geopy.distance.geodesic((dropoff_lat, dropoff_long), (met_lat, met_long)).miles\n    return met_distance\n\ndef wtc_dist(trip):\n    wtc_lat = 40.7126\n    wtc_long = -74.0099\n    dropoff_lat = trip['dropoff_latitude']\n    dropoff_long = trip['dropoff_longitude']\n    wtc_distance = geopy.distance.geodesic((dropoff_lat, dropoff_long), (wtc_lat, wtc_long)).miles\n    return wtc_distance","ffcf940a":"def optimize_floats(df):\n    floats = df.select_dtypes(include=['float64']).columns.tolist()\n    df[floats] = df[floats].apply(pd.to_numeric, downcast='float')\n    return df\n\n\ndef optimize_ints(df):\n    ints = df.select_dtypes(include=['int64']).columns.tolist()\n    df[ints] = df[ints].apply(pd.to_numeric, downcast='integer')\n    return df\n\ndef optimize(df):\n    return optimize_floats(optimize_ints(df))","07d6dea5":"df = optimize(df)\ntest_df = optimize(test_df)","9f2e6732":"def calc_dists(df):\n    df['geodesic'] = df.apply(lambda x: geodesic_dist(x), axis = 1 )\n    df['circle'] = df.apply(lambda x: circle_dist(x), axis = 1 )\n    df['jfk'] = df.apply(lambda x: jfk_dist(x), axis = 1 )\n    df['lga'] = df.apply(lambda x: lga_dist(x), axis = 1 )\n    df['ewr'] = df.apply(lambda x: ewr_dist(x), axis = 1 )\n    df['tsq'] = df.apply(lambda x: tsq_dist(x), axis = 1 )\n    df['cpk'] = df.apply(lambda x: cpk_dist(x), axis = 1 )\n    df['lib'] = df.apply(lambda x: lib_dist(x), axis = 1 )\n    df['gct'] = df.apply(lambda x: gct_dist(x), axis = 1 )\n    df['met'] = df.apply(lambda x: met_dist(x), axis = 1 )\n    df['wtc'] = df.apply(lambda x: wtc_dist(x), axis = 1 )\n    return df","dd385961":"df = calc_dists(df)\ntest_df = calc_dists(test_df)","889125ec":"# df.drop(['pickup_longitude','pickup_latitude','dropoff_longitude','dropoff_latitude'],axis=1,inplace=True)\n# test_df.drop(['pickup_longitude','pickup_latitude','dropoff_longitude','dropoff_latitude'],axis=1,inplace=True)","78ecd479":"plt.figure(figsize=(10, 8))\nsns.heatmap(df.drop('fare_amount', axis=1).corr(), square=True)\nplt.suptitle('Pearson Correlation Heatmap')\nplt.show();","020bafa8":"(mu, sigma) = norm.fit(df['geodesic'])\nf, (ax1, ax2) = plt.subplots(1, 2, figsize=(19, 5))\nax1 = sns.distplot(df['geodesic'] , fit=norm, ax=ax1)\nax1.legend([f'Normal distribution ($\\mu=$ {mu:.3f} and $\\sigma=$ {sigma:.3f})'], loc='best')\nax1.set_ylabel('Frequency')\nax1.set_title('Distance Distribution')\nax2 = stats.probplot(df['geodesic'], plot=plt)\nf.show();","66045903":"(mu, sigma) = norm.fit(df['fare_amount'])\nf, (ax1, ax2) = plt.subplots(1, 2, figsize=(19, 5))\nax1 = sns.distplot(df['fare_amount'] , fit=norm, ax=ax1)\nax1.legend([f'Normal distribution ($\\mu=$ {mu:.3f} and $\\sigma=$ {sigma:.3f})'], loc='best')\nax1.set_ylabel('Frequency')\nax1.set_title('Fare Distribution')\nax2 = stats.probplot(df['fare_amount'], plot=plt)\nf.show();","d4d72e09":"df.describe()","823cb5e3":"df = optimize(df)\ntest_df = optimize(test_df)","144843aa":"df.dtypes","aa9977df":"X, y = df.drop('fare_amount', axis = 1), df['fare_amount']\nX_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=12)","89dee1e6":"dtrain = xgb.DMatrix(X_train, label=y_train)\ndvalid = xgb.DMatrix(X_test, label=y_test)\ndtest = xgb.DMatrix(test_df)\nwatchlist = [(dtrain, 'train'), (dvalid, 'valid')]\n\nxgb_params = {\n    'min_child_weight': 1, \n    'learning_rate': 0.05, \n    'colsample_bytree': 0.7, \n    'max_depth': 10,\n    'subsample': 0.7,\n    'n_estimators': 5000,\n    'n_jobs': -1, \n    'booster' : 'gbtree', \n    'silent': 1,\n    'eval_metric': 'rmse'}\n\nmodel = xgb.train(xgb_params, dtrain, 700, watchlist, early_stopping_rounds=100, maximize=False, verbose_eval=50)","e99b1a21":"y_train_pred = model.predict(dtrain)\ny_pred = model.predict(dvalid)\nprint('Train r2 score: ', r2_score(y_train_pred, y_train))\nprint('Test r2 score: ', r2_score(y_test, y_pred))\ntrain_rmse = np.sqrt(mean_squared_error(y_train_pred, y_train))\ntest_rmse = np.sqrt(mean_squared_error(y_test, y_pred))\nprint(f'Train RMSE: {train_rmse:.4f}')\nprint(f'Test RMSE: {test_rmse:.4f}')","0a5834ff":"test_preds = model.predict(dtest)","7413b752":"test_preds = model.predict(dtest)\n\nsubmission = pd.DataFrame(\n    {'key': key, 'fare_amount': test_preds},\n    columns = ['key', 'fare_amount'])\nsubmission.to_csv('submission1.csv', index = False)","6d2aa3a4":"# NYC Taxi Fare Prediction"}}