{"cell_type":{"c29a1999":"code","6eed1cc5":"code","fdc66ae6":"code","6d134949":"code","b9ddaf4a":"code","92d3ab33":"code","a82601b4":"code","3104d28f":"code","755345af":"code","c5375bc7":"code","b8f4a54e":"code","0d4901ba":"code","77be4307":"code","0305d022":"code","a9d8ead7":"markdown","d07f0a90":"markdown","de9c4070":"markdown","e18fa36b":"markdown","138b554e":"markdown","150a39c0":"markdown","7285cafd":"markdown","4dcf95ca":"markdown","35eb0bd3":"markdown","aa52e5be":"markdown","98b13a8e":"markdown","15e07128":"markdown"},"source":{"c29a1999":"import datetime\n\nimport numpy as np\nimport matplotlib.pyplot as plt\nimport pandas as pd\n\nfrom scipy.integrate import odeint\nfrom scipy.optimize import differential_evolution\n\nfrom sklearn.metrics import r2_score","6eed1cc5":"covid19_df = pd.read_csv(\"..\/input\/covid19turkey\/Covid19-Turkey.csv\")\ncovid19_df.tail()","fdc66ae6":"def SIR(x, t, BETA, GAMMA):\n    S, I, R = x\n\n    N = S + I + R\n\n    dSdt = -(BETA * S * I) \/ N\n    dIdt = ((BETA * S * I) \/ N) - (GAMMA * I)\n    dRdt = GAMMA * I\n\n    return dSdt, dIdt, dRdt","6d134949":"def SIRD(x, t, BETA, GAMMA, MU):\n    S, I, R, D = x\n\n    N = S + I + R + D\n\n    dSdt = -(BETA * S * I) \/ N\n    dIdt = ((BETA * S * I) \/ N) - (GAMMA * I) - (MU * I)\n    dRdt = GAMMA * I\n    dDdt = MU * I\n\n    return dSdt, dIdt, dRdt, dDdt","b9ddaf4a":"T = len(covid19_df) * 10\nday_count = len(covid19_df)\nt = np.linspace(0, day_count, T)","92d3ab33":"population = 83_154_997 # Based on December 2019\nsir_y0 = (1.0, 1 \/ population, 0) # num. of susceptibles, num. of initial infected count, num. of removed\nsird_y0 = (1.0, 1 \/ population, 0, 0) # num. of susceptibles, num. of initial infected count, num. of recovered, num. of deceased","a82601b4":"def sir_loss_1(x):\n    BETA, GAMMA = x\n\n    if BETA < 0 or GAMMA < 0:\n        return np.inf\n    \n    y = odeint(SIR, sir_y0, t, args=(BETA, GAMMA))\n\n    step = np.round((1 \/ day_count) * T).astype(int)\n\n    I = y[0:step * len(covid19_df):step, 1]\n    R = y[0:step * len(covid19_df):step, 2]\n    \n    return -r2_score(I, covid19_df[\"Active Cases\"].values \/ population)\n\n    #return (np.abs(I - covid19_df[\"Active Cases\"].values \/ population).sum() \/ len(I))\n\ndef sir_loss_2(x):\n    BETA, GAMMA = x\n\n    if BETA < 0 or GAMMA < 0:\n        return np.inf\n    \n    y = odeint(SIR, sir_y0, t, args=(BETA, GAMMA))\n\n    step = np.round((1 \/ day_count) * T).astype(int)\n\n    I = y[0:step * len(covid19_df):step, 1]\n    R = y[0:step * len(covid19_df):step, 2]\n    \n    return -r2_score(R, ((covid19_df[\"Total Recovered\"].values + covid19_df[\"Total Deaths\"].values) \/ population))\n\n    #return (np.abs(R - ((covid19_df[\"Total Recovered\"].values + covid19_df[\"Total Deaths\"].values) \/ population)).sum() \/ len(R))\n\ndef sir_loss_3(x):\n    BETA, GAMMA = x\n\n    if BETA < 0 or GAMMA < 0:\n        return np.inf\n    \n    y = odeint(SIR, sir_y0, t, args=(BETA, GAMMA))\n\n    step = np.round((1 \/ day_count) * T).astype(int)\n\n    I = y[0:step * len(covid19_df):step, 1]\n    R = y[0:step * len(covid19_df):step, 2]\n    \n    return -(r2_score(I, covid19_df[\"Active Cases\"].values \/ population) + r2_score(R, ((covid19_df[\"Total Recovered\"].values + covid19_df[\"Total Deaths\"].values) \/ population)))\n\n#     return (np.abs(I - covid19_df[\"Active Cases\"].values \/ population).sum() \/ len(I)) + \\\n#         (np.abs(R - ((covid19_df[\"Total Recovered\"].values + covid19_df[\"Total Deaths\"].values) \/ population)).sum() \/ len(R))","3104d28f":"def sird_loss(x):\n    BETA, GAMMA, MU = x\n\n    if BETA < 0 or GAMMA < 0 or MU < 0:\n        return np.inf\n    \n    y = odeint(SIRD, sird_y0, t, args=(BETA, GAMMA, MU))\n\n    step = np.round((1 \/ day_count) * T).astype(int)\n\n    I = y[0:step * len(covid19_df):step, 1]\n    R = y[0:step * len(covid19_df):step, 2]\n    D = y[0:step * len(covid19_df):step, 3]\n    \n    return -(r2_score(I, covid19_df[\"Active Cases\"].values \/ population) + \\\n        r2_score(R, covid19_df[\"Total Recovered\"].values \/ population) + \\\n        r2_score(D, covid19_df[\"Total Deaths\"].values \/ population))\n\n#     return (np.abs(I - covid19_df[\"Active Cases\"].values \/ population).sum() \/ len(I)) + \\\n#         (np.abs(R - covid19_df[\"Total Recovered\"].values \/ population).sum() \/ len(R)) + \\\n#         (np.abs(D - covid19_df[\"Total Deaths\"].values \/ population).sum() \/ len(D))","755345af":"sir_res_loss_1 = differential_evolution(\n    sir_loss_1,\n    ((0, 50), (0, 50)),\n    tol=0.00001\n)\n\nsir_res_loss_2 = differential_evolution(\n    sir_loss_2,\n    ((0, 100), (0, 100)),\n    tol=0.00001\n)\n\nsir_res_loss_3 = differential_evolution(\n    sir_loss_3,\n    ((0, 100), (0, 100)),\n    tol=0.00001\n)\n\nsird_res_loss = differential_evolution(\n    sird_loss,\n    ((0, 100), (0, 100), (0, 100)),\n    tol=0.00001\n)","c5375bc7":"print(\"SIR Loss 1:\")\nprint(sir_res_loss_1)\nprint(\"R0:\", sir_res_loss_1.x[0] \/ sir_res_loss_1.x[1])\nprint()\n\nprint(\"SIR Loss 2:\")\nprint(sir_res_loss_2)\nprint(\"R0:\", sir_res_loss_2.x[0] \/ sir_res_loss_2.x[1])\nprint()\n\nprint(\"SIR Loss 3:\")\nprint(sir_res_loss_3)\nprint(\"R0:\", sir_res_loss_3.x[0] \/ sir_res_loss_3.x[1])\nprint()\nprint(50 * \"#\")\nprint()\n\nprint(\"SIRD Loss:\")\nprint(sird_res_loss)\nprint(\"R0:\", sird_res_loss.x[0] \/ sird_res_loss.x[1])","b8f4a54e":"step = np.round((1 \/ day_count) * T).astype(int)\n\nsir_y_loss_1 = odeint(SIR, sir_y0, t, args=(sir_res_loss_1.x[0], sir_res_loss_1.x[1]))\nsir_y_loss_2 = odeint(SIR, sir_y0, t, args=(sir_res_loss_2.x[0], sir_res_loss_2.x[1]))\nsir_y_loss_3 = odeint(SIR, sir_y0, t, args=(sir_res_loss_3.x[0], sir_res_loss_3.x[1]))\n\nsir_S_loss_1 = sir_y_loss_1[:, 0]\nsir_I_loss_1 = sir_y_loss_1[:, 1]\nsir_R_loss_1 = sir_y_loss_1[:, 2]\n\nsir_S_loss_2 = sir_y_loss_2[:, 0]\nsir_I_loss_2 = sir_y_loss_2[:, 1]\nsir_R_loss_2 = sir_y_loss_2[:, 2]\n\nsir_S_loss_3 = sir_y_loss_3[:, 0]\nsir_I_loss_3 = sir_y_loss_3[:, 1]\nsir_R_loss_3 = sir_y_loss_3[:, 2]","0d4901ba":"fig, ax = plt.subplots(3, 1, figsize=(20, 10), constrained_layout=True)\n\nax[0].plot(t, sir_I_loss_1, label=\"# of infectives\")\nax[0].plot(t, sir_R_loss_1, label=\"# of removed\")\nax[0].plot(t[0:step * len(covid19_df):step], covid19_df[\"Active Cases\"].values \/ population, label=\"# of real infectives\")\nax[0].plot(t[0:step * len(covid19_df):step], (covid19_df[\"Total Recovered\"] + covid19_df[\"Total Deaths\"]) \/ population, label=\"# of real removed\")\nax[0].set_xlabel(\"Days\")\nax[0].set_ylabel(\"Normalized Population\")\nax[0].set_title(\"147 Days of Simuation w\/ Loss 1\")\nax[0].legend()\n\nax[1].plot(t, sir_I_loss_2, label=\"# of infectives\")\nax[1].plot(t, sir_R_loss_2, label=\"# of removed\")\nax[1].plot(t[0:step * len(covid19_df):step], covid19_df[\"Active Cases\"].values \/ population, label=\"# of real infectives\")\nax[1].plot(t[0:step * len(covid19_df):step], (covid19_df[\"Total Recovered\"] + covid19_df[\"Total Deaths\"]) \/ population, label=\"# of real removed\")\nax[1].set_xlabel(\"Days\")\nax[1].set_ylabel(\"Normalized Population\")\nax[1].set_title(\"147 Days of Simuation w\/ Loss 2\")\nax[1].legend()\n\nax[2].plot(t, sir_I_loss_3, label=\"# of infectives\")\nax[2].plot(t, sir_R_loss_3, label=\"# of removed\")\nax[2].plot(t[0:step * len(covid19_df):step], covid19_df[\"Active Cases\"].values \/ population, label=\"# of real infectives\")\nax[2].plot(t[0:step * len(covid19_df):step], (covid19_df[\"Total Recovered\"] + covid19_df[\"Total Deaths\"]) \/ population, label=\"# of real removed\")\nax[2].set_xlabel(\"Days\")\nax[2].set_ylabel(\"Normalized Population\")\nax[2].set_title(\"147 Days of Simuation w\/ Loss 3\")\nax[2].legend()\n\nplt.show()","77be4307":"step = np.round((1 \/ day_count) * T).astype(int)\n\nsird_y_loss = odeint(SIRD, sird_y0, t, args=(sird_res_loss.x[0], sird_res_loss.x[1], sird_res_loss.x[2]))\n\nsird_S_loss = sird_y_loss[:, 0]\nsird_I_loss = sird_y_loss[:, 1]\nsird_R_loss = sird_y_loss[:, 2]\nsird_D_loss = sird_y_loss[:, 3]","0305d022":"fig, ax = plt.subplots(1, 1, figsize=(20, 6), constrained_layout=True)\n\nax.plot(t, sird_I_loss, label=\"# of infectives\")\nax.plot(t, sird_R_loss, label=\"# of recovered\")\nax.plot(t, sird_D_loss, label=\"# of deceased\")\nax.plot(t[0:step * len(covid19_df):step], covid19_df[\"Active Cases\"].values \/ population, label=\"# of real infectives\")\nax.plot(t[0:step * len(covid19_df):step], covid19_df[\"Total Recovered\"] \/ population, label=\"# of real recovered\")\nax.plot(t[0:step * len(covid19_df):step], covid19_df[\"Total Deaths\"] \/ population, label=\"# of real deceased\")\nax.set_xlabel(\"Days\")\nax.set_ylabel(\"Normalized Population\")\nax.set_title(\"147 Days of Simuation w\/ Loss\")\nax.legend()\n\nplt.show()","a9d8ead7":"# Conclusion\n\nWhich loss function do you think fits the data better than the others?\n\nI think the model with *Loss 1* fits the data better than the others. This proves that if the published number of infectives are correct, then the other numbers are incorrect according to this specific simple SIR model.\n\nIn the next versions, I will add more sophisticated models to the notebook. See you.","d07f0a90":"# Optimization\n\n## The SIR Model\n\nThe choice of loss function is based on three assumptions. Each of the loss functions are the *Mean Absolute Errors (MAE)* of different parameters.\n\n1. The first assumption is the number of infected people is published correctly and the number of removed people is published incorrectly. In this case, the loss function is as follows:\n\n$$\nLoss_1 = \\frac{1}{N} \\sum_{k=0}^{N} \\lvert y_k^I - \\hat{y}_k^I \\rvert\n$$\n\n2. The second assumption is the number of infected people is published incorrectly and the number of removed people is published correctly. In this case, the loss function is as follow:\n\n$$\nLoss_2 = \\frac{1}{N} \\sum_{k=0}^{N} \\lvert y_k^R - \\hat{y}_k^R \\rvert\n$$\n\n3. The third assumption is the both of the infected and removed people count is published correctly. In this case, the loss function is the sum of the loss functions in assumption one and two.\n\n$$\nLoss_3 = Loss_1 + Loss_2\n$$\n\n$N$ is the number of data points, in this case number of days because the steps are adjusted as 1 days of periods. Superscripts $I$ and $R$ indicates the calculations for *infectives* and *removed*.","de9c4070":"# The SIRD Model\n\nThe Susceptible Infectious Recovered Deceased (SIRD) Model differentiates between Recovered (meaning specifically individuals having survived the disease and now immune) and Deceased. This model uses the following system of differential equations:\n\n- Susceptibles: $ \\frac{dS}{dt} = -\\frac{\\beta S I}{N} $,\n- Infectives: $ \\frac{dI}{dt} = \\frac{\\beta S I}{N} - \\gamma I - \\mu I$,\n- Recovered: $ \\frac{dR}{dt} = \\gamma I $,\n- Deceased: $ \\frac{dD}{dt} = \\mu I $,\n\nwhere $\\beta$ $\\gamma$, $\\mu$ are the rates of infection, recovery, and mortality, respectively.","e18fa36b":"# The SIR Model (Kermack-McKendrick)\n\nThe model consists of a system of three coupled nonlinear ordinary differential equations,\n\n- Susceptibles: $ \\frac{dS}{dt} = -\\frac{\\beta S I}{N} $,\n- Infectives: $ \\frac{dI}{dt} = \\frac{\\beta S I}{N} - \\gamma I $,\n- Removed: $ \\frac{dR}{dt} = \\gamma I $,\n\nwhere $N=S + I + R$, $t$ is time, $S(t)$ is the number of susceptible people, $I(t)$ is the number of people infected, $R(t)$ is the number of people who have recovered and developed immunity to the infection, $\\beta$ is the infection rate, and $\\gamma$ is the recovery rate. ","138b554e":"$R_0$, the basic reproduction number, which estimates the speed at which a disease is capable of spreading in a population. Although the currently computed $R_0$ value of 5.66 is extraordinary, it indicates an outbreak.","150a39c0":"I used the `differential_evolution` global optimizer from *Scipy*. You can easily import it from the `scipy.optimize` package. The range of parameters are constrain between 0 and 10.","7285cafd":"## The SIRD Model Results","4dcf95ca":"# The Dataset","35eb0bd3":"# Simulation Parameters","aa52e5be":"# Results\n\nAfter running the simulation, I pinpoint the each 147 days from the simulation time. The step is calculated as follows:\n\n$$\n\\text{STEP}_k = \\lfloor \\frac{k}{D} \\times T \\rceil\n$$\n\nwhere $k=1$ for 1 days of stepping, $D=147$ which is the total simulation time and $T=1000$ which is the number of linearly spaced points in the duration of 147 days. For example, 50th day in real life indicates the $50 \\times \\lfloor \\frac{1}{147} \\times 1000 \\rceil = 340$th data point in simulation.\n\nBy using the above formula, I got the $S$, $I$, and $R$ values from the simulation for each 147 days.\n\n## The SIR Model Results","98b13a8e":"## The SIRD Model\n\nIn the fifth version of the notebook, the loss function for the SIRD model is very similar to the Loss 3 of the SIR model. It is defined as follows:\n\n$$\nMAE_I = \\frac{1}{N} \\sum_{k=0}^{N} \\lvert y_k^I - \\hat{y}_k^I \\rvert \\\\\nMAE_R = \\frac{1}{N} \\sum_{k=0}^{N} \\lvert y_k^R - \\hat{y}_k^R \\rvert \\\\\nMAE_D = \\frac{1}{N} \\sum_{k=0}^{N} \\lvert y_k^D - \\hat{y}_k^D \\rvert \\\\\nLoss = MAE_I + MAE_R + MAE_D\n$$\n\nThe only difference is that the $MAE_D$ term is added for the error computation of the deceased data.","15e07128":"In the below figure, you can see the 147 days of simulation result in addition to the real data. The susceptibles are removed from the figures since in the beginning, the value is pretty high with respect to the other data resulting a viusally destructive plot."}}