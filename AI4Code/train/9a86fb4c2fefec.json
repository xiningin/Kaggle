{"cell_type":{"37c13dcb":"code","86df97b5":"code","c73e012a":"code","96fbb2b4":"code","975f3822":"code","e4329586":"code","c0d47ba7":"code","132dd5db":"code","bd87a4c1":"code","56e9f2b4":"code","dc579b29":"code","8616a077":"code","86ed9c45":"code","0d391b85":"code","74d7aa5e":"code","81faadec":"code","6329321b":"code","cc01a3fa":"code","fcdd8e87":"code","59c417d0":"code","9e4e66a1":"code","15358582":"code","bb8ed192":"code","4648ec9c":"code","1979ba67":"code","a7b86ff6":"code","f91a8aac":"markdown","a14c1338":"markdown"},"source":{"37c13dcb":"from glob import glob\nfrom collections import Counter\nimport os\nimport sys\n\nimport numpy as np\nimport pandas as pd\nfrom tqdm import tqdm\nfrom sklearn.preprocessing import StandardScaler,OneHotEncoder\nfrom sklearn.model_selection import KFold\nimport xgboost as xgb","86df97b5":"def get_building_floor(fname):\n    xx = fname.split('\/')\n    return xx[-3],xx[-2]\n\ndef get_test_building(name):\n    with open(name) as f:\n        for c,line in enumerate(f):\n            if c==1:\n                x = line.split()[1].split(':')[1]\n                return x  \n\ndef get_floor_target(floor):\n    floor = floor.lower()\n    if floor in ['bf','bm']:\n        return None\n    elif floor == 'b':\n        return -1\n    if floor.startswith('f'):\n        return int(floor[1])\n    elif floor.endswith('f'):\n        return int(floor[0])\n    elif floor.startswith('b'):\n        return -int(floor[1])\n    elif floor.endswith('b'):\n        return -int(floor[0])\n    else:\n        return None\n        \nACOLS = ['timestamp','x','y','z']\n        \nFIELDS = {\n    'acce': ACOLS,\n    'acce_uncali': ACOLS,\n    'gyro': ACOLS,\n    'gyro_uncali': ACOLS,\n    'magn': ACOLS,\n    'magn_uncali': ACOLS,\n    'ahrs': ACOLS,\n    'wifi': ['timestamp','ssid','bssid','rssi','last_timestamp'],\n    'ibeacon': ['timestamp','code','rssi'],\n    'waypoint': ['timestamp','x','y']\n}\n\nNFEAS = {\n    'acce': 3,\n    'acce_uncali': 3,\n    'gyro': 3,\n    'gyro_uncali': 3,\n    'magn': 3,\n    'magn_uncali': 3,\n    'ahrs': 3,\n    'wifi': 1,\n    'ibeacon': 1,\n    'waypoint': 3\n}","c73e012a":"PATH = '..\/input\/indoor-location-navigation'","96fbb2b4":"def mpe(yp, y):\n    e1 = (yp[:,0] - y[:,0])**2 + (yp[:,1] - y[:,1])**2\n    e2 = 15*np.abs(yp[:,2] - y[:,2])\n    return np.mean(e1**0.5 + e2)","975f3822":"db = pd.read_csv('..\/input\/extracteddata\/feature.csv')","e4329586":"cols = ['F' + str(i) for i in range(244)]","c0d47ba7":"X = np.asarray(db[cols])","132dd5db":"df = pd.read_csv('..\/input\/extracteddata\/target.csv')\ndf = df[df.columns[1:]]","bd87a4c1":"test_files = glob(f'{PATH}\/test\/*.txt')\nlen(test_files)","56e9f2b4":"%%time\ntest_b = []\nfor name in tqdm(test_files):\n    test_b.append(get_test_building(name))\ntest_b = np.array(test_b)","dc579b29":"db = pd.read_csv('..\/input\/extracteddata\/feature_test.csv')","8616a077":"%%time\nXt = np.asarray(db[cols])\nXt.shape","86ed9c45":"params2 = {\n        'booster' : 'gbtree',\n        'objective': 'reg:linear',\n        'eval_metric': 'mae',\n        'eta':0.1,\n        'depth':7,\n        'nthread':2,\n        'verbosity': 0,\n    }","0d391b85":"params = {\n        'booster' : 'gblinear',\n        'objective': 'reg:squarederror',\n        'eval_metric': 'rmse',\n        ''\n        'eta':0.1,\n        'depth':7,\n        'nthread':2,\n        'verbosity': 0,\n    }","74d7aa5e":"N = 5\ndtest = xgb.DMatrix(data=Xt)\nysub = np.zeros([Xt.shape[0],3])\n\nkf = KFold(n_splits=N,shuffle=True,random_state=42)\n\nmsgs = []\nfor i,(train_index, test_index) in enumerate(kf.split(X)):\n    X_train, X_test = X[train_index], X[test_index]\n    yps = np.zeros([X_test.shape[0],3])\n    yrs = yps.copy()\n    for c,col in enumerate(['w_x','w_y','floors']):\n        y = df[col].values\n        y_train, y_test = y[train_index], y[test_index]\n        print(y_train.shape)            \n        dtrain = xgb.DMatrix(data=X_train, label=y_train)\n        dvalid = xgb.DMatrix(data=X_test, label=y_test)\n        watchlist = [(dtrain, 'train'), (dvalid, 'eval')] \n        if c != 2:\n            clf = xgb.train(params, dtrain=dtrain,\n                        num_boost_round=70,evals=watchlist,\n                        early_stopping_rounds=10,\n                       verbose_eval=100)\n        else:\n            clf = xgb.train(params2, dtrain=dtrain,\n                        num_boost_round=70,evals=watchlist,\n                        early_stopping_rounds=10,\n                       verbose_eval=100)            \n            \n        yp = clf.predict(dvalid)\n        yps[:,c] = yp\n        yrs[:,c] = y_test\n        ysub[:,c] += clf.predict(dtest)\n    msg = f'Fold {i}: MPE {mpe(yps, yrs):.4f}'\n    print(msg)\n    msgs.append(msg)\nysub = ysub\/N","81faadec":"msgs","6329321b":"sub = pd.read_csv(f'{PATH}\/sample_submission.csv')\nsub.head()","cc01a3fa":"sub.shape","fcdd8e87":"sub['site'] = sub['site_path_timestamp'].apply(lambda x: x.split('_')[0])\nsub.head()","59c417d0":"test_map = {i:j for i,j in zip(test_b, test_files)}\nsub['filename'] = sub['site'].apply(lambda x: test_map[x])\nsub.head()","9e4e66a1":"ds = pd.DataFrame(ysub,columns=['x','y','floor'])\nds.head()","15358582":"ds['filename'] = test_files\nds.head()","bb8ed192":"sub = sub.drop(['x','y','floor'],axis=1).merge(ds,on='filename',how='left')\nprint(sub.shape)\nsub.head()","4648ec9c":"for i in sub.columns:\n    print(i,sub[i].isnull().sum())","1979ba67":"sub['floor'] = sub['floor'].astype('int')\nsub.head()","a7b86ff6":"sub.drop(['site','filename'],axis=1).to_csv('submission.csv',index=False)","f91a8aac":"#  REF:https:\/\/www.kaggle.com\/jiweiliu\/dask-with-simple-xgb","a14c1338":"### Train XGB"}}