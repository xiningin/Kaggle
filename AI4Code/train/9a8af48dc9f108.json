{"cell_type":{"21fe889e":"code","0b8e2467":"code","ea7e47b9":"code","959d0e08":"code","73e7978f":"code","c946108b":"code","3afa5e13":"code","e733bf7f":"code","09857d0c":"code","238d99d0":"code","ad24202d":"code","5438d7fa":"code","003c9911":"code","f3b911b6":"code","a5a3769c":"code","b5f97d77":"code","b46c1722":"code","33cae2a8":"code","cef22a5d":"code","d5a56e9c":"code","242cd255":"code","234b73b7":"code","1fb22f22":"code","e7ad0625":"code","7bac8543":"code","b2e18856":"code","f424b5df":"code","e9da85a6":"code","df94caf9":"code","e715bb73":"code","b5631c29":"code","04a263f5":"code","3f97bea9":"code","bec36c56":"code","bae05c5e":"code","85cf85f9":"code","70b7661d":"code","fca8fe49":"code","c3e189a7":"code","2a5155b0":"code","e1c2ba4e":"code","bd78c5a3":"code","87ef3c77":"markdown","71becbf3":"markdown","6d1d892d":"markdown","db766a9b":"markdown","599277cf":"markdown"},"source":{"21fe889e":"import datetime as dt\nimport pandas as pd\nimport numpy as np\nfrom sklearn.preprocessing import StandardScaler\nfrom sklearn.cluster import KMeans\nimport seaborn as sns\n\nimport squarify\nimport matplotlib.pyplot as plt\n%matplotlib inline","0b8e2467":"# Import datasets\ndata = pd.read_csv('..\/input\/online-retail-customer-clustering\/OnlineRetail.csv', sep=\",\", encoding=\"ISO-8859-1\", header=0)\ndata.head()","ea7e47b9":"data.isnull().sum()","959d0e08":"data = data.dropna()\ndata.shape","73e7978f":"#checking for duplicates\ndata.duplicated().sum()","c946108b":"#removing duplicates\ndata.drop_duplicates(keep='first', inplace=True)\ndata.shape","3afa5e13":"#let's do a copy of our df for next manipulations\nretail = data.copy()","e733bf7f":"#calculate revenue per row and add new column\nretail['Revenue'] = retail['Quantity'] * retail['UnitPrice']","09857d0c":"retail.InvoiceDate = pd.to_datetime(retail['InvoiceDate'], format='%d-%m-%Y %H:%M')","238d99d0":"# Let's visualize the top grossing months\nretail_month = retail[retail.InvoiceDate.dt.year==2011]\nmonthly_gross = retail_month.groupby(retail_month.InvoiceDate.dt.month).Revenue.sum()\n\nplt.figure(figsize=(8,4))\nsns.set_context(\"talk\")\nsns.set_palette(\"PuBuGn_d\")\nsns.lineplot(y=monthly_gross.values,x=monthly_gross.index, marker='o')\nplt.xticks(range(1,13))\nplt.title(\"Revenue per month in 2011\")\nplt.show()","ad24202d":"#amount of transactions per month\nplt.figure(figsize=(8,4))\nretail[retail.InvoiceDate.dt.year==2011].InvoiceDate.dt.month.value_counts(sort=False).plot(kind='bar')\nplt.title(\"Amount of transactions per month in 2011\")\nplt.show()","5438d7fa":"# Let's visualize some top products from the whole range\ntop_products = retail['Description'].value_counts()[:20]\nplt.figure(figsize=(8,6))\nsns.set_context(\"paper\", font_scale=1.5)\nsns.barplot(y = top_products.index,\n            x = top_products.values, \n           palette='PuBuGn_d')\nplt.title(\"Top selling products\")\nplt.show()\nplt.savefig('top_products.png')","003c9911":"#creating invoice month column to see first month when customer purchased \nretail['InvoiceMonth'] = retail['InvoiceDate'].apply(lambda x: dt.datetime(x.year, x.month, 1))","f3b911b6":"grouping = retail.groupby('CustomerID')['InvoiceMonth']\n#assign smallest invoice value to each customer\nretail['CohortMonth'] = grouping.transform('min')\nretail.head()","a5a3769c":"#function to extract year, month, day as integers\ndef get_date_int(df, column):\n    year = df[column].dt.year\n    month = df[column].dt.month\n    day = df[column].dt.day\n    return year, month, day","b5f97d77":"#extract month\ninvoice_year, invoice_month, _ = get_date_int(retail, 'InvoiceMonth')\ncohort_year, cohort_month, _ = get_date_int(retail, 'CohortMonth')","b46c1722":"years_diff = invoice_year - cohort_year\nmonths_diff = invoice_month - cohort_month","33cae2a8":"# Extract the difference in days from all previous values\nretail['CohortIndex'] = years_diff * 12 + months_diff + 1\nretail.head()","cef22a5d":"#count monthly active customers from each cohort\ngrouping = retail.groupby(['CohortMonth', 'CohortIndex'])\ncohort_data = grouping['CustomerID'].apply(pd.Series.nunique)\ncohort_data = cohort_data.reset_index()\ncohort_counts = cohort_data.pivot(index='CohortMonth', columns = 'CohortIndex', values='CustomerID')","d5a56e9c":"#Customer retention\ncohort_sizes = cohort_counts.iloc[:,0]\nretention = cohort_counts.divide(cohort_sizes, axis=0)\nretention = retention.round(3) * 100\nretention.head(20)","242cd255":"month_list = [\"Dec '10\", \"Jan '11\", \"Feb '11\", \"Mar '11\", \"Apr '11\",\\\n              \"May '11\", \"Jun '11\", \"Jul '11\", \"Aug '11\", \"Sep '11\", \\\n              \"Oct '11\", \"Nov '11\", \"Dec '11\"]\n\nplt.figure(figsize=(15,8))\nplt.title('Retention by Monthly Cohorts')\nsns.heatmap(data=retention,\n            annot = True,\n            cmap = \"Greens\",\n            vmin = 0.0,\n            vmax = list(retention.max().sort_values(ascending = False))[1]+3,\n            fmt = '.1f',\n            linewidth = 0.3,\n            yticklabels=month_list)\n\nplt.show()","234b73b7":"#12 months of data\nprint('Min:{}; Max:{}'.format(min(retail.InvoiceDate), max(retail.InvoiceDate)))","1fb22f22":"#calculate revenue per row and add new column\nretail['MonetaryValue'] = retail['Quantity'] * retail['UnitPrice']","e7ad0625":"#let's look at amount spend per customer (revenue contributed) M-Monetary\nretail_mv = retail.groupby(['CustomerID']).agg({'MonetaryValue': sum}).reset_index()\nretail_mv.head()","7bac8543":"#F-frequency (how many purchases each customer made)\nretail_f = retail.groupby('CustomerID')['InvoiceNo'].count()\nretail_f = retail_f.reset_index()\nretail_f.head()","b2e18856":"#merge previous dataframes together (mv+f)\nretail_mv_f = pd.merge(retail_mv, retail_f, on='CustomerID', how='inner')\nretail_mv_f.head()","f424b5df":"#R-recency \n#last transaction date \n\nretail['InvoiceDate'] = pd.to_datetime(retail['InvoiceDate'],format='%d-%m-%Y %H:%M')\nmax_date = max(retail['InvoiceDate'])\n\n#difference between last date and transaction date\nretail['Diff'] = max_date - retail['InvoiceDate']\nretail.head()","e9da85a6":"#recency per customer (last transaction date)\nretail_r = retail.groupby('CustomerID')['Diff'].min()\nretail_r = retail_r.reset_index()\n\n# Extract number of days only\nretail_r['Diff'] = retail_r['Diff'].dt.days","df94caf9":"#merge R dataframe with FM\n\nretail_rfm = pd.merge(retail_mv_f, retail_r, on='CustomerID', how='inner')\nretail_rfm.columns = ['CustomerID', 'MonetaryValue', 'Frequency', 'Recency']\nretail_rfm.head()","e715bb73":"cols = retail_rfm.columns.tolist()\ncols","b5631c29":"#changed columns order\ncols = ['CustomerID', 'Recency', 'Frequency', 'MonetaryValue']\nretail_rfm = retail_rfm[cols]\nretail_rfm.head()","04a263f5":"# create labels and assign them to tree percentile groups \nr_labels = range(4, 0, -1)\nr_groups = pd.qcut(retail_rfm.Recency, q = 4, labels = r_labels)\nf_labels = range(1, 5)\nf_groups = pd.qcut(retail_rfm.Frequency, q = 4, labels = f_labels)\nm_labels = range(1, 5)\nm_groups = pd.qcut(retail_rfm.MonetaryValue, q = 4, labels = m_labels)","3f97bea9":"# make a new column for group labels\nretail_rfm['R'] = r_groups.values\nretail_rfm['F'] = f_groups.values\nretail_rfm['M'] = m_groups.values\n# sum up the three columns\nretail_rfm['RFM_Segment'] = retail_rfm.apply(lambda x: str(x['R']) + str(x['F']) + str(x['M']), axis = 1)\nretail_rfm['RFM_Score'] = retail_rfm[['R', 'F', 'M']].sum(axis = 1)\nretail_rfm.head()","bec36c56":"# assign labels from total score\nscore_labels = ['Green', 'Bronze', 'Silver', 'Gold']\nscore_groups = pd.qcut(retail_rfm.RFM_Score, q = 4, labels = score_labels)\nretail_rfm['RFM_Level'] = score_groups.values\nretail_rfm.sort_values(by='RFM_Score', ascending=False)\nretail_rfm.head(10)","bae05c5e":"retail_rfm_levels = retail_rfm.groupby('RFM_Level')['CustomerID'].count().reset_index(name='counts')\nretail_rfm_levels.head()","85cf85f9":"#let's exclude others segment for visualization\nlevels = list(retail_rfm_levels.RFM_Level)\nscore = list(retail_rfm_levels.counts)\nplt.figure(figsize=(12,8))\nplt.title('Customer Levels distribution')\nsquarify.plot(sizes=score, label=levels)\n\nplt.show()","70b7661d":"#let's try to do more detailed segmentation\nsegment_dict = {    \n    'Best Customers':'444',      # Highest frequency as well as monetary value with least recency\n    'Loyal Customers':'344',     # High frequency as well as monetary value with good recency\n    'Potential Loyalists':'434', # High recency and monetary value, average frequency\n    'Big Spenders':'334',        # High monetary value but good recency and frequency values\n    'At Risk Customers':'244',   # Customer's shopping less often now who used to shop a lot\n    'Can\u2019t Lose Them':'144',      # Customer's shopped long ago who used to shop a lot.\n    'Recent Customers':'443',    # Customer's who recently started shopping a lot but with less monetary value\n    'Lost Cheap Customers':'122' # Customer's shopped long ago but with less frequency and monetary value\n}","fca8fe49":"# Swap the key and value of dictionary\ndict_segment = dict(zip(segment_dict.values(),segment_dict.keys()))\n\n# Allocate segments to each customer as per the RFM score mapping\nretail_rfm['Segment'] = retail_rfm.RFM_Segment.map(lambda x: dict_segment.get(x))","c3e189a7":"# Allocate all remaining customers to others segment category\nretail_rfm.Segment.fillna('others', inplace=True)","2a5155b0":"retail_rfm.sample(10)","e1c2ba4e":"retail_rfm_segments = retail_rfm[retail_rfm.Segment!='other'].groupby('Segment')['CustomerID'].count().reset_index(name='counts')\nretail_rfm_segments.iloc[:8]","bd78c5a3":"#let's exclude others segment for visualization\nsegment = list(retail_rfm_segments.iloc[:8].Segment)\nscore = list(retail_rfm_segments.iloc[:8].counts)\ncolor_list = [\"#248af1\", \"#eb5d50\", \"#8bc4f6\", \"#8c5c94\", \"#a170e8\", \"#fba521\", \"#75bc3f\"]\nplt.figure(figsize=(12,8))\nplt.title('Customer Segments distribution')\nsquarify.plot(sizes=score, label=segment,color=color_list, alpha=0.7)\n\nplt.show()","87ef3c77":"# **Cohort Analysis**\n\nAssign acquisition month cohort to each customer","71becbf3":"# **Exploration of the data**","6d1d892d":"Let's do a bit of cleaning.","db766a9b":"# **RFM analysis**","599277cf":"which customers are the best ones by examining how recently a customer has purchased (recency), how often they purchase (frequency), and how much the customer spends (monetary)"}}