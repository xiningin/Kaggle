{"cell_type":{"c347e184":"code","1454ef5e":"code","1e2a53d3":"code","4a060b51":"code","039d36a8":"code","22651b5b":"code","00effed2":"code","cf3aea84":"code","617a4606":"code","728a2376":"code","25eb59dd":"code","a672954a":"code","77719fad":"code","9271dd2c":"code","3d6d5060":"code","42dd4392":"code","a36fd985":"code","8a8e367a":"markdown","329d21e3":"markdown","b13debf6":"markdown","610097b3":"markdown","843efe0f":"markdown","e35a8c2d":"markdown","b475a9aa":"markdown","aab9d2c2":"markdown","2b18bdf8":"markdown","7302de54":"markdown","2036a1ab":"markdown","0a71b2db":"markdown","967f65b2":"markdown","b5e53d07":"markdown","5c1248c2":"markdown","7eb16f9f":"markdown"},"source":{"c347e184":"import numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\nimport cv2\nfrom scipy.spatial import distance\n# Input data files are available in the read-only \"..\/input\/\" directory\n# For example, running this (by clicking run or pressing Shift+Enter) will list all files under the input directory\n\nimport os\nfor dirname, _, filenames in os.walk('\/kaggle\/input'):\n    for filename in filenames:\n        print(os.path.join(dirname, filename))","1454ef5e":"#loading haarcascade_frontalface_default.xml\nface_model = cv2.CascadeClassifier('..\/input\/haarcascades\/haarcascade_frontalface_default.xml')","1e2a53d3":"import matplotlib.pyplot as plt\n#trying it out on a sample image\nimg = cv2.imread('..\/input\/face-mask-detection\/images\/maksssksksss244.png')\n\nimg = cv2.cvtColor(img, cv2.IMREAD_GRAYSCALE)\n\nfaces = face_model.detectMultiScale(img,scaleFactor=1.1, minNeighbors=4) #returns a list of (x,y,w,h) tuples\n\nout_img = cv2.cvtColor(img, cv2.COLOR_RGB2BGR) #colored output image\n\n#plotting\nfor (x,y,w,h) in faces:\n    cv2.rectangle(out_img,(x,y),(x+w,y+h),(0,0,255),1)\nplt.figure(figsize=(12,12))\nplt.imshow(out_img)","4a060b51":"MIN_DISTANCE = 130","039d36a8":"if len(faces)>=2:\n    label = [0 for i in range(len(faces))]\n    for i in range(len(faces)-1):\n        for j in range(i+1, len(faces)):\n            dist = distance.euclidean(faces[i][:2],faces[j][:2])\n            if dist<MIN_DISTANCE:\n                label[i] = 1\n                label[j] = 1\n    new_img = cv2.cvtColor(img, cv2.COLOR_RGB2BGR) #colored output image\n    for i in range(len(faces)):\n        (x,y,w,h) = faces[i]\n        if label[i]==1:\n            cv2.rectangle(new_img,(x,y),(x+w,y+h),(255,0,0),1)\n        else:\n            cv2.rectangle(new_img,(x,y),(x+w,y+h),(0,255,0),1)\n    plt.figure(figsize=(10,10))\n    plt.imshow(new_img)\n            \nelse:\n    print(\"No. of faces detected is less than 2\")","22651b5b":"from keras import applications\n\nfrom keras import Sequential\nfrom keras.layers import Flatten, Dense\nfrom keras.preprocessing.image import ImageDataGenerator","00effed2":"#Load train and test set\ntrain_dir = '..\/input\/face-mask-12k-images-dataset\/Face Mask Dataset\/Train'\ntest_dir = '..\/input\/face-mask-12k-images-dataset\/Face Mask Dataset\/Test'\nval_dir = '..\/input\/face-mask-12k-images-dataset\/Face Mask Dataset\/Validation'","cf3aea84":"# Data augmentation\n\ntrain_datagen = ImageDataGenerator(rescale=1.0\/255, horizontal_flip=True, zoom_range=0.2,shear_range=0.2)\ntrain_generator = train_datagen.flow_from_directory(directory=train_dir,target_size=(128,128),class_mode='categorical',batch_size=32)\n\nval_datagen = ImageDataGenerator(rescale=1.0\/255)\nval_generator = train_datagen.flow_from_directory(directory=val_dir,target_size=(128,128),class_mode='categorical',batch_size=32)\n\ntest_datagen = ImageDataGenerator(rescale=1.0\/255)\ntest_generator = train_datagen.flow_from_directory(directory=val_dir,target_size=(128,128),class_mode='categorical',batch_size=32)","617a4606":"\nnet = applications.MobileNetV2(weights='imagenet',include_top=False,input_shape=(128,128,3))\n\nfor layer in net.layers:\n    layer.trainable = False\n    \nmodel = Sequential()\nmodel.add(net)\nmodel.add(Flatten())\nmodel.add(Dense(2,activation='sigmoid'))\nmodel.summary()","728a2376":"model.compile(optimizer=\"adam\",loss=\"categorical_crossentropy\",metrics =\"accuracy\")","25eb59dd":"history = model.fit_generator(generator=train_generator,\n                              steps_per_epoch=len(train_generator)\/\/32,\n                              epochs=20,validation_data=val_generator,\n                              validation_steps=len(val_generator)\/\/32)","a672954a":"model.evaluate_generator(test_generator)","77719fad":"sample_mask_img = cv2.imread('..\/input\/face-mask-12k-images-dataset\/Face Mask Dataset\/Test\/WithMask\/1565.png')\nsample_mask_img = cv2.resize(sample_mask_img,(128,128))\nplt.imshow(sample_mask_img)\nsample_mask_img = np.reshape(sample_mask_img,[1,128,128,3])\nsample_mask_img = sample_mask_img\/255.0","9271dd2c":"model.predict(sample_mask_img)","3d6d5060":"model.save('masknet.h5')","42dd4392":"mask_label = {0:'MASK',1:'NO MASK'}\ndist_label = {0:(0,255,0),1:(255,0,0)}","a36fd985":"if len(faces)>=2:\n    label = [0 for i in range(len(faces))]\n    for i in range(len(faces)-1):\n        for j in range(i+1, len(faces)):\n            dist = distance.euclidean(faces[i][:2],faces[j][:2])\n            if dist<MIN_DISTANCE:\n                label[i] = 1\n                label[j] = 1\n    new_img = cv2.cvtColor(img, cv2.COLOR_RGB2BGR) #colored output image\n    for i in range(len(faces)):\n        (x,y,w,h) = faces[i]\n        crop = new_img[y:y+h,x:x+w]\n        crop = cv2.resize(crop,(128,128))\n        crop = np.reshape(crop,[1,128,128,3])\/255.0\n        mask_result = model.predict(crop)\n        cv2.putText(new_img,mask_label[mask_result.argmax()],(x, y-10),cv2.FONT_HERSHEY_SIMPLEX,0.5,dist_label[label[i]],2)\n        cv2.rectangle(new_img,(x,y),(x+w,y+h),dist_label[label[i]],1)\n    plt.figure(figsize=(10,10))\n    plt.imshow(new_img)\n            \nelse:\n    print(\"No. of faces detected is less than 2\")","8a8e367a":"**Objective** is to build a Deep Learning model which can identify if the person is wearing a mask or not, also detecting if people vilating social distancing norms.","329d21e3":"### Building MobileNetV2 transfer learning model.","b13debf6":"### Save the model.","610097b3":"### Detecting social distancing violations\n\nThis can be done by iterating over the coordinates of faces and calculating the distance for each possible pair, if the distance for a particular pair is less than MIN_DISTANCE then the bounding boxes for those faces are colored red. MIN_DISTANCE must be manually initialized in such a way that it corresponds to the minimum allowable distance in real life (ex. 6ft in India).","843efe0f":"#### Red box shows violation of social distancing.","e35a8c2d":"The model is able to classify if the person is wearing a mask or not.","b475a9aa":"**Social distancing**, also called **\u201cphysical distancing,\u201d** means keeping a safe space between yourself and other people who are not from your household.\n\nTo practice social or physical distancing, stay at least 6 feet (about 2 arm lengths) from other people who are not from your household in both indoor and outdoor spaces.","aab9d2c2":"### Using haar cascade to detect faces\n\nObject Detection using Haar feature-based cascade classifiers is an effective object detection method proposed by Paul Viola and Michael Jones in their paper, \"Rapid Object Detection using a Boosted Cascade of Simple Features\" in 2001. It is a machine learning based approach where a cascade function is trained from a lot of positive and negative images. It is then used to detect objects in other images. We'll be using a Haar Cascade Model trained to detect faces in order to obtain the bounding box coordinates of faces in an image.","2b18bdf8":"#### Red boxes shows violation of social distancing.","7302de54":"### Integrating with haar cascade","2036a1ab":"Our modela achieved 99% accuracy on test data.","0a71b2db":"![d8ce0480-9ac0-11ea-8062-809a1b8bfab6.png](attachment:d8ce0480-9ac0-11ea-8062-809a1b8bfab6.png)","967f65b2":"### Using MobileNetV2for mask detection\n","b5e53d07":"We now take crops of the faces detected in the image and use the model trained in the above section to determine whether the individual faces have a mask or not.","5c1248c2":"# Mask and Social distancing Detection ","7eb16f9f":"### Testing the model on the test data"}}