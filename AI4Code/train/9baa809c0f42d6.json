{"cell_type":{"e2bd1a66":"code","7b04f590":"code","5b3e281e":"code","c8b88b08":"code","9108f9be":"code","b88186cb":"code","c1791db5":"code","e1759fc5":"code","5a7c2748":"code","a98217fe":"code","7b92833d":"code","b8c76a6b":"code","f0710470":"code","82fb0915":"code","6390ac8f":"code","69716462":"code","eb4d2de5":"code","6751a715":"code","5587b2bb":"code","72b2cbd0":"code","384cc2ff":"code","0f00f9ef":"code","c8f4edb2":"code","10fd5695":"markdown","deffb573":"markdown","220fb5c9":"markdown","13a5f4f3":"markdown","95d2b71a":"markdown","1d904ae5":"markdown"},"source":{"e2bd1a66":"import numpy as np\nimport pandas as pd\nimport matplotlib.pyplot as plt\nimport tensorflow\nimport os\nimport tqdm\nimport skimage.io\nimport glob\n\nfrom tqdm import tqdm\n\nfrom skimage.io import imread, imshow\nfrom skimage.transform import resize\n\nfrom sklearn.utils import shuffle\n\nfrom tensorflow.keras.utils import to_categorical\nfrom tensorflow.keras.preprocessing.image import ImageDataGenerator\nfrom tensorflow.keras.models import Sequential, Model\nfrom tensorflow.keras.layers import InputLayer, Conv2D, BatchNormalization, MaxPool2D, Dropout, Flatten, Dense\nfrom tensorflow.keras.callbacks import EarlyStopping, ModelCheckpoint, ReduceLROnPlateau\n\n# Instantiating the model for loading the weights and biases and preprocess_input\nfrom tensorflow.keras.applications.xception import Xception, preprocess_input\n\n%matplotlib inline","7b04f590":"# Reading Data\n\ntrain_dataset_0_all = glob.glob('..\/input\/leukemia-classification\/C-NMC_Leukemia\/training_data\/fold_0\/all\/*.bmp')\ntrain_dataset_0_hem = glob.glob('..\/input\/leukemia-classification\/C-NMC_Leukemia\/training_data\/fold_0\/hem\/*.bmp')\ntrain_dataset_1_all = glob.glob('..\/input\/leukemia-classification\/C-NMC_Leukemia\/training_data\/fold_1\/all\/*.bmp')\ntrain_dataset_1_hem = glob.glob('..\/input\/leukemia-classification\/C-NMC_Leukemia\/training_data\/fold_1\/hem\/*.bmp')\ntrain_dataset_2_all = glob.glob('..\/input\/leukemia-classification\/C-NMC_Leukemia\/training_data\/fold_2\/all\/*.bmp')\ntrain_dataset_2_hem = glob.glob('..\/input\/leukemia-classification\/C-NMC_Leukemia\/training_data\/fold_2\/hem\/*.bmp')\n\n#test_dataset  = glob.glob('..\/input\/leukemia-classification\/C-NMC_Leukemia\/testing_data\/C-NMC_test_final_phase_data\/*.bmp')\n#valid_dataset = glob.glob('..\/input\/leukemia-classification\/C-NMC_Leukemia\/validation_data\/C-NMC_test_prelim_phase_data\/*.bmp')\n\nvalid_data    = pd.read_csv('..\/input\/leukemia-classification\/C-NMC_Leukemia\/validation_data\/C-NMC_test_prelim_phase_data_labels.csv')","5b3e281e":"A = []\nH = []\n\nA.extend(train_dataset_0_all)\nA.extend(train_dataset_1_all)\nA.extend(train_dataset_2_all)\n\nH.extend(train_dataset_0_hem)\nH.extend(train_dataset_1_hem)\nH.extend(train_dataset_2_hem)\n\nA = np.array(A)\nH = np.array(H)\n\nlen(A),len(H)","c8b88b08":"Image = []\nLabel = []\n\nfor i in tqdm(range(0, len(A))):\n    img = imread(A[i])\n    img = resize(img, (128,128))\n    Image.append(img)\n    Label.append(1)\n    \nfor i in tqdm(range(0, len(H))):\n    img = imread(H[i])\n    img = resize(img, (128,128))\n    Image.append(img)\n    Label.append(0)\n    \nImage = np.array(Image)\nLabel = np.array(Label)\n\nImage.shape, Label.shape","9108f9be":"# Shuffle the data as results are appened.\n\nImage, Label = shuffle(Image, Label, random_state = 42)","b88186cb":"# Viewing Image - After Shuffle \n\nfig, ax = plt.subplots(nrows = 1, ncols = 5, figsize = (20,20))\n\nfor i in tqdm(range(0, 5)):\n    rand = np.random.randint(len(Image))\n    ax[i].imshow(Image[rand])\n    ax[i].axis('off')\n    a = Label[rand]\n    if a == 1:\n        ax[i].set_title('Diseased')\n    else:\n        ax[i].set_title('Non_Diseased')","c1791db5":"# Assigning Images and Label to new variable \n\nX = Image\ny = Label","e1759fc5":"del Image \ndel Label\ndel A\ndel H","5a7c2748":"valid_data.head()","a98217fe":"# Checking target coloumn distribution\n\nvalid_data.labels.value_counts()","7b92833d":"# Loading image and storing it numpy array.\n\nX_val = []\n\nfor image_name in valid_data.new_names:\n    # Loading images\n    img = imread('..\/input\/leukemia-classification\/C-NMC_Leukemia\/validation_data\/C-NMC_test_prelim_phase_data\/' + image_name)\n    # Resizing \n    img = resize(img, (128,128))\n    # Appending them into list\n    X_val.append(img)\n \n# Converting into array\nX_val = np.array(X_val)\n\n# Storing target values as well \ny_val = valid_data.labels.values","b8c76a6b":"# Augmentation & Applying preprocessing function of pre-trained model.\n\ntrain_datagen  = ImageDataGenerator(horizontal_flip=True,\n                                    vertical_flip=True,\n                                    zoom_range = 0.2,\n                                    preprocessing_function=preprocess_input)\ntrain_datagen.fit(X)","f0710470":"valid_datagen = ImageDataGenerator(preprocessing_function=preprocess_input)\n\nvalid_datagen.fit(X_val)","82fb0915":"# Creating model with pre trained imagenet weights\n\nxcep = Xception(include_top=False, weights='imagenet', input_shape=(128,128,3))","6390ac8f":"# Model Summary \n\nxcep.summary()","69716462":"# We dont want to train all layers so, we do following step because we are using same weights given in VGG16\n\nfor layers in xcep.layers:\n    layers.trainable = False","eb4d2de5":"# Introducing Flatten Layer\n\nx = Flatten()(xcep.output)","6751a715":"# Introducing FCC & Output Layer\n\nfcc_layer_1 = Dense(units = 1024, activation = 'relu')(x)\ndropout_1   = Dropout(0.3)(fcc_layer_1)\n\nfcc_layer_2 = Dense(units = 512, activation = 'relu')(dropout_1)\ndropout_2   = Dropout(0.3)(fcc_layer_2)\n\nfinal_layer = Dense(units = 1, activation = 'sigmoid')(dropout_2)","5587b2bb":"# Creating Final Model\n\nmodel = Model(inputs = xcep.input, outputs = final_layer)","72b2cbd0":"# Summary\n\nmodel.summary()","384cc2ff":"# Model Compile \n\nmodel.compile(optimizer = 'adam', \n              loss = 'binary_crossentropy',\n              metrics = ['accuracy'])","0f00f9ef":"# Defining Callbacks\n\nfilepath = '.\/best_weights.hdf5'\n\nearlystopping = EarlyStopping(monitor = 'val_accuracy', \n                              mode = 'max' , \n                              patience = 15,\n                              verbose = 1)\n\ncheckpoint    = ModelCheckpoint(filepath, \n                                monitor = 'val_accuracy', \n                                mode='max', \n                                save_best_only=True, \n                                verbose = 1)\n\nlearning_rate = ReduceLROnPlateau(monitor = 'val_accuracy',\n                                  mode = 'max',\n                                  patience = 5,\n                                  factor = 0.3,\n                                  min_delta = 0.00001)\n\ncallback_list = [earlystopping, checkpoint, learning_rate]","c8f4edb2":"# Fitting Model\n\nmodel_history = model.fit(train_datagen.flow(X, y, batch_size=512), \n                          validation_data = (X_val, y_val),\n                          epochs = 500,\n                          verbose = 1,\n                          callbacks = callback_list,\n                          use_multiprocessing = True,\n                          workers = 5)\n","10fd5695":"**`DATA AUGMENTATION`**","deffb573":"### IMPORT LIBRARIES","220fb5c9":"### IMPORT \/ VIEWING \/ PREPROCESSING DATA","13a5f4f3":"### MODEL BUILDING ","95d2b71a":"**`TRAIN DATA PREPROCESSING`**","1d904ae5":"> **`VALIDATION DATA PREPROCESSING`**"}}