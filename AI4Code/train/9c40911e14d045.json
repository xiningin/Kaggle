{"cell_type":{"12d8283b":"code","64e0061e":"code","96291b6c":"code","3cccda70":"code","c65a1a03":"code","0815034b":"code","602c1599":"code","1c4592bc":"code","6ab2ced4":"code","37a1cd38":"code","0e9b8267":"code","34898cf1":"code","67a4cc64":"code","66e1a990":"code","54fee98c":"code","0092b38d":"code","089f36d6":"code","daa30526":"code","b612e3e7":"code","2d87763a":"code","5889e76a":"code","81a5b8e0":"code","77123fa7":"code","4af70286":"code","e82534d0":"code","9ac23d31":"code","952d1826":"code","91e35ada":"markdown","a0f62850":"markdown","dcdc5f01":"markdown","8029120e":"markdown","56f6727f":"markdown","9716524b":"markdown"},"source":{"12d8283b":"DATASET_DIR = '..\/input\/severstal-steel-defect-detection\/'\nTEST_SIZE = 0.1\nRANDOM_STATE = 123","64e0061e":"import pandas as pd\nimport os\nimport cv2\nimport numpy as np\nimport matplotlib.pyplot as plt\n\nfrom shutil import copyfile\nfrom sklearn.model_selection import train_test_split","96291b6c":"df = pd.read_csv(os.path.join(DATASET_DIR, 'train.csv'))","3cccda70":"df['Image'] = df['ImageId_ClassId'].map(lambda x: x.split('_')[0])\ndf['HavingDefection'] = df['EncodedPixels'].map(lambda x: 0 if x is np.nan else 1)\n\nimage_col = np.array(df['Image'])\nimage_files = image_col[::4]\ny = np.array(df['HavingDefection']).reshape(-1, 4)","c65a1a03":"df.head()","0815034b":"num_img_class_1 = np.sum(y[:, 0])\nnum_img_class_2 = np.sum(y[:, 1])\nnum_img_class_3 = np.sum(y[:, 2])\nnum_img_class_4 = np.sum(y[:, 3])\nprint('Class 1:', num_img_class_1)\nprint('Class 2:', num_img_class_2)\nprint('Class 3:', num_img_class_3)\nprint('Class 4:', num_img_class_4)","602c1599":"X_train, X_val, y_train, y_val = train_test_split(image_files, y, test_size=TEST_SIZE, random_state=RANDOM_STATE)","1c4592bc":"df.head()","6ab2ced4":"print(X_train.shape)\nprint(y_train.shape)\nprint(X_val.shape)\nprint(y_val.shape)","37a1cd38":"train_pairs = np.array(list(zip(X_train, y_train)))\nsamples = train_pairs[np.random.choice(train_pairs.shape[0], 10, replace=False), :]\n\nfig, axes = plt.subplots(5, 2, figsize=(30, 20))\nfor i in range(10):\n    sample = samples[i]\n    img_path = os.path.join(DATASET_DIR, 'train_images', sample[0])\n    img = cv2.imread(img_path)\n\n    axes[i\/\/2][i%2].imshow(img\/255)\n    axes[i\/\/2][i%2].set_title('{} - ({})'.format(sample[0], ', '.join(sample[1].astype(np.str))))\nplt.show()","0e9b8267":"val_pairs = np.array(list(zip(X_val, y_val)))\nsamples = val_pairs[np.random.choice(val_pairs.shape[0], 10, replace=False), :]\n\nfig, axes = plt.subplots(5, 2, figsize=(30, 20))\nfor i in range(10):\n    sample = samples[i]\n    img_path = os.path.join(DATASET_DIR, 'train_images', sample[0])\n    img = cv2.imread(img_path)\n\n    axes[i\/\/2][i%2].imshow(img\/255)\n    axes[i\/\/2][i%2].set_title('{} - ({})'.format(sample[0], ', '.join(sample[1].astype(np.str))))\nplt.show()","34898cf1":"!mkdir train_images\n!mkdir val_images","67a4cc64":"for image_file in X_train:\n    src = os.path.join(DATASET_DIR, 'train_images', image_file)\n    dst = os.path.join('.\/train_images', image_file)\n    copyfile(src, dst)\n\nfor image_file in X_val:\n    src = os.path.join(DATASET_DIR, 'train_images', image_file)\n    dst = os.path.join('.\/val_images', image_file)\n    copyfile(src, dst)","66e1a990":"!apt install zip","54fee98c":"!zip -r -m -1 -q train_images.zip .\/train_images\n!zip -r -m -1 -q val_images.zip .\/val_images","0092b38d":"# y_train = list(map(lambda x: ' '.join(x.astype(np.str)), y_train))\n# y_val = list(map(lambda x: ' '.join(x.astype(np.str)), y_val))\ny_train = [' '.join(y.astype(np.str)) for y in y_train]\ny_val = [' '.join(y.astype(np.str)) for y in y_val]","089f36d6":"print(len(y_train))\nprint(len(y_val))","daa30526":"train_set = {\n    'ImageId': X_train,\n    'Label': y_train\n}\n\nval_set = {\n    'ImageId': X_val,\n    'Label': y_val\n}\n\ntrain_df = pd.DataFrame(train_set)\nval_df = pd.DataFrame(val_set)\n\ntrain_df.to_csv('.\/train.csv', index=False)\nval_df.to_csv('.\/val.csv', index=False)","b612e3e7":"train_df.head()","2d87763a":"%reload_ext autoreload\n%autoreload 2\n%matplotlib inline","5889e76a":"train_df['blabels'] = train_df['Label'].map(lambda x: int(x.split()[0])+2*int(x.split()[1])+3*int(x.split()[2])+4*int(x.split()[3]))","81a5b8e0":"train_df.head()","77123fa7":"print(train_df[\"blabels\"].nunique()); classes = list(set(train_df[\"blabels\"])); classes","4af70286":"train_df.to_csv('train_df.csv')","e82534d0":"for i in classes:\n    print(\"Number of items in class {} is {}\".format(i,len(train_df[train_df[\"blabels\"] == i])))","9ac23d31":"from fastai import *\nfrom fastai.vision import *\n\ndata = ImageDataBunch.from_csv('..\/input\/severstal-steel-defect-detection\/', folder = 'severstal-steel-defect-detection', csv_labels = \"train.csv\",\n                               test = 'test_images',suffix=\".zip\", size = 36, ds_tfms = get_transforms())\ndata.path = pathlib.Path('.')\ndata.normalize(imagenet_stats)\n\nlearn = create_cnn(data,resnet50,pretrained = True,metrics = accuracy)\nlearn.fit_one_cycle(5)\n\nlearn.unfreeze()\nlearn.lr_find()\nlearn.recorder.plot()\nlearn.fit_one_cycle(3,max_lr = slice(1e-6,3e-4))\n\ninterp = ClassificationInterpretation.from_learner(learn)\ninterp.plot_top_losses(9)\ninterp.plot_confusion_matrix()\npreds,y = learn.TTA()\nacc = accuracy(preds, y)\nprint('The validation accuracy is {} %.'.format(acc * 100))\n\ndef generateSubmission(learner):\n    submissions = pd.read_csv('..\/input\/sample_submission.csv')\n    id_list = list(submissions.id)\n    preds,y = learner.TTA(ds_type=DatasetType.Test)\n    pred_list = list(preds[:,1])\n    pred_dict = dict((key, value.item()) for (key, value) in zip(learner.data.test_ds.items,pred_list))\n    pred_ordered = [pred_dict[Path('..\/input\/test\/' + id + '.zip')] for id in id_list]\n    submissions = pd.DataFrame({'id':id_list,'label':pred_ordered})\n    submissions.to_csv(\"submission_{}.csv\".format(pred_score),index = False)\n\ngenerateSubmission(learn)","952d1826":"tfms = get_transforms(do_flip = True,flip_vert = True,max_zoom = 1.1)","91e35ada":"# Split dataset into training and validation sets","a0f62850":"# Import modules","dcdc5f01":"# Save labels","8029120e":"# Copy images into right folders","56f6727f":"# Zip training and validation sets","9716524b":"# Visualize some images and corresponding labels"}}