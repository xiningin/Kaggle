{"cell_type":{"1861db5d":"code","d806990a":"code","a9143f1b":"code","1947e5b0":"code","56afeb75":"code","f0bfd681":"code","48096146":"code","311f8788":"code","aa3fce6d":"code","65d780cd":"code","e5a67e01":"code","1bf4870e":"code","97b187a2":"code","0115f535":"code","cc8a19c0":"code","c0a10996":"code","2fd6724d":"code","1f615350":"code","6bc91262":"code","f5dfaa14":"code","2d4fedd9":"markdown","a8a38a72":"markdown","a4d4d85c":"markdown","dd461406":"markdown","e99d77da":"markdown","067d1733":"markdown"},"source":{"1861db5d":"import numpy as np \nimport pandas as pd \nimport tqdm\nimport datetime\nimport matplotlib.pyplot as plt\nimport os\nimport geopy.distance\nimport folium\nimport seaborn as sns\nfrom sklearn.cluster import KMeans\n\nprint(os.listdir(\"..\/input\"))","d806990a":"df = pd.read_csv(r'..\/input\/autotel-shared-car-locations\/\/sample_table.csv')","a9143f1b":"df['carsList'] = df.carsList.apply(lambda x: x[1:-1]) # remove square brackets\ndf['carsList'] = df.carsList.apply(lambda x: x.split(',')) # convert string to list\ndf['carsList'] = df.carsList.apply(lambda x: [] if x == [''] else x) # denote empty lists\ndf['carsList'] = df.carsList.apply(lambda x: [int(i) for i in x]) # convert list items to int\ndf['total_cars'] = df.carsList.apply(len) \ndf = df[df.total_cars > 0]","1947e5b0":"# Parse list of cars into different rows \ndef explode(df, lst_cols, fill_value=''):\n    # make sure `lst_cols` is a list\n    if lst_cols and not isinstance(lst_cols, list):\n        lst_cols = [lst_cols]\n    # all columns except `lst_cols`\n    idx_cols = df.columns.difference(lst_cols)\n\n    # calculate lengths of lists\n    lens = df[lst_cols[0]].str.len()\n\n    if (lens > 0).all():\n        # ALL lists in cells aren't empty\n        return pd.DataFrame({\n            col:np.repeat(df[col].values, lens)\n            for col in idx_cols\n        }).assign(**{col:np.concatenate(df[col].values) for col in lst_cols}) \\\n          .loc[:, df.columns]\n    else:\n        # at least one list in cells is empty\n        return pd.DataFrame({\n            col:np.repeat(df[col].values, lens)\n            for col in idx_cols\n        }).assign(**{col:np.concatenate(df[col].values) for col in lst_cols}) \\\n          .append(df.loc[lens==0, idx_cols]).fillna(fill_value) \\\n          .loc[:, df.columns]\n    \nnew_df = explode(df, ['carsList'], fill_value='')","56afeb75":"# Pivot the table to a new structures, where the indices are unique timestamps, the columns are cars and the values are the coordinates of the cars\npivot_df = new_df.pivot(index='timestamp',columns='carsList', values=['latitude', 'longitude'])","f0bfd681":"pivot_df.head()","48096146":"def get_car_trips(pivot_df, car_num):\n    # First, take the relevant columns for the car in question\n    car = pivot_df[[('latitude', car_num), ('longitude', car_num)]]\n    car = car[pd.isnull(car[('latitude', car_num)]) == False]\n    \n    # Find the previous location\n    car.loc[:, 'prev_lat'] = car.shift()[('latitude', car_num)]\n    car.loc[:, 'prev_lon'] = car.shift()[('longitude', car_num)]\n    \n    # If the location has not changed, there is no trip going on\n    car.loc[:, 'trip'] = car[('latitude', car_num)] == car.prev_lat\n    car.loc[:, 'trip'] = car.trip.apply(lambda x: 0 if x else 1)\n    car.loc[:, 'trip'] = car.trip.cumsum()\n    car.reset_index(inplace=True)\n    \n    # Merge the data frame with itself shifted by one\n    f = {'timestamp': ['min', 'max'], ('latitude', car_num): 'first', ('longitude', car_num): 'first'}\n    trip_df = car.groupby('trip').agg(f)\n    prev_df = car.groupby('trip').agg(f).shift()\n\n    trip_df = pd.merge(trip_df, prev_df, left_index=True, right_index=True)\n    \n    trip_df.columns = trip_df.columns.get_level_values(0)\n    trip_df.columns = ['end', 'start_next', 'end_lat', 'end_long', 'end_prev', 'start', 'start_lat', 'start_long']\n    trip_df['car'] = car_num\n    return trip_df","311f8788":"trips = pd.DataFrame()\n\nfor car in tqdm.tqdm(np.array(pivot_df.columns.get_level_values(1))):\n    trips = trips.append(get_car_trips(pivot_df, car))\n    \nprint(len(trips))","aa3fce6d":"def trip_distance(lat1, lat2, lon1, lon2):\n    try:\n        coords_1 = (lat1, lon1)\n        coords_2 = (lat2, lon2)\n        return geopy.distance.vincenty(coords_1, coords_2).km\n    except ValueError:\n        return -1","65d780cd":"trips['trip_len'] = trips.apply(lambda x: trip_distance(x.start_lat, x.end_lat, x.start_long, x.end_long), axis=1)\n\ntrips.reset_index(inplace=True)","e5a67e01":"def transform_time(x):\n    try:\n        return datetime.datetime.strptime(x[:19], '%Y-%m-%d %H:%M:%S')\n    except TypeError:\n        return -1\ntrips['end'] = trips.end.apply(transform_time)\ntrips['start'] = trips.start.apply(transform_time)","1bf4870e":"trips = trips[trips.trip_len > -1]\ntrips['trip_duration'] = trips.apply(lambda x: (x.end - x.start).seconds\/60, axis=1)\ntrips = trips[trips.trip_duration > 3]","97b187a2":"import seaborn as sns\nplt.figure(figsize=(8, 6))\nplt.style.use('fivethirtyeight')\nsns.distplot(trips.trip_duration, bins=np.linspace(0, 120, 60), kde=False)\nplt.xlabel('Duration [mins]')\n","0115f535":"trips.head()","cc8a19c0":"# lets count the number of rides per day\ndf_rides = trips.copy()\ndf_rides['start'] = df_rides['start'].apply(pd.Timestamp)\ndf_rides = df_rides.set_index('start')\n\ndf_rides = df_rides[df_rides['trip_duration'] < 90] # very long trips are maintanance time\n\ndf_daily_rids = df_rides.groupby(pd.Grouper(freq='1D')).agg({'trip':'count', 'trip_duration':'sum'})\ndf_daily_rids.index = df_daily_rids.index.map(lambda t: t.strftime('%Y-%m-%d'))\ndf_daily_rids.head()","c0a10996":"df_daily_rids['trip'].plot(kind='bar', figsize=(20,6))\nplt.title(\"Daily recorded trips\")\nplt.ylabel('Total trips')\nplt.show()","2fd6724d":"df_daily_rids['trip_duration'].plot(kind='bar', figsize=(20,6))\nplt.title(\"Total daily ride time\")\nplt.ylabel('Ride time (minutes)')\nplt.show()","1f615350":"# We assume all rides cost 1.3 ILS per minute\ndf_daily_rids['daily_revenue'] = (df_daily_rids['trip_duration'] * 1.3) \/ 1000\n\ndf_daily_rids['daily_revenue'].plot(kind='bar', figsize=(20,6))\nplt.title(\"Autotel Daily Revenue\")\nplt.ylabel('1K ILS')\nplt.show()","6bc91262":"df_daily_rids[['daily_revenue']].plot(kind='hist', bins=range(40, 190, 10), alpha=0.6, figsize=(14,5))\nplt.show()","f5dfaa14":"# The average daily revenue is estimated to be around 100K ILS :)","2d4fedd9":"# Read The Data","a8a38a72":"Some pandas transformaton of the data. If anyone has a more elegant solution I would be happy to incorporate it into my code","a4d4d85c":"# Some Transformations","dd461406":"## Calculating AutoTel's Daily Revenue\nThis notenook is a fork of @drgilermo's notebook that extracted from the AutoTel dataset the actual trips by examining when and where parked cars appear on the map.\nThe Addition is a simple group by that adds the total duration time and multiples it by a fixed price of 1.3 ILS per minute which is the assumed average price per minute ride.","e99d77da":"# Trips data frame\nNow we have a new data frame, where each row is a trip, with a starting and an ending point, as well as the relevant timestamps and car id. Let's add the interesting columns to each trip","067d1733":"## Analizing total revene\nHere we simply group the table by day to sum the total rides and ride durations and multiplie by the assumed average cost per minute of ride"}}