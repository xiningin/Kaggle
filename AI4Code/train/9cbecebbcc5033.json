{"cell_type":{"29152a04":"code","8b5f1b04":"code","887236e7":"code","ad8bdc07":"code","4ffd6453":"code","51bc6b1a":"code","89030912":"code","9cd554a7":"code","0c15fd35":"code","b2d86b70":"code","146ae106":"code","9f6c2073":"code","9ec49192":"code","7e4dbf55":"code","0a4c1cce":"code","c80dbc3c":"code","56780a94":"code","a6b53f95":"code","f788b5a3":"code","573154c1":"code","aa2ff551":"code","06de55ce":"code","4fbf22e4":"code","2d4efcb2":"code","180c6229":"code","51bc7ca1":"code","31c8195b":"code","197d31a7":"code","56b8f638":"code","3a8a916e":"code","12db4f49":"code","63fd9d34":"code","16522f74":"code","2589b006":"code","96ea0f18":"code","6b572f74":"code","36813653":"code","4baef0a6":"code","d1ec86db":"code","dd27cc41":"code","c84fa780":"code","bec3a340":"code","f97ee663":"code","b730a3b9":"code","3c5f2fe9":"code","29122805":"markdown","f408c630":"markdown","4ae3e614":"markdown","728179d3":"markdown"},"source":{"29152a04":"%reload_ext autoreload\n%autoreload 2\n%matplotlib inline","8b5f1b04":"from fastai.vision import *","887236e7":"path=untar_data(URLs.MNIST)","ad8bdc07":"path.ls()","4ffd6453":"il=ImageList.from_folder(path,convert_mode=\"L\")","51bc6b1a":"il.items[0]","89030912":"defaults.camp=\"binary\"","9cd554a7":"il","0c15fd35":"il[0].show()","b2d86b70":"sd=il.split_by_folder(train=\"training\",valid=\"testing\")","146ae106":"sd","9f6c2073":"(path\/\"training\").ls()","9ec49192":"l1=sd.label_from_folder()","7e4dbf55":"l1","0a4c1cce":"x,y=l1.train[0]","c80dbc3c":"x.show()\nprint(y,x.shape)","56780a94":"tfms=([*rand_pad(padding=3,size=28,mode=\"zeros\")],[])","a6b53f95":"l1=l1.transform(tfms)","f788b5a3":"bs=128","573154c1":"data=l1.databunch(bs=bs).normalize()","aa2ff551":"data","06de55ce":"x,y=data.train_ds[0]\nx.show()\nprint(y,x.shape)","4fbf22e4":"# \u753b\u51fa\u4e00\u7ec4\u7ecf\u8fc7\u6570\u636e\u53d8\u6362\u540e\u7684\u56fe\u7247\ndef _plot(i,j,ax): data.train_ds[0][0].show(ax,camp=\"gray\")\nplot_multi(_plot,3,3,figsize=(8,8))","2d4efcb2":"xb,yb=data.one_batch()\nxb.shape,yb.shape","180c6229":"# \u5c55\u793a\u4e00\u7ec4\u6837\u672c\ndata.show_batch(rows=3,figsize=(5,5))","51bc7ca1":"# \u4e3a\u4e86\u9632\u6b62\u91cd\u590d\u7684\u5199\u4ee3\u7801\ndef conv(ni,nf): return nn.Conv2d(ni,nf,kernel_size=3,stride=2,padding=1)","31c8195b":"model=nn.Sequential(\n    conv(1,8),\n    nn.BatchNorm2d(8),\n    nn.ReLU(),\n    conv(8,16),\n    nn.BatchNorm2d(16),\n    nn.ReLU(),\n    conv(16,32),\n    nn.BatchNorm2d(32),\n    nn.ReLU(),\n    conv(32,16),\n    nn.BatchNorm2d(16),\n    nn.ReLU(),\n    conv(16,10),\n    nn.BatchNorm2d(10),\n    Flatten()     # \u6241\u5e73\u5316\n)","197d31a7":"learn=Learner(data,model,loss_func=nn.CrossEntropyLoss(),metrics=accuracy)","56b8f638":"learn.summary()","3a8a916e":"learn.lr_find()","12db4f49":"learn.recorder.plot()","63fd9d34":"learn.fit_one_cycle(3,max_lr=0.1)","16522f74":"# fastai\u6574\u5408\u4e86\u4e00\u4e2aconv\u3001batchnorm\u548crelu\u7684\u51fd\u6570\ndef conv(ni,nf): return conv_layer(ni,nf,stride=2)","2589b006":"model=nn.Sequential(\n    conv(1,8),\n    conv(8,16),\n    conv(16,32),\n    conv(32,16),\n    conv(16,10),\n    Flatten()\n)","96ea0f18":"learn=Learner(data,model,loss_func=nn.CrossEntropyLoss(),metrics=accuracy)","6b572f74":"learn.summary()","36813653":"learn.fit_one_cycle(10,max_lr=0.1)","4baef0a6":"class ResBlock(nn.Module):\n    def __init__(self,nf):\n        super().__init__()\n        self.conv1=conv_layer(nf,nf)\n        self.conv2=conv_layer(nf,nf)\n        \n    def forward(self,x):\n        return x+self.conv2(self.conv1(x))","d1ec86db":"model=nn.Sequential(\n    conv(1,8),\n    res_block(8),\n    conv(8,16),\n    res_block(16),\n    conv(16,32),\n    res_block(32),\n    conv(32,16),\n    res_block(16),\n    conv(16,10),\n    Flatten()\n)","dd27cc41":"# \u6211\u4eec\u4e3a\u4e86\u907f\u514d\u91cd\u590d\u5199\u4ee3\u7801\ndef conv_and_res(ni,nf): return nn.Sequential(conv(ni,nf),res_block(nf))","c84fa780":"model=nn.Sequential(\n    conv_and_res(1,8),\n    conv_and_res(8,16),\n    conv_and_res(16,32),\n    conv_and_res(32,16),\n    conv(16,10),\n    Flatten()\n)","bec3a340":"learn=Learner(data,model,loss_func=nn.CrossEntropyLoss(),metrics=accuracy)","f97ee663":"learn.summary()","b730a3b9":"learn.lr_find(end_lr=100)\nlearn.recorder.plot()","3c5f2fe9":"learn.fit_one_cycle(12,max_lr=0.1)","29122805":"## Data","f408c630":"## Basic CNN with batchnorm","4ae3e614":"## Resnet-ish","728179d3":"## Refactor"}}