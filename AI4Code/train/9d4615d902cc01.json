{"cell_type":{"21eb2245":"code","a390c04a":"code","be45ef06":"code","30b0d69e":"code","dade91e5":"code","a4231625":"code","e32046c1":"code","1e0e8664":"code","6f88c7f3":"code","f341cc40":"code","318072a7":"code","f640ef5e":"code","29b26369":"code","6fcede69":"code","d6b9ae11":"code","83d21867":"code","f328658c":"code","5c2e16c4":"code","7e6d85ea":"code","6a544487":"code","9dfde705":"code","0ffd6662":"code","7e44a059":"code","5f7c2dc0":"code","a92557c7":"code","c93bd0c1":"code","193bcf6f":"code","fc788f9c":"code","63104be9":"code","0e19a76f":"code","cb763cba":"code","9616d85d":"code","284f5f7e":"code","7c771b40":"code","82cbe95e":"code","07127983":"code","17b1df41":"code","0293983c":"code","921155ed":"code","8c2f2887":"code","cd299ac6":"code","a55c36ba":"code","9f809ff8":"code","1d05717d":"code","53a13b14":"code","61db664c":"code","d092b98b":"code","206826b0":"code","6a865df2":"code","522da8df":"code","8fd3b988":"code","85436e92":"code","82310e00":"code","fae69748":"code","e36617b3":"code","4187c1c6":"code","4b5d7772":"code","b32c9861":"code","cea0eb22":"code","87d85efe":"code","cda34896":"code","961f11b7":"code","fb3a4cb7":"code","dc0b98d4":"code","35e520a2":"code","ca1ef7d1":"code","e268b9be":"code","151040ec":"code","ba2f64e3":"code","b2c649ef":"code","9f7b057e":"code","b810475e":"code","146af86d":"code","fa95064e":"code","78b046ee":"code","27db6a5b":"code","939ba088":"code","400eca1c":"code","611af8d0":"code","c7f53d08":"code","3e067899":"code","3291948c":"code","ba0a3c39":"code","8e862d1f":"code","6928fda9":"code","19abe4eb":"code","01c65370":"code","387f37ba":"code","4716f63f":"code","ea4be16f":"code","9af0845c":"code","4efa75ef":"code","cd07e812":"code","a1bc98c5":"code","74627582":"code","6d70a8af":"code","6ad7532d":"markdown","3169024f":"markdown","1b90a89f":"markdown","31b4f8d1":"markdown","ea09c89a":"markdown","f1e44c27":"markdown","9bb013dd":"markdown","cb94cf65":"markdown","3132b3e5":"markdown","63af8245":"markdown","4a7d26af":"markdown","4b898d72":"markdown","1f878b56":"markdown","da804f95":"markdown","886f6b92":"markdown","e01da7bb":"markdown","25f0ee43":"markdown","2407128b":"markdown","b0a0cc2a":"markdown","23ad5420":"markdown","8a4d7eed":"markdown","ccd2c54a":"markdown","1423e3b4":"markdown","bfefa8a1":"markdown","a1e7f9e5":"markdown","0d42d2f6":"markdown"},"source":{"21eb2245":"\nimport numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\n\n# Input data files are available in the \"..\/input\/\" directory.\n# For example, running this (by clicking run or pressing Shift+Enter) will list the files in the input directory\n\nimport os\nprint(os.listdir(\"..\/input\"))\n\n# Any results you write to the current directory are saved as output.","a390c04a":"import bq_helper\n\n# https:\/\/www.kaggle.com\/sohier\/introduction-to-the-bq-helper-package\nbq_assistant = bq_helper.BigQueryHelper(\"bigquery-public-data\", \"google_analytics_sample\")\nprint(bq_assistant.list_tables()[:5])\nprint(bq_assistant.list_tables()[-5:])\ntable_names = bq_assistant.list_tables()\n# a table for each day : 2016-08-01 - 2017-08-01\n# a year's worth of data","be45ef06":"bq_assistant.head(\"ga_sessions_20160801\", num_rows=5)\n# Many nested columns \n    # BiQuery allows access via \"category_name.subcategory_name\"\n# What do rows represent?\n    # Each row within a table corresponds to a session in Analytics 360.\n","30b0d69e":"last_schema = bq_assistant.table_schema(\"ga_sessions_20170801\")\nfirst_col_names = bq_assistant.table_schema(\"ga_sessions_20160801\")['name']\nlast_col_names = bq_assistant.table_schema(\"ga_sessions_20170801\")['name']\nprint(\"Number of columns in 2016:\", len(first_col_names))\nprint(\"Number of columns in 2017:\", len(last_col_names))","dade91e5":"# print new columns \n[c for c in last_col_names if c not in first_col_names.tolist()]","a4231625":"def inspect(query, nrows=15, sample=False):\n    \"\"\"Display response from given query but don't save. \n    query: str, raw SQL query\n    nrows: int, number of rows to display, default 15\n    sample: bool, use df.sample instead of df.head, default False \"\"\"\n    response = bq_assistant.query_to_pandas_safe(query, max_gb_scanned=10)\n    if sample:\n        return response.sample(nrows)\n    return response.head(nrows) \n\ndef retrieve(query, nrows=10):\n    \"\"\"Save response from given query and print a preview. \n    query: str, raw SQL query\n    nrows: int, number of rows to display\"\"\"\n    response = bq_assistant.query_to_pandas_safe(query, max_gb_scanned=10)\n    print(response.head(nrows))\n    return response","e32046c1":"query = \"\"\"\nSELECT\n    COUNT(*)\nFROM\n    `bigquery-public-data.google_analytics_sample.ga_sessions_20160801`\n\"\"\"\ninspect(query)","1e0e8664":"query = \"\"\"\nSELECT COUNT(*)\nFROM \n     (SELECT DISTINCT fullVisitorId, visitID\n        FROM\n    `bigquery-public-data.google_analytics_sample.ga_sessions_20160801`) s\n\"\"\"\ninspect(query)","6f88c7f3":"# Total Sessions\nquery = \"\"\"\nSELECT\n    COUNT(*)\nFROM\n    `bigquery-public-data.google_analytics_sample.ga_sessions_*`\n\"\"\"\ninspect(query)\n# The wild card parses to a UNION ALL","f341cc40":"# Unique sessions \nquery = \"\"\"\nSELECT COUNT(*)\nFROM \n     (SELECT DISTINCT fullVisitorId, visitID\n        FROM\n    `bigquery-public-data.google_analytics_sample.ga_sessions_*`) s\n\"\"\"\ninspect(query)\n\n# A few(~900) sessions don't have unique ID's if looking across all tables","318072a7":"# Quick Check of alternative method Unique sessions \nquery = \"\"\"\nSELECT COUNT(*)\nFROM \n     (SELECT DISTINCT concat(fullVisitorId, cast(visitID as string))\n        FROM\n    `bigquery-public-data.google_analytics_sample.ga_sessions_*`) s\n\"\"\"\ninspect(query)","f640ef5e":"# Test alt way to count distinct \ntable = table_names[0]\nprint(table)\ndate = table[-8:]\nprint(date)\nquery = f\"\"\"\nSELECT {date} as table, \nCOUNT(*) as total, \ncount(DISTINCT CONCAT(fullVisitorId, CAST(visitID as string))) as unique\nFROM \n    `bigquery-public-data.google_analytics_sample.{table}`\n\"\"\"\ninspect(query)","29b26369":"# ' UNION '.join(['A', 'B', 'C'])","6fcede69":"# Create a bunch of queries with a loop\n# queries = []\n# for table in table_names:\n#     date = table[-8:]\n#     query = f\"\"\"SELECT {date}, COUNT(*) as total, count(DISTINCT CONCAT(fullVisitorId, CAST(visitID as string))) as unique FROM `bigquery-public-data.google_analytics_sample.{table}`\"\"\"\n#     queries.append(query)\n# queries[:5]","d6b9ae11":"# %%time # wall time 9 mins\n\n# tables = []\n# mismatches = []\n# for query in queries:\n#     table_info = bq_assistant.query_to_pandas_safe(query)\n#     tables.append(table_info)\n#     if table_info.loc[0, 'total'] != table_info.loc[0, 'unique']:\n#         print(table_info['date'])\n#         mismatches.append(table_info)","83d21867":"# # List of tables with record counts\n# table_records = pd.concat(tables, axis=0)\n# table_records","f328658c":"# Test unnesting- needed since it's a list within the column\nunnested_query = \"\"\"\nSELECT\n    fullVisitorId,\n    visitId,\n    visitNumber,\n    hits.hitNumber AS hitNumber,\n    hits.page.pagePath AS pagePath\nFROM\n    `bigquery-public-data.google_analytics_sample.ga_sessions_20160801`, UNNEST(hits) as hits\nWHERE\n    hits.type=\"PAGE\"\nORDER BY\n    fullVisitorId,\n    visitId,\n    visitNumber,\n    hitNumber\n\"\"\"\nunnested_query_df = retrieve(unnested_query)\nunnested_query_df\n\n","5c2e16c4":"# How many unique visitors ?\nquery = \"\"\" SELECT COUNT (DISTINCT fullVisitorId) unique_visitors\n            FROM `bigquery-public-data.google_analytics_sample.ga_sessions_*`            \n            \"\"\"\ninspect(query)","7e6d85ea":"# How many unique customers ?\nquery = \"\"\" SELECT COUNT (DISTINCT fullVisitorId) unique_visitors\n            FROM `bigquery-public-data.google_analytics_sample.ga_sessions_*`\n            WHERE totals.transactions > 0 \n            \"\"\"\ninspect(query)","6a544487":"# Repeat customers and how many sessions with a purchase\nquery = \"\"\" SELECT fullVisitorId, COUNT(DISTINCT visitId) cnt_purchases\n            FROM `bigquery-public-data.google_analytics_sample.ga_sessions_*`\n            WHERE totals.transactions > 0 \n            GROUP BY fullVisitorId\n            HAVING COUNT(DISTINCT visitId) > 1\n            \"\"\"\n        \nrepeat_customers = retrieve(query)\n","9dfde705":"print(repeat_customers.shape)\nrepeat_customers['cnt_purchases'].sum()\n","0ffd6662":"# group by device browser from july tables \nquery = f\"\"\"\nSELECT device.browser, \n    COUNT(totals.totalTransactionRevenue) AS cnt_revenue,\n    COUNT(totals.transactions) AS cnt_transactions, \n    COUNT(*) AS cnt_all_rows, --sessions with browser\n    COUNT(totals.transactions) \/ COUNT(*) AS sess_conversion_rate,\n    sum(totals.totalTransactionRevenue) AS sum_revenue, \n    Sum(totals.transactions) AS  sum_transactions,\n    sum(totals.totalTransactionRevenue) \/ Sum(totals.transactions) AS revenue_per_transaction\nFROM `bigquery-public-data.google_analytics_sample.ga_sessions_201707*` \n GROUP BY device.browser\n ORDER BY sum_transactions DESC\n\"\"\"\n\ntransactions_by_browser = retrieve(query)","7e44a059":"transactions_by_browser.head(10)\n# Most transactions are done through Chrome. It also has the highest session-to-transaction conversion rate and revenue per transaction.","5f7c2dc0":"# \"Real\" bounce rate -- go by definition and filter where total.pageviews = 1 and divide by total visits\nquery = \"\"\"\nSELECT t.source,\n    t.total_visits,\n    b.bounce_visits,\n    100 * b.bounce_visits \/ t.total_visits AS bounce_rate\nFROM \n(SELECT trafficSource.source, COUNT(visitId) AS total_visits \nFROM `bigquery-public-data.google_analytics_sample.ga_sessions_201707*`\nGROUP BY trafficSource.source) t\n\nJOIN (SELECT trafficSource.source, COUNT(visitId) bounce_visits \nFROM `bigquery-public-data.google_analytics_sample.ga_sessions_201707*`\nWHERE totals.pageviews = 1\nGROUP BY trafficSource.source) b\nON t.source = b.source\nORDER by total_visits DESC\n\n\"\"\"\ninspect(query)\n\n# Slightly different results than using totals.bounces column - more bounces visits but total visits are the same","a92557c7":"# GA bounce rate \nquery = \"\"\"\nSELECT trafficSource.source, \n    COUNT(visitId) AS total_visits,\n    COUNT(totals.bounces) AS bounce_visits,\n    100 * COUNT(totals.bounces) \/ COUNT(visitId) AS bounce_rate\nFROM `bigquery-public-data.google_analytics_sample.ga_sessions_201707*`\nGROUP BY trafficSource.source\nORDER BY total_visits DESC\n\"\"\"\n\ninspect(query)","c93bd0c1":"query = \"\"\"\nSELECT DISTINCT totals.pageviews AS pageview_values\nFROM `bigquery-public-data.google_analytics_sample.ga_sessions_201707*`\nWHERE totals.bounces= 1\n\"\"\"\ninspect(query)","193bcf6f":"query = \"\"\"\nSELECT DISTINCT totals.bounces AS bounce_values\nFROM `bigquery-public-data.google_analytics_sample.ga_sessions_201707*`\nWHERE totals.pageviews= 1\n\"\"\"\ninspect(query)\n\n# total.bounces column - for convenience but is sometimes null for a session with 1 pageview -- explains the extra bounces ","fc788f9c":"# Cofirm same results as other kernel\nhowto_query = \"\"\"SELECT\nsource,\ntotal_visits,\ntotal_no_of_bounces,\n( ( total_no_of_bounces \/ total_visits ) * 100 ) AS bounce_rate\nFROM (\nSELECT\ntrafficSource.source AS source,\nCOUNT ( trafficSource.source ) AS total_visits,\nSUM ( totals.bounces ) AS total_no_of_bounces\nFROM `bigquery-public-data.google_analytics_sample.ga_sessions_*`\nWHERE\n_TABLE_SUFFIX BETWEEN '20170701' AND '20170731'\nGROUP BY\nsource )\nORDER BY\ntotal_visits DESC;\n        \"\"\"\ninspect(howto_query)","63104be9":"# get users who made a purchase in July 2017\nquery = \"\"\"\nSELECT DISTINCT fullVisitorId \nFROM `bigquery-public-data.google_analytics_sample.ga_sessions_201707*`\nWHERE totals.transactions > 0\n\"\"\"\ninspect(query)","0e19a76f":"# more info on users who made a purchase in July 2017\nquery = \"\"\"\nSELECT \n    COUNT(fullVisitorId) AS total_visitors, \n    COUNT(DISTINCT fullVisitorId) AS unique_visitors, \n    SUM(totals.transactions) AS sum_transactions,\n    SUM(totals.totalTransactionRevenue) AS sum_revenue,\n    AVG(totals.pageviews) as avg_pageviews -- in sessions where purchase was made\n\nFROM `bigquery-public-data.google_analytics_sample.ga_sessions_201707*`\nWHERE totals.transactions > 0\n\"\"\"\ninspect(query)","cb763cba":"# calculate average among those users who made a purchase in July 2017\nquery = \"\"\"\nSELECT AVG(totals.pageviews) as avg_pageviews -- includes other sessions by user in which they did not make a purchase\n FROM `bigquery-public-data.google_analytics_sample.ga_sessions_201707*`\nWHERE fullVisitorId IN (SELECT DISTINCT fullVisitorId \n                         FROM `bigquery-public-data.google_analytics_sample.ga_sessions_201707*`\n                        WHERE totals.transactions > 0)\n\"\"\"\ninspect(query)","9616d85d":"query = \"\"\"\nSELECT \n    COUNT(fullVisitorId) AS total_visitors, \n    COUNT(DISTINCT fullVisitorId) AS unique_visitors, \n    SUM(totals.transactions) AS sum_transactions,\n    SUM(totals.totalTransactionRevenue) AS sum_revenue,\n    AVG(totals.pageviews) as avg_pageviews -- in sessions where purchase were not made\n\nFROM `bigquery-public-data.google_analytics_sample.ga_sessions_201707*`\nWHERE totals.transactions IS NULL\n\"\"\"\ninspect(query)","284f5f7e":"# calculate average among those users who did not made a purchase in July 2017\nquery = \"\"\"\nSELECT AVG(totals.pageviews) as avg_pageviews -- includes other sessions by user in which they did make a purchase\n FROM `bigquery-public-data.google_analytics_sample.ga_sessions_201707*`\nWHERE fullVisitorId IN (SELECT DISTINCT fullVisitorId \n                         FROM `bigquery-public-data.google_analytics_sample.ga_sessions_201707*`\n                        WHERE totals.transactions IS NULL)\n\"\"\"\ninspect(query)","7c771b40":"query = \"\"\"\nSELECT \n    COUNT(fullVisitorId) AS total_visitors, \n    COUNT(DISTINCT fullVisitorId) AS unique_visitors, \n    SUM(totals.transactions) AS sum_transactions,\n    AVG(totals.totalTransactionRevenue) AS sum_revenue,\n    AVG(totals.transactions) as avg_transactions, -- in sessions where purchase were  made\n    SUM(totals.transactions) \/ COUNT(fullVisitorId) as alt_avg_transactions\nFROM `bigquery-public-data.google_analytics_sample.ga_sessions_201707*`\nWHERE totals.transactions > 0\n\"\"\"\ninspect(query)","82cbe95e":"# calculate average among those users who made a purchase in July 2017\nquery = \"\"\"\nSELECT AVG(totals.transactions) as avg_transactions,  -- includes other sessions by user in which they did not make a purchase\n      SUM(totals.transactions) \/ COUNT(fullVisitorId) as alt_avg_transactions -- AVG function ignores NULLs by default\n FROM `bigquery-public-data.google_analytics_sample.ga_sessions_201707*`\nWHERE fullVisitorId IN (SELECT DISTINCT fullVisitorId \n                         FROM `bigquery-public-data.google_analytics_sample.ga_sessions_201707*`\n                        WHERE totals.transactions > 0)\n\"\"\"\ninspect(query)","07127983":"query = \"\"\"\nSELECT \n    AVG(totals.totalTransactionRevenue) as avg_money_spent_per_purchase,\n    SUM(totals.totalTransactionRevenue) \/ COUNT(*) as avg_money_spent\n FROM `bigquery-public-data.google_analytics_sample.ga_sessions_201707*`\n\"\"\"\ninspect(query)","17b1df41":" \nhowto_query6 = \"\"\"SELECT\n( SUM(total_transactionrevenue_per_user) \/ SUM(total_visits_per_user) ) AS\navg_revenue_by_user_per_visit\nFROM (\nSELECT\nfullVisitorId,\nSUM( totals.visits ) AS total_visits_per_user,\nSUM( totals.transactionRevenue ) AS total_transactionrevenue_per_user\nFROM\n`bigquery-public-data.google_analytics_sample.ga_sessions_*`\nWHERE\n_TABLE_SUFFIX BETWEEN '20170701' AND '20170731'\nAND\ntotals.visits > 0\nAND totals.transactions >= 1\nAND totals.transactionRevenue IS NOT NULL\nGROUP BY\nfullVisitorId );\n\"\"\"\ninspect(howto_query6)\n# Why group by VisitorId (ie user) when it asks for money spent per session? ","0293983c":"query = \"\"\"\nSELECT \n   COUNT(totals.visits) as visits,\n   COUNT(*) - COUNT(totals.visits) as sessions_not_visits\n FROM `bigquery-public-data.google_analytics_sample.ga_sessions_201707*`\n--WHERE totals.visits  1\n\"\"\"\ninspect(query) \n# so all sessions are visits, as it should be ","921155ed":"howto_query7 = \"\"\"SELECT\nfullVisitorId,\nvisitId,\nvisitNumber,\nhits.hitNumber AS hitNumber,\nhits.page.pagePath AS pagePath\nFROM\n`bigquery-public-data.google_analytics_sample.ga_sessions_*`,\nUNNEST(hits) as hits\nWHERE\n_TABLE_SUFFIX BETWEEN '20170701' AND '20170731'\nAND\nhits.type=\"PAGE\"\nORDER BY\nfullVisitorId,\nvisitId,\nvisitNumber,\nhitNumber;\n        \"\"\"\nview_seqs = retrieve(howto_query7)","8c2f2887":"print(view_seqs.shape)\nview_seqs.head()","cd299ac6":"# hitNumber has the order within the session\n# view_seqs.groupby('fullVisitorId')['visitNumber'].count() # find a sample customer with more than 1 visit\nview_seqs[view_seqs['fullVisitorId'] == '0000436683523507380']","a55c36ba":"# apply list to each group - a way to aggregate the different records into the same row\n# nice to see but not recommended to store a list in a dataframe\nview_seqs.groupby(['fullVisitorId', 'visitId']).agg({'hitNumber': list, 'pagePath': list}).head(5)","9f809ff8":"# Get first page from each session - could be nice to use for first touch attribution  \n# view_seqs.groupby(['fullVisitorId', 'visitId']).head(1)\n# Top 10 landing pages from sessions - homepage 50% of time\nview_seqs.groupby(['fullVisitorId', 'visitId']).head(1)['pagePath'].value_counts(normalize=True).head(10)","1d05717d":"# expand traffic source \nquery = \"\"\"SELECT\nfullVisitorId,\nvisitId,\nvisitNumber,\nhits.hitNumber AS hitNumber,\ntrafficSource.*\nFROM\n`bigquery-public-data.google_analytics_sample.ga_sessions_*`,\nUNNEST(hits) as hits\nWHERE\n_TABLE_SUFFIX BETWEEN '20170701' AND '20170731'\n;\n        \"\"\"\ninspect(query)\n","53a13b14":"# What are possible sources? in July 2017 value_counts\nquery = \"\"\"SELECT\ntrafficSource.source, COUNT(*) as cnt\nFROM\n`bigquery-public-data.google_analytics_sample.ga_sessions_201707*`\nGROUP BY trafficSource.source\nORDER BY cnt DESC\n        \"\"\"\ntraffic_sources = retrieve(query)","61db664c":"print(traffic_sources.shape)\nprint(\"Too many to plot, even if establishing a threshold at like 100 for July. Need a good way of combining sources\")\ntraffic_sources.head(15)","d092b98b":"# confirm (direct) is the source of the (none)'s\nquery = \"\"\"SELECT\n trafficSource.source, trafficSource.medium, count(*) cnt\nFROM\n`bigquery-public-data.google_analytics_sample.ga_sessions_201707*`\nWHERE -- trafficSource.source IN ('google', '(direct)') AND \n trafficSource.medium = '(none)'\nGROUP BY 1,2\nORDER BY cnt DESC\n\n        \"\"\"\ninspect(query)","206826b0":"# What are possible media? in 2017 value_counts\nquery = \"\"\"SELECT\ntrafficSource.medium, COUNT(*) as cnt\nFROM\n`bigquery-public-data.google_analytics_sample.ga_sessions_2017*`\nGROUP BY trafficSource.medium\nORDER BY cnt DESC\n        \"\"\"\ninspect(query)\n# cpc: cost per click - use when has good offer with high conversion rate using ads adapted to that specific offer\n# cpm: cost per thousand impression - may save money if good CTR, can buy traffic from premium spots\n# cpv = cost per unique visitor","6a865df2":"# What are possible devices? value_counts\nquery = \"\"\"SELECT\ndevice.browser, COUNT(*) as cnt\nFROM\n`bigquery-public-data.google_analytics_sample.ga_sessions_201707*`\nGROUP BY device.browser\nORDER BY cnt DESC\n        \"\"\"\ninspect(query)\n","522da8df":"# What are possible device categories? value_counts\nquery = \"\"\"SELECT\ndevice.deviceCategory, COUNT(*) as cnt\nFROM\n`bigquery-public-data.google_analytics_sample.ga_sessions_201707*`\nGROUP BY device.deviceCategory\nORDER BY cnt DESC\n        \"\"\"\ninspect(query)","8fd3b988":"# What are possible browsers? value_counts -- counts unique users -  but session is more relevant\nquery = \"\"\"\nSELECT\n deviceCategory, \n COUNT(*) as cnt\nFROM\n    (SELECT \n      fullVisitorId,\n      visitId,\n      MAX(device.deviceCategory) as deviceCategory\n    FROM\n     `bigquery-public-data.google_analytics_sample.ga_sessions_201707*`\n    GROUP BY fullVisitorId, visitId\n    ) s\nGROUP BY deviceCategory\nORDER BY cnt DESC\n        \"\"\"\ninspect(query)","85436e92":"query = \"\"\"\nSELECT  \n totals.sessionQualityDim,\n COUNT(*) cnt\nFROM \n`bigquery-public-data.google_analytics_sample.ga_sessions_201707*`\nGROUP BY totals.sessionQualityDim\nORDER by cnt DESC\n\n\"\"\"\nsess_quality_vc = retrieve(query)","82310e00":"import seaborn as sns\nsns.set()\nsns.scatterplot(x='sessionQualityDim', y='cnt', data=sess_quality_vc[sess_quality_vc['sessionQualityDim'] > 2])\n# exclude the two ","fae69748":"sess_quality_vc.sort_values('sessionQualityDim').tail(10)","e36617b3":"query = \"\"\"\nSELECT  \n totals.timeOnSite,\n COUNT(*) cnt\nFROM \n`bigquery-public-data.google_analytics_sample.ga_sessions_2017*`\nGROUP BY totals.timeOnSite\nORDER by cnt DESC\n\n\"\"\"\ntime_on_site = retrieve(query) \n#  totals.timeOnScreen - not a valid column\n# timeOnSite: Total time of the session expressed in seconds.","4187c1c6":"time_on_site['timeOnSite'].describe()","4b5d7772":"# Base conversion rate in July\nquery = f\"\"\"\nSELECT \n    COUNT(totals.totalTransactionRevenue) AS cnt_revenue,\n    COUNT(totals.transactions) AS cnt_transactions, \n    COUNT(*) AS cnt_all_rows, --sessions with browser\n    COUNT(totals.transactions) \/ COUNT(*) AS sess_conversion_rate,\n    sum(totals.totalTransactionRevenue) AS sum_revenue, \n    Sum(totals.transactions) AS  sum_transactions,\n    sum(totals.totalTransactionRevenue) \/ Sum(totals.transactions) AS revenue_per_transaction\nFROM `bigquery-public-data.google_analytics_sample.ga_sessions_201707*` \n\"\"\"\n\nbase_CR = retrieve(query)","b32c9861":"base_CR","cea0eb22":"# Base conversion rate by month \nquery = f\"\"\"\nSELECT \n    substr(date, 1, 6) as ym,\n    COUNT(totals.totalTransactionRevenue) AS cnt_revenue,\n    COUNT(totals.transactions) AS cnt_transactions, \n    COUNT(*) AS cnt_all_rows, --sessions with browser\n    COUNT(totals.transactions) \/ COUNT(*) AS sess_conversion_rate,\n    sum(totals.totalTransactionRevenue) AS sum_revenue, \n    Sum(totals.transactions) AS  sum_transactions,\n    sum(totals.totalTransactionRevenue) \/ Sum(totals.transactions) AS revenue_per_transaction\nFROM `bigquery-public-data.google_analytics_sample.ga_sessions*` \nGROUP BY ym\nORDER BY ym\n\"\"\"\n\nmonthly_base_CR = retrieve(query)","87d85efe":"monthly_base_CR\n# Not all transactionshave revenue? ","cda34896":"monthly_base_CR['ym'] = pd.to_datetime(monthly_base_CR['ym'], format='%Y%m')","961f11b7":"sns.lineplot(x='ym', y='sess_conversion_rate', data=monthly_base_CR)","fb3a4cb7":"sns.lineplot(x='ym', y='cnt_all_rows', data=monthly_base_CR)\n# the big CR dip in Nov is due more to higher traffic than a drop in transactions","dc0b98d4":"# Base conversion rate by month and device category\nquery = \"\"\"\nSELECT \n    substr(date, 1, 6) as ym,\n    device.deviceCategory,\n    COUNT(totals.totalTransactionRevenue) AS cnt_revenue,\n    COUNT(totals.transactions) AS cnt_transactions, \n    COUNT(*) AS cnt_all_rows, --sessions with browser\n    COUNT(totals.transactions) \/ COUNT(*) AS sess_conversion_rate,\n    sum(totals.totalTransactionRevenue) AS sum_revenue, \n    Sum(totals.transactions) AS  sum_transactions,\n    sum(totals.totalTransactionRevenue) \/ Sum(totals.transactions) AS revenue_per_transaction\nFROM `bigquery-public-data.google_analytics_sample.ga_sessions_*`\nGROUP BY  device.deviceCategory, ym\nORDER BY device.deviceCategory, ym\n\"\"\"\nmonthly_device_CR = retrieve(query)\nmonthly_device_CR.head()","35e520a2":"import matplotlib.pyplot as plt\ndef plot_metric_by_month(vc_df, metric, group):\n    '''Convert date from string and plot metric by group\n    vc_df: df, SQL value counts output grouped by month and group\n    metric: str, column name for metric of interest\n    group: str, column name of group'''\n    df = vc_df.copy()\n    df['ym'] = pd.to_datetime( df['ym'], format='%Y%m')\n    sns.lineplot(x='ym', y=metric, hue=group, data=df, marker='o')\n    plt.title(f'Monthly {metric}')\n    plt.legend(loc=\"upper left\", bbox_to_anchor=(1,1))","ca1ef7d1":"plot_metric_by_month(monthly_device_CR, 'sess_conversion_rate', 'deviceCategory')\n# much higher CR when visited via desktop","e268b9be":"plot_metric_by_month(monthly_device_CR, 'cnt_transactions', 'deviceCategory')\n# raw count looks similar in shape for desktop and mobile, so likely consistent total traffic but changing number of transactions","151040ec":"# Base conversion rate by month and traffic source\nquery = \"\"\"\nSELECT \n    substr(date, 1, 6) as ym,\n    trafficSource.medium, \n    COUNT(totals.totalTransactionRevenue) AS cnt_revenue,\n    COUNT(totals.transactions) AS cnt_transactions, \n    COUNT(*) AS cnt_all_rows, --sessions with browser\n    COUNT(totals.transactions) \/ COUNT(*) AS sess_conversion_rate,\n    sum(totals.totalTransactionRevenue) AS sum_revenue, \n    Sum(totals.transactions) AS  sum_transactions,\n    sum(totals.totalTransactionRevenue) \/ Sum(totals.transactions) AS revenue_per_transaction\nFROM `bigquery-public-data.google_analytics_sample.ga_sessions_*`\nGROUP BY trafficSource.medium, ym\nORDER BY trafficSource.medium, ym\n\"\"\"\nmonthly_medium_CR = retrieve(query)","ba2f64e3":"plot_metric_by_month(monthly_medium_CR, 'sess_conversion_rate', 'medium')\n# direct ads (cpc and cpm) > organic > referral\/affiliate\n# medium can have a pretty strong effect on CR - diverging from the overall average of 1.5% ","b2c649ef":"plot_metric_by_month(monthly_medium_CR, 'cnt_transactions', 'medium')\n# organic has a low CR but it makes up for a good chunk of the transactions\n# Need to look further into (none) --> direct traffic - so people who want to buy stuff often visit directly \n# - bookmarks? returning customers?","9f7b057e":"# Base conversion rate by month and browser \nquery = \"\"\"\nSELECT \n    substr(date, 1, 6) as ym,\n    device.browser,\n    COUNT(totals.totalTransactionRevenue) AS cnt_revenue,\n    COUNT(totals.transactions) AS cnt_transactions, \n    COUNT(*) AS cnt_all_rows, --sessions with browser\n    COUNT(totals.transactions) \/ COUNT(*) AS sess_conversion_rate,\n    sum(totals.totalTransactionRevenue) AS sum_revenue, \n    Sum(totals.transactions) AS  sum_transactions,\n    sum(totals.totalTransactionRevenue) \/ Sum(totals.transactions) AS revenue_per_transaction\nFROM `bigquery-public-data.google_analytics_sample.ga_sessions_*`\nGROUP BY  device.browser, ym\nORDER BY  device.browser, ym\n\"\"\"\nmonthly_browser_CR = retrieve(query)","b810475e":"mask = (monthly_browser_CR['sess_conversion_rate'] > 0) | (monthly_browser_CR['cnt_all_rows'] > 1000) # doesn't catch every month if a browser doesn't always make it\nprint(len(monthly_browser_CR[mask]))\nmonthly_browser_CR[mask].sample(10)","146af86d":"plot_metric_by_month(monthly_browser_CR[mask], 'sess_conversion_rate', 'browser')\n# Chrome dominates both raw count and CR\n# Silk has that one blip of relatively high CR","fa95064e":"plot_metric_by_month(monthly_browser_CR[mask], 'cnt_transactions', 'browser')\n","78b046ee":"plot_metric_by_month(monthly_browser_CR[mask & (monthly_browser_CR['browser'] != 'Chrome')], 'cnt_transactions', 'browser')\n# Safari being a distant second but another sizeable gap from the rest","27db6a5b":"\n# Base conversion rate by month and source\nquery = \"\"\"\nSELECT \n    substr(date, 1, 6) as ym,\n    trafficSource.source,\n    COUNT(totals.totalTransactionRevenue) AS cnt_revenue,\n    COUNT(totals.transactions) AS cnt_transactions, \n    COUNT(*) AS cnt_all_rows, --sessions with browser\n    COUNT(totals.transactions) \/ COUNT(*) AS sess_conversion_rate,\n    sum(totals.totalTransactionRevenue) AS sum_revenue, \n    Sum(totals.transactions) AS  sum_transactions,\n    sum(totals.totalTransactionRevenue) \/ Sum(totals.transactions) AS revenue_per_transaction\nFROM `bigquery-public-data.google_analytics_sample.ga_sessions_*`\nGROUP BY trafficSource.source, ym\nORDER BY  trafficSource.source, ym\n\"\"\"\nmonthly_source_CR = retrieve(query)","939ba088":"monthly_source_CR.head(10)","400eca1c":"monthly_source_CR.shape","611af8d0":"mask = (monthly_source_CR['cnt_all_rows'] > 500) \nplot_metric_by_month(monthly_source_CR[mask], 'sess_conversion_rate', 'source')\n# dominated by direct or google\n# not sure what dfa is","c7f53d08":"mask = (monthly_source_CR['cnt_all_rows'] > 500) \nplot_metric_by_month(monthly_source_CR[mask], 'sess_conversion_rate', 'source')","3e067899":"# looking into a particuar visitor\nquery = \"\"\"SELECT date, visitId, channelGrouping, visitNumber, trafficSource.medium, \n            totals.*\n            FROM `bigquery-public-data.google_analytics_sample.ga_sessions_*`\n            WHERE  fullVisitorId =  '7813149961404844386'\n            ORDER BY date \n            \n            \"\"\"\nq = retrieve(query)\n\n","3291948c":"q.head()","ba0a3c39":"# channelgrouping - ga channels\nquery = \"\"\"SELECT channelGrouping, COUNT(*) cnt\n            FROM `bigquery-public-data.google_analytics_sample.ga_sessions_*`\n            GROUP BY channelGrouping\n            \"\"\"\ninspect(query)","8e862d1f":"query = \"\"\"SELECT channelGrouping, COUNT(DISTINCT trafficSource.medium) cnt\n            FROM `bigquery-public-data.google_analytics_sample.ga_sessions_*`\n            GROUP BY channelGrouping\n            \"\"\"\ninspect(query)","6928fda9":"# verify conditions match up with definition  https:\/\/support.google.com\/analytics\/answer\/3297892\nquery = \"\"\"SELECT channelGrouping, array_agg(DISTINCT trafficSource.medium) cnt\n            FROM `bigquery-public-data.google_analytics_sample.ga_sessions_*`\n            GROUP BY channelGrouping\n            \"\"\"\ninspect(query)","19abe4eb":"# above by with counts within each group\nquery = \"\"\"SELECT channelGrouping,trafficSource.medium, count(*) cnt\n            FROM `bigquery-public-data.google_analytics_sample.ga_sessions_*`\n            GROUP BY channelGrouping,trafficSource.medium\n            \"\"\"\ninspect(query)","01c65370":"# group by medium\nquery = \"\"\"SELECT trafficSource.medium,  channelGrouping, count(*) cnt\n            FROM `bigquery-public-data.google_analytics_sample.ga_sessions_*`\n            GROUP BY trafficSource.medium, channelGrouping\n            ORDER BY trafficSource.medium\n            \"\"\"\ninspect(query)\n# so (none) can have labeled in channelGroupig even when ","387f37ba":"# what do these look like? \nquery = \"\"\"SELECT * \n            FROM `bigquery-public-data.google_analytics_sample.ga_sessions_*`\n            WHERE trafficSource.medium = '(none)'\n                AND channelGrouping = 'Referral'\n            \n            \"\"\"\ninspect(query)","4716f63f":"query = \"\"\"\nSELECT \n    substr(date, 1, 6) as ym,\n    channelGrouping,\n    COUNT(totals.totalTransactionRevenue) AS cnt_revenue,\n    COUNT(totals.transactions) AS cnt_transactions, \n    COUNT(*) AS cnt_all_rows, --sessions with browser\n    COUNT(totals.transactions) \/ COUNT(*) AS sess_conversion_rate,\n    sum(totals.totalTransactionRevenue) AS sum_revenue, \n    Sum(totals.transactions) AS  sum_transactions,\n    sum(totals.totalTransactionRevenue) \/ Sum(totals.transactions) AS revenue_per_transaction\nFROM `bigquery-public-data.google_analytics_sample.ga_sessions_*`\nGROUP BY  channelGrouping, ym\nORDER BY channelGrouping, ym\n\"\"\"\nmonthly_channel_CR = retrieve(query)\nmonthly_channel_CR.head()","ea4be16f":"monthly_channel_CR.sum()","9af0845c":"plot_metric_by_month(monthly_channel_CR, 'sess_conversion_rate', 'channelGrouping')","4efa75ef":"plot_metric_by_month(monthly_channel_CR, 'cnt_transactions', 'channelGrouping')\n# Why does this look so different than raw source medium\n    # because (none) can be assigned to various channelGroupings and other caveats\n# https:\/\/support.google.com\/analytics\/answer\/3297892","cd07e812":"# Base conversion rate by month and traffic source\nquery = \"\"\"\nSELECT \n    substr(date, 1, 6) as ym,\n    trafficSource.medium, \n    COUNT(totals.totalTransactionRevenue) AS cnt_revenue,\n    COUNT(totals.transactions) AS cnt_transactions, \n    COUNT(*) AS cnt_all_rows, --sessions with browser\n    COUNT(totals.transactions) \/ COUNT(*) AS sess_conversion_rate,\n    sum(totals.totalTransactionRevenue) AS sum_revenue, \n    Sum(totals.transactions) AS  sum_transactions,\n    sum(totals.totalTransactionRevenue) \/ Sum(totals.transactions) AS revenue_per_transaction\nFROM `bigquery-public-data.google_analytics_sample.ga_sessions_*`\nGROUP BY trafficSource.medium, ym\nORDER BY trafficSource.medium, ym\n\"\"\"\nmonthly_medium_CR = retrieve(query)","a1bc98c5":"monthly_medium_CR.sum()\n# revenue per transaction and sess_conversion_rate changed -- rest stayed the same","74627582":"plot_metric_by_month(monthly_medium_CR, 'sess_conversion_rate', 'medium')\n# direct ads (cpc and cpm) > organic > referral\/affiliate\n# medium can have a pretty strong effect on CR - diverging from the overall average of 1.5% ","6d70a8af":"plot_metric_by_month(monthly_medium_CR, 'cnt_transactions', 'medium')\n# organic has a low CR but it makes up for a good chunk of the transactions\n# Need to look further into (none) --> direct traffic - so people who want to buy stuff often visit directly \n# - bookmarks? returning customers?","6ad7532d":"# Look at available columns","3169024f":"Resources and Acknowledgements:\n* Table schema https:\/\/support.google.com\/analytics\/answer\/3437719?hl=en\n* BigQueryHelper https:\/\/www.kaggle.com\/sohier\/introduction-to-the-bq-helper-package\n* BigQuery tricks: https:\/\/www.kaggle.com\/vikramtiwari\/bigquery-in-depth-using-google-analytics-data\n* BQ Standard SQL - Unnest: https:\/\/cloud.google.com\/bigquery\/docs\/reference\/standard-sql\/query-syntax#unnest","1b90a89f":"# Inspiration Questions:\n\n1. [What is the total number of transactions generated per device browser in July 2017?](#insp1)\n2. [The real bounce rate is defined as the percentage of visits with a single pageview. What was the real bounce rate per traffic source?](#insp2)\n3. [What was the average number of product pageviews for users who made a purchase in July 2017?](#insp3)\n4. [What was the average number of product pageviews for users who did not make a purchase in July 2017?](#insp4)\n5. [What was the average total transactions per user that made a purchase in July 2017?](#insp5)\n6. [What is the average amount of money spent per session in July 2017?](#insp6)\n7. [What is the sequence of pages viewed?](#insp7)","31b4f8d1":"<a id='insp4'> <\/a>\n\nWhat was the average number of product pageviews for users who did not make a purchase in July 2017?  \n<t>Slight differences in the average for both questions 3 and 4 depending on interpretation of question but overall trend is that users who make a purchase have more than 3 times the page views as users who do not make a purchase.","ea09c89a":"We've found that conversion rate and the number of transactions have associations with the traffic source as well the device and browser used for the visit. Direct visits and paid ads appear to be positively correlated with conversion ratios. Chrome users make up an overwhelming majority of conversions. \n\n","f1e44c27":"### TrafficSource","9bb013dd":"Description of columns available at https:\/\/support.google.com\/analytics\/answer\/3437719?hl=en  \n\nNotable columns:\n1. fullVisitorId: str, unique visitor ID (hashed) \n2. visitID - int, identifier to session - only unique within user -- completely unique id is 1+2\n","cb94cf65":"Misc Queries\n\n","3132b3e5":"### Base conversion rate by month and browser ","63af8245":"<a id='insp5'> <\/a>\n\nWhat was the average total transactions per user that made a purchase in July 2017?\n\n","4a7d26af":"**totals.sessionQualityDim**: An estimate of how close a particular session was to transacting, ranging from 1 to 100, calculated for each session. A value closer to 1 indicates a low session quality, or far from transacting, while a value closer to 100 indicates a high session quality, or very close to transacting. A value of 0 indicates that Session Quality is not calculated for the selected time range.\n\n<p> How well does it predict actual conversion\/transacting? Come back to this. <\/p> ","4b898d72":"### Base conversion rate by month and traffic source","1f878b56":"<a id='insp7'> <\/a>\nWhat is the sequence of pages viewed?","da804f95":"<a id='insp2'> <\/a>\nThe real bounce rate is defined as the percentage of visits with a single pageview. What was the real bounce rate per traffic source?","886f6b92":"<a id='insp1'> <\/a>\nWhat is the total number of transactions generated per device browser in July 2017?","e01da7bb":"### What are the possible values for various columns of interest?","25f0ee43":"# Preface\nI will be looking at some common digital marketing metrics by exploring the Google Analytics data of the Google Mercandise Store, an ecommerce site. I will primarily be using SQL and bq_helper to assess the data from BigQuery, along with some pandas and seaborn functionsfor additional processing and visualizations. ","2407128b":"# To do's\n<p> This is a rich data set, so a lot remains to be explored. This includes looking at different campaigns, closer looks into specific audiences, other definitions of conversion, other metrics like ROI and ROAS. An interesting feature is the totals.sessionQualityDim, which is GA's estimate on how close a session came to converting. There are other ones like totals.timeOnScreen, which may be more a vanity metric but could be insightful on the user experience. <\/p>","b0a0cc2a":"## Having found interesting columns to explore, let's see how they might affect conversion rate.\n","23ad5420":"### Base conversion rate by month and source","8a4d7eed":"<a id='insp3'> <\/a>\nWhat was the average number of product pageviews for users who made a purchase in July 2017?\n","ccd2c54a":"<a id='insp6'> <\/a>\nWhat is the average amount of money spent per session in July 2017?\n\n","1423e3b4":"# Exploring other columns\nSticking with July 2017\n1. trafficSource.source\n2. trafficSource.medium\n3. device.browser\n4. device.deviceCategory\n5. totals.sessionQualityDim\n6. totals.timeOnScreen\n<p hidden> 7. GROUP BY Source SELECT sum(Revenue) - c * Count(impressions) <\/p>","bfefa8a1":"### Base conversion rate by month ","a1e7f9e5":"### Base conversion rate by month and device category","0d42d2f6":"## Check for duplicates "}}