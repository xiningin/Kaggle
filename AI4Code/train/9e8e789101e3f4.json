{"cell_type":{"9f21615d":"code","d66b7a59":"code","a69257fb":"code","67f8ac66":"code","a14dac62":"code","5e3591da":"code","e6c05382":"code","ef99eb58":"code","420b4c2a":"code","a771de67":"code","a35f8a36":"code","c82c9660":"code","b7eee563":"code","a7a099ac":"code","c3f29193":"code","97a92e54":"code","034ad24a":"code","03a70cd0":"code","bd0fb41a":"code","3eb8ae4f":"code","5a551edf":"code","e5dff67b":"code","145a82d6":"markdown","11059275":"markdown","bf926668":"markdown","e1f0a34a":"markdown"},"source":{"9f21615d":"!pip install imageio\n!pip install imageio-ffmpeg\n!pip install mtcnn","d66b7a59":"import numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\nimport matplotlib.pyplot as plt\nimport os\nfrom collections import defaultdict\nimport cv2\nimport numpy as np\nimport pylab\nimport imageio\nfrom mtcnn import MTCNN\nimport cv2\nimport json\nfrom tqdm import tqdm","a69257fb":"def train_test_data(path,complete_path=False):\n    '''get file names of train and test data folder\n       complete_path - get list with the full path  \n        '''\n    dataset = []\n    folderseq = []\n    for dirname, _, filenames in os.walk(path):\n        \n        folderseq.append(_)\n\n        for folder in _:\n            \n            for dire,_,file in os.walk(os.path.join(dirname,folder)):\n                if complete_path == True:\n                    full_path = []\n                    for val in file:\n                        full_path.append(os.path.join(dire,val))\n                    dataset.append(full_path)\n                else:\n                    dataset.append(file)\n#     print(dataset)\n   \n    if folderseq[0][0] == 'train_sample_videos':\n        return dataset[0],dataset[1]\n        \n    else :\n        return dataset[1],dataset[0]\n        \n    \ndef count_file(file_list):\n    '''Check type of file format in each train test folder'''\n    count = defaultdict(int)\n    for file in file_list:\n        fileformat = file.split('.')[1]\n        count[fileformat] += 1\n    return count","67f8ac66":"TRAIN_FOLDER = '\/kaggle\/input\/deepfake-detection-challenge\/train_sample_videos\/'\nTEST_FOLDER = '\/kaggle\/input\/deepfake-detection-challenge\/test_videos\/'\ntrain_file,test_file = train_test_data('\/kaggle\/input\/deepfake-detection-challenge\/',complete_path=False)","a14dac62":"count_file(train_file),count_file(test_file)","5e3591da":"def get_jsonpath(train_file):\n    '''get the path on json file in train data'''\n    for file in train_file:        \n        if file.split('.')[1] == 'json':\n            json_index = train_file.index(file)\n    metadata = os.path.join(TRAIN_FOLDER,train_file[json_index])\n    return metadata\n","e6c05382":"metadata = get_jsonpath(train_file)","ef99eb58":"'''remove metadata form train folder '''\ntrain_file.remove('metadata.json')\nprint(len(train_file))","420b4c2a":"json_meta = pd.read_json(metadata)\njson_meta = json_meta.T.reset_index()\njson_meta.columns = ['input', 'label', 'split', 'original']\njson_meta.head()","a771de67":"json_meta['label'].value_counts()","a35f8a36":"def check_datacoverage(json_meta,train_file):\n    '''check how may .mp4 files of metadata.json present in our dataset'''\n    original = json_meta.dropna().values.tolist()\n    test1 = []\n    for val in original:\n        if val in train_file:\n            test1.append(val)\n    return print('Out of {} videos {} files available in dataset'.format(len(original),len(test1)))\n    ","c82c9660":"# All  input videos of json  file present in train folder\ncheck_datacoverage(json_meta['input'],train_file)","b7eee563":"# Out of 323 original videos only 58 vides files available in train dataset\ncheck_datacoverage(json_meta['original'],train_file)","a7a099ac":"def generate_data(metadata,train_file):\n    '''generate dataset of only those FAKE - REAL file pairs that are available in the dataset'''\n    json_data = json.load(open(metadata))\n    dataset = []\n    for val in json_data:\n        if val in train_file:\n            if json_data[val]['label'] == 'FAKE':\n                if json_data[val]['original'] in train_file:\n                    dataset.append((val,json_data[val]['original']))\n    print('Total File Pairs - {}'.format(len(dataset)))\n    return dataset\n    ","c3f29193":"fake_original_data = generate_data(metadata,train_file)","97a92e54":"def get_data_imgio(data,frames):\n    '''Return fake and real images  for single video file\n    with numbers of frames set to scan for faces. All images are resized to\n        160*160 size\n    '''\n    test0 = []\n    test1 = []\n    vid = imageio.get_reader(os.path.join(TRAIN_FOLDER,data[0]),  'ffmpeg')\n    vid2 = imageio.get_reader(os.path.join(TRAIN_FOLDER,data[1]),  'ffmpeg')\n    nums = np.linspace(0,vid.count_frames() - 1,frames,dtype=int)\n    for num in nums:\n        try:\n            image = vid.get_data(num)\n            image2 = vid2.get_data(num)\n    #         print(image)\n            img = cv2.cvtColor(image, cv2.COLOR_BGR2RGB)\n            img2 = cv2.cvtColor(image2, cv2.COLOR_BGR2RGB)\n            detector = MTCNN()\n            x1, y1, width, height = detector.detect_faces(img)[0]['box']\n            x2, y2 = x1 + width, y1 + height\n            res = cv2.resize(img[y1:y2, x1:x2],(160,160))\n            res = cv2.cvtColor(res, cv2.COLOR_BGR2GRAY)\n            test0.append(res)\n            res2 = cv2.resize(img2[y1:y2, x1:x2],(160,160))\n            res2 = cv2.cvtColor(res2, cv2.COLOR_BGR2GRAY)\n            test1.append(res2)\n        except:\n            continue\n#         break\n        \n        \n    test0 = np.stack(test0)\n    test1 = np.stack(test1)\n    return test0,test1\n","034ad24a":"def show_img(num):\n    '''select the frame to show fake and real image out of total frames set to scan'''\n    fig,ax = plt.subplots(1,2,figsize=(10,10))\n    ax[0].imshow(x[num])\n    ax[0].set_title('FAKE')\n    ax[1].imshow(y[num])\n    ax[1].set_title('REAL')\n    \nx,y = get_data_imgio(fake_original_data[30],30)\nx.shape,y.shape\n# Each vides mp4 file 30 frames are selected to get faces from them ","03a70cd0":"show_img(22) #select from 0 - 29 because 30 frames selected to scan the image","bd0fb41a":"x,y = get_data_imgio(fake_original_data[15],30)\nshow_img(17) #select from 0 - 29 because 30 frames selected to scan the image","3eb8ae4f":"def generate_training_data(fake_original_data):\n    '''generate fake and original video  with there labels'''\n    trainx = []\n    trainy = []\n    for data in tqdm(fake_original_data):\n        try:\n            train,test = get_data_imgio(data,30)\n            trainx.append(train)\n            trainy.append(test)\n        except:\n            continue\n#         break\n    inp = np.vstack(trainx)\n    real = np.vstack(trainy)\n    zero = np.zeros(inp.shape[0])\n    one = np.ones(inp.shape[0])\n    label = np.concatenate((zero,one))\n    images = np.concatenate((inp,real),axis=0)\n    images = np.expand_dims(images,axis=-1)\n    \n    return images,label\n","5a551edf":"X,y = generate_training_data(fake_original_data)","e5dff67b":"X.shape,y.shape","145a82d6":"above is example on one frame of one MP4 file with fake and real images side to each other ","11059275":"dataset = fake_original_data","bf926668":"Total of 400 video files in train_file after removing metadata.json ","e1f0a34a":"400 MP4 in train folder with one metadata.json .\n400 MP4 in test folder ."}}