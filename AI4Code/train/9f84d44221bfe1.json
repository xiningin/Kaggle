{"cell_type":{"35faf628":"code","5fba78f9":"code","b458c4b0":"code","3c03a957":"code","12a5bb35":"code","cc45a471":"code","fc9dadc3":"code","07a8c11b":"code","8aa261be":"code","d74ce121":"code","a7218a73":"code","c7bcc9ab":"code","fe95d7de":"code","a7a83ef6":"code","3b328bba":"code","6c9bca9d":"code","ef553102":"code","3c47af5f":"code","3b385561":"code","e0f3be1f":"markdown","db1908b3":"markdown","d733edd1":"markdown","2194f4c7":"markdown","7328c944":"markdown","3e0412f3":"markdown","33cd2d2d":"markdown","811ec210":"markdown","b287f47e":"markdown","e2acadc1":"markdown","c9595e78":"markdown","483c50b4":"markdown","f49a3577":"markdown","8867f23b":"markdown","633da640":"markdown","9135b1ac":"markdown","5fcf1b8a":"markdown","cd31ec9f":"markdown","e8cab146":"markdown","4091c7c4":"markdown","c6753570":"markdown","0f66a620":"markdown","5df2de1a":"markdown","17edfb56":"markdown","ddbfbb4d":"markdown","9408c88f":"markdown"},"source":{"35faf628":"import pandas as pd\nimport numpy as np\nimport tensorflow as tf\nimport cv2\nimport os\nimport matplotlib.pyplot as plt\nimport seaborn as sns\nfrom keras.preprocessing.image import ImageDataGenerator\nfrom keras.callbacks import ReduceLROnPlateau\nfrom sklearn.metrics import confusion_matrix\nfrom keras.preprocessing import image","5fba78f9":"labels = ['NORMAL', 'PNEUMONIA']\ndef read_images(directory):\n    x = []\n    y = []\n    for label in labels: \n        path = os.path.join(directory, label)\n        image_class = labels.index(label)\n        for image_name in os.listdir(path):\n            if image_name == \".DS_Store\":\n                continue\n            image = cv2.imread(os.path.join(path, image_name), cv2.IMREAD_GRAYSCALE)\n            image = cv2.resize(image, (150, 150))\n            x.append(image \/ 255)\n            y.append(image_class)\n    return ((np.array(x)).reshape(-1, 150, 150, 1), np.array(y))","b458c4b0":"x_test, y_test = read_images('..\/input\/chest-xray-pneumonia\/chest_xray\/chest_xray\/test')\nx_val, y_val = read_images('..\/input\/chest-xray-pneumonia\/chest_xray\/chest_xray\/val')","3c03a957":"train_datagen = ImageDataGenerator(rescale = 1.\/255,\n                                   rotation_range = 10,\n                                   width_shift_range=0.1,\n                                   height_shift_range=0.1,\n                                   shear_range = 0.2,\n                                   zoom_range = 0.2)\ntraining_set = train_datagen.flow_from_directory('..\/input\/chest-xray-pneumonia\/chest_xray\/train\/',\n                                                 target_size = (150, 150),\n                                                 batch_size = 32,\n                                                 color_mode = 'grayscale',\n                                                 class_mode = 'binary')","12a5bb35":"test_datagen = ImageDataGenerator(rescale = 1.\/255)\ntest_set = test_datagen.flow_from_directory('..\/input\/chest-xray-pneumonia\/chest_xray\/test\/',\n                                            target_size = (150, 150),\n                                            batch_size = 32,\n                                            color_mode = 'grayscale',\n                                            class_mode = 'binary')","cc45a471":"cnn = tf.keras.models.Sequential()","fc9dadc3":"cnn.add(tf.keras.layers.Conv2D(filters=32, kernel_size=3, activation='relu', input_shape=[150, 150, 1]))\ncnn.add(tf.keras.layers.MaxPool2D(pool_size=2, strides=2))","07a8c11b":"cnn.add(tf.keras.layers.Conv2D(filters=32, kernel_size=3, activation='relu'))\ncnn.add(tf.keras.layers.MaxPool2D(pool_size=2, strides=2))","8aa261be":"cnn.add(tf.keras.layers.Conv2D(filters=32, kernel_size=3, activation='relu'))\ncnn.add(tf.keras.layers.MaxPool2D(pool_size=2, strides=2))","d74ce121":"cnn.add(tf.keras.layers.Flatten())\ncnn.add(tf.keras.layers.Dropout(0.5))","a7218a73":"cnn.add(tf.keras.layers.Dense(units=512, activation='relu'))\ncnn.add(tf.keras.layers.Dropout(0.5))","c7bcc9ab":"cnn.add(tf.keras.layers.Dense(units=1, activation='sigmoid'))","fe95d7de":"cnn.compile(optimizer = 'adam', loss = 'binary_crossentropy', metrics = ['accuracy'])","a7a83ef6":"reduce_lr = ReduceLROnPlateau(monitor = 'val_loss', factor = 0.25,\n                              patience = 3, min_lr = 0.00001)\ncnn.fit(x = training_set, validation_data = test_set, epochs = 12, callbacks=[reduce_lr])","3b328bba":"cnn.evaluate(x_val,y_val)","6c9bca9d":"y_pred = cnn.predict(x_test)\ny_pred = [1 if x > 0.5 else 0 for x in y_pred]","ef553102":"cm = confusion_matrix(y_test, y_pred)\nprint(cm)","3c47af5f":"cm = pd.DataFrame(cm , index = ['0','1'] , columns = ['0','1'])\nplt.figure(figsize = (15,10))\nsns.heatmap(cm,cmap= \"Blues\", linewidth = 3 , annot = True, \n            fmt='',xticklabels = ['Pneumonia', 'Normal'],yticklabels = ['Pneumonia', 'Normal'])","3b385561":"test_image = image.load_img('..\/input\/chest-xray-pneumonia\/chest_xray\/val\/PNEUMONIA\/person1946_bacteria_4875.jpeg',\n                            target_size = (150, 150), color_mode = 'grayscale')\ntest_image = image.img_to_array(test_image)\ntest_image = np.expand_dims(test_image, axis = 0)\nresult = cnn.predict(test_image)\nif result[0][0] == 1:\n  prediction = 'Pneumonia'\nelse:\n  prediction = 'Normal'\nprint(prediction)","e0f3be1f":"Bronchial branches are very difficult to differentiate from lung tissue because they both are filled with air and produce similar shadow, however if the lung has consolidation, you can see the branches of bronchus going through the tissue.  \n*Air bronchogram* is the phenomenon of air-filled bronchi (dark) being made visible by the opacification of surrounding alveoli (grey\/white) due to lung consolidation. ","db1908b3":"## Normal lung\nNormal lung on chest x-ray should appear grey as alveolae are filled with air. In a normal chest x-ray you should always see blood vessels which appear whitish.","d733edd1":"## Making a single prediction","2194f4c7":"### Flattening","7328c944":"## Data Preprocessing","3e0412f3":"### First convolutional layer","33cd2d2d":"### Output Layer","811ec210":"### Third convolutional layer","b287f47e":"## Chest X-Rays\nA chest x-ray is one of the most important diagnostic tools to either confirm or rule out the diagnosis when a physician is suspecting pneumonia. If auscultation with the help of his stethoscope reveals rales rhonchi and percussion returns are dull sounds instead of healthy hollow drum, it indicates **consolidation** of pleural effusion in lungs which both are indicative of pneumonia.  \n","e2acadc1":"![IM-0147-0001%20%282%29.jpg](attachment:IM-0147-0001%20%282%29.jpg)","c9595e78":"# About Pneumonia\nPneumonia is an illness, usually caused by infection, in which the lungs become inflamed and congested, reducing oxygen exchange and leading to cough and breathlessness. It affects individuals of all ages but occurs most frequently in children and the elderly. Among children, pneumonia is the most common cause of death worldwide.","483c50b4":"#### Recently, the WHO has also pioneered the standardized interpretation of chest X-rays to define bacterial pneumonia.","f49a3577":"## Building the Convolutional Neural Network","8867f23b":"### Full Connection\n#### We will use the Dropout technique which works by randomly reducing the number of interconnecting neurons within a neural network. At every training step, each neuron has a chance of being left out, or rather, dropped out of the collated contribution from connected neurons. This technique minimizes overfitting because each neuron becomes independently sufficient, in the sense that the neurons within the layers learn weight values that are not based on the cooperation of its neighbouring neurons.","633da640":"### Training the CNN on the Training set and evaluating it on the Test set","9135b1ac":"#### For our model we will use the Adam optimizer. The Adam optimization algorithm is an extension to stochastic gradient descent that has recently seen broader adoption for deep learning applications in computer vision. Stochastic gradient descent maintains a single learning rate (termed alpha) for all weight updates and the learning rate does not change during training. Using the Adam optimizier a learning rate is maintained for each network weight (parameter) and separately adapted as learning unfolds.\n#### Adam combines the advantages of two other extensions of stochastic gradient descent. Specifically:\n\n* Adaptive Gradient Algorithm (AdaGrad) that maintains a per-parameter learning rate that improves performance on problems with sparse gradients.\n* Root Mean Square Propagation (RMSProp) that also maintains per-parameter learning rates that are adapted based on the average of recent magnitudes of the gradients for the weight (e.g. how quickly it is changing). This means the algorithm does well on non-stationary problems like noisy images classification.  \n\n#### Adam optimizer realizes the benefits of both AdaGrad and RMSProp.\n","5fcf1b8a":"### Initialising the CNN","cd31ec9f":"### Generate batches of augmented data using the ImageDataGenerator Class\nData augmentation is a technique used to increase the amount of data by adding slightly modified copies of already existing data or newly created synthetic data from existing data. It acts as a regularizer and helps reduce overfitting when training our model. Some popular augmentations people use are grayscales, horizontal flips, random crops, color jitters, translations, rotations, and many more.","e8cab146":"The point to remember is that blood vessels produce a whitish shadow as compared to trachea and bronchi branches which produce black shadow and often are very difficult to see in a normal chest x-ray. ","4091c7c4":"![person35_bacteria_181.jpg](attachment:person35_bacteria_181.jpg)","c6753570":"## Signs of pneumonia on an X-Ray","0f66a620":"### What is consolidation? \n  \nConsolidation is defined as an area of the lung that should normally have air in it and should be collapsible, but is now filled with exudate and has become heavy, firm and inelastic because of exudates. Oxygen can't be absorbed through this area of the lung anymore.  \n\n","5df2de1a":"### Importing libraries","17edfb56":"### Compiling the CNN","ddbfbb4d":"## Conventional diagnosis of pneumonia consists of two stages: \n - first, determining the syndrome by history, clinical examination, and chest radiology; \n - and second, determining the etiology by microbiological, serological, and molecular tests.  \n","9408c88f":"### Second convolutional layer"}}