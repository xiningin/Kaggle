{"cell_type":{"4c931215":"code","ac800367":"code","9498009c":"code","0fd8bd7b":"code","36131db6":"code","7e7e11c8":"markdown"},"source":{"4c931215":"from tqdm import tqdm\nimport numpy as np\nimport pandas as pd\nfrom sklearn.model_selection import GroupKFold","ac800367":"class UnionFind():\n    def __init__(self, n):\n        self.n = n\n        self.parents = [-1] * n\n\n    def find(self, x):\n        if self.parents[x] < 0:\n            return x\n        else:\n            self.parents[x] = self.find(self.parents[x])\n            return self.parents[x]\n\n    def union(self, x, y):\n        x = self.find(x)\n        y = self.find(y)\n        if x == y:\n            return\n        if self.parents[x] > self.parents[y]:\n            x, y = y, x\n        self.parents[x] += self.parents[y]\n        self.parents[y] = x\n\n\ndef get_group_unionfind(train: pd.DataFrame):\n    unique_text = set(train['less_toxic']) | set(train['more_toxic'])\n    text2num = {text: i for i, text in enumerate(unique_text)}\n    num2text = {num: text for text, num in text2num.items()}\n    train['num_less_toxic'] = train['less_toxic'].map(text2num)\n    train['num_more_toxic'] = train['more_toxic'].map(text2num)\n\n    uf = UnionFind(len(unique_text))\n    for seq1, seq2 in train[['num_less_toxic', 'num_more_toxic']].to_numpy():\n        uf.union(seq1, seq2)\n\n    text2group = {num2text[i]: uf.find(i) for i in range(len(unique_text))}\n    train['group'] = train['less_toxic'].map(text2group)\n    train = train.drop(columns=['num_less_toxic', 'num_more_toxic'])\n    return train","9498009c":"train = pd.read_csv(\"..\/input\/jigsaw-toxic-severity-rating\/validation_data.csv\")","0fd8bd7b":"%%time\n###GET GROUP!###\ntrain = get_group_unionfind(train)","36131db6":"group_kfold = GroupKFold(n_splits=5)\nfor fold, (trn_idx, val_idx) in enumerate(group_kfold.split(train, train, train['group'])): \n    train.loc[val_idx , \"fold\"] = fold\n\ntrain[\"fold\"] = train[\"fold\"].astype(int)\ntrain.to_csv('train_noleak.csv', index=False)\ndisplay(train)","7e7e11c8":"This notebook is a sample code for leak-free CV Starategy by using Union-Find Forest.  \nIt is probably the same as [tito](https:\/\/www.kaggle.com\/its7171)'s [Jigsaw CV strategy](https:\/\/www.kaggle.com\/its7171\/jigsaw-cv-strategy). However, it is much faster for grouping by using Union-find."}}