{"cell_type":{"0d3ef220":"code","a4f94338":"code","8aee621f":"code","1c6e69dc":"code","ba2b043b":"code","d77043f7":"code","7523f141":"code","4e0870c3":"code","bd547d32":"code","ef4a71a0":"code","578494c8":"code","bcdf9f3b":"code","4f132303":"code","0ad2ed48":"code","501b8be7":"code","d38ca2ce":"code","2d6767b1":"code","3fa4267e":"markdown","3c3fd5c4":"markdown","72e138f0":"markdown","67251c0d":"markdown","ced5c9ca":"markdown","5944b616":"markdown","0536621e":"markdown"},"source":{"0d3ef220":"import sys\nimport pytorch_lightning as pl\nsys.path.append('..\/input\/timmmaster')\nimport os\nimport json\nimport glob\nimport random\nimport collections\nimport albumentations as A\nimport timm\nimport cuml ,pickle\nfrom cuml.svm import SVR\nfrom cuml.linear_model import LogisticRegression, ElasticNet\nfrom cuml.ensemble import RandomForestRegressor\nimport pandas as pd\nimport numpy as np\nfrom sklearn.model_selection import train_test_split\n\nimport numpy as np\nimport pandas as pd\nimport pydicom\nfrom pydicom.pixel_data_handlers.util import apply_voi_lut\nimport cv2\nimport matplotlib.pyplot as plt\nimport seaborn as sns\nimport sklearn\nimport torch\npackage_path = \"..\/input\/efficientnet-pytorch\/EfficientNet-PyTorch\/EfficientNet-PyTorch-master\/\"\nimport sys \nsys.path.append(package_path)\nimport glob\nimport warnings\nwarnings.filterwarnings(\"ignore\")\nfrom sklearn.model_selection import StratifiedKFold\n\nimport time\nimport os\nimport torch\nfrom torch import nn\nfrom torch.cuda import amp\nfrom torch.utils import data as torch_data\nfrom sklearn import model_selection as sk_model_selection\nfrom torch.nn import functional as torch_functional\nimport efficientnet_pytorch\nimport torch.optim.lr_scheduler as lr_scheduler\n\nfrom sklearn.model_selection import StratifiedKFold\nfrom tqdm import tqdm","a4f94338":"train_df = pd.read_csv(\"..\/input\/petfinder-pawpularity-score\/train.csv\")\ntrain_df\n# train_df_extr=pd.read_csv('..\/input\/petfinder-adoption-prediction\/train\/train.csv')\n# train_df_extr['Pawpularity']=train_df_extr['AdoptionSpeed'].apply(lambda x: float(abs(x*25-5)))\n# train_df_extr","8aee621f":"submission = pd.read_csv(\"..\/input\/petfinder-pawpularity-score\/sample_submission.csv\")\nsubmission.head()\nsubmission.Pawpularity.values\/100\n","1c6e69dc":"def set_seed(seed):\n    random.seed(seed)\n    os.environ[\"PYTHONHASHSEED\"] = str(seed)\n    np.random.seed(seed)\n    torch.manual_seed(seed)\n    if torch.cuda.is_available():\n        torch.cuda.manual_seed_all(seed)\n        torch.backends.cudnn.deterministic = True\n\n\nset_seed(42)","ba2b043b":"df = pd.read_csv(\"..\/input\/petfinder-pawpularity-score\/train.csv\")\n","d77043f7":"import albumentations\n\ntransform = albumentations.Compose(\n     [   \n       \n        albumentations.HueSaturationValue(\n            hue_shift_limit=0.2, sat_shift_limit=0.2, val_shift_limit=0.2, p=0.5\n        ),\n        albumentations.RandomBrightnessContrast(\n            brightness_limit=(-0.1, 0.1), contrast_limit=(-0.1, 0.1), p=0.5\n        ),\n        albumentations.Normalize(\n            mean=[0.485, 0.456, 0.406],\n            std=[0.229, 0.224, 0.225],\n            max_pixel_value=255.0,\n            p=1.0,\n        ),\n    ],\n    p=1.0,\n)\n\nvalid_aug = albumentations.Compose(\n    [\n        albumentations.Normalize(\n            mean=[0.485, 0.456, 0.406],\n            std=[0.229, 0.224, 0.225],\n            max_pixel_value=255.0,\n            p=1.0,\n        ),\n    ],)","7523f141":"class DataRetriever(torch_data.Dataset):\n    def __init__(self,ids,targets,train=False,valid=False):\n        self.id=ids\n        self.targets=targets\n        self.train=train\n        self.valid=valid\n        self.alpha=0.2\n        \n    def __len__(self):\n        return len(self.id)\n    def __getitem__(self,index):\n        if self.train or self.valid:\n            img_path='..\/input\/petfinder-pawpularity-score\/train\/'+str(self.id[index])+'.jpg'\n        else:\n            img_path='..\/input\/petfinder-pawpularity-score\/test\/'+str(self.id[index])+'.jpg'\n            \n        \n        if self.train or self.valid:\n            labels=torch.tensor(self.targets[index],dtype=torch.float)\n        img=cv2.imread(img_path)\n        \n        img=cv2.cvtColor(img, cv2.COLOR_BGR2RGB)\n        img=cv2.resize(img,(224,224))\n        \n        if self.train:\n            img=transform(image=img)['image']\n#             if index%2!=0:\n#                 lam=np.random.beta(self.alpha,self.alpha)\n#                 mixup_index=np.random.randint(0,index)\n#                 labels2=torch.tensor(self.targets[mixup_index],dtype=torch.float)\n#                 img_path='..\/input\/petfinder-pawpularity-score\/train\/'+str(self.id[mixup_index])+'.jpg'\n#                 img2=cv2.imread(img_path)\n#                 img2=cv2.cvtColor(img, cv2.COLOR_BGR2RGB)\n#                 img2=cv2.resize(img,(224,224))\n#                 img=lam*img+(1-lam)*img2\n#                 labels=lam*labels+(1-lam)*labels2\n        else:\n            img=valid_aug(image=img)['image']\n      \n        img=np.transpose(img,(2,0,1)).astype(np.float32)\n        if self.train or self.valid:\n            return {\n            'X':torch.tensor(img,dtype=torch.float),   \n            'y':labels\n          }\n        return{'X':torch.tensor(img,dtype=torch.float)} ","4e0870c3":"class RMSELoss(nn.Module):\n    def __init__(self):\n        super(RMSELoss,self).__init__()\n        \n    def forward(self,x,y):\n        criterion=nn.MSELoss()\n        loss=torch.sqrt(criterion(x,y))\n        return loss\n    ","bd547d32":"def train(model,criterion,metric,scheduler,optimizer,epochs,train_loader,valid_loader):\n    \n    scaler=amp.GradScaler()\n    for epoch in range(epochs):\n        total_loss=[]\n        total_rmse=[]\n        total_val_rmse=[]\n        model.train()\n        loop=tqdm(enumerate(train_loader),total=len(train_loader))\n        for i,batch in loop:\n            img=batch['X'].to('cuda')\n            y=batch['y'].to('cuda')\n            y=y.view(-1,1)\n            optimizer.zero_grad()\n            with amp.autocast():\n                output=model(img)\n                loss=criterion(output,y)\n            scaler.scale(loss).backward()\n            scaler.step(optimizer)\n            scaler.update()\n            scheduler.step()\n#             output=model(img)\n#             loss=criterion(output,y)\n#             loss.backward()\n#             optimizer.step()\n            rmse=metric(torch.sigmoid(output)*100,y*100)\n            \n            total_loss.append(loss.item())\n            total_rmse.append(rmse.detach().cpu().numpy())\n            train_rmse=sum(total_rmse)\/len(total_rmse)\n            loop.set_postfix(Train_Rmse_loss=train_rmse)\n        model.eval()\n        with torch.no_grad():\n            loop=tqdm(enumerate(valid_loader),total=len(valid_loader)) \n            for i,batch in loop:\n                img=batch['X'].to('cuda')\n                y=batch['y'].to('cuda')\n                y=y.view(-1,1)\n                output=model(img)\n               \n                rmse=metric(torch.sigmoid(output)*100,y*100)\n                total_val_rmse.append(rmse.detach().cpu().numpy())\n                val_rmse=sum(total_val_rmse)\/len(total_val_rmse)\n                loop.set_postfix(Valid_Rmse_loss=val_rmse)\n        \n       \n        #scheduler.step()\n        print(len(total_rmse))\n        train_rmse=sum(total_rmse)\/len(total_rmse)\n        val_rmse=sum(total_val_rmse)\/len(total_val_rmse)\n        print(f\"Epoch-> {epoch}  Train Rmse->>{train_rmse}   Val_rmse-->>{val_rmse} \")\n        \n   ","ef4a71a0":"class PawpularityModel(nn.Module):\n    def __init__(self):\n        super().__init__()\n        self.model = timm.create_model('swin_large_patch4_window7_224_in22k', pretrained=False, in_chans=3)\n        #self.model.classifier = nn.Linear(self.model.classifier.in_features, 128)\n        self.dropout = nn.Dropout(0.1)\n        self.dense1 = nn.Linear(128, 1)\n        #self.dense2 = nn.Linear(64, 1)\n        self.model.head=nn.Linear(self.model.head.in_features,128)\n        #self.model.fc = nn.Linear(self.model.fc.in_features, 128)\n        \n    def forward(self,x):\n        output=self.model(x)\n        #print(output.shape)\n        output=self.dropout(output)\n        #print(output.shape)\n        #output=torch.cat([output,dense_features],dim=1)\n        output=self.dense1(output)\n        #print(output.shape)\n        #output=self.dense2(output)\n       # output=torch.sigmoid(output)       \n        return output\n    \n","578494c8":"def get_dataloaders(train_idx,val_idx):\n\n\n    valid_data_retriever=DataRetriever(df.Id.values[val_idx],\n                               df.Pawpularity.values[val_idx]\/100,\n                                           train=False,valid=True)\n    valid_loader = torch_data.DataLoader(\n        valid_data_retriever, \n        batch_size=32,\n        shuffle=False,\n        num_workers=8,\n        )\n    \n    train_data_retriever=DataRetriever(df.Id.values[train_idx],\n                               df.Pawpularity.values[train_idx]\/100,\n                                           train=True,valid=False)\n    \n    train_loader = torch_data.DataLoader(\n        train_data_retriever,\n        batch_size=32,\n        shuffle=True,\n        num_workers=8,\n        )\n    return train_loader,valid_loader\n    ","bcdf9f3b":"def get_settings():\n    device='cuda'\n   # criterion=nn.BCELoss()\n    criterion =nn.BCEWithLogitsLoss()\n    #criterion=LabelSmoothingCrossEntropy()\n    #criterion = FocalLoss()\n    metric=RMSELoss()\n    model=PawpularityModel()\n    model.to(device)\n    optimizer =torch.optim.AdamW(model.parameters(), lr=2e-6,\n                                  amsgrad=False)\n#     scheduler = lr_scheduler.CosineAnnealingWarmRestarts(\n#             optimizer,\n#             T_0=5,\n#             eta_min=1e-7,\n#             last_epoch=-1\n#         )\n    scheduler=torch.optim.lr_scheduler.CosineAnnealingWarmRestarts(\n            optimizer, T_0=10, T_mult=1, eta_min=1e-4, last_epoch=-1\n        )\n    #scheduler=torch.optim.lr_scheduler.CyclicLR(optimizer, base_lr=1e-6, max_lr=1e-5)\n    return criterion,metric,model,optimizer,scheduler","4f132303":"# df['fold']=-1\n# num_bins=int(np.floor(1+np.log2(len(df))))\n# df.loc[:,'bins']=pd.cut(df['Pawpularity'],bins=num_bins,labels=False)\n# kf=StratifiedKFold(n_splits=10,shuffle=True,random_state=42)\n# epochs=2\n# for fold,(train_idx,val_idx) in enumerate(kf.split(df.index,df.Pawpularity.values)):\n#     print(f\"Fold-->>{fold}\")\n#     criterion,metric,model,optimizer,scheduler= get_settings()\n#     train_loader,valid_loader= get_dataloaders(train_idx,val_idx)\n#     train(model,criterion,metric,scheduler,optimizer,epochs,train_loader,valid_loader)\n#     torch.save(model.state_dict(),f\"model_fold={fold}.pth\")\n#     print('saved')","0ad2ed48":"submission = pd.read_csv(\"..\/input\/petfinder-pawpularity-score\/sample_submission.csv\")\nmodel=PawpularityModel()\ntest=pd.read_csv(\"..\/input\/petfinder-pawpularity-score\/test.csv\")\nmodel.to('cuda')\ndevice='cuda'\ntest_data_retriever = DataRetriever(\n    submission.Id.values,None,train=False,\n    valid=False\n)\n\ntest_loader = torch_data.DataLoader(\n    test_data_retriever,\n    batch_size=64,\n    shuffle=False,\n    num_workers=8,\n)","501b8be7":"ids = []\npaths=[]\npred=[]\nfor path in os.listdir('..\/input\/pet-paw-data'):\n    paths.append('..\/input\/pet-paw-data\/'+path)\n\nfor path in paths:\n    y_pred = []\n    model.load_state_dict(torch.load(path))\n    for e, batch in enumerate(test_loader):\n        print(f\"{e}\/{len(test_loader)}\", end=\"\\r\")\n        with torch.no_grad():\n            tmp_pred = np.zeros((batch[\"X\"].shape[0], ))\n\n            tmp_pred=model(batch['X'].to(device)).cpu().numpy().squeeze()\n            #print(tmp_pred)\n            tmp_pred=1\/(1+np.exp(-tmp_pred))\n           # print(tmp_pred)\n            \n            y_pred.extend(tmp_pred)\n    y_pred=[x*100 for x in y_pred]\n    pred.append(y_pred)\n    \npred=np.mean(np.column_stack(pred), axis=1)    ","d38ca2ce":"submission = pd.DataFrame({\"Id\": submission.Id.values, \"Pawpularity\": pred})\nsubmission.to_csv(\"submission.csv\", index=False)","2d6767b1":"submission.head()","3fa4267e":"# Dataset ","3c3fd5c4":"# Submission","72e138f0":"# Training","67251c0d":"# Model","ced5c9ca":"# Set Seed Config","5944b616":"# Transformations","0536621e":"# Practice Dataset"}}