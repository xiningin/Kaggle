{"cell_type":{"1e8d605d":"code","d22f1112":"code","2e556d62":"code","b2f89195":"code","230a9224":"code","fe72220c":"code","786108f5":"code","3f894eab":"code","f74ea8f0":"code","92b26d61":"code","563bf847":"code","ea4be61f":"code","a37b3c2f":"code","70e071dc":"code","22b18411":"code","ce1db83a":"code","84071c3f":"code","56b3426f":"code","2396faf0":"code","7750f386":"code","c83b55d0":"code","47ecc21b":"code","6183666e":"code","5b65d92d":"code","beda923f":"code","8b11094a":"code","c9280723":"code","e9c75023":"code","2ec6d008":"code","045c7f2f":"code","6a6c3220":"code","2b46a9df":"code","558f77a4":"code","a7649956":"code","6eaa8c47":"code","741410f6":"code","401b7fbd":"code","b0dba9ee":"code","3e6f8909":"code","761c30d0":"code","1832ff95":"code","0eb57e39":"code","c80e636a":"code","8c017f5f":"code","102a3a38":"code","1d158dfe":"code","fd3109a1":"code","aeb4df90":"code","faebdd32":"code","2482b37c":"code","d4ea26d6":"code","2d92ed2b":"code","859a54fc":"code","ff4f695c":"code","877e56bb":"code","5d58571e":"code","e2e64051":"code","1bfd9e3d":"code","162d990f":"code","aef91f4f":"code","2a393e7b":"code","f6eed70a":"code","f3ecd78b":"code","14c92409":"code","153b45c2":"code","bbb70cd2":"code","e5eb5a6d":"markdown","400b934c":"markdown","1f1d6700":"markdown","3f3b8bb9":"markdown","fb64d565":"markdown","3e97e215":"markdown","5c985a8c":"markdown","1d2f6a4f":"markdown"},"source":{"1e8d605d":"%reload_ext autoreload\n%autoreload 2\n%matplotlib inline","d22f1112":"from fastai.vision import *\nfrom fastai.callbacks.hooks import *\nfrom fastai.utils.mem import *","2e556d62":"# usage see camvid tiramisu\n# path = Path('.\/data\/camvid-small')\npath = Path('\/kaggle\/input\/repository\/alexgkendall-SegNet-Tutorial-bb68b64\/CamVid')","b2f89195":"path_lbl = path\/'valannot'\npath_img = path\/'val'","230a9224":"fnames = get_image_files(path_img)\nfnames[:3]","fe72220c":"lbl_names = get_image_files(path_lbl)\nlbl_names[:3]","786108f5":"img_f = fnames[0]\nimg = open_image(img_f)\nimg.show(figsize=(5,5))","3f894eab":"# get_y_fn = lambda x: path_lbl\/f'{x.stem}_P{x.suffix}'\ndef get_y_fn(x): return Path(str(x.parent)+'annot')\/x.name","f74ea8f0":"mask = open_mask(get_y_fn(img_f))\nmask.show(figsize=(5,5), alpha=1)","92b26d61":"src_size = np.array(mask.shape[1:])\nsrc_size,mask.data","563bf847":"# def get_y_fn(x): return Path(str(x.parent)+'annot')\/x.name\n\ncodes = array(['Sky', 'Building', 'Pole', 'Road', 'Sidewalk', 'Tree',\n    'Sign', 'Fence', 'Car', 'Pedestrian', 'Cyclist', 'Void'])","ea4be61f":"size = src_size\/\/2\n\nfree = gpu_mem_get_free_no_cache()\n# the max size of bs depends on the available GPU RAM\nif free > 8200: bs=8\nelse:           bs=4\nprint(f\"using bs={bs}, have {free}MB of GPU RAM free\")","a37b3c2f":"size","70e071dc":"src = (SegmentationItemList.from_folder(path)\n       .split_by_folder(valid='val')\n       .label_from_func(get_y_fn, classes=codes))\n\n# bs=8\ndata = (src.transform(get_transforms(),size=size, tfm_y=True)\n        .databunch(bs=bs, num_workers=0)\n        .normalize(imagenet_stats))","22b18411":"data","ce1db83a":"data.c","84071c3f":"data.show_batch(2, figsize=(10,7))","56b3426f":"data.show_batch(2, figsize=(10,7), ds_type=DatasetType.Valid)","2396faf0":"# path = untar_data(URLs.CAMVID)\n# path.ls()","7750f386":"# path_lbl = path\/'labels'\n# path_img = path\/'images'","c83b55d0":"# fnames = get_image_files(path_img)\n# fnames[:3]","47ecc21b":"# lbl_names = get_image_files(path_lbl)\n# lbl_names[:3]","6183666e":"# img_f = fnames[0]\n# img = open_image(img_f)\n# img.show(figsize=(5,5))","5b65d92d":"# get_y_fn = lambda x: path_lbl\/f'{x.stem}_P{x.suffix}'","beda923f":"# mask = open_mask(get_y_fn(img_f))\n# mask.show(figsize=(5,5), alpha=1)","8b11094a":"# src_size = np.array(mask.shape[1:])\n# src_size,mask.data","c9280723":"# codes = np.loadtxt(path\/'codes.txt', dtype=str); codes","e9c75023":"# codes.size","2ec6d008":"# size = src_size\/\/2\n\n# free = gpu_mem_get_free_no_cache()\n# # the max size of bs depends on the available GPU RAM\n# if free > 8200: bs=8\n# else:           bs=4\n# print(f\"using bs={bs}, have {free}MB of GPU RAM free\")","045c7f2f":"# src = (SegmentationItemList.from_folder(path_img)\n#        .split_by_fname_file('..\/valid.txt')\n#        .label_from_func(get_y_fn, classes=codes))","6a6c3220":"# data = (src.transform(get_transforms(), size=size, tfm_y=True)\n#         .databunch(bs=bs,num_workers=0) # remember to set it 0\n#         .normalize(imagenet_stats))","2b46a9df":"# data.show_batch(2, figsize=(10,7))","558f77a4":"# data.show_batch(2, figsize=(10,7), ds_type=DatasetType.Valid)","a7649956":"# data; data.c","6eaa8c47":"name2id = {v:k for k,v in enumerate(codes)}\nvoid_code = name2id['Void']\n\ndef acc_camvid(input, target):\n    target = target.squeeze(1)\n    mask = target != void_code\n    return (input.argmax(dim=1)[mask]==target[mask]).float().mean()","741410f6":"metrics=acc_camvid\n# metrics=accuracy","401b7fbd":"wd=1e-2","b0dba9ee":"learn = unet_learner(data, models.resnet34, metrics=metrics, wd=wd, model_dir='\/kaggle\/working\/')","3e6f8909":"lr_find(learn)\nlearn.recorder.plot()","761c30d0":"lr=3e-3","1832ff95":"learn.fit_one_cycle(1, slice(lr), pct_start=0.9)","0eb57e39":"learn.save('stage-1')","c80e636a":"del learn\ngc.collect()\n# learn.destroy() # \u91ca\u653e\u5185\u5bb9\uff0c \u4f46\u662f1.0.45\u7248\u672c\u91cc\u6ca1\u6709\u8fd9\u4e2amethod\n# https:\/\/www.kaggle.com\/danielliao\/fastai-tutorial-13-dl-on-a-shoestring","8c017f5f":"learn = unet_learner(data, models.resnet34, metrics=metrics, wd=wd, \n                     model_dir='\/kaggle\/working\/')\nlearn.load('stage-1',with_opt=False);","102a3a38":"learn.show_results(rows=3, figsize=(8,9))","1d158dfe":"learn.unfreeze()","fd3109a1":"lrs = slice(lr\/400,lr\/4)","aeb4df90":"learn.fit_one_cycle(1, lrs, pct_start=0.8)","faebdd32":"learn.save('stage-2');","2482b37c":"#learn.destroy() # uncomment once 1.0.46 is out\n\nsize = src_size\n\nfree = gpu_mem_get_free_no_cache()\n# the max size of bs depends on the available GPU RAM\nif free > 8200: bs=3\nelse:           bs=1\nprint(f\"using bs={bs}, have {free}MB of GPU RAM free\")","d4ea26d6":"size","2d92ed2b":"del learn\ngc.collect()\n# learn.destroy() # \u91ca\u653e\u5185\u5bb9\uff0c \u4f46\u662f1.0.45\u7248\u672c\u91cc\u6ca1\u6709\u8fd9\u4e2amethod\n# https:\/\/www.kaggle.com\/danielliao\/fastai-tutorial-13-dl-on-a-shoestring\n# in fact, these two lines above don't release any ram or disk based on observation!!!\n# but remove saved models can release both RAM and Disk","859a54fc":"data = (src.transform(get_transforms(), size=size, tfm_y=True)\n        .databunch(bs=2, num_workers=0) # bs = 3 takes too much mem\n        .normalize(imagenet_stats))","ff4f695c":"learn = unet_learner(data, models.resnet34, metrics=metrics, wd=wd, model_dir='\/kaggle\/working')","877e56bb":"learn.load('stage-2');","5d58571e":"lr_find(learn)\nlearn.recorder.plot()","e2e64051":"lr=1e-3","1bfd9e3d":"learn.fit_one_cycle(1, slice(lr), pct_start=0.8) # 10","162d990f":"learn.save('stage-1-big')","aef91f4f":"learn.load('stage-1-big');","2a393e7b":"learn.unfreeze()","f6eed70a":"lrs = slice(1e-6,lr\/10)","f3ecd78b":"learn.fit_one_cycle(1, lrs) # 10","14c92409":"learn.save('stage-2-big')","153b45c2":"learn.load('stage-2-big');","bbb70cd2":"learn.show_results(rows=3, figsize=(10,10))","e5eb5a6d":"## fin","400b934c":"## Camvid \u5168\u6570\u636e\u96c6\n\u54ea\u6015\u53ea\u8bad\u7ec3\u4e00\u6b21\uff0c\u8017\u65f6\u592a\u4e45","1f1d6700":"## \u5c0f\u6570\u636e\u96c6 \n\u6570\u636e\u91cf\u66f4\u5c11\uff0c\u7c7b\u522b\u66f4\u5c11\uff0c\u8bad\u7ec3\u66f4\u5feb","3f3b8bb9":"<h1>Table of Contents<span class=\"tocSkip\"><\/span><\/h1>\n<div class=\"toc\"><ul class=\"toc-item\"><li><span><a href=\"#Image-segmentation-with-CamVid\" data-toc-modified-id=\"Image-segmentation-with-CamVid-1\"><span class=\"toc-item-num\">1&nbsp;&nbsp;<\/span>Image segmentation with CamVid<\/a><\/span><\/li><li><span><a href=\"#Subset-classes\" data-toc-modified-id=\"Subset-classes-2\"><span class=\"toc-item-num\">2&nbsp;&nbsp;<\/span>Subset classes<\/a><\/span><\/li><li><span><a href=\"#Data\" data-toc-modified-id=\"Data-3\"><span class=\"toc-item-num\">3&nbsp;&nbsp;<\/span>Data<\/a><\/span><\/li><li><span><a href=\"#Datasets\" data-toc-modified-id=\"Datasets-4\"><span class=\"toc-item-num\">4&nbsp;&nbsp;<\/span>Datasets<\/a><\/span><\/li><li><span><a href=\"#Model\" data-toc-modified-id=\"Model-5\"><span class=\"toc-item-num\">5&nbsp;&nbsp;<\/span>Model<\/a><\/span><\/li><li><span><a href=\"#Go-big\" data-toc-modified-id=\"Go-big-6\"><span class=\"toc-item-num\">6&nbsp;&nbsp;<\/span>Go big<\/a><\/span><\/li><li><span><a href=\"#fin\" data-toc-modified-id=\"fin-7\"><span class=\"toc-item-num\">7&nbsp;&nbsp;<\/span>fin<\/a><\/span><\/li><\/ul><\/div>","fb64d565":"You may have to restart your kernel and come back to this stage if you run out of memory, and may also need to decrease `bs`.","3e97e215":"## Go big","5c985a8c":"## Model","1d2f6a4f":"## Camvid\u7684\u56fe\u7247\u9694\u79bb Image segmentation"}}