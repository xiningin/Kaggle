{"cell_type":{"214030a5":"code","28e6642a":"code","bcf150f7":"code","8dcda8df":"code","f4ffe91d":"code","89a0de07":"code","137d78c6":"code","a33ea0ef":"code","73209733":"code","173ab378":"code","a265d19e":"code","e4922dc1":"code","f2ec1598":"code","951cdbdb":"markdown","e05f17ec":"markdown","57692f8a":"markdown","b5a31012":"markdown","9d4eb6f6":"markdown","0247ff6f":"markdown","6eb236ea":"markdown","7914fc72":"markdown"},"source":{"214030a5":"import folium\nimport warnings\nimport pandas as pd\nimport geopandas as gpd\nimport geopy.distance\nfrom shapely.geometry import Point\nimport numpy as np\nimport os\nfrom datetime import datetime, timedelta\nfrom tqdm import tqdm_notebook as tqdm\n\nwarnings.filterwarnings(action='ignore')","28e6642a":"df_meta = pd.read_csv('..\/input\/birdclef-2021\/train_metadata.csv',)\ndf_meta.head()","bcf150f7":"files = []\nfor dirname, _, filenames in os.walk('\/kaggle\/input\/birdclef-2021\/test_soundscapes'):\n    files += [os.path.join(dirname, filename) for filename in filenames]\nfiles","8dcda8df":"df_sites = pd.DataFrame()\n\nfor file in files[1:]:\n    with open(file, 'r') as f:\n        lines=f.readlines()\n        df_sites = df_sites.append({\"name\" : lines[0].strip(), \n                                    \"radius\" : 450, \n                                    \"latitude\" : float(lines[-2].split()[-1]), \n                                    \"longitude\" : float(lines[-1].split()[-1]),\n                                    \"alias\" : file.split(\"\/\")[-1].split(\"_\")[0]}, ignore_index=True)\n\ndf_sites","f4ffe91d":"m = folium.Map(location=[21.612581945168355, -79.0603262312263], tiles=\"cartodbpositron\", zoom_start=4)\n\nfor item in df_sites.iterrows():\n    folium.Circle(location=[item[1][\"latitude\"], item[1][\"longitude\"]], popup=item[1][\"alias\"], fill_color='#00CED1', radius=item[1][\"radius\"]*1000, weight=2, color=\"#000\").add_to(m)\n\nm","89a0de07":"df_dates = pd.read_csv(files[0])\ndf_dates[\"date\"] = pd.to_datetime(df_dates[\"date\"].astype(str), format=\"%Y%m%d\")\n\ndf_dates[\"month\"] = df_dates[\"date\"].apply(lambda x: x.month)\ndf_meta['month'] = df_meta['date'].apply(lambda x: x.split(\"-\")[1]).astype(int)\n\ndf_dates.head()","137d78c6":"site_params = dict([(site, []) for site in df_dates[\"site\"].unique()])\nfor row in df_dates.iterrows():\n    site_params[row[1][\"site\"]].append(row[1][\"month\"])\n\nfor site in site_params:\n    site_params[site] = {\"months\" : list(set(site_params[site]))}\n\nfor spatial in df_sites.values:\n    site_params[spatial[0]][\"latlon\"] = (spatial[1], spatial[2])\n    site_params[spatial[0]][\"R\"] = spatial[-1]\n    \nsite_params","a33ea0ef":"def right_place_time(lat, lon, date):\n    \"\"\"\n    Calculate if an observation was made within test site parameters (coordinates and time)\n    \"\"\"\n    check = False\n    for site, params in site_params.items():\n        # Check within site\n        check_site = (geopy.distance.distance(params[\"latlon\"], (lat, lon)).km < params[\"R\"]) and (date in params[\"months\"])\n        check = check or (check_site > 0)\n\n    return check\n\nright_place_time(42.3005, -72.5877, 0)","73209733":"# df_meta[\"right_place_time\"] = df_meta.apply(lambda r: right_place_time(r['latitude'], r['longitude'], r[\"month\"]), axis=1)\n\n# print(\"Percentage of records withing test sites at matching times of year: {:.2f}%\".format(100*len(df_meta[df_meta[\"right_place_time\"]])\/len(df_meta)))","173ab378":"# print(\"Of {} species {} were observed within sites at the same time of year\".format(df_meta[\"primary_label\"].nunique(), df_meta[df_meta[\"right_place_time\"]][\"primary_label\"].nunique()))","a265d19e":"from geopy.distance import geodesic\nBIRDS = sorted(list(set(df_meta.primary_label.values)))\nCOL = (5.57, -75.85)\nCOR = (10.12, -84.51)\nSNE = (38.49, -119.95)\nSSW = (42.47, -76.45)\n\ndf_meta[\"birds\"] = df_meta.primary_label + \", \" + df_meta.secondary_labels\ndf_meta[\"birds\"] = df_meta.birds.map(\n    lambda s: sorted(list(set(s.replace(\"[\", \"\")\n    .replace(\"]\", \"\")\n    .replace(\",\", \"\")\n    .replace(\"'\", \"\")\n    .split(\" \"))))\n)\ndf_birds = df_meta.birds.values\ndf_month = df_meta.date.map(lambda x: x[5:7]).values\ndf_latitude = df_meta.latitude.values\ndf_longitude = df_meta.longitude.values\n\nmonth_data = {b:{m: 0 for m in sorted(list(set(df_month)))} for b in sorted(set(BIRDS))}\nfor b, m in zip(df_birds, df_month):\n    for bi in b:\n        if bi != \"\":\n            if bi == \"rocpig1\":\n                bi = \"rocpig\"\n            month_data[bi][m] += 1\nmonth_df=pd.DataFrame(month_data).T.drop('00', axis=1)\nmonth_df.to_csv(\"month_mask.csv\", index=False)\n\nsite_data = {b:{\"COL\": 0, \"COR\": 0, \"SNE\": 0, \"SSW\": 0, \"other\": 0} for b in sorted(set(BIRDS))}\nfor b, lat, lon in tqdm(zip(df_birds, df_latitude, df_longitude), total=len(df_birds)):\n    lation = (lat, lon)\n    site = \"other\"\n    if geodesic(lation, COL).km < 450:\n        site = \"COL\"\n    elif geodesic(lation, COR).km < 450:\n        site = \"COR\"\n    elif geodesic(lation, SNE).km < 450:\n        site = \"SNE\"\n    elif geodesic(lation, SSW).km < 450:\n        site = \"SSW\"\n    for bi in b:\n        if bi != \"\":\n            if bi == \"rocpig1\":\n                bi = \"rocpig\"\n            site_data[bi][site] += 1\nsite_df = pd.DataFrame(site_data).T\nsite_df.to_csv(\"site_mask.csv\", index=False)","e4922dc1":"site_df.head()","f2ec1598":"month_df.head()","951cdbdb":"<a id=\"top\"><\/a>\n\n<div class=\"list-group\" id=\"list-tab\" role=\"tablist\">\n    \n<center><h2 class=\"list-group-item list-group-item-action active\" data-toggle=\"list\" style='background-color:#1E90FF; border:0; color:#FFF5EE' role=\"tab\" aria-controls=\"home\">Content<\/h2><\/center>\n    \nIn this notebook I look to explore which birds were at the right place and in the right time to have a chance of making into a test set recording. In the [competition notebook](https:\/\/www.kaggle.com\/stefankahl\/birdclef2021-exploring-the-data), Stefan Kahl points that all birds were likely to be observed at the test sites, but were they there at the right time? To answer this question, each site is assigned a circular region of 200 km in radius. If any of the birds were previously recorded in the same month as the test recordings on that site, the bird could potentially be present in test recordings.","e05f17ec":"Lets draw 400 kilometer regions around each point and consider this to be a site. If the bird has ever been recorded within a circle, it could have potentially been recorded in the test run.","57692f8a":"We will also need the description of test site parameters, such as location and date.","b5a31012":"month\u3068site\u3067\u4e8c\u7a2e\u985e\u306e\u9ce5\u306e\u751f\u606f\u6570\u3092\u30ab\u30a6\u30f3\u30c8\u3059\u308bdf\u3092\u4f5c\u308b ","9d4eb6f6":"First, lets get the metadata","0247ff6f":"<a id=\"1\"><\/a><center><h2 style='background-color:#1E90FF; border:0; color:#FFF5EE'>Summary<\/h2><\/center>\n\nWith 200 km regions around test site, 273 species have been recorded at the same time of year (same month). This narrows down a range of suspects :-) Hope you find this notebook helpful, and please consider upvoting it if you did.","6eb236ea":"TODO: 3\u6b21\u5143\u3067\u8868\u3059\uff1f\u758e\u306b\u306a\u308b\u306e\u3067\u30de\u30b9\u30af\u3068\u3057\u3066\u6a5f\u80fd\u3059\u308b\u304b\u602a\u3057\u3044\u3051\u3069\u3001\u6642\u671f\u306b\u3088\u3063\u3066\u79fb\u52d5\u3059\u308b\u9ce5\u306a\u3069\u3092\u30ad\u30e3\u30d7\u30c1\u30e3\u3067\u304d\u308b\u304b\u3082","7914fc72":"Next, lets retrieve all months, when the recording took place, in the test set. Together with location, lets check all species that were observed in the right place and in the right time."}}