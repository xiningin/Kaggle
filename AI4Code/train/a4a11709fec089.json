{"cell_type":{"032b5e3d":"code","33040bd3":"code","92d3b5a8":"code","e3ca1107":"code","8ddc3601":"code","5d944539":"code","5fa5ae5a":"code","2db7342e":"code","02ba2b63":"code","9df59190":"code","f364e474":"code","5151915e":"markdown","4a49dd9c":"markdown","823e43c1":"markdown","d6fd311e":"markdown","ef84398b":"markdown","25f9022a":"markdown"},"source":{"032b5e3d":"import os\n\nimport pydicom as dicom\nimport numpy as np\nimport pandas as pd\n\nimport matplotlib\nimport matplotlib.pyplot as plt\nimport cv2\n\nprint(\"default backend: \", matplotlib.get_backend())\nmatplotlib.use('Agg')","33040bd3":"# path\ndf = pd.read_csv(\"\/kaggle\/input\/siim-isic-melanoma-classification\/train.csv\")\ndf = df.sort_values(by=\"patient_id\").reset_index(drop=True)\n\ntest_df = pd.read_csv(\"\/kaggle\/input\/siim-isic-melanoma-classification\/test.csv\")\ntest_df = test_df.sort_values(by=\"patient_id\").reset_index(drop=True)\n\nTEST_IMG_PATH = \"\/kaggle\/input\/siim-isic-melanoma-classification\/test\/\"\nTRAIN_IMG_PATH = \"\/kaggle\/input\/siim-isic-melanoma-classification\/train\/\"\n\n# image resolution\nWIDTH = 500\nHEIGHT = 320\nN_CHANNELS = 3\n\n# framrate\nFRAMERATE = 2","92d3b5a8":"def plot(img_path, img_name, annotate,\n         w=WIDTH, h=HEIGHT, dpi=80):\n    \n    # data\n    ds = dicom.dcmread(img_path)\n    image = cv2.resize(ds.pixel_array, (w, h))\n    image = cv2.cvtColor(image, cv2.COLOR_BGR2RGB)\n\n    annotate = [str(key) + \": \" + str(value)+\"\\n\"\n                    for key, value in annotate.items()]\n\n    figsize = w \/ float(dpi), h \/ float(dpi)\n\n    # plot\n    fig = plt.figure(figsize=figsize)\n    ax = fig.add_axes([0, 0, 1, 1])\n  \n    ax.imshow(image, interpolation='nearest')\n    ax.axis('off')\n    \n    # annotate\n    ax.text(280, 75, \"\".join(annotate), \n            color=\"black\", weight=\"bold\",\n            fontsize=7,\n            bbox=dict(boxstyle=\"round\",\n                        facecolor='#BF02F6', \n                        alpha=0.3, \n                        edgecolor='black'\n                        )\n                )\n    # save\n    plt.savefig(img_name, bbox_inches='tight', \n                transparent=False, pad_inches=0.006, dpi=dpi)\n    \n    return plt.close()","e3ca1107":"%%time\n\ntrain_video_name = 'train_data.avi'\ntest_video_name = 'test_data.avi'\n\ndef make_video(df, data_path, \n               video_name, framerate=FRAMERATE,\n               width=WIDTH, height=HEIGHT):\n    \n    # Define the codec and create VideoWrite object\n    fourcc = cv2.VideoWriter_fourcc(*'XVID')\n    video = cv2.VideoWriter(video_name, fourcc, framerate, (width, height))\n\n    for i in range(len(df)):\n            \n        meta_data = df.iloc[i, :].to_dict()\n        img_path = data_path + meta_data[\"image_name\"] + \".dcm\"\n\n        img_name = \"skin.png\"\n\n        # create image file\n        plot(img_path, img_name, meta_data)\n        \n        # write as np array remove as image\n        video.write(cv2.imread(img_name))\n        os.remove(img_name)\n        \n\n    cv2.destroyAllWindows()\n    return video.release()\n\nmake_video(df, TRAIN_IMG_PATH, train_video_name)\n#make_video(test_df, TEST_IMG_PATH, test_video_name)","8ddc3601":"!pip install youtube_dl -qq ","5d944539":"# https:\/\/stackoverflow.com\/questions\/27473526\/download-only-audio-from-youtube-video-using-youtube-dl-in-python-script\nfrom __future__ import unicode_literals\nimport youtube_dl\n\n\nydl_opts = {\n    'format': 'bestaudio\/best',\n    'postprocessors': [{\n        'key': 'FFmpegExtractAudio',\n        'preferredcodec': 'mp3',\n        'preferredquality': '192',\n    }],\n}\nwith youtube_dl.YoutubeDL(ydl_opts) as ydl:\n    ydl.download(['https:\/\/www.youtube.com\/watch?v=DnCJBZVTiJ4']);","5fa5ae5a":"# convert from avi to mp4 \n!ffmpeg -i train_data.avi -strict -2 train_data.mp4\n\n# adding sound\n!ffmpeg  -stream_loop -1 -i \"Deus Ex - Human Revolution - Detroit Limb Clinic (1 Hour of Music & Ambience)-DnCJBZVTiJ4.mp3\" -c copy -v 0 -f nut - | ffmpeg -thread_queue_size 10K -i - -i train_data.mp4 -c copy -map 1:v -map 0:a -shortest -y train_data_with_sound.mp4\n              \n# piece of video\n#!ffmpeg -ss 00:00:00 -i stats_with_sound.mp4 -to 00:01:00 -c copy stats_clip.mp4   ","2db7342e":"# from num_images to timecode\ndef get_timecode(n_images, framerate=FRAMERATE):\n    seconds = n_images \/ framerate\n    return '{h:02d}:{m:02d}:{s:02d}' \\\n            .format(h=int(seconds\/3600),\n                    m=int(seconds\/60%60),\n                    s=int(seconds%60))\n\nunique_patients = np.unique(df[\"patient_id\"].values, \n                             return_index=True)\n\ntimecodes = [f\"{n} - {get_timecode(t)}\" for n, t \n                    in zip(unique_patients[0], unique_patients[1])]\n#timecodes[:10]\n\nwith open('timecodes.txt', 'w') as f:\n    f.write(f\"Timestamps:\\nPatient id    Time\\n\")\n    for item in timecodes:\n        f.write(f\"\\n\\n{item}\")        ","02ba2b63":"%%HTML\n<video width=\"800\" height=\"600\" controls>\n  <source src=\"train_data_with_sound.mp4\" type=\"video\/mp4\">\n<\/video>","9df59190":"!head -n 20 timecodes.txt","f364e474":"!cat timecodes.txt","5151915e":"plot and save np.array as image file with meta annotation","4a49dd9c":"Writing Video from images(np arrays)","823e43c1":"### [High resolution video](https:\/\/www.youtube.com\/watch?v=CZmCkOhjv14)","d6fd311e":"adding sound","ef84398b":"time codes","25f9022a":"### Full list of time codes\n"}}