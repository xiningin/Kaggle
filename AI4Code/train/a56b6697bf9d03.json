{"cell_type":{"28479538":"code","7420673f":"code","2ba25e78":"code","1c61d8c8":"code","3dc21870":"code","7d7246f3":"code","15febba8":"code","9b94df19":"markdown"},"source":{"28479538":"import os, re, pydicom\nimport numpy as np\nfrom scipy.ndimage import affine_transform\nimport matplotlib.pyplot as plt","7420673f":"data_directory = '..\/input\/rsna-miccai-brain-tumor-radiogenomic-classification\/'","2ba25e78":"def plot3d(img3d):\n    fig, ax = plt.subplots(1,3)\n    fig.set_figheight(10)\n    fig.set_figwidth(20)\n    \n    ax[0].imshow(img3d[:,:,img3d.shape[2]\/\/2])\n    ax[1].imshow(img3d[:,img3d.shape[1]\/\/2,:])\n    ax[2].imshow(img3d[img3d.shape[0]\/\/2,:,:])\n    plt.show()\n\ndef img3d_from_dicom(path):\n    files = sorted(os.listdir(path), key=lambda x: int(re.findall('\\\\d+', x)[0]))\n    deepth = len(os.listdir(path))\n    \n    for idx, f in enumerate(files):\n        dicom = pydicom.read_file(path + f)\n        data = dicom.pixel_array.astype(np.float32)\n           \n        if idx > 0:\n            img3d[:,:,idx] = data\n        else:            \n            img3d = np.zeros((data.shape[0], data.shape[1], deepth), dtype=np.float32)\n            img3d[:,:,0] = data\n        \n    return img3d - np.min(img3d)","1c61d8c8":"# Rotation vector (rot_v) is a three-dimensional vector \n# whose direction is the axis of rotation and \n# whose magnitude is the angle in radians.\n\ndef rotate_by_vector(img3d, rot_v):\n    \n    x, y, z = rot_v\n    angle = np.sqrt(x*x + y*y + z*z)\n    cos = np.cos(angle)\n    sin = np.sin(angle)\n    x, y, z = rot_v \/ angle\n\n    R = np.eye(4, dtype=np.float32)\n    R[0, 0] = cos + (1 - cos)*x*x\n    R[1, 1] = cos + (1 - cos)*y*y\n    R[2, 2] = cos + (1 - cos)*z*z\n    R[0, 1] = (1 - cos)*x*y - sin*z\n    R[0, 2] = (1 - cos)*x*z + sin*y    \n    R[1, 0] = (1 - cos)*x*y + sin*z\n    R[1, 2] = (1 - cos)*y*z - sin*x\n    R[2, 0] = (1 - cos)*x*z - sin*y\n    R[2, 1] = (1 - cos)*y*z + sin*x\n    \n    T1 = np.array(img3d.shape) \/ 2\n    T2 = np.matmul(R[:3,:3], T1)\n    R[:3, 3] = T1 - T2\n   \n    return affine_transform(img3d, R)","3dc21870":"patient = '00000'\npath = data_directory + '\/train\/' + patient + '\/FLAIR\/'\n\nimg3d  = img3d_from_dicom(path)[80:400, 110:410, 40:350]\nplot3d(img3d)","7d7246f3":"img3d_r = rotate_by_vector(img3d, np.radians([0, 10, 0]))\nplot3d(img3d_r)","15febba8":"img3d_r = rotate_by_vector(img3d, np.radians([-5, 10, -2]))\nplot3d(img3d_r)","9b94df19":"3d rotation is way to increase numer of 2d slices for training.\n\n**WARNING:** original 3d image should have approximately equal axes scales or new slices would be highly distorted."}}