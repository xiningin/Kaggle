{"cell_type":{"6c583deb":"code","eacad7e7":"code","d196e847":"code","2fba2010":"code","1393496f":"code","9e937000":"code","a032ccc9":"code","1747e2fa":"code","a1d22131":"code","c1aa62aa":"code","78f25c62":"code","2869b708":"code","0bffacf2":"code","ab949a63":"code","f39a1e0b":"code","bfc5dcbe":"code","a8762d70":"code","a55730dc":"code","693b838b":"code","c8676ff3":"code","87c5e432":"code","a055b1c3":"code","15f18def":"code","0d2b396a":"code","182bfe4d":"code","7fd0ecc7":"code","27254686":"code","5e5b2ec2":"code","d5e50317":"code","5fa451da":"code","3e5d2d70":"code","5fdcefad":"code","7174b935":"code","ad6b14d3":"code","880a5bae":"code","b0aa91f3":"code","29a59970":"markdown","3013e053":"markdown","378f91b6":"markdown","64846e37":"markdown","7fe673f6":"markdown","c86d72ed":"markdown","86d68787":"markdown","b268d9f6":"markdown","6663bc2f":"markdown","09c5b504":"markdown","4905925c":"markdown","dd226289":"markdown","9f50ff86":"markdown","c88c32b2":"markdown","5285ede8":"markdown","1900d6db":"markdown","8d7cae11":"markdown","6d3b266c":"markdown","92088464":"markdown","a01a3094":"markdown","59fae7ff":"markdown","3bf20375":"markdown","ec18daa9":"markdown"},"source":{"6c583deb":"# This Python 3 environment comes with many helpful analytics libraries installed\n# It is defined by the kaggle\/python Docker image: https:\/\/github.com\/kaggle\/docker-python\n# For example, here's several helpful packages to load\n!pip install chart_studio\nimport numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\nimport seaborn as sns\nimport matplotlib.pyplot as plt\n# import plotly.plotly as py\nimport chart_studio.plotly as py\nimport plotly.graph_objs as go\nfrom plotly.offline import iplot, init_notebook_mode\n\nimport cufflinks\ncufflinks.go_offline(connected=True)\ninit_notebook_mode(connected=True)\n\n\nsns.set()\nplt.rcParams[\"figure.figsize\"] = [8,12]\n\n\n# Input data files are available in the read-only \"..\/input\/\" directory\n# For example, running this (by clicking run or pressing Shift+Enter) will list all files under the input directory\n\nimport os\nfor dirname, _, filenames in os.walk('\/kaggle\/input'):\n    for filename in filenames:\n        print(os.path.join(dirname, filename))\n\n# You can write up to 5GB to the current directory (\/kaggle\/working\/) that gets preserved as output when you create a version using \"Save & Run All\" \n# You can also write temporary files to \/kaggle\/temp\/, but they won't be saved outside of the current session","eacad7e7":"df_train=pd.read_csv(r\"\/kaggle\/input\/osic-pulmonary-fibrosis-progression\/train.csv\")\ndf_test=pd.read_csv(\"\/kaggle\/input\/osic-pulmonary-fibrosis-progression\/test.csv\")\ndf_train.head(170)","d196e847":"df_test.head()","2fba2010":"print(\"The shape of our training dataset is:{}\".format(df_train.shape))\nprint(\"The shape of our testing dataset is:{}\".format(df_test.shape))","1393496f":"df_train.info()","9e937000":"df_test.info()","a032ccc9":"df_train.describe()","1747e2fa":"df_train['Patient'].nunique()","a1d22131":"df_unique = df_train.groupby([df_train.Patient,df_train.Age,df_train.Sex, df_train.SmokingStatus])['Patient'].count()\ndf_unique.index = df_unique.index.set_names(['Patient Id','Age','Sex','SmokingStatus'])\n\ndf_unique = df_unique.reset_index()\ndf_unique.rename(columns = {'Patient': 'Frequency'},inplace = True)\n\ndf_unique.head()","c1aa62aa":"df_unique['Frequency'].mean()","78f25c62":"print(df_unique['Sex'].value_counts())\npercent_sexwise=df_unique['Sex'].value_counts()\/len(df_unique['Sex'])\nprint(percent_sexwise)","2869b708":"fig, ax = plt.subplots(figsize=(20,8))\nsns.countplot(ax=ax, x=\"Sex\", data=df_unique, palette=\"bone\")","0bffacf2":"from matplotlib import colors\n\nfig, ax = plt.subplots(figsize=(20,8))\nN_points = 100000\nn_bins = 15\nN, bins, patches = plt.hist(df_unique['Age'], n_bins, alpha=0.5)\n\nfracs = N \/ N.max()\nnorm = colors.Normalize(fracs.min(), fracs.max())\nfor thisfrac, thispatch in zip(fracs, patches):\n    color = plt.cm.viridis(norm(thisfrac))\n    thispatch.set_facecolor(color)","ab949a63":"fig, ax = plt.subplots(figsize=(20,8))\ndf_train.groupby(['Age', 'Sex']).size().unstack().plot(kind='bar', stacked=True, ax=ax)","f39a1e0b":"fig, ax = plt.subplots(figsize=(20,8))\nsns.countplot(x=\"SmokingStatus\", data=df_unique, palette=\"magma\")","bfc5dcbe":"fig, ax = plt.subplots(figsize=(20,8))\ndf_train.groupby(['SmokingStatus', 'Sex']).size().unstack().plot(kind='bar', stacked=True, ax=ax)","a8762d70":"fig, ax = plt.subplots(figsize=(20,8))\n\nN_points = 100000\nn_bins = 15\nN, bins, patches = plt.hist(df_train['FVC'], n_bins, alpha=0.5)\n\nfracs = N \/ N.max()\nnorm = colors.Normalize(fracs.min(), fracs.max())\nfor thisfrac, thispatch in zip(fracs, patches):\n    color = plt.cm.inferno(norm(thisfrac))\n    thispatch.set_facecolor(color)\nprint(df_train['FVC'].min())\nprint(df_train['FVC'].max())\nprint(df_train['FVC'].mean())\nprint(df_train['FVC'].median())","a55730dc":"from scipy.stats import kurtosis, skew\n\n\nprint(\"The mean of FVC data is: {}\".format(df_train['FVC'].mean()))\nprint(\"The median of FVC data is: {}\".format(df_train['FVC'].median()))\nprint(\"The standard deviation of FVC data is: {}\".format(df_train['FVC'].std()))\n\nprint( 'excess kurtosis of normal distribution (should be 0): {}'.format( kurtosis(df_train['FVC']) ))\nprint( 'skewness of normal distribution (should be 0): {}'.format( skew(df_train['FVC']) ))","693b838b":"fig, ax = plt.subplots(figsize=(20,15))\nsns.boxplot(x=\"Sex\", y=\"FVC\",hue=\"SmokingStatus\", data=df_train, palette=\"spring\", ax=ax)","c8676ff3":"fig, ax = plt.subplots(figsize=(20,8))\ndf_weeks=df_train.groupby(['Weeks']).count()\ndf_weeks.head(20)\nsns.distplot(df_weeks, color='b')","87c5e432":"fig, ax = plt.subplots(figsize=(20,15))\n\nx=df_train['FVC']\ny=df_train['Percent']\n\ncolors = df_train['FVC']  # 0 to 15 point radii\n\nplt.scatter(x, y, c=colors, alpha=0.5)\nplt.show()","a055b1c3":"df_patient=df_train.groupby(['Patient'])\ndf_patient.head()","15f18def":"patient_df = df_train[df_train['Patient'] == \"ID00010637202177584971671\"]\nprint(patient_df)","0d2b396a":"import plotly.express as px\n\nfig = px.line(patient_df, x=\"Weeks\", y=\"FVC\", title='Patient FVC over the weeks')\nfig.show()","182bfe4d":"patient_df = df_train[df_train['Patient'] == \"ID00426637202313170790466\"]\nprint(patient_df)","7fd0ecc7":"import plotly.express as px\n\nfig = px.line(patient_df, x=\"Weeks\", y=\"FVC\", title='Patient FVC over the weeks')\nfig.show()","27254686":"patient_df = df_train[df_train['Patient'] == \"ID00082637202201836229724\"]\nprint(patient_df)","5e5b2ec2":"import plotly.express as px\n\nfig = px.line(patient_df, x=\"Weeks\", y=\"FVC\", title='Patient FVC over the weeks')\nfig.show()","d5e50317":"# common packages \nimport numpy as np \nimport os\nimport copy\nfrom math import *\nimport matplotlib.pyplot as plt\nfrom functools import reduce\n# reading in dicom files\nimport pydicom as dicom\nimport glob\n# skimage image processing packages\nfrom skimage import measure, morphology\nfrom skimage.morphology import ball, binary_closing\nfrom skimage.measure import label, regionprops\n# scipy linear algebra functions \nfrom scipy.linalg import norm\nimport scipy.ndimage\n# ipywidgets for some interactive plots\nfrom ipywidgets.widgets import * \nimport ipywidgets as widgets\n# plotly 3D interactive graphs \nimport plotly\nfrom plotly.graph_objs import *\nimport chart_studio.plotly as py\n# set plotly credentials here \n# this allows you to send results to your account plotly.tools.set_credentials_file(username=your_username, api_key=your_key)","5fa451da":"apply_resample = False","3e5d2d70":"def load_scan(path):\n    slices = [dicom.read_file(path + '\/' + s) for s in os.listdir(path)]\n    slices.sort(key = lambda x: float(x.ImagePositionPatient[2]))\n    try:\n        slice_thickness = np.abs(slices[0].ImagePositionPatient[2] - slices[1].ImagePositionPatient[2])\n    except:\n        slice_thickness = np.abs(slices[0].SliceLocation - slices[1].SliceLocation)\n        \n    for s in slices:\n        s.SliceThickness = slice_thickness\n        \n    return slices","5fdcefad":"def get_pixels_hu(slices):\n    image = np.stack([s.pixel_array for s in slices])\n    # Convert to int16 (from sometimes int16), \n    # should be possible as values should always be low enough (<32k)\n    image = image.astype(np.int16)\n\n    # Set outside-of-scan pixels to 0\n    # The intercept is usually -1024, so air is approximately 0\n    image[image == -2000] = 0\n    \n    # Convert to Hounsfield units (HU)\n    for slice_number in range(len(slices)):\n        \n        intercept = slices[slice_number].RescaleIntercept\n        slope = slices[slice_number].RescaleSlope\n        \n        if slope != 1:\n            image[slice_number] = slope * image[slice_number].astype(np.float64)\n            image[slice_number] = image[slice_number].astype(np.int16)\n            \n        image[slice_number] += np.int16(intercept)\n    \n    return np.array(image, dtype=np.int16)","7174b935":"def set_lungwin(img, hu=[-1200., 600.]):\n    lungwin = np.array(hu)\n    newimg = (img-lungwin[0]) \/ (lungwin[1]-lungwin[0])\n    newimg[newimg < 0] = 0\n    newimg[newimg > 1] = 1\n    newimg = (newimg * 255).astype('uint8')\n    return newimg","ad6b14d3":"scans = load_scan('\/kaggle\/input\/osic-pulmonary-fibrosis-progression\/train\/ID00007637202177411956430\/')\nscan_array = set_lungwin(get_pixels_hu(scans))","880a5bae":"from scipy.ndimage.interpolation import zoom\n\ndef resample(imgs, spacing, new_spacing):\n    new_shape = np.round(imgs.shape * spacing \/ new_spacing)\n    true_spacing = spacing * imgs.shape \/ new_shape\n    resize_factor = new_shape \/ imgs.shape\n    imgs = zoom(imgs, resize_factor, mode='nearest')\n    return imgs, true_spacing, new_shape\n\nspacing_z = (scans[-1].ImagePositionPatient[2] - scans[0].ImagePositionPatient[2]) \/ len(scans)\n\nif apply_resample:\n    scan_array_resample = resample(scan_array, np.array(np.array([spacing_z, *scans[0].PixelSpacing])), np.array([1.,1.,1.]))[0]","b0aa91f3":"import imageio\nfrom IPython.display import Image\n\nimageio.mimsave(\"\/tmp\/gif.gif\", scan_array, duration=0.0001)\nImage(filename=\"\/tmp\/gif.gif\", format='png')","29a59970":"It was obvious and it is evident that FVC and Percent share linear relationship so in our analysis further, we need not use both of these variables. \n\n## Data distribution of few individuals\n\nWe will see data distribution of few individual patients to see how the pattern of FVC over the weeks. ","3013e053":"Citing this [research paper](https:\/\/www.jstage.jst.go.jp\/article\/jpts\/24\/1\/24_1_5\/_pdf#:~:text=It%20was%20found%20that%20the,lung%20capacity%20in%20females%20than), women have 20-25% lower capacity than men, owing to their smaller lungs. \n\nHowever, I have one concern about the data shown above. As seen from the boxplot, men and women who currently smoke have higher FVC than ex-smokers and non-smokers which is contradictory to this [research paper](https:\/\/www.ncbi.nlm.nih.gov\/pmc\/articles\/PMC3944281\/#:~:text=They%20showed%20that%20smoking%20decreased,airway%20obstruction%20and%20small%20airway) which states that:\n\n**Some previous studies have demonstrated the effect of smoking on the pulmonary function of adults8,9,10). They showed that smoking decreased pulmonary function including forced vital capacity (FVC), forced expiratory volume in one second (FEV1), FEV1\/FVC, and forced expiratory flow at 25\u201375% (FEF25\u201375%)9). Cigarette smoking causes deficits in both FEV1\/FVC and FEF25\u201375 which indicate airway obstruction and small airway disease in adult smokers.**\n\nThese works suggest otherwise, which should be a cause of concern. I will read more and try to find the caauses, etc behind this. \n\n## Data distribution by Weeks \n\nThis will give us an information on weekly visits by patients:","378f91b6":"Let us have a look at the shape our training and testing dataset: ","64846e37":"Both the train and test dataset contain no missing values. Let us look at other statistical parameters of our training dataset, which is our quite important for us. ","7fe673f6":"Let us how many unique values we have in our dataset:","c86d72ed":"The detrioration is quite steep in this case. \n\nWe have seen the tabular dataset till now, it is time to explore the DICOM dataset. I tried to be very elaborate in tabular data, I will also try the same in the DICOM data.","86d68787":"# DICOM \n\n**DICOM\u00ae \u2014 Digital Imaging and Communications in Medicine** \u2014 is the international standard for medical images and related information. It defines the formats for medical images that can be exchanged with the data and quality necessary for clinical use.\n\nDICOM\u00ae is implemented in almost every radiology, cardiology imaging, and radiotherapy device (X-ray, CT, MRI, ultrasound, etc.), and increasingly in devices in other medical domains such as ophthalmology and dentistry. With hundreds of thousands of medical imaging devices in use, DICOM\u00ae is one of the most widely deployed healthcare messaging Standards in the world.\n\n### What is the data related to DICOM?\n\nA DICOM data object consists of a number of attributes, including items such as name, ID, etc., and also one special attribute containing the image pixel data. A single DICOM object can have only one attribute containing pixel data. For many modalities, this corresponds to a single image. However, the attribute may contain multiple \"frames\", allowing storage of cine loops or other multi-frame data.\n\nLet us start by importing all the dependencies:","b268d9f6":"The deterioration of FVC in patients who have never smoked have less steep fall in FVC as compared to the patient seen above who was an ex-smoker. Let us look at one patient who currently smokes: \n\n## Patient 3 with id ID00082637202201836229724","6663bc2f":"So, most of the people have had smoking history before they developed symptoms. They could have dropped smoking after the symptoms perhaps, but it is very much evident that people with a smoking history have greater chances of contracting pulmonary fibriosis. One more thing could be the bias in smoking status with a bias towards the ex-smokers. \n\nWe will try to find that out!\n\n## Data distribution by Smoking Status according to Sex (uniques values)","09c5b504":"* So, there are 7 columns in our training dataset:\n\n1. **Patient id:** Will be useful for us to follow the week-by-week status update of an individual. As mentioned in the problem statement, patients have been followed on a week-by-week basis, so there could be a lot of repeatitive values according to the weekly update. We will also attempt to find unique ids in the column so that we know how many actual patients are we dealing with, in the data.\n\n2. **Weeks:** This denotes the week's number.\n\n3. **FVC:** This represents the total amount of air exhaled during the FEV test. Forced expiratory volume and forced vital capacity are lung function tests that are measured during spirometry.\n\n4. **Percent:** It is the computed field which approximates the patient's FVC as a percent of the typical FVC for a person of similar characteristics\n\n5. **Age** \n\n6. **Sex**\n\n7. **Smoking status:** This could be an important parameter in determining whether smoking status is relevant to the FVC or not. ","4905925c":"Most of the patients develop the symptoms of pulmonary fibrosis between 65 - 75 years of age. People start developing symptoms around 50 years of age and continue till 80 years of age. People below that age and above that age have lesser risk of developing symptoms. \n\n## Data distribution by Age according to Sex (uniques values)","dd226289":"Now it is time to see if our dataset has any missing value, we will check for both training and testing dataset:","9f50ff86":"For a person with Pulmonary fibrosis, it is expected that the capacity of lungs will deteriorate with time. Will analyse more in the next versions.\n\n## Patient 2 with id ID00426637202313170790466","c88c32b2":"Let us find out the average appointment a patient takes to get his FVC measured:","5285ede8":"## Data distribution by FVC\n\n### Before moving further, let us understand more about FVC:\n\n![](http:\/\/)![](https:\/\/slideplayer.com\/slide\/10537676\/36\/images\/8\/Pulmonary+Fibrosis+Restrictive+Diseases+Pulmonary+Function+Tests.jpg)\n\n\n**Forced vital capacity (FVC)** is the amount of air that can be forcibly exhaled from your lungs after taking the deepest breath possible, as measured by spirometry. This test may help distinguish obstructive lung diseases, such as asthma and COPD, from restrictive lung diseases, such as pulmonary fibrosis and sarcoidosis.\n\nFVC can also help doctors assess the progression of lung disease and evaluate the effectiveness of treatment. An abnormal FVC value may be chronic, but sometimes the problem is reversible and the FVC can be corrected.\n\n### Interpreting Results\n\nYour total FVC volume can be compared with the standard FVC for your age, sex, height, and weight. Your FVC can also be compared with your own previous FVC values, if applicable, to determine whether your pulmonary condition is progressing or if your lung function is improving under treatment. **FVC also may be expressed as a percentage of the predicted FVC.** This is expressed as percent in our dataset. \n\n\nForced vital capacity will be reported in two ways:\n\n1. As an absolute value, reported as a number in liters (L)\n2. On a linear graph to chart the dynamics of your exhalation\n\n\nThe normal FVC range for an adult is between 3.0 and 5.0 L. This depends on a lot of factors like genetics, height, body weight and other factors. It has nowhere been explicitly mentioned, but I am assuming that FVC is given in ml. ","1900d6db":"## Data distribution by Smoking Status (uniques values)","8d7cae11":"The distribution shows that most of the people have had their measurements done in 0-10 weeks. This indicates two things:\n\n1. Either patients are reluctant to visit hospitals to get their FVC mesured.\n2. Or, the health of patients deteriorated over the course of weeks and gradually death would have occured.\n\n## FVC vs percent \n\n\nLet us see what is the relationship between FVC and Percent:","6d3b266c":"We notice from the distribution that very few patients having very high FVC. The data is not normally distributed. We have a positive skew; Positive Skewness means when the tail on the right side of the distribution is longer or fatter. The mean and median will be greater than the mode. ","92088464":"Since this is real medical data, you will notice the relative timing of FVC measurements varies widely. The timing of the initial measurement relative to the CT scan and the duration to the forecasted time points may be different for each patient. This is considered part of the challenge of the competition.\n\nLet us undestand more on how our data is distributed: ","a01a3094":"So, we have 176 unique patients ids. Rest of them are essentially the week-by-week record of these patients. Now we can analyze the data in two ways:\n\n1. We can use all the data\n2. We can use the data with uniqe ids.\n\nLet us first make a new dataframe with unique ids and also make a columns expressing frequency of each patient","59fae7ff":"### Patient 1 with id ID00010637202177584971671","3bf20375":"We can see that on an average, patients had around 9 appointments to get their FVC tested. Some had fewer than that, but most of them had close to 9 appointments. Let us explore other features in the dataset. \n\n## Data distribution by Sex (uniques values)","ec18daa9":"We see that more number of men suffer from pulmonary fibrosis than women. This could be because they are more exposed to environmental hazards because they work more in outdoor jobs. Women also tend to develop cardiovascular diseases around 7-12 years later than men. Cardiovascular diseases are also a potential factor behind development of pulmonary fibrosis. \n\n## Data distribution by Age (uniques values)"}}