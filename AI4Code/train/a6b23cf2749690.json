{"cell_type":{"10f153a8":"code","1a01d72d":"code","78d95934":"code","740a5caf":"code","16607c95":"code","144938ae":"code","99e8d016":"code","f5da2150":"code","fc879d68":"code","847ce6a1":"code","5d850574":"code","8dd9d0c4":"code","bf9f002c":"code","5770cbd4":"code","b654e72a":"markdown"},"source":{"10f153a8":"import numpy as np\nimport pandas as pd\nimport xgboost as xg\nfrom sklearn.model_selection import train_test_split\nfrom sklearn.preprocessing import Normalizer\nimport pandas as pd\nimport numpy as np\nimport lightgbm\nfrom IPython.display import display\nfrom sklearn.model_selection import train_test_split, GroupKFold, KFold\nfrom sklearn.metrics import mean_absolute_error\nimport optuna\nfrom tensorflow import keras\nimport tensorflow as tf\nfrom sklearn.preprocessing import normalize","1a01d72d":"df = pd.read_csv('..\/input\/ventilator-pressure-prediction\/train.csv')\ntest_df = pd.read_csv('..\/input\/ventilator-pressure-prediction\/test.csv')","78d95934":"def prepare_dataset(df):\n    df['area'] = df['time_step'] * df['u_in']\n    df['area'] = df.groupby('breath_id')['area'].cumsum()\n    df['cross']= df['u_in']*df['u_out']\n    df['cross2']= df['time_step']*df['u_out']\n    df['u_in_cumsum'] = (df['u_in']).groupby(df['breath_id']).cumsum()\n    df['one'] = 1\n    df['count'] = (df['one']).groupby(df['breath_id']).cumsum()\n    df['u_in_cummean'] =df['u_in_cumsum'] \/df['count']\n    df['breath_id_lag']=df['breath_id'].shift(1).fillna(0)\n    df['breath_id_lag2']=df['breath_id'].shift(2).fillna(0)\n    df['breath_id_lagsame']=np.select([df['breath_id_lag']==df['breath_id']],[1],0)\n    df['breath_id_lag2same']=np.select([df['breath_id_lag2']==df['breath_id']],[1],0)\n    df['u_in_lag'] = df['u_in'].shift(1).fillna(0)\n    df['u_in_lag'] = df['u_in_lag']*df['breath_id_lagsame']\n    df['u_in_lag2'] = df['u_in'].shift(2).fillna(0)\n    df['u_in_lag2'] = df['u_in_lag2']*df['breath_id_lag2same']\n    df['u_out_lag2'] = df['u_out'].shift(2).fillna(0)\n    df['u_out_lag2'] = df['u_out_lag2']*df['breath_id_lag2same']\n    df['R'] = df['R'].astype(str)\n    df['C'] = df['C'].astype(str)\n    df['RC'] = df['R']+df['C']\n    df = pd.get_dummies(df)\n    return df","740a5caf":"train_y = df[['pressure']].to_numpy().reshape(-1, 80)\ntrain_x = prepare_dataset(df[['id','breath_id','R','C','time_step','u_in','u_out']])\ntest_x = prepare_dataset(test_df)\ntrain_x","16607c95":"train_x.drop(['id', 'breath_id','one','count','breath_id_lag','breath_id_lag2','breath_id_lagsame','breath_id_lag2same'], axis=1, inplace=True)\ntest_x.drop(['id', 'breath_id','one','count','breath_id_lag','breath_id_lag2','breath_id_lagsame','breath_id_lag2same'], axis=1,inplace=True)\n\n","144938ae":"train_y.shape","99e8d016":"train_x = np.array(train_x)\ntest_x = np.array(test_x)\n\ntrain_x = train_x.reshape(-1, 80, train_x.shape[-1])\ntest_x = test_x.reshape(-1, 80, test_x.shape[-1])","f5da2150":"test_x.shape","fc879d68":"kf = KFold(n_splits=5, shuffle=True, random_state=2021)\ntest_preds = []\nfor fold, (train_idx, test_idx) in enumerate(kf.split(train_x, train_y)):\n    print('-'*15, '>', f'Fold {fold+1}', '<', '-'*15)\n    X_train, X_valid = train_x[train_idx], train_x[test_idx]\n    y_train, y_valid = train_y[train_idx], train_y[test_idx]\n    scheduler = tf.keras.optimizers.schedules.ExponentialDecay(1e-3, 200*((len(X_train)*0.8)\/1024), 1e-5)\n    model = keras.models.Sequential([\n        keras.layers.Input(shape=(80, 26)),\n        keras.layers.Bidirectional(keras.layers.LSTM(200, return_sequences=True)),\n        keras.layers.Bidirectional(keras.layers.LSTM(150, return_sequences=True)),\n        keras.layers.Bidirectional(keras.layers.LSTM(100, return_sequences=True)),\n        keras.layers.Dense(100, activation='relu'),\n        keras.layers.Dense(1),\n    ])\n    model.compile(optimizer=\"adam\", loss=\"mae\")\n    model.fit(X_train, y_train, validation_data=(X_valid, y_valid), epochs=180, batch_size=256, callbacks=[tf.keras.callbacks.LearningRateScheduler(scheduler)])\n    model.save(f'Fold{fold+1} RNN Weights')\n    test_preds.append(model.predict(test_x).squeeze().reshape(-1, 1).squeeze())","847ce6a1":"model.summary()","5d850574":"test_preds","8dd9d0c4":"submission_df = pd.DataFrame([], columns=['id','pressure' ])\nsubmission_df['id'] =test_df['id']\nsubmission_df['pressure'] = test_preds[0]","bf9f002c":"submission_df","5770cbd4":"submission_df.to_csv('.\/submission.csv',index=False)","b654e72a":"# Please Upvote if you Like my work."}}