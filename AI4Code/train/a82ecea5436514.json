{"cell_type":{"de49a834":"code","3ee48c64":"code","7f154fc6":"code","e2b20cc4":"code","d0908280":"code","e68cf8f4":"code","ab5ec60f":"code","6291cc4a":"code","f461128e":"code","ff3f584a":"code","6afe932e":"code","df51a62d":"code","6d034a24":"code","9ff9b8b9":"code","69923e26":"code","ebaf9e26":"code","4220e38e":"code","8f84be10":"code","cd736fd8":"code","c174bf06":"code","acb52f52":"code","ab786216":"code","2742b2d1":"code","a2a56c64":"code","a6ed0748":"code","73394d4b":"code","817d1ae2":"code","abe04c78":"code","199088db":"code","bf5f8824":"code","8fafe921":"code","de376025":"code","39015b39":"code","e894d386":"code","db170295":"code","348132d6":"code","9d3fbc54":"code","8a89b2a3":"code","13e2cb62":"code","9dbc5d7e":"code","1cfbcc21":"code","363d7179":"code","087543e3":"code","3a9dd296":"code","d9a3e2be":"code","a5fc7696":"code","81b8fc10":"code","c2bdddc0":"code","eab32c1d":"code","b67059e7":"code","44f9b757":"code","4175b636":"code","9741b09e":"code","1dad2bb3":"code","6ea9a66c":"code","e8326cea":"code","aaedd526":"code","2334945b":"code","cabb1655":"code","fae07550":"code","3f7e8535":"code","54ac3745":"code","2c95fda0":"code","785bf291":"code","768da218":"code","d8533689":"code","45ac6213":"code","9880c4ac":"code","45a77054":"code","63fc755f":"code","c6ddd836":"code","62aed3a9":"code","18ea31d3":"code","b911fdce":"code","4a212384":"code","e9929fd8":"code","cf33b93d":"code","240d7079":"code","e1a72fa0":"code","7a58181b":"code","0b4a3bf6":"code","27995596":"code","8043a732":"code","1afc3efd":"markdown","cd619aa8":"markdown","9e6c86f3":"markdown","ded229ad":"markdown","c615c8b6":"markdown","535464a3":"markdown","ce4d4c88":"markdown","d23e39c7":"markdown","adccb5f9":"markdown","0a6d8c32":"markdown","0d813e34":"markdown","eb1b58dc":"markdown","ab062891":"markdown","546239a9":"markdown","70d2c4e9":"markdown","0026b555":"markdown","89978c0f":"markdown","2a32607c":"markdown","908e322b":"markdown","ab4f69c9":"markdown","82e42c81":"markdown","462c1d0f":"markdown","85d0b27d":"markdown","351cdd14":"markdown","c4d5434f":"markdown","eb6a8eb9":"markdown","e0c8e587":"markdown","2a43f880":"markdown","c37519b5":"markdown","8f4a53ae":"markdown","f2882a63":"markdown","5d31cd0b":"markdown","098a5174":"markdown","65a053d7":"markdown","aadc1640":"markdown","f00c2bd3":"markdown","39b5c1e3":"markdown","38e54a42":"markdown","2ca7da43":"markdown","e8547ffe":"markdown","c03fc732":"markdown","d8d6390d":"markdown","6e9526e6":"markdown","202ef230":"markdown","48a89875":"markdown","62b23f42":"markdown","40d7df17":"markdown","00950331":"markdown","79b0f1ac":"markdown","b110e751":"markdown","bbcc5f9a":"markdown","e6492d13":"markdown","146841d9":"markdown","b7fc6a45":"markdown"},"source":{"de49a834":"# This Python 3 environment comes with many helpful analytics libraries installed\n# It is defined by the kaggle\/python docker image: https:\/\/github.com\/kaggle\/docker-python\n# For example, here's several helpful packages to load in \n\nimport numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\n\n# Input data files are available in the \"..\/input\/\" directory.\n# For example, running this (by clicking run or pressing Shift+Enter) will list the files in the input directory\n\nfrom subprocess import check_output\nprint(check_output([\"ls\", \"..\/input\"]).decode(\"utf8\"))\n\n# Any results you write to the current directory are saved as output.","3ee48c64":"# visualization\nimport seaborn as sns\nimport matplotlib.pyplot as plt\n%matplotlib inline\n\n# machine learning\nfrom sklearn.ensemble import RandomForestClassifier, GradientBoostingClassifier\nfrom sklearn.pipeline import Pipeline, FeatureUnion\n#from sklearn.compose import ColumnTransformer not present in version 19.1\nfrom sklearn.model_selection import GridSearchCV, StratifiedKFold\nfrom sklearn.metrics import mean_squared_error, precision_score,precision_recall_curve,recall_score,f1_score, roc_auc_score\nfrom sklearn.model_selection import cross_val_score, cross_validate\nfrom sklearn.preprocessing import PolynomialFeatures, StandardScaler, OneHotEncoder, LabelBinarizer\nfrom sklearn.impute import SimpleImputer","7f154fc6":"dftrain=pd.read_csv('..\/input\/train.csv')\ndftest=pd.read_csv('..\/input\/test.csv')\ndftrain.head(3)","e2b20cc4":"def ticket2(value):\n    split=value.split(\" \")\n    if(len(split)>1):\n        return int(split[-1].strip())\n    else :\n        return 0","d0908280":"dftotal=pd.concat([dftrain,dftest],axis=0,ignore_index=True)\ndftotal[\"Ticket1\"]=dftotal.Ticket.map(lambda x: x.split(\" \")[0])\ndftotal[\"Ticket2\"]=dftotal.Ticket.map(ticket2)\n#dftotal[\"Ticket2\"]=dftotal[\"Ticket2\"].astype(int)","e68cf8f4":"dftotal[\"KNNs\"]=\"\"\ndftotal[\"KNNsNbr\"]=0\ndftotal[\"KSurvivalRate\"]=0","ab5ec60f":"k=10\nfor index in dftotal.index:\n    ticket1=dftotal.loc[index,\"Ticket1\"]\n    ticket2=dftotal.loc[index,\"Ticket2\"]\n    embarked = dftotal.loc[index,\"Embarked\"]\n    if(ticket1==\"LINE\"):\n        nbours_index=dftotal[dftotal.Ticket==\"LINE\"].index\n        dftotal.at[index,\"KNNs\"]=nbours_index.values\n        dftotal.loc[index,\"KNNsNbr\"]=len(nbours_index)\n        dftotal.loc[index,\"KSurvivalRate\"]=dftotal.loc[nbours_index,\"Survived\"].mean()\n    elif((ticket1!=\"LINE\")&(ticket2==0)):\n        dftotalindex=dftotal[(dftotal.Embarked==embarked)&(dftotal.Ticket2==0)&(dftotal.Ticket!=\"LINE\")].copy()\n        nbours_index=dftotalindex[np.abs(dftotalindex[\"Ticket1\"].astype(int)-int(ticket1))<k].index\n        dftotal.at[index,\"KNNs\"]=nbours_index.values\n        dftotal.loc[index,\"KNNsNbr\"]=len(nbours_index)\n        dftotal.loc[index,\"KSurvivalRate\"]=dftotalindex.loc[nbours_index,\"Survived\"].mean()\n    else:\n        dftotalindex=dftotal[(dftotal.Embarked==embarked)&(dftotal.Ticket1==ticket1)].copy()\n        nbours_index=dftotalindex[np.abs(dftotalindex[\"Ticket2\"].astype(int)-int(ticket2))<k].index\n        dftotal.at[index,\"KNNs\"]=nbours_index.values\n        dftotal.loc[index,\"KNNsNbr\"]=len(nbours_index)\n        dftotal.loc[index,\"KSurvivalRate\"]=dftotalindex.loc[nbours_index,\"Survived\"].mean()","6291cc4a":"(dftotal[(dftotal.KNNsNbr>5)&(dftotal.KSurvivalRate==0.0)\n        &(dftotal.PassengerId>891)&(dftotal.Sex==\"female\")&(dftotal.Pclass==3)])","f461128e":"women_group_dead=dftotal[(dftotal.KNNsNbr>0)&(dftotal.KSurvivalRate==0.0)\n        &(dftotal.PassengerId>891)&(dftotal.Sex==\"female\")&(dftotal.Pclass==3)][\"PassengerId\"].values\nwomen_group_dead","ff3f584a":"group=dftrain.groupby([\"Sex\",\"Pclass\"])\ngroup[\"Survived\",\"Age\",\"Fare\"].agg([\"mean\",\"std\",\"size\"])","6afe932e":"from sklearn.base import BaseEstimator\n\nclass DummyPrediction(BaseEstimator):\n    \n    def fit(self, X, Y=None):\n        pass\n    \n    def predict(self, X):\n        Y=X[\"Sex\"]==\"female\"\n        return Y.astype(int)\n            ","df51a62d":"def print_scores(scores):\n    print(scores)\n    print(scores.mean())\n    print(scores.std())","6d034a24":"clf = DummyPrediction()\ndftrain[\"Survived_Model\"]=clf.predict(dftrain)","9ff9b8b9":"Y=dftrain[\"Survived\"]\nY_model=dftrain[\"Survived_Model\"]\nprint(\"recall score on training set\",recall_score(Y,Y_model))","69923e26":"print(\"precision score on training set\",precision_score(Y,Y_model))","ebaf9e26":"scores=cross_validate(clf,dftrain,dftrain[\"Survived\"],scoring=[\"f1\",\"accuracy\"],cv=10,return_train_score=False)","4220e38e":"def display_cross_validate(scores):\n    print(\"cross val scores\")\n    print(\"f1 scores\", scores[\"test_f1\"])\n    print(\"f1 mean\", scores[\"test_f1\"].mean())\n    print(\"f1 std\", scores[\"test_f1\"].std())\n    print(\"accuracy scores\", scores[\"test_accuracy\"])\n    print(\"accuracy mean\", scores[\"test_accuracy\"].mean())\n    print(\"accuracy std\", scores[\"test_accuracy\"].std())","8f84be10":"display_cross_validate(scores)","cd736fd8":"print(\"roc_auc_score on training set\",roc_auc_score(Y,Y_model))","c174bf06":"dftest[\"Survived\"]=clf.predict(dftest)","acb52f52":"def process_names(df):\n    df[\"FamilyName\"]=df[\"Name\"].map(lambda x: x.split(\",\")[0].strip())\n    df[\"FullName\"]=df[\"Name\"].map(lambda x: x.split(\",\")[1].strip())\n    df[\"Title\"]=df[\"FullName\"].map(lambda x: x.split(\".\")[0].strip())\n    df[\"TwoLetters\"]=df[\"FamilyName\"].map(lambda x: x[-2:])\n    \nprocess_names(dftrain)\nprocess_names(dftest)","ab786216":"print(\"most occuring tickets in the training set:\")\ndftrain[\"Ticket\"].value_counts()[:6]","2742b2d1":"dftrain[\"TicketButLast\"]=dftrain.Ticket.map(lambda x: x[:-1])\ndftest[\"TicketButLast\"]=dftest.Ticket.map(lambda x: x[:-1])","a2a56c64":"dftrain[dftrain.TwoLetters==\"ic\"].sort_values(\"Ticket\")[[\"PassengerId\",\"Survived\",\"Pclass\",\"Name\",\"Ticket\"]]","a6ed0748":"ticket_count_train = dftrain[\"Ticket\"].value_counts()\nticket_count_test = dftest[\"Ticket\"].value_counts()\nticket_inter = np.intersect1d(dftrain[\"Ticket\"].values,dftest[\"Ticket\"].values)\n\nticketButLast_count_train = dftrain[\"TicketButLast\"].value_counts()\nticketButLast_count_test = dftest[\"TicketButLast\"].value_counts()\nticketButLast_inter = np.intersect1d(dftrain[\"TicketButLast\"].values,dftest[\"TicketButLast\"].values)","73394d4b":"for idx in dftrain.index:\n    ticket = dftrain.loc[idx,\"Ticket\"]\n    dftrain.loc[idx,\"CountTicket_InTrain\"]=ticket_count_train[ticket]\n    if(ticket in ticket_inter):\n        dftrain.loc[idx,\"CountTicket\"]=(ticket_count_train[ticket]+ticket_count_test[ticket])\n    else:\n        dftrain.loc[idx,\"CountTicket\"]=ticket_count_train[ticket]","817d1ae2":"for idx in dftest.index:\n    ticket = dftest.loc[idx,\"Ticket\"]\n    dftest.loc[idx,\"CountTicket_InTest\"]=ticket_count_test[ticket]\n    if(ticket in ticket_inter):\n        dftest.loc[idx,\"CountTicket\"]=(ticket_count_train[ticket]+ticket_count_test[ticket])\n    else:\n        dftest.loc[idx,\"CountTicket\"]=ticket_count_test[ticket]","abe04c78":"for idx in dftrain.index:\n    ticketButLast = dftrain.loc[idx,\"TicketButLast\"]\n    dftrain.loc[idx,\"CountTicketButLast_InTrain\"]=ticketButLast_count_train[ticketButLast]\n    if(ticketButLast in ticketButLast_inter):\n        dftrain.loc[idx,\"CountTicketButLast\"]=(ticketButLast_count_train[ticketButLast]\n                                               +ticketButLast_count_test[ticketButLast])\n    else:\n        dftrain.loc[idx,\"CountTicketButLast\"]=ticketButLast_count_train[ticketButLast]","199088db":"for idx in dftest.index:\n    ticketButLast = dftest.loc[idx,\"TicketButLast\"]\n    dftest.loc[idx,\"CountTicketButLast_InTest\"]=ticketButLast_count_test[ticketButLast]\n    if(ticketButLast in ticketButLast_inter):\n        dftest.loc[idx,\"CountTicketButLast\"]=(ticketButLast_count_train[ticketButLast]\n                                               +ticketButLast_count_test[ticketButLast])\n        dftest.loc[idx,\"CountTicketButLast_InTrain\"]=(ticketButLast_count_train[ticketButLast])\n    else:\n        dftest.loc[idx,\"CountTicketButLast\"]=ticketButLast_count_test[ticketButLast]","bf5f8824":"for idx in dftrain.index:\n    ticket = dftrain.loc[idx,\"Ticket\"]\n    if(ticket in ticket_inter):\n        dftrain.loc[idx,\"FareCorrect\"]=dftrain.loc[idx,\"Fare\"]\/(ticket_count_train[ticket]\n                                                                +ticket_count_test[ticket])\n    else:\n        dftrain.loc[idx,\"FareCorrect\"]=dftrain.loc[idx,\"Fare\"]\/(ticket_count_train[ticket])","8fafe921":"print(\"Example of correction for large Pclass 3 Family\")\ndftrain[dftrain.FamilyName==\"Panula\"][[\"Survived\",\"Pclass\",\"Name\",\"Ticket\",\"Fare\",\"FareCorrect\"]]","de376025":"dfFamilyTrain=dftrain[(dftrain[\"Parch\"]>0)&(dftrain[\"Survived\"]==0)]\ndfFamily=dfFamilyTrain[(dfFamilyTrain[\"Sex\"]==\"female\")|(dfFamilyTrain[\"Age\"]<10)]\nfamiliestrain=dfFamily[\"FamilyName\"]","39015b39":"dfFamilytest=dftest[(dftest[\"Parch\"]>0)&(dftest[\"Sex\"]==\"female\")]\nfamiliestest=dfFamilytest[\"FamilyName\"]","e894d386":"print(\"Women who have family members who died in the training set.\")\nintersection=np.intersect1d(familiestest,familiestrain)\nintersection","db170295":"women_died_ids=dfFamilytest[dfFamilytest[\"FamilyName\"].isin(intersection)][\"PassengerId\"].index","348132d6":"col_index=dftest.columns.get_loc(\"Survived\")\ndftest.iloc[women_died_ids,col_index]=0","9d3fbc54":"print(\"Mothers and Sisters who died with their families\")\ndftest.iloc[women_died_ids,:]","8a89b2a3":"dfFamilyTrain=dftrain[(dftrain[\"Parch\"]>0)&(dftrain[\"Survived\"]==1)]\ndfFamily=dfFamilyTrain[(dftrain[\"Sex\"]==\"female\")]\nfamiliestrain=dfFamily[\"FamilyName\"]","13e2cb62":"dfFamilytest=dftest[(dftest[\"Parch\"]>0)&(dftest[\"Sex\"]==\"male\")&((dftest[\"Title\"]==\"Master\"))]\nfamiliestest=dfFamilytest[\"FamilyName\"]","9dbc5d7e":"print(\"Family names of Boys with mothers who survived \")\nintersection=np.intersect1d(familiestest,familiestrain)\nintersection","1cfbcc21":"boys_survived_ids=dfFamilytest[dfFamilytest[\"FamilyName\"].isin(intersection)][\"PassengerId\"].index","363d7179":"col_index=dftest.columns.get_loc(\"Survived\")\ndftest.iloc[boys_survived_ids,col_index]=1","087543e3":"print(\"Boys who survived with their mothers\")\ndftest.iloc[boys_survived_ids,:]","3a9dd296":"dftest[(dftest.Title==\"Master\")&(dftest.Survived==0)]","d9a3e2be":"print(\"Male passenger travelling with Olsen, Master. Artur Karl who survived:\")\ndftrain[dftrain.Ticket.map(lambda x: x[:-1])==\"C 1736\"]","a5fc7696":"dftest[dftest.FamilyName==\"Peacock\"]","81b8fc10":"olsen_idx=dftest[(dftest.FamilyName==\"Olsen\")].index\ndftest.loc[olsen_idx,\"Survived\"]=1\npeacock_idx=dftest[(dftest.FamilyName==\"Peacock\")].index\ndftest.loc[peacock_idx,\"Survived\"]=0","c2bdddc0":"print(\"Panula family Ticket number 3101295\")\ndftrain[dftrain.Ticket==\"3101295\"]","eab32c1d":"print(\"Travelling with them in test set\")\ndftest[dftest.Ticket==\"3101295\"]","b67059e7":"print(\"Most occuring ticket in train set, a group of Chinese. Most of them survived.\")\ndftrain[dftrain.Ticket==\"1601\"]","44f9b757":"print(\"accompanying them in test set : \")\ndftest[dftest.Ticket==\"1601\"]","4175b636":"most_occ_ticks=dftrain[\"Ticket\"].value_counts()[:19]","9741b09e":"df=dftest[dftest[\"Ticket\"].isin(most_occ_ticks.index)].sort_values(\"Ticket\")\ndf_women=df[df[\"Sex\"]==\"female\"]","1dad2bb3":"print(\"Women who died with their groups. We already spotted some mothers above.\")\nfor idx in df_women.index:\n    ticket = df_women.loc[idx,\"Ticket\"]\n    nbr_survivors = dftrain[dftrain[\"Ticket\"]==ticket][\"Survived\"].sum()\n    if(nbr_survivors==0):\n        print(df_women.loc[idx,\"Name\"])\n        dftest.loc[idx,\"Survived\"]=0","6ea9a66c":"df_men=df[(df[\"Sex\"]==\"male\")&(df[\"SibSp\"]==0)&(df[\"Parch\"]==0)]\ndf_men","e8326cea":"print(\"Man who survived with the majority of his group:\")\nfor idx in df_men.index:\n    ticket = df_men.loc[idx,\"Ticket\"]\n    mean_survivors = dftrain[dftrain[\"Ticket\"]==ticket][\"Survived\"].mean()\n    if(mean_survivors>0.5):\n        print(df_men.loc[idx,\"Name\"])\n        dftest.loc[idx,\"Survived\"]=1","aaedd526":"dftest[(dftest.CountTicketButLast>10)&(dftest.Pclass==3)&(dftest.SibSp==0)&(dftest.Parch==0)&(dftest.Sex==\"female\")&\n      (dftest.Title==\"Miss\")]","2334945b":"print(\"Passengers of train set who travelled with Nieminen, Miss. Manta Josefina\")\ndftrain[dftrain.TicketButLast==\"310129\"]","cabb1655":"print(\"Passengers of train set who travelled with Nieminen, Miss. Jenny Lovisa\")\ndftrain[dftrain.TicketButLast==\"34708\"]","fae07550":"idx=dftest[(dftest.CountTicketButLast>10)&(dftest.Pclass==3)&(dftest.SibSp==0)&(dftest.Parch==0)&(dftest.Sex==\"female\")&\n      (dftest.Title==\"Miss\")].index\ndftest.loc[idx,\"Survived\"]=0","3f7e8535":"print(\"People called ---ic died :\")\ndftrain[dftrain.TwoLetters==\"ic\"]","54ac3745":"print(\"People called ---ff died :\")\ndftrain[dftrain.TwoLetters==\"ff\"]","2c95fda0":"dftest[(dftest.TwoLetters.isin([\"ic\",\"ff\"]))&(dftest.Sex==\"female\")]","785bf291":"idx=dftest[(dftest.TwoLetters.isin([\"ic\",\"ff\"]))&(dftest.Sex==\"female\")].index\ndftest.loc[idx,\"Survived\"]=0","768da218":"dftest[dftest[\"PassengerId\"]==1297]","d8533689":"dftest.loc[dftest[dftest[\"PassengerId\"]==1297].index,\"Survived\"]=1","45ac6213":"print(\"single women statistics\")\ndftrain[(dftrain[\"Sex\"]==\"female\")&(dftrain[\"SibSp\"]==0)&(dftrain[\"Parch\"]==0)].describe()","9880c4ac":"single_women = dftrain[(dftrain[\"Sex\"]==\"female\")&(dftrain[\"SibSp\"]==0)&(dftrain[\"Parch\"]==0)]\nsingle_women[\"Age\"]=single_women[\"Age\"].fillna(single_women[\"Age\"].median())\nfeatures=[\"Age\",\"Pclass\",\"Fare\"]\nx_single_women = single_women[features]\ny_single_women = single_women[\"Survived\"]","45a77054":"xg = GradientBoostingClassifier()\nkfold = StratifiedKFold(10)","63fc755f":"param_grid={\n    'n_estimators':[100,200,300],\n    'min_samples_split':[2,3,4],\n    'max_depth' : np.arange(3,7,1)\n}","c6ddd836":"grid = GridSearchCV(xg,param_grid=param_grid,cv=kfold,scoring=\"accuracy\")\ngrid.fit(x_single_women,y_single_women)","62aed3a9":"grid.best_params_","18ea31d3":"test_df=dftest[(dftest[\"Sex\"]==\"female\")&(dftest[\"SibSp\"]==0)&(dftest[\"Parch\"]==0)]\ntest_df[\"Age\"]=test_df[\"Age\"].fillna(test_df[\"Age\"].median())\ntest_df[\"Fare\"]=test_df[\"Fare\"].fillna(test_df[\"Fare\"].median())","b911fdce":"Y_scores_pclass3 = grid.best_estimator_.predict_proba(test_df[features])[:,1]\ntest_df[\"Y_scores\"]=Y_scores_pclass3","4a212384":"print(\"Five worst scores of xgboost :\")\ntest_df.sort_values(\"Y_scores\",ascending=True)[:5]","e9929fd8":"idxs = test_df.sort_values(\"Y_scores\",ascending=True).index[:5]\ndftest.loc[idxs,\"Survived\"]=0","cf33b93d":"single_poor_wmn=dftest[(dftest.CountTicketButLast<=2)&(dftest.Sex==\"female\")\n                       &(dftest.Pclass==3)&(dftest.SibSp==0)&(dftest.Parch==0)].index\ndftest.loc[single_poor_wmn,\"Survived\"]=0","240d7079":"print(\"Single poor isolated women with no family\")\ndftest.loc[single_poor_wmn,:]","e1a72fa0":"idx=dftest[dftest.PassengerId.isin(women_group_dead)].index\ndftest.loc[idx,\"Survived\"]=0","7a58181b":"print(\"Men who are predicted to survive\")\ndftest[(dftest[\"Survived\"]==1)& (dftest[\"Sex\"]==\"male\")]","0b4a3bf6":"print(\"Women who are predicted to survive\")\ndftest[(dftest[\"Survived\"]==0)& (dftest[\"Sex\"]==\"female\")]","27995596":"dftest_sorted=dftest.sort_values(\"PassengerId\")\ndftest_sorted=dftest_sorted[[\"PassengerId\",\"Survived\"]]","8043a732":"dftest_sorted.to_csv(\"Titanic.csv\",index=False)\nprint('print csv')","1afc3efd":" ### 1. Common mistake\n\nI had a lot of fun exploring the Titanic dataset and felt like an investigator in charge of discovering the reasons why some people survived and other died. I think that this competition is a great way to start learning but teaches you the harsh way !  Indeed, as most of us, I first blindly applied my favorite classification algorithm, that is Random Forest, barely looking at the features. I was mainly focused on tweaking hyperparameters and designing very complex strategies to fill in missing values for Age, Fare, Embarked... I could not overtop the 79-80% of the top 20% of participants. \n \n ### 2. Simple is beautiful\n \nUntil I accidentally discovered that some people in the test set shared family bounds with people in the train set. Everything became clear at that moment. I finally understood that it did not matter if you were 35 or 40 or if you paid 12\u00a3 instead of 20\u00a3. What really matters here is the fate of people whom you were travelling with. Indeed, in all this chaos, what prevailed was bounds between passengers.\n\n### 3. Build a transparent model\n\nSo the challenge is to properly identify people who were travelling together and decide on the fate of people in the test set given what happened to the people in the train set that belonged to the same group. **We then build here our own decision tree that is a transparent model that we fully understand. **\n \nThus I want to insist on a particular point of interest that contradicts what we usually learn doing Machine Learning that we should not use any information on the test set while building our model. If we follow this principle here and run classical algorithms on the training set, they won't be able to see the connections that could exist between the training and test sets. As you could have noticed, by naively training classification algorithms, they often output that all men died. Slightly better, they output that all youg Masters survived even if they have mothers who died in the training set.  That is why we should manually correct them or simply don't use them here as the most important features are neither quantitative nor categorical as Name or Ticket. ","cd619aa8":"<h1><a id=Model>Model<\/a>","9e6c86f3":"I checked manually for all of them using FamilyName, Ticket and TicketButLast. For Rice, Boulos, van Billiard, Dangbom, Johnston, Betros, Sage, Palsson family died. For Olsen his father died but I found that another Norwegian travelling with them survived so I made the hypotheses that he saved the kid. ","ded229ad":"## Default Prediction\n\nExcept for \"outliers\" that we will try to identify below, our default prediction will be that women survived and men died. We get a reasonable score on the public test set of 76.55%. Then to refine our model we  will use different features and feature engineering to identify rare women that should have died and rare men that survived.","c615c8b6":"<h2><a id=FEng>Feature Engineering <\/a>","535464a3":"<h1><a id=Intro>Introduction<\/a>","ce4d4c88":"## Baron von Drachstedt","d23e39c7":"## People from Yougoslavia and Russia died","adccb5f9":"## Boys who survived with their mothers","0a6d8c32":"<h2><a id=CSV>CSV OUTPUT <\/a>","0d813e34":"1. [Introduction](#Intro)\n2. [References](#Ref)\n3. [Model](#Model)\n<br\/>\n 3.1[Dummy Sex Model](#Dummy)\n<br\/>\n 3.2[Feature Engineering](#FEng)\n<br\/>\n 3.3[Mothers & Babies](#MB)\n<br\/>\n 3.4[Other Groups](#G)\n<br\/>\n 3.5[Single & Isolated Women](#SW)\n4. [Further Improvements](#FI)\n5. [Checks](#C)\n6. [CSV Output](#CSV)\n\n\n","eb1b58dc":"<h2><a id=Dummy>Dummy Sex Model<\/a>","ab062891":"## Obtaining correct Fare per passenger","546239a9":"# ALGORITHMIC CLASSIFICATION for SINGLE WOMEN","70d2c4e9":"-KNNs contains a list of all the passengers index surrounding the individual. Very useful to view and debug the function below. \n-KNNsNbr just a count of KNNs\n-KSurvivalRate is the survival rate of the people surrounding the person. ","0026b555":"The goal here is to extract from Name, the family name, title and last two letters of family name. Here the idea is to classify people according to their nationality. We will see below that this last feature can identify people from Yougoslavia, Russia for instance. ","89978c0f":"<h1><a id=Ref>References<\/a>","2a32607c":"Looking at the last two letters of FamilyName is a proxy to spot people from the same regions. It is a way to clusterize people. ","908e322b":"## Isolated women","ab4f69c9":"## Same Ticket","82e42c81":"An excellent notebook that hugely influenced mine : \n[Chris Deotte - Titanic WCG + XGBoost](https:\/\/www.kaggle.com\/cdeotte\/titanic-wcg-xgboost-0-84688).\nIt is the best scoring notebook with detailed explanations. Overperforming notebooks are only copy-paste of the black-box genetic programming original code. \n\n[Aur\u00e9lien G\u00e9ron - Hands-On Machine Learning with Scikit-Learn and TensorFlow](https:\/\/www.amazon.fr\/Hands-Machine-Learning-Scikit-Learn-TensorFlow\/dp\/1491962291).\nA perfect place to start learning Machine Learning with neat python code relying on two of the most used libraries Sklearn and TF. \nIn particular, it has a dedicated section to classification and clearly explains why it is more difficult to design adequate metrics than for regression. You could find here definitions for the different metrics I use to evalute the Dummy Sex Model. \n\n\n","462c1d0f":"For Peacock, Master. Alfred Edward I saw that his mother and sister were also in the test set with no other family member. So I presumed that a poor mother with 2 young kids died : ","85d0b27d":"## Olsen survived and Peacock family died","351cdd14":"<h2><a id=SW>Single & Isolated Women <\/a>","c4d5434f":"## Processing Ticket","eb6a8eb9":"<h2><a id=G>Other Groups <\/a>","e0c8e587":"### Storing their PassengerIds","2a43f880":"We had already found that Jelka Oreskovic should have died. We found 4 other women very likely to die. ","c37519b5":"<h2><a id=FI>Further Improvements <\/a>","8f4a53ae":"The first obvious observation is that **Women survived and Men died** with a slight distinction between Pclasses. That will be our default model that we build here using Sklearn framework in order to evaluate it on different training samples with various metrics. ","f2882a63":"**Ticket entries are not unique**. We want to identify duplicates. By doing so we will be able to spot large families, groups and be able to correct Fare to get the real Fare per passenger. We also create a new column with the Ticket number without the last figure so as again to spot groups. ","5d31cd0b":"Here looking at the names of men in the test set and using the split method, we luckily found that one had a noble title. We decided to assume that he survived. ","098a5174":"Here I just check for \"Masters\" for which I did not find mothers in the training set. Some could be in the test set or they could travel with adults. ","65a053d7":"In the same idea as above, we look for young women from Pclass3 who could have accompanied large families who died and took care of their children. ","aadc1640":"Manifestly, I did not find enough information regarding men who survived. I did not manage yet to do the same as I did for single women. That is finding a good, balanced training set to train a classification algo that would output very high survival probability for men in the test set that are not young Masters. \n\nMoreover, many operations in this notebook are done manually. I could improve it by creating real column features as for Mother, Father, Mother who died, Mother who Survived, Mean of Survival for People in the same group... Then feed those new features to a classification algorithm. \n\nBesided, more could be done also on the Name feature to extract the nationality of passengers. As we saw, some people travelled together, not sharing any family bounds based on family names, and shared the same fate. From the training data, we could aslo extrapolate the fact that non-english speaking passengers could be more likely to die. \n\n**I would be happy if some Kagglers forked this notebook and improve from it. I Welcome also all your comments to improve this code and I will add some comments if some operations were not clear enough.**","f00c2bd3":"We observe that Nieminen, Miss. Manta Josefina should have travelled with the Panula family and their 6 children. They all died. On the table below only Hirvonen, Miss. Hildur E, 2 years old survived. Her mother is in the test set. ","39b5c1e3":"## Creating a distance metric splitting Ticket numbers","38e54a42":"<h2><a id=C>Checks <\/a>","2ca7da43":"## Mothers won't abandon their children","e8547ffe":"With this correction my submission score went from 76.55% to 78.46% which is equal to an improvement of 1.91%=4\/(417\/2). So I think that 4 out of the 7 cases we found above are contained in the test set used to compute public initial scores. ","c03fc732":"Then I create new columns to count the number of occurences for each ticket number as follows : \n* for tickets in train :\n* * the number of duplicates in train, in train & test combined if intersection not empty. \n* for tickets in test : \n* * the number of duplicates in test, in train & test combined if intersection not empty. \n\nWe do the same for the ticket number without the same figure. As groups travelling together but not sharing family bounds or buying their tickets individually could not be spotted otherwise. \nPeople from Yougoslavia ex : ","d8d6390d":"Looking for similar people in the test set we found two women. Another way we could have spotted was by looking at their ticket number since they have consecutive ticket numbers. ","6e9526e6":"<h2><a id=MB>Mothers & Babies <\/a>","202ef230":"Here I use very cautiously the xgboost classifier that I train only on single women. By doing so I try to eliminate all the biases that come from the human bounds we have studied above. I then only select the 5 worst scores that are very close to 0 and assume that those women die. Moreover as for the single women training set, 40% of women survived. So we are training the algo on a **balanced data set**. ","48a89875":"We can see on the table above that we are dealing with and **unbalanced classification problem**. That is a large majority of women survived and men died. That is one of the reason why applying blindly classification algos won't work. Still they will have a good accuracy as the naive strategy of saying that everyone died gets already a good score. ","62b23f42":"*UPDATE 11-21-2018*\n\nWIP : I added a new feature based on Ticket and I measure the mean survival rate of people having close ticket numbers. \nI will sum up and fully automate the classification task using xgboost and these new features in the coming days. ","40d7df17":"## Processing Name","00950331":"## Boy with non family members and mother alone","79b0f1ac":"First find mothers in the test set that have babies or family members who died in the training set. We use FamilyName and Age to identify those women.  ","b110e751":"### Women of third class surrounded by people who all died","bbcc5f9a":"By looking at most occuring tickets I could see that some people were travelling with families as \"au paire\" or groups of friends from the same regrion. ","e6492d13":"The idea here is again to regroup passengers with the people they were travelling with and identify groups of people who all died. This may be because they were poor, located in a bad area of the boat... To do so, I convert Ticket feature to a ticket number and I define the group surrounding a person with the passengers having the same ticket +\/- k=10.\n\nTODO : I should cross-validate k on the training set to fine tune the value of this hyperparameter","146841d9":"To identify them we select males with Title==\"Master\" and look for their mums in the training set based on FamilyName.","b7fc6a45":"## Same TicketButLast"}}