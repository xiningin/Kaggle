{"cell_type":{"7469a42a":"code","4c9855f9":"code","8327186c":"code","b015748e":"code","def7fc59":"code","2b085dff":"code","396e4c7f":"code","d0f65111":"code","19561e05":"code","394f81f2":"code","048b2e70":"code","f080c8e4":"code","f9e1d753":"code","033b70fe":"code","a837e365":"code","0aa967cf":"code","e9f78db8":"code","ffde6376":"code","3ff05df3":"code","934130d6":"code","3c3302e6":"code","9841672b":"code","9501f29c":"code","12477b55":"code","cda46e19":"code","db8888da":"code","c9f96893":"code","eb837a65":"code","1ed8506c":"code","b01979c6":"code","94e0e2fc":"code","c5087327":"code","e1e272e0":"code","564dc52a":"code","37db5287":"code","af36e933":"code","b1fc8651":"code","b8d65ce3":"code","e4279c2d":"markdown","aef5505e":"markdown","98b9dc2e":"markdown","cf5c1203":"markdown","1406dc8f":"markdown","87758760":"markdown","485594f4":"markdown","752d1ea5":"markdown","69820425":"markdown","ce05bfa6":"markdown","b21a6d40":"markdown","6b6a3b39":"markdown","b42eb893":"markdown","08d61d76":"markdown","1373b08a":"markdown","c5b95ae2":"markdown","fbc8acc7":"markdown"},"source":{"7469a42a":"import numpy as np \nimport pandas as pd \n\nimport os\nfor dirname, _, filenames in os.walk('\/kaggle\/input'):\n    for filename in filenames:\n        print(os.path.join(dirname, filename))\n\nimport matplotlib.pyplot as plt\nimport seaborn as sns\nfrom imblearn.over_sampling import SMOTE\nfrom sklearn.model_selection import train_test_split\nfrom sklearn.neighbors import KNeighborsClassifier\nfrom sklearn.metrics import classification_report, roc_auc_score, accuracy_score, confusion_matrix, auc\n%matplotlib inline","4c9855f9":"df = pd.read_csv(\"..\/input\/telco-customer-churn\/WA_Fn-UseC_-Telco-Customer-Churn.csv\")\ndf.head()","8327186c":"df[\"MonthlyCharges\"] = df[\"MonthlyCharges\"].apply(float)\ndf[\"TotalCharges\"] = df[\"TotalCharges\"].replace(' ',None) # to ensure that TotalCharges can be successfully converted to a float column\ndf[\"TotalCharges\"] = df[\"TotalCharges\"].apply(float)\ndf.isnull().sum()","b015748e":"plt.figure()\nsns.countplot(x=\"gender\", data=df)\nplt.figure()\nsns.countplot(x=\"gender\", hue=\"Churn\", data=df)","def7fc59":"plt.figure()\nsns.countplot(x=\"SeniorCitizen\", data=df)\nplt.figure()\nsns.countplot(x=\"SeniorCitizen\", hue=\"Churn\", data=df)","2b085dff":"plt.figure()\nsns.countplot(x=\"Partner\", data=df)\nplt.figure()\nsns.countplot(x=\"Partner\", hue=\"Churn\", data=df)","396e4c7f":"plt.figure()\nsns.countplot(x=\"Dependents\", data=df)\nplt.figure()\nsns.countplot(x=\"Dependents\", hue=\"Churn\", data=df)","d0f65111":"plt.figure()\nsns.countplot(x=\"PhoneService\", data=df)\nplt.figure()\nsns.countplot(x=\"PhoneService\", hue=\"Churn\", data=df)","19561e05":"plt.figure()\nsns.countplot(x=\"MultipleLines\", data=df)\nplt.figure()\nsns.countplot(x=\"MultipleLines\", hue=\"Churn\", data=df)","394f81f2":"plt.figure()\nsns.countplot(x=\"InternetService\", data=df)\nplt.figure()\nsns.countplot(x=\"InternetService\", hue=\"Churn\", data=df)","048b2e70":"plt.figure()\nsns.countplot(x=\"OnlineSecurity\", data=df)\nplt.figure()\nsns.countplot(x=\"OnlineSecurity\", hue=\"Churn\", data=df)","f080c8e4":"plt.figure()\nsns.countplot(x=\"OnlineBackup\", data=df)\nplt.figure()\nsns.countplot(x=\"OnlineBackup\", hue=\"Churn\", data=df)","f9e1d753":"plt.figure()\nsns.countplot(x=\"DeviceProtection\", data=df)\nplt.figure()\nsns.countplot(x=\"DeviceProtection\", hue=\"Churn\", data=df)","033b70fe":"plt.figure()\nsns.countplot(x=\"TechSupport\", data=df)\nplt.figure()\nsns.countplot(x=\"TechSupport\", hue=\"Churn\", data=df)","a837e365":"plt.figure()\nsns.countplot(x=\"StreamingTV\", data=df)\nplt.figure()\nsns.countplot(x=\"StreamingTV\", hue=\"Churn\", data=df)","0aa967cf":"plt.figure()\nsns.countplot(x=\"StreamingMovies\", data=df)\nplt.figure()\nsns.countplot(x=\"StreamingMovies\", hue=\"Churn\", data=df)","e9f78db8":"plt.figure()\nsns.countplot(x=\"Contract\", data=df)\nplt.figure()\nsns.countplot(x=\"Contract\", hue=\"Churn\", data=df)","ffde6376":"plt.figure()\nsns.countplot(x=\"PaperlessBilling\", data=df)\nplt.figure()\nsns.countplot(x=\"PaperlessBilling\", hue=\"Churn\", data=df)","3ff05df3":"plt.figure()\nsns.countplot(x=\"PaymentMethod\", data=df)\nplt.figure()\nsns.countplot(x=\"PaymentMethod\", hue=\"Churn\", data=df)","934130d6":"sns.countplot(x=\"Churn\", data=df)","3c3302e6":"sns.distplot(df[\"tenure\"].tolist())","9841672b":"df[\"tenure\"].describe()","9501f29c":"sns.distplot(df[\"MonthlyCharges\"].tolist())","12477b55":"sns.distplot(df[\"TotalCharges\"].tolist())","cda46e19":"sns.scatterplot(x=\"TotalCharges\", y=\"tenure\", hue=\"Churn\",\n                     data=df)","db8888da":"sns.scatterplot(x=\"MonthlyCharges\", y=\"tenure\", hue=\"Churn\",\n                     data=df)","c9f96893":"sns.scatterplot(x=\"MonthlyCharges\", y=\"TotalCharges\", hue=\"Churn\",\n                     data=df)","eb837a65":"label_encoding = {\n                    \"Partner\": {\n                            \"Yes\": 1,\n                            \"No\": 0\n                        },\n                        \"Dependents\": {\n                            \"Yes\": 1,\n                            \"No\": 0\n                        },\n                        \"PhoneService\": {\n                            \"Yes\": 1,\n                            \"No\": 0\n                        },\n                        \"MultipleLines\": {\n                            \"Yes\": 2,\n                            \"No\": 1,\n                            \"No phone service\": 0\n                        },\n                        \"InternetService\": {\n                            \"Fiber optic\": 2,\n                            \"DSL\": 1,\n                            \"No\": 0\n                        },\n                        \"OnlineSecurity\": {\n                            \"Yes\": 2,\n                            \"No\": 1,\n                            \"No internet service\": 0\n                        },\n                        \"OnlineBackup\": {\n                            \"Yes\": 2,\n                            \"No\": 1,\n                            \"No internet service\": 0\n                        },\n                        \"DeviceProtection\": {\n                            \"Yes\": 2,\n                            \"No\": 1,\n                            \"No internet service\": 0\n                        },\n                        \"TechSupport\": {\n                            \"Yes\": 2,\n                            \"No\": 1,\n                            \"No internet service\": 0\n                        },\n                        \"StreamingTV\": {\n                            \"Yes\": 2,\n                            \"No\": 1,\n                            \"No internet service\": 0\n                        },\n                        \"StreamingMovies\": {\n                            \"Yes\": 2,\n                            \"No\": 1,\n                            \"No internet service\": 0\n                        },\n                        \"Contract\": {\n                            \"Two year\": 2,\n                            \"One year\": 1,\n                            \"Month-to-month\": 0\n                        },\n                        \"PaymentMethod\": {\n                            \"Credit card (automatic)\": 1,\n                            \"Bank transfer (automatic)\": 1,\n                            \"Mailed check\": 0,\n                            \"Electronic check\": 0\n                        },\n                        \"Churn\": {\n                            \"Yes\": 1,\n                            \"No\": 0\n                        },\n                        \"gender\": {\n                            \"Male\": 1,\n                            \"Female\": 0\n                        }\n                    }\n\nfor column, val_mapping in label_encoding.items():\n    df[column] = df[column].apply(lambda i: val_mapping[i])\ndf.head()","1ed8506c":"std_cols = [\"MonthlyCharges\", \"TotalCharges\"]\nfor column in std_cols:\n    df[column] = df[column].apply(lambda i: (i-df[column].mean()) \/ df[column].std())\ndf.head()","b01979c6":"new_tenure = []\nfor i in df[\"tenure\"]:\n    if i <= 12:\n        new_tenure.append(0)\n    elif i <= 24:\n        new_tenure.append(1)\n    elif i <= 36:\n        new_tenure.append(2)\n    elif i <= 48:\n        new_tenure.append(3)\n    elif i <= 60:\n        new_tenure.append(4)\n    else:\n        new_tenure.append(5)\ndf[\"tenure\"] = new_tenure\ndf[\"tenure\"].head()","94e0e2fc":"df[\"Responsibility_Score\"] = (df[\"Partner\"] + df[\"Dependents\"] + df[\"SeniorCitizen\"]) \/ 3\ndf[\"Phone_Reliance\"] = (df[\"PhoneService\"] + df[\"MultipleLines\"]) \/ 2\ndf[\"Support\"] = (df[\"OnlineSecurity\"] + df[\"OnlineBackup\"] + df[\"DeviceProtection\"] + df[\"TechSupport\"]) \/ 4\ndf[\"Online_Services\"] = (df[\"InternetService\"] + df[\"StreamingTV\"] + df[\"StreamingMovies\"]) \/ 3\ndf[\"Duration\"] = (df[\"tenure\"] + df[\"Contract\"]) \/ 2","c5087327":"drop_cols = [\"PaperlessBilling\",\"Partner\", \"Dependents\", \"SeniorCitizen\", \"PhoneService\", \"MultipleLines\",\n            \"OnlineSecurity\", \"OnlineBackup\", \"DeviceProtection\", \"TechSupport\",\n            \"InternetService\", \"StreamingTV\", \"StreamingMovies\",\n            \"tenure\", \"Contract\"]\ndf = df.drop(drop_cols, axis=1)\ndf.head()","e1e272e0":"# Train Test Split\ntrain_df, test_df = train_test_split(df, test_size=0.2, random_state=100, stratify=df[\"Churn\"].tolist())\ntrain_X = train_df.drop([\"customerID\", \"Churn\"], axis=1).values\ntrain_Y = train_df[\"Churn\"].tolist()\ntest_X = test_df.drop([\"customerID\", \"Churn\"], axis=1).values\ntest_Y = test_df[\"Churn\"].tolist()\n\n# Oversample using SMOTE\nsampler = SMOTE(random_state=100, k_neighbors=7)\ntrain_X, train_Y = sampler.fit_resample(train_X, train_Y)\n\n# Train Model\n# rf = RandomForestClassifier()\n# model = RandomizedSearchCV(estimator = rf, param_distributions = random_grid, n_iter = 10, cv = 3, verbose=2, random_state=100, n_jobs = -1)\nmodel = KNeighborsClassifier(n_neighbors=5)\nmodel.fit(train_X, train_Y)","564dc52a":"predictions = model.predict(test_X)\nprediction_proba = model.predict_proba(test_X)","37db5287":"report_ = []\nlines = classification_report(test_Y, predictions).split('\\n')\nfor l in lines[2:-4]:\n    row_ = l.split()\n    if len(row_) != 0:\n        row = {}\n        row['precision'] = float(row_[-4])\n        row['recall'] = float(row_[-3])\n        row['f1_score'] = float(row_[-2])\n        row['support'] = float(row_[-1])\n        row['class'] = {1: \"Churn\", 0: \"No Churn\"}[int(row_[0])]\n        report_.append(row)\ndataframe = pd.DataFrame.from_dict(report_)\ndataframe.head()","af36e933":"print(\"ROC AUC Score: {}\\n\\n\".format(roc_auc_score(test_Y, prediction_proba[:, 1])))\nprint(\"Accuracy Score: {}\\n\\n\".format(accuracy_score(test_Y, predictions)))\n\nconfusion_mat = confusion_matrix(test_Y, predictions, labels=[0, 1])\n_row = confusion_mat.sum(axis=0)\n_col = [np.nan] + list(confusion_mat.sum(axis=1)) + [sum(_row)]\ncon_df = pd.DataFrame({})\ncon_df[\"Predicted\"] = [\"Actual\"] + [\"No Churn\", \"Churn\"] + [\"All\"]\nfor label, idx in {\"No Churn\": 0, \"Churn\": 1}.items():\n    temp = [np.nan] + list(confusion_mat[:, idx]) + [_row[idx]]\n    con_df[label] = temp\n\ncon_df[\"All\"] = _col\nprint(\"Confusion Matrix\\n\")\ncon_df","b1fc8651":"sorted_proba = [y for _, y in sorted(zip(prediction_proba[:, -1], test_Y), reverse = True)] # sorting with predicted probabilities of churning as key\ny_cum = np.append([0], np.cumsum(sorted_proba)) # cumulative sum of true labels sorted previously\ntotal_points = len(test_Y) # total number of plot points\nclass_1_count = np.sum(test_Y) # Number of true churn samples\nx_points = np.arange(0, total_points + 1) # generate data points for x axis\nrandom_model_area = auc([0, total_points], [0, class_1_count]) # area under random model\nperfect_model_area = auc([0, class_1_count, total_points], [0, class_1_count, class_1_count]) # area under perfect model\ntrained_model_area = auc(x_points, y_cum) # area under trained model\nperfect_vs_random = perfect_model_area - random_model_area # area between perfect and random model\ntrained_vs_random = trained_model_area - random_model_area # area between trained and random model\naccuracy_rate = trained_vs_random \/ perfect_vs_random # accuracy rate\n\nplt.figure(figsize = (20, 12))\nplt.plot([0, 100], [0, 100], c = 'r', linestyle = '--', label = 'Random Model with Area: {}'.format(random_model_area))\nplt.plot([0, (class_1_count\/total_points)*100, 100], \n        [0, 100, 100], \n        c = 'grey', \n        linewidth = 2, \n        label = 'Perfect Model with Area: {}'.format(perfect_model_area))\ncum = (np.cumsum(sorted_proba)\/class_1_count)*100\ncum = [cum[i] for i in range(0, len(cum), len(cum)\/\/100)]\ny_values = np.append([0], cum[-100:])\nx_values = np.arange(0, 101)\nplt.plot(x_values, \n        y_values, \n        c = 'b', \n        label = \"KNNClassifier with Area: {}\".format(trained_model_area), \n        linewidth = 4)\nplt.xlabel('Total observations (%)', fontsize = 16)\nplt.ylabel('Churn observations (%)', fontsize = 16)\nplt.title('Cumulative Accuracy Profile with Accuracy Rate: {}'.format(accuracy_rate), fontsize = 16)\nplt.legend(loc = 'lower right', fontsize = 16)\n","b8d65ce3":"print(\"Our Model Has Selected 500 Customers Out of {} Customers and Managed to Identify {} Churn Cases Out of a Total of {} Churn Cases\"\\\n     .format(len(sorted_proba), sum(sorted_proba[:500]), sum(sorted_proba)))","e4279c2d":"## Exploratory Data Analysis <a class=\"anchor\" id=\"3\"><\/a>\n\n### Observations\n- There are no null values\n- *gender*: There seems to be an equal distribution of males and females with respect to churn intention\n- *SeniorCitizen*: There are much fewer senior citizens and there is a larger proportion of senior citizens churning\n- *Partner*: There seems to be an equal distribution of people having and not having partners, there is also a larger proportion of people with partners churning\n- *Dependents*: There are much fewer people with dependents, there is a larger proportion of people with no dependents churning\n- *PhoneService*: There are many more people with a phone service\n- *MultipleLines*: The numbers of people who have and do not have multiple lines are similar\n- *InternetService*: There are many more people who has an internet service and there is a large proportion of people with fiber optic internet service who intend to churn\n- *OnlineSecurity*: For those with an internet service, there are more people with no online security and a large proportion of the same group of people has churned.\n- *OnlineBackup*: For those with an internet service, there are more people with no online backup and a large proportion of the same group of people has churned\n- *DeviceProtection*: For those with an internet service, there are more people with no device protection and a large proportion of the same group of people has churned\n- *TechSupport*: For those with an internet service, there are more people with no tech support and a large proportion of the same group of people has churned\n- *StreamingTV*: There seems to be an equal distribution of people who did and did not have streaming tv with respect to churn intention\n- *StreamingMovies*: There seems to be an equal distribution of people who did and did not have streaming movies with respect to churn intention\n- *Contract*: There are many more people who are on a month-to-month contract and a large proportion of this group of people has churned\n- *PaperlessBilling*: The number of people with paperless billing is quite similar to that with\n- *PaymentMethod*: There are more people adopting electronic check as a payment method and a large proportion of them has churned\n- *Churn*: The number of churn cases is significantly fewer than that of non-churn ones\n- *tenure*: The distribution of tenure periods seems to be quite even except that for two peaks at the extreme ends\n- *MonthlyCharges*: Highest peak appears at the lower spectrum of values\n- *TotalCharges*: Distribution of values is right skewed","aef5505e":"## Table of Contents\n\n1. [Import Packages](#1)\n2. [Import Data](#2)\n3. [Exploratory Data Analysis](#3)\n4. [Preprocess Data](#4)\n5. [Trivial Feature Engineering](#5)\n6. [Train Model](#6)\n7. [Evaluation](#7)\n8. [Further Evaluation with CAP](#8)\n9. [Conclusion](#9)\n10. [References](#10)","98b9dc2e":"## Preprocess Data <a class=\"anchor\" id=\"4\"><\/a>\n\n\n\n### Columns\n\n- customerID\n    - Insignificant to the classification task\n- gender\n    - Unique values are male and female, we can choose to let 1 and 0 represent male and female respectively\n- SeniorCitizen\n    - Unique values are 1 and 0, with 1 meaning that the customer is a senior citizen, so no preprocessing is needed\n- Partner\n    - Unique values are yes and no, we can choose to let 1 and 0 represent yes and no respectively\n- Dependents\n    - Unique values are yes and no, we can choose to let 1 and 0 represent yes and no respectively\n- tenure\n    - Binning all the values, 5 buckets, multiples of 12\n- PhoneService\n    - Unique values are yes and no, we can choose to let 1 and 0 represent yes and no respectively\n- MultipleLines\n    - Unique values are yes, no and no phone service, we can choose to let 0, 1 and 2 represent no phone service, no and yes respectively\n- InternetService\n    - Unique values are dsl, fiber optic and no, we can choose to let 0, 1 and 2 represent no, dsl and fiber optic respectively. Also, fiber optic's speed is much faster than dsl\n- OnlineSecurity\n    - Unique values are yes, no and no internet service, we can choose to let 0, 1 and 2 represent no internet service, no and yes\n- OnlineBackup\n    - Unique values are yes, no and no internet service, we can choose to let 0, 1 and 2 represent no internet service, no and yes\n- DeviceProtection\n    - Unique values are yes, no and no internet service, we can choose to let 0, 1 and 2 represent no internet service, no and yes\n- TechSupport\n    - Unique values are yes, no and no internet service, we can choose to let 0, 1 and 2 represent no internet service, no and yes\n- StreamingTV\n    - Unique values are yes, no and no internet service, we can choose to let 0, 1 and 2 represent no internet service, no and yes\n- StreamingMovies\n    - Unique values are yes, no and no internet service, we can choose to let 0, 1 and 2 represent no internet service, no and yes\n- Contract\n    - Unique values are month-to-month, one year and two year, we can choose to let 0, 1 and 2 represent month-to-month, one year and two year\n- PaperlessBilling\n    - Unique values are yes and no, but I would choose to drop this column as I believe that it has no causation effect on whether a customer churns\n- PaymentMethod\n    - Unique values are Credit card (automatic), Bank transfer (automatic), Mailed check, Electronic check and they will represented by values 1, 1, 0 and 0 respectively. Automatic methods would create more convenience for the customers\n- MonthlyCharges\n    - Standardization would be applied\n- Total Charges\n    - Standardization would be applied\n- Churn\n    - Unique values are yes and no, we can choose to let 0 and 1 represent non-churn and churn cases respectively","cf5c1203":"## Further Evaluation with CAP <a class=\"anchor\" id=\"8\"><\/a>","1406dc8f":"## Evaluation <a class=\"anchor\" id=\"7\"><\/a>","87758760":"### Typical Metrics","485594f4":"### Obtain CAP Curve and Accuracy Rate","752d1ea5":"### Drop Columns","69820425":"# Evaluating A Churn Prediction Model with CAP Curve\n\nThe aim of this notebook is to provide further explanations on how to use a Cumulative Accuracy Profile (CAP) curve to evaluate a churn prediction model on its ability to allocate resources optimally.\n\n## Example Problem Statement\n\nIf your business has 500 discount vouchers to give out to a population of 1409 customers and there are 374 customers who actually wishes to churn, how do you select 500 out of these 1409 customers to give the vouchers to so as to maximize the number of churn cases present within these selected 500 customers?\n\nNOTE: The numbers 1409 and 374 are based on the test set generated later in this notebook. Use the same random state to get the same results!","ce05bfa6":"## Import Packages <a class=\"anchor\" id=\"1\"><\/a>","b21a6d40":"## Conclusion <a class=\"anchor\" id=\"9\"><\/a>\n\nThe CAP curve and related metrics are useful in evaluating a churn prediction model's capability in optimal allocation of resources. The model used in this notebook has achieved decent performance by first picking 500 customers to give vouchers to as a preventive measure of churn and then successfully identifying 259 churn cases.\n\nBetter models would be able to identify many more churn cases within 500 selected customers, hence enhancing the effectiveness of the preventive measure of churn.\n\nModels' performances in reducing costs and enhancing effectiveness of preventive measures of churn can be assessed to be exceptional based on the number of churn cases identified within a fixed number of customers or the number of customers required to identify all the churn cases.","6b6a3b39":"## Trivial Feature Engineering <a class=\"anchor\" id=\"5\"><\/a>\n\n- Responsibility_Score: Average of partner, dependents and senior citizen to determine a score which determines the amount of life-related responsibility one has.\n- Phone_Reliance: Average of PhoneService and MultipleLines to determine a score which determines the extent of reliance one has on phone service.\n- Support: Average of InternetService, StreamingTV and StreamingMovies to determine a score which determines the amount of support services one has.\n- Duration: Average of tenure and contract to determine an aggregation score of time-related factors","b42eb893":"### Standardizing","08d61d76":"## References <a class=\"anchor\" id=\"10\"><\/a>\n\n- https:\/\/www.kaggle.com\/pavanraj159\/telecom-customer-churn-prediction\n- https:\/\/towardsdatascience.com\/machine-learning-classifier-evaluation-using-roc-and-cap-curves-7db60fe6b716","1373b08a":"### Binning","c5b95ae2":"## Train Model <a class=\"anchor\" id=\"6\"><\/a>","fbc8acc7":"### Ordinal Encoding"}}