{"cell_type":{"f966ca84":"code","a4d24ab0":"code","66b789bf":"code","050275c4":"code","20847d7b":"code","c0f65f8d":"code","7b403a9b":"code","c0d4e293":"code","c529dcf6":"code","304f652a":"code","42728f3b":"code","97e7a57e":"markdown","7e0847bf":"markdown","3148a6f9":"markdown","5a6a8e5c":"markdown"},"source":{"f966ca84":"import math\nimport shutil\nimport numpy as np\nimport pandas as pd\nimport tensorflow as tf\nfrom tensorflow import keras\nfrom keras.preprocessing.image import ImageDataGenerator\nfrom keras.callbacks import ModelCheckpoint, EarlyStopping\nfrom datetime import datetime, timedelta\nfrom sklearn.model_selection import train_test_split\nimport os\n\ntf.logging.set_verbosity(tf.logging.INFO)\npd.options.display.max_rows = 10\npd.options.display.float_format = '{:.1f}'.format","a4d24ab0":"output_dir = \".\"\nOUTDIR = \".\"\nOUTPUT_RESULT=\"submission.csv\"\n#Hyper prameters\nINPUT_SHAPE = (28, 28, 1)\nSCALE = 10\nBATCH_SIZE=2048\nROWS_TO_READ=42000\nROWS_TO_SKIP=1\nLEARNING_RATE=0.001\nSTEPS_TO_PROCESS=42000\nnum_classes=10\n\n# input image dimensions\nimg_rows, img_cols = 28, 28","66b789bf":"df = type('', (), {})()\nprint(datetime.now())\ndf.train = pd.read_csv('..\/input\/train.csv', sep=\",\", skiprows=range(1,ROWS_TO_SKIP),nrows=ROWS_TO_READ)\nprint(datetime.now())\ndf.test = pd.read_csv('..\/input\/test.csv', sep=\",\")\nprint(datetime.now())\n#df.train.head(10)\ndf.train.describe()","050275c4":"df.labels = df.train['label'] #get target training values\ndf.labels = keras.utils.to_categorical(df.labels.values.astype('int32') , num_classes) # identify how many numbers to train\ndf.train = df.train.drop(columns='label', axis=1) #remove so only image data remains\ndf.train = df.train\/255 # normalize data so rance is 0.0 to 1.0\ndf.test = df.test\/255 # normalize data so rance is 0.0 to 1.0\ndf.train = df.train.values.astype('float32') # change all pixel values to float and numpy matrix\ndf.test = df.test.values.astype('float32')\ndf.train = df.train.reshape(df.train.shape[0], img_rows, img_cols, 1) #change change image correct shape 1x784 to 28by28\ndf.test = df.test.reshape(df.test.shape[0], img_rows, img_cols, 1)\ndf.trainX = df.train\ndf.labelsX = df.labels","20847d7b":"datagen = ImageDataGenerator(\n        rotation_range=17,\n        zoom_range=0.1,\n        width_shift_range=0.1,\n        height_shift_range=0.1,\n        horizontal_flip=False,\n        fill_mode='nearest')\ndatagen.fit(df.trainX, augment=True)\ni=15\nfor xbatch,ybatch in datagen.flow(df.trainX, df.labelsX, batch_size=BATCH_SIZE*200):\n    df.train=np.append(df.train,xbatch)\n    df.labels=np.append(df.labels,ybatch)\n    i=i-1\n    if i==0:\n        break;","c0f65f8d":"df.train = df.train.reshape(int(df.train.shape[0]\/img_rows\/img_cols), img_rows, img_cols, 1)\ndf.labels = df.labels.reshape(int(df.labels.shape[0]\/10),10)","7b403a9b":"\nimport matplotlib.pyplot as plt\nplt.imshow(df.train[100000].reshape(28,28),cmap='gray')\nplt.show()","c0d4e293":"checkpointer = ModelCheckpoint(filepath=\".\/weights.hdf5\",\n                               verbose=1, save_best_only=True)\nearlystopper = EarlyStopping(monitor='val_loss', min_delta=0,\n                             patience=4, verbose=1, mode='auto')","c529dcf6":"df.X_train, df.X_test, df.y_train, df.y_test = train_test_split(df.train, df.labels,\n                                                    test_size=0.1,\n                                                    random_state=42)","304f652a":"model = keras.Sequential()\nmodel.add(keras.layers.Conv2D(32, kernel_size=(3, 3),\n                 input_shape=INPUT_SHAPE))\nmodel.add(keras.layers.LeakyReLU(alpha=0.1))\nmodel.add(keras.layers.Conv2D(64, (3, 3)))\nmodel.add(keras.layers.LeakyReLU(alpha=0.1))\nmodel.add(keras.layers.MaxPooling2D(pool_size=(2, 2)))\nmodel.add(keras.layers.Conv2D(64, (3, 3)))\nmodel.add(keras.layers.LeakyReLU(alpha=0.1))\nmodel.add(keras.layers.MaxPooling2D(pool_size=(2, 2)))\nmodel.add(keras.layers.Dropout(0.25))\nmodel.add(keras.layers.Flatten())\nmodel.add(keras.layers.Dense(128))\nmodel.add(keras.layers.LeakyReLU(alpha=0.1))\nmodel.add(keras.layers.Dropout(0.5))\nmodel.add(keras.layers.Dense(num_classes, activation='softmax'))\n\nmodel.compile(optimizer=tf.train.AdamOptimizer(LEARNING_RATE),\n              loss='categorical_crossentropy',\n              metrics=['accuracy'])\n\nmodel.fit(df.X_train, df.y_train,\n          batch_size=BATCH_SIZE,\n          epochs=45,shuffle=True,\n          validation_data=(df.X_test, df.y_test),\n          callbacks=[checkpointer, earlystopper])","42728f3b":"df.pred = model.predict(df.test)\nx = [np.where(r==max(r))[0]  for r in df.pred]\nflat_list = [item for sublist in x for item in sublist]\npred=pd.DataFrame({'Label':flat_list})\nidx=pd.DataFrame({'ImageId':range(1,len(pred)+1)})\nsubmission=pd.concat([idx,pred],axis=1)\nsubmission.to_csv(OUTPUT_RESULT,index=False)\nsubmission.describe()","97e7a57e":"# Read the data set","7e0847bf":"   # Remove labels and normalize","3148a6f9":"# Constants and Hyper-parameters","5a6a8e5c":"# Keras and Tensorflow\nCode taken from https:\/\/github.com\/keras-team\/keras\/blob\/master\/examples\/mnist_cnn.py"}}