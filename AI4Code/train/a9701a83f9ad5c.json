{"cell_type":{"174a7203":"code","eed4793d":"code","7b47bd56":"code","4b3c3b34":"code","6293060c":"code","e68af32e":"code","8191a981":"code","4390eac4":"code","7f2092f0":"code","6ade0d70":"code","4279dccf":"code","a95177e9":"code","c8a41d69":"code","7bdf3bea":"code","41980768":"code","4c805793":"code","1456a0c7":"code","6fc6d93f":"code","f459fd91":"code","ef21b1ef":"code","22a6bf6b":"code","84cd66b3":"code","7746d6a6":"code","8adbd92e":"code","2190a3e4":"code","74f95c83":"code","a0a0985f":"code","8da5bf5c":"code","d832731b":"code","9a6523a4":"code","31421530":"code","2b95db5b":"markdown","30d6c906":"markdown","f6a5f4e3":"markdown","c897da39":"markdown","43b699b4":"markdown","bec5386c":"markdown","599cf74d":"markdown"},"source":{"174a7203":"!pip uninstall --yes opencv-contrib-python opencv-python\n!pip install opencv-contrib-python","eed4793d":"import tensorflow as tf\nimport matplotlib.pyplot as plt\nimport numpy as np\nimport pandas as pd\nimport cv2\nimport os\nimport random\nimport warnings\nwarnings.filterwarnings(\"ignore\")","7b47bd56":"print('Image(Train):',len(os.listdir('..\/input\/car-object-detection\/data\/training_images')))\nprint('Image(Test):',len(os.listdir('..\/input\/car-object-detection\/data\/testing_images')))","4b3c3b34":"Data=pd.read_csv('..\/input\/car-object-detection\/data\/train_solution_bounding_boxes (1).csv')","6293060c":"Data.head()","e68af32e":"print('Train data localization:',len(Data))","8191a981":"for i in Data.values:\n  photo=plt.imread(f'..\/input\/car-object-detection\/data\/training_images\/{i[0]}')\n  plt.imshow(photo)\n  print('Photo shape:',photo.shape)\n  print('Name,xmin,ymin,xmax,ymax:',i)\n  pt1=(int(i[1]),int(i[2]))\n  pt2=(int(i[3]),int(i[4]))\n  color=(255, 0, 0)\n  thickness = 2\n  cv2.rectangle(photo,pt1,pt2, color, thickness)\n  plt.figure()\n  plt.imshow(photo)\n  break","4390eac4":"for a,i in enumerate(Data.values):\n  img=plt.imread('..\/input\/car-object-detection\/data\/training_images\/'+i[0])\n  print(img.shape)\n  plt.figure()\n  plt.imshow(img)\n  xmin=int(i[1])\n  ymin=int(i[2])\n  xmax=int(i[3])\n  ymax=int(i[4])\n  cv2.rectangle(img,(xmin, ymin),(xmax, ymax),(255, 0, 0),2)\n  plt.figure()\n  plt.imshow(img)\n  if a ==2:\n    break","7f2092f0":"cv2.setUseOptimized(True) # Optimeze\nss = cv2.ximgproc.segmentation.createSelectiveSearchSegmentation() # Selective search obje","6ade0d70":"im = cv2.imread('..\/input\/car-object-detection\/data\/training_images\/vid_4_1000.jpg')\nim=cv2.resize(im,(224,224))\nplt.figure()\nplt.imshow(im)\nss.setBaseImage(im) # G\u00d6r\u00fcnt\u00fcn\u00fcn y\u00fcklendi\u011fi k\u0131s\u0131m\nss.switchToSelectiveSearchFast() # Selective Search s\u00fcresini h\u0131zland\u0131rmak i\u00e7in\nrects = ss.process()\nprint('Shape:',im.shape)\nprint('possible bounty boxes:',len(rects))\n\nfor rect in rects:\n  x, y, w, h = rect\n  imOut=cv2.rectangle(im, (x, y), (x+w, y+h), (0, 255, 0), 1, cv2.LINE_AA)\nplt.figure()\nplt.imshow(imOut);","4279dccf":"#Iou and selective search \ncv2.setUseOptimized(True)\nss = cv2.ximgproc.segmentation.createSelectiveSearchSegmentation()\ndef get_iou(bb1, bb2):\n\n    assert bb1['x1'] < bb1['x2'] #bb1\n    assert bb1['y1'] < bb1['y2']\n\n    assert bb2['x1'] < bb2['x2'] #bb2\n    assert bb2['y1'] < bb2['y2'];\n\n    x_left = max(bb1['x1'], bb2['x1'])\n    y_top = max(bb1['y1'], bb2['y1'])\n    x_right = min(bb1['x2'], bb2['x2'])\n    y_bottom = min(bb1['y2'], bb2['y2'])\n\n    if x_right < x_left or y_bottom < y_top:\n      return 0.0\n    intersection_area = (x_right - x_left) * (y_bottom - y_top)\n    bb1_area = (bb1['x2'] - bb1['x1']) * (bb1['y2'] - bb1['y1'])\n    bb2_area = (bb2['x2'] - bb2['x1']) * (bb2['y2'] - bb2['y1'])\n    iou = intersection_area \/ float(bb1_area + bb2_area - intersection_area)\n    assert iou >= 0.0\n    assert iou <= 1.0\n    return iou","a95177e9":"image_liste=[]\nk=0\nl=0\nz=0 #Loading\nfor a in pd.read_csv('..\/input\/car-object-detection\/data\/train_solution_bounding_boxes (1).csv').values:\n  Name,xmin,ymin,xmax,ymax=a\n  bb1={ #ger\u00e7ek bounty boxxes\n            'x1':int(xmin),\n            'y1':int(ymin),\n            'x2':int(xmax),\n            'y2':int(ymax)\n            }\n  try:\n    img=cv2.imread('..\/input\/car-object-detection\/data\/training_images\/'+Name)\n    ss.setBaseImage(img)\n    ss.switchToSelectiveSearchFast()\n    rects = ss.process()\n    for i in rects:\n      x, y, w, h = i # Selective bounty boxxes\n      bb2={'x1':x, \n          'y1':y,\n          'x2':x+w,\n          'y2':y+h\n          }\n      img1=img[bb2['y1']:bb2['y2'],bb2['x1']:bb2['x2']] # Crop img\n      img1_shape=cv2.resize(img1,(224,224))\n      if k<l:\n            if 0.5<get_iou(bb1,bb2):  \n              image_liste.append([img1_shape,1])\n              k+=1\n      else:\n        if 0.5<get_iou(bb1,bb2):  \n          image_liste.append([img1_shape,1])\n          k+=1\n        else:\n          image_liste.append([img1_shape,0])\n          l+=1\n  except Exception as e:\n    print('hata var',e)\n  z+=1\n  print(Name,z,len(rects))","c8a41d69":"len(image_liste)","7bdf3bea":"data=[]\ndata_label=[]\nfor features,label in image_liste:\n  data.append(features)\n  data_label.append(label)\nprint('i\u015flem ba\u015far\u0131l\u0131')","41980768":"print('Foto\u011fraf say\u0131s\u0131:',len(data),'|Label say\u0131s\u0131:',len(data_label))","4c805793":"i=random.randint(1,10583)\nprint('Class:',data_label[i])\nprint('G\u00f6r\u00fcnt\u00fc boyutu:',data[i].shape)\nplt.imshow(data[i]);","1456a0c7":"data=np.asarray(data)\ndata_label=np.asarray(data_label) ","6fc6d93f":"print('Araba g\u00f6r\u00fcnt\u00fcs\u00fc yok:',len(data_label[data_label==0]),'|Araba g\u00f6r\u00fcnt\u00fcs\u00fc var:',len(data_label[data_label==1]))","f459fd91":"data.shape","ef21b1ef":"data_label.shape","22a6bf6b":"from sklearn.model_selection import train_test_split\n\nx_train,x_val,y_train,y_val=train_test_split(data,data_label,test_size=0.33, random_state=42)","84cd66b3":"print('x_train shape:',x_train.shape)\nprint('x_val shape:',x_val.shape)\nprint('y_train shape:',y_train.shape)\nprint('y_val shape:',y_val.shape)","7746d6a6":"base_model=tf.keras.applications.VGG16(include_top=False,input_shape=(224,224,3),weights='imagenet')","8adbd92e":"base_model.summary()","2190a3e4":"model=tf.keras.Sequential()\nmodel.add(base_model)\nmodel.add(tf.keras.layers.GlobalAveragePooling2D())\nmodel.add(tf.keras.layers.Dropout(0.5))\nmodel.add(tf.keras.layers.Dense(1,activation='sigmoid'))","74f95c83":"model.summary()","a0a0985f":"base_model.trainable=False","8da5bf5c":"for i,layer in enumerate(base_model.layers):\n  print(i,layer.name,'-',layer.trainable)","d832731b":"model.compile(loss='binary_crossentropy',optimizer=tf.keras.optimizers.Adam(),metrics='accuracy')","9a6523a4":"epoch=4\nhist=model.fit(x_train,y_train,epochs=epoch,validation_data=(x_val,y_val))","31421530":"car=[]\nphoto_path='..\/input\/car-object-detection\/data\/testing_images\/vid_5_27620.jpg'\ndeneme_img=cv2.imread(photo_path)\nss.setBaseImage(deneme_img)\nss.switchToSelectiveSearchFast()\nrects1 = ss.process()\nprint('Foto\u011fraftaki muhtemel obje say\u0131s\u0131: ',len(rects1))\nfor i in rects1:\n  x, y, w, h = i\n  bb3={'x1':x,\n        'y1':y,\n        'x2':x+w,\n        'y2':y+h\n      }\n  try:\n    assert bb3['x1'] < bb3['x2']\n    assert bb3['y1'] < bb3['y2']\n    img_data=deneme_img[bb3['y1']:bb3['y2'],bb3['x1']:bb3['x2']]\n    img_data=cv2.resize(img_data,(224,224))\n    tahmin=model.predict(img_data.reshape(1,224,224,3))\n    if tahmin[0]>0.5:\n      car.append([bb3,tahmin[0]])\n    else:\n      pass\n  except Exception as e:\n    print('hata',e)\nprint('ka\u00e7 adet class tahmini 1 olan muhtemel bounty box var:',len(car))\nprint('-------------------------------------------------------------------------')\ndeneme_img=cv2.imread(photo_path)\ncar[np.argmax(np.array(car)[:,1])][0]\npt1=(car[np.argmax(np.array(car)[:,1])][0]['x1'],car[np.argmax(np.array(car)[:,1])][0]['y1'])\npt2=(car[np.argmax(np.array(car)[:,1])][0]['x2'],car[np.argmax(np.array(car)[:,1])][0]['y2'])\nplt.figure()\nplt.imshow(deneme_img)\ncv2.rectangle(deneme_img,pt1,pt2,(255, 0, 0),2)\nplt.figure()\nplt.title(f'Class numaras\u0131 1 olup ihtimal oran\u0131 en y\u00fcksek bounty box score: %{car[np.argmax(np.array(car)[:,1])][1][0]*100}') \nplt.imshow(deneme_img);","2b95db5b":"# Selective serach crop the image iou>0.5 (Kullan\u0131m\u0131)","30d6c906":"### Annotations (Check)","f6a5f4e3":"## Selective search","c897da39":"## Model","43b699b4":"## Deneme","bec5386c":"## Selective Search kullan\u0131m\u0131","599cf74d":"### Data load\n"}}