{"cell_type":{"75ff1a6e":"code","99fe912c":"code","13784939":"code","70debc91":"code","a2728af5":"code","ae05f119":"code","a21e773d":"code","896e81bb":"code","667a30ad":"code","f75f7b3a":"code","b8ec142b":"code","b9f70c3c":"code","e442dead":"code","4823b719":"code","ad03bf1b":"code","36f4675b":"code","60c800e9":"code","88509b78":"code","12a66f99":"code","df36dc59":"code","ca0600cb":"code","965cb0e0":"code","8d951453":"code","37b75208":"markdown","7b47a761":"markdown","2d73777f":"markdown","e1963acc":"markdown","82ed37f3":"markdown","47443314":"markdown","7e6a7a4a":"markdown"},"source":{"75ff1a6e":"import numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\nfrom statsmodels.formula.api import quantreg\n\nimport os","99fe912c":"train = pd.read_csv( '..\/input\/osic-pulmonary-fibrosis-progression\/train.csv' )\ntest  = pd.read_csv( '..\/input\/osic-pulmonary-fibrosis-progression\/test.csv' )\n\ntrain['traintest'] = 0\ntest ['traintest'] = 1\n\nsub   = pd.read_csv( '..\/input\/osic-pulmonary-fibrosis-progression\/sample_submission.csv' )\nsub['Weeks']   = sub['Patient_Week'].apply( lambda x: int(x.split('_')[-1]) )\nsub['Patient'] = sub['Patient_Week'].apply( lambda x: x.split('_')[0] ) \n\nprint( train.shape, test.shape, sub.shape )\n\nsub.head()","13784939":"train.tail(10)","70debc91":"test.tail(10)","a2728af5":"train.Patient.nunique(), sub.Patient.nunique()","ae05f119":"sub.Patient.isin( test.Patient.unique() ).mean()","a21e773d":"train = pd.concat( (train,test) )\ntrain.sort_values( ['Patient','Weeks'], inplace=True )\ntrain.shape","896e81bb":"train.describe()","667a30ad":"train['Age'].hist( bins=100, figsize=(5, 5) )","f75f7b3a":"train['Percent'].hist( bins=100, figsize=(5, 5) )","b8ec142b":"train['FVC'].hist( bins=100, figsize=(5, 5) )","b9f70c3c":"train.groupby( ['Sex','SmokingStatus'] )['FVC'].agg( ['mean','std','count'] )","e442dead":"train.groupby( ['Sex','Age'] )['FVC'].agg( ['mean','std','count'] )","4823b719":"train['Sex']           = pd.factorize( train['Sex'] )[0]\ntrain['SmokingStatus'] = pd.factorize( train['SmokingStatus'] )[0]\ntrain","ad03bf1b":"train['Percent']       = (train['Percent'] - train['Percent'].mean()) \/ train['Percent'].std()\ntrain['Age']           = (train['Age'] - train['Age'].mean()) \/ train['Age'].std()\ntrain['Sex']           = (train['Sex'] - train['Sex'].mean()) \/ train['Sex'].std()\ntrain['SmokingStatus'] = (train['SmokingStatus'] - train['SmokingStatus'].mean()) \/ train['SmokingStatus'].std()\ntrain.head(10)","36f4675b":"modelL = quantreg('FVC ~ Weeks+Percent+Age+Sex+SmokingStatus', train).fit( q=0.15 )\nmodel  = quantreg('FVC ~ Weeks+Percent+Age+Sex+SmokingStatus', train).fit( q=0.50 )\nmodelH = quantreg('FVC ~ Weeks+Percent+Age+Sex+SmokingStatus', train).fit( q=0.85 )\nprint(model.summary())","60c800e9":"train['ypredL'] = modelL.predict( train ).values\ntrain['ypred']  = model.predict( train ).values\ntrain['ypredH'] = modelH.predict( train ).values\ntrain['ypredstd'] = 0.5*np.abs(train['ypredH'] - train['ypred'])+0.5*np.abs(train['ypred'] - train['ypredL'])\ntrain.head(10)","88509b78":"def metric( trueFVC, predFVC, predSTD ):\n    \n    clipSTD = np.clip( predSTD, 70 , 9e9 )  \n    \n    deltaFVC = np.clip( np.abs(trueFVC-predFVC), 0 , 1000 )  \n\n    return np.mean( -1*(np.sqrt(2)*deltaFVC\/clipSTD) - np.log( np.sqrt(2)*clipSTD ) )\n    \n\nprint( 'Metric:', metric( train['FVC'].values, train['ypred'].values, train['ypredstd'].values  ) )","12a66f99":"dt = train.loc[ train.traintest==1 ,['Patient','Percent','Age','Sex','SmokingStatus']]\ntest = pd.merge( sub, dt, on='Patient', how='left' )\ntest.sort_values( ['Patient','Weeks'], inplace=True )\ntest.head(10)","df36dc59":"test['ypredL'] = modelL.predict( test ).values\ntest['FVC']    = model.predict( test ).values\ntest['ypredH'] = modelH.predict( test ).values\ntest['Confidence'] = np.abs(test['ypredH'] - test['ypredL']) \/ 2\n\ntest.head(10)","ca0600cb":"test[['Patient_Week','FVC','Confidence']].to_csv('submission.csv', index=False)\ntest[['Patient_Week','FVC','Confidence']].head(10)","965cb0e0":"test.loc[ test.Patient=='ID00419637202311204720264'  ].plot( x='Weeks', y='FVC' )\ntest.loc[ test.Patient=='ID00421637202311550012437'  ].plot( x='Weeks', y='FVC' )\ntest.loc[ test.Patient=='ID00422637202311677017371'  ].plot( x='Weeks', y='FVC' )\ntest.loc[ test.Patient=='ID00423637202312137826377'  ].plot( x='Weeks', y='FVC' )\ntest.loc[ test.Patient=='ID00426637202313170790466'  ].plot( x='Weeks', y='FVC' )","8d951453":"test.loc[ test.Patient=='ID00419637202311204720264'  ].plot( x='Weeks', y='Confidence' )\ntest.loc[ test.Patient=='ID00421637202311550012437'  ].plot( x='Weeks', y='Confidence' )\ntest.loc[ test.Patient=='ID00422637202311677017371'  ].plot( x='Weeks', y='Confidence' )\ntest.loc[ test.Patient=='ID00423637202312137826377'  ].plot( x='Weeks', y='Confidence' )\ntest.loc[ test.Patient=='ID00426637202313170790466'  ].plot( x='Weeks', y='Confidence' )","37b75208":"# Fit quantreg models","7b47a761":"# Train have 176 patients and Test only 5\n# Welcome to the uncertainty and LB shake up world!","2d73777f":"# Merge features to test set","e1963acc":"# Calculate competition metric","82ed37f3":"# Concatenate the 5 samples we have in test with the train set","47443314":"# Label encode Strings","7e6a7a4a":"# Manual mean removal + std"}}