{"cell_type":{"b3f0c782":"code","6a564b2d":"code","d537eb8b":"code","ee678341":"code","3331c679":"code","42d282f6":"code","18395a40":"code","8b1ac794":"code","3d09f69d":"code","4ea2988e":"code","18bba542":"code","0a3e1fe0":"code","1e5b7580":"code","32def053":"code","d2ea98cc":"code","1b29a433":"code","fc88d734":"code","4c334dc3":"code","ef64add7":"code","f6092966":"code","64a5d880":"markdown","ac092c90":"markdown","90c7ae12":"markdown","226802f9":"markdown","c96e67da":"markdown","81eb032f":"markdown","77c25a91":"markdown","57ca552d":"markdown","0cd84089":"markdown","deb420f9":"markdown","4bc1bf58":"markdown","53ca540c":"markdown","f99edd18":"markdown","a5416420":"markdown","a1da944b":"markdown","1ddb6a60":"markdown","24c91609":"markdown"},"source":{"b3f0c782":"!pip install seaborn -U --quiet","6a564b2d":"import math\n\nimport matplotlib.patches as mpatches\nimport matplotlib.pyplot as plt\nimport matplotlib.ticker as ticker\nimport numpy as np\nimport pandas as pd\nimport scipy.stats as stats\nimport seaborn as sns\nfrom tqdm.notebook import tqdm\n\nplt.style.use('seaborn')","d537eb8b":"id_columns = [\n    'NU_INSCRICAO', #student unique id\n]\nstatus_columns=[\n    'TP_ST_CONCLUSAO', #high school situation (already over, finishing, ongoing, not on high school) \n]\ngrade_columns_raw = [\n    'NU_NOTA_CN', #grade natural sciencies\n    'NU_NOTA_CH', #grades human sciencies\n    'NU_NOTA_LC', #grades languages and codes\n    'NU_NOTA_MT', #grades math\n    'NU_NOTA_REDACAO', #grades essay\n]\nsocial_economic_columns = [\n    'Q001', #how far did the mother go with her studies\n    'Q002', #how far did the father go with his studies\n    'Q005', #number of people living in the house\n    'Q006', #family income\n]\nschool_columns_raw=[\n    'CO_ESCOLA', #School code\n    'NO_MUNICIPIO_ESC',#School city name\n    'SG_UF_ESC', #School State code\n    'TP_DEPENDENCIA_ADM_ESC', #school dependency(federal gov., state gov., city gov., private)\n]\n\ndf = pd.read_csv('\/kaggle\/input\/enem-2019\/DADOS\/MICRODADOS_ENEM_2019.csv', \n                 delimiter=';',\n                 encoding='ISO-8859-1', \n                 usecols=id_columns + status_columns + grade_columns_raw + social_economic_columns + school_columns_raw)\n\ndf = df.rename(columns={\n    'NU_NOTA_CN': 'Natural Sciences',\n    'NU_NOTA_CH': 'Humanities',\n    'NU_NOTA_LC': 'Languages', \n    'NU_NOTA_MT': 'Mathematics',\n    'NU_NOTA_REDACAO': 'Essay', \n    'TP_DEPENDENCIA_ADM_ESC': 'School type'\n})\n\ndf = df.replace({\n    'School type':{\n        1.0: 'Federal',\n        2.0: 'State',\n        3.0: 'City',\n        4.0: 'Private'\n    },\n    'TP_ST_CONCLUSAO':{\n        1.0: 'Graduated',\n        2.0: '3rd year',\n        3.0: '2nd year or before',\n        4.0: 'Not graduated nor ongoing'\n    }\n})\n\ngrade_columns = [\n    'Natural Sciences',\n    'Humanities',\n    'Languages', \n    'Mathematics',\n    'Essay', \n]\n\nschool_columns=[\n    'CO_ESCOLA', #School code\n    'NO_MUNICIPIO_ESC',#School city name\n    'SG_UF_ESC', #School State code\n    'School type', #school dependency(federal gov., state gov., city gov., private)\n]","ee678341":"df.head()","3331c679":"df.info(null_counts=True)","42d282f6":"#drop non assigned grades and non assigned schools\ndf = df.dropna(subset=grade_columns + school_columns)\n#drop students that are not finishing this year\ndf = df[df['TP_ST_CONCLUSAO']=='3rd year']\n#drop grades 0 in CN, CH, LC, MT, because it should not be possible to receive these grades if you took the test (probably it means that the student missed the test)\ndf = df[df['Natural Sciences']>0]\ndf = df[df['Humanities']>0]\ndf = df[df['Languages']>0]\ndf = df[df['Mathematics']>0]\nprint('High school graduating students that took all the tests:', len(df))","18395a40":"print('Nan Values in columns:\\n')\nprint(df.isna().sum())","8b1ac794":"df['School type'].value_counts()\/len(df)","3d09f69d":"id_vars = ['School type', 'NU_INSCRICAO']\nlin_df = pd.melt(df[grade_columns + id_vars], \n                 id_vars=id_vars, \n                 value_vars=grade_columns,\n                 var_name='Test',\n                 value_name='Grade')\n\ng = sns.displot(data=lin_df, \n            x='Grade', \n            hue='School type', \n            row='Test',\n            kind='kde', \n            facet_kws={\n                'sharex': True, \n                'sharey': False, \n                'xlim': (0, 1000)\n            },\n            common_norm=False, \n            height=3, \n            aspect=5)\n\ng.set_titles('KDE for student grades on `{row_name}` per school type')\n\nprint('Number of students in each type of school:\\n')\nprint(df['School type'].value_counts())","4ea2988e":"g = sns.displot(data=lin_df, \n            x='Grade', \n            hue='School type', \n            row='Test',\n            facet_kws={\n                'sharex': True, \n                'sharey': False, \n                'xlim': (0, 1000)\n            },\n            binwidth=10,\n            height=3, \n            aspect=5)\n\ng.set_titles('Histogram for student grades on `{row_name}` per school type')","18bba542":"incomeTh =  [\n    0, #padding\n    0,\n    998,\n    1497,\n    1996,\n    2495,\n    2994,\n    3992,\n    4990,\n    5988,\n    6986,\n    7984,\n    8982,\n    9980,\n    11976,\n    14970,\n    19960,\n    19960*2\n]\nincomeClasses = {}\nfor idx, c in enumerate(list('ABCDEFGHIJKLMNOPQ'), start=1):\n    incomeClasses[c]=(incomeTh[idx-1] + incomeTh[idx])\/2\n\ndf2 = df.copy() # do not change main df after data preparation    \ndf2 = df2.replace({'Q006':incomeClasses}) \ndf2['Income per person'] = df2['Q006']\/df2['Q005']\n\n# remove some outliers on income per person\nquantiles = df2[['Income per person', 'School type']].groupby('School type')['Income per person'].quantile(0.99)\n# df2 = df2[df2['Income per person'] < 1000 * math.ceil(df2['Income per person'].quantile(0.99)\/1000)]\nfor school_type, quantile in quantiles.iteritems():\n    df2 = df2[(df2['School type'] != school_type) | \n              (df2['Income per person'] <= quantile)]\n\ng = sns.displot(data=df2, \n                x='Income per person', \n                hue='School type',\n                row='School type', \n                common_norm=False, \n                binwidth=100,\n                facet_kws={\n                    'sharey': False,\n                },\n                height=3, \n                aspect=5)\ng.set_titles('')\n\nplt.subplots_adjust(top=0.95)\nplt.figlegend(title='School type')\n_ = plt.suptitle('Students per income per person', fontweight='bold', fontsize='xx-large')","0a3e1fe0":"df2.head()","1e5b7580":"fig, axs = plt.subplots(6, 4, sharex='col', sharey='row', figsize=(15, 12), gridspec_kw={'right': 0.85, 'wspace':0.05, 'hspace': 0.1})\n       \ndf2['Binned income'] = df2['Income per person'].apply(lambda x: 100*int(x\/100)).astype(str)\n        \ndefault_palette = sns.color_palette()\nschool_types = df2['School type'].unique()\nfor col, school_type in enumerate(school_types):\n    data = df2[df2['School type']==school_type]\n    for row, test_type in enumerate(grade_columns):\n        ax = axs[row][col]\n        sns.histplot(\n            data = data,\n            x='Income per person', \n            y=test_type,\n            binwidth=(100,10),\n            ax=ax,\n            legend=False,\n            color=default_palette[col])\n        \n        mean = data[['Binned income', test_type]].groupby('Binned income').mean()\n        mean = mean.reset_index()\n        mean['Binned income'] = mean['Binned income'].astype(int)\n        sns.lineplot(x=mean['Binned income'], \n                     y=mean[test_type], \n                     ax=ax, \n                     color='#111111')\n        \n        if row==0 or col==0:\n            ax.xaxis.set_major_locator(ticker.MultipleLocator(2000))\n            ax.yaxis.set_major_locator(ticker.MultipleLocator(200))\n    \n        if row == 0:\n            ax.set_title(school_type)\n        \n        ax.spines['right'].set_visible(False)\n        ax.spines['top'].set_visible(False)\n        \n        \n    ax = axs[len(grade_columns)][col]\n    sns.histplot(\n            data = data,\n            x='Income per person',\n            binwidth=100,\n            stat='density',\n            ax=ax,\n            legend=False,\n            color=default_palette[col])\n   \n    if col == 0:\n        ax.set(ylabel='count')\n        \n\npatches = [mpatches.Patch(color=default_palette[col], \n                          label=school_type) \n           for col, school_type in enumerate(school_types)]   \npatches.append(plt.plot([],[], ms=10, label='Average', color='#111111')[0]) #https:\/\/stackoverflow.com\/a\/44113141\/7502752\n\nfig.legend(handles=patches, loc='center right', title='School type', frameon=False)\n_ = fig.suptitle('Grade distribuition per income per person\\n(Plots do not carry the same scale, but ticks are equally spaced in absolute values)', \n                 fontweight='bold', fontsize='xx-large')","32def053":"df3 = df2.copy()\n\nschool_avg = (df3[school_columns + grade_columns + id_columns]\n              .groupby(school_columns)\n              .agg(func={\n                **{col: 'mean' for col in grade_columns}, \n                **{col: 'count' for col in id_columns}\n              })\n              .rename(columns={id_columns[0]:'Count'}))\nschool_avg = school_avg[school_avg['Count'] >= 10]\n\ndf3 = df3.join(school_avg, how='inner', on=school_avg.index.names, rsuffix=' (school average)')\nprint('Removing school with less than 10 students dropped {:.2f}% of students'.format(100*(1-len(df3)\/len(df2))))\n\ngrade_columns_mean = [col+' (school average)' for col in grade_columns]\ngrade_columns_mean_normalized = [col+' (normalized by school average)' for col in grade_columns]\n\ndf3[grade_columns_mean_normalized] = df3[grade_columns] - df3[grade_columns_mean].values\n\nf, ax = plt.subplots(figsize=(9, 6))\nsns.heatmap(df3[grade_columns + grade_columns_mean].corr().iloc[:,5:], \n            annot=True, fmt=\".2f\", linewidths=.5, ax=ax)\n_ = plt.title('Correlation between student grades and their school averages', fontweight='bold')","d2ea98cc":"fig, axs = plt.subplots(2, 5, sharex='col', figsize=(15, 6), gridspec_kw={'right': 0.85, 'wspace':0.25, 'hspace': 0.15})\n\ngrade_columns_mean_binned = [col+'_mean_binned' for col in grade_columns]\n\ndf3[grade_columns_mean_binned] = df3[grade_columns_mean].applymap(lambda x: 10*int(x\/10)).astype(str)\n        \ndefault_palette = sns.color_palette()\nfor col, student_var in enumerate(grade_columns):\n    ###### Plot 1 ######\n    school_var = grade_columns_mean[col]\n    school_var_binned = grade_columns_mean_binned[col]\n        \n    ax = axs[0][col]\n    sns.histplot(\n        data = df3,\n        x=school_var, \n        y=student_var,\n        binwidth=(10,10),\n        ax=ax,\n        legend=False,)\n\n    stats = df3[[school_var_binned, student_var]].groupby(school_var_binned)[student_var].agg(['mean', 'std'])\n    stats = stats.reset_index()\n    stats[school_var_binned] = stats[school_var_binned].astype(int)\n    sns.lineplot(x=stats[school_var_binned], \n                 y=stats['mean'], \n                 ax=ax, \n                 label='Average',\n                 legend=False)\n    \n    sns.lineplot(x=stats[school_var_binned], \n                 y=3*stats['std'], \n                 ax=ax, \n                 label='std * 3',\n                 legend=False)\n    \n    ax.xaxis.set_major_locator(ticker.MultipleLocator(200))\n    ax.yaxis.set_major_locator(ticker.MultipleLocator(200))\n    ax.set(title=student_var, ylim=(0, None), ylabel='Student grade' if col==0 else None)\n    ax.spines['right'].set_visible(False)\n    ax.spines['top'].set_visible(False)\n   \n    ###### Plot 2 ######   \n    ax = axs[1][col]\n    sns.histplot(\n        data = df3,\n        x=school_var,\n        binwidth=10,\n        stat='density',\n        ax=ax,\n        legend=False)\n       \n    ax.set(\n        xlabel='School average grade' if col==2 else None,\n        ylabel='Student density' if col==0 else None, \n        yticks=[]\n    )\n# patches = [mpatches.Patch(color=default_palette[col], \n#                           label=school_type) \n#            for col, school_type in enumerate(school_types)]   \n# patches.append(plt.plot([],[], ms=10, label='Average', color='#111111')[0]) #https:\/\/stackoverflow.com\/a\/44113141\/7502752\n\n# fig.legend(handles=patches, loc='center right', title='School type', frameon=False)\nhandles, labels = axs[0][0].get_legend_handles_labels()\nfig.legend(handles, labels, loc='center right')\nplt.subplots_adjust(top=0.8)\n_ = fig.suptitle('Student Grades vs school grades\\n(Plots do not carry the same scale, but ticks are equally spaced in absolute values)', \n                 fontweight='bold', fontsize='xx-large')","1b29a433":"print('Correlation between income per person and student deviation from school average:')\ndf3[['Income per person'] + grade_columns_mean_normalized].corr().iloc[0:1, 1:]","fc88d734":"df4 = df3.copy()\nclasses = list('ABCDEFGHIJ')\ndf4['Income class'], income_classes = pd.qcut(\n    df4.loc[df4['Income per person'] > 0, 'Income per person'],\n    q=9,\n    labels=classes[1:],\n    retbins=True,\n    duplicates='drop'\n)\ndf4 = df4.astype({'Income class': str})\n\ndf4.loc[df4['Income per person'] == 0, 'Income class'] = classes[0]\nassert df4['Income class'].isna().sum() == 0\n\nax = sns.countplot(data=df4, x='Income class', order=classes)\nax.set_title('Number of students in each income class', fontweight='bold')\nprint('Income class binning result:\\n')\nprint('\\n'.join(\n    ['Income Class\\tRange']+\n    ['{}\\t\\tno income'.format(classes[0])]+\n    ['{}\\t\\t{:.2f} - {:.2f}'.format(key, income_classes[idx], income_classes[idx+1]) for idx, key in enumerate(classes[1:])]))","4c334dc3":"grades_by_income = df4[grade_columns_mean_normalized + ['School type','Income class']].groupby(['School type','Income class']).agg(['mean', 'std', 'count'])\nmean_income = df4[['Income per person', 'Income class']].groupby('Income class').mean().rename({'income_per_person':'mean_income'})","ef64add7":"fig, axs = plt.subplots(5, 1, sharex='col', figsize=(15, 15), gridspec_kw={'right': 0.85, 'wspace':0.25, 'hspace': 0.15})\nfor idx_discipline, discipline in enumerate(grade_columns_mean_normalized):\n    for idx_school_type, school_type in enumerate(['State', 'Private']):\n        grades = (grades_by_income\n                  .loc[school_type, discipline]\n                  .join(mean_income))\n        ax = axs[idx_discipline]\n        ax.plot(grades['Income per person'], \n                grades['mean'], \n                color=default_palette[idx_school_type],\n                label=school_type)\n        ax.fill_between(\n            grades['Income per person'], \n            grades['mean']-grades['std'], \n            grades['mean']+grades['std'],\n            color=default_palette[idx_school_type],\n            alpha=.3)\n    \n        ax.set(title=discipline, xticks=grades['Income per person'])\n        \naxs[-1].set(xticklabels=classes)\nplt.xlabel('Income class')\nhandles, labels = axs[0].get_legend_handles_labels()\nfig.legend(handles, labels, loc='center right', title='School type')\nfig.show()","f6092966":"df5 = df4.copy()\ndf5['school_grade'] = df5[grade_columns_mean].mean(axis=1)\nrenameMap = {\n    **{key:'A-C' for key in list('ABC')},\n    **{key:'D-F' for key in list('DEF')},\n    **{key:'G-I' for key in list('GH')},\n    **{key:'I-J' for key in list('IJ')},\n}\n\ndf5 = df5.astype({'school_grade':np.int}).replace({\n    'Income class':renameMap\n})\n\nstudent_per_income_class = df5.pivot_table(\n    index='school_grade',\n    columns='Income class', \n    values='NU_INSCRICAO',\n    aggfunc='count')\nstudent_per_income_class = student_per_income_class.div(student_per_income_class.sum(axis=1), axis=0)\n\nstudent_per_income_class.plot.area()\nplt.ylim(top=1, bottom=0)\nplt.xlim(left=student_per_income_class.index.min(), right=student_per_income_class.index.max())\nplt.xlabel('School Grade')\nplt.ylabel('Student Income distribuition')\nplt.legend(title=\"Income Class\", fancybox=True, framealpha = .7, frameon=True)\nplt.gca().yaxis.set_major_formatter(ticker.PercentFormatter(1.0))\n_ = plt.title('Student income distribuition per school sorted by school grade', fontweight='bold')","64a5d880":"From the above, we see that all students have answered social-economic questions. Some students have not shown to test, therefore they don't have grades. Some students don't have a school associated with them, we hypotetize that those student have graduated from highschool before the year of 2019. \n\nWe are interested on the students graduating from high school that took all the tests. So we can drop all nan values on the grading \ncolumns and select by students graduating. School will play an important role on our further analysis, so we remove students that do not have a school associated with them.","ac092c90":"That numbers tell us that this information is not correlated. Lets investigate further.","90c7ae12":"From our knowledge of Brazil's education system, we know that school type (federal, state, city or private) is a major factor in student performance. Lets see how this information is reflected in the data.","226802f9":"From the plot above we can see that there is a high correlation between school average grades. This means that good schools probably teach all subjects well, as expected.","c96e67da":"We have two types of information: family income and number of people per family. Income per person is a better measure of finantial health than just family income. A family of two with 3k family income can make a lot more than a family of 6. \n\nFamily income is categorical, so we take the average value between thresholds to each bin as its value. For the upper income bin (more than 19,960BRL) we take the average between that value and its double.  ","81eb032f":"# Processing","77c25a91":"The graphs above show a trend in student performance towards better performance at better incomes. There is a large standard deviation in those values, though, and the trend never leaves the standard deviation range. \n\nFinally, lets ask one more question:\n### How is student income related to their distribuition among schools?\nTo answer that question, we are going to visualize the distribuition of students per income class. The schools are sorted by low to high grades. To simplify, we are taking the average grade among tests to be the school grade","57ca552d":"We can see that the distribuition of students among public schools are very similar and skewed towards low income. Students in private schools are more distibuited across income regions. It worth notice, though, that there is a fair amount of low income student in private schools. \n\nFederal Schools have the biggest tail among public schools. That might reflect the acknowlegment by the parents that federal schools are as good (or better) than private schools. \n\nWe saw that there is a reasonable proportion of students with low income on private schools. \n### How is the correlation between grades and income on each school type?","0cd84089":"The plots above show a clear difference in performance from State and City schools to Federal and Private ones. Despite being public, Federal schools have a performance close and similar to Private schools, except in essays, where there is a growing difference in performance after the score of about 800.\n\nIn regard to the number of students in each school type, we see from the printed values that the vast majority of students come from State schools. The following plot will display the histogram of student grades. We already visualise the inequalities in proportion of performance between students given their school type, does the same inequality holds when observing total numbers?","deb420f9":"So student grade is correlated with school grade, but not much. This correlation is there by construction, since we evaluate schools based on their student average, so there is not much to conclude here. We can observe that Mathematics and Essay are the most 'democratic' disciplines, since we find students in the middle-end of schools obtaining almost full grades. \n\nWe find that as we move towards the high end, the major aspect in play is reducing the standard deviation of students while keeping their performance high. On Humanities and Natural Sciences, the best grades were not even achieved by top ranking schools, but their worst student performed much better that the worst ones from middle-to-high ranking schools. ","4bc1bf58":"# Loading\n\n","53ca540c":"# Conclusion\nOn this notebook we analised how income play a role in education in Brazil. We concluded that students are highly affected by quality of the school they attend. We show that students on the low income range tends to attend to the worst schools. We also show that the biggest impact on family income improvements happens on the 0-1000 BRL income per person range. The effects on income given the school appears to be limited, but present. It is more present in the very low income range, this time up to about 600BRL per person.  \n\nFederal schools are public schools but, differently from city and state schools, have a performance very close to private schools. Student income distribuition in federal schools are slightly less skewed to low income than state and city schools. We suspect that federal schools can be a role model to other public schools, although further investigation is necessary to see if this is actually doable. \n\nOur analysis shows that students in middle range schools can hope to achieve golden grades on some disciplines. We also notice that high-end schools are able to not only improve its average but also reduce its standard deviation, having a more consistent grading among students. This conclusion needs further investigation. We need to analyse if these schools are able to reproduce this behaviour among the years, or if this fenomena is just derived from the math (after all grades are limited on the top).\n\nThe analysis done here does not include school budget information. We leave for future work to consider the role of school budget on its student performance.","f99edd18":"### Is income a factor inside a school?\nIn order to answer that question we are going to study how the difference between student grades and school average grades behave among different incomes classes. For that matter, we are now going to turn income values into discrete income ranges, by binning them. Since the income distribuition is highly skewed toward low incomes, we bin by splitting in bins with equal number of points.\n\nThe first information we analyse is correlation.","a5416420":"# Abstract\n\nEducation is the foundation for the equality of opportunity. The quality of education one receives in Brazil is deep correlated with their family income, the geografic region they live, and so forth. In this notebook, we intend to explore how income affect the student performace on the most importante exam high school students take in Brazil. ENEM is the front door to joining the university, much like the SAT in the USA, and is taken by almost all students who intend to go to college. In this notebook we answer the following questions:\n\n* How is the distribuition of Income across school types, though?\n* How is the correlation between grades and income on each school type?\n* How much can student performance be explained by their school quality?\n* Is income a factor inside a school?\n* How is student income related to their distribuition among schools?\n\n","a1da944b":"We can verify on the plots above the inequalities also in absolute values. Despite being only 16.36% of the total, Private school students are the predominant class after thresholds that are just above the mode of their grade histograms.\n\n### How is the distribuition of Income across school types, though?","1ddb6a60":"From the above charts we can see that there is correlation between student performance and income. This correlation is specially accentuated in an income range up to 1000BRL. The improvements on performance decrease as the income grows. This can be explained taking in consideration the student needs. Students need school material, a good place to study, books and maybe some tutoring. This needs are filled in the low-income range. The expenses for studing in the high-income end (like better computers and tablets) promote only marginal gains to a student performance compared to the basic ones. Also, parent education, for which income is a good proxy, may be playing an important role in their children education. ","24c91609":"We have seen that income influence on the type of school student attend. It also influence on their performance given the type of school. Therefore, we can ask:\n\nHow much can student performance be explained by their school quality?\nIs income a factor inside each school?\n\n### How much can student performance be explained by their school quality?\n\nWe are going to use the average grade for students in a school as measure for its quality. Schools are required to have at least 10 students, in order to factor out those schools that have too little students"}}