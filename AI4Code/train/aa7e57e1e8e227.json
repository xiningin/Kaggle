{"cell_type":{"5832c29f":"code","861b04d7":"code","0d4a3884":"code","e9057640":"code","f13893aa":"code","68a356a5":"code","7db5ae9e":"code","e32fdf5c":"code","cd8fb128":"code","1eb07994":"code","8df87bda":"code","51356779":"code","edd891ff":"code","a02ae3ab":"code","fb85d4a2":"code","e7ce2cb7":"code","26d0dc29":"code","d9b5b57b":"code","bf68a1a1":"code","c3c7f912":"code","3e84aa11":"code","6e93af01":"code","7d1452fd":"markdown","f060eea4":"markdown","8cb399b7":"markdown","ae7b5d6d":"markdown","96465829":"markdown","29864f52":"markdown","bb0d72ad":"markdown","2b57dc87":"markdown","ec5b1455":"markdown","c0cd23c3":"markdown","8c6ef037":"markdown","0cb8e973":"markdown","98ac405a":"markdown","1ea2446e":"markdown","b610addc":"markdown","2c18b70b":"markdown","1b193638":"markdown","5f62539d":"markdown","7f857078":"markdown","03554fe4":"markdown","a77f35c8":"markdown","2bd34cec":"markdown","2b0d1ed8":"markdown","258f970c":"markdown","39622e67":"markdown"},"source":{"5832c29f":"import numpy as np\nimport pandas as pd\nimport seaborn as sns\nimport matplotlib.pyplot as plt\nfrom sklearn.ensemble import RandomForestClassifier\nimport warnings\nwarnings.simplefilter(action='ignore', category=FutureWarning)\nwarnings.simplefilter(action='ignore', category=UserWarning)\nsns.set(style=\"white\")\ndf = pd.read_csv(\"..\/input\/WA_Fn-UseC_-Telco-Customer-Churn.csv\")\ndf.head(3)","861b04d7":"df['TotalCharges'] = df['TotalCharges'].replace(\" \", 0).astype('float32')","0d4a3884":"ax = sns.catplot(y=\"Churn\", kind=\"count\", data=df, height=2.6, aspect=2.5, orient='h')","e9057640":"def kdeplot(feature):\n    plt.figure(figsize=(9, 4))\n    plt.title(\"KDE for {}\".format(feature))\n    ax0 = sns.kdeplot(df[df['Churn'] == 'No'][feature].dropna(), color= 'navy', label= 'Churn: No')\n    ax1 = sns.kdeplot(df[df['Churn'] == 'Yes'][feature].dropna(), color= 'orange', label= 'Churn: Yes')\nkdeplot('tenure')\nkdeplot('MonthlyCharges')\nkdeplot('TotalCharges')","f13893aa":"g = sns.PairGrid(df, y_vars=[\"tenure\"], x_vars=[\"MonthlyCharges\", \"TotalCharges\"], height=4.5, hue=\"Churn\", aspect=1.1)\nax = g.map(plt.scatter, alpha=0.6)","68a356a5":"# Calculate features\ndf['total_charges_to_tenure_ratio'] = df['TotalCharges'] \/ df['tenure']\ndf['monthly_charges_diff'] = df['MonthlyCharges'] - df['total_charges_to_tenure_ratio']\nkdeplot('monthly_charges_diff')","7db5ae9e":"def barplot_percentages(feature, orient='v', axis_name=\"percentage of customers\"):\n    ratios = pd.DataFrame()\n    g = df.groupby(feature)[\"Churn\"].value_counts().to_frame()\n    g = g.rename({\"Churn\": axis_name}, axis=1).reset_index()\n    g[axis_name] = g[axis_name]\/len(df)\n    if orient == 'v':\n        ax = sns.barplot(x=feature, y= axis_name, hue='Churn', data=g, orient=orient)\n        ax.set_yticklabels(['{:,.0%}'.format(y) for y in ax.get_yticks()])\n    else:\n        ax = sns.barplot(x= axis_name, y=feature, hue='Churn', data=g, orient=orient)\n        ax.set_xticklabels(['{:,.0%}'.format(x) for x in ax.get_xticks()])\n    ax.plot()\nbarplot_percentages(\"SeniorCitizen\")","e32fdf5c":"df['churn_rate'] = df['Churn'].replace(\"No\", 0).replace(\"Yes\", 1)\ng = sns.FacetGrid(df, col=\"SeniorCitizen\", height=4, aspect=.9)\nax = g.map(sns.barplot, \"gender\", \"churn_rate\", palette = \"Blues_d\", order= ['Female', 'Male'])","cd8fb128":"g = sns.FacetGrid(df, row='SeniorCitizen', col=\"gender\", hue=\"Churn\", height=3.5)\ng.map(plt.scatter, \"tenure\", \"MonthlyCharges\", alpha=0.6)\ng.add_legend();","1eb07994":"fig, axis = plt.subplots(1, 2, figsize=(12,4))\naxis[0].set_title(\"Has partner\")\naxis[1].set_title(\"Has dependents\")\naxis_y = \"percentage of customers\"\n# Plot Partner column\ngp_partner = df.groupby('Partner')[\"Churn\"].value_counts()\/len(df)\ngp_partner = gp_partner.to_frame().rename({\"Churn\": axis_y}, axis=1).reset_index()\nax = sns.barplot(x='Partner', y= axis_y, hue='Churn', data=gp_partner, ax=axis[0])\n# Plot Dependents column\ngp_dep = df.groupby('Dependents')[\"Churn\"].value_counts()\/len(df)\ngp_dep = gp_dep.to_frame().rename({\"Churn\": axis_y}, axis=1).reset_index()\nax = sns.barplot(x='Dependents', y= axis_y, hue='Churn', data=gp_dep, ax=axis[1])","8df87bda":"plt.figure(figsize=(9, 4.5))\nbarplot_percentages(\"MultipleLines\", orient='h')","51356779":"ax = sns.catplot(x=\"MultipleLines\", y=\"MonthlyCharges\", hue=\"Churn\", kind=\"violin\",\n                 split=True, palette=\"pastel\", data=df, height=4.2, aspect=1.4)","edd891ff":"plt.figure(figsize=(9, 4.5))\nbarplot_percentages(\"InternetService\", orient=\"h\")","a02ae3ab":"ax = sns.catplot(x=\"InternetService\", y=\"MonthlyCharges\", hue=\"Churn\", kind=\"violin\",\n                 split=True, palette=\"pastel\", data=df, height=4.2, aspect=1.4);","fb85d4a2":"cols = [\"OnlineSecurity\", \"OnlineBackup\", \"DeviceProtection\", \"TechSupport\", \"StreamingTV\", \"StreamingMovies\"]\ndf1 = pd.melt(df[df[\"InternetService\"] != \"No\"][cols]).rename({'value': 'Has service'}, axis=1)\nplt.figure(figsize=(10, 4.5))\nax = sns.countplot(data=df1, x='variable', hue='Has service')\nax.set(xlabel='Additional service', ylabel='Num of customers')\nplt.show()","e7ce2cb7":"plt.figure(figsize=(10, 4.5))\ndf1 = df[(df.InternetService != \"No\") & (df.Churn == \"Yes\")]\ndf1 = pd.melt(df1[cols]).rename({'value': 'Has service'}, axis=1)\nax = sns.countplot(data=df1, x='variable', hue='Has service', hue_order=['No', 'Yes'])\nax.set(xlabel='Additional service', ylabel='Num of churns')\nplt.show()","26d0dc29":"g = sns.FacetGrid(df, col=\"PaperlessBilling\", height=4, aspect=.9)\nax = g.map(sns.barplot, \"Contract\", \"churn_rate\", palette = \"Blues_d\", order= ['Month-to-month', 'One year', 'Two year'])","d9b5b57b":"plt.figure(figsize=(9, 4.5))\nbarplot_percentages(\"PaymentMethod\", orient='h')","bf68a1a1":"ax = sns.catplot(x=\"Contract\", y=\"MonthlyCharges\", hue=\"Churn\", kind=\"box\", data=df, height=4.2, aspect=1.4)","c3c7f912":"ax = sns.catplot(y=\"Churn\", x=\"MonthlyCharges\", row=\"PaymentMethod\", kind=\"box\", data=df, height=1.5, aspect=4, orient='h')","3e84aa11":"plt.figure(figsize=(12, 6))\ndf.drop(['customerID', 'churn_rate', 'total_charges_to_tenure_ratio', 'monthly_charges_diff'],\n        axis=1, inplace=True)\ncorr = df.apply(lambda x: pd.factorize(x)[0]).corr()\nax = sns.heatmap(corr, xticklabels=corr.columns, yticklabels=corr.columns, \n                 linewidths=.2, cmap=\"YlGnBu\")","6e93af01":"params = {'random_state': 0, 'n_jobs': 4, 'n_estimators': 5000, 'max_depth': 8}\n# One-hot encode\ndf = pd.get_dummies(df)\n# Drop redundant columns (for features with two unique values)\ndrop = ['Churn_Yes', 'Churn_No', 'gender_Female', 'Partner_No',\n        'Dependents_No', 'PhoneService_No', 'PaperlessBilling_No']\nx, y = df.drop(drop,axis=1), df['Churn_Yes']\n# Fit RandomForest Classifier\nclf = RandomForestClassifier(**params)\nclf = clf.fit(x, y)\n# Plot features importances\nimp = pd.Series(data=clf.feature_importances_, index=x.columns).sort_values(ascending=False)\nplt.figure(figsize=(10,12))\nplt.title(\"Feature importance\")\nax = sns.barplot(y=imp.index, x=imp.values, palette=\"Blues_d\", orient='h')","7d1452fd":"* Customers that doesn't have partners are more likely to churn\n* Customers without dependents are also more likely to churn\n\n<h3>3.3 Phone and Internet services<\/h3>\n\nNow let's look at the services that customers are using. There are only two main services: phone and internet but the former has many additionals like online backup and security.","f060eea4":"**Additional services**\n\nThere are six additional services for customers with internet:","8cb399b7":"A few observations:\n* Customers with paperless billing are more probable to churn\n* The preferred payment method is Electronic check with around 35% of customers. This method also has a very high churn rate\n* Short term contracts have higher churn rates\n\nOne and two year contracts probably have contractual fines and therefore customers have to wait untill the end of contract to churn. A time-series dataset would be better to understand this kind of behaviour. Now let's have a look at the relation with numerical features:","ae7b5d6d":"<h2>5. Feature Importance<\/h2>\n\nTo get some preliminary feature importances we will use the Random Forest classifier, an well know decision-tree based model.  I've used one-hot encode to encode the categorical features and dropped the 'No' columns for binary features. I've also manually tested a few hyperparameters to get a better model.\n\nThe importances are the mean decrease in impurity for each feature across all trees.","96465829":"The first plot shows the total number of customers for each additional service, while the second shows the number of clients that churn. We can see that:\n\n* Customers with the first 4 additionals (security to tech support) are more unlikely to churn\n* Streaming service is not predictive for churn","29864f52":"* Clients without internet have a very low churn rate\n* Customers with fiber are more probable to churn than those with DSL connection\n\nComparing the Internet service with monthly charges:","bb0d72ad":"<b>Phone services<\/b>\n\nThere are only two features here: if the client has phone and if he has more than one line. Both can be summed up in one chart:","2b57dc87":"<h3>3.4 Contract and Payment<\/h3>","ec5b1455":"\n<h2>3. Categorical features<\/h2>\n\nThis dataset has 16 categorical features:\n\n* Six binary features (Yes\/No)\n* Nine features with three unique values each (categories)\n* One feature with four unique values","c0cd23c3":"* Few customers doesn't have phone service\n* Customers with multiple lines have a slightly higher churn rate\n\nLet's see how multiple lines affects the monthly charges:","8c6ef037":"* Longer contracts are more affected by higher monthly charges (for churn rate).\n* Mailed checks have lower charges\n* There is a huge gap in charges between customers that churn and those that don't with respect to Mailed Check","0cb8e973":"<b>Internet services<\/b>","98ac405a":"<h2>4. Correlation between features<\/h2>\n\nCorrelation heatmap (Pearson method)","1ea2446e":"<h2>2. Numerical features<\/h2>\n\nThere are only three numerical columns: tenure, monthly charges and total charges. The probability density distribution can be estimate using the seaborn kdeplot function. ","b610addc":"From the plots above we can conclude that:\n* Recent clients are more likely to churn\n* Clients with higher MonthlyCharges are also more likely to churn\n* Tenure and MonthlyCharges are probably important features\n\nIn fact we can see some boundaries when we use scatter plots:","2c18b70b":"The importances are in line with our previous analysis. The three numerical features are good predictors for churn, specially tenure. As we've seen, customers with Fiber optic are very likely to churn, while those with long term contracts are not. On the other hand, gender and streaming are not important features and It might be interesting to drop additional services with the label 'No internet service', since they are highly correlated.\n\nPlease leave your feedback and suggestions. \n\nYou can also check: [Predicting churn - logistic regression and SVM](https:\/\/www.kaggle.com\/jsaguiar\/predicting-churn-complete-tutorial-logit-vs-svm)","1b193638":"<h3>3.2 Partner and dependents<\/h3>","5f62539d":"Not a promising feature at first glance, but it might be usefull when combined with categorical features.","7f857078":"<h3>1.2 Target variable<\/h3>\n\nWe are trying to predict if the client left the company in the previous month. Therefore we have a binary classification problem with a slightly unbalanced target:\n* Churn: No   - 72.4%\n* Churn: Yes  - 27.6%","03554fe4":"<h2>1. Introduction<\/h2>\n\nThis IBM Sample Dataset has information about Telco customers and if they left the company within the last month (churn). Each row represents a unique costumer, while the columns contains information about customer\u2019s services, account and demographic data. We will be using Python and Seaborn library to plot and analyze the data.\n\n**Basic information**:\n* Only 7043 rows\n* There are 21 columns with 19 features\n* Only 11 missing values (next item).\n\nYou can also check: [Predicting churn - logistic regression and SVM](https:\/\/www.kaggle.com\/jsaguiar\/predicting-churn-complete-tutorial-logit-vs-svm)","a77f35c8":"<h3>3.1 Gender and Age (SeniorCitizen)<\/h3>","2bd34cec":"It's interesting how customers with DSL (slower connection) and higher charges are less probable to churn. ","2b0d1ed8":"* Gender is not an indicative of churn. \n* SeniorCitizens are only 16% of customers, but they have a much higher churn rate: 42% against 23% for non-senior customers. \n* There are no special relations between this categorical values and the main numerical features.","258f970c":"Another feature we can consider is the difference between the MonthlyCharges and the TotalCharges divided by the tenure:","39622e67":"<h3>1.1 Impute missing values<\/h3>\n\nThere are only 11 missing values, all of them for the TotalCharges column. This values are actually a blank space in the csv file and are exclusive for customers with zero tenure. It's possible to concluded that they are missing due to the fact that the customer never paied anything to the company. We will impute this missing values with zero:"}}