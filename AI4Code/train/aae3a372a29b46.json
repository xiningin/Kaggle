{"cell_type":{"2757e4a2":"code","dc47e302":"code","0418cc14":"code","e8260e1f":"code","0f190f4d":"code","c44684e6":"code","3e71f0ff":"code","75b24b0a":"code","ceb2d20c":"code","a57066fc":"code","959a0ac0":"code","b83c4b47":"code","ea8b0365":"markdown","967182e3":"markdown","10225755":"markdown","8a0bed57":"markdown","769b7af2":"markdown","686b0a24":"markdown"},"source":{"2757e4a2":"# Nativos\nimport os\nimport sys\n\n#calculo\nimport numpy as np\nimport pandas as pd\n\n#modelamiento\nfrom sklearn.model_selection import GridSearchCV\nfrom sklearn.linear_model import LogisticRegression\nfrom sklearn.feature_selection import SelectFromModel\nfrom sklearn.linear_model import LassoCV\nfrom sklearn.model_selection import StratifiedKFold\nfrom sklearn.metrics import roc_auc_score\nfrom sklearn.discriminant_analysis import QuadraticDiscriminantAnalysis\nfrom sklearn.feature_selection import VarianceThreshold\nfrom sklearn.decomposition import PCA\nfrom sklearn.neighbors import KNeighborsClassifier\nfrom sklearn.cluster import KMeans\n\n#warning ignore future\nimport warnings\n# warnings.simplefilter(action='ignore', category=FutureWarning)\nwarnings.filterwarnings(\"ignore\")\n\nimport os\n\nsubfolder = \"..\/input\"\nprint(os.listdir(subfolder))","dc47e302":"set_parameter_csv = {\n    'sep': ',',\n    'encoding': 'ISO-8859-1',\n    'low_memory': False\n}\n\ntrain = pd.read_csv(subfolder + '\/train.csv', **set_parameter_csv).round(2)\ntest = pd.read_csv(subfolder + '\/test.csv', **set_parameter_csv).round(2)\ntrain.shape, test.shape","0418cc14":"train.head(2)","e8260e1f":"%%time\ndef get_memory_usage(data, deep=True):\n    return '{} MB'.format(data.memory_usage(deep=deep).sum() \/ 1024 ** 2)\n\ndef reduce_size_data(df, default=''):\n    print(\"INITIAL SIZE : DEEP\", get_memory_usage(df), \"REAL\", get_memory_usage(df, deep=False))\n \n    for col in df.select_dtypes(include=['int']).columns:\n        df[col] = pd.to_numeric(arg=df[col], downcast=default or'integer')\n    \n    for col in df.select_dtypes(include=['float']).columns:\n        df[col] = pd.to_numeric(arg=df[col], downcast=default or'float')\n                \n    print(\"FINAL SIZE : DEPP\", get_memory_usage(df), \"REAL\", get_memory_usage(df, deep=False))               \n    return df\n\ntrain = reduce_size_data(train)\ntest = reduce_size_data(test)","0f190f4d":"train.isnull().sum().any(), test.isnull().sum().any()","c44684e6":"for col in train.columns:\n    unicos = train[col].unique().shape[0]\n    if unicos < 1000:\n        print(col, unicos)","3e71f0ff":"SEED = 29082013\npd.np.random.seed(SEED)\n\ncol_wctm = 'wheezy-copper-turtle-magic'\ncol_target = 'target'\ncol_log = 'predict_log'\ncol_knn = 'predict_knn'\ncols = [c for c in train.columns if c not in ['id', col_wctm, col_target]]\n\nkfold_off = StratifiedKFold(\n    n_splits=11, \n    shuffle=False, \n    random_state=SEED\n)\nparam_grid_knn = {\n    'n_neighbors': [7],\n    'p': [2],\n    'weights':['distance']\n}\nparam_grid_gauss = {\n    'priors': [[0.5, 0.5]],\n    'reg_param': [0.3]\n}\n\nparam_grid_log = {\n    'solver': ['sag'],\n    'penalty': ['l2'],\n    'C': [0.001],\n    'tol': [0.0001]\n}\n\nmodel_knn = KNeighborsClassifier()\nmodel_gauss = QuadraticDiscriminantAnalysis()\nmodel_log = LogisticRegression(random_state=SEED)\nkm = KMeans(n_clusters=5, n_init=5, init='k-means++', random_state=SEED, algorithm='elkan')\npca = PCA(svd_solver='full',n_components='mle')","75b24b0a":"def apply_pca(X_train, X_test):\n    #PCA\n    X_train = pd.DataFrame(pca.fit_transform(X_train))\n    X_test = pd.DataFrame(pca.transform(X_test)) \n    return X_train, X_test\n\ndef apply_km(X_train, X_test):\n    col_km = 'cluster_km'\n    X_train[col_km] = km.fit_predict(X_train)\n    X_test[col_km] = km.predict(X_test)\n    return pd.get_dummies(X_train, columns=[col_km]), pd.get_dummies(X_test, columns=[col_km])\n\ndef apply_grid(X_train, y_train, X_test, model, param_grid, predict_train=True):\n    grid = GridSearchCV(\n        model, param_grid, cv=kfold_off, n_jobs=-1, scoring='roc_auc'\n    )\n    grid.fit(X_train, y_train)\n    print(grid.best_score_, end=' \/ ')\n    if predict_train:\n        return grid.best_estimator_.predict_proba(X_train)[:,1], grid.best_estimator_.predict_proba(X_test)[:,1]\n    else:\n        return grid.best_estimator_.predict_proba(X_test)[:,1]","ceb2d20c":"%%time\ncol_wctm = 'wheezy-copper-turtle-magic'\ncol_target = 'target'\ncols = [c for c in train.columns if c not in ['id', col_wctm, col_target]]\nresult = []\nscores = 0\nscores2 = 0\n\nfor val in sorted(train[col_wctm].unique()):\n    # Build X_train and y_train\n    X_train = train[train[col_wctm] == val]\n    y_train = X_train[col_target]\n    X_test = test[test[col_wctm] == val]\n    result_test = X_test[['id', col_wctm]]\n    \n    X_train = X_train[cols]\n    X_test = X_test[cols]\n    \n    #PCA\n    X_train, X_test = apply_pca(X_train, X_test)\n    \n    # ADD column prediction log or knn\n    train_log, test_log = apply_grid(X_train, y_train, X_test, model_log, param_grid_log)\n    train_knn, test_knn = apply_grid(X_train, y_train, X_test, model_knn, param_grid_knn)    \n    \n    X_train, X_test = apply_km(X_train, X_test)\n    \n    X_train[col_log] = train_log\n    X_test[col_log] = test_log\n    X_train[col_knn] = train_knn\n    X_test[col_knn] = test_knn\n    \n    # TRAIN    \n    result_test[col_target] = apply_grid(X_train, y_train, X_test, model_gauss, param_grid_gauss, predict_train=False)\n    result.append(result_test[['id', col_target]])\n    print(\"-\"*100)","a57066fc":"result = pd.concat(result).sort_index()\nresult.head(15)","959a0ac0":"\"\"\"\ndef fix_round(val):\n    if val > 0.9:\n        return 1\n    elif val < 0.1:\n        return 0\n    else:\n        return val\n    \nresult[col_target] = result[col_target].apply(lambda _: fix_round(_))\n\"\"\"","b83c4b47":"result.to_csv('oordered_log_kfold11_knn7_qda_38.csv', index=False)","ea8b0365":"### FUNCTIONS MODELING","967182e3":"### REDUCE SIZE","10225755":"### PROCESS VARIABLES","8a0bed57":"### CATEGORY DETECTION","769b7af2":"### LOAD DATA","686b0a24":"### NULL ANALYSIS"}}