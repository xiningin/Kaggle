{"cell_type":{"da922f1c":"code","cef164eb":"code","4d311e4e":"code","1dfffd64":"code","bf4250dd":"code","b400f570":"code","0a322262":"code","41d34a9f":"code","475b094f":"code","07ac94fd":"markdown","a44d5fd7":"markdown","40c12406":"markdown","9fcd42f6":"markdown","b715d2c5":"markdown"},"source":{"da922f1c":"# Replace 'kaggle-competitions-project' with YOUR OWN project id here --  \nPROJECT_ID = 'kaggle-bq-geotag' #\n#PROJECT_ID='kaggle-competitions-project'\n\nfrom google.cloud import bigquery\nclient = bigquery.Client(project=PROJECT_ID, location=\"US\")\ndataset = client.create_dataset('bqml_example', exists_ok=True)\n\nfrom google.cloud.bigquery import magics\nfrom kaggle.gcp import KaggleKernelCredentials\nmagics.context.credentials = KaggleKernelCredentials()\nmagics.context.project = PROJECT_ID\n\nimport seaborn as sns\nimport matplotlib.pyplot as plt\n\n# create a reference to our table\ntable = client.get_table(\"kaggle-competition-datasets.geotab_intersection_congestion.train\")\n\n# look at five rows from our dataset\nclient.list_rows(table, max_results=5).to_dataframe()","cef164eb":"%load_ext google.cloud.bigquery","4d311e4e":"%%bigquery city_df\nSELECT t.city\n  FROM `kaggle-competition-datasets.geotab_intersection_congestion.test` t\nUNION DISTINCT\nSELECT t.city\n  FROM `kaggle-competition-datasets.geotab_intersection_congestion.train` t","1dfffd64":"cities = list(city_df['city'])\ncities","bf4250dd":"model_changed = True\n\nif model_changed:\n    for c in cities:\n        sql=\"\"\"CREATE MODEL IF NOT EXISTS `bqml_example.model_cluster_\"\"\"+c+\"\"\"`\n        OPTIONS(model_type='kmeans',\n                NUM_CLUSTERS = 10) AS\n        SELECT\n            latitude,\n            longitude\n        FROM\n          `kaggle-competition-datasets.geotab_intersection_congestion.train` t\n        WHERE city = '\"\"\"+c+\"\"\"'\n        UNION ALL\n        SELECT\n            latitude,\n            longitude\n        FROM\n          `kaggle-competition-datasets.geotab_intersection_congestion.test` t\n        WHERE city = '\"\"\"+c+\"\"\"'\"\"\"\n        \n        client.query(sql)\n\n        print('Done with',c)","b400f570":"%%bigquery eda_df\nWITH city_cluster AS (\n    SELECT (SELECT MIN(d.DISTANCE) FROM UNNEST(NEAREST_CENTROIDS_DISTANCE) d) AS dist_to_cluster_center, \n           CONCAT(m.city,\"_\",CAST(m.CENTROID_ID AS STRING)) AS city_cluster,\n           m.* EXCEPT (nearest_centroids_distance, CENTROID_ID) \n      FROM ML.PREDICT(MODEL `bqml_example.model_cluster_boston`, \n                   (SELECT t.RowId,\n                   t.city,\n                           t.IntersectionId,\n                           t.Latitude,\n                           t.Longitude,\n                           #t.EntryStreetName,\n                           #t.ExitStreetName,\n                           t.EntryHeading,\n                           t.ExitHeading,\n                           t.Hour,\n                           t.Weekend,\n                           t.Month,\n                           #t.Path,\n                           t.TotalTimeStopped_p20,\n                           #t.TotalTimeStopped_p40,\n                           t.TotalTimeStopped_p50,\n                           #t.TotalTimeStopped_p60,\n                           t.TotalTimeStopped_p80,\n                           #t.TimeFromFirstStop_p20,\n                           #t.TimeFromFirstStop_p40,\n                           #t.TimeFromFirstStop_p50,\n                           #t.TimeFromFirstStop_p60,\n                           #t.TimeFromFirstStop_p80,\n                           t.DistanceToFirstStop_p20,\n                           #t.DistanceToFirstStop_p40,\n                           t.DistanceToFirstStop_p50,\n                           #t.DistanceToFirstStop_p60,\n                           t.DistanceToFirstStop_p80,\n                           'TRAIN' AS source\n                     FROM `kaggle-competition-datasets.geotab_intersection_congestion.train` t\n                    WHERE city = 'Boston' \n                    #  AND rowid in(2209678,2209692)\n                    UNION ALL\n                    SELECT t.RowId,\n                    t.city,\n                           t.IntersectionId,\n                           t.Latitude,\n                           t.Longitude,\n                           #t.EntryStreetName,\n                           #t.ExitStreetName,\n                           t.EntryHeading,\n                           t.ExitHeading,\n                           t.Hour,\n                           t.Weekend,\n                           t.Month,\n                           #t.Path,\n                           null as TotalTimeStopped_p20,\n                           #null as TotalTimeStopped_p40,\n                           null as TotalTimeStopped_p50,\n                           #null as TotalTimeStopped_p60,\n                           null as TotalTimeStopped_p80,\n                           #null as TimeFromFirstStop_p20,\n                           #null as TimeFromFirstStop_p40,\n                           #null as TimeFromFirstStop_p50,\n                           #null as TimeFromFirstStop_p60,\n                           #null as TimeFromFirstStop_p80,\n                           null as DistanceToFirstStop_p20,\n                           #null as DistanceToFirstStop_p40,\n                           null as DistanceToFirstStop_p50,\n                           #null as DistanceToFirstStop_p60,\n                           null as DistanceToFirstStop_p80,\n                           'TEST' AS source\n                     FROM `kaggle-competition-datasets.geotab_intersection_congestion.test` t\n                    WHERE city = 'Boston' \n                    #  AND rowid in(2209678,2209692)\n                    )) m\n)\nSELECT cc.source,\n       cc.city,\n       cc.city_cluster, \n       count(1) cnt, \n       avg(cc.dist_to_cluster_center) avg_dist_to_cluster_center, \n       stddev(cc.dist_to_cluster_center) stddev_dist_to_cluster_center, \n       min(cc.dist_to_cluster_center) min_dist_to_cluster_center, \n       max(cc.dist_to_cluster_center) max_dist_to_cluster_center,\n       avg(avg(cc.dist_to_cluster_center)*(count(1)-1)) over(partition by cc.city) avg_dist_to_cluster_center_over_city\n  FROM city_cluster cc\n GROUP BY cc.source, \n          cc.city, \n          cc.city_cluster;","0a322262":"eda_df.sort_values(by=['source','city_cluster']).head(100)","41d34a9f":"sns.swarmplot(x='city_cluster',y='cnt', data=eda_df ,hue='source')\n\nplt.xticks(rotation=45)","475b094f":"sns.swarmplot(x='city_cluster',y='avg_dist_to_cluster_center', data=eda_df ,hue='source')\n\nplt.xticks(rotation=45)","07ac94fd":"# Cluster Intersections per City","a44d5fd7":"# Basic EDA using the clusters","40c12406":"Using Boston as an example","9fcd42f6":"Set *model_changed* to True to generate the Models.","b715d2c5":"# INTRO\n\nThis kernel is forked from [BigQuery Machine Learning Tutorial](https:\/\/www.kaggle.com\/rtatman\/bigquery-machine-learning-tutorial).\n\nLet's use BigQuery to cluster the city intersection based on their location."}}