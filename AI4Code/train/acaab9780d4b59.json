{"cell_type":{"ebac463b":"code","52e8a4fd":"code","693ce0cd":"code","cd2ae214":"code","ffd8ef7b":"code","314276bc":"code","da42fffe":"code","946896fc":"code","b4fd5995":"code","a63ebd2c":"markdown","9057a249":"markdown","84cfd661":"markdown","364ac9f5":"markdown","461ee624":"markdown","197d15d6":"markdown","1b35ac0b":"markdown","2d938ca3":"markdown","09226f23":"markdown","babf51e3":"markdown","2cb8838d":"markdown","27a683ee":"markdown","094ce641":"markdown","d27f4b0b":"markdown","ea8a6d9e":"markdown"},"source":{"ebac463b":"import os\nimport shutil\nimport glob\nimport vmmr_utils\nimport matplotlib.pyplot as plt\n%matplotlib inline\n\ncars = {\n    \"honda_civic_1998\": [\"honda_civic_1997\", \"honda_civic_1998\"], # available \"honda_civic_1999\"\n    \"honda_accord_1997\": [\"honda_accord_1996\", \"honda_accord_1997\"],\n    \"ford_f150_2006\": [\"ford_f150_2005\", \"ford_f150_2006\", \"ford_f150_2007\"],\n    \"chevrolet_silverado_2004\": [\"chevrolet_silverado_2003\", \"chevrolet_silverado_2004\"], # available \"chevrolet_silverado_2005\"\n    \"toyota_camry_2014\": [\"toyota_camry_2012\", \"toyota_camry_2013\", \"toyota_camry_2014\", \"toyota_camry_le_2012\", \"toyota_camry_le_2013\", \"toyota_camry_le_2014\", \"toyota_camry_se_2012\", \"toyota_camry_se_2013\", \"toyota_camry_xle_2012\", \"toyota_camry_xle_2013\"],\n    \"nissan_altima_2014\": [\"nissan_altima_2013\", \"nissan_altima_2014\", \"nissan_altima_2015\"],\n    \"toyota_corolla_2013\": [\"toyota_corolla_2011\", \"toyota_corolla_2012\", \"toyota_corolla_2013\", \"toyota_corolla_ce_2012\", \"toyota_corolla_le_2012\", \"toyota_corolla_le_2013\", \"toyota_corolla_s_2011\", \"toyota_corolla_s_2012\"],\n    \"dodge_ram_2001\": [\"dodge_ram_1500_2000\", \"dodge_ram_1500_2001\", \"dodge_ram_1500_1999\", \"dodge_ram_1500_1998\", \"dodge_ram_1500_1997\", \"dodge_ram_1500_1996\", \"dodge_ram_1500_1995\"],\n    \"gmc_sierra_2012\": [\"gmc_sierra_1500_2007\", \"gmc_sierra_1500_2008\", \"gmc_sierra_1500_2009\", \"gmc_sierra_1500_2010\", \"gmc_sierra_1500_2011\", \"gmc_sierra_1500_2012\", \"gmc_sierra_1500_2013\", \"gmc_sierra_2500_2007\", \"gmc_sierra_2500_2008\", \"gmc_sierra_2500_2009\", \"gmc_sierra_2500_2010\", \"gmc_sierra_2500_2011\", \"gmc_sierra_2500_2012\", \"gmc_sierra_2500_2013\"],\n    \"chevrolet_impala_2008\": [\"chevrolet_impala_2007\", \"chevrolet_impala_2008\", \"chevrolet_impala_2009\"]\n}\n\n\nfull_dataset_path = \"Dataset\/SubsetVMMR\/Dataset\/SubsetVMMR\"\nstolen_cars_path = \"Dataset\/Most_Stolen_Cars\"\n\nif os.path.exists(stolen_cars_path):\n    shutil.rmtree(stolen_cars_path)\nelse:\n    os.makedirs(stolen_cars_path)\n\nfor directory, car_list in cars.items():\n    print(\"Creating\", directory)\n    car_directory_name = os.path.join(stolen_cars_path, directory)\n    os.makedirs(car_directory_name)\n    for car in car_list:\n        path = os.path.join(full_dataset_path, car, \"\")\n        files = glob.glob(path + '*.jpg')\n        for file in files:\n            shutil.copy(file, car_directory_name)\n\nvmmr_utils.display_images(stolen_cars_path)","52e8a4fd":"from multiprocessing import Pool\n\n#Check Images\nif __name__ == '__main__':\n    pool = Pool()\n    image_list = glob.glob(stolen_cars_path + \"\/*\/*\")\n    pool.map(vmmr_utils.check_image, image_list)\n    pool.close()\n\nprint('Done.')","693ce0cd":"import pygal \nfrom IPython.display import display, HTML\n#Create function to display interactive plotting\nbase_html = \"\"\"\n<!DOCTYPE html>\n<html>\n  <head>\n  <script type=\"text\/javascript\" src=\"http:\/\/kozea.github.com\/pygal.js\/javascripts\/svg.jquery.js\"><\/script>\n  <script type=\"text\/javascript\" src=\"https:\/\/kozea.github.io\/pygal.js\/2.0.x\/pygal-tooltips.min.js\"\"><\/script>\n  <\/head>\n  <body>\n    <figure>\n      {rendered_chart}\n    <\/figure>\n  <\/body>\n<\/html>\n\"\"\"\n\ndef galplot(chart):\n    rendered_chart = chart.render(is_unicode=True)\n    plot_html = base_html.format(rendered_chart=rendered_chart)\n    display(HTML(plot_html))\n    \n#Compare class distribution\nline_chart = pygal.Bar(height=300)\nline_chart.title = 'Stolen Car Class Distribution'\nfor o in os.listdir(stolen_cars_path):\n    line_chart.add(o, len(os.listdir(os.path.join(stolen_cars_path, o))))\ngalplot(line_chart)","cd2ae214":"#Confirm Folder Structure\nfor root, dirs, files in os.walk(stolen_cars_path):\n    level = root.replace(os.getcwd(), '').count(os.sep)\n    print('{0}{1}\/'.format('    ' * level, os.path.basename(root)))\n    for f in files[:2]:\n        print('{0}{1}'.format('    ' * (level + 1), f))\n    if level is not 0:\n        print('{0}{1}'.format('    ' * (level + 1), \"...\"))        ","ffd8ef7b":"import math\nimport re\nimport sys\n\n#Train and Test Set Variables\ntrain_val_test_ratio = (.7,.1,.2) # 70\/10\/20 Data Split\ntest_folder = 'Dataset\/test\/'\ntrain_folder = 'Dataset\/train\/'\nval_folder = 'Dataset\/val\/'\n\nfile_names = os.listdir('Dataset\/Most_Stolen_Cars')\n\n#Remove Existing Folders if they exist\nfor folder in [test_folder, train_folder, val_folder]:\n    if os.path.exists(folder) and os.path.isdir(folder):\n        shutil.rmtree(folder)\n\n#Remake Category Folders in both Train and Test Folders\nfor category in file_names:\n    os.makedirs(test_folder + category)\n    os.makedirs(train_folder + category)\n    os.makedirs(val_folder + category)\n\n#Split Data by Train Ratio and copy files to correct directory\nfor idx, category in enumerate(file_names):\n    file_list = os.listdir(stolen_cars_path + '\/' + category)\n    \n    train_ratio = math.floor(len(file_list) * train_val_test_ratio[0])\n    val_ratio = math.floor(len(file_list) * train_val_test_ratio[1])\n    train_list = file_list[:train_ratio]\n    val_list = file_list[train_ratio:train_ratio + val_ratio]\n    test_list = file_list[train_ratio + val_ratio:]\n    \n    for i, file in enumerate(train_list):\n        shutil.copy(stolen_cars_path + '\/' + category + '\/' + file, train_folder + '\/' + category + '\/' + file)\n    sys.stdout.write('Moving %s train images to category folder %s' % (len(train_list), category))  \n    sys.stdout.write('\\n')\n    for i, file in enumerate(val_list):\n        shutil.copy(stolen_cars_path + '\/' + category + '\/' + file, val_folder + '\/' + category + '\/' + file)\n    sys.stdout.write('Moving %s validation images to category folder %s' % (len(val_list), category))                   \n    sys.stdout.write('\\n')\n    for i, file in enumerate(test_list):\n        shutil.copy(stolen_cars_path + '\/' + category + '\/' + file, test_folder + '\/' + category + '\/' + file)\n    sys.stdout.write('Moving %s test images to category folder %s' % (len(test_list), category))\n    sys.stdout.write('\\n')\n    \nprint(\"Done.\")  ","314276bc":"import random\nimport numpy as np\nfrom keras.preprocessing.image import ImageDataGenerator, array_to_img, img_to_array, load_img\n\n#Select a random image and follow the next step\ndatagen = ImageDataGenerator(rotation_range=45, \n                             width_shift_range=0.2, \n                             height_shift_range=0.2, \n                             zoom_range=0.3, \n                             vertical_flip=True,\n                             horizontal_flip=True, \n                             fill_mode=\"nearest\")\n#Load example image\nfile_list = glob.glob(\"Dataset\/test\/*\/*\")\nimg_path = random.choice(file_list)\nimg = load_img(img_path)\ncar_class = img_path.split(\"\/\")[1]\nplt.imshow(img)\nplt.axis(\"off\")\nplt.title(\"Original \" + car_class, fontsize=16)\n\nimg = img_to_array(img)\nimg = img.reshape((1,) + img.shape)\n#Apply different augmentation techniques\nn_augmentations = 4\nplt.figure(figsize=(15, 6))    \ni = 0\nfor batch in datagen.flow(img, \n                          batch_size=1, \n                          seed=21):\n    \n    plt.subplot(2, int(np.ceil(n_augmentations * 1. \/ 2)), i + 1)\n    plt.imshow(array_to_img(batch[0]))\n    plt.axis(\"off\")\n    plt.suptitle(\"Augmented \" + car_class, fontsize=16)    \n    \n    i += 1\n    if i >= n_augmentations:\n        break","da42fffe":"#Oversampling Minority Classes in Training Set\ndef data_augment(data_dir):\n    list_of_images = os.listdir(data_dir)\n    datagen = ImageDataGenerator(rotation_range=45, \n        horizontal_flip=True, \n        fill_mode=\"nearest\")\n    for img_name in list_of_images:\n        tmp_img_name = os.path.join(data_dir, img_name)\n        img = load_img(tmp_img_name)\n        img = img_to_array(img)\n        img = img.reshape((1,) + img.shape)\n\n        batch = datagen.flow(img, \n            batch_size=1, \n            seed=21,\n            save_to_dir=data_dir, \n            save_prefix=img_name.split(\".jpg\")[0] + \"augmented\", \n            save_format=\"jpg\")\n\n        batch.next()\n\nclasses_to_augment = [\n    \"toyota_camry_2014\",\n    \"nissan_altima_2014\",\n    \"toyota_corolla_2013\",\n    \"gmc_sierra_2012\"]\n\nfor class_names in classes_to_augment:\n    print(\"Currently Augmenting:\", class_names)\n    data_dir = os.path.join(train_folder, class_names)\n    data_augment(data_dir)","946896fc":"from functools import partial\n\n#Resize Images\nif __name__ == '__main__':\n    pool = Pool()\n    image_list = glob.glob(train_folder + \"\/*\/*\")\n    func = partial(vmmr_utils.resize_image, size=299)\n    pool.map(func, image_list)\n    pool.close()\n\nvmmr_utils.display_images(train_folder)","b4fd5995":"#Compare class distribution\nline_chart = pygal.Bar(height=300)\nline_chart.title = 'Most Stolen Car Training Class Distribution'\nfor o in os.listdir(train_folder):\n    line_chart.add(o, len(os.listdir(os.path.join(train_folder, o))))\ngalplot(line_chart)   ","a63ebd2c":"### Finalize Augmented Dataset for Training \n\n![Data Augmentation](assets\/EDA_1-5.png)\n\nBy using the augmentation techniques we have learned, we can oversample minority classes in training set. We are not going to do these steps in validation or test in order not to create any bias on the data. \n\n**Activity**\n\nClick the cell below and then click **Run**.","9057a249":"**Notices**\n\nCopyright (c) 2019 Intel Corporation.\n\nPermission is hereby granted, free of charge, to any person obtaining\na copy of this software and associated documentation files (the\n\"Software\"), to deal in the Software without restriction, including\nwithout limitation the rights to use, copy, modify, merge, publish,\ndistribute, sublicense, and\/or sell copies of the Software, and to\npermit persons to whom the Software is furnished to do so, subject to\nthe following conditions:\n\nThe above copyright notice and this permission notice shall be\nincluded in all copies or substantial portions of the Software.\n\nTHE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND,\nEXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF\nMERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND\nNONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE\nLIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION\nOF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION\nWITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n","84cfd661":"### 1.2 Subset of the Data\n\nAlthough we used the initial data set during our initial exploration, we are only providing a subset of the relevant data used for training.  This means that you don't have download an 11GB dataset but instead just use the existing data set provided with the notebook.  We maintained the original folder structure of the dataset but removed classes we're not utilizing.","364ac9f5":"## Summary \n**In this section of the training you learned**\n- Fetch and visually inspect a dataset \n- Create a dataset to address a real life problem\n- Image Preprocessing and Data Augmentation Techniques\n- Address Imbalanced Dataset Problem\n- Organize a dataset into training, validation and testing groups\n- Finalize an augmented dataset for training, and testing\n\nYou now should understand ways to find a data set and to prepare a data set for machine learning and training.","461ee624":"## Citations\n\nA Large and Diverse Dataset for Improved Vehicle Make and Model Recognition\nF. Tafazzoli, K. Nishiyama and H. Frigui\nIn Proceedings of the IEEE Conference on Computer Vision and Pattern Recognition (CVPR) Workshops 2017. \n","197d15d6":"### Create Train, Validation and Test Folders\n\n![Create Data Folders](assets\/EDA_1-4.png)\n\nWe need to create training, validation and test folders for data ingestion and we'll use 0.7, 0.1, 0.2 ratio for this purpose.\n\nClick the cell below and then click **Run**.","1b35ac0b":"### Look at Distribution of Selected Classes again\n\n![View New Data Distribution](assets\/EDA_1-7.png)\n\nNow that we've done some augmentation to the dataset we want to see how the distribution has changed compared to before the augmentation.  In this case we're only going to be looking at the train folder, since we only augmented the train dataset, so the numbers will be slightly lower than the full dataset distribution graph from earlier.  \n\nClick the cell below and then click **Run**.","2d938ca3":"### 1.1 Find a Data set\n\nArtificial intelligence projects depend upon data. When beginning a project, data scientists look for existing data sets that are similar to or match the given problem. This saves time and money, and leverages the work of others, building upon the body of knowledge for all future projects. \n\nTypically you begin with a search engine query. For this project, we were looking for a data set with an unencumbered license.\n\nThis project starts with [Vehicle Make and Model Recognition Dataset (VMMRdb)](http:\/\/vmmrdb.cecsresearch.org\/)   which is large in scale and diversity, containing 9,170 classes consisting of 291,752 images, covering models manufactured between 1950 to 2016. VMMRdb dataset contains images that were taken by different users, different imaging devices, and multiple view angles, ensuring a wide range of variations to account for various scenarios that could be encountered in a real-life scenario. The cars are not well aligned, and some images contain irrelevant background. The data covers vehicles from 712 areas covering all 412 sub-domains corresponding to US metro areas. VMMRdb dataset can be used as a baseline for training a robust model in several real-life scenarios for traffic surveillance. ","09226f23":"### Sample Augmentation\n\nWhile looking at our distribution above we saw that certain classes were significantly lower than others.  To help mitigate that issue we're going to augment some of our data set so that we have a dataset that is more closely distributed.  Below we're taking a look at an example image and showing the effets of augmentation given a certain threshold of modification.  Then we're going to apply these random augmentations to our data.\n\nClick the cell below and then click **Run**.","babf51e3":"# Data Wrangling with VMMRdb on CPU\n\n## Objective\n\nUnderstand ways to find a data set and to prepare a data set for machine learning and training.\n\n## Activities \n**In this section of the training you will**\n- Fetch and visually inspect a dataset \n- Create a dataset to address a real life problem\n- Image Preprocessing\n- Data Augmentation Techniques\n- Address Imbalanced Dataset Problem\n- Organize a dataset into training, validation and testing groups\n- Finalize an augmented dataset for training, and testing\n\nAs you follow this notebook, complete **Activity** sections to finish this workload. \n","2cb8838d":"### 2.2 Distribution of Selected Classes\n\n![View Data Distribution](assets\/EDA_1-3.png)\n\nNow, we can take a look at the class distribution of our problem statement. We're importing PyGal and creating a wrapper for rendering the chart inline, then passing in our data to the charting function.\n\nClick the cell below and then click **Run**.","27a683ee":"### 1.3 Hottest Wheels: The Most Stolen New And Used Cars In The U.S.\n\n![Create Dataset for Problem](assets\/EDA_1-1.png)\n\nThe most popular vehicle in America\u2014at least among thieves\u2014is neither a rip-roaring sports car nor a plush luxury sedan. Heck, it\u2019s not even an SUV. Instead, the most stolen vehicle is a plain vanilla 1996 Honda Civic that otherwise gets lost in a crowded parking lot. A total of 45,052 older-model Civics were pilfered last year. Among brand-new vehicles, another average family car tops the list, the Nissan Altima. Some 1,153 Altimas from the 2017 model year were taken last year.\n\nHere are the 10 most stolen used cars according to the NICB, with the most \u201cpopular\u201d model year noted along with the total number of units from all model years taken:\n\n- Honda Civic (1998): 45,062\n- Honda Accord (1997): 43,764\n- Ford F-150 (2006): 35,105\n- Chevrolet Silverado (2004): 30.056\n- Toyota Camry (2017): 17,276\n- Nissan Altima (2016):  13,358\n- Toyota Corolla (2016): 12,337\n- Dodge\/Ram Pickup (2001): 12,004\n- GMC Sierra (2017): 10,865\n- Chevrolet Impala (2008): 9,487\n\n### 1.4 Select and Merge Interested Classes\n\nIn this section, we're going to look at merging cars that are the same Make\/Model but look at the years nearby since cars usually look the same for 3-4 years before changing styles.  Below we'll see a dictionary containing the base car we're looking for and all the relevant cars that we're going to include in that category.\n\nHonda Civic (1998): 45,062\t        -> Honda Civic (1997 - 1998)\nHonda Accord (1997): 43,764\t        -> Honda Accord (1996 - 1997)\nFord F-150 (2006): 35,105\t        -> Ford F150 (2005 - 2007)\nChevrolet Silverado (2004): 30,056\t-> Chevrolet Silverado (2003 - 2004)\nToyota Camry (2017): 17,276         -> Toyota Camry (2012 - 2014)\nNissan Altima (2016):  13,358       -> Nissan Altima (2013 - 2015)\nToyota Corolla (2016): 12,337       -> Toyota Corolla (2011 - 2013)\nDodge\/Ram Pickup (2001): 12,004\t    -> Dodge Ram 1500 (1995 - 2001)\nGMC Sierra (2017): 10,865           -> GMC Sierra 1500 (2007 - 2013)\nChevrolet Impala (2008): 9,487\t    -> Chevrolet Impala (2007 - 2009)\n\nAfter merging the directories appropriately we're going take a look at a random subset of images in each of the categories.\n\nClick the cell below and then click **Run**.","094ce641":"### Resize Images\n\n![Resize Images](assets\/EDA_1-6.png)\n\nDepending on the toplogy, we need to resize the images with the expected image format. Since we're going to be using InceptionV3 in the next section we're going to match the size, 299x299, for that topology. \n\n**Activity**\n\nClick the cell below and then click **Run**.","d27f4b0b":"### 2.3 Confirm Folder Structure is Correct\n\nTo summarize and confirm our progress, we can take a look at the folder tree structure in **Most_Stolen_Cars** to take a look at our images we used to create a smaller subset. \n\nClick the cell below and then click **Run**.","ea8a6d9e":"### 2.1 Remove Invalid, Corrupt and Non-JPG files\n\n![Clean images](assets\/EDA_1-2.png)\n\nIn this section, we remove images that are not in \".jpg\" format or that can not be read by cv2 module. We're utilizing the multiprocessing function so that we can take advantage of all of the cores on our machine to make the process go quickly\n\nClick the cell below and then click **Run**."}}