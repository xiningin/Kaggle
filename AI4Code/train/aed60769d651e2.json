{"cell_type":{"30a67427":"code","77a410cf":"code","570145f2":"code","d1be60b9":"code","7288c130":"code","7930ccd8":"code","e1039cd0":"code","f5842fea":"code","2c438c3e":"code","973d8d72":"code","f535c5e9":"code","0e82cfc7":"code","ac8f2c2b":"code","cea0206e":"code","af568e36":"code","b8055898":"markdown","8d810c1e":"markdown","286d5ba2":"markdown","993f69bf":"markdown"},"source":{"30a67427":"import os\nimport re\nimport pickle\nimport numba\n\nimport numpy as np\nimport pandas as pd\nimport datatable as dtable\n\nimport matplotlib.pyplot as plt\n\nfrom tqdm.notebook import tqdm\n\nfrom sklearn import linear_model","77a410cf":"@numba.njit(fastmath = True)\ndef utility_score_numba(date, weight, resp, action):\n    Pi = np.bincount(date, weight * resp * action)\n    t = np.sum(Pi) \/ np.sqrt(np.sum(Pi ** 2)) * np.sqrt(250 \/ len(Pi))\n    u = min(max(t, 0), 6) * np.sum(Pi)\n    return u\n\n\n@numba.njit\ndef fillna_npwhere_njit(array, values):\n    if np.isnan(array.sum()):\n        array = np.where(np.isnan(array), values, array)\n    return array","570145f2":"data = dtable.fread(\"..\/input\/jane-street-market-prediction\/train.csv\").to_pandas()\ndata = data.astype({c: np.float32 for c in data.select_dtypes(include='float64').columns})\ndata = data.query('weight > 0')","d1be60b9":"FEATURES = [f for f in data.columns if re.match('^feature_', f)]\nAUC_TARGET = [f for f in data.columns if re.match('^rep_', f)]\nDATE = 'date'\nWEIGHT = 'weight'\nTARGET = 'resp'\n\n\nFILL_NAN_PD = 0 * data.mean(0)\nFILL_NAN = np.zeros((1, len(FEATURES)))\n\n\ndef utility(data, action):\n    return utility_score_numba(data[DATE].values, data[WEIGHT].values, data[TARGET].values, action)","7288c130":"idxT = data[DATE] <= np.quantile(data[DATE], 0.8)\nidxV = (~idxT) & (data[DATE] <= np.quantile(data[DATE], 0.9))\nidxO = (~idxT) & (~idxV)\n\nX_train = data.loc[idxT][FEATURES].fillna(FILL_NAN_PD).values\ny_train = (data.loc[idxT][TARGET] > 0.0).astype('int').values\n\nX_valid = data.loc[idxV][FEATURES].fillna(FILL_NAN_PD).values\ny_valid = (data.loc[idxV][TARGET] > 0.0).astype('int').values\n\nX_other = data.loc[idxO][FEATURES].fillna(FILL_NAN_PD).values\ny_other = (data.loc[idxO][TARGET] > 0.0).astype('int').values\n\nprint(\"Train = %d\\t\\tValid = %d\\t\\tOther = %d\" % (idxT.sum(), idxV.sum(), idxO.sum()))","7930ccd8":"min_date_train = data.loc[idxT]['date'].min()\nmax_date_train = data.loc[idxT]['date'].max()\n\nwmin, wmax = 0.5, 1.0\n\nweight_train = (data.loc[idxT]['date'].values - min_date_train) \/ (max_date_train - min_date_train) * (wmax - wmin) + wmin\n\nprint(\"Weight Train: %.4f\\t%.4f\" % (weight_train.min(), weight_train.max()))","e1039cd0":"model = linear_model.LogisticRegression()\nmodel.fit(X_train, y_train, sample_weight=weight_train)","f5842fea":"plt.figure(figsize=(16, 4))\n\npred_train = model.predict_proba(X_train)[:, 1]\nplt.hist(pred_train, 1000, density=True, color='tab:green', alpha=0.5, histtype='step', linewidth=1.5, label='train')\nif len(X_valid) > 0:\n    pred_valid = model.predict_proba(X_valid)[:, 1]\n    plt.hist(pred_valid, 500, density=True, color='tab:red', alpha=0.5, histtype='step', linewidth=1.5, label='valid')\nif len(X_other) > 0:\n    pred_other = model.predict_proba(X_other)[:, 1]\n    plt.hist(pred_other, 500, density=True, color='tab:blue', alpha=0.5, histtype='step', linewidth=1.5, label='other')\n\nplt.legend()\nplt.vlines(0.5, *plt.ylim(), color='k', alpha=0.5, linestyle='--')\nplt.xlim(0.4, 0.6);","2c438c3e":"plt.figure(figsize=(16, 10))\nplt.title(\"Prediction by target\")\nplt.subplot(3, 1, 1)\nif len(X_train) > 0:\n    plt.hist(pred_train[y_train >= 0.5], 1000, density=True, color='tab:green', alpha=0.5, histtype='step', linewidth=1.5, label='y=1')\n    plt.hist(pred_train[y_train < 0.5], 1000, density=True, color='tab:red', alpha=0.5, histtype='step', linewidth=1.5, label='y=0')\n    plt.xlim(0.4, 0.6)\n    plt.legend()\n\nplt.subplot(3, 1, 2)\nif len(X_valid) > 0:\n    plt.hist(pred_valid[y_valid >= 0.5], 500, density=True, color='tab:green', alpha=0.5, histtype='step', linewidth=1.5)\n    plt.hist(pred_valid[y_valid < 0.5], 500, density=True, color='tab:red', alpha=0.5, histtype='step', linewidth=1.5)\n    plt.xlim(0.4, 0.6)\n    \nplt.subplot(3, 1, 3)\nif len(X_other) > 0:\n    plt.hist(pred_other[y_other >= 0.5], 500, density=True, color='tab:green', alpha=0.5, histtype='step', linewidth=1.5)\n    plt.hist(pred_other[y_other < 0.5], 500, density=True, color='tab:red', alpha=0.5, histtype='step', linewidth=1.5)\n    plt.xlim(0.4, 0.6)","973d8d72":"print(\"Train Score = %.4f\" % utility(data.loc[idxT], pred_train > 0.5))\nif len(X_valid) > 0:\n    print(\"Valid Score = %.4f\" % utility(data.loc[idxV], pred_valid > 0.5))\nif len(X_other) > 0:\n    print(\"Other Score = %.4f\" % utility(data.loc[idxO], pred_other > 0.5))","f535c5e9":"res = pd.DataFrame()\nfrac = 0.6\nthr_list = np.linspace(0.47, 0.53, 51)\nfor rep in tqdm(range(10)):\n    for thr in thr_list:\n        sample_idx = data.loc[idxO].reset_index().sample(frac=frac).index.tolist()\n        ut = utility(data.loc[idxO].iloc[sample_idx], pred_other[sample_idx] > thr)\n        res = pd.concat([res, pd.DataFrame({'rep': rep, 'thr': thr, 'ut': ut}, index=[0])], axis=0).reset_index(drop=True)","0e82cfc7":"# use the lower bound to choose the threshold\nplt.figure(figsize=(12, 6))\nplt.scatter(res['thr'], res['ut'], color='tab:red', alpha=0.1, zorder=0)\n\nres_agg = res.groupby('thr')['ut'].agg(['mean', 'std'])\nres_agg['lwb'] = res_agg['mean'] - 1 * res_agg['std']\nres_agg['upb'] = res_agg['mean'] + 1 * res_agg['std']\nplt.plot(res_agg.index, res_agg['mean'], color='tab:red', zorder=-1)\nplt.fill_between(res_agg.index, res_agg['lwb'], res_agg['upb'], color='tab:red', alpha=0.1, zorder=-2)\n\nlwb_best = float(res_agg['lwb'].max())\nthr_best = float(res_agg.index[res_agg['lwb'].argmax()])\nprint(\"Best threshold = %.4f\" % thr_best)\n\nplt.scatter(thr_best, lwb_best, s=400, edgecolor='k', color='gold', marker='*', zorder=+1)\n\nplt.vlines(0.5, min(0, plt.ylim()[0]), plt.ylim()[1], color='k', linestyle='--', alpha=0.4)\nplt.hlines(0, *plt.xlim(), color='k', linestyle='--', alpha=0.4)\n\nplt.xlabel('Thr')\nplt.ylabel('Utility')\nplt.title('Best threshold');","ac8f2c2b":"try:\n    pickle.dump(model, open(os.path.join('..\/working', 'model.pkl'), 'wb'), protocol=pickle.HIGHEST_PROTOCOL)\nexcept TypeError:\n    model.save(open(os.path.join('..\/working', 'model.h5')))","cea0206e":"THR = thr_best","af568e36":"import janestreet\nenv = janestreet.make_env()\niter_test = env.iter_test()\n\nfor (test_df, sample_prediction_df) in tqdm(iter_test):\n    sample_prediction_df.action = (model.predict_proba(test_df[FEATURES].fillna(0.0).values)[:, 1] > THR).astype(int)\n    env.predict(sample_prediction_df)","b8055898":"# Plot & Summaries","8d810c1e":"# Submission","286d5ba2":"# Save","993f69bf":"https:\/\/www.kaggle.com\/gogo827jz\/jane-street-super-fast-utility-score-function\n\nhttps:\/\/www.kaggle.com\/gogo827jz\/optimise-speed-of-filling-nan-function"}}