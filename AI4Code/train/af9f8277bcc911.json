{"cell_type":{"dc44138b":"code","969c57ff":"code","96ca59c0":"code","bd0dd714":"code","eca0c2d3":"code","c0eb3b0f":"code","42d023b8":"code","7a42d979":"code","8b8b51da":"code","85923566":"code","29c6551f":"code","e7de2055":"code","9cd698f1":"code","1512bdfb":"code","b51a9af2":"code","a03224b9":"code","ae17c8b4":"code","9821d834":"code","901cf555":"code","145657ac":"code","2deb3d8a":"code","f0dcffbd":"code","8929786e":"code","1752acff":"code","70d63b95":"code","809da3ac":"code","42bde421":"code","db46748d":"code","a3b83494":"code","b7ca43d6":"code","4f8e2352":"code","df58d1b1":"code","67c7dbc8":"code","bcb4e04a":"code","3a6b8143":"code","445ad76a":"code","5cf9acb8":"markdown","309acb38":"markdown","fab6b97a":"markdown","b5450caa":"markdown","4c467cb8":"markdown","cc338703":"markdown","8dcc55f4":"markdown","b6f4083e":"markdown","7e6d6f01":"markdown","40f9bb8f":"markdown","35674969":"markdown"},"source":{"dc44138b":"%reload_ext autoreload\n%autoreload 2\n%matplotlib inline","969c57ff":"from fastai import *\nfrom fastai.vision import *\n\nimport os\nimport pandas as pd\nimport sys\n\nfrom collections import Counter\nfrom pathlib import Path\nimport numpy","96ca59c0":"path = Path('\/kaggle\/input\/plant-pathology-2020-fgvc7')\npath.ls()","bd0dd714":"path2 = Path('\/kaggle\/input\/plant-pathology-2020-fgvc7\/images')\n# path2.ls()","eca0c2d3":"df = pd.read_csv(path\/'train.csv')\ndf.head()","c0eb3b0f":"test_df = pd.read_csv('..\/input\/plant-pathology-2020-fgvc7\/test.csv')","42d023b8":"#transform the data to get a bigger training set\ntfms = get_transforms(flip_vert=True, max_lighting=0.1, max_zoom=1.05, max_warp=0.)","7a42d979":"# labels for our classes\nLABEL_COLS = ['healthy', 'multiple_diseases', 'rust', 'scab']","8b8b51da":"#dataloading of testset\ntest = (ImageList.from_df(test_df,path,\n                          folder='images',\n                          suffix='.jpg',\n                          cols='image_id'))","85923566":"test","29c6551f":"#making training set with API Block\nnp.random.seed(42)\nsrc=(ImageList.from_csv(path,'train.csv',folder='images',suffix='.jpg')\n    .split_by_rand_pct(0.2)\n    .label_from_df(cols=LABEL_COLS,label_cls = MultiCategoryList))","e7de2055":"data = (src.transform(tfms, size=253).add_test(test)\n        .databunch(num_workers=0).normalize(imagenet_stats))","9cd698f1":"data.classes","1512bdfb":"data.show_batch(rows=3, figsize=(12,9))","b51a9af2":"arch = models.resnet50","a03224b9":"acc_02 = partial(accuracy_thresh, thresh=0.2)\nf_score = partial(fbeta, thresh=0.2)\nlearn = create_cnn(data, arch, metrics=[acc_02, f_score], model_dir='\/kaggle\/working')","ae17c8b4":"# learn.lr_find()\n# learn.recorder.plot()","9821d834":"lr=1e-03\nlearn.fit_one_cycle(5,slice(lr))","901cf555":"learn.save('stage-1-rn50')","145657ac":"learn.unfreeze()","2deb3d8a":"# learn.lr_find()\n# learn.recorder.plot()","f0dcffbd":"learn.fit_one_cycle(5, slice(1e-5, 1e-3))","8929786e":"learn.save('stage-2-rn50')","1752acff":"tfms = get_transforms()","70d63b95":"data = (src.transform(tfms, size=399)\n        .databunch().normalize(imagenet_stats))\n\nlearn.data = data\ndata.train_ds[0][0].shape","809da3ac":"learn.freeze()","42bde421":"# learn.lr_find()\n# learn.recorder.plot()","db46748d":"lr=1e-3\nlearn.fit_one_cycle(5, slice(lr))","a3b83494":"learn.unfreeze()","b7ca43d6":"# learn.lr_find()\n# learn.recorder.plot()","4f8e2352":"learn.fit_one_cycle(5, slice(1e-6, 1e-4))","df58d1b1":"learn.save('stage-2-256-rn50')","67c7dbc8":"#plot losses to see how good the model trained\nlearn.recorder.plot_losses()","bcb4e04a":"#Make predictions on test set\npreds = learn.get_preds(DatasetType.Test)","3a6b8143":"test = pd.read_csv(path\/'test.csv')\ntest_id = test['image_id'].values","445ad76a":"submission = pd.DataFrame({'image_id': test_id})\nsubmission = pd.concat([submission, pd.DataFrame(preds[0].numpy(), columns = LABEL_COLS)], axis=1)\nsubmission.to_csv('submission_plant12.csv', index=False)\nsubmission.head(10)\nprint('Model ready for submission!')","5cf9acb8":"...And fine-tune the whole model:","309acb38":"# Data viewing","fab6b97a":"To put this in a `DataBunch` while using the [data block API](https:\/\/docs.fast.ai\/data_block.html), we then need to using `ImageItemList` (and not `ImageDataBunch`). This will make sure the model created has the proper loss function to deal with the multiple classes.","b5450caa":"Then we can fit the head of our network.","4c467cb8":"# Multi-label prediction with Plant Pathology dataset","cc338703":"We use the LR Finder to pick a good learning rate.","8dcc55f4":"# Importing data","b6f4083e":"# Training model","7e6d6f01":"# Submission","40f9bb8f":"Now we load the data again with a better image size, this improve the quality on the images \ntherefor it should be better at predicting.\nWe freeze and unfreeze the model again becouse we treat it as if, it was a new model that, just have had some pretraining ","35674969":"# Data prep with API Blocks"}}