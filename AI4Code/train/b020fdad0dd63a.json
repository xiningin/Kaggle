{"cell_type":{"06a1269d":"code","0965f9ec":"code","9d017810":"code","4408d99d":"code","fd5d3313":"code","4b54d395":"code","53defa40":"code","26cd5b9b":"code","e4e4986f":"code","e7f699d2":"code","3e55c22c":"code","8663ba76":"code","2244425e":"code","7647ae54":"code","fa6ed646":"code","9ad00321":"code","336a3dba":"code","c0c6b584":"code","c80c3473":"code","1dc9950d":"code","81e82efd":"code","047a989b":"code","845c9bac":"code","9fdca8ed":"code","cd1e0074":"code","2eb9f605":"code","5690392d":"code","c257f031":"code","e5661580":"code","1664efe4":"code","65ba61f5":"code","4a8f03f6":"code","29b94a71":"code","969ce6d8":"code","baf49bc9":"code","11579510":"code","af871cd0":"code","dbd5620a":"markdown","cb2b15ea":"markdown","0ecb4c3e":"markdown","8046fb2b":"markdown","07ae12de":"markdown","3a248144":"markdown","97424876":"markdown","736ca2e2":"markdown","b3b53e0f":"markdown","5d95ae94":"markdown","6b544795":"markdown","d28c5d28":"markdown","fd1be8e5":"markdown","772b68a4":"markdown","5a84139f":"markdown","d3b92ad0":"markdown","1101035e":"markdown","1aaecd6e":"markdown","6084e830":"markdown","91ebb751":"markdown","1aa1a565":"markdown","fe601ef8":"markdown","0215201c":"markdown","a05b9ef8":"markdown","0439efe8":"markdown","38561ede":"markdown"},"source":{"06a1269d":"import numpy as np\nimport pandas as pd\nimport matplotlib.pyplot as plt\nimport seaborn as sns\nimport os\nfor dirname, _, filenames in os.walk('\/kaggle\/input'):\n    for filename in filenames:\n        print(os.path.join(dirname, filename))\nhtl = pd.read_csv(\"\/kaggle\/input\/hotel-booking-demand\/hotel_bookings.csv\")\npd.set_option('display.max_columns', None)\nhtl.head()","0965f9ec":"htl.columns","9d017810":"# a general overview of data\n\nhtl.describe(include=\"all\").T","4408d99d":"# How many numeric variables are actually more of categorical variables?\n\ndescribe = []\nfor col in htl.columns:\n    describe.append(len(htl[col].value_counts()))\ndescribe","fd5d3313":"#form a description about all attributes we have, including col_name,data type,NA count and unique value count.\n\ndescribe = pd.DataFrame(list(zip(htl.columns,htl.dtypes,htl.isnull().sum(),htl.describe(include=\"all\").T['unique'],describe)),columns = ['col','type','NA','Ucount','count'])\ndescribe\n","4b54d395":"#Turn the following int variables to categoricals. 10 is more of an experimental number. We can change later based on the data we got after we get a deeper understanding about it.\n\nto_cate = describe[describe['Ucount'].isna()][describe['count']<10]\nto_cate","53defa40":"# Do the data manipulation on a copy of original data.\n\nimport copy\ndata = copy.deepcopy(htl)","26cd5b9b":"# Creating new variables for better visualization\n\ndata['is_children'] = ['Y' if x > 0 else 'N' for x in data['children']]\ndata['is_baby'] = ['Y' if x > 0 else 'N' for x in data['babies']]\ndata['is_agent'] = ['Y' if x > 0 else 'N' for x in data['agent']]\ndata['is_company'] = ['Y' if x > 0 else 'N' for x in data['company']]\ndata['is_parking'] = ['Y' if x > 0 else 'N' for x in data['required_car_parking_spaces']]\ndata['is_request'] = ['Y' if x > 0 else 'N' for x in data['total_of_special_requests']]\ndata['is_canceled_before'] = ['Y' if x > 0 else 'N' for x in data['previous_cancellations']]\ndata['is_changed'] = ['Y' if x > 0 else 'N' for x in data['booking_changes']]\ndata['is_waited'] = ['Y' if x > 0 else 'N' for x in data['days_in_waiting_list']]\ndata['is_room_changed'] = data[['reserved_room_type','assigned_room_type']].apply(lambda x:x['reserved_room_type'] != x['assigned_room_type'], axis=1)\n\n# Change data type\nfor i in to_cate['col']:\n    data[i] = data[i].astype('str')\n    \ndata['arrival_date_day_of_month'] = data['arrival_date_day_of_month'].astype('str')\ndata['is_room_changed'] = data['is_room_changed'].astype('str')\n\n# And set different data types apart\ncate = [var for var in data.columns if data[var].dtypes == 'object']\nnum = [var for var in data.columns if data[var].dtypes != 'object']","e4e4986f":"# Assign 0 to a negative Price data\n\ndata.loc[14969,'adr'] = 0","e7f699d2":"# Now we have 30 categorical variables\n\ncate,len(cate)","3e55c22c":"# And 12 numeric variables\n\nnum,len(num)","8663ba76":"# correlation for numeric variables\n\ncorrelation = data.corr(method='pearson')\ncorrelation[correlation >0.3]","2244425e":"# Distribution plots for all numeric variables.\n\nfrom scipy import stats\nfig = plt.figure()\n#plt.figure(figsize=(120,60))\ni = 0\nfor col in num:\n    try:\n        ax = fig.add_subplot(3,4,i+1)\n        sns.distplot(data[col], kde=True, fit=stats.norm)\n    except ValueError:\n        print(str(i)+ ' '+ 'ValueError')\n    except RuntimeError:\n        print(str(i)+ ' '+ 'RuntimeError')\n    i = i+1\nfig.set_size_inches(24, 24)\n","7647ae54":"# We get some Error Messages from the kde plot.Print the name and value_counts of the following attributes to see the cause.\n\nnum[4],num[5],num[6],num[7],num[10]","fa6ed646":"print(num[4] , ': ' , data.adults.value_counts().sort_index())\nprint('===========================================')\nprint(num[5] , ': ' , data.previous_cancellations.value_counts().sort_index())\nprint('===========================================')\nprint(num[6] , ': ' , data.previous_bookings_not_canceled.value_counts().sort_index())\nprint('===========================================')\nprint(num[7] , ': ' , data.booking_changes.value_counts().sort_index())\nprint('===========================================')\nprint(num[10] , ': ' , data.days_in_waiting_list.value_counts())","9ad00321":"# plots for all numeric variables to Y\n\nfig = plt.figure()\nplt.figure(figsize=(120,60))\ni = 1\nfor col in num:\n    ax = fig.add_subplot(3,4,i)\n    data.groupby(['is_canceled'])[col].mean().plot(kind = 'bar', ax = ax).set_title(col) \n    i = i+1\nfig.set_size_inches(24, 24)\n","336a3dba":"# Boxplots for all numeric variables to Y\n\nfig = plt.figure()\nplt.figure(figsize=(120,60))\ni = 1\nfor col in num:\n    ax = fig.add_subplot(3,4,i)\n    sns.boxplot(x = 'is_canceled', y = col, data = data, ax = ax).set_title(col) \n    i = i+1\nfig.set_size_inches(24, 24)","c0c6b584":"#To better check the longtail data:\n\nfig = plt.figure()\nfig.set_size_inches(12, 12)\nfig.add_subplot(2,2,1)\nsns.boxplot(x = 'is_canceled', y = 'stays_in_weekend_nights', data = data[data['stays_in_weekend_nights']<5]).set_title('stays_in_weekend_nights') \nfig.add_subplot(2,2,2)\nsns.boxplot(x = 'is_canceled', y = 'stays_in_week_nights', data = data[data['stays_in_weekend_nights']<7]).set_title('stays_in_week_nights') \nfig.add_subplot(2,2,3)\nsns.boxplot(x = 'is_canceled', y = 'adults', data = data[data['adults']<5]).set_title('adults') \nfig.add_subplot(2,2,4)\nsns.boxplot(x = 'is_canceled', y = 'adr', data = data[data['adr']<5000]).set_title('adr') ","c80c3473":"# plots for all categorical variables\n\nfig = plt.figure()\n#plt.figure(figsize=(140,60))\ni = 0\nfor col in cate:\n    if col == 'country' or col == 'reservation_status_date' or col == 'arrival_date_day_of_month' or col == 'arrival_date_month' or col == 'arrival_date_year':\n        pass\n    else:\n        ax = fig.add_subplot(5,5,i+1)\n        data[col].value_counts().plot(kind = 'bar', ax = ax).set_title(col)\n        i = i+1\nfig.set_size_inches(30, 30)","1dc9950d":"\ndef stack2dim(raw, i, j, rotation = 0, location = 'upper left'):\n\n#    plt.figure(figsize = (15, 10))\n    import math\n    data_raw = pd.crosstab(raw[i], raw[j])\n    data = data_raw.div(data_raw.sum(1), axis=0)  \n    \n    createVar = locals()\n    x = [0] \n    width = [] \n    k = 0\n    for n in range(len(data)):\n        \n        createVar['width' + str(n)] = data_raw.sum(axis=1)[n] \/ sum(data_raw.sum(axis=1))\n        width.append(createVar['width' + str(n)])  \n        if n == 0:\n            continue\n        else:\n            k += createVar['width' + str(n - 1)] \/ 2 + createVar['width' + str(n)] \/ 2 + 0.05\n            x.append(k)  \n    \n    y_mat = []\n    n = 0\n    for p in range(data.shape[0]):\n        for q in range(data.shape[1]):\n            n += 1\n            y_mat.append(data.iloc[p, q])\n            if n == data.shape[0] * 2:\n                break\n            elif n % 2 == 1:\n                y_mat.extend([0] * (len(data) - 1))\n            elif n % 2 == 0:\n                y_mat.extend([0] * len(data))\n\n    y_mat = np.array(y_mat).reshape(len(data) * 2, len(data))\n    y_mat = pd.DataFrame(y_mat) \n    \n    createVar = locals()\n    for row in range(len(y_mat)):\n        createVar['a' + str(row)] = y_mat.iloc[row, :]\n        if row % 2 == 0:\n            if math.floor(row \/ 2) == 0:\n                label = data.columns.name + ': ' + str(data.columns[row])\n                plt.bar(x, createVar['a' + str(row)],\n                        width=width[math.floor(row \/ 2)], label='0', color='#5F9EA0')\n            else:\n                plt.bar(x, createVar['a' + str(row)],\n                        width=width[math.floor(row \/ 2)], color='#5F9EA0')\n        elif row % 2 == 1:\n            if math.floor(row \/ 2) == 0:\n                label = data.columns.name + ': ' + str(data.columns[row])\n                plt.bar(x, createVar['a' + str(row)], bottom=createVar['a' + str(row - 1)],\n                        width=width[math.floor(row \/ 2)], label='1', color='#8FBC8F')\n            else:\n                plt.bar(x, createVar['a' + str(row)], bottom=createVar['a' + str(row - 1)],\n                        width=width[math.floor(row \/ 2)], color='#8FBC8F')\n\n    plt.title(j + ' vs ' + i)\n#    group_labels = [data.index.name + ': ' + str(name) for name in data.index]\n    group_labels = [str(name) for name in data.index]\n    plt.xticks(x, group_labels, rotation = rotation)\n    plt.ylabel(j)\n    plt.legend(shadow=True, loc=location)\n    plt.show()\n","81e82efd":"# Plots for all categorical variables to Y\n\nfig = plt.figure()\n#plt.figure(figsize=(140,60))\nfor col in cate:\n    if col == 'country' or col == 'reservation_status_date' or col == 'arrival_date_day_of_month' or col == 'arrival_date_month' or col == 'arrival_date_year':\n        pass\n    else:\n        stack2dim(data, i=col, j=\"is_canceled\", rotation = 40)\nfig.set_size_inches(30, 30)\n","047a989b":"# Time series. It contains 3 years of data and we wonder if each year\/month has some differences or strange outliers.\n\ndata['date'] = data['arrival_date_year'] + '-' + data['arrival_date_month'] + '-' + data['arrival_date_day_of_month']\ndata['date'] = pd.to_datetime(data['date'],  errors = 'coerce')\nimport datetime as dt\ndata['month'] = data['date'].dt.month\ndata['year'] = data['date'].dt.year\ndata.month.value_counts().sort_index().plot(kind=\"bar\")","845c9bac":"# What's the difference between city hotel and resort hotel?\n\npd.DataFrame(zip(list(data[data['hotel'] == 'City Hotel'].month.value_counts().sort_index()),list(data[data['hotel'] == 'Resort Hotel'].month.value_counts().sort_index())),\n            columns=['City Hotel', 'Resort Hotel'], index = [1,2,3,4,5,6,7,8,9,10,11,12]).plot(kind=\"bar\")","9fdca8ed":"data.year.value_counts().sort_index().plot(kind=\"bar\")","cd1e0074":"cross_table = pd.crosstab(data['month'],data['is_canceled'])\ncross_table.div(cross_table.sum(1), axis = 0).plot(kind = 'bar', stacked = True)","2eb9f605":"cross_table_year = pd.crosstab(data['year'],data['is_canceled'])\ncross_table_year.div(cross_table_year.sum(1), axis = 0).plot(kind = 'bar', stacked = True)","5690392d":"# assigned vs. reserved room and its cancelation rate. We want to check if the cancelation is related to the booking change caused by hotels.\n\nroomtype = data.groupby(['reserved_room_type','assigned_room_type','is_canceled'], as_index=False)['adr'].agg(['count', 'mean']).reset_index()\nroomtype.T","c257f031":"fig = plt.figure(figsize=(30,10))\nsns.boxplot(x = 'reserved_room_type', y = 'adr' , hue=\"assigned_room_type\",  data = data[data['is_canceled']== '1'][data['adr']<4000]).set_title('Canceled')\n#fig.set_size_inches(100, 60)","e5661580":"sns.boxplot(x = 'reserved_room_type', y = 'adr' ,  data = data[data['adr']<4000])","1664efe4":"sns.boxplot(x = 'assigned_room_type', y = 'adr' ,  data = data[data['adr']<4000])","65ba61f5":"# geo info. We want to check if our data is a global data.\n\ndef percConvert(ser):\n    return ser\/float(ser[-1])\ncross_table_cty = pd.crosstab(data['country'],data['is_canceled'], margins=True)\ncross_table_cty_p = cross_table_cty.apply(percConvert, axis=1)\n\ncross_table_cty['cancel_rate']= cross_table_cty_p['1']\ncross_table_cty.sort_values('cancel_rate',ascending=False).T","4a8f03f6":"cross_table_cty = cross_table_cty.reset_index()\ncross_table_cty[:-1].sort_values('All',ascending = False).T","29b94a71":"import folium\nfrom folium.features import GeoJson, GeoJsonTooltip\n\n# Initialize the map:\nm = folium.Map(zoom_start=1)\nurl = 'https:\/\/raw.githubusercontent.com\/python-visualization\/folium\/master\/examples\/data'\ncountry_geo = f'{url}\/world-countries.json'\n\n# Add the color for the chloropleth:\nm.choropleth(\n geo_data=country_geo,\n name='choropleth',\n data=cross_table_cty[:-1],\n columns=['country', 'All'],\n key_on='feature.id',\n threshold_scale=[0, 50, 100, 1000, 10000,48591],\n fill_color='YlGn',\n fill_opacity=0.7,\n line_opacity=0.2,\n legend_name='Country Reservation:color range from [0, 50, 100, 1000, 10000, 48591]'\n)\nfolium.LayerControl().add_to(m)\nm","969ce6d8":"# And finally just for fun. We always wondered when is the best time to book the reservation.\n# adr divided by total customer number, we get one night rate per person.\n\nrate = data[['hotel','adults','children','babies','assigned_room_type','adr','month','is_canceled']]\nrate['rate_p'] = rate['adr']\/(rate['adults']+ rate['children'].astype(float)+ rate['babies'].astype(float))\nrate.rate_p.describe()","baf49bc9":"rate['rate'] = [x if x <3000 else 0 for x in rate['rate_p'] ]\nrate.rate.describe()","11579510":"plt.figure(figsize=(30, 10))\nsns.lineplot(x='month', y='rate', hue='hotel', data=rate, ci='sd')","af871cd0":"sns.boxplot(x = 'is_canceled', y = 'rate', data = rate[rate['rate']<150]).set_title('rate') ","dbd5620a":"# Hotel Booking Data Analysis\n\n### - Data\n#### This data set contains booking information for a city hotel and a resort hotel, and includes information such as when the booking was made, length of stay, the number of adults, children, and\/or babies, and the number of available parking spaces, among other things.\n\n### - Question\n#### We would like to predict if a new reservation is likely to be canceled by customers and what's the probability of it? Also, how can we utilise this infomation and what can we do about it?\n\n### - Goal\n#### The aim is to do a complete data analysis including exploratory data analysis, feature engineering and finally choose the best model to solve our question by model comparison and parameter tuning.\n\n\n### - Content of this notebook\n#### This notebook is divided into 2 parts. \n#### The fist part includes data visulization, exploration and some feature engineering to help us better understand our data.\n#### The second part will be the data modelling part and we will build and compare different models to satisfy different business needs.","cb2b15ea":"# Load Data","0ecb4c3e":"### Room type GFHC are the most expensive ones.","8046fb2b":"#### People still prefer city hotel in the summer holiday season?","07ae12de":"# Next we will do some deepdive and begin the modelling part.\n\n## Feel free to contact me if you have any questions.\n## Please upvote and fork if you find this notebook useful! Many thanks!\n","3a248144":"#### Now we get some basic ideas of how the categorical attributes look like.","97424876":"# Data Visualization\nWe do the visualization for data modelling use. So the major part of the visualisation is related to the Y(is_canceled).","736ca2e2":"### Holiday seaon in the summer is a rip off... No wonder people choose city hotel instead.","b3b53e0f":"#### When Room Type A is not available, what's the second choice? And the cost? Seems like when the room is unavailable, the hotels will upgrade their customer?","5d95ae94":"#### We observed some differences regarding **avg.value** for these variables between Canceled and Not_Canceled:\n### **lead time, previous cancellation\/not, booking changes, agent, days in waiting list, adr**\nCould mean that these variables can be used in models.","6b544795":"# Data Review","d28c5d28":"#### Didn't see any differences here.","fd1be8e5":"#### 2016 is the best year for tourism.","772b68a4":"#### Looks like people won't cancel their hotel reservation due to price?","5a84139f":"#### Can deepdive later if interested.","d3b92ad0":"### We observe a strange **adr** min and max.\n#### And there are many categorical variables marked as numeric variables.","1101035e":"#### Cancelation rate seems different between holiday and non-holiday seasons.\n#### People like to search and compare for their holiday options?","1aaecd6e":"Maybe the dataset is mostly collected from Portuguese hotels?","6084e830":"# EDA","91ebb751":"#### Cancelation between years are stable.","1aa1a565":"### We found some missing values: \n* country: 488 missing\n* Agent:16340 missing\n* Company:112593 missing.\nWe can decide later what we want to do about it.\n\n### Also we can change some variable types for plots and create new variables based on intuition just to see what will happen.","fe601ef8":"#### Country table sorted by bookings and cancelation rate for future deepdive. ","0215201c":"#### Slight correlation between weekend nights\/week nights and agent\/company found.","a05b9ef8":"### We observe some differences of cancel rate between attributes.\n#### For example: \nHotel Type: Resort Hotels seem to have lower cancel rate than City Hotels\n#### Other attributes are: \n* market segment, \n* distribution channel, \n* is repeat guest,\n* assigned room type,\n* deposit type,\n* customer type, \n* required car parking spaces(is parking), \n* total of special requests(is request), \n* is agent, \n* is company,  \n* is canceled before, \n* is changed, \n* is waited, \n* is room changed","0439efe8":"### They are all longtail data can be illustrated later in categorical variables we newly created.","38561ede":"### The hot season is summer."}}