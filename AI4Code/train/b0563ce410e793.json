{"cell_type":{"33c51257":"code","d97941da":"code","35d85219":"code","5847a3e2":"code","ff8696cc":"code","f87a7ff1":"code","a0cfbb34":"code","3599693e":"code","9ee8f1c5":"code","210b2978":"code","45637cd3":"code","bc94ea42":"code","805d26f6":"code","b701c1dc":"code","d722f310":"code","cd91e924":"code","ee627936":"code","02bf2440":"markdown","334b5a9d":"markdown","7cf4a1d7":"markdown","aea30344":"markdown","f2f0331b":"markdown","f3b4cce4":"markdown","589ef3f5":"markdown","68fcdf44":"markdown","5aa0e136":"markdown","79d0b8ad":"markdown","2974771c":"markdown","8e87f5ef":"markdown","69ce5802":"markdown","dce0c679":"markdown","54a895d5":"markdown"},"source":{"33c51257":"!git clone https:\/\/github.com\/tensorflow\/models.git\n%cd \/kaggle\/working\/models\/research\n!protoc object_detection\/protos\/*.proto --python_out=.\n!cp object_detection\/packages\/tf2\/setup.py .\n!python -m pip install --user .","d97941da":"# make sure we have the right tf version\n!pip install tensorflow==2.4.1\n!pip install tensorflow-addons","35d85219":"!python object_detection\/builders\/model_builder_tf2_test.py > test.log","5847a3e2":"%cd \/kaggle\/working\/models\/research\/object_detection\/utils\n!cp autoaugment_utils.py autoaugment_utils.py.org\nwith open('autoaugment_utils.py.org', 'r') as f:\n    txt = f.read()\n# hack to make auto_augmentation work\ntxt = txt.replace('from tensorflow.contrib import image as contrib_image', 'from tensorflow_addons import image as contrib_image')\ntxt = txt.replace('from tensorflow.contrib import training as contrib_training', 'from collections import namedtuple')\ntxt = txt.replace('# TODO(barretzoph): Add in ArXiv link once paper is out.', 'def hparams(**kwargs):\\n    return namedtuple(\\\"HParams\\\", kwargs.keys())(*kwargs.values())\\n\\n')\ntxt = txt.replace('augmentation_hparams = contrib_training.HParams(', 'augmentation_hparams = hparams(')\nwith open('autoaugment_utils.py', 'w') as f:\n    f.write(txt)\n# copy the file to the installation directory\n!cp autoaugment_utils.py \/root\/.local\/lib\/python3.7\/site-packages\/object_detection\/utils\/.\n%cd \/kaggle\/working\/models\/research","ff8696cc":"MODEL = \"faster_rcnn_resnet50_v1_1024x1024_coco17_tpu-8\"\n\n%cd object_detection\n!mkdir pre-trained-models\n%cd pre-trained-models\n!wget http:\/\/download.tensorflow.org\/models\/object_detection\/tf2\/20200711\/{MODEL}.tar.gz\n!tar -xf {MODEL}.tar.gz\n!rm {MODEL}.tar.gz","f87a7ff1":"# first make a copy of the original pipeline.config file\n%cd \/kaggle\/working\/models\/research\/object_detection\n!cp \/kaggle\/working\/models\/research\/object_detection\/pre-trained-models\/{MODEL}\/pipeline.config \\\n    \/kaggle\/working\/models\/research\/object_detection\/pre-trained-models\/{MODEL}\/pipeline.config.org","a0cfbb34":"from object_detection.utils import config_util\n\nconfig = config_util.get_configs_from_pipeline_file(f'\/kaggle\/working\/models\/research\/object_detection\/pre-trained-models\/{MODEL}\/pipeline.config.org')","3599693e":"model_config = config['model']\nmodel_config.faster_rcnn.num_classes = 7\ntrain_config = config['train_config']\ntrain_config.fine_tune_checkpoint = \"\/kaggle\/working\/models\/research\/object_detection\/pre-trained-models\/\"+MODEL+\"\/checkpoint\/ckpt-0\"\n# GPU memory limits batch size\ntrain_config.batch_size = 2\ntrain_config.use_bfloat16 = False\n# some models use \"fine_tune\" rather than \"detection\" for fine-tuning\ntrain_config.fine_tune_checkpoint_type = \"detection\"\n# set auto-augmentation\ndel train_config.data_augmentation_options[:]\na1=train_config.data_augmentation_options.add()\na1.autoaugment_image.policy_name = \"v2\"\n# training dataset (80%)\ntrain_input_config = config['train_input_config']\ntrain_input_config.label_map_path = \"\/kaggle\/input\/tensorflow-tfrecords-demystified\/ArTaxOr.pbtxt\"\ntrain_input_config.tf_record_input_reader.input_path[:] = [\"\/kaggle\/input\/tensorflow-tfrecords-demystified\/ArTaxOr-????0-of-00050.tfrecord\",\n                                                           \"\/kaggle\/input\/tensorflow-tfrecords-demystified\/ArTaxOr-????2-of-00050.tfrecord\",\n                                                           \"\/kaggle\/input\/tensorflow-tfrecords-demystified\/ArTaxOr-????3-of-00050.tfrecord\",\n                                                           \"\/kaggle\/input\/tensorflow-tfrecords-demystified\/ArTaxOr-????4-of-00050.tfrecord\",\n                                                           \"\/kaggle\/input\/tensorflow-tfrecords-demystified\/ArTaxOr-????5-of-00050.tfrecord\",\n                                                           \"\/kaggle\/input\/tensorflow-tfrecords-demystified\/ArTaxOr-????6-of-00050.tfrecord\",\n                                                           \"\/kaggle\/input\/tensorflow-tfrecords-demystified\/ArTaxOr-????7-of-00050.tfrecord\",\n                                                           \"\/kaggle\/input\/tensorflow-tfrecords-demystified\/ArTaxOr-????9-of-00050.tfrecord\"]\n# evaluation dataset (20%)                                                           \neval_input_config = config['eval_input_config']\neval_input_config.label_map_path = \"\/kaggle\/input\/tensorflow-tfrecords-demystified\/ArTaxOr.pbtxt\"\neval_input_config.tf_record_input_reader.input_path[:] = [\"\/kaggle\/input\/tensorflow-tfrecords-demystified\/ArTaxOr-????1-of-00050.tfrecord\",\n                                                          \"\/kaggle\/input\/tensorflow-tfrecords-demystified\/ArTaxOr-????7-of-00050.tfrecord\"]\n# save pipeline.config file\npipeline_proto = config_util.create_pipeline_proto_from_configs(config)\nconfig_util.save_pipeline_config(pipeline_config=pipeline_proto, \n                                 directory=f'\/kaggle\/working\/models\/research\/object_detection\/pre-trained-models\/{MODEL}')","9ee8f1c5":"!cat \/kaggle\/working\/models\/research\/object_detection\/pre-trained-models\/{MODEL}\/pipeline.config","210b2978":"%cd \/kaggle\/working\/models\/research\n!python object_detection\/model_main_tf2.py \\\n    --num_train_steps=60000 \\\n    --pipeline_config_path=\/kaggle\/working\/models\/research\/object_detection\/pre-trained-models\/{MODEL}\/pipeline.config \\\n    --model_dir=\/kaggle\/working\/training\/ \\\n    --alsologtostderr &> \/kaggle\/working\/train.log","45637cd3":"!tail -n 10 \/kaggle\/working\/train.log","bc94ea42":"import re\nimport matplotlib.pyplot as plt\n%matplotlib inline\n\nwith open('\/kaggle\/working\/train.log', 'r') as f:\n    data=f.read()\nloss=[]\nl = re.findall(\"loss=[.0-9]+\", data)\nfor r in l:\n    loss.append(float(r.split('=')[-1]))\n\nstep=[]\ns = re.findall(\"Step [0-9]+\", data)\nfor r in s:\n    step.append(int(r.split(' ')[-1]))\nplt.figure(figsize=(16, 8))\nplt.plot(step,loss)\nplt.legend(['model loss'])\nplt.xlabel('Global step')\nplt.title('Learning curve');","805d26f6":"!python object_detection\/model_main_tf2.py \\\n    --pipeline_config_path=\/kaggle\/working\/models\/research\/object_detection\/pre-trained-models\/{MODEL}\/pipeline.config \\\n    --model_dir=\/kaggle\/working\/training\/ \\\n    --checkpoint_dir=\/kaggle\/working\/training\/ \\\n    --eval_timeout=30 \\\n    --alsologtostderr\n","b701c1dc":"!cp \/kaggle\/working\/models\/research\/object_detection\/pre-trained-models\/{MODEL}\/pipeline.config \/kaggle\/working\/training\/.","d722f310":"!python object_detection\/exporter_main_v2.py \\\n    --input_type image_tensor \\\n    --pipeline_config_path=\/kaggle\/working\/models\/research\/object_detection\/pre-trained-models\/{MODEL}\/pipeline.config \\\n    --trained_checkpoint_dir \/kaggle\/working\/training\/ \\\n    --output_directory \/kaggle\/working\/exported-models\/effdet_d2","cd91e924":"!ls -al \/kaggle\/working\/exported-models\/effdet_d2\/saved_model","ee627936":"# clean-up \n%cd \/kaggle\/working\n!rm -fr .\/models","02bf2440":"Follow the instructions [here](https:\/\/github.com\/tensorflow\/models\/blob\/master\/research\/object_detection\/g3doc\/tf2.md).","334b5a9d":"## Evaluation step\nEvaluation of the test set takes about 10 minutes.","7cf4a1d7":"# Next steps\n  * [Make predictions with the saved model](https:\/\/www.kaggle.com\/mistag\/tf2-object-detection-api-make-predictions)","aea30344":"# Install Object Detection API","f2f0331b":"Test the installation:","f3b4cce4":"In this notebook we will train a object detection model using the [TensorFlow Object Detection API](https:\/\/github.com\/tensorflow\/models\/tree\/master\/research\/object_detection). This is an update of the [TF Object Detection on Custom Data](https:\/\/www.kaggle.com\/mistag\/tensorflow-object-detection-on-custom-data) notebook which was based on TF1.\n\nThe TFRecords dataset is created in [this notebook](https:\/\/www.kaggle.com\/mistag\/tensorflow-tfrecords-demystified).","589ef3f5":"# Install a model from the model garden\nChoose from a large selection of object detection models in the [TensorFlow 2 Detection Model Zoo](https:\/\/github.com\/tensorflow\/models\/blob\/master\/research\/object_detection\/g3doc\/tf2_detection_zoo.md).","68fcdf44":"## Hack to enable auto-augmentation\nThe auto-augmentation policy does not work in the current release, so a hack is made below to make it work.","5aa0e136":"Copy the piplie.config for later use:","79d0b8ad":"Check the contents of the pipeline.config file:","2974771c":"# Export trained model\nFinally the trained model is exported in saved-model (.pb) format.","8e87f5ef":"# Training\nTraining on this dataset is lenghty, and we try to maximise the number of steps possible within 9 hours. Note that the selected model needs more training though, so don't expect great performance.","69ce5802":"![logo](data:image\/png;base64,iVBORw0KGgoAAAANSUhEUgAAAdoAAABqCAMAAAAsh2BcAAAA\/1BMVEX\/\/\/9CUGb\/hwD\/jQD\/hQA7SmH\/kQD\/jwD\/gwD\/gQBATmX\/jAD\/iAD\/8N3\/wpP\/fgD\/lgDT1dkwQVvw8fP\/mQBYY3bo6eyBiJUnOlb\/lTf\/nwCRmaRLWG3\/dAD\/eQA2Rl6LkZ3\/38Gcoavg4uX\/5dL\/uldha32vtb10fYy4vcSlq7TMz9TDx86ZoKv\/\/PVQXXFrdYX\/1Kr\/bAD\/vWv\/0Z3\/8eL\/n0L\/v4P\/qFf\/tnb\/27j\/zaH\/jx7\/sF\/\/t2z\/ypP\/oDH\/q0n\/nFD\/tX7\/37n\/iSr\/kUD\/xHv\/1rz\/zYr\/q3f\/qS0dM1D\/4b3\/pzz\/uYn\/2Kf\/3Mb\/t0wAHUP\/nDEuO0Y2AAAPVklEQVR4nO2di3bbNhKGKSe0Y9iJJVIk1egCWXQlSpQlJam7bZxum6Zt0iTtbnb3\/Z9lSQKDGyGSUijL8sF\/TnsqGiQuHzAYDEDWsoyMjIyMjIyMjIyMjIyMHrgWL24s6\/XTfRfDqHZdfn+aYH325B+LfZfEqFZd\/XDx+ChF+\/jo\/NbAfTha\/Hj+5OjoPEN7dnb+\/et9F8ioJt2+SYYsQ\/vo0dnRT2bKfQi6PLt48lhCm8A9\/+fNvstl9JVKJtnThKyC9uTkrPmzmXIPWYt3pwlZHdoE7i9myj1YLZ6dDk4Tslq0x8cn528v911Eo220+PB4cHFagDaV8acOUFe\/ZmCL0TaP23+aKfewdPOxP7iogLaZwH2x78IaVdfi3SABWw1tAvfTb\/susFE1LW5\/72dkK6JNZKbcg9CXP\/pkzFZG22432+\/NlHvfdfXry8FgY7Qp3O8M3Pusm4+D\/mArtInMlHuP9ez3l4TsVmjb7W\/NlHs\/9YGB3RZtu\/3K7BrcP33542W\/\/5Vonz9vPy8KYbitynLvruZ1KaxYqdmEaHo3xbr52E\/JfjXaBO6n39bCbXWcqmrdTb3rVFRWu8\/zLN1nnMlZ3kmpbgYZ2DrQJnBfrcumhRtVFd5JvWtVYJfUySFoO+QX8u6kVFf9fn1on3+7LhuDNpVBe3AyaA3ah4kWyeLVVv9w0GiRXvcJ7UUZ2uPN0Ia9pSSvB43R85S\/HDJatTKgXpyluwdoB9+8KTtl8TaDWxmt5ctyoTXsoav86U6qXa9YZQK1Mqy+Wbq9ox2cPrO+KUH76PLpTyeboFU1hNbo7rByd6WgYmX2jHYweLewKqC1rL\/+Pm4atKkOA23\/jy\/p5SporcXP7aZBax0G2v7gA7lcCa1lPX110jRoDwBtf\/AvCAJXRGtZl2+bu0Drt6ajIAi6k5bGrfJdIvgdxpPZbBoXbCyEcZJkEsdh8d6DG7biOG6FWlfOlXJN85zGNGEtaAsz30Ycbb\/\/K9+Xq4zWWvz7ee1o42BpY2zbyb\/wMpoqPFzPG6fyssWiO1n1SNAdeYFua8GNg3EPO2kK3POC+Tq67jTwGshxHLvhrUb5JRjJdOyl2zatKMvTCcifvh6tO08K2cgyX666cjXmQyoZeotclHeR3ICmbQloX55+EJJUR2tZN++btaKNV47NQxrIdjyl+D07iwPg6+THZMkTIxtHOXDTsfK05UxXHrfbkB7krOZKCodGHyaWdU2T2hH501ejnfUgc5RlPhZrPHXsTE4s3RNkl3Ek17aTJcVOyNC+HDyTkmyCNplyv6Xjtga0btBRw3bIkYi5PdIKuGv5KwdJKXFPHm5qguxpXn5wj0T+pGDOSn4UprlOrAieWRPaCcZK5kkZOUcXSjSU7nLoZamUXRLQRWOXof2onJHYDK1l\/fapXQ\/acKyLx+KVYIwArR34Xi6x7Ylma77UPc1uTORM3ZUuxG0jaeDS5re7I5a4FrRupPaqLI3NyzimA1ra5m1RtFgc4O7K5gVJ0b78\/YtaiDK0xz8pfWHxZ7sOtH5PH2nHKz5uAS2K8mRT4EL1G5pGS+90JBOv706pDRCTUbTI4yTqQKvvVmmV2cQBfQmLtmsEeYoW2adNk8WsrxJbfJsvRCna40fqW7ZPX7W\/Gq3LRxnKHCnWipgTA7QNssmA0slFmE0xM2Uuu5xMPp1OxxEeLthkV+hOSHmWwBaMptBb6kA75mTlzBvOiCaBbTMsWBF3DMXpCcBjOpQ76Y+rwUfdqZdStM3m8S\/qKz9\/ffpPcdUE6dFG0MgIj4fXo27iiLKKsnoxtATaMgqC1ZLPVnxKuqY32yiY+pmrzHac7JUm0wa2x1EQeVjwp\/hMlpsPUR1oh6zGNvaSzFc2Rw2dFDDaI35fyGcFwbu6Jk9D4\/THzZW2EBXQJnDVt0IWfxVXTZAW7QTKay\/pise\/btCEmWdAaiqgxSuytvRjblTBbrl0gNncbYqXjC27NgV\/BKFutu5144i325gVTkSLsN3o9ZK\/kqy2RxuDR4bsKKuJ2+qy\/oeWtCb0+aLtnbEiYiFTOtVi7SKAqhLaRK+2fXFAh5YZUFuYWVswobL5kaNFYh3Y4INFAjCzBcfKh0QsXxdo28J24pRxdJg3I6DFjVEcummMgfxpa7TcrCJu+kPmQmTLO4t3ecSbhZsawbuCutjyMklWVbRbvxWiQwvuAuutpKaQEmwoR2uLLqzr0cuY2i3o61J7T2ylQZjVlhaIMZvPl9AxBJM\/smTxTT3tsVWWLod24kAu4hIG\/NxkHiWXXUfutEmjLHlHc9i9LXCli4JuFdGmr\/z8vdWLAxq03D2SowVd6KAtJR2Wm5j5jNTjAuskecM+nAHo0IfRNkKO3BxTMHgYhi1zo3DuGLFwgEZzxKLD0uXQwqB15Br74KuBsaXpuJGaC241v0pHt9xLVVVH225+V\/SgddKgZQZUKVmoNDJD21HSyfeDsVNI9DpE\/6WZgvep2tKIzfH0AqBVIgepis9GrUcbQwhKDU\/BTIoa5PdIZSbmmLuKlWW7rH2ghcbMHTKnlhaqsA6ty2Zq8huW74FVIGb71EzZQT1wuJhBzlu7bdFCI+TtANxL1zsxDTKxeAy5ESyQfFVyLvLaA1qYK6WFWibacqhHE65DC6EMT\/ZbsRoNFgWTXT5iz8w+bXcIWfTyD9kWLXMacpsRXTAmxNi60Fq0mxHU9nCFxBL6pDJ8LaHVHtC2lKmSi67W2PRYipb0Wr6q6a6tK4TrNEOb+VdD8rt+tO76nSDWGNRSweRCTS1xK\/CcTCdQeDq5lPjpe0ALJPKLMvAZHIJsPVpoKSVdAzurqf6g5BSvyxSMIJts60cbr3EuEvnMAya\/FQeJkHZcn8TjqEdM\/U2nyErtBS2MkkbPUwRTCvX9q45aPmzToFXDCyb5nXjIVPMSWchuJr+3RuuwdApaWK7C8lXUCnxnUmRY1pCyEIcx7XOZf4LIOhbWTE7xeYM9oF1\/Tpu10YZorUCMvKdB6XGg9GhYWKG858EGDs2mAlo78EONWDoFLfjBeS9K8CnpynZM4+UhvzG1zuS\/SCP69Onj\/NNEbYJWs7tQrjzaqLDrb4XWGiq7telO\/Ejs1Kw\/5dGyEAidB6qg3SwadV2AFh4J5mQoLtJpUyWY\/Q4vE7XvhVFGq8rOT+1oxzKFWtBa80Yuqo+xcBIlKkDL4gmkdXeHVjc5dhW0c8It8+nCrKJkjUf6Xza2YW+g5AXl8lF7XLdB3glay+\/2VLgN3IO2BHywXpIex9ASm7hDtBoXb6igpcuf7FbiVtrZDE195XSkkqk2v3ZUVHrK4vV3J8c7GrXZaTfdP50t0CZwJ8sOlg8yoA4EtgpGre9tPtduaZA1ozYXvwEfyYfsSIcgAa3Uc6a+QXGU0ap0gGbxnrw80Py55FlarZ9rUTBao2vqUmyGNlE4iXqOhBdaswjtFm7UZmgruVGAliZO05KH0MAEKWXiBsa6kLlGlc5GPX2bfe+tJrTro26Kqq5r5T+G0+HYFnbCpKVgA+dtYgvS2uR3\/WgLFtV8NgDz2mKTLWEIKyY6hKewlEJlbzpWPPb24nmzNrSsD6tbZrlqbzxqIUEcYLYVOpEy1XgyW4QsNkQbrw+FsdmgwS4RZz9xnkiZYYMvhoAUGeclUUZrgxONf7aPa0KrNuVabY02kQ+HMWjzQuvmNn44dWj4+tEWBhqR2hjURPdC6hRDjTKLnDxCtzutU\/XDqjev3pc9TKc82pAFnUpMyteg5atVcjNscmv6E5hEiNvWj7Zge2CUD1RR841ntjzSs5ZEiNrjkiijteHbA2UP00mzqQexteJduKpop6uISOE8kVcczPCpq0EfopTKpl6daNn+Tm6DlZ0Y4aR44FP+AwmnoiV5dEmU0dr8iPnG0qBlQWTN0Z6pdLi0Elr6OgVWmMGGPY0xsRl+qOTIT\/PQCztAy7bi1WfGrCkEUuLCH\/VYj3XFaKp4UnON9oEWDkGJ5WZVtbnfXA0tO7yrvp4go+XTgNwF\/HUHaOpEy42+4iPDdWmRyg4SKX8QI7RlUUZrP2h5QNdW3LxpMpfg\/Dnk4sUP+EvKkhVsA9zMltOe\/uSZeuytVrT8yKlkqNhlLF6O+UaWtEKc8GGLCs8yEu0FbdhhnVJ4m8nyg7RVkZ07rFrsRg3Bw5X6yZz1HnqBH5RZ8nHLHGnBj9kFWn5YVWQ7sdVCksScrLRTFQqjFhUXINVe0Fr8RSmEV\/MwfVE5nEf0fQ74+FJVtPD+S\/r2Flv3R9DzebdnmaIOfbE1nGE+N7B+sQu0Vgy9GTndEMrI35iQJwm+7SlHE\/kkXBpltPaFVpw2bNzzxt64x1sZzupWXfwws4ZsL5jNJ7PhuMEeJuwH8JfCcGMcDYcr\/jaK6KHuBC2zLemmxWp43Q14GXNugvDGgDSl8hFRGsmz9oZWeqtS\/iocn2wrr2t590+34bEYRBYj8qHwhlb2bhgvgti4u0Erv84lvsCWzBDK7SGbbOWlf4vdUxpltPaGNn1VT7+3Zwsv4FUOWaxy+3lUHWkhGaI1pwAcMea5I7TuGOszF987peIGTK44RARQ\/pa89oXWcgMtDjzm\/bE62jUPs5ESImhpOxSSzd6O0FpupGOLnGD9eWc1zA6hD83p97z2hjZd6eT3zm3x1MsmgcZpfiPexqvcOQQ\/wurARdiTFxK7Qpsej8hZDdzQLVBhq0hd4sCR2\/Ioo3UHaAP49ka+NdyJuLmaTpNdaWnqNsh33vFn5b4GjT8txeQTT35Y\/vsjmeZjR6CLbIe71VTkAyAJhYLKDIsr\/RkKqFwPA3E3Oa3xtXbSDGkN1fvdHs2\/yv+3YedoJ\/DFHK1PF3ejJcq+2m97kdrG7oxKOePpwiOVE+XxNX2Y3RsHs7VbB63uquGQzxTZ3jC\/9IfP9gw3rUz+Efnu7M+ipeOkh0kcvAzUGvMHZFHxVW7bc0YC5pU+r7ZztKVKj33GcVjyEa8NHpbIL\/siWDifzkbTeT2Zbig\/jKeT6yTzHX9bdv9ojXYkg\/bByqB9sCpDe27QHqpujwYFaE\/O1C+CGR2OFu+eXJzq0Z48+rv6R4SM7qGufkjYatCeHavfeTM6OF2+uXiioj07+9GAfQi6fXMhoT07Vz\/wZnSoWvx49IShPTv\/3+t9F8ioPiVT7mOC9ujo1tjih6XL708ztGaSfXha3Car2Bf6T7AaGRkZGRkZGRkZGRkZGRkZGRkZGRk9WP0fMJw3ttS2wi8AAAAASUVORK5CYII=)","dce0c679":"Plot the training curve by parsing the log file:","54a895d5":"## Edit pipeline.config\nThe pipeline.config file is in protocol buffer format, and we can use the config_util to change the settings we need."}}