{"cell_type":{"26a107cf":"code","191612c3":"code","822e1c3c":"code","3bf5359a":"code","6b62f185":"code","31138d40":"code","7da12450":"code","d604af6b":"code","532612c3":"code","98e81c95":"code","cac4f889":"code","555f1851":"code","f21ab534":"code","1c547786":"code","57c813bc":"code","c551f471":"code","f0ed6c8e":"code","04ca988c":"code","51419392":"code","a2f2aa97":"code","4e262305":"code","881af2de":"code","1d59f7a9":"code","74e14f33":"code","b3b59948":"code","90e1a55d":"code","249a0c3d":"code","e538df1a":"code","ec71a60c":"code","04c5a758":"code","966c1f58":"code","d708df28":"code","168292a6":"code","9a7986ed":"code","6f6df05b":"code","ee0de169":"code","1dc074b5":"code","7d602bb1":"markdown","240cc433":"markdown","68ee365f":"markdown","03cfbcbc":"markdown","7595a6e4":"markdown","1c035564":"markdown","64204d1a":"markdown","9cf1131b":"markdown","0c06497d":"markdown","781f97e3":"markdown","76dc0cca":"markdown","d82bca7e":"markdown","ed604a49":"markdown","3ff968ea":"markdown","7d86f1d8":"markdown","a8f130f6":"markdown","1a6836d2":"markdown","0c829678":"markdown","0f5fec7a":"markdown","cd9006ef":"markdown","1d039520":"markdown","5b592887":"markdown","67b77706":"markdown","16fcbd3d":"markdown"},"source":{"26a107cf":"import pandas as pd\nimport numpy as np\n\nfrom datetime import datetime\nimport matplotlib.pyplot as plt\nimport seaborn as sns\nimport plotly_express as px\n%matplotlib inline\nimport plotly.offline as py\npy.init_notebook_mode(connected=True)\nimport xgboost as xgb\nimport lightgbm as lightgbm\nfrom catboost import Pool, CatBoostRegressor\nimport shap\nimport warnings\n# import the_module_that_warns\n\nwarnings.filterwarnings(\"ignore\")\n\nfrom fbprophet import Prophet\nfrom sklearn.metrics import mean_squared_error\nfrom sklearn.linear_model import LinearRegression\nimport missingno as msno","191612c3":"df_raw_train = pd.read_csv(\"..\/input\/predict-demand\/train.csv\")\ndf_raw_train.head()","822e1c3c":"df_raw_train.info()","3bf5359a":"msno.matrix(df_raw_train)","6b62f185":"fig = px.histogram(df_raw_train['quantity'],title='Distribui\u00e7\u00e3o dos dados de Venda Agrupados')\nfig.show()","31138d40":"df_raw_train[['price','quantity']].describe()","7da12450":"df_raw_train.columns","d604af6b":"df1 = df_raw_train.copy()","532612c3":"df1.isna().sum()","98e81c95":"df1 = df1.dropna()","cac4f889":"df1.isna().sum()","555f1851":"df1.groupby('shop')['quantity'].sum().sort_values(ascending=False)","f21ab534":"fig = px.box(df1,y='quantity',x='shop',title='Dispers\u00e3o de Venda por Shop')\nfig.show()","1c547786":"df1.groupby('brand')['quantity'].sum().sort_values(ascending=False)","57c813bc":"fig = px.box(df1,y='quantity',x='brand',title='Dispers\u00e3o de Venda por Brand')\nfig.show()","c551f471":"df1.groupby('city')['quantity'].sum().sort_values(ascending=False)","f0ed6c8e":"fig = px.box(df1,y='quantity',x='city',title='Dispers\u00e3o de Venda por Brand')\nfig.show()","04ca988c":"def rmse(ytrue, ypred):\n    return np.sqrt(mean_squared_error(ytrue, ypred))","51419392":"df1['date']=pd.to_datetime(df1['date'])\nprint('Data inicio: {}   Data fim: {}'.format(df1['date'].min(),df1['date'].max()))","a2f2aa97":"dfgroup = df1.groupby('date')['quantity'].sum()\npx.line(dfgroup)","4e262305":"df1['day']=df1['date'].dt.day\ndf1['week']=df1['date'].dt.week\ndf1['month']=df1['date'].dt.month\ndf1['year']=df1['date'].dt.year\ndf1['dow']=df1['date'].dt.dayofweek","881af2de":"df1","1d59f7a9":"df1.columns","74e14f33":"columns=['id','lat','long','pop']\ndf2 = df1.drop(columns=columns)\ndf2.head()","b3b59948":"traindf2 = df2[(df2['date']<'2017-07-01')]\nvaldf2 = df2[(df2['date']>='2017-07-01')]\n\ntraindf2 = traindf2.drop(columns=['date'])\nvaldf2 = valdf2.drop(columns=['date'])","90e1a55d":"xtr, xval = traindf2.drop(['quantity'], axis=1), valdf2.drop(['quantity'], axis=1)\nytr, yval = traindf2['quantity'].values, valdf2['quantity'].values","249a0c3d":"xval","e538df1a":"cfi = ['shop','city','brand','container','capacity']","ec71a60c":"model = CatBoostRegressor(\n    n_estimators = 2000,\n    learning_rate= 0.1,\n    max_depth=6,\n    loss_function = 'RMSE',\n    eval_metric = 'RMSE',\n    l2_leaf_reg=10,\n    cat_features = cfi)","04c5a758":"model.fit( xtr, ytr, eval_set=(xval,yval), silent=True, plot=True )","966c1f58":"model.plot_tree(\n    tree_idx=0,\n    pool=None\n)","d708df28":"p = model.predict(xval)\nprint('Raiz Quadrada do Erro M\u00e9dio Quadr\u00e1tico na base de TESTE: {}'.format(rmse(p,yval)))","168292a6":"np.corrcoef(p,yval)[1,0]","9a7986ed":"shap.initjs()\nexplainer = shap.TreeExplainer(model)\nshap_values = explainer.shap_values(Pool(xtr, ytr, cat_features=cfi))\nshap.force_plot(explainer.expected_value, shap_values[0,:], xtr.iloc[0,:])","6f6df05b":"# visualize the training set predictions\nshap.force_plot(explainer.expected_value, shap_values[0:50,:], xtr.iloc[0:50,:])","ee0de169":"# summarize the effects of all the features\nshap.summary_plot(shap_values, xtr)","1dc074b5":"# feature importance plot\nshap.summary_plot(shap_values, xtr, plot_type=\"bar\",title='Feature Importance')\n","7d602bb1":"# PREVIS\u00c3O DE DEMANDA UTILIZANDO CATBOOST E HYPERPARAMETER TUNNING\n\n\n","240cc433":"Calculando a correla\u00e7\u00e3o de Pearson entre Previs\u00e3o e Venda - an\u00e1lise de ader\u00eancia da previs\u00e3o gerada ","68ee365f":"Analisando o ranking de vendas por Brand","03cfbcbc":"# GRIDSEARCH PARA HYPERPARAMETER TUNING","7595a6e4":"Cria\u00e7\u00e3o de fun\u00e7\u00f5es e vari\u00e1veis de apoio","1c035564":"Avaliando a dispers\u00e3o dos dados de vendas por Brand utilizando Box Plot","64204d1a":"A base de dados possui alguns nulos nos atributos \"lat\" e \"long\"\n\nAvaliando a distribui\u00e7\u00e3o das vendas nota-se que os dados est\u00e3o \"enviesados\" \u00e0 direita","9cf1131b":"Analisando ranking de vendas por City","0c06497d":"# REFER\u00caNCIAS\n\nhttps:\/\/towardsdatascience.com\/deep-dive-into-catboost-functionalities-for-model-interpretation-7cdef669aeed\n\nhttps:\/\/www.kaggle.com\/mcsweena\/feature-importance-with-catboost-and-shap**","781f97e3":"# SPLIT DE TREINO E VALIDA\u00c7\u00c3O","76dc0cca":"Analisando a distribui\u00e7\u00e3o dos dados de venda por Shop atrav\u00e9s de Box Plot","d82bca7e":"Registro da ader\u00eancia dos modelos de acordo com hyperparametros","ed604a49":"Cria\u00e7\u00e3o de vari\u00e1veis de calend\u00e1rio","3ff968ea":"* CatBoostRegressor(\n    n_estimators = 1000,\n    learning_rate= 0.1,\n    max_depth=6,\n    loss_function = 'RMSE',\n    eval_metric = 'RMSE',\n    l2_leaf_reg=9,\n    cat_features = cfi)\n    BEST TEST: 3169.792976\n\n#################################################\n\n* model = CatBoostRegressor(\n    n_estimators = 2000,\n    learning_rate= 0.1,\n    max_depth=6,\n    loss_function = 'RMSE',\n    eval_metric = 'RMSE',\n    l2_leaf_reg=10,\n    cat_features = cfi)\n    BEST MODEL: 2949.235413\n","7d86f1d8":"Aus\u00eancia de registros em v\u00e1rios dados (exclus\u00e3o dos dados de teste) ","a8f130f6":"Calculando o ranking de vendas por Shop","1a6836d2":"Avaliando a dispers\u00e3o de vendas por City atrav\u00e9s do gr\u00e1fico Box Plot","0c829678":"# PR\u00d3XIMOS PASSOS\n\n* Utilizar outros modelos e comparar resultados (Linear Regression, Prophet, Sarimax, LSTM, etc)\n* Segmenta\u00e7\u00e3o dos dados atrav\u00e9s de clusteriza\u00e7\u00e3o para maior ader\u00eancia dos modelos","0f5fec7a":"Analisando a evolu\u00e7\u00e3o de vendas por m\u00eas verifica-se a presen\u00e7a de sazonalidade anual com pico de venda em Julho e vale em Fevereiro","cd9006ef":"# INTERPRETANDO OS RESULTADOS - IMPORT\u00c2NCIA DAS VARI\u00c1VEIS UTILIZANDO SHAP","1d039520":"Importando as bibliotecas necess\u00e1rias","5b592887":"# MODELAGEM DE DADOS UTILIZANDO CATBOOST REGRESSOR","67b77706":"Carregando os dados de Treino","16fcbd3d":"model = CatBoostRegressor(cat_features = cfi)\n\ngrid = {'n_estimators':[2000],\n        'learning_rate': [0.1, 0.5, 1],\n        'l2_leaf_reg': [10],\n       'max_depth':[6,10,15]}\n\ngrid_search_result = model.grid_search(grid, \n                                       X=xtr, \n                                       y=ytr,\n                                       verbose= False,\n                                       plot=True)"}}