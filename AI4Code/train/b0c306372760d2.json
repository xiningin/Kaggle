{"cell_type":{"e9b5c0c6":"code","eaf46a97":"code","c6e0ee5d":"code","ba624d70":"code","218d9229":"code","bb0177f5":"code","948c6fb4":"code","4fa82be3":"code","9210e1c5":"code","654a6ddf":"code","3964d4ed":"code","8b692be5":"code","77c547d9":"code","0fe1e531":"code","970f6d5f":"code","e95275ff":"code","ce60c083":"code","933eb9f0":"code","3f545a6f":"code","f4adc812":"code","9706e2ee":"code","db2bf0eb":"code","e56aa3e9":"code","3c4e143e":"code","a586d7d4":"code","4ae3d91b":"code","e1d31bd2":"code","31a5760f":"code","e6093b4b":"code","cca37bee":"code","52d0983e":"code","ffc8a760":"code","62fa291f":"code","c2e776b9":"code","9e7eafed":"code","1b0b6459":"code","170665b3":"code","bc7a7d02":"code","0e6eb9af":"code","4ec693b1":"code","f584aba1":"code","66ba3a0b":"code","4814f835":"markdown","ccab812b":"markdown","62e23b04":"markdown","c6849f7b":"markdown","700f6171":"markdown","90da4587":"markdown","644e1f7d":"markdown","650d37c7":"markdown","bf77d5d1":"markdown","0bf0b234":"markdown","4f0550c1":"markdown","de0c6972":"markdown","a8df76d6":"markdown","8ab777ae":"markdown","594d5966":"markdown","6f31bbb6":"markdown","891ed01a":"markdown","a3c03e8d":"markdown","7b897110":"markdown","ff45f621":"markdown","70a4c0f0":"markdown","29d303c1":"markdown","b1b5eae3":"markdown","ba6d47b4":"markdown","a3b2809b":"markdown","e2140244":"markdown","30a52dcd":"markdown","b0b30708":"markdown","9aa3c398":"markdown"},"source":{"e9b5c0c6":"import pandas as pd\nimport numpy as np\nimport matplotlib.pyplot as plt\nimport os\nimport seaborn as sns\nfrom sklearn.ensemble import RandomForestRegressor","eaf46a97":"# Change the working directory\n# ATTN: You will need to change this locally.\n# os.chdir('C:\/Users\/jonda\/OneDrive\/Documents\/Springboard\/Santander_Capstone')\n\n# Read in the csv's for test, and train data sets.\ntest_df  = pd.read_csv('..\/input\/test.csv')\ntrain_df = pd.read_csv('..\/input\/train.csv')","c6e0ee5d":"# Take a first look at the training set\ntrain_df.head(5)","ba624d70":"# Take a first look at the testing set\ntest_df.head(5)","218d9229":"test_df.isnull().values.any()","bb0177f5":"train_df.isnull().values.any()","948c6fb4":"train_columns = list(train_df.columns.values)","4fa82be3":"test_columns  = list(test_df.columns.values)","9210e1c5":"set(train_columns) - set(test_columns)","654a6ddf":"train_df.shape","3964d4ed":"test_df.shape","8b692be5":"# A couple style settings\nsns.set_style(\"whitegrid\")\nsns.set_context(\"poster\")","77c547d9":"plt.figure(figsize = (12, 6))\nplt.hist(train_df['target'])\nplt.title('Histogram of target values in the training set')\nplt.xlabel('Count')\nplt.ylabel('Target value')\nplt.show()\nplt.clf()","0fe1e531":"x = train_df['target']\n\nfig, ax = plt.subplots(figsize=(12, 6))\nn_bins = 50\n\n# plot the cumulative histogram\nn, bins, patches = ax.hist(x, n_bins, normed=1, histtype='step',\n                           cumulative=True, label='Empirical')","970f6d5f":"train_df['target'].describe()","e95275ff":"train_df.columns.values","ce60c083":"# Drop all columns that consist of only zeros.\ndf = train_df.loc[:, (train_df != 0).any(axis=0)]","933eb9f0":"df.shape","3f545a6f":"df.describe()","f4adc812":"nz = list(df.columns.values) \nnz.remove('ID')\nnz.remove('target')\ntype(nz)","9706e2ee":"# This next bit was inspired by Bojan Tunguz's idea to determine just how sparse each column is\n# https:\/\/www.kaggle.com\/tunguz\/yaeda-yet-another-eda\ntrain_nz = pd.DataFrame({'Percentile':((df[nz].values)==0).mean(axis=0),\n                           'Column' : nz})\ntrain_nz.head(5)","db2bf0eb":"plt.figure(figsize = (12,5))\nplt.hist(train_nz['Percentile'], bins = 100)\nplt.title('Percentge of column that has value 0')\nplt.xlabel('Percentage zero')\nplt.ylabel('Number of columns')\nplt.show()\nplt.clf()","e56aa3e9":"train_nz['Percentile'].describe()","3c4e143e":"sns.set_style('ticks')\nfig, ax = plt.subplots()\n\nfig.set_size_inches(11, 1)\nsns.boxplot(x=\"Percentile\",\n            data=train_nz, palette=\"Set3\", ax = ax)\nplt.show()\nplt.clf()","a586d7d4":"# The approach for machine learning was also inspired by Bojan Tunguz's work\n\ny_train = train_df.target.values\nprint('y shape: ', y_train.shape)\nX_train = train_df[nz]\nprint('\\n')\nprint('X_train 5 line head below: ')\nX_train.head(5)","4ae3d91b":"clf = RandomForestRegressor()\nclf.fit(X_train, y_train)\n\npreds = clf.predict(test_df[nz])","e1d31bd2":"sample_submission = pd.read_csv(\"C:\/Users\/jonda\/OneDrive\/Documents\/Springboard\/Santander_Capstone\/sample_submission.csv\")\nsample_submission.target = preds\nsample_submission.to_csv('simple_rfr_all_default.csv', index=False)\nsample_submission.head()","31a5760f":"train_df_no_target = train_df.loc[:, train_df.columns != 'target']\ntype(train_df_no_target)\ntrain_df_target = train_df.loc[:, train_df.columns == 'target']\ntype(train_df_target)","e6093b4b":"############### Start: Randomized Search CV ##################################\n\n# Look at parameters used by our current forest\n# from sklearn.ensemble import RandomForestRegressor\n\nrf = RandomForestRegressor()\n\nfrom pprint import pprint\n\n# Look at parameters used by our current forest\nprint('Parameters currently in use:\\n')\npprint(rf.get_params())\n\nfrom sklearn.model_selection import RandomizedSearchCV\nfrom sklearn.cross_validation import train_test_split\nfrom sklearn.metrics import mean_squared_error\n\n# Randomized Search CV\n\n# Number of trees in random forest\nn_estimators = [int(x) for x in np.linspace(start = 100, stop = 1200, num = 12)]\n# Number of features to consider at every split\nmax_features = ['auto', 'sqrt']\n# Maximum number of levels in tree\nmax_depth = [int(x) for x in np.linspace(5, 30, num = 6)]\n# max_depth.append(None)\n# Minimum number of samples required to split a node\nmin_samples_split = [2, 5, 10, 15, 100]\n# Minimum number of samples required at each leaf node\nmin_samples_leaf = [1, 2, 5, 10]\n# Method of selecting samples for training each tree\n# bootstrap = [True, False]\n\n# Create the random grid\nrandom_grid = {'n_estimators': n_estimators,\n               'max_features': max_features,\n               'max_depth': max_depth,\n               'min_samples_split': min_samples_split,\n               'min_samples_leaf': min_samples_leaf}\n\npprint(random_grid)\n\n\n# Use the random grid to search for best hyperparameters\n# First create the base model to tune\nrf = RandomForestRegressor()","cca37bee":"# Random search of parameters, using 3 fold cross validation, \n# search across 100 different combinations\n# rf_random = RandomizedSearchCV(estimator = rf, param_distributions = random_grid, n_iter = 100, cv = 3, verbose=2, random_state=42, n_jobs = 1)\n\n# Fit the random search model\n# In order to test these models I will need to do a train test split with the training data-set. \nX_train, X_test, y_train, y_test = train_test_split(train_df[nz], train_df.target.values, test_size=0.2)\n\n\n# rf_random.fit(X_train, y_train)","52d0983e":"# Evaluation of Random Search\ndef evaluate(model, X_test, y_test):\n    predictions = model.predict(X_test)\n    errors = np.sqrt(mean_squared_error(y_test, predictions))\n    print('Model Performance')\n    print('MSE of: ', errors)\n    \n    return errors","ffc8a760":"base_model = RandomForestRegressor(n_estimators = 10, random_state = 42)\nbase_model.fit(X_train, y_train)\nbase_accuracy = evaluate(base_model, X_test, y_test)\n\n\nbest_random = RandomForestRegressor(bootstrap=True, criterion='mse', max_depth=30,\n           max_features='sqrt', max_leaf_nodes=None,\n           min_impurity_decrease=0.0, min_impurity_split=None,\n           min_samples_leaf=2, min_samples_split=5,\n           min_weight_fraction_leaf=0.0, n_estimators=200, n_jobs=1,\n           oob_score=False, random_state=None, verbose=0, warm_start=False)\nbest_random.fit(X_train , y_train)\n\nrandom_accuracy = evaluate(best_random, X_test, y_test)\n\nprint('\\n')\nprint('Base Accuracy: ', base_accuracy)\nprint('\\n')\nprint('Random Accuracy: ', random_accuracy)\nprint('Improvement of {:0.2f}%.'.format((random_accuracy - base_accuracy) \/ base_accuracy))\n\nprint('\\n')\nprint('RF_Randomized_Search_CV')\nprint('\\n')\n\n\n# =============================================================================\n# Best param set for random forest regression on Registered Users\n# =============================================================================\n# RandomForestRegressor(bootstrap=True, criterion='mse', max_depth=30,\n#           max_features='sqrt', max_leaf_nodes=None,\n#           min_impurity_decrease=0.0, min_impurity_split=None,\n#           min_samples_leaf=2, min_samples_split=5,\n#           min_weight_fraction_leaf=0.0, n_estimators=200, n_jobs=1,\n#           oob_score=False, random_state=None, verbose=0, warm_start=False)\n# =============================================================================\n\n################# End: Randomized Search CV ##################################","62fa291f":"y_train = train_df.target.values\nX_train = train_df[nz]\n\n\nclf = RandomForestRegressor(bootstrap=True, criterion='mse', max_depth=30,\n           max_features='sqrt', max_leaf_nodes=None,\n           min_impurity_decrease=0.0, min_impurity_split=None,\n           min_samples_leaf=2, min_samples_split=5,\n           min_weight_fraction_leaf=0.0, n_estimators=200, n_jobs=1,\n           oob_score=False, random_state=None, verbose=0, warm_start=False)\n\nclf.fit(X_train, y_train)\n\npreds = clf.predict(test_df[nz])\n\nsample_submission = pd.read_csv(\"C:\/Users\/jonda\/OneDrive\/Documents\/Springboard\/Santander_Capstone\/sample_submission.csv\")\nsample_submission.target = preds\nsample_submission.to_csv('simple_rfr_searchCV_all_features.csv', index=False)\nsample_submission.head()","c2e776b9":"train_nz['Percentile'].describe()","9e7eafed":"sub_seventy = pd.DataFrame(train_nz.loc[train_nz['Percentile'] < 0.7])\nsub_seventy_col_series = sub_seventy['Column']\nsub_seventy_col = list(sub_seventy_col_series)","1b0b6459":"plt.figure(figsize = (15,5))\nplt.boxplot(sub_seventy['Percentile'], patch_artist = True, vert = False)\nplt.title('Boxplot for percentage zero of columns sub seventy')\nplt.xlabel('Percentage zero')\nplt.show()\nplt.clf()","170665b3":"len(sub_seventy_col)","bc7a7d02":"sub_seventy_df = train_df[sub_seventy_col]","0e6eb9af":"sub_seventy_df['target'] = train_df['target']","4ec693b1":"sub_seventy_df.head(3)","f584aba1":"sub_seventy_y = sub_seventy_df['target']\nsub_seventy_X = sub_seventy_df.loc[: , sub_seventy_df.columns != 'target']\n\ntrain = train_df[sub_seventy_col]\n# train['target'] = train_df['target']\n\ntest = test_df[sub_seventy_col]","66ba3a0b":"# Functions from Haim Feldman's kernal: https:\/\/www.kaggle.com\/haimfeld87\/randomforest-with-50-features\nfrom sklearn import model_selection\n\nY = train_df['target']\nY = np.log(Y+1)\n\ntest_id = test_df.ID\n\ndef rmsle(h, y): \n    \"\"\"\n    Compute the Root Mean Squared Log Error for hypthesis h and targets y\n    Args:\n        h - numpy array containing predictions with shape (n_samples, n_targets)\n        y - numpy array containing targets with shape (n_samples, n_targets)\n    \"\"\"\n    return np.sqrt(np.square(np.log(h + 1) - np.log(y + 1)).mean())\n\n\nkf = model_selection.KFold(n_splits=10, shuffle=True)\ndef runRF(x_train, y_train,x_test, y_test,test):\n    #model=RandomForestRegressor(bootstrap=True, max_features=0.75, min_samples_leaf=11, min_samples_split=13, n_estimators=100)\n    model = RandomForestRegressor(bootstrap=True, criterion='mse', max_depth=30,\n           max_features='sqrt', max_leaf_nodes=None,\n           min_impurity_decrease=0.0, min_impurity_split=None,\n           min_samples_leaf=2, min_samples_split=5,\n           min_weight_fraction_leaf=0.0, n_estimators=200, n_jobs=1,\n           oob_score=False, random_state=None, verbose=0, warm_start=False)\n    model.fit(x_train, y_train)\n    y_pred_train=model.predict(x_test)\n    mse=rmsle(np.exp(y_pred_train)-1,np.exp(y_test)-1)\n    y_pred_test=model.predict(test)\n    return y_pred_train,mse,y_pred_test\n\npred_full_test_RF = 0    \nrmsle_RF_list=[]\n\nfor dev_index, val_index in kf.split(train):\n    dev_X, val_X = train.loc[dev_index], train.loc[val_index]\n    dev_y, val_y = Y.loc[dev_index], Y.loc[val_index]\n    ypred_valid_RF,rmsle_RF,ytest_RF=runRF(dev_X, dev_y, val_X, val_y,test)\n    print(\"fold_ RF _ok \"+str(rmsle_RF))\n    rmsle_RF_list.append(rmsle_RF)\n    pred_full_test_RF = pred_full_test_RF + ytest_RF\n    \nrmsle_RF_mean=np.mean(rmsle_RF_list)\nprint(\"Mean cv score : \", np.mean(rmsle_RF_mean))\nytest_RF=pred_full_test_RF\/10\n\n\nytest_RF = np.exp(ytest_RF)-1\nout_df = pd.DataFrame(ytest_RF)\nout_df.columns = ['target']\nout_df.insert(0, 'ID', test_id)\nout_df.to_csv(\"RF_\" + str(rmsle_RF_mean) + \"_.csv\", index=False)","4814f835":"#### Column name verification","ccab812b":"This section can only be ran after running the rf_random.fit() block","62e23b04":"#### Heads","c6849f7b":"This did not improve performance significantly so we are going to pursue more refine feature selection and consider only the cluster of values with fewer than 70% zeros.","700f6171":"The cluster on the far left of the plot is particularly interesting. Those columns have the most nonzero data points.","90da4587":"#### Imports","644e1f7d":"Warning: This next section can take a long time to run as it was set to run off of one core for stability.","650d37c7":"#### How sparse is the feature data?\nWe have nearly 5000 feature columns, but from the .head() they seem to be quite sparse. But just how sparse are they? If any columns are entirely zero then they should affect all predictions equally and should be removed to save complexity. Let's remove those columns first.","bf77d5d1":"Santander did remark that this data is sparse, we will need to look into just how spare to determine which of the 4992\/4993 columns contribute non-zero values and drop any irrelevant columns. We will also want to:\n- Check for missing values\n- Determine if all of the columns in test exist in train, and vice versa sans target \n- Do some initial plotting","0bf0b234":"Notice how the 50th percentile is far above the mean, this is due to the low minimum value and the upper bound on the highest values. More interseting is that standard deviation is 4% while our values are incredibly tightly packed. This tells us that vast majority of features are very underused by the public. Perhaps this is a wide varity of assets and stocks for individual companies. As there are an massive amount of companies to invest in, many are left with few investors. ","4f0550c1":"#### Missing Values","de0c6972":"It's certainly odd that the test_df is 11 times larger than the training set. There was some concern that perhaps the sets were swapped but Santander has verified that the data sets are correct. The larger training set force the model to actually be predictive. If it can predict a much larger audience of users then it is indicative that the model keyed into actual signal instead of 'getting lucky' with noise,.","a8df76d6":"Much better. Now we are up to 1.48 on the public submissions. To continue the project I would like to look at putting quartiles of the data together, such as the fourth and the first quartile. Then trying not only the searched parameter random forest, but expanding the to other algorithms and trying my hand at feature engineering. ","8ab777ae":"#### Target Statistics","594d5966":"#### All features searched forest submission","6f31bbb6":"#### Shapes","891ed01a":"## Introduction\n\nHello Kaggle~! I'm Jon and happy to be a part of this competition. I'm excited by data science and am currently finishing up a bootcamp. Hopefully my contributions will help someone out while I further my learning. \n\nI started by looking at Bojan Tunguz's kernel available here: https:\/\/www.kaggle.com\/tunguz\/yaeda-yet-another-eda. I'm going to be making a lot of revisions as I progress towards better predictions.\n\nWelcome to the Santander Value Prediction Challenge. Santander Bank is looking to personalize service for their broad customer base. To do this they are looking to predict the value of transactions for each potential customer, and that's where we come in. \n\nWe are given both testing and training data sets which will we look into and analyze. It is important to note that because this is sensitive banking data it has been anonymized meaning we will need to rely on statistical results as opposed to domain knowledge for feature engineering. Unfortunately unless Santander releases more data, the data we have will not be expanded, but that doesn't stop feature engineering. I cleaned the data by checking for empty values, of which there were none, and removing any columns comprised entirely of zeros.","a3c03e8d":"#### Data Entry","7b897110":"Thankfully there are no missing values, so we will be able to skip imputation for now.","ff45f621":"### Exploratory Data Analysis","70a4c0f0":"Once you realize that the x-axis of this plot is scalled by 1e7 it makes perfect sense. Most customers at a bank have fewer than 1,000,000 dollar valuations, while some certainly do have higher valuations and one aspect of this project is to learn which customers will yield those high valuations thanks to the other anonymized properties, which for conversations sake I will assume are asset types such as stocks, registered collectibles, or bonds. Looking at a cumulative plot should help shed light on this this.","29d303c1":"Let's try hyperparameter tuning on the all features data\n\nThis first section is setting up the grid and importing the necessary modules","b1b5eae3":"All the columns from the training set, sans target, are accounted for in the test set. ","ba6d47b4":"Set up the evaluate function","a3b2809b":"#### Target plot","e2140244":"#### Which methods to try?\nBecause we are attempting to predict a value we will look at regression methods. Because of the medium size of our sample we will begin RandomForestRegressors, and then move towards ensemble methods like boosted trees such as AdaBoost, LightGBM, and XGBoost.\n\nRandom forest will be very usefull in identifying variable importance. \n\nCertain high 0 assest could be indicative of high value accounts. Example: Very few people own high rises hotels. But those who do probably have high valuation accounts. \n\nTo give ourself a baseline our first submission will simply use all the data and no hyperparameter tuning.","30a52dcd":"### Machine Learning","b0b30708":"This default RandomForestRegressor scored 1.73. There is much work to be done! Thankfully we are planning to do more than just an all default RandomForestRegressor! Our goal is to reach the top 10%, this means we need to reach a score of 1.38. Now it's important to not get entirely bogged down in score. The learning process is the most important aspect of this exercise, personally.","9aa3c398":"RandomForestRegressor(bootstrap=True, criterion='mse', max_depth=30,\n           max_features='sqrt', max_leaf_nodes=None,\n           min_impurity_decrease=0.0, min_impurity_split=None,\n           min_samples_leaf=2, min_samples_split=5,\n           min_weight_fraction_leaf=0.0, n_estimators=200, n_jobs=1,\n           oob_score=False, random_state=None, verbose=0, warm_start=False)"}}