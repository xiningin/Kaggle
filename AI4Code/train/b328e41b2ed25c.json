{"cell_type":{"d0d47c7f":"code","b8880b58":"code","25fe7429":"code","d58af29b":"code","87bb6265":"code","91543266":"code","f54b50ad":"code","faf5c32d":"code","c92792d2":"code","9d0f3c86":"code","6ba0450a":"code","867f6bb1":"code","d812ea8a":"code","287628d5":"code","0c833db4":"code","79dd07c7":"code","495b4c5f":"code","86f50a72":"code","6735ea9b":"code","0b2b2ab2":"code","1f4f7bb4":"code","2f4866f9":"code","dc3ade38":"code","23bb318c":"code","db51f86f":"code","bde930c8":"code","3e2b9669":"code","48681aa8":"code","b405f53a":"markdown","c8031218":"markdown","7379967f":"markdown","efd0a6af":"markdown","cfe1cf5c":"markdown","ee45d9e0":"markdown","97e0f185":"markdown","0861e18e":"markdown","4ab7b9cb":"markdown","bf61e56c":"markdown","21b595af":"markdown","e7fc1151":"markdown","2ab815cd":"markdown","1f94da29":"markdown","e93ba6a8":"markdown","8d13db36":"markdown","8e7cd0ca":"markdown","e9d755f1":"markdown","ffe31b0a":"markdown","16349504":"markdown","cadc95ee":"markdown"},"source":{"d0d47c7f":"# This Python 3 environment comes with many helpful analytics libraries installed\n# It is defined by the kaggle\/python Docker image: https:\/\/github.com\/kaggle\/docker-python\n# For example, here's several helpful packages to load\n\nimport numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\n\n# Input data files are available in the read-only \"..\/input\/\" directory\n# For example, running this (by clicking run or pressing Shift+Enter) will list all files under the input directory\n\nimport os\nfor dirname, _, filenames in os.walk('\/kaggle\/input'):\n    for filename in filenames:\n        print(os.path.join(dirname, filename))\n\n# You can write up to 20GB to the current directory (\/kaggle\/working\/) that gets preserved as output when you create a version using \"Save & Run All\" \n# You can also write temporary files to \/kaggle\/temp\/, but they won't be saved outside of the current session","b8880b58":"# Libraries for data-visualization\nfrom pandas.plotting import scatter_matrix\nimport matplotlib as mpl\nimport matplotlib.pyplot as plt\nimport seaborn as sns\n!pip install RapidPlot\nimport RapidPlot\n\n# Libraries for interactive plotting\nimport plotly.express as px\nimport plotly.graph_objs as go\nimport plotly.figure_factory as ff\nfrom plotly.subplots import make_subplots\n\n# Library for automatic EDA\nimport pandas_profiling\n\n# Library for pre-processing:\nfrom sklearn.preprocessing import StandardScaler\n\n# Library for Dimensionality-Reduction:\nfrom sklearn.decomposition import PCA\n\n# Libraries for modelling\nfrom sklearn.linear_model import LogisticRegression, SGDClassifier\nfrom sklearn.svm import SVC\nfrom sklearn.neighbors import KNeighborsClassifier\nfrom sklearn.naive_bayes import GaussianNB\nfrom sklearn.tree import DecisionTreeClassifier\nfrom sklearn.ensemble import RandomForestClassifier, GradientBoostingClassifier\nfrom xgboost import XGBClassifier\nfrom lightgbm import LGBMClassifier\n!pip install catboost\nfrom catboost import CatBoostClassifier\n\n\n# Model Selection:\nfrom sklearn.pipeline import Pipeline as Pipeline\nfrom sklearn.model_selection import GridSearchCV, train_test_split\nfrom sklearn.base import BaseEstimator, TransformerMixin\n\n# Libraries for model evaluaton \nfrom sklearn.model_selection import GridSearchCV, RandomizedSearchCV\n\n# --CLASSIFICATION:\nfrom sklearn.metrics import roc_auc_score, confusion_matrix, precision_recall_curve, roc_curve, precision_score, recall_score, f1_score, accuracy_score\n\n# Library for plotting confusion matrix\nfrom mlxtend.plotting import plot_confusion_matrix\n\n# Library for converting python equation to Latex (markdown)\n%pip install handcalcs\nimport handcalcs.render\n\n# Miscellanous libraries\nfrom IPython.display import display","25fe7429":"hf_df = pd.read_csv('..\/input\/heart-failure-clinical-data\/heart_failure_clinical_records_dataset.csv')\nhf_df","d58af29b":"report = pandas_profiling.ProfileReport(hf_df)","87bb6265":"display(report)","91543266":"cat_variables = np.array(['anaemia', 'diabetes', 'high_blood_pressure', 'smoking', 'DEATH_EVENT', 'sex'])\nnum_variables = np.array(['age', 'creatinine_phosphokinase', 'ejection_fraction', 'platelets', 'serum_creatinine', 'serum_sodium', 'time'])","f54b50ad":"death_labels = ['Male - Survived', 'Female - Survived', 'Male - Not Survived', 'Female - Not Survived']\nanaemia_labels = ['Male - No Anaemia', 'Female - No Anaemia', 'Male - Anaemia', 'Female - Anaemia']\ndiabetes_labels = ['Male - No Diabetes', 'Female - No Diabetes', 'Male - Diabetes', 'Female - Diabetes']\nbp_labels = ['Male - No High BP', 'Female - No High BP', 'Male - High BP', 'Female - High BP']\nsmoking_labels = ['Male - Non-Smokers', 'Female - Non-Smokers', 'Male - Smokers', 'Female - Smokers']\n\nlabels = [anaemia_labels, diabetes_labels, bp_labels, smoking_labels, death_labels]\n\nmale = hf_df[hf_df.sex == 1]\nfemale = hf_df[hf_df.sex == 0]\n\nfig = make_subplots(rows=1, cols=len(labels), specs=[[{\"type\": \"pie\"}]*len(labels)])\n\ncat_counts = list()\nfor cat_var in cat_variables[:-1]:\n    cat_counts.append([np.sum(male[cat_var] == 0), np.sum(female[cat_var] == 0),\n                       np.sum(male[cat_var] == 1), np.sum(female[cat_var] == 1)\n                     ])\n    \n\nfor i, label_counts in enumerate(zip(cat_variables[:-1], labels, cat_counts)):\n    cat_var = label_counts[0]\n    cat_labels = label_counts[1]\n    cat_counts = label_counts[2]\n    fig.add_trace(go.Pie(values=cat_counts,\n                         labels=cat_labels,\n                         #domain=dict(x=[0, 0.5]),\n                         name=f'{cat_var}'), \n                         row=1, col=i+1)     \n\nfig.update_layout(title='Gender Composition for Various Categorical Variables')\nfig.show() ","faf5c32d":"anaemia_labels = ['Smoker - No Anaemia', 'Non-Smoker - No Anaemia', 'Smoker - Anaemia', 'Non-Smoker - Anaemia']\ndiabetes_labels = ['Smoker - No Diabetes', 'Non-Smoker - No Diabetes', 'Smoker - Diabetes', 'Non-Smoker - Diabetes']\nbp_labels = ['Smoker - No High BP', 'Non-Smoker - No High BP', 'Smoker - High BP', 'Non-Smoker - High BP']\n\nlabels = [anaemia_labels, diabetes_labels, bp_labels]\n\nsmoker = hf_df[hf_df.smoking == 1]\nnon_smoker = hf_df[hf_df.smoking == 0]\n\nfig = fig = make_subplots(rows=1, cols=len(labels), specs=[[{\"type\": \"pie\"}]*len(labels)])\n\ncat_counts = list()\nfor cat_var in cat_variables[:-1]:\n    cat_counts.append([np.sum(smoker[cat_var] == 0), np.sum(non_smoker[cat_var] == 0),\n                       np.sum(smoker[cat_var] == 1), np.sum(non_smoker[cat_var] == 1)\n                     ])\n    \nfor i, label_counts in enumerate(zip(['anaemia', 'diabetes', 'high blood pressure'], labels, cat_counts)):\n    cat_var = label_counts[0]\n    cat_labels = label_counts[1]\n    cat_counts = label_counts[2]\n    fig.add_trace(go.Pie(values=cat_counts,\n                         labels=cat_labels,\n                         #domain=dict(x=[0, 0.5]),\n                         name=f'{cat_var}'), \n                         row=1, col=i+1)     \n\nfig.update_layout(title='Smoker Composition for Various Categorical Variables')\nfig.show() ","c92792d2":"fig = px.imshow(hf_df.corr())\nfig.show()","9d0f3c86":"plot_maker = RapidPlot.Plotter()\nplot_maker.plotter(hf_df, 'age', ['ejection_fraction', 'serum_creatinine', 'serum_sodium', 'time'], ['anaemia', 'diabetes', 'sex', 'DEATH_EVENT'], 30, 30)","6ba0450a":"age_min = np.min(hf_df.age)\nage_max = np.max(hf_df.age)\n\nfig = px.scatter(x=hf_df.age, y=hf_df.ejection_fraction, color=hf_df['DEATH_EVENT'].astype('bool'))\nfig.update_layout(\n    xaxis=dict(\n        tickmode='array',\n        tickvals=np.int64(np.linspace(age_min, age_max, 10)),\n        title='Age',\n    ),\n    yaxis=dict(\n        title='Ejection Fraction',\n    ),\n    title='Age v\/s Ejection Fraction for Deaths'\n)\n\nfig.add_trace(go.Scatter(x=[40-3, 40-3, 75+3, 75+3, 40-3], y=[10, 30+3, 30+3, 10, 10], fillcolor='yellow', fill='toself', opacity=0.15, name='Age(40-75)'))","867f6bb1":"age_min = np.min(hf_df.age)\nage_max = np.max(hf_df.age)\n\nfig = px.scatter(x=hf_df.age, y=hf_df.time, color=hf_df['DEATH_EVENT'].astype('bool'))\nfig.update_layout(\n    xaxis=dict(\n        tickmode='array',\n        tickvals=np.int64(np.linspace(age_min, age_max, 10)),\n        title='Age',\n    ),\n    yaxis=dict(\n        title='Follow-up period',\n    ),\n    title='Age v\/s Follow-up time for Deaths'\n)\n\nfig.add_trace(go.Scatter(x=[43, 43, 97, 97, 43], y=[0-3, 65, 65, 0-3, 0-3], fillcolor='yellow', fill='toself', opacity=0.15, name='Age(45-95) approx.'))","d812ea8a":"age_min = np.min(hf_df.age)\nage_max = np.max(hf_df.age)\n\nfig = px.scatter(x=hf_df.age, y=hf_df.serum_creatinine, color=hf_df['DEATH_EVENT'].astype('bool'))\nfig.update_layout(\n    xaxis=dict(\n        tickmode='array',\n        tickvals=np.int64(np.linspace(age_min, age_max, 10)),\n        title='Age',\n    ),\n    yaxis=dict(\n        title='Serum Creatinine',\n    ),\n    title='Age v\/s Serum Creatinine for Deaths'\n)","287628d5":"X = hf_df.drop(columns='DEATH_EVENT')\ny = hf_df['DEATH_EVENT']\n\nX_train, X_test_cv, y_train, y_test_cv = train_test_split(X, y, test_size=0.4)\nX_cv, X_test, y_cv, y_test = train_test_split(X_test_cv, y_test_cv, test_size=0.5)","0c833db4":"rnd_state=3\n\nmodel_list = [LogisticRegression(random_state=rnd_state),\n              SGDClassifier(random_state=rnd_state),\n              SVC(random_state=rnd_state),\n              KNeighborsClassifier(),\n              GaussianNB(),\n              DecisionTreeClassifier(random_state=rnd_state),\n              RandomForestClassifier(random_state=rnd_state),\n              GradientBoostingClassifier(random_state=rnd_state),\n             ]","79dd07c7":"Main_Pipeline = Pipeline([\n    ('scaler', StandardScaler()),\n    ('pca', PCA(n_components=0.99)),\n    ('model', LogisticRegression()),\n])\n\n# param_grid for fast execution\nparams_grid = [{\n\n    'model': model_list,  \n}]","495b4c5f":"main_grid_f1 = GridSearchCV(Main_Pipeline, params_grid, scoring='f1', cv=2, verbose=2)\nmain_grid_f1.fit(X_train, y_train)","86f50a72":"main_grid_f1.best_estimator_","6735ea9b":"main_grid_f1.best_estimator_.steps[1][1].n_components_","0b2b2ab2":"y_pred_main = main_grid_f1.best_estimator_.predict(X_test)\nf1_score(y_test, y_pred_main)","1f4f7bb4":"accuracy_score(y_test, y_pred_main)","2f4866f9":"best_model = main_grid_f1.best_estimator_\nbest_model","dc3ade38":"best_param_grid = [{\n    'model__penalty': ['l1', 'l2', 'elasticnet'],\n    'model__tol': [1e-5, 2e-5, 1e-4, 2e-4, 1e-3],\n    #'model__C': np.r_[1, np.array([C for C in np.random.uniform(0.001, 1, 5) if C != 1])], # C=1 is the default value, and we want to include it but not get repeated\n    'model__max_iter': np.r_[100, np.array([max_iter for max_iter in np.random.randint(80, 200, 5) if max_iter != 100])], # Same as reason as C\n}]","23bb318c":"best_grid = GridSearchCV(best_model, best_param_grid, scoring='f1', cv=3, verbose=2)\nbest_grid.fit(X_cv, y_cv)","db51f86f":"best_grid.best_estimator_","bde930c8":"y_pred_tuned = best_grid.best_estimator_.predict(X_test)\nprint(f1_score(y_test, y_pred_tuned))\nprint(accuracy_score(y_test, y_pred_tuned))","3e2b9669":"conf_mat_ori = confusion_matrix(y_test, y_pred_main)\nconf_mat_tuned = confusion_matrix(y_test, y_pred_tuned)","48681aa8":"plot_confusion_matrix(conf_mat=conf_mat_ori); plot_confusion_matrix(conf_mat=conf_mat_tuned);","b405f53a":"### Confusion Matrices for both the models:","c8031218":"## Heart Failure: \n\nHeart Failure is the leading cause of death in many countries, \n\n### What does Heart Failure look like?\n![image.png](attachment:image.png)","7379967f":"![image.png](attachment:image.png)","efd0a6af":"## Report Insights:\nWe will look only at numerical data here, since the set is not imbalanced by a large margin, report won't be helpful for categorical data.\n\n### Age:\n* The data we have consists mainly of seniors (average=60 yrs).\n\n### Creatinine Phosphokinase:\n* Normal Creatinine Phosphokinase level is 10-120 mcg\/L by https:\/\/www.mountsinai.org\/health-library\/tests\/creatine-phosphokinase-test.\n* Our avergae is _581_ mcg\/L. Veryyy baddd\n\n### Ejection Fraction:<br>(https:\/\/www.mayoclinic.org\/ejection-fraction\/expert-answers\/faq-20058286)\n* Ejection fraction of 55 percent or higher is considered normal.\n* Ejection fraction of 50 percent or lower is considered reduced.\n* Ejection fraction between 50 and 55 percent is usually considered \"borderline.\"\n* We have an average of 38%.\n\n### Platelets:\n* A normal platelet count ranges from 150,000 to 450,000 platelets per microliter of blood. Having more than 450,000 platelets is a condition called thrombocytosis; having less than 150,000 is known as thrombocytopenia.\n* We have as average of 263,358, which is alright. \n\n### Serum Creatinine:\n* The normal range for creatinine in the blood may be 0.84 to 1.21 milligrams per deciliter (by https:\/\/www.mayoclinic.org\/tests-procedures\/creatinine-test\/about\/pac-20384646)\n* We have an avg. of 1.39 mg\/dL. (Just outside borderline).\n\n### Serum Sodium:\n* A normal blood sodium level is between 135 and 145 milliequivalents per liter (by https:\/\/www.mayoclinic.org\/diseases-conditions\/hyponatremia\/symptoms-causes\/syc-20373711)\n* We have an avg. of 136.625 mEq\/L.\n\nNo comments on follow-up period.","cfe1cf5c":"We can see that those who had died, had followed up recently (compared to majority of those who didn't die). From this we can say that their situation was a lot more serious resulting in more frequent follow-ups or, some complications might have arisen after the treatment got over.","ee45d9e0":"Relations :-\n* age v\/s ejection fraction for DEATH EVENT,\n* age v\/s time for DEATH EVENT,\n* age v\/s serum creatinine for DEATH EVENT<br><br>\ncan give some insights, let's zoom in on them. Rest all plots told no story.","97e0f185":"The values are too congested, all we can say is higher the serum creatinine, higher the death chances (we already know ;) )","0861e18e":"Below, I am using  ***Plotter class*** which I created to quickly skim over the relations of a particular feature,<br>and zoom in on the ones which can give better insights. It is uploaded on PyPi under ***RapidPlot*** (!pip install RapidPlot ), Library that I created. Only Contains 1 classs with 4 functions till now ;)","4ab7b9cb":"# EDA","bf61e56c":"Looks like HyperParameter Tuning imporoved the model. Kudos!","21b595af":"### Importance of \"creatinine_phosphokinase\":<br>\nWhen the total CPK level is very high, it most often means there has been injury or stress to muscle tissue, the heart, or the brain.\n\nMuscle tissue injury is most likely. When a muscle is damaged, CPK leaks into the bloodstream. Finding which specific form of CPK is high helps determine which tissue has been damaged.\n\n\n### Importance of \"serum_creatinine\":<br>\nA creatinine test reveals important information about your kidneys.\n\nCreatinine is a chemical waste product that's produced by your muscle metabolism and to a smaller extent by eating meat. Healthy kidneys filter creatinine and other waste products from your blood. The filtered waste products leave your body in your urine.\n\nIf your kidneys aren't functioning properly, an increased level of creatinine may accumulate in your blood. A serum creatinine test measures the level of creatinine in your blood and provides an estimate of how well your kidneys filter (glomerular filtration rate). A creatinine urine test can measure creatinine in your urine.\n\n\n### Importance of \"serum_sodium\":<br>\nMeasurement of serum sodium is routine in assessing electrolyte, acid-base, and water balance, as well as renal function. Sodium accounts for approximately 95% of the osmotically active substances in the extracellular compartment, provided that the patient is not in renal failure or does not have severe hyperglycemia. ","e7fc1151":"# Model-Selection:","2ab815cd":"## Symptoms:\n\n**Heart failure can be ongoing (chronic), or your condition may start suddenly (acute).**\n\nHeart failure signs and symptoms may include:\n*  Shortness of breath (dyspnea) when you exert yourself or when you lie down\n*  Fatigue and weakness\n*  Swelling (edema) in your legs, ankles and feet\n*  Rapid or irregular heartbeat\n*  Reduced ability to exercise\n*  Persistent cough or wheezing with white or pink blood-tinged phlegm\n*  Increased need to urinate at night\n*  Swelling of your abdomen (ascites)\n*  Very rapid weight gain from fluid retention\n*  Lack of appetite and nausea\n*  Difficulty concentrating or decreased alertness\n*  Sudden, severe shortness of breath and coughing up pink, foamy mucus\n*  Chest pain if your heart failure is caused by a heart attack","1f94da29":"# Introduction:\n\nHeart failure, sometimes known as congestive heart failure, occurs when your heart muscle doesn't pump blood as well as it should. Certain conditions, such as narrowed arteries in your heart (coronary artery disease) or high blood pressure, gradually leave your heart too weak or stiff to fill and pump efficiently.\n\nNot all conditions that lead to heart failure can be reversed, but treatments can improve the signs and symptoms of heart failure and help you live longer. Lifestyle changes \u2014 such as exercising, reducing sodium in your diet, managing stress and losing weight \u2014 can improve your quality of life.\n\nOne way to prevent heart failure is to prevent and control conditions that cause heart failure, such as coronary artery disease, high blood pressure, diabetes or obesity.\n\n### Heart Anatomy:\n![image.png](attachment:image.png)","e93ba6a8":"We can see that, most of the people in age group (40 - 75) who died had a low ejection fraction","8d13db36":"## Loading Dataset:","8e7cd0ca":"#### First one is of Original Best model (before hyperparameter tuning) & second one is of Tuned Best Model.","e9d755f1":"From the heatmap, we can see that ****'ejection_fraction', 'serum_creatinine', 'serum_sodium', and 'time'**** are the most important features for DEATH_EVENT. <br>\nBut, we will check for a few more Categorical Variables hoping to find some more interesting relations.","ffe31b0a":"## Importing Libraries:","16349504":"## Risk factors\n\n**A single risk factor may be enough to cause heart failure, but a combination of factors also increases your risk.**\n\n### Risk factors include:\n\n* <ins>***High blood pressure:***<\/ins> Your heart works harder than it has to if your blood pressure is high.\n\n* <ins>***Coronary artery disease:***<\/ins> Narrowed arteries may limit your heart's supply of oxygen-rich blood, resulting in weakened heart muscle.\n\n* <ins>***Heart attack:***<\/ins> A heart attack is a form of coronary disease that occurs suddenly. Damage to your heart muscle from a heart attack may mean your heart can no longer pump as well as it should.\n\n* <ins>***Diabetes:***<\/ins> Having diabetes increases your risk of high blood pressure and coronary artery disease.\n\n* <ins>***Some diabetes medications:***<\/ins> The diabetes drugs rosiglitazone (Avandia) and pioglitazone (Actos) have been found to increase the risk of heart failure in some people. Don't stop taking these medications on your own, though. If you're taking them, discuss with your doctor whether you need to make any changes.\n\n* <ins>***Certain medications:***<\/ins> Some medications may lead to heart failure or heart problems. Medications that may increase the risk of heart problems include nonsteroidal anti-inflammatory drugs (NSAIDs); certain anesthesia medications; some anti-arrhythmic medications; certain medications used to treat high blood pressure, cancer, blood conditions, neurological conditions, psychiatric conditions, lung conditions, urological conditions, inflammatory conditions and infections; and other prescription and over-the-counter medications.\n\n* Don't stop taking any medications on your own. If you have questions about medications you're taking, discuss with your doctor whether he or she recommends any changes.\n\n* <ins>***Sleep apnea:***<\/ins> The inability to breathe properly while you sleep at night results in low blood oxygen levels and increased risk of abnormal heart rhythms. Both of these problems can weaken the heart.\n\n* <ins>***Congenital heart defects:***<\/ins> Some people who develop heart failure were born with structural heart defects.\n\n* <ins>***Valvular heart disease:***<\/ins> People with valvular heart disease have a higher risk of heart failure.\n\n* <ins>***Viruses:***<\/ins> A viral infection may have damaged your heart muscle.\n\n* <ins>***Alcohol use:***<\/ins> Drinking too much alcohol can weaken heart muscle and lead to heart failure.\n\n* <ins>***Tobacco use:***<\/ins> Using tobacco can increase your risk of heart failure.\n\n* <ins>***Obesity:***<\/ins> People who are obese have a higher risk of developing heart failure.\n\n* <ins>***Irregular heartbeats:***<\/ins> These abnormal rhythms, especially if they are very frequent and fast, can weaken the heart muscle and cause heart failure.\n","cadc95ee":"## HyperParameter Tuning:"}}