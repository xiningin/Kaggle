{"cell_type":{"fdd801f2":"code","fdb9f392":"code","ad78727d":"code","2112568b":"code","b02f1a8f":"code","295849cd":"code","ac1b7fbc":"code","60f75104":"code","b7d3bf00":"code","26cc79a5":"code","77c9d72c":"code","8f77bac3":"code","d3783b2d":"code","27fb102b":"code","ce7f75fa":"code","49f16e8c":"code","8675bf00":"code","c1d54fb5":"code","21a70f87":"code","41145180":"code","6dc9a682":"code","3ae78d2f":"markdown"},"source":{"fdd801f2":"import numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\nimport os\nimport random\n\nimport pydicom #DICOM file\nfrom pydicom.pixel_data_handlers.util import apply_voi_lut\n\nimport cv2 #openCV\nimport matplotlib.pyplot as plt\nfrom tqdm.notebook import tqdm #progress bar\n\nimport glob #glob\n\nimport tensorflow as tf\nfrom tensorflow import keras\nfrom sklearn.metrics import roc_auc_score\nfrom sklearn.model_selection import train_test_split\nfrom tensorflow.keras.utils import to_categorical\nfrom tensorflow.keras import layers\nfrom tensorflow.keras.optimizers import SGD","fdb9f392":"train_df = pd.read_csv(\"..\/input\/rsna-miccai-brain-tumor-radiogenomic-classification\/train_labels.csv\")\ntest_df = pd.read_csv(\"..\/input\/rsna-miccai-brain-tumor-radiogenomic-classification\/sample_submission.csv\")","ad78727d":"#refer: https:\/\/www.kaggle.com\/arnabs007\/part-1-rsna-miccai-btrc-understanding-the-data\nEXCLUDE = [109, 123, 709]\ntrain_df = train_df[~train_df.BraTS21ID.isin(EXCLUDE)]","2112568b":"train_df.head(10)","b02f1a8f":"train_df.head(10)","295849cd":"TYPES = [\"FLAIR\", \"T1w\", \"T1wCE\", \"T2w\"] #mpMRI scans","ac1b7fbc":"def load_dicom(path, size = 224): #load DICOM files\n    dicom = pydicom.read_file(path)\n    data = dicom.pixel_array #returns a numpy.ndarray containing the pixel data\n    if np.max(data) != 0:\n        data = data \/ np.max(data) #standardizes so that the pixel values are between 0 and 1\n    data = (data * 255).astype(np.uint8) #rescales to 0 and 255\n    return cv2.resize(data, (size, size))","60f75104":"def get_all_image_paths(BraTS21ID, image_type, folder=\"train\"): #get an array of all the images of a particular type or a particular patient id\n    assert(image_type in TYPES) #only in types\n    patient_path = os.path.join(\"..\/input\/rsna-miccai-brain-tumor-radiogenomic-classification\/%s\/\" % folder, str(BraTS21ID).zfill(5)) #\ub2e4\ub978 \ud3f4\ub354\uc77c \uc218\ub3c4 \uc788\uc74c\n    #print(lambda x: int(x[:-4].split(\"-\")[-1]))\n    \n    paths = sorted(glob.glob(os.path.join(patient_path, image_type, \"*\")), key=lambda x: int(x[:-4].split(\"-\")[-1])) #sort\n    #print(paths)\n    \n    num_images = len(paths)\n    \n    start = int(num_images * 0.25)\n    end = int(num_images * 0.75)\n    if num_images < 10:\n        jump = 1\n    else:\n        jump = 3\n        \n    return np.array(paths[start:end:jump])","b7d3bf00":"def get_all_images(BraTS21ID, image_type, folder=\"train\", size=225):\n    return [load_dicom(path, size) for path in get_all_image_paths(BraTS21ID, image_type, folder)]","26cc79a5":"IMAGE_SIZE = 128\n\ndef get_all_data_train(image_type):\n    global train_df\n    \n    X = []\n    y = []\n    train_ids = []\n\n    for i in tqdm(train_df.index):\n        tmp_x = train_df.loc[i]\n        images = get_all_images(int(tmp_x[\"BraTS21ID\"]), image_type, \"train\", IMAGE_SIZE)\n        label = tmp_x[\"MGMT_value\"]\n\n        X += images\n        y += [label] * len(images)\n        train_ids += [int(tmp_x[\"BraTS21ID\"])] * len(images)\n        assert(len(X) == len(y))\n    return np.array(X), np.array(y), np.array(train_ids)\n\ndef get_all_data_test(image_type):\n    global test_df\n    \n    X = []\n    test_ids = []\n\n    for i in tqdm(test_df.index):\n        tmp_x = test_df.loc[i]\n        images = get_all_images(int(tmp_x[\"BraTS21ID\"]), image_type, \"test\", IMAGE_SIZE)\n        X += images\n        test_ids += [int(tmp_x[\"BraTS21ID\"])] * len(images)\n\n    return np.array(X), np.array(test_ids)","77c9d72c":"X, y, train_idt = get_all_data_train(\"T1wCE\")\nX_test, test_idt = get_all_data_test(\"T1wCE\")\nX.shape, y.shape, train_idt.shape","8f77bac3":"X.shape, y.shape","d3783b2d":"X_train, X_valid, y_train, y_valid, train_idt_train, train_idt_valid = train_test_split(X, y, train_idt, test_size=0.2, random_state=42)\n\nsplit = int(X.shape[0] * 0.8) #8:2 split\n\nX_train = tf.expand_dims(X_train, axis=-1) #expand the dimension at the end of the array\nX_valid = tf.expand_dims(X_valid, axis=-1)\n\ny_train = to_categorical(y_train) #one-hot incoding\ny_valid = to_categorical(y_valid)\n\nX_train.shape, y_train.shape, X_valid.shape, y_valid.shape, train_idt_train.shape, train_idt_valid.shape","27fb102b":"file_path1 = \"..\/input\/rsna-model-2\/rsna_model_data_augment_best_model_3.h5\" #shape=128\n#file_path2 = \"..\/input\/rsna-best-model-training2\/best_model (2).h5\"\nfile_path2 = \"..\/input\/rsna-model-model-1\/rsna_model_data_augment_best_model_2.h5\" #shape=128\nfile_path3 = \"..\/input\/best-model-trainingver3\/best_model_trainingVer3.h5\" #shape=32","ce7f75fa":"#import tensorflow_hub as tfhub\n#import tensorflow_addons as tfa\nfrom tensorflow.keras import layers","49f16e8c":"#best_model = tf.keras.models.load_model(filepath = file_path, custom_objects={'KerasLayer': tfhub.KerasLayer})\nmodel1 = tf.keras.models.load_model(filepath = file_path1)\nmodel2 = tf.keras.models.load_model(filepath = file_path2)\n#model3 = tf.keras.models.load_model(filepath = file_path3)","8675bf00":"y_pred1 = model1.predict(X_valid) #pedict on X_valid\ny_pred2 = model2.predict(X_valid) #pedict on X_valid\n\npred1 = np.argmax(y_pred1, axis = 1)\npred2 = np.argmax(y_pred2, axis = 1)\n\nresult = pd.DataFrame(train_idt_valid)\nresult[1] = pred1*0.3+pred2*0.7\nresult.columns=[\"BraTS21ID\",\"MGMT_value\"]\n\n#Group by BraTS21ID and average + do not use index\nresult_temp = result.groupby(\"BraTS21ID\", as_index = False).mean()\nresult_temp = result_temp.merge(train_df, on = \"BraTS21ID\") #merge train_df\nresult_temp","c1d54fb5":"auc = roc_auc_score(result_temp.MGMT_value_y, result_temp.MGMT_value_x)\n\nprint(f\"Validation AUC={auc}\")","21a70f87":"#submission\nsample_sub = pd.read_csv(\"..\/input\/rsna-miccai-brain-tumor-radiogenomic-classification\/sample_submission.csv\")\n\ny_pred1 = model1.predict(X_test) #predict test\ny_pred2 = model2.predict(X_test)\n#y_pred3 = model3.predict(X_test)\n\npred1 = np.argmax(y_pred1, axis = 1)\npred2 = np.argmax(y_pred2, axis = 1)\n#pred3 = np.argmax(y_pred3, axis = 1)\n\nresult = pd.DataFrame(test_idt)\nresult[1] = pred1*0.3+pred2*0.7\n\nresult.columns=[\"BraTS21ID\",\"MGMT_value\"]\nresult_final = result.groupby(\"BraTS21ID\",as_index = False).mean()\n\nresult_final[\"BraTS21ID\"] = sample_sub[\"BraTS21ID\"]\nresult_final[\"MGMT_value\"] = result_final[\"MGMT_value\"]\nresult_final","41145180":"result_final.to_csv(\"submission.csv\",index=False)","6dc9a682":"plt.figure(figsize=(5, 5))\nplt.hist(result_final[\"MGMT_value\"]);","3ae78d2f":"In this [discussion](https:\/\/www.kaggle.com\/c\/rsna-miccai-brain-tumor-radiogenomic-classification\/discussion\/262046) a competition host has notified that there are some issues with these 3 cases   \nPatient IDs - \n\n1. 00109 (FLAIR images are blank)\n2. 00123 (T1w images are blank)\n3. 00709 (FLAIR images are blank)    \n\nHence these can be excluded\n"}}