{"cell_type":{"69aebcb0":"code","bca049a5":"code","d48e9552":"code","3ba7f3ea":"code","6828ed5f":"code","cde8a103":"code","a39d7c61":"code","27d4c862":"code","cb86acd4":"code","090426c0":"code","37ce99d3":"code","ab35cb71":"code","8e7315fa":"code","179a62dc":"code","1d8efcc4":"code","db8e346f":"code","edd3ae37":"code","97f0bb20":"code","a4aec51b":"code","73ffe65f":"code","252d1d7d":"code","1bb5231f":"code","a6bb70db":"code","098fda35":"code","dc944566":"markdown","e35a19c8":"markdown","5bbb1dee":"markdown","c7b43d4c":"markdown","35d849bb":"markdown","2424dc4c":"markdown","0e7ebbc9":"markdown","e959c6be":"markdown","d838d9f4":"markdown","57b57192":"markdown","6a2b6711":"markdown","1628b2bc":"markdown","301cf5b3":"markdown","4ab43d95":"markdown","caa8d947":"markdown"},"source":{"69aebcb0":"import pandas as pd\nimport numpy as np\nimport datetime\nimport matplotlib.pyplot as plt\n%matplotlib inline\n%config InlineBackend.figure_format = 'retina'","bca049a5":"DATE_FIELDS = ['Accurate_Episode_Date','Case_Reported_Date','Test_Reported_Date','Specimen_Date']","d48e9552":"latest = pd.read_csv('https:\/\/data.ontario.ca\/dataset\/f4112442-bdc8-45d2-be3c-12efae72fb27\/resource\/455fd63b-603d-4608-8216-7d8647f43350\/download\/conposcovidloc.csv',\n                    parse_dates=DATE_FIELDS,\n                    )\nlatest.head()","3ba7f3ea":"percentiles = [50,80,90,95,100]\nmetrics = ['Episode_to_Report', 'Episode_to_Specimen', 'Specimen_to_Result', 'Result_to_Report']\ncombo_metrics = ['%s_%d' % (m, p) for m in metrics for p in percentiles]","6828ed5f":"latest['Episode_to_Report'] = (latest['Case_Reported_Date'] - latest['Accurate_Episode_Date']).dt.days\nlatest['Episode_to_Specimen'] = (latest['Specimen_Date'] - latest['Accurate_Episode_Date']).dt.days\nlatest['Specimen_to_Result'] = (latest['Test_Reported_Date'] - latest['Specimen_Date']).dt.days\nlatest['Result_to_Report'] = (latest['Case_Reported_Date'] - latest['Test_Reported_Date']).dt.days","cde8a103":"latest[metrics].describe()","a39d7c61":"latest[latest['Result_to_Report']==-83]","27d4c862":"latest[latest['Episode_to_Specimen']==-89]","cb86acd4":"latest[latest['Specimen_to_Result']==-30]","090426c0":"for m in metrics:\n    print('There are %d cases of missing %s' % (len(latest[np.isnan(latest[m])]), m))\nprint('... out of %d total cases' % len(latest))","37ce99d3":"latest_date = latest[DATE_FIELDS].max().max()\nlatest_date","ab35cb71":"delay_df = pd.DataFrame(index=pd.date_range('2020-03-01', latest_date), columns=combo_metrics)\n\nfor crd, grp in latest[latest['Accurate_Episode_Date']>=pd.to_datetime('2020-03-01')].groupby('Case_Reported_Date'):\n    for m in metrics:\n        for p in percentiles:\n            delay_df.loc[crd, '%s_%d' % (m, p)] = grp[m].quantile(p\/100)\ndelay_df.tail()","8e7315fa":"fig, axarr = plt.subplots(4, figsize=(6, 12))\nfor i, m in enumerate(metrics):\n    ax = axarr[i]\n    for p in percentiles:\n        delay_df.plot(y='%s_%d' % (m, p), label='%dth percentile' % p, ax=ax)\n        ax.set_ylabel(m)\n    ax.set_xlabel('Case_Reported_Date')","179a62dc":"latest[latest['Accurate_Episode_Date']>=pd.to_datetime('2020-03-01')].groupby('Reporting_PHU')[metrics].quantile([0.5, 0.9, 0.95, 1.0]).unstack()","1d8efcc4":"sentinel_date = pd.Timestamp.max\nsentinel_date","db8e346f":"latest_sentinel = latest.copy()\nfor d_f in DATE_FIELDS:\n    latest_sentinel[d_f] = latest_sentinel[d_f].fillna(sentinel_date)","edd3ae37":"latest_sentinel['Episode_to_Report'] = (latest_sentinel['Case_Reported_Date'] - latest_sentinel['Accurate_Episode_Date']).dt.days\nlatest_sentinel['Episode_to_Specimen'] = (latest_sentinel['Specimen_Date'] - latest_sentinel['Accurate_Episode_Date']).dt.days\nlatest_sentinel['Specimen_to_Result'] = (latest_sentinel['Test_Reported_Date'] - latest_sentinel['Specimen_Date']).dt.days\nlatest_sentinel['Result_to_Report'] = (latest_sentinel['Case_Reported_Date'] - latest_sentinel['Test_Reported_Date']).dt.days","97f0bb20":"sentinel_delay_df = pd.DataFrame(index=pd.date_range('2020-03-01', latest_date), columns=combo_metrics)\n\nfor crd, grp in latest_sentinel[latest_sentinel['Accurate_Episode_Date']>=pd.to_datetime('2020-03-01')].groupby('Case_Reported_Date'):\n    for m in metrics:\n        for p in percentiles:\n            sentinel_delay_df.loc[crd, '%s_%d' % (m, p)] = grp[m].quantile(p\/100)\nsentinel_delay_df.tail()","a4aec51b":"fig, axarr = plt.subplots(4, figsize=(6, 12))\nfor i, m in enumerate(metrics):\n    ax = axarr[i]\n    for p in percentiles:\n        sentinel_delay_df.plot(y='%s_%d' % (m, p), label='%dth percentile' % p, ax=ax)\n        ax.set_ylabel(m)\n    ax.set_xlabel('Case_Reported_Date')","73ffe65f":"def correct_sentinel(val_in_days):\n    # if it's off by more than 2 years, it's due to missing data\n    if (val_in_days > 730) or (val_in_days < -730):\n        return np.nan\n    else:\n        return val_in_days","252d1d7d":"for cm in combo_metrics:\n    sentinel_delay_df[cm] = sentinel_delay_df[cm].apply(correct_sentinel)","1bb5231f":"fig, axarr = plt.subplots(4, figsize=(6, 12))\nfor i, m in enumerate(metrics):\n    ax = axarr[i]\n    for p in percentiles:\n        sentinel_delay_df.plot(y='%s_%d' % (m, p), label='%dth percentile' % p, ax=ax)\n        ax.set_ylabel(m)\n    ax.set_xlabel('Case_Reported_Date')","a6bb70db":"latest_sentinel[latest_sentinel['Accurate_Episode_Date']>=pd.to_datetime('2020-03-01')].groupby('Reporting_PHU')[metrics].quantile([0.5, 0.9, 0.95, 1.0]).unstack().applymap(correct_sentinel)","098fda35":"# This Python 3 environment comes with many helpful analytics libraries installed\n# It is defined by the kaggle\/python Docker image: https:\/\/github.com\/kaggle\/docker-python\n# For example, here's several helpful packages to load\n\nimport numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\n\n# Input data files are available in the read-only \"..\/input\/\" directory\n# For example, running this (by clicking run or pressing Shift+Enter) will list all files under the input directory\n\nimport os\nfor dirname, _, filenames in os.walk('\/kaggle\/input'):\n    for filename in filenames:\n        print(os.path.join(dirname, filename))\n\n# You can write up to 5GB to the current directory (\/kaggle\/working\/) that gets preserved as output when you create a version using \"Save & Run All\" \n# You can also write temporary files to \/kaggle\/temp\/, but they won't be saved outside of the current session","dc944566":"# Ontario COVID-19 Duration Descriptive Stats\n\nThis notebook consumes the Ontario COVID-19 case-level data release (https:\/\/data.ontario.ca\/dataset\/confirmed-positive-cases-of-covid-19-in-ontario\/resource\/455fd63b-603d-4608-8216-7d8647f43350) and describes the length of time it takes for various activities to occur. Ideally, all activities happen as rapidly as possible, leading to good visibility of COVID-19 cases and prompt medical care for those requiring it.\n\nThe \"patient journey\" is measured using four dates:\n* Active_Episode_Date -- the best estimate of when the onset of symptoms occured\n* Specimen_Date -- the date that a specimen was collected from the patient for testing\n* Test_Reported_Date -- the date on which the test result was reported by the laboratory\n* Case_Reported_Date -- the date that the confirmed-positive case was logged by the Public Health Unit into the iPHIS database\n\nIn some cases, steps may have occurred out-of-order, particularly reporting of tests and cases. It is not entirely clear why, but you will see this in the statistics.\n\nWe measure four durations, defined as the difference between the dates above:\n* Episode-to-Report -- the time from (estimated) onset of symptoms to reporting in iPHIS.  This is the end-to-end measure and the most relevant for measuring surveillance performance\n* Episode-to-Specimen -- how long did it take the patient to arrive at an assessment centre and have a specimen collected?  This measures a mix of patient behaviour and assessment centre availability.\n* Specimen-to-Result -- how long between the collection of the specimen and completed processing by the lab?  This measures the test-processing workflow.\n* Result-to-Report -- how long between a positive lab result and a report logged in iPHIS?  This would ideally be zero.","e35a19c8":"The fact that the maximum-line is increasing linearly in the top plot indicates that cases from the beginning of the pandemic are still routinely being logged.  This is indicative of the poor data engineering at the start of the pandemic.","5bbb1dee":"Good!  Our missing data is showing up!\n\nNow let's correct for it.","c7b43d4c":"# Break Down by Public Health Unit\n\nLet's see how the PHUs compare.","35d849bb":"# Computation and Display of Percentiles\n\nLet's break down those metrics into percentiles, treating each day as its own cohort.  This will let use compare the trends from day to day.\n\nWe will look **starting March 1, 2020** as the handling of the pre-outbreak stage of the pandemic is not of much interest to us now.\n\nNB: this calculates the percentiles out of the non-missing data.  We'll handle the computation taking into account the missing data below.","2424dc4c":"## Outliers\n\nWe definitely have some outliers.  Let's take a look at a few of the extremes.","0e7ebbc9":"## Missing Data?\n\nHow many missing dates do we have?","e959c6be":"If we're still dealing with COVID-19 in 242 years in Ontario, we deserve our fate.  Also, someone will need to update this code.","d838d9f4":"# Accounting for Missing Data\n\nWe will use a sentinel date far in the future to replace the missing data.  We will then calculate percentiles and the far-future date will force all missing data to show up at the \"top\" of the percentile rank-ordered list.  If we get a sentinel date back from a percentile calculation, we will then replace it with `NaN`, indicating that we do not yet known the value of that percentile.","57b57192":"This looks like a data keying error.  5 and 2 are adjacent on the numeric pad, and the day part of the date would otherwise make sense.","6a2b6711":"This is interesting -- `NaN` indicates that some of the dates are missing, and you can clearly see where.","1628b2bc":"Data entry error seems likely.  Test Reported = 03-31 would make sense.","301cf5b3":"## Kaggle Boilerplate Below","4ab43d95":"Overall the outliers are probably not worrisome, as we'll be looking at things by percentile.","caa8d947":"Not clear what's happening with this one.  Is this a re-test?"}}