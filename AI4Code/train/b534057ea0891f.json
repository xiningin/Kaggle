{"cell_type":{"6636056b":"code","8d66da46":"code","f51e4d21":"code","7f65e217":"code","598c8699":"code","bac06444":"code","79bb2574":"code","7e0c903e":"code","0ce5023c":"code","09747efa":"code","71a324fa":"code","f766ca5f":"code","048713f7":"code","e622c251":"code","95bbc29c":"code","b794fff4":"code","e04c353d":"code","ed83e244":"code","5ba9b3a0":"code","9acf0875":"code","495508a5":"code","1765069e":"code","c6213f46":"code","15fe4e41":"code","85d3aa3e":"code","99c97a48":"code","8aad138d":"code","849c1767":"code","20ee2ffc":"code","ba5c7fde":"code","541d97df":"code","72d311ee":"code","b7c0972f":"code","ef66ed01":"code","7ec4f68e":"code","a222dee8":"code","13616ec4":"code","b60d3aa6":"code","5ce6ee28":"code","dcd9c92e":"code","6fa1d0d0":"code","009547b3":"code","b67d35b3":"code","46299f61":"code","d2dfd495":"code","6223e2a9":"code","dda477c5":"code","992291d1":"markdown","6779c064":"markdown","82693a5c":"markdown","4a38e3cf":"markdown","36a579d4":"markdown","baa0da72":"markdown","64bb5647":"markdown","7bd00f64":"markdown","e04a5910":"markdown","4f13e5c8":"markdown","5c1e5532":"markdown","df52a314":"markdown","dce3fa7f":"markdown","84ae438d":"markdown","8a4ef8ae":"markdown","73c18ef7":"markdown","1e4adf4f":"markdown","88c01883":"markdown","721d3165":"markdown","13437209":"markdown","86a9f63e":"markdown","da05187d":"markdown","502516f1":"markdown","9fb501cb":"markdown","8a576d60":"markdown","6860b8e4":"markdown","83b7b545":"markdown","0d047f82":"markdown","f7c417cb":"markdown","a27fb4f6":"markdown","028b7e45":"markdown","9b909de2":"markdown","a908bd6d":"markdown","c822a32b":"markdown","5acc1f57":"markdown"},"source":{"6636056b":"# This Python 3 environment comes with many helpful analytics libraries installed\n# It is defined by the kaggle\/python Docker image: https:\/\/github.com\/kaggle\/docker-python\n# For example, here's several helpful packages to load\n\nimport numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\n\n# Input data files are available in the read-only \"..\/input\/\" directory\n# For example, running this (by clicking run or pressing Shift+Enter) will list all files under the input directory\n\nimport os\nfor dirname, _, filenames in os.walk('\/kaggle\/input'):\n    for filename in filenames:\n        print(os.path.join(dirname, filename))\n\n","8d66da46":"data = pd.read_csv(\"..\/input\/hotel-booking-demand\/hotel_bookings.csv\")","f51e4d21":"import pandas as pd\nimport numpy as np\nimport matplotlib.pyplot as plt\nimport seaborn as sns\n%matplotlib inline\n\n#LabelEncoder for transforming the categorical data.\nfrom sklearn.preprocessing import LabelEncoder\n\n#Train test split\nfrom sklearn.model_selection import train_test_split\n#Confusion matrix and ROC\/AUC for comparing the models\nfrom sklearn.metrics import confusion_matrix\nfrom sklearn.metrics import roc_curve, auc\n#Models\nfrom sklearn.linear_model import LogisticRegression\nfrom sklearn.svm import SVC, LinearSVC\nfrom sklearn.ensemble import RandomForestClassifier\nfrom sklearn.neighbors import KNeighborsClassifier\nfrom sklearn.naive_bayes import GaussianNB","7f65e217":"#Checking whats the shape of our data\ndata.shape","598c8699":"#Checking the general info of our data\ndata.info()","bac06444":"# Checking if we have missing data in the dataframe\ndata.isnull().sum()","79bb2574":"#Dropping agent and company columns and filling missing data for children and country with the mode of those columns\ndata=data.drop(['agent','company'],axis=1)\ndata.country=data.country.fillna(data.country.mode()[0])\ndata.children=data.children.fillna(data.children.mean())","7e0c903e":"#Checking if we have more missing data:\ndata.isnull().sum()","0ce5023c":"#Getting a grasp of what the data contains and start planning what questions we want to answer in our exploratory data analysis\ndata.head()","09747efa":"# Finding out the unique values for the categorical variable in the dataset:\nprint('Unique values for hotel:\\n', data.hotel.unique())\nprint('Unique values for arrival_date_month:\\n', data.arrival_date_month.unique())\nprint('Unique values for customer_type:\\n', data.customer_type.unique())\nprint('Unique values for reservation_status:\\n', data.reservation_status.unique())\nprint('Unique values for deposit_type:\\n',data.deposit_type.unique())\nprint('Unique values for reserved_room_type :\\n',data.reserved_room_type .unique())\nprint('Unique values for assigned_room_type :\\n',data.assigned_room_type .unique())\nprint('Unique values for distribution_channel :\\n',data.distribution_channel .unique())\nprint('Unique values for market_segment :\\n',data.market_segment.unique())\nprint('Unique values for meal :\\n',data.meal.unique())","71a324fa":"# Transforming arrival date month names to numbers 1-12 for easier use and visualisation\n# I did this manually originally and then I saw \n\ndata.arrival_date_month=data.arrival_date_month.map({'January':1,'February':2,'March':3,'April':4,'May':5,'June':6,'July':7,'August':8,'September':9,'October':10,'November':11,'December':12})\n\n# transforming resort hotel and city hotel to 0 and 1 for easier use\n\ndata.hotel=data.hotel.map({'Resort Hotel':0 ,'City Hotel':1})","f766ca5f":"data.head()","048713f7":"#creating a column that defines whether the customers are family or not using the adults\/children\/babies columns\ndef family(data):\n    if (data.adults>0 and data.babies>0 and data.children>0):\n        val=1\n    else:\n        val=0\n    return val\ndata['family']=data.apply(family,axis=1)","e622c251":"#creating a column that calculates the tot number of people booking:\ndata['n_people']=data.adults + data.babies + data.children\n\n#creating a column that includes the total number of nights the customer booked for:\ndata['n_nights']=data['stays_in_weekend_nights']+data['stays_in_week_nights']","95bbc29c":"# 1. Whats the most popular month for bookings for both resort hotel and and city hotel\nplt.figure(figsize=(16,10))\nlegend_data={'Resort Hotel':0 ,'City Hotel':1}\nax=sns.countplot(x='arrival_date_month',data=data,hue='hotel')\nax.set(xlabel='Months',ylabel='Number of bookings')\nax.legend(legend_data)\nplt.show()","b794fff4":"#How does cancellation looks like for both hotels.\n\nax=sns.barplot(x='hotel',y='lead_time',hue='is_canceled', data=data.groupby([\"hotel\",\"is_canceled\"]).lead_time.count().reset_index())\n#ax.legend(legend_data)\nplt.show()\n","e04c353d":"data.groupby([\"is_canceled\"]).mean().reset_index()","ed83e244":"country_data=data.country.value_counts()\n# Adding the bookings for all countries outside of top 10 and naming that row other.\nother_vals=pd.DataFrame({0:country_data[10:].sum()},index=['other'])\n#Adding that new row to our data\ncountry_data=country_data.append(other_vals)\n# Sorting the country data in descending order\ncountry_data=country_data.sort_values(by=[0],ascending=False)\n\n\n# Creating the pie chart and displaying only the top 10 sources\nplt.figure(figsize=(10,6))\nplt.title('Top 10 sources per gross bookings volume')\nfig=plt.pie(country_data[0:9],labels=country_data.index[0:9],autopct='%1.1f%%')\nplt.show()\n","5ba9b3a0":"#Are there any major differences in lead time for both hotels.\n\ndata[['hotel','lead_time']].groupby([\"hotel\"]).mean().reset_index()","9acf0875":"plt.figure(figsize=(10,6))\nax=sns.barplot(x='hotel',y='lead_time', data=data[['hotel','lead_time']].groupby([\"hotel\"]).mean().reset_index())\n#ax.legend(legend_data)\nplt.title('Booking lead times by hotel type')\nplt.show()","495508a5":"#Whats the ADR behaviour across different months\ndata_line_plot=data[['arrival_date_year','arrival_date_month','lead_time']].groupby(['arrival_date_year',\"arrival_date_month\"]).mean().reset_index()\ndata_line_plot","1765069e":"#plotting a graph with lead time per year for all the data.\nplt.figure(figsize=(10,6))\nplt.title('Yearly Lead time trends for both hotels at the same time')\nsns.lineplot(x='arrival_date_month',y='lead_time',data=data_line_plot,hue='arrival_date_year',marker='o',palette=['red','blue','green'])\nplt.show()","c6213f46":"#Whats the proportion between booked and cancelled(what's the cancellation rate for both hotels)\nlineplot2=data[['is_canceled','hotel','lead_time']].groupby(['is_canceled','hotel']).count().reset_index()\nlineplot2","15fe4e41":"plt.figure(figsize=(10,6))\nax=sns.barplot(x='hotel',y='lead_time', data=lineplot2,hue='is_canceled')\n#ax.legend(['Resort hotel is 0','City hotel is 1'])\nplt.title('Booking lead times by hotel type')\nplt.show()","85d3aa3e":"# Calculating the cancelation rate for both hotels:\nprint('Calcelation rate for resort hotel:',round(lineplot2['lead_time'][2]\/(lineplot2['lead_time'][0]+lineplot2['lead_time'][2]),2))\nprint('Calcelation rate for city hotel:',round(lineplot2['lead_time'][3]\/(lineplot2['lead_time'][1]+lineplot2['lead_time'][3]),2))","99c97a48":"#Is there a link between number of guests and hotel booked\n#Pivoting the number of hotels and seeing what the mean of n_people is:\ndata[['hotel','n_people']].groupby(['hotel']).mean().reset_index()","8aad138d":"#Are cancellation spiking in a particular month or year\ndata_line_plot=data[['arrival_date_year','arrival_date_month','is_canceled','hotel']].groupby(['arrival_date_year',\"arrival_date_month\",'hotel']).mean().reset_index()\ndata_line_plot","849c1767":"#plotting a graph with lead time per year for all the data.\nplt.figure(figsize=(10,6))\nplt.title('Yearly cancelation trends for both hotels')\nsns.lineplot(x='arrival_date_month',y='is_canceled',data=data_line_plot,hue='hotel',marker='o',palette=['red','blue'])\nplt.show()","20ee2ffc":"# Calling the LabelEncoder. Also I am duplicating data into data1 where I will encode all the categorical values.\n# After that I will see the correlations of all the variables and particularly the correllation with is_cancelled.\n#That way if some of the variables have very low correlation I can safely drop from the models.\nle = LabelEncoder()\ndata1=data\ndata1.customer_type=le.fit_transform(data1.customer_type)\n# changing the country strings to numerical data\ndata1.country=le.fit_transform(data1.country)\n#Transforming all the data to numerical values so that we can use those variables for correlation analysis and the model building\ndata1.deposit_type=le.fit_transform(data1.deposit_type)\ndata1.reserved_room_type=le.fit_transform(data1.reserved_room_type)\ndata1.assigned_room_type=le.fit_transform(data1.assigned_room_type)\ndata1.distribution_channel=le.fit_transform(data1.distribution_channel)\ndata1.market_segment=le.fit_transform(data1.market_segment)\ndata1.meal=le.fit_transform(data1.meal)","ba5c7fde":"data1.corr()","541d97df":"#Determining how how are all x values correlated to is_canceled\ndata1.corr()['is_canceled']","72d311ee":"#Correlation heatmap\nplt.figure(figsize=(40,25))\nsns.heatmap(data1.corr(),annot=True,annot_kws={'size':18})\nplt.xticks(fontsize=25)\nplt.yticks(fontsize=25)\nplt.show()","b7c0972f":"#droping all the abovementioned columns\ndata1=data1.drop(['reservation_status','stays_in_weekend_nights','arrival_date_week_number','stays_in_weekend_nights','arrival_date_day_of_month','meal','babies','children','n_people'],axis=1)\ndata1=data1.drop(['n_nights'],axis=1)\ndata1=data1.drop(['reservation_status_date'],axis=1)\n","ef66ed01":"data1.head()","7ec4f68e":"# Firstly move the is canceled column to y as thats what we want to predict\ny=data1['is_canceled']\n\n#Then drop the is_canceled column from our features.\nx=data1.drop(['is_canceled'],axis=1)\n\n# Create the test\/train split for our models. I have arbitrary chosen 80-20 split.\nx_train, x_test, y_train, y_test = train_test_split(x, y, test_size = 0.2)","a222dee8":"#logistic regression\nlogreg = LogisticRegression()\nlogreg.fit(x_train, y_train)\ny_pred = logreg.predict(x_test)\ny.prob=logreg.decision_function(x_test)\nacc_log = round(logreg.score(x_test, y_test) * 100, 2)\nprint('Score:',acc_log)\nprint('Confusion matrix:\\n',confusion_matrix(y_test, y_pred))","13616ec4":"#Creating roc and aoc for logreg\nlogreg_fpr,logreg_tpr,threshold=roc_curve(y_test,y_pred)\nauc_logreg=auc(logreg_fpr,logreg_tpr)","b60d3aa6":"#Naive bayes classifier\nnbc = GaussianNB()\nnbc.fit(x_train, y_train)\ny_pred = nbc.predict(x_test)\nacc_nbc = round(nbc.score(x_test, y_test) * 100, 2)\nprint('Score:',acc_nbc)\nprint('Confusion matrix:\\n',confusion_matrix(y_test, y_pred))","5ce6ee28":"#Creating roc and aoc for GaussianNB\nnbc_fpr,nbc_tpr,threshold=roc_curve(y_test,y_pred)\nauc_nbc=auc(nbc_fpr,nbc_tpr)","dcd9c92e":"#SVC\nsvc = SVC()\nsvc.fit(x_train, y_train)\ny_pred = svc.predict(x_test)\nacc_svc = round(svc.score(x_test, y_test) * 100, 2)\nprint('Score:',acc_svc)\nprint('Confusion matrix:\\n',confusion_matrix(y_test, y_pred))","6fa1d0d0":"#Creating roc and aoc for SVC\nsvc_fpr,svc_tpr,threshold=roc_curve(y_test,y_pred)\nauc_svc=auc(svc_fpr,svc_tpr)","009547b3":"#Random Forest\nrf = RandomForestClassifier()\nrf.fit(x_train, y_train)\ny_pred = rf.predict(x_test)\nacc_rf = round(rf.score(x_test, y_test) * 100, 2)\nprint('Score:',acc_rf)\nprint('Confusion matrix:\\n',confusion_matrix(y_test, y_pred))","b67d35b3":"#Creating roc and aoc for Random Forest\nrf_fpr,rf_tpr,threshold=roc_curve(y_test,y_pred)\nauc_rf=auc(rf_fpr,rf_tpr)","46299f61":"#knn neghbours\nknn = KNeighborsClassifier()\nknn.fit(x_train, y_train)\ny_pred = knn.predict(x_test)\nacc_knn = round(knn.score(x_test, y_test) * 100, 2)\nprint('Score:',acc_knn)\nprint('Confusion matrix:\\n',confusion_matrix(y_test, y_pred))","d2dfd495":"#Creating roc and aoc for knn neighbours\nknn_fpr,knn_tpr,threshold=roc_curve(y_test,y_pred)\nauc_knn=auc(knn_fpr,knn_tpr)","6223e2a9":"model_names=['Logistic Regression','Naive Bayes Classifier','SVC(Support Vector Classification)','Random Forest','k-Nearest Neighbors']\naccuracy=[acc_log,acc_nbc,acc_svc,acc_rf,acc_knn]\nauc=[auc_logreg,auc_nbc,auc_svc,auc_rf,auc_knn]\nresults=pd.DataFrame({'Model':model_names,'Accuracy':accuracy,'AUC':auc})\nresults","dda477c5":"#plotting the AUC curves to visualise that random forest model is the best in this situation\nplt.figure(figsize=(10,10))\nplt.plot(logreg_fpr,logreg_tpr,label='Logistic Regrassion (auc=%0.3f)' %auc_logreg)\nplt.plot(nbc_fpr,nbc_tpr,label='Naive Bayes Classifier (auc=%0.3f)' %auc_nbc)\nplt.plot(svc_fpr,svc_tpr, label='Support Vector Classifier (auc=%0.3f)' %auc_svc)\nplt.plot(rf_fpr,rf_tpr, label='Random Forest (auc=%0.3f)' %auc_rf)\nplt.plot(knn_fpr,knn_tpr, label='KNN neighbours (auc=%0.3f)' %auc_knn)\nplt.title('AUC for all 5 models')\nplt.xlabel('False Positives')\nplt.ylabel('True Postives')\nplt.legend(loc=4)\nplt.show()","992291d1":"Checking if we have missing data in the dataframe","6779c064":" # Preprocessing","82693a5c":"Now we have fixed our missing data and we no longer have empty rows:","4a38e3cf":"#### Country data inference:\n*Biggest source is domestic with other major EU sources following.","36a579d4":"Transforming arrival date month names to numbers 1-12 for easier use and visualisation. Also transforming hotels to Resort Hotel:0 ,City Hotel:1","baa0da72":"# Label encoding the categorical columns \n\nIn this section we are transforming the categorical data into numerical in order to run a correlation analysis and find which features are relevant for our machine learning model.","64bb5647":"## Logistic Regression calculations","7bd00f64":"# Visualising the Area under the curve with a line plot\nWe can clearly see that the random forest perform best among the 5 machine learning models built and it is the furthest away from the diagonal of the graph.","e04a5910":"A quick pivot method below to see if there is a significant difference in the means of some of the parameters for the canceled bookings vs the non-canceled bookings.\n* Firstly we can see again that cancellations tend to occur more frequently in the city breaks than the resort hotels(in the hotel column we can see that in the cancelled row the mean is 0.748 which means that cancellations are favoured towards the 1(city hotel rather than the 0(resort))\n* People who book much in advance tend to cancel their bookings more often (144.8 vs 79.98) which makes sense as short lead time bookings leave less time for the customers to change their mind.\n* Both arrival date months means are around 6.5-6.6 which means that somewhere between june and july volume for both peaks. Those numbers being so close together indicates that there wont be big correlation between which month customer books and cancellation though\n* There is no signigicant difference between weekdays and weekends which means that there shouldnt be a strong correlation between which days of the week the customers are booking and cancellation\n* The customers who have cancelled before are much more likely to cancel again.\n* The customers who amend their bookings more often tend to cancel much less.\n* The more customers are in the waiting list the more likely they will cancel.\n* Cheaper bookings get cancelled less on average than more expensive bookings.\n* The more special requests customers have the less likely they will cancel their booking.\n* There is no immediate inference we can make about the new metrics we created and cancellation (family,n_people,n_nights)","4f13e5c8":"[](http:\/\/)Seems like we have 4 problematic columns with missing data, namely:country,agent,company,children.\nWe have a few options in order to tackle the incomplete data.\n1. We can replace the missing entries with the most common occurances (the mode) in that particular column.\n2. We can delete the missing data from the dataframe.\n\n### Decision about missing data\nWe can take a mixed approach: We will drop the company and agent columns from the data frame as we have way too many missing entries there.\n\nWe can add the missing 488 country entries with the most frequest occurent country(mode).It would be reasonable to just drop these entries too as we have sufficiently large dataset.\n\nSimilarly we will add the 4 missing children entries with the mean of the column.\n","5c1e5532":"seeing all the categorical unique values for our categorical columns","df52a314":"## Naive Bayes Classifier calculations","dce3fa7f":"## K-near neigbours Classifier calculations","84ae438d":"#### From the chart below we can make a few decisions:\n1. Drop arrival_date_week_number, stays_in_weekend_nights and arrival_date_day_of_month since their importances are really low while predicting cancellations.\n2.  Also we need to drop babies and children and we have used them to create the n_people column.\n3. We need to drop reservation_status as we have data there about which data is cancelled and which not, so we cannot use that as a X variable.\n4. Adults has better explanation power than total number of people so drop that column that we previously created.\n5. Drop n_nights ad the week_nights column has better explanaion power.","8a4ef8ae":"## Random Forest calculations","73c18ef7":"Checking the general info of our data:","1e4adf4f":"Whats the proportion between booked and cancelled(what's the cancellation rate for both hotels)\n* Cancelation rate for resort hotel :28%\n* Cancelation rate for city hotel: 42%","88c01883":"# Model training and testing.\nNow we are ready to train our model and predict which customer will cancel their booking. There are many predictive algorithms to choose from. As this problem is a classification and regression problem I will choose:\n1. Logistic Regression\n2. Naive Bayes Classifier\n3. SVC(Support Vector Classification)\n4. Random Forest\n5. KNN or k-Nearest Neighbors\n\nI will then do 3 metrics:\n* Calculate the score of each model\n* Calculate the confusion matrix of each model\n* Calculate the ROC\/AUC for each model.\n\n#### Finally, I will combine the scoreas and AUC for each model and see which model performed best. The goal is too choose the model with the highest score\/AUC.\n","721d3165":"Cancellations for city hotel are consistently higher than the cancellations for the resort:","13437209":"Final visual check to see if our Label Encoder worked as intended:","86a9f63e":"### Thanks for taking the time to read my analysis. If you have questions, do not hesitate to ask!\n### I welcome all kind of feedback as I am still learning and trying to improve my data science skills.","da05187d":"#### Pivoting the data in order to try and spot some trends in lead time over the years.\n* We can see that we have increasing lead time trend YOY thats consistent across all years in the dataset","502516f1":"Shape of our DataFrame:","9fb501cb":"## SVC calculations","8a576d60":"Checking how is our data looking:","6860b8e4":"## Imports\n","83b7b545":"We are adding a few more columns that we will later check if they are relevant for our machine learning training.\n\nThe ones will be created are :\n1. family - if the booking is made by a family then 1(if the booking includes adults and babies and children), else 0\n2. n_people - that is the total number of adults babies and children\n3. n_nights - thats the total number of nights the customers booked (weekend nights + week nights)","0d047f82":"There is no big difference between number of people that have booked the hotel and cancelation which means that we shouldnt expect strong correlation between number of people and cancellation","f7c417cb":"### To prep the data for model building we need to:\n1. move the is_canceled column in a var named y\n2. drop the is_canceled column from data1 and name it x\n3. split our data into train\/test data.","a27fb4f6":"## Result summary","028b7e45":"#### Findings:\n* We can see that the city hotel has bigger volume than the resort hotel. \n* Appart from that given the fact that the dataset is for Portugal we can see that there is seasonality in summer (volume peaks in summer).\n* Customers tend to be more likely to cancel the city hotel than the resort hotel on average.","9b909de2":"# Running correlation analysis to determine which variables are significant for our analysis.","a908bd6d":"#### We have put all results into a DataFrame to best see and comapare all 5 machine learning performance.\n#### We can see that the random forest model has the best accuracy (almost 89%) with the bes ROC\/AUC measure.****","c822a32b":"# Hotel Bookings Analysis\n\nThe aim is to create a  variety of models that predicts the cancellation and compare them in order to see which one would work the best.Ultimately we want to pick the most efficient model.\n### 1. Preprocessing\n- Handle missing values.\n- Prepare and transform the data if needed for the machine learning models.\n- Create a few more columns, namely:\nfamily - 1 if the booking is from a family and 0 otherwise\nn_people - total number of people the booking is for\nn_nights - total number of nights the booking is for\n\n\n### 2. Exploratory Data Analysis\n\nQuestions for our EDA(exploratory data analysis)\n1. Whats the most popular month for bookings for both resort hotel and and city hotel\n2. Which are the major sources booking those 2 hotels.\n3. Are there any major differences in lead time for both hotels.\n4. Whats the ADR behaviour across different months\n5. Whats the proportion between booked and cancelled(what's the cancellation rate for both hotels)\n6. Whats the trend across multiple years.\n7. Is there a link between number of adults and hotel booked\n8. Are customers prefering to start their holiday during the weekend or weekday\n9. Are cancellation spiking in a particular month or year\n\n\n### 3. Models and comparison\n\n- Logistic Regression\n- Naive Bayes Classifier\n- Support Vector Classification\n- Random Forest\n- K nearest neighbour","5acc1f57":"# EDA"}}