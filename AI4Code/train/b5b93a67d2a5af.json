{"cell_type":{"7d804dc6":"code","107e12ba":"code","b81aea1b":"code","a545ca27":"code","f96493db":"code","ad3904e7":"code","a256bee6":"code","705309a2":"code","1bd08b94":"code","feba2b7e":"code","a6b458e9":"code","fb9c0532":"code","75a524bc":"code","459daf46":"code","a2975653":"code","18e02315":"code","155fa86d":"code","ad83a194":"code","fde9607a":"code","679ba47f":"code","64f43f68":"code","2fdf0dae":"code","feb6c171":"code","8a394065":"code","0a6d804d":"code","fde00f7e":"code","3d7929f3":"code","c888a0e4":"code","5717aa70":"markdown","dc19090a":"markdown","c092473c":"markdown","b5e3de6d":"markdown","5946d311":"markdown","b0d86517":"markdown","c421326e":"markdown","039bad05":"markdown","b20c6c98":"markdown","451ad1bf":"markdown","a457a3e5":"markdown","c7f8d891":"markdown","eb3a7043":"markdown","c9d756dc":"markdown","44e8c333":"markdown","55cc3b18":"markdown","48a730dc":"markdown","26ead257":"markdown","4a0edcdd":"markdown","0988f6bc":"markdown","caebd0ea":"markdown","686ba7c7":"markdown","f9332028":"markdown","37401aaa":"markdown","bddd9fd3":"markdown","2ffae440":"markdown","1f70d731":"markdown","867601a7":"markdown","e1556cdf":"markdown","97d3a797":"markdown","701cb829":"markdown","64819aa8":"markdown","3f8574ce":"markdown","a638ec75":"markdown"},"source":{"7d804dc6":"import numpy as np\nimport pandas as pd\nimport os\nimport matplotlib.pyplot as plt\nimport tqdm\nimport re\nimport cv2","107e12ba":"train_df = pd.read_csv('..\/input\/osic-pulmonary-fibrosis-progression\/train.csv')\ntest_df = pd.read_csv('..\/input\/osic-pulmonary-fibrosis-progression\/test.csv')","b81aea1b":"train_df.head()","a545ca27":"train_df.info()","f96493db":"test_df.head()","ad3904e7":"test_df.info()","a256bee6":"import pydicom\nimport glob","705309a2":"def visualize_dicom(images, limit = 16):\n    images = images[:limit]\n    \n    fig, ax = plt.subplots(4, 4, figsize = (20, 20))\n    ax = ax.flatten()\n    \n    for index, file in enumerate(images):\n        image_data = pydicom.read_file(file).pixel_array\n        ax[index].imshow(image_data, cmap = plt.cm.bone)\n        \n        name = '-'.join(file.split('\/')[-2:])\n        ax[index].set_title(name)","1bd08b94":"TRAIN_PATH = '\/kaggle\/input\/osic-pulmonary-fibrosis-progression\/train'\nimage_files = glob.glob(os.path.join(TRAIN_PATH, '*', '*.dcm'))\n\nvisualize_dicom(image_files)","feba2b7e":"# !pip3 install med2image","a6b458e9":"TRAIN_PATH_PATIENT = '\/kaggle\/input\/osic-pulmonary-fibrosis-progression\/train\/ID00123637202217151272140'\n\nimages_patient = glob.glob(os.path.join('\/kaggle\/input\/osic-pulmonary-fibrosis-progression\/train\/ID00123637202217151272140\/*.dcm'\n))\n\nimages_patient.sort(key=lambda f: int(re.sub('\\D', '', f)))\n\nfor index, file in enumerate(images_patient[:10]):\n    print(file)","fb9c0532":"# ! mkdir \"patient-png-1\"","75a524bc":"!pip3 install mritopng","459daf46":"import mritopng\nmritopng.convert_folder('\/kaggle\/input\/osic-pulmonary-fibrosis-progression\/train\/ID00123637202217151272140', '.\/patient-png-1\/')","a2975653":"images_patient_png = glob.glob(os.path.join('\/kaggle\/working\/patient-png-1\/*.png'\n))\nimages_patient_png.sort(key=lambda f: int(re.sub('\\D', '', f)))\n\nfor index, file in enumerate(images_patient_png[:10]):\n    print(file)","18e02315":"img_array = []\nfor frame in images_patient_png:\n    img = cv2.imread(frame)\n    height, width, layers = img.shape\n    size = (width,height)\n    img_array.append(img)\n \n \nout = cv2.VideoWriter('project.mp4',cv2.VideoWriter_fourcc(*'mp4v'), 15, size)\n \nfor i in range(len(img_array)):\n    out.write(img_array[i])\nout.release()","155fa86d":"image_data = pydicom.read_file(image_files[3837])\nimage_data","ad83a194":"dir(image_data)","fde9607a":"def extract_metadata(file):\n    image_data = pydicom.read_file(file)\n    \n    record = {\n        'patient_ID': image_data.PatientID,\n        'patient_name': image_data.PatientName,\n        'patient_sex': image_data.PatientSex,\n        'modality': image_data.Modality,\n        'body_part_examined': image_data.BodyPartExamined,\n        'photometric_interpretation': image_data.PhotometricInterpretation,\n        'rows': image_data.Rows,\n        'columns': image_data.Columns,\n        'pixel_spacing': image_data.PixelSpacing,\n        'window_center': image_data.WindowCenter,\n        'window_width': image_data.WindowWidth,\n        'bits_allocated': image_data.BitsAllocated\n    }\n    \n    return record","679ba47f":"metadata_list = []\n\nfor file in tqdm.tqdm(image_files):\n    metadata_list.append(extract_metadata(file))","64f43f68":"metadata_df = pd.DataFrame.from_dict(metadata_list)\nmetadata_df.head()","2fdf0dae":"len(metadata_df)","feb6c171":"from collections import Counter\nimport plotly.express as px\nimport seaborn as sns","8a394065":"smoker_counts = dict(Counter(train_df['SmokingStatus']))\nsmoker_counts = {'status': list(smoker_counts.keys()), 'count': list(smoker_counts.values())}\nsmoker_df = pd.DataFrame(smoker_counts)\n\nfig_smoker = px.pie(smoker_df, values = 'count', names = 'status', title = 'Smoker Status', hole = .5, color_discrete_sequence = px.colors.diverging.Portland)\nfig_smoker.show()","0a6d804d":"sex_counts = dict(Counter(train_df['Sex']))\nsex_counts = {'sex': list(sex_counts.keys()), 'count': list(sex_counts.values())}\nsex_df = pd.DataFrame(sex_counts)\n\nfig_sex = px.pie(sex_df, values = 'count', names = 'sex', title = 'Gender Distribution', hole = .5, color_discrete_sequence = px.colors.sequential.Agsunset)\nfig_sex.show()","fde00f7e":"# Uncomment for interactive histogram\n# fig_age = px.histogram(train_df, x=\"Age\")\n# fig_age.update_layout(title_text='Age Distribution')\n# fig_age.show()\n\nplt.figure(figsize = (10, 7))\nax = sns.distplot(train_df['Age'])\nax.set_title('Histogram for Age')","3d7929f3":"# Uncomment for interactive histogram\n# fig_fvc = px.histogram(train_df, x=\"FVC\")\n# fig_fvc.update_layout(title_text='FVC Distribution')\n# fig_fvc.show()\n\nplt.figure(figsize = (10, 7))\nax = sns.distplot(train_df['FVC'])\nax.set_title('Histogram for FVC')","c888a0e4":"# Code for deleting output visualizations (reduces the chances of slow loading of the kernel)\n! rm -rf '.\/patient-png-1\/'","5717aa70":"# Video of the Scan!\n\n> **Update:** I uploaded the video to Imgur. The raw video must be available down in the output files section (above comments).\n\nHere is a video of the scan, it looks really interesting:","dc19090a":"We will be visualizing images using the `pydicom` package. \n\nLet's define a function to visualize DICOM images:","c092473c":"Let's see the distribution of patient's ages:","b5e3de6d":"Here is the metadata of the 10th image in the training set:","5946d311":"<blockquote class=\"imgur-embed-pub\" lang=\"en\" data-id=\"a\/0pCtdHN\"  ><a href=\"\/\/imgur.com\/a\/0pCtdHN\">OSIC Pulmonary Fibrosis MRI Scan<\/a><\/blockquote><script async src=\"\/\/s.imgur.com\/min\/embed.js\" charset=\"utf-8\"><\/script>","b0d86517":"# Basic EDA\n\nLet us import `plotly` for making visualizations:","c421326e":"Here is our train.csv:","039bad05":"Here is a small piece of code for generating a video using the converted images:","b20c6c98":"Check more about `pydicom` here: https:\/\/pydicom.github.io\/pydicom\/0.9\/viewing_images.html","451ad1bf":"Let us now visualize DICOM (`.dcm` images in the dataset.):","a457a3e5":"## Ground Truths by Researchers:","c7f8d891":"It seems that there isn't missing data. This is great!","eb3a7043":"These were the records of the 33026 images in the training set.","c9d756dc":"In this kernel, I'll be converting sliced `.dcm` images to PNG of a particular patient with a unique ID, feel free to change the code for suitable conversion for all patients:","44e8c333":"Now we'll be converting this to a DataFrame object:","55cc3b18":"# About Pulmonary Fibrosis:\n\n**Pulmonary fibrosis** is a condition that causes lung scarring and stiffness. This makes it difficult to breathe. It can prevent your body from getting enough oxygen and may eventually lead to respiratory failure, heart failure, or other complications.\n\nResearchers currently believe that a combination of exposure to lung irritants like certain chemicals, smoking, and infections, along with genetics and immune system activity, play key roles in pulmonary fibrosis.\n\n![Pulmonary Fibrosis](https:\/\/external-content.duckduckgo.com\/iu\/?u=https%3A%2F%2Fwww.pulmonologyadvisor.com%2Fwp-content%2Fuploads%2Fsites%2F21%2F2019%2F03%2Ffibrosis.tuberculosis_SH_414679936.jpg&f=1&nofb=1)","48a730dc":"79% patients are male, 21% female:","26ead257":"Let's create a **utility function for extracting metadata** from DICOM images:","4a0edcdd":"Let's see the converted images:","0988f6bc":"# Basic EDA and DICOM Visualization\n\nI know you're excited for the new competition! Let's start with some EDA and the most important part, visualizing DICOM images!","caebd0ea":"# What's DICOM?\n\n**Digital Imaging and Communications in Medicine (DICOM)** is the standard for the communication and management of medical imaging information and related data. \n\nDICOM is most commonly used for storing and transmitting medical images enabling the integration of medical imaging devices such as scanners, servers, workstations, printers, network hardware, etc.","686ba7c7":"## Give your suggestions and feel free to ask questions!","f9332028":"`mritopng` reads the folder and converts the `.dcm` files to PNG:","37401aaa":"Here is a distribution of the smoking status of the patients:","bddd9fd3":"Let's create a empty list and append new records to the dictionary:","2ffae440":"# Converting DICOM (.dcm) to PNG:\n\nLet's try to convert DICOM (`.dcm`) files to PNG for future use.\n\n","1f70d731":"According to scientific research,\n\nYou\u2019re more likely to be diagnosed with pulmonary fibrosis if you:\n\n- are male\n- are between the ages of 40 and 70\n- have a history of smoking","867601a7":"# DICOM Visualization:","e1556cdf":"Let's manually make a directory for saving the converted images:","97d3a797":"Let's see the FVC distribution:\n\n**Forced vital capacity (FVC)** is the amount of air that can be forcibly exhaled from your lungs after taking the deepest breath possible, as measured by spirometry. This test may help distinguish obstructive lung diseases, such as asthma and COPD, from restrictive lung diseases, such as pulmonary fibrosis and sarcoidosis. ","701cb829":"# Metadata in DICOM images:\n\nDICOM images generally contain metadata like patient's name, ID, image data like photometric interpretation, transfer syntax, image width and height, etc.\n\nMore about metadata in DICOM files can be seen at: http:\/\/dicom.nema.org\/dicom\/2013\/output\/chtml\/part10\/chapter_7.html","64819aa8":"Most patients are ex-smokers, and there are a significant amount of people who didn't smoke.","3f8574ce":"Only 5 rows. Ok.","a638ec75":"# Conclusion:\n\nIn this kernel:\n\n- We got to know about DICOM images\n\n- We visualized DICOM images\n\n- Viewing sliced images as a video (Cool MRI Scan)\n\n- We saw that with visualizations we are able to align with the study conducted by the researchers:\n\n    - Most patients were male.\n    - Most patients had a history of smoking\n    - A significant portion of patients had an age between 40-70\n\n\n\nDo upvote the kernel if you liked it!"}}