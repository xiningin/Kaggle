{"cell_type":{"9982c6a9":"code","802e2cf4":"code","d46e89e5":"code","6c3aaf76":"code","1e828134":"code","418baf24":"code","c3c1e39b":"code","77ad9bd9":"code","6648d0b7":"code","eea2fff8":"code","c455c3fd":"code","e89e257c":"code","0d02ddc3":"code","c2362ed7":"code","69b3541a":"code","a550654f":"code","cd11eb5f":"code","a18de85b":"code","2845a176":"code","2a97148f":"code","8560b3f8":"code","c69c31e5":"code","6d113ce0":"code","4ead978d":"code","458d9115":"code","ae293671":"code","18094ac5":"code","83638a16":"code","75f34053":"code","25a60591":"code","60acb5bb":"code","acdcc65d":"code","f3722357":"code","173600d9":"code","9009a9fd":"code","e4ee898a":"code","2bfd4999":"code","bb4746cc":"markdown","10364c87":"markdown","5f550cb9":"markdown","a6221d17":"markdown","74c1a7f2":"markdown","03420039":"markdown","ac83f3fd":"markdown","e71a3e36":"markdown","7b630f3b":"markdown","ad8e00f4":"markdown","7ab6ee28":"markdown","be0eefa4":"markdown","e22ae522":"markdown","48f853f1":"markdown","29672990":"markdown","97d10e5e":"markdown","71e73f8f":"markdown","58b56fef":"markdown","0ab8f90f":"markdown","1abbc0df":"markdown","8bd46da7":"markdown","ad167398":"markdown","efb0afad":"markdown","e15b9984":"markdown","d6206e87":"markdown","81088838":"markdown","15bf8779":"markdown","a3f83e63":"markdown","037a8dc6":"markdown","01e74080":"markdown","05136f94":"markdown","9491e8ab":"markdown","58b5f4e2":"markdown","db6eb035":"markdown","b7ae1735":"markdown","1c67688e":"markdown","f12db258":"markdown","850adad5":"markdown","6513159e":"markdown","25302d59":"markdown","7bd71ff8":"markdown","bdf630ec":"markdown","a2356f92":"markdown"},"source":{"9982c6a9":"!pip install fastai2 -q","802e2cf4":"#Load the dependancies\nfrom fastai2.basics import *\nfrom fastai2.callback.all import *\nfrom fastai2.vision.all import *\n\nimport seaborn as sns\nimport numpy as np\nimport pandas as pd\nimport os\nimport cv2\nimport openslide\n\nsns.set(style=\"whitegrid\")\nsns.set_context(\"paper\")\n\nmatplotlib.rcParams['image.cmap'] = 'ocean_r'","d46e89e5":"source = Path(\"..\/input\/prostate-cancer-grade-assessment\")\nfiles = os.listdir(source)\nfiles","6c3aaf76":"train = source\/'train_images'\nmask = source\/'train_label_masks'\ntrain_labels = pd.read_csv(source\/'train.csv')\ntrain_labels.head()","1e828134":"def view_image(folder, fn):\n    if folder == train:\n        filename = f'{folder}\/{fn}.tiff'\n    if folder == mask:\n        filename = f'{folder}\/{fn}_mask.tiff'\n    file = openslide.OpenSlide(str(filename))\n    t = tensor(file.get_thumbnail(size=(255, 255)))\n    if folder == train:\n        show_image(t)\n    if folder == mask:\n        show_image(t[:,:,0])","418baf24":"view_image(train, '0005f7aaab2800f6170c399693a96917')","c3c1e39b":"view_image(mask, '0005f7aaab2800f6170c399693a96917')","77ad9bd9":"def view_images(file, mask, fn):\n    ima = f'{file}\/{fn}.tiff'\n    msk = f'{mask}\/{fn}_mask.tiff'\n    ima_file = openslide.OpenSlide(str(ima)); ima_t = tensor(ima_file.get_thumbnail(size=(255, 255)))\n    ima_msk = openslide.OpenSlide(str(msk)); msk_t = tensor(ima_msk.get_thumbnail(size=(255, 255)))\n    \n    fig, (ax1, ax2, ax3) = plt.subplots(1,3, figsize = (20, 6))\n    s1 = show_image(ima_t, ax=ax1, title='image')\n    s2 = show_image(msk_t[:,:,0], ax=ax2, title='mask')\n    s3 = plt.hist(msk_t.flatten()); plt.title('mask histogram')\n    plt.show()","6648d0b7":"view_images(train, mask, '06636cdd43041e78141f2f5069fa62d5')","eea2fff8":"view_images(train, mask, '0d3159cd1b2495cc82637ececf63ed41')","c455c3fd":"view_images(train, mask, '08134913a9aa1d541f719e9f356f9378')","e89e257c":"from fastai2.medical.imaging import *","0d02ddc3":"@patch\n@delegates(show_image)\ndef show(self:PILImage, scale=True, cmap=plt.cm.ocean_r, min_px=None, max_px=None, **kwargs):\n    px = tensor(self)\n    if min_px is not None: px[px<min_px] = float(min_px)\n    if max_px is not None: px[px>max_px] = float(max_px)\n    show_image(px, cmap=cmap, **kwargs)","c2362ed7":"def selective_mask(file, mask, fn, min_px=None, max_px=None):\n    ima = f'{file}\/{fn}.tiff'\n    msk = f'{mask}\/{fn}_mask.tiff'\n    ima_file = openslide.OpenSlide(str(ima)); ima_t = tensor(ima_file.get_thumbnail(size=(255, 255)))\n    ima_msk = openslide.OpenSlide(str(msk)); msk_t = tensor(ima_msk.get_thumbnail(size=(255, 255)))\n    msk_pil = PILImage.create(msk_t[:,:,0])\n    \n    fig, (ax1, ax2, ax3, ax4) = plt.subplots(1,4, figsize = (20, 6))\n    s1 = show_image(ima_t, ax=ax1, title='image')\n    s2 = show_image(msk_t[:,:,0], ax=ax2, title='mask')\n    s3 = msk_pil.show(min_px=min_px, max_px=max_px, ax=ax3, title=f'selective mask: min_px:{min_px}')\n    s4 = plt.hist(msk_t.flatten()); plt.title('mask histogram')\n    plt.show()","69b3541a":"selective_mask(train, mask, '08134913a9aa1d541f719e9f356f9378', min_px=None, max_px=None)","a550654f":"selective_mask(train, mask, '08134913a9aa1d541f719e9f356f9378', min_px=1, max_px=None)","cd11eb5f":"selective_mask(train, mask, '08134913a9aa1d541f719e9f356f9378', min_px=2, max_px=None)","a18de85b":"selective_mask(train, mask, '08134913a9aa1d541f719e9f356f9378', min_px=3, max_px=None)","2845a176":"selective_mask(train, mask, '08134913a9aa1d541f719e9f356f9378', min_px=4, max_px=None)","2a97148f":"msk = f'{mask}\/08134913a9aa1d541f719e9f356f9378_mask.tiff'\nima_msk = openslide.OpenSlide(str(msk)); msk_t = tensor(ima_msk.get_thumbnail(size=(255, 255)))\nmsk_pil = PILImage.create(msk_t[:,:,0])","8560b3f8":"fig, (ax1, ax2, ax3, ax4, ax5) = plt.subplots(1,5, figsize = (20, 6))\ns1 = msk_pil.show(min_px=None, max_px=None, ax=ax1, title='original mask')\ns2 = msk_pil.show(min_px=1, max_px=2, ax=ax2, title='1 and 2')\ns3 = msk_pil.show(min_px=2, max_px=3, ax=ax3, title='2 and 3')\ns4 = msk_pil.show(min_px=3, max_px=4, ax=ax4, title='3 and 4')\ns4 = msk_pil.show(min_px=4, max_px=5, ax=ax5, title='4 and 5')\nplt.show()","c69c31e5":"train_labels[train_labels.values == '08134913a9aa1d541f719e9f356f9378']","6d113ce0":"isup_0 = train_labels[train_labels.isup_grade == 0]\nisup_0[:1]","4ead978d":"selective_mask(train, mask, '0005f7aaab2800f6170c399693a96917', min_px=None, max_px=None)","458d9115":"isup_5 = train_labels[train_labels.isup_grade == 5]\nisup_5[:1]","ae293671":"selective_mask(train, mask, '00928370e2dfeb8a507667ef1d4efcbb', min_px=None, max_px=None)","18094ac5":"def custom_img(fn):\n    fn = f'{train}\/{fn.image_id}.tiff'\n    file = openslide.OpenSlide(str(fn))\n    t = tensor(file.get_thumbnail(size=(255, 255)))\n    img_pil = PILImage.create(t)\n    return img_pil","83638a16":"def show_selective(p, scale=True, cmap=plt.cm.ocean_r, min_px=None, max_px=None):\n    px = tensor(p)\n    if min_px is not None: px[px<min_px] = float(min_px)\n    if max_px is not None: px[px>max_px] = float(max_px)\n    return px","75f34053":"def custom_selective_msk(fn):\n    fn = f'{mask}\/{fn.image_id}_mask.tiff'\n    file = openslide.OpenSlide(str(fn))\n    t = tensor(file.get_thumbnail(size=(255, 255)))[:,:,0]\n    ts = show_selective(t, min_px=None, max_px=None)\n    return ts","25a60591":"blocks = (ImageBlock,\n          ImageBlock)\n\ngetters = [\n           custom_img,\n           custom_selective_msk\n          ]","60acb5bb":"prostate = DataBlock(blocks=blocks,\n                 getters=getters,\n                 item_tfms=Resize(128))\n\nj = prostate.dataloaders(train_labels, bs=16)\nj.show_batch(max_n=12, nrows=2, ncols=6)","acdcc65d":"def custom_selective_msk(fn):\n    fn = f'{mask}\/{fn.image_id}_mask.tiff'\n    file = openslide.OpenSlide(str(fn))\n    t = tensor(file.get_thumbnail(size=(255, 255)))[:,:,0]\n    ts = show_selective(t, min_px=1, max_px=None)\n    return ts","f3722357":"blocks = (ImageBlock,\n          ImageBlock)\n\ngetters = [\n           custom_img,\n           custom_selective_msk\n          ]","173600d9":"prostate = DataBlock(blocks=blocks,\n                 getters=getters,\n                 item_tfms=Resize(128))\n\nj = prostate.dataloaders(train_labels, bs=16)\nj.show_batch(max_n=12, nrows=2, ncols=6)","9009a9fd":"def custom_selective_msk(fn):\n    fn = f'{mask}\/{fn.image_id}_mask.tiff'\n    file = openslide.OpenSlide(str(fn))\n    t = tensor(file.get_thumbnail(size=(255, 255)))[:,:,0]\n    ts = show_selective(t, min_px=None, max_px=None)\n    return ts","e4ee898a":"blocks = (ImageBlock,\n          MaskBlock,\n          CategoryBlock)\n\ngetters = [\n           custom_img,\n           custom_selective_msk,\n           ColReader('isup_grade')\n          ]","2bfd4999":"prostate = DataBlock(blocks=blocks,\n                 getters=getters,\n                 item_tfms=Resize(224))\n\nj = prostate.dataloaders(train_labels, bs=16)\nj.show_batch(max_n=4)","bb4746cc":"### Using Selective mask","10364c87":"How about intensities above 1 (so getting rid of the bulk of pixels)","5f550cb9":"As we'll be using the `csv` file to load the images","a6221d17":"Lets see what the `dataBlock` would look like.  `fastai` provides a very convenient way of getting the dataset ready for training for example you can specify `blocks` and `getters` where `blocks` can be images, labels etc and `getters` are where are the images or labels located.","74c1a7f2":"# Next Steps","03420039":"The histogram does show some pixels above 4 but not many","ac83f3fd":"Lets check an example with `isup_grade` of 0","e71a3e36":"It looks like:\n- each mask has intensities based on its `isup_grade`","7b630f3b":"This library has a `show` function that has the capability of specifying max and min pixel values so you can specify the range of pixels you want to view within an image (useful when DICOM images can vary in pixel values between the range of -32768 to 32768).\n \nYou can easily adapt any function in `fastai2` using `@patch` and it just works!  In this case I am adapting the `show` function so you can specify `min` and `max` pixel values for this dataset.","ad8e00f4":"Intensities above 2","7ab6ee28":"View the corresponding mask","be0eefa4":"# Load the dependencies","e22ae522":"### isup_grade = 0","48f853f1":"Intensities above 3","29672990":"There is still alot of experimentation to be done.\n\n- for example the data is extremely unbalanced but images with say `isup_grade` of 5 also have masks for grades 2,3 and 4 \n- extract the portions within the masks to create a seperate dataset","97d10e5e":"# Selective Mask","71e73f8f":"The dataset is categorized by both `isup_grade` and `gleason_score`.  What is noticed is that the masks have different intensities.  For example we can specify a function that will display the image, the mask and plot a histogram of the intensites. ","58b56fef":"The batch above shows the images and masks side by side, in this case the full mask is being shown.  However what if we specify the mask intensites, as an example I want to get rid of the bulk of images which is predominantly the outline of the mask or any intensitiy below 1","0ab8f90f":"Looking at the selective masks side by side","1abbc0df":"Specify the `blocks`\n\nLets look at images and masks side by side just to see what the images and masks look like","8bd46da7":"### Using original mask","ad167398":"Plotting a histogram of the mask intensities shows that the bulk of the intensity is between `0` and `1` and this corresponds to the the bulk of the pixels which is the outline of the mask (light blue)\n\nHere are some more examples:","efb0afad":"Can see that the bulk of the pixels within the mask are the light blue areas of the mask which correspond to the the out outline of the mask itself.  ","e15b9984":"The plot shows the original image, the mask, the selective mask(in this case all intensities are shown hence the reason it looks the same as the mask image) and the histogram of intensities (again the bulk of pixels are within `0` and `1`","d6206e87":"Specify the min_px value as 1 in the `custom_selective_msk` function:","81088838":"This version update:\n- uses `openslide` to view the `.tiff` files instead of the previous version that involved coverting the files from `.tiff` to `.png`\n- each image is categorized by an `isup_grade` and we can selectively choose what grade to view by specifying `min_px` and `max_px` values\n- load the selective mask into a `DataLoader`\n\n### Original Mask\n\n![selective_msk.PNG](attachment:selective_msk.PNG)\n\n### Selective Mask\n`min_px` value of 3\n\n![selective_msk2.PNG](attachment:selective_msk2.PNG)","15bf8779":"What about images with `isup_grade` of 5","a3f83e63":"Now lets look at the images and masks over-layed on each other.  For this we simply change the `ImageBlock` we used above for the mask images into a `MaskBlock` and lets add a `CategoryBlock` so that we can identify the `isup_grade`","037a8dc6":"lets check to see what the `isup_grade` of the example above is:","01e74080":"# Viewing an image","05136f94":"For this we would have to create 2 custom functions, one so that that the `dataloader` can correctly view the images (as they are in `.tiff` format and `fastai` does not have an out of the box method of parsing these files and the second so that we only view the masks in the red channel","9491e8ab":"View an image","58b5f4e2":"### isup_grade = 5","db6eb035":"You can view the images and masks by specifying their filename.  The only difference in the naming between the images and masks is that the mask filenames have `_mask` before the file type.\n\nThe masks are saved in RGB format and the mask is stored in the red channel and the rest of the channels are set to 0. To view the mask we have to explicity display only that channel.\n\nWe can create a function to view the images and masks using `openslide` that takes into consideration where the image is stored, if the non-mask image display the image as is or if it is the mask image display the red channel only.","b7ae1735":"# Selective Mask","1c67688e":"We will also have to define another function that will allow us to view the selective masks","f12db258":"For the masks","850adad5":"Specify the folders","6513159e":"We can see that the mask images are selective.  The mask images that are fully purple correspond to images that have an `isup_grade` of 0","25302d59":"# DataBlock","7bd71ff8":"To be able to view the mask images at different intensities I adapted a function from `fastai`'s medical imaging library (which is typically geared towards working with DICOM images). To learn more about `fastai`'s medical imaging module please read my blog [here](https:\/\/asvcode.github.io\/MedicalImaging\/) or view this [notebook](https:\/\/www.kaggle.com\/avirdee\/fastai2-dicom-starter)\n\nLoad the medical imaging library","bdf630ec":"It has an `isup_grade` of 4","a2356f92":"We have to make a custom function `show_selective` so that we can pass the different intensities to the `dataloader`"}}