{"cell_type":{"1cbc925f":"code","08c1c2f7":"code","a5218d48":"code","c41de0a8":"code","3ad0d5f9":"code","fe83e523":"code","c86ffe77":"code","72f05e1f":"code","521e3459":"code","39db8bf8":"code","b20f6673":"code","5207a978":"code","f619fa97":"code","68e4e121":"code","f5629100":"code","bc08e8cc":"code","3b3b44e5":"code","9d81de51":"code","15478be7":"code","d1cd8475":"code","b27aa00e":"code","852facfc":"code","44f77b41":"code","61f3211f":"code","8295e395":"code","6b41d106":"code","888e41e0":"code","2946f946":"code","955736f7":"code","08fe95f0":"code","47a190c6":"code","e5755319":"code","833f3b4c":"code","f7e25e93":"code","62fdbe33":"code","a3a52d81":"code","626f9bcf":"code","ee137ebf":"code","a509a0d9":"code","0af036df":"code","dcda31ce":"code","2a9f55a3":"code","1a2ff363":"code","50f48241":"code","1441a5c3":"code","4ec75ef6":"code","7099bab2":"code","2287155d":"code","29a9815c":"code","4e435284":"code","32abc979":"code","b9cc2f8e":"code","626098a5":"code","8368e973":"code","21d99aa1":"code","5a91d0f2":"code","0ba4a86a":"code","52d7e534":"code","4b39f8bd":"code","7b1a024d":"code","e093eeae":"code","9145e5f7":"code","197ed5ca":"code","57becb04":"code","1675a613":"code","18f0ce61":"code","d4e01fe0":"code","a0bc4a03":"code","ff0ae4b9":"code","9b4c8009":"code","4b0e0a03":"code","845f4969":"code","bca95ab6":"code","44554098":"code","6bf02861":"code","5a902e8d":"markdown","bd5ac547":"markdown","02b9edb0":"markdown","5fddf4b0":"markdown","3785fea5":"markdown","f1f46479":"markdown","85977b11":"markdown","3c40372f":"markdown","221e1f5a":"markdown","cc1977bb":"markdown","7445dd3b":"markdown","3b42bdf7":"markdown"},"source":{"1cbc925f":"import pandas as pd\nimport matplotlib.pyplot as plt\nimport numpy as np\nimport seaborn as sns\nfrom sklearn.naive_bayes import GaussianNB\nfrom sklearn import metrics\nfrom sklearn.model_selection import KFold\nfrom sklearn.decomposition import PCA\nfrom sklearn.ensemble import RandomForestClassifier\nfrom sklearn.metrics import make_scorer\nfrom sklearn.model_selection import cross_validate\nfrom timeit import default_timer as timer\nfrom sklearn.model_selection import GridSearchCV","08c1c2f7":"dataset = pd.read_csv('..\/input\/hotel-booking-demand\/hotel_bookings.csv')\n\ndataset.head()","a5218d48":"dataset.info()","c41de0a8":"dataset.isnull().sum()","3ad0d5f9":"#children: NA -> 0\n#country: NA -> 'N.A.'\n#agent: NA -> 0\n#company: NA -> 0\n\ndataset.fillna({'children' : 0, 'country' : 'N. A.', 'agent' : 0, 'company' : 0}, inplace = True)","fe83e523":"dataset.isnull().sum()","c86ffe77":"dataset[['children', 'country', 'agent', 'company']]","72f05e1f":"dataset.children.value_counts()","521e3459":"dataset.country.value_counts()","39db8bf8":"dataset.agent.value_counts()","b20f6673":"dataset.company.value_counts()","5207a978":"dataset.describe(include = 'all')","f619fa97":"#number of reservations for each hotel\n\ndef auto_label(ax, container):\n    for c in container:\n        height = c.get_height()\n        \n        ax.annotate('{}'.format(height),\n                    xy = (c.get_x() + c.get_width() \/ 2, height),\n                    xytext = (0, 3),  #3 points vertical offset\n                    textcoords = 'offset points',\n                    ha = 'center', va = 'bottom')\n\ndef show_number_reservations():\n    dict = []\n    \n    for hotel in dataset.hotel.unique():\n        dict.append({'hotel' : hotel, \n                     'reservations' : len(dataset.loc[dataset.hotel == hotel, 'hotel']), \n                     'cancelations' : len(dataset.loc[(dataset.hotel == hotel) & (dataset.is_canceled == 1), 'hotel'])})\n    \n    data = pd.DataFrame(dict)\n    \n    fig, ax = plt.subplots()\n    \n    reserv_bar = ax.bar(data.hotel, data.reservations, label = 'Reservations')\n    cancel_bar = ax.bar(data.hotel, data.cancelations, label = 'Cancelations')\n            \n    plt.title('Number of reservations by Hotel')\n    plt.xlabel('Hotel')\n    plt.ylabel('Number of reservations')\n    plt.legend()\n\n    auto_label(ax, reserv_bar)\n    auto_label(ax, cancel_bar)\n    \n    return data\n\nshow_number_reservations()","68e4e121":"attrs = ['lead_time', 'stays_in_weekend_nights', 'stays_in_week_nights', 'adults', 'children', 'babies', \n         'is_repeated_guest', 'previous_cancellations', 'previous_bookings_not_canceled', 'booking_changes', \n         'days_in_waiting_list', 'adr', 'required_car_parking_spaces', 'total_of_special_requests']\n\ndef show_attributes(canceled, attributes):\n    dict = []\n    \n    for attr in attributes:        \n        data = dataset.loc[dataset.is_canceled == (1 if canceled else 0), ['hotel', attr]]\\\n                      .groupby('hotel').agg(['mean']).reset_index()\n        \n        for i in range(len(dataset.hotel.unique())):\n            dict.append({'hotel' : data.iat[i, 0], 'attribute' : attr, 'value' : data.iat[i, 1]})\n    \n    result = pd.DataFrame(dict)\n    \n    for attr in attributes:\n        ax = result.loc[result.attribute == attr].plot('hotel', 'value', kind = 'bar', label = attr)\n        ax.set_title(attr + (' | canceled reservations' if canceled else ''))\n        ax.set_xlabel('Hotel')\n        ax.set_xticklabels(ax.get_xticklabels(), rotation = 0, horizontalalignment = 'center')\n        plt.show()\n    \n    return result\n\nshow_attributes(True, attrs)","f5629100":"attrs = ['lead_time', 'stays_in_weekend_nights', 'stays_in_week_nights', 'adults', 'children', 'babies', \n         'is_repeated_guest', 'previous_cancellations', 'previous_bookings_not_canceled', 'booking_changes', \n         'days_in_waiting_list', 'adr', 'required_car_parking_spaces', 'total_of_special_requests', \n         'meal', 'country', 'market_segment', 'distribution_channel', 'reserved_room_type', 'assigned_room_type',\n         'deposit_type', 'agent', 'company', 'customer_type']\n\ndef list_attributes(canceled, attributes):\n    dict = []\n\n    for attr in attributes:        \n        data = dataset.loc[dataset.is_canceled == (1 if canceled else 0), ['hotel', attr]]\n\n        operation = 'count' if data.dtypes[attr] == np.object else 'mean'\n            \n        data = data.groupby('hotel').agg([operation]).reset_index()\n\n        for i in range(len(dataset.hotel.unique())):\n            dict.append({'hotel' : data.iat[i, 0], 'attribute' : attr, 'type': operation, 'value' : data.iat[i, 1]})\n\n    return pd.DataFrame(dict)\n\nlist_attributes(True, attrs)","bc08e8cc":"attrs = ['lead_time', 'stays_in_weekend_nights', 'stays_in_week_nights', 'adults', 'children', 'babies', \n         'is_repeated_guest', 'previous_cancellations', 'previous_bookings_not_canceled', 'booking_changes', \n         'days_in_waiting_list', 'adr', 'required_car_parking_spaces', 'total_of_special_requests', \n         'meal', 'country', 'market_segment', 'distribution_channel', 'reserved_room_type', 'assigned_room_type',\n         'deposit_type', 'agent', 'company', 'customer_type']\n\ndef freq_attributes(canceled, attributes):\n    hotels = dataset.hotel.unique()\n        \n    for attr in attributes:\n        for h in hotels:            \n            counts = dataset.loc[(dataset.hotel == h) & (dataset.is_canceled == (1 if canceled else 0)), attr].value_counts()\n            \n            plt.figure(figsize = (10, 4))\n            ax = counts.head(30).plot(kind = 'bar', label = attr)\n            ax.set_title(h + ' | ' + attr + (' | canceled reservations' if canceled else ''))\n            ax.set_xticklabels(ax.get_xticklabels(), rotation = 45, horizontalalignment = 'right')\n            plt.tight_layout()\n            plt.show()\n        \nfreq_attributes(True, attrs)","3b3b44e5":"#from which countries did the guests come?\ndef show_countries():\n    countries = dataset[dataset.is_canceled == 0].groupby('country').country.count().sort_values(ascending = False)\n    \n    plt.figure(figsize = (15, 5))\n    ax = countries.head(20).plot(kind = 'bar')\n    ax.set_title('Number of reservations per Country')\n    ax.set_xlabel('Country')\n    ax.set_ylabel('Number of reservations')\n#     ax.set_xticklabels(ax.get_xticklabels(), rotation = 45, horizontalalignment = 'right')\n    plt.xticks(rotation = 45)\n    plt.show()\n    \n    return countries\n\nshow_countries()","9d81de51":"#from wich country were the guests who canceled their reservations the most?\ndef show_countries_canceled():\n    countries = dataset[dataset.is_canceled == 1].groupby('country').country.count().sort_values(ascending = False)\n    \n    plt.figure(figsize = (15, 5))\n    ax = countries.head(20).plot(kind = 'bar')\n    ax.set_title('Number of canceled reservations per Country')\n    ax.set_xlabel('Country')\n    ax.set_ylabel('Number of canceled reservations')\n    ax.set_xticklabels(ax.get_xticklabels(), rotation = 45, horizontalalignment = 'right')\n    plt.show()\n    \n    return countries\n\nshow_countries_canceled()","15478be7":"#what are the months with the most guests in each hotel?\ndef guests_month():\n    info = ['arrival_date_month', 'hotel', 'is_canceled', 'adults', 'children', 'babies']\n    guests = dataset.loc[dataset.is_canceled == 0, info]\n    guests['total_guests'] = guests.adults + guests.children + guests.babies\n    guests.total_guests = guests.total_guests.astype(int)\n    \n    guests = guests.groupby(['arrival_date_month', 'hotel']) \\\n                   .aggregate({'total_guests' : sum}) \\\n                   .reset_index()\n    \n    guests.columns = ['month', 'hotel', 'guests']\n        \n    months = ['January', 'February', 'March', 'April', 'May', 'June',\n              'July', 'August', 'September', 'October', 'November', 'December']\n        \n    guests.month = pd.Categorical(guests.month, categories = months, ordered = True)\n    \n    guests.sort_values('month', inplace = True)\n    \n    hotels = guests.hotel.unique()\n    fig, ax = plt.subplots(figsize = (12, 6))\n    bars = []\n        \n    for i in range(len(hotels)):\n        bars.append(ax.bar(guests.loc[guests.hotel == hotels[i], 'month'], \\\n                           guests.loc[guests.hotel == hotels[i], 'guests'], \\\n                           label = hotels[i]))\n        auto_label(ax, bars[i])\n        \n    anos = dataset.arrival_date_year.unique()\n    plt.title(f'Total number of guests per month by Hotel from {min(anos)} to {max(anos)}')\n    plt.xlabel('Month')\n    plt.ylabel('Number of guests')\n    plt.legend()\n    plt.show()\n    \n    return guests\n\nguests_month()","d1cd8475":"#what are the average prices for each person per night by hotel?\ndef average_daily_rate_person():\n    for h in dataset.hotel.unique():\n        print(f'Average daily rate per person: {dataset[dataset.hotel == h].adr.mean():.2f} in {h}.')\n    return\n\naverage_daily_rate_person()","b27aa00e":"#what is the average stay in days?\ndef average_stay_days():\n    stay = dataset.loc[dataset.is_canceled == 0, ['hotel', 'stays_in_week_nights', 'stays_in_weekend_nights']] \n    stay['nights'] = stay.stays_in_week_nights + stay.stays_in_weekend_nights    \n    stay = stay.groupby('hotel').agg({'nights' : 'mean'})\n    \n    return stay\n\naverage_stay_days()","852facfc":"dataset.corr()","44f77b41":"corr = dataset.corr()\n\nplt.figure(figsize = (10, 5))\n\nax = sns.heatmap(corr, vmin = -1, vmax = 1, center = 0, \n                 cmap = sns.diverging_palette(20, 220, n = 200))\n\nax.set_xticklabels(ax.get_xticklabels(), rotation = 45, horizontalalignment = 'right')","61f3211f":"dataset.corr()['is_canceled'].abs().sort_values(ascending = False)","8295e395":"dataset.lead_time.value_counts()","6b41d106":"dataset.groupby(['is_canceled', 'lead_time']).count()['hotel']","888e41e0":"dataset.total_of_special_requests.value_counts()","2946f946":"dataset.groupby(['is_canceled', 'total_of_special_requests']).agg({'hotel' : 'count'})","955736f7":"dataset.required_car_parking_spaces.value_counts()","08fe95f0":"dataset.groupby(['is_canceled', 'required_car_parking_spaces']).agg({'hotel' : 'count'})","47a190c6":"dataset.booking_changes.value_counts()","e5755319":"dataset.groupby(['is_canceled', 'booking_changes']).agg({'hotel' : 'count'})","833f3b4c":"dataset.previous_cancellations.value_counts()","f7e25e93":"dataset.groupby(['is_canceled', 'previous_cancellations']).agg({'hotel' : 'count'})","62fdbe33":"variables = ['lead_time', 'total_of_special_requests', 'required_car_parking_spaces', \n             'booking_changes', 'previous_cancellations', 'is_canceled']\n\ndataset[variables]","a3a52d81":"model = GaussianNB()\n\n#using KFold validation to try to increase the accuracy\ndef kfold_validation(dataset, variables, k, shuffle = False):\n    i = 1\n\n    kfold = KFold(n_splits = k, shuffle = shuffle)\n\n    for i_train, i_test in kfold.split(dataset):\n        data = dataset.loc[i_train, variables[:-1]]\n        target = dataset.loc[i_train, variables[-1]]\n\n        model.fit(data, target)\n\n        data = dataset.loc[i_test, variables[:-1]]\n        target = dataset.loc[i_test, variables[-1]]\n\n        predicted = model.predict(data)\n\n        print(53 * '-' + f'\\nFold {i} | train: {len(i_train)} | test: {len(i_test)}')\n        print(metrics.classification_report(target, predicted))\n        print(metrics.confusion_matrix(target, predicted))\n\n        i += 1\n        \n    return kfold\n\nkfold_validation(dataset, variables, 5)","626f9bcf":"data = dataset[variables[:-1]]\ntarget = dataset[variables[-1]]\n\npredicted = model.predict(data)\n\nprint(metrics.classification_report(target, predicted))\nprint(metrics.confusion_matrix(target, predicted))","ee137ebf":"variables = ['lead_time', 'total_of_special_requests',\n             'booking_changes', 'previous_cancellations', 'is_canceled']\n\ndataset[variables]","a509a0d9":"model = GaussianNB()\n\nkfold_validation(dataset, variables, 5)","0af036df":"data = dataset[variables[:-1]]\ntarget = dataset[variables[-1]]\n\npredicted = model.predict(data)\n\nprint(metrics.classification_report(target, predicted))\nprint(metrics.confusion_matrix(target, predicted))","dcda31ce":"variables = list(dataset.select_dtypes(include = np.number).columns.values)\nvariables","2a9f55a3":"temp = variables[0]\nvariables[0] = variables[-1]\nvariables[-1] = temp\n\nvariables","1a2ff363":"dataset[variables]","50f48241":"model = GaussianNB()\n\nkfold_validation(dataset, variables, 5)","1441a5c3":"data = dataset[variables[:-1]]\ntarget = dataset[variables[-1]]\n\npredicted = model.predict(data)\n\nprint(metrics.classification_report(target, predicted))\nprint(metrics.confusion_matrix(target, predicted))","4ec75ef6":"variables = ['lead_time', 'total_of_special_requests', 'required_car_parking_spaces', \n             'booking_changes', 'previous_cancellations', 'is_canceled']\n\ndataset[variables[:-1]]","7099bab2":"pca = PCA()\n\npca","2287155d":"transformed = pca.fit_transform(dataset[variables[:-1]])\ntransformed","29a9815c":"len(pca.components_)","4e435284":"sum(pca.explained_variance_ratio_[0:1])","32abc979":"dataset_pca = pd.DataFrame(transformed)\ndataset_pca.drop([1, 2, 3, 4], axis = 1, inplace = True)\ndataset_pca","b9cc2f8e":"dataset_pca['is_canceled'] = dataset['is_canceled']\ndataset_pca.is_canceled","626098a5":"dataset_pca.columns = ['pc1', 'is_canceled']\n\ndataset_pca","8368e973":"len(dataset) == len(dataset_pca)","21d99aa1":"print(f'dataset -> {dataset[variables].shape}\\ndataset_pca -> {dataset_pca.shape}')","5a91d0f2":"variables = list(dataset_pca.columns)\nvariables","0ba4a86a":"model = GaussianNB()\n\nkfold_validation(dataset_pca, variables, 5, False)","52d7e534":"data = dataset_pca[variables[:-1]]\ntarget = dataset_pca[variables[-1]]\n\npredicted = model.predict(data)\n\nprint(metrics.classification_report(target, predicted))\nprint(metrics.confusion_matrix(target, predicted))","4b39f8bd":"variables = list(dataset.select_dtypes(include = np.number).columns.values)\ntemp = variables[0]\nvariables[0] = variables[-1]\nvariables[-1] = temp\n\nvariables","7b1a024d":"dataset[variables]","e093eeae":"pca = PCA()\ntransformed = pca.fit_transform(dataset[variables])\ntransformed","9145e5f7":"len(pca.components_)","197ed5ca":"sum(pca.explained_variance_ratio_[0:5])","57becb04":"dataset_pca = pd.DataFrame(transformed)\ndataset_pca.drop(range(5, 20), axis = 1, inplace = True)\ndataset_pca","1675a613":"dataset_pca['is_canceled'] = dataset.is_canceled\ndataset_pca.columns = ['pc1', 'pc2', 'pc3', 'pc4', 'pc5', 'is_canceled']\ndataset_pca","18f0ce61":"print(f'dataset -> {dataset[variables].shape}\\ndataset_pca -> {dataset_pca.shape}')","d4e01fe0":"variables = list(dataset_pca.columns)\nvariables","a0bc4a03":"model = GaussianNB()\n\nkfold_validation(dataset_pca, variables, 5)","ff0ae4b9":"data = dataset_pca[variables[:-1]]\ntarget = dataset_pca[variables[-1]]\n\npredicted = model.predict(data)\n\nprint(metrics.classification_report(target, predicted))\nprint(metrics.confusion_matrix(target, predicted))","9b4c8009":"variables = ['lead_time', 'total_of_special_requests', 'required_car_parking_spaces', \n             'booking_changes', 'previous_cancellations', 'is_canceled']\n\ndataset[variables[:-1]]","4b0e0a03":"model = RandomForestClassifier(n_estimators = 1000, max_depth = 20, n_jobs = -1, \n                               random_state = 0, bootstrap = True)\n\nkfold_validation(dataset, variables, 5, True)","845f4969":"data = dataset[variables[:-1]]\ntarget = dataset[variables[-1]]\n\npredicted = model.predict(data)\n\nprint(metrics.classification_report(target, predicted))\nprint(metrics.confusion_matrix(target, predicted))","bca95ab6":"variables = list(dataset.select_dtypes(include = np.number).columns.values)\ntemp = variables[0]\nvariables[0] = variables[-1]\nvariables[-1] = temp\n\nvariables","44554098":"model = RandomForestClassifier(n_estimators = 1000, max_depth = 20, n_jobs = -1, \n                               random_state = 0, bootstrap = True)\n\nkfold_validation(dataset, variables, 5, True)","6bf02861":"data = dataset[variables[:-1]]\ntarget = dataset[variables[-1]]\n\npredicted = model.predict(data)\n\nprint(metrics.classification_report(target, predicted))\nprint(metrics.confusion_matrix(target, predicted))","5a902e8d":"The variable 'required_car_parking_spaces' may not be decisive in determining if a reservation is canceled or not.","bd5ac547":"# Hotel Booking Demand\n\n# EDA (Exploratory Data Analysis)","02b9edb0":"Precision and recall for valid cancelations were better than in Model 1. Unfortunately, precision and recall for canceled reservations were worse. The variable required_car_parking_spaces had a greater impact than anticipated.\n\n## Model 3: Naive Bayes + all numeric variables","5fddf4b0":"Using highly correlated variables with PCA did not produce better results than before.\n\n## Model 5: Naive Bayes + PCA (with all numeric variables)","3785fea5":"The Naive Bayes classifier had a bad performance. The accuracy was low in almost all folds. Although recall for canceled reservations was high, the precision was low. The classifier can detect most of the real cancelations, but wrongly classifies a great number of valid reservations as canceled.\n\n## Model 2: Naive Bayes + new set of variables\n\nSince using the 5 most correlated variables didn't produce good results, we'll try to use a better set of variables. Of the 5 used variables, required_car_parking_spaces is the only one which has just one value for all canceled reservations. The other variables have more values for both canceled and valid reservations. Let's try to use just the other 4 variables.\n\nUsing the following variables, the classifier is expected to determine wether a reservation will probably be canceled or not:\n* lead_time\n* total_of_special_requests\n* booking_changes\n* previous_cancellations","f1f46479":"The first 5 variables (lead_time, total_of_special_requests, required_car_parking_spaces, booking_changes, previous_cancellations) will be used for building a model, since they are the ones with correlation > 0.10 for is_canceled.","85977b11":"# Predicting cancelations\n## Determining the most relevant variables","3c40372f":"The Random Forest classifier produced better results than any Naive Bayes run. Maybe it will produce better results if all numeric variables are used.\n\n## Model 7: Random Forest + all numeric variables","221e1f5a":"Random Forest with all numeric variables, using shuffle during CV, produces the best result so far. High precision and recall for both classes and a high overall accuracy.","cc1977bb":"Using all numeric variables did not produce better results than before.\n\n## Model 4: Naive Bayes + PCA (using the 5 variables with higher correlation to is_canceled)","7445dd3b":"Using all numeric variables with PCA did not produce better results than before.\n\n## Model 6: Random Forest + 5 highly correlated variables","3b42bdf7":"## Model 1: Naive Bayes\n\nSince the most relevant variables are already numeric, no conversions are needed.\n\nUsing the following variables, the classifier is expected to determine wether a reservation will probably be canceled or not:\n* lead_time\n* total_of_special_requests\n* required_car_parking_spaces\n* booking_changes\n* previous_cancellations"}}