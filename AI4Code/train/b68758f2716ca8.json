{"cell_type":{"1c8bd298":"code","625caec3":"code","907b3ddf":"code","a9af2fdc":"code","0514aa5f":"code","25e5b47f":"code","3ffaf6ce":"code","a14f66b2":"code","0bbe7d40":"code","862d6b41":"code","a54ae861":"code","04d04c20":"code","274e52de":"code","8e13eb6d":"code","31048170":"code","1345cc14":"code","c5f18d42":"code","3d72dab6":"code","7faf9bdf":"code","cb0eae9c":"markdown","5bc0bc24":"markdown","b3822404":"markdown","e1eb096e":"markdown","9acb1e81":"markdown","2ffe5170":"markdown","44823d7c":"markdown"},"source":{"1c8bd298":"import os\nimport cv2\nimport numpy as np\nimport pandas as pd\nimport pydicom\n\nfrom skimage.measure import label,regionprops\nfrom skimage.segmentation import clear_border\nimport matplotlib.pyplot as plt","625caec3":"# https:\/\/www.kaggle.com\/currypurin\/osic-image-shape-eda-and-preprocess\ndef crop_image(img: np.ndarray):\n    edge_pixel_value = img[0, 0]\n    mask = img != edge_pixel_value\n    return img[np.ix_(mask.any(1),mask.any(0))]","907b3ddf":"#d = pydicom.dcmread('..\/input\/osic-pulmonary-fibrosis-progression\/train\/ID00030637202181211009029\/100.dcm')\nd = pydicom.dcmread('..\/input\/osic-pulmonary-fibrosis-progression\/test\/ID00419637202311204720264\/21.dcm')","a9af2fdc":"img = crop_image(d.pixel_array)","0514aa5f":"fig = plt.figure(figsize=(12, 12))\n\nplt.imshow(img)","25e5b47f":"right_mask = cv2.imread('..\/input\/osic-generalized-lung-mask\/mask\/right_mask_simetric.jpg', 0)\nleft_mask = cv2.imread('..\/input\/osic-generalized-lung-mask\/mask\/left_mask_simetric.jpg', 0)","3ffaf6ce":"img = (crop_image(d.pixel_array) + d.RescaleIntercept) \/ d.RescaleSlope\ndim = min(img.shape)\ncancer_mask = (img > 10) & (img < 400)\nlung_mask = (img > -850) & (img < -600)\nlung_mask = cv2.bilateralFilter(lung_mask.astype('float32'),int(dim*0.05),int(dim*0.2),int(dim*0.2)) > 0.1","a14f66b2":"cancer_mask[~lung_mask] = 0","0bbe7d40":"fig = plt.figure(figsize=(12, 12))\n\nplt.imshow(cancer_mask)\nplt.imshow(lung_mask, alpha=0.3)","862d6b41":"fig = plt.figure(figsize=(12, 12))\n\nplt.imshow(right_mask, alpha=0.75)\nplt.imshow(left_mask, alpha=0.75);","a54ae861":"right_mask = cv2.resize(right_mask, lung_mask.shape[::-1]).astype('uint8')\nleft_mask = cv2.resize(left_mask, lung_mask.shape[::-1]).astype('uint8')","04d04c20":"fig = plt.figure(figsize=(12, 12))\n\nplt.imshow(cancer_mask)\nplt.imshow(lung_mask, alpha=0.4)\nplt.imshow(cv2.resize(right_mask, lung_mask.shape[::-1]), alpha=0.25)\nplt.imshow(cv2.resize(left_mask, lung_mask.shape[::-1]), alpha=0.25)","274e52de":"cancer_mask = clear_border(cancer_mask)\nlung_mask = clear_border(lung_mask)","8e13eb6d":"fig = plt.figure(figsize=(12, 12))\n\nplt.imshow(cancer_mask)\nplt.imshow(lung_mask, alpha=0.4)","31048170":"from sklearn.metrics import jaccard_score","1345cc14":"lung_mask_labeled = label(lung_mask)\n\nfig = plt.figure(figsize=(12, 12))\n\nplt.imshow(lung_mask_labeled)","c5f18d42":"for i, r in enumerate(regionprops(lung_mask_labeled)):\n    _lung_mask = lung_mask.copy()\n    m = np.zeros_like(_lung_mask)\n    m[r.slice] = 1\n    _lung_mask = _lung_mask * m > 0\n    riou = jaccard_score(_lung_mask, right_mask > 0, average='micro')\n    liou = jaccard_score(_lung_mask, left_mask > 0, average='micro')\n    print(f\"Region {i}\")\n    print(\"\\tRight: \", riou, \"\\n\\tLeft: \", liou)\n    if liou < 0.1 and riou < 0.1:\n        for coordinates in r.coords:                \n            lung_mask_labeled[coordinates[0], coordinates[1]] = 0","3d72dab6":"fig = plt.figure(figsize=(12, 12))\n\nplt.imshow(cancer_mask)\nplt.imshow(lung_mask_labeled, alpha=0.5);","7faf9bdf":"fig = plt.figure(figsize=(12, 12))\n\nplt.imshow((crop_image(d.pixel_array) + d.RescaleIntercept) \/ d.RescaleSlope)\nplt.imshow(lung_mask_labeled, alpha=0.5);","cb0eae9c":"## Rescale and create binary mask\nThe bright region inside the lungs are the blood vessels or air. A threshold of -600--850 HU is used at all places because it was found in experiments. ","5bc0bc24":"## Reference\n* [OSIC \/ image shape EDA and preprocess](https:\/\/www.kaggle.com\/currypurin\/osic-image-shape-eda-and-preprocess)\n* [Unsupervise Lung Detection](https:\/\/www.kaggle.com\/miklgr500\/unsupervise-lung-detection)","b3822404":"## Raw image","e1eb096e":"## Remove small and select nearest to generic lung mask region","9acb1e81":"## Cleaning border","2ffe5170":"Based on the previous mask I created a generic lung mask for right and left lung.","44823d7c":"## Conclusion \nThe determining of a mask for the lungs is the starting point in the algorithm for determining the volume of the lungs by CT images. The next step is the correct integration of all CT images to determine the volume of the lungs and volume posible cancer regions. \n\nI trying current approach for many patients and taking a good lungs of mask in a result."}}