{"cell_type":{"e3ab2ae5":"code","83ef953c":"code","5e10f10c":"code","7c27fffe":"code","d77044a3":"code","3e85c2d0":"code","8dba09f8":"code","98ef1356":"code","e9a6cc9a":"code","82da1cf4":"code","1d304c53":"code","c7d99497":"code","638ac62f":"code","ee203582":"markdown","50107069":"markdown","9577b27f":"markdown","ae2d6a32":"markdown","99d1079a":"markdown","76ee6bbf":"markdown","fbc3608d":"markdown","4963dc4c":"markdown","fe01db35":"markdown","1f37677c":"markdown","d4d2045a":"markdown","45d7d270":"markdown"},"source":{"e3ab2ae5":"import os\nimport cv2\nimport openslide\nimport skimage.io\nimport matplotlib\nimport numpy as np \nimport pandas as pd \nimport deepdish as dd\nimport seaborn as sns\nimport matplotlib.pyplot as plt\n\n## print out the names of the first 3 image_files (total = 10 images for train_imgaes & train_label_masks) with the train, test, submission.csv files\nfor dirname, _, filenames in os.walk('\/kaggle\/input'):\n    for filename in filenames[:3]:\n        print(os.path.join(dirname, filename))","83ef953c":"BASE_PATH = '..\/input\/prostate-cancer-grade-assessment'\n\ndata_dir = f'{BASE_PATH}\/train_images'\nmask_dir = f'{BASE_PATH}\/train_label_masks'\nh5_dir = '\/kaggle\/input\/h5-files\/full_data_coordinate.h5'\n\ntrain = pd.read_csv(f'{BASE_PATH}\/train.csv').set_index('image_id')\ntest = pd.read_csv(f'{BASE_PATH}\/test.csv')\nsubmission = pd.read_csv(f'{BASE_PATH}\/sample_submission.csv')","5e10f10c":"train.head(5)","7c27fffe":"def plot_relative_distribution(df, feature, hue, title='', size=2):\n    f, ax = plt.subplots(1,1, figsize=(10*size, 4*size))\n    total = float(len(df))\n    sns.countplot(x=feature, hue=hue, data=df, palette='Set2')\n    plt.title(title)\n    for p in ax.patches:\n        height = p.get_height()\n        ax.text(p.get_x() + p.get_width()\/2,  ## set the text in the middle of each column \n                height*0.7,                   ## set the text above 0.8*height of the column's height\n                '{:d} img_id \\n\\n approx {:1.2f}%'.format(height, (height*100\/total)), ## content\n                ha=\"center\") \n    plt.show()\n    \nplot_relative_distribution(df=train, feature='isup_grade', hue='data_provider', title = 'relative count plot of isup_grade with data_provider', size=2)","d77044a3":"def plot_count(df, feature, title='', size=2):\n    f, ax = plt.subplots(1,1, figsize=(5.5*size, 3.25*size))\n    total = float(len(df))\n    sns.countplot(df[feature],order = df[feature].value_counts().index, palette='Set2')\n    plt.title(title)\n    for p in ax.patches:\n        height = p.get_height()\n        ax.text(p.get_x() + p.get_width()\/2,  ## set the text in the middle of each column \n                height*0.8,                   ## set the text above 0.8*height of the column's height\n                '{:d} img_id \\n\\n approx {:1.2f}%'.format(height, (height*100\/total)), ## content\n                ha=\"center\") \n    plt.show()\n    \nplot_count(df=train, feature='data_provider', title = 'data_provider count_plot')","3e85c2d0":"%time df = dd.io.load(h5_dir)\nlen(df), df[0]","8dba09f8":"def display_tiles_in_data(img_ID, level = 0):\n    idx = df[img_ID][0]\n    im = skimage.io.MultiImage(os.path.join(data_dir, f'{idx}.tiff'))[level]\n    plt.figure(figsize = (25, 25))\n    for k in range(36):\n        plt.subplot(6, 6, k + 1)\n        a, b, c, d = df[img_ID + k][1 :]\n        plt.imshow(im[a : b, c: d, :])\n        plt.title(k)\n        \ndisplay_tiles_in_data(720)","98ef1356":"def display_tiles_in_mask(img_ID, level = 0):\n    idx = df[img_ID][0]\n    im = skimage.io.MultiImage(os.path.join(mask_dir, f'{idx}_mask.tiff'))[0]\n    cmap = matplotlib.colors.ListedColormap(['black', 'gray', 'green', 'yellow', 'orange', 'red'])\n    plt.figure(figsize = (25, 25))\n    for k in range(36):\n        plt.subplot(6, 6, k + 1)\n        a, b, c, d = df[img_ID + k][1 :]\n        plt.imshow(im[a : b, c: d, 0], cmap=cmap, interpolation='nearest', vmin=0, vmax=5)\n        plt.title(k)\n        \ndisplay_tiles_in_mask(720)","e9a6cc9a":"def display_tiles_df_h5_file(img_ID, tile_indexes, level = 0):\n    \"\"\"\n    Load & display the indexes of {image_id and tiles_coordinates} in h5.file\n    Input args:\n        img_ID (int : a multiple of 36, less than len of h5.tile): img_id from the data_dir \n        tile_indexes (list of int from [0, 36]): list of the indexes of 36 tiles per image from data_dir\n    output:\n        display mask_img & data_img coresponding to img_id and its indexes\n    \"\"\"\n    img_id = df[img_ID][0]\n    img_data = skimage.io.MultiImage(os.path.join(data_dir, f'{img_id}.tiff'))[level]\n    img_mask = skimage.io.MultiImage(os.path.join(mask_dir, f'{img_id}_mask.tiff'))[level]\n    cmap = matplotlib.colors.ListedColormap(['black', 'gray', 'green', 'yellow', 'orange', 'red'])\n    nrow = len(tile_indexes)\n    resize = 2**(2*level)\n    plt.figure(figsize = (10, 5.5*nrow))\n    for k in range(nrow):\n        coordinates = df[img_ID + tile_indexes[k]][1 : ]\n        x_start, x_end, y_start, y_end = [int(coordinates[j] \/ resize) for j in range(4)]\n        plt.subplot(nrow, 2, 2*(k+1) -1 )\n        plt.imshow(img_data[x_start: x_end, y_start: y_end, :])\n        plt.title('ID = %s \\n level = %s & tile_index = %s'%(img_id, level, tile_indexes[k]))\n        plt.subplot(nrow, 2, 2*(k+1))\n        plt.imshow(img_mask[x_start: x_end, y_start: y_end,0], cmap=cmap, interpolation='nearest', vmin=0, vmax=5)\n        plt.title('mask image')\n        \ndisplay_tiles_df_h5_file(1080, [15, 7, 12, 21, 28])","82da1cf4":"DF = []\nfor idx in range(len(df)):\n    img_id = df[idx][0]\n    data_provider = train.loc[img_id, 'data_provider']\n    if data_provider == 'radboud':\n        DF += [df[idx]]\nDF[0], DF[-1], len(DF)","1d304c53":"%time dd.io.save('radboud_tiles_coordinates.h5', data = DF)","c7d99497":"len(DF)","638ac62f":"import torch\ndevice = torch.device(\"cuda:0\" if torch.cuda.is_available() else \"cpu\")\ndevice","ee203582":"### Now, extract the `img_id` in `h5.database` which is from `radboud`","50107069":"**Choose what device to run**","9577b27f":"**Load `h5.file`**","ae2d6a32":"See how many `img_id` from `radboud`","99d1079a":"#### Loading & viewing dataset","76ee6bbf":"### Train model","fbc3608d":"Source: https:\/\/www.kaggle.com\/c\/prostate-cancer-grade-assessment","4963dc4c":"We want to seperate the dataset from `radboud` to build a model of $6$ classes, since almost data from `karolinska` has `isup_grade = {0, 1}`, ","fe01db35":"Randomly display tiles of image_mask & image_data","1f37677c":"Now, display 36 tiles in the corresponding mask","d4d2045a":"### See something in the `h5.file`\n\nThis dataset is a list of `list(image_id, coordinates)`\n\nEach `coordinates` contains the values of `x_start, x_end, y_start, y_end` from the `data_image` and `mask_image`. For example","45d7d270":"Finally, save it as the new `h5.file`"}}