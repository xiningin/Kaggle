{"cell_type":{"1d5ffa85":"code","9efa9551":"code","9c98d580":"code","a68ca6b3":"code","a97eb834":"code","17aa13b0":"code","321ec156":"code","62b948f4":"code","d98f9aa8":"code","fb57ffd5":"code","dfc28768":"code","3d2dc396":"code","b271be55":"code","3034465a":"code","fbd15b9e":"code","58af5329":"code","510dbf85":"code","020829a9":"code","1609b8e7":"code","f480fe09":"code","75d2634b":"code","69594260":"code","5c15f86d":"code","570a9241":"code","0b4ff9e2":"code","f128b6cb":"code","76b01edf":"code","b43c1733":"code","5783a02c":"code","51272722":"code","7771c701":"code","7a0f11bf":"markdown","dae37249":"markdown","4f89d44f":"markdown","1c21015c":"markdown","b84de344":"markdown","d5978911":"markdown","ab993939":"markdown"},"source":{"1d5ffa85":"%matplotlib inline\nimport pandas as pd\nimport numpy as np\nimport os, re, sys\nimport matplotlib.pyplot as plt\nfrom IPython.core.display import HTML, Image","9efa9551":"YEAR = 2015\nOUTPUT_ZIP = f'mm_heatmaps_{YEAR}.zip'\nDIR  = f'..\/input\/2015-march-ml-mania-predictions'\nCDIR = f'..\/input\/march-machine-learning-mania-2015'\nPRED_ZIP = f'{CDIR}\/all_selected_predictions.zip'\nTDIR = f'..\/input\/meta-march-mania'\nPNG_DIR = '\/kaggle\/plots'\nPDIR = f'\/kaggle\/preds'  # unzip all_selected_predictions.zip to here","9c98d580":"os.makedirs(PNG_DIR, exist_ok=True)","a68ca6b3":"!7z x -bd -mmt4 -o\/kaggle {PRED_ZIP}","a97eb834":"teams = pd.read_csv(f'{CDIR}\/teams.csv', index_col=0)\nteams.shape","17aa13b0":"seeds = pd.read_csv(f'{CDIR}\/tourney_seeds_2015.csv', index_col=2)\nseeds.shape","321ec156":"res = pd.read_csv(f'{TDIR}\/GroundTruths.csv', index_col=0).query(f'Season=={YEAR}')\nres.shape","62b948f4":"ids = set(res.Low) | set(res.High)\nnteams = len(ids)\nnteams","d98f9aa8":"seeds = seeds[seeds.index.isin(ids)] # 64 teams\nseeds = seeds.join(teams)\n', '.join(seeds.team_name) # team_name -> seed based position","fb57ffd5":"inds = dict(zip(seeds.index, range(nteams)))\nprint(inds)  # TeamID -> seed based position","dfc28768":"ICOLS = ['i1', 'i2']\n\ndef add_inds(df, col):\n    parts = getattr(df, col).str.split('_')\n    df = df.assign(**{ICOLS[i]:parts.str[i+1].astype(int).map(inds) for i in range(2)})\n    df = df.dropna()\n    df[ICOLS] = df[ICOLS].astype(int)\n    return df\n\n# return a submission in a standard form\ndef read_sub(name):\n    df = pd.read_csv(name)\n    df.columns = df.columns.str.lower()\n    df = add_inds(df, 'id')\n    return df[['id', 'pred'] + ICOLS].set_index('id')\n\ndef log_loss(df):\n    p = np.where(df.Truth, df.pred, 1 - df.pred)\n    # clip low predictions to avoid infinite loss\n    p = p.clip(min=1e-15)\n    return (-np.log(p)).mean()\n\ndef score(sub):\n    df = sub.join(res, how='inner')\n    return log_loss(df)\n\n# return final score and the round 1 score from first 32 games\ndef score_multi(sub):\n    df = sub.join(res, how='inner')\n    return log_loss(df), log_loss(df.query('Round==1'))\n\ndef to_matrix(sub):\n    m = np.ones((nteams, nteams)) * 0.5\n    m[sub.i1, sub.i2] = sub.pred\n    m[sub.i2, sub.i1] = 1 - sub.pred\n    return m","3d2dc396":"plt.rc('figure', figsize=(14, 14))\nplt.rc('font', size=12)","b271be55":"def save_heatmap(probs, filename, cmap=plt.cm.seismic):\n    fig, ax = plt.subplots()\n    heatmap = ax.pcolormesh(probs, vmin=0., vmax=1., cmap=cmap)\n\n    ax.spines['top'].set_visible(False)\n    ax.spines['right'].set_visible(False)\n    ax.spines['bottom'].set_visible(False)\n    ax.spines['left'].set_visible(False)\n    \n    ax.invert_yaxis()\n    ax.tick_params(direction='out')\n    ax.xaxis.tick_top()\n    ax.yaxis.tick_left()\n    plt.xticks(rotation=90)\n    \n    team_labels = seeds.team_name.values\n    # put the major ticks at the middle of each cell\n    ax.set_xticks(np.arange(nteams)+0.5, minor=False)\n    ax.set_yticks(np.arange(nteams)+0.5, minor=False)\n    ax.set_xticklabels(team_labels)\n    ax.set_yticklabels(team_labels)\n    plt.savefig(filename, bbox_inches='tight')   ","3034465a":"save_heatmap(to_matrix(add_inds(res, 'index').rename(columns={'Truth': 'pred'})), f'truth_{YEAR}', cmap=plt.cm.bwr)","fbd15b9e":"lst = os.listdir(PDIR)\nlen(lst)","58af5329":"errs = []\nsums = 0\ncount = 0\nfor name in lst:\n    if name.lower().endswith('.csv'):\n        try:\n            sub = read_sub(f'{PDIR}\/{name}')\n            out = re.sub(r'\\.csv$', '.png', name, re.IGNORECASE)\n            s = score_multi(sub)\n            m = to_matrix(sub)\n            sums += sub[['pred']].clip(0, 1)\n            count += 1\n            save_heatmap(m, f'{PNG_DIR}\/{s[0]:.6f}_{s[1]:.6f}_{out}')\n            plt.close()\n        except:\n            errs.append(name)","510dbf85":"len(errs)","020829a9":"errs","1609b8e7":"ensemble = (sums \/ count)\nensemble = add_inds(ensemble, 'index')\nscore_multi(ensemble)","f480fe09":"save_heatmap(to_matrix(ensemble), f'ensemble_{YEAR}')","75d2634b":"lst = sorted(os.listdir(PNG_DIR))\nlen(lst)","69594260":"for i, f in enumerate(lst[:50], 1):\n    (score, sr1, tag) = re.findall(r'([\\d\\.]+)_([\\d\\.]+)_(.+)\\.png$', f)[0]\n    name = tag.replace('_', ' ')\n    display(HTML(\n        f'<h1 id=\"{tag}\">[#{i}] {name}<\/h1>'\n        f'<p>Score: {score} <br\/>'\n        f'R1 Score: {sr1}'\n    ))\n    display(Image(f'{PNG_DIR}\/{f}'))","5c15f86d":"lst = np.asarray(os.listdir(PNG_DIR))\n\nnp.random.seed(42)\nnp.random.shuffle(lst)\n\ndef read_row(names):\n    return np.hstack([plt.imread(os.path.join(PNG_DIR, n)) for n in names])\n\ndef read_grid(names2d):\n    return np.vstack([read_row(row) for row in names2d])\n\ndef pop_gallery(shape):\n    global lst\n    n = np.product(shape)\n    g = read_grid(lst[:n].reshape(shape))\n    lst = lst[n:]\n    return g\n\ndef show_gallery(gal):\n    fig, ax = plt.subplots(figsize=(12, 12))\n    ax.imshow(gal, interpolation='bilinear')\n    ax.axis('off')\n    plt.tight_layout(pad=0)\n    plt.show()","570a9241":"show_gallery(pop_gallery((2,2)))","0b4ff9e2":"show_gallery(pop_gallery((3,3)))","f128b6cb":"show_gallery(pop_gallery((4,4)))","76b01edf":"show_gallery(pop_gallery((5,5)))","b43c1733":"show_gallery(pop_gallery((6,6)))","5783a02c":"show_gallery(pop_gallery((7,7)))","51272722":"show_gallery(pop_gallery((8,8)))","7771c701":"!7z a -bd -mmt4 {OUTPUT_ZIP} {PNG_DIR}\/*.png","7a0f11bf":"# Preview Top Plots\n\nShow the best submissions by log loss score - ranks not exactly same as leaderboard ranks as some teams had two strong submissions. See the [2015 leaderboard here](https:\/\/www.kaggle.com\/c\/march-machine-learning-mania-2015\/leaderboard). Also, beware that double digit logloss values 10+ aren't sorted correctly - but that will not affect the top 50 shown here.","dae37249":"# Ground Truth\n\nThis is it &mdash; the correct solution to 2015 &mdash; all the 63 matches actually played, and the results; reading rows, red means a win, blue is a loss. All the white cells are ignored in scoring solutions.","4f89d44f":"# Zip All Plots\n\nThat's still less than half the submissions!\n\nSurely some of the above tempt you to download them all and take a look?","1c21015c":"# Generate All Plots","b84de344":"# Heatmap All *March Machine Learning Mania 2015* Submissions\n\nThe plot format is introduced [here](https:\/\/www.kaggle.com\/c\/march-machine-learning-mania-2017\/discussion\/30333), along with generated heatmaps for all the 2017 entries.\n\nTo recap: it is easiest to read the row for each team, where white means 50:50, red indicates probably winning, blue means probably losing, the deeper the color, the higher the probability.\n\nIn this Notebook the play-in matches are removed, leaving a 64x64 grid showing the four 16x16 regions, and all possible tournament matches.\n\nThe outline is:\n\n 1. list all csv submissions\n 2. for each: load; score; save heatmap\n 3. display selection\n 4. zip all 613 heatmaps for download\n\n","d5978911":"# Ensemble of All Submissions","ab993939":"# Random Galleries!\n\nLet's zoom out, step by step, seeing more and more submissions :)"}}