{"cell_type":{"695e2985":"code","eb59de19":"code","10efdccf":"code","5683f4c8":"code","ce829500":"code","6a4bbec4":"code","3f451717":"code","3beaef6c":"code","96ac7dd8":"code","fbb633ea":"code","b37a8574":"code","7c51d7a0":"code","8474548e":"code","e04b98f7":"code","16c62083":"code","361de514":"code","85bbfd47":"code","28d5141a":"code","4131b195":"code","5e89bdb9":"code","203ffeb1":"code","c221a506":"code","1cdfc63f":"code","0b76008d":"code","01801db9":"code","431802a3":"code","286bd847":"code","6de4d709":"code","12147668":"code","22f57798":"code","7edd695c":"code","3781c032":"code","67513b32":"code","cd157b80":"code","471119aa":"code","fc51398c":"code","2da8b8fc":"code","b0d374df":"code","06e52230":"code","00aee49c":"code","610875b8":"code","2e705f7b":"code","5c28d7fc":"code","59db2af4":"code","6ea9f1bd":"code","c3e97a07":"code","1b710450":"code","5e8b8e69":"code","c953d37d":"code","3a629167":"code","b53327ef":"code","97c91811":"code","173c1d7f":"code","c7ffd9fa":"code","bd77d0b4":"code","b76355f4":"code","4219e9ff":"markdown","5aa45cbf":"markdown","8cd49d68":"markdown","f5fd5f54":"markdown","8117be57":"markdown"},"source":{"695e2985":"import numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\nimport datetime\nfrom datetime import timedelta\nimport scipy\nimport sklearn\n\nimport os\nfor dirname, _, filenames in os.walk('\/kaggle\/input'):\n    for filename in filenames:\n        print(os.path.join(dirname, filename))\n\n# Any results you write to the current directory are saved as output.","eb59de19":"df = pd.read_csv('\/kaggle\/input\/covid19-local-us-ca-forecasting-week-1\/ca_train.csv')\ndf.head()","10efdccf":"df['datetime'] = pd.to_datetime(df.Date)\ndf.index = df.datetime","5683f4c8":"## According to the US Census Bureau\n## https:\/\/www.census.gov\/quickfacts\/CA\nca_population = 39512223 # As of July 2019\n\n## Coronavirus contact rate\n## According to this article from Reuters\n## https:\/\/www.reuters.com\/article\/us-china-health-transmission\/coronavirus-contagion-rate-makes-it-hard-to-control-studies-idUSKBN1ZO0QW\nbeta = 1\/2.5 ## Based on a study from Britain's Lancaster University\n\n## Coronavirus recovery rate from California\n## Calculated based on demographic factors from South Korea data\n## gamma = \n\n\n## Most frequent Symptom Lag\n## According to BBC\n## https:\/\/www.bbc.com\/news\/health-51800707\nt = 5\n\n## Ratio of tests per member of the population in South Korea to the same figure in the US\n## https:\/\/www.npr.org\/sections\/coronavirus-live-updates\/2020\/03\/24\/820981710\/fact-check-u-s-testing-still-isnt-close-to-what-south-korea-has-done\ntesting_ratio = 1090\/170","ce829500":"df['ActualCases'] = df.ConfirmedCases.apply(lambda x: x* testing_ratio)","6a4bbec4":"df","3f451717":"import matplotlib.pyplot as plt\ndf['datetime'] = pd.to_datetime(df.datetime)\nfirstcase = df.loc[df.ConfirmedCases>=0].datetime.min()\ndf1 = df.loc[df.datetime>firstcase ]\n\n\nplt.rcParams[\"figure.figsize\"] = [6.4*3, 4.8*3]\nplt.plot(df1.ConfirmedCases, color = 'grey', label = 'Confirmed Cases')\nplt.plot(df1.Fatalities, color = 'red', label = 'Fatalities')\nplt.plot(df1.ActualCases, color = 'orange', linestyle = '--', label = 'Potential Actual Cases')\nplt.legend()\n# plt.yscale('log')\nplt.show()\n","3beaef6c":"\nfirst_confirmed_case = df.loc[df.ConfirmedCases>0].index.min()\ndf1 = df.loc[df.index>=first_confirmed_case]\nprint(first_confirmed_case)","96ac7dd8":"## Mortality rate of those tested\ndef newdiv(n1, n2):\n    if n2!=0:\n        return n1\/n2\n    else:\n        return 0\n    \nmort = df1.apply(lambda x: newdiv(x.Fatalities, x.ConfirmedCases), axis = 1)\nm,b = np.polyfit([i for i in range(len(mort))], mort, 1)\nprint(m)\nprint(b)\nplt.scatter(x = df1.index, y = mort)\nbest_fit = pd.Series([i*m+b for i in range(len(df1.index))])\nbest_fit.index = df1.index\nplt.title('Changes in COVID-19 Mortality Rate Since First Confirmed Cases')\nplt.xlabel('date')\nplt.ylabel('mortality rate')\nplt.plot(best_fit, color = 'red', linestyle = '--')\n\nplt.show()","fbb633ea":"import os\nfor dirname, _, filenames in os.walk('\/kaggle\/input\/coronavirusdataset'):\n    for filename in filenames:\n        print(os.path.join(dirname, filename))","b37a8574":"routes = pd.read_csv('\/kaggle\/input\/coronavirusdataset\/PatientRoute.csv')\nprovince = pd.read_csv('\/kaggle\/input\/coronavirusdataset\/TimeProvince.csv')\nregions = pd.read_csv('\/kaggle\/input\/coronavirusdataset\/Region.csv')\nage = pd.read_csv('\/kaggle\/input\/coronavirusdataset\/TimeAge.csv')\npatient = pd.read_csv('\/kaggle\/input\/coronavirusdataset\/PatientInfo.csv')\ngender = pd.read_csv('\/kaggle\/input\/coronavirusdataset\/TimeGender.csv')\ntime = pd.read_csv('\/kaggle\/input\/coronavirusdataset\/Time.csv')","7c51d7a0":"time.head()\ntime.index = pd.to_datetime(time.date)\nplt.plot(time.test, color = 'grey',label = 'tested')\nplt.plot(time.confirmed, color = 'teal', label = 'confirmed')\nplt.plot(time.released, color = 'purple', label = 'released')\nplt.plot(time.deceased, color = 'yellow', label = 'deceased')\nplt.legend()\nplt.title('Spread of COVID-19 in South Korea')\nplt.xlabel('date')\nplt.ylabel('count')\nplt.yscale('log')\nplt.show()","8474548e":"patient.head()\npatient['symptom_onset_date'] = pd.to_datetime(patient['symptom_onset_date'])\npatient['confirmed_date'] = pd.to_datetime(patient['confirmed_date'])\npatient['released_date'] = pd.to_datetime(patient['released_date'])\npatient['deceased_date'] = pd.to_datetime(patient['deceased_date'])\npatient['onset_to_confirmed']  = patient.apply(lambda x: x.confirmed_date - x.symptom_onset_date, axis = 1)\npatient['onset_to_mortality'] = patient.apply(lambda x: x.confirmed_date - x.symptom_onset_date, axis = 1)\npatient['confirmed_to_mortality'] = patient.apply(lambda x: x.deceased_date - x.confirmed_date, axis = 1)\npatient['onset_to_released'] = patient.apply(lambda x: x.released_date - x.symptom_onset_date, axis = 1)\npatient['confirmed_to_released'] = patient.apply(lambda x: x.released_date - x.confirmed_date, axis = 1)","e04b98f7":"ovs = patient.loc[patient.infection_case == 'overseas inflow']\ndates_of_overseas_confirmed = list(set(ovs.confirmed_date.dt.date.tolist()))\ndates_of_overseas_confirmed.sort()","16c62083":"pc_dict = province.pivot_table(index = ['date'], columns = 'province', values = 'confirmed', aggfunc = np.sum)\npr_dict = province.pivot_table(index = ['date'], columns = 'province', values = 'released', aggfunc = np.sum)\npd_dict = province.pivot_table(index = ['date'], columns = 'province', values = 'deceased', aggfunc = np.sum)","361de514":"province_piv = province.pivot_table(index = ['date'], columns = 'province', values = 'confirmed', aggfunc = np.sum)\ncases_by_province = {}\nfor c in province_piv.columns:\n    cases_by_province[c] = province_piv[c].to_dict()\n    plt.plot(province_piv[c], label = c)\n\nplt.title('Confirmed Cases of COVID-19 in South Korea by Province')\nplt.xlabel('date')\nplt.ylabel('Confirmed Cases by Province')\nplt.yscale('log')\nplt.legend()\nplt.xticks(rotation = 45)\nplt.show()","85bbfd47":"\ndef cases_map(pdict, pr, date):\n    try:\n        return pdict[pr][str(date.date())]\n    except:\n        return np.nan\n\npatient['cases_in_province'] = patient.apply(lambda x: cases_map(pc_dict,x.province, x.confirmed_date), axis = 1)\n","28d5141a":"patient['age_years'] = (datetime.datetime.now().year-patient.birth_year)","4131b195":"hlth.iloc[0].values","5e89bdb9":"r1 = regions.pivot_table(index = 'province',values = ['university_count'], aggfunc = np.sum).to_dict()\nr2 = regions.pivot_table(index = 'province',values = ['elderly_population_ratio'], aggfunc = np.mean).to_dict()\n","203ffeb1":"# if 'date' in province.columns:\n#     province.drop('date', inplace = True, axis = 1)\nif 'time' in province.columns:\n    province.drop('time', inplace = True, axis = 1)\nprovince['average_elderly_ratio'] = province.province.map(r2['elderly_population_ratio'])\nprovince['university_count'] = province.province.map(r1['university_count'])","c221a506":"hlth = pd.read_csv('\/kaggle\/input\/south-korea-number-of-health-centers\/Number_of_Health_Center__Health_Center_Branch__Health_Care_Center__1997____20200326033038.csv')\nhlth[['By Si-Do(1)','2018',\n       '2018.1', '2018.2', '2018.3', '2018.4']]\nhlth.columns = hlth.iloc[0]\nhlth.index = hlth['By Si-Do(1)']\nhlth.drop('By Si-Do(1)', axis = 0, inplace = True)\nhlth.drop('By Si-Do(1)', axis = 1, inplace = True)\n\nhc_dict = hlth['Health Care Center'].to_dict()['Health Care Center']\n\nprovince['province'] = province.province.apply(lambda x: x.replace('-do','').replace('sang','').replace('cheong','').replace('lla','').replace('Jeobuk','Jeonbuk').replace('Jeonam','Jeonnam'))\nset(province.province.unique())-set(hc_dict.keys())\nprovince['health_care_centers'] = province.province.map(hc_dict)","1cdfc63f":"province","0b76008d":"patient['cases_in_province_t5'] = patient.cases_in_province.shift(5)\nprovince['cases_in_province_t5'] = province.confirmed.shift(5)\npatient.cases_in_province_t5.fillna(0, inplace = True)\nprovince.cases_in_province_t5.fillna(0, inplace = True)\n\n","01801db9":"patient.head()\npdfr = patient.loc[patient.released_date.notna()][['sex','age_years','onset_to_released','cases_in_province','cases_in_province_t5']]\npdfm = patient.loc[patient.deceased_date.notna()][['sex','age_years','confirmed_to_mortality','cases_in_province','cases_in_province_t5']]","431802a3":"plt.title(\"South Korea Onset to Mortality by Gender and Age\")\nplt.scatter(x = pdfm.loc[pdfm.sex == 'male'].age_years,y = pdfm.loc[pdfm.sex == 'male'].confirmed_to_mortality.dt.days, color = 'blue')\nplt.scatter(x = pdfm.loc[pdfm.sex == 'female'].age_years,y = pdfm.loc[pdfm.sex == 'female'].confirmed_to_mortality.dt.days, color = 'pink')","286bd847":"province.index = pd.to_datetime(province.date)\n\nfor p in province.province.unique():\n    pr = province.loc[province.province == p]\n    plt.plot(pr.confirmed, color = 'teal')\n    plt.plot(pr.released, color = 'yellow')\n    plt.plot(pr.deceased, color = 'grey')\n    \nplt.show()","6de4d709":"province['province'] = province.province.apply(lambda x: x.replace('-do','').replace('Jeobuk','Jeonbuk').replace('Jeonam','Jeonnam').replace('sang','').replace('cheong','').replace('lla',''))\nset(province.province.unique())-set(hc_dict.keys())\nprovince['health_care_centers'] = province.province.map(hc_dict)\nprovince","12147668":"## Calculate Days Since Initial Outbreak\n\nfirst_case = {}\nfor p in province.province.unique():\n    pr = province.loc[(province.province == p)&(province.confirmed>0)]\n    fd = pr.index.min()\n    first_case[p] = fd","22f57798":"province","7edd695c":"province","3781c032":"province['first_case'] = province.province.map(first_case)\nprovince.first_case\nprovince['time_since_first_case'] = (pd.to_datetime(province.date)-pd.to_datetime(province.first_case)).dt.days\nprovince.drop('first_case', inplace = True, axis = 1)","67513b32":"province.columns\n","cd157b80":"province_data = {}\n\n'''\nThe goal is to end up with the coefficients of the infection, mortality and recovery curves, and then predict for the entire state of California\n'''\npr_columns_all = province.columns\npr_columns = [\n       'average_elderly_ratio', 'university_count', 'health_care_centers',\n       'cases_in_province_t5', 'time_since_first_case']\npr_indexes = {}\npr_confirmed = {}\npr_released = {}\npr_deceased = {}\nprovince_data_truncated = {}\n\n\nfor p in province.province.unique():\n    pr = province.loc[province.province == p][['confirmed','released','deceased',\n       'average_elderly_ratio', 'university_count', 'health_care_centers',\n       'cases_in_province_t5', 'time_since_first_case']]\n    pr2 = pr.loc[pr.time_since_first_case>=0]\n    pr_indexes[p] = pr2.index\n    pr_confirmed[p] = pr2.confirmed.values\n    pr_released[p] = pr2.released.values\n    pr_deceased[p] = pr2.deceased.values \n    province_data[p] = pr[['average_elderly_ratio', 'university_count', 'health_care_centers',\n       'cases_in_province_t5', 'time_since_first_case']].values\n    province_data_truncated[p] = pr2[['average_elderly_ratio', 'university_count', 'health_care_centers',\n       'cases_in_province_t5', 'time_since_first_case']].values","471119aa":"c = model.coef_[0]\nb = model.intercept_\n\n\nvs = []\nfor u in x:\n    v = c[0]*u**4 + c[1]*u**3 + c[2]*u**2 + c[3]*u**1+b\n    vs.append(v)\n    \nplt.scatter(x=x,y = vs)","fc51398c":"# from sklearn.utils.extmath import safe_sparse_dot\n# cmatrix = np.dot(np.array(x), model.coef_.T.reshape(1,-1))+ model.intercept_\n# model.densify()","2da8b8fc":"# model.coef_.T","b0d374df":"\nimport operator\n\nimport numpy as np\nimport matplotlib.pyplot as plt\n\nfrom sklearn.linear_model import LinearRegression\nfrom sklearn.metrics import mean_squared_error, r2_score\nfrom sklearn.preprocessing import PolynomialFeatures\n'''\nCode used originally from Animesh Agarwal, via\nhttps:\/\/towardsdatascience.com\/polynomial-regression-bbe8b9d97491\n\n'''\nr2_values = []\ncoeffs = {}\n\nfor p in pr_confirmed.keys():\n    print(p)\n    y = pr_confirmed[p]\n    x = province_data_truncated[p][:,4]\n    # transforming the data to include another axis\n    x = x[:, np.newaxis]\n    y = y[:, np.newaxis]\n\n    polynomial_features= PolynomialFeatures(degree=3)\n    x_poly = polynomial_features.fit_transform(x)\n    \n\n    model = LinearRegression()\n    model.fit(x_poly, y)\n    y_poly_pred = model.predict(x_poly)\n    \n#     data = pd.DataFrame.from_dict({\n#     'x': x,\n#     'y': y\n#         })\n\n#     p = PolynomialFeatures(degree=3).fit(data)\n#     features = DataFrame(p.transform(data), columns=p.get_feature_names(data.columns))\n\n\n    rmse = np.sqrt(mean_squared_error(y,y_poly_pred))\n    r2 = r2_score(y,y_poly_pred)\n    r2_values.append(r2)\n    print(rmse)\n    print(r2)\n\n    plt.scatter(x, y, s=10)\n    # sort the values of x before line plot\n    sort_axis = operator.itemgetter(0)\n    sorted_zip = sorted(zip(x,y_poly_pred), key=sort_axis)\n    x, y_poly_pred = zip(*sorted_zip)\n    \n    c = model.coef_[0]\n    b = model.intercept_\n\n    vs = []\n    for u in x:\n        v = c[0]*u**0 + c[1]*u**1 + c[2]*u**2 + c[3]*u**3+b[0]\n        vs.append(v)\n\n    coeffs[p] = [b[0], c[0],c[1],c[2],c[3]]\n    plt.plot(x, y_poly_pred, color='m')\n    plt.plot(vs, color = 'yellow', linestyle = '--')\n    plt.show()","06e52230":"province['b']=province.province.map(coeffs).apply(lambda x: x[0])\nprovince['c0']=province.province.map(coeffs).apply(lambda x: x[1])\nprovince['c1']=province.province.map(coeffs).apply(lambda x: x[2])\nprovince['c2']=province.province.map(coeffs).apply(lambda x: x[3])\nprovince['c3'] = province.province.map(coeffs).apply(lambda x: x[4])","00aee49c":"f = province[[\n       'average_elderly_ratio', 'university_count', 'health_care_centers',\n       'cases_in_province_t5']].values\n\nt1 = province.b.values\nt2 = province.c1.values\nt3 = province.c2.values\nt4 = province.c3.values","610875b8":"\ncount = 1\nfor i in range(f.shape[1]):\n#     print('\\n')\n#     print(i)\n    f_ = f[:,i]\n    for t in [t1,t2,t3,t4]:\n#         print(count)\n        model = LinearRegression()\n        model.fit(f_.reshape(-1,1), t)\n        y_poly_pred = model.predict(f_.reshape(-1,1))\n        count +=1\n        rmse = np.sqrt(mean_squared_error(t,y_poly_pred))\n        r2 = r2_score(t,y_poly_pred)\n#         print(r2)\n\n# for t in [t1,t2,t3,t4]:\n#     print(count)\n#     model = LinearRegression()\n#     model.fit(f, t)\n#     y_poly_pred = model.predict(f)\n#     count +=1\n#     rmse = np.sqrt(mean_squared_error(t,y_poly_pred))\n#     r2 = r2_score(t,y_poly_pred)\n#     print(r2)","2e705f7b":"regions.university_count.sum()","5c28d7fc":"province.columns\nprovinces_labels = province.province\nprovinces['health_care_centers'] = province.health_care_centers(lambda x: float(x))\nkorea_vectors = [province[['health_care_centers','university_count', 'average_elderly_ratio']].values[i] for i in range(len(province))]","59db2af4":"hospitals = 81729\/58\nunis = 138\/58\nelderly_ratio  = 14.3\n\nca_vector = [hospitals, unis, elderly_ratio]\ndistances = {}\ncount = 0\n\nfor v in korea_vectors:\n    v = [float(i) for i in v]\n    dist = scipy.spatial.distance.cosine(v, ca_vector)\n    distances[provinces_labels[count]] = dist\n    count +=1\n","6ea9f1bd":"sim = pd.Series(distances)\nsim.sort_values(ascending = False, inplace = True)\nsim","c3e97a07":"df.columns","1b710450":"coeffs = province.loc[province.province == 'Seoul'][['b','c0','c1','c2','c3']].drop_duplicates()\nb = coeffs['b']\nc1 = coeffs['c1']\nc2 = coeffs['c2']\nc3 = coeffs['c3']","5e8b8e69":"test = pd.read_csv('\/kaggle\/input\/covid19-local-us-ca-forecasting-week-1\/ca_test.csv')\ntrain_and_test = pd.concat([df[['Date','ConfirmedCases','Fatalities','ActualCases']], test[['ForecastId','Date']]])\ntest.head()","c953d37d":"train_and_test['day_number'] = np.array(range(len(train_and_test)))\ntrain_and_test['calculated_confirmed'] = train_and_test.day_number.apply(lambda x: (b+c1*x**1+c2*x**2+c3*x**3) )\ntrain_and_test['calculated_actual'] = train_and_test.calculated_confirmed.apply(lambda x: x*testing_ratio)\n# train_and_test['calculated_fatalities'] = train_and_test.day_number.apply(lambda x: )","3a629167":"m,b = np.polyfit([i for i in range(len(mort))], mort, 1)\nprint(m,b)\ntrain_and_test['mortality_rate'] = [i*m+b for i in range(len(train_and_test))]\ntrain_and_test['mortalities'] = train_and_test.apply(lambda x: float(x.mortality_rate)*float(x.calculated_actual), axis = 1)","b53327ef":"train_and_test.mortality_rate","97c91811":"train_and_test[['mortality_rate', 'calculated_actual']]","173c1d7f":"plt.title('Seoul vs. California Predicted Cases')\nplt.plot(train_and_test.calculated_confirmed.values, color = 'blue', linestyle = '--')\nplt.plot(train_and_test.calculated_actual.values, color = 'orange', linestyle = '--',label = 'calculated_actual''')\nplt.plot(train_and_test.mortalities.values, color = 'red', linestyle = '--', label = 'mortalities')\nplt.plot(train_and_test.ConfirmedCases.values, color = 'teal', label = 'Confirmed Cases')\nplt.legend\nplt.show()\n","c7ffd9fa":"train_and_test.columns","bd77d0b4":"results = train_and_test[['ForecastId','calculated_confirmed','mortalities']]\nresults['ConfirmedCases'] = results['calculated_confirmed']\nresults['Mortalities'] = results['mortalities']","b76355f4":"results.to_csv('submission.csv')","4219e9ff":"California:\n- Average elderly ratio 14.3 https:\/\/www.census.gov\/quickfacts\/CA\n- university count 138 https:\/\/www.usnews.com\/best-colleges\/ca\n- health care centers 81729 in 2013 \/58 counties https:\/\/www.chcf.org\/wp-content\/uploads\/2017\/12\/PDF-CaliforniaHospitals2015.pdf","5aa45cbf":"None of these scores are good at all, showing that it isn't possible pr predict. Instead, I'll just pick the closest values to the California feature vector and go from there.","8cd49d68":"There's not enough data in the South Korea dataset to determine what contributes to the time between contraction of COVID-19 and mortality. However, according to the ","f5fd5f54":"**Facts for Analysis**\n* South Korea Testing Rate (get data if possible)\n* California Testing Rate\n(Use these to predict number of actual cases in California)\n* Predicted delta from confirmed case to mortality based on \n    age,\n    gender,\n    days since first confirmed case\n* Predicted mortality rate based on \n    age,\n    gender,\n    income,\n    days since first confirmed case\n* Predicted Infection rate\n* Predicted Recovery rate\n    \nOne assumption we will be making in this analysis is that the infected population is a microcosm of California's overall demographics. This is likely not the case, since individuals in similar demographics (i.e. age, income categories) are likely to be in contact with one another more frequently) and individuals in some demographics are more likely to get tested than others because of either access to limited testing resources or possibly being asymptomatic. If we had more precise data on locations and demographics of those infected, it would be possible to predict both the ","8117be57":"Degree 2\nAverage r2:\n0.9360372808880892\nr2 Standard Deviation:\n0.05449828265182969\n\nDegree 3\nAverage r2:\n0.9545393733898083\nr2 Standard Deviation\n0.04581180415185544"}}