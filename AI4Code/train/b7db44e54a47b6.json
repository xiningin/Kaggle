{"cell_type":{"5b3ccdc5":"code","9e270ab5":"code","34ce465c":"code","a6051216":"code","c5f79747":"code","58fcc3d2":"code","563ddefc":"code","a22e876e":"code","d23e0f59":"code","0252971e":"code","34a049be":"code","04c586d1":"code","a4cfdc4c":"code","b5c1f57c":"code","fe8215bf":"code","e1669a6a":"code","3ea19f8f":"code","e07b385f":"code","32b3e3a3":"code","45664365":"code","086b18ca":"code","5eab675d":"code","9af7b68c":"code","f95a61de":"code","899b1cf5":"code","59067d50":"code","dcb1bf45":"code","72d59594":"code","b762c1f5":"code","1014acfd":"code","a019c68e":"code","5ca2dc76":"markdown","17ebcf7c":"markdown","9b637ed6":"markdown","3976a61d":"markdown","8f38164b":"markdown","0900532f":"markdown","fc6358ac":"markdown","e8dafd28":"markdown","370d174b":"markdown","c0256ff8":"markdown","357adbb8":"markdown","62564193":"markdown","228f68ea":"markdown","a754db37":"markdown","88c00e32":"markdown"},"source":{"5b3ccdc5":"!pip install pyspark","9e270ab5":"!pip install pygal","34ce465c":"!pip install cairosvg","a6051216":"from pyspark import SparkConf, SparkContext\nfrom pyspark.sql.functions import *\nfrom pyspark.sql import SparkSession\nimport ipywidgets as widgets\nfrom ipywidgets import interact, interactive\nimport pygal\nspark = SparkSession.builder.appName(\"E-Commerce Analysis\").getOrCreate()","c5f79747":"reviews_df = spark.read.option(\"delimeter\",\"|\").csv('..\/input\/brazilian-ecommerce\/olist_order_reviews_dataset.csv',header = True)\nreviews_df = reviews_df.na.drop(subset=['review_creation_date','review_answer_timestamp'])\nreviews_df = reviews_df.withColumn('review_creation_date',to_timestamp('review_creation_date')).withColumn('review_answer_timestamp',to_timestamp('review_answer_timestamp'))\nreviews_df.printSchema()\nreviews_df.show()","58fcc3d2":"payment_df = spark.read.option(\"delimeter\",\"|\").csv('..\/input\/brazilian-ecommerce\/olist_order_payments_dataset.csv',header = True)\npayment_df = payment_df.na.drop()\npayment_df.printSchema()\npayment_df.show()","563ddefc":"orders_df = spark.read.option(\"delimeter\",\"|\").csv('..\/input\/brazilian-ecommerce\/olist_orders_dataset.csv',header = True)\norders_df = orders_df.withColumn('order_purchase_timestamp', to_timestamp('order_purchase_timestamp')).withColumn('order_delivered_carrier_data', to_timestamp('order_delivered_carrier_date')).withColumn('order_approved_at',to_timestamp('order_approved_at')).withColumn('order_delivered_customer_date',to_timestamp('order_delivered_customer_date')).withColumn('order_estimed_delivery_date',to_timestamp('order_estimated_delivery_date'))\norders_df.printSchema()\norders_df.show()","a22e876e":"customers_df = spark.read.option(\"delimeter\",\"|\").csv('..\/input\/brazilian-ecommerce\/olist_customers_dataset.csv',header = True)\ncustomers_df = customers_df.na.drop()\ncustomers_df.printSchema()\ncustomers_df.show()","d23e0f59":"products_df = spark.read.option(\"delimeter\",\"|\").csv('..\/input\/brazilian-ecommerce\/olist_products_dataset.csv',header = True)\nproducts_df = products_df.na.drop()\nproducts_df.printSchema()\nproducts_df.show()","0252971e":"item_df = spark.read.option(\"delimeter\",\"|\").csv('..\/input\/brazilian-ecommerce\/olist_order_items_dataset.csv',header = True).dropna()\nitem_df=item_df.withColumn('shipping_limit_date',to_timestamp('shipping_limit_date')).withColumn('order_item_id',item_df.order_item_id.cast('int'))\nitem_df.printSchema()\nitem_df.show()\n","34a049be":"sellers_df = spark.read.option(\"delimeter\",\"|\").csv('..\/input\/brazilian-ecommerce\/olist_sellers_dataset.csv',header = True).dropna()\nsellers_df.printSchema()\nsellers_df.show()","04c586d1":"geolocation_df = spark.read.csv(\"..\/input\/brazilian-ecommerce\/olist_geolocation_dataset.csv\",header = True)\ngeolocation_df = sellers_df.join(geolocation_df).where(sellers_df['seller_zip_code_prefix']==geolocation_df['geolocation_zip_code_prefix']).drop(*('seller_id','seller_zip_code_prefix','seller_state','geolocation_city')).withColumnRenamed('seller_city','geolocation_city')\ngeolocation_df = geolocation_df.select('geolocation_zip_code_prefix','geolocation_lat','geolocation_lng','geolocation_city','geolocation_state')\ngeolocation_df.show()","a4cfdc4c":"translation_df = spark.read.csv(\"..\/input\/brazilian-ecommerce\/product_category_name_translation.csv\",header = True)\norder_item_grpby = item_df.groupBy('product_id').agg({'order_item_id':'max'})\ntop_selling = order_item_grpby.join(products_df,['product_id'])\ntop_selling = top_selling.join(translation_df,['product_category_name'])\ntop_selling = top_selling.groupBy('product_category_name_english').agg({'max(order_item_id)':'max'}).withColumnRenamed('max(max(order_item_id))','order_item').withColumnRenamed('product_category_name_english','Product_Name')\ntop_selling.orderBy('order_item',ascending=False).show()","b5c1f57c":"from_date = widgets.DatePicker(\n    description = 'Start Date'\n)\nTo_date = widgets.DatePicker(\n    description = 'End Date'\n)\ndef Total_revenue(from_date,To_date):\n    Total_revenue = orders_df.join(payment_df,['order_id']).filter(orders_df.order_status == 'delivered').drop(*('customer_id','order_status','order_delivered_customer_date','order_approved_at','order_delivered_carrier_date','order_estimated_delivery_date'))\n    Total_revenue = Total_revenue.withColumn('Date',to_date('order_purchase_timestamp'))\n    Total_revenue = Total_revenue.filter(Total_revenue.Date.between(from_date,To_date))\n    Total_revenue = Total_revenue.agg({'payment_value':'sum'}).withColumnRenamed('sum(payment_value)','Total_revenue')\n    Total_revenue = Total_revenue.withColumn('Total_revenue',Total_revenue.Total_revenue.cast('float'))\n    Total_revenue.show()\n\nout = widgets.interactive_output(Total_revenue,{'from_date':from_date,'To_date':To_date})\nwidgets.HBox([widgets.VBox([from_date,To_date]),out])","fe8215bf":"product_category = item_df.join(products_df,['product_id'])\nproduct_category = product_category.join(translation_df,['product_category_name'])\nproduct_category = product_category.groupBy('product_category_name_english').count().withColumnRenamed('count','Total_item').withColumnRenamed('product_category_name_english','Product_Category')\nproduct_category.show()","e1669a6a":"Customer_by_region_state = customers_df.groupBy('customer_state').count().withColumnRenamed('count','No_of_customers').show()","3ea19f8f":"Customer_by_region_city = customers_df.groupBy('customer_city').count().orderBy('count',ascending=False).withColumnRenamed('count','No_of_customers').show()","e07b385f":"@interact(Year=[('2018',2018),('2017',2017),('2016',2016)])\ndef Annual(Year):\n  Annual_revenue = orders_df.join(payment_df,['order_id']).filter(orders_df.order_status=='delivered').drop(*('customer_id','order_status','order_delivered_customer_date','order_removed_at','order_delivered_carrier_date','order_estimated_delivery_date'))\n  Annual_revenue = Annual_revenue.withColumn('Date',to_date('order_purchase_timestamp'))\n  Annual_revenue = Annual_revenue.withColumn('year',year(to_timestamp('Date','dd\/MM\/yyyy')))\n  Annual_revenue = Annual_revenue.filter(Annual_revenue.year==Year)\n  Annual_revenue = Annual_revenue.agg({'payment_value':'sum'}).withColumnRenamed('sum(payment_value)','Total_Payment')\n  Annual_revenue = Annual_revenue.withColumn('Total_Payment',Annual_revenue.Total_Payment.cast('int'))\n  Annual_revenue.show()\n\n\n","32b3e3a3":"orders_df_filter = orders_df.filter(orders_df.order_status=='delivered')\nMost_fav = orders_df_filter.join(item_df,['order_id']).drop(*('order_status','order_purchase_timestamp','order_approved_at','order_delivered_carrier_date','order_delivered_customer_date','order_estimated_delivery_date','shipping_limit_date','price','freight_value'))\nMost_fav_customer = Most_fav.groupBy('Customer_id').count().withColumnRenamed('count','total_product_buy')\nMost_fav_customer.orderBy('total_product_buy',ascending=False).show()","45664365":"Most_fav_seller = Most_fav.groupBy('seller_id').count().withColumnRenamed('count','total_product_sold')\nMost_fav_seller.orderBy('total_product_sold',ascending=False).show()","086b18ca":"from IPython.display import display, HTML\n\nbase_html = \"\"\"\n<!DOCTYPE html>\n<html>\n  <head>\n  <script type=\"text\/javascript\" src=\"http:\/\/kozea.github.com\/pygal.js\/javascripts\/svg.jquery.js\"><\/script>\n  <script type=\"text\/javascript\" src=\"https:\/\/kozea.github.io\/pygal.js\/2.0.x\/pygal-tooltips.min.js\"\"><\/script>\n  <\/head>\n  <body>\n    <figure>\n      {pygal_render}\n    <\/figure>\n  <\/body>\n<\/html>\n\"\"\"","5eab675d":"list_product = translation_df.groupBy('product_category_name_english').count().select('product_category_name_english').rdd.flatMap(lambda x:x).collect()\n\n@interact(Product=[str(x) for x in list_product])\ndef product(Product):\n  product_sales = orders_df.join(item_df,['order_id']).join(products_df,['product_id']).join(translation_df,['product_category_name']).select('product_category_name_english','order_purchase_timestamp').withColumn('Date',to_date('order_purchase_timestamp'))\n  product_sales = product_sales.filter(product_sales.product_category_name_english == Product)\n  product_sales = product_sales.groupby('Date').count().sample(0.2)\n  list_date = product_sales.select('Date').rdd.flatMap(lambda x:x).collect()\n  list_count = product_sales.select('count').rdd.flatMap(lambda x:x).collect()\n  chart = pygal.Line(width=1200,height=400,explicit_size=True,x_lable_rotation=20,show_minor_x_lable=False)\n  chart.x_labels = map(str,[str(x) for x in list_date ])\n  chart.add(Product,[x for x in list_count])\n  HTML(base_html.format(pygal_render=chart.render()))\n  chart.render_in_browser()\n  product_sales.sample(0.1).orderBy('Date',ascending=True).show()\n\n","9af7b68c":"Order_by_region = customers_df.join(orders_df_filter,['customer_id'],'leftsemi')\nCustomer_by_region_city = Order_by_region.groupBy('customer_city').count()\nCustomer_by_region_city.orderBy('count',ascending=False).withColumnRenamed('count','Total_orders').show()\nCustomer_by_region_city.sample(0.01).show()","f95a61de":"Reviewed_product = item_df.join(orders_df_filter,['order_id'],'leftsemi').join(products_df,['product_id']).join(reviews_df,['order_id']).join(translation_df,['product_category_name']).select('review_id','order_id','product_id','product_category_name_english','review_comment_title','review_comment_message').dropna()\nReviewed_product = Reviewed_product.groupby('product_category_name_english','review_comment_title').count().groupBy('product_category_name_english').agg({'count':'sum'}).withColumnRenamed('sum(count)','Total_review')\nReviewed_product.orderBy('Total_review',ascending = False).show()","899b1cf5":"minmax = item_df.groupBy('product_id').agg({'price':'min'})\nproduct_priced = minmax.join(products_df,['product_id'])\nproduct_priced = product_priced.join(translation_df,['product_category_name'])\nproduct_priced = product_priced.groupBy('product_category_name_english').agg({'min(price)':'min'}).withColumnRenamed('min(min(price))','Price').withColumnRenamed('product_category_name_english','Product_Name')\nproduct_priced.orderBy('Price',ascending=True).show()\n\n\nminmax = item_df.groupBy('product_id').agg({'price':'max'})\nproduct_priced = minmax.join(products_df,['product_id'])\nproduct_priced = product_priced.join(translation_df,['product_category_name'])\nproduct_priced = product_priced.groupBy('product_category_name_english').agg({'max(price)':'max'}).withColumnRenamed('max(max(price))','Price').withColumnRenamed('product_category_name_english','Product_Name')\nproduct_priced.orderBy('Price',ascending=False).show()","59067d50":"Return = orders_df.filter(orders_df.order_status=='delivered')\nLoyalty = Return.join(item_df,['order_id']).drop(*('order_status','order_purchase_timestamp','order_approved_at','order_delivered_carrier_date','order_delivered_customer_date','order_estimated_delivery_date','shipping_limit_date','price','freight_value'))\nLoyalty = Loyalty.groupBy('Customer_id').count().withColumnRenamed('count','total_product_buy')\nprint(\"The Most Valuable Customer is: \",Loyalty.orderBy('total_product_buy').tail(1))\nLoyalty.orderBy('total_product_buy',ascending=False).show()","dcb1bf45":"no_orders = orders_df.filter((orders_df.order_status !='canceled') & (orders_df.order_status !='unavailable'))\nno_orders = no_orders.join(item_df,['order_id']).drop(*('order_status','order_purchase_timestamp','order_approved_at','order_delivered_carrier_date','order_delivered_customer_date','order_estimated_delivery_date','shipping_limit_date','price','freight_value'))\nno_orders = no_orders.groupBy('customer_id').count()\nno_orders = no_orders.groupby('customer_id').sum('count').orderBy('sum(count)',ascending=False).withColumnRenamed('sum(count)',\"Total_orders\")\nno_orders_no_customers = no_orders.agg({'customer_id':'count','Total_orders':'sum'}).withColumnRenamed('sum(Total_orders)','Total_orders').withColumnRenamed(\"count(customer_id)\",'Total_customer').show()","72d59594":"month_yr = orders_df.withColumn('Month_year',date_format('order_purchase_timestamp','M')).withColumn('Year',year('order_purchase_timestamp'))\nmonth_yr = month_yr.select('order_id','customer_id','Month_year','Year',concat(col('year'),lit('-'),trim(col('Month_year'))).alias('MY')).select('order_id','MY').withColumn('MY',to_date('MY'))\nmonth_yr = month_yr.join(item_df,['order_id'])","b762c1f5":"Analysis = month_yr.drop('order_item_id').withColumn('Total_Price',month_yr['price']+month_yr['freight_value'])\nAnalysis = Analysis.groupBy('MY').agg({'order_id':'count','price':'sum','freight_value':'sum','Total_Price':'sum'})\nAnalysis = Analysis.withColumn('price_per_product',Analysis['sum(Total_price)']\/Analysis['count(order_id)']).withColumn('freight_per_product',Analysis['sum(freight_value)']\/Analysis['count(order_id)']).withColumnRenamed('sum(Total_price)','Total_price').withColumnRenamed('count(order_id)','Order_id').withColumnRenamed('sum(freight_value)','freight_value').withColumnRenamed('sum(price)','price').orderBy('MY',ascending=True)           \nAnalysis = Analysis.withColumn(\"Year\",year('MY')).withColumn('price',Analysis.price.cast('int'))","1014acfd":"from plotly.subplots import make_subplots\nimport plotly.graph_objects as go\n\nAnalysis_80_20 = Analysis.filter(Analysis['Year']==2017)                                        \nlist_date_a = Analysis_80_20.select('MY').rdd.flatMap(lambda x:x).collect()\nlist_date_count_a = Analysis_80_20.select('price').rdd.flatMap(lambda x:x).collect()\nlist_orders = Analysis_80_20.select('order_id').rdd.flatMap(lambda x:x).collect()\n\n\nfig = go.Figure()\nfig = make_subplots(specs=[[{'secondary_y':True}]])\nfig.add_trace(\n    go.Scatter(\n        x = [str(x) for x in list_date_a],\n        y = [x for x in list_date_count_a],\n        name='Price',\n        text = [x for x in list_date_count_a],\n        \n    ),secondary_y=False,)\nfig.add_trace(\n    go.Bar(\n        x = [str(x) for x in list_date_a],\n        y = [x for x in list_orders],\n        name='order',\n        text = [x for x in list_orders]\n        \n    ),\n    secondary_y=True,\n)\nfig.update_layout(\n    autosize=False,\n    width = 1000,\n    height = 500,\n    title = 'Orders and Price',\n    xaxis_title = ' Year-Month',\n    yaxis_title = 'Price'\n\n)\nfig.update_yaxes(automargin=True,title_text='Product count',secondary_y=True)\nfig.show()","a019c68e":"Shipment_Aging = orders_df_filter.join(item_df,['order_id']).join(products_df,['product_id']).join(translation_df,['product_category_name'])\nShipment_Aging = Shipment_Aging.withColumn('Shipment_Aging_days',datediff('order_delivered_carrier_date','order_approved_at')).select('product_category_name_english','order_id','customer_id','seller_id','Shipment_Aging_days')\nShipment_Aging.sample(0.001).show()","5ca2dc76":"Most Reviewed Product","17ebcf7c":"Total Number Of Customers By Region","9b637ed6":"**Top Selling Product**","3976a61d":"80-20 Analysis of Product vs Sales\/Profit","8f38164b":"Most Valued Customer and Salesman","0900532f":"Shipment Aging of Each Order","fc6358ac":"Min and Max Priced Products","e8dafd28":"Total Orders by Product Category","370d174b":"Revenue Generated Annually","c0256ff8":"**Total Revenue generated between dd\/mm\/yyyy to dd\/mm\/yyyy**","357adbb8":"Number of Orders and Number of Customers","62564193":"Product Sale Over Time","228f68ea":"**E-Commerce_Analysis_PySpark**","a754db37":"Total Order By Regions\/Cities","88c00e32":"Returning Customer to Understand Customer Loyalty"}}