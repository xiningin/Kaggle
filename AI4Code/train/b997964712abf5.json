{"cell_type":{"16847c43":"code","312b7f0a":"code","7d8e3139":"code","d5771ca8":"code","969987c3":"code","2a6bbe21":"code","79bddca7":"code","45fe40ba":"code","c4ede046":"code","4c8c42fe":"code","bf4e8f2f":"code","40ab0774":"code","9535c4ed":"code","a3496f6d":"code","5cb50831":"code","abd5d593":"code","567efd40":"code","9b2ecff0":"code","6cbcc5c9":"code","a4f8c35a":"code","6cefdbb7":"code","62b7b3d3":"code","4322d5aa":"code","c61b7889":"code","29938277":"code","c1b93bd4":"code","78d27df9":"code","252f083f":"code","982bf553":"code","6a41205c":"code","ba63bd47":"code","dcefdf5a":"code","f14bd682":"code","9f01e6df":"code","98263b6c":"code","671c8b3d":"code","aef7cfae":"code","15e84a14":"code","78e9313e":"code","459d4c9f":"code","288f1c83":"code","21d4a214":"code","19011e98":"code","8b41d1f0":"code","c50640a0":"code","9d80da0f":"code","de50a8e3":"code","e6c8cfb2":"code","8c6eff17":"code","92e72e44":"code","46558d8c":"code","6f5aa946":"code","5322fa18":"code","af98f6f0":"code","8bdda73b":"code","ed33a172":"code","90cb644a":"code","184a4ab8":"code","01035d6c":"code","1491c59a":"code","ab4c6595":"code","9d522690":"code","33cc7335":"code","655bf4a6":"code","938e6c6f":"code","2b0196af":"code","cca97185":"code","267ea05a":"code","ceb0fb83":"code","a36440db":"code","645ca52c":"code","909927f1":"code","111d052b":"code","1751f9a7":"code","f94bbb6f":"code","d34fd0fa":"code","09200ac3":"code","100f3f8e":"code","7cc602e7":"code","6a07593d":"code","e8a8cd90":"code","3d4d8d36":"code","9e1141ba":"code","41e2a2f0":"code","0e6dad39":"code","2239f1b8":"code","b60e2716":"code","e55c38f8":"code","0e6a216d":"code","869eed10":"code","c873f31b":"code","ccd36af0":"code","e2e6e903":"code","a556032b":"code","7a843b1e":"code","5a70b8cc":"code","96683888":"code","c738307e":"code","0e669c52":"code","1f31ed86":"code","b4550539":"code","6f319959":"code","ae88f7f5":"code","6b4ad05d":"code","ed68f5ea":"code","b95219ca":"code","14a7d81d":"code","d38b93d1":"code","54ebe3e1":"code","c09d4a5c":"code","e6b10c9f":"code","ccec2134":"code","f0aeca49":"code","23772896":"code","0420070b":"code","4ad1ce79":"code","e03811bf":"code","14782b4e":"code","8f2e6db9":"code","e1f37d8d":"code","48b05893":"code","60ea79c9":"code","d1ef2364":"code","c5c60066":"code","5c747c47":"code","b79330ac":"code","d72d5d1f":"code","c58ecdbe":"code","77e2270a":"code","d9c9f840":"code","7121559e":"code","cd453771":"code","cec78e32":"code","7e1d92f6":"code","9d36d607":"code","a584d3e5":"code","b525ffb2":"code","2c42d6de":"code","be9c2edb":"code","43d30777":"code","b5830b2c":"code","051ad9c0":"code","93a7eaa8":"code","1bbd6af2":"code","11036a32":"code","5b593f56":"code","b96fd67c":"code","94376c5d":"code","cac6e361":"code","0e20cc90":"code","263f16df":"code","26884aaa":"code","5c4fcd73":"code","0a6efb7a":"code","5e0436a4":"code","9d6a8229":"code","f0d52131":"code","688c3e36":"code","4a9de6f5":"code","a7416bd8":"code","90d5cd7b":"code","7c2b02f0":"code","190de806":"code","c0dbafc0":"markdown","9d87560b":"markdown","bc9c792d":"markdown","ea046191":"markdown","66e7b47f":"markdown","f708c7eb":"markdown","efe9d5df":"markdown","2340524b":"markdown","ea430b2f":"markdown","d41650e0":"markdown","31c15426":"markdown","d40b8fb4":"markdown","fbb32d53":"markdown","9b9bd32f":"markdown","325f7654":"markdown","3f3b77d4":"markdown","6169db14":"markdown","7e9a33fb":"markdown","0c0521d3":"markdown","488594d0":"markdown","42e86c4f":"markdown","4261748f":"markdown","1dd8b8ec":"markdown","af6b4198":"markdown","e1a36a9c":"markdown","d2b95bda":"markdown","cd0658df":"markdown","5ddbeb3e":"markdown","abd3459a":"markdown","e8e5146e":"markdown","0b8d35ae":"markdown","70367db3":"markdown","52b0a58f":"markdown","d5619cd8":"markdown","fb0f4c75":"markdown","b8fee37a":"markdown","5bb22b45":"markdown","2f2fd165":"markdown","c59363be":"markdown","7180f080":"markdown","07d91abc":"markdown","a3bfdbaf":"markdown","f0b5953e":"markdown","969e5080":"markdown","e42f4e2f":"markdown","13053869":"markdown","fb2b7b8a":"markdown","18cee679":"markdown","e1c6d06d":"markdown","9ea5e1ff":"markdown","f6fd78eb":"markdown","d877d493":"markdown","22b5abe2":"markdown","e8e277ad":"markdown","2174efb4":"markdown","6e3231ee":"markdown","b6e6b4ee":"markdown","14be730a":"markdown","a0a57c33":"markdown","9487f58b":"markdown","a3669df7":"markdown","54cf8494":"markdown","d8699614":"markdown","9432ebae":"markdown","c78d6be3":"markdown","dfdfb3e9":"markdown","04fdc345":"markdown","43fd9ac1":"markdown","9789d60c":"markdown","550d0aa8":"markdown","484147ea":"markdown","6f6e4e91":"markdown","4b45ea01":"markdown","343195b2":"markdown","1bd04019":"markdown","957662a7":"markdown","e6280fd3":"markdown","364148fc":"markdown","a630b62d":"markdown","b576fe8d":"markdown","f6d998c1":"markdown","32733704":"markdown","415bb0d8":"markdown","eb9790c5":"markdown","c8c31c17":"markdown","19e9573c":"markdown","06f51643":"markdown","e0198870":"markdown","9117ee5d":"markdown","25e5f45f":"markdown","b70df5df":"markdown","00822524":"markdown","1330a95d":"markdown","d2f82272":"markdown","fadbca63":"markdown","0ea3f23c":"markdown","6a931514":"markdown","cee117ce":"markdown","288ee3dc":"markdown","80fa5e0f":"markdown","cb4564e3":"markdown","5bde0b47":"markdown","614bdff2":"markdown","d0d13f99":"markdown","4484995b":"markdown","4a8c39ae":"markdown","3a0492be":"markdown","fca9d3dd":"markdown","7f6a5e61":"markdown","7137b801":"markdown","901696b0":"markdown","5d1747f4":"markdown","91369684":"markdown","b15e4b73":"markdown","6b6d8605":"markdown","8dc9e4be":"markdown","0aaa0e90":"markdown","051528ec":"markdown","47aa25d2":"markdown","e0155dcc":"markdown","7add73ae":"markdown","ab77840c":"markdown","6a306065":"markdown","5de96998":"markdown","3836276a":"markdown","5c2a027f":"markdown","965bb8f6":"markdown","01042ff3":"markdown","3f6d6181":"markdown","89d14d2d":"markdown"},"source":{"16847c43":"!pip install textdistance","312b7f0a":"import numpy as np\nimport pandas as pd\nimport matplotlib.pyplot as plt\nimport seaborn as sns\nimport gc\nfrom itertools import product\nimport textdistance\nfrom xgboost import XGBRegressor\nfrom xgboost import plot_importance\nfrom datetime import datetime, date\nfrom sklearn.linear_model import LinearRegression\nfrom sklearn.ensemble import RandomForestRegressor\n\n%matplotlib inline","7d8e3139":"# downcast \ndef downcast(df):\n    df_dtypes = df.dtypes\n    new_dtypes = []\n    for idx, col_dtype in enumerate(df_dtypes):\n        if col_dtype == \"float64\":\n            new_dtypes.append(np.float16)\n        elif col_dtype in [\"int64\", \"int32\", \"int16\"]:\n            if df[df.columns[idx]].min() >= -128 and df[df.columns[idx]].max() <= 127:\n                new_dtypes.append(np.int8)\n            elif df[df.columns[idx]].min() >= -32768 and df[df.columns[idx]].max() <= 32767:\n                new_dtypes.append(np.int16)\n            elif df[df.columns[idx]].min() >= -2147483648  and df[df.columns[idx]].max() <= 2147483647:\n                new_dtypes.append(np.int32)\n            else:\n                new_dtypes.append(np.int64)\n        else:\n            new_dtypes.append(col_dtype)\n            \n    return df.astype(dict(zip(df.columns,new_dtypes)))","d5771ca8":"# load data\ntrain = pd.read_csv('..\/input\/competitive-data-science-predict-future-sales\/sales_train.csv')\ntest = pd.read_csv('..\/input\/competitive-data-science-predict-future-sales\/test.csv')\nitems = pd.read_csv('..\/input\/competitive-data-science-predict-future-sales\/items.csv')\n\n# item_categories = pd.read_csv('..\/input\/competitive-data-science-predict-future-sales\/item_categories.csv')\n# shops = pd.read_csv('..\/input\/competitive-data-science-predict-future-sales\/shops.csv')\n\nitem_categories = pd.read_pickle('..\/input\/translated\/item_categories.pkl')\nshops = pd.read_pickle('..\/input\/translated\/shops.pkl')","969987c3":"pd.options.display.precision = 6\npd.options.display.float_format = '{:.2f}'.format","2a6bbe21":"# check\nprint(\"-----------------train-------------------------\")\ntrain.info()\nprint(train.head())\nprint(train.describe())","79bddca7":"# check\nprint(\"-----------------test-------------------------\")\ntest.info()\nprint(test.head())\nprint(test.describe())","45fe40ba":"# check\nprint(\"-----------------item_categories-------------------------\")\nitem_categories.info()\nprint(item_categories.head())\nprint(item_categories.describe())","c4ede046":"# check\nprint(\"-----------------items-------------------------\")\nitems.info()\nprint(items.head())\nprint(items.describe())","4c8c42fe":"# check\nprint(\"-----------------shops-------------------------\")\nshops.info()\nprint(shops.head())\nprint(shops.describe())","bf4e8f2f":"# check duplicated rows\nprint(train.duplicated().count())\n\n# delete duplicated rows\ntrain = train[~train.duplicated()]\ntrain.info()","40ab0774":"# plot\n#date_block_num \n\ntrain[\"date_block_num\"].value_counts(normalize=True).sort_index().plot(kind=\"bar\", figsize = (15,5))\n\n# 11 and 23 have a large number of sales","9535c4ed":"#shop_id   \n\ntrain[\"shop_id\"].value_counts(normalize=True).plot(kind=\"bar\", figsize = (15,5))\n\n# Some shops have a large number of sales, ","a3496f6d":"#item_id     \n\ntrain[\"item_id\"].plot(kind=\"hist\", figsize = (15,5))\n\n# The distribution is not even. Some items seem to have more sales than others.","5cb50831":"plt.figure(figsize=(15,5))\nsns.boxplot(train[\"item_id\"].value_counts())\n","abd5d593":"#item_price     \n\ntrain[\"item_price\"].plot(kind=\"hist\", figsize = (15,5))\n\n# Maybe there are outliers","567efd40":"train[\"item_id\"].value_counts().plot(kind=\"hist\", figsize = (15,5))","9b2ecff0":"#item_cnt_day      \n\ntrain[\"item_cnt_day\"].plot(kind=\"hist\", figsize = (15,5))\n\n# Maybe there are outliers","6cbcc5c9":"train[\"item_id\"].value_counts().plot(kind=\"hist\", figsize = (15,5))","a4f8c35a":"train[\"item_id\"].value_counts().sort_values(ascending=False)[:10]","6cefdbb7":"#shop_id   \n\nplt.figure(figsize=(15,5))\nsns.boxplot(train[\"shop_id\"].value_counts(normalize=True))","62b7b3d3":"train[\"shop_id\"].value_counts(normalize=True).sort_values(ascending=False)[:10]\n\n","4322d5aa":"train[\"item_id\"].value_counts().sort_values(ascending=False)[:10]\n","c61b7889":"items.loc[items[\"item_id\"]==20949]","29938277":"item_categories.loc[item_categories[\"item_category_id\"]==71]","c1b93bd4":"train.loc[train[\"item_id\"]==20949][\"date_block_num\"].value_counts(normalize=True).sort_index().plot(kind=\"bar\", figsize = (15,5))","78d27df9":"#item_price     \nplt.figure(figsize=(15,5))\nsns.boxplot(train[\"item_price\"])","252f083f":"train[\"item_price\"].sort_values(ascending=False)[:10]","982bf553":"train[train['item_price'] == 307980]","6a41205c":"items.loc[items[\"item_id\"]==6066]","ba63bd47":"item_categories.loc[item_categories[\"item_category_id\"]==75]","dcefdf5a":"test[test[\"item_id\"]==6066].empty","f14bd682":"train = train[train[\"item_id\"] != 6066]\ntrain.info()","9f01e6df":"train[train['item_price'] < 0]","98263b6c":"items.loc[items[\"item_id\"]==2978]","671c8b3d":"item_categories.loc[item_categories[\"item_category_id\"]==31]","aef7cfae":"train = train[train[\"item_id\"] != 2978]","15e84a14":"train[\"item_cnt_day\"].sort_values(ascending=False)[:10]","78e9313e":"train[train[\"item_cnt_day\"] > 999]","459d4c9f":"items.loc[items[\"item_id\"]==11373]","288f1c83":"item_categories.loc[item_categories[\"item_category_id\"]==9]","21d4a214":"\nplt.figure(figsize=(15,5))\nsns.boxplot(train[train[\"item_id\"]==11373][\"item_cnt_day\"])","19011e98":"train[train[\"item_id\"]==11373][\"item_cnt_day\"].sort_values(ascending=False)[:10]","8b41d1f0":"\ntrain = train[train[\"item_cnt_day\"] < 1000]","c50640a0":"# check duplicated rows\nprint(test[[\"shop_id\", \"item_id\"]].duplicated().sum())","9d80da0f":"test[\"shop_id\"].value_counts().sort_index().plot(kind=\"bar\", figsize = (15,5))","de50a8e3":"test[\"shop_id\"].value_counts().sort_values()[:10]\n","e6c8cfb2":"test[\"shop_id\"].value_counts().sort_values()[-5:]","8c6eff17":"plt.figure(figsize=(15,5))\nsns.boxplot(test[\"item_id\"].value_counts())","92e72e44":"test[\"item_id\"].value_counts().sort_values()[:10]","46558d8c":"test[\"item_id\"].value_counts().sort_values()[-10:]","6f5aa946":"mat = np.zeros((shops.shape[0], shops.shape[0]))","5322fa18":"for row in range(shops.shape[0]):\n    for col in range(shops.shape[0]):\n        mat[row, col] = textdistance.levenshtein.normalized_similarity(shops[\"shop_name\"][row], shops[\"shop_name\"][col])\n# if 1 set as 0\nmat = np.where(mat == 1 , 0, mat)","af98f6f0":"plt.figure(figsize=(15,15))\nsns.heatmap(mat, vmin = 0.7, xticklabels = 1, yticklabels = 1)","8bdda73b":"# 0.7 as threshold\nshop_name_duplicated = pd.DataFrame(np.transpose(np.nonzero(np.where(mat > 0.7, mat, 0))))\nshop_name_duplicated = shop_name_duplicated[~shop_name_duplicated.apply(frozenset, axis=1).duplicated()].reset_index(drop=True)\nprint(shop_name_duplicated)","ed33a172":"for index, row in shop_name_duplicated.iterrows():\n    print(\"shop_id:\", row[0], \"shop_name:\", shops.loc[shops[\"shop_id\"] == row[0], \"shop_name\"].values[0])\n    print(\"shop_id:\", row[1], \"shop_name:\", shops.loc[shops[\"shop_id\"] == row[1], \"shop_name\"].values[0])\n    print()","90cb644a":"\nfig, ((ax0,ax1), (ax2,ax3), (ax4,ax5), (ax6,ax7)) = plt.subplots(4, 2, figsize=(15, 20))\n\nfor index, row in shop_name_duplicated.iterrows():\n    data = train[[\"date_block_num\", \"item_cnt_day\", \"shop_id\"]].query('shop_id == @row[0] or shop_id == @row[1]')\\\n        .groupby([\"shop_id\", \"date_block_num\"]).sum().reset_index()\n    sns.lineplot(x=\"date_block_num\", y=\"item_cnt_day\", hue=\"shop_id\", legend = \"full\", data=data, ax=eval(\"ax\" + str(index)),  palette = [\"Blue\", \"Green\"])\n\nplt.show()","184a4ab8":"test[test.isin({\"shop_id\":[0,57,1,58,10,11,23,24]})[\"shop_id\"]][\"shop_id\"].drop_duplicates()","01035d6c":"train.loc[train[\"shop_id\"]==10].describe()","1491c59a":"train.loc[train[\"shop_id\"]==11].describe()","ab4c6595":"# plot \nplt.figure(figsize=(15,5))\nsns.countplot(x=\"date_block_num\", hue=\"shop_id\", data = train.query('shop_id == [10, 11]'))\nplt.show()","9d522690":"train.loc[train[\"shop_id\"]== 0, \"shop_id\"] = 57\ntest.loc[test[\"shop_id\"]== 0, \"shop_id\"] = 57\n\ntrain.loc[train[\"shop_id\"]== 1, \"shop_id\"] = 58\ntest.loc[test[\"shop_id\"]== 1, \"shop_id\"] = 58\n\ntrain.loc[train[\"shop_id\"]== 23, \"shop_id\"] = 24\ntest.loc[test[\"shop_id\"]== 23, \"shop_id\"] = 24\n\ntrain.loc[train[\"shop_id\"]== 11, \"shop_id\"] = 10\ntest.loc[test[\"shop_id\"]== 11, \"shop_id\"] = 10","33cc7335":"print(\"shop_id:\", \"train:\" , len(train[\"shop_id\"].unique()), \"test:\", len(test[\"shop_id\"].unique()))\nprint(\"item_id:\", \"train:\" , len(train[\"item_id\"].unique()), \"test:\", len(test[\"item_id\"].unique()))","655bf4a6":"train_comb = train[[\"shop_id\", \"item_id\"]].drop_duplicates()\nprint(train_comb)","938e6c6f":"test_comb = test[[\"shop_id\", \"item_id\"]].drop_duplicates()\nprint(test_comb)","2b0196af":"unseen_shops = test_comb.shop_id[~test_comb[\"shop_id\"].isin(train_comb[\"shop_id\"])].drop_duplicates()\nunseen_items = test_comb.item_id[~test_comb[\"item_id\"].isin(train_comb[\"item_id\"])].drop_duplicates()\nprint(\"In the test set:\", unseen_shops.count(), \"unseen shops\",\"and\", unseen_items.count(), \"unseen items\")","cca97185":"len(test[\"item_id\"].unique()) - unseen_items.count()","267ea05a":"unseen_combs = []\nseen_others = []\nfor shop in test_comb[\"shop_id\"].unique():\n    test_items = test_comb.loc[test_comb[\"shop_id\"] == shop, [\"item_id\"]].values.reshape(-1)\n    # in the same shop\n    train_items = train_comb.loc[train_comb[\"shop_id\"] == shop, [\"item_id\"]].values.reshape(-1)\n    # but in other shops (maybe overlapped)\n    train_items_others = train_comb.loc[train_comb[\"shop_id\"] != shop, [\"item_id\"]].values.reshape(-1)\n    for item in test_items:\n        if item not in train_items:\n           unseen_combs.append((shop, item))","ceb0fb83":"unseen_combs_df = pd.DataFrame(unseen_combs, columns=[\"shop_id\", \"item_id\"])\nunseen_combs_df.info()","a36440db":"unseen_comb_items = unseen_combs_df[\"item_id\"].unique()\nlen(unseen_comb_items)","645ca52c":"214200 - 102697","909927f1":"102697-363*42","111d052b":"seen_combs = []\nfor shop in test_comb[\"shop_id\"].unique():\n    test_items = test_comb.loc[test_comb[\"shop_id\"] == shop, [\"item_id\"]].values.reshape(-1)\n    # in the same shop\n    train_items = train_comb.loc[train_comb[\"shop_id\"] == shop, [\"item_id\"]].values.reshape(-1)\n    for item in test_items:\n        if item in train_items:\n           seen_combs.append((shop, item))","1751f9a7":"print(len(seen_combs))","f94bbb6f":"last_months_shops_sales = train.query('date_block_num > 27').groupby(\"shop_id\")[\"item_cnt_day\"].sum()\n\nprint(last_months_shops_sales > 0) ","d34fd0fa":"last_months_sales_shops = last_months_shops_sales.index.tolist()","09200ac3":"no_sales_shops = []\nfor shop in test[\"shop_id\"].unique():\n    if shop not in last_months_sales_shops:\n        no_sales_shops.append(shop)\nprint(no_sales_shops)","100f3f8e":"last_months_items_sales = train.query('date_block_num > 27').groupby(\"item_id\")[\"item_cnt_day\"].sum()\nlast_months_items_sales = last_months_items_sales[last_months_items_sales > 0]\nprint(last_months_items_sales) ","7cc602e7":"last_months_sales_items = last_months_items_sales.index.tolist()","6a07593d":"no_sales_items = []\nfor item in test[\"item_id\"].unique():\n    if item not in last_months_sales_items:\n        no_sales_items.append(item)\nprint(no_sales_items)","e8a8cd90":"len(no_sales_items)","3d4d8d36":"len(set(no_sales_items) & set(unseen_items))","9e1141ba":"outdated_items = list(set(no_sales_items) - set(unseen_items))\nlen(outdated_items)","41e2a2f0":"outdated_combs = []\nfor shop in test_comb[\"shop_id\"].unique():\n    test_items = test_comb.loc[test_comb[\"shop_id\"] == shop, [\"item_id\"]].values.reshape(-1)\n    for item in outdated_items:\n        if item in test_items:\n           outdated_combs.append((shop, item))","0e6dad39":"len(outdated_combs)                    ","2239f1b8":"item_categories.info()\nprint(item_categories.head())\nprint(item_categories.item_category_name.unique())","b60e2716":"# split\nno_split = item_categories.item_category_name.str.split(\" \", expand=True, n = 2)\n\n# replace hyphen and None as \"\"\nno_split = no_split.fillna(\"\").apply(lambda x: x.replace(\"-\", \"\"))\nno_split[0] = no_split[0] + \" \" + no_split[1]\n\n# create item category df\nitem_category_df = no_split.drop(columns = 1)\nitem_category_df.columns = [\"big_category_name\", \"sub_category_name\"]\n\n# item_category_df big_category_name column\nbig_category_name = item_category_df.big_category_name.str.strip()\n\n# item_category_df sub_category_name column\nsub_category_name = item_category_df.sub_category_name.apply(lambda x: x.replace(\"-\", \"\")).str.strip()\n\nitem_category_df[\"big_category_name\"] = big_category_name\nitem_category_df[\"sub_category_name\"] = sub_category_name\n\n# item category encoding\nitem_category_df[\"big_category_id\"] = item_category_df.big_category_name.astype(\"category\").cat.codes.to_frame(name = \"big_category_id\")\nitem_category_df[\"sub_category_id\"] = item_category_df.sub_category_name.astype(\"category\").cat.codes.to_frame(name = \"sub_category_id\")\n\n# join to item_categories\nitem_categories = item_categories.join(item_category_df)\nprint(item_categories)\nitem_categories = downcast(item_categories)\n\ndel no_split\ndel item_category_df","e55c38f8":"print(\"items\")\nitems.info()\nprint(items.head())\nprint(items.item_name.unique())","0e6a216d":"print(\"shops\")\nshops.info()\nprint(shops.head())\nprint(shops.shop_name.unique())","869eed10":"# split\nsplit = shops.shop_name\n\n# delete \nsplit = split.apply(lambda x:x.replace(\"!\", \"\"))\n#print(split)\n\n# some names seem to be repeated\n\n# with out split \nwithout_split = split.str.split(expand=True)\n#print(without_split)\n\n# city name correction for index 34 35 42 43 and 46 \nto_correct = without_split.iloc[[34, 35, 42, 43, 46]].drop(columns = [3,4,5,6,7])\nto_correct[0] = to_correct[0] + \" \" + to_correct[1]\nto_correct[1] = to_correct[2]\nto_correct.drop(columns = 2, inplace=True)\n\nwithout_split_new = without_split.drop(index= [34, 35, 42, 43, 46]).drop(columns = [2,3,4,5,6,7])\nwithout_split_new = to_correct.join(without_split_new, how=\"outer\", rsuffix=\"_\").fillna(\"\")\n\nwithout_split_new[\"0\"] = without_split_new[\"0\"] + without_split_new[\"0_\"]\nwithout_split_new[\"1\"] = without_split_new[\"1\"] + without_split_new[\"1_\"]\nwithout_split_new.drop(columns = [\"0_\",\"1_\"], inplace=True)\nwithout_split_new.columns = [\"city_name\", \"shop_category_name\"]\nwithout_split_new.city_name = without_split_new.city_name.str.strip()\nwithout_split_new.shop_category_name = without_split_new.shop_category_name.str.strip()\n\n# first column: city name encoding\ncity_name_ids = without_split_new.city_name.astype(\"category\").cat.codes.to_frame(name = \"city_id\")\n# first column: shop category encoding\nshop_category_ids = without_split_new.shop_category_name.astype(\"category\").cat.codes.to_frame(name = \"shop_category_id\")\n\n# create shop_df \nshop_df = without_split_new.join(city_name_ids).join(shop_category_ids)\n\n# and join to shops\nshops = shops.join(shop_df)\nprint(shops)\nshops = downcast(shops)\n\ndel to_correct\ndel shop_df","c873f31b":"\n\n# NA\nprint(\"train\")\nprint(train.isna().sum())\nprint(\"test\")\nprint(test.isna().sum())\nprint(\"item_categories\")\nprint(item_categories.isna().sum())\nprint(\"items\")\nprint(items.isna().sum())\nprint(\"shops\")\nprint(shops.isna().sum())\n\n# Null\nprint(\"train\")\nprint(train.isnull().sum())\nprint(\"test\")\nprint(test.isnull().sum())\nprint(\"item_categories\")\nprint(item_categories.isnull().sum())\nprint(\"items\")\nprint(items.isnull().sum())\nprint(\"shops\")\nprint(shops.isnull().sum())","ccd36af0":"train_extended = []\nfor i in range(34):\n    sales = train.query('date_block_num == @i')\n    train_extended.append(np.array(list(product([i] ,sales[\"shop_id\"].unique(), sales[\"item_id\"].unique()))))\n\ncols = [\"date_block_num\", \"shop_id\", \"item_id\"]\nprint(train_extended)","e2e6e903":"train_extended = pd.DataFrame(np.vstack(train_extended), columns = cols)","a556032b":"train_extended.info()\nprint(train_extended.describe())","7a843b1e":"train_extended = downcast(train_extended)","5a70b8cc":"# date \n# train[\"date\"] = pd.to_datetime(train[\"date\"], format=\"%d.%m.%Y\")\n# train['year'], train['month'] = train['date'].dt.year, train['date'].dt.month\n\n# revenue\ntrain[\"revenue\"] = train[\"item_price\"] * train[\"item_cnt_day\"] ","96683888":"train_monthly = train.groupby(['date_block_num', \"shop_id\", \"item_id\"], as_index = False)\\\n    .agg({\"item_cnt_day\" : [\"sum\"]})\n\ntrain_monthly.columns = ['date_block_num',\"shop_id\", \"item_id\", \"item_cnt_month\"]\n\ntrain_monthly = downcast(train_monthly)","c738307e":"train_monthly[\"item_cnt_month\"] = train_monthly[\"item_cnt_month\"].clip(0,20)\n\n# add year and month\n# data_monthly = data_monthly.merge(train[['date_block_num',\"year\", \"month\"]].drop_duplicates(), on = 'date_block_num')","0e669c52":"print(train_monthly.describe())","1f31ed86":"train_new = train_extended.merge(train_monthly, on=[\"date_block_num\", \"shop_id\", \"item_id\"], how=\"left\").fillna(0)","b4550539":"train_new = downcast(train_new)\ntrain_new[\"item_cnt_month\"] = train_new[\"item_cnt_month\"].astype(np.int8)","6f319959":"train_new.info()","ae88f7f5":"train_new.describe()","6b4ad05d":"test = test.drop(\"ID\", axis = 1)\ntest.insert(0, \"date_block_num\", 34)","ed68f5ea":"test = downcast(test)","b95219ca":"test.info()","14a7d81d":"train_new = pd.concat([train_new, test], ignore_index=True, sort=False, keys=[\"date_block_num\", \"shop_id\", \"item_id\", \"item_cnt_month\"])\ntrain_new.describe()","d38b93d1":"train_new.fillna(0, inplace=True)","54ebe3e1":"# downcast\ntrain_new = downcast(train_new)","c09d4a5c":"train_new.info()","e6b10c9f":"train_new.describe()","ccec2134":"items_and_item_categories = items.drop(columns=[\"item_name\"])\\\n    .merge(item_categories.drop(columns=[\"item_category_name\", \"big_category_name\", \"sub_category_name\"]))\n\nitems_and_item_categories.info()","f0aeca49":"train_new = train_new.merge(items_and_item_categories, on = [\"item_id\"])\ntest = test.merge(items_and_item_categories, on = [\"item_id\"])","23772896":"train_new = train_new.merge(shops.drop(columns=[\"shop_name\", \"city_name\", \"shop_category_name\"]), on = [\"shop_id\"])\ntest = test.merge(shops.drop(columns=[\"shop_name\", \"city_name\", \"shop_category_name\"]), on = [\"shop_id\"])","0420070b":"train_new.fillna(0, inplace=True)\ntest.fillna(0, inplace=True)","4ad1ce79":"train_new.describe()","e03811bf":"test.describe()","14782b4e":"train_new.info()","8f2e6db9":"test.info()","e1f37d8d":"# use this for lag features\nlags = [1,2,3,6,12]\n\ndef lag_feature(df, lags, col):\n    tmp = df[['date_block_num','shop_id','item_id',col]]\n    for i in lags:\n        shifted = tmp.copy()\n        shifted.columns = ['date_block_num','shop_id','item_id', col+'_lag_'+str(i)]\n        shifted['date_block_num'] += i\n        df = pd.merge(df, shifted, on=['date_block_num','shop_id','item_id'], how='left')\n    return df","48b05893":"# target \ntrain_new = lag_feature(train_new, lags, \"item_cnt_month\")\ntrain_new.fillna(0, inplace=True)\ntrain_new = downcast(train_new)","60ea79c9":"# by date_block_num mean\ngroup = train_new.groupby(\"date_block_num\").agg({\"item_cnt_month\": [\"mean\"]}).reset_index()\ngroup.columns = [\"date_block_num\", \"date_block_item_cnt_mean\"]","d1ef2364":"# merge it to train_new, generate lag 1 feature and drop it as date_block_item_cnt_mean for the test set is all zero\ntrain_new =  train_new.merge(group, on=[\"date_block_num\"])\ntrain_new.fillna(0, inplace=True)","c5c60066":"# lag 1 feature\ntrain_new = lag_feature(train_new, [1], \"date_block_item_cnt_mean\")\ntrain_new.fillna(0, inplace=True)","5c747c47":"train_new.drop(\"date_block_item_cnt_mean\", axis=1, inplace=True)","b79330ac":"# use lags as all shops of the test set appear in the train set\ngroup = train_new.groupby([\"date_block_num\",\"shop_id\"]).agg({\"item_cnt_month\": [\"mean\"]}).reset_index()\ngroup.columns = [\"date_block_num\",\"shop_id\", \"shop_item_cnt_mean\"]\ntrain_new = train_new.merge(group, on=[\"date_block_num\", \"shop_id\"])\ntrain_new = lag_feature(train_new, lags, \"shop_item_cnt_mean\")\ntrain_new.fillna(0, inplace=True)","d72d5d1f":"train_new.drop(\"shop_item_cnt_mean\", axis=1, inplace=True)","c58ecdbe":"# use only lag 1 as there are many unseen items in the test set\ngroup = train_new.groupby([\"date_block_num\",\"item_id\"]).agg({\"item_cnt_month\": [\"mean\"]}).reset_index()\ngroup.columns = [\"date_block_num\",\"item_id\", \"item_item_cnt_mean\"]\ntrain_new = train_new.merge(group, on=[\"date_block_num\", \"item_id\"])\ntrain_new = lag_feature(train_new, [1], \"item_item_cnt_mean\")\ntrain_new.drop(\"item_item_cnt_mean\", axis=1, inplace=True)\ntrain_new.fillna(0, inplace=True)","77e2270a":"# use only lag 1 as there are many unseen items in the test set\ngroup = train_new.groupby([\"date_block_num\",\"item_category_id\"]).agg({\"item_cnt_month\": [\"mean\"]}).reset_index()\ngroup.columns = [\"date_block_num\",\"item_category_id\", \"item_category_item_cnt_mean\"]\ntrain_new = train_new.merge(group, on=[\"date_block_num\", \"item_category_id\"])\ntrain_new = lag_feature(train_new, [1], \"item_category_item_cnt_mean\")\ntrain_new.drop(\"item_category_item_cnt_mean\", axis=1, inplace=True)\ntrain_new.fillna(0, inplace=True)","d9c9f840":"group = train_new.groupby([\"date_block_num\",\"city_id\"]).agg({\"item_cnt_month\": [\"mean\"]}).reset_index()\ngroup.columns = [\"date_block_num\",\"city_id\", \"city_item_cnt_mean\"]\ntrain_new = train_new.merge(group, on=[\"date_block_num\", \"city_id\"])\ntrain_new = lag_feature(train_new, [1], \"city_item_cnt_mean\")\ntrain_new.drop(\"city_item_cnt_mean\", axis=1, inplace=True)\ntrain_new.fillna(0, inplace=True)","7121559e":"group = train_new.groupby([\"date_block_num\",\"big_category_id\"]).agg({\"item_cnt_month\": [\"mean\"]}).reset_index()\ngroup.columns = [\"date_block_num\",\"big_category_id\", \"big_category_item_cnt_mean\"]\ntrain_new = train_new.merge(group, on=[\"date_block_num\", \"big_category_id\"])\ntrain_new = lag_feature(train_new, [1], \"big_category_item_cnt_mean\")\ntrain_new.drop(\"big_category_item_cnt_mean\", axis=1, inplace=True)\ntrain_new.fillna(0, inplace=True)","cd453771":"group = train_new.groupby([\"date_block_num\",\"sub_category_id\"]).agg({\"item_cnt_month\": [\"mean\"]}).reset_index()\ngroup.columns = [\"date_block_num\",\"sub_category_id\", \"sub_category_item_cnt_mean\"]\ntrain_new = train_new.merge(group, on=[\"date_block_num\", \"sub_category_id\"])\ntrain_new = lag_feature(train_new, [1], \"sub_category_item_cnt_mean\")\ntrain_new.drop(\"sub_category_item_cnt_mean\", axis=1, inplace=True)\ntrain_new.fillna(0, inplace=True)","cec78e32":"group = train_new.groupby([\"date_block_num\",\"item_category_id\", \"item_id\"]).agg({\"item_cnt_month\": [\"mean\"]}).reset_index()\ngroup.columns = [\"date_block_num\",\"item_category_id\", \"item_id\", \"item_category_item_item_cnt_mean\"]\ntrain_new = train_new.merge(group, on=[\"date_block_num\",\"item_category_id\", \"item_id\"])\ntrain_new = lag_feature(train_new, lags, \"item_category_item_item_cnt_mean\")\ntrain_new.drop(\"item_category_item_item_cnt_mean\", axis=1, inplace=True)\ntrain_new.fillna(0, inplace=True)","7e1d92f6":"group = train_new.groupby([\"date_block_num\", \"shop_id\", \"item_category_id\"]).agg({\"item_cnt_month\": [\"mean\"]}).reset_index()\ngroup.columns = [\"date_block_num\", \"shop_id\", \"item_category_id\", \"shop_item_category_item_cnt_mean\"]\ntrain_new = train_new.merge(group, on=[\"date_block_num\", \"shop_id\", \"item_category_id\"])\ntrain_new = lag_feature(train_new, lags, \"shop_item_category_item_cnt_mean\")\ntrain_new.drop(\"shop_item_category_item_cnt_mean\", axis=1, inplace=True)\ntrain_new.fillna(0, inplace=True)","9d36d607":"group = train_new.groupby([\"date_block_num\", \"shop_id\", \"big_category_id\"]).agg({\"item_cnt_month\": [\"mean\"]}).reset_index()\ngroup.columns = [\"date_block_num\", \"shop_id\", \"big_category_id\", \"shop_big_category_item_cnt_mean\"]\ntrain_new = train_new.merge(group, on=[\"date_block_num\", \"shop_id\", \"big_category_id\"])\ntrain_new = lag_feature(train_new, [1], \"shop_big_category_item_cnt_mean\")\ntrain_new.drop(\"shop_big_category_item_cnt_mean\", axis=1, inplace=True)\ntrain_new.fillna(0, inplace=True)","a584d3e5":"group = train_new.groupby([\"date_block_num\", \"shop_id\", \"sub_category_id\"]).agg({\"item_cnt_month\": [\"mean\"]}).reset_index()\ngroup.columns = [\"date_block_num\", \"shop_id\", \"sub_category_id\", \"shop_sub_category_item_cnt_mean\"]\ntrain_new = train_new.merge(group, on=[\"date_block_num\", \"shop_id\", \"sub_category_id\"])\ntrain_new = lag_feature(train_new, [1], \"shop_sub_category_item_cnt_mean\")\ntrain_new.drop(\"shop_sub_category_item_cnt_mean\", axis=1, inplace=True)\ntrain_new.fillna(0, inplace=True)","b525ffb2":"print(train_new.describe())\nprint(train_new.info())","2c42d6de":"train_new[\"month\"] = train_new[\"date_block_num\"] % 12","be9c2edb":"# from http:\/\/www.timebie.com\/calendar\/russia2013.php\n\nholidays = [13, 8, 11, 8, 10, 11, 8, 9, 9, 8, 10, 9,\n            12, 8, 10, 4, 11, 10, 8, 10, 8, 8, 12, 8,\n            13, 9, 9, 8, 11, 9, 8, 10, 8, 9, 11]\n\nholidays_dict = dict(zip(list(range(35)), holidays))\n\nprint(holidays_dict)\n\ntrain_new[\"holidays_cnt\"] = train_new[\"date_block_num\"].map(holidays_dict)","43d30777":"# from https:\/\/www.x-rates.com\/average\/?from=RUB&to=USD&amount=1&year=2013\n\nrates = [\n    \n    0.033064, 0.033135, 0.032450, 0.031901, 0.031923, 0.030951, 0.030517, 0.030310, 0.030674, 0.031174, 0.030592, 0.030425,\n    0.029695, 0.028373, 0.027628, 0.028044, 0.028638, 0.029076, 0.028831, 0.027667, 0.026349, 0.024501, 0.021618, 0.017868,\n    0.015704, 0.015517, 0.016594, 0.018804, 0.019731, 0.018311, 0.017496, 0.015301, 0.014936, 0.015841, 0.015365\n    \n]\n\nrates_dict = dict(zip(list(range(35)), rates))\n\ntrain_new[\"dollar_ruble_rate\"] = train_new[\"date_block_num\"].map(rates_dict)","b5830b2c":"days = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31]\n\ndays_dict = dict(zip(list(range(13)), rates))\n\ntrain_new[\"days_cnt\"] = train_new[\"month\"].map(days_dict)","051ad9c0":"test_sort = pd.read_csv('..\/input\/competitive-data-science-predict-future-sales\/test.csv')\ntest_sort.drop(\"ID\", axis=1, inplace = True)\n\n# drop first 6 months\ntrain = downcast(train_new.query('date_block_num < 31 and date_block_num > 5')) # 1 - 30\nval = downcast(train_new.query('date_block_num > 30 and date_block_num < 34')) # 31 - 33\ntest = downcast(test_sort.merge(train_new.query('date_block_num == 34'), on = [\"shop_id\", \"item_id\"], how=\"left\")) # 34","93a7eaa8":"train = downcast(train)\nval = downcast(val)\ntest = downcast(test)","1bbd6af2":"X_train = train.drop(\"item_cnt_month\", axis = 1).reset_index(drop=True)\nX_val = val.drop(\"item_cnt_month\", axis = 1).reset_index(drop=True)\ny_train = train[[\"item_cnt_month\"]].reset_index(drop=True)\ny_val = val[[\"item_cnt_month\"]].reset_index(drop=True)\nX_test = test.drop(\"item_cnt_month\", axis = 1).reset_index(drop=True)","11036a32":"X_train = downcast(X_train)\nX_val = downcast(X_val)\ny_train = downcast(y_train)\ny_val = downcast(y_val)\nX_test = downcast(X_test)","5b593f56":"del train_new\ndel train\ndel test\ndel val\ndel items\ndel shops\ndel item_categories","b96fd67c":"gc.collect()","94376c5d":"xgb_features = ['date_block_num',\n 'shop_id',\n 'item_id',\n 'item_category_id',\n 'big_category_id',\n 'sub_category_id',\n 'city_id',\n 'shop_category_id',\n 'item_cnt_month_lag_1',\n 'item_cnt_month_lag_2',\n 'item_cnt_month_lag_3',\n #'item_cnt_month_lag_6',\n #'item_cnt_month_lag_12',\n 'date_block_item_cnt_mean_lag_1',\n 'shop_item_cnt_mean_lag_1',\n 'shop_item_cnt_mean_lag_2',\n 'shop_item_cnt_mean_lag_3',\n #'shop_item_cnt_mean_lag_6',\n #'shop_item_cnt_mean_lag_12',\n 'item_item_cnt_mean_lag_1',\n 'item_category_item_cnt_mean_lag_1',\n # 'city_item_cnt_mean_lag_1',\n 'big_category_item_cnt_mean_lag_1',\n 'sub_category_item_cnt_mean_lag_1',\n 'shop_category_item_cnt_mean_lag_1',\n 'item_category_item_item_cnt_mean_lag_1',\n 'item_category_item_item_cnt_mean_lag_2',\n#  'item_category_item_item_cnt_mean_lag_3',\n #'item_category_item_item_cnt_mean_lag_6',\n #'item_category_item_item_cnt_mean_lag_12',\n 'shop_item_category_item_cnt_mean_lag_1',\n 'shop_item_category_item_cnt_mean_lag_2',\n#  'shop_item_category_item_cnt_mean_lag_3',\n #'shop_item_category_item_cnt_mean_lag_6',\n #'shop_item_category_item_cnt_mean_lag_12',\n 'shop_big_category_item_cnt_mean_lag_1',\n 'shop_sub_category_item_cnt_mean_lag_1',\n # 'shop_category_item_item_cnt_mean_lag_1',\n # 'shop_category_item_category_item_cnt_mean_lag_1',\n #'item_cnt_rolling_min',\n #'item_cnt_rolling_max',\n # 'item_cnt_rolling_mean',\n # 'item_cnt_rolling_std',\n 'month',\n 'holidays_cnt',\n 'dollar_ruble_rate',\n 'days_cnt']","cac6e361":"X_train_xgb = X_train.loc[:, xgb_features]\nX_val_xgb = X_val.loc[:, xgb_features]\nX_test_xgb = X_test.loc[:, xgb_features]","0e20cc90":"X_train_xgb.fillna(0, inplace=True)\nX_val_xgb.fillna(0, inplace=True)\nX_test_xgb.fillna(0, inplace=True)","263f16df":"xgb_model = XGBRegressor(\n    max_depth=8,\n    n_estimators=1000,\n    min_child_weight=400, \n    colsample_bytree=0.6, \n    subsample=0.6, \n    eta=0.2,    \n    seed=0,\n    learning_rate = 0.1,\n    n_jobs=-1)\n\nxgb_model.fit(\n    X_train_xgb, \n    y_train, \n    eval_metric=\"rmse\", \n    eval_set=[(X_train_xgb, y_train), (X_val_xgb, y_val)], \n    verbose=10, \n    early_stopping_rounds = 10)","26884aaa":"xgb_train_pred = xgb_model.predict(X_train_xgb)\nxgb_val_pred = xgb_model.predict(X_val_xgb)\nxgb_test_pred = xgb_model.predict(X_test_xgb)","5c4fcd73":"fig, ax = plt.subplots(figsize=(10, 15))\nplot_importance(xgb_model,ax=ax)","0a6efb7a":"\nrf_features = ['date_block_num',\n 'shop_id',\n 'item_id',\n 'item_category_id',\n 'big_category_id',\n 'sub_category_id',\n 'city_id',\n 'shop_category_id',\n 'item_cnt_month_lag_1',\n 'item_cnt_month_lag_2',\n 'item_cnt_month_lag_3',\n #'item_cnt_month_lag_6',\n #'item_cnt_month_lag_12',\n 'date_block_item_cnt_mean_lag_1',\n 'shop_item_cnt_mean_lag_1',\n 'shop_item_cnt_mean_lag_2',\n # 'shop_item_cnt_mean_lag_3',\n #'shop_item_cnt_mean_lag_6',\n #'shop_item_cnt_mean_lag_12',\n 'item_item_cnt_mean_lag_1',\n 'item_category_item_cnt_mean_lag_1',\n#  'city_item_cnt_mean_lag_1',\n 'big_category_item_cnt_mean_lag_1',\n 'sub_category_item_cnt_mean_lag_1',\n 'shop_category_item_cnt_mean_lag_1',\n 'item_category_item_item_cnt_mean_lag_1',\n # 'item_category_item_item_cnt_mean_lag_2',\n # 'item_category_item_item_cnt_mean_lag_3',\n #'item_category_item_item_cnt_mean_lag_6',\n #'item_category_item_item_cnt_mean_lag_12',\n 'shop_item_category_item_cnt_mean_lag_1',\n 'shop_item_category_item_cnt_mean_lag_2',\n # 'shop_item_category_item_cnt_mean_lag_3',\n #'shop_item_category_item_cnt_mean_lag_6',\n #'shop_item_category_item_cnt_mean_lag_12',\n 'shop_big_category_item_cnt_mean_lag_1',\n 'shop_sub_category_item_cnt_mean_lag_1',\n # 'shop_category_item_item_cnt_mean_lag_1',\n # 'shop_category_item_category_item_cnt_mean_lag_1',\n #'item_cnt_rolling_min',\n #'item_cnt_rolling_max',\n #'item_cnt_rolling_mean',\n #'item_cnt_rolling_std',\n 'month',\n 'holidays_cnt',\n 'dollar_ruble_rate',\n 'days_cnt']","5e0436a4":"X_train_rf = X_train.loc[:, rf_features]\nX_val_rf = X_val.loc[:, rf_features]\nX_test_rf = X_test.loc[:, rf_features]","9d6a8229":"X_train_rf.fillna(0, inplace=True)\nX_val_rf.fillna(0, inplace=True)\nX_test_rf.fillna(0, inplace=True) ","f0d52131":"rf_model = RandomForestRegressor(n_estimators=50, max_depth=7, random_state=0, n_jobs=-1)\nrf_model.fit(X_train_rf, y_train)","688c3e36":"rf_train_pred = rf_model.predict(X_train_rf)\nrf_val_pred = rf_model.predict(X_val_rf)\nrf_test_pred = rf_model.predict(X_test_rf.fillna(0))","4a9de6f5":"first_level = pd.DataFrame(xgb_val_pred, columns=[\"xgb\"])\nfirst_level[\"rf\"] = rf_val_pred\nfirst_level.info()\n\nfirst_level_test = pd.DataFrame(xgb_test_pred, columns=[\"xgb\"])\nfirst_level_test[\"rf\"] = rf_test_pred\nfirst_level_test.info()","a7416bd8":"meta_model = LinearRegression(n_jobs=-1)\nmeta_model.fit(first_level, y_val)","90d5cd7b":"test_prediction = meta_model.predict(first_level_test)","7c2b02f0":"submission = pd.DataFrame(test_prediction, columns=[\"item_cnt_month\"]).clip(0, 20).reset_index()\nsubmission.columns = [\"ID\", \"item_cnt_month\"]\nprint(submission)","190de806":"submission.to_csv(\"submission.csv\", index=False)","c0dbafc0":"## Shop","9d87560b":"date_blok_num and corresponding year\n\n- 0-11 2013\n- 12-23 2014\n- 24-33 2015","bc9c792d":"As other kernel notebooks have shown, I also considered that items which have not sold for the last 6 months are outdated.  \nAnd shops which have no sales for the last 6 months can be considered outdated.","ea046191":"## Shops","66e7b47f":"#### item_id  ","f708c7eb":"How many combinations in the test set have been seen ?","efe9d5df":"But actually 363 never seen items and other items have been seen at least once in another shop.","2340524b":"### target mean by date_block_num, shop_id and sub_category_id","ea430b2f":"create a useful function to reduce data size","d41650e0":"\u0414\u043e\u0441\u0442\u0430\u0432\u043a\u0430 \u0434\u043e \u043f\u0443\u043d\u043a\u0442\u0430 \u0432\u044b\u0434\u0430\u0447\u0438 (Boxberry) seems to be a delivery service.","31c15426":"item_id 20949 seems to make a large number of sales","d40b8fb4":"## Outdated shop\/item","fbb32d53":"Take in account that the distribution of shop sales in uneven","9b9bd32f":"## unique values and combinations","325f7654":"holidays","3f3b77d4":"## Items","6169db14":"number of no_sales_items","7e9a33fb":"### target mean by date_block_num and sub_category_id","0c0521d3":"US Dollar per 1 Russian Ruble Monthly average rate from January 2013 to November 2015","488594d0":"How many items have been seen but not its combination ?","42e86c4f":"As item_categories names are separated by \"-\", split it and generate new columns.  ","4261748f":"The shop 11 might be the shop 10 in the date_block_num 25.","1dd8b8ec":"All shops appeared at least once but there are 15246 never seen items !!","af6b4198":"shop_id correction","e1a36a9c":"102697 out of 24100 combinations have not seen in the train set.","d2b95bda":"The plots show that the following shop's names are cosiderated as the same shop:  \n\n- 0 and 57   \n- 1 and 58  \n- 10 and 11  \n- 23 and 24  ","cd0658df":"What is that ?","5ddbeb3e":"The two lines are overlapped.","abd3459a":"#### item_price ","e8e5146e":"### target mean by date_block_num and big_category_id","0b8d35ae":"interesting all items appear same number 42 times","70367db3":"Delete first 6 months data from train set as lag features are all 0 for these time periods.  \nI did not split the data randomly because of time-based features. For example, some items are outdated.","52b0a58f":"#### shop_id  ","d5619cd8":"Combinations of outdated items in the test set","fb0f4c75":"Apparently there are some outliers.","b8fee37a":"## Import packages","5bb22b45":"Clip target values","2f2fd165":"Delete item_id 6066 from train set","c59363be":"November 2015 corresponds to date_block_num 34.","7180f080":"very interesting that all shops have same number of rows, 5100","07d91abc":"# Preprocessing","a3bfdbaf":"seen combinations","f0b5953e":"for the purpose of dataframe visulization","969e5080":"# Final project","e42f4e2f":"### panda display option","13053869":"## Useful functions","fb2b7b8a":"186 items of the train set seem to be outdated and test set contains these items.\n186*42 = 7812 combinations in the test set","18cee679":"What is that ?","e1c6d06d":"calculate levenshtein distance","9ea5e1ff":"import textdistance to calculate Levenshtein distance","f6fd78eb":"There is no duplicated combinations in the test set.","d877d493":"### target mean by date_block_num and shop_id ","22b5abe2":"# Feature engineering","e8e277ad":"Using vstack and make a dataframe","2174efb4":"Some shops seem to be the same.","6e3231ee":"## target mean by date_block_num ","b6e6b4ee":"## Item categories","14be730a":"The distribution is really even ?","a0a57c33":"As this value is quite extreme, it should be deleted from the train set.","9487f58b":"prediction","a3669df7":"This is a pc game but it is not clear why the price is -1. Maybe an eror. So delete item_id 2978.","54cf8494":"Concatenate ","d8699614":"See the distribution","9432ebae":"The train set is grouped by date_block_num to calculate monthly mean of item_cnt_days.","c78d6be3":"### target mean by date_block_num, shop_id and item_category_id  all","dfdfb3e9":"### test","04fdc345":"## Submission","43fd9ac1":"To correct shop_id in the train and test set, check if the test set contains all these shop_id","9789d60c":"#### outdated items","550d0aa8":"## Train set extension","484147ea":"to dataframe","6f6e4e91":"Except date_block_num 0, 1 and 2, this item has been sold across the entire period. It seems that this item launched on date_block_num 3.   \nIt is something strange that sales decrease towards date_block_num 24. Maybe it is substituted by another item or chaged its price. ","4b45ea01":"number of days","343195b2":"#### shop_id","1bd04019":"seen items","957662a7":"The shop 11 contains only data of date_block_num 25. ","e6280fd3":"# EDA","364148fc":"### Ensemble\nUse linear model","a630b62d":"unseen combinations","b576fe8d":"Merge train_monthly to train_extended","f6d998c1":"## Load data","32733704":"There is no duplicated row in the test set","415bb0d8":"The right way to change shop_id is the following:\n\n- 0 to 57 \n- 1 to 58\n- 23 to 24\n- 11 to 10","eb9790c5":"Because of the kernel capacity, I reduced number of features. Nevertheless, the rmse error does not increase too much.","c8c31c17":"## Data split\n","19e9573c":"## other features","06f51643":"### Random Forest","e0198870":"Compute item_cnt_days of all combinations of shop and item across date_block_num.  \nIf there is not item_cnt_days for a given combination of shop and item a given date_block_num, item_cnt_days as 0 is computed.","9117ee5d":"### Xgboost","25e5f45f":"### target mean by date_block_num and item_category_id","b70df5df":"### Resume before feature engineering\n\n- Items\n    - Never seen 363 items\n    - Seen 4737 items but never sold in a given shop combinations of shop-item no exist\n        - 186 items seem to be outdated as they have not made any sales in the last 6 months\n        - 4551 items have been seen in the last 6 months\n\n- Combinations\n    - Never seen 15246 combinations\n    - 87451 combinations of shop-item no exist, but items have been sold at least once\n    - Seen 111503 combinations of which,\n        - combinations exist in the test set but the item have not seen in the last 6 months (7812 combinations)\n        - combinations exist and have been seen in the last 6 months (111503 - 7812 = 103691 combinations)\n","00822524":"Here, I aslo selected only some features.","1330a95d":"#### plot feature importance","d2f82272":"It can no be translated by googletrans API because of its data size.","fadbca63":"### target mean by date_block_num, item_category_id and item_id  all","0ea3f23c":"downcast","6a931514":"shop_id 10 and 11","cee117ce":"month","288ee3dc":"Add item_categoriees data ","80fa5e0f":"## Shifted features of the target","cb4564e3":"# Train and Test relationships\n\nTo check all possible combinations of shop_id and item_id of the test data appear at least one in the train data ","5bde0b47":"See the distribution","614bdff2":"item_price < 0 is wired. ","d0d13f99":"Radmin 3 - 522 \u043b\u0438\u0446. seems to be a computer software and this item was sold only one day in the entire period with high price.  \nTherefore, it is reasonable to delete this item from the train set.  \nMake sure that the test set does not contain this item","4484995b":"### Outliers in train","4a8c39ae":"## add other data frames","3a0492be":"## monthly sales (respect to item_cnt_days)","fca9d3dd":"## Add test set to the train set","7f6a5e61":"I previously translated shops and item_categories data set by googletrans API.","7137b801":"### target mean by date_block_num and city_id ","901696b0":"### Linear regression","5d1747f4":"# Text analysis: item_categories\/shops","91369684":"#### outdated shops","b15e4b73":"#### item_id\n","6b6d8605":"### target mean by date_block_num and item_id ","8dc9e4be":"plot item_cnt_day of item_id 11373","0aaa0e90":"# Data leakages","051528ec":"## modeling","47aa25d2":"## Train\n","e0155dcc":"### target mean by date_block_num, shop_id and big_category_id","7add73ae":"## Missing values","ab77840c":"calculate revenue","6a306065":"plot of item_cnt_days across the entire period (date_block_num) by pairs of shops","5de96998":"plot item_id 20949 across date_block_num ","3836276a":"Some of no_sales_items are unseen_items","5c2a027f":"Add shops data","965bb8f6":"Same as items_categories, split it and generate new columns, extracting city name and shop catgeory.","01042ff3":"## Delete data","3f6d6181":"#### item_cnt_day","89d14d2d":"Outliers ?"}}