{"cell_type":{"ab10e569":"code","547799a8":"code","6c06255b":"code","7b9b9a33":"code","896881d3":"code","613dcb1f":"code","98b348a1":"code","2d73584f":"code","18644dbd":"markdown","e6810b1c":"markdown"},"source":{"ab10e569":"import os\nimport numpy as np\nimport pandas as pd\nimport matplotlib.pyplot as plt\nimport math # TeKa change \nfrom matplotlib.collections import LineCollection # TeKa change ","547799a8":"book_train_path='..\/input\/optiver-realized-volatility-prediction\/book_train.parquet'\ntrain=pd.read_csv('..\/input\/optiver-realized-volatility-prediction\/train.csv')\n","6c06255b":"def get_volatility(wap_val):\n    s=np.log(wap_val)\n    s=np.diff(s)\n    s=(s**2).sum()\n    s=np.sqrt(s)\n    return s\n\ndef get_volatility_per_minute(row):\n    seconds_in_bucket=np.array(row.seconds_in_bucket)\n    wap=np.array(row.wap)\n    rv=[]\n    \n    for i in np.arange(60, 601, 60): \n        s=i-60; e=i\n        time_idx=np.where(seconds_in_bucket[(seconds_in_bucket>=s) & (seconds_in_bucket<=e)])[0]\n        \n        wap_val=wap[time_idx]\n        if len(wap_val) == 0:\n            rv.append(0)\n            continue\n        rv.append( get_volatility(wap_val)*math.sqrt(10)) # TeKa change \n    return rv\n\ndef get_bucket_volatility():\n    all_df=pd.DataFrame()\n    for i, filepath in enumerate(os.listdir(book_train_path)):\n        if i == 10:\n            break\n        path=os.path.join(book_train_path, filepath)\n        stock_id=int(filepath.split('=')[-1])\n        \n        df=pd.read_parquet(path)\n        df['stock_id']=stock_id\n        df['wap'] = (df['bid_price1'] * df['ask_size1'] + df['ask_price1'] * df['bid_size1'])\n        df['wap'] \/= (df['ask_size1']+df['bid_size1'])\n        \n        \n        \n        df=df.groupby(['stock_id', 'time_id'])[['seconds_in_bucket', 'wap']].agg(list).reset_index()\n        df['min_rv'] = df.apply(get_volatility_per_minute, axis=1)\n        df['bucket_rv']=df['wap'].apply(get_volatility)\n        \n        df=df[['stock_id', 'time_id', 'min_rv', 'bucket_rv']].copy()\n        all_df=pd.concat([all_df, df])\n    return all_df","7b9b9a33":"%%time\nbucket_df=get_bucket_volatility()\nbucket_df=bucket_df.merge(train)\n\nbucket_df.head(10)","896881d3":"def visualize_bucket_volatility(stock_id, time_id):\n    sample_df=bucket_df[(bucket_df.stock_id==stock_id) & (bucket_df.time_id==time_id)].copy()\n    min_rv=sample_df.min_rv.values[0]\n \n    plt.figure(figsize=(10, 5))\n    plt.xlim(0,20)\n    plt.ylim(0,0.01)\n    \n    bucket_rv_t=sample_df.bucket_rv.values[0] # TeKa change \n    target_t=sample_df.target.values[0]  # TeKa change  \n    \n    x = np.linspace(1, 10, 10)\n    y = min_rv\n    plt.plot(x, y, color='b', label='Realized volatility calculated in minutes') # TeKa change \n    l_rv = [(0, bucket_rv_t), (10, bucket_rv_t)]\n    l_t = [(10, target_t), (20, target_t)]\n    lc = LineCollection([l_rv, l_t], color=[\"g\",\"r\"], label=\"Realized volatility calculated afer 10 minutes, Target - realized volatility calculated afer 20 minutes\")\n\n    plt.gca().add_collection(lc)\n    #plt.axhline(y = bucket_rv_t, xmin = 0, xmax = 0.5, color='g', label='Realized volatility calculated afer 10 minutes') # TeKa change \n    #plt.axhline(y = target_t, xmin = 0.5, xmax = 1, color='r', label='Target - realized volatility calculated afer 20 minutes') # TeKa change \n    \n    #plt.legend(loc='lower left')\n    plt.title(\"Stock Id:{} - Time Id:{}\".format(stock_id, time_id))\n    plt.show()","613dcb1f":"bucket_df['rv_diff']=bucket_df['target'] - bucket_df['bucket_rv']\nbucket_df.head()\nbucket_df.tail()","98b348a1":"time_id = 5\n\nsample_time_df=bucket_df[bucket_df.time_id==time_id].copy()\n\nfor i in sample_time_df['stock_id'].to_list():\n    visualize_bucket_volatility(i, time_id)\n    ","2d73584f":"time_id = 32767\n\nsample_time_df=bucket_df[bucket_df.time_id==time_id].copy()\n\nfor i in sample_time_df['stock_id'].to_list():\n    visualize_bucket_volatility(i, time_id)\n    ","18644dbd":"> Lets get the volatility for every 1-min in the bucket.","e6810b1c":"# Introduction \nIn this Notebook is presented comparison of Target and Realized volatility for all available stocks in two chosen time buckets.\n\n_'Target'_ (red line) is volatility for second 10 minutes period in time bucket. \n_'Bucket volatility'_ (green line), is calculated for first period of 10 minutes.\n\nRealized volatility calculated in 1 minutes period (blue line) is rescaled to period 10 minutes\n\nThis  Notebook is based on analysis proposed by **doteeee**\n[link](https:\/\/www.kaggle.com\/narendra\/optiver-realized-volatility-eda)"}}