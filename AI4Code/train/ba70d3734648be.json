{"cell_type":{"2c4960dd":"code","ab6297c7":"code","b942215c":"code","f9447132":"code","a8b84f4c":"code","e3615e2f":"code","6099377f":"code","e9309119":"code","c705294f":"code","62e85468":"code","aa0df006":"code","44f94691":"code","8c1ef61b":"code","d97faf06":"code","63de00ed":"code","989bc129":"code","51ee8340":"code","08b37194":"code","358a5a46":"code","ba737640":"code","18c7f849":"code","cdf05559":"code","1e72de47":"code","d00c1b77":"code","3f72d9a1":"code","129e9918":"code","064c6f07":"code","6e2bcf91":"code","c68b44cc":"code","535ae2a5":"code","18629607":"code","1d81223b":"code","eae65440":"code","7281b070":"code","a30bc6f1":"code","50794e37":"code","a19b4c09":"code","b776bdb2":"code","11b67f63":"code","27599f51":"code","04f664f9":"code","c04d31a4":"code","e8b86670":"code","6f9bbb09":"code","7c6acd1c":"code","16ade57c":"code","36ffaefb":"code","91ff6287":"code","07ada671":"code","05de71f3":"code","8568d0dd":"code","9b5b8a36":"code","e98d36f0":"code","dd09d1ed":"code","b684884a":"code","48b06d70":"code","9fd63fe1":"code","60e595ff":"code","e994e044":"code","5a626b2e":"code","5cd1ef58":"code","7698faab":"code","a7975a3b":"code","fc8dbfa3":"code","0a2cfdd3":"markdown","71495820":"markdown","420bf43e":"markdown","213523ea":"markdown","e2fc0b74":"markdown","948bfe52":"markdown","68ded711":"markdown","d51a3d82":"markdown","750f5ef2":"markdown","496e4203":"markdown","bce8d411":"markdown","c9ea5db5":"markdown","0cb2bad4":"markdown","ccfdb561":"markdown","da59735d":"markdown","0b9ecdea":"markdown","732827f7":"markdown","d027f6e9":"markdown","6bb59c3e":"markdown"},"source":{"2c4960dd":"import numpy as np\nimport pandas as pd\nimport matplotlib.pyplot as plt\nimport seaborn as sns\n%matplotlib inline\nimport warnings\nwarnings.simplefilter('ignore')","ab6297c7":"freezers = pd.read_csv('..\/input\/Temperature_Data.csv')","b942215c":"freezers.head()","f9447132":"#setting the first column as index\nfreezers = freezers.set_index('0')","a8b84f4c":"type(freezers.index[0])","e3615e2f":"#converting index into datetime\nfreezers.index = pd.to_datetime(freezers.index)","6099377f":"type(freezers.index[0])","e9309119":"#freezers.info()","c705294f":"#checking if hours and minute can be retrived through the index\n(freezers.index[1].minute)","62e85468":"#finding out the index at which columns of different sites start\/end to create a seperate dataframe per site \n#to use later for analysis\nindexing = {}\nj=1\nfor i in freezers.columns:\n    #splitting the column names which were of the format - \"Site-1 > Freezer-1\"\n    print(((i.split(\">\")[0]).split(\"-\")[1]),\"-\",j)\n    #key of dictionary \"indexing\" is the site number and the value will be updated with the last column number of the site\n    indexing[((i.split(\">\")[0]).split(\"-\")[1]).strip()] = j\n    j+=1            ","aa0df006":"#the dictionary\nindexing","44f94691":"#creating seperate dataframes per site - can be used to analyse a particular site if needed later\nsite_1_freezers = freezers.iloc[:,0:indexing['1']]\nsite_2_freezers = freezers.iloc[:,indexing['1']:indexing['2']]\nsite_3_freezers = freezers.iloc[:,indexing['2']:indexing['3']]\nsite_4_freezers = freezers.iloc[:,indexing['3']:]","8c1ef61b":"site_4_freezers.head()","d97faf06":"freezers.head()","63de00ed":"#taking all observations at a particular hour and minute of a day\nfreezers_specific_time = freezers[(freezers.index.hour==2)&(freezers.index.minute==12)]","989bc129":"#observations at 2:12:00 for all the 15 days\nfreezers_specific_time","51ee8340":"#variance associated with the filtered values above\n(freezers_specific_time.var())","08b37194":"#variance associated if we take all observations\nfreezers.var()","358a5a46":"#comparing both the variances\ncomparing_variance = pd.DataFrame({'total variance':freezers.var(),'variance at specific time':freezers_specific_time.var()})","ba737640":"comparing_variance['%decrease'] = ((comparing_variance['total variance']-comparing_variance['variance at specific time'])\/comparing_variance['total variance'])*100","18c7f849":"#we find that there is considerable decrease in variance with most of the observations\ncomparing_variance","cdf05559":"#finding list of dates where we have null values in a column. Have taken 'Site-3 > Freezer-15' as an example to test\nindexes_list = freezers['Site-3 > Freezer-15'].index[freezers['Site-3 > Freezer-15'].apply(np.isnan)]","1e72de47":"#number of null values. This should be equal to the length of the indexes_list generated above\nfreezers['Site-3 > Freezer-15'].isna().sum()","d00c1b77":"#661 dates are returned which is indeed the number of missing value for that particular column\nindexes_list","3f72d9a1":"#filling null values across the dataframe\nfor col in freezers.columns:\n    #list of dates where we have null values for a column 'col'\n    indexes_list = freezers[col].index[freezers[col].apply(np.isnan)]    \n    #for one date at a time, filling the null value\n    for date in indexes_list:\n        column_name = col\n        obs_hour = date.hour\n        obs_min = date.minute\n        #list of observations having same hour and minute as the freezer having null value\n        df_hour_min = freezers[(freezers.index.hour==obs_hour)&(freezers.index.minute==obs_min)][column_name]\n        #finding mean of those observations\n        mean_value = df_hour_min.mean()\n        #print(mean_value)\n        #setting the null value as the mean value\n        freezers.ix[date][column_name] = mean_value","129e9918":"freezers.isnull().any()","064c6f07":"#Now finding the operational temperature range of each freezer at each site -\nprint(\"\\n\")\nprint(\"======Operational Temperature Range======\")\nprint(\"\\n\")\nfor col in freezers.columns:\n    print(col,\"- [\",'\\033[1m',freezers[col].min(),\":\",freezers[col].max(),\"\\033[0m\",\"]\")","6e2bcf91":"#Calculating the daily average of door open duration per freezer\nfreezers['Site-4 > Freezer-9'].describe()","c68b44cc":"freezers['Site-1 > Freezer-5'].describe()","535ae2a5":"import plotly\nimport cufflinks as cf\nfrom plotly.offline import iplot,init_notebook_mode\ninit_notebook_mode(connected=True)\ncf.go_offline()\n\nplt.figure(figsize=(20,10))\nfreezers['Site-1 > Freezer-5'].iplot()","18629607":"#this function is used to calculate the average time for which the freezer door stays open for each time it is opened\n#it takes the difference of the timestamp when the temperature rises above threshold and when the temp comes back\n#below the threshold. These differences are stored in a list and finally average is taken as the output.\ndef find_avg_door_opening_time(col,threshold_value):\n    time_freezer_opened = []\n    c=0  #keeps a track if the past temp value was above threshold or below; if c==1 -> last temp value was above threshold\n    j=0 #keeps a count of index\n    for value in freezers[col]:\n        if ((value>threshold_value) & (c==0)):\n            c=1\n            start_time_index = j\n        if ((value<threshold_value) & (c==1)):\n            end_time_index = j\n            c=0\n            time_difference = ((freezers[col].ix[[end_time_index]].index[0])-\n            (freezers[col].ix[[start_time_index]].index[0]))\n            time_freezer_opened.append(time_difference.seconds\/\/60)\n        j+=1\n    average_time_freezer_opened_mean = np.mean(time_freezer_opened) \n    average_time_freezer_opened_median = np.median(time_freezer_opened)\n    return average_time_freezer_opened_median,average_time_freezer_opened_mean","1d81223b":"#calling the above function for all the columns\nmins=[]\nhours=[]\ncol_name=[]\navg_time_mean = []\navg_time_median = []\nstd_deviation = []\nfor col in freezers.columns:\n    mean_value = freezers[col].mean()\n    #max_value = freezers[col].max()\n    st_deviation = freezers[col].std()\n    #TRY 1 - threshold = mean_value + st_deviation + 5\n    #TRY 2 - threshold = mean_value + ((max_value-mean_value)*0.5)\n    #finally settled with this threshold value\n    threshold = mean_value + st_deviation\n    #num_mins calculates the total number of minutes the freezer was opened across 15 days\n    num_mins = freezers[freezers[col] > threshold][col].count()\n    num_hours = num_mins\/60\n    #average_open_time_median calculates the median time for which the freezer door stays open for each time it is opened\n    average_open_time_median,average_open_time_mean = find_avg_door_opening_time(col,threshold)\n    col_name.append(col)\n    mins.append(num_mins)\n    hours.append(num_hours)\n    std_deviation.append(st_deviation)\n    avg_time_mean.append(average_open_time_mean)\n    avg_time_median.append(average_open_time_median)","eae65440":"freezer_opened = pd.DataFrame({\"freezer\":col_name,\"mins_opened\":mins,\"hours_opened\":hours,\"num_mins_door_remains_open(median)\":avg_time_median,\"num_mins_door_remains_open(mean)\":avg_time_mean})","7281b070":"freezer_opened['avg_hours_door_opens_per_day'] = freezer_opened['hours_opened']\/15","a30bc6f1":"freezer_opened.set_index('freezer')","50794e37":"freezer_opened = freezer_opened.drop(['mins_opened','hours_opened'],axis=1)","a19b4c09":"freezer_opened","b776bdb2":"#1 Site-1 > Freezer-1 average minutes the door stays open ~60 mins\nfreezers['Site-1 > Freezer-1'].describe()","11b67f63":"#threshold for this freezer was set at mean+std i.e. ~10\nplt.figure(figsize=(20,10))\nfreezers['Site-1 > Freezer-1'].iplot()","27599f51":"#2 Site-2 > Freezer-5 average minutes the door stays open ~200 mins\nfreezers['Site-2 > Freezer-5'].describe()","04f664f9":"#threshold for this freezer was set at mean+std i.e. ~18\nplt.figure(figsize=(20,10))\nfreezers['Site-2 > Freezer-5'].iplot()","c04d31a4":"#3 Site-4 > Freezer-5 average minutes the door stays open ~400 mins\nfreezers['Site-4 > Freezer-5'].describe()","e8b86670":"#threshold for this freezer was set at mean+std i.e. ~21\nplt.figure(figsize=(20,10))\nfreezers['Site-4 > Freezer-5'].iplot()","6f9bbb09":"#1 Site-1 > Freezer-9 --> median 1 vs mean 14\nfreezers['Site-1 > Freezer-9'].describe()","7c6acd1c":"#threshold for this freezer was set at mean+std i.e. ~9\nplt.figure(figsize=(20,10))\nfreezers['Site-1 > Freezer-9'].iplot()","16ade57c":"#2 Site-2 > Freezer-9 --> median 3 vs mean 50\nfreezers['Site-2 > Freezer-9'].describe()","36ffaefb":"#threshold for this freezer was set at mean+std i.e. ~10\nplt.figure(figsize=(20,10))\nfreezers['Site-2 > Freezer-9'].iplot()","91ff6287":"#3 Site-3 > Freezer-13 --> median 18 vs mean 42\nplt.figure(figsize=(20,10))\nfreezers['Site-3 > Freezer-13'].iplot()","07ada671":"#calculating the deviation of mean value door opening time from median value of door opening time\nfreezer_opened['%deviation in mean from median'] = ((freezer_opened['num_mins_door_remains_open(mean)']-\n                                                     freezer_opened['num_mins_door_remains_open(median)'])\n                                                    \/freezer_opened['num_mins_door_remains_open(median)'])*100","05de71f3":"freezer_opened.head()","8568d0dd":"#ranking freezer based on their deviation.\n#the more the deviation, the more chances of the freezer being malfunctioning. why? - the freezer finds it hard\n#to stay in the normal operating range and breaches the threshold value for most of the durations\n#this leads to a jump in the mean calculated for the total time for which the door stays open as the criteria set for\n#calculating door opening time was to see when the temp crosses the threshold. On the other hand the median stays close\n#to the normal operating temperature!\nfreezer_rankings_malfunctioning = freezer_opened[['freezer','%deviation in mean from median']]\nfreezer_rankings_malfunctioning = freezer_rankings_malfunctioning.sort_values(by='%deviation in mean from median')\nfreezer_rankings_malfunctioning = freezer_rankings_malfunctioning.reset_index(drop=True)\nfreezer_rankings_malfunctioning","9b5b8a36":"#taking into account the door opening time in addition to deviation. The freezers which have low door opening time will be \n#ranked lower while those having high door opening ranks will be ranked poorly.\nfreezer_opened['%deviation*dooropentime'] = (np.abs(freezer_opened['%deviation in mean from median']))*freezer_opened['num_mins_door_remains_open(median)']","e98d36f0":"freezer_rankings_dooropening = freezer_opened[['freezer','%deviation*dooropentime']]\nfreezer_rankings_dooropening = freezer_rankings_dooropening.sort_values(by='%deviation*dooropentime')\nfreezer_rankings_dooropening = freezer_rankings_dooropening.reset_index(drop=True)\nfreezer_rankings_dooropening","dd09d1ed":"# creating one comprehensive rank table - \nfreezer_rankings_malfunctioning['malfunctioning_rank'] = freezer_rankings_malfunctioning.index+1","b684884a":"freezer_rankings_dooropening['dooropening_rank'] = freezer_rankings_dooropening.index+1","48b06d70":"comprehensive_ranking = pd.merge(freezer_rankings_malfunctioning,freezer_rankings_dooropening,on=\"freezer\")","9fd63fe1":"comprehensive_ranking = comprehensive_ranking.drop(['%deviation in mean from median','%deviation*dooropentime'],axis=1)","60e595ff":"comprehensive_ranking","e994e044":"#Freezer 5 in Site 4 has a malfunctioning rank of 10 which is good while the door opening rank of 44 i.e. second last\n#the plot shows the reason why - the freezer isnt malfunctioning, its just that it remained open for atleast 3 days straight\n#between 15th May and 18th May.\nfreezers['Site-4 > Freezer-5'].iplot()","5a626b2e":"#The opposite case - \n#Freezer 8 at Site 4 has a good door opening rank of 4 but a rather bad rank at malfunctioning of 28.\n#Plotting it shows us that indeed - even though the door isnt opened for longer, the fact that the temperature varies\n#so much from 3 degrees to 12 degrees so frequently indicates that the freezer might be having difficulty maintaining the temp.\n\nfreezers['Site-4 > Freezer-8'].iplot()","5cd1ef58":"from statsmodels.tsa.seasonal import seasonal_decompose\n#freq = 1440 as every 1440minutes(24hrs) the data is bound to repeat\ndecomposition = seasonal_decompose(freezers['Site-2 > Freezer-2'],freq=1440)\n\ntrend = decomposition.trend\nseasonal = decomposition.seasonal\nresidual = decomposition.resid\nplt.figure(figsize=(10,6))\nplt.subplot(411)\nplt.plot(freezers['Site-2 > Freezer-2'], label='Original')\nplt.legend(loc='best')\nplt.subplot(412)\nplt.plot(trend, label='Trend')\nplt.legend(loc='best')\nplt.subplot(413)\nplt.plot(seasonal,label='Seasonality')\nplt.legend(loc='best')\nplt.subplot(414)\nplt.plot(residual, label='Residuals')\nplt.legend(loc='best')\nplt.tight_layout()","7698faab":"#divide into train and validation set\ntrain = freezers[:int(0.7*(len(freezers['Site-2 > Freezer-2'])))]['Site-2 > Freezer-2']\nvalid = freezers[int(0.7*(len(freezers['Site-2 > Freezer-2']))):]['Site-2 > Freezer-2']\n\n#plotting the data\nplt.figure(figsize=(20,6))\nax = train.plot(label='Train')\nvalid.plot(ax=ax,label='Validation')\nplt.legend()","a7975a3b":"#building the model without accounting for seasonality\nfrom pmdarima.arima import auto_arima\nmodel = auto_arima(train, trace=True, error_action='ignore', suppress_warnings=True)\nmodel.fit(train)\n\nforecast = model.predict(n_periods=len(valid))\nforecast = pd.DataFrame(forecast,index = valid.index,columns=['Prediction'])\n\n#plot the predictions for validation set\nplt.figure(figsize=(20,6))\nplt.plot(train, label='Train')\nplt.plot(valid, label='Valid')\nplt.plot(forecast, label='Prediction')\nplt.legend(loc='best')\nplt.show()","fc8dbfa3":"#building the model accounting for seasonality. But was taking too much time to process and hence i commented it out.\n\"\"\"from pmdarima.arima import auto_arima\nmodel = auto_arima(train, trace=True, error_action='ignore', suppress_warnings=True,seasonal=True,m=1440,D=1)\nmodel.fit(train)\n\nforecast = model.predict(n_periods=len(valid))\nforecast = pd.DataFrame(forecast,index = valid.index,columns=['Prediction'])\n\n#plot the predictions for validation set\nplt.plot(train, label='Train')\nplt.plot(valid, label='Valid')\nplt.plot(forecast, label='Prediction')\nplt.legend(loc='best')\nplt.show()\"\"\"","0a2cfdd3":"As there is considerable decrease in variance over the values taken at a particular time, we can fill null values by\ntaking mean of all temperature values taken at that particular time across different days for the same site and freezer rather than taking mean of all observations for that site and freezer.","71495820":"Now finding the operational temperature range of each freezer at each site - ","420bf43e":"HENCE TAKING INTO CONSIDERATION BOTH MEAN AND MEDIAN HAS LED TO PIN POINT AT FREEZERS WHO ARE EITHER MALFUNCTIONING OR ARE KEPT OPEN FOR LONGER DURATION OF TIME. LATER BY THE END OF THE NOTEBOOK WE WOULD BE ABLE TO DIFFERENTIATE THESE FREEZERS AND EVEN RANK THEM ACCORDING TO THEIR HEALTH!","213523ea":"Here we see that the reason for the discrepency is mainly due to the time period between 14th May and 18th May - The freezer remained above the threshold from May 14 16:48 till May 15 8:33 --> more than 15 hours i.e. 900 minutes and similarly this happened between 16th May till 18th May. This lead to a jump in the mean value of minutes for which the door opened each time.\n\nSOLUTION - A solution to this problem could be to CALCULATE MEDIAN IN ADDITION TO MEAN! Why? - \n\nWhat we can infer is that freezers that have lower median but higher mean are the ones which had some issue - either they were malfunctioning or they were kept open for long duration. Why? - Because the std deviation is at max. 6-8 degrees and so there should not be much difference between mean and median but because due to some malfunctioning in the freezer or because its door had been kept open for long, some temperatures shoot way above the normal range and hence lead to an jump in the mean values while the median remains unhindered!","e2fc0b74":"For this freezer too we see a continuos deterioration in the ability of the freezer to maintain its mean temperature. After 18th May the mean temperature has remained above the threshold for huge amount of time and that is the reason for the figure of 200 minutes of average opening time.","948bfe52":"In the last 2 days, the freezer has either been kept open or has started to deteriorate because it is above its threshold for huge amounts of time.","68ded711":"If we have to fill the null values, it would be better to fill it as a mean of the observations which are taken at the same hour and minute as the null value for that very particular freezer kept at the very same site because then we can assume the environmental conditions to be remain somewhat constant. \n\nBelow I'm comparing the variance associated with values taken at the same hour and minute with the values taken across the dataframe for a particular site and freezer.","d51a3d82":"*The reason why I have included both mean and median and as to why is there so much difference between both the values have been explained below.*\n\nThese discrepencies mentioned below were found before i had added median values. Studying them led me to decide that I should include median values in analysis.\n\nDiscrepancies observed with a few freezers wrt the average minutes the door remains open - \n\n1. Site-1 > Freezer-1 --> ~60 mins\n2. Site-2 > Freezer-5 --> ~200 mins\n3. Site-4 > Freezer-5 --> ~400 mins\n\nlet us plot their temperatures and see the reason for such high values and why median was taken into consideration - ","750f5ef2":"Calculating the daily average of door open duration per freezer - ","496e4203":"Lets find out such freezers and then check if we are correct by plotting their temperatures - ","bce8d411":"Ranking freezer malfunctioning is based on the deviation of mean values from median. The more the deviation, the more chances of the freezer being malfunctioning. why? - the freezer finds it hard to stay in the normal operating range and breaches the threshold value for most of the time. This leads to a jump in the mean calculated for the total time for which the door stays open as the criteria set for calculating door opening time was to see when the temp crosses the threshold. On the other hand the median stays close to the normal operating temperature!","c9ea5db5":"===============================================================================================================================\n\n                                    PREDICTING FUTURE TEMPERATURE VALUES\n                                             USING AUTOARIMA\n                                             \n \nI had just started to explore the field of time series analysis and found a few articles on analysing using autoarima. I currently have very nascent knowledge regarding the topic but thought that i should experiment now that i have some data.\n\n===============================================================================================================================","0cb2bad4":"===============================================================================================================================\n                                   \n                                   CLASSIFYING FREEZERS BASED ON OPERATIONAL HEALTH\n\nWe have already seen how to pin point at freezers which have an issue - either malfunctioning or doors kept open for long using the two variables - mean and median. Now we will be seperating the freezers into those malfunctioning or those whose doors are kept open for long. For this we will also take into consideration the variable - \"num_mins_door_remains_open(median)\" which measures the amount of time the door stays open. \n\nTHE FACT IS THAT BOTH A MALFUNCTIONING FREEZER WHICH FINDS IT DIFFICULT TO MAINTAIN A STABLE TEMPERATURE AND LONGER DURATION OF DOOR STAYING OPEN RESULTS INTO ONE THING - MEAN VALUE DEVIATING FROM MEDIAN VALUE. BUT IF WE COULD WEIGH IN THE AMOUNT OF TIME THE DOOR STAYS OPEN IN ADDITION TO THE DEVIATION - WE CAN EVEN PIN POINT THE ISSUE. LETS SEE - \n\n===============================================================================================================================","ccfdb561":"If we zoom in at dates after 18th May, the freezer remains above the threshold for most of the time and hence accounts for the discrepant value. Also what we can see is that the freezer has started to move away from its mean value of ~7 degrees. The reason could be due to some malfuntioning or because it is kept open for longer duration of time.","da59735d":"TRY 1 - Looking at the observations we see that the mean is 8.53 and standard deviation is 1.2 but still the max temp is 19.5 which is 10 times the standard deviation. Hence surely there are times when the freezer would have been opened. What we need is to somehow get to a threshold temperature, above which we can label the observation as when the freezer was opened.\n\nLooking at this link - https:\/\/www.dataloggerinc.com\/resource-article\/top-3-reasons-temperature-fluctuates-in-fridge\/ I found that there is temperature jump of 5-10 degrees  in 1-2 minutes when the door is opened.\n\nHence we can set the threshold at ((mean + std) + 5) \n\nTRY 2 - After trying the above method to find threshold I was having cases where I got 0 minutes of freezer opening time. On going deeper I found that this was the case with freezers who had narrow operational temperature range. Therefore I have used another method which takes into consideration this range to calculate a threshold temperature - \n\nthreshold temperature should be set at mean value plus 50% of the difference of mean value and maximum value.\n\nTRY 3 - I was still getting erroneous observations and so i decided to plot the temperatures for a particular freezer - ","0b9ecdea":"We have successfully filled all the null values","732827f7":"We can see why the TRY 2 had not worked. The maximum values are one off and shouldnt be used to compare all values. We should rather use mean and standard deviation only. The THRESHOLD should be set at MEAN+STD. This wont give perfect results but it will cover most of the cases. ","d027f6e9":"It seems as if the operator had shut down the freezer on the night of 11th may and put it on later the next day i.e. 12th may at around 10 in the morning -  the same thing happened on 13th may,15th,16th till 22nd. Therefore we have high mean while low median","6bb59c3e":"As we can see above, in the last few days after 19th May, the freezer has deviated away from its mean position. Shows that the freezer is finding it hard to maintain the temperature as before."}}