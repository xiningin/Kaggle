{"cell_type":{"0d43309e":"code","ce964ab0":"code","1c3b8de0":"code","0930aab6":"code","8e93483e":"code","21f5775b":"code","371b7843":"markdown"},"source":{"0d43309e":"import gc\nimport glob\nimport json\nfrom os.path import basename, dirname, splitext\nimport numpy as np\nfrom osgeo import gdal","ce964ab0":"def human_readable_size(arr: np.ndarray) -> str:\n    \"\"\"Gets array's size as a verbose, human-readable string.\"\"\"\n    \n    n = arr.nbytes\n    for unit in ('bytes', 'Kb', 'Mb', 'Gb'):\n        if n >= 1024:\n            n \/= 1024\n        else:\n            break\n    return f'{n:.3f} {unit}'","1c3b8de0":"def read_tiff(path: str) -> np.ndarray:\n    \"\"\"Reads TIFF file.\"\"\"\n    \n    dataset = gdal.Open(path, gdal.GA_ReadOnly)\n    n_channels = dataset.RasterCount\n    width = dataset.RasterXSize\n    height = dataset.RasterYSize\n    image = np.zeros((n_channels, height, width), dtype=np.uint8)\n    for i in range(n_channels):\n        band = dataset.GetRasterBand(i+1)\n        channel = band.ReadAsArray()\n        image[i] = channel\n    return image","0930aab6":"meta = []\n\nfor filename in glob.glob('\/kaggle\/input\/hubmap-kidney-segmentation\/**\/*.tiff'):\n    print(f'Processing file: {filename}')\n    identifier, _ = splitext(basename(filename))\n    subset = basename(dirname(filename))\n    img = read_tiff(filename)\n    meta.append(dict(\n        identifier=identifier,\n        filename=filename,\n        subset=subset,\n        memory_bytes=img.nbytes,\n        memory_human_readable=human_readable_size(img),\n        image_shape=img.shape\n    ))\n    del img\n    gc.collect()","8e93483e":"for info in meta:\n    print(\n        f'id: {info[\"identifier\"]}, '\n        f'memory: {info[\"memory_human_readable\"]:>10s}, '\n        f'shape: {info[\"image_shape\"]}'\n    )","21f5775b":"with open('\/kaggle\/working\/meta.json', 'w') as fp:\n    json.dump(meta, fp)","371b7843":"In this competition, we deal with TIFF images. I've never worked with this format before so my first question was: what library should I use to read this format? The most obvious choices were `Pillow` and `tifffile` packages. However, they didn't work: the former failed with `DecompressionBombError` (!), while the latter complained about NumPy array being non-contiguous for some image in the dataset.\n\n[After some search](https:\/\/stackoverflow.com\/questions\/7569553\/working-with-tiffs-import-export-in-python-using-numpy), I stumbled upon the `osgeo` library. As the name suggests, the library was probably written to work with maps, satellite images, or something like that. But it has TIFF reading functionality built-in so why not to apply it for medical imagery, right? \n\nHere I show my approach to read the dataset images. This approach worked out for me right out of the box, without any errors that I encountered with other libraries. But if you know a better\/faster way, please let me know!"}}