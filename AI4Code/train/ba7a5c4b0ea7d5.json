{"cell_type":{"5961ac3a":"code","94bff968":"code","37c7eaad":"code","2806ca18":"code","a3ecebe9":"code","493cf20a":"code","17b0087d":"code","0f78ac05":"code","c331d8dc":"code","05a1d0c6":"code","9ad5b84c":"code","2bbb0709":"code","cf064271":"code","29c70f59":"code","4a904c05":"code","629f24ea":"code","6afe2a48":"code","329de184":"code","62b32388":"code","5d148a75":"code","bc2e9e4e":"code","e846b3c6":"code","2645f10e":"code","68c9c91e":"code","6210db23":"markdown","1bfb098c":"markdown","6418eca6":"markdown","b6cc4fcd":"markdown","86ad342a":"markdown","01a25500":"markdown","c001142b":"markdown","e129c11b":"markdown","2bdb3790":"markdown"},"source":{"5961ac3a":"!pip install jcopdl\n!pip install jcopml","94bff968":"# This Python 3 environment comes with many helpful analytics libraries installed\n# It is defined by the kaggle\/python Docker image: https:\/\/github.com\/kaggle\/docker-python\n# For example, here's several helpful packages to load\n\n# COMMON PACKAGES\nimport numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\nimport matplotlib.pyplot as plt\nimport torch\nfrom torch import nn, optim\nfrom jcopdl.callback import Callback, set_config\n\nimport helper\n\n# Input data files are available in the read-only \"..\/input\/\" directory\n# For example, running this (by clicking run or pressing Shift+Enter) will list all files under the input directory\n\nimport os\nfor dirname, _, filenames in os.walk('\/kaggle\/input'):\n    for filename in filenames:\n        print(os.path.join(dirname, filename))\n\n# You can write up to 5GB to the current directory (\/kaggle\/working\/) that gets preserved as output when you create a version using \"Save & Run All\" \n# You can also write temporary files to \/kaggle\/temp\/, but they won't be saved outside of the current session","37c7eaad":"device = torch.device(\"cuda:0\" if torch.cuda.is_available() else \"cpu\")\ndevice","2806ca18":"# DATASET & DATALOADER\nfrom torchvision import datasets, transforms\nfrom torch.utils.data import DataLoader","a3ecebe9":"bs = 64\ncrop_size = 224 #standart MobileNet v2\n\ntrain_transform = transforms.Compose([\n    transforms.RandomRotation(10), #rotation 10%\n    transforms.RandomResizedCrop(crop_size, scale=(0.7, 1)), #max zoom 70% from data\n    transforms.RandomHorizontalFlip(),\n    transforms.ToTensor(),\n    transforms.Normalize(mean=[0.485, 0.456, 0.406], std=[0.229, 0.224, 0.225]) #standart MobileNet v2\n])\n\ntest_transform = transforms.Compose([ #rule  MobileNet v2\n    transforms.Resize(230), #256 replaced 230 so that the size is not far from CenterCrop 224\n    transforms.CenterCrop(224),\n    transforms.ToTensor(),\n    transforms.Normalize(mean=[0.485, 0.456, 0.406], std=[0.229, 0.224, 0.225])\n]) #rule MobileNet\n\ntrain_set = datasets.ImageFolder(\"\/kaggle\/input\/chest-xray-pneumonia\/chest_xray\/train\", transform=train_transform) \ntrainloader = DataLoader(train_set, batch_size=bs, shuffle=True, num_workers=4)\n\ntest_set = datasets.ImageFolder(\"\/kaggle\/input\/chest-xray-pneumonia\/chest_xray\/val\", transform=test_transform)\ntestloader = DataLoader(test_set, batch_size=bs, shuffle=True)","493cf20a":"len(train_set.classes)","17b0087d":"feature, target = next(iter(trainloader))\nfeature.shape","0f78ac05":"#label category\nlabel2cat = train_set.classes\nlabel2cat","c331d8dc":"#how to use Pretrained-Models\nfrom torchvision.models import mobilenet_v2\n\nmnet = mobilenet_v2(pretrained=True) #True: download model & weightnya \n\n#freze weight\nfor param in mnet.parameters():\n    param.requires_grad = False","05a1d0c6":"mnet","9ad5b84c":"#replacing classifier sequential\nmnet.classifier = nn.Sequential(\n    nn.Linear(1280, 2), #2 total class\n    nn.LogSoftmax() \n)","2bbb0709":"#custom arsitektur\nclass CustomMobilenetV2(nn.Module):\n    def __init__(self, output_size):\n        super().__init__()\n        self.mnet = mobilenet_v2(pretrained=True) #arsitektur\n        self.freeze()\n        self.mnet.classifier = nn.Sequential(  \n            #linear_block(1280, 1, activation=\"lsoftmax\")\n            nn.Linear(1280, output_size),\n            nn.LogSoftmax(dim=1)\n        )\n        \n    def forward(self, x):\n        return self.mnet(x)\n\n    def freeze(self):\n        for param in self.mnet.parameters():\n            param.requires_grad = False\n            \n    def unfreeze(self):        \n        for param in self.mnet.parameters():\n            param.requires_grad = True        ","cf064271":"config = set_config({\n    \"output_size\": len(train_set.classes),\n    \"batch_size\": bs,\n    \"crop_size\": crop_size\n})","29c70f59":"model = CustomMobilenetV2(config.output_size).to(device)\ncriterion = nn.NLLLoss()\noptimizer = optim.AdamW(model.parameters(), lr=0.001)\ncallback = Callback(model, config, early_stop_patience=2, outdir=\"model\")","4a904c05":"from tqdm.auto import tqdm\n\ndef loop_fn(mode, dataset, dataloader, model, criterion, optimizer, device):\n    if mode == \"train\":\n        model.train()\n    elif mode == \"test\":\n        model.eval()\n    cost = correct = 0\n    for feature, target in tqdm(dataloader, desc=mode.title()):\n        feature, target = feature.to(device), target.to(device)\n        output = model(feature)\n        loss = criterion(output, target)\n        \n        if mode == \"train\":\n            loss.backward()\n            optimizer.step()\n            optimizer.zero_grad()\n        \n        cost += loss.item() * feature.shape[0]\n        correct += (output.argmax(1) == target).sum().item()\n    cost = cost \/ len(dataset)\n    acc = correct \/ len(dataset)\n    return cost, acc","629f24ea":"while True:\n    train_cost, train_score = loop_fn(\"train\", train_set, trainloader, model, criterion, optimizer, device)\n    with torch.no_grad():\n        test_cost, test_score = loop_fn(\"test\", test_set, testloader, model, criterion, optimizer, device)\n    \n    # Logging\n    callback.log(train_cost, test_cost, train_score, test_score)\n\n    # Checkpoint\n    callback.save_checkpoint()\n        \n    # Runtime Plotting\n    callback.cost_runtime_plotting()\n    callback.score_runtime_plotting()\n    \n    # Early Stopping\n    if callback.early_stopping(model, monitor=\"test_score\"):\n        callback.plot_cost()\n        callback.plot_score()\n        break","6afe2a48":"model.unfreeze()\noptimizer = optim.AdamW(model.parameters(), lr=1e-5)\n\ncallback.reset_early_stop()\ncallback.early_stop_patience = 5","329de184":"while True:\n    train_cost, train_score = loop_fn(\"train\", train_set, trainloader, model, criterion, optimizer, device)\n    with torch.no_grad():\n        test_cost, test_score = loop_fn(\"test\", test_set, testloader, model, criterion, optimizer, device)\n    \n    # Logging\n    callback.log(train_cost, test_cost, train_score, test_score)\n\n    # Checkpoint\n    callback.save_checkpoint()\n        \n    # Runtime Plotting\n    callback.cost_runtime_plotting()\n    callback.score_runtime_plotting()\n    \n    # Early Stopping\n    if callback.early_stopping(model, monitor=\"test_score\"):\n        callback.plot_cost()\n        callback.plot_score()\n        break\n","62b32388":"test_set = datasets.ImageFolder(\"\/kaggle\/input\/chest-xray-pneumonia\/chest_xray\/test\/\",transform=test_transform)\ntestloader = DataLoader(test_set,batch_size = bs)\n\nwith torch.no_grad():\n        test_cost, test_score = loop_fn(\"test\", test_set, testloader, model, criterion, optimizer, device)\n        print(f\"Test accuracy:{test_score}\")\n\n","5d148a75":"from jcopml.utils import save_model","bc2e9e4e":"save_model(model, \"xray_chest_pneumonia_mobilenet_v2.pkl\")","e846b3c6":"feature, target = next(iter(testloader))\nfeature, target = feature.to(device), target.to(device)","2645f10e":"with torch.no_grad():\n    model.eval()\n    output = model(feature)\n    preds = output.argmax(1)\npreds","68c9c91e":"fig, axes = plt.subplots(6, 6, figsize=(24, 24))\nfor image, label, pred, ax in zip(feature, target, preds, axes.flatten()):\n    ax.imshow(image.permute(1, 2, 0).cpu())\n    font = {\"color\": 'r'} if label != pred else {\"color\": 'g'}        \n    label, pred = label2cat[label.item()], label2cat[pred.item()]\n    ax.set_title(f\"L: {label} | P: {pred}\", fontdict=font);\n    ax.axis('off');","6210db23":"# Arsitektur & Config","1bfb098c":"# Dataset & Dataloader","6418eca6":"## Save Model","b6cc4fcd":"<img src=\"https:\/\/upload.wikimedia.org\/wikipedia\/commons\/thumb\/2\/2a\/Chest_X-ray_in_influenza_and_Haemophilus_influenzae_-_annotated.jpg\/300px-Chest_X-ray_in_influenza_and_Haemophilus_influenzae_-_annotated.jpg\"> ","86ad342a":"## Phase 2: Fine-tuning (lr low, patience increases)","01a25500":"## Visualization","c001142b":"## Phase 1: Adaptation (lr standard + patience low)","e129c11b":"# [](http:\/\/)Pneumonia\n\nis an inflammatory condition of the lung affecting primarily the small air sacs known as alveoli, Typically symptoms include some combination of productive or dry cough, chest pain, fever, and trouble breathing. Severity is variable.\n\nPneumonia is usually caused by infection with viruses or bacteria and less commonly by other microorganisms, certain medications and conditions such as autoimmune diseases.  Risk factors include other lung diseases such as cystic fibrosis, COPD, and asthma, diabetes, heart failure, a history of smoking, a poor ability to cough such as following a stroke, or a weak immune system. Diagnosis is often based on the symptoms and physical examination. Chest X-ray, blood tests, and culture of the sputum may help confirm the diagnosis. The disease may be classified by where it was acquired with community, hospital, or health care associated pneumonia. **[See the source](https:\/\/en.wikipedia.org\/wiki\/Pneumonia)**","2bdb3790":"## Predict"}}