{"cell_type":{"d8b74370":"code","ea99e727":"code","7c9855e2":"code","41747b35":"code","a50fcecd":"code","266ef11e":"code","430c7ab7":"code","be267af8":"code","672244fe":"code","e683215d":"code","f04b0950":"code","79107d0a":"code","6eb8247c":"code","ea1f5471":"code","6c28c040":"code","7e7d8f34":"code","8726ee11":"code","734267cd":"code","2b24e172":"code","1298f316":"code","079b5cf7":"code","e4fe6b77":"code","ad849908":"code","9b863adf":"code","1fa2a676":"code","9a66acfc":"code","9bb846ab":"code","acdd3fa8":"code","3ad8050d":"code","3d6edc5e":"code","74daa621":"code","4060be6d":"code","f580affc":"code","2747610a":"code","26c03d92":"code","43b2700b":"code","4495aa16":"code","4877e9b7":"code","d55f19c0":"code","71798ef6":"code","fa13c5ff":"code","45deac33":"code","843f85ae":"code","52ee5dce":"code","64b699f1":"code","4c43b831":"code","c7bef9cb":"code","87b4b3c0":"code","a1133da6":"code","4e4f9bde":"code","899094da":"code","09dc6db4":"code","f8901e13":"code","032107d5":"code","32d3e805":"code","d793361b":"code","101aa59f":"code","4e410b11":"code","ab94b207":"code","baad7b52":"code","90b0ed85":"code","338fded2":"code","86abea59":"markdown","7c646091":"markdown","a69c26c4":"markdown","46fe5c91":"markdown","9e5c8c87":"markdown","a94b6451":"markdown","bf0eadee":"markdown","d81e3773":"markdown","938f084e":"markdown","b4b21db2":"markdown","306f3c02":"markdown","5fc78c36":"markdown","c9d54a81":"markdown","2abe092f":"markdown","95ed4e0d":"markdown","61e55cc4":"markdown","2510d631":"markdown","cdf594fc":"markdown","66f7eb88":"markdown","c71c951b":"markdown","8d42c81d":"markdown","98c40fa7":"markdown","ce181a00":"markdown","827c6374":"markdown","597cda51":"markdown","f7755de5":"markdown","e83932cc":"markdown","c10bfc9d":"markdown","8c13cc86":"markdown","8ae02e9c":"markdown","700563ff":"markdown","a1770a62":"markdown","8c2519d5":"markdown","f2fd7e0f":"markdown","42738c3b":"markdown","a3142761":"markdown","2bd227c5":"markdown","d55c40ba":"markdown","43eb8266":"markdown","3b128956":"markdown","de62de26":"markdown","a0e6012b":"markdown","d94c36bb":"markdown","54187319":"markdown","987eb9be":"markdown","995c3525":"markdown","aec4ad7e":"markdown","162f8638":"markdown","abc193cb":"markdown","2d489d34":"markdown","9d39141c":"markdown"},"source":{"d8b74370":"import numpy as np\nimport pandas as pd\nfrom sklearn.impute import SimpleImputer\nfrom sklearn.preprocessing import OneHotEncoder\nfrom sklearn.ensemble import RandomForestClassifier\nimport matplotlib.pyplot as plt\nimport seaborn as sns\n\nimport warnings\nwarnings.filterwarnings('ignore')\n\n%matplotlib inline","ea99e727":"train = pd.read_csv('..\/input\/titanic\/train.csv', index_col='PassengerId')\ntest_X = pd.read_csv('..\/input\/titanic\/test.csv', index_col='PassengerId')","7c9855e2":"print(train.columns); print(train.shape)\nprint(test_X.columns); print(test_X.shape)","41747b35":"features = list(set(train.columns) - {'Survived'})\ntarget = 'Survived'\ntrain_X, train_y = train[features], train[target]","a50fcecd":"train_X.head()","266ef11e":"print(train_X.info())","430c7ab7":"print(test_X.info())","be267af8":"plt.figure()\nplt.title('Visualizing null values in train (nulls in white)')\nsns.heatmap(train_X.isnull(), cbar=False)","672244fe":"null_percent = (train_X.isnull().sum() \/ train_X.shape[0]).values * 100\nplt.figure()\nplt.xlabel('Percentage of nulls')\nsns.barplot(x=null_percent, y=features)","e683215d":"null_threshold = 0.5    # Features with more than null_threshold fraction of nulls will be dropped.\nfor feature in features:\n    null_fraction = train_X[feature].isnull().sum() \/ train_X.shape[0]\n    if(null_fraction > null_threshold):\n        print(f'Dropped \\'{feature}\\' having {round(null_fraction * 100, 2)}% nulls.')\n        train_X = train_X.drop(feature, axis=1)\n        test_X = test_X.drop(feature, axis=1)\n        features.remove(feature)","f04b0950":"print('Number of unique values for each feature')\ntrain_X.nunique()","79107d0a":"numeric_features = ['Age', 'Fare', 'Parch', 'SibSp']\nordinal_features = ['Pclass']    # Label encoded\nnominal_features = ['Sex', 'Ticket', 'Embarked']    # To one hot encode","6eb8247c":"fig, ax = plt.subplots(1, 2, figsize=(8, 3))\nplt.tight_layout()\nfor i, feature in enumerate(['Age', 'Fare']):\n    ax[i].set_title(f'Histogram of {feature}')\n    sns.distplot(train_X[feature], ax=ax[i], kde=False)","ea1f5471":"fig, ax = plt.subplots(1, 5, figsize=(18, 3))\nplt.tight_layout()\nfor i, feature in enumerate(['Parch', 'SibSp', 'Pclass', 'Sex', 'Embarked']):\n    sns.countplot(train_X[feature], ax=ax[i])","6c28c040":"plt.figure()\nsns.pairplot(pd.concat([train_y, train_X[numeric_features]], axis=1), \n             hue='Survived', \n             vars=numeric_features,\n             markers=['+', 'x'],\n             diag_kind=None, \n             dropna=True,\n             plot_kws={'alpha': 0.4})","7e7d8f34":"plt.title('Effect of age on survival')\nsns.swarmplot(x=train_y, y=train_X['Age'])","8726ee11":"plt.title('Effect of fare on survival')\nsns.swarmplot(x=train_y, y=train_X['Fare'])","734267cd":"survival_percent = dict(round(train.groupby(by='Sex').mean()['Survived'] * 100, 2))\nprint(survival_percent)","2b24e172":"survived_males_age = train_X['Age'].where((train_X['Sex'] == 'male') & (train_y == 1))\nnot_survived_males_age = train_X['Age'].where((train_X['Sex'] == 'male') & (train_y == 0))\nsurvived_females_age = train_X['Age'].where((train_X['Sex'] == 'female') & (train_y == 1))\nnot_survived_females_age = train_X['Age'].where((train_X['Sex'] == 'female') & (train_y == 0))","1298f316":"fig, ax = plt.subplots(1, 2, figsize=(9, 4))\nplt.tight_layout()\n\nax[0].set_title('Male age hist (by survival)')\nax[0].set_xlim([0, 80])\nsns.distplot(survived_males_age, ax=ax[0], kde=False, label='Survived')\nsns.distplot(not_survived_males_age, ax=ax[0], kde=False, label='Not survived')\nax[0].legend()\n\nax[1].set_title('Female age hist (by survival)')\nax[1].set_xlim([0, 80])\nsns.distplot(survived_females_age, ax=ax[1], kde=False, label='Survived')\nsns.distplot(not_survived_females_age, ax=ax[1], kde=False, label='Not survived')\nax[1].legend()","079b5cf7":"survival_percent = dict(round(train.groupby(by='Parch').mean()['Survived'] * 100, 2))\nprint(survival_percent)","e4fe6b77":"plt.figure()\nplt.xlabel('Number of parents\/children')\nplt.ylabel('% survived')\nitems = survival_percent.items()\nparch = [item[0] for item in items]\nsurvival_rates = [item[1] for item in items]\nsns.barplot(x=parch, y=survival_rates)","ad849908":"survival_percent = dict(round(train.groupby(by='SibSp').mean()['Survived'] * 100, 2))\nprint(survival_percent)","9b863adf":"plt.figure()\nplt.xlabel('Number of siblings\/spouses')\nplt.ylabel('% survived')\nitems = survival_percent.items()\nparch = [item[0] for item in items]\nsurvival_rates = [item[1] for item in items]\nsns.barplot(x=parch, y=survival_rates)","1fa2a676":"train_X['FamilyMembers'] = train_X['Parch'] + train_X['SibSp']\ntest_X['FamilyMembers'] = test_X['Parch'] + test_X['SibSp']\nnumeric_features.append('FamilyMembers')","9a66acfc":"survival_percent = dict(round((pd.concat([train_X, train_y], axis=1)).groupby(by='FamilyMembers').mean()['Survived'] * 100, 2))\nprint(survival_percent)","9bb846ab":"plt.figure()\nplt.xlabel('Number of family members')\nplt.ylabel('% survived')\nitems = survival_percent.items()\nparch = [item[0] for item in items]\nsurvival_rates = [item[1] for item in items]\nsns.barplot(x=parch, y=survival_rates)","acdd3fa8":"survival_percent = dict(round(train.groupby(by='Pclass').mean()['Survived'] * 100, 2))\nprint(survival_percent)","3ad8050d":"plt.figure()\nplt.xlabel('Class')\nplt.ylabel('% survived')\nitems = survival_percent.items()\nparch = [item[0] for item in items]\nsurvival_rates = [item[1] for item in items]\nsns.barplot(x=parch, y=survival_rates)","3d6edc5e":"survival_percent = dict(round(train.groupby(by='Embarked').mean()['Survived'] * 100, 2))\nprint(survival_percent)","74daa621":"plt.figure()\nplt.xlabel('Port of embarking')\nplt.ylabel('% survived')\nitems = survival_percent.items()\nparch = [item[0] for item in items]\nsurvival_rates = [item[1] for item in items]\nsns.barplot(x=parch, y=survival_rates)","4060be6d":"train_titles = [name.split(',')[1].strip().split(' ')[0] for name in train_X['Name']]\ntest_titles = [name.split(',')[1].strip().split(' ')[0] for name in test_X['Name']]","f580affc":"train_X['Title'] = train_titles\ntest_X['Title'] = test_titles","2747610a":"print('Title occurrences in training set:')\nprint(train_X['Title'].value_counts())","26c03d92":"print(train_X['Name'][train_X['Title'] == 'the'])    # Using logical indexing on train_X['Name']","43b2700b":"print('Title occurrences in test set:')\nprint(test_X['Title'].value_counts())","4495aa16":"def group_titles(title):\n    \"\"\" Function to group low occurrence titles using the scheme above. \"\"\"\n    \n    if(title in {'Major.', 'Col.', 'Capt.'}):\n        return 'Military'\n    elif(title in {'Jonkheer.', 'Lady.', 'Sir.', 'Don.', 'Dona.', 'the'}):\n        return 'Royalty'\n    elif(title in {'Mlle.', 'Ms.'}):\n        return 'Miss.'\n    elif(title == 'Mme.'):\n        return 'Mrs.'\n    else:\n        return title","4877e9b7":"train_X['Title'] = train_X['Title'].apply(group_titles)\ntest_X['Title'] = test_X['Title'].apply(group_titles)","d55f19c0":"print(f'Unique titles in training set:\\t{train_X.Title.unique()}')\nprint(f'Unique titles in test set:\\t{test_X.Title.unique()}')","71798ef6":"nominal_features.append('Title')","fa13c5ff":"corr_with_fare = train_X['Age'].corr(train_X['Fare'])\ncorr_with_family_members = train_X['Age'].corr(train_X['FamilyMembers'])\ncorr_with_pclass = train_X['Age'].corr(train_X['Pclass'])\n\nprint(f'Correlation of Age with Fare = {round(corr_with_fare, 3)}')\nprint(f'Correlation of Age with FamilyMembers = {round(corr_with_family_members, 3)}')\nprint(f'Correlation of Age with Pclass = {round(corr_with_pclass, 3)}')","45deac33":"null_ids_train = train_X['Age'].isnull()\nnull_ids_train = null_ids_train[null_ids_train != False].index.tolist()    # Passenger indices where age is null in training set\nlen(null_ids_train)","843f85ae":"fill_values_train = train_X.groupby(by=['Title', 'Pclass']).mean()['Age'].astype(int)\nprint('Age values to fill classwise, training set:')\nprint(fill_values_train)","52ee5dce":"for index in null_ids_train:\n    title = train_X.loc[index, 'Title']\n    pclass = train_X.loc[index, 'Pclass']\n    train_X.loc[index, 'Age'] = fill_values_train[(title, pclass)]","64b699f1":"print(train_X.info())","4c43b831":"null_ids_test = test_X['Age'].isnull()\nnull_ids_test = null_ids_test[null_ids_test != False].index.tolist()    # Passenger indices where age is null in test set\nlen(null_ids_test)","c7bef9cb":"fill_values_test = test_X.groupby(by=['Title', 'Pclass']).mean()['Age'].astype(int)\nprint('Age values to fill classwise, test set:')\nprint(fill_values_test)","87b4b3c0":"for index in null_ids_test:\n    title = test_X.loc[index, 'Title']\n    pclass = test_X.loc[index, 'Pclass']\n    test_X.loc[index, 'Age'] = fill_values_test[(title, pclass)]","a1133da6":"print(test_X.info())","4e4f9bde":"imputer = SimpleImputer(strategy='mean')\ntrain_X[numeric_features] = imputer.fit_transform(train_X[numeric_features])\ntest_X[numeric_features] = imputer.transform(test_X[numeric_features])","899094da":"imputer = SimpleImputer(strategy='most_frequent')\n\ntrain_X[ordinal_features] = imputer.fit_transform(train_X[ordinal_features])\ntest_X[ordinal_features] = imputer.transform(test_X[ordinal_features])\n\ntrain_X[nominal_features] = imputer.fit_transform(train_X[nominal_features])\ntest_X[nominal_features] = imputer.transform(test_X[nominal_features])","09dc6db4":"print(f'train_X null count = {train_X.isnull().sum().sum()}')\nprint(f'test_X null count = {test_X.isnull().sum().sum()}')","f8901e13":"print(f'Ordinal categorical features: {ordinal_features}')\nprint(f'Nominal categorical features: {nominal_features}')","032107d5":"print(train_X['Pclass'].unique())","32d3e805":"one_hot_encoder = OneHotEncoder(handle_unknown='error', sparse=False, drop='if_binary')\n\ntrain_oe_matrix = one_hot_encoder.fit_transform(train_X[['Sex', 'Embarked', 'Title']]).astype('int')\ntest_oe_matrix = one_hot_encoder.transform(test_X[['Sex', 'Embarked', 'Title']]).astype('int')\n\nprint(train_oe_matrix.shape)\nprint(test_oe_matrix.shape)","d793361b":"one_hot_encoder.categories_","101aa59f":"features = ['Sex', 'Embarked', 'Title']\nohe_column_names = list()\nfor i, categories in enumerate(one_hot_encoder.categories_):\n    for category in categories:\n        ohe_column_names.append(features[i] + '_' + category)\n# Dropped first column in 'Sex', so dropping it from ohe_column_names as well\nohe_column_names.pop(0)\nprint(ohe_column_names)","4e410b11":"# Converting one hot encoded matrices to dataframe\ntrain_oe = pd.DataFrame(train_oe_matrix, index=train_X.index, columns=ohe_column_names)\ntest_oe = pd.DataFrame(test_oe_matrix, index=test_X.index, columns=ohe_column_names)\n\n# Dropping columns 'Sex', 'Embarked' and 'Title' as they have been one hot encoded\ntrain_X = train_X.drop(columns=['Sex', 'Embarked', 'Title'])\ntest_X = test_X.drop(columns=['Sex', 'Embarked', 'Title'])\n\n# Adding the one hot encoded columns to train_X and test_X\ntrain_X = pd.concat([train_X, train_oe], axis=1)\ntest_X = pd.concat([test_X, test_oe], axis=1)","ab94b207":"train_X = train_X.drop(columns=['Ticket', 'Name'])\ntest_X = test_X.drop(columns=['Ticket', 'Name'])","baad7b52":"fig, ax = plt.subplots(1, 2, figsize=(7, 3))\nfig.suptitle('Before scaling', y=1.1)\nplt.tight_layout()\nax[0].set_title('Training')\nax[1].set_title('Test')\nsns.scatterplot(train_X['Age'], train_X['Fare'], ax=ax[0], hue=train_y)\nsns.scatterplot(test_X['Age'], test_X['Fare'], ax=ax[1])","90b0ed85":"mean = train_X[numeric_features].mean(axis=0)\nstddev = train_X[numeric_features].std(axis=0)\n\nfor numeric_feature in numeric_features:\n    train_X[numeric_feature] = (train_X[numeric_feature] - mean[numeric_feature]) \/ stddev[numeric_feature]\n    test_X[numeric_feature] = (test_X[numeric_feature] - mean[numeric_feature]) \/ stddev[numeric_feature]","338fded2":"fig, ax = plt.subplots(1, 2, figsize=(7, 3))\nfig.suptitle('After scaling', y=1.1)\nplt.tight_layout()\nax[0].set_title('Training')\nax[1].set_title('Test')\nsns.scatterplot(train_X['Age'], train_X['Fare'], ax=ax[0], hue=train_y)\nsns.scatterplot(test_X['Age'], test_X['Fare'], ax=ax[1])","86abea59":"'Ticket' contains far too many categories to be one hot encoded. Maybe it could be label encoded or maybe we could glean some information from it. But for now, dropping the 'Ticket' column.\n\nAlso dropping 'Name' as we have extracted it from it as much useful information as we could.","7c646091":"### Dealing with 'Sex', 'Embarked' and 'Title'","a69c26c4":"Most were single travellers ('Parch' and 'SibSp'). A large number portion travelled in 3rd class. A majority were male. Most embarked from Southampton.","46fe5c91":"### Effect of age and sex together on survival","9e5c8c87":"Sanity check: len(null_ids_train) matches the number of nulls in the 'Age' column in train_X.","a94b6451":"Filling null values in 'Age' for the training set","bf0eadee":"Label\/ordinal encoding ordinal categorical features.\n\nOne hot encoding nominal features.","d81e3773":"## Scaling numeric features","938f084e":"Generating the column names for the one hot encoded features in the format (feature)_(category)","b4b21db2":"Filling null values in 'Age' for the test set","306f3c02":"### Combining Parch and SibSp into one feature FamilyMembers and observing its effect on survival\n\nIt probably makes more sense to have one feature for the total number of family members than have separate counts for the number of parents\/children and number of siblings\/spouses.","5fc78c36":"Features with far too many null values have low predictive power. It makes sense to remove such variables than try to impute and fill in so many null values.","c9d54a81":"Survival rates were highest in 1st class and lowest in 3rd class.","2abe092f":"### Dealing with 'Pclass'","95ed4e0d":"### Nulls in 'Age'\n\nFinding which feature best correlates with age (absolute magnitude). Then using it to impute the missing age values, along with using titles as an indicator of age.","61e55cc4":"### Effect of class on survival","2510d631":"### Effect of sex on survival","cdf594fc":"### Effect of port of embarking on survival","66f7eb88":"Sanity check: len(null_ids_test) matches the number of nulls in the 'Age' column in test_X.","c71c951b":"Age correlates highest (in absolute magnitude) with Pclass. The older a person is, the greater the chance of being able to afford a better class (1st > 2nd > 3rd).","8d42c81d":"Imputing ordinal and nominal categorical features using mode","98c40fa7":"### Effect of fare on survival","ce181a00":"'Pclass' is already label\/ordinal encoded by default.","827c6374":"### Effect of number of siblings\/spouses on survival","597cda51":"Highest survival rates were observed among those who had 1, 2 or 3 parents\/children.","f7755de5":"'the' seems to be an odd title. But because we split on ' ', the whole title 'the Countess.' became 'the'. So the title should actually be 'Countess'.","e83932cc":"## Dealing with nulls","c10bfc9d":"'Age' and 'Fare' are continuous variables. 'Parch', 'SibSp' and 'Pclass' are ordinal categorical variables. The rest are nominal categorical variables.","8c13cc86":"Imputing numeric features using mean","8ae02e9c":"It looks like in the age bracket 0 to 5, there were more survivors than were killed. The trend is reversed in the middle age groups, where more were killed than survived. This makes sense, as it was ladies and children first. And there were more men than women, so despite ladies first, men would have dominated the not survived section, explaining the blue bulge among the middle-aged.","700563ff":"# Exploratory Data Analysis and Feature Engineering","a1770a62":"Neither train nor test contain nulls now.","8c2519d5":"It is quite apparent that among those passengers who paid a zero fare, the vast majority did not survive. Also among those who paid a high fare (Fare > 10), more passengers survived than were killed.","f2fd7e0f":"Survival rates by class and survival rates by port of embarking show similar patterns. It's possible that class and port of embarking are correlated.","42738c3b":"Sanity check: The number of columns in the one hot encoded matrices should be 12 each.\n* 'Sex' has 2 categories, and we've used drop='if_binary', so it contributes 1 column to the OHE matrix.\n* 'Embarked' has 3 categories, so it contributes 3 columns to the OHE matrix.\n* 'Title' has 8 categories, so it contributes 8 columns to the OHE matrix.","a3142761":"## Encoding categorical features","2bd227c5":"## Distribution of features","d55c40ba":"## Multivariate analysis","43eb8266":"## Adding a title feature (Mr., Mrs., Dr., etc.)","3b128956":"### Effect of age on survival","de62de26":"Number of family members clearly impacts survival rates, as seen from the above graph.","a0e6012b":"Apart from 'Mr.', 'Miss.', 'Mrs.' and 'Master.', the titles have very low occurrences.\n\nGrouping the low occurrence titles according to the scheme below:\n* 'Major.', 'Col.' and 'Capt.' under 'Military'\n* 'Jonkheer.', 'Lady.', 'Sir.', 'Don.' and 'Dona.' under 'Royalty'\n* 'Mlle.' (Mademoiselle) under 'Miss.' and 'Mme.' (Madame) under 'Mrs.'\n* 'Ms.' under 'Miss.', even though Ms. could mean either Miss. or Mrs. (there's only one occurrence of Ms., so it shouldn't matter anyway)\n* 'the' under 'Royalty' (because of 'the Countess.')\n* 'Dr.' and 'Rev.' get their own categories","d94c36bb":"## Visualizing null values","54187319":"From the colour coding, it's quite apparent that more males died than survived, and more females survived than not.\n\nFrom the graph on the left hand side, we can see that the males in the age range 20-40 had the highest chance of not surviving.\n\nThe spike in the age range 0-5 in both the male and female graphs indicates that children were probably given first preference to be saved.","987eb9be":"A significantly higher proportion of females survived (74.2%) than males (18.89%). Sex seems to be an important feature determining survival.","995c3525":"Highest survival rates were observed in those who had 1 or 2 siblings\/spouses.","aec4ad7e":"'Age' seems to be relatively normally distributed. 'Fare' seems to be rather skewed.","162f8638":"### Effect of number of parents\/children on survival","abc193cb":"Instead of imputing age using mean across the age column, it might be a good idea to fill age by grouping primarily using title, and secondarily using class.\n\nWe can expect that age is correlated with title. It's reasonable to assume a 'Mr.' would be older than a 'Master.', and generally speaking, a 'Mrs.' to be older than a 'Miss.'\n\nImputing age grouping primarily by title and secondarily by class.","2d489d34":"## Univariate analysis (effect of features on survival)","9d39141c":"### Imputing nulls in all other columns"}}