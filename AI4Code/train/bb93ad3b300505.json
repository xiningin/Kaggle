{"cell_type":{"e21d4e45":"code","95152d65":"code","081000f0":"code","da8e9a60":"code","a727c5d8":"code","901f04c6":"code","43a3b13a":"code","1d350d5e":"code","d23fcb4f":"code","c61429ed":"code","6fcb6764":"code","cf08fe73":"code","fb8ac3fe":"code","03df1892":"code","85283f35":"code","6685cf6c":"code","36a2fa86":"code","263188f7":"code","d2add2f6":"code","54db2ebe":"code","501d315b":"code","5b76379a":"code","b6028f42":"code","b1c0306b":"code","d42ac830":"code","2ea45cc5":"code","def97511":"code","0868332a":"code","a1625d59":"code","755a5119":"code","ed228956":"code","ad767ccf":"code","4525fab5":"code","2df67c42":"code","8c2bab80":"code","264dfe85":"code","d01b60dc":"code","a9bb61d4":"code","df25569d":"code","2b084fc9":"code","7ba54934":"code","81b60c23":"code","445e947f":"code","405ee69c":"code","1890eb06":"code","a6026224":"code","118dcee1":"code","de1f0bcc":"code","c69b5a52":"code","eeb00638":"code","12271c6f":"code","bca8ff26":"code","7696d2f6":"code","c1977bab":"code","39edb58e":"code","8fd96948":"code","e1871e2b":"code","9b0feff9":"code","551123e0":"code","525b2c87":"code","bdca48af":"code","e19d1316":"code","d381651f":"code","53d1dac5":"code","8426e83f":"code","7170862e":"code","17e92258":"code","15b16294":"code","4601ed0d":"code","18daaf7e":"code","8d10ddac":"code","d9070cd7":"code","ed867b7d":"code","bd40b60e":"code","3600074e":"code","817fbae2":"code","febf153b":"code","2ecf4b8d":"code","967ee6eb":"code","29773f2b":"markdown","3e4794af":"markdown","f6a07c38":"markdown","66d862e2":"markdown","25dd2add":"markdown","c8630b24":"markdown","36374dd6":"markdown","1bcde288":"markdown","080ffd60":"markdown","56029efa":"markdown","44a01bf6":"markdown","5dc8b109":"markdown","31c43987":"markdown","fca230eb":"markdown","fc7266b6":"markdown","63fdfccd":"markdown","757e3d23":"markdown","727ff266":"markdown","e8121ea9":"markdown","915f166f":"markdown","2d168f60":"markdown","2b3d3d84":"markdown","43dcb98c":"markdown"},"source":{"e21d4e45":"%matplotlib inline","95152d65":"import os\nimport PIL\nimport numpy as np\nimport pandas as pd\nimport matplotlib.pyplot as plt\nfrom tqdm import tqdm","081000f0":"DATA_ROOT = os.path.join('..', 'input'); DATA_ROOT","da8e9a60":"DATA_COMPT = os.path.join(DATA_ROOT, 'plant-pathology-2021-fgvc8'); DATA_COMPT","a727c5d8":"DATA_TRAIN_IMAGES = os.path.join(DATA_COMPT, 'train_images'); DATA_TRAIN_IMAGES","901f04c6":"DATA_TEST_IMAGES = os.path.join(DATA_COMPT, 'test_images'); DATA_TEST_IMAGES","43a3b13a":"DATA_IMG_STATS = os.path.join(DATA_ROOT, 'plant-pathology-2021-metadata-with-image-stats'); DATA_IMG_STATS","1d350d5e":"DATA_OUTPUT = '.\/'","d23fcb4f":"df_train = pd.read_csv(os.path.join(DATA_COMPT, 'train.csv'))","c61429ed":"df_sample_submission = pd.read_csv(os.path.join(DATA_COMPT, 'sample_submission.csv'))","6fcb6764":"df_train.info()","cf08fe73":"df_train.head()","fb8ac3fe":"df_sample_submission.info()","03df1892":"df_sample_submission.head()","85283f35":"len(df_train)\/len(set(df_train['image']))","6685cf6c":"set(df_train['image']).intersection(set(df_sample_submission['image']))","36a2fa86":"df_train['labels'].value_counts()","263188f7":"train_image_files = [f for f in os.listdir(DATA_TRAIN_IMAGES) \\\n if os.path.isfile(os.path.join(DATA_TRAIN_IMAGES, f))]","d2add2f6":"train_image_files[:5]","54db2ebe":"test_image_files = [f for f in os.listdir(DATA_TEST_IMAGES) \\\n if os.path.isfile(os.path.join(DATA_TEST_IMAGES, f))]","501d315b":"test_image_files","5b76379a":"len(train_image_files)==len(set(train_image_files))","b6028f42":"len(train_image_files)==len(df_train)","b1c0306b":"set(train_image_files) - set(df_train['image'])","d42ac830":"len(test_image_files)==len(df_sample_submission)","2ea45cc5":"set(test_image_files) - set(df_sample_submission['image'])","def97511":"image = PIL.Image.open(os.path.join(DATA_TRAIN_IMAGES, f\"{df_train.sample()['image'].values[0]}\")); image","0868332a":"plt.imshow(image)","a1625d59":"np.array(image).shape # (height, width, channels)","755a5119":"np.array(image).min()","ed228956":"np.array(image).max()","ad767ccf":"def get_image_stats(df:pd.DataFrame, path:str, image_id_col, suffix:str='')->pd.DataFrame:\n    \n    image_stats = {image_id_col:[], 'height':[], 'width':[], 'channels':[], 'pixl_mean':[], 'pixl_std':[]}\n    \n    for image_id in tqdm(df[image_id_col]):\n        if suffix=='': image = PIL.Image.open( os.path.join(path, f'{image_id}') )\n        else: image = PIL.Image.open( os.path.join(path, f'{image_id}.{suffix}') )\n        \n        image = np.array(image)\n        image_shape = image.shape\n        image_stats[image_id_col].append(image_id)\n        \n        if len(image_shape)==3: image_stats['channels'].append(image_shape[2])\n        else: image_stats['channels'].append(1)\n        \n        image_stats['height'].append(image_shape[0])\n        image_stats['width'].append(image_shape[1])\n        image_stats['pixl_mean'].append(image.mean())\n        image_stats['pixl_std'].append(image.std())\n    \n    return df.merge(right=pd.DataFrame(data=image_stats), how='inner', on=image_id_col)","4525fab5":"try:\n    df_train = pd.read_csv(os.path.join(DATA_IMG_STATS, 'train_stats.csv'))\nexcept:\n    df_train = get_image_stats(df=df_train, path=DATA_TRAIN_IMAGES, image_id_col='image')\n    df_train.to_csv(os.path.join(DATA_COMPT, 'train_stats.csv'), index=False)","2df67c42":"df_train.head()","8c2bab80":"try:\n    df_sample_submission = pd.read_csv(os.path.join(DATA_IMG_STATS, 'sample_submission_stats.csv'))\nexcept:\n    df_sample_submission = get_image_stats(df=df_sample_submission, path=DATA_TEST_IMAGES, image_id_col='image')\n    df_sample_submission.to_csv(os.path.join(DATA_OUTPUT, 'sample_submission_stats.csv'), index=False)","264dfe85":"df_sample_submission","d01b60dc":"df_train.info()","a9bb61d4":"df_train['channels'].value_counts()","df25569d":"df_train['height'].value_counts()","2b084fc9":"df_train['width'].value_counts()","7ba54934":"df_train['height2width'] = df_train['height']\/df_train['width']","81b60c23":"df_train['height2width'].hist()","445e947f":"df_train['height2width'].max()","405ee69c":"df_train[df_train['height2width']>1]","1890eb06":"df_train.loc[df_train['height2width']<=1, 'height2width'].hist()","a6026224":"df_train.loc[df_train['height2width']<=1, 'height2width'].value_counts()","118dcee1":"for imgFileName in df_train.loc[df_train['height2width']>1, 'image']:\n    im = PIL.Image.open(os.path.join(DATA_TRAIN_IMAGES, f\"{imgFileName}\"))\n    \n    fig, ax = plt.subplots(figsize=(10,10))\n    ax.imshow(im)\n    ax.title.set_text(imgFileName)\n    plt.show()","de1f0bcc":"subset = ['pixl_mean','pixl_std']","c69b5a52":"train_mask_duplicates = df_train.duplicated(subset=subset, keep=False)","eeb00638":"train_mask_duplicates.sum()","12271c6f":"test_mask_duplicates = df_sample_submission.duplicated(subset=subset, keep=False)","bca8ff26":"test_mask_duplicates.sum()","7696d2f6":"train_test_outer_mask_duplicates =\\\npd.concat([df_train[~train_mask_duplicates],df_sample_submission[~test_mask_duplicates]]).reset_index(drop=True).duplicated(subset=subset, keep=False)","c1977bab":"train_test_outer_mask_duplicates.sum()","39edb58e":"df_dupl_train =\\\ndf_train.loc[train_mask_duplicates, ['image']+subset].groupby(by=subset)['image'].apply(list).reset_index()\n\ndf_dupl_train['num_dupls'] = df_dupl_train['image'].apply(lambda x: len(x)).astype(int)","8fd96948":"df_dupl_train","e1871e2b":"target = 'labels'\nimages_target_inconsistent = []\nfor i in range(len(df_dupl_train)):\n    image_id1 = df_dupl_train.loc[i, 'image'][0]\n    image_id2 = df_dupl_train.loc[i, 'image'][1]\n    \n    image1 = PIL.Image.open( os.path.join(DATA_TRAIN_IMAGES, f'{image_id1}') )\n    image1 = np.array(image1)\n    image2 = PIL.Image.open( os.path.join(DATA_TRAIN_IMAGES, f'{image_id2}') )\n    image2 = np.array(image2)\n    \n    fig, (ax1, ax2) = plt.subplots(nrows=1, ncols=2, figsize=(15,15))\n    ax1.imshow(image1)\n    ax2.imshow(image2)\n    \n    l1 = df_train.loc[df_train['image']==image_id1, target].tolist()[0].split()\n    l2 = df_train.loc[df_train['image']==image_id2, target].tolist()[0].split()\n    \n    ax1.title.set_text(f'Image:{image_id1}\\nLabel:{l1}')\n    ax2.title.set_text(f'Image:{image_id2}\\nLabel:{l2}')\n    plt.show()\n    \n    if set(l1)!=set(l2): images_target_inconsistent.extend([image_id1,image_id2])","9b0feff9":"len(images_target_inconsistent)","551123e0":"len(df_train)","525b2c87":"df_train = df_train[~df_train['image'].isin(images_target_inconsistent)].reset_index(drop=True)","bdca48af":"len(df_train)","e19d1316":"def plot_dist_stats(df, col, **kwargs):\n    mn  = round(df[col].min(), 2)\n    mx  = round(df[col].max(), 2)\n    avg = round(df[col].mean(), 2)\n    std = round(df[col].std(), 2)\n\n    df[col].hist(label=f'min, max = ({mn}, {mx})\\navg, std = ({avg}, {std})', **kwargs)\n    plt.legend()\n    plt.title(col)\n    plt.show()","d381651f":"plot_dist_stats(df=df_train, col='pixl_mean')","53d1dac5":"plot_dist_stats(df=df_train, col='pixl_std')","8426e83f":"# least bright image:\nPIL.Image.open( os.path.join(DATA_TRAIN_IMAGES, f\"{df_train.loc[df_train['pixl_mean']==df_train['pixl_mean'].min(), 'image'].tolist()[0]}\") )","7170862e":"# most bright image:\nPIL.Image.open( os.path.join(DATA_TRAIN_IMAGES, f\"{df_train.loc[df_train['pixl_mean']==df_train['pixl_mean'].max(), 'image'].tolist()[0]}\") )","17e92258":"# least contrast image:\nPIL.Image.open( os.path.join(DATA_TRAIN_IMAGES, f\"{df_train.loc[df_train['pixl_std']==df_train['pixl_std'].min(), 'image'].tolist()[0]}\") )","15b16294":"# most contrast image:\nPIL.Image.open( os.path.join(DATA_TRAIN_IMAGES, f\"{df_train.loc[df_train['pixl_std']==df_train['pixl_std'].max(), 'image'].tolist()[0]}\") )","4601ed0d":"def plot_dist_bar(df, col, **kwargs):\n    ds = df[col].value_counts()\n    \n    height = ds.values\n    xticks = list(ds.index)\n    x = np.arange(len(xticks))\n    \n    plt.bar(x=x, height=height)\n    plt.xticks(x, xticks, **kwargs)\n    plt.show()","18daaf7e":"df_train['labels'].value_counts()","8d10ddac":"plot_dist_bar(df=df_train, col='labels', rotation=90)","d9070cd7":"clas_counts = df_train['labels'].value_counts().to_dict()","ed867b7d":"uclasses =\\\npd.DataFrame([(clas,clas_counts[label]) for label in clas_counts \n              for clas in label.split()]).groupby(by=0).sum().reset_index().rename(columns={0:'class',\n                                                                                            1:'counts'}).sort_values(by='counts',\n                                                                                                                     ascending=False).reset_index(drop=True)","bd40b60e":"uclasses","3600074e":"uclasses['class_single_rust'] = uclasses['class']","817fbae2":"uclasses.loc[uclasses['class']=='cider_apple_rust', 'class_single_rust'] = 'rust'","febf153b":"uclasses_single_rust =\\\nuclasses.groupby(by='class_single_rust').sum().sort_values(by='counts', ascending=False).reset_index().copy()\nuclasses = uclasses.drop(labels=['class_single_rust'], axis=1)","2ecf4b8d":"uclasses_single_rust","967ee6eb":"rot=60\n\nheight1 = uclasses['counts']\nxticks1 = uclasses['class'].tolist()\nx1 = np.arange(len(xticks1))\n\nheight2 = uclasses_single_rust['counts']\nxticks2 = uclasses_single_rust['class_single_rust'].tolist()\nx2 = np.arange(len(xticks2))\n\nfig, (ax1, ax2) = plt.subplots(nrows=1, ncols=2, figsize=(15,5))\n\nax1.bar(x=x1, height=height1)\nax1.set_xticks(x1)\nax1.set_xticklabels(xticks1, rotation=rot)\nax1.title.set_text(f'Unique class counts')\n\nax2.bar(x=x2, height=height2)\nax2.set_xticks(x2)\nax2.set_xticklabels(xticks2, rotation=rot)\nax2.title.set_text(f'Unique class single rust counts')","29773f2b":"### Looking up labels","3e4794af":"I will drop all dublicates because there is issue with their labels.","f6a07c38":"# Defining environment parameters","66d862e2":"### Checking for duplicate records in train metadata. If return > 1 there are duplicates.","25dd2add":"Let's visually inspect suspects for duplicate images:","c8630b24":"# Initial Exploratory Data Analysis for Plant Pathology 2021","36374dd6":"### Unique classes","1bcde288":"# Loading packages","080ffd60":"### Let's look for duplicate images via image statistics","56029efa":"# Exploring label","44a01bf6":"# Exploring data consistency","5dc8b109":"## 1) Metadata","31c43987":"## 3) Image data","fca230eb":"Nothing wrong or special about these images, they were simpy rotated, so that height and width switched around. It is good to keep it mind when building pre-processing steps in pipeline as similarly rotated images can be in the test set. One might consider adding a step into pipeline which checks for rotated images and deals with them accordingly.","fc7266b6":"It is a multi-label classification problem i.e., single image can have a label comprised of a few classes at the same time.","63fdfccd":"## 2) Metadata & image files consistency","757e3d23":"Looks like there are duplicate suspects in train data (54 images) but there is no duplicate suspect images between train and test sets nor within the small sample of the test data alone.","727ff266":"Visual inspection confirmed that the suspcts were indeed duplicate images. There are total of 54 duplicates with groups of 2 of the same images thus, resulting in 27 unique pairs of duplicates.\n\nThe other issue with these duplicates is that their respected labels are all different for each pair, so there is target inconsistency among duplicate images. This issue might not be only present for this subset of images but also for the rest of the train and test data sets, meaning that we might have noisy label in this data!","e8121ea9":"Are **'cider_apple_rust'** and **'rust'** just two labels for the same class? Depending on the answer there are 7 or 6 unique classes.","915f166f":"**Method Description:**\n\nIn case of exact and trivial duplicate images (pixel to pixel same images) it, in principal, should be possible to find duplicates via image statistics.\n\n\nFirst, calculate for each image mean and std over its pixel values.\n\n\nSecond, detect possible suspects for dublicate images via selecting groups of images with exactly the same pairs of values of mean and std within each group.\n\n\nThird, visually inspect detected suspects on whether they are duplicates.","2d168f60":"### Exploring image stats more in depth","2b3d3d84":"### Checking for data leak between train and sample_submission subsets with respect to 'image'","43dcb98c":"sample_submission.csv file contains metadata for the subset of test images which host made avalibale"}}