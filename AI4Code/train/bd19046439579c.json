{"cell_type":{"8fbd9c67":"code","81caaf2d":"code","16c2f280":"code","92ccc281":"code","4b6c1468":"code","266bdb3d":"code","568f19b6":"code","58a50bb6":"code","97ed2240":"code","804e4560":"code","f3ba55e9":"code","bfb55fa1":"code","b202d54f":"code","855a188e":"code","d80175c0":"code","c2499eff":"code","a78fbf77":"code","64180d08":"code","d012f98d":"code","7bec89e7":"code","7dcb7070":"markdown","145bce35":"markdown","026ebc87":"markdown","b608dff2":"markdown","789dca83":"markdown","8608dd22":"markdown","3a546217":"markdown","97db2fd5":"markdown","7fbb890f":"markdown","f083bd58":"markdown","7761766f":"markdown","180adfdc":"markdown","6f0f7ca0":"markdown","103b0923":"markdown","f75122a0":"markdown","2638e03d":"markdown","a3a6234d":"markdown","b61cdcba":"markdown"},"source":{"8fbd9c67":"features = ['PAGE_41', 'PAGE_110', 'PAGE_109', 'PAGE_108',\n       'CONTENT_CATEGORY_16', 'CONTENT_CATEGORY_BOTTOM_16', 'PAGE_321',\n       'PAGE_285', 'SITE_ID_4', 'PAGE_296', 'PAGE_360',\n       'CONTENT_CATEGORY_34', 'CONTENT_CATEGORY_BOTTOM_34',\n       'CONTENT_CATEGORY_TOP_1', 'CONTENT_CATEGORY_BOTTOM_1',\n       'CONTENT_CATEGORY_1', 'SITE_ID_1', 'PAGE_286', 'PAGE_111',\n       'PAGE_1259', 'PAGE_287', 'PAGE_39', 'PAGE_57', 'PAGE_85',\n       'PAGE_203', 'PAGE_455', 'PAGE_345', 'PAGE_153', 'PAGE_1',\n       'PAGE_123', 'SITE_ID_3', 'PAGE_202', 'PAGE_611', 'PAGE_40',\n       'PAGE_612', 'PAGE_89', 'PAGE_1227', 'PAGE_190', 'PAGE_660',\n       'PAGE_457', 'PAGE_456', 'PAGE_11', 'PAGE_516',\n       'CONTENT_CATEGORY_18', 'CONTENT_CATEGORY_BOTTOM_18', 'PAGE_426',\n       'PAGE_2', 'PAGE_4', 'PAGE_1248', 'PAGE_1247', 'PAGE_573',\n       'PAGE_901', 'PAGE_902', 'PAGE_1254', 'CONTENT_CATEGORY_TOP_3',\n       'PAGE_138', 'CONTENT_CATEGORY_20', 'CONTENT_CATEGORY_BOTTOM_20',\n       'PAGE_289', 'PAGE_9', 'PAGE_163', 'PAGE_121', 'PAGE_1249',\n       'CONTENT_CATEGORY_TOP_2', 'PAGE_20', 'PAGE_212', 'PAGE_197',\n       'PAGE_135', 'CONTENT_CATEGORY_BOTTOM_2', 'CONTENT_CATEGORY_2',\n       'PAGE_254', 'PAGE_690', 'PAGE_211', 'PAGE_903', 'PAGE_164',\n       'PAGE_346', 'PAGE_307', 'PAGE_1251', 'PAGE_165', 'PAGE_195',\n       'PAGE_210', 'PAGE_1250', 'PAGE_15', 'PAGE_243', 'PAGE_50',\n       'PAGE_49', 'PAGE_26', 'PAGE_479', 'PAGE_154', 'PAGE_69', 'PAGE_10',\n       'PAGE_284', 'PAGE_831', 'CONTENT_CATEGORY_BOTTOM_19',\n       'CONTENT_CATEGORY_19', 'PAGE_25', 'PAGE_604', 'PAGE_102',\n       'CONTENT_CATEGORY_31', 'CONTENT_CATEGORY_BOTTOM_31']","81caaf2d":"import pandas as pd\nimport numpy as np\nfrom matplotlib import pyplot as plt\nfrom tqdm import tqdm_notebook","16c2f280":"original = pd.read_csv(\"..\/input\/banco-galicia-dataton-2019\/pageviews\/pageviews.csv\",parse_dates=[\"FEC_EVENT\"])","92ccc281":"complemento = pd.read_csv(\"..\/input\/banco-galicia-dataton-2019\/pageviews_complemento\/pageviews_complemento.csv\", parse_dates=[\"FEC_EVENT\"])[original.columns]","4b6c1468":"data = pd.concat([original,complemento])\ndata.head()","266bdb3d":"conversiones = pd.read_csv(\"..\/input\/banco-galicia-dataton-2019\/conversiones\/conversiones.csv\")","568f19b6":"def month_range(window,start,end):\n    out = []\n    for i in range(window+(start-1),end+1):\n        out.append([i-j for j in range(window)])\n    return out","58a50bb6":"month_range(2,4,6)","97ed2240":"def get_col_distribution(df):\n    out = []\n    for c in tqdm_notebook(df.drop([\"USER_ID\", \"FEC_EVENT\", \"ON_SITE_SEARCH_TERM\"], axis=1).columns,leave=False):\n        temp = pd.crosstab(df.USER_ID, df[c])\n        temp.columns = [c + \"_\" + str(v) for v in temp.columns]\n#         temp = temp.apply(lambda x: x \/ x.sum(), axis=1)\n        out.append(temp)\n    return pd.concat(out, axis=1)","804e4560":"def set_conversions(df,conversions,months):\n    user_conversions = conversions[conversions.mes.isin(months)].groupby(\"USER_ID\").size()\n    user_conversions.name = \"conversions\"\n    df = df.join(user_conversions, how=\"left\")\n    df[\"conversions\"] = df[\"conversions\"].fillna(0)\n    return df","f3ba55e9":"def get_y(df,conversiones,months):\n    y = pd.Series(0, index=df.index)\n    months = [max(months) + i for i in range(1,4)]\n    idx = set(conversiones[conversiones.mes.isin(months)].USER_ID.unique()).intersection(set(df.index))\n    y.loc[list(idx)] = 1    \n    return y","bfb55fa1":"def normalize_df(df):\n    c = df.conversions.sum()\n    for col in df.drop(columns=\"conversions\"):\n        df[col] \/= c\n    return df","b202d54f":"def get_dataset(data,conversiones,months):\n    X = data[data.FEC_EVENT.dt.month.isin(months)]\n    X = get_col_distribution(X)\n    X = set_conversions(X,conversiones,months)\n    X = normalize_df(X)\n    y = get_y(X,conversiones,months)\n    return X,y","855a188e":"def unify_columns(dfs):\n    l = [df.columns for df in dfs]\n    new_cols = set(l[0]).intersection(*l).intersection(features + [\"conversions\"])\n    return [df[sorted(new_cols)] for df in dfs]","d80175c0":"Xs = []\nys = []\nfor r in tqdm_notebook(month_range(6,1,9) + month_range(7,1,9) + month_range(8,1,9)):\n    X, y = get_dataset(data, conversiones, r)\n    Xs.append(X)\n    ys.append(y)","c2499eff":"Xs = unify_columns(Xs)","a78fbf77":"X = pd.concat(Xs)\ny = pd.concat(ys)","64180d08":"print(X.columns)\nprint(len(X.columns))","d012f98d":"X_test, y_test = get_dataset(data,conversiones,[6,7,8,9,10,11,12])","7bec89e7":"X, X_test = unify_columns([X,X_test])","7dcb7070":"Una vez m\u00e1s, el intervalo elegido para el set de predicci\u00f3n es de 7 meses, por evidencia emp\u00edrica. Aclaraci\u00f3n: no todos los usuarios tienen eventos en los \u00faltimos 7 meses, por lo que hay que decidir que hacer con los usuarios restantes. La opci\u00f3n que mejores resultados di\u00f3 fue asignarles probabilidad 0. ","145bce35":"month_range devuelve una lista de listas de meses en un intervalo determinado y para un tama\u00f1o de ventana.","026ebc87":"## Lectura de los datos","b608dff2":"Finalmente, se puede utilizar cualquier modelo para realizar la predicci\u00f3n. En mi caso, utilizando RandomForest obtuve un score final de 0.84933.","789dca83":"## Generaci\u00f3n del training set","8608dd22":"set_conversions agrega una variable con la cantidad de conversiones que tuvo cada usuario en los meses indicados","3a546217":"se utilizan ventanas de 6,7 y 8 meses porque fueron las que mejores resultados dieron para las distintas combinaciones posibles (no se probaron todas igualmente)","97db2fd5":"normalize_df divide todos los features por la cantidad de conversiones en el intervalo de tiempo.","7fbb890f":"## Definici\u00f3n de funciones","f083bd58":"get_col_distribution es la funci\u00f3n de Benchmark que obtiene la cuenta de eventos para cada usuario, se descart\u00f3 ON_SITE_TERM por el feature selection previo","7761766f":"## Features utilizadas","180adfdc":"get_dataset devuelve el training_set entero para los meses indicados","6f0f7ca0":"La idea principal es modelar el comportamiento de los usuarios en distintas ventanas de tiempo. Por ejemplo, si un usuario tuvo eventos en todos los meses de Enero a Septiembre, y se define una ventana de tres meses, entonces el training set va a tener 9\/3 = 3 filas que corresponden al mismo.","103b0923":"La generaci\u00f3n de este training set parte de la hip\u00f3tesis de que la cantidad de data points no es suficiente para realizar una buena predicci\u00f3n. Si bien hay una cantidad significativa de eventos, gran parte de los mismos son pr\u00e1cticamente irrelevantes para la tarea de predicci\u00f3n.\nOtra hip\u00f3tesis importante es que los eventos m\u00e1s relevantes para determinar si un usuario va a convertir son los m\u00e1s cercanos al intervalo en el que se espera predecir.","f75122a0":"Se defini\u00f3 el siguiente conjunto de features como relevantes para el modelo, a partir de una prueba sencilla de feature selection. Esta decisi\u00f3n es para optimizar el uso de memoria y tiempo de entrenamiento.","2638e03d":"unify_columns fue definida porque no en todas las ventanas hay eventos asocidados a todas las variables, entonces se utiliza la intersecci\u00f3n.","a3a6234d":"get_y devuelve la variable que se intenta predecir: si el usuario convirti\u00f3 en los siguientes tres meses. Aclaraci\u00f3n: si el mes m\u00e1ximo del intervalo es 12, entonces \"y\" van a ser todos 0.","b61cdcba":"# Training Set usando ventanas de tiempo"}}