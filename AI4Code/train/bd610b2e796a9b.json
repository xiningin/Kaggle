{"cell_type":{"8d89fbc2":"code","90dca1aa":"code","78a907ce":"code","4dab9da5":"code","0f8be679":"code","b1a44b5c":"code","83d94308":"code","366a5f4b":"code","a3eed3b5":"code","4a783ec9":"code","12379036":"markdown","6add263b":"markdown"},"source":{"8d89fbc2":"import numpy as np\nimport pandas as pd\nfrom numba import njit, prange","90dca1aa":"data = pd.read_csv('\/kaggle\/input\/santa-workshop-tour-2019\/family_data.csv', index_col='family_id')\nprediction = pd.read_csv(\"\/kaggle\/input\/santa-s-2019-stochastic-product-search\/submission.csv\", index_col='family_id').assigned_day.values\nfamily_size = data.n_people.values.astype(np.int8)","78a907ce":"penalties = np.asarray([\n    [\n        0,\n        50,\n        50 + 9 * n,\n        100 + 9 * n,\n        200 + 9 * n,\n        200 + 18 * n,\n        300 + 18 * n,\n        300 + 36 * n,\n        400 + 36 * n,\n        500 + 36 * n + 199 * n,\n        500 + 36 * n + 398 * n\n    ] for n in range(family_size.max() + 1)\n])\nfamily_cost_matrix = np.concatenate(data.n_people.apply(lambda n: np.repeat(penalties[n, 10], 100).reshape(1, 100)))\nfor fam in data.index:\n    for choice_order, day in enumerate(data.loc[fam].drop(\"n_people\")):\n        family_cost_matrix[fam, day - 1] = penalties[data.loc[fam, \"n_people\"], choice_order]","4dab9da5":"accounting_cost_matrix = np.zeros((500, 500))\nfor n in range(accounting_cost_matrix.shape[0]):\n    for diff in range(accounting_cost_matrix.shape[1]):\n        accounting_cost_matrix[n, diff] = max(0, (n - 125.0) \/ 400.0 * n**(0.5 + diff \/ 50.0))\n","0f8be679":"@njit(fastmath=True)\ndef cost_function(prediction, family_size, family_cost_matrix, accounting_cost_matrix):\n    N_DAYS = family_cost_matrix.shape[1]\n    MAX_OCCUPANCY = 300\n    MIN_OCCUPANCY = 125\n    penalty = 0\n    daily_occupancy = np.zeros(N_DAYS + 1, dtype=np.int16)\n    for i, (pred, n) in enumerate(zip(prediction, family_size)):\n        daily_occupancy[pred - 1] += n\n        penalty += family_cost_matrix[i, pred - 1]\n\n    accounting_cost = 0\n    n_low = 0\n    n_high = 0\n    daily_occupancy[-1] = daily_occupancy[-2]\n    for day in range(N_DAYS):\n        n_next = daily_occupancy[day + 1]\n        n = daily_occupancy[day]\n        n_high += (n > MAX_OCCUPANCY) \n        n_low += (n < MIN_OCCUPANCY)\n        diff = abs(n - n_next)\n        accounting_cost += accounting_cost_matrix[n, diff]\n\n    return np.asarray([penalty, accounting_cost, n_low, n_high])","b1a44b5c":"family_size = family_size.astype(np.int16)","83d94308":"cost_function(prediction, family_size, family_cost_matrix, accounting_cost_matrix)","366a5f4b":"%timeit cost_function(prediction, family_size, family_cost_matrix, accounting_cost_matrix)","a3eed3b5":"def get_cost_consolidated(prediction): \n    fc, ac, l, h = cost_function(prediction, family_size, family_cost_matrix, accounting_cost_matrix)\n    return (fc + ac) + (l + h) * 1000000\n\nget_cost_consolidated(prediction)","4a783ec9":"prediction = pd.Series(prediction, name=\"assigned_day\")\nprediction.index.name = \"family_id\"\nprediction.to_csv(\"submission.csv\", index=True, header=True)","12379036":"## Motivation\n\nAlthough many cost functions are more than fast enough already, I wanted to a simple pythonic version, while still being blazing fast. The results are somewhere between 23 and 24 \u00b5s.\n\nAlso, I updated the cost function so it reports how many high and low days there are, instead of only out of bounds. The original function returns 4 values: family cost, accounting cost, number of days under 125 or over 300. I also show how to use closures to combine costs and penalties for out of bounds days. ","6add263b":"## References:\n\n- Original Kernel: https:\/\/www.kaggle.com\/inversion\/santa-s-2019-starter-notebook\n- First kernel that had the idea to use Numba: https:\/\/www.kaggle.com\/nickel\/250x-faster-cost-function-with-numba-jit\n- Another great cost function optimization: https:\/\/www.kaggle.com\/sekrier\/fast-scoring-using-c-52-usec\n- Original cost matrix idea: https:\/\/www.kaggle.com\/paulorzp\/cost-matrix-low-memory-and-fast\n- Better performance with family cost matrix idea: https:\/\/www.kaggle.com\/xhlulu\/santa-s-2019-300x-faster-cost-function-37-s\n- Better performance with accounting cost matrix idea: https:\/\/www.kaggle.com\/xhlulu\/santa-s-2019-faster-cost-function-24-s\n- Submission fle from: https:\/\/www.kaggle.com\/xhlulu\/santa-s-2019-stochastic-product-search"}}