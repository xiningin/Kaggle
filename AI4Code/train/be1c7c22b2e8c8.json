{"cell_type":{"3660977e":"code","91769a60":"code","09f86ce5":"code","0f080c7c":"code","5905b5ca":"code","65ce1c9a":"code","57e84ceb":"code","856ca11c":"code","c584bfc7":"code","286702dd":"code","40d13f40":"code","5bc50e04":"code","fb97dde3":"code","c759abaf":"code","4d7dbd26":"code","01a2c3cb":"code","bbcc5d90":"code","52ea3294":"code","0b25e72a":"code","60fd3841":"code","ba3cd6e5":"code","4cdda39f":"code","5f655e30":"code","594feb0d":"code","a7c65fe7":"code","a25c9e30":"code","b6acd097":"code","b3344709":"code","41b8ee76":"code","682e2ac0":"code","9c45ae1f":"code","f39669e3":"markdown","47a670b8":"markdown","a1bf1a58":"markdown","18a0b0a6":"markdown","46c344f3":"markdown","9be71875":"markdown","eb648e3f":"markdown","ebf59053":"markdown"},"source":{"3660977e":"import numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\n%matplotlib inline\nimport matplotlib.pyplot as plt\nimport seaborn as sns\nimport plotly_express as px\nplt.rcParams[\"figure.figsize\"] = (15, 10)\nplt.rcParams[\"figure.dpi\"] = 125\nplt.rcParams[\"font.size\"] = 14\nplt.rcParams['font.family'] = ['sans-serif']\nplt.rcParams['font.sans-serif'] = ['DejaVu Sans']\nplt.style.use('ggplot')\nsns.set_style(\"whitegrid\", {'axes.grid': False})\nplt.rcParams['image.cmap'] = 'gray' # grayscale looks better\nfrom itertools import cycle\nprop_cycle = plt.rcParams['axes.prop_cycle']\ncolors = prop_cycle.by_key()['color']","91769a60":"corona_df = pd.read_csv(\"..\/input\/corona-virus-report\/covid_19_clean_complete.csv\")\ncorona_df['DateCode'] = pd.to_datetime(corona_df['Date'])\ncorona_df.head(5)                      ","09f86ce5":"date_country_df = corona_df.\\\n    groupby(['DateCode', 'Country\/Region']).\\\n    agg({'Confirmed': 'sum', 'Deaths': 'sum', 'Recovered': 'sum'}).\\\n    reset_index()\ndate_country_df.head(3)","0f080c7c":"px.line(date_country_df.query('Confirmed>0'), \n        x='DateCode', \n        y='Confirmed', \n        color='Country\/Region', \n        log_y=True)","5905b5ca":"fig, ax1 = plt.subplots(1,1, figsize=(15, 15))\nsns.heatmap(\n    corona_df.\\\n        pivot_table(index='Country\/Region', columns='Date', values='Confirmed', aggfunc='sum').\\\n        sort_values('2020-04-05').\\\n        applymap(lambda x: np.log(x) if x>0 else -1),\n    ax=ax1\n)","65ce1c9a":"corona_df.pivot_table(index='Country\/Region', columns='Date', values='Confirmed', aggfunc='sum').applymap(lambda x: np.clip(x, 0, 1000)) ","57e84ceb":"px.density_heatmap(date_country_df, y='Country\/Region', x='DateCode', z='Confirmed')","856ca11c":"fig, ax1 = plt.subplots(1, 1, figsize=(10, 10))\ntwitter_countries = [('Italy', 0), ('Germany', -9), ('France', -9), ('Spain', -10.5), \n                     ('US', -11.5) ,('UK', -13.5), ('Japan', 0), ('Korea, South', +2.5), \n                    ('Taiwan*', +2.5)]\ngraph_day_zero = pd.to_datetime('2020-03-09')\ntwitter_rows = []\n\nfor c_country, offset in twitter_countries:\n    c_rows = date_country_df[date_country_df['Country\/Region'].isin([c_country])].query('Confirmed>0').sort_values(['DateCode'])\n    days_since_start = (c_rows['DateCode']-graph_day_zero).dt.total_seconds()\/(24*3600)+offset\n    group_label = f'{c_country} (Offset:{offset:5.1f})'\n    ax1.plot(days_since_start, c_rows['Confirmed'],'.-', label=group_label)\n    twitter_rows += [c_rows.assign(days_since_start=days_since_start, label=group_label)]\n\n# 33% growth\nfake_days = np.arange(-22, 3)\nax1.plot(fake_days, 30*np.power(1.33, np.arange(len(fake_days))), 'b-', label='33% Daily Increase', lw=8, alpha=0.25)\n\nax1.legend()\nax1.set_yscale('log')\nax1.set_xlabel('Days before March 9\\nWith Offset to Italy')\nax1.set_ylabel('Confirmed Cases')\nax1.set_ylim(10, 1e6)","c584bfc7":"px.line(pd.concat(twitter_rows), x='days_since_start', y='Confirmed', color='label', log_y=True)","286702dd":"countries_by_cases_df = date_country_df.\\\n    groupby('Country\/Region').\\\n    agg({'Confirmed': 'sum'}).\\\n    reset_index().\\\n    sort_values('Confirmed', ascending=False)","40d13f40":"fig, ax1 = plt.subplots(1, 1, figsize=(10, 10))\ntop_countries = countries_by_cases_df.head(8)['Country\/Region'].values.tolist()\ntop_df = date_country_df[\n        date_country_df['Country\/Region'].isin(top_countries)\n    ].query('Confirmed>0').sort_values('DateCode')\n\nfor c_country, raw_rows in top_df.groupby(['Country\/Region']):\n    c_rows = raw_rows.sort_values(['DateCode'])\n    # define day zero as when there are 100 cases\n    day_zero = c_rows.query('Confirmed>100')['DateCode'].min()\n    days_since_start = (c_rows['DateCode']-day_zero).dt.total_seconds()\/(24*3600)\n    ax1.semilogy(c_rows['DateCode']-day_zero, c_rows['Confirmed'], '-', label=f'{c_country} (First Case:{day_zero:%m-%d})')\nax1.legend()\nax1.set_xlabel('Days Since Outbreak')\nax1.set_ylabel('Confirmed Cases')","5bc50e04":"from sklearn.linear_model import LinearRegression\nout_rows = []\nlr_rows = []\nfor c_country, raw_rows in date_country_df.groupby(['Country\/Region']):\n    c_rows = raw_rows.sort_values(['DateCode'])\n    # define day zero as when there are 100 cases\n    if c_rows.query('Confirmed>100').shape[0]>1:\n        day_zero = c_rows.query('Confirmed>100')['DateCode'].min()\n        days_since_start = (c_rows['DateCode']-day_zero).dt.total_seconds()\/(24*3600)\n        group_label = f'{c_country} (First Case:{day_zero:%m-%d})'\n        \n        out_rows += [c_rows.assign(days_since_start=days_since_start, \n                                   day_zero=day_zero, \n                                   label=group_label)]\nnorm_rows_df = pd.concat(out_rows)","fb97dde3":"px.line(norm_rows_df, \n        x='days_since_start', \n        y='Confirmed', \n        color='Country\/Region', \n        log_y=True)","c759abaf":"from sklearn.linear_model import LinearRegression\nlr_rows = []\nfor c_country, raw_rows in date_country_df.groupby(['Country\/Region']):\n    c_rows = raw_rows.sort_values(['DateCode'])\n    # define day zero as when there are 100 cases\n    if c_rows.query('Confirmed>100').shape[0]>1:\n        day_zero = c_rows.query('Confirmed>100')['DateCode'].min()\n        days_since_start = (c_rows['DateCode']-day_zero).dt.total_seconds()\/(24*3600)\n        group_label = f'{c_country} (Outbreak Day: {day_zero:%m-%d})'\n        \n        lr = LinearRegression()\n        lr.fit(days_since_start.values.reshape((-1, 1)), c_rows['Confirmed'])\n        lr_rows.append(dict(New_Cases_Per_Day=lr.coef_[0], day_zero=day_zero, label=group_label, Total_Confirmed_Cases=c_rows['Confirmed'].max()))\nlr_rows_df = pd.DataFrame(lr_rows)\nlr_rows_df.sample(3)","4d7dbd26":"import plotly.graph_objects as go\nfig = px.scatter(lr_rows_df, \n        y='New_Cases_Per_Day', \n        x='Total_Confirmed_Cases', \n        color='label', \n        log_x=True,\n        log_y=True)\n\n# 33% growth\ntotal_cases = 50*np.power(1.33, np.arange(20))\nnew_cases_per_day = np.diff(total_cases, axis=0)\nfig.add_trace(go.Scatter(x=total_cases[1:], y=new_cases_per_day,\n                    mode='lines',\n                    name='33% Daily Increase'))","01a2c3cb":"all_diff_rows = []\nfor c_country, raw_rows in date_country_df.groupby(['Country\/Region']):\n    c_rows = raw_rows.sort_values(['DateCode'])\n    # define day zero as when there are 100 cases\n    if c_rows.query('Confirmed>100').shape[0]>1:\n        day_zero = c_rows.query('Confirmed>100')['DateCode'].min()\n        days_since_start = (c_rows['DateCode']-day_zero).dt.total_seconds()\/(24*3600)\n        group_label = f'{c_country} (Outbreak Day: {day_zero:%m-%d})'\n        \n        all_diff_rows.append(c_rows.assign(\n            New_Cases_Per_Day=c_rows['Confirmed'].diff(), \n            day_zero=day_zero, \n            label=group_label, \n            Total_Confirmed_Cases=c_rows['Confirmed'].max(),\n            days_since_start=days_since_start\n        ))\nall_diff_rows_df = pd.concat(all_diff_rows).dropna()\nall_diff_rows_df.sample(3)","bbcc5d90":"fig = px.line(all_diff_rows_df.query('New_Cases_Per_Day>0'), \n        y='New_Cases_Per_Day', \n        x='Confirmed', \n        color='label', \n        log_x=True,\n        log_y=True)\n\n# 33% growth\ntotal_cases = 10*np.power(1.33, np.arange(35))\nnew_cases_per_day = np.diff(total_cases, axis=0)\nfig.add_trace(go.Scatter(x=total_cases[1:], y=new_cases_per_day,\n                    mode='lines',\n                         line=dict(width=12),\n                         opacity=0.5,\n                    name='33% Daily Increase'))","52ea3294":"fig = px.scatter(all_diff_rows_df, \n        y='New_Cases_Per_Day', \n        x='Confirmed', \n        color='label', \n        log_x=True,\n        log_y=True)\n\n# 33% growth\ntotal_cases = 50*np.power(1.33, np.arange(20))\nnew_cases_per_day = np.diff(total_cases, axis=0)\nfig.add_trace(go.Scatter(x=total_cases[1:], y=new_cases_per_day,\n                    mode='lines',\n                    name='33% Daily Increase'))","0b25e72a":"fig, ax1 = plt.subplots(1, 1, figsize=(10, 10))\ntop_countries = countries_by_cases_df.head(8)['Country\/Region'].values.tolist()\ntop_df = date_country_df[\n        date_country_df['Country\/Region'].isin(top_countries)\n    ].query('Deaths>0').sort_values('DateCode')\n\nfor c_country, raw_rows in top_df.groupby(['Country\/Region']):\n    c_rows = raw_rows.sort_values(['DateCode'])\n    # define day zero as when there are 100 cases\n    day_zero = c_rows.query('Deaths>1')['DateCode'].min()\n    days_since_start = (c_rows['DateCode']-day_zero).dt.total_seconds()\/(24*3600)\n    ax1.semilogy(c_rows['DateCode']-day_zero, c_rows['Deaths'], '-', label=f'{c_country} (First Case:{day_zero:%m-%d})')\nax1.legend()\nax1.set_xlabel('Days Since Outbreak')\nax1.set_ylabel('Confirmed Cases')","60fd3841":"all_death_diff_rows = []\nfor c_country, raw_rows in date_country_df.groupby(['Country\/Region']):\n    c_rows = raw_rows.sort_values(['DateCode'])\n    # define day zero as when there are 10 deaths\n    if c_rows.query('Deaths>10').shape[0]>1:\n        day_zero = c_rows.query('Deaths>10')['DateCode'].min()\n        days_since_start = (c_rows['DateCode']-day_zero).dt.total_seconds()\/(24*3600)\n        group_label = f'{c_country} (Outbreak Day: {day_zero:%m-%d})'\n        \n        all_death_diff_rows.append(c_rows.assign(\n            New_Deaths_Per_Day=c_rows['Deaths'].diff(), \n            New_Cases_Per_Day=c_rows['Confirmed'].diff(), \n            New_Recovery_Per_Day=c_rows['Recovered'].diff(), \n            day_zero=day_zero, \n            label=group_label, \n            Total_Deaths_Cases=c_rows['Deaths'].max(),\n            days_since_start=days_since_start\n        ))\nall_death_diff_rows_df = pd.concat(all_death_diff_rows).dropna()\nall_death_diff_rows_df.sample(3)","ba3cd6e5":"fig = px.scatter(all_death_diff_rows_df, \n        y='New_Deaths_Per_Day', \n        x='Deaths', \n        color='label', \n        log_x=True,\n        log_y=True)\n\n# 33% growth\ntotal_cases = 50*np.power(1.33, np.arange(10))\nnew_cases_per_day = np.diff(total_cases, axis=0)\nfig.add_trace(go.Scatter(x=total_cases[1:], y=new_cases_per_day,\n                    mode='lines',\n                    name='33% Daily Increase'))","4cdda39f":"corona_df['QLat'] = pd.cut(corona_df['Lat'], 100)\ncorona_df['QLong'] = pd.cut(corona_df['Long'], 100)","5f655e30":"def summarize_grid(in_rows):\n    return in_rows.\\\n        groupby('DateCode').\\\n        agg({'Confirmed': 'sum', 'Deaths': 'sum', 'Recovered': 'sum', \n         'Country\/Region': 'first', 'Province\/State': 'first'}).\\\n        reset_index()\ndef cut_to_num(in_str: str) -> float:\n    \"\"\"Takes the middle of qcut range\"\"\"\n    clean_str = str(in_str).replace('(', '').replace('[', '').replace(']', '').replace(')', '')\n    return np.mean([float(x) for x in clean_str.split(',')])    \ndate_grid_df = corona_df.\\\n    groupby(['QLat', 'QLong']).\\\n    apply(summarize_grid).\\\n    reset_index().\\\n    dropna().\\\n    assign(Lat=lambda x: x['QLat'].astype(str).map(cut_to_num), \n           Long=lambda x: x['QLong'].astype(str).map(cut_to_num))\ndate_grid_df.head(3)","594feb0d":"sum_grid_df = date_grid_df.groupby(['Lat', 'Long']).agg({'Confirmed': 'sum'}).reset_index().query('Confirmed>0')","a7c65fe7":"plt.scatter(sum_grid_df['Long'], sum_grid_df['Lat'], s=10*np.log10(sum_grid_df['Confirmed']))","a25c9e30":"from mpl_toolkits.basemap import Basemap\nworld_map = Basemap(projection='ortho',lat_0=45,lon_0=100,resolution='l')\nworld_map.drawcoastlines(linewidth=0.25)\nworld_map.drawcountries(linewidth=0.25)\nworld_map.fillcontinents(color='lightgreen',lake_color='aqua', alpha=0.25)\n\nworld_map.scatter(sum_grid_df['Long'].values, \n                  sum_grid_df['Lat'].values, \n                  s=10*np.log10(sum_grid_df['Confirmed']),\n                  c='r',\n                  latlon=True)","b6acd097":"out_rows = []\nfig, (ax1, ax2) = plt.subplots(1, 2, figsize=(10, 5))\nfor c_bucket, raw_rows in date_grid_df.groupby(['QLat', 'QLong']):\n    if raw_rows.query('Confirmed>10').shape[0]>0:\n        c_rows = raw_rows.sort_values(['DateCode'])\n        # define day zero as when there are 100 cases\n        day_zero = c_rows.query('Confirmed>10')['DateCode'].min()\n        days_since_start = (c_rows['DateCode']-day_zero).dt.total_seconds()\/(24*3600)\n        ax1.semilogy(days_since_start, c_rows['Confirmed'], '-', label=f'{c_bucket} (First Case:{day_zero:%m-%d})')\n        ax2.semilogy(days_since_start, c_rows['Deaths'], '-', label=f'{c_bucket} (First Case:{day_zero:%m-%d})')\n        lr = LinearRegression()\n        lr.fit(days_since_start.values.reshape((-1, 1)), c_rows['Confirmed'])\n    else:\n        lr = LinearRegression()\n        day_zero = raw_rows['DateCode'].min()\n        days_since_start = (raw_rows['DateCode']-day_zero).dt.total_seconds()\/(24*3600)\n        lr.fit(days_since_start.values.reshape((-1, 1)), raw_rows['Confirmed'])\n    out_rows.append(dict({\n        'Lat': raw_rows['Lat'].iloc[0],\n        'Long': raw_rows['Long'].iloc[0],\n        'Region': raw_rows['Country\/Region'].iloc[0],\n        'State': raw_rows['Province\/State'].iloc[0],\n        'day_zero': day_zero,\n        'spread_rate': lr.coef_[0],\n        'max_confirmed': raw_rows['Confirmed'].max(),\n        'max_deaths': raw_rows['Deaths'].max()\n                         }))\nax1.set_xlabel('Days Since Outbreak')\nax1.set_ylabel('Confirmed Cases')\nax2.set_ylabel('Confirmed Deaths')","b3344709":"grid_growth_df = pd.DataFrame(out_rows).sort_values('spread_rate', ascending=False)\nprint(grid_growth_df.shape[0])\ngrid_growth_df.head(10)","41b8ee76":"plt.scatter(grid_growth_df['Long'], grid_growth_df['Lat'], s=np.clip(grid_growth_df['spread_rate'], 0, 25))","682e2ac0":"world_map = Basemap(projection='ortho',lat_0=30,lon_0=50,resolution='l')\nworld_map.drawcoastlines(linewidth=0.25)\nworld_map.drawcountries(linewidth=0.25)\nworld_map.fillcontinents(color='lightgreen',lake_color='aqua', alpha=0.25)\n\nworld_map.scatter(grid_growth_df['Long'].values, \n                  grid_growth_df['Lat'].values, \n                  s=np.clip(grid_growth_df['spread_rate'], 0, 25),\n                  c='r',\n                  latlon=True)","9c45ae1f":"px.scatter_geo(grid_growth_df, lat='Lat', lon='Long', color='spread_rate', size='max_deaths')","f39669e3":"# Deaths\nSince confirmed infections are a fairly difficult to measure number (and highly depenedent on testing). Using deaths as an end-point is probably more reliable","47a670b8":"# Lat\/Long Grids\nRather than country we can focus on latitude longitude grids","a1bf1a58":"## Top Country Overview","18a0b0a6":"## Big Summary Table\nThis should show all the countries, not sure why they are missing","46c344f3":"## Capture Intermediate Points","9be71875":"# Overview\n- Basically trying to reproduce this graph: https:\/\/twitter.com\/MarkJHandley\/status\/1237119688578138112\/photo\/1 showing a linear (on a semilog scale) growth and a particularly slow\/quick peaking growth in Japan.\n- I try to also see how number of people infected relates to the average spread in a country\n- Finally I drop the country pretense and just look at grids of latitute and longitude","eb648e3f":"# Twitter Post Line\nHere I try to reproduce the twitter post","ebf59053":"# Slope for Each Country"}}