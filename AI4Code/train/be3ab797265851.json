{"cell_type":{"cf3312ae":"code","84975424":"code","0d171cae":"code","01844aa1":"code","5ee16e54":"code","3c28a183":"code","2ca6e897":"code","74cbc77e":"code","ffe1ca4c":"code","667a13c7":"code","2cd1966a":"code","73c15e88":"code","1e8f2166":"code","6b951640":"code","9c4091e5":"code","d416d225":"code","46c54d52":"code","7a69cb63":"code","ec695082":"code","9d6ad59b":"code","0cbca45b":"code","3cdfec9b":"code","a034012c":"code","d94545a1":"code","58abb0cc":"code","ac5250a3":"code","258c7578":"code","8a32d500":"code","80e1b417":"code","c61bf56c":"code","64c476cf":"code","3c2ec02d":"code","8cb30246":"code","66b96e90":"code","d3e153a2":"code","d23bf8fa":"code","438fd889":"code","f895c77a":"code","b7739c1a":"code","e908d38a":"code","3ead933d":"code","56125c56":"code","8dded949":"code","28f31a95":"code","b0840d67":"code","6171c9de":"code","24af5e63":"code","238b12d9":"code","30c36364":"markdown","4e0e3697":"markdown","84fcec17":"markdown","2c4914e0":"markdown","395c83f6":"markdown","091a872a":"markdown","585feb3f":"markdown","10f25274":"markdown","0221f63c":"markdown","b3fc8862":"markdown","bd587349":"markdown","33f35542":"markdown","1db48a53":"markdown","af6e758d":"markdown","f40e75e3":"markdown","023cf8d9":"markdown","c4cd35ad":"markdown","0e4e153a":"markdown","19277932":"markdown","f03df862":"markdown","149c8a06":"markdown","76b1793c":"markdown","fd67507f":"markdown","0bae157d":"markdown"},"source":{"cf3312ae":"from datetime import datetime\nimport numpy as np\nimport pandas as pd\nimport geopandas as gpd\nimport geoplot\nimport mapclassify\nimport matplotlib.pyplot as plt\nimport matplotlib.colors as colors\n\n%matplotlib inline\nimport matplotlib.pyplot as pyplot","84975424":"HISTORY_DATA_URL='\/kaggle\/input\/corona-infection-data-032020-until-102020\/corona_history.csv'","0d171cae":"START_DATE='05-mar-2020'\nLATEST_DATE='13-oct-2020'","01844aa1":"df = pd.read_csv(HISTORY_DATA_URL, usecols=['parent', 'label', 'label_parent', 'population', 'date', 'updated', 'confirmed', 'recovered', 'deaths'])\ndf['date'] = pd.to_datetime(df['date'], format=\"%Y-%m-%d\")\n\nhistory_df = df[(df.date>pd.to_datetime(START_DATE)) & (df.date<=LATEST_DATE)]","5ee16e54":"LATEST_DATE","3c28a183":"bln_df = history_df[history_df.label=='Berlin'].copy()\nbln_df.drop(columns=['parent','label_parent','updated'],inplace=True)\nbln_df['active'] = bln_df['confirmed'] - (bln_df['recovered'] + bln_df['deaths'])","2ca6e897":"BLN_POPULATION=int(bln_df['population'].tail(1))","74cbc77e":"de_bln_all = bln_df.drop(columns=['population','label']).set_index('date')","ffe1ca4c":"de_bln = history_df[history_df.parent=='de.be'].copy() # does not work any more for Charlottenburg :-(\nde_bln.drop(columns=['parent','label_parent','updated'],inplace=True)\nde_bln['active'] = de_bln['confirmed'] - (de_bln['recovered'] + de_bln['deaths'])","667a13c7":"population_per_district_bln = de_bln[['label','population']].dropna().rename(columns={'label':'district'}).groupby('district').last()","2cd1966a":"def draw_threshold_lines():\n    plt.axhline(30, color='red')\n    plt.text(LATEST_DATE,31,'Rote Berliner Ampel',ha='right', color='red')\n    plt.axhline(50, color='darkred')\n    plt.text(LATEST_DATE,51,'German Maximum',ha='right', color='darkred')\n       \ndef severity_color_berliner_ampel(c):\n    if c >= 50:\n        return 'background-color: darkred'\n    if c >= 30:\n        return 'background-color: red'          \n    if c >= 20:\n        return 'background-color: orange'        \n    else:\n        return 'background-color: white'    ","73c15e88":"bln = (\n    gpd.read_file('..\/input\/berlin-districts\/berliner_bezirke.shp', encoding='utf-8')\n        .rename(columns={'name':'district'})[['district','geometry']]\n        .set_index('district')\n)","1e8f2166":"de_bln_all.tail()","6b951640":"de_bln_all.plot(figsize=(12,5), title='Berlin: Absolute Cases')\npyplot.grid(True);","9c4091e5":"def abs_growth_from(df_by_date):\n    return df_by_date.diff().fillna(0)\n\ndef plot_abs_growth(df_abs_growth ,details=\"\",column='confirmed', max_y=None):\n    max_y = max_y if max_y else df_abs_growth[column].max()\n    ax = df_abs_growth.plot(figsize=(12,4), title='New {} 1day: {}'.format(column, details), ylim=(0,max_y))\n    pyplot.ylabel('Delta to day before');\n    pyplot.grid(True)\n    return ax","d416d225":"abs_growth_bln_by_date = abs_growth_from(de_bln_all)\nabs_growth_bln_by_date.tail()","46c54d52":"plot_abs_growth(abs_growth_bln_by_date,'Berlin');","7a69cb63":"abs_growth_c = abs_growth_bln_by_date['confirmed']\nabs_growth_confirmed = pd.DataFrame({'confirmed':abs_growth_c, 'confirmed_mean_7days' : abs_growth_c.rolling(7).mean()})\nplot_abs_growth(abs_growth_confirmed,'Berlin');","ec695082":"abs_growth_d = abs_growth_bln_by_date['deaths']\nabs_growth_deaths = pd.DataFrame({'deaths':abs_growth_d, 'deaths_mean_7days' : abs_growth_d.rolling(7).mean()})\nplot_abs_growth(abs_growth_deaths,'Berlin','deaths');","9d6ad59b":"PER_INHABITANTS = 100000","0cbca45b":"new_infections7days_bln=abs_growth_c.rolling(7).sum()*PER_INHABITANTS\/BLN_POPULATION\nnew_deaths7days_bln=abs_growth_d.rolling(7).sum()*PER_INHABITANTS\/BLN_POPULATION\nnew_7days_bln=pd.DataFrame({'new_infections_7days_per100k':new_infections7days_bln, 'new_deaths_7days_per100k' : new_deaths7days_bln})","3cdfec9b":"new_7days_bln.tail(7).style.applymap(lambda c: severity_color_berliner_ampel(c))","a034012c":"plt.figure(figsize=(14,7))\n\nax1 = plt.subplot(121, title = \"Berlin: New Infections last 7 days per 100k inhabitants\")\nnew_infections7days_bln.plot(ax=ax1, grid=True)\n\ndraw_threshold_lines()\n\nax2 = plt.subplot(122, title = \"Berlin: New Deaths last 7 days per 100k inhabitants\")\nnew_deaths7days_bln.plot(ax=ax2, grid=True);","d94545a1":"DAYS_BEFORE=4\nDAYS=7\nabs_growth_c_lastXdays = abs_growth_c.rolling(DAYS).sum()\nr = abs_growth_c_lastXdays\/abs_growth_c_lastXdays.shift(4)\nr.tail(14)","58abb0cc":"def ampel_color_r(r):\n    r_last3days = r.tail(3)\n    if (r_last3days>1.2).sum()>=3:\n        return 'red'\n    if (r_last3days>1.1).sum()>=3:\n        return 'yellow'\n    else:\n        return 'green'\n    \ndef ampel_color_new_infections7days(new_infections7days):\n    last_new = new_infections7days[-1]\n    if last_new>=30:\n        return 'red'\n    if last_new>=20:\n        return 'yellow'\n    else:\n        return 'green'    \n    \nprint (\"R-Wert         : {}\".format(ampel_color_r(r)))\nprint (\"7-Tage-Incidenz: {}\".format(ampel_color_new_infections7days(new_7days_bln.new_infections_7days_per100k)))","ac5250a3":"bln_districts = de_bln[de_bln.label != 'weitere F\u00e4lle in Berlin'].rename(columns={'label':'district'})","258c7578":"bln_districts_by_date_district=bln_districts.set_index(['date','district'])\nbln_districts_by_date_district['active_per_inhabitants']=bln_districts_by_date_district['active']\/bln_districts_by_date_district['population']*PER_INHABITANTS","8a32d500":"bln_district_cases_by_date=bln_districts_by_date_district.reset_index().drop(columns=['population']).set_index(['date']).groupby('district')\nbln_district_cases_by_date.last().sort_values(by='active_per_inhabitants', ascending=False)","80e1b417":"bln_district_cases_by_date['confirmed'].plot(figsize=(15,7), legend=True, title='Absolute Confirmed by Berlin Districts');\npyplot.grid(True)","c61bf56c":"bln_district_cases_by_date['active'].plot(figsize=(15,7), legend=True, title='Absolute Active by Berlin Districts');\npyplot.grid(True)","64c476cf":"active_per_inhabitants_w_geo=bln.merge(bln_district_cases_by_date.last()[['active_per_inhabitants']], left_index=True, right_index=True)","3c2ec02d":"bln_district_cases_by_date['active_per_inhabitants'].plot(figsize=(15,7), legend=True, title='Active per 100.000 inhabitants by Berlin Districts');\npyplot.grid(True)","8cb30246":"geoplot.choropleth(\n    active_per_inhabitants_w_geo, \n    hue='active_per_inhabitants',\n    cmap='Reds',\n    legend=True\n);\nplt.suptitle('Current active per 100k inhabitants');","66b96e90":"bln_districts_new_by_date_and_district=abs_growth_from(bln_districts_by_date_district['confirmed'])\nbln_districts_new = bln_districts_new_by_date_and_district.reset_index().rename(columns={'confirmed':'new_infections'})","d3e153a2":"bln_districts_new_by_date_per_district = pd.pivot_table(bln_districts_new, values='new_infections', index=['date'],\n                    columns=['district']).tail(16)","d23bf8fa":"def weekenddays(s):\n    return ['background-color: grey' if s.date.dayofweek in [5,6] else '']*s.size\n\ndef null_report(c):\n    return 'background-color : yellow' if isinstance(c, (int, float, complex))  and c<1 else ''\n    \n    \nbln_districts_new_by_date_per_district.reset_index().style.apply(weekenddays, axis=1).applymap(null_report).hide_index()","438fd889":"bln_districts_new_by_date=bln_districts_new.set_index('date').groupby('district')\nbln_districts_new_by_date_last=bln_districts_new_by_date.last()\nbln_districts_new_by_date_last['new\/max %'] = bln_districts_new_by_date.last()\/bln_districts_new_by_date.max()*100\n\n# FIX drop Charlottenburg-Wilmersdorf, because we don't get any data anymore\nnew_infections = bln_districts_new_by_date_last.drop('Charlottenburg-Wilmersdorf')\n\nnew_infections.sort_values(by='new\/max %', ascending=False, inplace=True)","f895c77a":"def highlight(df):\n    num_of_cols = df.size\n    if df.new_infections < 1.0:\n        return ['background-color: yellow']*num_of_cols\n    else:\n        if df['new\/max %'] >= 100:\n            return ['background-color: red']*num_of_cols\n        else:\n            return ['background-color: white']*num_of_cols\n\nnew_infections.style.apply(highlight, axis=1)        ","b7739c1a":"bln_districts_new_by_date_last.new_infections.sum()","e908d38a":"bln_districts_new7days = bln_districts_new_by_date_and_district.rolling(7).sum().reset_index().rename(columns={'confirmed':'new_infections7days'}) \n\n# FIX drop Charlottenburg-Wilmersdorf, because we don't get any data anymore\nwo_charlottenburg=bln_districts_new7days.set_index('district').drop('Charlottenburg-Wilmersdorf')\nbln_districts_new7days_with_pop = wo_charlottenburg.merge(population_per_district_bln, left_index=True, right_index=True).reset_index()","3ead933d":"bln_districts_new7days_by_date_with_pop = bln_districts_new7days_with_pop.set_index('date')","56125c56":"bln_districts_new7days_by_date_with_pop['new_infections7days_per100k'] = (\n    bln_districts_new7days_by_date_with_pop['new_infections7days']\/bln_districts_new7days_by_date_with_pop['population']*PER_INHABITANTS\n)\nbln_districts_new7days_by_date=bln_districts_new7days_by_date_with_pop.drop(columns=['population'])","8dded949":"bln_districts_new7days_last=bln_districts_new7days_by_date.groupby(by=\"district\").last()\nnew7days = bln_districts_new7days_last.sort_values(by='new_infections7days_per100k', ascending=False)","28f31a95":"def highlight(df):\n    num_of_cols = df.size\n    if df.new_infections7days < 1.0:\n        return ['background-color: yellow']*num_of_cols\n    else:\n        return [severity_color_berliner_ampel(df['new_infections7days_per100k'])]*num_of_cols\n        \nnew7days.style.apply(highlight, axis=1)        ","b0840d67":"bln_districts_new7days_by_date.groupby(by=\"district\")['new_infections7days'].plot(\n    figsize=(17,7), legend=True, title='Absolute New Infections 7 days by Berlin Districts',\n    ylim=(0,bln_districts_new7days_by_date['new_infections7days'].max())\n);\npyplot.grid(True)","6171c9de":"new7d_w_geo=bln.merge(bln_districts_new7days_last[['new_infections7days_per100k']], left_index=True, right_index=True)\nnew7d_w_geo['new_infections7days_per100k_cut30'] = new7d_w_geo['new_infections7days_per100k'].apply(lambda v:v if v<30 else 30)\nnew7d_w_geo['new_infections7days_per100k_cut50'] = new7d_w_geo['new_infections7days_per100k'].apply(lambda v:v if v<50 else 50)","24af5e63":"plt.figure(figsize=(15,7))\nax = plt.subplot(131, title = \"New Infections last 7 days per 100k inhabitants\")\ngeoplot.choropleth(\n    new7d_w_geo, \n    hue='new_infections7days_per100k',\n    cmap='Reds',\n    legend=True,\n    legend_kwargs={'orientation': 'horizontal'},\n    ax=ax\n);\n\nif (new7d_w_geo.new_infections7days_per100k <= 30).sum() >0:\n    ax = plt.subplot(132, title = \"New Infections last 7 days per 100k inhabitants\\n cut to max=30 (Berliner Ampel)\")\n    geoplot.choropleth(\n        new7d_w_geo, \n        hue='new_infections7days_per100k_cut30',\n        cmap='Reds',\n        legend=True,\n        legend_kwargs={'orientation': 'horizontal'},    \n        ax=ax\n    );\n\n\nax = plt.subplot(133, title = \"New Infections last 7 days per 100k inhabitants\\n  cut to max=50 (German Maximum)\")\ngeoplot.choropleth(\n    new7d_w_geo, \n    hue='new_infections7days_per100k_cut50',\n    cmap='Reds',\n    legend=True,\n    legend_kwargs={'orientation': 'horizontal'},    \n    ax=ax\n);","238b12d9":"bln_districts_new7days_by_date.groupby(by=\"district\")['new_infections7days_per100k'].plot(\n    figsize=(17,7), legend=True, title='New Infections 7 days per 100.000 inhabitants by Berlin Districts',\n    ylim=(0,bln_districts_new7days_by_date['new_infections7days_per100k'].max())\n);\n\ndraw_threshold_lines()\npyplot.grid(True)","30c36364":"## Corona Data","4e0e3697":"### Berlin: New Death 1 Day\n\n- Absolute new deaths for 1 day\n- Mean over 7 days of deaths for 1 day","84fcec17":"## Berlin: Absolute Cases","2c4914e0":"**Note**, that \n- values higher than the current maximum are colored **red**, and \n- **zero**-values, which indicate, that a district didn't ship new numbers this day, are **yellow**.","395c83f6":"# Data","091a872a":"# Links\n\nThe definition of the 'Berliner Ampel' can be found here:\n- [Berliner Senat: Corona Ampel](https:\/\/www.berlin.de\/sen\/gpg\/service\/presse\/2020\/pressemitteilung.950145.php)\n- [RBB: Das ist die Corona-Ampel \u2013 mit all ihren Schwierigkeiten](https:\/\/www.rbb24.de\/panorama\/thema\/2020\/coronavirus\/service\/corona-ampel-infektionen-berlin.html)\n\nFor a more detailed geographical case analysis please visit \n- the [Lagebericht des Berliner Senats](https:\/\/www.berlin.de\/corona\/lagebericht\/)\n- the [Robert Koch-Institut: COVID-19-Dashboard](https:\/\/experience.arcgis.com\/experience\/478220a4c454480e823b17327b2bf1d4)\n- the [Infektionskarte of the Berliner Morgenpost](https:\/\/interaktiv.morgenpost.de\/corona-virus-karte-infektionen-deutschland-weltweit\/)\n\nThe case numbers for Berlin originally are published by the LAGESO:\n- [Berlin: new infections last day](https:\/\/www.berlin.de\/lageso\/gesundheit\/infektionsepidemiologie-infektionsschutz\/corona\/tabelle-bezirke\/)\n\nMy further analyses notebooks can be found at\n- [COVID-19-Germany - Geo Case Hotspot Analysis](https:\/\/www.kaggle.com\/pat777\/covid-19-germany-geo-case-hotspot-analysis\/)\n- [COVID-19-Germany - Case Overview](https:\/\/www.kaggle.com\/pat777\/covid-19-germany-case-overview\/)","585feb3f":"## New Infections per District 7 Days","10f25274":"# Berlin Ampel\n\nsee also the [Official Lagebericht of the Berliner Senat](https:\/\/www.berlin.de\/corona\/lagebericht\/desktop\/corona.html#corona-ampel)","0221f63c":"## Berlin: R7 (7-days-R of RKI)\n\n**Definition**\n\nThe 7-day-R compares the 7-days mean of new infections with the 7-days mean **4** days ago.\n\nr7 = (new infections on the 7 days([N-6,N])\/7) \/ (new infections on the 7 days([N-10,N-4])\/7)\n\n**Note**\n\nThe RKI does not use the actually reported case numbers for the last 3 days, but applies a now-cast (forecast) to these numbers. Thus the following calculation differs from that one of the RKI.","b3fc8862":"### Berlin: New Infections 1 Day\n\n- Absolute new confirmed cases for 1 day\n- Mean over 7 days of new absolute confirmed cases for 1 day","bd587349":"## New Infections","33f35542":"# Districts of Berlin","1db48a53":"# Berlin","af6e758d":"### New Infections 1 day (without Charlottenburg-Wilmersdorf)","f40e75e3":"## Berlin: Absolute Growth 1 Day","023cf8d9":"On base of the data the of the [Berliner Morgenpost](https:\/\/interaktiv.morgenpost.de\/corona-virus-karte-infektionen-deutschland-weltweit\/) this notebook analyzes \n- how the Corona spread out in Berlin\n- what the hotspots were\nbetween **march 5th 2020 and oct 13th 2020** (when the details API of the Berliner Morgenpost stopped to work).\n\nNote, that this notebook is continued in [Corona Cases in Berlin (Lageso)](https:\/\/www.kaggle.com\/pat777\/covid-19-berlin), which takes its data from the [LaGeSo](https:\/\/www.berlin.de\/lageso\/gesundheit\/infektionsepidemiologie-infektionsschutz\/corona\/tabelle-bezirke-gesamtuebersicht\/).","c4cd35ad":"## Berlin: New Infections over 7 Days","0e4e153a":"**Note**, that \n- values higher or equal than 30 per 10k are colored **red** (Berliner Ampel), and \n- values higher or equal than 20 and lower than 30 per 10k are colored **orange** (Berliner Ampel), and \n- **zero**-values, which indicate, that a district didn't ship new numbers, are **yellow**.","19277932":"## Note: We don't have numbers from Charlottenburg-Wilmersdorf any more!!!","f03df862":"## New Infections per District 1 Day","149c8a06":"## New Infections per Destrict 14 days\n\n**Yellow** Cells indicate, that zero cases have been reported this day (for what reason ever).","76b1793c":"# Corona Cases in Berlin\n\n march 5th 2020 - oct 13th 2020 - **DISCONTINUED**","fd67507f":"## Absolute Cases","0bae157d":"## Helpers"}}