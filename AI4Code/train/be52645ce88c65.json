{"cell_type":{"e7bc2b02":"code","f3985ddf":"code","e654f941":"code","5c836008":"code","3ad2d786":"code","4465029d":"code","4734d426":"code","b15f05a8":"code","3b69e7ac":"code","0312b5d8":"code","98b65b8b":"code","21fca9af":"code","4c5d2c18":"code","857b68df":"code","03819a9a":"markdown","a7643f2a":"markdown","1ab93bf8":"markdown","18e82651":"markdown"},"source":{"e7bc2b02":"%%html\n<style>\n@import url('https:\/\/fonts.googleapis.com\/css?family=Ewert|Roboto&effect=3d|ice|');\nspan {font-family:'Roboto'; color:black; text-shadow: 5px 5px 5px #aaa;}  \ndiv.output_area pre{font-family:'Roboto'; font-size:110%; color: steelblue;}      \n<\/style>","f3985ddf":"import numpy as np,pandas as pd,keras as ks\nimport os,ast,warnings\nimport pylab as pl\nfrom skimage.transform import resize\nfrom sklearn.model_selection import train_test_split\nfrom sklearn.metrics import confusion_matrix,\\\nclassification_report\nfrom keras.callbacks import ModelCheckpoint,\\\nReduceLROnPlateau\nfrom keras.models import Sequential\nfrom keras.layers.advanced_activations import LeakyReLU\nfrom keras.layers import Activation,Dropout,Dense,\\\nConv2D, MaxPooling2D, GlobalMaxPooling2D\nwarnings.filterwarnings('ignore')\npl.style.use('seaborn-whitegrid')\nstyle_dict={'background-color':'gainsboro','color':'steelblue', \n            'border-color':'white','font-family':'Roboto'}\nos.listdir(\"..\/input\")","e654f941":"fpath='..\/input\/quickdraw-doodle-recognition\/train_simplified\/'\nfiles=os.listdir(fpath)\nlabels=[el.replace(\" \",\"_\")[:-4] for el in files]\nprint(sorted(labels)) # 340 labels - 17 sets","5c836008":"wpath='..\/input\/quick-draw-model-weights-for-doodle-recognition\/weights\/'\nweights=sorted(os.listdir(wpath))\nprint(weights) # files with weights for 17 label sets","3ad2d786":"I=64 # image size in pixels\nT=20 # number of labels in one set","4465029d":"# https:\/\/stackoverflow.com\/questions\/25837544\/get-all-points-of-a-straight-line-in-python\ndef get_line(x1,y1,x2,y2):\n    steep=abs(y2-y1)>abs(x2-x1)\n    if steep: x1,y1,x2,y2=y1,x1,y2,x2\n    rev=False\n    if x1>x2:\n        x1,x2,y1,y2=x2,x1,y2,y1\n        rev=True\n    dx=x2-x1; dy=abs(y2-y1)\n    error=int(dx\/2)\n    xy=[]; y=y1; ystep=None\n    if y1<y2: ystep=1\n    else: ystep=-1\n    for x in range(x1,x2+1):\n        if steep: xy.append([y,x])\n        else: xy.append([x,y])\n        error-=dy\n        if error<0:\n            y+=ystep\n            error+=dx\n    if rev: xy.reverse()\n    return xy\ndef display_drawing():\n    pl.figure(figsize=(10,10))\n    pl.suptitle('Test Pictures')\n    for i in range(20):\n        picture=ast.literal_eval(test_data.drawing.values[i])\n        for x,y in picture:\n            pl.subplot(5,4,i+1)\n            pl.plot(x,y,'-o',markersize=1,color='slategray')\n            pl.xticks([]); pl.yticks([])\n            pl.title(submission.iloc[i][1])\n        pl.gca().invert_yaxis()\n        pl.axis('equal');           \ndef get_image(data,k,I=I):\n    img=np.zeros((280,280))\n    picture=ast.literal_eval(data.values[k])\n    for x,y in picture:\n        for i in range(len(x)):\n            img[y[i]+10][x[i]+10]=1\n            if (i<len(x)-1):\n                x1,y1,x2,y2=x[i],y[i],x[i+1],y[i+1]\n            else:\n                x1,y1,x2,y2=x[i],y[i],x[0],y[0]\n            for [xl,yl] in get_line(x1,y1,x2,y2):\n                img[yl+10][xl+10]=1                \n    return resize(img,(I,I))    ","4734d426":"ftest='..\/input\/quickdraw-doodle-recognition\/test_simplified.csv'\ntest_data=pd.read_csv(ftest,index_col='key_id')\ntest_data.tail(3).T.style.set_properties(**style_dict)","b15f05a8":"# creating test images in pixels\ntest_images=[]\ntest_images.extend([get_image(test_data.drawing,i) \n                    for i in range(len(test_data))])\ntest_images=np.array(test_images)\ntest_images.shape","3b69e7ac":"pl.figure(figsize=(10,5))\npl.subplot(1,2,1); pl.imshow(test_images[0])\npl.subplot(1,2,2); pl.imshow(test_images[10000])\npl.suptitle('Key Points in the Test Pictures');","0312b5d8":"def model():\n    model=Sequential()  \n    model.add(Conv2D(32,(5,5),padding='same',\n                     input_shape=(I,I,1)))\n    model.add(LeakyReLU(alpha=.02))\n    model.add(MaxPooling2D(pool_size=(2,2)))\n    model.add(Dropout(.2))\n    model.add(Conv2D(196,(5,5)))\n    model.add(LeakyReLU(alpha=.02))\n    model.add(MaxPooling2D(pool_size=(2,2)))\n    model.add(Dropout(.2))\n    model.add(GlobalMaxPooling2D())\n    model.add(Dense(1024))\n    model.add(LeakyReLU(alpha=.02))\n    model.add(Dropout(.5)) \n    model.add(Dense(T))\n    model.add(Activation('softmax'))\n    model.compile(loss='categorical_crossentropy',\n                  optimizer='adam',metrics=['accuracy'])\n    return model\nmodel=model()","98b65b8b":"fn1='..\/input\/quick-draw-model-weights-for-doodle-recognition\/'+\\\n    'weights\/weights.best.model001_020.hdf5'\nmodel.load_weights(fn1)\ntest_predictions=model.predict(test_images.reshape(-1,I,I,1))\ntest_predictions.shape","21fca9af":"# separated predictions for each label set\nfor w in weights[1:]:\n    w=wpath+w\n    model.load_weights(w)\n    test_predictions2=model.predict(test_images.reshape(-1,I,I,1))\n    test_predictions=np.concatenate((test_predictions,\n                                     test_predictions2),axis=1)\ntest_predictions.shape","4c5d2c18":"# 3 best guesses among all label sets\ntest_labels=[[labels[i] \n              for i in test_predictions[k].argsort()[-3:][::-1]] \n             for k in range(len(test_predictions))]\ntest_labels=[\" \".join(test_labels[i]) \n             for i in range(len(test_labels))]\nsubmission=pd.DataFrame({\"key_id\":test_data.index,\n                         \"word\":test_labels})\nsubmission.to_csv('qd_submission.csv',index=False)","857b68df":"display_drawing()","03819a9a":"<h1 style=\"color:steelblue; font-family:Ewert; font-size:150%;\" class=\"font-effect-3d\">Code Library, Style and Links<\/h1>\n\nThe previous notebook - [Quick, Draw! Doodle Recognition 1](https:\/\/www.kaggle.com\/olgabelitskaya\/quick-draw-doodle-recognition-1)","a7643f2a":"<h1 style=\"color:steelblue; font-family:Ewert; font-size:150%;\" class=\"font-effect-3d\">The Model<\/h1>","1ab93bf8":"<h1 style=\"color:steelblue; font-family:Ewert; font-size:150%;\" class=\"font-effect-3d\">Test Data Exploration<\/h1>","18e82651":"<h1 style=\"color:steelblue; font-family:Ewert; font-size:200%;\" class=\"font-effect-3d\">Predictions<\/h1>"}}