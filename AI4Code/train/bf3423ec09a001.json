{"cell_type":{"ad5df7c2":"code","98896b3a":"code","e22227b5":"code","81c81517":"code","8a8fd71a":"code","be7f0520":"code","44c2ecfc":"code","81b5adcf":"code","85b1e680":"markdown","041aee7f":"markdown","e8350ab4":"markdown","2eab426b":"markdown","a148f65a":"markdown","fb09a64e":"markdown"},"source":{"ad5df7c2":"import numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\nimport matplotlib.pyplot as plt\nimport plotly.express as px\nfrom google.cloud import bigquery","98896b3a":"client = bigquery.Client()\n\n# List the tables in covid19_google_mobility dataset which resides in bigquery-public-data project:\ndataset = client.get_dataset('bigquery-public-data.covid19_google_mobility')\ntables = list(client.list_tables(dataset))\nprint([table.table_id for table in tables])","e22227b5":"sql = '''\nSELECT\n  *\nFROM\n  `bigquery-public-data.covid19_google_mobility.mobility_report` \nWHERE\n  country_region = \"United States\"\n  AND sub_region_1 = \"California\"\n  AND sub_region_2 = \"San Francisco County\"\n  AND date BETWEEN \"2020-03-10\" AND \"2020-03-24\"\nORDER BY\n  date\n'''\n# Set up the query\nquery_job = client.query(sql)\n\n# Make an API request  to run the query and return a pandas DataFrame\ndf = query_job.to_dataframe()\ndf.head(5)","81c81517":"fig = plt.figure();\ndf.plot(x='date', rot=45, y=['retail_and_recreation_percent_change_from_baseline',                                  \n                             'grocery_and_pharmacy_percent_change_from_baseline',\n                             'parks_percent_change_from_baseline',\n                             'transit_stations_percent_change_from_baseline',\n                             'workplaces_percent_change_from_baseline',\n                             'residential_percent_change_from_baseline'])\nplt.legend(bbox_to_anchor=(1, 0.5), loc='lower left')\nplt.xlabel('Date')\nplt.ylabel('Percent Change From Baseline')\nplt.show()","8a8fd71a":"sql = '''\nselect sub_region_1, avg(retail_and_recreation_percent_change_from_baseline) percent_change\nfrom (\n  SELECT \n    sub_region_1,\n    sub_region_2,\n    date,\n    retail_and_recreation_percent_change_from_baseline,\n    max(date) over (partition by sub_region_1) max_date\n  FROM `bigquery-public-data`.covid19_google_mobility.mobility_report\n  where country_region_code = 'US' and sub_region_1 is not null\n)\nwhere date = max_date\ngroup by sub_region_1\n'''\n# Set up the query\nquery_job = client.query(sql)\n\n# Make an API request  to run the query and return a pandas DataFrame\ndf = query_job.to_dataframe()\ndf.head(5)\n","be7f0520":"states = {\n    'state': [\n        'Alabama',\n        'Alaska',\n        'Arizona',\n        'Arkansas',\n        'California',\n        'Colorado',\n        'Connecticut',\n        'Delaware',\n        'District of Columbia',\n        'Florida',\n        'Georgia',\n        'Hawaii',\n        'Idaho',\n        'Illinois',\n        'Indiana',\n        'Iowa',\n        'Kansas',\n        'Kentucky',\n        'Louisiana',\n        'Maine',\n        'Maryland',\n        'Massachusetts',\n        'Michigan',\n        'Minnesota',\n        'Mississippi',\n        'Missouri',\n        'Montana',\n        'Nebraska',\n        'Nevada',\n        'New Hampshire',\n        'New Jersey',\n        'New Mexico',\n        'New York',\n        'North Carolina',\n        'North Dakota',\n        'Ohio',\n        'Oklahoma',\n        'Oregon',\n        'Pennsylvania',\n        'Rhode Island',\n        'South Carolina',\n        'South Dakota',\n        'Tennessee',\n        'Texas',\n        'Utah',\n        'Vermont',\n        'Virginia',\n        'Washington',\n        'West Virginia',\n        'Wisconsin',\n        'Wyoming',\n        'Puerto Rico'], \n    'abbreviation': [\n        'AL',\n        'AK',\n        'AZ',\n        'AR',\n        'CA',\n        'CO',\n        'CT',\n        'DE',\n        'DC',\n        'FL',\n        'GA',\n        'HI',\n        'ID',\n        'IL',\n        'IN',\n        'IA',\n        'KS',\n        'KY',\n        'LA',\n        'ME',\n        'MD',\n        'MA',\n        'MI',\n        'MN',\n        'MS',\n        'MO',\n        'MT',\n        'NE',\n        'NV',\n        'NH',\n        'NJ',\n        'NM',\n        'NY',\n        'NC',\n        'ND',\n        'OH',\n        'OK',\n        'OR',\n        'PA',\n        'RI',\n        'SC',\n        'SD',\n        'TN',\n        'TX',\n        'UT',\n        'VT',\n        'VA',\n        'WA',\n        'WV',\n        'WI',\n        'WY',\n        'PR']}\nstate_abbr = pd.DataFrame(states)\nstate_abbr","44c2ecfc":"df = df.merge(state_abbr, left_on='sub_region_1', right_on='state')[['percent_change', 'abbreviation']]","81b5adcf":"fig = px.choropleth(df, locationmode=\"USA-states\", locations='abbreviation', color='percent_change', scope=\"usa\")\nfig.show()","85b1e680":"## 2.2. Show the latest changes in retail and recreation for each US state\nFor each US state, select the most recent `retail_and_recreation_percent_change_from_baseline` averaged by county.","041aee7f":"# 1. Initial Setup\nFirst, import necessary python libraries including google.cloud:","e8350ab4":"Next, list tables in a public dataset `covid19_google_mobility`","2eab426b":"# 2. Data Exploration\n## 2.1. How have San Francisco's mobility patterns changed a week before and after the \"shelter-in-place\" order was issued?\nThis query examines the changes in mobility patterns within San Francisco county before and after the city's \"shelter-in-place\" order was issued March 17th, 2020. The first date (03-10-2020) is a week before the order was issued, and the second date (03-24-2020) is a week after the order was issued.","a148f65a":"Next, plot the results on the US map. To do so, you'll need to use state abbreviations. So, create a helper dataframe and merge it with the above results:","fb09a64e":"Finally, plot the results on the map:"}}