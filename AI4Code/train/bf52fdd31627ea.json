{"cell_type":{"9d33da76":"code","5fae29ff":"code","dcf01a72":"code","f2ae7596":"code","bd10fb3d":"code","0b20bbe2":"code","ff05d972":"code","56fae958":"code","bb8e58de":"code","74685723":"code","c60cb659":"code","a998380d":"code","0d872f5e":"code","90c819d9":"code","1f84c4ed":"code","51c7a5df":"code","428823c2":"code","67daff01":"code","b695f3f9":"code","e430c5aa":"markdown","26b6abfe":"markdown","66f60fe5":"markdown","73de4792":"markdown","471b582b":"markdown"},"source":{"9d33da76":"import numpy as np\nimport pandas as pd\nfrom pathlib import Path\nimport h5py\nfrom tqdm import tqdm\n\nimport tensorflow as tf\n\nimport matplotlib.pyplot as plt\n%matplotlib inline","5fae29ff":"BASE_PATH = Path(\"..\/input\/trends-assessment-prediction\")\nfmri_scan_folder = BASE_PATH \/ \"fMRI_train\"\ntrain_scores_path = BASE_PATH \/ \"train_scores.csv\"","dcf01a72":"mat_files = list(fmri_scan_folder.glob(\"*.mat\"))","f2ae7596":"df = pd.read_csv(train_scores_path)","bd10fb3d":"mat_file_ids = list(map(int, [x.stem for x in mat_files]))\ntmp_df = pd.DataFrame({\"Id\":mat_file_ids, \"path\":list(map(str, mat_files))})","0b20bbe2":"df = df.merge(tmp_df, on=\"Id\", how=\"outer\")","ff05d972":"df.isnull().sum()","56fae958":"# All missing target values are filled with 0.0, so this can be handled in training in the loss function\ndf = df.fillna(value=0.0)","bb8e58de":"brain = h5py.File(mat_files[0], \"r\")[\"SM_feature\"][:]","74685723":"# We do not need to store this is the TFRecords file as it is the same for every fmri scan\nnum_of_brains, brain_width, brain_height, brain_depth = brain.shape","c60cb659":"def _bytes_feature(value):\n    \"\"\"Returns a bytes_list from a string \/ byte.\"\"\"\n    if isinstance(value, type(tf.constant(0))):\n        value = value.numpy()\n    return tf.train.Feature(bytes_list=tf.train.BytesList(value=[value]))\n\n\ndef _float_feature(value):\n    \"\"\"Returns a float_list from a float \/ double.\"\"\"\n    return tf.train.Feature(float_list=tf.train.FloatList(value=[value]))","a998380d":"def serialize_example(_id, brain, age, domain1_var1, domain1_var2, domain2_var1, domain2_var2):\n    feature_dict = {\n        'id':_bytes_feature(_id),\n        'brain': _bytes_feature(brain),\n        'age': _float_feature(age),\n        'domain1_var1': _float_feature(domain1_var1),\n        'domain1_var2': _float_feature(domain1_var2),\n        'domain2_var1': _float_feature(domain2_var1),\n        'domain2_var2': _float_feature(domain2_var2),\n    }\n\n    example_proto = tf.train.Example(features=tf.train.Features(feature=feature_dict))\n    return example_proto","0d872f5e":"record_file = \"fmri_dataset_train.tfrecods\"\n\n\nwith tf.io.TFRecordWriter(record_file) as writer:\n    for row_index in tqdm(range(len(df))):\n        row = df.iloc[row_index]\n\n        _id = str(row[\"Id\"]).encode()\n        file_path = row[\"path\"]\n        age = row[\"age\"]\n        domain1_var1 = row[\"domain1_var1\"]\n        domain1_var2 = row[\"domain1_var2\"]\n        domain2_var1 = row[\"domain2_var1\"]\n        domain2_var2 = row[\"domain2_var2\"]\n        \n        brains = h5py.File(file_path, \"r\")[\"SM_feature\"][:]\n\n        # Iterate over every brain scan and assign the same values as it is the same patient\n        # Only 1 random brain scan is used\n        rnd_index = np.random.randint(0, brains.shape[0])\n        for brain_scan_index in range(rnd_index, rnd_index+1):\n            brain = brains[brain_scan_index, :, :, :]\n            brain = brain.astype(np.float16)\n            brain = brain.tostring()\n            \n            tf_example = serialize_example(_id, brain, age, domain1_var1, domain1_var2, domain2_var1, domain2_var2)\n            writer.write(tf_example.SerializeToString())","90c819d9":"dataset = tf.data.TFRecordDataset(record_file)","1f84c4ed":"dataset","51c7a5df":"feature_description = {\n    'id': tf.io.FixedLenFeature([], tf.string),\n    'brain': tf.io.FixedLenFeature([], tf.string),\n    'age': tf.io.FixedLenFeature([], tf.float32),\n    'domain1_var1': tf.io.FixedLenFeature([], tf.float32),\n    'domain1_var2': tf.io.FixedLenFeature([], tf.float32),\n    'domain2_var1': tf.io.FixedLenFeature([], tf.float32),\n    'domain2_var2': tf.io.FixedLenFeature([], tf.float32),\n    }\n\n\ndef parse_example(example_proto):\n    return tf.io.parse_single_example(example_proto, feature_description)","428823c2":"dataset = dataset.map(parse_example)","67daff01":"for x in dataset.take(2):\n    brain_flat = np.frombuffer(x[\"brain\"].numpy(), dtype=np.float16)\n    brain = brain_flat.reshape((brain_width, brain_height, brain_depth))\n    \n    print(f\"Id: {x['id'].numpy().decode() }\")\n    print(f\"Brain scan shape {brain.shape}\")\n    print(f\"Age: {x['age'].numpy():.4f}\")\n    print(f\"Domain 1 Var 1: {x['domain1_var1'].numpy():.4f}\")\n    print(f\"Domain 1 Var 2: {x['domain1_var2'].numpy():.4f}\")\n    print(f\"Domain 2 Var 1: {x['domain2_var1'].numpy():.4f}\")\n    print(f\"Domain 2 Var 2: {x['domain2_var2'].numpy():.4f}\")\n    print(\"-\"*30)","b695f3f9":"fig, axs = plt.subplots(5, 5, figsize=(10, 10))\n\nfor i, ax in enumerate(axs.flatten()):\n    ax.imshow(brain[i, :, :].astype(np.float32))\n    ax.axis(\"off\")\n\nplt.tight_layout()","e430c5aa":"# Prepare DataFrame","26b6abfe":"## Check missing values","66f60fe5":"# Create TFRecords\n\n**Only 1 fmri scan is used per patient** so we fit into the Kaggle HDD constraint. Also the fMRI scans are converted to `float16`.","73de4792":"# Inspect a single brain scan","471b582b":"# Read\/Test created TFRecords file"}}