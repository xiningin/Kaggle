{"cell_type":{"014cea08":"code","fb9ba5b6":"code","e22d3dfd":"code","b8f49b5c":"code","d235e91d":"code","bfb0cb43":"code","62b62d43":"code","89c89f08":"code","3ed79493":"code","04e04be0":"code","b8f98e8a":"code","d1d7ec7f":"code","44213363":"code","d752a493":"code","dc08d3f2":"code","a7078db9":"markdown","822d8b01":"markdown","4c30e99b":"markdown","301f307a":"markdown","9fdce415":"markdown","ebbbd7f7":"markdown","9b088261":"markdown","0ff97363":"markdown","c9e55fe2":"markdown"},"source":{"014cea08":"import os, re, gc, warnings\nimport numpy as np\nimport pandas as pd\nfrom scipy.stats import wasserstein_distance as wd\nfrom tqdm import tqdm_notebook\nwarnings.filterwarnings(\"ignore\")\ngc.collect()","fb9ba5b6":"DATA_DIR = '..\/input\/'\nFILES={}\nfor fn in os.listdir(DATA_DIR):\n    FILES[ re.search( r'[^_\\.]+', fn).group() ] = DATA_DIR + fn\n\nCAT_COL='wheezy-copper-turtle-magic'    \n\ntrain = pd.read_csv(FILES['train'],index_col='id')\n# test = pd.read_csv(FILES['test'],index_col='id')\nCATS = sorted(train[CAT_COL].unique())","e22d3dfd":"feats = train.columns.drop([CAT_COL,'target'])\nwd_matrix = pd.DataFrame(index=range(512), columns=feats)","b8f49b5c":"for wctm in tqdm_notebook(CATS):\n    for f in feats:\n        wd_matrix.loc[wctm][f] = wd(train[(train[CAT_COL]==wctm) & (train['target']==0) ][f], train[(train[CAT_COL]==wctm) & (train['target']==1) ][f])\n        ","d235e91d":"wd_matrix = wd_matrix[ wd_matrix.columns ].astype('float')","bfb0cb43":"import seaborn as sns\nimport matplotlib.pyplot as plt","62b62d43":"sns.set(style=\"whitegrid\")\ncmap = sns.color_palette('YlGn',10)\nf, ax = plt.subplots(figsize=(20, 20))\nsns.heatmap(wd_matrix, xticklabels=8, yticklabels=16, cmap=cmap ,cbar_kws={\"shrink\": .5} )","89c89f08":"# viewing by ranked feature importance within each of 512 models doesn't reveal much\n# wd_matrix.rank(axis=1,ascending=True).astype('int')","3ed79493":"sns.set(style=\"whitegrid\")\ncmap = sns.color_palette('colorblind',10)\nf, ax = plt.subplots(figsize=(20, 40))\nf.add_subplot(2,1,1)\nsns.heatmap(wd_matrix.iloc[:,0:16], vmin=.6, vmax=2, cmap=cmap ,cbar_kws={\"shrink\": .5} )\nf.add_subplot(2,1,2)\nsns.heatmap(wd_matrix.filter(like='important'), vmin=.6, vmax=2, xticklabels=1, yticklabels=16, cmap=cmap ,cbar_kws={\"shrink\": .5} )","04e04be0":"wd_matrix.describe()","b8f98e8a":"wd_matrix['WCTM'] = wd_matrix.index","d1d7ec7f":"sns.set(style=\"white\", rc={\"axes.facecolor\": (0, 0, 0, 0)})\n\n# Create the data\ndf = pd.melt(wd_matrix, \n             id_vars=['WCTM'], \n             value_vars=feats, \n             var_name='feature', value_name='wDistance')\n\n# Initialize the FacetGrid object\npal = sns.cubehelix_palette(256, rot=-.1, light=.6)\ng = sns.FacetGrid(df, row=\"feature\", hue=\"feature\", aspect=3, height=3, palette=pal)\n\n# Draw the densities in a few steps\ng.map(sns.kdeplot, \"wDistance\", clip_on=False, shade=True, alpha=1, lw=1.5, bw=.05)\ng.map(sns.kdeplot, \"wDistance\", clip_on=False, color=\"w\", lw=2, bw=.05)\ng.map(plt.axhline, y=0, lw=2, clip_on=False)\n\n# Define and use a simple function to label the plot in axes coordinates\ndef label(x, color, label):\n    ax = plt.gca()\n    ax.text(0, .2, label, fontweight=\"bold\", color='black', size='large',\n            ha=\"left\", va=\"center\", transform=ax.transAxes)\n\ng.map(label, \"wDistance\")\n\n# Set the subplots to overlap\ng.fig.subplots_adjust(hspace=-.25)\n\n# Remove axes details that don't play well with overlap\ng.set_titles(\"\")\ng.set(yticks=[])\ng.despine(bottom=True, left=True)","44213363":"df.sort_values('wDistance',ascending=False)[40*512:50*512:250]","d752a493":"df.sort_values('wDistance',ascending=False).hist()\ndf.sort_values('wDistance',ascending=False)[:45*512].hist()\ndf.sort_values('wDistance',ascending=False)[:10*512].hist()","dc08d3f2":"sns.set(style=\"white\", rc={\"axes.facecolor\": (0, 0, 0, 0)})\n\n\ndf2=df[df['wDistance']>1]\n\n# Initialize the FacetGrid object\npal = sns.cubehelix_palette(256, rot=-.1, light=.6)\ng = sns.FacetGrid(df2, row=\"feature\", hue=\"feature\", aspect=5, height=2, palette=pal)\n\n# Draw the densities in a few steps\ng.map(sns.kdeplot, \"wDistance\", clip_on=False, shade=True, alpha=1, lw=1.5, bw=.05)\ng.map(sns.kdeplot, \"wDistance\", clip_on=False, color=\"w\", lw=2, bw=.05)\ng.map(plt.axhline, y=0, lw=2, clip_on=False)\n\n# Define and use a simple function to label the plot in axes coordinates\ndef label(x, color, label):\n    ax = plt.gca()\n    ax.text(0, .2, label, fontweight=\"bold\", color='black', size='large',\n            ha=\"left\", va=\"center\", transform=ax.transAxes)\n\ng.map(label, \"wDistance\")\n\n# Set the subplots to overlap\ng.fig.subplots_adjust(hspace=-.25)\n\n# Remove axes details that don't play well with overlap\ng.set_titles(\"\")\ng.set(yticks=[])\ng.despine(bottom=True, left=True)","a7078db9":"This will be an attempt to find some structure in feature importance, primarily by looking for a relationship between `whiskey-copper-turtle-magic` and which features are useful for identifying `target`","822d8b01":"Convention in this competition has been to work on modelling using just the best 40-50 features for any given value of `whiskey-copper-turtle-magic`. That would be a dividing line of about 0.2 in terms of Wasserstein distance","4c30e99b":"[Wasserstein Distance on wikipedia](https:\/\/en.wikipedia.org\/wiki\/Wasserstein_metric)\nI could have used a different, faster, metric but I did not want to miss any useful signal until I knew what I would be throwing away.","301f307a":"Every feature varies from useless (WD=.05) to excellent (WD=2)\nThey all take turns being significant to the same degree, but any predictable rotation eludes me.","9fdce415":"One more pretty ridgeline plot, this time just focusing on the wasserstein distances when that feature is in the top 10 strongest features for a value of `whiskey-copper-turtle-magic`.","ebbbd7f7":"Here we're getting hints at how the data was generated. Most of the data is more noise than signal, but once you drop 90% of it there is a scale-free distribution of wasserstein distances. The amount of these better features is fairly even across instances of `whiskey-copper-turtle-magic`.","9b088261":"I had hoped to see some clear pattern that would allow unscrambling which columns were significant if given only the value for `whiskey-copper-turtle-magic`. No feature seems to share the same sequence of high WD scores with any other feature (the vertical columns are not duplicated, and there isn't a reptition within them that I can see).","0ff97363":"Above are heatmaps for 2 different subsections of the features. The colormap is non-sequential to help identify any pattern visually.\nThe 2 subsections are:\n* 16 sequential columns of the data as given in `train.csv`\n* 16 columns that have `importance` in their name\n\nIt's easier to pay attention when there is less information shown, but I just see noise.","c9e55fe2":"This is a ridgeline plot for each of the 255 features, showing the distribution of wasserstein distances of that feature's value distributions for `target==0` or `target==1`, among the 512 values of `whiskey-copper-turtle-magic`."}}