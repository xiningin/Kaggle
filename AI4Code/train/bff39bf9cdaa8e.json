{"cell_type":{"35a1a262":"code","d8d275b4":"code","e142b579":"code","31d55f47":"code","74d353db":"code","a0ae4f4d":"code","fd094018":"code","54d489fc":"code","8b78e34b":"code","662cde27":"code","26cde269":"code","f37a77bf":"code","113cdfd7":"code","aedfaa93":"code","e71b6063":"code","c627d1f3":"code","04b069ae":"code","a0496845":"code","2e2c9c7e":"code","65d3623b":"code","5adfae8e":"code","9e20f290":"code","c0ca7ee1":"code","28b93925":"code","35678f76":"code","db503d8e":"code","291294ae":"code","1154a3df":"code","88cdf43e":"code","3a5942ac":"code","e64a0d13":"code","6cb4acad":"code","2f9a3b51":"code","cd205217":"code","e4a383db":"code","0fbe7def":"code","569015ea":"code","e27713f3":"code","6eef7202":"code","9ce9468b":"code","313a95aa":"code","978dd911":"code","4cf89c9d":"code","7762b059":"code","ac7fff60":"code","e6bf2b6e":"code","9bce79c7":"code","199820cb":"code","7f1e5384":"code","f36ce512":"code","1caa18d2":"code","92607579":"code","064d339a":"code","514fde95":"code","ea9a48e8":"code","0961c34c":"code","58351daa":"code","40ecf963":"code","b218266b":"code","a2143852":"code","cb90c84a":"code","6233ac9d":"code","2ba6c135":"code","5057b501":"code","48452411":"code","0d58ba7d":"code","571c0bf8":"code","e0b657cf":"code","de1ecf6f":"code","bddb3895":"code","883ff0f1":"code","e6c79d10":"code","68c6988f":"code","64283139":"code","ee19a02a":"code","8152167d":"code","549481da":"code","b3df3662":"code","367016e5":"code","424fa736":"code","f4633731":"code","a5cb9472":"code","328f513b":"code","675e8996":"markdown"},"source":{"35a1a262":"import pandas as pd\nimport numpy as np\nimport matplotlib.pyplot as plt\nimport seaborn as sns\nimport warnings\nsns.set_style('darkgrid')\nwarnings.filterwarnings('ignore')\n","d8d275b4":"df=pd.read_csv('..\/input\/kobe-bryant-shot-selection\/data.csv', header=0,sep=',')","e142b579":"df.shot_made_flag.value_counts()","31d55f47":"df.info()","74d353db":"plt.figure(figsize=(15,5))\ndf.shot_made_flag.value_counts().plot(kind='bar')\nplt.title('misses vs baskets')\nplt.show()","a0ae4f4d":"#missing values\n\ndf.shot_made_flag.isnull().sum()","fd094018":"# analysis of missing values\nplt.figure(figsize=(18,5))\nsns.heatmap(df.isnull())","54d489fc":"# no missing values except shot_made_flag column, which is our target.\n# rows with null values form the test data, the remaining part is our training data.","8b78e34b":"#lat and lon columns\n\nplt.figure(figsize=(15,6))\nplt.subplot(121)\nplt.scatter(df.lon, df.lat, marker='x', alpha=0.1)\nplt.title('scatter plot of lon and lat values')\nplt.subplot(122)\nplt.scatter(df.loc_x, df.loc_y, marker='x', alpha=0.1)\nplt.title('scatter plot of loc_x and loc_y values')","662cde27":"# It seems that lat and lon values are linear transformation of loc_x and loc_y values, so delete lat and lon columns\n\nif 'lat' in df.columns:\n    df.drop(labels='lat',axis=1,inplace=True)\nif 'lon' in df.columns:\n    df.drop(labels='lon',axis=1,inplace=True)","26cde269":"#team_name\ndf.team_name.value_counts()","f37a77bf":"# team_name column contains just one name, so drop this column\n\nif 'team_name' in df.columns:\n    df.drop(labels='team_name', inplace=True, axis=1)","113cdfd7":"#shot_id\n\n# the column shot_id is almost the same as the index of the dataframe, so delete it\n\nif 'shot_id' in df.columns:\n    df.drop(labels='shot_id', inplace=True, axis=1)","aedfaa93":"# game_id and game_event_id\n\ndf.game_id.value_counts().head(10)","e71b6063":"# we see that the game_id 21501228 is repeated 50 times in game_id column.\n# This means that  Kobe had 50 attempts in this match and corresponding to each attempt we have one id \n# in game_event_id column. By game_id and game event_id we can order the attempts. But such information\n# may lead to data leakage. I think we cannot use general performance information in one match to\n# predict whether an attempt in that match is a basket or miss. So delete game_id and game_event_id\n\nif 'game_id' in df.columns:\n    df.drop(labels='game_id', inplace=True, axis=1)\nif 'game_event_id' in df.columns:\n    df.drop(labels='game_event_id', inplace=True, axis=1)","c627d1f3":"#matchup and opponent\n\ndf.matchup.head(20)","04b069ae":"# check whether each matchup starts with 'LAL' or not\n# maybe this column gives an information about the location of match, home or away?\n\ndf.matchup.str.startswith('LAL').value_counts()","a0496845":"# every matchup starts with LAL. However, every matchup has two kind of separators: @ or vs.\n# A little  internet search gives that 'vs.' means Lakers is home team\n\n\ndf['home_or_away']=df.matchup.apply(lambda x: 'home' if x.find('@')==-1 else 'away')\ndf['home_or_away']=df['home_or_away'].astype('category')","2e2c9c7e":"# check whether  the second part of matchup column matches with opponent column\n\ndef second_part(x):\n    # x:string\n    if x.find('@')>=0:\n        return x.split('@')[1].strip().upper()\n    else:\n        return x.split('vs.')[1].strip().upper()\n    \n\n\n(df.matchup.apply(func=second_part).values!=df.opponent.str.upper().values).sum()        ","65d3623b":"\ndf.matchup.apply(func=second_part).unique()","5adfae8e":"df.opponent.unique()","9e20f290":"set(df.matchup.apply(func=second_part).unique()).difference(df.opponent.unique())","c0ca7ee1":"set(df.opponent.unique()).difference(df.matchup.apply(func=second_part).unique())","28b93925":"# there are a few  differences in abbreviations, maybe due to some name changes of nba teams in time\n# we cannot gain any real information from the matchup column, opponent column is sufficient, so delete the former one\n\nif 'matchup' in df.columns:\n    df.drop(labels='matchup', axis=1,inplace=True)","35678f76":"average_successful_attempt=df.shot_made_flag.mean()\nplt.figure(figsize=(15,6))\ndf.groupby('opponent')['shot_made_flag'].mean().plot(kind='bar')\nplt.hlines(average_successful_attempt, 0,33, colors='red')\nplt.title('average successful attempt against each opponent')\nplt.show()","db503d8e":"#convert opponent column to a categorical variable\ndf['opponent']=df['opponent'].astype('category')","291294ae":"#team_id \ndf.team_id.value_counts()","1154a3df":"# since team_id feature is constant, delete it\n\nif 'team_id' in df.columns:\n    df.drop(labels='team_id', axis=1,inplace=True)","88cdf43e":"#shot_type\ndf.shot_type.value_counts()","3a5942ac":"plt.figure(figsize=(15,5))\nsns.countplot('shot_made_flag',hue='shot_type',data=df[df.shot_made_flag.notnull()])","e64a0d13":"# rate of successfull attempts in two categories of shot-type\nplt.figure(figsize=(15,6))\ndf.groupby('shot_type')['shot_made_flag'].mean().plot(kind='bar')\nplt.hlines(average_successful_attempt, -5,30, colors='red',linestyles='dashed')\nplt.show()","6cb4acad":"#convert shot_type into categorical variable\n\ndf['shot_type']=df.shot_type.astype('category')","2f9a3b51":"#game_date and season\n\n# convert game_date column to datetime object\n\ndf['game_date']=pd.to_datetime(df['game_date'])","cd205217":"#convert season into categorical variable\n\ndf['season']=df.season.astype('category')","e4a383db":"# rate of successfull attempts in each season\nplt.figure(figsize=(15,6))\ndf.groupby('season')['shot_made_flag'].mean().plot(kind='bar')\nplt.hlines(average_successful_attempt, -5,30, colors='red',linestyles='dashed')\nplt.title('rate of successfull attempts in each season')\nplt.show()","0fbe7def":"#convert game_date into new categorical variables such as year, day, month,...\n\ndf['weekofyear']=df.game_date.apply(lambda x:x.weekofyear)\ndf['dayofweek']=df.game_date.apply(lambda x:x.dayofweek)\ndf['year']=df.game_date.apply(lambda x:x.year)\ndf['month']=df.game_date.apply(lambda x:x.month)\n\ndf['weekofyear']=df['weekofyear'].astype('category')\ndf['dayofweek']=df['dayofweek'].astype('category')\ndf['year']=df['year'].astype('category')\ndf['month']=df['month'].astype('category')\n","569015ea":"#drop game_date column\n\nif 'game_date' in df.columns:\n    df.drop(labels='game_date',axis=1,inplace=True)\n\n","e27713f3":"#shot_zone_range\n\ndf.shot_zone_range.value_counts()","6eef7202":"plt.figure(figsize=(15,5))\nsns.countplot('shot_zone_range',hue='shot_made_flag',data=df[df.shot_made_flag.notnull()])\nplt.title('misses and baskets from each zone_range')\nplt.show()","9ce9468b":"plt.figure(figsize=(15,6))\n\nfor zone in df.shot_zone_range.unique():\n    plt.scatter(df.loc[df.shot_zone_range==zone,'loc_x'],df.loc[df.shot_zone_range==zone,'loc_y'], label=\"{}\".format(zone))\n    tx,ty=df.loc[df.shot_zone_range==zone,'loc_x'].mean(),df.loc[df.shot_zone_range==zone,'loc_y'].mean()\n    avg_basket=df.loc[df.shot_zone_range==zone,'shot_made_flag'].mean()\n    plt.text(tx,ty+50,round(avg_basket,3),bbox=dict(facecolor='white', alpha=0.5))\n\nplt.title(\"average successful attempts from each zone\")\nplt.legend()\nplt.show()","313a95aa":"#convert shot_zone_range into categorical variable\n\ndf['shot_zone_range']=df['shot_zone_range'].astype('category')","978dd911":"#shot_zone_basic\n\ndf.shot_zone_basic.value_counts()","4cf89c9d":"plt.figure(figsize=(15,5))\nsns.countplot('shot_zone_basic',hue='shot_made_flag',data=df[df.shot_made_flag.notnull()])\nplt.title('misses and baskets from each zone_basic')\nplt.show()","7762b059":"plt.figure(figsize=(10,10))\n\nfor zone in df.shot_zone_basic.unique():\n    plt.scatter(df.loc[df.shot_zone_basic==zone,'loc_x'],df.loc[df.shot_zone_basic==zone,'loc_y'], label=\"{}\".format(zone))\n    tx,ty=df.loc[df.shot_zone_basic==zone,'loc_x'].mean(),df.loc[df.shot_zone_basic==zone,'loc_y'].mean()\n    avg_basket=df.loc[df.shot_zone_basic==zone,'shot_made_flag'].mean()\n    if zone=='Above the Break 3' or zone=='Mid-Range':\n        plt.text(tx,ty+70,round(avg_basket,3),bbox=dict(facecolor='white', alpha=0.5))\n    else:\n        plt.text(tx,ty,round(avg_basket,3),bbox=dict(facecolor='white', alpha=0.5))\n\nplt.title(\"average successful attempts from each zone\")\nplt.legend()\nplt.show()","ac7fff60":"#convert shot_zone_basic into categorical variable\n\ndf['shot_zone_basic']=df['shot_zone_basic'].astype('category')\n","e6bf2b6e":"#shot_zone_area\n\ndf.shot_zone_area.value_counts()","9bce79c7":"plt.figure(figsize=(15,5))\nsns.countplot('shot_zone_area',hue='shot_made_flag',data=df[df.shot_made_flag.notnull()])\nplt.title('misses and baskets from each zone_area')\nplt.show()","199820cb":"plt.figure(figsize=(10,10))\n\nfor zone in df.shot_zone_area.unique():\n    plt.scatter(df.loc[df.shot_zone_area==zone,'loc_x'],df.loc[df.shot_zone_area==zone,'loc_y'], label=\"{}\".format(zone))\n    tx,ty=df.loc[df.shot_zone_area==zone,'loc_x'].mean(),df.loc[df.shot_zone_area==zone,'loc_y'].mean()\n    avg_basket=df.loc[df.shot_zone_area==zone,'shot_made_flag'].mean()\n    plt.text(tx,ty+30,round(avg_basket,3),bbox=dict(facecolor='white', alpha=0.5))\n    \nplt.title(\"average successful attempts from each zone area\")\nplt.legend()\nplt.show()","7f1e5384":"#convert shot_zone_area into categorical variable\n\ndf['shot_zone_area']=df['shot_zone_area'].astype('category')","f36ce512":"#action_type\n\ndf.action_type.value_counts()","1caa18d2":"# rate of successfull attempts in each action_type\nplt.figure(figsize=(15,6))\ndf.groupby('action_type')['shot_made_flag'].mean().plot(kind='bar')\nplt.hlines(average_successful_attempt, -5,60, colors='red',linestyles='dashed')\nplt.title('rate of successfull attempts in each action_type')\nplt.show()","92607579":"#convert shot_type into categorical variable\n\ndf['action_type']=df.action_type.astype('category')","064d339a":"#combined_shot_type\n\ndf.combined_shot_type.value_counts()","514fde95":"plt.figure(figsize=(15,5))\nsns.countplot(x='combined_shot_type',hue='shot_made_flag',data=df[df.shot_made_flag.notnull()])","ea9a48e8":"# rate of successfull attempts in each combined_shot_type\nplt.figure(figsize=(15,6))\ndf.groupby('combined_shot_type')['shot_made_flag'].mean().plot(kind='bar')\nplt.hlines(average_successful_attempt, -5,60, colors='red',linestyles='dashed')\nplt.title('rate of successfull attempts in each combined_shot_type')\nplt.show()","0961c34c":"#convert combined_shot_type into categorical variable\n\ndf['combined_shot_type']=df.combined_shot_type.astype('category')","58351daa":"#loc_x and loc_y\n\n# locx and locy are the coordinates on the court where the shot took place.\n\ndf.loc_x.describe()","40ecf963":"df.loc_y.describe()","b218266b":"plt.figure(figsize=(15,6))\nplt.scatter(df.loc_x, df.loc_y, marker='x', alpha=0.1)\nplt.title('locations of attempts of Kobe')\nplt.show()","a2143852":"# The boundary of 3pt is very clear from the above plot. As the distance from the basket increases, the number of attempts decreases\n#as expected.\n\nplt.figure(figsize=(15,6))\nsns.scatterplot(x='loc_x',y='loc_y', hue='shot_made_flag',data=df[df.shot_made_flag.notnull()],alpha=0.2)\nplt.show()","cb90c84a":"plt.figure(figsize=(15,6))\nplt.subplot(121)\nplt.scatter(df.loc[df.shot_made_flag==0,'loc_x'], df.loc[df.shot_made_flag==0,'loc_y'], marker='x', alpha=0.3)\nplt.title('locations of misses of Kobe')\nplt.ylim(-100,800)\nplt.subplot(122)\nplt.scatter(df.loc[df.shot_made_flag==1,'loc_x'], df.loc[df.shot_made_flag==1,'loc_y'], marker='x', alpha=0.3)\nplt.title('locations of baskets of Kobe')\nplt.ylim(-100,800)\nplt.show()","6233ac9d":"#minutes_remaining and seconds_remaining\n\ndf.minutes_remaining.value_counts()","2ba6c135":"df.seconds_remaining.describe()","5057b501":"#instead of these two columns, create one column showing remaining time to the end of a period\n#in terms of seconds\n\ndf['total_seconds_remaining']=df[['minutes_remaining','seconds_remaining']].apply(lambda x:x[0]*60+x[1], axis=1).values\nbins_=[0]+list(np.linspace(6,715,71))\ndf['time_intervals']=pd.cut(df.total_seconds_remaining,bins=bins_,labels=list(range(1,72))).values\nplt.figure(figsize=(16,6))\ndf.groupby('time_intervals')['shot_made_flag'].mean().plot(kind='line')\nplt.show()","48452411":"#there is a sharp decrease in the last 5 seconds of periods, no pattern in the remaining parts\n\ndf['in_last_five_seconds']=[1 if val==1 else 0 for val in df.time_intervals.values]\ndf['in_last_five_seconds']=df['in_last_five_seconds'].astype('category')\n\n\nif 'minutes_remaining' in df.columns:\n    df.drop(labels='minutes_remaining',axis=1,inplace=True)\nif 'seconds_remaining' in df.columns:\n    df.drop(labels='seconds_remaining',axis=1,inplace=True)\nif 'time_intervals' in df.columns:\n    df.drop(labels='time_intervals',axis=1,inplace=True)\n    \n    \n","0d58ba7d":"#period and playoffs\n\ndf.period.value_counts()","571c0bf8":"# rate of successfull attempts in each period\nplt.figure(figsize=(15,6))\ndf.groupby('period')['shot_made_flag'].mean().plot(kind='bar')\nplt.hlines(average_successful_attempt, -5,60, colors='red',linestyles='dashed')\nplt.title('rate of successfull attempts in each period')\nplt.show()","e0b657cf":"df.playoffs.value_counts()","de1ecf6f":"# rate of successfull attempts in two different terms\nplt.figure(figsize=(15,6))\ndf.groupby('playoffs')['shot_made_flag'].mean().plot(kind='bar')\nplt.hlines(average_successful_attempt, -5,60, colors='red',linestyles='dashed')\nplt.title('rate of successfull attempts in normal term\/playoffs')\nplt.show()","bddb3895":"\ndf['period']=df['period'].astype('category')\ndf['playoffs']=df['playoffs'].astype('category')\n","883ff0f1":"#shot_distance\n\ndf.shot_distance.describe()","e6c79d10":"df.shot_distance.nunique()","68c6988f":"df.shot_distance.value_counts().head(15)","64283139":"# rate of successfull attempts in each distance\nplt.figure(figsize=(15,6))\ndf.groupby('shot_distance')['shot_made_flag'].mean().plot(kind='bar')\nplt.hlines(average_successful_attempt, -5,60, colors='red',linestyles='dashed')\nplt.title('rate of successfull attempts in each distance')\nplt.show()","ee19a02a":"df['shot_made_flag']=df['shot_made_flag'].astype('category')\n","8152167d":"# the last preparation before machine learning algorithms\n#convert categorical variables into dummies\n\ndf_with_dummies=pd.get_dummies(df.drop(labels='shot_made_flag',axis=1),drop_first=True)\nxtrain=df_with_dummies[df.shot_made_flag.notnull()]\nytrain=df.shot_made_flag[df.shot_made_flag.notnull()].values\ntest=df_with_dummies[df.shot_made_flag.isnull()]","549481da":"# RANDOM FOREST\n\nfrom sklearn.ensemble import RandomForestClassifier\n","b3df3662":"\n# tuning the parameters of  random forest\n\nfrom collections import OrderedDict\n\n# aim is to optimize 'name_of_parameter'\ndef optimization_of_parameter_of_rf(X,y,dict_of_param,name_of_parameter, list_of_values, min_estimators, max_estimators):\n    list_of_parameter_dicts=[(value,{**dict_of_param,**{'n_estimators':100, 'warm_start':True, 'oob_score':True, 'n_jobs':-1,\n                               'random_state':434,name_of_parameter:value}}) for value in list_of_values]\n    \n    #if x and y are two dictionaries, {**x,**y} is a way of merging these two\n    \n    ensemble_clfs = [( \"{x}={y}\".format(x=name_of_parameter, y=value), RandomForestClassifier(**param_dict))\n                 for value, param_dict in list_of_parameter_dicts]\n\n    # Map a classifier name to a list of (<n_estimators>, <error rate>) pairs.\n    error_rate = OrderedDict((label, []) for label, _ in ensemble_clfs)\n\n\n\n    for label, clf in ensemble_clfs:\n        for i in range(min_estimators, max_estimators + 1):\n            clf.set_params(n_estimators=i)\n            clf.fit(X, y)\n\n            # Record the OOB error for each `n_estimators=i` setting.\n            oob_error = 1 - clf.oob_score_\n            error_rate[label].append((i, oob_error))\n\n    # Generate the \"OOB error rate\" vs. \"n_estimators\" plot.\n    plt.figure(figsize=(15,8))\n    for label, clf_err in error_rate.items():\n        xs, ys = zip(*clf_err)\n        plt.plot(xs, ys, label=label)\n\n    plt.xlim(min_estimators, max_estimators)\n    plt.xlabel(\"n_estimators\")\n    plt.ylabel(\"OOB error rate\")\n    plt.legend(loc=\"upper right\")\n    plt.show()","367016e5":"#tune the parameter max_features\n\noptimization_of_parameter_of_rf(xtrain.values, ytrain,{'min_samples_leaf':9},'max_features',[50,70,90],30,250)","424fa736":"#tune the parameter min_samples_leaf   \n\noptimization_of_parameter_of_rf(xtrain.values, ytrain,{'max_features':50},'min_samples_leaf',[5,9,11,13],30,250)","f4633731":"#tune the parameter max_depth\n\noptimization_of_parameter_of_rf(xtrain.values, ytrain,{'max_features':50, 'min_samples_leaf':13},'max_depth',[15,20,25],30,250)","a5cb9472":"#set up random forest model with the above parameters\n\nrfc=RandomForestClassifier(n_estimators=400,max_features=50,min_samples_leaf=13, max_depth=20)\n\nrfc.fit(xtrain.values, ytrain)\n\npreds=rfc.predict_proba(test)\n","328f513b":"# prepare a file containing probabilities of being 1 ( shot made) of every shot in test data\n\npreds_df=pd.DataFrame({'shot_made_flag':preds[:,1]},index=df[df.shot_made_flag.isnull()].index+1)\npreds_df.index.name='shot_id'\npreds_df.to_csv('submission.csv')","675e8996":"**Remarks**:\n\n1. As expected, the distance from the basket, the success rate decreases.\n2. Kobe attains his maximum in the center, and has more successful in the right than in the left. This suggests that the angle of an attempt has an impact on the success.\n"}}