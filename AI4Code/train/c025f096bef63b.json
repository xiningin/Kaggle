{"cell_type":{"c7fe67cb":"code","fd4db434":"code","cfa73f16":"code","d95a7f2d":"code","8f789a89":"code","d113a963":"code","6e62cb00":"markdown","430e0159":"markdown","7466fcf6":"markdown","bdf3c2d6":"markdown","b6291b69":"markdown","0b23d2dd":"markdown"},"source":{"c7fe67cb":"!pip install lets-plot==2.0.4","fd4db434":"import numpy as np\nimport pandas as pd\nimport geopandas as gpd\n\nfrom lets_plot import *\nLetsPlot.setup_html()","cfa73f16":"df = pd.read_csv('\/kaggle\/input\/wvssurvey\/wvs_wave_7.csv', low_memory=False)\ndf = df.groupby('B_COUNTRY_ALPHA').agg({'RESEMAVAL': ['mean'], \\\n                                        'SACSECVAL': ['mean'], \\\n                                        'version': ['count']}).reset_index()\ndf.columns = ['country_alpha', 'emancipative_mean', 'secular_mean', 'count']\ndf = gpd.GeoDataFrame(df.merge(gpd.read_file(gpd.datasets.get_path('naturalearth_lowres')), \\\n                      left_on='country_alpha', right_on='iso_a3', how='right'), geometry='geometry')\ndf.emancipative_mean = (df.emancipative_mean - df.emancipative_mean.mean()) \/\\\n                       df.emancipative_mean.std()\ndf.secular_mean = (df.secular_mean - df.secular_mean.mean()) \/\\\n                  df.secular_mean.std()\ndf.head()","d95a7f2d":"ggplot(df[~df.country_alpha.isna()], aes('emancipative_mean', 'secular_mean')) + \\\n    geom_vline(xintercept=0, color='black') + \\\n    geom_hline(yintercept=0, color='black') + \\\n    geom_point(aes(fill='continent', size='count'), \\\n               shape=21, color='black', alpha=.7,\n               tooltips=layer_tooltips().line('@name')\\\n                                        .line('number of respondents|@count')\\\n                                        .format('@emancipative_mean', '.3f')\\\n                                        .format('@secular_mean', '.3f')\\\n                                        .line('(x, y)|(@emancipative_mean, @secular_mean)')) + \\\n    geom_text(aes(label='name', color='continent'), size=5, angle=-15, \\\n              position=position_nudge(x=.02, y=.1)) + \\\n    scale_size(name='', range=[3, 9]) + \\\n    xlab('survival vs. self-expression values') + \\\n    ylab('traditional vs. secular-rational values') + \\\n    ggtitle('The Inglehart-Welzel World Cultural Map (2017-2020)') + \\\n    ggsize(800, 600)","8f789a89":"def unit_square_to_hex(x, y, dx=1, dy=1, ifnan='gray', h_breaks=None, v_lambda=None):\n    from colorsys import hsv_to_rgb\n    from numpy import pi, cos, sqrt, arctan2, isnan\n\n    if isnan(x) or isnan(y):\n        return ifnan\n\n    if not hasattr(h_breaks, '__len__'):\n        h_breaks = [0, pi \/ 3, 2 * pi \/ 3, 4 * pi \/ 3]\n    if not hasattr(v_lambda, '__call__'):\n        v_lambda = lambda _r: 1\n\n    def cart_to_pol(_x, _y):\n        return sqrt(_x**2 + _y**2), arctan2(_y, _x)\n\n    def max_radius(_r, _t):\n        if _t < -3 * pi \/ 4:\n            return dx \/ cos(_t + pi)\n        elif _t < -pi \/ 2:\n            return dy \/ cos(-_t - pi \/ 2)\n        elif _t < -pi \/ 4:\n            return dy \/ cos(_t + pi \/ 2)\n        elif _t < 0:\n            return dx \/ cos(-_t)\n        elif _t < pi \/ 4:\n            return dx \/ cos(_t)\n        elif _t < pi \/ 2:\n            return dy \/ cos(pi \/ 2 - _t)\n        elif _t < 3 * pi \/ 4:\n            return dy \/ cos(_t - pi \/ 2)\n        else:\n            return dx \/ cos(pi - _t)\n\n    def shift_angle(_t):\n        l = lambda t0, t1, s0, s1: (_t - t0) \/ (t1 - t0) * (s1 - s0) + s0\n        if _t < -pi \/ 2:\n            return l(-pi, -pi \/ 2, h_breaks[2], h_breaks[3])\n        elif _t < 0:\n            return l(-pi \/ 2, 0, h_breaks[3], 2 * pi + h_breaks[0])\n        elif _t < pi \/ 2:\n            return l(0, pi \/ 2, h_breaks[0], h_breaks[1])\n        else:\n            return l(pi \/ 2, pi, h_breaks[1], h_breaks[2])\n\n    r, t = cart_to_pol(x, y)\n    r = r \/ max_radius(r, t)\n    t = shift_angle(t) \/ (2 * pi)\n    h, s, v = min(1, max(0, t)), min(1, max(0, r)), min(1, max(0, v_lambda(r)))\n\n    return '#%02x%02x%02x' % tuple(round(i * 255) for i in hsv_to_rgb(h, s, v))","d113a963":"v_lambda = lambda r: .8 + np.sqrt(r)\ndx, dy = 3, 3\n\ndf['color'] = [unit_square_to_hex(e, s, dx=dx, dy=dy, v_lambda=v_lambda) \\\n               for e, s in zip(df.emancipative_mean, df.secular_mean)]\n\nx_breaks = np.linspace(-dx, dx, 7)\ny_breaks = np.linspace(-dy, dy, 7)\nX, Y = np.meshgrid(x_breaks, y_breaks)\nX, Y = X.reshape(-1), Y.reshape(-1)\nC = [unit_square_to_hex(x, y, dx=dx, dy=dy, v_lambda=v_lambda) for x, y in zip(X, Y)]\n\nlegend_plot = ggplot({'emancipative_mean': X, 'secular_mean': Y, 'c': C}, \\\n                     aes('emancipative_mean', 'secular_mean')) + \\\n    geom_raster(aes(fill='c'), color='white') + \\\n    scale_x_continuous(name='survival \/ self-expression', breaks=x_breaks) + \\\n    scale_y_continuous(name='traditional \/ secular', breaks=y_breaks) + \\\n    scale_fill_identity() + \\\n    coord_fixed(ratio=.6) + \\\n    theme(axis_line='blank', axis_ticks='blank', axis_tooltip='blank')\n\nworld_plot = ggplot() + \\\n    geom_map(aes(fill='color'), color='black', data=df, \\\n             tooltips=layer_tooltips().line('@name')\\\n                                      .format('@emancipative_mean', '.2f')\\\n                                      .line('emancipative mean value|@emancipative_mean')\n                                      .format('@secular_mean', '.2f')\\\n                                      .line('secular mean value|@secular_mean')) + \\\n    scale_fill_identity() + \\\n    ggtitle('World Values Survey (2017-2020)') + \\\n    theme(axis_line='blank', axis_ticks='blank', axis_text='blank', axis_title='blank')\n\nbunch = GGBunch()\nbunch.add_plot(world_plot, 0, 0, 800, 600)\nbunch.add_plot(legend_plot, 500, 400, 300, 200)\nbunch.show()","6e62cb00":"In addition to pure colors, we also see mixed ones.\n\nFor example, the US is colored in coral (between red and yellow) which means that it has a positive value for both Inglehart-Welzel indices corresponding to the legend.","430e0159":"# World Values Survey Wave 7 (2017-2020)\n\nI drew a few graphs inspired by this diagram:\n\n<img src=\"https:\/\/www.worldvaluessurvey.org\/photos\/EV000190.JPG\" alt=\"Provisional version\" width=\"400\" height=\"300\" \/>\n\nThe Inglehart-Welzel World Cultural Map - World Values Survey 7 (2020) \\[Provisional version\\]. Source: http:\/\/www.worldvaluessurvey.org\n\nHere I collect only data corresponding to the 7th wave of the survey.\n\n### Contents\n\n- [Data Preparation](#section1)\n- [World Cultural Map](#section2)\n- [World Bivariate Choropleth Map](#section3)\n- [Bibliography](#bibliography)","7466fcf6":"The plot slightly differs from the original one, because we only use data from the 7th survey wave.","bdf3c2d6":"<a id='bibliography'><\/a>\n### Bibliography\n\n- Haerpfer, C., Inglehart, R., Moreno, A., Welzel, C., Kizilova, K., Diez-Medrano J., M. Lagos, P. Norris, E. Ponarin & B. Puranen et al. (eds.). 2020. World Values Survey: Round Seven - Country-Pooled Datafile. Madrid, Spain & Vienna, Austria: JD Systems Institute & WVSA Secretariat. doi.org\/10.14281\/18241.1","b6291b69":"<a id='section2'><\/a>\n### World Cultural Map\n\nHere we just repeat the Inglehart-Welzel diagram from the first picture.","0b23d2dd":"<a id='section3'><\/a>\n### World Bivariate Choropleth Map\n\nLet's explore the connection between these two Inglehart-Welzel indices on the [bivariate choropleth map](https:\/\/www.joshuastevens.net\/cartography\/make-a-bivariate-choropleth-map). Both of them are in the range of [-3, 3], so we use a diverging palette to map their values to colors."}}