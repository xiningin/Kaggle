{"cell_type":{"1f33db3d":"code","58261fda":"code","8e177323":"code","8419a834":"code","33ada27b":"code","c2a9062a":"code","e17f3a49":"code","f61731d7":"code","061facd6":"code","5eadaf4c":"code","c41ef09d":"code","8e034ffb":"code","f2dcd903":"code","02d031f2":"code","ca94b04d":"code","c8d07a1e":"code","0263b95a":"code","a24388fe":"code","74847270":"code","21ace601":"code","d5d7a8bb":"code","cd7a09ed":"code","69008dbc":"code","f5642c15":"code","78ca6c2b":"code","87268e6d":"code","0b829c1e":"code","2ec0f10c":"code","0238c6c1":"code","41860bf8":"code","cde387ff":"code","914cb28b":"code","3c98c30e":"code","3d20e046":"code","d47e819d":"code","10c909d3":"code","4da5230c":"code","9215e264":"code","7abae1b2":"code","5428c3cd":"code","fa9fad82":"code","f6b91960":"code","66e75a49":"code","88a223ac":"code","c8f8597a":"code","e968d517":"code","6b50a549":"code","62d5fadb":"markdown","17f3e102":"markdown","0cab61d6":"markdown","9653cdbd":"markdown","50201457":"markdown","6b2dddfa":"markdown","8cc93b93":"markdown","4cddac11":"markdown","b1d5d92d":"markdown","39cac76e":"markdown","c13854a3":"markdown","bd710880":"markdown","2d9a19e9":"markdown","0967aa4a":"markdown","a72aed2f":"markdown","677801f8":"markdown"},"source":{"1f33db3d":"import numpy as np\nimport pandas as pd \nimport os\n\ngeo = pd.read_csv(\"..\/input\/geolocation_olist_public_dataset.csv\")\ngeo.head(3)","58261fda":"geo['zip_code_prefix'].value_counts().to_frame().describe()","8e177323":"# Removing some outliers\n#Brazils most Northern spot is at 5 deg 16\u2032 27.8\u2033 N latitude.;\ngeo = geo[geo.lat <= 5.27438888]\n#it\u2019s most Western spot is at 73 deg, 58\u2032 58.19\u2033W Long.\ngeo = geo[geo.lng >= -73.98283055]\n#It\u2019s most southern spot is at 33 deg, 45\u2032 04.21\u2033 S Latitude.\ngeo = geo[geo.lat >= -33.75116944]\n#It\u2019s most Eastern spot is 34 deg, 47\u2032 35.33\u2033 W Long.\ngeo = geo[geo.lng <=  -34.79314722]","8419a834":"from datashader.utils import lnglat_to_meters as webm\nx, y = webm(geo['lng'], geo['lat'])\ngeo['x'] = pd.Series(x)\ngeo['y'] = pd.Series(y)","33ada27b":"geo.head(3)","c2a9062a":"brazil = geo\nagg_name = 'zip_code_prefix'\nbrazil[agg_name].describe().to_frame()","e17f3a49":"# plot wtih holoviews + datashader - bokeh with map background\nimport holoviews as hv\nimport geoviews as gv\nimport datashader as ds\nfrom colorcet import fire, rainbow, bgy, bjy, bkr, kb, kr\nfrom holoviews.streams import RangeXY\nfrom holoviews.operation.datashader import datashade, dynspread, rasterize\nfrom bokeh.io import push_notebook, show, output_notebook\noutput_notebook()\nhv.extension('bokeh')","f61731d7":"%opts Overlay [width=800 height=600 toolbar='above' xaxis=None yaxis=None]\n%opts QuadMesh [tools=['hover'] colorbar=True] (alpha=0 hover_alpha=0.2)\n\nT = 0.05\nPX = 1\n\ndef plot_map(data, label, agg_data, agg_name, cmap):\n    url=\"http:\/\/server.arcgisonline.com\/ArcGIS\/rest\/services\/Canvas\/World_Dark_Gray_Base\/MapServer\/tile\/{Z}\/{Y}\/{X}.png\"\n    geomap = gv.WMTS(url)\n    points = hv.Points(gv.Dataset(data, kdims=['x', 'y'], vdims=[agg_name]))\n    agg = datashade(points, element_type=gv.Image, aggregator=agg_data, cmap=cmap)\n    zip_codes = dynspread(agg, threshold=T, max_px=PX)\n    hover = hv.util.Dynamic(rasterize(points, aggregator=agg_data, width=50, height=25, streams=[RangeXY]), operation=hv.QuadMesh)\n    hover = hover.options(cmap=cmap)\n    img = geomap * zip_codes * hover\n    img = img.relabel(label)\n    return img","061facd6":"plot_map(brazil, 'Zip Codes in Brazil', ds.min(agg_name), agg_name, cmap=rainbow)","5eadaf4c":"# plot wtih datashader - image with black background\nimport datashader as ds\nfrom datashader import transfer_functions as tf\nfrom functools import partial\nfrom datashader.utils import export_image\nfrom IPython.core.display import HTML, display\nfrom colorcet import fire, rainbow, bgy, bjy, bkr, kb, kr\n\nbackground = \"black\"\nexport = partial(export_image, background = background, export_path=\"export\")\ndisplay(HTML(\"<style>.container { width:100% !important; }<\/style>\"))\nW = 700 \n\ndef create_map(data, cmap, data_agg):\n    pad = (data.x.max() - data.x.min())\/50\n    x_range, y_range = ((data.x.min() - pad, data.x.max() + pad), \n                             (data.y.min() - pad, data.y.max() + pad))\n\n    ratio = (y_range[1] - y_range[0]) \/ (x_range[1] - x_range[0])\n\n    plot_width  = int(W)\n    plot_height = int(plot_width * ratio)\n    if ratio > 1.5:\n        plot_height = 550\n        plot_width = int(plot_height \/ ratio)\n        \n    cvs = ds.Canvas(plot_width=plot_width, plot_height=plot_height, x_range=x_range, y_range=y_range)\n\n    agg = cvs.points(data, 'x', 'y', data_agg)\n    img = tf.shade(agg, cmap=cmap, how='eq_hist')\n    return export(img,'img')","c41ef09d":"create_map(brazil, rainbow, ds.mean(agg_name))","8e034ffb":"def filter_data(level, name):\n    df = geo[geo[level] == name]\n    #remove outliers\n    df = df[(df.x <= df.x.quantile(0.999)) & (df.x >= df.x.quantile(0.001))]\n    df = df[(df.y <= df.y.quantile(0.999)) & (df.y >= df.y.quantile(0.001))]\n    return df","f2dcd903":"sp = filter_data('state', 'sp')\nagg_name = 'zip_code_prefix'\nsp[agg_name].describe().to_frame()","02d031f2":"agg_name = 'zip_code_prefix'\nplot_map(sp, 'Zip Codes in Sao Paulo State', ds.min(agg_name), agg_name, cmap=rainbow)","ca94b04d":"create_map(sp, rainbow, ds.mean(agg_name))","c8d07a1e":"saopaulo = filter_data('city', 'sao paulo')\nagg_name = 'zip_code_prefix'\nsaopaulo[agg_name].describe().to_frame()","0263b95a":"plot_map(saopaulo, 'Zip Codes in Sao Paulo City', ds.min(agg_name), agg_name, cmap=rainbow)","a24388fe":"create_map(saopaulo, rainbow, ds.mean(agg_name))","74847270":"df = geo[geo['city'] == 'atibaia']\nagg_name = 'zip_code_prefix'\ndf[agg_name].describe().to_frame()","21ace601":"zip129 = geo[geo[agg_name] == 129]\nzip129[[agg_name, 'city', 'state']].drop_duplicates()","d5d7a8bb":"def plot_map2(data, label, agg_data, agg_name, cmap):\n    url=\"http:\/\/server.arcgisonline.com\/ArcGIS\/rest\/services\/Canvas\/World_Dark_Gray_Base\/MapServer\/tile\/{Z}\/{Y}\/{X}.png\"\n    geomap = gv.WMTS(url)\n    points = hv.Points(gv.Dataset(data, kdims=['x', 'y'], vdims=[agg_name]))\n    agg = datashade(points, element_type=gv.Image, aggregator=agg_data, cmap=cmap)\n    zip_codes = dynspread(agg, threshold=T, max_px=PX)\n    img = geomap * zip_codes\n    img = img.relabel(label)\n    return img\nplot_map2(zip129, 'Zip Codes Prefix 129', ds.min(agg_name), agg_name, cmap=rainbow)","cd7a09ed":"orders = pd.read_csv('..\/input\/olist_public_dataset_v2.csv')\nbrazil_geo = geo.set_index('zip_code_prefix').copy()","69008dbc":"gp = orders.groupby('customer_zip_code_prefix')['order_products_value'].sum().to_frame()\nrevenue = brazil_geo.join(gp)\nagg_name = 'revenue'\nrevenue[agg_name] = revenue.order_products_value \/ 1000","f5642c15":"plot_map(revenue, 'Orders Revenue (thousands R$)', ds.mean(agg_name), agg_name, cmap=fire)","78ca6c2b":"create_map(revenue, fire, ds.mean(agg_name))","87268e6d":"gp = orders.groupby('order_id').agg({'order_products_value': 'sum', 'customer_zip_code_prefix': 'max'})\ngp = gp.groupby('customer_zip_code_prefix')['order_products_value'].mean().to_frame()\navg_ticket = brazil_geo.join(gp)\nagg_name = 'avg_ticket'\navg_ticket[agg_name] = avg_ticket.order_products_value","0b829c1e":"plot_map(avg_ticket, 'Orders Average Ticket (R$)', ds.mean(agg_name), agg_name, cmap=bgy)","2ec0f10c":"create_map(avg_ticket, bgy, ds.mean('avg_ticket'))","0238c6c1":"gp = orders.groupby('order_id').agg({'order_products_value': 'sum', 'order_freight_value': 'sum', 'customer_zip_code_prefix': 'max'})\nagg_name = 'freight_ratio'\ngp[agg_name] = gp.order_freight_value \/ gp.order_products_value\ngp = gp.groupby('customer_zip_code_prefix')[agg_name].mean().to_frame()\nfreight_ratio = brazil_geo.join(gp)","41860bf8":"plot_map(freight_ratio, 'Orders Average Freight Ratio', ds.mean(agg_name), agg_name, cmap=bgy)","cde387ff":"create_map(freight_ratio, bgy, ds.mean('freight_ratio'))","914cb28b":"orders['order_delivered_customer_date'] = pd.to_datetime(orders.order_delivered_customer_date)\norders['order_aproved_at'] = pd.to_datetime(orders.order_aproved_at)\norders['actual_delivery_time'] = orders.order_delivered_customer_date - orders.order_aproved_at\norders['actual_delivery_time'] = orders['actual_delivery_time'].dt.days","3c98c30e":"gp = orders.groupby('customer_zip_code_prefix')['actual_delivery_time'].mean().to_frame()\ndelivery_time = brazil_geo.join(gp)\nagg_name = 'avg_delivery_time'\ndelivery_time[agg_name] = delivery_time['actual_delivery_time']","3d20e046":"plot_map(delivery_time, 'Orders Average Delivery Time (days)', ds.mean(agg_name), agg_name, cmap=bjy)","d47e819d":"create_map(delivery_time, bjy, ds.mean(agg_name))","10c909d3":"pr = filter_data('state', 'pr').set_index('zip_code_prefix')\ngp = orders.groupby('customer_zip_code_prefix')['actual_delivery_time'].mean().to_frame()\npr_delivery_time = pr.join(gp)\npr_delivery_time[agg_name] = pr_delivery_time['actual_delivery_time']","4da5230c":"plot_map(pr_delivery_time, 'Orders Average Delivery Time in Parana State (days)', ds.mean(agg_name), agg_name, cmap=bjy)","9215e264":"create_map(pr_delivery_time, bjy, ds.mean(agg_name))","7abae1b2":"riodejaneiro = filter_data('city', 'rio de janeiro').set_index('zip_code_prefix')\ngp = orders.groupby('customer_zip_code_prefix')['actual_delivery_time'].mean().to_frame()\nrj_delivery_time = riodejaneiro.join(gp)\nrj_delivery_time[agg_name] = rj_delivery_time['actual_delivery_time']","5428c3cd":"plot_map(rj_delivery_time, 'Orders Average Delivery Time in Rio de Janeiro (days)', ds.mean(agg_name), agg_name, cmap=bjy)","fa9fad82":"create_map(rj_delivery_time, bjy, ds.mean(agg_name))","f6b91960":"saopaulo = filter_data('city', 'sao paulo').set_index('zip_code_prefix')\ngp = orders.groupby('customer_zip_code_prefix')['actual_delivery_time'].mean().to_frame()\nsp_delivery_time = saopaulo.join(gp)\nsp_delivery_time[agg_name] = sp_delivery_time['actual_delivery_time']","66e75a49":"plot_map(sp_delivery_time, 'Orders Average Delivery Time in Sao Paulo (days)', ds.mean(agg_name), agg_name, cmap=bjy)","88a223ac":"create_map(sp_delivery_time, bjy, ds.mean(agg_name))","c8f8597a":"poa = filter_data('city', 'porto alegre').set_index('zip_code_prefix')\ngp = orders.groupby('customer_zip_code_prefix')['actual_delivery_time'].mean().to_frame()\npoa_delivery_time = poa.join(gp)\npoa_delivery_time[agg_name] = poa_delivery_time['actual_delivery_time']","e968d517":"plot_map(poa_delivery_time, 'Orders Average Delivery Time in Porto Alegre (days)', ds.mean(agg_name), agg_name, cmap=bjy)","6b50a549":"create_map(poa_delivery_time, bjy, ds.mean(agg_name))","62d5fadb":"# Geospatial Analysis of Brazilian E-Commerce\n\nOlist has released a dataset with 100k orders made between 2016 and 2018. Each order has some information about the customer and contains the first three digits of the customer zip code. Olist has also released a geolocation database that has 323k lat\/lng coordinates related to the first three digits of each zip code.\n\n## CEP: the Brazilian Zip Code\nA brazilian zip code, also know as CEP, stands for Postal Adressing Code (*C\u00f3digo de Endere\u00e7amento Postal*) and contains 8 digits. Introduced in 1972 as a sequence of five digits, it was expanded to eight digits in 1992 to allow for more precise localization. The standard format is \"nnnnn-nnn\" (the original five digits, an hyphen, and the new three digits).\n\n**CEP:** 12.345-678\n\nMost cities with population around 100,000 and above have a CEP assigned to every public place and to some high-occupancy private spaces, like major commercial buildings and large residential condos. Small towns are assigned a general 5-digit code followed by the suffix -000. \n\n* the first part is composed by 5 digits that represent Region, Subregion, Sector, Subsector and Subsector Splitter.\n* the second part contain 3 digits, separated by an hyphen from the first, and it represents the Distribution Identifiers.\n\nMore info about how CEP works may be found at the [Correios website](https:\/\/www.correios.com.br\/a-a-z\/cep-codigo-de-enderecamento-postal).\n\nLets look at the geolocation dataset provided by Olist and try to understand how CEP works geographically.","17f3e102":"## Zip Codes in Small Cities\nLets look at the city of Atibaia to see how zip code prefixes works in a city level. We see that:\n* zip code prefix of Atibaia city is 129\n* but there are other neighbor cities with the same zip code prefix\n* to have more detail and go down to a city level we would probably need more zip code digits (the 4th and 5th digit)","0cab61d6":"## Zip Codes in States\nLets look at the state of Sao Paulo (SP) to see how zip code prefixes works in a regional level. We see that:\n* zip code prefixes in Sao Paulo state ranges from 010 to 199\n* zip codes starting with 0 are in the Sao Paulo metro region\n* zip codes starting with 1 are in the interior of the state","9653cdbd":"## Zip Codes in Large Cities \nLets look at the city of Sao Paulo to see how zip code prefixes works in a city level. We see that:\n* zip code prefixes in Sao Paulo city ranges from 010 to 095\n* zip code prefixes are somehow related to neighborhoods or city districts","50201457":"# What is the Average Ticket?\nHere we see something somehow unexpected. Customers of the south and southeast regions of Brazil have lower average ticket, than their peers on north and norteast. This might happen because they have to pay more for freight (let's check that in a moment)","6b2dddfa":"# Work in progress...\n\n## To do:\n1. Which categories are most sold.\n2. Wich payment method was chosen. \n3. How many installments.\n4. Analysis on specific cities, such as  Sao Paulo, Porto Alegre, Curitiba, Fortaleza, Bahia, Brasilia. \n5. Any sugestion?","8cc93b93":"Lets look to delivery times at a state level. We filtered only orders from Parana state (PR). It is possible to see that larger cities have lower average delivery times than the smaller ones.","4cddac11":"There are some outliers coordinates in the dataset that are outside of brazilian territory. Lets guarantee that all coordinates are within a rectangle delimited by the limits of Brazil.","b1d5d92d":"It turns out that if you live in rich neighborhoods such as Downtown, Botafogo, Copacabana and Flamengo you are likey to receive your order five days earlier than someone who lives in a poor neighborhood such as Cidade de Deus or Bangu. We see the same pattern in Sao Paulo and Porto Alegre, customers near downtown receive their orders faster than those who lives on suburbs.","39cac76e":"Then we treat the latitute and longitude coordinates and transform then to Mercator x\/y Coordinates.","c13854a3":"# Where does most revenue comes from?\nPlotting the sum of products value grouped by zip code prefix we see that most of the revenue came from the Southeast and South regions of Brazil. It is also possible to see that large cities and capitals, where population is bigger, have larger participation on revenue. ","bd710880":"# Average Delivery Time\nUnfortunately, who lives in the north and northeast of Brazil has to bear with higher freight costs and has to wait longer to receive their purchase.","2d9a19e9":"There are 851 different zip_code_prefix. They are all limited to 500 samples per zip_code_prefix. On average there are 380 coordinates for each prefix.","0967aa4a":"## Zip Codes in Brazil\nFinally plotting the coordinates on a map. We see there is a relationship between the zip code prefix and the location of that zip code. They start in Sao Paulo, with prefix 010, and then increase counterclockwise finishing in Rio Grande do Sul (south of Brazil), with prefix 999.","a72aed2f":"## Interesting Point About Brazilian Suburbs\nUnlike other countries, in Brazil the richest areas usualy are near downtow and suburbs are know for poverty and high violence rates. Lets explore that in Rio the Janeiro.","677801f8":"# Who pays more for transportation?\nWe might find a freight ratio by dividing the freight value by the order value. This ratio indicates the percentage of the product price that a person had to pay just to get their order delivered. For example, if a product costs R\\$50.00 and the freight value was R\\$10.00, then the freight ratio is 0.2 or 20%. Higher freight ratios are very likely to discourage customers to complete a purchase. Due to logistics costs, we expect to see lower freight ratios in densely populated areas and are higher freight ratios on sparsely poulated regions."}}