{"cell_type":{"3554835c":"code","98db6624":"code","977edd20":"code","4ebe38d4":"code","5aba53aa":"code","eff3b313":"code","6cba9659":"code","d1b50cae":"code","d85915b2":"code","c29e9ef8":"code","c0595f2c":"code","c0c9f7e7":"code","141fa4a0":"code","75183252":"code","a1a4b86a":"code","e5a88f4a":"code","fa613337":"code","bb19685b":"code","578ef96e":"code","8ea368f7":"code","6f077dee":"code","f87c5764":"markdown","ccc41efe":"markdown","0216e2c9":"markdown","46c355d2":"markdown","f52c3120":"markdown","2e144f5f":"markdown","dfa37234":"markdown","0d7dffde":"markdown","a8be7f9a":"markdown","2b6944ce":"markdown"},"source":{"3554835c":"import numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\nimport os\nprint(os.listdir(\"..\/input\"))\n\n\nimport cv2\nimport keras\nfrom keras import backend as K\nfrom matplotlib import pyplot as plt\nfrom sklearn.metrics import f1_score\nfrom sklearn.model_selection import train_test_split\nfrom keras.layers import Conv2D, Dense, MaxPooling2D, Flatten, Activation, Input, BatchNormalization, ZeroPadding2D, Dropout\nfrom keras.models import Sequential, Model\nfrom tqdm import tqdm","98db6624":"base = '..\/input\/cell_images\/cell_images\/'\npara = os.listdir(base+'Parasitized')\nnor = os.listdir(base+'Uninfected')","977edd20":"len(para), len(nor)","4ebe38d4":"def image_reader(path):\n    '''\n    Image_reader:\n        Takes image as input and returns the RGB image of the same read image\n        The image is also resized into smaller shape and Dimension of 110x110.\n    '''\n    t=cv2.imread(path)\n    t=cv2.cvtColor(t, cv2.COLOR_BGR2RGB)\n    t=cv2.resize(t, (110,110))\n    return t","5aba53aa":"X = []\nY = [] \n\nfor x in tqdm(para):\n    # Parasite variable \n    try:\n        t = image_reader(base+'Parasitized\/'+x)\n        X.append(t)\n        Y.append(1)\n    except:\n        pass\n    \nfor x in tqdm(nor):\n    # Non Parasite images variable\n    try:\n        t = image_reader(base+'Uninfected\/'+x)\n        X.append(t)\n        Y.append(0)\n    except:\n        pass","eff3b313":"X=np.array(X)\nY=np.array(Y)\nY_oh = keras.utils.to_categorical(Y, num_classes=2)\nprint(X.shape, Y_oh.shape)","6cba9659":"# Show training images\nnp.random.seed(10)\n\nconcat_img = None\nfor i in range(10):\n    idx = np.random.randint(X.shape[0])\n    if concat_img is None:\n        concat_img = X[idx]\n    else:\n        concat_img = np.concatenate([concat_img, X[idx]], axis=1)\nplt.figure(figsize=(15, 5)) \nplt.imshow(concat_img)","d1b50cae":"train_x, test_x, train_y, test_y = train_test_split(X,Y_oh,test_size=0.1, shuffle=True)","d85915b2":"X_input = Input((110,110,3))\n\n# Zero-Padding: pads the border of X_input with zeroes\nX = ZeroPadding2D((3, 3))(X_input)\n\n# CONV -> BN -> RELU Block applied to X\nX = Conv2D(32, (7, 7), strides = (1, 1), name = 'conv0')(X)\nX = BatchNormalization(axis = 3, name = 'bn0')(X)\nX = Activation('relu')(X)\n\n# MORE CONVS\nX = MaxPooling2D((2, 2))(X)\n#shortcut = X\nX = Conv2D(32, (3, 3), strides = (1, 1), padding=\"same\")(X)\nX = BatchNormalization()(X)\nX = Activation('relu')(X)\nX = Conv2D(32, (3, 3), strides = (1, 1), padding=\"same\")(X)\nX = BatchNormalization()(X)\n#X = layers.add([X, shortcut])\nX = Activation('relu')(X)\n\n# MAXPOOL\nX = MaxPooling2D((2, 2), name='max_pool')(X)\n\n# FLATTEN X (means convert it to a vector) + FULLYCONNECTED\nX = Flatten()(X)\n\n# MORE DENSE\nX = Dense(128)(X)\nX = BatchNormalization()(X)\nX = Activation('relu')(X)\nX = Dropout(0.5)(X)\n\nX = Dense(2, activation='softmax', name='fc')(X)\n\n# Create model. This creates your Keras model instance, you'll use this instance to train\/test the model.\nmodel = Model(inputs = X_input, outputs = X, name='HappyModel')","c29e9ef8":"def get_f1(y_true, y_pred): #taken from old keras source code\n    true_positives = K.sum(K.round(K.clip(y_true * y_pred, 0, 1)))\n    possible_positives = K.sum(K.round(K.clip(y_true, 0, 1)))\n    predicted_positives = K.sum(K.round(K.clip(y_pred, 0, 1)))\n    precision = true_positives \/ (predicted_positives + K.epsilon())\n    recall = true_positives \/ (possible_positives + K.epsilon())\n    f1_val = 2*(precision*recall)\/(precision+recall+K.epsilon())\n    return f1_val","c0595f2c":"model.compile('SGD', 'categorical_crossentropy', ['acc', get_f1])","c0c9f7e7":"callback = keras.callbacks.ModelCheckpoint('best_malaria.h5', \n                                           monitor='val_get_f1', \n                                           verbose=1, \n                                           save_weights_only=True, \n                                           save_best_only=True, \n                                           mode='max')","141fa4a0":"history = model.fit(train_x, train_y, validation_split=0.1, epochs=10, batch_size=128, callbacks=[callback])","75183252":"model.load_weights('best_malaria.h5')","a1a4b86a":"np.bincount(test_y.argmax(1))","e5a88f4a":"model.evaluate(test_x, test_y)","fa613337":"!wget https:\/\/ik.imagekit.io\/1tspxkg7vx\/3-1_3YucqGN2z8.jpg https:\/\/ik.imagekit.io\/1tspxkg7vx\/1-0__nHp6ya3h.jpg https:\/\/ik.imagekit.io\/1tspxkg7vx\/1-1_YyeldWIMn1.jpg https:\/\/ik.imagekit.io\/1tspxkg7vx\/2-0_NxWFVOR3m2.jpg https:\/\/ik.imagekit.io\/1tspxkg7vx\/2-1_jeECkgM4cG.jpg","bb19685b":"evaluation=[]\nevaluation.append(image_reader('.\/1-0__nHp6ya3h.jpg'))\nevaluation.append(image_reader('.\/1-1_YyeldWIMn1.jpg'))\nevaluation.append(image_reader('.\/2-0_NxWFVOR3m2.jpg'))\nevaluation.append(image_reader('.\/2-1_jeECkgM4cG.jpg'))\nevaluation.append(image_reader('.\/3-1_3YucqGN2z8.jpg'))\nevaluation=np.asarray(evaluation); evaluation.shape","578ef96e":"idx=4\nt = test_x[idx].reshape(1,110, 110, 3)\n# print(np.argmax(test_y[idx]), np.argmax(model.predict(t)))\nplt.imshow(t[0])","8ea368f7":"res=model.predict(evaluation)\nres.argmax(1)","6f077dee":"model.save_weights('happy_weights.h5')","f87c5764":"## Understanding our model\n\nThe model we have created is for understanding of all the concepts one would require for understanding and building your deep learning models. The model we have created here uses functional model structure defined in Keras. \n\nWe have carried out the following in the model-\n\n1. Take image input in shape of (110,110,3) shaped array\n2. Perform a zero padding over the image spanning 3 pixels\n3. Perform a 2D convolution with kernel shape of (3,3) and stride=1\n4. Apply relu activation over the outcome\n5. Perform MaxPooling operation over the image\n6. Repeat 3-5 again and BatchNormalize\n7. Convert the 2D image to linear array\n8. Perform Dropout on half of the nodes\n9. Create a Dense layer with 2 outputs","ccc41efe":"You can see the model functionality merely changing the idx on a desired number. ","0216e2c9":"We can see that the model gets around 95 percent accuracy. This is sufficient to understand the concepts, but when it comes to building a industry standard model, this is not going to fair well. What could be done for that? Well I leave it upto you to come up with some innovative ideas and discuss them in the discussion section.","46c355d2":"Here I have imported all basic Machine Learning libraries that we have already seen in the module 2 of the course. But apart from that the only other libraires I have imported are *Keras* and *OpenCV*.\n\n\n* *Keras* is the Deep learning library that is designed by a Google Researcher for ease of building high level models.\n* *CV2 (OpenCV)* is the computer vision library which we are going to use to read and write the images from within the folder.","f52c3120":"The model has been coded and needs to be compiled by defining the optimizer to be used, The targetted loss, and the Metrics on which to check the outcomes. These 2 things are required to compile the model. Once compiled, we are going to run 5 epochs (num of iterations ) to fit the data into the model.","2e144f5f":"Keeping in mind this Deep learning Life-Cycle, we are going to split the dataset into train, test and validation dataset. If you are wondering what these are, then refer to [his blog](https:\/\/machinelearningmastery.com\/difference-test-validation-datasets\/) right now.\n\nWe are splitting the dataset into the test-set and train-set just first just to evaluate our model after finalizing all the required Hyperparameters. At training time, we are going to call the validation split which is going to be a part of the training-set itself.","dfa37234":"1. The labels are numeric and needs to be converted to One-Hot encoded. If you are wondering what One-Hot-Encoding is, you should refer to this [Machine Learning Mastery article](https:\/\/machinelearningmastery.com\/why-one-hot-encode-data-in-machine-learning\/). ","0d7dffde":"# Malaria Detection using Keras\n\n![Malaria](http:\/\/www.ox.ac.uk\/sites\/files\/oxford\/styles\/ow_medium_feature\/public\/field\/field_image_main\/Malaria%20banner_0.jpg?itok=d_zOvyQy)\n\nIn this tutorial, we are going to explore how to train our model to detect malaria parasite images from the test slides containing cells.\nFor creating the model, we are going to use a very basic and popular Deep learning framework called as ***Keras*** that has been designed by one of Google's researcher.\n\nThis tutorial is going to guide you through building an end to end pipeline from reading images from the folder to making your predictions","a8be7f9a":"Remember the test dataset we had split? We are going to test our model on the same dataset now just to see weather the model has been properly trained or not.","2b6944ce":"The *para* variable contains the images of the parasite slide whereas the *nor* dataset contains uninfected images. "}}