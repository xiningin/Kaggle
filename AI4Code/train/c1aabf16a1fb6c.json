{"cell_type":{"46446b43":"code","28d1e12c":"code","3b79ffd1":"code","195c02f5":"code","c60c924b":"code","de572261":"code","59c34113":"code","50de4d4d":"code","718c5915":"code","07283248":"code","06b82ff5":"code","80f03e2a":"code","1cec0be0":"code","c0114ca1":"code","dea98eeb":"code","0a5de46c":"code","f64bddd1":"code","83b3f753":"code","c22b3946":"code","4dd873ad":"code","ad8223b1":"code","7e90f792":"markdown"},"source":{"46446b43":"!pip install torch==1.6.0+cu101 torchvision==0.7.0+cu101 -f https:\/\/download.pytorch.org\/whl\/torch_stable.html\n!pip install fastai==2.0.9","28d1e12c":"import random, os\nimport numpy as np\nimport torch\nfrom fastai.vision.all import *","3b79ffd1":"def seed_everything(seed=0):\n    random.seed(seed)\n    os.environ['PYTHONHASHSEED'] = str(seed)\n    np.random.seed(seed)\n    torch.manual_seed(seed)\n    torch.cuda.manual_seed(seed)\n    torch.backends.cudnn.deterministic = True\n\nseed_everything()","195c02f5":"path = Path('\/kaggle\/input\/chest-xray-pneumonia\/chest_xray\/'); path.ls()","c60c924b":"dls = ImageDataLoaders.from_folder(path, train='train',\n                                   item_tfms=Resize(224),valid_pct=0.2,\n                                   bs=64,seed=0)","de572261":"dls.show_batch()","59c34113":"print(dls.vocab); print(dls.c)","50de4d4d":"learn = cnn_learner(dls, resnet34, metrics=[error_rate, accuracy], model_dir=\"\/tmp\/model\/\").to_fp16()","718c5915":"learn.lr_find()","07283248":"learn.fit_one_cycle(1, lr_max=1e-2)","06b82ff5":"learn.unfreeze()","80f03e2a":"learn.fit_one_cycle(1, lr_max=1e-4)","1cec0be0":"interp = ClassificationInterpretation.from_learner(learn)","c0114ca1":"interp.plot_confusion_matrix(figsize=(5,5), dpi=60)","dea98eeb":"learn.show_results()","0a5de46c":"preds, _ = learn.get_preds(); preds.shape","f64bddd1":"test_items = get_image_files(path\/'test')\ndl = learn.dls.test_dl(test_items, rm_type_tfms=1, bs=64)","83b3f753":"y_pred, _ = learn.get_preds(dl=dl)\nthresh = 0.5\nyhat_test = [' '.join([learn.dls.vocab[i] for i,p in enumerate(pred) if p > thresh]) for pred in y_pred.numpy()]","c22b3946":"y_test = list(map(lambda x:x.parents[0].name, test_items))","4dd873ad":"results = pd.DataFrame({'target': y_test, 'pred': yhat_test})","ad8223b1":"accuracy = results[results.target == results.pred].shape[0]\/ results.shape[0]; accuracy","7e90f792":"- This notebook is work in progress. Within 2 epochs, 91.7% test accuracy."}}