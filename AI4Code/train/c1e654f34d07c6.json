{"cell_type":{"7ae3680f":"code","114090ce":"code","fc4fda41":"code","997db12b":"code","eb46467a":"code","e2273bd7":"code","0ae8ae01":"code","11ac1e75":"code","32a861ef":"code","a859cd39":"code","2a0d9145":"code","1c1d0fbe":"code","78346f37":"code","7314d7af":"code","8b510fc6":"code","3bcd14e1":"code","b606d52b":"code","6a75feb9":"code","cd2ffbb2":"code","670d4a1e":"code","49fd220a":"code","26b228ec":"code","c17eec59":"code","126220eb":"markdown","7536d322":"markdown","78449150":"markdown","c3c6e882":"markdown","d60d70ff":"markdown"},"source":{"7ae3680f":"# %%script false --no-raise-error\n!rm -fr '.\/kaggle\/'\n","114090ce":"%reload_ext autoreload\n%autoreload 2\n%matplotlib inline","fc4fda41":"import os\nimport torch\nimport numpy as np\nimport pandas as pd\n\nimport matplotlib.pyplot as plt\nimport seaborn as sns\nimport fastai\nimport dill\nfrom fastai.imports import *\nfrom fastai.vision import *\nfrom fastai.vision.all import *\nfrom fastai.metrics import error_rate, accuracy","997db12b":"## Defining Directories\npath = Path('..\/input\/hotel-id-2021-fgvc8')\n\n## csv\nsample_sub = path\/'sample_submission.csv'\nlabels = path\/'train.csv'","eb46467a":"train_data = pd.read_csv(labels)\ntrain_data.head(5)","e2273bd7":"!tar xzvf \/kaggle\/input\/hotelid-224\/kaggle_hotelid_train_imgs_224x224.tgz","0ae8ae01":"train_dir = '.\/kaggle\/working\/train\/'\n\ntrain_data['image_path'] = train_dir + train_data.chain.astype('str') + '\/' + train_data.image\ntrain_data[:5]","11ac1e75":"batch_size = 32\nbatch_size = 32\ndef create_dataLoader():\n    dataset = ImageDataLoaders.from_df(df = train_data[['image_path', 'hotel_id']],\n                                   path = '.',\n                                   folder = '.',\n                                   valid_pct=0.2,\n                                   item_tfms=Resize(224, method='pad', pad_mode='reflection'),\n                                   batch_tfms=aug_transforms(size=224),\n                                   bs=batch_size)\n    return dataset","32a861ef":"dataset = create_dataLoader()","a859cd39":"dataset.show_batch()","2a0d9145":"%%script false --no-raise-error\ndef training_models(dataset, model_name):\n    learn = cnn_learner(dataset,  models.resnet101, \n                        metrics=[accuracy, top_k_accuracy], \n                        opt_func=QHAdam).to_fp16()\n    learn.fine_tune(5, 0.005, freeze_epochs=3)\n    learn.save(model_name)\n    return learn","1c1d0fbe":"%%script false --no-raise-error\n%time\nmodel_name ='model_allData_rn50'\nlearn = training_models(dataset, model_name)","78346f37":"%%script false --no-raise-error\nlearn.export(f'{model_name}.pkl', pickle_module=dill)","7314d7af":"%%script false --no-raise-error\nfromDir ='..\/input\/hotelid-model\/model_Data_category_rn101.pkl'\ntoDir ='.'\ncopy_tree(fromDir, toDir)","8b510fc6":"model_path ='..\/input\/hotelid-model\/model_Data_category_rn101.pkl'\nlearn = load_learner(fname = Path(model_path), cpu=False, pickle_module=dill) ","3bcd14e1":"sample_submission = pd.read_csv('..\/input\/hotel-id-2021-fgvc8\/sample_submission.csv')\nsubmission = sample_submission.copy()\nsubmission['image'] = '..\/input\/hotel-id-2021-fgvc8\/test_images\/' + submission['image']\nsubmission","b606d52b":"test_dl = learn.dls.test_dl(submission)","6a75feb9":"test_dl.show_batch() ","cd2ffbb2":"probs, _ = learn.tta(dl=test_dl)","670d4a1e":"preds_idx = probs.topk(5)[1]","49fd220a":"preds = [' '.join(map(str, learn.dls.vocab[pred])) for pred in preds_idx]\npreds[:5]","26b228ec":"os.chdir(\".\")\nsubmission = sample_submission.copy()\nsubmission['hotel_id'] = preds\n\nsubmission.to_csv('submission.csv', index = False)\n\nsubmission.head()","c17eec59":"!rm -fr '.\/kaggle\/working\/train'","126220eb":"## Training dataset","7536d322":"## Creating a data Loader of the entire Dataset","78449150":"## Loading the model","c3c6e882":"## Predictions","d60d70ff":"## Exporting the model\n"}}