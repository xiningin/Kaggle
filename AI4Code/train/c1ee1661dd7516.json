{"cell_type":{"36b08a3d":"code","a831e2df":"code","fc9a4a20":"code","465c9548":"code","c46b8f6f":"code","8f79bd8b":"code","b58ca339":"code","f6dede40":"code","d4787e9d":"code","3d481365":"code","e3e10faa":"code","3bcf0023":"code","9c5f38bb":"code","15b97518":"code","85460fca":"code","3dc67c6e":"code","5f5fc401":"code","850c0a9f":"code","30bd3793":"code","51650582":"code","03733a42":"code","18a29816":"code","3d2f9721":"code","0b150825":"code","845d068f":"code","3d69539e":"code","eb35d97c":"code","e8e6b9be":"code","2b2d3057":"code","d25c446a":"code","f9c36956":"code","225bf5f5":"code","972ea7fe":"code","48e1118d":"code","1008109c":"code","c745713e":"code","059be7f5":"markdown","71c9043a":"markdown","b26ed394":"markdown","f20c94e6":"markdown","2e0ca418":"markdown","ab110c7e":"markdown","9a0ccf8c":"markdown","768ab5c2":"markdown","971dba74":"markdown","a2f96b06":"markdown","a81a9dcb":"markdown","76c074ca":"markdown","2fc3dfda":"markdown","71d02db5":"markdown","dde86277":"markdown","1ba66128":"markdown","acd1fcb4":"markdown","7b82733e":"markdown","638f57be":"markdown"},"source":{"36b08a3d":"# import the packages we need\nimport numpy as np\nimport pandas as pd\nimport seaborn as sns\n\n%matplotlib inline\nimport matplotlib.pyplot as plt\n\nfrom sklearn import ensemble\nfrom sklearn import preprocessing","a831e2df":"import os\nfor dirname, _, filenames in os.walk('\/kaggle\/input'):\n    for filename in filenames:\n        print(os.path.join(dirname, filename))","fc9a4a20":"# get our train and test data\ntrain_raw = pd.read_csv(\"..\/input\/bigquery-geotab-intersection-congestion\/train.csv\")\ntest_raw  = pd.read_csv(\"..\/input\/bigquery-geotab-intersection-congestion\/test.csv\")","465c9548":"city_ints = train_raw[['IntersectionId','City']].drop_duplicates().groupby(['City']).count()\n\nplt.figure()\nsns.barplot(city_ints.index, city_ints.IntersectionId)\nplt.xlabel('City')\nplt.ylabel('# of intersections')\nplt.show()","c46b8f6f":"city_vol_hour = train_raw.loc[train_raw.Weekend == 0]\ncity_vol_hour = city_vol_hour[['City','Hour','TotalTimeStopped_p50']]\\\n                        .groupby(['City','Hour']).mean().reset_index()","8f79bd8b":"vol_plot = sns.catplot(x=\"Hour\", y=\"TotalTimeStopped_p50\", col=\"City\", col_wrap = 2,\n                       data=city_vol_hour, kind = \"bar\", color = \"black\")","b58ca339":"city_vol_hour_we = train_raw.loc[train_raw.Weekend == 1]\ncity_vol_hour_we = city_vol_hour_we[['City','Hour','TotalTimeStopped_p50']]\\\n                        .groupby(['City','Hour']).mean().reset_index()","f6dede40":"vol_plot = sns.catplot(x=\"Hour\", y=\"TotalTimeStopped_p50\", col=\"City\", col_wrap = 2,\n                       data=city_vol_hour_we, kind = \"bar\", color = \"red\")","d4787e9d":"city_vol_hour_week = train_raw.loc[train_raw.Weekend == 0]\ncity_vol_hour_week = city_vol_hour_week[['City','Month','Hour','TotalTimeStopped_p50']]\\\n                        .groupby(['City','Month','Hour']).mean().reset_index()","3d481365":"vol_plot = sns.catplot(x=\"Hour\", y=\"TotalTimeStopped_p50\", col=\"Month\", col_wrap = 2,\n            hue=\"City\", data=city_vol_hour_week, kind = \"bar\")","e3e10faa":"corr_grid = sns.FacetGrid(train_raw[['City','TotalTimeStopped_p50','DistanceToFirstStop_p50']], hue = 'City' \n                          ,col = 'City', col_wrap = 2)\ncorr_grid = corr_grid.map(plt.scatter,'TotalTimeStopped_p50','DistanceToFirstStop_p50')","3bcf0023":"all_data = pd.concat([train_raw, test_raw], join = 'inner')\njunc_complex = all_data[['City','IntersectionId','EntryHeading','ExitHeading']]\\\n                    .drop_duplicates().groupby(['City','IntersectionId']).count().reset_index()","9c5f38bb":"complexity_grid = sns.FacetGrid(junc_complex[['City','EntryHeading']], col = 'City', col_wrap = 2, hue = \"City\")\ncomplexity_grid = complexity_grid.map(plt.hist, 'EntryHeading', density = True)\ncomplexity_grid.set_axis_labels(\"Possible Junction Decisions\", \"Density\")","15b97518":"junc_complex.loc[junc_complex.EntryHeading > 15]","85460fca":"all_data.isnull().sum()","3dc67c6e":"# Give the missing road names the NoName tag\nall_data.fillna('NoName', inplace = True)","5f5fc401":"def day_periods(row):\n    \n    if row.Weekend == 1:\n        if row.Hour >= 11 and row.Hour <= 19:\n            return 'we_day'\n        if row.Hour >= 20 or row.Hour <= 8:\n            return 'we_night'\n        else:\n            return 'we_morning'\n        \n    else:\n        if row.Hour >= 15 and row.Hour <= 18:\n            return 'eve_rush'\n        if row.Hour >= 19 and row.Hour <= 22:\n            return 'evening'\n        if row.Hour <= 5 or row.Hour >= 23:\n            return 'night'\n        if row.Hour >= 6 and row.Hour <= 9:\n            return 'mor_rush'\n        else:\n            return 'day'","850c0a9f":"all_data['DayPeriod'] = all_data.apply(day_periods, axis = 1)","30bd3793":"all_data['Hour']  = round( np.sin( all_data['Hour'] * np.pi \/ 12.0 ),4)\nall_data['Month'] = round( np.sin( all_data['Month'] * np.pi \/ 12.0 ),4)","51650582":"big_roads = ['Highway','Expressway','Parkway']\n\ndef junc_type(row):\n    if any(x in str(row.EntryStreetName) for x in big_roads) and any(x in str(row.ExitStreetName) for x in big_roads):\n        return 'BigBig'\n    elif any(x in str(row.EntryStreetName) for x in big_roads) and all(x not in str(row.ExitStreetName) for x in big_roads):\n        return 'BigSmall'\n    elif all(x not in str(row.EntryStreetName) for x in big_roads) and any(x in str(row.ExitStreetName) for x in big_roads):\n        return 'SmallBig'\n    else:\n        return 'SmallSmall'\n    \ndef straight_on(row):\n    if row.EntryStreetName == 'NoName' or row.ExitStreetName == 'NoName':\n        return 0\n    if row.EntryStreetName == row.ExitStreetName:\n        return 1\n    else:\n        return 0","03733a42":"all_data['RoadChange'] = all_data.apply(junc_type, axis = 1)\nall_data['StraightOn'] = all_data.apply(straight_on, axis = 1)","18a29816":"city_centers = pd.DataFrame({'Atlanta':[33.748151,-84.387840],\n                             'Philadelphia': [39.952732,-75.165198],\n                             'Chicago': [41.878136,-87.630822],\n                             'Boston':[42.360046,-71.060006]\n                            })\n\ndef add_radial_dist(df, city_centers):\n    \n    df['radialDist'] = df.apply(lambda x: np.sqrt( (city_centers[x.City][0] - x.Latitude )**2 + \n                                                     (city_centers[x.City][1] - x.Longitude )**2\n                                                 ), axis = 1 )\n    \ndef shift_long_lat(df, city_centers):\n    df['Latitude'] = df.apply(lambda x: x.Latitude - city_centers[x.City][0], axis = 1)\n    df['Longitude'] = df.apply(lambda x: x.Longitude - city_centers[x.City][1], axis = 1)","3d2f9721":"add_radial_dist(all_data,city_centers)\nshift_long_lat(all_data,city_centers)","0b150825":"junc_complex.head()\njunc_complex = junc_complex[['City','IntersectionId','EntryHeading']]\njunc_complex.columns = ['City','IntersectionId','Complexity']","845d068f":"all_data = all_data.merge(junc_complex, how = \"left\", on = ['IntersectionId','City'])","3d69539e":"all_data['JuncPath'] = all_data['EntryHeading'] + all_data['ExitHeading']","eb35d97c":"all_data['Intersection'] = all_data['IntersectionId'].astype(str) + all_data['City']","e8e6b9be":"le = preprocessing.LabelEncoder()\nle.fit(list(all_data['Intersection'].values))\nall_data['Intersection'] = le.transform(list(all_data['Intersection'].values))","2b2d3057":"predict_cols = ['Intersection','Latitude','Longitude','Hour','Weekend','Month', 'City', 'DayPeriod', 'radialDist',\n                'Complexity', 'JuncPath', 'RoadChange', 'StraightOn']","d25c446a":"all_x = all_data[predict_cols]","f9c36956":"all_x['Weekend'] = all_x['Weekend'].astype(str)","225bf5f5":"all_x = pd.get_dummies(all_x)","972ea7fe":"x_train = all_x[:len(train_raw)]\nx_test  = all_x[len(train_raw):]\n\noutput_cols = ['TotalTimeStopped_p20' ,'TotalTimeStopped_p50','TotalTimeStopped_p80',\n                     'DistanceToFirstStop_p20','DistanceToFirstStop_p50','DistanceToFirstStop_p80']\n\ny_train = train_raw[output_cols]","48e1118d":"rf = ensemble.RandomForestRegressor(n_estimators = 500)","1008109c":"rf.fit(x_train, y_train)\npredictions = rf.predict(x_test)\n\npred_series = pd.Series(list(predictions) )\nall_preds   = pd.Series.explode(pred_series)","c745713e":"sub_file = pd.read_csv(\"..\/input\/bigquery-geotab-intersection-congestion\/sample_submission.csv\"\nsub_file[\"Target\"] = all_preds.values\nsub_file.to_csv('submission.csv', index=False)","059be7f5":"#### We are only missing the street names, which we argue we can drop for this prediction, since we know the intersection id and the entry and exit heading.\n\nThis also means that some entries 'Path' are of the form 'Unknown_...'. We will also drop this column based on inituition\n> ","71c9043a":"### Cyclical variables\n\nThe month and hour variables are cyclical in that December (12) is prior to January (1) and similarly for hour 23 and hour 0. We would like to transform our variables such that we can reflect this. We will keep these variables as numeric in our prediction (i.e. we won't treat them as categorical).\n\n$$ H(t) = \\sin \\Big(\\frac{ \\pi t}{12} \\Big)$$\n\n$$ M(t) = \\sin \\Big(\\frac{ \\pi t}{12} \\Big)$$\n\nKeeping t between $0$ and $\\pi$ in monts means, the feature is maximized in the summer, minimized in the winter and spring and autumn are treated roughly the same.","b26ed394":"### What does the average median stop period look like for each city & hour (weekdays only)?","f20c94e6":"### Let's combine Entry and Exit directions into a JuncPath Variable\n\nThis will give us 8C2 = 28 columns when we one-hot encode these","2e0ca418":"### We will eventually predict two variables: 'Distance to First Stop' & 'Total Time Stopped', what does the correlation of the medians look like by city?","ab110c7e":"#### Our most complex junctions...","9a0ccf8c":"### Do we have any missing values?","768ab5c2":"### A short total time stopped but with a long distance to first stop likely means there is a very long phase on the junction (these are usually bigger junctions)\n* There is a long queue at the junction, but when the lights turn green, we get through in one go.\n* It looks like Atlanta and Philadelphia have more of these junctions\n","971dba74":"## Exploring the data\n### We know we have four cities, how many intersections do we have in each?","a2f96b06":"## Prediction","a81a9dcb":"### What does junction complexity look like for each city?","76c074ca":"### and at weekends?","2fc3dfda":"### Junction Complexity","71d02db5":"### Type of Road Change at Intersection\n\nWe add features which tell us if we are moving between big\/small roads as defined in \nhttps:\/\/en.wikipedia.org\/wiki\/Types_of_road\n\nWe also add whether the path continues along the same road or not","dde86277":"## Cleaning the data and feature preparation","1ba66128":"### What does the stop time profile look like for each city (weekdays only)?","acd1fcb4":"### Longitude and Latitude\n\nWe would like some consistent frame of reference for measuring the position of each junction. It makes sense to find the centrepoint of each city and measure radial distance.\n","7b82733e":"### Unique IntersectionId\nThe IntersectionId is only use for each city, we will construct a unique id and label encode them.","638f57be":"### Intersection data by city seems to be fairly incomplete for January and May. It is missing altogether for Feb-Apr.\n* Based on this very crude metric, it seems at initial glance that Atlanta is the most 'congested'\n* However this could be due to the fact we have less intersections (and they are just closer to the center of town)\n* This may explain why Chicago seems to have less congestion (since it has the most intersections and likely spans a greater area\n* Boston seems to be relatively busier during the day, but tails off at night compared to the other cities (in particular Philadelphia)\n"}}