{"cell_type":{"c89d1301":"code","a49a2d47":"code","9fb60265":"code","d68d573d":"code","5489b77a":"code","d970b9d8":"code","c9c4283d":"code","658e5401":"code","03df5c9c":"code","213d4689":"code","6eeb204f":"code","8558f43f":"code","4b9597aa":"code","3c237a83":"code","9cc4c7b1":"code","2b5cd035":"code","e8f5b683":"code","1b748486":"code","e81c0dde":"code","272e5c77":"code","dbdd844c":"markdown","a87aea00":"markdown","aecacfb2":"markdown","938909ef":"markdown","d8f7eeca":"markdown","61bc84ef":"markdown","6a57cddb":"markdown","01cc807f":"markdown","b482f29b":"markdown","6d27838a":"markdown","deb3b3eb":"markdown"},"source":{"c89d1301":"# This Python 3 environment comes with many helpful analytics libraries installed\n# It is defined by the kaggle\/python docker image: https:\/\/github.com\/kaggle\/docker-python\n# For example, here's several helpful packages to load in \n\nimport numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\n\n# Input data files are available in the \"..\/input\/\" directory.\n# For example, running this (by clicking run or pressing Shift+Enter) will list the files in the input directory\n\nimport os\nprint(os.listdir(\"..\/input\"))\n\n# Any results you write to the current directory are saved as output.","a49a2d47":"from fastai import *\nfrom fastai.vision import *\nfrom fastai.callbacks.hooks import *\nfrom fastai.callbacks import *\nfrom torchvision.models import *\nimport pandas as pd\nimport matplotlib.pyplot as plt\nimport seaborn as sns\nimport os\nfrom glob import glob\n","9fb60265":"path = Path(\"..\/input\")\nlabels = pd.read_csv('..\/input\/HAM10000_metadata.csv', sep=',')\nlabels.head()\n\nimageid = {os.path.splitext(os.path.basename(x))[0]: x\n                     for x in glob(os.path.join(path, '*', '*.jpg'))}\n\nlabels['path'] = labels['image_id'].map(imageid.get)\nlabels['path'] = labels['path'].str[9:]\nlabels.sample(5)","d68d573d":"unique_lesion = labels['lesion_id'].value_counts()","5489b77a":"sns.set(style=\"white\", palette=\"pastel\", color_codes=True)\nf, (ax1) = plt.subplots(1, 1, figsize=(6, 6))\nsns.countplot(x=unique_lesion, palette=\"Blues\", ax=ax1)\nplt.title('Number of images per lesion')\nplt.show()","d970b9d8":"f, (ax1, ax2) = plt.subplots(1, 2, figsize=(8, 5))\nsns.countplot(x=labels['sex'], palette=\"Blues\", ax=ax1)\nsns.boxplot(x=labels['age'], orient='v', ax=ax2)\nplt.show()","c9c4283d":"f, ax1 = plt.subplots(1,1, figsize=(10,5))\nsns.boxplot(x=labels['dx'], y=labels['age'], hue=labels['sex'], ax=ax1)\nplt.title('Diagnosis by gender')\nplt.show()","658e5401":"f, (ax1) = plt.subplots(1, 1, figsize=(8, 5), sharex=True)\nsns.countplot(x=labels['dx_type'], palette=\"Greens\", ax=ax1)\nplt.show()","03df5c9c":"f, (ax1) = plt.subplots(1, 1, figsize=(8, 5), sharex=True)\nsns.countplot(x=labels['localization'], palette=\"Reds\", ax=ax1)\nplt.xticks(rotation=90)\nplt.show()","213d4689":"tfms = get_transforms(do_flip=True, \n                      flip_vert=True,\n                      max_zoom=1.1,\n                      max_warp=0.2, \n                      p_affine=0.5,\n                      xtra_tfms=[rotate(degrees=(-45,45),p=.1),\n                                brightness(change=(0.35,0.65),p=.5),\n                                contrast(scale=(0.8,1.2),p=.5),\n                                dihedral(p=1)])","6eeb204f":"np.random.seed(21)\ndata = ImageDataBunch.from_df(path='..\/input\/', df=labels,\n                              ds_tfms=tfms, size=224,bs=16,\n                               valid_pct=0.2, fn_col='path', \n                              label_col='dx'\n                              ).normalize(imagenet_stats)","8558f43f":"data.show_batch(rows=3)","4b9597aa":"arch=densenet121\nlearner = create_cnn(data, arch=arch, metrics=[accuracy],ps=.5,model_dir=\"\/tmp\/model\/\",\n                    callback_fns=ShowGraph).to_fp16()","3c237a83":"learner.lr_find()\nlearner.recorder.plot()","9cc4c7b1":"learner.fit(1, 1e-2)","2b5cd035":"learner.unfreeze()\nlearner.lr_find()\nlearner.recorder.plot()","e8f5b683":"learner.fit_one_cycle(3, max_lr=slice(1e-5, 1e-3), wd=0.1)","1b748486":"learner.to_fp32()   #I think that in latest version of fastai you don't have to come back \n                    #from half_precision, but here gives me an error when running TTA.\nint=learner.interpret(tta=True)","e81c0dde":"int.plot_confusion_matrix(figsize=(6,6))","272e5c77":"int.plot_top_losses(9, figsize=(10,10), heatmap=False)","dbdd844c":"Sex and gender distribution may be important in many diseases, and we are provided with these data.","a87aea00":"Localization of the lesions is given. This could be a relevant data as many malignan lesions may be related to sun-exposed localizations.","aecacfb2":"# EDA","938909ef":"With longer training and with some tuning, I got ~90% accuracy with this approach at home, and confusion matrix improves a little more. Most confusing lesions are nevi with melanoma, as expected.  ","d8f7eeca":"Next,  some wrong predictions.","61bc84ef":"There are some skin lesions that were pictured several times. There's a bunch of lesions with 2\/3 pictures, I guess that they are differt photos from different angles, or at different times. ","6a57cddb":"# **HAM10000 Dataset: Skin lesion classification**\n\nThis dataset of skin lesions is the largest so far. There are 10015 images with seven diagnoses:\n* Actinic Keratoses (squamous cell carcinoma) and  Intraepithelial Carcinoma (Bowen\u2019s disease)\n* Basal cell carcinoma\n* Benign keratosis\n* Dermatofibroma\n* Melanocytic nevi\n* Melanoma\n\nFor an extensive explanation regarding this dataset, take a look at the original publication. \nhttps:\/\/www.nature.com\/articles\/sdata2018161\n\nAlso, this dataset was also part of a recent competition (https:\/\/challenge2018.isic-archive.com\/).\n","01cc807f":"# Training","b482f29b":"Diagnosis were made through several approaches. First, mostly by biopsy. Follow-up was applied for nevi, and at least 1.5 years was necessary in order to rule out any progression. Consensus mean that two dermatologist agreed on a benign lesion. Finally, confocal microscopy was used in some cases. \n\nOne comment: based on these numbers, this is a solid database, particularly because only a minor fraction of the cases were diagnosed by consensus (which also was solid: two trained dermatologist independently agreed on the diagnosis, all benign). ","6d27838a":"Neither gender nor age seem to relate to diagnosis, although I did not run any formal statistics. Interesting, all unknown genders are concentrated in nevi diagnoses. ","deb3b3eb":"# Prediction"}}