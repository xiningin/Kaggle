{"cell_type":{"f6403bda":"code","46792d7f":"code","59a9d3a9":"code","f21bf6cf":"code","69a93db7":"code","e1a8d2f6":"code","50971bcf":"markdown","8547a8bd":"markdown","06d2383e":"markdown","269406b8":"markdown"},"source":{"f6403bda":"from typing import Any, Dict\nimport numpy as np\nimport itertools as it\nimport gc\nfrom tqdm import tqdm\nfrom numba import jit\nimport pandas as pd","46792d7f":"def read_data(n_rows: int) -> pd.DataFrame:\n    data = pd.read_pickle(\"..\/input\/walmartbasedata\/data2.pickle\").loc[:n_rows]\n    data = data[data[\"part\"] != \"evaluation\"]\n    return data\ndata = read_data(1_000)\nDAYS_PRED = 28","59a9d3a9":"data","f21bf6cf":"%%time\ndf = data.copy()\nmemo = df.groupby([\"id\"])[\"demand\"]\nfor diff in [0, 1, 2]:\n    shift = DAYS_PRED + diff\n    df[f\"shift_t{shift}\"] = memo.transform(\n        lambda x: x.shift(shift)\n    )\n\nfor size in [7, 30, 60, 90, 180]:\n    df[f\"rolling_std_t{size}\"] = memo.transform(\n        lambda x: x.shift(DAYS_PRED).rolling(size).std()\n    )\n\nfor size in [7, 30, 60, 90, 180]:\n    df[f\"rolling_mean_t{size}\"] = memo.transform(\n        lambda x: x.shift(DAYS_PRED).rolling(size).mean()\n    )\n\ndf[\"rolling_skew_t30\"] = memo.transform(\n    lambda x: x.shift(DAYS_PRED).rolling(30).skew()\n)\ndf[\"rolling_kurt_t30\"] = memo.transform(\n    lambda x: x.shift(DAYS_PRED).rolling(30).kurt()\n)\ndf","69a93db7":"from scipy.stats import skew as skew2\nfrom scipy.stats import kurtosis as kurt2\ndef shift2(arr, num):\n    result = np.empty(arr.shape[0])\n    if num > 0:\n        result[:num] = np.nan\n        result[num:] = arr[:-num]\n    elif num < 0:\n        result[num:] = fill_value\n        result[:num] = arr[-num:]\n    else:\n        result[:] = arr\n    return result\n\ndef rolling2(arr, num):\n    v = np.ones(num) \/ num\n    y = np.convolve(arr, v, mode=\"same\")\n    return y","e1a8d2f6":"%%time\ndf = data.copy()\nmemo = df.groupby([\"id\"])[\"demand\"]\nfor diff in [0, 1, 2]:\n    shift = DAYS_PRED + diff\n    df[f\"shift_t{shift}\"] = memo.transform(\n        lambda x: shift2(x.values, int(shift))\n    )\nfor size in [7, 30, 60, 90, 180]:\n    df[f\"rolling_std_t{size}\"] = memo.transform(\n        lambda x: np.std(rolling2(shift2(x.values, DAYS_PRED), size))\n    )\nfor size in [7, 30, 60, 90, 180]:\n    df[f\"rolling_mean_t{size}\"] = memo.transform(\n        lambda x: np.mean(rolling2(shift2(x.values, DAYS_PRED), size))\n    )\ndf[\"rolling_kurt_t30\"] = memo.transform(\n    lambda x: kurt2(rolling2(shift2(x.values, DAYS_PRED), size))\n)\ndf[\"rolling_skew_t30\"] = memo.transform(\n    lambda x: skew2(rolling2(shift2(x.values, DAYS_PRED), size))\n)\ndf","50971bcf":"## Please share how to make better code.\n\nThank you for reading my kernel.(I'm not at English.)","8547a8bd":"## Normal code(16.3s)\n\nThe two codes do the same thing.","06d2383e":"[I read this kernel.](https:\/\/www.kaggle.com\/harupy\/m5-baseline)\n### __We require very fast code because it handles very large data.__\n\n### If you have any idea after looking at my code, please tell me on comment.\n\n## 16.3s\u21928.54s(Using NumPy, SciPy and an optimize function)","269406b8":"## My new code(8.54s)"}}