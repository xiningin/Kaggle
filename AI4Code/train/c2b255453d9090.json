{"cell_type":{"926e89e6":"code","f9f44157":"code","efd91b10":"code","6e477766":"code","b87a72a3":"code","7753da05":"code","8b459d1b":"code","c856355c":"code","ced52788":"code","fd4ef6ae":"code","a9e5ba90":"code","3dddf12c":"code","a8a824fb":"code","c593b8bc":"code","04809ea9":"code","a7ca685c":"code","bd722d4c":"code","c1329242":"code","a35544d2":"code","3aff7793":"code","e124edae":"code","27c195fc":"code","0025b57b":"code","67eba65b":"code","3ae916b0":"code","c8fc1f1d":"markdown"},"source":{"926e89e6":"# Importing libraries\nimport pandas as pd\nimport numpy as np\nimport gc\ngc.enable()\nimport matplotlib.pyplot as plt\n%matplotlib inline\nplt.rcParams['figure.figsize'] = (8.0, 5.0)\n\nimport warnings\nwarnings.filterwarnings(\"ignore\")\n\nfrom fastai import *\nfrom fastai.vision import *\n\nfrom utils import *","f9f44157":"path = Path('..\/input\/humpback-whale-identification\/')\npath_test = Path('..\/input\/humpback-whale-identification\/test')\npath_train = Path('..\/input\/humpback-whale-identification\/train')","efd91b10":"train_df=pd.read_csv(path\/'train.csv')\nval_fns = {'69823499d.jpg'}","6e477766":"print(\"Train Shape : \",train_df.shape)","b87a72a3":"print(\"No of Whale Classes : \",len(train_df.Id.value_counts()))","7753da05":"train_df.Id.value_counts().head()","8b459d1b":"(train_df.Id == 'new_whale').mean()","c856355c":"(train_df.Id.value_counts() == 1).mean()","ced52788":"fn2label = {row[1].Image: row[1].Id for row in train_df.iterrows()}\npath2fn = lambda path: re.search('\\w*\\.jpg$', path).group(0)","fd4ef6ae":"gc.collect()","a9e5ba90":"name = f'densenet169'\n\nSZ = 224\nBS = 64\nNUM_WORKERS = 0\nSEED=0","3dddf12c":"data = (\n    ImageItemList\n        .from_df(train_df[train_df.Id != 'new_whale'],path_train, cols=['Image'])\n        .split_by_valid_func(lambda path: path2fn(path) in val_fns)\n        .label_from_func(lambda path: fn2label[path2fn(path)])\n        .add_test(ImageItemList.from_folder(path_test))\n        .transform(get_transforms(do_flip=False, max_zoom=1, max_warp=0, max_rotate=2), size=SZ, resize_method=ResizeMethod.SQUISH)\n        .databunch(bs=BS, num_workers=NUM_WORKERS, path=path)\n).normalize(imagenet_stats)","a8a824fb":"data.show_batch(rows=3)","c593b8bc":"learn = create_cnn(data, models.densenet169, lin_ftrs=[2048], model_dir='..\/working\/')\nlearn.clip_grad()","04809ea9":"gc.collect()","a7ca685c":"SZ = 224 * 2\nBS = 64 \/\/ 4\nNUM_WORKERS = 0\nSEED=0","bd722d4c":"df = pd.read_csv('..\/input\/oversample-whale\/oversampled_train_and_val.csv')","c1329242":"data = (\n    ImageItemList\n        .from_df(df, path_train, cols=['Image'])\n        .split_by_valid_func(lambda path: path2fn(path) in val_fns)\n        .label_from_func(lambda path: fn2label[path2fn(path)])\n        .add_test(ImageItemList.from_folder(path_test))\n        .transform(get_transforms(do_flip=False, max_zoom=1, max_warp=0, max_rotate=2), size=SZ, resize_method=ResizeMethod.SQUISH)\n        .databunch(bs=BS, num_workers=NUM_WORKERS, path=path)\n        .normalize(imagenet_stats)\n)","a35544d2":"learn = create_cnn(data, models.densenet169, lin_ftrs=[2048], model_dir='..\/working\/')","3aff7793":"learn.fit_one_cycle(1, slice(6.92E-06))","e124edae":"gc.collect()\nlearn.save('stage-1')","27c195fc":"gc.collect()","0025b57b":"preds, _ = learn.get_preds(DatasetType.Test)\npreds = torch.cat((preds, torch.ones_like(preds[:, :1])), 1)\npreds[:, 5004] = 0.06\n\nclasses = learn.data.classes + ['new_whale']","67eba65b":"def top_5_preds(preds): return np.argsort(preds.numpy())[:, ::-1][:, :5]\n\ndef top_5_pred_labels(preds, classes):\n    top_5 = top_5_preds(preds)\n    labels = []\n    for i in range(top_5.shape[0]):\n        labels.append(' '.join([classes[idx] for idx in top_5[i]]))\n    return labels\n\ndef create_submission(preds, data, name, classes=None):\n    if not classes: classes = data.classes\n    sub = pd.DataFrame({'Image': [path.name for path in data.test_ds.x.items]})\n    sub['Id'] = top_5_pred_labels(preds, classes)\n    sub.to_csv(f'{name}.csv', index=False)","3ae916b0":"create_submission(preds, learn.data, name, classes)","c8fc1f1d":"41% of all whales have only a single image associated with them.\n\n38% of all images contain a new whale - a whale that has not been identified as one of the known whales."}}