{"cell_type":{"cdc0b235":"code","c1d1776e":"code","a26df853":"code","f3bcdaf9":"code","864ccea8":"code","fbd6280d":"code","6b0707c2":"code","57acd5fc":"code","48dd97b9":"code","6fc723f1":"code","3ae47ec3":"code","2fd1516b":"code","9b507fa3":"code","be01fa33":"code","3d66aaa3":"code","c9c03fd1":"code","29855860":"code","9911e336":"code","14ea2f2b":"code","db1b9b5b":"code","0f20798d":"code","25ad83dc":"code","4d480fc8":"code","b63b167b":"code","e522c0a4":"code","05c97db6":"code","c1dbba58":"code","0c90addb":"code","140dd37f":"code","bb7fa71c":"code","20ad1d3e":"code","9daedea4":"code","e75f89ab":"code","18d493ac":"code","efbd998d":"code","dc25968b":"code","0dc71140":"code","a09a86ba":"code","1f8c514c":"code","3bbd787a":"code","52203417":"code","95b8e6b3":"markdown","0dc573d1":"markdown","cd81aa08":"markdown","e80e1510":"markdown","edf3ba2a":"markdown","db3c6af6":"markdown","8225cb11":"markdown","358ffef6":"markdown","392f80b7":"markdown","609b6f2b":"markdown","3117be2a":"markdown","ede15286":"markdown","75c651ed":"markdown","02ffb3bf":"markdown","a8f061db":"markdown","5084973f":"markdown","969d3216":"markdown","b7152716":"markdown","c8344343":"markdown","3e335370":"markdown","d289408c":"markdown","496dec07":"markdown"},"source":{"cdc0b235":"import pandas as pd\nimport numpy as np\nimport plotly.express as px\nimport seaborn as sns\nfrom tqdm import tqdm\nimport matplotlib.pyplot as plt\n#!pip install raceplotly\n#from raceplotly.plots import barplot","c1d1776e":"players = pd.read_csv('..\/input\/mlb-player-digital-engagement-forecasting\/players.csv')\nseasons = pd.read_csv('..\/input\/mlb-player-digital-engagement-forecasting\/seasons.csv')\nawards = pd.read_csv('..\/input\/mlb-player-digital-engagement-forecasting\/awards.csv')\nteams = pd.read_csv('..\/input\/mlb-player-digital-engagement-forecasting\/teams.csv')\ntrain = pd.read_csv('..\/input\/mlb-player-digital-engagement-forecasting\/train.csv')","a26df853":"train.head()","f3bcdaf9":"train.info()","864ccea8":"train","fbd6280d":"train_next_day = pd.read_pickle('..\/input\/mlb-unnested\/train_nextDayPlayerEngagement.pickle')\ntrain_next_day.engagementMetricsDate = train_next_day.engagementMetricsDate.astype('datetime64')","6b0707c2":"train_next_day","57acd5fc":"train_next_day.head()","48dd97b9":"unique_date = list(train_next_day.engagementMetricsDate.unique())\ntarget1_lis = []\ntarget2_lis = []\ntarget3_lis = []\ntarget4_lis = []\nfor i in unique_date:\n    df = train_next_day[train_next_day['engagementMetricsDate']==i]\n    target1 = (df['target1'].sum())\/len(df)\n    target2 = (df['target2'].sum())\/len(df)\n    target3 = (df['target3'].sum())\/len(df)\n    target4 = (df['target4'].sum())\/len(df)\n    target1_lis.append(target1)\n    target2_lis.append(target2)\n    target3_lis.append(target3)\n    target4_lis.append(target4)","6fc723f1":"px.line(x=unique_date,y=target1_lis,title='target 1 over time')","3ae47ec3":"px.line(x=unique_date,y=target2_lis,title='target 2 over time')","2fd1516b":"px.line(x=unique_date,y=target3_lis,title='target 3 over time')","9b507fa3":"px.line(x=unique_date,y=target4_lis,title='target 4 over time')","be01fa33":"team_twitter = pd.read_pickle('..\/input\/mlb-unnested\/train_teamTwitterFollowers.pickle')\nteam_twitter","3d66aaa3":"#my_raceplot = barplot(team_twitter,  item_column='teamName', value_column='numberOfFollowers', time_column='date')\n#my_raceplot.plot(item_label = 'team name', value_label = 'number of followers', frame_duration = 800)","c9c03fd1":"standings = pd.read_pickle('..\/input\/mlb-unnested\/train_standings.pickle')\ntransactions = pd.read_pickle('..\/input\/mlb-unnested\/train_transactions.pickle')","29855860":"#my_raceplot = barplot(standings,  item_column='teamName',value_column='wins', time_column='dailyDataDate',top_entries=10)\n#my_raceplot.plot(item_label = 'team name', value_label = 'current wins', frame_duration = 800)","9911e336":"transactions = transactions.dropna()","14ea2f2b":"transactions","db1b9b5b":"most_transaction_team=transactions.groupby('fromTeamName')['toTeamName'].count().reset_index(name='Count').sort_values('Count',ascending=False)\npx.bar(most_transaction_team.head(10),x='fromTeamName',y='Count')","0f20798d":"most_transaction_player=transactions.groupby('playerName')['toTeamName'].count().reset_index(name='Count').sort_values('Count',ascending=False)\npx.bar(most_transaction_player.head(10),x='playerName',y='Count')","25ad83dc":"players.head()","4d480fc8":"players.info()","b63b167b":"px.histogram(players,x='birthCountry',color='birthCountry')","e522c0a4":"px.scatter(players,x='weight',y='heightInches')","05c97db6":"playerid = list(awards['playerId'])\naward_count = []\nfor i in playerid:\n    award_count.append(len(awards[awards['playerId']==i]))\naward_count = pd.DataFrame({\"playerId\":playerid,\"award_count\":award_count})\nplayers = pd.merge(players,award_count,on='playerId')","c1dbba58":"postition_list = list(players['primaryPositionName'].unique())\naward_count_sum = []\nfor i in postition_list:\n    award_count_sum.append(players[players['primaryPositionName']==i]['award_count'].sum()) ","0c90addb":"px.bar(x=postition_list,y=award_count_sum)","140dd37f":"most_award = awards['playerId'].mode()\nprint(f\"playerID: {most_award.values}\")\nawards[awards['playerId'] == 405395]","bb7fa71c":"px.histogram(awards,y='awardName',category_orders=awards['awardName'])","20ad1d3e":"sample_preiction = pd.read_pickle('..\/input\/mlb-unnested\/example_sample_submission.pickle')\nexample_test_games = pd.read_pickle('..\/input\/mlb-unnested\/example_test_games.pickle')\ntrain_games = pd.read_pickle('..\/input\/mlb-unnested\/train_games.pickle')\ntrain_next_day = pd.read_pickle('..\/input\/mlb-unnested\/train_nextDayPlayerEngagement.pickle')\ntrain_next_day['year'] = pd.DatetimeIndex(train_next_day['engagementMetricsDate']).year","9daedea4":"year = train_next_day.year.unique()\nweight=[0.05,0.05,0.1,0.8]#Experiment here with different values","e75f89ab":"def weighted_median(df, val, weight):\n    df_sorted = df.sort_values(val)\n    cumsum = df_sorted[weight].cumsum()\n    cutoff = df_sorted[weight].sum() \/ 2.\n    return df_sorted[cumsum >= cutoff][val].iloc[0]","18d493ac":"def preprocess(df,weight,year):\n    for i in range(len(year)):\n        df.loc[df['year']==year[i],'weight'] = weight[i]\npreprocess(train_next_day,weight,year)","efbd998d":"train_next_day.head()","dc25968b":"playerId = train_next_day['playerId'].unique()\nfor i in playerId:\n    df=train_next_day[train_next_day['playerId']==i]\n    wm1 = weighted_median(df,'target1','weight')\n    wm2 = weighted_median(df,'target2','weight')\n    wm3 = weighted_median(df,'target3','weight')\n    wm4 = weighted_median(df,'target4','weight')\n    train_next_day.loc[train_next_day['playerId']==i,'target1'] = wm1\n    train_next_day.loc[train_next_day['playerId']==i,'target2'] = wm2\n    train_next_day.loc[train_next_day['playerId']==i,'target3'] = wm3\n    train_next_day.loc[train_next_day['playerId']==i,'target4'] = wm4","0dc71140":"train_mean = train_next_day.groupby([\"playerId\"])[[\"target1\",\"target2\",\"target3\",\"target4\"]].median().reset_index()","a09a86ba":"train_mean.head()","1f8c514c":"def process_pred(df):\n    df[\"playerId\"] = df[\"date_playerId\"].apply(lambda x: int( x.split(\"_\")[1] ) )\n    df.drop([\"target1\",\"target2\",\"target3\",\"target4\"], axis=1, inplace=True)\n    df = df.merge(train_mean, on=\"playerId\", how=\"left\")\n    df.drop(\"playerId\", axis=1, inplace=True)\n    df = df.fillna(0.)\n    return df","3bbd787a":"import mlb\nenv = mlb.make_env() # initialize the environment\niter_test = env.iter_test() # iterator which loops over each date in test set\n\nfor (test_df, sample_prediction_df) in iter_test:\n    sample_prediction_df = process_pred(sample_prediction_df)\n    env.predict(sample_prediction_df)","52203417":"sample_prediction_df.head()","95b8e6b3":"# EDA","0dc573d1":"# About the Competition\ud83d\udea9\n<p style=\"font-size:15px\">In this competition, you\u2019ll predict how fans engage with MLB players\u2019 digital content on a daily basis for a future date range. You\u2019ll have access to player performance data, social media data, and team factors like market size. Successful models will provide new insights into what signals most strongly correlate with and influence engagement.\n\nImagine if you could predict MLB All Stars all season long or when each of a team\u2019s 25 players has his moment in the spotlight. These insights are possible when you dive deeper into the fandom of America\u2019s pastime. Be part of the first method of its kind to try to understand digital engagement at the player level in this granular, day-to-day fashion. Simultaneously help MLB build innovation more easily using Google Cloud\u2019s data analytics, Vertex AI and MLOps tools. You could play a part in shaping the future of MLB fan and player engagement.\n\nSubmissions are evaluated on the mean column-wise mean absolute error (MCMAE). A mean absolute error is calculated for each of the four target variables and the score is the average of those four MAE values.\n\n<\/p>","cd81aa08":"<p style=\"font-size:15px\">Now let's take look at players.csv<\/p>","e80e1510":"<p style=\"font-size:15px\">Let's see viz of country<\/p>","edf3ba2a":"<p style=\"font-size:15px\">Let's visualize how our targets change over time<\/p>","db3c6af6":"# Model","8225cb11":"<div class=\"alert alert-block alert-info\" style=\"font-size:15px; font-family:verdana; line-height: 2.0em;\">\nNote: Since this is a code competition You must submit to this competition using the provided MLB python time-series module, which ensures that models do not peek forward in time.\n<\/div>","358ffef6":"<h2><center>Work in Progress ... \u23f3<\/center><\/h2>","392f80b7":"<h2><center>If you learned something new or forked the notebook then please don't forget to upvote<br>Thank You<\/center>\n<\/h2>","609b6f2b":"<div style=\"font-size:15px\">We can also combine 2 data frames to gain more insights for example by combining award count with primary position name we can see which position gets most awards<\/div>","3117be2a":"<div style=\"font-size:15px\">\n We are given 7 csv files:-\n<ul>\n    <li><code>train.csv:<\/code>training set<\/li>\n    <li><code>example_test.csv:<\/code>example of test set<\/li>\n    <li><code>example_sample_submission.csv:<\/code>example of sample_submission<\/li>\n    <li><code>awards.csv:<\/code>awards won by players before 2018<\/li>\n    <li><code>players.csv:<\/code>Library high level information about all players.<\/li>\n    <li><code>seasons.csv:<\/code>Information about start and end dates of all seasons in this dataset<\/li>\n    <li><code>teams.csv:<\/code>Library containing high level information about all MLB teams.<\/li>\n<\/ul>    \n<\/div>","ede15286":"I am using an unnested dataset created by @Ml_Bear link of the original [kernel](https:\/\/www.kaggle.com\/naotaka1128\/creating-unnested-dataset) do check it out","75c651ed":"similary we can also plot raceplot to visuzalize no. of wins of a team over the years","02ffb3bf":"<div style=\"font-size:15px\">Let's see if there is a relationship between height and weight of players<\/div>","a8f061db":"<center><img src=\"https:\/\/stn2.tv\/wp-content\/uploads\/2020\/04\/mlb-logo.jpg\"><\/center>","5084973f":"<p style=\"font-size:15px\"> We can plot a raceplot to visualize no. of followers of the team growing over the years  <\/p>","969d3216":"# Data Description","b7152716":"year wise weighted targets","c8344343":"<div class=\"alert alert-block alert-info\" style=\"font-size:1ilocx; font-family:verdana; line-height: 2.0em;\">\n\ud83d\udcccno. of followers have grown over the years<br>\n\ud83d\udcccHouston Astros also seems to becoming more popular\n<\/div>","3e335370":"<div class=\"alert alert-block alert-info\" style=\"font-size:1ilocx; font-family:verdana; line-height: 2.0em;\">\nNote: Coulmn nextDayPlayerEngagement contains the targets that we want to predict\n<\/div>","d289408c":"Following starter model code is inspired from @ulrich07 <a href=\"https:\/\/www.kaggle.com\/ulrich07\/baseline-model-player-mean-or-median\">notebook<\/a> instead of just using median I am using weighted median and giving higher weight to the recent years","496dec07":"<p style=\"font-size:15px\">Let's take a peek at train.csv<\/p>"}}