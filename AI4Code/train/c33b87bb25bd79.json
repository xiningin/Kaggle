{"cell_type":{"97369d9d":"code","548bb547":"code","1c9077d7":"code","92659f07":"code","6936f50a":"code","5e1a8776":"code","e8b1195d":"code","ee054f3d":"code","e534d65f":"code","f65e3843":"code","1bb35a36":"code","8eebbdc9":"code","ebefeb2d":"code","9f5944de":"code","c92530a8":"code","af7e5e26":"code","1d422f9c":"code","33463d31":"code","57eb900b":"code","73454784":"code","649c601f":"code","7276a048":"code","29c10cf9":"code","e6736039":"code","33ab603b":"code","41291c6f":"code","fb32820f":"code","6298f604":"code","1e827a87":"code","f432e596":"code","e96896ed":"code","f7faef6c":"code","dcf0863f":"code","17807032":"markdown","8a5076ca":"markdown","188555a1":"markdown","e0d3386a":"markdown","b0c177bc":"markdown","fe24c419":"markdown","e06aa45c":"markdown","bc05e338":"markdown","f36fc313":"markdown","2190d3ce":"markdown","80b5ead9":"markdown","143fc629":"markdown","386e3f32":"markdown","9a15813d":"markdown","9c3119f9":"markdown","646fd787":"markdown","e50c619c":"markdown","541e683e":"markdown","c64a3c19":"markdown","665404ab":"markdown","abd39a4a":"markdown","82fa2b75":"markdown","657c9aac":"markdown","daa487bb":"markdown","abf646e6":"markdown","aa59c0ad":"markdown","97feace6":"markdown","70cacc03":"markdown","3ab67c0b":"markdown","7574b3b5":"markdown"},"source":{"97369d9d":"import numpy as np\nimport pandas as pd \nfrom keras.preprocessing.image import ImageDataGenerator, load_img\nfrom keras.utils import to_categorical\nfrom sklearn.model_selection import train_test_split\nimport matplotlib.pyplot as plt\nimport random\nimport os\nprint(os.listdir(\"..\/input\"))\n","548bb547":"FAST_RUN = False\nIMAGE_WIDTH=128\nIMAGE_HEIGHT=128\nIMAGE_SIZE=(IMAGE_WIDTH, IMAGE_HEIGHT)\nIMAGE_CHANNELS=3","1c9077d7":"filenames = os.listdir(\"..\/input\/train\/train\")\ncategories = []\nfor filename in filenames:\n    category = filename.split('.')[0]\n    if category == 'dog':\n        categories.append(1)\n    else:\n        categories.append(0)\n\ndf = pd.DataFrame({\n    'filename': filenames,\n    'category': categories\n})","92659f07":"df.head()","6936f50a":"df.tail()","5e1a8776":"df['category'].value_counts().plot.bar()","e8b1195d":"sample = random.choice(filenames)\nimage = load_img(\"..\/input\/train\/train\/\"+sample)\nplt.imshow(image)","ee054f3d":"from keras.models import Sequential\nfrom keras.layers import Conv2D, MaxPooling2D, Dropout, Flatten, Dense, Activation, BatchNormalization\n\nmodel = Sequential()\n\nmodel.add(Conv2D(32, (3, 3), activation='relu', input_shape=(IMAGE_WIDTH, IMAGE_HEIGHT, IMAGE_CHANNELS)))\nmodel.add(BatchNormalization())\nmodel.add(MaxPooling2D(pool_size=(2, 2)))\nmodel.add(Dropout(0.25))\n\nmodel.add(Conv2D(64, (3, 3), activation='relu'))\nmodel.add(BatchNormalization())\nmodel.add(MaxPooling2D(pool_size=(2, 2)))\nmodel.add(Dropout(0.25))\n\nmodel.add(Conv2D(128, (3, 3), activation='relu'))\nmodel.add(BatchNormalization())\nmodel.add(MaxPooling2D(pool_size=(2, 2)))\nmodel.add(Dropout(0.25))\n\nmodel.add(Flatten())\nmodel.add(Dense(512, activation='relu'))\nmodel.add(BatchNormalization())\nmodel.add(Dropout(0.5))\nmodel.add(Dense(2, activation='softmax')) # 2 because we have cat and dog classes\n\nmodel.compile(loss='categorical_crossentropy', optimizer='rmsprop', metrics=['accuracy'])\n\nmodel.summary()","e534d65f":"from keras.callbacks import EarlyStopping, ReduceLROnPlateau","f65e3843":"earlystop = EarlyStopping(patience=10)","1bb35a36":"learning_rate_reduction = ReduceLROnPlateau(monitor='val_acc', \n                                            patience=2, \n                                            verbose=1, \n                                            factor=0.5, \n                                            min_lr=0.00001)","8eebbdc9":"callbacks = [earlystop, learning_rate_reduction]","ebefeb2d":"df[\"category\"] = df[\"category\"].replace({0: 'cat', 1: 'dog'}) ","9f5944de":"train_df, validate_df = train_test_split(df, test_size=0.20, random_state=42)\ntrain_df = train_df.reset_index(drop=True)\nvalidate_df = validate_df.reset_index(drop=True)","c92530a8":"train_df['category'].value_counts().plot.bar()","af7e5e26":"validate_df['category'].value_counts().plot.bar()","1d422f9c":"total_train = train_df.shape[0]\ntotal_validate = validate_df.shape[0]\nbatch_size=15","33463d31":"train_datagen = ImageDataGenerator(\n    rotation_range=15,\n    rescale=1.\/255,\n    shear_range=0.1,\n    zoom_range=0.2,\n    horizontal_flip=True,\n    width_shift_range=0.1,\n    height_shift_range=0.1\n)\n\ntrain_generator = train_datagen.flow_from_dataframe(\n    train_df, \n    \"..\/input\/train\/train\/\", \n    x_col='filename',\n    y_col='category',\n    target_size=IMAGE_SIZE,\n    class_mode='categorical',\n    batch_size=batch_size\n)","57eb900b":"validation_datagen = ImageDataGenerator(rescale=1.\/255)\nvalidation_generator = validation_datagen.flow_from_dataframe(\n    validate_df, \n    \"..\/input\/train\/train\/\", \n    x_col='filename',\n    y_col='category',\n    target_size=IMAGE_SIZE,\n    class_mode='categorical',\n    batch_size=batch_size\n)","73454784":"example_df = train_df.sample(n=1).reset_index(drop=True)\nexample_generator = train_datagen.flow_from_dataframe(\n    example_df, \n    \"..\/input\/train\/train\/\", \n    x_col='filename',\n    y_col='category',\n    target_size=IMAGE_SIZE,\n    class_mode='categorical'\n)","649c601f":"plt.figure(figsize=(12, 12))\nfor i in range(0, 15):\n    plt.subplot(5, 3, i+1)\n    for X_batch, Y_batch in example_generator:\n        image = X_batch[0]\n        plt.imshow(image)\n        break\nplt.tight_layout()\nplt.show()","7276a048":"epochs=3 if FAST_RUN else 50\nhistory = model.fit_generator(\n    train_generator, \n    epochs=epochs,\n    validation_data=validation_generator,\n    validation_steps=total_validate\/\/batch_size,\n    steps_per_epoch=total_train\/\/batch_size,\n    callbacks=callbacks\n)","29c10cf9":"model.save_weights(\"model.h5\")","e6736039":"fig, (ax1, ax2) = plt.subplots(2, 1, figsize=(12, 12))\nax1.plot(history.history['loss'], color='b', label=\"Training loss\")\nax1.plot(history.history['val_loss'], color='r', label=\"validation loss\")\nax1.set_xticks(np.arange(1, epochs, 1))\nax1.set_yticks(np.arange(0, 1, 0.1))\n\nax2.plot(history.history['acc'], color='b', label=\"Training accuracy\")\nax2.plot(history.history['val_acc'], color='r',label=\"Validation accuracy\")\nax2.set_xticks(np.arange(1, epochs, 1))\n\nlegend = plt.legend(loc='best', shadow=True)\nplt.tight_layout()\nplt.show()","33ab603b":"test_filenames = os.listdir(\"..\/input\/test1\/test1\")\ntest_df = pd.DataFrame({\n    'filename': test_filenames\n})\nnb_samples = test_df.shape[0]","41291c6f":"test_gen = ImageDataGenerator(rescale=1.\/255)\ntest_generator = test_gen.flow_from_dataframe(\n    test_df, \n    \"..\/input\/test1\/test1\/\", \n    x_col='filename',\n    y_col=None,\n    class_mode=None,\n    target_size=IMAGE_SIZE,\n    batch_size=batch_size,\n    shuffle=False\n)","fb32820f":"predict = model.predict_generator(test_generator, steps=np.ceil(nb_samples\/batch_size))","6298f604":"test_df['category'] = np.argmax(predict, axis=-1)","1e827a87":"label_map = dict((v,k) for k,v in train_generator.class_indices.items())\ntest_df['category'] = test_df['category'].replace(label_map)","f432e596":"test_df['category'] = test_df['category'].replace({ 'dog': 1, 'cat': 0 })","e96896ed":"test_df['category'].value_counts().plot.bar()","f7faef6c":"sample_test = test_df.head(18)\nsample_test.head()\nplt.figure(figsize=(12, 24))\nfor index, row in sample_test.iterrows():\n    filename = row['filename']\n    category = row['category']\n    img = load_img(\"..\/input\/test1\/test1\/\"+filename, target_size=IMAGE_SIZE)\n    plt.subplot(6, 3, index+1)\n    plt.imshow(img)\n    plt.xlabel(filename + '(' + \"{}\".format(category) + ')' )\nplt.tight_layout()\nplt.show()","dcf0863f":"submission_df = test_df.copy()\nsubmission_df['id'] = submission_df['filename'].str.split('.').str[0]\nsubmission_df['label'] = submission_df['category']\nsubmission_df.drop(['filename', 'category'], axis=1, inplace=True)\nsubmission_df.to_csv('submission.csv', index=False)","17807032":"# Traning Generator","8a5076ca":"# Import Library","188555a1":"# See sample image","e0d3386a":"### Virtaulize Result","b0c177bc":"# Prepare Traning Data","fe24c419":"Because we will use image genaretor `with class_mode=\"categorical\"`. We need to convert column category into string. Then imagenerator will convert it one-hot encoding which is good for our classification. \n\nSo we will convert 1 to dog and 0 to cat","e06aa45c":"Seem to be nice ","bc05e338":"# Submission","f36fc313":"# Build Model\n\n<img src=\"https:\/\/i.imgur.com\/ebkMGGu.jpg\" width=\"100%\"\/>","2190d3ce":"# See how our generator work","80b5ead9":"# Predict","143fc629":"We will convert the predict category back into our generator classes by using `train_generator.class_indices`. It is the classes that image generator map while converting data into computer vision","386e3f32":"From our prepare data part. We map data with `{1: 'dog', 0: 'cat'}`. Now we will map the result back to dog is 1 and cat is 0","9a15813d":"# Save Model","9c3119f9":"# Virtualize Training","646fd787":"### Validation Generator","e50c619c":"This Kernel for someone want to deep dive into image classification. I use CNN for classification model. If you found this Kernel helpful please up vote it. If you have some feedback and question don't forget to comment below. \n\nI have simplier model with \n* https:\/\/www.kaggle.com\/uysimty\/get-start-image-classification","541e683e":"**Learning Rate Reduction**\n\nWe will reduce the learning rate when then accuracy not increase for 2 steps","c64a3c19":"**Early Stop**\n\nTo prevent over fitting we will stop the learning after 10 epochs and val_loss value not decreased","665404ab":"# Callbacks","abd39a4a":"# Prepare Testing Data","82fa2b75":"For categoral classication the prediction will come with probability of each category. So we will pick the category that have the highest probability with numpy average max","657c9aac":"# Define Constants","daa487bb":"# Create Testing Generator","abf646e6":"From our data we have 12000 cats and 12000 dogs","aa59c0ad":"### See predicted result with images","97feace6":"# Fit Model","70cacc03":"# Prepare data","3ab67c0b":"* **Input Layer**: It represent input image data. It will reshape image into single diminsion array. Example your image is 64x64 = 4096, it will convert to (4096,1) array.\n* **Conv Layer**: This layer will extract features from image.\n* **Pooling Layer**: This layerreduce the spatial volume of input image after convolution.\n* **Fully Connected Layer**: It connect the network from a layer to another layer\n* **Output Layer**: It is the predicted values layer. ","7574b3b5":"### See Total In count"}}