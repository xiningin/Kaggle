{"cell_type":{"b27b97fe":"code","46beaf36":"code","68907ec5":"code","268b47aa":"code","7acf8e4b":"code","ea4e236e":"code","9c649ffc":"code","cb881802":"code","f4698c51":"code","18207d07":"code","9fb114a8":"code","8573f7e9":"code","5ea19174":"code","c3d52ae1":"code","4b70ac1c":"code","613e51d9":"code","6e29301d":"code","cdd1e910":"code","5b5b368c":"code","50ead562":"code","b2057fd6":"code","b83eb293":"code","133863a6":"code","09c1d752":"code","5340dc1e":"code","bdeebe59":"code","e5cab7ff":"code","e1db171f":"code","6edf3855":"code","358e1dd2":"code","212ec67d":"code","4a51f7d8":"code","e1c355d4":"code","c3ef28cc":"code","de1397cd":"markdown","1ee04012":"markdown","9bd91e1a":"markdown","42d90f7c":"markdown","7066396d":"markdown","e61728a2":"markdown"},"source":{"b27b97fe":"from fastai.vision import *\nfrom fastai.metrics import KappaScore, accuracy\nfrom fastai.callbacks.tracker import ReduceLROnPlateauCallback, SaveModelCallback\nfrom fastai.callbacks import MixedPrecision\nimport sys, os, gc\nsys.path.insert(0, '..\/input\/aptos2019-blindness-detection')","46beaf36":"# copy pretrained weights for resnet34 to the folder fastai will search by default\nPath('\/tmp\/.cache\/torch\/checkpoints\/').mkdir(exist_ok=True, parents=True)","68907ec5":"!cp '..\/input\/resnet101\/resnet101.pth' '\/tmp\/.cache\/torch\/checkpoints\/resnet101-5d3b4d8f.pth'","268b47aa":"PATH = Path('..\/input\/aptos2019-blindness-detection')\ndf = pd.read_csv(PATH\/'train.csv')","7acf8e4b":"tfms = get_transforms(\n    do_flip=True,\n    flip_vert=True,\n    max_rotate=360,\n    max_warp=0,\n    max_zoom=1.1,\n    max_lighting=0.1,\n    p_lighting=0.5\n)","ea4e236e":"def return_train_data(size=56, bs=256):\n    return ImageDataBunch.from_df(\n        df=df,\n        folder='train_images',\n        path=PATH,\n        valid_pct=0.2,\n        ds_tfms=tfms,\n        size=size,\n        bs=bs,\n        suffix=\".png\",\n        resize_method=ResizeMethod.SQUISH,\n        padding_mode='zeros'\n    ).normalize(imagenet_stats)","9c649ffc":"# Small image data\ntrain_data = return_train_data()","cb881802":"kappa = KappaScore()\nkappa.weights = \"quadratic\"\n# loss_func = LabelSmoothingCrossEntropy()\nlearn = cnn_learner(\n    train_data,models.resnet101,metrics=[accuracy,kappa], model_dir='\/kaggle', pretrained=True\n                   ).mixup()\n# learn = load_learner(path=\"..\/input\/retinopathy-model\", file=\"stage_1.pkl\").to_fp32()\n\n# learn.data = train_data","f4698c51":"# Callbacks\nreduce_lr = ReduceLROnPlateauCallback(learn=learn, monitor='kappa_score', factor=1e-3, patience=2, min_delta=0.0002)\nsave_mod = SaveModelCallback(learn, every='improvement', monitor='kappa_score', name='best')","18207d07":"learn.lr_find()","9fb114a8":"learn.recorder.plot(suggestion=True)\nmin_grad_lr = learn.recorder.min_grad_lr","8573f7e9":"learn.fit_one_cycle(5, min_grad_lr, callbacks=[\n    reduce_lr, save_mod\n])","5ea19174":"learn.load(\"best\");\nlearn.export(f\"\/kaggle\/working\/model_bs_{train_data.batch_size}.pkl\")","c3d52ae1":"del train_data\ngc.collect(); gc.collect()\nlearn.load(\"best\");","4b70ac1c":"train_data = return_train_data(size=112, bs=128)\nlearn.data = train_data\nlearn.unfreeze()\nlearn.lr_find()","613e51d9":"learn.recorder.plot(suggestion=True)\nmin_grad_lr = learn.recorder.min_grad_lr","6e29301d":"learn.fit_one_cycle(5, min_grad_lr, callbacks=[reduce_lr, save_mod])","cdd1e910":"learn.load(\"best\");\nlearn.export(f\"\/kaggle\/working\/model_bs_{train_data.batch_size}.pkl\")","5b5b368c":"del train_data\ngc.collect(); gc.collect()\nlearn.load(\"best\");","50ead562":"train_data = return_train_data(size=224, bs=64)\nlearn.data = train_data\nlearn.freeze()\nlearn.lr_find()","b2057fd6":"learn.recorder.plot(suggestion=True)\nmin_grad_lr = learn.recorder.min_grad_lr","b83eb293":"learn.fit_one_cycle(5, min_grad_lr, callbacks=[reduce_lr, save_mod])","133863a6":"learn.load(\"best\");\nlearn.export(f\"\/kaggle\/working\/model_bs_{train_data.batch_size}.pkl\")","09c1d752":"del train_data\ngc.collect(); gc.collect()\nlearn.load(\"best\");","5340dc1e":"train_data = return_train_data(size=336, bs=32)\nlearn.data = train_data\n##### UNFREEZING #######\nlearn.unfreeze()\nlearn.lr_find()","bdeebe59":"learn.recorder.plot(suggestion=True)\nmin_grad_lr = learn.recorder.min_grad_lr","e5cab7ff":"learn.fit_one_cycle(5, min_grad_lr, callbacks=[reduce_lr, save_mod])","e1db171f":"learn.load(\"best\");\nlearn.export(f\"\/kaggle\/working\/model_bs_{train_data.batch_size}.pkl\")","6edf3855":"del train_data\ngc.collect(); gc.collect()\nlearn.load(\"best\");","358e1dd2":"sample_df = pd.read_csv(PATH\/'sample_submission.csv')\nsample_df.head()","212ec67d":"learn.data.add_test(ImageList.from_df(sample_df,PATH,folder='test_images',suffix='.png'))","4a51f7d8":"preds,y = learn.get_preds(DatasetType.Test)","e1c355d4":"sample_df.diagnosis = preds.argmax(1)\nsample_df.head()","c3ef28cc":"sample_df.to_csv('submission.csv',index=False)","de1397cd":"#### Fork of older version of [this kernel](https:\/\/www.kaggle.com\/khursani8\/fast-ai-starter-resnet34)","1ee04012":"### 336*32","9bd91e1a":"### Make Predictions","42d90f7c":"### 56*256","7066396d":"### 224*64","e61728a2":"### 112*128"}}