{"cell_type":{"c34cdfba":"code","90344ba7":"code","6f23c60f":"code","f24ec4ad":"code","6bd71461":"code","6c9c7673":"code","0d81f396":"code","ec0e2080":"code","951a971c":"code","428c3769":"code","1f19a77a":"code","89689206":"code","a058350c":"code","358a472d":"code","f25b2443":"code","b9854c1b":"code","4544ae91":"code","d7619d69":"code","1d8239f7":"code","fd7b255c":"code","11336849":"code","441755f3":"markdown","b65ff91a":"markdown","d073aa0e":"markdown","7c8fc2fd":"markdown","64499b54":"markdown","dd07a7ea":"markdown","96fca8ee":"markdown","1ebde4e6":"markdown","2c49f3cb":"markdown","9e422a77":"markdown","bd542d43":"markdown","8cff1125":"markdown","e3ea8db3":"markdown","278e16d9":"markdown","9b49f38b":"markdown","eb46b4b4":"markdown","c4375828":"markdown","f9f5a2c9":"markdown","cc458f06":"markdown","90c73546":"markdown","53a5921c":"markdown","07e977f4":"markdown","ef23357f":"markdown","e56273be":"markdown","9b328df6":"markdown","033095d4":"markdown","917bd265":"markdown","b0c7e730":"markdown","ec73504f":"markdown","942a3e9c":"markdown","126c7444":"markdown"},"source":{"c34cdfba":"%matplotlib inline\n\nimport sys\nimport scipy\nimport scipy.stats as ss\nimport numpy as np\nimport matplotlib\nimport matplotlib.pyplot as plt\nimport pandas as pd\nimport random","90344ba7":"ct_test = pd.read_csv('..\/input\/sat-ct-district-participation-2012csv\/SAT_CT_District_Participation_2012.csv') \nprint(ct_test.shape)\nct_test.head()","6f23c60f":"mean_rate = ct_test['Participation Rate'].mean()\n\n# ddof is the degrees of freedom correction \n# in the calculation of the standard deviation;\n# for population standard deviation ddof=0\nstdev_rate = ct_test['Participation Rate'].std(ddof=0)","f24ec4ad":"print('Mean participation rate is {:.3f}'.format(mean_rate))\nprint('Standard deviation is {:.3f}'.format(stdev_rate))","6bd71461":"zscore_rate = ss.zscore(ct_test['Participation Rate'], ddof=0)\nct_test = ct_test.assign(zscore=zscore_rate)\nct_test.head(8)","6c9c7673":"def plot_anomaly(score_data, threshold):\n    \n    score_data = score_data.copy().sort_values(ascending=False).values\n    ranks = np.linspace(1, len(score_data), len(score_data))\n    mask_outlier = (score_data < threshold)\n    \n    \n    plt.figure(dpi=150)\n    plt.plot(ranks[~mask_outlier], score_data[~mask_outlier],'o', color='b',label='OK schools')\n    plt.plot(ranks[mask_outlier], score_data[mask_outlier],'o', color='r', label='anomalies')\n    plt.axhline(threshold,color='r',label='threshold', alpha=0.5)\n    plt.legend(loc = 'lower left')\n    plt.title('Z-score vs. school district', fontweight='bold')\n    plt.xlabel('Ranked School district')\n    plt.ylabel('Z-score')\n    plt.show()","0d81f396":"plot_anomaly(ct_test['zscore'], -2)","ec0e2080":"zscore_anomalies = ct_test[(ct_test['zscore'] < -2)]\nzscore_anomalies","951a971c":"top_goals = pd.read_csv('..\/input\/world-cup-top-goal-scorers\/world_cup_top_goal_scorers.csv', \n                        encoding='utf-8',  \n                        names=['Year', 'Player(s)', 'Goals'], skiprows=1)                                                                                \ntop_goals","428c3769":"mean_goals = top_goals['Goals'].mean()\nstdev_goals = top_goals['Goals'].std(ddof=0)\nprint('Mean number of goals is {:.2f}'.format(mean_goals))\nprint('Standard deviation is {:.2f}'.format(stdev_goals))","1f19a77a":"zscore_goals = ss.zscore(top_goals['Goals'], ddof=0)\ntop_goals = top_goals.assign(zscore=zscore_goals)\ntop_goals.head(21)","89689206":"def plot_anomaly_goals(score_data, threshold):\n    score_data = score_data.copy().sort_values(ascending=False).values\n    ranks = np.linspace(1, len(score_data), len(score_data))\n    mask_outlier = (score_data > threshold)\n    \n    plt.figure(dpi=150)\n    plt.plot(ranks[mask_outlier], score_data[mask_outlier], 'o', color='r', label='anomalies')\n    plt.plot(ranks[~mask_outlier], score_data[~mask_outlier], 'o', color='b', label='typical player')\n    plt.axhline(threshold,color='r', label='threshold', alpha=0.5)\n    plt.legend(loc='upper right')\n    plt.title('Z-score vs. player', fontweight='bold')\n    plt.xticks(np.arange(0, 21, step=2.0))\n    plt.xlabel('Player Rank')\n    plt.ylabel('Z-score')\n    plt.show()","a058350c":"plot_anomaly_goals(top_goals['zscore'], 2)","358a472d":"zscore_anomalies_players = top_goals[(top_goals['zscore'] > 2)]\nzscore_anomalies_players","f25b2443":"median_goals = np.median(top_goals['Goals'])\nmedian_goals","b9854c1b":"print('The value of MAD is {:.2f}'.format(mad_goals))","4544ae91":"def modified_zscore(data, consistency_correction=1.4826):\n    \n    median = np.median(data)\n    \n    deviation_from_med = np.array(data) - median\n\n    mad = np.median(np.abs(deviation_from_med))\n    mod_zscore = deviation_from_med\/(consistency_correction*mad)\n    return mod_zscore, mad","d7619d69":"mod_zscore_goals, mad_goals = modified_zscore(top_goals['Goals'])\ntop_goals = top_goals.assign(mod_zscore=mod_zscore_goals)","1d8239f7":"def plot_anomaly_goals_2(score_data, threshold):\n    score_data = score_data.copy().sort_values(ascending=False).values\n    ranks = np.linspace(1, len(score_data), len(score_data))\n    mask_outliers = (score_data > threshold)\n    \n    plt.figure(dpi=150)\n    plt.plot(ranks[mask_outliers], score_data[mask_outliers],'o', color='r',label='anomalies')\n    plt.plot(ranks[~mask_outliers], score_data[~mask_outliers],'o', color='b', label='typical player')\n    plt.axhline(threshold,color='r',label='threshold', alpha=0.5)\n    plt.legend(loc = 'upper right')\n    plt.title('Modified z-score vs. player', fontweight='bold')\n    plt.xticks(np.arange(0, 21, step=2.0))\n    plt.xlabel('Player')\n    plt.ylabel('Modified z-score')\n    plt.show()","fd7b255c":"plot_anomaly_goals_2(top_goals['mod_zscore'], 2)","11336849":"mod_zscore_anomalies_players = top_goals[(top_goals['mod_zscore'] > 2)]\nmod_zscore_anomalies_players","441755f3":"**Let us start by analysing how z-score is calculated and can be used as anomaly detection.**","b65ff91a":"and this is the form we will use in the function below.","d073aa0e":"Only one player is picked out: Just Fontaine.","7c8fc2fd":"What is anomaly?\nAn anomaly is \u201can observation which deviates so much from other observations \nas to arouse suspicions that it was generated by a different mechanism.\u201d \n","64499b54":"Now calculate the modified z-score. For each data point it is defined as $x_{i}$ as follows:","dd07a7ea":"The answer is the mean and standard deviation are themselves susceptible to the presence of anomalies. With his 13 goals, the amazing Fontaine is raising the mean so much that most players fall below it. As a result, he becomes the only anomaly.","96fca8ee":"So the question arises why is it so?","1ebde4e6":" A common method for scoring anomalies in 1D data is the z-score.\nIf the mean and standard deviation are known, then for each data point \ncalculate the z-score as = data_point-mean\/standard_deviation","2c49f3cb":"In this series of anomaly detection we will start by defining what is anomaly and will discuss various methods to determine an anomaly, so let's start.","9e422a77":"where $\\tilde X$ is the median of the data and MAD is the median of the absolute deviation from the median.","bd542d43":"$y_{i} = (x_{i} - \\tilde X)\/{\\rm MAD}$","8cff1125":"* Anomalies are a subset of outliers (Aggarwal 2013)\n* All observations = normal data + outliers\n* Outliers = noise + anomalies \n* Noise = uninteresting outliers \n* Anomaly = sufficiently interesting outlier","e3ea8db3":"Now, modify the previous plotting function to display the results.","278e16d9":"Calculate the z-score and add the result to the dataframe.","9b49f38b":"And because of this the z-score can sometimes be unreliable, since the mean and standard deviation are themselves sensitive to anomalies but not median and mode.","eb46b4b4":"* If you like this work, don't forget to upvote.\n* Next time we will discuss how angle based techniques are used for anomaly detection","c4375828":"We will at the number of goals scored by the top goalscorer in every World Cup from 1930 through 2018 (21 competitions in total). ","f9f5a2c9":"As before, compute the modified z-score for all players then plot and list the results. Note that the threshold remains the same at  \ud835\udc66=+2 .","cc458f06":"As we are concerned about low participation rates, our cutoff will be a negative number we are looking for schools with participation rates below the mean. Here we choose $z=-2$. That is, any school with a z-score below -2 will be labeled as an anomaly. ","90c73546":"We will now look at a dataset that shows the limitations of z-scores and why the modified z-score can be useful.","53a5921c":"clearly our analysis is flawed. By looking at the plot, we see that in 12 out of 21 competitions, the top goalscorer(s) scored less than the mean number of goals (7.05).","07e977f4":"Here we are going to make a slight modification and introduce a consistency correction $k$, which allows us to use MAD as a consistent estimate for the standard deviation. The value of $k$ depends on the underlying distribution of the data. For simplicity, we will use the value for a normal distribution $k=1.4826$ (see [https:\/\/en.wikipedia.org\/wiki\/Median_absolute_deviation](https:\/\/en.wikipedia.org\/wiki\/Median_absolute_deviation)).\n\n**Note:** Correction factor of $k=1.4826$ still assumes the underlying data is normal!","ef23357f":"Now we find four anomalous players.","e56273be":"so this was all about anomaly detection using zscore and how modified-zscore overcomes the limitation of z-score.","9b328df6":"Finally, get a list of the schools that are anomalies.","033095d4":"Once again will start by using the z-score to identify anomalies. As we are interested in the superstars, this time we will have an upper threshold.  We choose $z = +2$. Above this z-score, any player will be labeled as an anomaly. ","917bd265":"$y_{i} = (x_{i} - \\tilde X)\/(k*{\\rm MAD})$","b0c7e730":"We have found our anomalies.","ec73504f":"* let us understand this with the help of an example\n* consider values = 2, 2, 3, 4, 7, 8, 9\n* we have mean = 5; median = 4; mode = 2; standard-deviation = 2.725 for above values\n* now we will introduce 30 an outlier:\n* values = 2, 2, 3, 4, 7, 8, **30**\n* now we have mean = 8; median = 4; mode = 2; standard-deviation = 9.242 for above values","942a3e9c":"So the modified z-score becomes","126c7444":"The *modified z-score* tackles this problem by using medians instead:"}}