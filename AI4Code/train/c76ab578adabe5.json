{"cell_type":{"b6876fca":"code","0b526d19":"code","2deee766":"code","34e71cfd":"code","226b98a6":"code","83b137e7":"code","639bac63":"code","09670e68":"code","71a86cff":"code","9a36ea9d":"code","c4a269ed":"code","d398233b":"code","82b19e60":"code","c36e7647":"code","0e3a1066":"code","a38196cf":"code","f9811ee8":"code","ef49dfb3":"code","11041898":"code","5e923f6d":"code","85d72c26":"markdown"},"source":{"b6876fca":"import matplotlib.pyplot as plt\nimport numpy as np\nimport pandas as pd\n\nfrom scipy.optimize import minimize\n\n%matplotlib inline","0b526d19":"MIN_VOTES = 100","2deee766":"df = pd.read_csv(\"\/kaggle\/input\/board-games\/bgg_GameItem.csv\", index_col=\"bgg_id\")\ndf.drop(\n    index=df.index[(df.compilation == 1) | (df.num_votes < MIN_VOTES)],\n    columns=['game_type', 'compilation', 'bga_id', 'dbpedia_id', 'luding_id', 'spielen_id', 'wikidata_id', 'wikipedia_id'],\n    inplace=True,\n)\ndf.shape","34e71cfd":"top = df.sort_values('avg_rating', ascending=False).head(5)\ntop.T","226b98a6":"for n, (bgg_id, name) in enumerate(top.name.items()):\n    print(f\"{n + 1}. {{{{% game {bgg_id} %}}}}{name}{{{{% \/game %}}}}\")","83b137e7":"data = df[\n    (df.year >= 1900)\n    & (df.year <= 2020)\n    & df.avg_rating.notna()\n    & df.bayes_rating.notna()\n    & (df.bayes_rating != 5.5)\n]\nprint(len(data))\ndf['num_dummy_votes'] = data.num_votes * (data.avg_rating - data.bayes_rating) \/ (data.bayes_rating - 5.5)\ndf.num_dummy_votes.describe()","639bac63":"df[df.index == 199478][[\"name\", \"num_votes\", \"avg_rating\", \"bayes_rating\", \"num_dummy_votes\"]]","09670e68":"num = 20\ndf.num_dummy_votes.quantile([n \/ num for n in range(num + 1)])","71a86cff":"ax = df.num_dummy_votes[(df.num_dummy_votes >= 1000) & (df.num_dummy_votes <= 2500)].hist(bins=200)\nax","9a36ea9d":"fig = ax.get_figure()\nfig.savefig(\"num_dummies_hist.svg\")","c4a269ed":"def bayes(avg_rating, num_rating, dummy_value, num_dummy):\n    return (avg_rating * num_rating + dummy_value * num_dummy) \/ (num_rating + num_dummy)","d398233b":"def correlations(data, start, end, step, dummy_value):\n    for num_dummy in range(start, end + 1, step):\n        col = \"bayes_rating_adj\"\n        data[col] = bayes(data.avg_rating, data.num_votes, dummy_value, num_dummy)\n        corr = data[[\"bayes_rating\", col]][data.num_votes >= MIN_VOTES].corr('spearman')['bayes_rating'][col]\n        yield num_dummy, corr\n\ndummy_value = 5.5\nstart, end, step = 1000, 2_500, 1\ndummy_values, correlations = zip(*correlations(df, start, end, step, dummy_value))\n\nprint(f\"Best value: {np.max(correlations):.10f} with {dummy_values[np.argmax(correlations)]} dummy ratings\")\n\nplt.plot(dummy_values, correlations)\nplt.savefig(\"num_dummies_corr.svg\")","82b19e60":"def target_corr(x, data=df):\n    num_dummy = x[0]\n    dummy_value = x[1] if len(x) > 1 else 5.5\n    temp = pd.DataFrame({\n        'original': data.bayes_rating,\n        'estimated': bayes(data.avg_rating, data.num_votes, dummy_value, num_dummy)\n    })\n    return -temp.corr('spearman')['original']['estimated']\n\ndef target_rmse(x, data=df):\n    num_dummy = x[0]\n    dummy_value = x[1] if len(x) > 1 else 5.5\n    return np.linalg.norm(data.bayes_rating - bayes(data.avg_rating, data.num_votes, dummy_value, num_dummy))","c36e7647":"x0 = np.array([1500])\nfor fun in (target_corr, target_rmse):\n    print(f\"Optimizing {fun}\")\n    result = minimize(\n        fun=fun, \n        x0=x0, \n        method='Nelder-Mead', \n        options={\n            'xatol': 1e-12, \n            'maxiter': 10_000,\n            'maxfev': 10_000,\n            'disp': True,\n        },\n    )\n    print(f\"Best value: {result.fun:.10f} with {result.x[0]:.1f} dummy ratings\")\n    if len(x0) > 1:\n        print(f\"Best dummy value: {result.x[1]:.5f}\")","0e3a1066":"x0 = np.array([1500, 5.5])\nfor fun in (target_corr, target_rmse):\n    print(f\"Optimizing {fun}\")\n    result = minimize(\n        fun=fun, \n        x0=x0, \n        method='Nelder-Mead', \n        options={\n            'xatol': 1e-12, \n            'maxiter': 10_000,\n            'maxfev': 10_000,\n            'disp': True,\n        },\n    )\n    print(f\"Best value: {result.fun:.10f} with {result.x[0]:.1f} dummy ratings\")\n    if len(x0) > 1:\n        print(f\"Best dummy value: {result.x[1]:.5f}\")","a38196cf":"average = (df.avg_rating * df.num_votes).sum() \/ df.num_votes.sum()\nprint(f\"Average rating: {average:.5f}\")","f9811ee8":"num_dummies = 1_600\ndf[\"bayes_rating_adj\"] = bayes(df.avg_rating, df.num_votes, average, num_dummies)\ndf[\"rank_adj\"] = df.bayes_rating_adj.rank(ascending=False)\n\nfor n, (bgg_id, name) in enumerate(df.sort_values(\"rank_adj\").name.head(100).items()):\n    print(f\"{n + 1}. {{{{% game {bgg_id} %}}}}{name}{{{{% \/game %}}}}\")","ef49dfb3":"top_ratings = df.num_votes.sort_values(ascending=False).iloc[249]\nprint(f\"The top 250 games have at least {top_ratings} ratings\")","11041898":"dummy_value = 5.5\ndf[\"bayes_rating_adj\"] = bayes(df.avg_rating, df.num_votes, dummy_value, top_ratings)\ndf[\"rank_adj\"] = df.bayes_rating_adj.rank(ascending=False)\n\nfor n, (bgg_id, name) in enumerate(df.sort_values(\"rank_adj\").name.head(100).items()):\n    print(f\"{n + 1}. {{{{% game {bgg_id} %}}}}{name}{{{{% \/game %}}}}\")","5e923f6d":"df[\"bayes_rating_adj\"] = bayes(df.avg_rating, df.num_votes, average, top_ratings)\ndf[\"rank_adj\"] = df.bayes_rating_adj.rank(ascending=False)\n\nfor n, (bgg_id, name) in enumerate(df.sort_values(\"rank_adj\").name.head(100).items()):\n    print(f\"{n + 1}. {{{{% game {bgg_id} %}}}}{name}{{{{% \/game %}}}}\")","85d72c26":"# Reverse engineering the BoardGameGeek ranking\n\nThis notebook contains the calculations for this [blog post](https:\/\/blog.recommend.games\/posts\/reverse-engineering-boardgamegeek-ranking\/). The aim is to understand how exactly the BoardGameGeek rankings are calculated. For the details and results, see the blog post."}}