{"cell_type":{"1c297827":"code","f1071652":"code","e702f0ad":"code","dbf2c286":"code","c4e23466":"code","b7aef442":"code","5007dddd":"code","55aeee1c":"code","f7edd03a":"code","caa1e73a":"code","87815e64":"code","36b09534":"code","243fd37a":"code","dd058289":"code","0398de94":"code","a20c0dfa":"code","cb906c0b":"code","5ceb9a59":"code","da584411":"code","87f7e695":"code","5f7b8f1b":"code","b119b84b":"code","fbf6dd50":"code","70e50ade":"code","a33e538c":"code","a85db2c1":"code","1fac88b6":"code","0a729ba1":"code","20f51291":"code","daa4cf91":"code","09a32f29":"code","247e8eac":"code","d5f2a08c":"code","c40f31fc":"markdown","b57cfc1b":"markdown","8503981a":"markdown","74971907":"markdown","4c279901":"markdown","9d11600f":"markdown","ecb2ed89":"markdown","7ab274fa":"markdown","1c1e5f63":"markdown","fcf109ee":"markdown","dee9e508":"markdown","0804e105":"markdown","fcba98bf":"markdown","5b9acbca":"markdown","e20d1027":"markdown","d0694af1":"markdown","371db1a6":"markdown","2e5eb9a2":"markdown","c37f0d89":"markdown","e9ebeadc":"markdown","82c91d2b":"markdown","d1de101d":"markdown","40060dbb":"markdown","b9bb9bf2":"markdown","75c5e771":"markdown","b3c23104":"markdown","0939d9a5":"markdown","53c3f4ef":"markdown","bedadd5c":"markdown","1f065a0d":"markdown"},"source":{"1c297827":"import numpy as np\nimport pandas as pd \nfrom keras.preprocessing.image import ImageDataGenerator, load_img\nfrom keras.utils import to_categorical\nfrom sklearn.model_selection import train_test_split\nimport matplotlib.pyplot as plt\nimport random\nimport os\nprint(os.listdir(\"..\/input\"))\n","f1071652":"FAST_RUN = False\nIMAGE_WIDTH=128\nIMAGE_HEIGHT=128\nIMAGE_SIZE=(IMAGE_WIDTH, IMAGE_HEIGHT)\nIMAGE_CHANNELS=3","e702f0ad":"filenames = os.listdir(\"..\/input\/train\/train\")\ncategories = []\nfor filename in filenames:\n    category = filename.split('.')[0]\n    if category == 'dog':\n        categories.append(1)\n    else:\n        categories.append(0)\n\ndf = pd.DataFrame({\n    'filename': filenames,\n    'category': categories\n})","dbf2c286":"df.head()","c4e23466":"df.tail()","b7aef442":"df['category'].value_counts().plot.bar()","5007dddd":"sample = random.choice(filenames)\nimage = load_img(\"..\/input\/train\/train\/\"+sample)\nplt.imshow(image)","55aeee1c":"from keras.models import Sequential\nfrom keras.layers import Conv2D, MaxPooling2D, Dropout, Flatten, Dense, Activation, BatchNormalization\n\nmodel = Sequential()\n\nmodel.add(Conv2D(32, (3, 3), activation='relu', input_shape=(IMAGE_WIDTH, IMAGE_HEIGHT, IMAGE_CHANNELS)))\nmodel.add(BatchNormalization())\nmodel.add(MaxPooling2D(pool_size=(2, 2)))\nmodel.add(Dropout(0.25))\n\nmodel.add(Conv2D(64, (3, 3), activation='relu'))\nmodel.add(BatchNormalization())\nmodel.add(MaxPooling2D(pool_size=(2, 2)))\nmodel.add(Dropout(0.25))\n\nmodel.add(Conv2D(128, (3, 3), activation='relu'))\nmodel.add(BatchNormalization())\nmodel.add(MaxPooling2D(pool_size=(2, 2)))\nmodel.add(Dropout(0.25))\n\nmodel.add(Flatten())\nmodel.add(Dense(512, activation='relu'))\nmodel.add(BatchNormalization())\nmodel.add(Dropout(0.5))\nmodel.add(Dense(2, activation='softmax')) # 2 because we have cat and dog classes\n\nmodel.compile(loss='categorical_crossentropy', optimizer='rmsprop', metrics=['accuracy'])\n\nmodel.summary()","f7edd03a":"from keras.callbacks import EarlyStopping, ReduceLROnPlateau","caa1e73a":"earlystop = EarlyStopping(patience=10)","87815e64":"learning_rate_reduction = ReduceLROnPlateau(monitor='val_acc', \n                                            patience=2, \n                                            verbose=1, \n                                            factor=0.5, \n                                            min_lr=0.00001)","36b09534":"callbacks = [earlystop, learning_rate_reduction]","243fd37a":"df[\"category\"] = df[\"category\"].replace({0: 'cat', 1: 'dog'}) ","dd058289":"train_df, validate_df = train_test_split(df, test_size=0.20, random_state=42)\ntrain_df = train_df.reset_index(drop=True)\nvalidate_df = validate_df.reset_index(drop=True)","0398de94":"train_df['category'].value_counts().plot.bar()","a20c0dfa":"validate_df['category'].value_counts().plot.bar()","cb906c0b":"total_train = train_df.shape[0]\ntotal_validate = validate_df.shape[0]\nbatch_size=15","5ceb9a59":"train_datagen = ImageDataGenerator(\n    rotation_range=15,\n    rescale=1.\/255,\n    shear_range=0.1,\n    zoom_range=0.2,\n    horizontal_flip=True,\n    width_shift_range=0.1,\n    height_shift_range=0.1\n)\n\ntrain_generator = train_datagen.flow_from_dataframe(\n    train_df, \n    \"..\/input\/train\/train\/\", \n    x_col='filename',\n    y_col='category',\n    target_size=IMAGE_SIZE,\n    class_mode='categorical',\n    batch_size=batch_size\n)","da584411":"validation_datagen = ImageDataGenerator(rescale=1.\/255)\nvalidation_generator = validation_datagen.flow_from_dataframe(\n    validate_df, \n    \"..\/input\/train\/train\/\", \n    x_col='filename',\n    y_col='category',\n    target_size=IMAGE_SIZE,\n    class_mode='categorical',\n    batch_size=batch_size\n)","87f7e695":"example_df = train_df.sample(n=1).reset_index(drop=True)\nexample_generator = train_datagen.flow_from_dataframe(\n    example_df, \n    \"..\/input\/train\/train\/\", \n    x_col='filename',\n    y_col='category',\n    target_size=IMAGE_SIZE,\n    class_mode='categorical'\n)","5f7b8f1b":"plt.figure(figsize=(12, 12))\nfor i in range(0, 15):\n    plt.subplot(5, 3, i+1)\n    for X_batch, Y_batch in example_generator:\n        image = X_batch[0]\n        plt.imshow(image)\n        break\nplt.tight_layout()\nplt.show()","b119b84b":"epochs=3 if FAST_RUN else 50\nhistory = model.fit_generator(\n    train_generator, \n    epochs=epochs,\n    validation_data=validation_generator,\n    validation_steps=total_validate\/\/batch_size,\n    steps_per_epoch=total_train\/\/batch_size,\n    callbacks=callbacks\n)","fbf6dd50":"model.save_weights(\"model.h5\")","70e50ade":"fig, (ax1, ax2) = plt.subplots(2, 1, figsize=(12, 12))\nax1.plot(history.history['loss'], color='b', label=\"Training loss\")\nax1.plot(history.history['val_loss'], color='r', label=\"validation loss\")\nax1.set_xticks(np.arange(1, epochs, 1))\nax1.set_yticks(np.arange(0, 1, 0.1))\n\nax2.plot(history.history['acc'], color='b', label=\"Training accuracy\")\nax2.plot(history.history['val_acc'], color='r',label=\"Validation accuracy\")\nax2.set_xticks(np.arange(1, epochs, 1))\n\nlegend = plt.legend(loc='best', shadow=True)\nplt.tight_layout()\nplt.show()","a33e538c":"test_filenames = os.listdir(\"..\/input\/test1\/test1\")\ntest_df = pd.DataFrame({\n    'filename': test_filenames\n})\nnb_samples = test_df.shape[0]","a85db2c1":"test_gen = ImageDataGenerator(rescale=1.\/255)\ntest_generator = test_gen.flow_from_dataframe(\n    test_df, \n    \"..\/input\/test1\/test1\/\", \n    x_col='filename',\n    y_col=None,\n    class_mode=None,\n    target_size=IMAGE_SIZE,\n    batch_size=batch_size,\n    shuffle=False\n)","1fac88b6":"predict = model.predict_generator(test_generator, steps=np.ceil(nb_samples\/batch_size))","0a729ba1":"test_df['category'] = np.argmax(predict, axis=-1)","20f51291":"label_map = dict((v,k) for k,v in train_generator.class_indices.items())\ntest_df['category'] = test_df['category'].replace(label_map)","daa4cf91":"test_df['category'] = test_df['category'].replace({ 'dog': 1, 'cat': 0 })","09a32f29":"test_df['category'].value_counts().plot.bar()","247e8eac":"sample_test = test_df.head(18)\nsample_test.head()\nplt.figure(figsize=(12, 24))\nfor index, row in sample_test.iterrows():\n    filename = row['filename']\n    category = row['category']\n    img = load_img(\"..\/input\/test1\/test1\/\"+filename, target_size=IMAGE_SIZE)\n    plt.subplot(6, 3, index+1)\n    plt.imshow(img)\n    plt.xlabel(filename + '(' + \"{}\".format(category) + ')' )\nplt.tight_layout()\nplt.show()","d5f2a08c":"submission_df = test_df.copy()\nsubmission_df['id'] = submission_df['filename'].str.split('.').str[0]\nsubmission_df['label'] = submission_df['category']\nsubmission_df.drop(['filename', 'category'], axis=1, inplace=True)\nsubmission_df.to_csv('submission.csv', index=False)","c40f31fc":"# Create Testing Generator","b57cfc1b":"# See sample image","8503981a":"# Define Constants","74971907":"# Build Model\n\n<img src=\"https:\/\/i.imgur.com\/ebkMGGu.jpg\" width=\"100%\"\/>","4c279901":"**Early Stop**\n\nTo prevent over fitting we will stop the learning after 10 epochs and val_loss value not decreased","9d11600f":"Seem to be nice ","ecb2ed89":"# Predict","7ab274fa":"* **Input Layer**: It represent input image data. It will reshape image into single diminsion array. Example your image is 64x64 = 4096, it will convert to (4096,1) array.\n* **Conv Layer**: This layer will extract features from image.\n* **Pooling Layer**: This layerreduce the spatial volume of input image after convolution.\n* **Fully Connected Layer**: It connect the network from a layer to another layer\n* **Output Layer**: It is the predicted values layer. ","1c1e5f63":"We will convert the predict category back into our generator classes by using `train_generator.class_indices`. It is the classes that image generator map while converting data into computer vision","fcf109ee":"# Save Model","dee9e508":"### Validation Generator","0804e105":"# Traning Generator","fcba98bf":"This Kernel for someone want to deep dive into image classification. I use CNN for classification model. If you found this Kernel helpful please up vote it. If you have some feedback and question don't forget to comment below. \n\nI have simplier model with \n* https:\/\/www.kaggle.com\/uysimty\/get-start-image-classification","5b9acbca":"# Virtualize Training","e20d1027":"# Fit Model","d0694af1":"### See predicted result with images","371db1a6":"# Prepare data","2e5eb9a2":"For categoral classication the prediction will come with probability of each category. So we will pick the category that have the highest probability with numpy average max","c37f0d89":"# Prepare Testing Data","e9ebeadc":"# Callbacks","82c91d2b":"# Submission","d1de101d":"### Virtaulize Result","40060dbb":"**Learning Rate Reduction**\n\nWe will reduce the learning rate when then accuracy not increase for 2 steps","b9bb9bf2":"# Prepare Traning Data","75c5e771":"Because we will use image genaretor `with class_mode=\"categorical\"`. We need to convert column category into string. Then imagenerator will convert it one-hot encoding which is good for our classification. \n\nSo we will convert 1 to dog and 0 to cat","b3c23104":"### See Total In count","0939d9a5":"From our prepare data part. We map data with `{1: 'dog', 0: 'cat'}`. Now we will map the result back to dog is 1 and cat is 0","53c3f4ef":"From our data we have 12000 cats and 12000 dogs","bedadd5c":"# Import Library","1f065a0d":"# See how our generator work"}}