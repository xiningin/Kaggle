{"cell_type":{"6ca275c5":"code","52c7fbf4":"code","2edc37fa":"code","7c1fa7bc":"code","e0be36b0":"code","bfa1edc9":"code","04656b13":"code","30409a8a":"code","9ce74181":"code","f8084956":"code","5c3ad6cd":"code","f65df0c3":"code","53593195":"code","8956842e":"code","fa42960f":"code","01626600":"code","0e5dce35":"code","8624703e":"code","5f8c1f2a":"code","83f5e240":"code","bc93275a":"code","90258d84":"code","212960aa":"code","7590e461":"code","ddf199dd":"markdown","f23f2ac3":"markdown","d65f01f8":"markdown","7417f3a8":"markdown","722739c1":"markdown","80f64db1":"markdown","762a7bfa":"markdown","00a8b0ab":"markdown"},"source":{"6ca275c5":"from pathlib import Path\n\nfrom fastai.text.all import *","52c7fbf4":"BASE_DATA_PATH = Path(\"..\/input\/commonlitreadabilityprize\/\")\n\ndf_train = pd.read_csv(BASE_DATA_PATH \/ \"train.csv\")\ndf_test = pd.read_csv(BASE_DATA_PATH \/ \"test.csv\")\n\ndf_train = df_train[[\"excerpt\", \"target\"]]","2edc37fa":"common_lit = DataBlock(blocks=(TextBlock.from_df(\"excerpt\", is_lm=True)), \n                       get_x=ColReader(\"text\"), \n                       splitter=RandomSplitter(seed=42))\n\ndls_lm = common_lit.dataloaders(df_train, bs=64, seq_len=256)","7c1fa7bc":"dls_lm.show_batch(max_n=4)","e0be36b0":"learn = language_model_learner(dls_lm, AWD_LSTM, metrics=[accuracy, Perplexity()], wd=0.1).to_fp16()","bfa1edc9":"learn.lr_find()","04656b13":"learn.fit_one_cycle(1, 1e-2)","30409a8a":"learn.save('1epoch')","9ce74181":"learn = learn.load('1epoch')","f8084956":"learn.unfreeze()\nlearn.fit_one_cycle(10, 1e-3)","5c3ad6cd":"learn.save_encoder('finetuned')","f65df0c3":"dls_class = DataBlock(blocks=(TextBlock.from_df('excerpt', seq_len=256, vocab=dls_lm.vocab), RegressionBlock),\n                      get_x=ColReader('text'),\n                      get_y=ColReader('target'),\n                      splitter=RandomSplitter())\n\ndls = dls_class.dataloaders(df_train, bs=64)\ndls.show_batch(max_n=4)","53593195":"learn = text_classifier_learner(dls, AWD_LSTM, drop_mult=0.5, metrics=rmse)","8956842e":"learn = learn.load_encoder(\"finetuned\")","fa42960f":"learn.lr_find()","01626600":"learn.fit_one_cycle(1, 2e-2)","0e5dce35":"learn.freeze_to(-2)\nlearn.fit_one_cycle(1, slice(1e-2\/(2.6**4),1e-2))","8624703e":"learn.freeze_to(-3)\nlearn.fit_one_cycle(1, slice(5e-3\/(2.6**4),5e-3))","5f8c1f2a":"learn.unfreeze()\nlearn.fit_one_cycle(2, slice(1e-3\/(2.6**4),1e-3))","83f5e240":"# learn.save(\"final\")\nlearn.export(\"final.pkl\")","bc93275a":"test_dl = learn.dls.test_dl(df_test.excerpt)","90258d84":"preds, _ = learn.get_preds(dl=test_dl)","212960aa":"df_sub = pd.read_csv(BASE_DATA_PATH \/ \"sample_submission.csv\")\ndf_sub['target'] = preds.numpy()\ndf_sub.to_csv('submission.csv',index=False)","7590e461":"df_sub","ddf199dd":"# Inference","f23f2ac3":"# Language Model Dataloaders","d65f01f8":"# Load & Fine-tune the Regressor Model","7417f3a8":"# Language Model Learner","722739c1":"# Dataloaders for the Text Regression","80f64db1":"# Fine-tune the LM","762a7bfa":"# Data Loading","00a8b0ab":"# About this notebook\n\n* This notebook is created based on this fastai [tutorial](https:\/\/docs.fast.ai\/tutorial.text.html). Additional information can be found on the fastai book as well on [Chapter 10](https:\/\/github.com\/fastai\/fastbook\/blob\/master\/10_nlp.ipynb) and [Chapter 12](https:\/\/github.com\/fastai\/fastbook\/blob\/master\/12_nlp_dive.ipynb). \n\n* This notebook also creates the submission as well. Additional inference notebook can be found from [here](https:\/\/www.kaggle.com\/snnclsr\/commonlit-fastai-inference) for faster submissions.\n\n"}}