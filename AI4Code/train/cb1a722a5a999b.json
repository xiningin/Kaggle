{"cell_type":{"80cd94bd":"code","dfa6b1d7":"code","5aacc4d3":"code","605f09d3":"code","6c7b15b5":"code","92dc195a":"code","db009313":"code","58c2c40b":"code","8c66fca6":"code","b68455d3":"code","50e243b9":"code","655f59cd":"code","85ac4cd8":"markdown","1ecd147e":"markdown","c59a1209":"markdown","5aadfa0f":"markdown","de1338d7":"markdown","3c81f586":"markdown","29152c37":"markdown"},"source":{"80cd94bd":"import os\nimport json\nimport pandas as pd\nfrom pandas.io.json import json_normalize\n\n#using https:\/\/www.kaggle.com\/julian3833\/1-quick-start-read-csv-and-flatten-json-fields\/notebook\ndef load_df(csv_path='..\/input\/ga-customer-revenue-prediction\/train.csv', nrows=None):\n    JSON_COLUMNS = ['device', 'geoNetwork', 'totals', 'trafficSource']\n    \n    df = pd.read_csv(csv_path, \n                     converters={column: json.loads for column in JSON_COLUMNS}, \n                     dtype={'fullVisitorId': 'str'}, # Important!!\n                     nrows=nrows)\n    \n    for column in JSON_COLUMNS:\n        column_as_df = json_normalize(df[column])\n        column_as_df.columns = [f\"{column}.{subcolumn}\" for subcolumn in column_as_df.columns]\n        df = df.drop(column, axis=1).merge(column_as_df, right_index=True, left_index=True)\n    print(f\"Loaded {os.path.basename(csv_path)}. Shape: {df.shape}\")\n    return df\n    \ntrain = load_df()\n\n# Keep only a subset of columns for illustration\ndf_train = train[['fullVisitorId','date','sessionId','visitStartTime','totals.transactionRevenue']]\n\n#Load external data\ntrain_store_1 = pd.read_csv('..\/input\/exported-google-analytics-data\/Train_external_data.csv', low_memory=False, skiprows=6, dtype={\"Client Id\":'str'})\ntrain_store_2 = pd.read_csv('..\/input\/exported-google-analytics-data\/Train_external_data_2.csv', low_memory=False, skiprows=6, dtype={\"Client Id\":'str'})\ndf_extra = pd.concat([train_store_1, train_store_2], sort=False)","dfa6b1d7":"df_train.head()","5aacc4d3":"df_extra.head()","605f09d3":"def get_visitId_by_cid(cid):\n    return cid.split('.')[1]\ndef get_visitId_by_sid(sid):\n    return sid.split('_')[1]","6c7b15b5":"df_train['visitId'] = df_train['sessionId'].apply(get_visitId_by_sid)\ndf_extra['visitId'] = df_extra['Client Id'].apply(get_visitId_by_cid)","92dc195a":"df_train.head()","db009313":"df_extra.head()","58c2c40b":"df_joint = df_train.merge(df_extra, how='inner', left_on='visitId', right_on='visitId')","8c66fca6":"df_joint.head(10)","b68455d3":"df_joint['totals.transactionRevenue'] = pd.to_numeric(df_joint['totals.transactionRevenue']) \/ 10**6  # convert to float USD. Should have done earlier.","50e243b9":"# Truncate the table for better view\ndf_trun = df_joint[df_joint['totals.transactionRevenue'] > 0.0][['date', 'Client Id', 'fullVisitorId', 'visitId', 'totals.transactionRevenue', 'Revenue', 'Transactions']]  # take a look at all rows with non-zero revenue ","655f59cd":"df_trun.head()","85ac4cd8":"Notice that `Revenue` looks close to the double of `totals.transactionRevenue`,  and a lot of `Transactions` are taking value of 2 (even numbers). In fact, this is a well-know issue of GA, where sampling is used if you query a lot of data at same time. This problem affects @Ankit's data too. You can verify this by searching for a Client ID in the User Exploer view, for example `446817349.1472832496` on Sep 2nd 2016, and it will show the correct, unsampled value ($ 117.34). \n\nAlso note that we did not touch the topic of shipping cost and tax, and they may (not) affect the revenues in the two tables. I will leave you to explore.\n\nThat's it. Hope you like it.","1ecd147e":"You can see that lots of sessions do not have any revenue in train set, but external data says otherwise. Part of the reason is the train data is on session level but external data is on user level, so I should have group-sum the revenue by `fullVisitorId` before joining. Another possibility is the organiser filtered out some  purchases, or multiple users share the same `visitId`, or there exists other problems in our method. But you get the idea. \n\nAnother puzzle is that the revenue from two sides do not match. Let's take a closer look:","c59a1209":"The part after `_` in `sessionId` in `df_train` is called `visitId`, which is the timestamp of the 1st session of a user. This `visitId` also shows up in  `Client ID`, after a dot `.`.\n\nA few notes:\n1. The part before the `_` in `sessionId` is `fullVisitorId`, or `fid`. We will use this terminology onward.\n2. In general, `Client ID` can take any format, but by default it is a numerical string (randomly generated to distinguish a cookie) and`visitId` joined by dot in between.\n3. Since `visitId` is a timestamp down to second precision, it is rare to see two sessions having same `visitId`. When this happens, we can further cross-check other information of the session, e.g. PV, location etc.\n\nTherefore, given a `sessionId`, we can split it to get the `fullVisitorId` and `visitId`, where `visitId` can be referenced to the `Client ID` in external data, giving us the revenue of a `fullVisitorId`.\n\nReference [here](https:\/\/support.google.com\/analytics\/answer\/3437719?hl=en).\n\n\nLets extract `visitId` from both tables.","5aadfa0f":"`df_train` is our training set, and `df_extra` is the external data corresponding to training set's time period.\n\nLet's take a look at the data first.","de1338d7":"### This kernel is a simple illustration of the previous data leak, forking @Ankit's kernel \"Story Of A Leak\".","3c81f586":"Joining these tables together by `visitId`...","29152c37":"We can download some leaked data from demo account of Google Merchandise Account (see [here](https:\/\/support.google.com\/analytics\/answer\/6367342?hl=en)). In particular, we can find from User Explorer the purchase history of any user (identified by *Client ID*, or *cid*), but here will simply use @Ankit's data  (with a note that it has a problem to be addressed later).\n\nLet's load the external 'leaked' data. We will use only the train set for illusration."}}