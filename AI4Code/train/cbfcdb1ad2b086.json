{"cell_type":{"41783e43":"code","f0d2f5b5":"code","ada7dc6e":"code","5e8e31b2":"code","54e9ba2c":"code","69f447ba":"code","d26ce56a":"markdown","cd440bc5":"markdown","11390ce2":"markdown","36bf6591":"markdown","19ad4b0a":"markdown","5cc71d0b":"markdown"},"source":{"41783e43":"!pip install fuggle","f0d2f5b5":"from fuggle import setup, Plot, PlotBar, PlotBarH, PlotLine, Dag\nsetup(\"spark\", {\"fuggle.sqlite.path\":\"\/kaggle\/input\/california-traffic-collision-data-from-switrs\"})","ada7dc6e":"%%fsql\nSELECT case_id, collision_date, collision_time, alcohol_involved, collision_severity\n    FROM switrs.sqlite.collisions WHERE collision_time IS NOT NULL AND collision_date IS NOT NULL\nSAVE AND USE OVERWRITE \"\/kaggle\/working\/t1.parquet\"\nPRINT","5e8e31b2":"%%fsql\ndata = \n    SELECT substr(collision_time, 0, 4) AS time, collision_severity, alcohol_involved\n    FROM (LOAD \"\/kaggle\/working\/t1.parquet\")\n    WHERE collision_time IS NOT NULL AND collision_severity IN (\"property damage only\",\"pain\",\"other injury\",\"severe injury\",\"fatal\")\n\nSELECT time,\n       COUNT(*) AS total,\n       SUM(CASE WHEN alcohol_involved=1.0 THEN 1 ELSE 0 END) AS alcohol_involved\n    FROM data\n    GROUP BY time\n\nOUTPUT USING PlotLine(x=\"time\", height=0.3, title=\"Case Count Per 10 Minutes\")\n\nSELECT time, collision_severity,\n       COUNT(*) AS total,\n       SUM(CASE WHEN alcohol_involved=1.0 THEN 1 ELSE 0 END) AS alcohol_involved\n    FROM data\n    GROUP BY time, collision_severity\n\nOUTPUT PREPARTITION BY collision_severity USING PlotLine(x=\"time\", width=0.5, height=0.2)\n\nSELECT time, collision_severity, alcohol_involved\/total AS alcohol_involved_ratio\nOUTPUT USING PlotLine(x=\"time\", group=\"collision_severity\", y=\"alcohol_involved_ratio\", height=0.3, title=\"Alcohol Involved Ratio\")","54e9ba2c":"%%fsql\ndata = \n    SELECT dayofweek(collision_date) AS time, collision_severity, alcohol_involved\n    FROM (LOAD \"\/kaggle\/working\/t1.parquet\")\n    WHERE collision_time IS NOT NULL AND collision_severity IN (\"property damage only\",\"pain\",\"other injury\",\"severe injury\",\"fatal\")\n        \nSELECT time, collision_severity,\n       COUNT(*) AS total,\n       SUM(CASE WHEN alcohol_involved=1.0 THEN 1 ELSE 0 END) AS alcohol_involved\n    GROUP BY time, collision_severity\n\nOUTPUT PREPARTITION BY collision_severity USING PlotLine(x=\"time\", order_by=\"time\", width=0.5, height=0.2)\n\nSELECT time, collision_severity, alcohol_involved\/total AS alcohol_involved_ratio\nOUTPUT USING PlotLine(x=\"time\", group=\"collision_severity\", y=\"alcohol_involved_ratio\", height=0.3, title=\"Alcohol Involved Ratio\")","69f447ba":"%%fsql\ndata = \n    SELECT dayofyear(collision_date) AS time, collision_severity, alcohol_involved\n    FROM (LOAD \"\/kaggle\/working\/t1.parquet\")\n    WHERE collision_time IS NOT NULL AND collision_severity IN (\"property damage only\",\"pain\",\"other injury\",\"severe injury\",\"fatal\")\n        \nSELECT time, collision_severity,\n       COUNT(*) AS total,\n       SUM(CASE WHEN alcohol_involved=1.0 THEN 1 ELSE 0 END) AS alcohol_involved\n    GROUP BY time, collision_severity\n\nOUTPUT PREPARTITION BY collision_severity USING PlotLine(x=\"time\", width=0.5, height=0.2)\n\nSELECT time, collision_severity, alcohol_involved\/total AS alcohol_involved_ratio\nOUTPUT USING PlotLine(x=\"time\", group=\"collision_severity\", y=\"alcohol_involved_ratio\", height=0.3, title=\"Alcohol Involved Ratio\")","d26ce56a":"# Alcohol Involved Collisions\n\nI am curious how alcohol affects driving and accident severity. So this is a very simple EDA to get some insights.\n\nAgain, this notebook is using [Fugue](https:\/\/github.com\/fugue-project\/fugue) [SQL](https:\/\/fugue-tutorials.readthedocs.io\/en\/latest\/tutorials\/sql.html). I notice that Sqlite is not as fast as Spark SQL (on this dataset). So I extracted related data into a file, then use Spark SQL to analyze it. Actually, in Fugue, it's quite simple to switch between Sqlite and Spark to do the same thing, it only depends on which is a better fit.\n\nNotice that exporting a lot of data from Sqlite isn't a good idea, it takes a lot of time and can cause out of memory issue.\n\n## Install dependency","cd440bc5":"## Are there more accidents at certain day of a year?\n\nNo\n\n* It seems for any severity, they are all flat\n* The more severe, the high percentage caused by alcohol","11390ce2":"## Conclusion\n\nDon't drink and drive","36bf6591":"## Export Sqlite data into a parquet file","19ad4b0a":"## Are there more accidents at certain time of a day?\n\nYes\n\n* for severe and fatal accidents, weekends have more accidents\n* alcohol involved percentage is higher in weekends\n* The more severe, the high percentage caused by alcohol","5cc71d0b":"## Are there more accidents at certain time of a day?\n\nHere are the findings:\n\n* If looking at aggregated per 10 minutes case count, `fatal` and `severe injury` shares the similar pattern, and other severities have the similar pattern\n* **rush hours** have more accidents\n* alcohol involved accidents have quite different pattern, **between 1am and 2am**, they are the highest\n* for percentage of alcohol related accidents\n    * **1am to 2am** is still the highest\n    * **The more severe, the high percentage caused by alcohol**"}}