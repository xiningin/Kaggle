{"cell_type":{"55a0ed1a":"code","79509d44":"code","c58309d3":"code","4fc49b69":"code","b74e0324":"code","833e5a1d":"code","f119dd63":"code","93e6b4db":"code","c5bdd5bf":"code","41337fca":"code","c5ec3cbe":"code","1b7b6b92":"code","131dba32":"code","5bd04d6a":"code","73517490":"code","d4e5723f":"code","73f3cee1":"code","565cc07c":"code","4e2142c5":"code","41d51c77":"code","c8ace5e0":"code","61c3fe4e":"code","a6d71994":"code","ef1aa8af":"code","aacdca6b":"code","c7343ead":"code","61be57aa":"markdown","644fa734":"markdown","8c96de09":"markdown","ecfb6f89":"markdown","11a545fe":"markdown","fcbe1a02":"markdown","40f8f256":"markdown","e3eaa3f0":"markdown"},"source":{"55a0ed1a":"!pip install tensorflow==1.15\n","79509d44":"import tensorflow.compat.v1 as tf\ntf.disable_v2_behavior()\nimport tensorflow_hub as hub","c58309d3":"print(tf.__version__)","4fc49b69":"# This Python 3 environment comes with many helpful analytics libraries installed\n# It is defined by the kaggle\/python Docker image: https:\/\/github.com\/kaggle\/docker-python\n# For example, here's several helpful packages to load\n\nimport numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\n\n# Input data files are available in the read-only \"..\/input\/\" directory\n# For example, running this (by clicking run or pressing Shift+Enter) will list all files under the input directory\n\nimport os\n#for dirname, _, filenames in os.walk('\/kaggle\/input'):\n    #for filename in filenames:\n        #print(os.path.join(dirname, filename))\n\n# You can write up to 5GB to the current directory (\/kaggle\/working\/) that gets preserved as output when you create a version using \"Save & Run All\" \n# You can also write temporary files to \/kaggle\/temp\/, but they won't be saved outside of the current session","b74e0324":"import glob\nfrom pathlib import Path\nimport matplotlib.pyplot as plt\nimport seaborn as sns\nimport itertools\n%matplotlib inline\nimport cv2\nfrom collections import defaultdict\nfrom IPython.display import SVG\nfrom tqdm.notebook import tqdm\nfrom PIL import Image","833e5a1d":"#import tensorflow as tf\nfrom tensorflow.python.client import device_lib\nprint(device_lib.list_local_devices())","f119dd63":"!git clone https:\/\/www.github.com\/matterport\/Mask_RCNN.git\nos.chdir('Mask_RCNN')","93e6b4db":"!wget --quiet https:\/\/github.com\/matterport\/Mask_RCNN\/releases\/download\/v2.0\/mask_rcnn_coco.h5\n!ls -lh mask_rcnn_coco.h5","c5bdd5bf":"import sys\n# Root directory of the project\n#ROOT_DIR = os.path.abspath(\"..\/..\/\")\nROOT_DIR = ('..\/kaggle\/working\/')\n# Import Mask RCNN\nsys.path.append(ROOT_DIR)  # To find local version of the library\nfrom mrcnn.config import Config\nfrom mrcnn import utils\nimport mrcnn.model as modellib\nfrom mrcnn import visualize\nfrom mrcnn.model import log\n\n\n# Directory to save logs and trained model\n#MODEL_DIR = os.path.join(ROOT_DIR, \"..\/output\/kaggle\/working\/logs\")\nMODEL_DIR = ('..\/kaggle\/working\/Mask_RCNN')\n\n# Local path to trained weights file\n#COCO_MODEL_PATH = os.path.join(MODEL_DIR, \"mask_rcnn_coco.h5\")\n# Download COCO trained weights from Releases if needed\n#if not os.path.exists(COCO_MODEL_PATH):\n#    utils.download_trained_weights(COCO_MODEL_PATH)","41337fca":"class DetectorConfig(Config):\n   \n    # Configuration name  \n    NAME = 'instances'\n    \n    # We have one GPU available, but can put multiple images on it\n    # Batch size is 8 (GPUs * images\/GPU)\n    GPU_COUNT = 1\n    IMAGES_PER_GPU = 8\n    \n    BACKBONE = 'resnet101' #'resnet101' would be another option\n    \n    NUM_CLASSES = 2  # background + pneumonia classes -->semantic segmentation\n    \n    IMAGE_MIN_DIM = 256\n    IMAGE_MAX_DIM = 256\n    TRAIN_ROIS_PER_IMAGE = 32 #or 16\n    MAX_GT_INSTANCES = 4 #or 3\n    DETECTION_MAX_INSTANCES = 3\n    DETECTION_MIN_CONFIDENCE = 0.78  #or 0.7\n    DETECTION_NMS_THRESHOLD = 0.01 #or 0.3\n    STEPS_PER_EPOCH = 200 #or 500\n    \nconfig = DetectorConfig()\nconfig.display()","c5ec3cbe":"sys.path.append(os.path.join('Mask_RCNN'))  # To find local version of the library\nfrom mrcnn.config import Config\nfrom mrcnn import utils\nimport mrcnn.model as modellib\nfrom mrcnn import visualize\nfrom mrcnn.model import log\n \n#!cd coco_weight && wget --quiet https:\/\/github.com\/matterport\/Mask_RCNN\/releases\/download\/v2.0\/mask_rcnn_coco.h5\n#!ls -lh mask_rcnn_coco.h5\nCOCO_WEIGHTS_PATH = \"\/kaggle\/working\/mask_rcnn_coco.h5\"","1b7b6b92":"MODEL_DIR\nCOCO_WEIGHTS_PATH","131dba32":"# Create model in training mode\nmodel = modellib.MaskRCNN(mode='training', config=config, model_dir=MODEL_DIR)\nmodel.load_weights(COCO_WEIGHTS_PATH, by_name=True, exclude=[\n    \"mrcnn_class_logits\", \"mrcnn_bbox_fc\",\n    \"mrcnn_bbox\", \"mrcnn_mask\"])","5bd04d6a":"path = '\/kaggle\/input\/open-images-instance-segmentation-rvc-2020\/test'\nfile_list = os.listdir(path )\ntype(file_list)\ntest_df = pd.DataFrame(file_list)\ntest_df.rename(columns = {0:'image_ids'}, inplace = True)","73517490":"img = cv2.imread( image_path + '00001a21632de752.jpg')\nplt.imshow(img)\nIMG_SHAPE = img.shape\nprint (IMG_SHAPE)","d4e5723f":"def display_images(flnames):\n    f, ax = plt.subplots(3,4, figsize=(20,40))\n    image_path = '\/kaggle\/input\/open-images-instance-segmentation-rvc-2020\/test\/'\n    #for img in path.iterdir():\n\n    for i, fl in enumerate(flnames):\n        ax[i\/\/4,i%4].set_axis_off()\n        img = cv2.imread( image_path+fl)\n        ax[i\/\/4,i%4].imshow(img)\n        ax[i\/\/4,i%4].set_title(f'{fl}')\n        f.tight_layout()","73f3cee1":"display_images(list(test_df['image_ids'][:12]))","565cc07c":"'''\nfig, axes = plt.subplots(10, figsize=(20,20))\nfor i in range(10):\n    img = cv2.imread( image_path+test_df['image_ids'][i])\n    axes[i].imshow(img)\n''' ","4e2142c5":"def resize_image(image):\n    img = cv2.imread(image_path)\n    img = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)\n    img = cv2.resize(img, (self.IMAGE_SIZE, self.IMAGE_SIZE), interpolation=cv2.INTER_AREA)  \n    return img","41d51c77":"#hs, ws = [], []\ntest_df['height'] = \"\"\ntest_df['weight'] = \"\"\n#test_df = pd.DataFrame(file_list)\nfor i, row in tqdm(test_df.iterrows(), total = len(test_df)): #total = len(test_df)):\n    img = Image.open(Path(path)\/(test_df['image_ids'][i]))\n    h, w = img.size\n    test_df['height'][i] = h\n    test_df['weight'][i] = w\n    #hs.append(h)\n    #ws.append(w)","c8ace5e0":"test_df.head(5)","61c3fe4e":"test_df.to_csv('\/kaggle\/working\/test_df.csv')","a6d71994":"# example of inference with a pre-trained coco model\nfrom keras.preprocessing.image import load_img\nfrom keras.preprocessing.image import img_to_array\nfrom mrcnn.visualize import display_instances\nfrom mrcnn.config import Config\nfrom mrcnn.model import MaskRCNN\n \n# define 81 classes that the coco model knows about\n\nclass_names = ['BG', 'person', 'bicycle', 'car', 'motorcycle', 'airplane',\n               'bus', 'train', 'truck', 'boat', 'traffic light',\n               'fire hydrant', 'stop sign', 'parking meter', 'bench', 'bird',\n               'cat', 'dog', 'horse', 'sheep', 'cow', 'elephant', 'bear',\n               'zebra', 'giraffe', 'backpack', 'umbrella', 'handbag', 'tie',\n               'suitcase', 'frisbee', 'skis', 'snowboard', 'sports ball',\n               'kite', 'baseball bat', 'baseball glove', 'skateboard',\n               'surfboard', 'tennis racket', 'bottle', 'wine glass', 'cup',\n               'fork', 'knife', 'spoon', 'bowl', 'banana', 'apple',\n               'sandwich', 'orange', 'broccoli', 'carrot', 'hot dog', 'pizza',\n               'donut', 'cake', 'chair', 'couch', 'potted plant', 'bed',\n               'dining table', 'toilet', 'tv', 'laptop', 'mouse', 'remote',\n               'keyboard', 'cell phone', 'microwave', 'oven', 'toaster',\n               'sink', 'refrigerator', 'book', 'clock', 'vase', 'scissors',\n               'teddy bear', 'hair drier', 'toothbrush']\n\n#class_names = ['car','Car'] \n# define the test configuration\nclass ImgConfig(Config):\n     NAME = \"images\"\n     GPU_COUNT = 1\n     IMAGES_PER_GPU = 1\n     NUM_CLASSES = 1 + 80\n\n# define the model\nrcnn = MaskRCNN(mode='inference', model_dir=MODEL_DIR, config=ImgConfig())\n# load coco model weights\nrcnn.load_weights(COCO_WEIGHTS_PATH, by_name=True)\n# load image\nimg = load_img(image_path + test_df['image_ids'][6])\nimg = img_to_array(img)\n# make prediction\nresults = rcnn.detect([img], verbose=0)\n# get dictionary for first prediction\nr = results[0]\n# show photo with bounding boxes, masks, class labels and scores\n#if (class_names == 'car'):\ndisplay_instances(img, r['rois'], r['masks'], r['class_ids'], class_names, r['scores'])","ef1aa8af":"# load image\nimg = load_img(image_path + test_df['image_ids'][15])\nimg = img_to_array(img)\n# make prediction\nresults = rcnn.detect([img], verbose=0)\n# get dictionary for first prediction\nr = results[0]\n# show photo with bounding boxes, masks, class labels and scores\n#if (class_names == 'car'):\ndisplay_instances(img, r['rois'], r['masks'], r['class_ids'], class_names, r['scores'])","aacdca6b":"# load image\nimg = load_img(image_path + test_df['image_ids'][9])\nimg = img_to_array(img)\n# make prediction\nresults = rcnn.detect([img], verbose=0)\n# get dictionary for first prediction\nr = results[0]\n# show photo with bounding boxes, masks, class labels and scores\n#if (class_names == 'car'):\ndisplay_instances(img, r['rois'], r['masks'], r['class_ids'], class_names, r['scores'])","c7343ead":"# load image\nimg = load_img(image_path + test_df['image_ids'][100])\nimg = img_to_array(img)\n# make prediction\nresults = rcnn.detect([img], verbose=0)\n# get dictionary for first prediction\nr = results[0]\n# show photo with bounding boxes, masks, class labels and scores\n#if (class_names == 'car'):\ndisplay_instances(img, r['rois'], r['masks'], r['class_ids'], class_names, r['scores'])","61be57aa":"Submissions are evaluated by computing mean Average Precision, with the mean taken over the 300 segmentable classes of the challenge. It follows the same spirit as the Object Detection evaluation, but takes into account mask-to-mask matching.","644fa734":"### Lets load another image and check","8c96de09":"# Open Images Instance Segmentation RVC 2020 edition\n## Outline segmentation masks of objects in images","ecfb6f89":"### We need to downgrade to TF 1.x in order to use MaskRCNN model","11a545fe":"![image.png](attachment:image.png)","fcbe1a02":"[Acknowledgement : MaskRCNN](https:\/\/github.com\/matterport\/Mask_RCNN)","40f8f256":"### Evaluation Metric","e3eaa3f0":"### Lets try One more gray image"}}