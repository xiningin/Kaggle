{"cell_type":{"a37ecbf6":"code","c41c228f":"code","cb44e5ce":"code","aaf5bef0":"code","8d612150":"code","1e448389":"code","43b74364":"code","d8e8f5f9":"code","5cc035ad":"code","9d969380":"code","da5c74f1":"code","3b19f311":"code","2682ef90":"code","02aea721":"code","edb4d712":"code","db6455fc":"code","fdced4b3":"code","1f1b2ab9":"code","e7d05638":"code","c20f3c54":"code","ca638628":"code","7e0c1660":"code","8d4d2826":"code","76e73920":"code","95f6a6db":"code","c346fd3d":"code","a5cb9801":"code","bf00d7cf":"code","bc898670":"code","3f3d507d":"code","8274b486":"code","3b68337a":"code","150bfc9c":"code","3e711243":"code","1d9d06ca":"code","04e9d0d1":"code","6776eb04":"code","55a05a33":"code","76a09f69":"code","4a69563d":"code","f360ce96":"code","05672551":"code","9d0c1028":"code","85262d15":"code","4a0cdf57":"code","f6ede7b3":"code","84f2471b":"markdown","83f0af39":"markdown","89a1a7f5":"markdown","4436e55f":"markdown","97194438":"markdown","863034c0":"markdown","498a68b9":"markdown","9b33046d":"markdown","41b300ba":"markdown","51d8d040":"markdown","451efafa":"markdown","d5a56dab":"markdown","52277da3":"markdown","63bbe86b":"markdown","45a41d77":"markdown","6c86053f":"markdown","ab974f23":"markdown","5fa2c786":"markdown","9b4526db":"markdown","e0182cdb":"markdown","5e74d90e":"markdown","801ed0d7":"markdown","84500aa5":"markdown","72d7a8cd":"markdown","9cec8986":"markdown","d35bdf57":"markdown","eb5b380d":"markdown"},"source":{"a37ecbf6":"import numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\nimport pydicom\nimport matplotlib.pyplot as plt\nimport matplotlib.patches as patches\nimport seaborn as sns\n\nimport os\nprint(os.listdir(\"..\/input\"))","c41c228f":"\npatient_classes = pd.read_csv('..\/input\/stage_2_detailed_class_info.csv')\npatient_classes.head()","cb44e5ce":"print(\"Number of classes in the dataset :: %i\" %  len(patient_classes[\"class\"].unique()))\nprint(\"Classes' names are :: %s\" % patient_classes[\"class\"].unique())","aaf5bef0":"class_count = patient_classes['class'].value_counts()\nclass_count.plot.bar( ec=\"orange\")\nprint(class_count)","8d612150":"\ntrain_labels = pd.read_csv('..\/input\/stage_2_train_labels.csv')\nprint(train_labels.iloc[0])","1e448389":"\ndcm_file = '..\/input\/stage_2_train_images\/%s.dcm' % train_labels.patientId.tolist()[0]\ndcm_data = pydicom.read_file(dcm_file)\nprint(dcm_data)  ","43b74364":"patientIds = train_labels.drop_duplicates('patientId', keep = 'first').patientId.tolist()","d8e8f5f9":"Sex = []\nAge = []\nfor patientId in patientIds:\n    dcm_file = '..\/input\/stage_2_train_images\/%s.dcm' % patientId\n    dcm_data = pydicom.read_file(dcm_file)\n    Sex.append(dcm_data.PatientSex)\n    Age.append(int(dcm_data.PatientAge))","5cc035ad":"patientInfo = pd.DataFrame({'patientId': patientIds, 'patientSex': Sex, 'patientAge': Age})\npatientInfo.dtypes","9d969380":"patientAge_count = patientInfo['patientAge'].value_counts().sum()\npatientSex_count = patientInfo['patientSex'].value_counts().sum()\npatient_count = patientInfo['patientId'].value_counts().sum()\n\nprint(\"total number of patientId :: %i\" % patient_count )\nprint(\"Total number of patients with Non null patientSex :: %i \" % patientSex_count )\nprint(\"Total number of patients with Non null patientAge :: %i \" %  patientAge_count )\nprint(\"Number of missing values to be imputed for the first field :: %i \" % (patient_count - patientSex_count) )\nprint(\"Number of missing values to be imputed for the second field :: %i \" % (patient_count - patientAge_count) )","da5c74f1":"patientInfo = patientInfo.set_index('patientId').join(train_labels.set_index('patientId'))[['patientSex', 'patientAge', 'Target']]\npatientInfo.reset_index(inplace=True)\npatientInfo.head()","3b19f311":"patientInfo.describe()","2682ef90":"\npatientInfo['patientAge'].unique()","02aea721":"\npatientInfo['patientAge'].hist()","edb4d712":"\npatientInfo[patientInfo['patientAge']>=90]['patientAge'].hist(bins=50)","db6455fc":"patientInfo[patientInfo['patientAge']>=85]['patientAge'].value_counts()","fdced4b3":"\ndef draw_img(patient_id, title=None):\n    dcm_file = '..\/input\/stage_2_train_images\/%s.dcm' % patient_id\n    dcm_data = pydicom.read_file(dcm_file)\n    plt.imshow(dcm_data.pixel_array)\n    if title is not None:\n        plt.title(title)","1f1b2ab9":"\npatients_greater_100 = patientInfo[patientInfo['patientAge']>=100]\npatients_less_5 = patientInfo[patientInfo['patientAge']<=5]\npatients_mid_age = patientInfo[(patientInfo['patientAge']>=30) & (patientInfo['patientAge']<= 50)]","e7d05638":"\ndef draw_grid(arr_patients, rows=5, columns=4, titles=None, figsize=(15, 15)):\n    fig=plt.figure(figsize=figsize)\n    for i in range(1, columns*rows + 1):\n        if(i <= len(arr_patients)):\n            fig.add_subplot(rows, columns, i)\n            if titles is None:\n                    draw_img(arr_patients[i - 1])\n            else:\n                    draw_img(arr_patients[i - 1], title=titles[i - 1])\n    plt.show()","c20f3c54":"draw_grid(patients_mid_age['patientId'].tolist())","ca638628":"draw_grid(patients_greater_100['patientId'].tolist(), 2, 2)","7e0c1660":"draw_grid(patients_less_5['patientId'].tolist())","8d4d2826":"patientInfo['age_category'] = (patientInfo['patientAge'] \/\/ 10) * 10","76e73920":"ax = sns.countplot(x=\"age_category\", hue=\"Target\", data=patientInfo)\nax.set_title('Disease per age category')\nax.legend(title='Disease')\nax.legend()","95f6a6db":"patientInfo['patientSex'].value_counts()","c346fd3d":"\ndraw_grid(patientInfo[patientInfo['patientSex'] == 'M']['patientId'].tolist(), 3, 3, \n          titles=patientInfo[patientInfo['patientSex'] == 'M']['patientAge'].tolist(), figsize=(15, 15))","a5cb9801":"\ndraw_grid(patientInfo[patientInfo['patientSex'] == 'F']['patientId'].tolist(), 3, 3, \n          titles=patientInfo[patientInfo['patientSex'] == 'F']['patientAge'].tolist(), figsize=(15, 15))","bf00d7cf":"\nax = sns.countplot(x=\"patientSex\", hue=\"Target\", data=patientInfo)\nax.set_title('Disease per gender')\nax.legend(title='Disease')\nax.legend()","bc898670":"\nz = {'F': 1, 'M': 0}\npatientInfo['Sex'] = patientInfo['patientSex'].map(z)","3f3d507d":"\nsns.pairplot(patientInfo[['Sex', 'age_category', 'Target']]);","8274b486":"corr = patientInfo.corr()\ncorr","3b68337a":"import seaborn as sns\n\n\nimport matplotlib.pyplot as plt\n\nf, ax = plt.subplots(figsize=(25, 25))\ncmap = sns.diverging_palette(220, 10, as_cmap=True)\nsns.heatmap(corr, cmap=cmap, vmax= .3,vmin = - 0.3, center=0,\n            square=True, linewidths=.5)","150bfc9c":"print(\"The number instances for the 0 class:: %i and for the 1 class = %i \" % (train_labels.Target.value_counts()[0], train_labels.Target.value_counts()[1]) )","3e711243":"train_ones = train_labels[train_labels.Target == 1]\ntrain_ones.head()","1d9d06ca":"print(\"The number of NaN values for bounding box dimentions columns for class 1 data = %s \" % train_ones.isna().sum() )","04e9d0d1":"\ntrain_labels.Target.value_counts()","6776eb04":"\ntrain_labels.iloc[110]","55a05a33":"\n\nprint('all images:', train_labels.shape[0])\nprint('unique images:', np.unique(train_labels.patientId.tolist()).shape[0])","76a09f69":"\ndef draw_mult_rects(patientIds, rows=3, cols=3, figsize=(15, 15)):\n    \n    fig=plt.figure(figsize=figsize)\n    \n    for i in range(1, len(patientIds)+1):\n        fig.add_subplot(rows, cols, i)\n        records = train_labels[train_labels.patientId == patientIds[i-1]]\n        class_label = patient_classes[patient_classes.patientId == patientIds[i-1]]['class'].tolist()[0]\n        dcm_file = '..\/input\/stage_2_train_images\/%s.dcm' % patientIds[i-1]\n        dcm_data = pydicom.read_file(dcm_file)\n        plt.imshow(dcm_data.pixel_array)\n        plt.title(class_label)\n        for j in range(records.shape[0]):\n            record = records.iloc[j]                \n            x = record.x\n            y = record.y\n            width = record.width\n            height = record.height\n            if x is not None:\n                rect = patches.Rectangle((x,y),width,height,linewidth=1,edgecolor='r',facecolor='none')\n                plt.gca().add_patch(rect)\n    plt.show()","4a69563d":"\ndraw_mult_rects(train_labels.patientId.unique()[:9])","f360ce96":"patientId = patientInfo.patientId\ntmp_cluster = patientInfo.drop(['patientId', \"Target\", 'patientSex', 'age_category'], axis = 1)\ntmp_cluster['patientAge'].max()","05672551":"from sklearn.cluster import KMeans\n\ndef kmeans(n, tmp_cluster) :\n    cluster = KMeans(n_clusters=n, max_iter=300, tol=0.0001, verbose=0, random_state = 0, n_jobs=-1).fit(tmp_cluster)\n    return cluster.labels_","9d0c1028":"import matplotlib.pyplot as plt\ntmp_cluster_Id = pd.DataFrame()\nrows = 0\nfor i in range(2,10):\n    columns = 3\n    tmp_cluster[\"clusters\"] = kmeans(i, tmp_cluster)\n    n, bins, patches = plt.hist(tmp_cluster[\"clusters\"], facecolor='b')\n    tmp_cluster_Id = tmp_cluster.copy()\n    tmp_cluster_Id[\"patientId\"] = patientId\n    pics = ((tmp_cluster_Id.drop_duplicates('clusters', keep = 'first'))['patientId']).tolist()\n    \n    if( len( pics ) >= 3) :\n        rows = (((len(pics) - 3) \/ 3) + (len(pics) - 3) % 3) + 1\n    else : \n        columns = 2\n        rows = 1\n    draw_grid(pics, columns = columns, rows = int(rows) )\n    plt.show()\n","85262d15":"import cv2\n\ndef remove_borders(img_data, threshold = 10):\n    img_data = img_data[:, np.max(img_data, axis=0) > threshold]\n    img_data = img_data[np.max(img_data, axis=1) > threshold]\n    img_data = cv2.resize(img_data, (1024, 1024))\n    return img_data","4a0cdf57":"def read_one_img(patientId):\n    dcm_file = '..\/input\/stage_2_train_images\/%s.dcm' % patientId\n    dcm_data = pydicom.read_file(dcm_file)\n    img = dcm_data.pixel_array\n    img = remove_borders(img)\n    img = cv2.resize(img, (224, 224))\n    return img","f6ede7b3":"figure=plt.figure(figsize=(15,15))\n\nfor (i, j) in enumerate(pics) :\n    image = read_one_img(j)\n    image_pixels = remove_borders(image)\n    figure.add_subplot(3, 3, i+1)\n    plt.imshow(image_pixels)\n    \nplt.show()","84f2471b":"**Exploring Age Feature**","83f0af39":"To be able to decide which performance metric we may use, We need to know the number of data examples in eachclass to see if the data is skewed or not. If the data is skewe ( one class has much more data examples than other classes ) then we can't use accuracy because it yeald misleading results but we may use Precision, Recall or F-beta score according to the situation we have.","89a1a7f5":"We will start by exploring the target classes we have in the dataset.","4436e55f":"# Age and Gender Exploration\nNow We will explore the age, gender and also the target classes. We will discover the data representation using histograms to see how the data looks like.","97194438":"<h1>EDA with Data Visualization and Augmentation<\/h1>\nIn this **tutorial** we are going to explore the dataset searching for hidden patterns using** statistical** and **manual** methodes.\nWe are also going to see how we can perform **Clustering** to cluster images based on the label data we have and also will perform some **data augmentation** to be able to classify the images efficiently.","863034c0":"# Drawing bounding boxes on images\nWe will draw the bounding boxes on the images to see how disease looks like in the radiation images .","498a68b9":"Input images are stored in DICOM format which stores description for every image in the dataset. Now let's see what we can benefit from this description.","9b33046d":"Now let's store all the destinct IDs into a dataframe for future usage.","41b300ba":"Before proceeding we need to know the number of target classes and its names.","51d8d040":"Most of the information doesn't seem to be useful except Age and Gender.","451efafa":"# Explore Gender\nWe will explore the images based on the ggender of the patient.\nFirst we need to see if the number of patients is the same for males and females.","d5a56dab":"It seems that data is not skewed so we will proceed with accuracy as the performance metric for the algorithm.\nNow let's try to see how our train_labels data looks like.","52277da3":"# Exploring Images \nWe will explore images from the dataset based on different age groups to see if there is a significant difference in the images to decide if we need further processing.","63bbe86b":"### Note : The data augmentation part is still in developpment since we can add many other things to it.","45a41d77":"Let's now explore the data we collected in the dataframe and search for missing values.","6c86053f":"I can see no difference between the images based on the gender of the patient only.","ab974f23":"Now we will try to see is there is a segnificant difference between the radiation images of males and females.","5fa2c786":"Plotting the histogram of clustered data and also viewing an image from each cluster to see what we can be gathered in each cluster.","9b4526db":"From the above example we see that for every label we have a patient ID, and bounding boxes coordinates which are nulls for class 0 and have values for class 1","e0182cdb":"We will explore the distinct age values in the dataset, Age greater than 90 years and also the frequency for each value using histgrams. Note: the oldest person on earth is 122 years old so any value more than this is probably an outlier.","5e74d90e":"We also have  to check if any label that is of the +ve class has Nulls in the bounding boxex data. Since only bounding boxes in the 0 class can have nulls since we will not draw anything.","801ed0d7":"Now let's try to explore the numbers in each class based on the gender.","84500aa5":"We will now extract the PatientAge and PatientSex fields in the DICOM description for every destince ID in a seperate array for each one and then convert this to a dataframe to be able to use it later.","72d7a8cd":"# Clustering\nWe have noticed a great difference in radiation images based on the Age and gender of the patient, So we will try to cluster images based on the differences in the features for each patient and examine the output histograms and draw an image for each cluster . We will explore the hestograms of each clustering procedure when changing the number of centroids of the clustering algorithm.","9cec8986":"It is very important to know the correlation between features and target variable to be able to decide if the feature is important to be used in the model or not. We will use correlation matrix and heat map to see this visually.","d35bdf57":"# Data Augmentation\nHere we will perform a very simple data augmentation. We will crop the edges of the images since we didn't need it. When trying this with our model it had significant effect on decreasing the variance.","eb5b380d":"Now we will see how the images look like after removing the boarders. I will show the same images as the above images to be able do see the differences."}}