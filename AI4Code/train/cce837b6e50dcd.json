{"cell_type":{"df97d85e":"code","8758a9d4":"code","52ab69a0":"code","fbd16e26":"code","4e1cc204":"code","9ade6293":"code","8929c981":"code","60c04ae4":"code","9581004a":"code","1d4d77ab":"code","ac60ca5d":"code","88422fa6":"code","a1fbc6e5":"code","f57340f2":"code","2ba581e0":"code","dd0026cb":"code","392c6e4c":"code","79af4038":"code","2e071359":"code","05920d4c":"code","bdc3d9ef":"code","ea271694":"code","162f0780":"code","47163852":"code","cd3c0caf":"code","6e10d4cc":"code","c17fdd32":"code","823d9db2":"code","6352fe48":"code","70053274":"code","9c271fd9":"code","69467025":"code","2e578f9e":"code","d14ef0e7":"markdown","bac6a58b":"markdown","23a80cf4":"markdown","aac2758b":"markdown","d928806b":"markdown","b1bdcd25":"markdown","60b376c1":"markdown","49051c87":"markdown"},"source":{"df97d85e":"import numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\ntrain = pd.read_csv(\"..\/input\/tabular-playground-series-apr-2021\/train.csv\")\ntest = pd.read_csv(\"..\/input\/tabular-playground-series-apr-2021\/test.csv\")\nsample = pd.read_csv(\"..\/input\/tabular-playground-series-apr-2021\/sample_submission.csv\")\nprint(train.shape, test.shape)","8758a9d4":"train.head()","52ab69a0":"test.head()","fbd16e26":"import matplotlib.pyplot as plt\nplt.style.use(\"seaborn-white\")\nimport seaborn as sns\n\ndummy = train.isnull().sum() \/ train.shape[0]\nsns.barplot(x = dummy.index, y = dummy.values)\nplt.xticks(rotation = 90)\nplt.show()","4e1cc204":"dummy = test.isnull().sum() \/ test.shape[0]\nsns.barplot(x = dummy.index, y = dummy.values)\nplt.xticks(rotation = 90)\nplt.show()","9ade6293":"train.isnull().sum()","8929c981":"def preprocess(train, test):\n    dummy = train[\"Age\"].median()\n    train[\"Age\"].fillna(dummy, inplace = True)\n    test[\"Age\"].fillna(dummy, inplace = True)\n    \n    dummy = train[\"Fare\"].median()\n    train[\"Fare\"].fillna(dummy, inplace = True)\n    test[\"Fare\"].fillna(dummy, inplace = True)\n    \n    dummy = train[\"Embarked\"].mode()[0]\n    train[\"Embarked\"].fillna(dummy, inplace = True)\n    test[\"Embarked\"].fillna(dummy, inplace = True)\n    return train, test\n\ntrain, test = preprocess(train, test)","60c04ae4":"train.isnull().sum()","9581004a":"test.isnull().sum()","1d4d77ab":"train[\"Name\"].values[:100]","ac60ca5d":"import re\nfrom wordcloud import WordCloud\n\ndef name_cloud(df):\n    word_text = []\n    for i in range(df.shape[0]):\n        word_text.append(re.sub(\",\", \"\", df[\"Name\"].values[i]))\n    word_text = \" \".join(word_text)\n    wordcloud = WordCloud(width = 800, height = 800, collocations = False).generate(word_text)\n    plt.figure(figsize = (8, 8))\n    plt.imshow(wordcloud)\n    plt.show()\nname_cloud(train)","88422fa6":"name_cloud(train.loc[train[\"Survived\"] == 0])","a1fbc6e5":"name_cloud(train.loc[train[\"Survived\"] == 1])","f57340f2":"train[\"first\"] = train[\"Name\"].apply(lambda x: x.split(\", \")[0])\ntrain[\"family\"] = train[\"Name\"].apply(lambda x: x.split(\", \")[1])\ntest[\"first\"] = test[\"Name\"].apply(lambda x: x.split(\", \")[0])\ntest[\"family\"] = test[\"Name\"].apply(lambda x: x.split(\", \")[1])\ntrain.head()","2ba581e0":"def clean(text):\n    text = text.upper()\n    text = re.sub(\" \", \"\", text)\n    text = re.sub(r\"\\.\", \"\", text)\n    text = re.sub(r\"\\\/\", \"\", text)\n    text = re.sub(r\"\\\\\", \"\", text)\n    return text\n\ntrain[\"Ticket\"] = train[\"Ticket\"].astype(str)\ntest[\"Ticket\"] = test[\"Ticket\"].astype(str)\ntrain[\"cleaned_ticket\"] = train[\"Ticket\"].apply(clean)\ntest[\"cleaned_ticket\"] = test[\"Ticket\"].apply(clean)","dd0026cb":"train[\"nan_ticket\"] = (train[\"cleaned_ticket\"] == \"NAN\").astype(int)\ntest[\"nan_ticket\"] = (test[\"cleaned_ticket\"] == \"NAN\").astype(int)\ntrain[\"ticket_feat\"] = train[\"cleaned_ticket\"].apply(lambda x: re.sub(\"[0-9]*\", \"\", x))\ntest[\"ticket_feat\"] = test[\"cleaned_ticket\"].apply(lambda x: re.sub(\"[0-9]*\", \"\", x))\ntrain.head()","392c6e4c":"def ticket_cloud(df):\n    word_text = []\n    for i in range(df.shape[0]):\n        text = re.sub(\"[0-9]*\", \"\", df[\"cleaned_ticket\"].values[i])\n        if text != \"\":\n            word_text.append(text)\n    word_text = \" \".join(word_text)\n    wordcloud = WordCloud(width = 800, height = 800, collocations = False).generate(word_text)\n    plt.figure(figsize = (8, 8), facecolor = None)\n    plt.imshow(wordcloud)\n    plt.show()\n    \nticket_cloud(train)","79af4038":"ticket_cloud(train.loc[train[\"Survived\"] == 0])","2e071359":"ticket_cloud(train.loc[train[\"Survived\"] == 1])","05920d4c":"train[\"Cabin\"].fillna(\"NAN\", inplace = True)\ntest[\"Cabin\"].fillna(\"NAN\", inplace = True)","bdc3d9ef":"def create_cabin_feat(cabin):\n    if cabin == \"NAN\":\n        return \"N\"\n    else:\n        return cabin[0]\ntrain[\"cabin_feat\"] = train[\"Cabin\"].apply(create_cabin_feat)\ntest[\"cabin_feat\"] = test[\"Cabin\"].apply(create_cabin_feat)","ea271694":"print(train[\"cabin_feat\"].unique())\nprint(test[\"cabin_feat\"].unique())","162f0780":"sns.countplot(x = train[\"cabin_feat\"], hue = train[\"Survived\"])\nplt.show()","47163852":"train.head()","cd3c0caf":"from sklearn.model_selection import StratifiedKFold\nkfold = StratifiedKFold(n_splits = 5)\nfold_dict = {}\nfor fold, (train_idx, valid_idx) in enumerate(kfold.split(train, train[\"Survived\"])):\n    fold_dict[fold] = (train_idx, valid_idx)","6e10d4cc":"from sklearn.preprocessing import LabelEncoder\nlbl = LabelEncoder()\nfor col in [\"Sex\", \"Embarked\", \"ticket_feat\", \"cabin_feat\"]:\n    lbl.fit(pd.concat([train, test])[col])\n    train[col] = lbl.transform(train[col])\n    test[col] = lbl.transform(test[col])\ntrain.head()","c17fdd32":"for col in [\"first\", \"family\"]:\n    tmp = train[col].value_counts().to_dict()\n    train[col] = train[col].map(tmp)\n    test[col] = test[col].map(tmp).fillna(0)\n    \ntrain[\"family_size\"] = train[\"SibSp\"] + train[\"Parch\"]\ntest[\"family_size\"] = test[\"SibSp\"] + test[\"Parch\"]\ntrain.head()","823d9db2":"use_cols = [\"Pclass\", \"Sex\", \"Age\", \"SibSp\", \"Parch\", \"Fare\", \"Embarked\", \"first\", \"family\", \"nan_ticket\", \"ticket_feat\", \"cabin_feat\", \"family_size\"]","6352fe48":"import lightgbm as lgb\nparams = {\n    \"objective\" : \"binary\",\n    \"metric\" : \"auc\",\n    \"verbosity\" : -1,\n    'num_leaves': 76,\n    'lambda_l1': 0.00018,\n    'lambda_l2': 0.0010,\n    'feature_fraction': 0.65,\n    'bagging_fraction': 0.56,\n    'min_child_samples': 29\n}\n\ndef training(params):\n    OOF = np.zeros(train.shape[0])\n    models = []\n    for fold in range(5):\n        train_idx = fold_dict[fold][0]\n        valid_idx = fold_dict[fold][1]\n        X_train = train.loc[train_idx, use_cols]\n        X_valid = train.loc[valid_idx, use_cols]\n        y_train = train.loc[train_idx, \"Survived\"]\n        y_valid = train.loc[valid_idx, \"Survived\"]\n        train_set = lgb.Dataset(X_train, y_train)\n        valid_set = lgb.Dataset(X_valid, y_valid)\n        model = lgb.train(\n            params = params, train_set = train_set, valid_sets = [train_set, valid_set],\n            num_boost_round = 100, early_stopping_rounds = 10, verbose_eval = 20\n        )\n        OOF[valid_idx] = model.predict(X_valid)\n        models.append(model)\n    return OOF, models\nOOF, models = training(params)","70053274":"from sklearn.metrics import accuracy_score\nacc = accuracy_score(y_true = train[\"Survived\"], y_pred = np.where(OOF > 0.5, 1, 0))\nprint(acc)","9c271fd9":"import optuna\n\ndef objective(trial):\n    tune_params = {\n        \"objectve\" : \"binary\",\n        \"metric\" : \"auc\",\n        \"verbosity\" : -1,\n        \"num_leaves\" : trial.suggest_int(\"num_leaves\", 2, 256),\n        \"lambda_l1\" : trial.suggest_loguniform(\"lambda_l1\", 1e-6, 1),\n        \"lambda_l2\" : trial.suggest_loguniform(\"lambda_l2\", 1e-6, 1),\n        \"feature_fraction\" : trial.suggest_uniform(\"feature_fraction\", 0.5, 1.0),\n        \"bagging_fraction\" : trial.suggest_uniform(\"bagging_fraction\", 0.5, 1.0),\n        \"min_child_samples\" : trial.suggest_int(\"min_child_samples\", 5, 100)\n    }\n    OOF, _ = training(tune_params)\n    acc = accuracy_score(y_true = train[\"Survived\"], y_pred = np.where(OOF > 0.5, 1, 0))\n    return acc\n\nTUNING = False\nif TUNING:\n    study = optuna.create_study(direction = \"maximize\")\n    study.optimize(objective, n_trials = 10)\n    print(\"=\" * 100)\n    print(study.best_params)","69467025":"preds = []\nfor model in models:\n    preds.append(model.predict(test[use_cols]))\npreds = np.mean(preds, axis = 0)\ntest[\"Survived\"] = np.where(preds > 0.5, 1, 0)\ntest[[\"PassengerId\", \"Survived\"]].to_csv(\"submission.csv\", index = False)","2e578f9e":"import shap\nshap.initjs()\nexplainer = shap.TreeExplainer(model = models[0])\nshap_values = explainer.shap_values(X = train[use_cols])\nshap.summary_plot(shap_values, train[use_cols])","d14ef0e7":"# Name","bac6a58b":"# PreProcess","23a80cf4":"# Ticket","aac2758b":"# MissingValue","d928806b":"# Loading","b1bdcd25":"# Model","60b376c1":"# Inference","49051c87":"# Cabin"}}