{"cell_type":{"63c6c021":"code","2a4d464d":"code","00cf03f7":"code","52976f46":"code","c276d6be":"code","37c81dd1":"code","f3d0a3b1":"code","95272988":"code","f809b4cd":"code","ea59fa09":"code","78050d7a":"code","e01f9c79":"code","24d44da4":"code","6c779ef0":"code","bfb7a53e":"code","2a02f87c":"code","425fc7a3":"code","17e87d66":"code","37410c67":"code","e180b899":"code","ebfa2fdd":"code","fa7543f6":"code","24eb5ef4":"code","04cf4d94":"markdown","a9372704":"markdown","8606acb0":"markdown","2d27bacd":"markdown","2300a583":"markdown","55c826eb":"markdown","d7f70d2c":"markdown","7288bcf8":"markdown","6a030e05":"markdown","38a8d84a":"markdown","dbe8022f":"markdown"},"source":{"63c6c021":"from google.cloud import bigquery\nimport plotly.express as px\nimport plotly.graph_objects as go\nimport pandas as pd","2a4d464d":"# Create a \"Client\" object\nclient = bigquery.Client()","00cf03f7":"# Reference to the dataset\ndataset_ref = client.dataset('london_crime', project='bigquery-public-data')\n\n# Fetch data\ndataset = client.get_dataset(dataset_ref)\n\n# List all the tables in the dataset\ntables = list(client.list_tables(dataset))\n\n# Print names of all tables in the dataset\nfor table in tables:  \n    print(table.table_id)","52976f46":"# Reference to the 'crime_by_lsoa' table\ntable_ref = dataset_ref.table('crime_by_lsoa')\n\n# Fetch the table\ntable = client.get_table(table_ref)\n\n# Dataset\nclient.list_rows(table, max_results=10).to_dataframe()","c276d6be":"# Total crimes by major category\nquery1 = \"\"\"\n\n    SELECT major_category, SUM(value) AS total_crimes\n                FROM `bigquery-public-data.london_crime.crime_by_lsoa`\n                WHERE year BETWEEN 2012 AND 2016\n                GROUP BY major_category\n                HAVING total_crimes > 0\n                ORDER BY total_crimes DESC\n        \"\"\"","37c81dd1":"# Execute query\ncrimes_by_major_category = client.query(query1).result().to_dataframe()","f3d0a3b1":"# Crimes by major category (%) chart\n\n# Create percentage column\nsum_of_crimes = crimes_by_major_category['total_crimes'].sum()\ncrimes_by_major_category['total_crimes%'] = (crimes_by_major_category['total_crimes']\/sum_of_crimes*100).round(1)\n\n# Barchart\nfig = px.bar(crimes_by_major_category, x ='major_category', y='total_crimes%',\n        labels={\n                 'major_category': 'Major category',\n                 'total_crimes%': 'Crimes (%)'\n                },\n         title='Total crimes by major category (%), 2012-2016')\nfig.show()","95272988":"# Crimes per month by major category\nquery2 = \"\"\"SELECT major_category, SUM(value) AS crimes_per_month, year, month\n                FROM `bigquery-public-data.london_crime.crime_by_lsoa`\n                WHERE (year BETWEEN 2009 AND 2016)\n                GROUP BY major_category, year, month\n                HAVING crimes_per_month > 0\n                ORDER BY major_category, year, month\n        \"\"\"","f809b4cd":"# Execute query\ncrime_by_month = client.query(query2).result().to_dataframe()","ea59fa09":"# Construct dates column\ncrime_by_month['date'] = crime_by_month.year.map(str) + '-' + crime_by_month.month.map(str)\ncrime_by_month['date'] = pd.to_datetime(crime_by_month.date, format='%Y-%m')\ndel crime_by_month['year'], crime_by_month['month']\n\n# Pivot\ncrime_by_month = crime_by_month.pivot_table(values='crimes_per_month',\n                                index='date',\n                                columns=['major_category'])","78050d7a":"# Line plots\nfig = px.line(crime_by_month, x=crime_by_month.index, y=list(crime_by_month), title='Major crime categories over time')\n\nfig.show()","e01f9c79":"# Average number of crimes per year for every borough\nquery3 = \"\"\"SELECT borough, cast(ROUND(SUM(value)\/5,0) as int64) AS average_crimes\n                FROM `bigquery-public-data.london_crime.crime_by_lsoa`\n                WHERE year BETWEEN 2012 AND 2016\n                GROUP BY borough\n                ORDER BY average_crimes DESC\n        \"\"\"","24d44da4":"# Execute query\naverage_crimes = client.query(query3).result().to_dataframe()","6c779ef0":"#Average number of crimes chart\nfig = px.bar(average_crimes, x='borough', y='average_crimes',\n        labels={\n                 'borough': 'Borough',\n                 'average_crimes': 'Average number of crimes per year'\n                },\n         title='Average number of crimes,  2012 - 2016')\nfig.show()","bfb7a53e":"# Top 3 most common minor categories for the top 5 boroughs as reported in section 3,\nquery4 = \"\"\"\n        WITH common_categories AS (\n             SELECT borough, minor_category, SUM(value) AS total_crimes,\n                 RANK() OVER (PARTITION BY borough ORDER BY SUM(value) DESC) \n                    AS rank_no\n             FROM `bigquery-public-data.london_crime.crime_by_lsoa`\n             WHERE year BETWEEN 2012 AND 2016\n             GROUP BY borough, minor_category\n        )\n                \n        SELECT borough, minor_category, rank_no, total_crimes\n            FROM common_categories\n            WHERE rank_no <= 3\n              AND borough IN ('Westminster','Lambeth','Southwark','Camden','Newham')\n            ORDER BY borough, rank_no\n        \"\"\"","2a02f87c":"# Execute query\ncommon_categories = client.query(query4).result().to_dataframe()","425fc7a3":"common_categories","17e87d66":"# 'Other theft' per month\nquery5 = \"\"\"SELECT minor_category, SUM(value) AS theft_per_month, year, month\n                FROM `bigquery-public-data.london_crime.crime_by_lsoa`\n                WHERE minor_category = 'Other Theft'\n                     AND (year BETWEEN 2009 AND 2016)\n                GROUP BY minor_category, year, month\n                ORDER BY year, month\n        \"\"\"","37410c67":"# Execute query\ntheft_per_month = client.query(query5).result().to_dataframe()","e180b899":"# Total crimes per month excluding 'Other theft'\nquery6 = \"\"\"SELECT SUM(value) AS other_categories, year, month\n                FROM `bigquery-public-data.london_crime.crime_by_lsoa`\n                WHERE year BETWEEN 2009 AND 2016\n                    AND minor_category != 'Other Theft'\n                GROUP BY year, month\n                ORDER BY year, month\n        \"\"\"","ebfa2fdd":"# Execute query\nother_categories = client.query(query6).result().to_dataframe()","fa7543f6":"# Construct dates column\ntheft_per_month['date'] = theft_per_month.year.map(str) + '-' + theft_per_month.month.map(str)\ntheft_per_month['date'] = pd.to_datetime(theft_per_month.date, format='%Y-%m')","24eb5ef4":"from plotly.subplots import make_subplots\n\n# Create figure with secondary y-axis\nfig = make_subplots(specs=[[{'secondary_y': True}]])\n\n# Add traces\nfig.add_trace(\n    go.Scatter(x=theft_per_month['date'], y=theft_per_month['theft_per_month'], name='Other theft'),\n    secondary_y=False,\n)\n\nfig.add_trace(\n    go.Scatter(x=theft_per_month['date'], y=other_categories['other_categories'], name='Other categories'),\n    secondary_y=True,\n)\n\n# Figure title\nfig.update_layout(\n    title_text=\"'Other theft' compared to other minor categories\"\n)\n\n# x-axis title\nfig.update_xaxes(title_text='Date')\n\n# y-axes titles\nfig.update_yaxes(title_text='Other theft', secondary_y=False)\nfig.update_yaxes(title_text='Other categories', secondary_y=True)\n\nfig.show()","04cf4d94":"Crimes related to theft seem to be the most common.","a9372704":"# 1. Total crimes by major category","8606acb0":"# 3. The average number of crimes per year in different boroughs","2d27bacd":"# 4. Most common minor categories in the boroughs with the highest criminality, 2012-2016","2300a583":"# 2. Major crime categories over time","55c826eb":"'Violence against the Person' rises notably after the end of 2013, whereas the other categories are relatively stable in the same period.","d7f70d2c":"Crime in London\n==============\n\n\n\n# Introduction\n\nThis dataset includes data related to the number of crimes in the different geographic areas of London. The analysis is mostly focused on the period from 2012 to 2016, but the evolution of crime rates from 2009 to 2016 is also provided. The data are divided into major and minor crime categories. The dataset is offered by BigQuery and more information is available [here](https:\/\/www.kaggle.com\/LondonDataStore\/london-crime).\n\n\nThis following analysis attempts to answer questions related to the following:\n* Which categories include the highest amount of crimes?\n* In which boroughs are the most crimes reported?\n* Did the crime rates increase or decrease over time? \n\n\n","7288bcf8":"The following section provides an insight into what forms of crime are the most common in the top 5 boroughs.","6a030e05":"'Other theft' peaked during 2012 and declined to the previous levels in the following years. The rest of the minor categories reached a minimum during 2014 but increased again in 2015-2016. As shown in section 2, violence against the person might have been related to this surge.","38a8d84a":"# 5. 'Other theft' compared to other minor categories","dbe8022f":"# BigQuery client"}}