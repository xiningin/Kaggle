{"cell_type":{"17f376c2":"code","c6017908":"code","e802deef":"code","6015c929":"code","0e7526fe":"code","74987936":"code","71a1a123":"code","985c4b73":"code","1c4e73e7":"code","aec97065":"code","60316af8":"code","f56dbb0a":"code","3e872b83":"code","3070dd2b":"code","a44fb655":"code","827ec8b9":"code","8b346b3c":"code","4b34da80":"code","9cf7bf98":"code","cf299f95":"code","388fd835":"markdown","6f74e21c":"markdown","af0ecfc0":"markdown","a6a30e96":"markdown","10f44c19":"markdown","91dc76be":"markdown","27d3b35a":"markdown","dbb18040":"markdown","be4beef5":"markdown","790d6b53":"markdown","09119aaa":"markdown","7bdbba75":"markdown","1c8e9f3c":"markdown","5a229052":"markdown","f812f832":"markdown","5a1ced5b":"markdown","03b1c598":"markdown","6d926b86":"markdown","51a5f43b":"markdown","041b6717":"markdown","fe6caa46":"markdown"},"source":{"17f376c2":"import gc\nimport dask\nimport dask.dataframe as dd\nimport warnings\nimport cufflinks\nimport numpy as np\nimport pandas as pd\nimport seaborn as sns\nimport matplotlib.pyplot as plt\nimport plotly.plotly as py\nimport plotly.graph_objs as go\nfrom plotly.offline import init_notebook_mode, iplot\n\ngc.enable()\n%matplotlib inline\nsns.set(style=\"whitegrid\")\nwarnings.filterwarnings(\"ignore\")\ncufflinks.go_offline(connected=True)\ninit_notebook_mode(connected=True)","c6017908":"dtypes = {\n        'MachineIdentifier':                                    'category',\n        'ProductName':                                          'category',\n        'EngineVersion':                                        'category',\n        'AvSigVersion':                                         'category',\n        'IsBeta':                                               'int8',\n        'RtpStateBitfield':                                     'float16',\n        'IsSxsPassiveMode':                                     'int8',\n        'AVProductsInstalled':                                  'float16',\n        'AVProductsEnabled':                                    'float16',\n        'HasTpm':                                               'int8',\n        'CountryIdentifier':                                    'int16',\n        'OrganizationIdentifier':                               'float16',\n        'GeoNameIdentifier':                                    'float16',\n        'LocaleEnglishNameIdentifier':                          'int8',\n        'Platform':                                             'category',\n        'Processor':                                            'category',\n        'OsVer':                                                'category',\n        'OsSuite':                                              'int16',\n        'OsPlatformSubRelease':                                 'category',\n        'SkuEdition':                                           'category',\n        'IsProtected':                                          'float16',\n        'AutoSampleOptIn':                                      'int8',\n        'SMode':                                                'float16',\n        'IeVerIdentifier':                                      'float16',\n        'SmartScreen':                                          'category',\n        'Firewall':                                             'float16',\n        'UacLuaenable':                                         'float32',\n        'Census_MDC2FormFactor':                                'category',\n        'Census_DeviceFamily':                                  'category',\n        'Census_ProcessorCoreCount':                            'float16',\n        'Census_ProcessorManufacturerIdentifier':               'float16',\n        'Census_PrimaryDiskTypeName':                           'category',\n        'Census_SystemVolumeTotalCapacity':                     'float32',\n        'Census_HasOpticalDiskDrive':                           'int8',\n        'Census_TotalPhysicalRAM':                              'float32',\n        'Census_ChassisTypeName':                               'category',\n        'Census_InternalPrimaryDiagonalDisplaySizeInInches':    'float16',\n        'Census_InternalPrimaryDisplayResolutionVertical':      'float16',\n        'Census_PowerPlatformRoleName':                         'category',\n        'Census_OSVersion':                                     'category',\n        'Census_OSArchitecture':                                'category',\n        'Census_OSBranch':                                      'category',\n        'Census_OSBuildRevision':                               'int32',\n        'Census_OSEdition':                                     'category',\n        'Census_OSSkuName':                                     'category',\n        'Census_OSInstallTypeName':                             'category',\n        'Census_OSInstallLanguageIdentifier':                   'float16',\n        'Census_OSUILocaleIdentifier':                          'int16',\n        'Census_OSWUAutoUpdateOptionsName':                     'category',\n        'Census_IsPortableOperatingSystem':                     'int8',\n        'Census_GenuineStateName':                              'category',\n        'Census_ActivationChannel':                             'category',\n        'Census_IsFlightsDisabled':                             'float16',\n        'Census_FlightRing':                                    'category',\n        'Census_IsSecureBootEnabled':                           'int8',\n        'Census_IsVirtualDevice':                               'float16',\n        'Census_IsTouchEnabled':                                'int8',\n        'Census_IsPenCapable':                                  'int8',\n        'Census_IsAlwaysOnAlwaysConnectedCapable':              'float16',\n        'Wdft_IsGamer':                                         'float16',\n        'Wdft_RegionIdentifier':                                'float16',\n        'HasDetections':                                        'int8'\n        }\n\nuse_columns = ['MachineIdentifier', 'ProductName', 'EngineVersion', 'AvSigVersion', 'IsBeta', 'RtpStateBitfield', 'IsSxsPassiveMode', 'AVProductsInstalled', \n               'AVProductsEnabled', 'HasTpm', 'CountryIdentifier', 'OrganizationIdentifier', 'GeoNameIdentifier', 'LocaleEnglishNameIdentifier', 'Platform', \n               'Processor', 'OsVer', 'OsSuite', 'OsPlatformSubRelease', 'SkuEdition', 'IsProtected', 'AutoSampleOptIn', 'SMode', 'IeVerIdentifier', \n               'SmartScreen', 'Firewall', 'UacLuaenable', 'Census_MDC2FormFactor', 'Census_DeviceFamily', 'Census_ProcessorCoreCount', 'Census_ProcessorManufacturerIdentifier', \n               'Census_PrimaryDiskTypeName', 'Census_SystemVolumeTotalCapacity', 'Census_HasOpticalDiskDrive', 'Census_TotalPhysicalRAM', 'Census_ChassisTypeName', \n               'Census_InternalPrimaryDiagonalDisplaySizeInInches', 'Census_InternalPrimaryDisplayResolutionVertical', 'Census_PowerPlatformRoleName', \n               'Census_OSVersion', 'Census_OSArchitecture', 'Census_OSBranch', 'Census_OSBuildRevision', 'Census_OSEdition', 'Census_OSSkuName', 'Census_OSInstallTypeName', \n               'Census_OSInstallLanguageIdentifier', 'Census_OSUILocaleIdentifier', 'Census_OSWUAutoUpdateOptionsName', 'Census_IsPortableOperatingSystem', \n               'Census_GenuineStateName', 'Census_ActivationChannel', 'Census_IsFlightsDisabled', 'Census_FlightRing', 'Census_IsSecureBootEnabled', \n               'Census_IsVirtualDevice', 'Census_IsTouchEnabled', 'Census_IsPenCapable', 'Census_IsAlwaysOnAlwaysConnectedCapable', 'Wdft_IsGamer', \n               'Wdft_RegionIdentifier']\n\nnumerics = ['int8', 'int16', 'int32', 'int64', 'float16', 'float32', 'float64']","e802deef":"train = dd.read_csv('..\/input\/microsoft-malware-prediction\/train.csv', dtype=dtypes, usecols=(use_columns + ['HasDetections'])).compute()\ntest = dd.read_csv('..\/input\/microsoft-malware-prediction\/test.csv', dtype=dtypes, usecols=use_columns).compute()","6015c929":"# Create statistics for train and test sets.\ndef dataset_stats(dataset):\n    stats = []\n    for col in dataset.columns:\n        if col != 'HasDetections':\n            n_unique = dataset[col].nunique()\n            col_type = dataset[col].dtype\n            if col_type in numerics:\n                col_type = 'Numerical'\n            if col_type == 'category':\n                col_type = 'Categorical'\n            if n_unique == 2:\n                col_type = 'Binary'\n            if n_unique == 1:\n                col_type = 'Constant'\n            stats.append((col, n_unique, col_type))\n\n    return pd.DataFrame(stats, columns=['Feature', 'Unique values', 'Type']).sort_values('Unique values', ascending=False)\n\ntrain_stats = dataset_stats(train)\ntest_stats = dataset_stats(test)","0e7526fe":"# Join statistics from train and test into a single dataframe.\njoin_stats = train_stats.copy()\njoin_stats.columns = ['Feature', 'Train Unique values', 'Train Type']\njoin_stats['Test Unique values'] = 0\njoin_stats['Test Type'] = '???'\n\nfor index, row in join_stats.iterrows():\n    for test_index, test_row in test_stats.iterrows():\n        if row['Feature'] == test_row['Feature']:\n            join_stats.loc[index, 'Test Unique values'] = test_row['Unique values']\n            join_stats.loc[index, 'Test Type'] = test_row['Type']\n\njoin_stats['% changed'] = (1 - (join_stats['Test Unique values'] \/ join_stats['Train Unique values'])) * 100\njoin_stats = join_stats[['Feature', 'Train Unique values', 'Test Unique values', '% changed', 'Train Type', 'Test Type']]\njoin_stats","74987936":"print('------Train------')\nprint(join_stats['Train Type'].value_counts())\nprint('------Test------')\nprint(join_stats['Test Type'].value_counts())","71a1a123":"cat_increase = join_stats[join_stats['% changed'] > 10]\ncat_decrease = join_stats[join_stats['% changed'] < -10]\ncat_change = cat_increase.append(cat_decrease).sort_values('% changed', ascending=False)\ndisplay(cat_change)\n\nf, ax = plt.subplots(figsize=(12, 6))\nax = sns.barplot(x=cat_change['Feature'].values, y=cat_change['% changed'].values, palette=\"rocket\")\nax.set_ylabel(\"Percentage\")\nplt.xticks(rotation=80)\nplt.show()","985c4b73":"del test_stats, join_stats, cat_increase, cat_decrease, test\ngc.collect()","1c4e73e7":"binary_features = list(train_stats[train_stats['Type'] == 'Binary']['Feature'])\nfor feature in binary_features:\n    if feature != 'HasDetections':\n        sns.catplot(x=feature, hue='HasDetections', data=train, kind='count', height=4)","aec97065":"numeric_features = ['Census_ProcessorCoreCount',\n                    'Census_SystemVolumeTotalCapacity',\n                    'Census_TotalPhysicalRAM',\n                    'Census_InternalPrimaryDiagonalDisplaySizeInInches',\n                    'Census_InternalPrimaryDisplayResolutionVertical',\n                    'AVProductsInstalled',\n                    'AVProductsEnabled',\n                    'RtpStateBitfield']\n\nfor feature in numeric_features:\n    trimmed_df = train[train[feature] < train[feature].quantile(0.95)]\n\n    f, (ax1, ax2) = plt.subplots(1, 2, figsize=(24, 4))\n    sns.boxplot(y=\"HasDetections\", x=feature, data=train, orient='h', ax=ax1).set_title(\"Complete set\", fontsize=18)\n    if len(trimmed_df) > 0:\n        sns.boxplot(y=\"HasDetections\", x=feature, data=trimmed_df, orient='h', ax=ax2).set_title(\"Values between 5 and 95 percentiles\", fontsize=18)\n    plt.show()","60316af8":"# Break plots in parts\nfifth_cols = len(numeric_features) \/\/ 4\ncols1 = list(numeric_features[:fifth_cols]) + ['HasDetections']\ncols2 = list(numeric_features[fifth_cols:fifth_cols*2]) + ['HasDetections']\ncols3 = list(numeric_features[fifth_cols*2:fifth_cols*3]) + ['HasDetections']\ncols4 = list(numeric_features[fifth_cols*3:]) + ['HasDetections']\n\nsns.set(style=\"ticks\")\nsns.set(font_scale=2)\nsns.pairplot(train[cols1], hue=\"HasDetections\", height=7)\nplt.show()","f56dbb0a":"sns.pairplot(train[cols2], hue=\"HasDetections\", height=7)\nplt.show()","3e872b83":"sns.pairplot(train[cols3], hue=\"HasDetections\", height=7)\nplt.show()","3070dd2b":"sns.pairplot(train[cols4], hue=\"HasDetections\", height=7)\nplt.show()","a44fb655":"corrs = train[numeric_features].corr()\nsns.set(font_scale=1)\nf, ax = plt.subplots(figsize=(10, 10))\nsns.heatmap(corrs, annot=True, linewidths=.5, fmt=\".2f\", ax=ax)\nplt.show()","827ec8b9":"test = dd.read_csv('..\/input\/microsoft-malware-prediction\/test.csv', dtype=dtypes, usecols=use_columns).compute()\n\n# IMPORT TIMESTAMP DICTIONARY\ndatedict = np.load('..\/input\/malware-timestamps\/AvSigVersionTimestamps.npy')\ndatedict = datedict[()]\n# ADD TIMESTAMPS\ntrain['Date'] = train['AvSigVersion'].map(datedict)\ntest['Date'] = test['AvSigVersion'].map(datedict)\n\ntrain.drop('AvSigVersion', axis=1, inplace=True)\ntest.drop('AvSigVersion', axis=1, inplace=True)\n\nprint('Train set shape', train.shape)\nprint('Test set shape', test.shape)\ntrain.head()","8b346b3c":"print('Train set min date', train['Date'].min().date())\nprint('Train set max date', train['Date'].max().date())\nprint('Test set min date ', test['Date'].min().date())\nprint('Test set max date ', test['Date'].max().date())","4b34da80":"train['Date'] = pd.to_datetime(train['Date'],).dt.strftime('%Y-%m')\ntest['Date'] = pd.to_datetime(test['Date'],).dt.strftime('%Y-%m')\n\ndf_train = train.groupby('Date', as_index=False)['MachineIdentifier'].count()\ndf_test = test.groupby('Date', as_index=False)['MachineIdentifier'].count()\ntrain_test = pd.merge(df_train, df_test, how='outer', on='Date', suffixes=('_train', '_test')).set_index('Date')\ntrain_test.fillna(0, inplace=True)\n\ntrain_test.iplot(kind='bar', xTitle='Date', yTitle='Count', title='Monthly machine count')","9cf7bf98":"df_train2 = train.groupby('Date', as_index=False)['HasDetections'].sum().set_index('Date')\ndf_train2.iplot(kind='bar', xTitle='Date', yTitle='Count', title='Monthly malware detection')","cf299f95":"n_train_unique_ids = train['MachineIdentifier'].nunique()\nn_test_unique_ids = test['MachineIdentifier'].nunique()\ntrain_unique_ids = set(train['MachineIdentifier'].unique())\ntest_unique_ids = set(test['MachineIdentifier'].unique())\ntrain_only_ids = list(train_unique_ids - test_unique_ids)\ntest_only_ids = list(test_unique_ids - train_unique_ids)\nboth_set_ids = list(train_unique_ids & test_unique_ids)\nids_df = pd.DataFrame([(len(train_only_ids), 'Train only ids'), (len(test_only_ids), 'Test only ids'), (len(both_set_ids), 'Both sets ids')], columns=['values', 'labels'])\n\nprint('IDs only in train set:', len(train_only_ids))\nprint('IDs only in test set:', len(test_only_ids))\nprint('IDs in both sets:', len(both_set_ids))\nids_df.iplot(kind='pie',labels='labels',values='values')","388fd835":"### Features cardinality evaluation\n* Let's see which features changes cardinality between train and test sets.\n\n### Features that have at least 10% more or less categories on the train set","6f74e21c":"It seems that the test set have a different max date than the train set, also most of the data the train and test sets are accumulated on the last 3 months, but train and test set have IDs across almost all years and months, it might be a good idea to leave the last 1 or 2 months from the train set as validation, and maybe add a few randomly distributed IDs to this validation set as well.","af0ecfc0":"Here \"Census_ProcessorCoreCount\" is interesting since it has most target 0 values on the beginning of the distribution.","a6a30e96":"\"AVProductsInstalled\" seems to be very useful, as you can see the target feature has a different distribution of it's values.","10f44c19":"### Machine IDs distribution by month","91dc76be":"## Train\/validation split EDA","27d3b35a":"### You can also find this on [GitHub here](https:\/\/github.com\/dimitreOliveira\/MachineLearning\/blob\/master\/Kaggle\/Microsoft%20Malware%20Prediction\/Malware%20Detection%20-%20Extended%20EDA.ipynb)\n### This is the second part of the EDA you can see the [first part here](https:\/\/www.kaggle.com\/dimitreoliveira\/malware-detection-eda-and-lgbm)\n* On the first part we saw that some features may not be useful for our models, so I won't use them on this analysis:\n    * Columns with more than 40% null values:  **PuaMode, Census_ProcessorClass, Census_InternalBatteryType, Census_IsFlightingInternal, Census_ThresholdOptIn, Census_IsWIMBootEnabled**.\n    * Columns with high cardinality:  **AvSigVersion, DefaultBrowsersIdentifier, AVProductStatesIdentifier, CityIdentifier, OsBuildLab, Census_OEMNameIdentifier, Census_OEMModelIdentifier, Census_ProcessorModelIdentifier, Census_FirmwareManufacturerIdentifier, Census_FirmwareVersionIdentifier**. I'll leave AvSigVersion in because I need it to the time-series analysis.\n    * Some features have a very similar distribution between labels: **AppVersion, OsBuild, Census_OSBuildNumber, Census_PrimaryDiskTotalCapacity, Census_InternalPrimaryDisplayResolutionHorizontal, Census_InternalBatteryNumberOfCharges**.\n    \n### Content\n* [Feature type EDA](#Feature-type-EDA)\n* [Binary features EDA](#Binary-features-EDA)\n* [Numerical features EDA](#Numerical-features-EDA)\n* [Train\/validation split EDA](#Train\/validation-split-EDA)","dbb18040":"### Label distribution by month","be4beef5":"Doesn't seems to be going anything really interesting with all the other distributions.\n\n### Correlation matrix","790d6b53":"### Scatter matrix\n* Things get a little difficult here since this kind of scatter plot isn't very useful with big data, but the distribution plots may help with the understanding.","09119aaa":"### Load data","7bdbba75":"<img src=\"https:\/\/raw.githubusercontent.com\/dimitreOliveira\/MachineLearning\/master\/Kaggle\/Microsoft%20Malware%20Prediction\/Microsoft_logo.png\" width=\"600\" height=\"170\">\n<h1><center>Microsoft Malware Prediction<\/center><\/h1>\n<h2><center>Extended EDA<\/center><\/h2>","1c8e9f3c":"### Unique IDs on data sets","5a229052":"## Feature type EDA","f812f832":"## Binary features EDA","5a1ced5b":"Some of the features have almost the same distribution on the label, then we should probably remove: **IsBeta, HasTpm, AutoSampleOptIn, SMode, Firewall, Census_HasOpticalDiskDrive, Census_IsPortableOperatingSystem, Census_IsFlightsDisabled, Census_IsSecureBootEnabled, Census_IsPenCapable**.","03b1c598":"Unfortunately doesn't seems to be any big correlation between the label and any variable, the greater correlation is with \"AVProductsInstalled\", makes sense since with more antivirus products less are the chances to be infected with a malware.\n\nSome feature may be a little redundant, like \"Census_TotalPhysicalRAM\" and \"Census_ProcessorCoreCount\", probably because if you have more RAM you may have a larger computer, so more cores as well.","6d926b86":"### Evaluating the dataset feature types, we should drop the constant features and have special care with features that changes type across the sets.\n#### PS: depending on the amount of rows loaded from train and test set cardinality and type of features might change.","51a5f43b":"Most of the malware detection are on the last months, this is no surprise as most of the data are also on those months.","041b6717":"There is no ID both on train and test set, this may make things easier as we don't need to care about ID distribution on train and validation sets.","fe6caa46":"## Numerical features EDA\n\n### Box plots\n* For each feature there are two plots for better visualization, one with all data, and other with only values between the 5 and 95 percentiles."}}