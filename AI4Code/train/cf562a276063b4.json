{"cell_type":{"ac40d4f5":"code","f4e7ce53":"code","3623b4c2":"code","c0709e6a":"code","729a2374":"code","1224e350":"code","17d142c1":"code","1cc410c8":"code","ea37df99":"code","e8c4ab62":"code","c6f9f53a":"code","f954f64b":"code","3c74a8a5":"code","4625c3b3":"code","33d3b249":"code","0f25f74c":"code","860bebd7":"code","651633de":"code","49517fec":"code","2ae3f806":"code","6e33050f":"code","ad5032be":"markdown","08f1ddf7":"markdown","252f3fe4":"markdown"},"source":{"ac40d4f5":"import numpy as np\nimport pandas as pd\nimport matplotlib.pyplot as plt\nimport seaborn as sns\n\nimport os, time, random, cv2, glob, pickle, librosa\nfrom pathlib import Path\nfrom PIL import Image\nimport imgaug as ia\nfrom imgaug import augmenters as iaa\nfrom tqdm import tqdm\n\nfrom keras.models import Model\nfrom keras.layers import (Convolution1D, Input, Dense, Flatten, Dropout, GlobalAveragePooling1D, concatenate,\n                          Activation, MaxPool1D, GlobalMaxPool1D, BatchNormalization, Concatenate, ReLU, LeakyReLU)\nfrom keras.callbacks import ModelCheckpoint, EarlyStopping, LearningRateScheduler\nfrom keras.optimizers import Adam, SGD, RMSprop\nfrom keras.losses import sparse_categorical_crossentropy\nfrom keras.utils.np_utils import to_categorical\nfrom sklearn.model_selection import train_test_split\nprint(os.listdir(\"..\/input\"))","f4e7ce53":"%matplotlib inline\npd.set_option('max_colwidth', 400)\nplt.rcParams['figure.figsize'] = [16, 10]\nplt.rcParams['font.size'] = 16\nt_start = time.time()\n\n# Keras reproduce score (then init all model seed)\n# seed_nb=14\n# import numpy as np \n# np.random.seed(seed_nb)\n# import tensorflow as tf\n# tf.set_random_seed(seed_nb)","3623b4c2":"input_length = 16000*2\n\nbatch_size = 32\n\ndef audio_norm(data):\n\n    max_data = np.max(data)\n    min_data = np.min(data)\n    data = (data-min_data)\/(max_data-min_data+0.0001)\n    return data-0.5\n\n\ndef load_audio_file(file_path, input_length=input_length):\n    data = librosa.core.load(file_path, sr=16000)[0] #, sr=16000\n    if len(data)>input_length:\n        max_offset = len(data)-input_length\n        offset = np.random.randint(max_offset)\n        data = data[offset:(input_length+offset)]\n        \n    else:\n        if input_length > len(data):\n            max_offset = input_length - len(data)\n            offset = np.random.randint(max_offset)\n        else:\n            offset = 0\n            \n        data = np.pad(data, (offset, input_length - len(data) - offset), \"constant\")\n        \n    data = audio_norm(data)\n    return data","c0709e6a":"train_files = glob.glob(\"..\/input\/train_curated\/*.wav\")\ntest_files = glob.glob(\"..\/input\/train_noisy\/*.wav\")\ntrain_labels = pd.read_csv(\"..\/input\/train_curated.csv\")","729a2374":"file_to_label = {\"..\/input\/train_curated\/\"+k:v for k,v in zip(train_labels.fname.values, train_labels.labels.values)}","1224e350":"data_base = load_audio_file(train_files[0])\nfig = plt.figure(figsize=(14, 8))\nplt.title('Raw wave : %s ' % (file_to_label[train_files[0]]))\nplt.ylabel('Amplitude')\nplt.plot(np.linspace(0, 1, input_length), data_base)\nplt.show();","17d142c1":"list_labels = sorted(list(set(train_labels.labels.values)))\nlabel_to_int = {k:v for v,k in enumerate(list_labels)}\nint_to_label = {v:k for k,v in label_to_int.items()}\nfile_to_int = {k:label_to_int[v] for k,v in file_to_label.items()}","1cc410c8":"def get_model():\n    nclass = len(list_labels)\n    inp = Input(shape=(input_length, 1))\n    img_1 = Convolution1D(16, kernel_size=9, activation=\"relu\", padding=\"valid\")(inp)\n    img_1 = Convolution1D(16, kernel_size=9, activation=\"relu\", padding=\"valid\")(img_1)\n    img_1 = MaxPool1D(pool_size=16)(img_1)\n    img_1 = Dropout(rate=0.1)(img_1)\n    img_1 = Convolution1D(32, kernel_size=3, activation=\"relu\", padding=\"valid\")(img_1)\n    img_1 = Convolution1D(32, kernel_size=3, activation=\"relu\", padding=\"valid\")(img_1)\n    img_1 = MaxPool1D(pool_size=4)(img_1)\n    img_1 = Dropout(rate=0.1)(img_1)\n    img_1 = Convolution1D(32, kernel_size=3, activation=\"relu\", padding=\"valid\")(img_1)\n    img_1 = Convolution1D(32, kernel_size=3, activation=\"relu\", padding=\"valid\")(img_1)\n    img_1 = MaxPool1D(pool_size=4)(img_1)\n    img_1 = Dropout(rate=0.1)(img_1)\n    img_1 = Convolution1D(256, kernel_size=3, activation=\"relu\", padding=\"valid\")(img_1)\n    img_1 = Convolution1D(256, kernel_size=3, activation=\"relu\", padding=\"valid\")(img_1)\n    img_1 = GlobalMaxPool1D()(img_1)\n    img_1 = Dropout(rate=0.2)(img_1)\n\n    dense_1 = Dense(64, activation=\"relu\")(img_1)\n    dense_1 = Dense(1028, activation=\"relu\")(dense_1)\n    dense_1 = Dense(nclass, activation=\"softmax\")(dense_1)\n\n    model = Model(inputs=inp, outputs=dense_1)\n\n    model.compile(optimizer=Adam(0.001), loss=sparse_categorical_crossentropy, metrics=['acc'])\n    model.summary()\n    return model","ea37df99":"def chunker(seq, size):\n    return (seq[pos:pos + size] for pos in range(0, len(seq), size))","e8c4ab62":"def train_generator(list_files, batch_size=batch_size):\n    while True:\n        random.shuffle(list_files)\n        for batch_files in chunker(list_files, size=batch_size):\n            batch_data = [load_audio_file(fpath) for fpath in batch_files]\n            batch_data = np.array(batch_data)[:,:,np.newaxis]\n            batch_labels = [file_to_int[fpath] for fpath in batch_files]\n            batch_labels = np.array(batch_labels)\n            \n            yield batch_data, batch_labels","c6f9f53a":"tr_files, val_files = train_test_split(train_files, test_size=0.1)","f954f64b":"model = get_model()","3c74a8a5":"model.fit_generator(train_generator(tr_files), \n                    steps_per_epoch=len(tr_files)\/\/batch_size, \n                    validation_data=train_generator(val_files),\n                    validation_steps=len(val_files)\/\/batch_size,\n                    epochs=1\n    )","4625c3b3":"model.save_weights(\"baseline_cnn.h5\")","33d3b249":"list_preds = []","0f25f74c":"for batch_files in tqdm(chunker(test_files, size=batch_size), total=len(test_files)\/\/batch_size ):\n    batch_data = [load_audio_file(fpath) for fpath in batch_files]\n    batch_data = np.array(batch_data)[:,:,np.newaxis]\n    preds = model.predict(batch_data).tolist()\n    list_preds += preds","860bebd7":"array_preds = np.array(list_preds)\nlist_labels = np.array(list_labels)\n\ntop_3 = list_labels[np.argsort(-array_preds, axis=1)[:, :3]]\npred_labels = [' '.join(list(x)) for x in top_3]","651633de":"df = pd.DataFrame(test_files, columns=[\"fname\"])\ndf['label'] = pred_labels","49517fec":"df['fname'] = df.fname.apply(lambda x: x.split(\"\/\")[-1])","2ae3f806":"df.to_csv(\"baseline.csv\", index=False)","6e33050f":"t_finish = time.time()\nprint(f\"Kernel run time = {(t_finish-t_start)\/3600} hours\")","ad5032be":"# || Data Preparation","08f1ddf7":"# || Configuration","252f3fe4":"based on : https:\/\/www.kaggle.com\/CVxTz\/keras-cnn-starter\n# || Loading Packages"}}