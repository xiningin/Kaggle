{"cell_type":{"d22a1261":"code","6c0eff3b":"code","d1d488a3":"code","bab2be60":"code","8115163c":"code","658d6c7a":"code","7589384d":"code","71a3259d":"code","6c113362":"code","e3532ca4":"code","ef04ffd7":"code","4ffbf659":"code","ff0714c1":"code","f5bc88a8":"code","161a949f":"code","5289ee6c":"code","1adb2ce6":"markdown","a2b4fa02":"markdown","b3f395a3":"markdown","45d90bfb":"markdown"},"source":{"d22a1261":"!pip install pycaret","6c0eff3b":"import gc\nimport numpy as np\nimport pandas as pd\nfrom tqdm import tqdm\nfrom sklearn.cluster import KMeans\nfrom sklearn.metrics import roc_auc_score\nfrom sklearn.preprocessing import QuantileTransformer\n\nfrom pycaret.classification import *","d1d488a3":"train_df = pd.read_csv(\"..\/input\/tabular-playground-series-sep-2021\/train.csv\")\ntrain_df.set_index('id', inplace=True)\nprint(f\"train_df: {train_df.shape}\")\ntrain_df.head()","bab2be60":"test_df = pd.read_csv(\"..\/input\/tabular-playground-series-sep-2021\/test.csv\")\ntest_df.set_index('id', inplace=True)\nprint(f\"test_df: {test_df.shape}\")\ntest_df.head()","8115163c":"features = test_df.columns.tolist()\n\ntrain_df['num_missing'] = train_df[features].isna().sum(axis=1)\ntrain_df['num_missing_std'] = train_df[features].isna().std(axis=1).astype('float')\ntrain_df['median'] = train_df[features].median(axis=1)\ntrain_df['std'] = train_df[features].std(axis=1)\ntrain_df['min'] = train_df[features].abs().min(axis=1)\ntrain_df['max'] = train_df[features].abs().max(axis=1)\ntrain_df['sem'] = train_df[features].sem(axis=1)\n\ntest_df['num_missing'] = test_df[features].isna().sum(axis=1)\ntest_df['num_missing_std'] = test_df[features].isna().std(axis=1).astype('float')\ntest_df['median'] = test_df[features].median(axis=1)\ntest_df['std'] = test_df[features].std(axis=1)\ntest_df['min'] = test_df[features].abs().min(axis=1)\ntest_df['max'] = test_df[features].abs().max(axis=1)\ntest_df['sem'] = test_df[features].sem(axis=1)\n\nprint(f\"train_df: {train_df.shape} \\ntest_df: {test_df.shape}\")\ntrain_df.head()","658d6c7a":"fill_value_dict = {\n    'f1': 'Mean', \n    'f2': 'Mean', \n    'f3': 'Mode', \n    'f4': 'Mode', \n    'f5': 'Mode', \n    'f6': 'Mean', \n    'f7': 'Mean', \n    'f8': 'Median', \n    'f9': 'Mode', \n    'f10': 'Mode', \n    'f11': 'Mode', \n    'f12': 'Median', \n    'f13': 'Mode', \n    'f14': 'Median', \n    'f15': 'Mean', \n    'f16': 'Median', \n    'f17': 'Mode', \n    'f18': 'Median', \n    'f19': 'Median', \n    'f20': 'Median', \n    'f21': 'Median', \n    'f22': 'Mean', \n    'f23': 'Mode', \n    'f24': 'Median', \n    'f25': 'Median', \n    'f26': 'Median', \n    'f27': 'Median', \n    'f28': 'Median', \n    'f29': 'Mean', \n    'f30': 'Median', \n    'f31': 'Mode', \n    'f32': 'Median', \n    'f33': 'Median', \n    'f34': 'Mean', \n    'f35': 'Median', \n    'f36': 'Median', \n    'f37': 'Median', \n    'f38': 'Mode', \n    'f39': 'Median', \n    'f40': 'Mean', \n    'f41': 'Median', \n    'f42': 'Mean', \n    'f43': 'Mode', \n    'f44': 'Median', \n    'f45': 'Median', \n    'f46': 'Mean', \n    'f47': 'Mean', \n    'f48': 'Median', \n    'f49': 'Mode', \n    'f50': 'Mean', \n    'f51': 'Median', \n    'f52': 'Median', \n    'f53': 'Median', \n    'f54': 'Median', \n    'f55': 'Mode', \n    'f56': 'Mean', \n    'f57': 'Mean', \n    'f58': 'Median', \n    'f59': 'Median', \n    'f60': 'Mode', \n    'f61': 'Mode', \n    'f62': 'Median', \n    'f63': 'Median', \n    'f64': 'Median', \n    'f65': 'Mean', \n    'f66': 'Mode', \n    'f67': 'Median', \n    'f68': 'Median', \n    'f69': 'Mode', \n    'f70': 'Mean', \n    'f71': 'Median', \n    'f72': 'Median', \n    'f73': 'Median', \n    'f74': 'Median', \n    'f75': 'Mean', \n    'f76': 'Mean', \n    'f77': 'Median', \n    'f78': 'Median', \n    'f79': 'Median', \n    'f80': 'Median', \n    'f81': 'Median', \n    'f82': 'Median', \n    'f83': 'Median', \n    'f84': 'Median', \n    'f85': 'Median', \n    'f86': 'Median', \n    'f87': 'Median', \n    'f88': 'Median', \n    'f89': 'Median', \n    'f90': 'Mean', \n    'f91': 'Mode', \n    'f92': 'Median', \n    'f93': 'Median', \n    'f94': 'Mode', \n    'f95': 'Median', \n    'f96': 'Median', \n    'f97': 'Mean', \n    'f98': 'Median', \n    'f99': 'Median', \n    'f100': 'Mean', \n    'f101': 'Median', \n    'f102': 'Median', \n    'f103': 'Median', \n    'f104': 'Median', \n    'f105': 'Mode', \n    'f106': 'Median', \n    'f107': 'Median', \n    'f108': 'Median', \n    'f109': 'Median', \n    'f110': 'Mode', \n    'f111': 'Median', \n    'f112': 'Median', \n    'f113': 'Median', \n    'f114': 'Median', \n    'f115': 'Mode', \n    'f116': 'Median', \n    'f117': 'Median', \n    'f118': 'Mean'\n}\n\n\nfor col in tqdm(features):\n    if fill_value_dict.get(col)=='Mean':\n        fill_value = train_df[col].mean()\n    elif fill_value_dict.get(col)=='Median':\n        fill_value = train_df[col].median()\n    elif fill_value_dict.get(col)=='Mode':\n        fill_value = train_df[col].mode().iloc[0]\n    \n    train_df[col].fillna(fill_value, inplace=True)\n    test_df[col].fillna(fill_value, inplace=True)\n\ntrain_df.head()","7589384d":"features = [col for col in train_df.columns if col not in ['num_missing','num_missing_std','claim']]\n\nfor col in tqdm(features):\n    transformer = QuantileTransformer(n_quantiles=3000, \n                                      random_state=42, \n                                      output_distribution=\"normal\")\n    \n    vec_len = len(train_df[col].values)\n    vec_len_test = len(test_df[col].values)\n\n    raw_vec = train_df[col].values.reshape(vec_len, 1)\n    test_vec = test_df[col].values.reshape(vec_len_test, 1)\n    transformer.fit(raw_vec)\n    \n    train_df[col] = transformer.transform(raw_vec).reshape(1, vec_len)[0]\n    test_df[col] = transformer.transform(test_vec).reshape(1, vec_len_test)[0]\n\nprint(f\"train_df: {train_df.shape} \\ntest_df: {test_df.shape}\")","71a3259d":"def kmeans_fet(train, test, features, n_clusters):\n    \n    train_ = train[features].copy()\n    test_ = test[features].copy()\n    data = pd.concat([train_, test_], axis=0)\n    \n    kmeans = KMeans(n_clusters=n_clusters, random_state=42).fit(data)\n    \n    train[f'clusters_k'] = kmeans.labels_[:train.shape[0]]\n    test[f'clusters_k'] = kmeans.labels_[train.shape[0]:]\n    return train, test","6c113362":"train_df, test_df = kmeans_fet(train_df, test_df, features, n_clusters=4)\n\nprint(train_df.shape, test_df.shape)","e3532ca4":"lf = setup(train_df, target = 'claim', train_size = 0.8, fold_strategy =  'stratifiedkfold', \n            fold_shuffle=True, use_gpu=True, n_jobs = -1, silent = True, session_id=42 )","ef04ffd7":"best4 = compare_models(fold = 5, sort = 'AUC', n_select = 3, include=['lightgbm','xgboost','catboost','lda','gbc','lr','nb','rf'])","4ffbf659":"blended = blend_models(estimator_list = best4, fold = 5, optimize = 'AUC')","ff0714c1":"final_blended = finalize_model(blended)","f5bc88a8":"prep_pipe = get_config(\"prep_pipe\") \nprep_pipe.steps.append(['trained_model', final_blended])\nprections = prep_pipe.predict_proba(test_df)","161a949f":"k = []\nfor row in prections:\n  k.append(row[1])","5289ee6c":"submit = pd.read_csv(\"..\/input\/tabular-playground-series-sep-2021\/sample_solution.csv\")\nsubmit['claim'] = k\nsubmit.to_csv(\"submission.csv\", index=False)\nsubmit.head(10)","1adb2ce6":"# Submission","a2b4fa02":"# Model","b3f395a3":"# Load Datasets","45d90bfb":"# Feature Engineering"}}