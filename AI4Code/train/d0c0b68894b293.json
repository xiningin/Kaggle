{"cell_type":{"78bc432d":"code","9ce9d4ad":"code","646b39ea":"code","d0bd73dd":"code","eed4ff89":"code","88c2cbc6":"code","aea44794":"code","814f2c4c":"code","90b1c267":"code","d4d721fe":"code","e9b5870a":"code","8968b4ee":"code","8338159c":"code","f7e7649b":"code","8923e7cd":"code","ff120ee4":"code","df7d473a":"code","5fa47ca7":"code","fcfb7be9":"code","b823c0b2":"code","cdb10309":"code","1fa3464e":"code","4827c2d7":"code","3e7ec6f6":"code","cfbda231":"code","3ede926c":"markdown","187c89e5":"markdown","733dec89":"markdown","14642f35":"markdown","564e5306":"markdown","8e7c6c1f":"markdown","a58b30dd":"markdown","6da75b1a":"markdown","6140de03":"markdown","d5038324":"markdown","653279b3":"markdown","ee5b1ad6":"markdown","fe03fc67":"markdown","900fdd72":"markdown","45e9dbec":"markdown","c170d84f":"markdown","eb1e204a":"markdown","4515e901":"markdown","79bd8b92":"markdown","555b3d85":"markdown","e9ec2b22":"markdown","f35d97ac":"markdown","2adab5bb":"markdown","f01317b4":"markdown","d3c1e6a5":"markdown","57c74fac":"markdown","51e2c60e":"markdown","1b61b541":"markdown","895bee25":"markdown","24723aa5":"markdown","f467f850":"markdown","a0ae82e8":"markdown","a6c84009":"markdown","9f09c59b":"markdown"},"source":{"78bc432d":"import numpy as np\nimport pandas as pd\nimport matplotlib.pyplot as plt","9ce9d4ad":"train = pd.read_csv('..\/input\/ventilator-pressure-prediction\/train.csv')","646b39ea":"BL = 80 #Each breath consists of 80 timestamps","d0bd73dd":"train_RC_20_10 = train[(train['R'] == 20) & (train['C'] == 10)]","eed4ff89":"pips = np.array([37,15,25,30,20,25,30,40,25,30,40,35,25,37,37,35,10,37,35,35])","88c2cbc6":"for i in range(20):\n    u_in  = train_RC_20_10['u_in']    [i*BL:i*BL+30].values\n    u_out = train_RC_20_10['u_out']   [i*BL:i*BL+30].values\n    p     = train_RC_20_10['pressure'][i*BL:i*BL+30].values\n\n    plt.plot(u_in\/2, label = 'u_in\/2')\n    plt.plot(p, label = 'pressure')\n    plt.axhline(pips[i], color = 'gray', ls = '--')\n    plt.axhline(0, color = 'gray', ls = '--')\n    plt.legend()\n    plt.show()","aea44794":"area            = np.zeros(20)\narea_to_pip_cross = np.zeros(20)\n\nfor i in range(20):\n    u_in  = train_RC_20_10['u_in']    [i*BL:i*BL+32].values\n    u_out = train_RC_20_10['u_out']   [i*BL:i*BL+32].values\n    p     = train_RC_20_10['pressure'][i*BL:i*BL+32].values\n\n    #position of the first zero u_in during the inhale\n    #(not counting the first timestep)\n    #(proxy for pressure crossing of PIP)\n    t_cross = 1 + np.argmax(u_in[1:]*(1-u_out[1:]) == 0)\n    \n    area_to_pip_cross[i] = sum(u_in[:t_cross])\n    area[i]              = sum(u_in)","814f2c4c":"plt.scatter(area, pips, label = 'area')\nplt.scatter(area_to_pip_cross, pips, marker = 'x', c = 'r', label = 'area to PIP crossing')\nplt.ylabel('PIP')\nplt.legend();","90b1c267":"print('Correlation of PIP and')\nprint(f'Area {np.corrcoef(area, pips)[0,1]:.2f}')\nprint(f'Area to PIP crossing {np.corrcoef(area_to_pip_cross, pips)[0,1]:.2f}')","d4d721fe":"area_to_pip_crossB = np.zeros(20)\nfor i in range(20):\n    u_in  = train_RC_20_10['u_in']    [i*BL:i*BL+32].values\n    u_out = train_RC_20_10['u_out']   [i*BL:i*BL+32].values\n    p     = train_RC_20_10['pressure'][i*BL:i*BL+32].values\n    \n    #position of the first zero u_in during the inhale\n    #(not counting the first timestep)\n    #(proxy for pressure crossing of PIP)\n    t_cross = 1 + np.argmax(u_in[1:]*(1-u_out[1:]) == 0)\n    \n    area_to_pip_crossB[i] = sum((pips[i] - p[:t_cross])*u_in[:t_cross])","e9b5870a":"plt.scatter(  area_to_pip_crossB, pips, label = 'pressure correction')\nplt.scatter(13*area_to_pip_cross, pips, marker = 'x', c = 'r', label = 'no pressure correction')\nplt.ylabel('PIP')\nplt.legend();","8968b4ee":"print('Correlation of PIP and the area to PIP crossing')\nprint(f'without pressure correction {np.corrcoef(area_to_pip_cross,  pips)[0,1]:.2f}')\nprint(f'with    pressure correction {np.corrcoef(area_to_pip_crossB, pips)[0,1]:.2f}')","8338159c":"alpha = 0.69\n\narea_to_pip_crossC = np.zeros(20)\nfor i in range(20):\n    u_in  = train_RC_20_10['u_in']    [i*BL:i*BL+32].values\n    u_out = train_RC_20_10['u_out']   [i*BL:i*BL+32].values\n    p     = train_RC_20_10['pressure'][i*BL:i*BL+32].values\n    \n    #position of the first zero u_in during the inhale\n    #(not counting the first timestep)\n    #(proxy for pressure crossing of PIP)\n    t_cross = 1 + np.argmax(u_in[1:]*(1-u_out[1:]) == 0)\n    \n    area_to_pip_crossC[i] = sum((pips[i] - p)*u_in**alpha)","f7e7649b":"print('Correlation of PIP and the area to PIP crossing with pressure correction')\nprint(f'alpha = 1.00: {np.corrcoef(area_to_pip_crossB, pips)[0,1]:.4f}')\nprint(f'alpha = 0.69: {np.corrcoef(area_to_pip_crossC, pips)[0,1]:.4f}')","8923e7cd":"plt.scatter(  area_to_pip_crossB, pips, label = 'alpha = 1')\nplt.scatter(3*area_to_pip_crossC, pips, marker = 'x', c = 'r', label = 'alpha = 0.69')\nplt.ylabel('PIP')\nplt.legend();","ff120ee4":"pips20 = np.array([30,30,37,16,9.5,25,40,20,25,25,22,25,35,35,37,20,25,20,15,35])","df7d473a":"for i in range(20, 40):\n    u_in  = train_RC_20_10['u_in']    [i*BL:i*BL+30].values\n    u_out = train_RC_20_10['u_out']   [i*BL:i*BL+30].values\n    p     = train_RC_20_10['pressure'][i*BL:i*BL+30].values\n\n    plt.plot(u_in\/2, label = 'u_in\/2')\n    plt.plot(p, label = 'pressure')\n    plt.axhline(pips20[i-20], color = 'gray', ls = '--')\n    plt.axhline(0, color = 'gray', ls = '--')\n    plt.legend()\n    plt.show()","5fa47ca7":"alpha20 = 0.69\n\narea_to_pip_crossC20 = np.zeros(20)\nfor i in range(20, 40):\n    u_in  = train_RC_20_10['u_in']    [i*BL:i*BL+32].values\n    u_out = train_RC_20_10['u_out']   [i*BL:i*BL+32].values\n    p     = train_RC_20_10['pressure'][i*BL:i*BL+32].values\n    \n    #position of the first zero u_in during the inhale\n    #(not counting the first timestep)\n    #(proxy for pressure crossing of PIP)\n    t_cross = 1 + np.argmax(u_in[1:]*(1-u_out[1:]) == 0)\n    \n    area_to_pip_crossC20[i-20] = sum((pips20[i-20] - p)*u_in**alpha20)","fcfb7be9":"plt.scatter(area_to_pip_crossC  , pips,  label = 'first 20 breaths')\nplt.scatter(area_to_pip_crossC20, pips20, marker = 'x', c = 'r', label = 'next 20 breaths')\nplt.ylabel('PIP')\nplt.legend();","b823c0b2":"print('Correlation of PIP and the area to PIP crossing with pressure correction')\nprint(f'first 20 breaths: {np.corrcoef(area_to_pip_crossC,   pips)[0,1]:.4f}')\nprint(f'next  20 breaths: {np.corrcoef(area_to_pip_crossC20, pips20)[0,1]:.4f}')","cdb10309":"print('Correlation of PIP and the area to PIP crossing with pressure correction')\nprint(f'first 20 breaths: {np.corrcoef(area_to_pip_crossC,   pips**2)[0,1]:.4f}')\nprint(f'next  20 breaths: {np.corrcoef(area_to_pip_crossC20, pips20**2)[0,1]:.4f}')","1fa3464e":"c1, c0 = np.polyfit(\n                np.concatenate((area_to_pip_crossC, area_to_pip_crossC20)), \n                np.concatenate((pips, pips20)), \n                1)\nprint(c0, c1)","4827c2d7":"num_breaths = len(train_RC_20_10)\npip_estimate = np.zeros(5000)\n\nfor i in range(5000):\n    u_in  = train_RC_20_10['u_in']    [i*BL:i*BL+32].values\n    p     = train_RC_20_10['pressure'][i*BL:i*BL+32].values\n    \n    #Equation A*PIP = B\n    A = 1 - c1 * np.sum(u_in**alpha)\n    B = c0 - c1 * np.sum(p * u_in**alpha)\n    \n    pip_estimate[i] = B\/A","3e7ec6f6":"print('Min: ', np.min(pip_estimate))\nprint('Max: ', np.max(pip_estimate))","cfbda231":"plt.hist(pip_estimate, np.arange(0,50,1));","3ede926c":"Looks much more linear now","187c89e5":"A super helpful response by [@PC Jimmy](https:\/\/www.kaggle.com\/pcjimmmy) in the [discussion about the peak airway pressure (PIP)](https:\/\/www.kaggle.com\/c\/ventilator-pressure-prediction\/discussion\/283827) made me look a bit more into the behavior of pressure knowing that the underlying controller is trying to reach some predetermined PIP. We have to keep in mind each breath has a different PIP (and potentially other parameters).\n\nWe only consider R = 20, C = 10.\n\nDuring our analysis we found that the following features might be useful:\n* Boolean variable denoting whether $u_{in}$ reaches zero anywhere before the inhale phase. This is an imperfect proxy for pressure overshooting PIP. Notice sometimes $u_{in} = 0$ at the first timestep, this should be discarded\n* Integral of $u_{in}$ up to the time of the first zero $u_{in}$. Should be a proxy for PIP, as the first zero in $u_{in}$ represent roughly the time when the pressure crosses PIP and the integral of $u_{in}$ roughly represents the amount of air injected\n* $u_{in}^{0.69}$ and its shifts, lags, cumulative sum, ...\n\nVersion 4: Checked the idea we might estimate PIP by a simple algebraic equation. Does not work.","733dec89":"Let's check on the next 20 breaths whether we confirm this behavior","14642f35":"# Introduction and findings","564e5306":"# Air inflow proportional to pressure difference relative to PIP","8e7c6c1f":"Again pretty tight relationship, though a bit more curved this time","a58b30dd":"For the first 20 breaths with R = 20, C = 10 we plot the first 30 values of pressure and u_in. We also show the value of PIP we estimated from the graph.","6da75b1a":"# Look into the first 20 breaths with R = 20, C = 10","6140de03":"This suggests we might play around with the idea of using $u_{in}^{0.69}$ as a feature, in addition to $u_{in}$. The same applies to shifts, lags, cumulative sum, ...","d5038324":"# Preliminaries","653279b3":"But the correlation is still pretty high","ee5b1ad6":"Here we check how well the integral idea from above works. We will use the PIP values from above as a target and sum u_in to either \n* the end of inhalation, which has been done in other notebooks\n* the first zero u_in (discarding the first timestep)\n\nWe ignore actual time differences as they are [mostly all the same](https:\/\/www.kaggle.com\/motloch\/ventilator-pressure-train-data-exploration\/notebook#Time-steps-in-individual-breaths). This can potentially be improved.","fe03fc67":"The previous model is a bit naive in that physically you would expect the air inflow (and thus change in pressure) to depend on the difference between the current pressure and PIP. We can thus improve our expectation to\n\n$PIP \\propto \\sum_{i = 1}^{t_{cross}} (PIP - p_i) u_{in,i}$\n\nLet's see how well this does.","900fdd72":"After plotting the pressure curves, we read off these values of PIP by eye","45e9dbec":"Based on the (EDA)[https:\/\/www.kaggle.com\/motloch\/ventilator-pressure-train-data-exploration#Pressure], for this combination of R, C the artificial lung often reaches the PIP","c170d84f":"It does not look so much better in here though the curve is a bit smoother..","eb1e204a":"We can actually get even better description by assuming nonlinear dependence on u_in. In principle, there should be a bigger difference between the valve closed and 20% opened than between the valve 80% opened and fully opened.\n\nWe model this with\n$PIP \\propto \\sum_{i = 1}^{t_{exhale}} (PIP - p_i) u_{in,i}^\\alpha$\n\nIt looks like integrating over the whole inhale phase works a bit better (note change in the upper bound).\n\nAfter some tweaking, $\\alpha = 0.69$ works best.","4515e901":"# Test integral of u_in to the PIP transition time","79bd8b92":"I will take this:","555b3d85":"# Nonlinear u_in","e9ec2b22":"The correlation is even better with PIP^2, because this removes the curvature seen above","f35d97ac":"The extremes are way off (because sometimes we get A close to zero)","2adab5bb":"This meant there was a hope that for the training breaths, $$PIP^2 \\approx c_0 + c_1 \\left(\\sum (PIP - p)u_{in}^\\alpha\\right)$$ could be used to solve for PIP (with c_0 and c_1 dependent on R and C).\n\nUnfortunately, this does not work as we sometimes get imaginary solutions.\n\nWe might still get something from\n$$PIP \\approx c_0 + c_1 \\left(\\sum (PIP - p)u_{in}^\\alpha\\right)$$\nthough.","f01317b4":"The majority of the predictions are sensible though","d3c1e6a5":"But the correlation goes up a notch","57c74fac":"Best fit values:","51e2c60e":"# Getting PIP for training set by solving an algebraic equation?","1b61b541":"Ok, so there are some differences, as expected. Looks like the area to PIP crossing (if PIP crossing present) has tighter spread. The correlation is a bit higher too:","895bee25":"The same integral as above","24723aa5":"# Next 20 breaths","f467f850":"Potential new features:\n* Does u_in reach zero anywhere before the inhale phase (when u_out = 0)? This is an imperfect proxy for pressure overcoming PIP. Notice sometimes u_in = 0 at the first timestep, this should be discarded\n* Integral of u_in up to the time of the first zero u_in. Should be a proxy for PIP, as the first zero in u_in represent roughly the time when the pressure crosses PIP and the integral of u_in roughly represents the amount of air injected","a0ae82e8":"Take aways:\n* In most of the cases pressure reached the PIP value, though in some cases there was not enough time to reach PIP\n* In many cases (though not always), zero u_in coincide with times when the pressure is above PIP. This makes sense - controller discovers too much pressure is in the lung and shuts off the valve. \n* When this happen, notice there is no delay. This goes against the \"two time units shift\" found for example in [notebook](https:\/\/www.kaggle.com\/luizflpe\/vpp-pressure-hysteresis-impact-of-r-feat-eng) . Looks like the u_in reaction to pressure overshoot is immediate.\n* In some cases shutting off the valve happens immediatelly and u_in goes to zero straight away, in others there is a long gradual decrease of u_in\n* We found PIP values (for example 40) inconsistent with the [preprint](https:\/\/arxiv.org\/pdf\/2102.06779.pdf) , although this can be just some overshoot that would have been corrected if given enough time","a6c84009":"Apply it to first 5000 breaths","9f09c59b":"How well do we predict PIP?"}}