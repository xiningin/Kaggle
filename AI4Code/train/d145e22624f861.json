{"cell_type":{"368ccf4c":"code","94fe621d":"code","d07fa203":"code","8960e9b7":"code","245a6e38":"code","4d4e08fb":"code","77ea8a1e":"code","227171ba":"code","649f276c":"code","04bdcd17":"code","c9f2d9d8":"code","cdbafc8f":"code","43762f61":"code","d743ab1d":"code","5af7ef0c":"code","72df00f8":"code","79ecc507":"code","dd9bfd24":"code","ba807d9e":"code","77580ed1":"markdown","f0e00bf9":"markdown","1d417edb":"markdown","d012fdb2":"markdown","c1b5e800":"markdown","e1d77aad":"markdown","d34b9f6b":"markdown","3799e429":"markdown","38aa00ec":"markdown","ec2e5b75":"markdown","3fec8a54":"markdown","5bf62b74":"markdown","10113344":"markdown","e4aa0d2e":"markdown","3f22414b":"markdown","9eda9e5b":"markdown","a4db3760":"markdown","ffe7815f":"markdown"},"source":{"368ccf4c":"import time\nimport pandas as pd\nimport numpy as np\nimport matplotlib.pyplot as plt\n%matplotlib inline\n\nimport statsmodels.api as sm\nfrom statsmodels.tsa.seasonal import seasonal_decompose\nfrom statsmodels.tsa.stattools import adfuller\n\npd.options.display.max_columns = 99\nplt.rcParams['figure.figsize'] = (12, 8)","94fe621d":"df_train = pd.read_csv('..\/input\/train.csv', parse_dates=['date'], index_col=['date'])\ndf_test = pd.read_csv('..\/input\/test.csv', parse_dates=['date'], index_col=['date'])\ndf_train.shape, df_test.shape","d07fa203":"df_train.head()","8960e9b7":"num_stores = len(df_train['store'].unique())\nfig, axes = plt.subplots(num_stores, figsize=(8, 16))\n\nfor s in df_train['store'].unique():\n    t = df_train.loc[df_train['store'] == s, 'sales'].resample('W').sum()\n    ax = t.plot(ax=axes[s-1])\n    ax.grid()\n    ax.set_xlabel('')\n    ax.set_ylabel('sales')\nfig.tight_layout();","245a6e38":"s1i1 = df_train.loc[(df_train['store'] == 1) & (df_train['item'] == 1)]\ns1i1.head()","4d4e08fb":"s1i1['sales'].plot();","77ea8a1e":"fig = seasonal_decompose(s1i1['sales'], model='additive', freq=365).plot()","227171ba":"dftest = adfuller(s1i1['sales'], autolag='AIC')\ndfoutput = pd.Series(dftest[0:4], index=['Test Statistic','p-value','#Lags Used','Number of Observations Used'])\nfor key,value in dftest[4].items():\n    dfoutput['Critical Value (%s)'%key] = value\ndfoutput","649f276c":"diff_7 = s1i1['sales'].diff(7)\ndiff_7.dropna(inplace=True)\nfig = seasonal_decompose(diff_7, model='additive', freq=365).plot()","04bdcd17":"dftest = adfuller(diff_7, autolag='AIC')\ndfoutput = pd.Series(dftest[0:4], index=['Test Statistic','p-value','#Lags Used','Number of Observations Used'])\nfor key,value in dftest[4].items():\n    dfoutput['Critical Value (%s)'%key] = value\ndfoutput","c9f2d9d8":"diff_1_7 = diff_7.diff(1)\ndiff_1_7.dropna(inplace=True)\nfig = seasonal_decompose(diff_1_7, model='additive', freq=365).plot()","cdbafc8f":"dftest = adfuller(diff_1_7, autolag='AIC')\ndfoutput = pd.Series(dftest[0:4], index=['Test Statistic','p-value','#Lags Used','Number of Observations Used'])\nfor key,value in dftest[4].items():\n    dfoutput['Critical Value (%s)'%key] = value\ndfoutput","43762f61":"fig, ax = plt.subplots(2)\nax[0] = sm.graphics.tsa.plot_acf(diff_1_7, lags=50, ax=ax[0])\nax[1] = sm.graphics.tsa.plot_pacf(diff_1_7, lags=50, ax=ax[1])","d743ab1d":"sarima = sm.tsa.statespace.SARIMAX(s1i1['sales'], trend='n', freq='D', enforce_invertibility=False,\n                                   order=(6, 1, 1), seasonal_order=(1, 1, 1, 7))\nresults = sarima.fit()\nprint(results.summary())","5af7ef0c":"s1i1['fcst'] = results.predict(start='2017-10-01', end='2017-12-31', dynamic=True)\ns1i1[['sales', 'fcst']].loc['2017-10-01':].plot();","72df00f8":"sarima_results = df_test.reset_index()\nsarima_results['sales'] = 0","79ecc507":"tic = time.time()\n\nfor s in sarima_results['store'].unique():\n    for i in sarima_results['item'].unique():\n        si = df_train.loc[(df_train['store'] == s) & (df_train['item'] == i), 'sales']\n        sarima = sm.tsa.statespace.SARIMAX(si, trend='n', freq='D', enforce_invertibility=False,\n                                           order=(6, 1, 1), seasonal_order=(1, 1, 1, 7))\n        results = sarima.fit()\n        fcst = results.predict(start='2017-12-31', end='2018-03-31', dynamic=True)\n        sarima_results.loc[(sarima_results['store'] == s) & (sarima_results['item'] == i), 'sales'] = fcst.values[1:]\n        \n        toc = time.time()\n        if i % 10 == 0:\n            print(\"Completed store {} item {}. Cumulative time: {:.1f}s\".format(s, i, toc-tic))","dd9bfd24":"sarima_results.drop(['date', 'store', 'item'], axis=1, inplace=True)\nsarima_results.head()","ba807d9e":"sarima_results.to_csv('sarima_results.csv', index=False)","77580ed1":"## Load Data","f0e00bf9":"All stores appear to show identical trends and seasonality; they just differ in scale.","1d417edb":"From the ACF, one non-seasonal MA term looks sensible. From the PACF, six non-seasonal AR terms looks sensible.\n\nFrom the ACF, one seasonal MA term looks sensible. From the PACF, we could use multiple seasonal AR terms, but will use one to keep the training time reasonable.","d012fdb2":"### Time Series Decomposition\n\nDecompose the example time series into trend, seasonal, and residual components.\n","c1b5e800":"### Plot ACF and PACF\n\nThe <a href=\"https:\/\/en.wikipedia.org\/wiki\/Autocorrelation\">Autocorrelation Function<\/a> (ACF) is the correlation of a signal with a delayed copy of itself as a function of delay.\n\nThe <a href=\"https:\/\/en.wikipedia.org\/wiki\/Partial_autocorrelation_function\">Partial Autocorrelation Function<\/a> (PACF) is the partial correlation of a signal with a delayed copy of itself, controlling for the values of the time series at all shorter delays, as a function of delay.\n\nUsing the ACF and PACF, and some <a href=\"http:\/\/people.duke.edu\/~rnau\/arimrule.htm\">simple heuristics<\/a>, the approriate Autoregression (AR) and Moving Average (MA) values can be identified for the SARIMA model. These are explained below.","e1d77aad":"## Make Predictions","d34b9f6b":"# Store Item Demand Forecasting Challenge","3799e429":"### Apply a seasonal difference\n\nWe should start by seeing if we can remove the trend by taking a seasonal difference.","38aa00ec":"Clearly the trend has now been eliminated.","ec2e5b75":"The Dickey-Fuller test p-value is lower than I would have expected, but the time series is not considered stationary using a 1% Critical Value and we can see visually that there is an upwards trend.","3fec8a54":"## Seasonal Autoregressive Integrated Moving Average (SARIMA)\n\n<a href=\"https:\/\/www.kaggle.com\/c\/demand-forecasting-kernels-only\">Link to competition on Kaggle.<\/a>\n\nSARIMA is a variant on the <a href=\"https:\/\/en.wikipedia.org\/wiki\/Autoregressive_integrated_moving_average\">ARIMA<\/a> model for datasets with a suspected seasonal effect.","5bf62b74":"### Example store and item","10113344":"### Take first differences","e4aa0d2e":"#### Example forecast","3f22414b":"### Build Model\n\nFrom the above analysis, we have identified the following parameters for our seasonal ARIMA(p,d,q)(P,D,Q)m model:\n- <b>p<\/b>: 6\n- <b>d<\/b>: 1\n- <b>q<\/b>: 1\n- <b>P<\/b>: 1\n- <b>D<\/b>: 1\n- <b>Q<\/b>: 1\n- <b>m<\/b>: 7","9eda9e5b":"## SARIMA\n\nWe will build a SARIMA model for a single store and item, and then retrain it and generate predictions for all time series in the dataset.","a4db3760":"The Dickey-Fuller test suggests that the trend has been removed, although we can still see visually that there appears to be a trend. We can try and eliminate this by applying a further first difference.","ffe7815f":"There is clearly yearly seasonality and a non-stationary, upward trend. We can run a Dickey-Fuller test to examine the stationarity."}}