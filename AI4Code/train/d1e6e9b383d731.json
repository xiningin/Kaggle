{"cell_type":{"037ae36a":"code","4947028d":"code","3ceb2009":"code","74b59e8e":"code","16411c2e":"code","31dbbe09":"code","4a1137ae":"code","cb11ec03":"code","6660846b":"code","6a7dc8fd":"code","e5e21f5e":"code","17922144":"code","fab3feb1":"markdown","988e0992":"markdown","6a208045":"markdown","32c167fa":"markdown","48367d5a":"markdown","f112862c":"markdown","74053b01":"markdown","616cd1b7":"markdown","a8106060":"markdown"},"source":{"037ae36a":"from sklearn.preprocessing import MultiLabelBinarizer\nfrom sklearn.model_selection import StratifiedKFold\nfrom tqdm.notebook import tqdm\nimport matplotlib.pyplot as plt\nimport tensorflow as tf\nimport albumentations\nimport pandas as pd\nimport numpy as np\nimport shutil\nimport os","4947028d":"#load data\ndf = pd.read_csv('..\/input\/plant-pathology-2021-fgvc8\/train.csv', index_col='image')\n#nh\u00e3n b\u1eb1ng ch\u1eef ban \u0111\u1ea7u c\u1ee7a t\u1eebng m\u1eabu\nlabels = df.labels.values.copy()\ndf","3ceb2009":"\nlabel_unique = df.labels.unique()\nprint(label_unique)","74b59e8e":"df.value_counts()\n\n\n","16411c2e":"#format train data\ntrain_Y = df['labels'].values.copy() \n# nh\u00ecn v\u00e0o d\u1eef li\u1ec7u ta th\u1ea5y r\u1eb1ng 1 m\u1eabu d\u1eef li\u1ec7u c\u00f3 th\u1ec3 c\u00f3 nhi\u1ec1u nh\u00e3n, v\u1eady \u0111\u00e2y l\u00e0 b\u00e0i to\u00e1n \u0111a nh\u00e3n\ndf['labels'] = [x.split(' ') for x in df['labels']] \nclasses = ['complex', 'frog_eye_leaf_spot', 'powdery_mildew', 'rust', 'scab', 'healthy']\nscores = MultiLabelBinarizer(classes=classes).fit_transform(df['labels'].values)\ndf = pd.DataFrame(columns=classes, data=scores, index=df.index)\n# df.to_csv('train.csv')\ndf.head()","31dbbe09":"x = [df[x].sum() for x in classes]\nprint(x)\ny = classes\n","4a1137ae":"plt.style.use('bmh')\nplt.xticks(fontsize =12)\nplt.yticks(fontsize =12)\nplt.xlabel('Category',fontsize =13)\nplt.ylabel('Quantity of Image',fontsize = 13)\nplt.xticks(rotation=50)\ncolor_list = ['#f8a709', '#FF6565', '#2CC9FB', '#37DE5B', '#FF74E9', '#2C99FE']\nplt.bar(y,x, color = color_list,width=0.6)\n\nplt.show()\nprint(\"S\u1ed1 m\u1eabu d\u1eef li\u1ec7u: \", len(df))","cb11ec03":"from sklearn.model_selection import KFold\nkfold = KFold(n_splits=5, shuffle=True, random_state = 42)\nfold_ids = np.zeros(len(df))\nfor i, (train_ids, val_ids) in enumerate(kfold.split(df.index, labels)):\n    fold_ids[val_ids] = i\n\nvalue_counts = lambda x: pd.Series.value_counts(x, normalize=True)\ndf_five_folds = pd.DataFrame({\n    'origin_data': df.apply(value_counts).loc[1],\n    'fold_0': df[fold_ids == 0].apply(value_counts).loc[1],\n    'fold_1': df[fold_ids == 1].apply(value_counts).loc[1],\n    'fold_2': df[fold_ids == 2].apply(value_counts).loc[1],\n    'fold_3': df[fold_ids == 3].apply(value_counts).loc[1],\n    'fold_4': df[fold_ids == 4].apply(value_counts).loc[1]})\n\nbar = df_five_folds.plot.bar(figsize=[10, 10], colormap='Spectral', rot=50)\n\nfolds = pd.DataFrame({\n    'image': df.index,\n    'fold': fold_ids})\n\nfolds.to_csv('folds.csv', index=False)","6660846b":"from sklearn.model_selection import StratifiedKFold\nkfold = StratifiedKFold(n_splits=5, shuffle=True, random_state = 42)\nfold_ids = np.zeros(len(df))\nfor i, (train_ids, val_ids) in enumerate(kfold.split(df.index, labels)):\n    fold_ids[val_ids] = i\n\nvalue_counts = lambda x: pd.Series.value_counts(x, normalize=True)\ndf_five_folds = pd.DataFrame({\n    'origin_data': df.apply(value_counts).loc[1],\n    'fold_0': df[fold_ids == 0].apply(value_counts).loc[1],\n    'fold_1': df[fold_ids == 1].apply(value_counts).loc[1],\n    'fold_2': df[fold_ids == 2].apply(value_counts).loc[1],\n    'fold_3': df[fold_ids == 3].apply(value_counts).loc[1],\n    'fold_4': df[fold_ids == 4].apply(value_counts).loc[1]})\n\nbar = df_five_folds.plot.bar(figsize=[10, 10], colormap='Spectral', rot=50)\n\nfolds = pd.DataFrame({\n    'image': df.index,\n    'fold': fold_ids})\n\nfolds.to_csv('folds.csv', index=False)","6a7dc8fd":"root = '..\/input\/plant-pathology-2021-fgvc8\/train_images'\nclasses = [\n        'complex', \n        'frog_eye_leaf_spot', \n        'powdery_mildew', \n        'rust', \n        'scab',\n        'healthy']\nstrategy = tf.distribute.get_strategy()\nbatch_size = 16\n#k\u00edch th\u01b0\u1edbc m\u1ed7i \u1ea3nh   \nimg_size = 512\n#s\u1ed1 fold \u0111\u00e3 chia\nfolds = 5 \n#s\u1ed1 file .tfrec trong m\u1ed7i fold\nsubfolds = 16 \n    ","e5e21f5e":"#tu\u1ea7n t\u1ef1 h\u00f3a h\u00ecnh \u1ea3nh\ndef _serialize_image(path, transform=None):\n    image = tf.io.read_file(path)\n    image = tf.image.decode_jpeg(image, channels=3)\n    image = tf.image.resize(image, [img_size, img_size])\n    image = tf.cast(image, tf.uint8)\n    \n    if transform is not None:\n        image = transform(image=image.numpy())['image']\n        \n    return tf.image.encode_jpeg(image).numpy()\n\n#tu\u1ea7n t\u1ef1 h\u00f3a c\u00e1c m\u1eabu d\u1eef li\u1ec7u\ndef _serialize_sample(image, image_name, label):\n    feature = {\n        'image': tf.train.Feature(bytes_list=tf.train.BytesList(value=[image])),\n        'image_name': tf.train.Feature(bytes_list=tf.train.BytesList(value=[image_name])),\n        'complex': tf.train.Feature(int64_list=tf.train.Int64List(value=[label[0]])),\n        'frog_eye_leaf_spot': tf.train.Feature(int64_list=tf.train.Int64List(value=[label[1]])),\n        'powdery_mildew': tf.train.Feature(int64_list=tf.train.Int64List(value=[label[2]])),\n        'rust': tf.train.Feature(int64_list=tf.train.Int64List(value=[label[3]])),\n        'scab': tf.train.Feature(int64_list=tf.train.Int64List(value=[label[4]])),\n        'healthy': tf.train.Feature(int64_list=tf.train.Int64List(value=[label[5]]))}\n    sample = tf.train.Example(features=tf.train.Features(feature=feature))\n    return sample.SerializeToString()\n\n#tu\u1ea7n t\u1ef1 h\u00f3a c\u00e1c fold\ndef serialize_fold(fold, name, transform=None, bar=None):\n    samples = []\n    \n    for image_name, labels in fold.iterrows():\n        path = os.path.join(root, image_name)\n        image = _serialize_image(path, transform=transform)\n        samples.append(_serialize_sample(image, image_name.encode(), labels))\n    \n    with tf.io.TFRecordWriter(name + '.tfrec') as writer:\n        [writer.write(x) for x in samples]\n        \n    if bar is not None:\n        bar.update(1)","17922144":"total = folds * subfolds\n\nwith tqdm(total=total) as bar:\n\n    for i in range(folds):\n\n        df_fold = df[fold_ids == i]\n        \n        folder = f'fold_{i}'\n        \n        try:\n            os.mkdir(folder)\n        except FileExistsError:\n            shutil.rmtree(folder)\n            os.mkdir(folder)\n        \n        for k, subfold in enumerate(np.array_split(df_fold, subfolds)):\n            name=os.path.join(folder, '%.2i-%.3i' % (k, len(subfold)))\n            serialize_fold(subfold, name=name, bar=bar)\n       ","fab3feb1":"run test","988e0992":"Ta nh\u1eadn th\u1ea5y r\u1eb1ng tuy \u0111\u00e2y l\u00e0 b\u00e0i to\u00e1n \u0111a nh\u00e3n nh\u01b0ng nh\u00ecn v\u00e0o th\u1ef1c t\u1ebf nh\u1eefng m\u1eabu \u0111\u00e3 \u0111\u01b0\u1ee3c g\u00e1n nh\u00e3n heathy r\u1ed3i th\u00ec s\u1ebd kh\u00f4ng g\u00e1n \u0111\u01b0\u1ee3c nh\u1eefng nh\u00e3n kh\u00e1c, v\u1eady ta s\u1ebd x\u00e2y d\u1ef1ng model cho 5 nh\u00e3n:complex, frog_eye_leaf_spot,  powdery_mildew,  rust,  scab. M\u1eabu d\u1eef li\u1ec7u kh\u00f4ng \u0111\u01b0\u1ee3c g\u00e1n nh\u00e3n n\u00e0o trong 5 nh\u00e3n tr\u00ean s\u1ebd \u0111c g\u00e1n l\u00e0 healthy\n","6a208045":"> **\u0110\u1ecbnh ngh\u0129a m\u1ed9t s\u1ed1 h\u00e0m**","32c167fa":"Khi s\u1eed d\u1ee5ng KFold ta th\u1ea5y ph\u00e2n b\u1ed1 nh\u00e3n trong c\u00e1c fold so v\u1edbi ph\u00e2n b\u1ed1 nh\u00e3n trong d\u1eef li\u1ec7u train ban \u0111\u1ea7u b\u1ecb l\u1ec7ch nhau. V\u1edbi StratifiedKFold ta s\u1ebd thu \u0111\u01b0\u1ee3c t\u1ec9 l\u1ec7 n\u00e0y c\u00e2n b\u1eb1ng h\u01a1n kh\u00e1 nhi\u1ec1u. V\u1edbi ph\u01b0\u01a1ng ph\u00e1p n\u00e0y th\u00ec n\u00f3 s\u1ebd ch\u1ec9 shuffle d\u1eef li\u1ec7u m\u1ed9t l\u1ea7n \u0111\u1ea7u ti\u00ean tr\u01b0\u1edbc khi b\u1eaft \u0111\u1ea7u chia fold v\u00e0 n\u00f3 s\u1ebd c\u1ed1 g\u1eafng chia sao cho t\u1ef7 l\u1ec7 c\u00e1c class trong c\u00e1c fold l\u00e0 t\u01b0\u01a1ng \u0111\u1ed3ng nhau.","48367d5a":"# 2. Chia fold ","f112862c":"Nh\u00ecn v\u00e0o bi\u1ec3u \u0111\u1ed3 tr\u00ean, ta th\u1ea5y r\u1eb1ng c\u00f3 m\u1ed9t s\u1ed1 l\u1edbp kh\u00e1 \u00edt d\u1eef li\u1ec7u, n\u00ean khi chia d\u1eef li\u1ec7u d\u1ec5 b\u1ecb miss n\u00ean ta d\u00f9ng 5-fold cross validation ","74053b01":"# 3. T\u1ea1o file tfrecords\n","616cd1b7":"**Kh\u1edfi t\u1ea1o m\u1ed9t s\u1ed1 tham s\u1ed1**","a8106060":"# 1. Ph\u00e2n t\u00edch d\u1eef li\u1ec7u "}}