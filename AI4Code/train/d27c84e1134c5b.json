{"cell_type":{"4b02a388":"code","28b669ae":"code","e848a4c6":"code","1996492e":"code","b6217016":"code","62b1e860":"code","f057660d":"code","8637f211":"code","9c794bfc":"code","fcc3a8e4":"code","f49f6f89":"code","c4378092":"code","ea8c3cc6":"code","da660963":"code","ba67a3a2":"markdown","4e607849":"markdown","fd6ab0d7":"markdown","2e599b08":"markdown","e5e8d6d2":"markdown","77fd9b37":"markdown","2f80100a":"markdown","c7a3582d":"markdown","082727ba":"markdown","e854084b":"markdown","91804b86":"markdown","152532e8":"markdown","b2630e7f":"markdown","4e415914":"markdown","b12c336c":"markdown"},"source":{"4b02a388":"!pip install -U -q timm\n!pip install -U -q fastai","28b669ae":"from timm import create_model\nfrom fastai.vision.all import *","e848a4c6":"from dataclasses import dataclass\n\n@dataclass\nclass config:\n    seed = 42\n    \n    # training\n    lr = 5e-2\n    epochs = 7\n    freeze_epochs = 3\n    arch = 'resnet200d_320'\n    \n    # data\n    bs = 16\n    fold = 2\n    img_size = 456\n    pre_img_size = 512","1996492e":"set_seed(config.seed)","b6217016":"path = Path('..\/input\/ranzcr-clip-catheter-line-classification')\nresized_path = Path('..\/input\/rancer-resized-dataset\/img_sz_512')\nfolds_path = Path('..\/input\/ranzcr-folds')","62b1e860":"targets = [\"ETT - Abnormal\", \"ETT - Borderline\", \"ETT - Normal\", \"NGT - Abnormal\",\n    \"NGT - Borderline\", \"NGT - Incompletely Imaged\", \"NGT - Normal\", \"CVC - Abnormal\",\n    \"CVC - Borderline\", \"CVC - Normal\", \"Swan Ganz Catheter Present\"]","f057660d":"df = pd.read_csv(folds_path\/'train_folds.csv')\ndf.head()","8637f211":"def get_x(x): return resized_path\/'train'\/(x['StudyInstanceUID']+'.jpg')\ndef get_y(y): return y[targets].tolist()\ndef splitter(df):\n    trn_idx = df[df.kfold != config.fold].index.to_list()\n    val_idx = df[df.kfold == config.fold].index.to_list()\n    return trn_idx, val_idx\n\ndb = DataBlock(blocks= (ImageBlock, MultiCategoryBlock(encoded=True, vocab=targets)),\n               get_x = get_x, \n               get_y = get_y,\n               splitter = splitter,\n               item_tfms = Resize(config.pre_img_size),\n               batch_tfms = [*aug_transforms(size=config.img_size, min_scale=0.9), \n                             Normalize.from_stats(*imagenet_stats)]\n               )","9c794bfc":"dls = db.dataloaders(df, bs=config.bs)\ndls.show_batch()","fcc3a8e4":"def create_timm_body(arch:str, pretrained=True, cut=None):\n    model = create_model(arch, pretrained=pretrained)\n    if cut is None:\n        ll = list(enumerate(model.children()))\n        cut = next(i for i,o in reversed(ll) if has_pool_type(o))\n    if isinstance(cut, int): return nn.Sequential(*list(model.children())[:cut])\n    elif callable(cut): return cut(model)\n    else: raise NamedError(\"cut must be either integer or function\")","f49f6f89":"body = create_timm_body(config.arch, pretrained=True)\nnf = num_features_model(nn.Sequential(*body.children()))\nhead = create_head(nf, 11) \nmodel = nn.Sequential(body, head)\napply_init(model[1], nn.init.kaiming_normal_)","c4378092":"learner = Learner(dls, model, \n                  splitter=default_split, \n                  loss_func=BCEWithLogitsLossFlat(),\n                  metrics=[accuracy_multi]).to_fp16()","ea8c3cc6":"learner.fine_tune(config.epochs, freeze_epochs=config.freeze_epochs, base_lr=config.lr)","da660963":"learner.export(f'{config.arch}_foldx{config.fold}.pkl')","ba67a3a2":"For experimentation, we will keeping the `config` at the top. \n\nNote: I prefer using dataclass, because dictionary syntax is very verbose. With dataclass, you can access the config values using `.` notation (that also means, tab auto-completion)","4e607849":"Don't worry a lot if the above code looks cryptic. You can read the [6th notebook (or chapter)](https:\/\/github.com\/fastai\/fastbook\/blob\/master\/06_multicat.ipynb) in fastbook. It explains the topic in the most simplest way possible. And once you master datablock API, you will feel like a Ninja (trust me on this)! \n\nYou are amazing! Now lets create our dataloaders, & then take a look at some images.","fd6ab0d7":"Looks great to me, What do you think?\n\nWe are done with data, time to build our deep learning model.","2e599b08":"And finally, lets train (technically, finetuning \ud83e\udd2f) our model.","e5e8d6d2":"Fastai's datablock API is amazing. Infinite flexibility and incredibly powerful. To use the datablock API, you need to define some functions.","77fd9b37":"Looking forward to inference? ","2f80100a":"As the title suggests, we will be using to fastai to achieve the best possible score with minimum lines of code.\n\nWe will also use **timm** for its pretrained models. Lets start by installing the latest version of both the libraries","c7a3582d":"## Model\n\nWe will wrap timm's `create_model` function inside `create_timm_body` function (inspired from fastai's `create_body` function), to use fastai's esoteric features like differential learning rate.\n\nHere is an amazing [colab notebook](https:\/\/colab.research.google.com\/github\/muellerzr\/Practical-Deep-Learning-for-Coders-2.0\/blob\/master\/Computer%20Vision\/05_EfficientNet_and_Custom_Weights.ipynb) to help you better understand \"how you can use custom models with fastai\". ","082727ba":"Next, we will initialize some path (& other) variables (for use throughout the notebook)\n\nPS: I will be using my version for the dataset. I have resized all the images so that its much faster to load them into the RAM.","e854084b":"Once we have the *model body*, we will calculate the *output* shape and create the *model head* accordingly. \n\nYou can easily calculate the output shape easily by using fastai's `num_features_model` function\ud83d\ude09\n\nFinally, we will use *kaimming initialization* to initialize the *model head* weights.\n\nI know it sounds complex, but its just a few lines of code.","91804b86":"Before we write any code, lets set the seed for reproducibility. We will use fastai's `set_seed` function.","152532e8":"Great, time to import both the libraries . . . ","b2630e7f":"## Learner\n\nTime to put everything together. Fastai has an awesome class for it, called `Learner`. ","4e415914":"## Data\n\nEnough prep-work! Lets dive in . . .","b12c336c":"Amazing! Lets export the model so that we can deploy it to production \ud83d\ude02. Just kidding, we will (only) use it for inference."}}