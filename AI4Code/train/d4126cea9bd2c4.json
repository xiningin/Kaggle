{"cell_type":{"88296655":"code","c0f3227f":"code","d85b52b2":"code","b7a408dd":"code","52f7d196":"code","80112ec1":"code","d02df870":"code","49213468":"code","7b8604f5":"code","2ca6ec37":"code","00fbf2c8":"code","15ea727e":"code","b894b021":"code","8a59ad49":"code","c24e2161":"code","ea8ef3ce":"code","8afe2b8a":"code","3a039ba0":"code","d683a950":"code","928c29d2":"code","1acb0a84":"code","7efbba8d":"code","04244609":"code","1d3c8b7d":"code","e1791f07":"code","e72e1856":"code","22ec09e4":"code","1fa77717":"markdown","578927d6":"markdown","415c8683":"markdown"},"source":{"88296655":"\nimport numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\nimport gc\nimport os\nimport matplotlib.pyplot as plt\nimport seaborn as sns\nimport gc\nfrom lightgbm.sklearn import LGBMClassifier\nfrom sklearn.model_selection import train_test_split\nfrom sklearn.metrics import roc_auc_score,accuracy_score\nfrom sklearn.model_selection import KFold,StratifiedKFold\nfrom xgboost.sklearn import XGBClassifier\nfrom sklearn.impute import SimpleImputer\nfrom sklearn.preprocessing import RobustScaler,PolynomialFeatures,MinMaxScaler,Binarizer\nfrom sklearn.decomposition import PCA\nimport warnings\n%matplotlib inline\nwarnings.filterwarnings('ignore')\ngc.enable()\n# Any results you write to the current directory are saved as output.","c0f3227f":"#Dataset view\npath1= \"..\/input\/\"\ndata_files=list(os.listdir(path1))\ndf_files=pd.DataFrame(data_files,columns=['File_Name'])\ndf_files['Size_in_MB']=df_files.File_Name.apply(lambda x:round(os.stat(path1+x).st_size\/(1024*1024),2))\ndf_files","d85b52b2":"#All functions\n\n#FUNCTION FOR PROVIDING FEATURE SUMMARY\ndef feature_summary(df_fa):\n    print('DataFrame shape')\n    print('rows:',df_fa.shape[0])\n    print('cols:',df_fa.shape[1])\n    col_list=['Null','Unique_Count','Data_type','Max\/Min','Mean','Std','Skewness','Sample_values']\n    df=pd.DataFrame(index=df_fa.columns,columns=col_list)\n    df['Null']=list([len(df_fa[col][df_fa[col].isnull()]) for i,col in enumerate(df_fa.columns)])\n    #df['%_Null']=list([len(df_fa[col][df_fa[col].isnull()])\/df_fa.shape[0]*100 for i,col in enumerate(df_fa.columns)])\n    df['Unique_Count']=list([len(df_fa[col].unique()) for i,col in enumerate(df_fa.columns)])\n    df['Data_type']=list([df_fa[col].dtype for i,col in enumerate(df_fa.columns)])\n    for i,col in enumerate(df_fa.columns):\n        if 'float' in str(df_fa[col].dtype) or 'int' in str(df_fa[col].dtype):\n            df.at[col,'Max\/Min']=str(round(df_fa[col].max(),2))+'\/'+str(round(df_fa[col].min(),2))\n            df.at[col,'Mean']=df_fa[col].mean()\n            df.at[col,'Std']=df_fa[col].std()\n            df.at[col,'Skewness']=df_fa[col].skew()\n        df.at[col,'Sample_values']=list(df_fa[col].unique())\n           \n    return(df.fillna('-'))\n\ndef drop_corr_col(df_corr):\n    upper = df_corr.where(np.triu(np.ones(df_corr.shape),\n                          k=1).astype(np.bool))\n    # Find index of feature columns with correlation greater than 0.999\n    to_drop = [column for column in upper.columns if any(upper[column] > 0.999)]\n    return(to_drop)\n\ndef cnt_unique(df):\n    return(len(df.unique()))","b7a408dd":"%%time\n#Reading credit card balance data\ncc_bal=pd.read_csv(path1+'credit_card_balance.csv')\nprint('credit_card_balance set reading complete...')","52f7d196":"cc_bal_fs=feature_summary(cc_bal)","80112ec1":"cc_bal_fs","d02df870":"cc_bal.head()","49213468":"cc_bal['MONTHS_BALANCE']=cc_bal['MONTHS_BALANCE'].abs()","7b8604f5":"cc_bal['CALC_PERC_BALANCE']=cc_bal['AMT_BALANCE']\/cc_bal['AMT_CREDIT_LIMIT_ACTUAL']\ncc_bal['CALC_PERC_DRAWINGS_ATM_CURRENT']=cc_bal['AMT_DRAWINGS_ATM_CURRENT']\/cc_bal['AMT_CREDIT_LIMIT_ACTUAL']\ncc_bal['CALC_PERC_DRAWINGS_CURRENT']=cc_bal['AMT_DRAWINGS_CURRENT']\/cc_bal['AMT_CREDIT_LIMIT_ACTUAL']\ncc_bal['CALC_PERC_DRAWINGS_OTHER_CURRENT']=cc_bal['AMT_DRAWINGS_OTHER_CURRENT']\/cc_bal['AMT_CREDIT_LIMIT_ACTUAL']\ncc_bal['CALC_PERC_DRAWINGS_POS_CURRENT']=cc_bal['AMT_DRAWINGS_POS_CURRENT']\/cc_bal['AMT_CREDIT_LIMIT_ACTUAL']\ncc_bal['CALC_PERC_INST_MIN_REGULARITY']=cc_bal['AMT_INST_MIN_REGULARITY']\/cc_bal['AMT_CREDIT_LIMIT_ACTUAL']\ncc_bal['CALC_PERC_PAYMENT_CURRENT']=cc_bal['AMT_PAYMENT_CURRENT']\/cc_bal['AMT_CREDIT_LIMIT_ACTUAL']\ncc_bal['CALC_PERC_PAYMENT_TOTAL_CURRENT']=cc_bal['AMT_PAYMENT_TOTAL_CURRENT']\/cc_bal['AMT_CREDIT_LIMIT_ACTUAL']\ncc_bal['CALC_PERC_RECEIVABLE_PRINCIPAL']=cc_bal['AMT_RECEIVABLE_PRINCIPAL']\/cc_bal['AMT_CREDIT_LIMIT_ACTUAL']\ncc_bal['CALC_PERC_RECIVABLE']=cc_bal['AMT_RECIVABLE']\/cc_bal['AMT_CREDIT_LIMIT_ACTUAL']\ncc_bal['CALC_DAYS_WITHOUT_TOLERANCE']=cc_bal['SK_DPD']-cc_bal['SK_DPD_DEF']\n\nCNT_DRAWING_LIST=['CNT_DRAWINGS_ATM_CURRENT','CNT_DRAWINGS_CURRENT','CNT_DRAWINGS_OTHER_CURRENT','CNT_DRAWINGS_POS_CURRENT']\ncc_bal['CALC_CNT_DRAWINGS_TOTAL']=cc_bal[CNT_DRAWING_LIST].sum(axis=1)","2ca6ec37":"cc_bal['NAME_CONTRACT_STATUS']=cc_bal['NAME_CONTRACT_STATUS'].apply(lambda x: str(x).replace(\" \",\"_\")) \ndummy=pd.get_dummies(cc_bal['NAME_CONTRACT_STATUS'],prefix='DUM_NAME_CONTRACT_STATUS')","00fbf2c8":"cc_bal_f=pd.concat([cc_bal.drop(['NAME_CONTRACT_STATUS'],axis=1),dummy],axis=1)","15ea727e":"cc_bal_f.head(10)","b894b021":"#DEFINING AGGREGATION RULES AND CREATING LIST OF NEW FEATURES\ncc_bal_cols=[x for x in list(cc_bal_f.columns) if x not in ['SK_ID_CURR']]\ncc_bal_agg={}\ncc_bal_name=['SK_ID_CURR','SK_ID_PREV']\nfor col in cc_bal_cols:\n    if 'SK_ID_PREV'==col:\n        cc_bal_agg[col]=['count']\n        cc_bal_name.append(col+'_'+'count')\n    elif 'MONTHS_BALANCE'==col:\n        cc_bal_agg[col]=['max','min','count']\n        cc_bal_name.append(col+'_'+'max')\n        cc_bal_name.append(col+'_'+'min')\n        cc_bal_name.append(col+'_'+'count')\n    elif 'AMT_' in col:\n        cc_bal_agg[col]=['sum','mean','max','min','var','std']\n        cc_bal_name.append(col+'_'+'sum')\n        cc_bal_name.append(col+'_'+'mean')\n        cc_bal_name.append(col+'_'+'max')\n        cc_bal_name.append(col+'_'+'min')\n        cc_bal_name.append(col+'_'+'var')\n        cc_bal_name.append(col+'_'+'std')\n    elif 'CNT_' in col:\n        cc_bal_agg[col]=['max','min','sum','count']\n        cc_bal_name.append(col+'_'+'max')\n        cc_bal_name.append(col+'_'+'min')\n        cc_bal_name.append(col+'_'+'sum')\n        cc_bal_name.append(col+'_'+'count')\n    else:\n        cc_bal_agg[col]=['mean']\n        cc_bal_name.append(col+'_'+'mean')","8a59ad49":"%%time\n#AGGREGATING DATA ON SK_ID_CURR,SK_ID_PREV USING RULES CREATED IN PREVIOUS STEP\ncc_bal_ff=cc_bal_f.groupby(['SK_ID_CURR','SK_ID_PREV']).aggregate(cc_bal_agg)\ncc_bal_ff.reset_index(inplace=True)\ncc_bal_ff.columns=cc_bal_name","c24e2161":"cc_bal_ff.head(20)","ea8ef3ce":"#DEFINING RULES FOR SECOND AGGREGATION ON SK_ID_CURR\ncc_bal_cols=[x for x in list(cc_bal_ff.columns) if x not in ['SK_ID_CURR','SK_ID_PREV']]\ncc_bal_agg={}\ncc_bal_name=['SK_ID_CURR']\nfor col in cc_bal_cols:\n    if '_sum'==col:\n        cc_bal_agg[col]=['sum']\n        cc_bal_name.append(col)\n    elif '_var' in col:\n        cc_bal_agg[col]=['mean']\n        cc_bal_name.append(col)\n    elif '_std' in col:\n        cc_bal_agg[col]=['mean']\n        cc_bal_name.append(col)\n    elif '_mean' in col:\n        cc_bal_agg[col]=['mean']\n        cc_bal_name.append(col)\n    elif '_max' in col:\n        cc_bal_agg[col]=['max']\n        cc_bal_name.append(col)\n    elif '_min' in col:\n        cc_bal_agg[col]=['min']\n        cc_bal_name.append(col)\n    elif '_count' in col:\n        cc_bal_agg[col]=['sum']\n        cc_bal_name.append(col)\n    else:\n        cc_bal_agg[col]=['sum']\n        cc_bal_name.append(col)","8afe2b8a":"%%time\n#AGGREGATING DATA ON SK_ID_CURR,SK_ID_PREV USING RULES CREATED IN PREVIOUS STEP\n# cc_bal_ff.drop(['SK_ID_PREV'],axis=1,inplace=True)\ncc_bal_fg=cc_bal_ff.groupby(['SK_ID_CURR']).aggregate(cc_bal_agg)\ncc_bal_fg.reset_index(inplace=True)\ncc_bal_fg.columns=cc_bal_name","3a039ba0":"cc_bal_fg.head()","d683a950":"cc_bal_fg.shape","928c29d2":"del cc_bal,cc_bal_f,cc_bal_ff\ngc.collect()","1acb0a84":"train=pd.read_csv(path1+'application_train.csv',usecols=['SK_ID_CURR','TARGET'])","7efbba8d":"df_final=train.join(cc_bal_fg.set_index('SK_ID_CURR'),on='SK_ID_CURR',lsuffix='_AP', rsuffix='_CCB')","04244609":"df_ccb=df_final.drop(['SK_ID_CURR','TARGET'],axis=1)","1d3c8b7d":"df_ccb.shape","e1791f07":"%%time\ntrain_X,test_X,train_y,test_y=train_test_split(df_ccb,train['TARGET'],random_state=200)\nmodel =LGBMClassifier(learning_rate=0.05,n_estimators=200,n_jobs=-1,reg_alpha=0.1,min_split_gain=.1,verbose=-1)\nmodel.fit(train_X,train_y)\nscore2=roc_auc_score(test_y,model.predict_proba(test_X)[:,1])\nprint(score2)","e72e1856":"%%time\n#FEATURE EXCLUSION\nscore=0\nscore1=0\nscore2=0\ndrop_list=[]\ncol_list=list(df_ccb.columns)\n\n\nwhile True:\n    score1=0\n    score2=0\n    for i,col in enumerate(col_list):\n        col_list.remove(col)\n        train_X,test_X,train_y,test_y=train_test_split(df_ccb[col_list],train['TARGET'],random_state=200)\n        model =LGBMClassifier(learning_rate=0.05,n_estimators=200,n_jobs=-1,reg_alpha=0.1,min_split_gain=.1,verbose=-1)\n        model.fit(train_X,train_y)\n        score2=roc_auc_score(test_y,model.predict_proba(test_X)[:,1])\n        col_list.extend([col])\n#        dummy_1.at[i,'score']=score2\n        if score1<score2:\n            score1=score2\n            col1=col\n#        print('dropped col',col,':',score2)\n    if score<score1:\n        score=score1\n        print('dropped col',col1,':',score)\n        drop_list.extend([col1])\n        col_list.remove(col1)\n    else:\n        print('Best score achieved')\n        break\nprint(drop_list)\nprint('best score:',score)","22ec09e4":"# %%time\n# #FORWARD FEATURE SELCTION \n# score=0\n# score1=0\n# score2=0\n# select_list=[]\n# col_list=list(df_ccb.columns)  \n# k=0\n\n\n# while True:\n#     score1=0\n#     score2=0\n#     temp_list=select_list\n#     for i,col in enumerate(col_list):\n#         if k==0:\n#             train_X,test_X,train_y,test_y=train_test_split(df_ccb[col],train['TARGET'],random_state=200)\n#             model =LGBMClassifier(learning_rate=0.05,n_estimators=200,n_jobs=-1,reg_alpha=0.1,min_split_gain=.1,verbose=-1)\n#             model.fit(np.array(train_X).reshape(-1,1),train_y)\n#             score2=roc_auc_score(test_y,model.predict_proba(np.array(test_X).reshape(-1,1))[:,1])\n#         else:\n#             temp_list.extend([col])\n#             train_X,test_X,train_y,test_y=train_test_split(df_ccb[temp_list],train['TARGET'],random_state=200)\n#             model =LGBMClassifier(learning_rate=0.05,n_estimators=200,n_jobs=-1,reg_alpha=0.1,min_split_gain=.1,verbose=-1)\n#             model.fit(train_X,train_y)\n#             score2=roc_auc_score(test_y,model.predict_proba(test_X)[:,1])\n#             temp_list.remove(col)\n#         if score1<=score2:\n#             score1=score2\n#             col1=col\n# #        print('dropped col',col,':',score2)\n#     k=k+1\n#     if score<=score1:\n#         score=score1\n#         print('select col',col1,':',score)\n#         select_list.extend([col1])\n#         col_list.remove(col1)\n#     else:\n#         print('Best score achieved')\n#         break\n    \n# print(select_list)\n# print('best score:',score)","1fa77717":"* Base score: 0.5664864722699678\n* Improvement 0.5695539915692158","578927d6":"<img src=\"https:\/\/storage.googleapis.com\/kaggle-media\/competitions\/home-credit\/home_credit.png\" alt=\"Count of Operation\" height=\"800\" width=\"800\"><\/img>","415c8683":"* select col CNT_DRAWINGS_POS_CURRENT_count : 0.5587218738047792\n* select col CALC_PERC_RECEIVABLE_PRINCIPAL_mean : 0.5627561594655999\n* select col AMT_DRAWINGS_CURRENT_mean : 0.5653548270712518\n* select col CNT_DRAWINGS_ATM_CURRENT_max : 0.567927622000367\n* select col AMT_DRAWINGS_OTHER_CURRENT_max : 0.5706820471123468\n* select col DUM_NAME_CONTRACT_STATUS_Refused_mean : 0.5706820471123468\n* select col DUM_NAME_CONTRACT_STATUS_Demand_mean : 0.5706820471123468\n* select col DUM_NAME_CONTRACT_STATUS_Approved_mean : 0.5706820471123468\n* select col CNT_DRAWINGS_OTHER_CURRENT_count : 0.5706820471123468\n* select col CNT_DRAWINGS_OTHER_CURRENT_min : 0.5706820471123468\n* select col CNT_DRAWINGS_ATM_CURRENT_count : 0.5706820471123468\n* select col AMT_DRAWINGS_OTHER_CURRENT_min : 0.5706820471123468\n* Best score achieved\n* ['CNT_DRAWINGS_POS_CURRENT_count', 'CALC_PERC_RECEIVABLE_PRINCIPAL_mean', 'AMT_DRAWINGS_CURRENT_mean', 'CNT_DRAWINGS_ATM_CURRENT_max', 'AMT_DRAWINGS_OTHER_CURRENT_max', 'DUM_NAME_CONTRACT_STATUS_Refused_mean', 'DUM_NAME_CONTRACT_STATUS_Demand_mean', 'DUM_NAME_CONTRACT_STATUS_Approved_mean', 'CNT_DRAWINGS_OTHER_CURRENT_count', 'CNT_DRAWINGS_OTHER_CURRENT_min', 'CNT_DRAWINGS_ATM_CURRENT_count', 'AMT_DRAWINGS_OTHER_CURRENT_min']\n* best score: 0.5706820471123468\n* CPU times: user 14h 9min 48s, sys: 1min 21s, total: 14h 11min 10s\n* Wall time: 3h 33min 41s"}}