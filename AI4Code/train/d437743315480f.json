{"cell_type":{"468e2775":"code","c6113094":"code","1643790b":"code","1b9c14bd":"code","7cd81da3":"code","5384bffd":"code","fcca2193":"code","d8976486":"code","b16f94dc":"code","67b5d536":"code","da66c3a2":"markdown","9d2ad5ee":"markdown","517cfabe":"markdown","519120c7":"markdown"},"source":{"468e2775":"import os\nimport numpy as np\nimport pandas as pd\n\nfrom keras.layers import *\nfrom keras import backend as K\nfrom keras.regularizers import l2\nfrom keras.optimizers import Adam\nfrom keras.models import Model,load_model\nfrom keras.preprocessing.image import ImageDataGenerator\nfrom keras.callbacks import ReduceLROnPlateau,EarlyStopping\n\nfrom scipy.misc import toimage,imresize\nfrom skimage import exposure\nfrom PIL import Image\nimport cv2","c6113094":"spirals_train_folder = '..\/input\/drawings\/spiral\/training'\nspirals_val_folder = '..\/input\/drawings\/spiral\/testing'\nwaves_train_folder = '..\/input\/drawings\/wave\/training'\nwaves_val_folder = '..\/input\/drawings\/wave\/testing'\n\nbatch_size = 24\n\n# histogram equalizer\ndef eqz_plz(img):\n    return exposure.equalize_hist(img)\n\n\nspiral_datagen = ImageDataGenerator(rotation_range=360, # they're spirals.\n                                    width_shift_range=0.1,\n                                    height_shift_range=0.1,\n                                    brightness_range=(0.5,1.5),\n                                    shear_range=0.2,\n                                    zoom_range=0.2,\n                                    horizontal_flip=True,\n                                    preprocessing_function=eqz_plz,\n                                    vertical_flip=True)\n\nwave_datagen = ImageDataGenerator(rotation_range=5,\n                                  width_shift_range=0.1,\n                                  height_shift_range=0.1,\n                                  brightness_range=(0.5,1.5),\n                                  shear_range=0.2,\n                                  zoom_range=0.2,\n                                  horizontal_flip=True,\n                                  preprocessing_function=eqz_plz,\n                                  vertical_flip=True)\n\n\nspiral_train_generator = spiral_datagen.flow_from_directory(directory=os.path.abspath(spirals_train_folder),\n                                                            target_size=(256, 256),\n                                                            color_mode=\"grayscale\",\n                                                            batch_size=batch_size,\n                                                            class_mode=\"binary\",\n                                                            shuffle=True,\n                                                            seed=666)\n\nspiral_val_generator = spiral_datagen.flow_from_directory(directory=os.path.abspath(spirals_val_folder),\n                                                            target_size=(256, 256),\n                                                            color_mode=\"grayscale\",\n                                                            batch_size=batch_size,\n                                                            class_mode=\"binary\",\n                                                            shuffle=True,\n                                                            seed=710)\n\nwave_train_generator = wave_datagen.flow_from_directory(directory=os.path.abspath(waves_train_folder),\n                                                        target_size=(256, 512), # HxW in machine learning, WxH in computer vision\n                                                        color_mode=\"grayscale\",\n                                                        batch_size=batch_size,\n                                                        class_mode=\"binary\",\n                                                        shuffle=True,\n                                                        seed=420)\n\nwave_val_generator = wave_datagen.flow_from_directory(directory=os.path.abspath(waves_val_folder),\n                                                        target_size=(256, 512),\n                                                        color_mode=\"grayscale\",\n                                                        batch_size=batch_size,\n                                                        class_mode=\"binary\",\n                                                        shuffle=True,\n                                                        seed=420)","1643790b":"reduce_lr = ReduceLROnPlateau(monitor='val_loss',patience=12,min_lr=1e-9,verbose=1)\nearly_stop = EarlyStopping(monitor='val_loss',patience=16,verbose=1)","1b9c14bd":"K.clear_session()\n\ndef nopamine_model(mode):\n    if (mode == 'spirals') or (mode == 'spiral'):\n        input_layer = Input(shape=(256,256,1),name=f'{mode}_input_layer')\n    elif (mode == 'waves') or (mode == 'wave'):\n        input_layer = Input(shape=(256,512,1),name=f'{mode}_input_layer')\n\n    m1 = Conv2D(256,(5,5),dilation_rate=4,kernel_initializer='glorot_normal',kernel_regularizer=l2(0.001),activation='relu',padding='same')(input_layer)\n    p1 = MaxPool2D((9,9),strides=3)(m1)\n    m2 = Conv2D(128,(5,5),dilation_rate=2,kernel_initializer='glorot_normal',kernel_regularizer=l2(0.001),activation='relu',padding='same')(p1)\n    p2 = MaxPool2D((7,7),strides=3)(m2)\n    m3 = Conv2D(64,(3,3),kernel_initializer='glorot_normal',kernel_regularizer=l2(0.001),activation='relu',padding='same')(p2)\n    p3 = MaxPool2D((5,5),strides=2)(m3)\n    g1=Dropout(0.2)(p3)\n    f1 = Flatten()(g1)\n    d1 = Dense(666,activation='relu')(f1)\n    g2=Dropout(0.5)(d1)\n    d2 = Dense(1,activation='sigmoid')(g2)\n    \n\n    \n    this_model = Model(input_layer,d2)\n    this_model.summary()\n    return this_model","7cd81da3":"spiral_model = nopamine_model(mode='spirals') # early stopping epoch 89: val_loss 0.4796, val_acc 0.8274\nspiral_model.compile(optimizer=Adam(lr=3.15e-5), loss='binary_crossentropy', metrics=['accuracy'])","5384bffd":"result=spiral_model.fit_generator(spiral_train_generator,\n                           validation_data=spiral_val_generator,\n                           epochs=666,\n                           steps_per_epoch=(2000\/\/batch_size),\n                           validation_steps=(800\/\/batch_size),\n                           callbacks=[reduce_lr,early_stop],\n                           verbose=1)","fcca2193":"# here's how to load\/save\nspiral_model.save('..\/nopamine_model_spirals.h5')","d8976486":"waves_model = nopamine_model(mode='waves')\nwaves_model.compile(optimizer=Adam(lr=3.15e-5),loss='binary_crossentropy',metrics=['accuracy'])","b16f94dc":"waves_model.fit_generator(wave_train_generator,\n                          validation_data=wave_val_generator,\n                          epochs=666,\n                          steps_per_epoch=(2000\/\/batch_size),\n                          validation_steps=(800\/\/batch_size),\n                          callbacks=[reduce_lr,early_stop],\n                          verbose=1)","67b5d536":"waves_model.save('..\/nopamine_model_waves.h5')","da66c3a2":"### Network for waves","9d2ad5ee":"## DNN","517cfabe":"### Image generators","519120c7":"### Network for spirals"}}