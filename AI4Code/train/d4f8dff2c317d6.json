{"cell_type":{"3b8793c6":"code","9869e4b7":"code","40fd6c7d":"code","4b98dbf6":"code","aa9c3a09":"code","01048fa7":"code","dee4ff56":"code","8398fbe4":"code","1f772436":"code","b06acda7":"code","21ef3554":"code","145d321a":"code","3f95d1b0":"code","80879f96":"code","c0afb29b":"markdown","4044450e":"markdown","7d342412":"markdown","d1aa51d6":"markdown","bc0f0a34":"markdown","6fe8d67d":"markdown"},"source":{"3b8793c6":"# You will need to run this command if opening a JPG encoded DICOM file\n#!conda install gdcm -c conda-forge -y","9869e4b7":"import os\nimport numpy as np\nimport pandas as pd\nimport pydicom\nimport matplotlib.pyplot as plt\nfrom skimage.filters import unsharp_mask, meijering, sato, scharr, hessian\nfrom skimage.exposure import exposure, equalize_hist, equalize_adapthist\nimport cv2 as cv","40fd6c7d":"# This function gets the first image path in a StudyInstanceUID directory in the train set\ndef get_image_by_study_id(study_id):\n    base_path = \"\/kaggle\/input\/siim-covid19-detection\/\"\n    study_path = base_path + \"train\/\" + study_id + \"\/\"\n    images = []\n    for subdir, dirs, files in os.walk(study_path):\n        for file in files:     \n            image = os.path.join(subdir, file)\n            if os.path.isfile(image):\n                return image\n    return \"none\"","4b98dbf6":"# Load a DICOM file and get the pixels\ndef load_image(study_id):\n    img_file = get_image_by_study_id(study_id)\n    image = pydicom.dcmread(img_file)\n    pixels = image.pixel_array\n\n    min_pixel = np.min(pixels)\n    max_pixel = np.max(pixels)\n\n    if image.PhotometricInterpretation == \"MONOCHROME1\":\n        pixels = max_pixel - pixels\n    else:\n        pixels = pixels\n\n    return pixels","aa9c3a09":"# Apply filters. Tweak params here.\ndef apply_filter(f, img):\n    if f == 'equalize_hist':\n        img = equalize_hist(img, nbins=256, mask=None)\n        \n    if f == 'equalize_adapthist': \n        img = equalize_adapthist(img, kernel_size=None, clip_limit=0.01, nbins=256)\n        \n    if f == 'unsharp_mask':\n        img = unsharp_mask(img, radius=5, amount=2)\n        \n    if f == 'meijering':\n        img = meijering(img, sigmas=range(1, 10, 2), alpha=None, black_ridges=True, mode='reflect', cval=0)\n        \n    if f == 'sato':\n        img = sato(img, sigmas=range(1, 10, 2), black_ridges=True, mode='reflect', cval=0)\n        \n    if f == 'scharr':\n        img = scharr(img, mask=None, axis=None, mode='reflect', cval=0.0)\n        \n    if f == 'hessian':\n        img = hessian(img, sigmas=range(1, 10, 2), scale_range=None, scale_step=None, alpha=0.5, beta=0.5, gamma=15, black_ridges=True, mode='reflect', cval=0)\n    \n    if f == 'threshold_isodata':\n        img = threshold_isodata(image=img, nbins=256, return_all=False, hist=None)\n    \n    return img","01048fa7":"# Display the original image and the processed image\ndef plot_images(title, image, image_processed):\n    # Plot both images\n    fig, axes = plt.subplots(nrows=1, ncols=2,sharex=True, sharey=True, figsize=(12, 12))\n    ax = axes.ravel()\n    ax[0].imshow(image, cmap=plt.cm.gray)\n    ax[0].set_title('Original image')\n    ax[1].imshow(image_processed, cmap=plt.cm.gray)\n    ax[1].set_title(title)\n    for a in ax:\n        a.axis('off')\n    fig.tight_layout()\n    plt.show()","dee4ff56":"# Load an image using the Study_ID\nimage = load_image('013d698aeecb')","8398fbe4":"# Apply Histogram Equalization\nimage_out = apply_filter('equalize_hist', image)\nplot_images('Histogram Equalization',image, image_out)","1f772436":"# Apply Adaptive Histogram Equalization (CLAHE)\nimage_out = apply_filter('equalize_adapthist', image)\nplot_images('CLAHE',image, image_out)","b06acda7":"# Apply unsharp mask\nimage_out = apply_filter('unsharp_mask', image_out)\nplot_images('Unsharp',image, image_out)","21ef3554":"# Apply Meijering and then Hist EQ to brighten it up\nimage_out = apply_filter('meijering', image)\nimage_out = apply_filter('equalize_hist', image_out)\nplot_images('Meijering',image, image_out)","145d321a":"# Apply Sato and Hist EQ\nimage_out = apply_filter('sato', image)\nimage_out = apply_filter('equalize_hist', image_out)\nplot_images('Sato',image, image_out)","3f95d1b0":"# Scharr is similar to Sobel, maybe a little faster?\nimage_out = apply_filter('scharr', image)\nimage_out = apply_filter('equalize_hist', image_out)\nplot_images('Scharr',image, image_out)","80879f96":"# Apply Hessian and CLAHE\nimage_out = apply_filter('hessian', image)\nimage_out = apply_filter('equalize_adapthist', image_out)\nplot_images('Hessian',image, image_out)","c0afb29b":"### Put an unsharp mask on the original image\n- Why is it called unsharp mask when it actually sharpens the image? (because the first step of unsharp is to blur, which is .. um .. unsharp)\n- The unsharpened image is more crisp and defined.","4044450e":"<div class='alert alert-info' style='text-align:center'><h1>Applying filters to Chest X-Rays<\/h1>- yet another chest x-ray processing notebook -<\/div>\n\n#### While exploring methods to better visualize lung tissue, I found some useful filters from sklearn.filters I thought I'd share.\n#### In this notebook we'll grab an image and apply a filter or two. Params can be tweaked to get some pretty unique views.\n\n- In this case, we'll use two modules from *sklearn.exposure* .. **equalize_hist** and **equalize_adapthist**\n- The filters are **unsharp_mask**, **meijering**, **sato**, **scharr**, and **hessian** from *sklearn.filters*","7d342412":"#### As you can see, there *are* methods to demonstrate tissue areas with more\/less contrast. Some are noisy. Some are not.\n\n- Stacking filters and using various parameter settings can yield interesting results.\n\nHere are some other processing notebooks I made:\n- Lung Segmentation Without CNN -> https:\/\/www.kaggle.com\/davidbroberts\/lung-segmentation-without-cnn\n- Rib supression on Chest X-Rays -> https:\/\/www.kaggle.com\/davidbroberts\/rib-suppression-poc\n- Manual DICOM VOI LUT -> https:\/\/www.kaggle.com\/davidbroberts\/manual-dicom-voi-lut\n- Apply Unsharp Mask to Chest X-Rays -> https:\/\/www.kaggle.com\/davidbroberts\/unsharp-masking-chest-x-rays\n- Cropping Chest X-Rays -> https:\/\/www.kaggle.com\/davidbroberts\/cropping-chest-x-rays\n- Bounding Boxes on Cropped Images -> https:\/\/www.kaggle.com\/davidbroberts\/bounding-boxes-on-cropped-images\n- Visualizing Chest X-Ray bit planes -> https:\/\/www.kaggle.com\/davidbroberts\/visualizing-chest-x-ray-bitplanes\n- DICOM full range pixels as CNN input -> https:\/\/www.kaggle.com\/davidbroberts\/dicom-full-range-pixels-as-cnn-input\n- Standardizins Chest X-Ray Dataset Exports -> https:\/\/www.kaggle.com\/davidbroberts\/standardizing-cxr-datasets","d1aa51d6":"### Sklearn has a lot of edge detection filters. Here's a few I found useful.\n- Play around with the default params in the apply_filter method to get some interesting results.","bc0f0a34":"### Load stuff and define some functions","6fe8d67d":"### Load an image and apply equalization\n- We'll use Histogram Equalization and Contrast Limited Adaptive Histogram Equalization (CLAHE)\n- Hist EQ gives a nice contrasty view of a chest x-ray.\n- CLAHE seems to be more balanced and 'wide' if the input image isn't poorly balanced."}}