{"cell_type":{"a268a454":"code","96c1641b":"code","90c69397":"code","0d88c46e":"code","627c1715":"code","81de052c":"code","f53b5fbc":"code","c176618c":"code","2c78168a":"code","ebe05e3f":"markdown"},"source":{"a268a454":"import pandas as pd\nimport numpy as np\nimport random\nfrom tqdm import tqdm","96c1641b":"import matplotlib.pyplot as plt\nplt.rcParams[\"figure.figsize\"] = (10, 8)","90c69397":"INPUT_PATH = '..\/input\/optiver-realized-volatility-prediction\/'","0d88c46e":"train = pd.read_csv(INPUT_PATH + 'train.csv')","627c1715":"def mflip(x):\n    return np.where(x > 0.5, x - 1, x)","81de052c":"all_prices = {}","f53b5fbc":"%%time\nfor sid in train.stock_id.unique():\n#     if sid >= 31: continue;\n    print(sid)\n    book = pd.read_parquet(INPUT_PATH + '\/book_train.parquet\/stock_id={}'.format(sid))\n    prices = {}\n    for tid in book.time_id.unique():\n        bt = book[book.time_id == tid]\n        chgs = np.hstack(    [np.log(bt[col]).diff().fillna(0).unique()\n                for col in [b for b in book.columns if 'price' in b]] )        \n        chgs = chgs[chgs != 0]\n        if len(chgs) < 6: continue;\n\n        minchg = np.abs(chgs).min()\n        mults = np.abs(chgs)\/ minchg\n    #     plt.hist(mflip(mults %1 ), bins =250); plt.figure()\n    #     plt.plot( ( mflip(mults % 1 ) \/ mults) )\n\n        if np.max( mflip(mults % 1 ) \/ mults) > 0.2:\n            print('*x*'); continue;\n\n        rem = ( mflip(mults % 1 ) \/ mults).mean() * minchg\n        rem\n\n        minchg += rem\n\n        if random.random() < 1\/500 and len(chgs) > 10: print(1\/ minchg)\n    #     break;\n        prices[tid] = 1\/minchg\n    \n    all_prices[sid] = (prices, len(chgs))\n    print()","c176618c":"import pickle","2c78168a":"pickle.dump(all_prices, open('all_prices.pkl', 'wb'))","ebe05e3f":"This is a forked version of another person's public kernel.  \nThe original author had lost his account.  \nIn the interest of fairness, I'm making it public.  \n\nDeleted Topic  \n[https:\/\/www.kaggle.com\/c\/optiver-realized-volatility-prediction\/discussion\/256725]"}}