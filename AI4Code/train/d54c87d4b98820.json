{"cell_type":{"3cfe7575":"code","d02e5d20":"code","970b7b20":"code","23ad82fb":"code","50ad323f":"code","c681875c":"code","b630443a":"code","89eeca34":"code","d6148821":"code","31290bfa":"code","5fe4d481":"code","33a47a57":"code","641dbbea":"code","b490d883":"code","d4682e1d":"code","300c6695":"code","53b64b44":"code","979c66fc":"code","cb1ac17d":"code","0341cbf4":"code","320c0878":"code","1643daa0":"code","0e5e127c":"code","98042ad3":"code","5f0e326e":"code","69d4cadc":"code","51bacedd":"markdown","c0b3e16f":"markdown","50ce9740":"markdown","739aefba":"markdown","919a3c3d":"markdown","e69a4082":"markdown"},"source":{"3cfe7575":"import pandas as pd \nimport numpy as np\nimport pydicom\nimport matplotlib.pyplot as plt \nimport re\nimport random","d02e5d20":"# data paths \n# (put img_paths into df table so can be sorted and join with patient_paths id)\n\n# img_train_paths\nimg_train_paths_df = pd.DataFrame(columns=['id', 'img_path', 'path_num'])\n\nimg_train_path = '\/kaggle\/input\/osic-pulmonary-fibrosis-progression\/train\/'\n\nfor folder in os.listdir(img_train_path):\n    id_folder = str(folder)\n    for file in os.listdir(img_train_path + folder):\n        path_file = img_train_path + str(folder) + '\/' + file\n        path_num = int(str(file).replace('.dcm', '')) # cast to int\n        img_train_paths_df = img_train_paths_df.append(\n            {'id': id_folder, 'img_path': path_file, 'path_num': path_num}, ignore_index=True)\n\nimg_train_paths_df = img_train_paths_df.sort_values(\n        by=['id', 'path_num'], axis=0) # IMPT: sort by id then path_num for sequential cross-section scan img for each id\nimg_train_paths_df = img_train_paths_df.drop(columns=['path_num'], axis=1) # drop path_num used for sort\nimg_train_paths_df = img_train_paths_df.reset_index(drop=True)\nimg_train_paths_df","970b7b20":"# img_test_paths\nimg_test_paths_df = pd.DataFrame(columns=['id', 'img_path', 'path_num'])\n\nimg_test_path = '\/kaggle\/input\/osic-pulmonary-fibrosis-progression\/test\/'\n\nfor folder in os.listdir(img_test_path):\n    id_folder = str(folder)\n    for file in os.listdir(img_test_path + folder):\n        path_file = img_test_path + str(folder) + '\/' + file\n        path_num = int(str(file).replace('.dcm', '')) # cast to int\n        img_test_paths_df = img_test_paths_df.append(\n            {'id': id_folder, 'img_path': path_file, 'path_num': path_num}, ignore_index=True)\n\nimg_test_paths_df = img_test_paths_df.sort_values(\n        by=['id', 'path_num'], axis=0) # IMPT: sort by id then path_num for sequential cross-section scan img for each id\nimg_test_paths_df = img_test_paths_df.drop(columns=['path_num'], axis=1) # drop path_num used for sort\nimg_test_paths_df = img_test_paths_df.reset_index(drop=True)\nimg_test_paths_df","23ad82fb":"# patient train test paths\npatient_train_df = pd.read_csv('\/kaggle\/input\/osic-pulmonary-fibrosis-progression\/train.csv')\npatient_test_df = pd.read_csv('\/kaggle\/input\/osic-pulmonary-fibrosis-progression\/train.csv')\n\n# IMPT: get first week of patient data only because CT scan images done on first week\npatient_train_df = patient_train_df.groupby('Weeks').first().reset_index()\npatient_test_df = patient_test_df.groupby('Weeks').first().reset_index()\n\npatient_train_df = patient_train_df.drop(columns=['Weeks']) # drop Weeks\npatient_test_df = patient_test_df.drop(columns=['Weeks'])\n\n# rename Patient to 'id' for join\nrename_columns = patient_train_df.columns.tolist()\nrename_columns[0] = 'id'\n\npatient_train_df.columns = rename_columns\npatient_test_df.columns = rename_columns\n\npatient_test_df","50ad323f":"# change id string to float (not int as it will cause overflow) for faster join\nimg_train_paths_df['id'] = img_train_paths_df['id'].replace('ID', '', regex=True).astype(float)\nimg_test_paths_df['id'] = img_test_paths_df['id'].replace('ID', '', regex=True).astype(float)\npatient_train_df['id'] = patient_train_df['id'].replace('ID', '', regex=True).astype(float)\npatient_test_df['id'] = patient_test_df['id'].replace('ID', '', regex=True).astype(float)\n\npatient_test_df","c681875c":"# left join subset patient_train_df with img_train_paths_df by id\nX_train_df = patient_train_df.merge(img_train_paths_df, on=['id'], how='left') # merge joins on non-string columns vs join which throws error \nX_test_df = patient_test_df.merge(img_test_paths_df, on=['id'], how='left')\n\nX_test_df","b630443a":"# plot lung cross-section scan of following categories:\n# (1) Healthy and never smoked (benchmark): a patient with FVC percentage='high' >= 70 (i.e. no pulmonary fibrosis), and SmokingStatus='Never smoked'\n# (2) Healthy and smoked: a patient with FVC percentage='high' >= 70 (i.e. no pulmonary fibrosis), and SmokingStatus='Ex-smoker'\n# (3) Not healthy and smoked: a patient with FVC percentage='low' <= 50 (i.e. have pulmonary fibrosis), and SmokingStatus='Ex-smoker'\n# (4) Not healthy and never smoked: a patient with FVC percentage='low' <= 50 (i.e. have pulmonary fibrosis), and SmokingStatus='Never smoked'\n\n# (1) Healthy and never smoked (benchmark): a patient with FVC percentage='high' (i.e. no pulmonary fibrosis), and SmokingStatus='Never smoked'\ncategory_1 = X_train_df[(X_train_df['Percent'] >= 70) & (X_train_df['SmokingStatus'] == 'Never smoked')] \n\nimg_plt_df_1 = category_1\nplt_index_1 = random.randint(0, img_plt_df_1.shape[0])\nimg_plt_df_1 = img_plt_df_1[img_plt_df_1['id'] == img_plt_df_1.iloc[plt_index_1]['id']]\nimg_plt_df_1","89eeca34":"# (2) Healthy and smoked: a patient with FVC percentage='high' >= 70 (i.e. no pulmonary fibrosis), and SmokingStatus='Ex-smoker'\ncategory_2 = X_train_df[(X_train_df['Percent'] >= 70) & (X_train_df['SmokingStatus'] == 'Ex-smoker')] \n\nimg_plt_df_2 = category_2\nplt_index_2 = random.randint(0, img_plt_df_2.shape[0])\nimg_plt_df_2 = img_plt_df_2[img_plt_df_2['id'] == img_plt_df_2.iloc[plt_index_2]['id']]\nimg_plt_df_2","d6148821":"# (3) Not healthy and smoke: a patient with FVC percentage='low' <= 50 (i.e. have pulmonary fibrosis), and SmokingStatus='Ex-smoker'\ncategory_3 = X_train_df[(X_train_df['Percent'] <= 50) & (X_train_df['SmokingStatus'] == 'Ex-smoker')] \n\nimg_plt_df_3 = category_3\nplt_index_3 = random.randint(0, img_plt_df_3.shape[0])\nimg_plt_df_3 = img_plt_df_3[img_plt_df_3['id'] == img_plt_df_3.iloc[plt_index_3]['id']]\nimg_plt_df_3","31290bfa":"# (4) Not healthy and smoke: a patient with FVC percentage='low' <= 50 (i.e. have pulmonary fibrosis), and SmokingStatus='Never smoked'\ncategory_4 = X_train_df[(X_train_df['Percent'] <= 50) & (X_train_df['SmokingStatus'] == 'Never smoked')] \n\nimg_plt_df_4 = category_4\nplt_index_4 = random.randint(0, img_plt_df_4.shape[0])\nimg_plt_df_4 = img_plt_df_4[img_plt_df_4['id'] == img_plt_df_4.iloc[plt_index_4]['id']]\nimg_plt_df_4","5fe4d481":"# plot img_df\n\ndef plot_img_df(img_plt_df, title):\n    f, plots = plt.subplots(2, 2, figsize=(15,15)) # set figsize to clear (15, 15)\n\n    # get four cross sections: 1\/4, 1\/3, 1\/2, 1\/1.5\n    ix_1 = int(img_plt_df.shape[0]\/4)\n    ix_2 = int(img_plt_df.shape[0]\/3)\n    ix_3 = int(img_plt_df.shape[0]\/2)\n    ix_4 = int(img_plt_df.shape[0]\/1.5)\n\n    img_1 = pydicom.read_file(img_plt_df['img_path'].values[ix_1])\n    img_2 = pydicom.read_file(img_plt_df['img_path'].values[ix_2])\n    img_3 = pydicom.read_file(img_plt_df['img_path'].values[ix_3])\n    img_4 = pydicom.read_file(img_plt_df['img_path'].values[ix_4])\n\n    img_1_arr = img_1.pixel_array\n    img_2_arr = img_2.pixel_array\n    img_3_arr = img_3.pixel_array\n    img_4_arr = img_4.pixel_array\n\n    plots[0, 0].set_title('1\/4 from top', fontsize=15)\n    plots[0, 1].set_title('1\/3 from top', fontsize=15)\n    plots[1, 0].set_title('1\/2 from top', fontsize=15)\n    plots[1, 1].set_title('1\/1.5 from top', fontsize=15)\n\n    print(title)\n\n    plots[0, 0].imshow(img_1_arr, cmap='bone')\n    plots[0, 1].imshow(img_2_arr, cmap='bone')\n    plots[1, 0].imshow(img_3_arr, cmap='bone')\n    plots[1, 1].imshow(img_4_arr, cmap='bone')","33a47a57":"# (1) Healthy and never smoked (benchmark): a patient with FVC percentage='high' >= 70 (i.e. no pulmonary fibrosis), and SmokingStatus='Never smoked'\nplot_img_df(img_plt_df_1, \n            title=\"(1) Healthy and never smoked (benchmark): a patient with FVC percentage='high' >= 70 (i.e. no pulmonary fibrosis), and SmokingStatus='Never smoked'\")","641dbbea":"# (2) Healthy and smoked: a patient with FVC percentage='high' >= 70 (i.e. no pulmonary fibrosis), and SmokingStatus='Ex-smoker'\nplot_img_df(img_plt_df_2, \n            title=\"(2) Healthy and smoked: a patient with FVC percentage='high' >= 70 (i.e. no pulmonary fibrosis), and SmokingStatus='Ex-smoker'\")","b490d883":"# (3) Not healthy and smoked: a patient with FVC percentage='low' <= 50 (i.e. have pulmonary fibrosis), and SmokingStatus='Ex-smoker'\nplot_img_df(img_plt_df_3, \n            title=\"(3) Not healthy and smoked: a patient with FVC percentage='low' <= 50 (i.e. have pulmonary fibrosis), and SmokingStatus='Ex-smoker'\")","d4682e1d":"# (4) Not healthy and never smoked: a patient with FVC percentage='low' <= 50 (i.e. have pulmonary fibrosis), and SmokingStatus='Never smoked'\nplot_img_df(img_plt_df_4, \n            title=\"(4) Not healthy and never smoked: a patient with FVC percentage='low' <= 50 (i.e. have pulmonary fibrosis), and SmokingStatus='Never smoked'\")","300c6695":"# make video of lung cross-section scan of patient\nimport matplotlib.animation as animation\nfrom IPython.display import HTML\n    \ndef create_img_video(img_plt_df):\n    fig = plt.figure(figsize=(7, 7))\n\n    imgs_anim = []\n    for index,row in img_plt_df.iterrows():\n        img = pydicom.read_file(row['img_path'])\n        img_arr = img.pixel_array\n        img_anim = plt.imshow(img_arr, animated=True, cmap=plt.cm.bone)\n        plt.axis('off')\n        imgs_anim.append([img_anim])\n\n    anim = animation.ArtistAnimation(fig, imgs_anim, interval=25, blit=False, repeat_delay=1000)\n    \n    return anim","53b64b44":"# (1) Healthy and never smoked (benchmark): a patient with FVC percentage='high' >= 70 (i.e. no pulmonary fibrosis), and SmokingStatus='Never smoked'\nanim = create_img_video(img_plt_df_1) \ntitle = \"(1) Healthy and never smoked (benchmark): a patient with FVC percentage='high' >= 70 (i.e. no pulmonary fibrosis), and SmokingStatus='Never smoked'\"\nprint(title)\nHTML(anim.to_html5_video())","979c66fc":"# (2) Healthy and smoked: a patient with FVC percentage='high' >= 70 (i.e. no pulmonary fibrosis), and SmokingStatus='Ex-smoker'\nanim = create_img_video(img_plt_df_2) \ntitle = \"(2) Healthy and smoked: a patient with FVC percentage='high' >= 70 (i.e. no pulmonary fibrosis), and SmokingStatus='Ex-smoker'\"\nprint(title)\nHTML(anim.to_html5_video())","cb1ac17d":"# (3) Not healthy and smoked: a patient with FVC percentage='low' <= 50 (i.e. have pulmonary fibrosis), and SmokingStatus='Ex-smoker'\n# \n# (as you can see, not healthy lung has larger areas of aveoli strands (NOT bronchi strands) for large vertical areas i.e. for longer video \n#  seconds vs healthy lung as the unhealhty aveolis are inflammed or enlarged and more spread out vs healthy)\n\nanim = create_img_video(img_plt_df_3) \ntitle = \"(3) Not healthy and smoked: a patient with FVC percentage='low' <= 50 (i.e. have pulmonary fibrosis), and SmokingStatus='Ex-smoker'\"\nprint(title)\nHTML(anim.to_html5_video())","0341cbf4":"# (4) Not healthy and never smoked: a patient with FVC percentage='low' <= 50 (i.e. have pulmonary fibrosis), and SmokingStatus='Never smoked'\nanim = create_img_video(img_plt_df_3) \ntitle = \"(4) Not healthy and never smoked: a patient with FVC percentage='low' <= 50 (i.e. have pulmonary fibrosis), and SmokingStatus='Never smoked'\"\nprint(title)\nHTML(anim.to_html5_video())","320c0878":"# plot histogram of above categories of interest:\n# (1) Healthy and never smoked (benchmark): a patient with FVC percentage='high' >= 70 (i.e. no pulmonary fibrosis), and SmokingStatus='Never smoked'\n# (2) Healthy and smoked: a patient with FVC percentage='high' >= 70 (i.e. no pulmonary fibrosis), and SmokingStatus='Ex-smoker'\n# (3) Not healthy and smoked: a patient with FVC percentage='low' <= 50 (i.e. have pulmonary fibrosis), and SmokingStatus='Ex-smoker'\n# (4) Not healthy and never smoked: a patient with FVC percentage='low' <= 50 (i.e. have pulmonary fibrosis), and SmokingStatus='Never smoked'\n\ncategory_df = X_train_df\n\ncategory_df.loc[category_1.index,'category'] = '(1)' # IMPT: use 'category'.index not img_plt_df\ncategory_df.loc[category_2.index,'category'] = '(2)'\ncategory_df.loc[category_3.index,'category'] = '(3)'\ncategory_df.loc[category_4.index,'category'] = '(4)'\ncategory_df.loc[pd.isnull(category_df['category']) == True, 'category'] = 'Others'\n\nplt.hist(category_df['category'])","1643daa0":"# get % counts \n\nprint(\"Category\")\ncategory_df['category'].value_counts() \/ category_df.shape[0] * 100","0e5e127c":"# plot histogram of variables\n\nf, plots = plt.subplots(3, 2, figsize=(15, 15))\n\nplots[0, 0].set_title('FVC', fontsize=15)\nplots[0, 1].set_title('Percent', fontsize=15)\nplots[1, 0].set_title('Age', fontsize=15)\nplots[1, 1].set_title('Sex', fontsize=15)\nplots[2, 0].set_title('SmokingStatus', fontsize=15)\n\nplots[0, 0].hist(X_train_df['FVC'])\nplots[0, 1].hist(X_train_df['Percent'])\nplots[1, 0].hist(X_train_df['Age'])\nplots[1, 1].hist(X_train_df['Sex'])\nplots[2, 0].hist(X_train_df['SmokingStatus'])","98042ad3":"# get % counts of discrete variables\n\nprint(\"Sex\")\nX_train_df['Sex'].value_counts() \/ X_train_df.shape[0] * 100","5f0e326e":"# get % counts of discrete variables\n\nprint(\"SmokingStatus\")\nX_train_df['SmokingStatus'].value_counts() \/ X_train_df.shape[0] * 100","69d4cadc":"# print mode\nfrom scipy import stats\n\nprint(\"Mode FVC: \", stats.mode(X_train_df['FVC']))\nprint(\"Mode Percent: \", stats.mode(X_train_df['Percent']))\nprint(\"Mode Age: \", stats.mode(X_train_df['Age']))\nprint(\"Mode Sex: \", stats.mode(X_train_df['Sex']))\nprint(\"Mode SmokingStatus: \", stats.mode(X_train_df['SmokingStatus']))","51bacedd":"### Not healthy lung has larger areas of aveoli strands (not bronchi strands) for large vertical areas i.e. for longer video seconds vs healthy lung as the unhealhty aveolis are inflammed or enlarged and more spread out vs healthy","c0b3e16f":"## Exploratory Data Analysis (EDA)","50ce9740":"### Data have a lot of Ex-smokers, mostly Male, mostly Age 69","739aefba":"![mcdc7_pulmonaryfibrosis-8col.webp](attachment:mcdc7_pulmonaryfibrosis-8col.webp)","919a3c3d":"## Prepare data and image paths","e69a4082":"### As you can see, not healthy lung has larger areas of aveoli strands (not bronchi strands) for large vertical areas i.e. for longer video seconds (video below) vs healthy lung as the unhealhty aveolis are inflammed or enlarged and more spread out vs healthy"}}