{"cell_type":{"405281ad":"code","dccfba1d":"code","7b4654a9":"code","679a9b37":"code","89c77ec8":"code","58182640":"code","d42d5dab":"code","0840674a":"code","2347c9d5":"code","34275bcc":"code","07080f06":"code","454e6951":"code","2a64fba4":"code","f082f533":"code","93174e6a":"code","43fe1c5b":"code","e980a845":"code","fe8118df":"code","e4268110":"code","ec4f5b98":"code","df3909f2":"code","5ca1516a":"code","cdf0917c":"code","f240ab1b":"code","ceb8f965":"code","93d095a9":"code","0b0270a8":"code","0da173e2":"code","03cdc4f1":"code","2dee633c":"code","dd46e582":"code","b6228b7b":"code","0c9ae4d0":"code","5742ba71":"code","66937764":"markdown","ca0d9dc6":"markdown","806ec72f":"markdown","a3637ca4":"markdown","0be7e55a":"markdown","30067f66":"markdown","579cc9be":"markdown","cdd2a05a":"markdown","22f74a82":"markdown","f0280c8b":"markdown","bde30b94":"markdown","86328fa0":"markdown","e0884ea3":"markdown","6b901a78":"markdown","0f79fd6d":"markdown","06c2a47a":"markdown","fa0b7aff":"markdown","fa11f74a":"markdown","542c50fb":"markdown","58b3e33e":"markdown","66af46c0":"markdown","3020aad9":"markdown","92ca3795":"markdown","9583d107":"markdown","fb7fd3d0":"markdown","ba0f48ae":"markdown","28b7508e":"markdown","17179727":"markdown","2992a8c1":"markdown"},"source":{"405281ad":"import numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\nimport seaborn as sns\nimport matplotlib.pyplot as plt","dccfba1d":"df = pd.read_csv('\/kaggle\/input\/brasilian-houses-to-rent\/houses_to_rent_v2.csv')\n\nnew_column_names = {'hoa (R$)':'hoa',\n                    'rent amount (R$)': 'rent_amount',\n                    'property tax (R$)':'property_tax',\n                    'fire insurance (R$)':'fire_insurance',\n                    'total (R$)':'total',\n                    'parking spaces': 'parking_spaces'}\n\ndf = df.rename(new_column_names, axis='columns')\ndf.head()","7b4654a9":"df.shape","679a9b37":"df.dtypes","89c77ec8":"df_copy = df.copy()\ndf_copy['floor'].replace('-',0, inplace=True)\ndf_copy['floor'] = df_copy['floor'].astype('int')","58182640":"df.groupby(['city'])['city'].aggregate(lambda x: x.count()\/ 10692).plot(kind='pie',autopct='%.2f',fontsize=11);","d42d5dab":"df.groupby(['city'])['area'].aggregate(lambda x: x.mean()).plot(kind='bar',color=['r','g','b','y','c']\\\n    , ylabel='Average area', title='Average area in a city', fontsize=12);","0840674a":"df.groupby(['city'])['rooms'].aggregate(lambda x: x.max()).plot(kind='barh',color=['r','g','b','y','c']\\\n    ,xlabel='City', title='Maximum number of rooms of a house in each city', fontsize=12);","2347c9d5":"df.groupby(['city'])['rooms'].aggregate(lambda x: x.mean()).plot(kind='barh',color=['r','g','b','y','c']\\\n    ,xlabel='City', title='Average number of rooms of a house in each city', fontsize=12);","34275bcc":"df.groupby(['city'])['bathroom'].aggregate(lambda x: x.max()).plot(kind='barh',color=['r','g','b','y','c']\\\n    ,xlabel='City', title='Maximum number of bathrooms of a house in each city', fontsize=12);","07080f06":"df.groupby(['city'])['bathroom'].aggregate(lambda x: x.mean()).plot(kind='barh',color=['r','g','b','y','c']\\\n    ,xlabel='City', title='Average number of bathrooms of a house in each city', fontsize=12);","454e6951":"df_copy.groupby(['city'])['floor'].aggregate(lambda x: x.mean()).plot(kind='barh',color=['r','g','b','y','c']\\\n    ,xlabel='City', title='Average number of floors of a house in each city', fontsize=12);","2a64fba4":"fig, axes = plt.subplots(1,2, figsize=(14,5))\n\nsns.countplot(x='city', hue='animal', data=df, palette=sns.color_palette(), ax=axes[0]);\nsns.countplot(x='city', hue='furniture', data=df, palette='Set1', ax=axes[1]);","f082f533":"sns.heatmap(df.groupby(['animal','furniture']).size().unstack(), annot=True, fmt=\"d\");","93174e6a":"fig, axes = plt.subplots(1,2, figsize=(14,5))\nsns.scatterplot(data=df, y='fire_insurance', x='rent_amount', hue=\"furniture\", ax=axes[0]);\nsns.scatterplot(data=df, y='fire_insurance', x='rent_amount', hue=\"animal\", ax=axes[1]);","43fe1c5b":"fig, axes = plt.subplots(1,2, figsize=(16,5))\nsns.scatterplot(data=df, y=np.log(df['area']), x=np.log(df['rent_amount']), hue=\"furniture\", ax=axes[0]);\nsns.scatterplot(data=df, y=np.log(df['area']), x=np.log(df['rent_amount']), hue=\"animal\", ax=axes[1]);","e980a845":"df_copy['area'].sort_values().values[-10:]","fe8118df":"fig, axes = plt.subplots(2,2, figsize=(18,8), sharex=True)\nlist_of_metrics = [['rent_amount','hoa'],['property_tax','fire_insurance']]\n\ndef bar_plot_func(ax, metric):\n    df.groupby(['city'])[f'{metric}'].aggregate(lambda x: x.mean()).plot(kind='bar',color=['r','g','b','y','c']\\\n    , ylabel='Average ' + f'{metric}', title='Average ' + f'{metric}' + ' in a city', fontsize=10, ax=ax);\n    \nbar_plot_func(axes[0,0],list_of_metrics[0][0])\nbar_plot_func(axes[0,1],list_of_metrics[0][1])\nbar_plot_func(axes[1,0],list_of_metrics[1][0])\nbar_plot_func(axes[1,1],list_of_metrics[1][1])","e4268110":"list_of_metrics = [['parking_spaces','rooms'], ['bathroom', 'city']]\n\ndef box_plot_func(ax, metric):\n    df.boxplot(column='rent_amount', by=f'{metric}', fontsize=12, ax=ax);\n    ax.set_title(\"Boxplot of Rent amount by \" + f\"{metric}\")\n    ax.set_xlabel(f\"{metric}\")\n    ax.set_ylabel('Rent amount')\n    plt.suptitle(\"\")\n\n    \nfig, axes = plt.subplots(2,2, figsize=(16,13))\n\nbox_plot_func(axes[0,0], list_of_metrics[0][0])\nbox_plot_func(axes[0,1], list_of_metrics[0][1])\nbox_plot_func(axes[1,0], list_of_metrics[1][0])\nbox_plot_func(axes[1,1], list_of_metrics[1][1])","ec4f5b98":"df_copy.dtypes","df3909f2":"df_copy.isna().sum()","5ca1516a":"from sklearn.model_selection import train_test_split\n\ndel df_copy['total']\nx, y = df_copy.drop('rent_amount',axis=1), df_copy['rent_amount']\nx_train, x_test, y_train, y_test = train_test_split(x, y, test_size=0.2)\nprint(f'X_train shape: {x_train.shape}, X_test shape: {x_test.shape}')","cdf0917c":"from sklearn.preprocessing import LabelEncoder\n\nle = LabelEncoder()\nx_train.loc[:,'city'] = le.fit_transform(x_train['city'])\nx_test.loc[:,'city'] = le.transform(x_test['city'])\n\nx_train.loc[:,'animal'] = le.fit_transform(x_train['animal'])\nx_test.loc[:,'animal'] = le.transform(x_test['animal'])\n\nx_train.loc[:,'furniture'] = le.fit_transform(x_train['furniture'])\nx_test.loc[:,'furniture'] = le.transform(x_test['furniture'])","f240ab1b":"sns.pairplot(x_train);","ceb8f965":"formula_str = x_train.columns[-1]+ ' ~ '+ ' + '.join(x_train.columns[:-1])\nformula_str","93d095a9":"import statsmodels.formula.api as sm\n\nlm = sm.ols(formula=formula_str,data=x_train)\n\nfitted = lm.fit()","0b0270a8":"print(fitted.summary())","0da173e2":"plt.figure(figsize=(8,5))\np=plt.scatter(x=fitted.fittedvalues,y=fitted.resid,edgecolor='k')\nxmin=min(fitted.fittedvalues)\nxmax = max(fitted.fittedvalues)\nplt.hlines(y=0,xmin=xmin*0.9,xmax=xmax*1.1,color='red',linestyle='--',lw=3)\nplt.xlabel(\"Fitted values\",fontsize=15)\nplt.ylabel(\"Residuals\",fontsize=15)\nplt.title(\"Fitted vs. residuals plot\",fontsize=18)\nplt.grid(True)\nplt.show()","03cdc4f1":"plt.figure(figsize=(8,5))\nplt.hist(fitted.resid_pearson,bins=20,edgecolor='k')\nplt.ylabel('Count',fontsize=15)\nplt.xlabel('Normalized residuals',fontsize=15)\nplt.title(\"Histogram of normalized residuals\",fontsize=18)\nplt.show()","2dee633c":"from numpy import mean, absolute\nfrom sklearn.model_selection import cross_val_score, cross_validate\nfrom sklearn.model_selection import KFold\nfrom sklearn.pipeline import Pipeline\nfrom sklearn.linear_model import HuberRegressor, LinearRegression\nfrom sklearn.preprocessing import PowerTransformer, StandardScaler, MinMaxScaler\nfrom sklearn.compose import TransformedTargetRegressor\n\n# prepare the model with input scaling\npipeline = Pipeline(steps=[('power', PowerTransformer()), ('model', HuberRegressor())])\n# prepare the model with target scaling\nmodel = TransformedTargetRegressor(regressor=pipeline, transformer=PowerTransformer())\n# evaluate model\ncv = KFold(n_splits=10, shuffle=True, random_state=1)\nscores = cross_validate(model, x_train, y_train, scoring=['neg_root_mean_squared_error', 'r2'], cv=cv, n_jobs=-1)\nmean_mae = mean(absolute(scores['test_neg_root_mean_squared_error']))\nmean_r2 = mean(absolute(scores['test_r2']))\n\nprint(f'Mean MAE: {mean_mae:.3f}, R2: {mean_r2:.3f}')","dd46e582":"from sklearn.tree import DecisionTreeRegressor\nfrom sklearn.metrics import mean_absolute_error, r2_score\n\ndef dart(*args):\n    x_train, x_test, y_train, y_test = args\n    model = DecisionTreeRegressor()\n    model.fit(x_train, y_train)\n    y_pred = model.predict(x_test)\n    print(f'RMAE: {mean_absolute_error(y_test, y_pred)**.5:.3f}, R-squared: {r2_score(y_test, y_pred):.3f}')\n\ndart(x_train, x_test, y_train, y_test)","b6228b7b":"from sklearn.ensemble import IsolationForest\n\niso = IsolationForest(contamination=0.0001)\nyhat = iso.fit_predict(x_train)\n# select all rows that are not outliers\nmask = yhat != -1\nX_train, Y_train = x_train[mask], y_train[mask]\ndart(X_train, x_test, Y_train, y_test)","0c9ae4d0":"from sklearn.covariance import EllipticEnvelope\n\nee = IsolationForest(contamination=0.001)\nyhat = ee.fit_predict(x_train)\n# select all rows that are not outliers\nmask = yhat != -1\nX_train, Y_train = x_train[mask], y_train[mask]\ndart(X_train, x_test, Y_train, y_test)","5742ba71":"from sklearn.neighbors import LocalOutlierFactor\n\nlof = LocalOutlierFactor(contamination=0.001)\nyhat = lof.fit_predict(x_train)\n# select all rows that are not outliers\nmask = yhat != -1\nX_train, Y_train = x_train[mask], y_train[mask]\ndart(X_train, x_test, Y_train, y_test)","66937764":"#### Data Transformation","ca0d9dc6":"#### Local Outlier Factor: resulted in a better performance","806ec72f":"#### Loading dataset","a3637ca4":"#### Maximum number of rooms of a house in each city","0be7e55a":"#### It is also evident that 60 percent of all houses are not furnished and do accept animals","30067f66":"#### Train\/Test split","579cc9be":"#### Average number of bathrooms of a house in each city","cdd2a05a":"The Durbin Watson (DW) statistic is a test for autocorrelation in the residuals from a statistical regression analysis. A value of <b> 2.0 means that there is no autocorrelation detected in the sample<\/b>.","22f74a82":"#### Maximum number of bathrooms of a house in each city","f0280c8b":"#### Average number of rooms of a house in each city","bde30b94":"### Does rental housing differ from city to city\n#### Hoa, Fire Insurance, and Property Tax impact on Rent Amount","86328fa0":"#### What is the average area of a house in each city","e0884ea3":"#### fire insurance relationship with rent amount","6b901a78":"#### Boxplot of Rent amount by (Parking spaces, Bathroom, Room, City)\n- Does housing rent increases when the # of bathrooms increases?\n- Does housing rent increases when the # of rooms increases?\n- Does housing rent increases when the # of parking spaces increases?","0f79fd6d":"### Automatic Outlier Detection\nOur baseline model: decision tree regressor","06c2a47a":"#### It is evident that most of the houses accept animals and most of the houses are not furnished","fa0b7aff":"### Regression models are sensitive to feature scaling","fa11f74a":"#### I stick with Local Outlier Factor because it has a better performance overall.","542c50fb":"#### 46335 square meters !!!!","58b3e33e":"#### What is the most popular city among brazilians","66af46c0":"#### rent amount relationship with area -> log-transformed dependency\n- It can be seen from the plots that there are several outliers in our dataset","3020aad9":"Not all p-values are significant, so we should remove the non-significant features from the model and test it again. The nong-significant values indicate that there is insufficient evidence in your sample to conclude that a non-zero correlation exists.","92ca3795":"#### Isolation Forest -> resulted in better performance","9583d107":"#### Minimum Covariance Determinant -> resulted in even better performance:)\n- Due to central limit theorem, we can say that our input has Gaussian distribution so we can use MCD","fb7fd3d0":"<b>violation of the constant variance assumption - Heteroscedasticity <\/b>","ba0f48ae":"#### Data types","28b7508e":"#### Check for Nan values","17179727":"#### It can be inferred from the above results, we need to change our baseline model","2992a8c1":"#### Average number of floors of a house in each city"}}