{"cell_type":{"8c32360d":"code","74b872be":"code","72ad7602":"code","4812024d":"code","24159a02":"code","616019e5":"code","c55c4774":"code","e060c270":"code","d40429af":"code","9aaab0a2":"code","09068f09":"code","1a3f13e0":"code","a7001c4e":"code","591f1255":"code","d4835b7e":"code","77615927":"code","ddce5809":"code","5f03a302":"code","5bdf7ea8":"code","46e3b428":"code","36a1729a":"code","f82be439":"code","ccb149f1":"code","ce559dd4":"code","530175a7":"markdown","43259e13":"markdown","e6ad2297":"markdown","e8799acc":"markdown","272abca2":"markdown","a7ba60f6":"markdown","56219f7f":"markdown","9f389a55":"markdown","47a8de96":"markdown","6cd67135":"markdown","1b139b08":"markdown","690b184a":"markdown"},"source":{"8c32360d":"import numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\nimport os\n\nimport ast\nimport cv2\nimport matplotlib.pyplot as plt\n%matplotlib inline","74b872be":"train = pd.read_csv('..\/input\/ranzcr-clip-catheter-line-classification\/train.csv')\ntrain_annotations = pd.read_csv('..\/input\/ranzcr-clip-catheter-line-classification\/train_annotations.csv')","72ad7602":"trncols = train.columns.values\ntarget_cols = trncols[1:-1]  # Target Columns from train","4812024d":"tbif = pd.read_csv('..\/input\/ranzcr-clip-tracheal-bifurcation\/RANZCR_CLiP_tracheal_bifurcation.csv')\nlen(tbif)  # all entries in train","24159a02":"tbif.head()","616019e5":"tbif5k = pd.read_json('..\/input\/5k-trachea-bifurcation-on-chest-xray\/trachea_annotations.json', orient='index')\ntbif5k.reset_index(drop=True, inplace=True)\nlen(tbif5k)","c55c4774":"# add StudyInstanceUID from jpg filename\ntbif5k['StudyInstanceUID'] = tbif5k['filename'].apply(lambda x: x.split('.jpg')[0])","e060c270":"def get_point_xy(x):\n    cx = 0\n    cy = 0\n    # skip empty regions\n    if len(x)>=1:\n        xd = x[0]  # dict from regions   \n        cx = xd['shape_attributes']['cx'] \n        cy = xd['shape_attributes']['cy']\n   \n    return pd.Series([cx,cy])","d40429af":"# note 2 entries with empty regions - set cx cy columns as 0s default\ntbif5k['cx'] = 0\ntbif5k['cy'] = 0\n\ntbif5k[['cx', 'cy']] = tbif5k.apply(lambda row: get_point_xy(row.regions), axis=1)\ntbif5k.head()","9aaab0a2":"tbif5kout = tbif5k.copy()\ntbif5kout.drop(['filename', 'size', 'regions', 'file_attributes'], axis=1, inplace=True)\ntbif5kout = pd.merge(tbif5kout, tbif, on=['StudyInstanceUID'], how='left')\ntbif5kout.head()","09068f09":"tbif5kout.to_csv('ranzcr_5K_tracheal_bifurcation_annotations.csv', index=False)","1a3f13e0":"tbif5kout = pd.merge(tbif5kout, train, on=['StudyInstanceUID'], how='left')\ntbif5kout.head()","a7001c4e":"def f_table(list1):\n    table_dic = {}\n    for i in list1:\n        if i not in table_dic.keys():\n            table_dic[i] = 1\n        else:\n            table_dic[i] += 1\n    return(table_dic)","591f1255":"tar_freq = np.array([np.min(list(f_table(tbif5kout[target_cols].iloc[:,i]).values())) for i in range(len(target_cols))])\ntbif5ktarg = pd.DataFrame(\n                {                \n                'target' : target_cols,\n                'count' : tar_freq,                     \n                })    \ntbif5ktarg.head(11)","d4835b7e":"# ETT UIDs in 5K\nabnorm5k_uid = tbif5kout.loc[tbif5kout['ETT - Abnormal']==1,'StudyInstanceUID'].tolist()\nborder5k_uid = tbif5kout.loc[tbif5kout['ETT - Borderline']==1, 'StudyInstanceUID'].tolist()  \nnorm5k_uid   = tbif5kout.loc[tbif5kout['ETT - Normal']==1,'StudyInstanceUID'].tolist()","77615927":"# ETT UIDS in annotations for borderline\nborderann_uid = train_annotations.loc[train_annotations.label=='ETT - Borderline', 'StudyInstanceUID'].tolist() \nbordset = (set(borderann_uid).intersection(set(border5k_uid)))\nborderlist = list(bordset)\nlen(borderlist)","ddce5809":"# ETT UIDS in annotations for Normal\nnormann_uid = train_annotations.loc[train_annotations.label=='ETT - Normal', 'StudyInstanceUID'].tolist() \nnormset = (set(normann_uid).intersection(set(norm5k_uid)))\nnormlist = list(normset)\nlen(normlist)","5f03a302":"# ref https:\/\/www.kaggle.com\/raddar\/simple-ett-bifurcation-visualization\ndef plot_xray(StudyInstanceUID, label):\n    \"\"\"\n    intubation as green (if annotation exists)\n    bifurcation as red (from raddar's predicted tracheal bifurcation)\n    bifurc 5k as blue (from 5k annotations)\n    \"\"\"\n    has_annot = len(train_annotations.loc[(train_annotations.StudyInstanceUID==StudyInstanceUID) & (train_annotations.label==label)] )\n    img = cv2.imread('..\/input\/ranzcr-clip-catheter-line-classification\/train\/'+StudyInstanceUID+'.jpg')\n    bifurc_5k = (tbif5kout.loc[tbif5kout.StudyInstanceUID==StudyInstanceUID,['cx', 'cy']].values[0])\n    bifurcation = ast.literal_eval(tbif5kout.loc[tbif5kout.StudyInstanceUID==StudyInstanceUID,'tracheal_bifurcation'].values[0])\n    if has_annot > 0:\n        intubation = ast.literal_eval(train_annotations.loc[(train_annotations.StudyInstanceUID==StudyInstanceUID) & (train_annotations.label==label),'data'].values[0])[0]\n        img = cv2.circle(img, tuple(intubation), 50, (0,255,0), 10)\n    img = cv2.circle(img, tuple(bifurcation), 50, (255,0,0), 10)        \n    img = cv2.circle(img,(bifurc_5k[0], bifurc_5k[1]),50,(0,0,255), 10)  \n    \n    plt.figure(figsize=(12,12))\n    plt.title(label = (StudyInstanceUID + '   ' + label))\n    \n    plt.imshow(img)","5bdf7ea8":"plot_xray(abnorm5k_uid[1],'ETT - Abnormal' )","46e3b428":"plot_xray(abnorm5k_uid[5],'ETT - Abnormal' )","36a1729a":"plot_xray(borderlist[30],'ETT - Borderline' )","f82be439":"plot_xray(borderlist[55],'ETT - Borderline' )","ccb149f1":"plot_xray(normlist[100],'ETT - Normal' )","ce559dd4":"plot_xray(normlist[400],'ETT - Normal' )","530175a7":"Plot some examples for ETT - Borderline","43259e13":"Output 5K tracheal bifurcations annotation points with dataset predicted included","e6ad2297":"https:\/\/www.kaggle.com\/sandorkonya\/5k-trachea-bifurcation-on-chest-xray\n\nThe dataset contains manually annotated 5281 trachea bifurcation on x-rays of the dataset of the current challenge.    \n","e8799acc":"Determine what Targets are present in 5K dataset","272abca2":"Plot some examples for ETT - Normal","a7ba60f6":"Copy of 5K trachea bifurcation for output as csv. Drop columns not needed.\n\nAdd raddar's trachea bifurcation predictions for comparison","56219f7f":"Plot some examples for ETT - Abnormal \n\nIntubation is green if annotation exists. Bifurcation blue for 5K annotations and red for raddar's predicted \n","9f389a55":"CSV format of 5K tracheal bifurcations annotation is created from json with predicted locations added and saved as output\n\nETT Visualisations are included for examples of RANZCR annotation intubation and the two tracheal bifurcations from datasets","47a8de96":"# Tracheal Bifurcations Visualisation for ETT","6cd67135":"Merge 5K with train to get target colums for visualisations","1b139b08":"# RANZCR Tracheal Bifurcations Datasets\n\nThis notebook uses two Datasets available for RANZCR - \n*     [raddar's bifurcation location predictions](https:\/\/www.kaggle.com\/raddar\/ranzcr-clip-tracheal-bifurcation)\n*     [dr konya's 5k manual annotations](https:\/\/www.kaggle.com\/sandorkonya\/5k-trachea-bifurcation-on-chest-xray)","690b184a":"https:\/\/www.kaggle.com\/raddar\/ranzcr-clip-tracheal-bifurcation \n\nThis dataset contains tracheal (bronchial) bifurcation location predictions of a YOLOv3 detector trained on several thousand hand labelled images from external data sources. Bifurcation points are used as a reference for deciding if intubation tube has been inserted correctly. Intubation is considered normal when tube tip is no less than 3cm above bifurcation point. If the distance is lower - abnormality is considered."}}