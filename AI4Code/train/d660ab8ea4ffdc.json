{"cell_type":{"1b96a780":"code","d9c30bbe":"code","c4d9c7cd":"code","f0f78f4c":"code","d4b8e262":"code","f2bdf46c":"code","0a2c731a":"code","f98e080d":"code","c05cd8e3":"code","3cacac80":"code","03569fab":"code","e8a330c6":"code","c3838d01":"markdown","1da954fb":"markdown","243ad6c9":"markdown","8e55b8cd":"markdown","32baf9df":"markdown","eec53e73":"markdown","1b358160":"markdown","d6ee45fa":"markdown","0613c0ec":"markdown","6f776945":"markdown","a611b39a":"markdown","23314129":"markdown","fe5be107":"markdown","743321b8":"markdown","2c670b36":"markdown","5859eb85":"markdown","61c20eac":"markdown","f9748db7":"markdown","edace4f5":"markdown","666d6b81":"markdown","9b1f001f":"markdown","31a9b95f":"markdown","9bb18ec3":"markdown","2f75fd2c":"markdown","55b71a40":"markdown","fbdf144c":"markdown","9d862a77":"markdown","23ba3b8a":"markdown","662df636":"markdown","150c1dfb":"markdown","c8b2aff5":"markdown","c361e2f5":"markdown","f1ef7491":"markdown","1b3a8676":"markdown","90037665":"markdown","4edfc6f2":"markdown","e2cff0ab":"markdown","9325440a":"markdown","2eafe809":"markdown","299989b0":"markdown","3200bde4":"markdown","94461da0":"markdown","c87a756b":"markdown","57fcf731":"markdown","aed66d2f":"markdown","f3682379":"markdown","bf79891a":"markdown","1697181a":"markdown","8d351ee6":"markdown","1e6d3a78":"markdown","10f055a6":"markdown","49cb3c97":"markdown"},"source":{"1b96a780":"import pandas as pd \nimport numpy as np \n\nfrom sklearn.model_selection import train_test_split,RepeatedStratifiedKFold,cross_val_score\nfrom sklearn.impute import SimpleImputer\nfrom sklearn.pipeline import Pipeline\nfrom sklearn.linear_model import LogisticRegression\nfrom sklearn.preprocessing import MinMaxScaler,PowerTransformer,OneHotEncoder\nfrom sklearn.compose import ColumnTransformer\n\n\nimport warnings\nwarnings.filterwarnings(\"ignore\")","d9c30bbe":"df = pd.read_csv('..\/input\/water-potability\/water_potability.csv')\ndf.head()","c4d9c7cd":"df.isnull().sum()","f0f78f4c":"df = pd.read_csv('..\/input\/water-potability\/water_potability.csv')\ndf['ph']= df['ph'].fillna(df['ph'].median())\ndf['Sulfate']= df['Sulfate'].fillna(df['Sulfate'].median())\ndf['Trihalomethanes']= df['Trihalomethanes'].fillna(df['Trihalomethanes'].median())\n\n\nX = df.drop('Potability', axis=1)\ny = df['Potability']\n\nscaler = MinMaxScaler()\nX = scaler.fit_transform(X)\n\nmodel = LogisticRegression(solver='liblinear')\n\ncv = RepeatedStratifiedKFold(n_splits=10, n_repeats=3, random_state=42)\n\nresult = cross_val_score(model, X, y,  scoring='roc_auc',cv=cv, n_jobs=-1)\n\nprint(f'{round(np.mean(result),6)}')","d4b8e262":"df = pd.read_csv('..\/input\/water-potability\/water_potability.csv')\n\nX = df.drop('Potability', axis=1)\ny = df['Potability']\n\nimputer = SimpleImputer(strategy='median')\nX = imputer.fit_transform(X)\n\nscaler = MinMaxScaler()\nX = scaler.fit_transform(X)\n\nmodel = LogisticRegression(solver='liblinear')\n\ncv = RepeatedStratifiedKFold(n_splits=10, n_repeats=3, random_state=42)\n\nresult = cross_val_score(model, X, y,  scoring='roc_auc',cv=cv, n_jobs=-1)\n\nprint(f'{round(np.mean(result),6)}')","f2bdf46c":"df = pd.read_csv('..\/input\/water-potability\/water_potability.csv')\n\nX = df.drop('Potability', axis=1)\ny = df['Potability']\n\nmodel =LogisticRegression(solver='liblinear')\n\npipeline = Pipeline(steps=[('imp', SimpleImputer(strategy='median')),('s',MinMaxScaler()),('m', model)]) \n\ncv = RepeatedStratifiedKFold(n_splits=10, n_repeats=3, random_state=42)\n\nresult = cross_val_score(pipeline, X, y,  scoring='roc_auc',cv=cv, n_jobs=-1)\n\nprint(f'{round(np.mean(result),6)}')","0a2c731a":"df = pd.read_csv('..\/input\/stroke-prediction-dataset\/healthcare-dataset-stroke-data.csv')\ndf.head()","f98e080d":"df = pd.read_csv('..\/input\/stroke-prediction-dataset\/healthcare-dataset-stroke-data.csv')\ndf=df.drop('id', axis=1)\ncategorical = [ 'hypertension', 'heart_disease', 'ever_married','work_type', 'Residence_type', 'smoking_status']\nnumerical = ['avg_glucose_level', 'bmi','age']\ny= df['stroke']\nX = df.drop('stroke', axis=1)\n\n\nmodel =LogisticRegression(solver='liblinear')\n\ntransformer = ColumnTransformer(transformers=[('imp',SimpleImputer(strategy='median'),numerical),('o',OneHotEncoder(),categorical)])\n\npipeline = Pipeline(steps=[('t', transformer),('p',PowerTransformer(method='yeo-johnson')),('m', model)])    \n\ncv = RepeatedStratifiedKFold(n_splits=10, n_repeats=3, random_state=42)\n\nresult = cross_val_score(pipeline, X, y,  scoring='roc_auc',cv=cv, n_jobs=-1)\n\nprint(f'{round(np.mean(result),3)}')","c05cd8e3":"transformer = ColumnTransformer(transformers=[('imp',SimpleImputer(strategy='median'),numerical),('o',OneHotEncoder(),categorical)])\n","3cacac80":"pipeline = Pipeline(steps=[('t', transformer),('p',PowerTransformer(method='yeo-johnson')),('m', model)])    \n","03569fab":"cv = RepeatedStratifiedKFold(n_splits=10, n_repeats=3, random_state=42)","e8a330c6":"result = cross_val_score(pipeline, X, y,  scoring='roc_auc',cv=cv, n_jobs=-1)","c3838d01":"<a id=\"9\"><\/a>\n<font color=\"darkblue\" size=+1.5><b>References & Further Reading<\/b><\/font>\n\n\n<a href=\"#toc\" class=\"btn btn-primary btn-sm\" role=\"button\" aria-pressed=\"true\" style=\"color:white\" data-toggle=\"popover\">Table of Contents<\/a>\n\n\n[Machine Learning - Beginner &Intermediate-Friendly BOOKS](https:\/\/www.kaggle.com\/general\/255972)","1da954fb":"> In statistics and machine learning, leakage (also known as data leakage or target leakage) is the use of information in the model training process which would not be expected to be available at prediction time, causing the predictive scores (metrics) to overestimate the model's utility when run in a production environment.\n\n> Leakage is often subtle and indirect, making it hard to detect and eliminate. Leakage can cause a statistician or modeler to select a suboptimal model, which could be outperformed by a leakage-free model. \n\nReference: https:\/\/en.wikipedia.org\/wiki\/Leakage_(machine_learning)","243ad6c9":"<a id=\"2\"><\/a>\n<font color=\"lightseagreen\" size=+2.5><b>Training- Test Leakage<\/b><\/font>\n\n\n<a href=\"#toc\" class=\"btn btn-primary btn-sm\" role=\"button\" aria-pressed=\"true\" style=\"color:white\" data-toggle=\"popover\">Table of Contents<\/a>","8e55b8cd":"- We defined the steps of the pipeline.\n- First we put the what we have done in the column transformer\n- Then our numerical variables have skewness and different scales, we use the Power transformer to normalize them for Logistic regression model\n- We call the model","32baf9df":"- First we fill the missing variable, by using each variable seperately.","eec53e73":"<a id=\"4\"><\/a>\n<font color=\"lightseagreen\" size=+2.5><b>Is Cross Validation Enough to Handle Data Leakage?<\/b><\/font>\n\n\n<a href=\"#toc\" class=\"btn btn-primary btn-sm\" role=\"button\" aria-pressed=\"true\" style=\"color:white\" data-toggle=\"popover\">Table of Contents<\/a>","1b358160":"- Ok we are seeing a litlle change in the model performance.\n- Becaues of the data leakage, one can expect better score on the first two model.\n- But there is very smal difference. \n- This might be because of the difficulty of the prediction task.\n- Important thing is, cross validation changes simply and incorrectly evaluating just the model.\n- By using pipeline, cross validation evaluate the entire pipleline of data preparation and model together.","d6ee45fa":"- First we put the pipeline and our fetures and target variable\n- We defined our metric (Roc-Auc)\n- We put our cross validation method.","0613c0ec":"- Remove leaky variables\n   - As we have mentioned in the credit card application prediction model, \n   - If we want to get minimze the contamination\n   - We have to remove 'fishy' variable 'paid_by_card' from our model.\n- Use cross validation\n-Use pipelines","6f776945":"<a id=\"5\"><\/a>\n<font color=\"lightseagreen\" size=+2.5><b>Where is the Data Leakage?<\/b><\/font>\n\n\n<a href=\"#toc\" class=\"btn btn-primary btn-sm\" role=\"button\" aria-pressed=\"true\" style=\"color:white\" data-toggle=\"popover\">Table of Contents<\/a>","a611b39a":"![](https:\/\/smartwatermagazine.com\/sites\/default\/files\/styles\/thumbnail-1180x647\/public\/water-pipe-2.jpg)","23314129":"- **Enjoy** \ud83e\udd18","fe5be107":"- First we need to deal with the missing values in the numerical features by\n- Secondly we need to change categorical variable to ML readable numerical version by OneHotEncoder\n- Since we are dealing a part of the data we use Column Transformer for this task.","743321b8":"<a id=\"6\"><\/a>\n<font color=\"lightseagreen\" size=+2.5><b>Using Pipeline<\/b><\/font>\n\n\n<a href=\"#toc\" class=\"btn btn-primary btn-sm\" role=\"button\" aria-pressed=\"true\" style=\"color:white\" data-toggle=\"popover\">Table of Contents<\/a>","2c670b36":"![](https:\/\/media.giphy.com\/media\/l2JJyDYEX1tXFmCd2\/giphy.gif)","5859eb85":"### Data Preprocessing Issues:","61c20eac":"- **imputer = SimpleImputer(strategy='median')**\n\n- ![](https:\/\/thefinanalyst.com\/wp-content\/uploads\/2021\/04\/ME.jpg)\n\n  - imputer uses dataset to get median scores for the variables which have missing values\n   - When we using cross validation to seperate training data,\n   - Training data has already knowledge on the test data about the median scores of the several features.\n   - Traning data knows the global median scores and has more knowledge on the global distribution of the features than it should.\n\n","f9748db7":"#### By the way, when you like the topic, you can show it by supporting \ud83d\udc4d\n\n####  **Feel free to leave a comment**. \n\n#### All the best \ud83e\udd18","edace4f5":"- In this study we will focus on data preparation part of the data leakage.","666d6b81":"\n- When we using cross validation to seperate training data,\n- Training data has already knowledge on the test data about the minimum and maximum scores of the features.\n- Because training data is scaled based on the global maximum and minimum values\n- Traning data has more knloedge on the global distribution of the features than it should.\n\n- Both of the results have a data leakage problem. \n- This can lead to make an incorrect estimation of model performance.","9b1f001f":"<a id=\"8\"><\/a>\n<font color=\"darkblue\" size=+1.5><b>Conclusion<\/b><\/font>\n\n\n<a href=\"#toc\" class=\"btn btn-primary btn-sm\" role=\"button\" aria-pressed=\"true\" style=\"color:white\" data-toggle=\"popover\">Table of Contents<\/a>","31a9b95f":"- **scaler = MinMaxScaler()**\n   - As we have seen that, when we are using to normalize our data;\n   - We are using minimum nd maximum values of the features.","9bb18ec3":"<a id=\"7\"><\/a>\n<font color=\"lightseagreen\" size=+2.5><b>Cross-Validation & Pipeline- Correct Data Preparation<\/b><\/font>\n\n\n<a href=\"#toc\" class=\"btn btn-primary btn-sm\" role=\"button\" aria-pressed=\"true\" style=\"color:white\" data-toggle=\"popover\">Table of Contents<\/a>","2f75fd2c":"Image Credit: https:\/\/miro.medium.com\/","55b71a40":"- Ok let's go step by step.","fbdf144c":"- By using K-fold cross-validation, we  split the data k non-overlapping groups of rows. \n- And then our model is trained on the training dataset \n- And then our model is evaluated on the held-out fold. \n- For the data leakage part, we use train and test\/validation seperately.\n","9d862a77":"- 'One definition of an ML pipeline is a means of automating the machine learning workflow by enabling data to be transformed and correlated into a model that can then be analyzed to achieve outputs. This type of ML pipeline makes the process of inputting data into the ML model fully automated.' (reference: https:\/\/algorithmia.com\/blog\/ml-pipeline)\n\n\n- When we use pipeline in our models, data pass through different automated steps before reaching the final output.\n\n- In our case, imputer will fit only on the training dataset, not the entire dataset or test set.\n\n- Let's see the coding.","23ba3b8a":"- We fill the missing values by using Simple Imputer.","662df636":"<a id=\"toc\"><\/a>\n\n<h3 class=\"list-group-item list-group-item-action active\" data-toggle=\"list\" role=\"tab\" aria-controls=\"home\">Table of Contents<\/h3>\n    \n* [Data Leakage](#0)\n* [Target Leakage](#1)\n* [Training- Test Leakage](#2)\n* [How to Deal With Data Leakage](#3)\n* [Is Cross Validation Enough to Handle Data Leakage?](#4)\n* [Where is the Data Leakage?](#5)\n* [Using Pipeline](#6)\n* [Cross-Validation & Pipeline- Correct Data Preparation](#7)\n* [Conclusion](#8)\n* [References & Further Reading](#9)","150c1dfb":"- We will do everything by using pipeline, so that cross validation evaluate the entire pipleline of data preparation and model together.","c8b2aff5":"#### **By the way, when you like the topic, you can show it by supporting** \ud83d\udc4d\n\n####  **Feel free to leave a comment in the notebook**. \n\n\n#### All the best \ud83e\udd18","c361e2f5":"- For further discussion on the target data leakage and different examples please refer to: https:\/\/www.researchgate.net\/publication\/221653692_Leakage_in_Data_Mining_Formulation_Detection_and_Avoidance","f1ef7491":"- Ok we have mising values, and most of the machine learning algorithm can not tolerate the missing values \n- and we have to handle it.\n- Let's use mean imputation and by using Cross Validation evaluate our Logistic Regression model.","1b3a8676":"- In the prediction modeling, we want get the best prediction on the target variable.\n- When we use the information, which shouldn't be expected to be present in the training, it causes the mess.\n- Let me give examples to clarify the issue.","90037665":"- We have defined our cross validation evaluation method.\n- Since we are dealing imbalanced data, we selected stratified version of Kfold with 3 repeats.","4edfc6f2":"### We have already worked on this data. I am not going to make a detailed analysis on this data. Please refer to [Beginner Friendly end to end ML Project](https:\/\/www.kaggle.com\/kaanboke\/beginner-friendly-end-to-end-ml-project-enjoy)","e2cff0ab":"#### Hi all.  \ud83d\ude4b\u2022\u2642\ufe0f \n\n\u200b\n#### We continue our **Beginner-Intermediate Friendly Machine Learning series**, which would help anyone who wants to learn or refresh the basics of ML.\n\u200b\n#### What we have covered: \n\n#### [Beginner Friendly Detailed Explained EDAs \u2013 For anyone at the beginnings of DS\/ML journey](https:\/\/www.kaggle.com\/general\/253911#1393015) \u2714\ufe0f\n\u200b\n#### [BIAS & VARIANCE TRADEOFF](https:\/\/www.kaggle.com\/kaanboke\/ml-basics-bias-variance-tradeoff) \u2714\ufe0f\n\u200b\n#### [LINEAR ALGORITHMS](https:\/\/www.kaggle.com\/kaanboke\/ml-basics-linear-algorithms)  \u2714\ufe0f\n\u200b\n#### [NONLINEAR ALGORITHMS](https:\/\/www.kaggle.com\/kaanboke\/nonlinear-algorithms)  \u2714\ufe0f\n\u200b\n#### [The Most Used Methods to Deal with MISSING VALUES](https:\/\/www.kaggle.com\/kaanboke\/the-most-used-methods-to-deal-with-missing-values)  \u2714\ufe0f\n\u200b\n#### [Beginner Friendly End to End ML Project- Classification with Imbalanced Data](https:\/\/www.kaggle.com\/kaanboke\/beginner-friendly-end-to-end-ml-project-enjoy)  \u2714\ufe0f\n\u200b\n#### Today we will cover one of the main problems of the data preprocessing : **Data Leakage**","9325440a":"<a id=\"1\"><\/a>\n<font color=\"lightseagreen\" size=+2.5><b>Target Leakage<\/b><\/font>\n\n\n<a href=\"#toc\" class=\"btn btn-primary btn-sm\" role=\"button\" aria-pressed=\"true\" style=\"color:white\" data-toggle=\"popover\">Table of Contents<\/a>","2eafe809":"- Data preparation methods to the whole dataset results in data leakage that causes incorrect estimates of model performance.\n- To prevent this **data preparation must be prepared on the training dataset**.\n\n- Nothing else really. OK if you want, I will tell it one more time;\n- **Data preparation must be prepared on the training dataset**","299989b0":"### Time Related Issues:","3200bde4":"- Ok What we did?\n- First we fill the missing values with the 'median' scores.\n- Then we normalize the scales.\n- We use cross validation and seperated our training and validation data to evaluate.","94461da0":"#### Credit Card Application:\n\n- If we want to predict whether person receive a card or not \n- And we have a feature so called, 'paid_by_card'\n- We have to examine that, whether these payment were made by the card in question or not?\n- Don't think it is exaggerated, you will see a lot of similar examples, in your data science career.","c87a756b":"Image credit: https:\/\/smartwatermagazine.com\/blogs\/victoria-edwards\/bunker-mentality-will-never-solve-worlds-water-leakage-problem","57fcf731":"![](https:\/\/miro.medium.com\/max\/1400\/1*FUZS9K4JPqzfXDcC83BQTw.png)","aed66d2f":"- All the preprocessing should be done with training data !!!\n- Featuring, scaling, normalization, missing value imputations, categorical value coding, etc.","f3682379":"- Imagine we are dealing with the sale price.\n- We have a data between 2015-2020 sale prices.\n- If we randomly divide these years between test and training datsets, \n- We will inform the training data about the test data and also make useless our timeseries analysis.","bf79891a":"### We have already worked on this data. I am not going to make a detailed analysis on this data. Please refer to [The Most Used Methods to Deal with MISSING VALUES](https:\/\/www.kaggle.com\/kaanboke\/the-most-used-methods-to-deal-with-missing-values)","1697181a":"- Before modeling:\n  - Handle the missing data.\n  - Change the categorical variables to numerical version for ML model\n  - Change the scale\n  - Normalize the distribution","8d351ee6":"<a id=\"3\"><\/a>\n<font color=\"lightseagreen\" size=+2.5><b>How to Deal With Data Leakage<\/b><\/font>\n\n\n<a href=\"#toc\" class=\"btn btn-primary btn-sm\" role=\"button\" aria-pressed=\"true\" style=\"color:white\" data-toggle=\"popover\">Table of Contents<\/a>","1e6d3a78":"- Ok let's see everything in the action.","10f055a6":"![](https:\/\/i.stack.imgur.com\/EuitP.png)","49cb3c97":"<a id=\"0\"><\/a>\n<font color=\"lightseagreen\" size=+2.5><b>Data Leakage<\/b><\/font>\n\n\n<a href=\"#toc\" class=\"btn btn-primary btn-sm\" role=\"button\" aria-pressed=\"true\" style=\"color:white\" data-toggle=\"popover\">Table of Contents<\/a>"}}