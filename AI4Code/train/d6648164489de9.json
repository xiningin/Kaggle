{"cell_type":{"85f572bc":"code","75bd8f77":"code","4a80e815":"code","149bed9d":"code","d93346ee":"code","fc8bedb0":"code","e5566bf3":"code","081c21b3":"code","cfb41d18":"code","d35e717a":"code","b6864658":"markdown"},"source":{"85f572bc":"import numpy as np\nimport pandas as pd\n\nimport janestreet\n\nimport tensorflow as tf\nimport tensorflow.keras.backend as K\nfrom tensorflow.keras.layers import Input, Dense, Input, BatchNormalization, Dropout\n\nimport cudf\n\nfrom sklearn.metrics import roc_auc_score, roc_curve\nfrom sklearn.model_selection import GroupKFold\nfrom tensorflow.keras.callbacks import Callback, ReduceLROnPlateau, ModelCheckpoint, EarlyStopping\nimport gc","75bd8f77":"train = cudf.read_csv('\/kaggle\/input\/jane-street-market-prediction\/train.csv')\nfeatures = [c for c in train.columns if 'feature' in c]","4a80e815":"f_mean = train[features[1:]].mean()\ntrain = train.query('weight > 0').reset_index(drop = True)\ntrain[features[1:]] = train[features[1:]].fillna(f_mean)\ntrain['action'] = ((train['weight'].values * train['resp'].values) > 0).astype('int')\n\ntrain = train.to_pandas()\nf_mean = f_mean.values.get()","149bed9d":"def create_model(input_size, layers, dropout_rates, learning_rate):\n    \n    inp = Input(shape = (input_size, ))\n    x = BatchNormalization()(inp)\n    x = Dropout(dropout_rates[0])(x)\n    for i in range(len(layers)): \n        x = Dense(hidden_units[i], activation='relu')(x)\n        x = BatchNormalization()(x)\n        x = Dropout(dropout_rates[i+1])(x)    \n        \n    out = tf.keras.layers.Dense(1, activation='sigmoid')(x)\n    \n    model = tf.keras.models.Model(inputs=inp, outputs=out)\n    model.compile(\n        optimizer=tf.keras.optimizers.Adam(learning_rate = learning_rate),\n        loss = tf.keras.losses.BinaryCrossentropy(), \n        metrics = tf.keras.metrics.AUC(name = 'AUC')\n    )\n    \n    return model","d93346ee":"tf.random.set_seed(666)\nbatch_size = 4000\n\nhidden_units = [256, 256, 80]\ndropout_rates = [0.05, 0.25, 0.25, 0.1]\nlearning_rate = 1e-3\n\noof = np.zeros(len(train['action']))\ngkf = GroupKFold(n_splits=5)\nfor fold, (tr, te) in enumerate(gkf.split(train['action'].values, train['action'].values, train['date'].values)):\n    X_tr, X_val = train.loc[tr, features].values, train.loc[te, features].values\n    y_tr, y_val = train.loc[tr, 'action'].values, train.loc[te, 'action'].values\n    \n    ckp_path = f'model_{fold}.hdf5'\n    model = create_model(X_tr.shape[1], hidden_units, dropout_rates, learning_rate)\n    rlr = ReduceLROnPlateau(monitor='val_AUC', factor = 0.1, patience = 3, verbose = 0, min_delta = 1e-4, mode = 'max')\n    ckp = ModelCheckpoint(ckp_path, monitor='val_AUC', verbose=0, save_best_only = True, save_weights_only = True, mode = 'max')\n    es = EarlyStopping(monitor = 'val_AUC', min_delta = 1e-4, patience = 10, mode = 'max', baseline = None, restore_best_weights = True, verbose=0)\n    model.fit(X_tr, y_tr, validation_data = (X_val, y_val), epochs = 1000, \n              batch_size = batch_size, callbacks = [rlr, ckp, es], verbose=1)\n                \n    oof[te] += model.predict(X_val, batch_size=batch_size * 4).ravel()\n    score = roc_auc_score(y_val, oof[te])\n    print(f'Fold {fold} ROC AUC:\\t', score)\n    \n    K.clear_session()\n    rubbish = gc.collect()","fc8bedb0":"score_oof = roc_auc_score(train['action'].values, oof)\nprint(score_oof)","e5566bf3":"env = janestreet.make_env()\niter_test = env.iter_test()","081c21b3":"models = []\nfor i in range(5):\n    clf = create_model(len(features), hidden_units, dropout_rates, learning_rate)\n    clf.load_weights(f'.\/model_{i}.hdf5')\n    models.append(clf)","cfb41d18":"from tqdm.notebook import tqdm","d35e717a":"opt_th = 0.5\nfor (test_df, pred_df) in tqdm(iter_test):\n    if test_df['weight'].item() > 0:\n        x_tt = test_df.loc[:, features].values\n        if np.isnan(x_tt[:, 1:].sum()):\n            x_tt[:, 1:] = np.nan_to_num(x_tt[:, 1:]) + np.isnan(x_tt[:, 1:]) * f_mean\n        for i, clf in enumerate(models):\n            if i == 0:\n                pred = clf(x_tt, training = False).numpy().item() \/ len(models)\n            else:\n                pred += clf(x_tt, training = False).numpy().item() \/ len(models)\n        pred_df.action = np.where(pred >= opt_th, 1, 0).astype(int)\n    else:\n        pred_df.action = 0\n    env.predict(pred_df)","b6864658":"### Based on https:\/\/www.kaggle.com\/gogo827jz\/jane-street-neural-network-starter"}}