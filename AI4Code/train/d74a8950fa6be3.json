{"cell_type":{"6f1796c8":"code","2fc18d3e":"code","24ccb064":"code","c7b91781":"code","b59d0b75":"code","569bee7b":"code","24d237ba":"code","a73ed86f":"code","80dc1981":"code","4fefcdec":"code","fc935911":"code","d5aab810":"code","f459d5e5":"code","7ed3ecc4":"code","df12ea8c":"code","466deb7f":"code","f1e391ff":"code","b4bfdfb4":"code","fcca4506":"code","780fa23f":"code","50a44951":"code","7f06131a":"code","4b1eb1d9":"code","6fb216fd":"code","f85828fd":"code","1941715f":"markdown","e92ecbc0":"markdown","32bf593a":"markdown","79cc9919":"markdown","0eb43776":"markdown","bbc5ca43":"markdown","1d635a27":"markdown","67c0bd13":"markdown","02f17b74":"markdown","84217583":"markdown"},"source":{"6f1796c8":"import numpy as np\nimport pandas as pd\nimport os\nimport matplotlib.pyplot as plt\nimport seaborn as sns","2fc18d3e":"df = pd.read_csv('..\/input\/hackereath-holiday-season-deep-learning-contest\/dataset\/train.csv')\ndf.head()","24ccb064":"from keras.applications.inception_v3 import InceptionV3,preprocess_input","c7b91781":"from keras.preprocessing.image import ImageDataGenerator","b59d0b75":"datagen = ImageDataGenerator(\n        preprocessing_function=preprocess_input)","569bee7b":"train_generator = datagen.flow_from_dataframe(\n    df,\n    directory='..\/input\/hackereath-holiday-season-deep-learning-contest\/dataset\/train',\n    x_col = 'Image',\n    y_col = 'Class',\n    target_size=(299,299),\n    class_mode = 'categorical',\n    batch_size=32)","24d237ba":"base_model = InceptionV3(include_top=False,weights='imagenet',input_shape=(299,299,3))","a73ed86f":"base_model.trainable = False","80dc1981":"from keras import layers,models","4fefcdec":"model = models.Sequential()\nmodel.add(base_model)\nmodel.add(layers.GlobalAveragePooling2D())\nmodel.add(layers.Dense(512,activation='relu'))\nmodel.add(layers.Dropout(0.5))\nmodel.add(layers.Dense(256,activation='relu'))\nmodel.add(layers.Dense(6,activation='softmax'))","fc935911":"model.compile(\n    optimizer='adam',\n    loss = 'categorical_crossentropy',\n    metrics = ['accuracy'])","d5aab810":"train_steps = np.ceil(train_generator.n\/train_generator.batch_size)","f459d5e5":"model.fit(\n    train_generator,\n    epochs=12,\n    batch_size=32,\n    steps_per_epoch=train_steps)","7ed3ecc4":"import keras\nnew_train_x = []\nnew_train_y = []\nmodel2 = keras.Model(model.input, model.layers[-5].output)\ncount = 0\nwhile count < 200:\n    x_batch,y_batch = next(train_generator)\n    pred = model2.predict(x_batch)\n    new_train_x.extend(pred)\n    new_train_y.extend(y_batch)\n    count += 1\n","df12ea8c":"new_train_y = np.argmax(new_train_y,axis=1)\nprint(new_train_y.shape)","466deb7f":"new_train_x = np.array(new_train_x)\nnew_train_y = np.array(new_train_y)\nprint(new_train_x.shape)\nprint(new_train_y.shape)","f1e391ff":"from xgboost import XGBClassifier\nclf = XGBClassifier(max_depth=7, objective='multi:softmax', n_estimators=1000, \n                        num_classes=6)\nclf.fit(new_train_x,new_train_y)","b4bfdfb4":"test_df = pd.DataFrame()\ntest_images = os.listdir('..\/input\/hackereath-holiday-season-deep-learning-contest\/dataset\/test')\ntest_df['Image']=test_images\ntest_df.head()","fcca4506":"test_generator = datagen.flow_from_dataframe(\n    test_df,\n    directory='..\/input\/hackereath-holiday-season-deep-learning-contest\/dataset\/test',\n    x_col = 'Image',\n    y_col = None,\n    target_size=(299,299),\n    class_mode = None,\n    batch_size=32,\n    shuffle = False)","780fa23f":"new_test_x = model2.predict(test_generator)\nnew_test_x = np.array(new_test_x)\npredictions_xgb = clf.predict(new_test_x)","50a44951":"predictions_xgb","7f06131a":"test_df['Class']=predictions_xgb","4b1eb1d9":"num_to_class = dict((y,x) for (x,y) in train_generator.class_indices.items())\nnum_to_class","6fb216fd":"test_df['Class']=test_df['Class'].map(num_to_class)\ntest_df.head()","f85828fd":"test_df.to_csv('pred.csv',index=False)","1941715f":"# ***Crucial step : Generated features of imagesby predicting it by removing the last layer of the model.***","e92ecbc0":"# ***If you find the notebook informative , please drop a like***","32bf593a":"# ***In this notebook , We will not follow common way of predicting from just pretrained model , instead we will take features of image by predicting image with second last layer of pretrained model and then fit it again with xgboost and get final predictions.***","79cc9919":"# ***Fitting new_train_x and new_train_y with xgboost.***","0eb43776":"# ***Using InceptionV3 pretrained model. You can try with others also.***","bbc5ca43":"# ***Using flow from dataframe method for mapping dataframe and directory both.***","1d635a27":"# ***Adding some extra layers over pretrained model.***","67c0bd13":"# ***If you have any doubts in above code , please ask in the comment section. I will surely revert back as soon as possible***","02f17b74":"# ***Preparing test generator***","84217583":"# ***Predicting on test_generator***"}}