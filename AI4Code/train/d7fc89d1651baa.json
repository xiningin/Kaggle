{"cell_type":{"8ac0f31d":"code","c4b54e56":"code","29a0be4d":"code","eacb6119":"code","fec67dfa":"code","09fc6392":"code","f6759ebb":"code","2be42b0f":"code","7f0b416d":"code","6d673201":"code","c9cf228f":"code","5ea559a7":"code","99e9ed52":"code","4ecf5edf":"code","72f76160":"code","94500b0a":"markdown","36569385":"markdown","d009f8b9":"markdown","6a68b657":"markdown","a8b1d47d":"markdown","b701f52f":"markdown"},"source":{"8ac0f31d":"import requests\nfrom tqdm.notebook import tqdm\nimport pandas as pd\nimport matplotlib as mpl\nimport matplotlib.pyplot as plt\nimport geopandas as gpd\nimport pathlib\n%matplotlib inline\nmpl.rcParams['figure.figsize'] = 20,10","c4b54e56":"%%capture\n# !pip install requests tqdm jupyterlab_widgets ipywidgets;\n# !jupyter nbextension enable --py widgetsnbextension;\n# !jupyter labextension install @jupyter-widgets\/jupyterlab-manager;","29a0be4d":"def download_stuff(name, url, path):\n    \"\"\"Download stuff nicely.\"\"\"\n    #TODO shunt only if too old\n    print(f\"Downloading {name}...\")\n    if pathlib.Path(path).exists():\n        print(\"Already available.\")\n        return\n    response = requests.get(url, stream=True)\n    response.raise_for_status()\n    total_size_in_bytes= int(response.headers.get('content-length', 0))\n    progress_bar = tqdm(total=total_size_in_bytes, unit='iB', unit_scale=True)\n    block_size = 1024\n    with open(path, \"wb\") as f:\n        for data in response.iter_content(block_size):\n            progress_bar.update(len(data))\n            f.write(data)\n    progress_bar.close()\n# TODO auto download\n\ndownload_stuff(\n    \"main dataset\",\n    \"https:\/\/data.montreal.ca\/dataset\/2fc8a2b9-1556-410e-a118-c46e97e9f19e\/resource\/71e86320-e35c-4b4c-878a-e52124294355\/download\/donneesouvertes-interventions-sim.csv\",\n    \"donneesouvertes-interventions-sim.csv\"\n)\ndownload_stuff(\n    \"arrondissement dataset\",\n    \"https:\/\/data.montreal.ca\/dataset\/00bd85eb-23aa-4669-8f1b-ba9a000e3dd8\/resource\/e9b0f927-8f75-458c-8fda-b5da65cc8b73\/download\/limadmin.geojson\",\n    \"limadmin.geojson\"\n)\ndownload_stuff(\n    \"population arrondissement dataset\",\n    \"https:\/\/data.montreal.ca\/dataset\/476ed7db-684a-42a3-8028-8d6cb83c0ec3\/resource\/370b0c30-886a-435b-9049-bcc5a5dd2e80\/download\/population-quartiers-arrondissements-et-villes-liees.csv\",\n    \"population-quartiers-arrondissements-et-villes-liees.csv\"\n)","eacb6119":"main_data = (\n    pd.read_csv('donneesouvertes-interventions-sim.csv')\n    .drop([\"MTM8_X\", \"MTM8_Y\"], axis=1)\n)\nmain_data.columns = [\"identifiant\", \"horodatage\", \"type_incident\", \"groupe_incident\", \"caserne\", \"ville\", \"arrondissement\", \"division\", \"nombre_unites\", \"civ\", \"longitude\", \"latitude\"]\nmain_data[\"horodatage\"] = pd.to_datetime(main_data[\"horodatage\"])\nfor i in [\"type_incident\", \"groupe_incident\", \"ville\", \"arrondissement\"]:\n    main_data[i] = main_data[i].astype('category')\nmain_data[\"horodatage_par_mois\"] = main_data[\"horodatage\"].dt.to_period('M')\n# main_data","fec67dfa":"# main, geo, pop\nrosetta_stone=[\n    (\"Ahuntsic \/ Cartierville\", \"Ahuntsic-Cartierville\", \"Ahuntsic-Cartierville\"),\n    (\"Anjou\", \"Anjou\", \"Anjou\"),\n    (\"C\u00f4te-des-Neiges \/ Notre-Dame-de-Gr\u00e2ce\", \"C\u00f4te-des-Neiges-Notre-Dame-de-Gr\u00e2ce\", \"C\u00f4te-des-Neiges\u2013Notre-Dame-de-Gr\u00e2ce\"),\n    (\"L'Ile-Bizard \/ Ste-Genevi\u00e8ve\", \"L'\u00cele-Bizard-Sainte-Genevi\u00e8ve\", \"L'\u00cele-Bizard\u2013Sainte-Genevi\u00e8ve\"),\n    (\"Lachine\", \"Lachine\", \"Lachine\"),\n    (\"Lasalle\", \"LaSalle\", \"LaSalle\"),\n    (\"Mercier \/ Hochelaga-Maisonneuve\", \"Mercier-Hochelaga-Maisonneuve\", \"Mercier\u2013Hochelaga-Maisonneuve\"),\n    (\"Montr\u00e9al-Nord\", \"Montr\u00e9al-Nord\", \"Montr\u00e9al-Nord\"),\n    (\"Outremont\", \"Outremont\", \"Outremont\"),\n    (\"Pierrefonds \/ Roxboro\", \"Pierrefonds-Roxboro\", \"Pierrefonds-Roxboro\"),\n    (\"Plateau Mont-Royal\", \"Le Plateau-Mont-Royal\", \"Le Plateau-Mont-Royal\"),\n    (\"Rivi\u00e8re-des-Prairies \/ Pointe-aux-Trembles\", \"Rivi\u00e8re-des-Prairies-Pointe-aux-Trembles\", \"Rivi\u00e8re-des-Prairies\u2013Pointe-aux-Trembles\"),\n    (\"Rosemont \/ Petite-Patrie\", \"Rosemont-La Petite-Patrie\", \"Rosemont\u2013La Petite-Patrie\"),\n    (\"Saint-Laurent\", \"Saint-Laurent\", \"Saint-Laurent\"),\n    (\"Saint-L\u00e9onard\", \"Saint-L\u00e9onard\", \"Saint-L\u00e9onard\"),\n    (\"Sud-Ouest\", \"Le Sud-Ouest\", \"Le Sud-Ouest\"),\n    (\"Verdun\", \"Verdun\", \"Verdun\"),\n    (\"Ville-Marie\", \"Ville-Marie\", \"Ville-Marie\"),\n    (\"Villeray \/ St-Michel \/ Parc Extension\", \"Villeray-Saint-Michel-Parc-Extension\", \"Villeray\u2013Saint-Michel\u2013Parc-Extension\"),\n]\n","09fc6392":"arrondissement_geo = (\n    gpd.read_file('limadmin.geojson')\n    .drop([\"ABREV\", \"NUM\", \"CODEMAMROT\", \"CODEID\", \"MUNID\", \"PERIM\", \"geometry\"], axis=1)\n    .query(\"TYPE == 'Arrondissement'\")\n    .drop([\"TYPE\"], axis=1)\n)\narrondissement_geo.columns = ['arrondissement', 'aire']\narrondissement_geo[\"arrondissement_aire_km2\"] = arrondissement_geo[\"aire\"] \/ 10**6\narrondissement_geo.drop(\"aire\", axis=1, inplace=True)\nrosetta = {tup[1]:tup[0] for tup in rosetta_stone}\narrondissement_geo[\"arrondissement\"] = arrondissement_geo[\"arrondissement\"].map(lambda x: rosetta[x]).astype('category')\narrondissement_geo.set_index('arrondissement', inplace=True)\narrondissement_geo","f6759ebb":"arrondissement_pop = pd.read_csv(\"population-quartiers-arrondissements-et-villes-liees.csv\")\narrondissement_pop.columns = [\"arrondissement\", \"todrop\", \"arrondissement_population\"]\narrondissement_pop.drop(\"todrop\", axis=1, inplace=True)\narrondissement_pop = arrondissement_pop[~arrondissement_pop[\"arrondissement_population\"].isna()].copy()\nrosetta = {tup[2]:tup[0] for tup in rosetta_stone}\narrondissement_pop[\"arrondissement\"] = arrondissement_pop[\"arrondissement\"].map(lambda x: rosetta.get(x))\narrondissement_pop = arrondissement_pop[~arrondissement_pop[\"arrondissement\"].isna()].copy()\narrondissement_pop.set_index('arrondissement', inplace=True)\narrondissement_pop","2be42b0f":"final_data = (\n    main_data\n    .join(arrondissement_geo, on=\"arrondissement\", how='left')\n    .join(arrondissement_pop, on=\"arrondissement\", how='left')\n)\nfinal_data","7f0b416d":"(final_data[[\"horodatage\", \"groupe_incident\", \"horodatage_par_mois\"]]\n .groupby([\"horodatage_par_mois\", \"groupe_incident\"]).count()\n .rename(columns={'horodatage':\"nombre_intervention\"})\n .fillna(0)\n).unstack().plot(kind=\"bar\", stacked=True)\nplt.title(\"Evolution des interventions par familles pour la periode 2015-2020\")\nplt.show()","6d673201":"(final_data[[\"horodatage\", \"groupe_incident\", \"horodatage_par_mois\"]]\n .groupby([\"horodatage_par_mois\", \"groupe_incident\"]).count()\n .rename(columns={'horodatage':\"nombre_intervention\"})\n .fillna(0)\n).unstack().apply(lambda x: x \/ x.sum() * 100, axis=1).plot(kind=\"bar\",stacked=True)\nplt.title(\"Evolution de la repartition des interventions par familles pour la p\u00e9riode 2015-2020\")\nplt.ylabel(\"R\u00e9partition(%)\")\nplt.show()","c9cf228f":"import numpy as np\nnb_type_to_display = 20\ndata = (\n    final_data[['horodatage', 'type_incident']]\n    .groupby('type_incident').count()\n    .rename(columns={\"horodatage\": \"nombre d'intervention\"})\n    .sort_values(\"nombre d'intervention\", ascending=False)\n).copy()\ndata = data \/ data.sum(axis=0) * 100\ndata.set_index(data.index.add_categories(\"Autres\"), inplace=True)\nautres = data[20:].sum(axis=0)\ndata.drop(data.index[20:], axis=0, inplace=True)\ndata.loc[\"Autres\"] = autres\ndata.plot(kind=\"bar\")\nplt.yscale(\"log\")\nplt.ylabel(\"Pourcentage des interventions (log)\")\nplt.title(\"R\u00e9partition des interventions par type entre 2015 et 2020\")\nplt.grid()\nfor i,v in enumerate(data.apply(lambda x: x.values[0], axis=1)):\n    plt.text(i, v, f\"{v:.2f}\", ha='center', va='bottom')\nplt.show()","5ea559a7":"overcooked = final_data[final_data[\"type_incident\"] == \"Aliments surchauff\u00e9s\"][[\"horodatage\", \"horodatage_par_mois\", \"type_incident\"]].copy()\novercooked = overcooked.drop('type_incident', axis=1).groupby(\"horodatage_par_mois\").count().rename(columns={'horodatage': \"nombre d'evenements\"})\novercooked.plot(kind='bar')\nplt.plot(overcooked.rolling(6).mean().values)\nplt.title(\"Evolution des aliments trop cuits\")\nplt.show()","99e9ed52":"count_per_arron = (final_data.groupby(\"arrondissement\").count()\n .rename(columns={\"horodatage\": \"nombre d'evenements\"})\n .drop([col for col in final_data.columns if col not in [\"arrondissement\", \"horodatage\"]], axis=1)\n .sort_values(by=\"nombre d'evenements\", ascending=False)\n)\ncount_per_arron.plot(kind=\"bar\")\nplt.grid()\nplt.title(\"Nombre d'\u00e9v\u00e8nements par arrondissement sur la p\u00e9riode 2015-2020\")","4ecf5edf":"data = count_per_arron.join(arrondissement_geo, how='right')\ndata['evenements par km2'] = data[\"nombre d'evenements\"] \/ data[\"arrondissement_aire_km2\"]\ndata.drop([\"nombre d'evenements\", \"arrondissement_aire_km2\"], axis=1, inplace=True)\ndata.sort_values(by=\"evenements par km2\", inplace=True, ascending=False)\ndata.plot(kind=\"bar\")\nplt.title(\"nombre d'intervention par km2 pour la periode 2015-2020\")\nplt.xlabel(\"arrondissement\")\nplt.show()","72f76160":"data = count_per_arron.join(arrondissement_pop, how='right')\ndata['evenements par 1000 habs'] = data[\"nombre d'evenements\"] \/ data[\"arrondissement_population\"] * 1000\ndata.drop([\"nombre d'evenements\", \"arrondissement_population\"], axis=1, inplace=True)\ndata.sort_values(by=\"evenements par 1000 habs\", inplace=True, ascending=False)\ndata.plot(kind=\"bar\")\nplt.title(\"nombre d'intervention pour 1000 habitants pour la periode 2015-2020\")\nplt.xlabel(\"arrondissement\")\nplt.show()","94500b0a":"# Evolution des aliments trop cuits","36569385":"# Arrondissements","d009f8b9":"# Types d'incidents","6a68b657":"## Preparation des donn\u00e9es","a8b1d47d":"# Interventions des pompiers de Montreal\nCe notebook presente les donn\u00e9es concernant les interventions des pompiers de Montr\u00e9al","b701f52f":"# evolution du nombre d'intervention"}}