{"cell_type":{"c1f08228":"code","f199fc1e":"code","05ab4ad4":"code","9c511cac":"code","b5345709":"code","543a0522":"code","17144feb":"code","9dfbf6be":"code","99522e47":"code","fa571eb6":"code","8e5b396c":"code","24cb09ce":"code","0a683d73":"code","542947e0":"code","858af01b":"code","d1cef422":"code","2017fed1":"code","f7e3831b":"code","390c22e2":"code","77344961":"code","18c80f3a":"code","4d3e705d":"code","6944aee7":"code","caf64a68":"code","9cacc465":"code","4714783b":"code","ef3b075e":"code","1f5efa35":"code","f6c04c48":"code","19228212":"code","094cfb33":"code","a80d57c4":"code","61b38958":"code","1752942a":"code","b23e2b80":"code","5c01246a":"code","67bd70a4":"markdown","75b2dff1":"markdown","5d753d71":"markdown","05979a1f":"markdown","7147542b":"markdown","f44a0079":"markdown","7ded01e0":"markdown","8ae9b5f6":"markdown","863ee714":"markdown"},"source":{"c1f08228":"import numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\n\nimport os\nprint(os.listdir(\"..\/input\"))","f199fc1e":"import fastai\nfastai.__version__","05ab4ad4":"from fastai.text import *\nfrom fastai.callbacks import *","9c511cac":"data_train = pd.read_csv(\"..\/input\/train.csv\")\ndata_valid = pd.read_csv(\"..\/input\/valid.csv\")\ndata_test = pd.read_csv(\"..\/input\/test.csv\")","b5345709":"data_train.fillna(\"xxempty\", inplace=True)\ndata_valid.fillna(\"xxempty\", inplace=True)\ndata_test.fillna(\"xxempty\", inplace=True)","543a0522":"data_train[\"full\"] = data_train[\"text\"].apply(lambda x: x + \" xxtitle \") + data_train[\"title\"]\ndata_valid[\"full\"] = data_valid[\"text\"].apply(lambda x: x + \" xxtitle \") + data_valid[\"title\"]\ndata_test[\"full\"] = data_test[\"text\"].apply(lambda x: x + \" xxtitle \") + data_test[\"title\"]","17144feb":"data_train[\"is_valid\"] = False\ndata_valid[\"is_valid\"] = True","9dfbf6be":"data_lm = (TextList.from_df(pd.concat([data_train, data_valid]), cols=[\"full\"])\n           .split_from_df(\"is_valid\")\n           .label_for_lm()\n           .databunch())","99522e47":"lm = language_model_learner(data_lm, AWD_LSTM, drop_mult=0.3, pretrained=True)","fa571eb6":"lm.lr_find()","8e5b396c":"lm.recorder.plot(suggestion=True)","24cb09ce":"lm.fit_one_cycle(1, 4e-3, callbacks=[SaveModelCallback(lm, name=\"best_lm\")], moms=(0.8,0.7))","0a683d73":"lm.unfreeze()","542947e0":"lm.fit_one_cycle(5, 4e-3, callbacks=[SaveModelCallback(lm, name=\"best_lm\")], moms=(0.8,0.7))","858af01b":"lm.load(\"best_lm\")","d1cef422":"lm.save_encoder(\"enc\")","2017fed1":"data_clf = (TextList.from_df(pd.concat([data_train, data_valid]), vocab=data_lm.vocab, cols=[\"full\"]).\n           split_from_df(\"is_valid\").\n           label_from_df(\"label\").\n           add_test(data_test[\"full\"]).\n           databunch()\n          )","f7e3831b":"clf = text_classifier_learner(data_clf, AWD_LSTM, drop_mult=0.3)","390c22e2":"del lm\ntorch.cuda.empty_cache()","77344961":"clf.load_encoder(\"enc\")","18c80f3a":"clf.lr_find()","4d3e705d":"clf.recorder.plot()","6944aee7":"clf.fit(3, 2e-3, callbacks=[SaveModelCallback(clf, name=\"best_clf\")])","caf64a68":"clf.load(\"best_clf\")","9cacc465":"clf.unfreeze()","4714783b":"clf.fit(1, 3e-4, callbacks=[SaveModelCallback(clf, name=\"best_clf_ft1\")])","ef3b075e":"clf.fit(1, 3e-4, callbacks=[SaveModelCallback(clf, name=\"best_clf_ft2\")])","1f5efa35":"pred_val = clf.get_preds(DatasetType.Valid, ordered=True)","f6c04c48":"pred_val_l = pred_val[0].argmax(1)","19228212":"from sklearn.metrics import classification_report","094cfb33":"print(classification_report(pred_val[1], pred_val_l))","a80d57c4":"pred_test, label_test = clf.get_preds(DatasetType.Test, ordered=True)","61b38958":"pred_test_ = pred_test.argmax(1)\npred_test_l = [data_clf.train_ds.y.classes[n] for n in pred_test_]","1752942a":"res = pd.Series(pred_test_l, index=data_test.index, name=\"label\")","b23e2b80":"res.index.name = \"id\"","5c01246a":"pd.DataFrame(res).to_csv(\"submission.csv\")","67bd70a4":"Let's join them together, putting titles at the end.","75b2dff1":"Some rows have missing article titles or texts - let's fix that.","5d753d71":"## Classification","05979a1f":"## Language model fine-tuning ","7147542b":"A Kaggle kernel's memory is not infinite, so let's do some clean up.","f44a0079":"## Load the data ","7ded01e0":"## Validation ","8ae9b5f6":"## Make a submission ","863ee714":"# ULMFiT - the first place solution "}}