{"cell_type":{"df75865b":"code","30efd8a5":"code","1f79d6fc":"code","45d8e22e":"code","a571017c":"code","eb5c5718":"code","2401696d":"code","918a74b6":"code","12d4ef5c":"code","22538147":"code","fd869714":"code","639dd9f0":"code","efe671ad":"code","405c2957":"code","1da78812":"code","8f76e689":"code","5ecc70d7":"code","aa4f55b9":"code","0b1636dd":"code","14ff0f04":"code","d404be0a":"code","815ebc26":"code","2c310bb9":"code","b3b61d70":"code","1cb2fff2":"code","ee777612":"code","e6410a24":"code","09ee0216":"markdown","142c38ce":"markdown","32e22a3c":"markdown","3a3a950e":"markdown","b9749ea8":"markdown","6d119d76":"markdown","51308552":"markdown","2c84b52f":"markdown","e6d69314":"markdown","1fb52763":"markdown","246648c2":"markdown","9d58b7db":"markdown","b342e297":"markdown","f906f1fb":"markdown","d6465911":"markdown","8f89efa2":"markdown","f0e29a9b":"markdown","f89e09ac":"markdown","f69206f6":"markdown","1dd50e23":"markdown","07bc2906":"markdown","8bcf7495":"markdown","72162b2c":"markdown","585a7870":"markdown","efb69230":"markdown","b6f13f91":"markdown"},"source":{"df75865b":"import os\nimport pandas as pd\nimport numpy as np\nimport seaborn as sns\nimport math\nimport matplotlib.pyplot as plt\nimport matplotlib.cm as cm\nimport statsmodels.api as sm\nimport statsmodels.formula.api as smf\nsns.set(style=\"darkgrid\")","30efd8a5":"train_df = pd.read_csv('..\/input\/training_set.csv')\ntrain_df.head(5)","1f79d6fc":"train_meta = pd.read_csv('..\/input\/training_set_metadata.csv')\ntrain_meta.head()","45d8e22e":"train_meta.describe()","a571017c":"help_dict = {'object_id' : 'Object ID',\n                'ra' : 'Right Ascension, corresponding to latitude', \n                'decl' : 'Declination (corresponding to longitude)',\n                'gal_l': 'Galactic coordinate 1',\n                'gal_b': 'Galactic coordinate 2',\n                'ddf': 'Object is observed usning Deep Drilling Field (DDFs have more observations but cover a smaller chunk of sky)',\n                'hostgal_specz': 'The spectroscopic redshift of the source8. This is an extremely accurate measure of redshift, provided for the training set and a small fraction of the test set (given as float32 numbers).',\n                'hostgal_photoz': 'The photometric redshift of the host galaxy of the astronomical source. While this is meant to be a proxy for hostgal specz, there can be large differences between the two and hostgal photoz should be regarded as a far less accurate version of hostgal specz',\n                'hostgal_photoz_err': 'The uncertainty on the hostgal photoz based on LSST survey projections.',\n                'distmod': 'The distance (modulus) calculated from the hostgal photoz since this redshift is given for all objects (given as float32 numbers). Computing the distance modulus requires knowledge of General Relativity, and assumed values of the dark energy and dark matter content of the Universe, as mentioned in the introduction section.',\n                'mwebv' : 'MW E(B-V): this \u2018extinction\u2019 of light is a property of the Milky Way (MW) dust along the line of sight to the astronomical source, and is thus a function of the sky coordinates of the source ra, decl. This is used to determine a passband dependent dimming and reddening of light from astronomical sources as described in subsection 2.1',\n                'target': 'The class of the astronomical source. This is provided in the training data.'\n               }\n","eb5c5718":"plt.figure(figsize = (10,6))\nplt.subplot(111,projection ='aitoff')\nplt.scatter(x = (train_meta['ra']-180)*math.pi\/180, y = (train_meta['decl'])*math.pi\/180);","2401696d":"fig, ax = plt.subplots(figsize = (10,6))\nsns.countplot(train_meta['ddf']);","918a74b6":"fig, ax = plt.subplots(figsize = (10,6))\nsns.countplot(train_meta['target']);","12d4ef5c":"df_0 = train_meta.loc[train_meta['ddf']==0]\ndf_1 = train_meta.loc[train_meta['ddf']==1]\n\n\nymax = 1.1* max(list(100*df_1['target'].value_counts()\/len(df_1))+list(100*df_0['target'].value_counts()\/len(df_0)))\n\nplt.figure(figsize = (20,6))\nplt.subplot(121)\nax = sns.barplot(x=\"target\", y=\"target\", data=df_1, estimator=lambda x: len(x) \/ len(df_1) * 100)\nax.set(ylabel=\"%\", xlabel ='Target')\nax.set_ylim(0,ymax)\nplt.title('DDF')\nplt.subplot(122)\nax = sns.barplot(x=\"target\", y=\"target\", data=df_0, estimator=lambda x: len(x) \/ len(df_0) * 100)\nax.set(ylabel=\"%\", xlabel ='Target')\nax.set_ylim(0,ymax)\nplt.title('Wide Angle');","22538147":"df_1['target'].loc[df_1['target'].isin([53,64])].value_counts()","fd869714":"plt.figure(figsize = (10,8))\nax = plt.subplot(111)\nax.scatter(train_meta['hostgal_photoz'],train_meta['hostgal_specz'], marker = '.')\nax.errorbar(train_meta['hostgal_photoz'],train_meta['hostgal_specz'], xerr= None, yerr= train_meta['hostgal_photoz_err'],fmt='none');","639dd9f0":"model = smf.ols(formula='hostgal_specz ~ hostgal_photoz', data=train_meta)\nresults = model.fit()\nprint(results.summary())","efe671ad":"plt.figure(figsize = (10,8))\nax = plt.subplot(111)\nfig = sm.graphics.plot_fit(results, 1, ax=ax)","405c2957":"train_meta['hostgal_sq_diff'] = (train_meta['hostgal_photoz'] - train_meta['hostgal_specz'])**2\ntrain_meta['hostgal_diff'] = train_meta['hostgal_photoz'] - train_meta['hostgal_specz']\ncorr = train_meta.corr()\n\n# create a heatmap plot\nsns.set(style=\"white\")\n# Generate a mask for the upper triangle\nmask = np.zeros_like(corr, dtype=np.bool)\nmask[np.triu_indices_from(mask)] = True\n\n# Set up the matplotlib figure\nf, ax = plt.subplots(figsize=(11, 9))\n\n# Generate a custom diverging colormap\ncmap = sns.diverging_palette(150, 275, s=80, l=55, n=9,as_cmap = True)\n\n# Draw the heatmap with the mask and correct aspect ratio\nsns.heatmap(corr, mask=mask, cmap=cmap, vmax=.3, center=0,\n            square=True, linewidths=.5, cbar_kws={\"shrink\": .5});","1da78812":"model = smf.ols(formula='hostgal_specz ~ hostgal_photoz + hostgal_photoz_err', data=train_meta)\nresults = model.fit()\nprint(results.summary())","8f76e689":"plt.figure(figsize = (20,8))\nax = plt.subplot(121)\nfig = sm.graphics.plot_fit(results, 1, ax=ax)\nax = plt.subplot(122)\nfig = sm.graphics.plot_fit(results, 2, ax=ax)","5ecc70d7":"model = smf.ols(formula='hostgal_specz ~ hostgal_photoz * hostgal_photoz_err', data=train_meta)\nresults = model.fit()\nprint(results.summary())","aa4f55b9":"plt.figure(figsize = (21,8))\nax = plt.subplot(131)\nfig = sm.graphics.plot_fit(results, 1, ax=ax)\nax = plt.subplot(132)\nfig = sm.graphics.plot_fit(results, 2, ax=ax)\nax = plt.subplot(133)\nfig = sm.graphics.plot_fit(results, 3, ax=ax)","0b1636dd":"cols = list(train_meta)\nplt.subplots_adjust(hspace = 2)\nplt.figure(figsize = (20,30))\nplt.title('Histograms');\nfor counter, col in enumerate(cols):\n    index = counter+1\n    ax = plt.subplot(7,2,index)\n    ax.hist(train_meta[col].dropna(), bins=10)\n    plt.title(col);\n","14ff0f04":"train_meta.isna().sum()","d404be0a":"train_df.isna().sum()","815ebc26":"train_meta['dist_mod_missing'] = train_meta['distmod'].isna()","2c310bb9":"corr = train_meta.corr()\n\n# create a heatmap plot\nsns.set(style=\"white\")\n# Generate a mask for the upper triangle\nmask = np.zeros_like(corr, dtype=np.bool)\nmask[np.triu_indices_from(mask)] = True\n\n# Set up the matplotlib figure\nf, ax = plt.subplots(figsize=(11, 9))\n\n# Generate a custom diverging colormap\ncmap = sns.diverging_palette(150, 275, s=80, l=55, n=9,as_cmap = True)\n\n# Draw the heatmap with the mask and correct aspect ratio\nsns.heatmap(corr, mask=mask, cmap=cmap, vmax=.3, center=0,\n            square=True, linewidths=.5, cbar_kws={\"shrink\": .5});","b3b61d70":"plt.figure(figsize = (10,8))\nsns.barplot(train_meta.groupby(['target']).sum().index,train_meta.groupby(['target']).sum()['dist_mod_missing']);","1cb2fff2":"test_df_reader = pd.read_csv('..\/input\/test_set.csv',chunksize = 1000) # use an iterator as otherwise file too large\ntest_df_reader.get_chunk(5)","ee777612":"# arrays_of_sums = [chunk.isna().sum() for chunk in test_df_reader]\n# sum(arrays_of_sums)","e6410a24":"test_meta = pd.read_csv('..\/input\/test_set_metadata.csv')\ntest_meta.head()","09ee0216":"We can see that infact there are entries for classes 53 and 64, but not many.","142c38ce":"**Position in the sky:**","32e22a3c":"## **Training data**","3a3a950e":"**Import meta data:**","b9749ea8":"We now use an interaction effect as well:","6d119d76":"**Redshift measurment differences:**","51308552":"Look for missing data:","2c84b52f":"**Count of each astronomical object:**","e6d69314":"**Import light curve data:**","1fb52763":"**DDF vs non-DDF Count:**[](http:\/\/)","246648c2":"**Plot histograms for each variable in metadata:**","9d58b7db":"Only missing values are in distance variable. See if the missingness is related to anything else:","b342e297":"**Import meta data:**","f906f1fb":"**Import libraries:**","d6465911":"## **Test data**","8f89efa2":"Missingness strongly negatively correlated with redshift measures (and error) and the target.  Looking closer at the target correlation:","f0e29a9b":"There is a cluster of points which in reality have very low redshift but are measured at a a quite high photometric redshift. We will see if the error is correlated with any other variables:","f89e09ac":"Much better results.","f69206f6":"If we actually look at the numbers for DDF:","1dd50e23":"So to fill these distances in we will build a classification system for these five classes and then fill in within the class.","07bc2906":"The difference in the redshift measurements is basically not correlated with anything except the measurements themselves. By visual inspection of the first plot it looks as if a predictive model using the photometric measurment and known error may predict spectroscopic measurement fairly well:","8bcf7495":"**Import light curve data:****","72162b2c":"Things which immediately jump out:\n* The DDF group has a much higher proportion of object class 90.\n* The DDF group very little objects of class 6 or 15 compared to Wide Angle.\n* The DDF group has (almost) no objects of class 53 or 64 wheras Wide Angle does.","585a7870":"Run a linear regression on this data:","efb69230":"**Percentage of each astronomical object (DDf vs non DDF):**","b6f13f91":"**Find missing values in all datasets**"}}