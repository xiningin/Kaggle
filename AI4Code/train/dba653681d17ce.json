{"cell_type":{"9b90e652":"code","86b25633":"code","d4c4f57d":"code","f4345c46":"code","6b23d05b":"code","bab9478d":"code","0d0f1207":"code","5b9f083b":"code","ef04f456":"code","984aa0e1":"code","2fcff072":"code","04ccda90":"code","8abcb161":"code","78a14063":"code","dc301ab5":"code","07f2aaf7":"code","1e1f3000":"code","901fc2f0":"code","d210fdff":"code","90375978":"code","50c8a79a":"code","69e384b9":"code","7cb6c706":"code","b8f088f2":"code","b3f16a6c":"code","5349fc6a":"code","8edd8cd2":"code","49b76b2d":"code","cde01bae":"code","bccc210c":"code","8d31134f":"code","e02704d2":"code","04ce0081":"code","e61428dd":"markdown","44beb0d7":"markdown","aa1f3ca8":"markdown","3c1695b2":"markdown","79e5c0cf":"markdown","f82bdec3":"markdown","4e0d363e":"markdown","771394ba":"markdown","28843949":"markdown","21f95887":"markdown","0363d409":"markdown","04830e64":"markdown"},"source":{"9b90e652":"import numpy as np\nimport pandas as pd\nimport matplotlib.pyplot as plt\nimport seaborn as sns\nimport plotly\nimport plotly.express as px\nimport plotly.graph_objects as go\nfrom plotly.offline import download_plotlyjs, init_notebook_mode, plot, iplot, plot_mpl\nimport plotly.offline as py\nimport folium\nimport Bio.SeqIO\ninit_notebook_mode(connected=True)\nplt.rcParams.update({'font.size': 14})","86b25633":"confirmed_df = pd.read_csv('..\/input\/novel-corona-virus-2019-dataset\/time_series_covid_19_confirmed.csv')\ndeaths_df = pd.read_csv('..\/input\/novel-corona-virus-2019-dataset\/time_series_covid_19_deaths.csv')\nrecoveries_df = pd.read_csv('..\/input\/novel-corona-virus-2019-dataset\/time_series_covid_19_recovered.csv')","d4c4f57d":"# Drop date columns if they are mostly NaN\nna_columns = (confirmed_df.isna().sum() \/ confirmed_df.shape[0]) > 0.99\nna_columns = na_columns[na_columns]\n\nconfirmed_df = confirmed_df.drop(na_columns.index, axis=1)\ndeaths_df = deaths_df.drop(na_columns.index, axis=1)\nrecoveries_df = recoveries_df.drop(na_columns.index, axis=1)","f4345c46":"## Tidy up the data\nconfirmed_df = confirmed_df.melt(id_vars=['Country\/Region', 'Province\/State', 'Lat', 'Long'], var_name='date', value_name='confirmed')\ndeaths_df = deaths_df.melt(id_vars=['Country\/Region', 'Province\/State', 'Lat', 'Long'], var_name='date', value_name='deaths')\nrecoveries_df = recoveries_df.melt(id_vars=['Country\/Region', 'Province\/State', 'Lat', 'Long'], var_name='date', value_name='recoveries')","6b23d05b":"confirmed_df['date'] = pd.to_datetime(confirmed_df['date'])\ndeaths_df['date'] = pd.to_datetime(deaths_df['date'])\nrecoveries_df['date'] = pd.to_datetime(recoveries_df['date'])","bab9478d":"full_df = confirmed_df.merge(recoveries_df).merge(deaths_df)\nfull_df = full_df.rename(columns={'Country\/Region': 'Country', 'date': 'Date', 'confirmed': \"Confirmed\", \"recoveries\": \"Recoveries\", \"deaths\": \"Deaths\"})\n# Check null values\nfull_df.isnull().sum()","0d0f1207":"world_df = full_df.groupby(['Date']).agg({'Confirmed': ['sum'], 'Recoveries': ['sum'], 'Deaths': ['sum']}).reset_index()\nworld_df.columns = world_df.columns.get_level_values(0)\n\ndef add_rates(df):\n    df['Confirmed Change'] = df['Confirmed'].diff().shift(-1)\n \n    df['Mortality Rate'] = df['Deaths'] \/ df['Confirmed']\n    df['Recovery Rate'] = df['Recoveries'] \/ df['Confirmed']\n    df['Growth Rate'] = df['Confirmed Change'] \/ df['Confirmed']\n    df['Growth Rate Change'] = df['Growth Rate'].diff().shift(-1)\n    df['Growth Rate Accel'] = df['Growth Rate Change'] \/ df['Growth Rate']\n    return df\n\nworld_df = add_rates(world_df)","5b9f083b":"def plot_aggregate_metrics(df, fig=None):\n    if fig is None:\n        fig = go.Figure()\n    fig.update_layout(template='plotly_dark')\n    fig.add_trace(go.Scatter(x=df['Date'], \n                             y=df['Confirmed'],\n                             mode='lines+markers',\n                             name='Confirmed',\n                             line=dict(color='Yellow', width=2)\n                            ))\n    fig.add_trace(go.Scatter(x=df['Date'], \n                             y=df['Deaths'],\n                             mode='lines+markers',\n                             name='Deaths',\n                             line=dict(color='Red', width=2)\n                            ))\n    fig.add_trace(go.Scatter(x=df['Date'], \n                             y=df['Recoveries'],\n                             mode='lines+markers',\n                             name='Recoveries',\n                             line=dict(color='Green', width=2)\n                            ))\n    return fig","ef04f456":"plot_aggregate_metrics(world_df).show()","984aa0e1":"def plot_diff_metrics(df, fig=None):\n    if fig is None:\n        fig = go.Figure()\n\n    fig.update_layout(template='plotly_dark')\n    fig.add_trace(go.Scatter(x=df['Date'], \n                             y=df['Mortality Rate'],\n                             mode='lines+markers',\n                             name='Mortality rate',\n                             line=dict(color='red', width=2)))\n\n    fig.add_trace(go.Scatter(x=df['Date'], \n                             y=df['Recovery Rate'],\n                             mode='lines+markers',\n                             name='Recovery rate',\n                             line=dict(color='Green', width=2)))\n\n    fig.add_trace(go.Scatter(x=df['Date'], \n                             y=df['Growth Rate'],\n                             mode='lines+markers',\n                             name='Growth rate confirmed',\n                             line=dict(color='Yellow', width=2)))\n    fig.update_layout(yaxis=dict(tickformat=\".2%\"))\n    \n    return fig","2fcff072":"plot_diff_metrics(world_df).show()","04ccda90":"fig = go.Figure()\nfig.update_layout(template='plotly_dark')\n\ntmp_df = world_df.copy()\ntmp_df = tmp_df[tmp_df['Growth Rate Accel'] < 10]\n\nfig.add_trace(go.Scatter(x=tmp_df['Date'], \n                         y=tmp_df['Growth Rate Accel'],\n                         mode='lines+markers',\n                         name='Growth Acceleration',\n                         line=dict(color='Green', width=3)))\nfig.update_layout(yaxis=dict(tickformat=\".2%\"))\n\nfig.show()","8abcb161":"confirmed_by_country_df = full_df.groupby(['Date', 'Country']).sum().reset_index()","78a14063":"fig = px.line(confirmed_by_country_df, x='Date', y='Confirmed', color='Country', line_group=\"Country\", hover_name=\"Country\")\nfig.update_layout(template='plotly_dark')\nfig.show()","dc301ab5":"# Log scale to allow for view\n#  (1) of countries other than China, and\n#  (2) identifying linear sections, which indicate exponential growth\nfig = px.line(confirmed_by_country_df, x='Date', y='Confirmed', color='Country', line_group=\"Country\", hover_name=\"Country\")\nfig.update_layout(\n    template='plotly_dark',\n    yaxis_type=\"log\"\n)\nfig.show()","07f2aaf7":"confirmed_by_country_df.groupby('Country').max().sort_values(by='Confirmed', ascending=False)[:60]","1e1f3000":"k_layout_kwargs = {\n    'font': dict(size=12,),\n    'legend': dict(x=0, y=-0.7),\n}","901fc2f0":"bg_df = confirmed_by_country_df[confirmed_by_country_df['Country'] == 'Serbia'].copy()\nbg_df = add_rates(bg_df)","d210fdff":"plot_aggregate_metrics(bg_df).show()","90375978":"plot_diff_metrics(tmp_df).show()","50c8a79a":"from sklearn.linear_model import LinearRegression\n\nbg_growth_rates = {}\n\nn_days_to_fit = 7\nconfirmed_bg_df = confirmed_by_country_df[(confirmed_by_country_df['Country'] == 'Serbia') & (confirmed_by_country_df['Date'] >= (np.datetime64('today') - np.timedelta64(n_days_to_fit,'D')))]\n\nx = (confirmed_bg_df['Date'] - confirmed_bg_df['Date'].min()).dt.days.to_numpy().reshape(-1, 1)\ny = np.log(confirmed_bg_df['Confirmed'])\nreg = LinearRegression().fit(x, y)\nprint(f\"Model fit score: {reg.score(x, y):.2f}\")\nprint(f\"Growth rate: {reg.coef_[0]:.3f}\")\nbg_growth_rates[n_days_to_fit] = reg.coef_[0]\n\nfig = go.Figure()\n\nfig.add_trace(\n    go.Scatter(\n        x=x[:,0],\n        y=np.exp(y),\n        name='Serbia - Current fit'\n    )\n)\n\nxx = np.linspace(0, len(x[:,0]) + 14, 100)  # Forecast 14 days out\nyy = reg.predict(xx.reshape(-1,1))\n\nfig.add_trace(\n    go.Scatter(\n        x=xx,\n        y=np.exp(yy),\n        name='Serbia - Exponential fit',\n        mode='lines',\n    )\n)\n\nfig.update_layout(\n    title=f\"Exponential Model of Serbia. Confirmed Cases<br>(fit to last {n_days_to_fit} days) with 14-Day Extrapolation\",\n    xaxis_title=f\"Days since {confirmed_bg_df['Date'].min()}\",\n    yaxis_title=\"Number of Confirmed Cases\",\n    yaxis_type=\"log\",\n    template=\"plotly_dark\",\n    **k_layout_kwargs,\n)\n\nfig.show()\n\nn_days_to_fit = 4\nconfirmed_bg_df = confirmed_by_country_df[(confirmed_by_country_df['Country'] == 'Serbia') & (confirmed_by_country_df['Date'] >= (np.datetime64('today') - np.timedelta64(n_days_to_fit,'D')))]\n\nx = (confirmed_bg_df['Date'] - confirmed_bg_df['Date'].min()).dt.days.to_numpy().reshape(-1, 1)\ny = np.log(confirmed_bg_df['Confirmed'])\n\nreg = LinearRegression().fit(x, y)\nprint(f\"Model fit score: {reg.score(x, y):.2f}\")\nprint(f\"Growth rate: {reg.coef_[0]:.3f}\")\nbg_growth_rates[n_days_to_fit] = reg.coef_[0]\n\nfig = go.Figure()\n\nfig.add_trace(\n    go.Scatter(\n        x=confirmed_by_country_df[confirmed_by_country_df['Country'] == 'Serbia']['Date'],\n        y=confirmed_by_country_df[confirmed_by_country_df['Country'] == 'Serbia']['Confirmed'],\n        name='Serbia - Current fit',\n        line=dict(width=4)\n    )\n)\n\npredict_days_out = 7*2\n\nexponential_fit_date_range = pd.date_range(confirmed_bg_df['Date'].min(), confirmed_bg_df['Date'].max() + np.timedelta64(predict_days_out,'D'))\n\nxx = np.linspace(0, len(x[:,0]) + predict_days_out, exponential_fit_date_range.shape[0])  # Forecast 14 days out\nyy = reg.predict(xx.reshape(-1,1))\n\nfig.add_trace(\n    go.Scatter(\n        x=exponential_fit_date_range,\n        y=np.exp(yy),\n        name='Serbia - Exponential fit',\n        mode='lines'\n    )\n)\n\nfig.update_layout(\n    title=f\"Exponential Model of Serbia Confirmed Cases<br>(fit to last {n_days_to_fit} days) with {predict_days_out}-Day Extrapolation\",\n    xaxis_title=f\"Date\",\n    yaxis_title=\"Number of Confirmed Cases\",\n    yaxis_type=\"log\",\n    template=\"plotly_dark\",\n    **k_layout_kwargs,\n)\n\nfig.show()","69e384b9":"proxy_country = 'Italy'\n\nconfirmed_italy_df = confirmed_by_country_df[(confirmed_by_country_df['Country'] == proxy_country) & (confirmed_by_country_df['Confirmed'] >= 100)]\n\nx = (confirmed_italy_df['Date'] - confirmed_italy_df['Date'].min()).dt.days.to_numpy().reshape(-1, 1)\ny = np.log(confirmed_italy_df['Confirmed'])\nreg = LinearRegression().fit(x, y)\nprint(f\"Model fit score: {reg.score(x, y):.2f}\")\nprint(f\"Growth rate: {reg.coef_[0]:.3f}\")\nitaly_growth_rate = reg.coef_[0]\n\nfig = go.Figure()\n\nfig.add_trace(\n    go.Scatter(\n        x=x[:,0],\n        y=np.exp(y),\n        name=proxy_country\n    )\n)\n\nxx = np.linspace(0, len(x[:,0]) + 14, 100)  # Forecast 14 days out\nyy = reg.predict(xx.reshape(-1,1))\n\nfig.add_trace(\n    go.Scatter(\n        x=xx,\n        y=np.exp(yy),\n        name=f'{proxy_country} - Exponential fit'\n    )\n)\n\nfig.update_layout(\n    title=f\"Exponential Model of {proxy_country} Confirmed Cases<br>with 14-Day Extrapolation\",\n    xaxis_title=f\"Days since {confirmed_italy_df['Date'].min()}\",\n    yaxis_title=\"Number of Confirmed Cases\",\n    yaxis_type=\"log\",\n    template=\"plotly_dark\",\n    **k_layout_kwargs,\n)\n\nfig.show()","7cb6c706":"def linear_model(x, a, b):\n    return b * x + a\n\n\ndef linear_model_fixed_slope(slope):\n    def func(x, intercept):\n        return linear_model(x, a=intercept, b=slope)\n    \n    return func\n\ntest_model = linear_model_fixed_slope(2)\nx = np.array([1, 2, 3])\ntest_model(x=x, intercept=2)","b8f088f2":"from scipy.optimize import curve_fit\n\n\ndef get_model(model, popt):\n    def fitted_model(x):\n        return model(x, *popt)\n    return fitted_model\n\n\nx = (confirmed_bg_df['Date'] - confirmed_bg_df['Date'].min()).dt.days.to_numpy()\ny = np.log(confirmed_bg_df['Confirmed'].to_numpy())\n\n# Pull the slope from the Italy model and use for the U.S., allowing only the intercept to vary\nmodel = linear_model_fixed_slope(italy_growth_rate)\npopt, pcov = curve_fit(model, x, y)\n\nfitted_model_italy_rate = get_model(model, popt)\n\n# Now do the same using the slope from the Malta model\nbg_growth_rate_n_days_to_fit = 4\nprint(bg_growth_rate_n_days_to_fit)\n\nmodel = linear_model_fixed_slope(bg_growth_rates[bg_growth_rate_n_days_to_fit])\npopt, pcov = curve_fit(model, x, y)\n\nfitted_model_bg_rate = get_model(model, popt)\n\n# Plot results\nfor layout_kwargs in [{}, {\"yaxis_type\": \"log\"}]:\n    fig = go.Figure()\n\n    fig.add_trace(\n        go.Scatter(\n            x=confirmed_by_country_df[confirmed_by_country_df['Country'] == 'Serbia']['Date'],\n            y=confirmed_by_country_df[confirmed_by_country_df['Country'] == 'Serbia']['Confirmed'],\n            name='Serbia - Current fit',\n            line=dict(width=4)\n        )\n    )\n\n    exponential_fit_date_range = pd.date_range(confirmed_bg_df['Date'].min(), confirmed_bg_df['Date'].max() + np.timedelta64(14,'D'))\n\n    xx = np.linspace(0, len(x) + 14, exponential_fit_date_range.shape[0])  # Forecast 14 days out\n    yy = fitted_model_italy_rate(xx)\n\n    fig.add_trace(\n        go.Scatter(\n            x=exponential_fit_date_range,\n            y=np.exp(yy),\n            name=f'Serbia - Exponential fit based on {proxy_country} growth rate ({italy_growth_rate:.0%})',\n            mode='lines'\n        )\n    )\n\n    #########\n\n    yy = fitted_model_bg_rate(xx)\n\n    fig.add_trace(\n        go.Scatter(\n            x=exponential_fit_date_range,\n            y=np.exp(yy),\n            name=f'Serbia - Exponential fit based on US growth rate ({bg_growth_rates[bg_growth_rate_n_days_to_fit]:.0%}) (fitted to {bg_growth_rate_n_days_to_fit} days)',\n            mode='lines'\n        )\n    )\n\n    fig.update_layout(\n        title=\"Exponential Model of Serbia Confirmed Cases<br>with 14-Day Extrapolation\",\n        xaxis_title=\"Date\",\n        yaxis_title=\"Number of Confirmed Cases\",\n        template=\"plotly_dark\",\n        **k_layout_kwargs,\n        **layout_kwargs\n    )\n\n    fig.show()","b3f16a6c":"from fbprophet.plot import plot_plotly\nfrom fbprophet import Prophet\nfrom fbprophet.plot import add_changepoints_to_plot","5349fc6a":"full_pop = 330e6\n\n#floor_model = lambda x: max(x - 1, 0)  # Use the value itself because the function only increases\nfloor_model = lambda x: round(0.65 * x)\ncap_model = lambda x: round(min(full_pop, 1.5 * x + 10000))  # 50% above plus one to ensure floor > cap at 0\n\n# Modeling Serbia confirmed cases \nconfirmed_training_df = confirmed_by_country_df[(confirmed_by_country_df['Country'] == 'Serbia') & (confirmed_by_country_df['Confirmed'] > 0)]\nconfirmed_training_df = confirmed_training_df.rename(columns={'Date': 'ds', 'Confirmed': 'y'}).reset_index(drop=True)\n\nconfirmed_training_df['floor'] = confirmed_training_df.y.apply(floor_model)\nconfirmed_training_df['cap'] = confirmed_training_df.y.apply(cap_model)","8edd8cd2":"confirmed_training_df.y = confirmed_training_df.y.apply(np.log10)\nconfirmed_training_df.floor = confirmed_training_df.floor.apply(np.log10)\nconfirmed_training_df.cap = confirmed_training_df.cap.apply(np.log10)","49b76b2d":"# Total confirmed model \nm = Prophet(\n    growth='linear',\n    #interval_width=0.90,\n    changepoint_prior_scale=0.05,\n    changepoint_range=0.9,\n    yearly_seasonality=False,\n    weekly_seasonality=False,\n    daily_seasonality=False,\n    #n_changepoints=2\n)\nm.fit(confirmed_training_df)\nfuture = m.make_future_dataframe(periods=14)\nfuture['floor'] = confirmed_training_df.floor\nfuture['cap'] = confirmed_training_df.cap\nconfirmed_forecast = m.predict(future)","cde01bae":"for kwargs in [{}, {\"yaxis_type\": \"log\"}]:\n    fig = plot_plotly(m, confirmed_forecast, plot_cap=False, changepoints=True)\n    annotations = []\n    annotations.append(dict(\n        xref='paper',\n        yref='paper',\n        x=0.0,\n        y=1.15,\n        xanchor='left',\n        yanchor='bottom',\n        text='Predictions for log10 Confirmed cases Serbia',\n        font=dict(\n            family='Arial',\n            size=30,\n            color='rgb(37,37,37)'),\n        showarrow=False))\n    fig.update_layout(\n        annotations=annotations,\n        **kwargs\n    )\n    fig.show()","bccc210c":"for kwargs in [{}, {\"yaxis_type\": \"log\"}]:\n    fig = plot_plotly(m, confirmed_forecast, plot_cap=False, changepoints=True)\n    annotations = []\n    annotations.append(dict(\n        xref='paper',\n        yref='paper',\n        x=0.0,\n        y=1.15,\n        xanchor='left',\n        yanchor='bottom',\n        text='Predictions for Confirmed cases Serbia',\n        font=dict(\n            family='Arial',\n            size=30,\n            color='rgb(37,37,37)'),\n        showarrow=False))\n    fig.update_layout(\n        annotations=annotations,\n        **kwargs\n    )\n    for trace in fig.data:\n        trace.y = np.power(trace.y, 10)\n    fig.show()","8d31134f":"import pandas as pd\nCOVID19_line_list_data = pd.read_csv(\"..\/input\/novel-corona-virus-2019-dataset\/COVID19_line_list_data.csv\")\nCOVID19_open_line_list = pd.read_csv(\"..\/input\/novel-corona-virus-2019-dataset\/COVID19_open_line_list.csv\")\ncovid_19_data = pd.read_csv(\"..\/input\/novel-corona-virus-2019-dataset\/covid_19_data.csv\")\ntime_series_covid_19_confirmed = pd.read_csv(\"..\/input\/novel-corona-virus-2019-dataset\/time_series_covid_19_confirmed.csv\")\ntime_series_covid_19_deaths = pd.read_csv(\"..\/input\/novel-corona-virus-2019-dataset\/time_series_covid_19_deaths.csv\")\ntime_series_covid_19_recovered = pd.read_csv(\"..\/input\/novel-corona-virus-2019-dataset\/time_series_covid_19_recovered.csv\")","e02704d2":"import pandas as pd\nCOVID19_line_list_data = pd.read_csv(\"..\/input\/novel-corona-virus-2019-dataset\/COVID19_line_list_data.csv\")\nCOVID19_open_line_list = pd.read_csv(\"..\/input\/novel-corona-virus-2019-dataset\/COVID19_open_line_list.csv\")\ncovid_19_data = pd.read_csv(\"..\/input\/novel-corona-virus-2019-dataset\/covid_19_data.csv\")\ntime_series_covid_19_confirmed = pd.read_csv(\"..\/input\/novel-corona-virus-2019-dataset\/time_series_covid_19_confirmed.csv\")\ntime_series_covid_19_deaths = pd.read_csv(\"..\/input\/novel-corona-virus-2019-dataset\/time_series_covid_19_deaths.csv\")\ntime_series_covid_19_recovered = pd.read_csv(\"..\/input\/novel-corona-virus-2019-dataset\/time_series_covid_19_recovered.csv\")","04ce0081":"import pandas as pd\nCOVID19_line_list_data = pd.read_csv(\"..\/input\/novel-corona-virus-2019-dataset\/COVID19_line_list_data.csv\")\nCOVID19_open_line_list = pd.read_csv(\"..\/input\/novel-corona-virus-2019-dataset\/COVID19_open_line_list.csv\")\ncovid_19_data = pd.read_csv(\"..\/input\/novel-corona-virus-2019-dataset\/covid_19_data.csv\")\ntime_series_covid_19_confirmed = pd.read_csv(\"..\/input\/novel-corona-virus-2019-dataset\/time_series_covid_19_confirmed.csv\")\ntime_series_covid_19_deaths = pd.read_csv(\"..\/input\/novel-corona-virus-2019-dataset\/time_series_covid_19_deaths.csv\")\ntime_series_covid_19_recovered = pd.read_csv(\"..\/input\/novel-corona-virus-2019-dataset\/time_series_covid_19_recovered.csv\")","e61428dd":"# Worldwide Rates","44beb0d7":"The y-axis above is the log of the number of cases. So let's rescale that.","aa1f3ca8":"###### Top 60 countries by confirmed cases","3c1695b2":"# Worldwide Cases","79e5c0cf":"# Daily Percent Change in Growth Rate\n\nUseful for tracking whether the growth rate is increasing. Any positive percentage indicates exponential growth.","f82bdec3":"# Serbia Model with Prophet\n\nWe allow for a linear model that detects changepoints at Prophet's default significance. In effect, this is a spline of linear models. This is nice because we expect the growth rate to change at some points during the spread.","4e0d363e":"***You can select individual traces above by double-clicking on the legend on the right***","771394ba":"# COVID-19 Predictions for Serbia \nThis notebook tracks the spread of the novel coronavirus, also known as the COVID-19 in Serbia. COVID-19 is a contagious respiratory virus that first started in Wuhan in December 2019. Learn more from the [WHO](https:\/\/www.who.int\/emergencies\/diseases\/novel-coronavirus-2019) or [CDC](https:\/\/www.cdc.gov\/coronavirus\/2019-ncov).","28843949":"### Applying the proxy model to Serbia","21f95887":"# Confirmed Cases by Country","0363d409":"![](http:\/\/)# Modeling Serbia","04830e64":"Import the data (make sure you update this on a daily basis)"}}