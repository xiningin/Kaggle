{"cell_type":{"734b3e2a":"code","5b7ee188":"code","19b9d062":"code","26fa0ed9":"code","4d296a86":"code","3845257c":"code","b1f0bc59":"code","0eb5baad":"code","55b961f7":"code","262fa4c4":"code","30418f63":"code","34490dd8":"code","a76a3e77":"code","9fb9328c":"code","b0d4a1ed":"code","5e160147":"code","76f8f4cf":"code","4c126fa8":"code","d49bea3e":"code","264b2ae5":"code","11a99c79":"code","41139c84":"code","2d454d57":"code","4af4cd2a":"code","c6f57c5f":"code","f7900641":"code","a1d634f1":"code","80e9bda4":"code","6ab42b3b":"code","c1ea3673":"code","9716d672":"code","953fd6de":"code","ba6b05f1":"code","0c8017cf":"code","6ddeab3e":"code","9765018b":"code","ada5a8f7":"code","b2252c82":"code","ec31cbe9":"code","44a6aa6e":"code","113fe91a":"code","7b1a243e":"code","f98e01d6":"code","bb9592b5":"code","f1a0cc1f":"code","9aea5dab":"code","dd3aa79e":"code","a47426e3":"code","4237dd84":"code","e30e1c23":"code","4d45de36":"code","02bdab3d":"code","c614e714":"code","ac4d6e74":"code","6c48368f":"code","1418ba3c":"code","c4f04cb6":"code","99c960bc":"code","73c19630":"code","7cb6fe52":"code","7446f466":"code","30103430":"code","beec6b8f":"code","5803d929":"code","e02b6fb4":"code","96764904":"code","6cea5504":"code","d31fd90f":"code","a08171b4":"markdown","f6eef985":"markdown","f4020d14":"markdown","08463ef1":"markdown","e956d8a6":"markdown","1d7f8d06":"markdown","08660bfb":"markdown","95b5577a":"markdown","dc1ce909":"markdown","0d3ae2a7":"markdown","91948eab":"markdown","83852cdd":"markdown","a0647327":"markdown","638cb0d2":"markdown","bd4b4b4e":"markdown","9bf9bf79":"markdown","8110cb36":"markdown","08565652":"markdown","9d6e18e9":"markdown","17ce6567":"markdown","954bc88b":"markdown","effb5af3":"markdown","b6cc52f3":"markdown","f92eb519":"markdown","8a8f8044":"markdown","f5ada786":"markdown","736ab60b":"markdown","bb20cdbc":"markdown","9b5c601f":"markdown","ea23eea4":"markdown","a3c5f3b1":"markdown","310082f1":"markdown","43a9f074":"markdown","9494d231":"markdown","11dc6f12":"markdown","9325c5f1":"markdown","fed31884":"markdown","14cf823a":"markdown","a1c8cbd6":"markdown","aaa9f683":"markdown","11ab0cee":"markdown"},"source":{"734b3e2a":"import pandas as pd\nimport matplotlib.pyplot as plt\nimport seaborn as sns\nimport numpy as np\nimport warnings\nfrom datetime import datetime\nimport calendar\nfrom math import sin, cos, sqrt, atan2, radians,asin\nimport folium\nfrom folium import FeatureGroup, LayerControl, Map, Marker\nfrom folium.plugins import HeatMap\nfrom folium.plugins import TimestampedGeoJson\nfrom folium.plugins import MarkerCluster\nfrom geopy.distance import great_circle\nimport matplotlib.dates as mdates\nimport matplotlib as mpl\nfrom datetime import timedelta\nimport datetime as dt\nwarnings.filterwarnings('ignore')\npd.set_option('display.max_colwidth', -1)\nplt.style.use('fivethirtyeight')\nimport folium\nfrom sklearn.cluster import KMeans\nfrom sklearn import preprocessing\nfrom sklearn.model_selection import train_test_split\nfrom sklearn.preprocessing import Imputer\nfrom sklearn import linear_model\nfrom sklearn.metrics import mean_squared_error\nfrom sklearn.ensemble import RandomForestRegressor\nimport pickle\nfrom geopy.distance import geodesic","5b7ee188":"##the training data has 55M rows. In this kernel, we shall only read in 6M rows\ntrain=pd.read_csv(\"..\/input\/train.csv\",nrows=6000000)\ntrain.head()","19b9d062":"train.info()","26fa0ed9":"train['pickup_datetime']=pd.to_datetime(train['pickup_datetime'],format='%Y-%m-%d %H:%M:%S UTC')\ntrain.head()","4d296a86":"train['pickup_date']= train['pickup_datetime'].dt.date\ntrain['pickup_day']=train['pickup_datetime'].apply(lambda x:x.day)\ntrain['pickup_hour']=train['pickup_datetime'].apply(lambda x:x.hour)\ntrain['pickup_day_of_week']=train['pickup_datetime'].apply(lambda x:calendar.day_name[x.weekday()])\ntrain['pickup_month']=train['pickup_datetime'].apply(lambda x:x.month)\ntrain['pickup_year']=train['pickup_datetime'].apply(lambda x:x.year)","3845257c":"train[pd.isnull(train)].sum()","b1f0bc59":"plt.figure(figsize=(8,5))\nsns.kdeplot(train['fare_amount']).set_title(\"Distribution of Trip Fare\")","0eb5baad":"train.loc[train['fare_amount']<0].shape","55b961f7":"train=train.loc[train['fare_amount']>=0]\ntrain.shape","262fa4c4":"plt.figure(figsize=(8,5))\nsns.kdeplot(np.log(train['fare_amount'].values)).set_title(\"Distribution of fare amount (log scale)\")","30418f63":"print(\"Range of Pickup Latitude is \", (min(train['pickup_latitude']),max(train['pickup_latitude'])))","34490dd8":"print(\"Range of Dropoff Latitude is \", (min(train['dropoff_latitude']),max(train['dropoff_longitude'])))","a76a3e77":"#Before we  ahead and identify outlier location, let us read the test data and see what the boundaries are.\ntest =  pd.read_csv('..\/input\/test.csv')\nprint(\"Longitude Boundary in test data\")\nmin(test.pickup_longitude.min(), test.dropoff_longitude.min()),max(test.pickup_longitude.max(), test.dropoff_longitude.max())","9fb9328c":"print(\"Latitude Boundary in test data\")\nmin(test.pickup_latitude.min(), test.pickup_latitude.min()),max(test.pickup_latitude.max(), test.pickup_latitude.max())","b0d4a1ed":"boundary={'min_lng':-74.263242,\n              'min_lat':40.573143,\n              'max_lng':-72.986532, \n              'max_lat':41.709555}\n\n\n","5e160147":"train[(train.pickup_latitude==0) | (train.pickup_longitude)==0 | (train.dropoff_latitude==0)|(train.dropoff_longitude==0)].shape","76f8f4cf":"train.loc[~((train.pickup_longitude >= boundary['min_lng'] ) & (train.pickup_longitude <= boundary['max_lng']) &\n            (train.pickup_latitude >= boundary['min_lat']) & (train.pickup_latitude <= boundary['max_lat']) &\n            (train.dropoff_longitude >= boundary['min_lng']) & (train.dropoff_longitude <= boundary['max_lng']) &\n            (train.dropoff_latitude >=boundary['min_lat']) & (train.dropoff_latitude <= boundary['max_lat'])),'is_outlier_loc']=1\ntrain.loc[((train.pickup_longitude >= boundary['min_lng'] ) & (train.pickup_longitude <= boundary['max_lng']) &\n            (train.pickup_latitude >= boundary['min_lat']) & (train.pickup_latitude <= boundary['max_lat']) &\n            (train.dropoff_longitude >= boundary['min_lng']) & (train.dropoff_longitude <= boundary['max_lng']) &\n            (train.dropoff_latitude >=boundary['min_lat']) & (train.dropoff_latitude <= boundary['max_lat'])),'is_outlier_loc']=0\n\nprint(\"Outlier vs Non Outlier Counts\")\nprint(train['is_outlier_loc'].value_counts())\n\n# Let us drop rows, where location is outlier\ntrain=train.loc[train['is_outlier_loc']==0]\ntrain.drop(['is_outlier_loc'],axis=1,inplace=True)","4c126fa8":"city_long_border = (-74.03, -73.75)\ncity_lat_border = (40.63, 40.85)\n\ntrain.plot(kind='scatter', x='dropoff_longitude', y='dropoff_latitude',\n                color='green', \n                s=.02, alpha=.6)\nplt.title(\"Dropoffs\")\n\nplt.ylim(city_lat_border)\nplt.xlim(city_long_border)","d49bea3e":"\ntrain.plot(kind='scatter', x='pickup_longitude', y='pickup_latitude',\n                color='blue', \n                s=.02, alpha=.6)\nplt.title(\"Pickups\")\n\nplt.ylim(city_lat_border)\nplt.xlim(city_long_border)","264b2ae5":"# Let us round pickup and dropoff lat lng to 3 decimal places\ntrain['pickup_latitude_round3']=train['pickup_latitude'].apply(lambda x:round(x,3))\ntrain['pickup_longitude_round3']=train['pickup_longitude'].apply(lambda x:round(x,3))\ntrain['dropoff_latitude_round3']=train['dropoff_latitude'].apply(lambda x:round(x,3))\ntrain['dropoff_longitude_round3']=train['dropoff_longitude'].apply(lambda x:round(x,3))\n","11a99c79":"pickup_fare_amount=train.groupby(['pickup_latitude_round3','pickup_longitude_round3'])['fare_amount'].mean().reset_index().rename(columns={'fare_amount':'avg_fare'})\npickup_fare_amount.head()","41139c84":"JFK={'min_lng':-73.8352,\n     'min_lat':40.6195,\n     'max_lng':-73.7401, \n     'max_lat':40.6659}\nJFK_center=[40.6437,-73.7900]\n# Get all pickups to JFK\nJFK_data=train.loc[(train.pickup_latitude>=JFK['min_lat']) & (train.pickup_latitude<=JFK['max_lat'])]\nJFK_data=JFK_data.loc[(train.pickup_longitude>=JFK['min_lng']) & (train.pickup_longitude<=JFK['max_lng'])]\n\nprint(\"Number of Trips with Pickups from JFK\",JFK_data.shape[0])\n\nJFK_dropoff=train.loc[(train.dropoff_latitude>=JFK['min_lat']) & (train.dropoff_latitude<=JFK['max_lat'])]\nJFK_dropoff=JFK_dropoff.loc[(train.dropoff_longitude>=JFK['min_lng']) & (train.dropoff_longitude<=JFK['max_lng'])]\n\nprint(\"Number of Trips with Dropoffs to JFK\",JFK_dropoff.shape[0])\n\n'''\n# Create a folium map with JFK as the center \nm=folium.Map(location =JFK_center,zoom_start = 10,)\nfolium.Marker(location=JFK_center, popup='JFK Airport',icon=folium.Icon(color='black')).add_to(m)\n\n#mc = MarkerCluster().add_to(m)\n#Add markers in blue for each pickup location and line between JFK and Pickup location over time. The thickness of line indicates the fare_amount\n\nfor index,row in JFK_data.iterrows():\n    folium.Marker([row['dropoff_latitude'],row['dropoff_longitude']]).add_to(m)\n'''\n\n    ","2d454d57":"plt.figure(figsize=(8,5))\nsns.kdeplot(np.log(JFK_data['fare_amount'].values),label='JFK Pickups')\n#sns.kdeplot(np.log(JFK_dropoff['fare_amount'].values),label='JFK Dropoff')\nsns.kdeplot(np.log(train['fare_amount'].values),label='All Trips in Train data')\nplt.title(\"Fare Amount Distribution\")","4af4cd2a":"plt.figure(figsize=(8,5))\nsns.kdeplot(np.log(JFK_dropoff['fare_amount'].values),label='JFK')\nsns.kdeplot(np.log(train['fare_amount'].values),label='train')\nplt.title(\"Dropoffs vs Fare Amount\")","c6f57c5f":"del JFK_data\ndel JFK\ndel JFK_dropoff\n","f7900641":"## Based on the above, let us create a function to see whether pickup or dropoff is an Airport. \n\n'''\ndef isAirport(latitude,longitude,airport_name='JFK'):\n    if airport_name=='JFK':\n        boundary={'min_lng':-73.8352,\n     'min_lat':40.6195,\n     'max_lng':-73.7401, \n     'max_lat':40.6659}\n    elif airport_name=='EWR':\n        boundary={\n            'min_lng':-74.1925,\n            'min_lat':40.6700, \n            'max_lng':-74.1531, \n            'max_lat':40.7081\n\n        }\n    elif airport_name=='la guardia':\n        boundary={'min_lng':-73.8895, \n                  'min_lat':40.7664, \n                  'max_lng':-73.8550, \n                  'max_lat':40.7931\n                 }\n    if latitude>=boundary['min_lat'] and latitude<=boundary['max_lat']:\n        if longitude>=boundary['min_lng'] and longitude<=boundary['max_lng']:\n            return 1\n    else:\n        return 0\n        \n\n\n'''\n\nnyc_airports={'JFK':{'min_lng':-73.8352,\n     'min_lat':40.6195,\n     'max_lng':-73.7401, \n     'max_lat':40.6659},\n              \n    'EWR':{'min_lng':-74.1925,\n            'min_lat':40.6700, \n            'max_lng':-74.1531, \n            'max_lat':40.7081\n\n        },\n    'LaGuardia':{'min_lng':-73.8895, \n                  'min_lat':40.7664, \n                  'max_lng':-73.8550, \n                  'max_lat':40.7931\n        \n    }\n    \n}\ndef isAirport(latitude,longitude,airport_name='JFK'):\n    \n    if latitude>=nyc_airports[airport_name]['min_lat'] and latitude<=nyc_airports[airport_name]['max_lat'] and longitude>=nyc_airports[airport_name]['min_lng'] and longitude<=nyc_airports[airport_name]['max_lng']:\n        return 1\n    else:\n        return 0\n        \n","a1d634f1":"train['is_pickup_JFK']=train.apply(lambda row:isAirport(row['pickup_latitude'],row['pickup_longitude'],'JFK'),axis=1)\ntrain['is_dropoff_JFK']=train.apply(lambda row:isAirport(row['dropoff_latitude'],row['dropoff_longitude'],'JFK'),axis=1)","80e9bda4":"train['is_pickup_EWR']=train.apply(lambda row:isAirport(row['pickup_latitude'],row['pickup_longitude'],'EWR'),axis=1)\ntrain['is_dropoff_EWR']=train.apply(lambda row:isAirport(row['dropoff_latitude'],row['dropoff_longitude'],'EWR'),axis=1)","6ab42b3b":"train['is_pickup_la_guardia']=train.apply(lambda row:isAirport(row['pickup_latitude'],row['pickup_longitude'],'LaGuardia'),axis=1)\ntrain['is_dropoff_la_guardia']=train.apply(lambda row:isAirport(row['dropoff_latitude'],row['dropoff_longitude'],'LaGuardia'),axis=1)","c1ea3673":"#calculate trip distance in miles\ndef distance(lat1, lat2, lon1,lon2):\n    p = 0.017453292519943295 # Pi\/180\n    a = 0.5 - np.cos((lat2 - lat1) * p)\/2 + np.cos(lat1 * p) * np.cos(lat2 * p) * (1 - np.cos((lon2 - lon1) * p)) \/ 2\n    return 0.6213712 * 12742 * np.arcsin(np.sqrt(a))","9716d672":"train['trip_distance']=train.apply(lambda row:distance(row['pickup_latitude'],row['dropoff_latitude'],row['pickup_longitude'],row['dropoff_longitude']),axis=1)","953fd6de":"sns.kdeplot(np.log(train['trip_distance'].values)).set_title(\"Distribution of Trip Distance (log scale)\")","ba6b05f1":"plt.scatter(x=train['trip_distance'],y=train['fare_amount'])\nplt.xlabel(\"Trip Distance\")\nplt.ylabel(\"Fare Amount\")\nplt.title(\"Trip Distance vs Fare Amount\")","0c8017cf":"non_airport=train.loc[(train['is_dropoff_JFK']==0) & (train['is_dropoff_EWR']==0) & (train['is_dropoff_la_guardia']==0)]\nnon_airport=non_airport.loc[(non_airport['is_pickup_JFK']==0) & (non_airport['is_pickup_EWR']==0) & (non_airport['is_pickup_la_guardia']==0)]\nnon_airport.shape","6ddeab3e":"plt.scatter(x=non_airport['trip_distance'],y=non_airport['fare_amount'])\nplt.xlabel(\"Trip Distance\")\nplt.ylabel(\"Fare Amount\")\nplt.title(\"Trip Distance vs Fare Amount (excluding airport rides)\")","9765018b":"non_airport_long_trips=non_airport[non_airport['trip_distance']>=50]","ada5a8f7":"drop_map = folium.Map(location = [40.730610,-73.935242],zoom_start = 12,)\n#print(pickup.shape)\n### For each pickup point add a circlemarker\n\nfor index, row in non_airport_long_trips.iterrows():\n    \n    folium.CircleMarker([row['dropoff_latitude_round3'], row['dropoff_longitude_round3']],\n                        radius=3,\n                        \n                        color=\"#008000\", \n                        fill_opacity=0.9\n                       ).add_to(drop_map)\nfor index, row in non_airport_long_trips.iterrows():\n    \n    folium.CircleMarker([row['pickup_latitude_round3'], row['pickup_longitude_round3']],\n                        radius=3,\n                        \n                        color=\"blue\", \n                        fill_opacity=0.9\n                       ).add_to(drop_map)\n\n'''\nhm_wide = HeatMap( list(zip(drop.dropoff_latitude_round3.values, drop.dropoff_longitude_round3.values, drop.Num_Trips.values)),\n                     min_opacity=0.2,\n                     radius=5, blur=15,\n                     max_zoom=1 \n                 )\ndrop_map.add_child(hm_wide)\n\n'''\n\ndrop_map","b2252c82":"nyc_boroughs={\n    'manhattan':{\n        'min_lng':-74.0479,\n        'min_lat':40.6829,\n        'max_lng':-73.9067,\n        'max_lat':40.8820\n    },\n    \n    'queens':{\n        'min_lng':-73.9630,\n        'min_lat':40.5431,\n        'max_lng':-73.7004,\n        'max_lat':40.8007\n\n    },\n\n    'brooklyn':{\n        'min_lng':-74.0421,\n        'min_lat':40.5707,\n        'max_lng':-73.8334,\n        'max_lat':40.7395\n\n    },\n\n    'bronx':{\n        'min_lng':-73.9339,\n        'min_lat':40.7855,\n        'max_lng':-73.7654,\n        'max_lat':40.9176\n\n    },\n\n    'staten_island':{\n        'min_lng':-74.2558,\n        'min_lat':40.4960,\n        'max_lng':-74.0522,\n        'max_lat':40.6490\n\n    }\n    \n    \n    \n}","ec31cbe9":"def getBorough(lat,lng):\n    \n    locs=nyc_boroughs.keys()\n    for loc in locs:\n        if lat>=nyc_boroughs[loc]['min_lat'] and lat<=nyc_boroughs[loc]['max_lat'] and lng>=nyc_boroughs[loc]['min_lng'] and lng<=nyc_boroughs[loc]['max_lng']:\n            return loc\n    return 'others'\n\n        ","44a6aa6e":"train['pickup_borough']=train.apply(lambda row:getBorough(row['pickup_latitude'],row['pickup_longitude']),axis=1)\ntrain['dropoff_borough']=train.apply(lambda row:getBorough(row['dropoff_latitude'],row['dropoff_longitude']),axis=1)\n","113fe91a":"\ntrain.to_csv(\"Training_FeatureEngineering.csv\",index=False)\ndel train","7b1a243e":"train=pd.read_csv(\"Training_FeatureEngineering.csv\")\nplt.figure(figsize=(8,5))\nsns.countplot(y=train['pickup_borough'])\nplt.title(\"Distribution of Pickup Boroughs\")","f98e01d6":"\n\nplt.figure(figsize=(16,10))\nplt.title(\"Distribution of Fare Amount Across Buroughs\")\ni=1\nfor key in nyc_boroughs.keys():\n    plt.subplot(3,2,i)\n    sns.kdeplot(np.log(train.loc[train['pickup_borough']==key,'fare_amount'].values),label='Pickup '+ key)\n    sns.kdeplot(np.log(train.loc[train['dropoff_borough']==key,'fare_amount'].values),label='Dropoff'+ key).set_title(\"Fare Amount (log scale) for \"+key)\n    \n    i=i+1\n","bb9592b5":"plt.figure(figsize=(24,15))\nplt.title(\"Distribution of Trip Distances Across Buroughs\")\ni=1\nfor key in nyc_boroughs.keys():\n    plt.subplot(3,2,i)\n    sns.kdeplot(np.log(train.loc[train['pickup_borough']==key,'trip_distance'].values),label='Pickup '+ key)\n    sns.kdeplot(np.log(train.loc[train['dropoff_borough']==key,'trip_distance'].values),label='Dropoff'+ key).set_title(\"Trip Distance (log scale) for \"+key)\n    i=i+1","f1a0cc1f":"\nlower_manhattan_boundary={'min_lng': -74.0194,\n                          'min_lat':40.6997,\n                          'max_lng':-73.9716,\n                          'max_lat':40.7427}\n\ndef isLowerManhattan(lat,lng):\n    if lat>=lower_manhattan_boundary['min_lat'] and lat<=lower_manhattan_boundary['max_lat'] and lng>=lower_manhattan_boundary['min_lng'] and lng<=lower_manhattan_boundary['max_lng']:\n        return 1\n    else:\n        return 0\n    ","9aea5dab":"train['is_pickup_lower_manhattan']=train.apply(lambda row:isLowerManhattan(row['pickup_latitude'],row['pickup_longitude']),axis=1)\ntrain['is_dropoff_lower_manhattan']=train.apply(lambda row:isLowerManhattan(row['dropoff_latitude'],row['dropoff_longitude']),axis=1)","dd3aa79e":"manhattan=train.loc[(train['pickup_borough']=='manhattan') | (train['dropoff_borough']=='manhattan')]\nmanhattan.shape","a47426e3":"plt.figure(figsize=(8,5))\nsns.kdeplot(np.log(manhattan.loc[manhattan['is_pickup_lower_manhattan']==1,'fare_amount'].values),label='Lower Manhattan Pickups')\nsns.kdeplot(np.log(manhattan.loc[manhattan['is_pickup_lower_manhattan']==0,'fare_amount'].values),label='Rest of Manhattan Pickups')\nplt.xlabel(\"fare amount (log)\")\nplt.title(\"Distribution of Fare Amount - Manhattan vs Lower Manhattan\")","4237dd84":"plt.figure(figsize=(8,5))\nsns.kdeplot(np.log(manhattan.loc[manhattan['is_dropoff_lower_manhattan']==1,'fare_amount'].values),label='Lower Manhattan Dropoffs')\nsns.kdeplot(np.log(manhattan.loc[manhattan['is_dropoff_lower_manhattan']==0,'fare_amount'].values),label='Rest of Manhattan Dropoffs')\nplt.xlabel(\"fare amount (log)\")\nplt.title(\"Distribution of Fare Amount - Manhattan vs Lower Manhattan\")","e30e1c23":"plt.scatter(x=manhattan.loc[manhattan['is_pickup_lower_manhattan']==1,'trip_distance'].values,y=manhattan.loc[manhattan['is_pickup_lower_manhattan']==1,'fare_amount'].values)\nplt.xlabel(\"Trip Distance\")\nplt.ylabel(\"Fare Amount\")\nplt.title(\"Trip Distance vs Fare Amount (Lower Manhattan pickups)\")","4d45de36":"plt.scatter(x=manhattan.loc[manhattan['is_pickup_lower_manhattan']==0,'trip_distance'].values,y=manhattan.loc[manhattan['is_pickup_lower_manhattan']==0,'fare_amount'].values)\nplt.xlabel(\"Trip Distance\")\nplt.ylabel(\"Fare Amount\")\nplt.title(\"Trip Distance vs Fare Amount (Rest of Manhattan pickups)\")","02bdab3d":"plt.scatter(x=manhattan.loc[manhattan['is_dropoff_lower_manhattan']==1,'trip_distance'].values,y=manhattan.loc[manhattan['is_dropoff_lower_manhattan']==1,'fare_amount'].values)\nplt.xlabel(\"Trip Distance\")\nplt.ylabel(\"Fare Amount\")\nplt.title(\"Trip Distance vs Fare Amount (Lower Manhattan dropoffs)\")","c614e714":"plt.scatter(x=manhattan.loc[manhattan['is_dropoff_lower_manhattan']==0,'trip_distance'].values,y=manhattan.loc[manhattan['is_dropoff_lower_manhattan']==0,'fare_amount'].values)\nplt.xlabel(\"Trip Distance\")\nplt.ylabel(\"Fare Amount\")\nplt.title(\"Trip Distance vs Fare Amount (Rest of Manhattan dropoffs)\")\n\ndel manhattan\ndel non_airport_long_trips\ndel non_airport","ac4d6e74":"trips_year=train.groupby(['pickup_year'])['key'].count().reset_index().rename(columns={'key':'Num_Trips'})\ntrips_year.head()\nsns.barplot(x='pickup_year',y='Num_Trips',data=trips_year)","6c48368f":"trips_year_fareamount=train.groupby(['pickup_year'])['fare_amount'].mean().reset_index().rename(columns={'fare_amount':'avg_fare_amount'})","1418ba3c":"sns.barplot(x='pickup_year',y='avg_fare_amount',data=trips_year_fareamount).set_title(\"Avg Fare Amount over Years\")","c4f04cb6":"def groupandplot(data,groupby_key,value,aggregate='mean'):\n    plt.figure(figsize=(16,10))\n    agg_data=data.groupby([groupby_key])[value].agg(aggregate).reset_index().rename(columns={value:aggregate+'_'+value})\n    plt.subplot(1,2,1)\n    count_data=train.groupby([groupby_key])['key'].count().reset_index().rename(columns={'key':'Num_Trips'})\n    sns.barplot(x=groupby_key,y='Num_Trips',data=count_data).set_title(\"Number of Trips vs \"+groupby_key)\n    \n    plt.subplot(1,2,2)\n    sns.barplot(x=groupby_key,y=aggregate+'_'+value,data=agg_data).set_title(aggregate+'_'+value+\" vs \"+groupby_key)\n\n    ","99c960bc":"groupandplot(train,'pickup_month','fare_amount')","73c19630":"groupandplot(train,'pickup_day_of_week','fare_amount')","7cb6fe52":"groupandplot(train,'pickup_hour','fare_amount')","7446f466":"# Let us encode day of the week to numbers\ndef encodeDays(day_of_week):\n    day_dict={'Sunday':0,'Monday':1,'Tuesday':2,'Wednesday':3,'Thursday':4,'Friday':5,'Saturday':6}\n    return day_dict[day_of_week]","30103430":"train['pickup_day_of_week']=train['pickup_day_of_week'].apply(lambda x:encodeDays(x))","beec6b8f":"\ngroupandplot(train,'passenger_count','fare_amount')","5803d929":"print(\"Avg trip distance (in miles) when there are zero passengers\",np.mean(train.loc[train['passenger_count']==0,'trip_distance'].values))","e02b6fb4":"train=train[train['passenger_count']<=8]","96764904":"groupandplot(train,'passenger_count','fare_amount')\n","6cea5504":"train.to_csv(\"train_cleaned.csv\",index=False)","d31fd90f":"\n\ntest =  pd.read_csv('..\/input\/test.csv')\ntest['pickup_datetime']=pd.to_datetime(test['pickup_datetime'],format='%Y-%m-%d %H:%M:%S UTC')\n\ntest['pickup_date']= test['pickup_datetime'].dt.date\ntest['pickup_day']=test['pickup_datetime'].apply(lambda x:x.day)\ntest['pickup_hour']=test['pickup_datetime'].apply(lambda x:x.hour)\ntest['pickup_day_of_week']=test['pickup_datetime'].apply(lambda x:calendar.day_name[x.weekday()])\ntest['pickup_month']=test['pickup_datetime'].apply(lambda x:x.month)\ntest['pickup_year']=test['pickup_datetime'].apply(lambda x:x.year)\ntest['is_pickup_JFK']=test.apply(lambda row:isAirport(row['pickup_latitude'],row['pickup_longitude'],'JFK'),axis=1)\ntest['is_dropoff_JFK']=test.apply(lambda row:isAirport(row['dropoff_latitude'],row['dropoff_longitude'],'JFK'),axis=1)\ntest['is_pickup_EWR']=test.apply(lambda row:isAirport(row['pickup_latitude'],row['pickup_longitude'],'EWR'),axis=1)\ntest['is_dropoff_EWR']=test.apply(lambda row:isAirport(row['dropoff_latitude'],row['dropoff_longitude'],'EWR'),axis=1)\ntest['is_pickup_la_guardia']=test.apply(lambda row:isAirport(row['pickup_latitude'],row['pickup_longitude'],'LaGuardia'),axis=1)\ntest['is_dropoff_la_guardia']=test.apply(lambda row:isAirport(row['dropoff_latitude'],row['dropoff_longitude'],'LaGuardia'),axis=1)\ntest['pickup_latitude_round3']=test['pickup_latitude'].apply(lambda x:round(x,3))\ntest['pickup_longitude_round3']=test['pickup_longitude'].apply(lambda x:round(x,3))\ntest['dropoff_latitude_round3']=test['dropoff_latitude'].apply(lambda x:round(x,3))\ntest['dropoff_longitude_round3']=test['dropoff_longitude'].apply(lambda x:round(x,3))\ntest['trip_distance']=test.apply(lambda row:distance(row['pickup_latitude'],row['dropoff_latitude'],row['pickup_longitude'],row['dropoff_longitude']),axis=1)\ntest['pickup_borough']=test.apply(lambda row:getBorough(row['pickup_latitude'],row['pickup_longitude']),axis=1)\ntest['dropoff_borough']=test.apply(lambda row:getBorough(row['dropoff_latitude'],row['dropoff_longitude']),axis=1)\ntest['is_pickup_lower_manhattan']=test.apply(lambda row:isLowerManhattan(row['pickup_latitude'],row['pickup_longitude']),axis=1)\ntest['is_dropoff_lower_manhattan']=test.apply(lambda row:isLowerManhattan(row['dropoff_latitude'],row['dropoff_longitude']),axis=1)\ntest['pickup_day_of_week']=test['pickup_day_of_week'].apply(lambda x:encodeDays(x))\nprint(\"Shape of test data\", test.shape)\n\ntest.to_csv(\"test_cleaned.csv\",index=False)","a08171b4":"New York city is divided into 7 Boroughs. Let us calculate which borough pickup and dropoff points are. And whether that effects the fare","f6eef985":"1. Most fares are between 2.7   and   54 dollars .Median fare is around $7","f4020d14":"Since we saw above that fare amount is highly skewed,let us take log transformation of the fare amount and plot the distribution","08463ef1":"The data is for Taxi Rides in Newyork, whose center lat, lng is at ((40,-74).The range of dropoff and pickup latitudes indicates lot of outlier locations in the train data. ","e956d8a6":"128K records are outliers","1d7f8d06":"### Exploratory Data Analysis","08660bfb":"Avg Fare amount has beern increasing over the years.","95b5577a":"There is a significant difference in pickups and dropoffs fare amount for each burough exceept Manhattan. We can see pickups from Queens is expensive compared to pickups from other Buroughs.Very high difference in pickup and dropoff prices for Staten Island.","dc1ce909":"**What is the Average Fare amount of trips from JFK**","0d3ae2a7":"In the plot above, we can see two clusters with linear realtionship between taxi fare and distance. But for trip distances >50miles, though a linear relationship exists,the fare amount is very low. Let us check where these trips originate and end","91948eab":"### Let us look at Geographical Features and their relationship with Fare Amount\n\n**Distribution of Pickup and Dropoff Lat Lng**","83852cdd":"Saturday has low avg fare amount, compared to other days though there are a lot of trips of saturday. On sunday and monday though the number of trips are lower, avg fare amount is higher","a0647327":"**How does Fare Amount differ for pickups and dropoff for Lower Manhattan compared to rest of Manhattan**","638cb0d2":"Dropoffs to Bronx and Staten island are long trips. In Manhattan the pickup and dropoffs fare amount has similar distribution. Let us add a field, is_lower_manhattan as we had seen above that dropoffs to lower manhattan had higher trip distance but lower fare","bd4b4b4e":"## In the scatter plot, we saw the high density of pickups and dropoffs from and to JFK and La Guardia Airport\nLet us look at over time how fares are from La Guardia and JFK","9bf9bf79":"1. There are trips with 0 passengers as well. In these cases are drop and pickup location the same? If so it would mean that passenger didnt take the cab after the cab arrived and a cancellation fee was charged - there were 20719 such records. In the test set there were 38 such records\n2. The fare is very high when there were 9 passengers. - only 2 records\n3.  the number 129 and 208 passengers are surely outliers - three such records\n4. There are no records in test data where number of passengers is greater than 8 - so we will remove from train data records where number of passengers >8","8110cb36":" Let us set the boundary for the train data also based on test data lat lng boundaries.We will mark the outlier locations as 1 and remove them for further analysi","08565652":"### How does the tripfare vary across buroughs","9d6e18e9":"The fare seems to be fixed for trip distances > 50 miles. Normally airports pickup or dropoff have fixed prices.\nWe can remove the airport pickup and dropoff and plot the distribution of Fare Amount vs Trip distribution ","17ce6567":"**Heatmap based on fare amount across NYC**","954bc88b":"### Create datetime features based on pickup_datetime","effb5af3":"As we can see, the fare amount is much higher when pickup is from JFK.","b6cc52f3":"Most of the long trips dropoffs and pickups are in lower Manhattan. There are a lot of dropoffs in Brooklyn","f92eb519":" if there are 7 passengers, fare amount is lower. Fare amount is higher for 6 passengers**","8a8f8044":"There are a lot of cases where lat lng is zero. How many such cases are there in the data?","f5ada786":" 114K records  have either pickup\/dropoff lat\/lng as 0.0 . There is a high chance this is present in test data as well. So, let us create a field called is_outlier_loc and mark as 1 in case it is an outlier. Any point beyond NYC border is an outlier.  We will also drop all rows where the pickup or dropoff location is an outlier\n","736ab60b":"### Let us now look at datetime features and their realtionship with Fare Amount\n**What is the time period  in out sample**","bb20cdbc":"There are 262 records with negative fare. We will remove these records from the data","9b5c601f":" Distribution of fare amount for  both pickup and dropoff to JFK is similar","ea23eea4":"### Convert pickup_datetime from Object to Datetime object","a3c5f3b1":"**Trip Distance**","310082f1":"There are no missing values in the data.","43a9f074":"### How does Number of passengers affect Fare time\n","9494d231":"Fares across months are fairly constant, though number of trips are lower from june to decemeber","11dc6f12":"There are some negative fare amount in the data and also it is skewed. Let us have a look at these data points","9325c5f1":"** Distribution of Trip Fare**","fed31884":"### Check for Missing Values ","14cf823a":"The avg fare amount at 5am is the higher while the number of trips at 5 am are the least. The number of trips are highest in 18 and 19 hours","a1c8cbd6":"### Plot Heatmap of Pickups and Dropoffs within NYC","aaa9f683":"Apart from Manhattan, we can see heavy pickups and dropoffs near JFK and La Guardia Airport. ","11ab0cee":"The distribution of trip distance and fare amount for Lower Manhattan pickups and dropoffs is very different. Also, slope of linear realtionship for pickups for Lower Manhattan is higher than that for Rest of Manhattan"}}