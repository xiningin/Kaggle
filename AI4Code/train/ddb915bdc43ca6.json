{"cell_type":{"a19033f6":"code","162d31e7":"code","f1e6def6":"code","7be33b78":"code","933d088e":"code","65e41444":"code","432baa6d":"code","8b2d46bd":"code","47afcee9":"code","cadc50b0":"code","4ce2243d":"code","747a58ab":"code","4f503669":"code","608f4b86":"code","5ece9214":"code","5ec5e58b":"code","d8fa2eed":"code","50a5663e":"code","3767e2c5":"code","f55a5757":"code","78eb37b8":"code","b6acab54":"code","f24d317e":"code","61bc473e":"code","3d6519dd":"code","30dfa67a":"code","69702a55":"code","38a7ee5e":"code","aa910c34":"code","d233e1ed":"code","f13bed89":"code","d9e03239":"code","442877bd":"code","d6a2ae1c":"code","a0567936":"code","32f01bb5":"code","30311d69":"code","6ea5b776":"code","f5b1bd71":"code","7a475600":"code","bcb8a242":"code","51b8080d":"code","5919f679":"code","1a6af222":"code","e2e65b33":"code","e82d44b4":"code","e5afe52c":"markdown","80b6b2af":"markdown","1f74a075":"markdown","542af462":"markdown","63831d29":"markdown","801c2612":"markdown","3a7f4cea":"markdown","b9efed84":"markdown","7c42c02f":"markdown","a2fbdf61":"markdown","caac7131":"markdown","de938b6e":"markdown","4333def3":"markdown","45f8f53e":"markdown","bc06e1b1":"markdown","e96081e2":"markdown","aa829dde":"markdown","8e3798b1":"markdown","dcc4d426":"markdown","012bf98d":"markdown","b9d365f5":"markdown","8bfcdfe9":"markdown","882a0a61":"markdown","03a5df27":"markdown"},"source":{"a19033f6":"\nimport os\nfor dirname, _, filenames in os.walk('\/kaggle\/input'):\n    for filename in filenames:\n        print(os.path.join(dirname, filename))","162d31e7":"import pandas as pd\nimport numpy as np\nimport matplotlib.pyplot as plt\nimport seaborn as sns\n\nfrom sklearn.preprocessing import MinMaxScaler\nfrom sklearn.preprocessing import PolynomialFeatures\nfrom sklearn.linear_model import LinearRegression\n\nimport warnings\nwarnings.filterwarnings(\"ignore\")","f1e6def6":"df_train=pd.read_csv(\"..\/input\/covid19-global-forecasting-week-4\/train.csv\")\ndf_test=pd.read_csv(\"..\/input\/covid19-global-forecasting-week-4\/test.csv\")\ndf_sub=pd.read_csv(\"..\/input\/covid19-global-forecasting-week-4\/submission.csv\")\n\nprint(df_train.shape)\nprint(df_test.shape)\nprint(df_sub.shape)","7be33b78":"df_train.head()","933d088e":"print(f\"Unique Countries: {len(df_train.Country_Region.unique())}\")","65e41444":"train_dates=list(df_train.Date.unique())\nlatest_date=df_train.Date.max()\nprint(f\"Period : {len(df_train.Date.unique())} days\")\nprint(f\"From : {df_train.Date.min()} To : {df_train.Date.max()}\")","432baa6d":"print(f\"Unique Regions: {df_train.shape[0]\/len(df_train.Date.unique())}\")","8b2d46bd":"df_train.Country_Region.value_counts()","47afcee9":"print(f\"Number of rows without Country_Region : {df_train.Country_Region.isna().sum()}\")","cadc50b0":"df_train[\"UniqueRegion\"]=df_train.Country_Region\ndf_train.UniqueRegion[df_train.Province_State.isna()==False]=df_train.Province_State+\" , \"+df_train.Country_Region\n\nregion_list=df_train.UniqueRegion.unique()\nprint(f\"Total unique regions are : {len(region_list)}\")\ndf_train[df_train.Province_State.isna()==False]","4ce2243d":"df_train.drop(labels=[\"Id\",\"Province_State\",\"Country_Region\"], axis=1, inplace=True)\ndf_train","747a58ab":"df_train[\"Delta\"]=1.0\ndf_train[\"NewCases\"]=0.0\nfinal_train=pd.DataFrame(columns=[\"Date\",\"ConfirmedCases\",\"Fatalities\",\"NewCases\",\"UniqueRegion\", \"Delta\"])\n\nfor region in region_list:\n    df_temp=df_train[df_train.UniqueRegion==region].reset_index()\n    size_train=df_temp.shape[0]\n    \n    df_temp.NewCases[0]=df_temp.ConfirmedCases[1]\n    for i in range(1,df_temp.shape[0]):\n        df_temp.NewCases[i]=df_temp.ConfirmedCases[i]-df_temp.ConfirmedCases[i-1]\n        if(df_temp.ConfirmedCases[i-1]>0):\n            df_temp.Delta[i]=df_temp.ConfirmedCases[i]\/df_temp.ConfirmedCases[i-1]\n            \n    df_temp=df_temp[[\"Date\",\"ConfirmedCases\",\"Fatalities\",\"UniqueRegion\",\"NewCases\",\"Delta\"]]\n    final_train=pd.concat([final_train,df_temp], ignore_index=True)\nfinal_train.shape","4f503669":"latest_train=final_train[final_train.Date==latest_date]\nlatest_train.head()","608f4b86":"def train_data_plotter(r_name, n=df_temp.shape[0]):\n    \"\"\"\n    Inputs\n    r_name : Country name \n    n      : Latest period(in days) required (default from first confirmed case) \n    \n    Output\n    plots confirmed cases, fatalities and delta vs date\n    \"\"\"\n    df_temp=final_train[final_train.UniqueRegion==r_name]\n    df_temp=df_temp.tail(n)\n    df_temp=df_temp[df_temp.ConfirmedCases>0]\n    \n    sns.set(style='darkgrid')\n    # Plot Confirmed Cases\n    plt.figure(figsize=(10,5))\n    sns.lineplot('Date', 'ConfirmedCases', data=df_temp)\n    plt.xticks(rotation=90)\n    plt.title(\"Confirmed Cases\")\n    plt.show()\n    # Plot Fatalities\n    plt.figure(figsize=(10,5))\n    sns.lineplot('Date', 'Fatalities', data=df_temp)\n    plt.xticks(rotation=90)\n    plt.title(\"Fatalities\")\n    plt.show()\n    #Plot New Cases\n    plt.figure(figsize=(10,3))\n    sns.lineplot('Date', 'NewCases', data=df_temp)\n    plt.xticks(rotation=90)\n    plt.title(\"NewCases\")\n    plt.show()\n    # Plot Delta\n    plt.figure(figsize=(10,3))\n    sns.lineplot('Date', 'Delta', data=df_temp)\n    plt.xticks(rotation=90)\n    plt.title(\"Delta\")\n    plt.show()","5ece9214":"train_data_plotter(\"Germany\")","5ec5e58b":"train_data_plotter(\"Hubei , China\")","d8fa2eed":"train_data_plotter(\"Italy\")","50a5663e":"train_data_plotter(\"Korea, South\")","3767e2c5":"score_list=[]\nfor region in region_list:\n    df_temp=final_train[final_train.UniqueRegion==region]\n    X=np.array(df_temp.ConfirmedCases).reshape(-1,1)\n    Y=df_temp.Fatalities\n    model=LinearRegression()\n    model.fit(X,Y)\n    score_list.append(model.score(X,Y))\nscore_df=pd.DataFrame({\"Region\":region_list,\"Score\":score_list})\nprint(f\"Average R2 score between Fatality and Confirmed Cases is :{score_df.Score.mean()}\")\n\nplt.figure(figsize=(10,6))    \nplt.title(\"Distribution of R2 score between Confirmed Cases and Fatality\")\nsns.distplot(score_df.Score)\nplt.show()","f55a5757":"less_than_50=score_df[score_df.Score<0.5].Region.unique()\nprint(f\"Number of countries where r2 score<0.50 : {len(less_than_50)}\")\nlatest_train[latest_train.UniqueRegion.isin(less_than_50)]","78eb37b8":"train_data_plotter(\"Zhejiang , China\")","b6acab54":"def heat_map_plotter(r_name):\n    \"\"\"\n    Input: Region Name\n    Output: Plots correlation heatmap for periods: full data, last 15 days, last 5 days\n    \"\"\"\n    \n    plt.title(\"Correlation HeatMap Full data\")\n    df_temp=final_train[final_train.UniqueRegion==r_name]\n    df_temp=df_temp.tail(df_temp.shape[0]).reset_index()\n    sns.heatmap(abs(df_temp.corr()), cmap='coolwarm', annot=True)\n    plt.show()\n\n    plt.title(\"Correlation HeatMap 15 days\")\n    df_temp=final_train[final_train.UniqueRegion==r_name]\n    df_temp=df_temp.tail(15).reset_index()\n    sns.heatmap(abs(df_temp.corr()), cmap='coolwarm', annot=True)\n    plt.show()\n\n    plt.title(\"Correlation HeatMap 5 days\")\n    df_temp=final_train[final_train.UniqueRegion==r_name]\n    df_temp=df_temp.tail(5).reset_index()\n    sns.heatmap(abs(df_temp.corr()), cmap='coolwarm', annot=True)\n    plt.show()","f24d317e":"heat_map_plotter(\"France\")","61bc473e":"heat_map_plotter(\"Iran\")","3d6519dd":"def reg_plotter(r_name, n=df_temp.shape[0]):\n    \"\"\"\n    Inputs\n    r_name : Country name \n    n      : Latest period(in days) required (default from first confirmed case) \n    \n    Output\n    Returns R2 score\n    plots regression plot between delta vs period\n    \"\"\"\n    df_temp=final_train[final_train.UniqueRegion==r_name]\n    df_temp=df_temp.tail(n).reset_index()\n    date=np.arange(1,n+1)\n    \n    # Plot Delta\n    plt.figure(figsize=(10,3))\n    plt.title(f\"Delta Vs Time for last {n} days\")\n    sns.regplot(date, df_temp.Delta)\n    plt.xticks(rotation=90)\n    model=LinearRegression()\n    X=date.reshape(-1,1)\n    Y=df_temp.Delta\n    model.fit(X,Y)\n    print(f\"R2 Score :{round(model.score(X,Y),2)}\")\n    plt.show()","30dfa67a":"reg_plotter(\"United Kingdom\",5)","69702a55":"reg_plotter(\"New York , US\",5)","38a7ee5e":"reg_plotter(\"India\", 5)","aa910c34":"\n%%time\nreg_score_list=[]\nperiod=[]\nreg=[]\nfor n in range(3,10):\n    for region in region_list:\n        df_temp=final_train[final_train.UniqueRegion==region]\n        df_temp=df_temp.tail(n).reset_index()\n        date=np.arange(1,n+1)\n        model=LinearRegression()\n        X=date.reshape(-1,1)\n        Y=df_temp.Delta\n        model.fit(X,Y)\n        reg.append(region)\n        reg_score_list.append(model.score(X,Y))\n        period.append(n)\nscore_df=pd.DataFrame({\"Region\":reg,\"Score\":reg_score_list, \"Period\":period})\n\nfor n in range(3,10): \n    print(f\"Average R2 score for {n} days period :{score_df[score_df.Period==n].Score.mean()}\")\n    plt.figure(figsize=(10,6))    \n    plt.title(f\"Distribution of R2 score for {n} days\")\n    sns.distplot(score_df[score_df.Period==n].Score)\n    plt.show()\n","d233e1ed":"\nn_list=[]\nfor reg in region_list:\n    temp_score_df=score_df[score_df.Region==reg]\n    if temp_score_df.Score.max()==1:\n        n_list.append(3)\n    else:\n        n_list.append(temp_score_df.Period[temp_score_df.Score==temp_score_df.Score.max()].median())\nbest_n_df=pd.DataFrame({\"Region\":region_list,\"N\":n_list})\nsns.countplot(best_n_df.N)\n","f13bed89":"df_test.head()","d9e03239":"print(f\"Unique Countries: {len(df_test.Country_Region.unique())}\")\ntest_dates=list(df_test.Date.unique())\nsize_test=len(df_test.Date.unique())\nprint(f\"Period : {len(df_test.Date.unique())} days\")\nprint(f\"From : {df_test.Date.min()} To : {df_test.Date.max()}\")\nprint(f\"Unique Regions: {df_test.shape[0]\/len(df_test.Date.unique())}\")","442877bd":"df_test[\"UniqueRegion\"]=df_test.Country_Region\ndf_test.UniqueRegion[df_test.Province_State.isna()==False]=df_test.Province_State+\" , \"+df_test.Country_Region","d6a2ae1c":"df_test.drop(labels=[\"ForecastId\",\"Province_State\",\"Country_Region\"], axis=1, inplace=True)\ndf_test[\"ConfirmedCases\"]=0\ndf_test[\"Fatalities\"]=0\ndf_test[\"NewCases\"]=0\ndf_test[\"Delta\"]=0","a0567936":"final_test=df_test[[\"Date\",\"ConfirmedCases\",\"Fatalities\",\"UniqueRegion\",\"NewCases\",\"Delta\"]]\napp_test=final_test[final_test.Date>latest_date]\napp_test.shape","32f01bb5":"\ndf_pred=pd.DataFrame(columns=[\"ConfirmedCases\",\"Fatalities\"])\ndf_traintest=pd.DataFrame(columns=[\"Date\",\"ConfirmedCases\",\"Fatalities\",\"UniqueRegion\",\"NewCases\",\"Delta\"])\n\nfor region in region_list:\n    df_temp=final_train[final_train.UniqueRegion==region].reset_index()\n    \n    #number of days for delta trend\n    n=int(best_n_df[best_n_df.Region==region].N.sum()) \n    #Delta for the period\n    delta_list=np.array(df_temp.tail(n).Delta).reshape(-1,1)\n    #Morality rate as on last availabe date\n    death_rate=df_temp.tail(1).Fatalities.sum()\/df_temp.tail(1).ConfirmedCases.sum()\n    \n    scaler=MinMaxScaler()\n    X=np.arange(1,n+1).reshape(-1,1)\n    Y=scaler.fit_transform(delta_list) \n    model=LinearRegression()\n    model.fit(X,Y)\n    \n    df_test_app=app_test[app_test.UniqueRegion==region]\n    df_temp=pd.concat([df_temp,df_test_app])\n    df_temp=df_temp.reset_index()\n    \n    for i in range (size_train, df_temp.shape[0]):\n        n=n+1        \n        df_temp.Delta[i]=max(1,scaler.inverse_transform(model.predict(np.array([n]).reshape(-1,1))))\n        df_temp.ConfirmedCases[i]=round(df_temp.ConfirmedCases[i-1]*df_temp.Delta[i],0)\n        df_temp.Fatalities[i]=round(death_rate*df_temp.ConfirmedCases[i],0)\n        df_temp.NewCases[i]=df_temp.ConfirmedCases[i]-df_temp.ConfirmedCases[i-1]\n        \n    df_traintest=pd.concat([df_traintest,df_temp],ignore_index=True)\n    \n    df_temp=df_temp.iloc[-size_test:,:]\n    df_temp=df_temp[[\"ConfirmedCases\",\"Fatalities\"]]\n    df_pred=pd.concat([df_pred,df_temp], ignore_index=True)\n","30311d69":"def prediction_plotter(r_name):\n    pred_df=df_traintest[df_traintest.UniqueRegion==r_name]\n    train_df=final_train[final_train.UniqueRegion==r_name]\n    plt.figure(figsize=(10,6))\n    sns.lineplot('Date','ConfirmedCases',data=pred_df, color='r', label=\"Predicted Cases\")\n    sns.lineplot('Date','ConfirmedCases',data=train_df, color='g', label=\"Actual Cases\")\n    plt.show()","6ea5b776":"prediction_plotter(\"Germany\")","f5b1bd71":"prediction_plotter(\"Pakistan\")","7a475600":"\ndf_pred=pd.DataFrame(columns=[\"ConfirmedCases\",\"Fatalities\"])\ndf_traintest=pd.DataFrame(columns=[\"Date\",\"ConfirmedCases\",\"Fatalities\",\"UniqueRegion\",\"NewCases\",\"Delta\"])\n\nfor region in region_list:\n    df_temp=final_train[final_train.UniqueRegion==region].reset_index()\n    \n    #number of days for delta trend\n    n=10 \n    #Delta for the period\n    NewCasesList=df_temp.tail(n).NewCases \n    #Morality rate as on last availabe date\n    death_rate=df_temp.tail(1).Fatalities.sum()\/df_temp.tail(1).ConfirmedCases.sum()\n    \n    X=np.arange(1,n+1).reshape(-1,1)\n    Y=NewCasesList\n    model=LinearRegression()\n    model.fit(X,Y)\n    \n    df_test_app=app_test[app_test.UniqueRegion==region]\n    df_temp=pd.concat([df_temp,df_test_app])\n    df_temp=df_temp.reset_index()\n    \n    for i in range (size_train, df_temp.shape[0]):\n        n=n+1        \n        df_temp.NewCases[i]=round(max(0,model.predict(np.array([n]).reshape(-1,1))[0]),0)\n        df_temp.ConfirmedCases[i]=df_temp.ConfirmedCases[i-1]+df_temp.NewCases[i]\n        df_temp.Fatalities[i]=round(death_rate*df_temp.ConfirmedCases[i],0)\n        df_temp.Delta[i]=df_temp.ConfirmedCases[i]\/df_temp.ConfirmedCases[i-1]\n        \n    df_traintest=pd.concat([df_traintest,df_temp],ignore_index=True)\n    \n    df_temp=df_temp.iloc[-size_test:,:]\n    df_temp=df_temp[[\"ConfirmedCases\",\"Fatalities\"]]\n    df_pred=pd.concat([df_pred,df_temp], ignore_index=True)\ndf_pred.shape\n","bcb8a242":"prediction_plotter(\"New York , US\")","51b8080d":"prediction_plotter(\"Korea, South\")","5919f679":"#\"\"\"\ndf_pred=pd.DataFrame(columns=[\"ConfirmedCases\",\"Fatalities\"])\ndf_traintest=pd.DataFrame(columns=[\"Date\",\"ConfirmedCases\",\"Fatalities\",\"UniqueRegion\",\"NewCases\",\"Delta\"])\n\nfor region in region_list:\n    df_temp=final_train[final_train.UniqueRegion==region].reset_index()\n    \n    #number of days for delta trend\n    n=7\n    #Delta for the period\n    ConfirmedCasesList=df_temp.tail(n).ConfirmedCases \n    #Morality rate as on last availabe date\n    death_rate=df_temp.tail(1).Fatalities.sum()\/df_temp.tail(1).ConfirmedCases.sum()\n    polynom=PolynomialFeatures(degree=2)\n    X=polynom.fit_transform(np.arange(1,n+1).reshape(-1,1))\n    Y=ConfirmedCasesList\n    model=LinearRegression()\n    model.fit(X,Y)\n    \n    df_test_app=app_test[app_test.UniqueRegion==region]\n    df_temp=pd.concat([df_temp,df_test_app])\n    df_temp=df_temp.reset_index()\n    \n    for i in range (size_train, df_temp.shape[0]):\n        n=n+1        \n        pred=round(model.predict(polynom.fit_transform(np.array(n).reshape(-1,1)))[0],0)\n        df_temp.ConfirmedCases[i]=max(df_temp.ConfirmedCases[i-1],pred)\n        df_temp.NewCases[i]=df_temp.ConfirmedCases[i]+df_temp.ConfirmedCases[i-1]\n        df_temp.Fatalities[i]=round(death_rate*df_temp.ConfirmedCases[i],0)\n        df_temp.Delta[i]=df_temp.ConfirmedCases[i]\/df_temp.ConfirmedCases[i-1]\n        \n    df_traintest=pd.concat([df_traintest,df_temp],ignore_index=True)\n    \n    df_temp=df_temp.iloc[-size_test:,:]\n    df_temp=df_temp[[\"ConfirmedCases\",\"Fatalities\"]]\n    df_pred=pd.concat([df_pred,df_temp], ignore_index=True)\ndf_pred.shape\n#\"\"\"","1a6af222":"prediction_plotter(\"India\")","e2e65b33":"prediction_plotter(\"New York , US\")","e82d44b4":"df_sub.ConfirmedCases=df_pred.ConfirmedCases\ndf_sub.Fatalities=df_pred.Fatalities\n#df_sub.to_csv(\"submission.csv\",index=None)","e5afe52c":"## Prediction when confirmed cases is in polinomial regression","80b6b2af":"### Establishing the relation between Confirmed Cases and Fatalities","1f74a075":"### We have established that Fatality varies linearly with Confirmed cases","542af462":"Dropping the unwanted labels","63831d29":"These are the regions where there are a very few number of cases (probably imported ones) and fatality rate is low.\n\nSince the number of these regions are low, we can ignore them.","801c2612":"### Finding Best N for regions","3a7f4cea":"### Analysing correlation heatmap for different periods","b9efed84":"Observation:\n* There is variablily in R2 score from above examples, so assumption that delta varies linearly with time in short term needs further testing","7c42c02f":"### Examining regions where r2 score is less than 0.5 ","a2fbdf61":"Observation:\n* Generally average R2 score is better when N=3\n* For some regions, R2 score is better when N is higer","caac7131":"### Regression plot for a specific region for a specific period","de938b6e":"## Predicting using Linear Regression of Delta","4333def3":"We will add one more column, Delta (Growth Factor) which is the ratio of confirmed cases on one day to that of the previous day.","45f8f53e":"### Define a function to plot how confirmed cases, fatalities and Delta changes with time","bc06e1b1":"We will add column UniqueRegion by combining province\/state name, where available to country region.","e96081e2":"### Plotting heat map for few random regions","aa829dde":"Observations:\n* Fatality appears to be linearly correlated with Confirmed Cases\n* When delta increases, there is exponetial increase in the number of cases","8e3798b1":"## Test data EDA","dcc4d426":"# Visualizing the trend in few Countries\/regions","012bf98d":"* Observation Linear Regression can be used to predict Delta for the test data however the model would be underfitting.\n* Polynomial Regression or LSTM would do a much better job in prediction","b9d365f5":"Observation:\n* Fatalities are generally highly correlated with Confirmed Cases\n* In short term New Cases is highly correlated with Delta\n* In short term Correlation between Delta and index increases","8bfcdfe9":"### EDA Train Data","882a0a61":"# Assumption delta varies linearly in short-term","03a5df27":"## Prediction Where new Cases follows Linear Regression"}}