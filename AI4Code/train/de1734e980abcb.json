{"cell_type":{"92f1a41c":"code","68f4d243":"code","6d380e3c":"code","af690e6e":"code","18c0a970":"code","42044dee":"code","82240af4":"code","342a8008":"code","cd51cc27":"code","5a85f42a":"code","7eb64b96":"code","706578c6":"code","6e2ef967":"code","0e027759":"code","d0df5697":"code","feab5d21":"code","92b18ade":"code","b10a6054":"code","f88b468a":"code","d54ee5b1":"code","f387cd56":"code","6c4a7c43":"markdown","37ab5ab5":"markdown","f4e9eef4":"markdown","06351d7e":"markdown","a2f548a9":"markdown","a51be1ba":"markdown","039f4ff8":"markdown","09d31f1a":"markdown","eb6c14d3":"markdown","4f99761d":"markdown","b682790b":"markdown","030f9f80":"markdown","de5c0aac":"markdown","70c5282f":"markdown","44f182f6":"markdown","e456edf2":"markdown","43625e3d":"markdown","4882b4ec":"markdown","a2b50934":"markdown","b2fd097a":"markdown","e7036175":"markdown","92663787":"markdown","2d72c2ef":"markdown","8b84d5c8":"markdown","2f89e883":"markdown"},"source":{"92f1a41c":"# import libraries and environment setting \nimport numpy as np \nimport pandas as pd \nimport missingno as msno\nfrom math import floor\nimport matplotlib.pyplot as plt\nimport seaborn as sns\nimport requests\nimport re\nimport xgboost as xgb\nfrom sklearn.model_selection import train_test_split\nfrom sklearn.model_selection import RandomizedSearchCV\nfrom sklearn.metrics import  plot_confusion_matrix, classification_report\nimport warnings\nwarnings.filterwarnings('ignore')\n%matplotlib inline\nsns.set_theme()\nsns.set_palette('colorblind')\n","68f4d243":"df = pd.read_csv('\/kaggle\/input\/weather-dataset-rattle-package\/weatherAUS.csv')\ncoordinates = pd.read_csv('..\/input\/world-cities-database\/worldcitiespop.csv',usecols = ['Country','AccentCity','Latitude','Longitude'])\ndf.head()","6d380e3c":"coordinates = coordinates[coordinates.Country=='au'].drop(['Country'],axis = 1)\ncoordinates.head()","af690e6e":"df = df.merge(coordinates,how = 'left', left_on='Location', right_on='AccentCity')\ndf.info()","18c0a970":"locations = df.Location[df.Latitude.isna()].unique()\nlocations","42044dee":"params = {'access_key':'b8a7f574448bf69e3fa2fe41cc5e4fa8','country':'AU'} \nbase_url = 'http:\/\/api.positionstack.com\/v1\/forward'\nfor address in locations:\n    if address == 'PearceRAAF':\n        query_address ='RAAF Base Pearce'\n    else:\n        query_address = ' '.join(re.findall('[A-Z][a-z]*', address))\n    params['query'] =  query_address\n    response = requests.get(base_url, params = params).json()\n    try:\n        df.loc[df.Location==address,'Latitude'] = response['data'][0]['latitude']\n        df.loc[df.Location==address,'Longitude'] = response['data'][0]['longitude']\n    except:\n        print(params)\n        print(response)\n        break\n","82240af4":"msno.matrix(df)\ndf.isna().sum()","342a8008":"df.drop([\"Evaporation\",\"Sunshine\",\"Cloud9am\",\"Cloud3pm\",\"AccentCity\"], axis = 1, inplace = True)\ndf.dropna(axis=0,subset=['RainTomorrow'], inplace= True)\ndf['Year'] = pd.to_datetime(df['Date']).dt.year\ndf['Day_of_year'] = pd.to_datetime(df['Date']).dt.dayofyear\n","cd51cc27":"df.sort_values(by = ['Location','Year','Day_of_year'],inplace = True)\ndf.fillna(method = 'ffill', limit = 10, inplace = True)","5a85f42a":"df.drop([\"Location\", \"Date\"], axis =1,inplace= True)\ndf.dropna(axis=0,how=\"any\",inplace= True)\ndf.reset_index(drop = True, inplace = True)\ndf.isna().sum()","7eb64b96":"print(df.shape)\nprint(df['RainTomorrow'].value_counts(normalize = True))\nsns.countplot(x='RainTomorrow', data=df)\n","706578c6":"cat_cols = df.columns[(df.dtypes=='O') & (df.columns!='RainTomorrow')]\nnum_cols = df.columns[df.dtypes!='O']\n\nfig, axes = plt.subplots(4,4,figsize=(25, 25))\nfor i,col in enumerate(num_cols):\n    plt_col = i%4\n    plt_row = floor(i\/4)\n    sns.boxplot(ax = axes[plt_row,plt_col], data = df, y = col, linewidth=2.5)\ndf.describe()","6e2ef967":"for col in cat_cols:\n    print('Column','\"'+ col +'\"', 'has', df[col].nunique(),'unique values:\\n' )\n    print(df[col].value_counts(), '\\n\\n------------------------------\\n')","0e027759":"fig, axes = plt.subplots(4,4,figsize=(25, 25))\nfor i,col in enumerate(num_cols):\n    plt_col = i%4\n    plt_row = floor(i\/4)\n    sns.kdeplot(ax = axes[plt_row,plt_col], data = df, x = col, hue = \"RainTomorrow\")","d0df5697":"plt.figure(figsize=(20,15))\nsns.kdeplot(data = df, x = 'Longitude',y = 'Latitude',hue = 'RainTomorrow')","feab5d21":"fig, axes = plt.subplots(4,1,figsize=(15, 40))\nfor i,col in enumerate(cat_cols):\n    chart = sns.countplot(ax =axes[i],x= col ,hue = 'RainTomorrow' ,data = df)","92b18ade":"dirangle_map = {'N':0, 'NNE':22.5, 'NE':45, 'ENE':67.5, 'E':90, 'ESE': 112.5, 'SE':135, 'SSE':157.5, 'S':180, 'SSW':202.5, 'SW':225, 'WSW':247.5, 'W':270, 'WNW':292.5, 'NW':315, 'NNW':337.5 }\nbool_map = {'No':0, 'Yes':1}\ndf.replace({\"WindGustDir\": dirangle_map, 'WindDir9am':dirangle_map, 'WindDir3pm':dirangle_map, 'RainToday':bool_map, 'RainTomorrow':bool_map }, inplace = True)\ndf.info()","b10a6054":"rng = 42\nX = df.drop(['RainTomorrow'],axis = 1)\ny = df['RainTomorrow']\nX_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=rng,stratify =y)","f88b468a":"param_grid = {\n    'max_depth': range(2, 13),\n    'n_estimators':range(300, 1500)\n}\nclf = xgb.XGBClassifier(eta = 0.1)\nrandomized_clf = RandomizedSearchCV(estimator=clf,param_distributions=param_grid,scoring = 'accuracy',n_iter = 7, cv = 3, random_state = rng)\nrandomized_clf.fit(X_train,y_train)","d54ee5b1":"print(\"Best parameters: \", randomized_clf.best_params_)\nprint(\"Best Score: \", randomized_clf.best_score_)\nfeatures = pd.DataFrame(randomized_clf.best_estimator_.feature_importances_,index = X.columns)\nfeatures.sort_values(by = 0, ascending = True, inplace = True)\nplt.figure(figsize=(20,15))\nfeatures.plot(kind = 'barh')","f387cd56":"y_pred = randomized_clf.best_estimator_.predict(X_test)\nplot_confusion_matrix(randomized_clf.best_estimator_, X_test, y_test)\nprint(classification_report(y_test,y_pred))","6c4a7c43":"* There are 99581 observations and 21 columns left.\n* RainTomorrow is positive in 22% of entries.","37ab5ab5":"Let's convert wind directions into angles first.","f4e9eef4":"Import weatherAUS and worldcitiespop datasets, we will extract the GPS coordinates from the latter one.","06351d7e":"# Make Prediction with XGBoost","a2f548a9":"# Introduction ","a51be1ba":"Columns with a high number of missing values will be dropped, which are \"Evaporation\", \"Sunshine\", \"Cloud9am\", and \"Cloud3pm\". <br \/>  And we will extract year and day of year from Date.\n","039f4ff8":"Plot missing values with msno.","09d31f1a":"* The model has an 89% accuracy rate on the predictions of the test set.\n","eb6c14d3":"# Deal with Missing Values","4f99761d":"* Wind directions are encoded as 16 values.\n* The proportion of \"RainToday\" is similar to \"RainTomorrow\", which makes sense.","b682790b":"* It is more likely to rain tomorrow if it rains today.","030f9f80":"* The best hyperparameters found by RandomizedSearchCV are 1464 estimators and max_depth of 11.\n* Humidity3pm is the most important featues followed by WindGustSpeed, Pressure3pm, and Lontitude.","de5c0aac":"Here, we fix the learning rate of the XGBClassifier at 0.1 and search for the optimal max_depth and n_estimators with RandomizedSearchCV.","70c5282f":"Extract the rows of locations in Australia, and join two data frames on Location and AccentCity.\n","44f182f6":"* It rains more often in the southeastern area than in other regions.","e456edf2":"First of all, let's check out the target variable 'RainTomorrow', then inspect the distribution of numeric and categorial preditor variables.","43625e3d":"There are still some locations with missing coordinates, for which we will get with Positionstack Geocoding API below.","4882b4ec":"* Rainfall and WindGustSpeed have some extreme values, which could be caused by extreme weather conditions.\n* The majority of observations are located in the Southeastern area of Australia, the most densely populated region of the country.\n","a2b50934":"we will explore the effects of predictor variables on the target variable below.","b2fd097a":"Here we sort the data by location and time, then fill the missing values with forward fill. ","e7036175":"The objective of this notebook is to predict whether it will rain the next day with the weather conditions of the current day. The dataset we will use is weatherAUS.csv, which contains 160689 entries of weather data between 2007 and 2017 at 49 locations in Australia. As geographical factors play vital roles in weather conditions, we will import geo-coordinates of the locations from worldcitiespop dataset and geocoding API to better capture the feature, and therefore make more accurate predictions. <br>\nThere are four sections in this notebook: <br>\n* Import and Join Data\n* Deal with Missing Values\n* Exploratory Data Analysis\n* Make Prediction with XGBoost","92663787":"Now that we have aquired geo-corrdinates and transformed Date into desired formats, we can drop \"Location\" and \"Date\". <br>\nThe rows with missing values left will be deleted as well.","2d72c2ef":"# Exploratory Data Analysis","8b84d5c8":"* Humidity in the afternoon is an effective predictor of RainTomorrow.\n* The chance of rain is slightly higher in the middle of the year, which is winter in the souther hemisphere.\n","2f89e883":"# Import and Join Data"}}