{"cell_type":{"0ae2c934":"code","4664c10f":"code","75a0aa03":"code","4049898b":"code","c080f37e":"code","8c3cc1df":"code","c40f6376":"code","6d92df4c":"code","8451ff89":"code","221b951d":"code","62cf2d3d":"code","c4c233f5":"code","c691338b":"code","52d1e34f":"code","d25f613b":"code","3a62b748":"code","66d4e94d":"code","fac3e569":"code","3fdfda2a":"code","2531836a":"code","31c0fe86":"code","f62e94bb":"code","71f8cc04":"markdown","6a5c1eb5":"markdown","a6e7097a":"markdown","4f3b2138":"markdown","3368711b":"markdown","99da0c5d":"markdown","4bb2a751":"markdown","3093544a":"markdown","74b86bb7":"markdown","1460dffb":"markdown"},"source":{"0ae2c934":"# Replace 'kaggle-competitions-project' with YOUR OWN project id here --  \nPROJECT_ID = 'kaggle-bq-geotag' #\n#PROJECT_ID='kaggle-competitions-project'\n\nfrom google.cloud import bigquery\nclient = bigquery.Client(project=PROJECT_ID, location=\"US\")\ndataset = client.create_dataset('bqml_example', exists_ok=True)\n\nfrom google.cloud.bigquery import magics\nfrom kaggle.gcp import KaggleKernelCredentials\nmagics.context.credentials = KaggleKernelCredentials()\nmagics.context.project = PROJECT_ID\n\nimport seaborn as sns\nimport matplotlib.pyplot as plt\n\n# create a reference to our table\ntable = client.get_table(\"kaggle-competition-datasets.geotab_intersection_congestion.train\")\n\n# look at five rows from our dataset\nclient.list_rows(table, max_results=5).to_dataframe()","4664c10f":"%load_ext google.cloud.bigquery","75a0aa03":"mod_names= ['TotalTimeStopped_p20','TotalTimeStopped_p50','TotalTimeStopped_p80',\n            'DistanceToFirstStop_p20','DistanceToFirstStop_p50','DistanceToFirstStop_p80']","4049898b":"%%bigquery city_df\nSELECT t.city\n  FROM `kaggle-competition-datasets.geotab_intersection_congestion.test` t\nUNION DISTINCT\nSELECT t.city\n  FROM `kaggle-competition-datasets.geotab_intersection_congestion.train` t\n","c080f37e":"cities = list(city_df['city'])","8c3cc1df":"model_changed = False\n\nif model_changed:\n    for c in cities:\n        sql=\"\"\"DROP MODEL `bqml_example.model_cluster_\"\"\"+c+\"\"\"`\"\"\"\n        client.query(sql)\n\n        print('Dropped',c)\n    \n    \nfor c in cities:\n    sql=\"\"\"CREATE MODEL IF NOT EXISTS `bqml_example.model_cluster_\"\"\"+c+\"\"\"`\n    OPTIONS(model_type='kmeans',\n            NUM_CLUSTERS = 10) AS\n    SELECT\n        latitude,\n        longitude\n    FROM\n      `kaggle-competition-datasets.geotab_intersection_congestion.train` t\n    WHERE city = '\"\"\"+c+\"\"\"'\n    UNION ALL\n    SELECT\n        latitude,\n        longitude\n    FROM\n      `kaggle-competition-datasets.geotab_intersection_congestion.test` t\n    WHERE city = '\"\"\"+c+\"\"\"'\"\"\"\n\n    client.query(sql)\n\n    print('Done with',c)","c40f6376":"%%bigquery eda_df\nWITH city_cluster AS (\n    SELECT (SELECT MIN(d.DISTANCE) FROM UNNEST(NEAREST_CENTROIDS_DISTANCE) d) AS dist_to_cluster_center, \n           CONCAT(m.city,\"_\",CAST(m.CENTROID_ID AS STRING)) AS city_cluster,\n           m.* EXCEPT (nearest_centroids_distance, CENTROID_ID) \n      FROM ML.PREDICT(MODEL `bqml_example.model_cluster_boston`, \n                   (SELECT t.RowId,\n                   t.city,\n                           t.IntersectionId,\n                           t.Latitude,\n                           t.Longitude,\n                           #t.EntryStreetName,\n                           #t.ExitStreetName,\n                           t.EntryHeading,\n                           t.ExitHeading,\n                           t.Hour,\n                           t.Weekend,\n                           t.Month,\n                           #t.Path,\n                           t.TotalTimeStopped_p20,\n                           #t.TotalTimeStopped_p40,\n                           t.TotalTimeStopped_p50,\n                           #t.TotalTimeStopped_p60,\n                           t.TotalTimeStopped_p80,\n                           #t.TimeFromFirstStop_p20,\n                           #t.TimeFromFirstStop_p40,\n                           #t.TimeFromFirstStop_p50,\n                           #t.TimeFromFirstStop_p60,\n                           #t.TimeFromFirstStop_p80,\n                           t.DistanceToFirstStop_p20,\n                           #t.DistanceToFirstStop_p40,\n                           t.DistanceToFirstStop_p50,\n                           #t.DistanceToFirstStop_p60,\n                           t.DistanceToFirstStop_p80,\n                           'TRAIN' AS source\n                     FROM `kaggle-competition-datasets.geotab_intersection_congestion.train` t\n                    WHERE city = 'Boston' \n                    #  AND rowid in(2209678,2209692)\n                    UNION ALL\n                    SELECT t.RowId,\n                    t.city,\n                           t.IntersectionId,\n                           t.Latitude,\n                           t.Longitude,\n                           #t.EntryStreetName,\n                           #t.ExitStreetName,\n                           t.EntryHeading,\n                           t.ExitHeading,\n                           t.Hour,\n                           t.Weekend,\n                           t.Month,\n                           #t.Path,\n                           null as TotalTimeStopped_p20,\n                           #null as TotalTimeStopped_p40,\n                           null as TotalTimeStopped_p50,\n                           #null as TotalTimeStopped_p60,\n                           null as TotalTimeStopped_p80,\n                           #null as TimeFromFirstStop_p20,\n                           #null as TimeFromFirstStop_p40,\n                           #null as TimeFromFirstStop_p50,\n                           #null as TimeFromFirstStop_p60,\n                           #null as TimeFromFirstStop_p80,\n                           null as DistanceToFirstStop_p20,\n                           #null as DistanceToFirstStop_p40,\n                           null as DistanceToFirstStop_p50,\n                           #null as DistanceToFirstStop_p60,\n                           null as DistanceToFirstStop_p80,\n                           'TEST' AS source\n                     FROM `kaggle-competition-datasets.geotab_intersection_congestion.test` t\n                    WHERE city = 'Boston' \n                    #  AND rowid in(2209678,2209692)\n                    )) m\n)\nSELECT cc.source,\n       cc.city,\n       cc.city_cluster, \n       count(1) cnt, \n       avg(cc.dist_to_cluster_center) avg_dist_to_cluster_center, \n       stddev(cc.dist_to_cluster_center) stddev_dist_to_cluster_center, \n       min(cc.dist_to_cluster_center) min_dist_to_cluster_center, \n       max(cc.dist_to_cluster_center) max_dist_to_cluster_center,\n       avg(avg(cc.dist_to_cluster_center)*(count(1)-1)) over(partition by cc.city) avg_dist_to_cluster_center_over_city\n  FROM city_cluster cc\n GROUP BY cc.source, \n          cc.city, \n          cc.city_cluster;","6d92df4c":"eda_df.sort_values(by=['source','city_cluster']).head(100)","8451ff89":"sns.swarmplot(x='city_cluster',y='cnt', data=eda_df ,hue='source')\n\nplt.xticks(rotation=45)","221b951d":"sns.swarmplot(x='city_cluster',y='avg_dist_to_cluster_center', data=eda_df ,hue='source')\n\nplt.xticks(rotation=45)","62cf2d3d":"def feature_sql(model_name, rowid_split, incl_rowid, tab): \n    \n    if incl_rowid:\n        rowid = \"t.RowId,\"\n    else:\n        rowid = \"\"\n    \n    if tab == 'test':\n        label = \"\"\n    elif model_name == 'ALL':\n        label = \"\"\"t.TotalTimeStopped_p20,\n                t.TotalTimeStopped_p50,\n                t.TotalTimeStopped_p80,\n                t.DistanceToFirstStop_p20,\n                t.DistanceToFirstStop_p50,\n                t.DistanceToFirstStop_p80,\"\"\"\n    else:\n        label = \"\"\"t.\"\"\"+model_name+\"\"\" as label,\"\"\"\n    \n    sql = \"\"\n    \n    for c in cities:\n        features = \"\"\"SELECT \"\"\"+label+\"\"\"\n                             \"\"\"+rowid+\"\"\"\n                             t.city,\n                             t.EntryHeading,\n                             t.ExitHeading,\n                             t.Hour,\n                             t.Weekend,\n                             t.Month,\n                             t.Latitude,\n                             t.Longitude,\n                             case \n                                 when t.entryheading = t.exitheading THEN\n                                  \"C\"\n                                 when (\"N\" in (t.entryheading, t.exitheading) and \"S\" in (t.entryheading, t.exitheading)) \n                                      OR \n                                      (\"E\" in (t.entryheading, t.exitheading) and \"W\" in (t.entryheading, t.exitheading)) \n                                      OR \n                                      (\"NE\" in (t.entryheading, t.exitheading) and \"SW\" in (t.entryheading, t.exitheading))  \n                                      OR \n                                      (\"SE\" in (t.entryheading, t.exitheading) and \"NW\" in (t.entryheading, t.exitheading)) \n                                 THEN\n                                  \"U\" \n                                 when (t.entryheading=\"N\" and t.exitheading = \"W\") \n                                      OR(t.entryheading=\"NW\" and t.exitheading = \"SW\") \n                                      OR(t.entryheading=\"W\" and t.exitheading = \"S\") \n                                      OR(t.entryheading=\"SW\" and t.exitheading = \"SE\") \n                                      OR(t.entryheading=\"S\" and t.exitheading = \"E\") \n                                      OR(t.entryheading=\"SE\" and t.exitheading = \"NE\") \n                                      OR(t.entryheading=\"E\" and t.exitheading = \"N\") \n                                      OR(t.entryheading=\"NE\" and t.exitheading = \"NW\") \n                                 THEN\n                                  \"L\" \n                                 when (t.entryheading=\"N\" and t.exitheading = \"E\") \n                                      OR(t.entryheading=\"NW\" and t.exitheading = \"NE\") \n                                      OR(t.entryheading=\"W\" and t.exitheading = \"N\") \n                                      OR(t.entryheading=\"SW\" and t.exitheading = \"NW\") \n                                      OR(t.entryheading=\"S\" and t.exitheading = \"W\") \n                                      OR(t.entryheading=\"SE\" and t.exitheading = \"SW\") \n                                      OR(t.entryheading=\"E\" and t.exitheading = \"S\") \n                                      OR(t.entryheading=\"NE\" and t.exitheading = \"SE\") \n                                 THEN\n                                  \"R\" \n                                 when (t.entryheading=\"N\" and t.exitheading = \"NW\") \n                                      OR(t.entryheading=\"NW\" and t.exitheading = \"W\") \n                                      OR(t.entryheading=\"W\" and t.exitheading = \"SW\") \n                                      OR(t.entryheading=\"SW\" and t.exitheading = \"S\") \n                                      OR(t.entryheading=\"S\" and t.exitheading = \"SE\") \n                                      OR(t.entryheading=\"SE\" and t.exitheading = \"E\") \n                                      OR(t.entryheading=\"E\" and t.exitheading = \"NE\") \n                                      OR(t.entryheading=\"NE\" and t.exitheading = \"N\") \n                                 THEN\n                                  \"CL\" \n                                 when (t.entryheading=\"N\" and t.exitheading = \"NE\") \n                                      OR(t.entryheading=\"NW\" and t.exitheading = \"N\") \n                                      OR(t.entryheading=\"W\" and t.exitheading = \"NW\") \n                                      OR(t.entryheading=\"SW\" and t.exitheading = \"W\") \n                                      OR(t.entryheading=\"S\" and t.exitheading = \"SW\") \n                                      OR(t.entryheading=\"SE\" and t.exitheading = \"S\") \n                                      OR(t.entryheading=\"E\" and t.exitheading = \"SE\") \n                                      OR(t.entryheading=\"NE\" and t.exitheading = \"E\") \n                                 THEN\n                                  \"CR\" \n                                 when (t.entryheading=\"N\" and t.exitheading = \"SW\") \n                                      OR(t.entryheading=\"NW\" and t.exitheading = \"S\") \n                                      OR(t.entryheading=\"W\" and t.exitheading = \"SE\") \n                                      OR(t.entryheading=\"SW\" and t.exitheading = \"E\") \n                                      OR(t.entryheading=\"S\" and t.exitheading = \"NE\") \n                                      OR(t.entryheading=\"SE\" and t.exitheading = \"N\") \n                                      OR(t.entryheading=\"E\" and t.exitheading = \"NW\") \n                                      OR(t.entryheading=\"NE\" and t.exitheading = \"W\") \n                                 THEN\n                                  \"UL\" \n                                 when (t.entryheading=\"N\" and t.exitheading = \"SE\") \n                                      OR(t.entryheading=\"NW\" and t.exitheading = \"E\") \n                                      OR(t.entryheading=\"W\" and t.exitheading = \"NE\") \n                                      OR(t.entryheading=\"SW\" and t.exitheading = \"N\") \n                                      OR(t.entryheading=\"S\" and t.exitheading = \"NW\") \n                                      OR(t.entryheading=\"SE\" and t.exitheading = \"W\") \n                                      OR(t.entryheading=\"E\" and t.exitheading = \"SW\") \n                                      OR(t.entryheading=\"NE\" and t.exitheading = \"S\") \n                                 THEN\n                                  \"UR\" \n                               else null end direction\n                       FROM `kaggle-competition-datasets.geotab_intersection_congestion.\"\"\"+tab+\"\"\"` t\n                      WHERE city = '\"\"\"+c+\"\"\"' \n                       AND rowid \"\"\"+rowid_split\n                            \n        sql += \"\"\"\n               SELECT (SELECT MIN(d.DISTANCE) FROM UNNEST(NEAREST_CENTROIDS_DISTANCE) d) AS dist_to_cluster_center, \n                      CONCAT(m.city,\"_\",CAST(m.CENTROID_ID AS STRING)) AS city_cluster,\n                      m.* EXCEPT (nearest_centroids_distance, CENTROID_ID,Latitude,Longitude) \n                 FROM ML.PREDICT(MODEL `bqml_example.model_cluster_\"\"\"+c+\"\"\"`, \n                              (\"\"\"+features+\"\"\")) m\n               UNION ALL\"\"\"\n        \n        \n    return sql[:-len(\"UNION ALL\")]","c4c233f5":"model_changed = False\n\nif model_changed:\n    sql=\"DROP TABLE IF EXISTS `bqml_example.city_cluster_train`\"\n    job_result=client.query(sql).result()\n    sql=\"DROP TABLE IF EXISTS `bqml_example.city_cluster_test`\"\n    job_result=client.query(sql).result()\n\n    \nsql = \"CREATE TABLE IF NOT EXISTS `bqml_example.city_cluster_train` as \" + feature_sql('ALL','=rowid', True, 'train')\njob_result=client.query(sql).result()\nsql = \"CREATE TABLE IF NOT EXISTS `bqml_example.city_cluster_test` as \" + feature_sql('ALL','=rowid', True, 'test')\njob_result=client.query(sql).result()\n    \n    ","c691338b":"%%bigquery\n\nSELECT t.TotalTimeStopped_p20 as label, cc.* except (rowid, TotalTimeStopped_p20,TotalTimeStopped_p50,TotalTimeStopped_p80,DistanceToFirstStop_p20, DistanceToFirstStop_p50, DistanceToFirstStop_p80) \n  FROM `bqml_example.city_cluster_train` cc,\n       `kaggle-competition-datasets.geotab_intersection_congestion.train` t\n WHERE cc.rowid = t.rowid\n LIMIT 20;","52d1e34f":"%%bigquery\nCREATE OR REPLACE FUNCTION `bqml_example.direction2degree`(dir string) AS (\n case dir\n   when \"C\" then\n    90\n   when 'CL' then\n    135\n   when \"L\" then\n    180\n   when 'UL' then\n    225\n   when \"U\" then\n    270\n   when 'UR' then\n    315\n   when \"R\" then\n    0\n   when 'CR' then\n    45\n    \n   when \"N\" then\n    90\n   when 'NW' then\n    135\n   when \"W\" then\n    180\n   when 'SW' then\n    225\n   when \"S\" then\n    270\n   when 'SE' then\n    315\n   when \"E\" then\n    0\n   when 'NE' then\n    45\n end\n);","d25f613b":"%%time\nmodel_changed = True\n\nif model_changed:\n    for mn in mod_names:\n        sql=\"DROP MODEL IF EXISTS `bqml_example.model_\"+mn+\"`\"\n        client.query(sql).result()\n\n        print('Drop',mn)\n\nfor mn in mod_names:\n    \n    sql=\"\"\"\n    CREATE MODEL IF NOT EXISTS `bqml_example.model_\"\"\"+mn+\"\"\"`\n    OPTIONS(MODEL_TYPE='linear_reg', \n            L2_REG=0.1,\n            LS_INIT_LEARN_RATE=0.4) AS \n    SELECT  t.\"\"\"+mn+\"\"\" as label,\n            cc.city_cluster,\n            cc.city,\n            cc.hour,\n            cc.weekend,\n            cc.month,\n            cc.direction,\n            cc.entryheading,\n            cc.exitheading,\n            round(sin(bqml_example.direction2degree(cc.direction)*ACOS(-1)\/180),6) direction_sin,\n            round(cos(bqml_example.direction2degree(cc.direction)*ACOS(-1)\/180),6) direction_cos,\n            round(sin(bqml_example.direction2degree(cc.entryheading)*ACOS(-1)\/180),6) entryheading_sin,\n            round(cos(bqml_example.direction2degree(cc.entryheading)*ACOS(-1)\/180),6) entryheading_cos,\n            round(sin(bqml_example.direction2degree(cc.exitheading)*ACOS(-1)\/180),6) exitheading_sin,\n            round(cos(bqml_example.direction2degree(cc.exitheading)*ACOS(-1)\/180),6) exitheading_cos,\n            round(cc.dist_to_cluster_center,8) dist_to_cluster_center\n      FROM `bqml_example.city_cluster_train` cc,\n           `kaggle-competition-datasets.geotab_intersection_congestion.train` t\n     WHERE t.rowid = cc.rowid\n       AND cc.rowid < 2600000;\n    \"\"\"\n\n    client.query(sql).result()\n\n    print('Done with',mn)","3a62b748":"%%time\n%%bigquery\nSELECT\n  *\nFROM\n  ML.TRAINING_INFO(MODEL `bqml_example.model_TotalTimeStopped_p20`)\nORDER BY iteration ","66d4e94d":"%%time\n%%bigquery\nSELECT\n  *\nFROM\n  ML.FEATURE_INFO(MODEL `bqml_example.model_TotalTimeStopped_p20`)","fac3e569":"%%bigquery\nSELECT\n  *\nFROM\n  ML.WEIGHTS(MODEL  `bqml_example.model_TotalTimeStopped_p20`,\n    STRUCT(true AS standardize))","3fdfda2a":"sql=\"\"\"SELECT\n          *\n        FROM ML.EVALUATE(MODEL `bqml_example.model_TotalTimeStopped_p20`, (\n        SELECT  t.TotalTimeStopped_p20 as label, \n                cc.city_cluster,\n                cc.city,\n                cc.hour,\n                cc.weekend,\n                cc.month,\n                cc.direction,\n                cc.entryheading,\n                cc.exitheading,\n                round(sin(bqml_example.direction2degree(cc.direction)*ACOS(-1)\/180),6) direction_sin,\n                round(cos(bqml_example.direction2degree(cc.direction)*ACOS(-1)\/180),6) direction_cos,\n                round(sin(bqml_example.direction2degree(cc.entryheading)*ACOS(-1)\/180),6) entryheading_sin,\n                round(cos(bqml_example.direction2degree(cc.entryheading)*ACOS(-1)\/180),6) entryheading_cos,\n                round(sin(bqml_example.direction2degree(cc.exitheading)*ACOS(-1)\/180),6) exitheading_sin,\n                round(cos(bqml_example.direction2degree(cc.exitheading)*ACOS(-1)\/180),6) exitheading_cos,\n                round(cc.dist_to_cluster_center,8) dist_to_cluster_center\n          FROM `bqml_example.city_cluster_train` cc,\n               `kaggle-competition-datasets.geotab_intersection_congestion.train` t\n         WHERE t.rowid = cc.rowid\n         AND t.rowid > 2600000))\"\"\"\n\nclient.query(sql).to_dataframe()","2531836a":"def pred(mn, debug=False):\n    \n    if debug:\n        lmt='LIMIT 10'\n    else:\n        lmt=''\n    \n    sql=\"\"\"\n    SELECT\n      RowId,\n      predicted_label as \"\"\"+mn+\"\"\"\n    FROM\n      ML.PREDICT(MODEL `bqml_example.model_\"\"\"+mn+\"\"\"`,\n        (\n        SELECT  cc.RowId, \n                cc.city_cluster,\n                cc.city,\n                cc.hour,\n                cc.weekend,\n                cc.month,\n                cc.direction,\n                cc.entryheading,\n                cc.exitheading,\n                round(sin(bqml_example.direction2degree(cc.direction)*ACOS(-1)\/180),6) direction_sin,\n                round(cos(bqml_example.direction2degree(cc.direction)*ACOS(-1)\/180),6) direction_cos,\n                round(sin(bqml_example.direction2degree(cc.entryheading)*ACOS(-1)\/180),6) entryheading_sin,\n                round(cos(bqml_example.direction2degree(cc.entryheading)*ACOS(-1)\/180),6) entryheading_cos,\n                round(sin(bqml_example.direction2degree(cc.exitheading)*ACOS(-1)\/180),6) exitheading_sin,\n                round(cos(bqml_example.direction2degree(cc.exitheading)*ACOS(-1)\/180),6) exitheading_cos,\n                round(cc.dist_to_cluster_center,8) dist_to_cluster_center\n          FROM `bqml_example.city_cluster_test` cc,\n               `kaggle-competition-datasets.geotab_intersection_congestion.test` t\n         WHERE t.rowid = cc.rowid\n          \"\"\"+lmt+\"\"\"))\n        ORDER BY RowId ASC\"\"\"\n\n    return client.query(sql).to_dataframe()\n    \ndf=None\nfor i, mn in enumerate(mod_names):\n    if i == 0:\n        print('Start', i)\n        df = pred(mn)\n        df['RowId'] = df['RowId'].apply(str) + '_'+str(i)\n        df.rename(columns={'RowId': 'TargetId', mn: 'Target'}, inplace=True)\n    else:\n        print('Start', i)\n        df_temp = pred(mn)\n        df_temp['RowId'] = df_temp['RowId'].apply(str) + '_'+str(i)\n        df_temp.rename(columns={'RowId': 'TargetId', mn: 'Target'}, inplace=True)\n        df=df.append(df_temp)\n\n    print('Done with',mn)","31c0fe86":"print(df.shape)\ndf.head(100)","f62e94bb":"df.to_csv('submission.csv', index=False)","71f8cc04":"# Predict outcomes\n","6a5c1eb5":"## Create city_cluster table","a6e7097a":"# Cluster Intersections per City","4f3b2138":"## Checkout the clusters\nUsing Boston as an example","3368711b":"## Evaluate your model\n","99da0c5d":"## Train","4bb2a751":"## Get training statistics\n","3093544a":"# Intro\n\nThe kernel relies as much as possible on BigQuery (BQ). All features are generated in BQ. And the prediction model is also build in BQ.\n\n## Summary\nFeatures:\n- city, hour, weekend, month\n- 10 clusters of Intersections per city\n- Distance to the nearest cluster\n- 8 directions of turn (left, right, centered, uturn, centered-left, ...)\n- Directions, Entry- and Exit-Heading are embedded and also they are translated into degrees (centered = 90deg; North = 90deg). Afterwards the degree features are split into two features sin(feature_x_deg) and cos(feature_x_deg).\n\nModel:\n- Linear Regression\n\n\n## Next TODOs\n- reasonable Train-Valid-Split strategy\n\n## Credits\nSome of the ideas are inspired by the following kernels. Please visit and give them upvotes if you like them.\n- This kernel is a forked from [BigQuery Machine Learning Tutorial](https:\/\/www.kaggle.com\/rtatman\/bigquery-machine-learning-tutorial).\n- The direction features are like the Flow feature in https:\/\/www.kaggle.com\/jpmiller\/intersection-level-eda","74b86bb7":"## Output as CSV\n","1460dffb":"# Model"}}