{"cell_type":{"3c0fc071":"code","890ae938":"code","b97c9ee1":"code","2623d130":"code","39e801bf":"code","1738dfe5":"code","b4feb47c":"code","4950a797":"code","8612bb07":"code","608c4eaf":"code","182b3d6b":"code","20bd2a01":"code","022aecfd":"code","701ba45e":"code","241d22bd":"code","1b2918d2":"code","22499752":"code","ce89b786":"code","4cdbf94d":"code","49f952a6":"markdown","5e2ea520":"markdown","db3dad51":"markdown","9de64a24":"markdown","d79c7de5":"markdown","fab240aa":"markdown","c32c38b0":"markdown","89dc6d2f":"markdown","a9888f01":"markdown","b6ca202a":"markdown","315aabce":"markdown","ecb1c809":"markdown"},"source":{"3c0fc071":"import numpy as np\nimport pandas as pd\nimport random\nfrom sklearn.preprocessing import LabelEncoder\nfrom lightgbm import LGBMRegressor\nfrom lightgbm import LGBMClassifier\nimport lightgbm\nimport matplotlib.pyplot as plt \nfrom sklearn.model_selection import KFold\nfrom tqdm import tqdm\nfrom sklearn.metrics import log_loss\nimport warnings\nwarnings.filterwarnings('ignore')","890ae938":"NCAA = pd.read_csv('..\/input\/kenpom-2020\/NCAA2021_Kenpom.csv')\nNCAA['record_w'] = NCAA['record'].apply(lambda x: int(x.split('-')[0]))\nNCAA['record_l'] = NCAA['record'].apply(lambda x: int(x.split('-')[1]))\nNCAA = NCAA.drop(['FirstD1Season','TeamName','FirstD1Season','LastD1Season','team','Seed','conference','record'],axis = 1)\nNCAA.head()","b97c9ee1":"# Kenpom = pd.read_csv('..\/input\/kenpom-2020\/Mkenpom2021.csv')\n# Teams = pd.read_csv('..\/input\/ncaam-march-mania-2021\/MDataFiles_Stage2\/MTeamSpellings.csv',encoding='cp1251')\n# Kenpom['Team'] = Kenpom['Team'].str.lower()\n# Kenpom = Kenpom.merge(Teams, how='left', left_on=['Team'], right_on=['TeamNameSpelling'])\n# Kenpom = Kenpom.dropna(subset=['TeamID'])\n# Kenpom['TeamID'] = Kenpom['TeamID'].astype(int)\n# Kenpom = Kenpom[['Year','TeamID','Wins','Losses','Pyth']]\n# Kenpom.head()","2623d130":"men538 = pd.read_csv('..\/input\/ncaa-men-538-team-ratings\/538ratingsMen.csv').drop(['TeamName'],axis = 1)\nmen538.head()","39e801bf":"MNCAATourneyDetailedResults = pd.read_csv('..\/input\/ncaam-march-mania-2021\/MDataFiles_Stage2\/MNCAATourneyDetailedResults.csv')\nMNCAATourneyCompactResults = pd.read_csv('..\/input\/ncaam-march-mania-2021\/MDataFiles_Stage2\/MNCAATourneyCompactResults.csv')\nTourneyResults = MNCAATourneyDetailedResults.merge(MNCAATourneyCompactResults, on= MNCAATourneyCompactResults.columns.to_list(), how='right')\nTourneyResults['TypeCompetition'] = 'Tourney'\n\nMRegularSeasonDetailedResults = pd.read_csv('..\/input\/ncaam-march-mania-2021\/MDataFiles_Stage2\/MRegularSeasonDetailedResults.csv')\nMRegularSeasonCompactResults = pd.read_csv('..\/input\/ncaam-march-mania-2021\/MDataFiles_Stage2\/MRegularSeasonCompactResults.csv')\nSeasonResults = MRegularSeasonDetailedResults.merge(MRegularSeasonCompactResults, on= MRegularSeasonCompactResults.columns.to_list(), how='right')\nSeasonResults['TypeCompetition'] = 'Season'\n\nX = TourneyResults.merge(SeasonResults, on= SeasonResults.columns.to_list(), how='outer')\n\nX = X.drop(['DayNum',\n       'NumOT', 'WFGM', 'WFGA', 'WFGM3', 'WFGA3', 'WFTM', 'WFTA', 'WOR', 'WDR',\n       'WAst', 'WTO', 'WStl', 'WBlk', 'WPF', 'LFGM', 'LFGA', 'LFGM3', 'LFGA3',\n       'LFTM', 'LFTA', 'LOR', 'LDR', 'LAst', 'LTO', 'LStl', 'LBlk', 'LPF'], axis=1)\nX.head()","1738dfe5":"A = X[X['WLoc']=='A'].rename(columns={\n    'WTeamID': 'BTeamID',\n    'WScore': 'BScore',\n    'LTeamID': 'ATeamID',\n    'LScore': 'AScore',\n}).drop('WLoc', axis=1)\n\nH = X[X['WLoc']=='H'].rename(columns={\n    'WTeamID': 'ATeamID',\n    'WScore': 'AScore',\n    'LTeamID': 'BTeamID',\n    'LScore': 'BScore',\n}).drop('WLoc', axis=1)\n\nN = X[X['WLoc']=='N'].rename(columns={\n    'WTeamID': 'ATeamID',\n    'WScore': 'AScore',\n    'LTeamID': 'BTeamID',\n    'LScore': 'BScore',\n})\n\nimport random\nfor index in N.index:\n    if random.randint(0, 1) == 1:\n        N.at[index, 'WLoc'] = N.at[index, 'ATeamID']\n        N.at[index, 'ATeamID'] = N.at[index, 'BTeamID']\n        N.at[index, 'BTeamID'] = N.at[index, 'WLoc']\n        \n        N.at[index, 'WLoc'] = N.at[index, 'AScore']\n        N.at[index, 'AScore'] = N.at[index, 'BScore']\n        N.at[index, 'BScore'] = N.at[index, 'WLoc']\n\nN = N.drop('WLoc', axis=1)  \n\nX = H.append(A, ignore_index=False,sort=False)\nX = X.append(N, ignore_index=False,sort=False)\nX.head()","b4feb47c":"X = X.merge(NCAA, how='left', left_on=['Season','ATeamID'], right_on=['Season','TeamID']).drop(['TeamID'], axis=1)\nX = X.merge(NCAA, how='left', left_on=['Season','BTeamID'], right_on=['Season','TeamID']).drop(['TeamID'], axis=1)\n\n# X = X.merge(Kenpom, how='left', left_on=['Season','ATeamID'], right_on=['Year','TeamID']).drop(['TeamID','Year'], axis=1)\n# X = X.merge(Kenpom, how='left', left_on=['Season','BTeamID'], right_on=['Year','TeamID']).drop(['TeamID','Year'], axis=1)\n\nX = X.merge(men538, how='left', left_on=['Season','ATeamID'], right_on=['Season','TeamID']).drop(['TeamID'], axis=1)\nX = X.merge(men538, how='left', left_on=['Season','BTeamID'], right_on=['Season','TeamID']).drop(['TeamID'], axis=1)\n\nX = X.dropna(subset=['rank_x','rank_y'])\nX.head()","4950a797":"X['rank'] = X['rank_x'] - X['rank_y']\nX['adj_em'] = X['adj_em_x'] - X['adj_em_y']\nX['adj_o'] = X['adj_o_x'] - X['adj_o_y']\nX['adj_o_rank'] = X['adj_o_rank_x'] - X['adj_o_rank_y']\nX['adj_d'] = X['adj_d_x'] - X['adj_d_y']\nX['adj_d_rank'] = X['adj_d_rank_x'] - X['adj_d_rank_y']\nX['adj_tempo'] = X['adj_tempo_x'] - X['adj_tempo_y']\nX['adj_tempo_rank'] = X['adj_tempo_rank_x'] - X['adj_tempo_rank_y']\nX['luck_rank'] = X['luck_rank_x'] - X['luck_rank_y']\nX['sos_adj_em'] = X['sos_adj_em_x'] - X['sos_adj_em_y']\nX['sos_adj_em_rank'] = X['sos_adj_em_rank_x'] - X['sos_adj_em_rank_y']\nX['nc_sos_adj_em'] = X['nc_sos_adj_em_x'] - X['nc_sos_adj_em_y']\nX['nc_sos_adj_em_rank'] = X['nc_sos_adj_em_rank_x'] - X['nc_sos_adj_em_rank_y']\nX['ncaa_seed'] = X['ncaa_seed_x'] - X['ncaa_seed_y']\nX['record_w'] = X['record_w_x'] - X['record_w_y']\nX['record_l'] = X['record_l_x'] - X['record_l_y']\n\n# X['Rank'] = X['Rank_x'] - X['Rank_y']\n# X['Wins'] = X['Wins_x'] - X['Wins_y']\n# X['Losses'] = X['Losses_x'] - X['Losses_y']\n# X['Pyth'] = X['Pyth_x'] - X['Pyth_y']\n\nX['538rating'] = X['538rating_x'] - X['538rating_y']\n\nX = X.drop(['rank_x', 'adj_em_x', 'adj_o_x',\n       'adj_o_rank_x', 'adj_d_x', 'adj_d_rank_x', 'adj_tempo_x',\n       'adj_tempo_rank_x', 'luck_x', 'luck_rank_x', 'sos_adj_em_x',\n       'sos_adj_em_rank_x', 'sos_adj_o_x', 'sos_adj_o_rank_x', 'sos_adj_d_x',\n       'sos_adj_d_rank_x', 'nc_sos_adj_em_x', 'nc_sos_adj_em_rank_x',\n       'ncaa_seed_x', 'record_w_x', 'record_l_x', 'rank_y', 'adj_em_y',\n       'adj_o_y', 'adj_o_rank_y', 'adj_d_y', 'adj_d_rank_y', 'adj_tempo_y',\n       'adj_tempo_rank_y', 'luck_y', 'luck_rank_y', 'sos_adj_em_y',\n       'sos_adj_em_rank_y', 'sos_adj_o_y', 'sos_adj_o_rank_y', 'sos_adj_d_y',\n       'sos_adj_d_rank_y', 'nc_sos_adj_em_y', 'nc_sos_adj_em_rank_y',\n       'ncaa_seed_y', 'record_w_y', 'record_l_y',\n       '538rating_x', '538rating_y'],axis = 1)","8612bb07":"X['HomeWin'] = (X['AScore']-X['BScore'] > 0).astype(int)\nX.head()","608c4eaf":"test = pd.read_csv('..\/input\/ncaam-march-mania-2021\/MDataFiles_Stage2\/MSampleSubmissionStage2.csv')\nsubmission = pd.read_csv('..\/input\/ncaam-march-mania-2021\/MDataFiles_Stage2\/MSampleSubmissionStage2.csv')\n\ntest['Season'] = test['ID'].apply(lambda x: int(x.split('_')[0]))\ntest['ATeamID'] = test['ID'].apply(lambda x: int(x.split('_')[1]))\ntest['BTeamID'] = test['ID'].apply(lambda x: int(x.split('_')[2]))\ntest = test.drop(['Pred','ID'], axis=1)\ntest['TypeCompetition'] = 'Tourney'\ntest.head()","182b3d6b":"test = test.merge(NCAA, how='left', left_on=['Season','ATeamID'], right_on=['Season','TeamID']).drop(['TeamID'], axis=1)\ntest = test.merge(NCAA, how='left', left_on=['Season','BTeamID'], right_on=['Season','TeamID']).drop(['TeamID'], axis=1)\n\n# test = test.merge(Kenpom, how='left', left_on=['Season','ATeamID'], right_on=['Year','TeamID']).drop(['TeamID','Year'], axis=1)\n# test = test.merge(Kenpom, how='left', left_on=['Season','BTeamID'], right_on=['Year','TeamID']).drop(['TeamID','Year'], axis=1)\n\ntest = test.merge(men538, how='left', left_on=['Season','ATeamID'], right_on=['Season','TeamID']).drop(['TeamID'], axis=1)\ntest = test.merge(men538, how='left', left_on=['Season','BTeamID'], right_on=['Season','TeamID']).drop(['TeamID'], axis=1)\ntest.head()","20bd2a01":"test['rank'] = test['rank_x'] - test['rank_y']\ntest['adj_em'] = test['adj_em_x'] - test['adj_em_y']\ntest['adj_o'] = test['adj_o_x'] - test['adj_o_y']\ntest['adj_o_rank'] = test['adj_o_rank_x'] - test['adj_o_rank_y']\ntest['adj_d'] = test['adj_d_x'] - test['adj_d_y']\ntest['adj_d_rank'] = test['adj_d_rank_x'] - test['adj_d_rank_y']\ntest['adj_tempo'] = test['adj_tempo_x'] - test['adj_tempo_y']\ntest['adj_tempo_rank'] = test['adj_tempo_rank_x'] - test['adj_tempo_rank_y']\ntest['luck_rank'] = test['luck_rank_x'] - test['luck_rank_y']\ntest['sos_adj_em'] = test['sos_adj_em_x'] - test['sos_adj_em_y']\ntest['sos_adj_em_rank'] = test['sos_adj_em_rank_x'] - test['sos_adj_em_rank_y']\ntest['nc_sos_adj_em'] = test['nc_sos_adj_em_x'] - test['nc_sos_adj_em_y']\ntest['nc_sos_adj_em_rank'] = test['nc_sos_adj_em_rank_x'] - test['nc_sos_adj_em_rank_y']\ntest['ncaa_seed'] = test['ncaa_seed_x'] - test['ncaa_seed_y']\ntest['record_w'] = test['record_w_x'] - test['record_w_y']\ntest['record_l'] = test['record_l_x'] - test['record_l_y']\n\n# test['Rank'] = test['Rank_x'] - test['Rank_y']\n# test['Wins'] = test['Wins_x'] - test['Wins_y']\n# test['Losses'] = test['Losses_x'] - test['Losses_y']\n# test['Pyth'] = test['Pyth_x'] - test['Pyth_y']\n\ntest['538rating'] = test['538rating_x'] - test['538rating_y']\n\ntest = test.drop(['rank_x', 'adj_em_x', 'adj_o_x',\n       'adj_o_rank_x', 'adj_d_x', 'adj_d_rank_x', 'adj_tempo_x',\n       'adj_tempo_rank_x', 'luck_x', 'luck_rank_x', 'sos_adj_em_x',\n       'sos_adj_em_rank_x', 'sos_adj_o_x', 'sos_adj_o_rank_x', 'sos_adj_d_x',\n       'sos_adj_d_rank_x', 'nc_sos_adj_em_x', 'nc_sos_adj_em_rank_x',\n       'ncaa_seed_x', 'record_w_x', 'record_l_x', 'rank_y', 'adj_em_y',\n       'adj_o_y', 'adj_o_rank_y', 'adj_d_y', 'adj_d_rank_y', 'adj_tempo_y',\n       'adj_tempo_rank_y', 'luck_y', 'luck_rank_y', 'sos_adj_em_y',\n       'sos_adj_em_rank_y', 'sos_adj_o_y', 'sos_adj_o_rank_y', 'sos_adj_d_y',\n       'sos_adj_d_rank_y', 'nc_sos_adj_em_y', 'nc_sos_adj_em_rank_y',\n       'ncaa_seed_y', 'record_w_y', 'record_l_y',\n       '538rating_x', '538rating_y'],axis = 1)","022aecfd":"temp = X.append(test, ignore_index=False,sort=False)\ntemp = pd.get_dummies(temp,dtype=bool)\nX = temp[:len(X)]\ntest = temp[len(X):]\ntemp = pd.DataFrame\ntest = test.drop(['AScore','BScore','HomeWin'],axis = 1)","701ba45e":"test","241d22bd":"X","1b2918d2":"lgbm_parameters= {\n    'objective': 'binary',\n    'metric': 'binary_logloss',\n}","22499752":"test_pred = np.zeros(len(test))\ntest_pred = []\n\nkf = KFold(n_splits=10, shuffle=True)\n\nfor year in test['Season'].unique():\n    \n    #X_year = X[(X['Season'] >= year-5)&(X['Season'] <= year+5)]\n    X_year = X[((X['TypeCompetition_Season'] == True)&(X['Season'] == year))|(X['Season'] != year)]\n    \n    y_year = X_year['HomeWin']\n    X_year = X_year.drop(['AScore','BScore','HomeWin'], axis=1)\n    test_year = test[test['Season'] == year]\n \n    lgbm_val_pred = np.zeros(len(y_year))\n    lgbm_test_pred = np.zeros(len(test_year))\n    logloss = []\n    \n    for trn_idx, val_idx in kf.split(X_year,y_year):\n        x_train_idx = X_year.iloc[trn_idx]\n        y_train_idx = y_year.iloc[trn_idx]\n        x_valid_idx = X_year.iloc[val_idx]\n        y_valid_idx = y_year.iloc[val_idx]\n\n        lgbm_model = LGBMClassifier(**lgbm_parameters)\n        lgbm_model.fit(x_train_idx, y_train_idx, eval_set = ((x_valid_idx,y_valid_idx)),verbose = False, early_stopping_rounds = 100,categorical_feature=[0,1,2])\n        lgbm_test_pred += lgbm_model.predict_proba(test_year)[:,1]\/10\n        logloss.append(log_loss(y_valid_idx, lgbm_model.predict_proba(x_valid_idx)[:,1])) \n        \n    test_pred += lgbm_test_pred.tolist()\n    \n    print('Year_Predict:',year,'Log_Loss:',np.mean(logloss))","ce89b786":"submission.Pred = test_pred  \nsubmission.to_csv('submission.csv', index=False)","4cdbf94d":"plt.rcParams[\"figure.figsize\"] = (5, 10)\nlightgbm.plot_importance(lgbm_model,height=.9)","49f952a6":"get y","5e2ea520":"V.2\n\n-deleted prediction year from train\n\nV.3\n\n-add kenpom\n\n-add 538 team rating","db3dad51":"get submission","9de64a24":"Feature importance","d79c7de5":"# test prepare","fab240aa":"load 538 team ratings","c32c38b0":"add kenpom and 538 team ratings to test","89dc6d2f":"# X prepare","a9888f01":"# Train","b6ca202a":"Load kenpom","315aabce":"shuffle teams","ecb1c809":"add kenpom and 538 team ratings to X"}}