{"cell_type":{"e9a03be4":"code","7e64a414":"code","d3c3ed0a":"code","d072008a":"code","e980bb73":"code","38f76134":"code","540fe11b":"code","d4ec01df":"code","4def63d8":"code","fdb20318":"code","533a1fe9":"code","821da088":"code","bf02c661":"code","01b0020f":"code","82148162":"code","f9756b6b":"code","9dfb51d4":"code","fd6d2bd2":"code","2db9b4f5":"markdown","8be87f9d":"markdown","91836ca8":"markdown","acc09280":"markdown","4d3ed428":"markdown","3d8b603e":"markdown","8cfb4a17":"markdown","877707b9":"markdown","a35fa305":"markdown","7a37ac77":"markdown","478467dd":"markdown","23aa961c":"markdown","12854125":"markdown"},"source":{"e9a03be4":"pip install -U scikit-learn","7e64a414":"import pandas as pd\nimport datetime\nimport matplotlib.pyplot as plt\nimport seaborn as sns\nimport statsmodels.api as sm\nimport numpy as np\n\nfrom sklearn.impute import SimpleImputer\nfrom sklearn.linear_model import LinearRegression\nfrom sklearn.metrics import mean_absolute_error, mean_absolute_percentage_error\nfrom sklearn.model_selection import train_test_split\nfrom sklearn.pipeline import Pipeline\nfrom sklearn.preprocessing import OrdinalEncoder, StandardScaler, OneHotEncoder\nfrom sklearn_pandas import DataFrameMapper\n\n# Additional Features","d3c3ed0a":"hdfc = pd.read_csv('..\/input\/stock-price-forecast-india\/HDFCBANK.NS.csv')\nhdfc.head()","d072008a":"def get_stats(df):\n    start_date = datetime.datetime.strptime(df['Date'].min(), '%Y-%m-%d')\n    end_date = datetime.datetime.strptime(df['Date'].max(), '%Y-%m-%d')\n    data_duration = (end_date - start_date).days\n\n    print(f\"Start Date: {df['Date'].min()}\")\n    print(f\"End Date: {df['Date'].max()}\")\n    print(f\"Date Difference: {data_duration}\")\n    print(f\"Number of Data Points: {df.shape[0]}\")","e980bb73":"get_stats(hdfc)","38f76134":"plt.rcParams.update({'figure.figsize': (17, 3), 'figure.dpi':300})\nfig, ax = plt.subplots()\nsns.lineplot(data=hdfc.tail(50), x='Date', y='Adj Close')\nplt.grid(linestyle='-', linewidth=0.3)\nax.tick_params(axis='x', rotation=90)","540fe11b":"hdfc.head","d4ec01df":"hdfc.columns = ['date', 'open', 'high', 'low', 'close', 'adjusted_close', 'volume']\n\nhdfc['prev_adjusted_close'] = hdfc['adjusted_close'].shift(1)\nhdfc['prev_volume'] = hdfc['volume'].shift(1)\nhdfc['day_of_week'] = pd.to_datetime(hdfc['date']).dt.dayofweek\n\ndata = hdfc[['date', 'adjusted_close', 'prev_adjusted_close', 'prev_volume', 'day_of_week']].dropna()\ndata.sample()","4def63d8":"categorical_features = ['day_of_week']\nnumerical_features = ['prev_adjusted_close', 'prev_volume']\nlabel = 'adjusted_close'\n\ntrain_df, test_df = train_test_split(data, test_size=0.1, shuffle=False)\nX_train, y_train = train_df[categorical_features + numerical_features], train_df[label]\nX_test, y_test = test_df[categorical_features + numerical_features], test_df[label]\n\nnum = [([n], [StandardScaler()]) for n in numerical_features]\ncat = [([n], [OrdinalEncoder()]) for n in categorical_features]\nmapper = DataFrameMapper(num + cat, df_out=True)\n\npreprocessed_X_train = mapper.fit_transform(X_train)\npreprocessed_X_train = sm.add_constant(preprocessed_X_train)\nresults = sm.OLS(y_train, preprocessed_X_train).fit()\nresults.summary()","fdb20318":"def evaluation(pipeline, X, y):\n    y_prediction = pipeline.predict(X)\n    return{\n        'MAE': mean_absolute_error(y, y_prediction),\n        'MAPE': mean_absolute_percentage_error(y, y_prediction),\n        'y_pred': y_prediction\n    }","533a1fe9":"mapper = DataFrameMapper(num + cat, df_out=True)\nclf = LinearRegression()\npipeline = Pipeline([\n    ('preprocess', mapper),\n    ('clf', clf)\n])\n\npipeline.fit(X_train, y_train)\nresults = evaluation(pipeline, X_test, y_test)\nprint(f\"MAE: \u20b9{round(results['MAE'], 2)}, MAPE: {round(results['MAPE'] * 100, 2)}%\")","821da088":"hdfc_forecast = pd.DataFrame(data={\n    'date': test_df['date'].reset_index().drop('index', axis=1)['date'],\n    'predictions': results['y_pred'],\n    'truth': y_test.reset_index().drop('index', axis=1)['adjusted_close']})\nhdfc_forecast.sample()","bf02c661":"plt.rcParams.update({'figure.figsize': (17, 3), 'figure.dpi':300})\nfig, ax = plt.subplots()\nsns.lineplot(data=hdfc_forecast.tail(50), x='date', y='truth')\nsns.lineplot(data=hdfc_forecast.tail(50), x='date', y='predictions')\nplt.grid(linestyle='-', linewidth=0.3)\nax.tick_params(axis='x', rotation=90)","01b0020f":"hdfc_forecast.tail(10)","82148162":"test_df['perc_change'] = (\n    (test_df['adjusted_close'] - test_df['prev_adjusted_close']) * 100 \/ \\\n    test_df['prev_adjusted_close']).abs()\nhdfc_forecast = hdfc_forecast.merge(test_df[['date', 'perc_change']], on='date')\nhdfc_forecast.sample()","f9756b6b":"performance = []\nfor perc_change in np.arange(0, 10, 0.5):\n    test = hdfc_forecast[hdfc_forecast['perc_change'] > perc_change]\n    performance.append({\n        'perc_change': perc_change,\n        'MAE':  mean_absolute_error(test['truth'], test['predictions']),\n        'MAPE':  mean_absolute_percentage_error(test['truth'], test['predictions']),\n        'count': test.shape[0]\n    })\nresults = pd.DataFrame(performance)","9dfb51d4":"plt.rcParams.update({'figure.figsize': (17, 3), 'figure.dpi': 300})\nfig, ax = plt.subplots()\nax2 = ax.twinx()\n\nsns.lineplot(\n    data=results['MAE'],\n    color='red',\n    legend=True,\n    ax=ax)\n\nsns.barplot(\n    x='perc_change',\n    y='count',\n    data=results,\n    color='blue',\n    alpha=0.1,\n    ax=ax2\n)\n\nplt.grid(linestyle='-', linewidth=0.3)\ntitle = ax.set_title('Model Evaluation for different Price Changes')\nxlabel = ax.set_xlabel('Absolute Percentage Change (Day over Day)')\nylabel = ax2.set_ylabel('Number of Days')\ny2label = ax.set_ylabel('MAE')","fd6d2bd2":"plt.rcParams.update({'figure.figsize': (17, 3), 'figure.dpi': 300})\nfig, ax = plt.subplots()\nax2 = ax.twinx()\n\nsns.lineplot(\n    data=results['MAPE'],\n    color='red',\n    legend=True,\n    ax=ax)\n\nsns.barplot(\n    x='perc_change',\n    y='count',\n    data=results,\n    color='blue',\n    alpha=0.1,\n    ax=ax2\n)\n\nplt.grid(linestyle='-', linewidth=0.3)\ntitle = ax.set_title('Model Evaluation for different Price Changes')\nxlabel = ax.set_xlabel('Absolute Percentage Change (Day over Day)')\nylabel = ax2.set_ylabel('Number of Days')\ny2label = ax.set_ylabel('MAPE')","2db9b4f5":"# Kernal is still under development!","8be87f9d":"Let's see how far we can get with:\n\n1. Lagged Ajusted Close price\n2. Previous day's volume\n3. Day of week","91836ca8":"# 3 Model Training","acc09280":"Not a good evaluation metric since we are lagging the truth. Maybe it's more apparent in drops","4d3ed428":"Let's plot the adjusted closed price for the last 50 days","3d8b603e":"How well can we predict the closing price of a stock every day? Let's use HDFCBANK as an example\n\n\nOutcome\n\n* Timeseries analysis\n* Novel method of evaluation of model\n* Machine Learning isn't magic\n","8cfb4a17":"Let's leave in prev_volume. If taken alone, it shows significance. The linear regression model may not be complex enough to capture contribution by prev_volume","877707b9":"If you have any suggestion please provide in comment section. Thank You!","a35fa305":"We will apply some more models and use google trends in coming days! ","7a37ac77":"# 1 Problem","478467dd":"# 2 Feature Engineering","23aa961c":"Simple Linear Regression looks like it's doing super well. But is it?","12854125":"# 4 Better Evaluation Metric"}}