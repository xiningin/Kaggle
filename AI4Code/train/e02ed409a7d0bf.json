{"cell_type":{"d9c5b842":"code","2ae4cb22":"code","1a16031d":"code","289a8065":"code","48257c01":"code","673f32c7":"code","aa450eaa":"code","6a16c207":"code","48c0fb85":"code","8b350283":"code","89a7abc5":"code","ce99972a":"code","d36c75a3":"code","a0095a0d":"code","4aebf18c":"code","fdd1ba80":"code","b44180d6":"code","94ab3f3b":"code","e0109b09":"code","ea584fcd":"code","77de5051":"code","19c49188":"code","618a3194":"code","4e6786a1":"code","11b14fd8":"code","f0ad9012":"markdown","4ac3989c":"markdown","442aae6d":"markdown","429d1ea0":"markdown","ccdafc86":"markdown","f15923a5":"markdown","a5e83625":"markdown","7102520d":"markdown"},"source":{"d9c5b842":"import numpy as np\nimport pandas as pd\nimport os\n\nimport matplotlib.pyplot as plt\nimport matplotlib.image as mpimg\n\n%matplotlib inline","2ae4cb22":"TRAIN_CSV_PATH = '..\/input\/plant-pathology-2020-fgvc7\/train.csv'\nTEST_CSV_PATH = '..\/input\/plant-pathology-2020-fgvc7\/test.csv'\nINPUT_IMAGES_DIR = '..\/input\/plant-pathology-2020-fgvc7\/images\/'\nROOT_INPUT_DIR = '..\/input\/plant-pathology-2020-fgvc7\/'","1a16031d":"dataset = pd.read_csv(TRAIN_CSV_PATH)\ndataset.head()","289a8065":"dataset.info()","48257c01":"num_healthy_plant = dataset['healthy'].value_counts()\nprint(\"Number of healthy leafs: {}\".format(num_healthy_plant.loc[1]))\nprint(\"Number of unhealthy leafs: {}\".format(num_healthy_plant.loc[0]))","673f32c7":"num_multi_diseases_plant = dataset['multiple_diseases'].value_counts()\nprint(\"Number of leafs has multiple diseases: {}\".format(num_multi_diseases_plant.loc[1]))\nprint(\"Number of leafs doesn't has multiple diseases: {}\".format(num_multi_diseases_plant.loc[0]))\n\nnum_multi_diseases_plant.plot.bar()","aa450eaa":"num_rust_plant = dataset['rust'].value_counts()\nprint(\"Number of leafs has rust: {}\".format(num_rust_plant.loc[1]))\nprint(\"Number of leafs doesn't has rust: {}\".format(num_rust_plant.loc[0]))\n\nnum_rust_plant.plot.bar()","6a16c207":"num_scab_plant = dataset['scab'].value_counts()\nprint(\"Number of leafs has scab: {}\".format(num_scab_plant.loc[1]))\nprint(\"Number of leafs doesn't has scab: {}\".format(num_scab_plant.loc[0]))\n\nnum_scab_plant.plot.bar()","48c0fb85":"def show_rgb_color_channels(image_id):        \n    fig = plt.figure(figsize=(15, 12))\n    img = mpimg.imread(INPUT_IMAGES_DIR + image_id + '.jpg')\n    image_titles = ['Original Image', 'R Channels', 'G Channels', 'B Channels']\n    # showing RGB image\n    ax = fig.add_subplot(1, 4, 1)\n    ax.title.set_text(image_titles[0])\n    plt.imshow(img)\n\n    for i in range(3):\n        ax = fig.add_subplot(1, 4, i+2)\n        ax.title.set_text(image_titles[i+1])\n        plt.imshow(img[:, :, i])\n\n    plt.show()","8b350283":"# A healthy leaf\nhealthy_leaf_image_ids = dataset[dataset['healthy'] == 1]['image_id']\nshow_rgb_color_channels(healthy_leaf_image_ids.iloc[0])","89a7abc5":"# A leaf with multiple_diseases\nmultiple_diseases_leaf_image_ids = dataset[dataset['multiple_diseases'] == 1]['image_id']\nshow_rgb_color_channels(multiple_diseases_leaf_image_ids.iloc[0])","ce99972a":"# A leaf with rust\nrust_leaf_image_ids = dataset[dataset['rust'] == 1]['image_id']\nshow_rgb_color_channels(rust_leaf_image_ids.iloc[0])","d36c75a3":"# A leaf with scab\nscab_leaf_image_ids = dataset[dataset['scab'] == 1]['image_id']\nshow_rgb_color_channels(scab_leaf_image_ids.iloc[0])","a0095a0d":"unique_shapes_of_images = set()\n\nfor image_id in dataset.image_id:\n    img = mpimg.imread(INPUT_IMAGES_DIR + image_id + '.jpg')\n    unique_shapes_of_images.add(img.shape)\n\nunique_shapes_of_images","4aebf18c":"## Installing pytorch lightning\n!pip install pytorch_lightning","fdd1ba80":"# Ignore warnings\nimport warnings\nwarnings.filterwarnings(\"ignore\")\nfrom PIL import Image\nfrom argparse import Namespace\n\nimport torch\nfrom torch import nn\nfrom torch.utils.data import Dataset\nfrom torchvision import transforms\nfrom torch.utils.data import DataLoader, random_split\nfrom torch.nn import functional as F\nimport torchvision.models as models\n\nimport pytorch_lightning as pl","b44180d6":"class PlantTrainDataset(Dataset):\n    def __init__(self, df, image_root_dir):\n        self.dataset = df                \n        self.image_root_dir = image_root_dir  #'..\/input\/images\/'              \n        self.transforms = transforms.Compose([transforms.RandomApply([transforms.RandomHorizontalFlip(),\n                                                    transforms.RandomRotation(10),\n                                                    transforms.RandomVerticalFlip(),\n                                                    transforms.CenterCrop((224,224))\n                                                    ]),\n                                                transforms.Resize((224,224)),\n                                                transforms.ToTensor(),\n                                                transforms.Normalize(mean=[0.485, 0.456, 0.406],\n                                                                        std=[0.229, 0.224, 0.225])                                                \n                                                ])              \n\n    def __len__(self):\n        return len(self.dataset.image_id)\n\n    def __getitem__(self, idx):        \n        image_id = self.dataset.iloc[idx, 0]\n        label = self.dataset.iloc[idx, 1:]\n        label = torch.tensor(label, dtype=torch.long)        \n        \n        image = Image.open(self.image_root_dir + image_id + '.jpg')    \n        image = self.transform_image(image)\n        \n        return image, label\n\n    def transform_image(self, image):                \n        image = self.transforms(image)\n        return image","94ab3f3b":"class PlantTestDataset(Dataset):\n    def __init__(self, df, image_root_dir):\n        self.dataset = df                \n        self.transforms = transforms.Compose([transforms.Resize((224,224)),\n                                                transforms.ToTensor(),\n                                                transforms.Normalize(mean=[0.485, 0.456, 0.406],\n                                                                        std=[0.229, 0.224, 0.225])                                                \n                                                ])    \n        self.image_root_dir = image_root_dir #'..\/input\/images\/'        \n\n    def __len__(self):\n        return len(self.dataset.image_id)\n\n    def __getitem__(self, idx):\n        image_id = self.dataset.iloc[idx, 0]        \n        image = Image.open(self.image_root_dir + image_id + '.jpg')    \n        image = self.transforms(image)\n        \n        return image_id, image","e0109b09":"class PlantDiseaseClassifier(pl.LightningModule):\n\n    def __init__(self, hyper_params): \n        super(PlantDiseaseClassifier, self).__init__()\n        self.root_input_dir = ROOT_INPUT_DIR\n        self.train_batch_size = hyper_params.train_batch_size\n        self.test_batch_size = hyper_params.test_batch_size\n        self.val_batch_size = hyper_params.val_batch_size\n        self.learning_rate = hyper_params.learning_rate\n        ### model architecture\n        self.model = models.resnet18(pretrained=True)\n\n        self.model.fc = nn.Linear(self.model.fc.in_features, 4)                \n        self.soft_max = nn.Softmax(dim=1)\n\n    def forward(self, x):\n        x = self.model(x)\n        x = self.soft_max(x)\n        return x\n\n    def cross_entropy_loss(self, logits, labels):        \n        return F.nll_loss(logits, torch.argmax(labels, dim=1))\n\n    def training_step(self, train_batch, batch_idx):\n      x, y = train_batch\n      logits = self(x) ##\n      loss = self.cross_entropy_loss(logits, y)\n\n      logs = {'train_loss': loss}\n      return {'loss': loss, 'log': logs}\n\n    def validation_step(self, val_batch, batch_idx):\n      x, y = val_batch\n      logits = self(x) ##\n      loss = self.cross_entropy_loss(logits, y)\n      return {'val_loss': loss}\n\n    def validation_epoch_end(self, outputs):        \n        avg_loss = torch.stack([x['val_loss'] for x in outputs]).mean()\n        tensorboard_logs = {'val_loss': avg_loss}\n        return {'avg_val_loss': avg_loss, 'log': tensorboard_logs}\n\n    def prepare_data(self):                            \n        train_dataset = pd.read_csv(self.root_input_dir + 'train.csv')\n        test_dataset = pd.read_csv(self.root_input_dir + 'test.csv')\n        \n        image_dir = self.root_input_dir + 'images\/'\n        plant_train = PlantTrainDataset(train_dataset, image_dir)\n        plant_test = PlantTestDataset(test_dataset, image_dir)\n        \n        self.plant_train, self.plant_val = random_split(plant_train, [1500, 321])\n        self.plant_test = plant_test\n\n    def train_dataloader(self):\n        return DataLoader(self.plant_train, batch_size=self.train_batch_size)\n\n    def val_dataloader(self):\n        return DataLoader(self.plant_val, batch_size=self.val_batch_size)\n\n    def test_dataloader(self):\n        return DataLoader(self.plant_test, batch_size=self.test_batch_size)\n\n    def configure_optimizers(self):\n        optimizer = torch.optim.Adam(self.parameters(), lr=self.learning_rate)\n        return optimizer","ea584fcd":"#%load_ext tensorboard\n#%tensorboard --logdir lightning_logs\/","77de5051":"hyper_params = Namespace(**{\n    'train_batch_size': 64,\n    'test_batch_size': 8,\n    'val_batch_size': 8,\n    'learning_rate': 2e-4\n})\n\n\nmodel = PlantDiseaseClassifier(hyper_params)\ntrainer = pl.Trainer(max_epochs=50, gpus=1)\n\ntrainer.fit(model)","19c49188":"model.eval()\n\ntest_dataloader = model.test_dataloader()\npredictions = []\nfor image_ids, images in test_dataloader:\n    outputs = model(images.cuda())\n    outputs = outputs.detach().cpu().numpy()\n    for idx, image_id in enumerate(image_ids):\n        predictions.append((image_id, outputs[idx, 0], outputs[idx, 1], outputs[idx, 2], outputs[idx, 3]))        ","618a3194":"submission = pd.DataFrame(predictions, columns=['image_id', 'healthy', 'multiple_diseases', 'rust', 'scab'])\nsubmission.head()","4e6786a1":"submission.tail()","11b14fd8":"submission.to_csv('submission.csv', index=False)","f0ad9012":"### Let's see the unique shapes of the training images","4ac3989c":"#### Currently kaggle has disabled the tensorboard feature. I have tried them in colab.","442aae6d":"### Now comes the model.....","429d1ea0":"### First, preparing our dataset classes","ccdafc86":"### We are going to visualize all photos of each labels.","f15923a5":"### Loading required packages for this part of the notebook.","a5e83625":"if we sums up all the 1's, it will sum up to (516 + 91 + 622 + 592) = 1821.\nIt means there is no photo without labels.","7102520d":"## NOW Let's start working with our model."}}