{"cell_type":{"5d2342ca":"code","14c765ff":"code","3ec085ca":"code","0af0745c":"code","64de3c2e":"code","f8285842":"code","8500faac":"code","27015d56":"code","a1d1bb58":"code","ff85126f":"code","93b0e655":"code","5c7608ed":"code","8fe34c7d":"code","fb0053eb":"code","bdcf26ff":"code","be4c6eea":"code","985a3263":"code","c7e8cb66":"code","a55bc678":"code","dd21ccda":"code","83c67b38":"code","0a33890b":"markdown","97d0e748":"markdown"},"source":{"5d2342ca":"%%capture\n!pip install pycaret[full]\n\nimport os\nimport warnings\n\nimport numpy as np  # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\n\nimport seaborn as sns\nimport matplotlib.pyplot as plt\n\nimport math\nfrom pathlib import Path\n\nimport dateutil.easter as easter\nfrom pycaret.regression import *\n\n# Mute warnings\nwarnings.filterwarnings(\"ignore\")","14c765ff":"data_dir = Path('..\/input\/tabular-playground-series-jan-2022')\nholiday_dir = Path('..\/input\/public-and-unofficial-holidays-nor-fin-swe-201519')\ngdp_dir = Path('..\/input\/gdp-20152019-finland-norway-and-sweden')\n\ntrain = pd.read_csv(\n    data_dir \/ 'train.csv',\n    dtype={\n        'country': 'category',\n        'store': 'category',\n        'product': 'category',\n        'num_sold': 'float32',\n    },\n    parse_dates=['date'],\n    infer_datetime_format=True,\n    index_col='row_id'\n)\n\ntest = pd.read_csv(\n    data_dir \/ \"test.csv\",\n    dtype={\n        'country': 'category',\n        'store': 'category',\n        'product': 'category',\n    },\n    parse_dates=['date'],\n    infer_datetime_format=True,\n    index_col='row_id'\n)\n\ntarget_col = train.columns.difference(test.columns)[0]\n\nholiday_data = pd.read_csv(holiday_dir \/ 'holidays.csv')\n\ngdp = pd.read_csv(\n    gdp_dir \/ 'GDP_data_2015_to_2019_Finland_Norway_Sweden.csv', index_col='year')","3ec085ca":"# Categorical features\ncategorical_cols = train.select_dtypes('category').columns.tolist() # country, store, product","0af0745c":"K_FOLDS = 3\nGDP_EXPONENT = 1.2120618918594863 \n# c.f https:\/\/www.kaggle.com\/ambrosm\/tpsjan22-03-linear-model\n\ngdp.columns = gdp.columns.str[4:]\ngdp = gdp.apply(lambda x: x**GDP_EXPONENT)\nscaler = gdp.iloc[K_FOLDS+1] \/ gdp\ngdp_map = scaler.stack().to_dict()\n\ntrain[target_col] = pd.Series(\n    list(zip(train.date.dt.year,train.country))\n).map(gdp_map) * train[target_col]\n\ntrain[target_col] = np.log1p(train.num_sold)","64de3c2e":"# Event \/ Holidays for Finland, Sweden and Norway\nholiday_data.head(5)","f8285842":"def holiday_features(holiday_df, df):\n    \n    fin_holiday = holiday_df.loc[holiday_df.country == 'Finland']\n    swe_holiday = holiday_df.loc[holiday_df.country == 'Sweden']\n    nor_holiday = holiday_df.loc[holiday_df.country == 'Norway']\n    \n    df['fin holiday'] = df.date.isin(fin_holiday.date).astype(int)\n    df['swe holiday'] = df.date.isin(swe_holiday.date).astype(int)\n    df['nor holiday'] = df.date.isin(nor_holiday.date).astype(int)\n    \n    df['holiday'] = np.zeros(df.shape[0]).astype(int)\n    \n    df.loc[df.country == 'Finland', 'holiday'] = df.loc[df.country == 'Finland', 'fin holiday']\n    df.loc[df.country == 'Sweden', 'holiday'] = df.loc[df.country == 'Sweden', 'swe holiday']\n    df.loc[df.country == 'Norway', 'holiday'] = df.loc[df.country == 'Norway', 'nor holiday']\n    \n    df.drop(['fin holiday', 'swe holiday', 'nor holiday'], axis=1, inplace=True)\n    \n    # Easter\n    easter_date = df.date.apply(lambda date: pd.Timestamp(easter.easter(date.year)))\n    df['days_from_easter'] = (df.date - easter_date).dt.days.clip(-5, 65)\n    \n    # Last Sunday of May (Mother's Day)\n    sun_may_date = df.date.dt.year.map({\n        2015: pd.Timestamp(('2015-5-31')),\n        2016: pd.Timestamp(('2016-5-29')),\n        2017: pd.Timestamp(('2017-5-28')),\n        2018: pd.Timestamp(('2018-5-27')),\n        2019: pd.Timestamp(('2019-5-26'))\n    })\n    #new_df['days_from_sun_may'] = (df.date - sun_may_date).dt.days.clip(-1, 9)\n    \n    # Last Wednesday of June\n    wed_june_date = df.date.dt.year.map({\n        2015: pd.Timestamp(('2015-06-24')),\n        2016: pd.Timestamp(('2016-06-29')),\n        2017: pd.Timestamp(('2017-06-28')),\n        2018: pd.Timestamp(('2018-06-27')),\n        2019: pd.Timestamp(('2019-06-26'))\n    })\n    df['days_from_wed_jun'] = (df.date - wed_june_date).dt.days.clip(-5, 5)\n    \n    # First Sunday of November (second Sunday is Father's Day)\n    sun_nov_date = df.date.dt.year.map({\n        2015: pd.Timestamp(('2015-11-1')),\n        2016: pd.Timestamp(('2016-11-6')),\n        2017: pd.Timestamp(('2017-11-5')),\n        2018: pd.Timestamp(('2018-11-4')),\n        2019: pd.Timestamp(('2019-11-3'))\n    })\n    df['days_from_sun_nov'] = (df.date - sun_nov_date).dt.days.clip(-1, 9)\n    \n    return df\n\ntrain = holiday_features(holiday_data, train)\ntest  = holiday_features(holiday_data, test)","8500faac":"train.date.dt.dayofyear","27015d56":"def  fourier_features(df):\n    dayofyear = df.date.dt.dayofyear\n    for k in range(1, 5):\n        df[f'sin{k}'] = np.sin(dayofyear \/ 365.25 * 2 * math.pi * k)\n        df[f'cos{k}'] = np.cos(dayofyear \/ 365.25 * 2 * math.pi * k)\n        df[f'mug_sin{k}'] = df[f'sin{k}'] * df['product_Kaggle Mug']\n        df[f'mug_cos{k}'] = df[f'cos{k}'] * df['product_Kaggle Mug']\n        df[f'hat_sin{k}'] = df[f'sin{k}'] * df['product_Kaggle Hat']\n        df[f'hat_cos{k}'] = df[f'cos{k}'] * df['product_Kaggle Hat']\n    return df","a1d1bb58":"train = pd.get_dummies(train, columns=categorical_cols)\ntest  = pd.get_dummies(test, columns=categorical_cols)","ff85126f":"# Add Fourrier features\ntrain = fourier_features(train)\ntest = fourier_features(test)","93b0e655":"train.head()","5c7608ed":"def new_date_features(df):\n    df['year'] = df.date.dt.year \n    df['quarter'] = df.date.dt.quarter\n    df['month'] = df.date.dt.month  \n    df['week'] = df.date.dt.week \n    df['day'] = df.date.dt.day  \n    df['weekday'] = df.date.dt.weekday\n#     df['day_of_week'] = df.date.dt.dayofweek  \n    df['day_of_year'] = df.date.dt.dayofyear  \n#     df['week_of_year'] = df.date.dt.weekofyear\n    df['day_of_month'] = df.date.dt.days_in_month  \n    df['is_weekend'] = np.where((df['weekday'] == 5) | (df['weekday'] == 6), 1, 0)\n    df['is_friday'] = np.where((df['weekday'] == 4), 1, 0)\n    \n    df.drop('date', axis=1, inplace=True)\n    \n    return df\n    ","8fe34c7d":"# Add Date features\ntrain = new_date_features(train)\ntest  = new_date_features(test)","fb0053eb":"def smape(actual, predicted):\n    numerator = np.abs(predicted - actual)\n    denominator = (np.abs(actual) + np.abs(predicted)) \/ 2\n    \n    return np.mean(numerator \/ denominator)*100","bdcf26ff":"train","be4c6eea":"NB_MODELS = 4\n\nmodels = []\n\nfor i in range (NB_MODELS):\n    print ('Fit Model', i)\n    reg = setup(\n        data = train,\n        target = target_col,\n        data_split_shuffle = False, \n        create_clusters = False,\n        fold_strategy = 'groupkfold',\n        fold_groups = 'year',\n        use_gpu = True,\n        silent = True,\n        fold = K_FOLDS,\n        normalize = True,\n        n_jobs = -1,\n    )\n    \n    add_metric('SMAPE', 'SMAPE', smape, greater_is_better=False)\n    \n    models.append(create_model('catboost'))","985a3263":"blend = blend_models(models)","c7e8cb66":"final_blend = finalize_model(blend)","a55bc678":"# Fit-Based Weights Geo-Rounded\n# from https:\/\/www.kaggle.com\/fergusfindley\/ensembling-and-rounding-techniques-comparison\ndef geometric_round(arr):\n    result_array = arr\n    result_array = np.where(result_array < np.sqrt(np.floor(arr)*np.ceil(arr)), np.floor(arr), result_array)\n    result_array = np.where(result_array >= np.sqrt(np.floor(arr)*np.ceil(arr)), np.ceil(arr), result_array)\n\n    return result_array","dd21ccda":"y_pred = np.expm1(\n    predict_model(final_blend, data=test)['Label']\n)\n\ny_pred = geometric_round(np.array(y_pred).transpose()).astype(int)\ny_pred","83c67b38":"submission = pd.read_csv('..\/input\/tabular-playground-series-jan-2022\/sample_submission.csv')\nsubmission[target_col] = y_pred\n\nsubmission.to_csv('submission.csv', index=False)","0a33890b":"This notebook is the result of the work of https:\/\/www.kaggle.com\/maxencefzr\/tps-jan22-catboost-using-pycaret\/notebook","97d0e748":"## Pre-Processing"}}