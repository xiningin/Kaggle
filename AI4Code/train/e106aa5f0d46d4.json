{"cell_type":{"dae0a2e9":"code","5935d5ce":"code","d7bc5046":"code","67d28810":"code","c3a1e4fb":"code","4591fb68":"markdown","903ca8a0":"markdown","1767da51":"markdown","6155873c":"markdown"},"source":{"dae0a2e9":"# Adjusted predictions based on classifier certainty\nimport gc\nimport numpy as np\nimport pandas as pd\nimport xgboost as xgb\nimport janestreet","5935d5ce":"# Load data\ntrain = pd.read_csv('\/kaggle\/input\/jane-street-market-prediction\/train.csv')\nprint(f'Done loading data. Train shape is {train.shape}')","d7bc5046":"# For training only look at data that has weight\ntrain = train[train.weight != 0]\n\n# Settings\nNAN_VALUE = -999\nFEATURES = [c for c in train.columns if 'feature' in c]\nTARGET = 'resp'\nMAX_WEIGHT = train.weight.max()\nSAMPLE_WEIGHTS = (train['resp'] * train['weight']).abs() + 1\n\n# Split into X and y\nX = train.loc[:, FEATURES].fillna(NAN_VALUE)\ny = (train.loc[:, TARGET] > 0).astype(int)\n\n# Clear memory\ndel train\ngc.collect()","67d28810":"# Train model\n# Parameters from: https:\/\/www.kaggle.com\/hamditarek\/market-prediction-xgboost-with-gpu-fit-in-1min\nmodel = xgb.XGBClassifier(\n    n_estimators=500,\n    max_depth=11,\n    learning_rate=0.05,\n    subsample=0.9,\n    colsample_bytree=0.7,\n    missing=NAN_VALUE,\n    random_state=2020,\n    tree_method='gpu_hist'\n)\nmodel.fit(X, y, sample_weight=SAMPLE_WEIGHTS)\nprint('Finished training model')\n\n# Clear memory\ndel X, y\ngc.collect()","c3a1e4fb":"# Create submission\nenv = janestreet.make_env()\niter_test = env.iter_test()\nfor (test_df, sample_prediction_df) in iter_test:    \n    test_weight = test_df.iloc[0].weight\n    if test_weight > 0:\n        sample_prediction_df.action = model.predict(test_df.loc[:, FEATURES].fillna(NAN_VALUE))[0]\n    else:\n        sample_prediction_df.action = 0\n    env.predict(sample_prediction_df)","4591fb68":"# Modeling","903ca8a0":"# Split Data","1767da51":"# Import Data","6155873c":"# Submission"}}