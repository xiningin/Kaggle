{"cell_type":{"7bd89102":"code","b5c8f618":"code","bcf65edf":"code","ede6fc58":"code","9d8a63e2":"code","34a725fd":"code","9962a308":"code","aa882ecb":"code","be35564a":"code","bb720ec2":"code","c92e8573":"code","71683871":"code","2cbfb343":"code","ae017b1f":"code","5e5f89ab":"code","660890d1":"code","bc5e83cb":"code","cd39dd6c":"code","cdd8f2b8":"code","ed41d369":"code","560f95a1":"markdown","4b3f9bac":"markdown","bbcbb0bd":"markdown","3c980d2c":"markdown","d680dc02":"markdown","d1baef75":"markdown","1224552b":"markdown","0d388254":"markdown","7bfb58c1":"markdown","286feaa8":"markdown","2b7bd1a6":"markdown","9e136bad":"markdown","7bf647d5":"markdown"},"source":{"7bd89102":"!pip install pyradiomics","b5c8f618":"# special functions for using pyradiomics\nfrom SimpleITK import GetImageFromArray\nimport radiomics\nfrom radiomics.featureextractor import RadiomicsFeatureExtractor # This module is used for interaction with pyradiomic\nimport logging\nlogging.getLogger('radiomics').setLevel(logging.CRITICAL + 1)  # this tool makes a whole TON of log noise","bcf65edf":"# Instantiate the extractor\ntexture_extractor = RadiomicsFeatureExtractor(verbose=False)\ntexture_extractor.disableAllFeatures()\n_text_feat = {ckey: [] for ckey in texture_extractor.featureClassNames}\ntexture_extractor.enableFeaturesByName(**_text_feat)\n\nprint('Extraction parameters:\\n\\t', texture_extractor.settings)\nprint('Enabled filters:\\n\\t', texture_extractor.enabledImagetypes) \nprint('Enabled features:\\n\\t', texture_extractor.enabledFeatures) ","ede6fc58":"import numpy as np # for manipulating 3d images\nimport pandas as pd # for reading and writing tables\nimport h5py # for reading the image files\nimport skimage # for image processing and visualizations\nimport sklearn # for machine learning and statistical models\nimport os # help us load files and deal with paths","9d8a63e2":"%matplotlib inline\nimport matplotlib.pyplot as plt\nfrom mpl_toolkits.mplot3d import Axes3D\nimport seaborn as sns\nplt.rcParams[\"figure.figsize\"] = (8, 8)\nplt.rcParams[\"figure.dpi\"] = 125\nplt.rcParams[\"font.size\"] = 14\nplt.rcParams['font.family'] = ['sans-serif']\nplt.rcParams['font.sans-serif'] = ['DejaVu Sans']\nplt.style.use('ggplot')\nsns.set_style(\"whitegrid\", {'axes.grid': False})","34a725fd":"train_df = pd.read_csv('..\/input\/train.csv')\ntrain_df.head(5) # show the first 5 lines","9962a308":"def read_scan(in_filename, folder='train'):\n    full_scan_path = os.path.join('..', 'input',folder, in_filename)\n    # load the image using hdf5\n    with h5py.File(full_scan_path, 'r') as h:\n        # [::2, ::4, ::4, 0] downsampling makes it go much faster\n        return h['image'][:][:, :, :, 0] # we read the data from the file","aa882ecb":"sample_scan = train_df.iloc[0] # just take the first row\nprint(sample_scan)\n# turn the h5_path into the full path\nimage_data = read_scan(sample_scan['h5_path'])\nprint('Image Shape:', image_data.shape)","be35564a":"# we take a mask by just keeping the part of the image greater than 0\nplt.imshow(np.sum((image_data>0).astype(float), 0))","bb720ec2":"%%time\nresults = texture_extractor.execute(GetImageFromArray(image_data),\n                            GetImageFromArray((image_data>0).astype(np.uint8)))","c92e8573":"pd.DataFrame([results]).T","71683871":"def calc_radiomics(in_image_data):\n    return texture_extractor.execute(GetImageFromArray(in_image_data),\n                            GetImageFromArray((in_image_data>0).astype(np.uint8)))","2cbfb343":"%%time\ntrain_df['radiomics'] = train_df['h5_path'].map(lambda c_filename: calc_radiomics(read_scan(c_filename)))","ae017b1f":"new_train_df = pd.DataFrame([dict(**c_row.pop('radiomics'), **c_row) for _, c_row in train_df.iterrows()])\nprint(new_train_df.shape, 'data prepared')\nnew_train_df.sample(3)","5e5f89ab":"# leave out anything that doesn't start with original (just junk from the input)\n# also remove shape since it is not very informative\nvalue_feature_names = [c_col for c_col in full_df.columns if (c_col.startswith('original') and '_shape_' not in c_col)]\nprint(np.random.choice(value_feature_names, 3), 'of', len(value_feature_names))","660890d1":"from sklearn.ensemble import RandomForestRegressor\nage_model = RandomForestRegressor()\nage_model.fit(np.stack(new_train_df[value_feature_names].values, 0), \n              new_train_df['age_years'].values)\nage_model","bc5e83cb":"plt.plot(\n    new_train_df['age_years'].values,\n    age_model.predict(np.stack(new_train_df[value_feature_names].values, 0)),\n    '.'\n)\nplt.xlabel('Actual Age (Years)')\nplt.ylabel('Predicted Age (Years)')","cd39dd6c":"test_df = pd.read_csv('..\/input\/test_sample_submission.csv')[['scan_id']]\ntest_df['h5_path'] = test_df['scan_id'].map(lambda s_id: 'mri_{:08d}.h5'.format(s_id))\ntest_df['radiomics'] = test_df['h5_path'].map(\n    lambda c_filename: calc_radiomics(read_scan(c_filename, folder='test'))\n)\nnew_test_df = pd.DataFrame([dict(**c_row.pop('radiomics'), **c_row) for _, c_row in test_df.iterrows()])\nnew_test_df.sample(3)","cdd8f2b8":"new_test_df['age_years'] = age_model.predict(np.stack(new_test_df[value_feature_names].values, 0))\nplt.hist(new_test_df['age_years'])","ed41d369":"# save the output\nnew_test_df[['scan_id', 'age_years']].to_csv('radiomics_prediction.csv', index=False)","560f95a1":"# Load the Training Data\nWe start with the training data since we have labels for them and can look in more detail","4b3f9bac":"# Read Image","bbcbb0bd":"# Apply to Test Data\nWe can now load the test data and make a prediction","3c980d2c":"# Load a Scan\n- the data on kaggle are located in a parent folder called input. \n- Since the files have been organized into train and test we use the train folder","d680dc02":"### Plot Setup Code\nHere we setup the defaults to make the plots look a bit nicer for the notebook","d1baef75":"# Overview\nIn this notebook we load the data and view different images to get a better idea about the challenge we are facing. This is always a very helpful first step. It is also important that you can see and try to make some of your own predictions about the data. If you cannot see differences between the groups it is going to be difficult for a biomarker to capture that (but not necessarily impossible)","1224552b":"Install the PyRadiomics package read more about it here (https:\/\/pyradiomics.readthedocs.io\/en\/latest\/)","0d388254":"### Run over all scans\nWe use the `.map` function from pandas to calculate the brightness for all the scans","7bfb58c1":"We reuse the trained model to generate predictions of the age based on the brightness","286feaa8":"### Setup the PyRadiomics Code","2b7bd1a6":"# Focusing on Interesting Radiomics","9e136bad":"We can use more complicated models like random forest to better incorporate all features","7bf647d5":"# Calculate Radiomic Features\nCalculate the radiomic features for the test scan"}}