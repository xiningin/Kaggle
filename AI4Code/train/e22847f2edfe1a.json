{"cell_type":{"a3b30a01":"code","a19ae98b":"code","94f3bc7c":"code","65db1a63":"code","56d0ed3c":"code","e92d664d":"code","4425be71":"code","03c59d12":"code","59243508":"code","5d4302ce":"code","ba2484da":"code","0fbd1c27":"code","cef9499c":"code","d0fd6978":"code","70d682c5":"code","11f904ac":"code","e8a41896":"code","a44a170d":"code","129485af":"code","6bd5ac15":"code","bac7ade8":"code","cae6871f":"code","9839ce31":"code","6c9e1961":"code","26c04c0b":"code","0d1ae0df":"code","9396733b":"code","fa01029a":"markdown"},"source":{"a3b30a01":"import numpy as np\nimport pandas as pd\nfrom fastai import *\nfrom fastai.vision import *\nfrom torchvision.models import *\nimport os","a19ae98b":"df = pd.read_csv('..\/input\/train_labels.csv')\ndf.head()","94f3bc7c":"df_unique = pd.unique(df['label'])\ndf_unique","65db1a63":"path = Path('..\/input')\npath.ls()","56d0ed3c":"SZ = 96\nBS = 64\nNUM_WORKERS = 4","e92d664d":"data = (\n    ImageItemList\n        .from_csv(path, 'train_labels.csv', folder='train', suffix='.tif')\n        .random_split_by_pct()\n        .label_from_df()\n        .add_test(ImageItemList.from_folder('..\/input\/test'))\n        .transform(get_transforms(do_flip=True, flip_vert=True, max_rotate=.0, max_zoom=.1,max_lighting=0.05, max_warp=0.), size=SZ, resize_method=ResizeMethod.SQUISH)\n        .databunch(bs=BS, num_workers=NUM_WORKERS, path = '.')\n        .normalize(imagenet_stats)\n)","4425be71":"data.show_batch(3)","03c59d12":"from sklearn.metrics import roc_auc_score\ndef auc_score(y_pred,y_true,tens=True):\n    score=roc_auc_score(y_true,torch.sigmoid(y_pred)[:,1])\n    if tens:\n        score=tensor(score)\n    else:\n        score=score\n    return score","59243508":"learn = create_cnn(data, densenet161, metrics=[auc_score], ps=0.5)","5d4302ce":"# learn.lr_find()\n# learn.recorder.plot()","ba2484da":"learn.fit_one_cycle(1, 1e-3)","0fbd1c27":"learn.unfreeze()\n# learn.lr_find()\n# learn.recorder.plot()","cef9499c":"learn.fit_one_cycle(4, slice(1e-6, 1e-4))","d0fd6978":"SZ = 96*2\nBS = 64\/\/2\nNUM_WORKERS = 0","70d682c5":"data = (\n    ImageItemList\n        .from_csv(path, 'train_labels.csv', folder='train', suffix='.tif')\n        .random_split_by_pct()\n        .label_from_df()\n        .add_test(ImageItemList.from_folder('..\/input\/test'))\n        .transform(get_transforms(do_flip=True, flip_vert=True, max_rotate=.0, max_zoom=.1,max_lighting=0.05, max_warp=0.), size=SZ, resize_method=ResizeMethod.SQUISH)\n        .databunch(bs=BS, num_workers=NUM_WORKERS, path = '.')\n        .normalize(imagenet_stats)\n)","11f904ac":"learn.data = data","e8a41896":"# learn.lr_find()\n# learn.recorder.plot()","a44a170d":"learn.freeze()","129485af":"learn.fit_one_cycle(1, 1e-3\/2)","6bd5ac15":"learn.unfreeze()","bac7ade8":"learn.fit_one_cycle(1, slice(1e-6\/2, 1e-4\/2))","cae6871f":"preds = learn.get_preds(ds_type=DatasetType.Test)","9839ce31":"df_sub = pd.read_csv('..\/input\/sample_submission.csv').set_index('id')\ndf_sub.head()","6c9e1961":"clean_fname = np.vectorize(lambda fname: str(fname).split('\/')[-1].split('.')[0])\nfname_cleaned = clean_fname(data.test_ds.items)\nfname_cleaned = fname_cleaned.astype(str)","26c04c0b":"df_sub.loc[fname_cleaned,'label'] = preds[0][:,1].tolist()","0d1ae0df":"df_sub.head()","9396733b":"df_sub.to_csv('sub.csv')","fa01029a":"**Pred**"}}