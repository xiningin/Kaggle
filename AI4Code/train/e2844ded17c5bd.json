{"cell_type":{"cf3d7e03":"code","be3e3d43":"code","8e11ac33":"code","9105b821":"code","e3be4686":"code","c809488f":"code","805f29fd":"code","a6455591":"code","18f9c191":"code","fc012a7e":"code","94b7ba42":"code","ea4b543b":"code","9aa32977":"code","97574188":"code","4acc1ecb":"code","0a9293f9":"code","9f00b4af":"code","29c93783":"code","d695f778":"code","bd9ee86d":"code","560cbc4b":"markdown","2dd4a00c":"markdown","0c576894":"markdown","8295ced6":"markdown","e032da8d":"markdown","2db08c07":"markdown","e627162d":"markdown","3c85a83f":"markdown","543afa76":"markdown","459f87e7":"markdown","3606e5e4":"markdown","7bdb8332":"markdown","8e1b0b19":"markdown","22dff930":"markdown","84a1d918":"markdown","ef8923fb":"markdown","9d155039":"markdown","929fc890":"markdown","f0f4b9c8":"markdown","51786d45":"markdown","cc835de0":"markdown","da02da31":"markdown"},"source":{"cf3d7e03":"#basic lib\nimport pandas as pd\nimport numpy as np \nimport math,os,random\n\n#EDA\nimport matplotlib.pyplot as plt \nimport seaborn as sns\n# import pandas_profiling as pf\n\n#oversampling:\nfrom imblearn.over_sampling import SMOTE\nfrom imblearn.combine import SMOTEENN,SMOTETomek\n\n#preprocessing:\nfrom sklearn.preprocessing import MinMaxScaler,StandardScaler\nfrom sklearn.decomposition import PCA\n\n#model_selection\n# from sklearn.model_selection import cross_val_score\nfrom sklearn.model_selection import KFold\nfrom sklearn.model_selection import train_test_split\nfrom sklearn.pipeline import Pipeline\n\n\n#ml algo\nfrom sklearn.ensemble import RandomForestClassifier\nfrom sklearn.linear_model import LassoLars\nfrom xgboost import XGBClassifier \nfrom catboost import CatBoostClassifier\n# from sklearn.cluster import KMeans\n\n#scoring function:\nfrom sklearn.metrics import make_scorer,f1_score,confusion_matrix,ConfusionMatrixDisplay","be3e3d43":"def set_seed(seed):\n    np.random.seed(seed)\n    random.seed(seed)\n    \nseed=5\nset_seed(seed)","8e11ac33":"df=pd.read_csv('..\/input\/company-bankruptcy-prediction\/data.csv')\ndf.head()","9105b821":"#no empty values in data .\n\n# cols_to_be_imputed=[col for col in df.columns if df[col].isnull().sum()>0]\n# cols_to_be_imputed\n\n#categorical cols:\n# categ_cols=[col for col in df.columns if df[col].dtype in ['object'] ]\n# categ_cols\n\n#profile report:\n# pf.ProfileReport(df,minimal=True)","e3be4686":"def plot_class_balance(df,target):\n    plt.figure(figsize=(12,6))\n    sns.countplot(df[target])\n    plt.show()\n    \nplot_class_balance(df,'Bankrupt?')","c809488f":"def plot_correlation(df):\n    plt.figure(figsize=(30,30))\n    corr=df.corr()\n    mask=np.triu(np.ones_like(corr,dtype=bool))\n    sns.heatmap(corr,mask=mask,cmap=sns.diverging_palette(230, 20, as_cmap=True),\n               linewidth=0.5)\n    plt.show()\n    \nplot_correlation(df)","805f29fd":"def plot_boxplots(df):\n    n=len(df.columns)\n    plt.subplots(math.ceil(n\/4),4,figsize=(20,8*math.ceil(n\/5)))\n    plt.grid('off')\n    \n    for i,col in enumerate(df.drop('Bankrupt?',axis=1).columns):\n        plt.subplot(math.ceil(n\/4),4,i+1)\n        \n        sns.boxplot(x='Bankrupt?',y=col,data=df)\n        plt.title(f'{col}')\n        \n    plt.tight_layout()\n    plt.show()\nplot_boxplots(df)        ","a6455591":"\n\ndef specify_outliers(df):    \n    df_new=df.copy()\n    df_new['Is_Outlier']=np.zeros(len(df_new))\n\n    for col in df.drop('Bankrupt?',axis=1).columns:\n                \n        \n        Q1=np.percentile(df[col],25)\n        Q3=np.percentile(df[col],75)\n        \n        col_IQR = Q3-Q1\n        \n        lower_limit= Q1 - (1.5 * col_IQR)\n        upper_limit= Q3 + (1.5 * col_IQR)\n        \n        outliers_idx=[i for i,x in enumerate(df[col]) if x<lower_limit or x> upper_limit]\n        \n        for i in outliers_idx:\n            df_new['Is_Outlier'].iloc[i] +=1\n        \n        #replacing outliers with median\n#         median= np.median(df[col])\n#         df_new[col].replace(to_replace=outliers,value=median,inplace=True)\n        \n    return df_new\n\nnew_df=specify_outliers(df)        ","18f9c191":"y=new_df.pop('Bankrupt?')\nX=new_df.copy()\n\n\n# adding new features using PCA\npca_pipe= Pipeline([('Scale',StandardScaler()),('PCA',PCA(n_components=10))])\n\nX_pca=pca_pipe.fit_transform(X)\nX_pca=pd.DataFrame(X_pca,columns=[f'P{i}' for i in range(1,X_pca.shape[1]+1)])\nX=X.join(X_pca)","fc012a7e":"X_train,X_val,y_train,y_val=train_test_split(X,y,shuffle=True,random_state=seed)","94b7ba42":"# Learning pipelines:\n#logistic reg:\n# log_pipe=Pipeline([(('Normalize'),MinMaxScaler()),('LassoLars',LassoLars(verbose=0))])\n\n#RandomForest\nRF_pipe=Pipeline([('Random_forest',RandomForestClassifier(n_estimators=300,random_state=seed,verbose=0))])\n\n#XGBClassifier\nXGB_pipe=Pipeline([('Normalize',MinMaxScaler()),('XGB',XGBClassifier(n_estimators=300,random_state=seed,use_label_encoder =False,\n                                                                     objective ='binary:logistic',verbosity=0))])\n\n#catboost classifier\ncatb_pipe=Pipeline([('Normalize',MinMaxScaler()),('Catboost',CatBoostClassifier(n_estimators=300,\n                                                                                random_state=seed,verbose=0))])\n\npipes=[RF_pipe,XGB_pipe,catb_pipe]","ea4b543b":"for pipe in pipes:\n    pipe.fit(X_train,y_train)\n    pred=pipe.predict(X_val)\n    f1=f1_score(pred,y_val)\n    print(f'f1 Score with {pipe} is {f1}')","9aa32977":"#oversampling minority\nsmote=SMOTE()\n\n#smote +ENN \nsmote_enn=SMOTEENN()\n\n#Smote + Tomek:\nsmote_tomek=SMOTETomek()\n\n\ndef resample(function,X,y):\n    x_r,y_r= function.fit_resample(X,y)\n    return x_r,y_r","97574188":"x_new,y_new=resample(smote,X_train,y_train)\n\nfor pipe in pipes:\n    pipe.fit(x_new,y_new)\n    pred=pipe.predict(X_val)\n    f1=f1_score(pred,y_val)\n    print(f'f1 Score with {pipe} is {f1}')\n\ndel x_new,y_new\n","4acc1ecb":"x_new,y_new=resample(smote_enn,X_train,y_train)\n\nfor pipe in pipes:\n    pipe.fit(x_new,y_new)\n    pred=pipe.predict(X_val)\n    f1=f1_score(pred,y_val)\n    print(f'f1 Score with {pipe} is {f1}')\n\ndel x_new,y_new\n","0a9293f9":"x_new,y_new=resample(smote_tomek,X_train,y_train)\n\nfor pipe in pipes:\n    pipe.fit(x_new,y_new)\n    pred=pipe.predict(X_val)\n    f1=f1_score(pred,y_val)\n    print(f'f1 Score with {pipe} is {f1}')\n\ndel x_new,y_new\n","9f00b4af":"def predict(X_t,y_t,X_test):\n    #resampling using smote+tomek\n    x_st,y_st =resample(smote_tomek,X_t,y_t)\n    \n    #Kfold cross validation:\n    kf=KFold(n_splits=5,random_state=seed,shuffle=True)\n    \n    #predicting using smote and XGB Classifier:\n    \n    preds_xgb=[]\n    preds_catb=[]\n    preds_rf=[]\n\n    for train_idx,test_idx in kf.split(x_st,y_st):\n        X_tr,X_ts = x_st.iloc[train_idx],x_st.iloc[test_idx]\n        y_tr,y_ts = y_st.iloc[train_idx],y_st.iloc[test_idx]\n        \n        #fitting data on models:\n        #Catboost\n        catb_pipe.fit(X_tr,y_tr)\n        \n        #XGB Classifier\n        XGB_pipe.fit(X_tr,y_tr)\n        #RF Classifier\n        RF_pipe.fit(X_tr,y_tr)\n        \n        \n        #predicting on test set:\n        preds_catb.append(XGB_pipe.predict(X_test))\n        #predicting on test set:\n        preds_xgb.append(XGB_pipe.predict(X_test))\n       \n        #predicting on test set:\n        preds_rf.append(RF_pipe.predict(X_test))\n        \n        \n        \n    \n    #Averaging Both prediction:\n    mean_preds= (np.array(preds_xgb)\/3 + np.array(preds_catb)\/3 + np.array(preds_rf)\/3)\n    \n    #averaging predictions across all folds:\n    preds=np.mean(a=mean_preds,axis=0)\n    \n    assert len(preds)== len(X_test)\n    \n    del mean_preds,preds_xgb,preds_catb\n    \n    return preds\n\n\n## Predicting Boolean value based on threshold:\ndef assign_bool_values(preds,thresh=0.5):\n    final_preds=[]\n    \n    for i in preds:\n        if i> thresh:\n            final_preds.append(1)\n        else:\n            final_preds.append(0)\n            \n    assert(len(final_preds)==len(preds))\n    \n    \n    return final_preds\n    ","29c93783":"pred=predict(X_t=X_train,y_t=y_train,X_test=X_val)\npred.mean()","d695f778":"predictions=assign_bool_values(preds=pred,thresh=0.2)\nf1_score(predictions,y_val)","bd9ee86d":"\ndef display_cm(pred,y_test):\n    \n    cm=confusion_matrix(y_test,pred)\n    \n    disp=ConfusionMatrixDisplay(confusion_matrix=cm,display_labels=['0','1'])\n    \n    disp.plot()\n    plt.show()\n\ndisplay_cm(predictions,y_val)","560cbc4b":"**Confusion Matrix**","2dd4a00c":"This illustrates that there is a heavy imbalance between companies going bankrupt and not going bankrupt.","0c576894":"**Plotting Boxplots**","8295ced6":"**Using the function 'assign_bool_values', we can play with threshold values for predictions.**","e032da8d":"# Loading Data and EDA","2db08c07":"# Predictions","e627162d":"# Oversampling and Combine methods for Class imbalance.","3c85a83f":"**Checking for null and categorical values **","543afa76":"**Specify Outliers**\n* Adding a extra feature that specifies a outlier and assigns a value +1 to the feature 'Is_Outlier' if its an outlier.\n\n**Formulas**:\n\n* **IQR(Inter Quartile Range) = Q3-Q1**\n* **lower limit = Q1 - (1.5 * IQR)**\n* **upper limit= Q3 + (1.5 * IQR)**","459f87e7":"**Correlation HeatMap**","3606e5e4":"# Importing Libraries","7bdb8332":"**Class Balance**","8e1b0b19":"**Adding new features and Train Test Split**","22dff930":"**Constructing models**","84a1d918":"# Scoring a model without upsampling.","ef8923fb":"**Setting random state for reproducibility**","9d155039":"**SMOTE + Tomek**","929fc890":"**SMOTE + ENN**","f0f4b9c8":"**Used some code from this amazing notebook** [ https:\/\/www.kaggle.com\/marto24\/bankruptcy-detection ]","51786d45":"**Oversampling using smote**","cc835de0":"**I have kept the threshold low , so that maximum of bankruptcy cases are identified. This results in a relatively low f1_score , as the ensemble incorrectly predicts some false positives. I would probably get better f1_score if I try to find optimum threshold and use SMOTE for resampling.**","da02da31":"**Building a scoring function**\n\nBecause of there is class imbalance in the data , accuracy will perform poorly as a metric. We will use f1_score as metric, which is the harmonic mean of precision and recall.  "}}