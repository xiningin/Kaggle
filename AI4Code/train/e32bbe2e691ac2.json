{"cell_type":{"dc0e6da0":"code","d133ba80":"code","17c23731":"code","61b98fc2":"code","e113649b":"code","1fc2f855":"code","686e7991":"code","03e9e709":"markdown","e49a8405":"markdown","fecdc8ee":"markdown","e6c713bb":"markdown"},"source":{"dc0e6da0":"import csv\nimport tensorflow as tf\n\nfrom tqdm import tqdm","d133ba80":"tf.__version__  # make sure you are using TensorFlow 2.x","17c23731":"model = tf.keras.models.load_model(\"..\/input\/arcface-final-lresnet50ir\/arcface_final.h5\")","61b98fc2":"print(f\"Input shape --> {model.input_shape}\\nOutput Shape --> {model.output_shape}\")\n\n\"\"\"\nAs you can see, model take image(s) in 112x112 and with 3 channels(RGB, not BGR)\n\"\"\"","e113649b":"# now i will define a data loader to read pins face recognition dataset, i will be receiving this code from Liyana\n\nclass DataEngineTypical:\n    def make_label_map(self):\n        self.label_map = {}\n\n        for i, class_name in enumerate(tf.io.gfile.listdir(self.main_path)):\n            self.label_map[class_name] = i\n\n        self.reverse_label_map = {v: k for k, v in self.label_map.items()}\n\n    def path_yielder(self):\n        for class_name in tf.io.gfile.listdir(self.main_path):\n            if not \"tfrecords\" in class_name:\n                for path_only in tf.io.gfile.listdir(self.main_path + class_name):\n                    yield (self.main_path + class_name + \"\/\" + path_only, self.label_map[class_name])\n\n    def image_loader(self, image):\n        image = tf.io.read_file(image)\n        image = tf.io.decode_jpeg(image, channels=3)\n        image = tf.image.resize(image, (112, 112), method=\"nearest\")\n        image = tf.image.random_flip_left_right(image)\n\n        return (tf.cast(image, tf.float32) - 127.5) \/ 128.\n\n    def mapper(self, path, label):\n        return (self.image_loader(path), label)\n\n    def __init__(self, main_path: str, batch_size: int = 16, buffer_size: int = 10000, epochs: int = 1,\n                 reshuffle_each_iteration: bool = False, test_batch=64,\n                 map_to: bool = True):\n        self.main_path = main_path.rstrip(\"\/\") + \"\/\"\n        self.make_label_map()\n\n        self.dataset_test = None\n        if test_batch > 0:\n            reshuffle_each_iteration = False\n            print(f\"[*] reshuffle_each_iteration set to False to create a appropriate test set, this may cancelled if tf.data will fixed.\")\n\n        self.dataset = tf.data.Dataset.from_generator(self.path_yielder, (tf.string, tf.int64))\n        if buffer_size > 0:\n            self.dataset = self.dataset.shuffle(buffer_size, reshuffle_each_iteration=reshuffle_each_iteration, seed=42)\n\n        if map_to:\n            self.dataset = self.dataset.map(self.mapper, num_parallel_calls=tf.data.experimental.AUTOTUNE)\n        self.dataset = self.dataset.batch(batch_size, drop_remainder=True)\n\n        if test_batch > 0:\n            self.dataset_test = self.dataset.take(int(test_batch))\n            self.dataset = self.dataset.skip(int(test_batch))\n\n        self.dataset = self.dataset.repeat(epochs)\n","1fc2f855":"# now i will define an Engine Class to run jobs for getting outputs from images\n\n# this class will take data and get 512-D features through ArcFace model\nclass Engine:\n    @staticmethod\n    def flip_batch(batch):\n        return batch[:, :, ::-1, :]\n\n    def __init__(self, data_engine: DataEngineTypical):\n        self.data_engine = data_engine\n        self.model = tf.keras.models.load_model(\"..\/input\/arcface-final-lresnet50ir\/arcface_final.h5\")\n\n        tf.io.gfile.mkdir(\"projector_tensorboard\")\n\n    def __call__(self, flip: bool = False):\n        metadata_file = open('projector_tensorboard\/metadata.tsv', 'w')\n        metadata_file.write('Class\\tName\\n')\n        with open(\"projector_tensorboard\/feature_vecs.tsv\", 'w') as fw:\n            csv_writer = csv.writer(fw, delimiter='\\t')\n\n            for x, y in tqdm(self.data_engine.dataset):\n                outputs = self.model(x, training=False)\n                if flip:\n                    outputs += self.model(self.flip_batch(x), training=False)\n\n                csv_writer.writerows(outputs.numpy())\n                for label in y.numpy():\n                    name = self.data_engine.reverse_label_map[label]\n                    metadata_file.write(f'{label}\\t{name}\\n')\n\n        metadata_file.close()","686e7991":"# Now we have both data loader and an engine to process that data through arcface model and save those features to a tsv file.\n\nTDOM = DataEngineTypical(\n    \"..\/input\/pins-face-recognition\/105_classes_pins_dataset\/\",\n    batch_size=64,\n    epochs=1,\n    buffer_size=0,\n    reshuffle_each_iteration=False,\n    test_batch=0\n)  # TDOM for \"Tensorflow Dataset Object Manager\"\n\ne = Engine(\n    data_engine=TDOM\n)\n\ne()","03e9e709":"And last, i would like to show you more examples of face recognition that i like to share. Those videos also created by [Liyana](https:\/\/github.com\/aangfanboy\/liyana\/)\n\n\n### My favourite professor Gilbert Strang and My favourite podcaster Lex Fridman \n![gif1](https:\/\/github.com\/aangfanboy\/liyana\/blob\/master\/images-and-figures\/gil_lex_gif.gif?raw=true)\n\n\n### Elon Musk and Joe Rogan\n![gif2](https:\/\/github.com\/aangfanboy\/liyana\/blob\/master\/images-and-figures\/joe_elon_gif.gif?raw=true)\n\nSince my show-off is done :) we can start.","e49a8405":"I would like to drop a screenshot of what we are trying to achive in this notebook. \n\nIn first screenshot, features of Anne Hathaway which extracted by *ArcFace model* and you can see that the **closest features to choosen Anne Hathaway face are also the features of Anne Hathaway.** That is the main idea of deep learning face recognition, **model extracts features and it designed to extract close features to same persons faces.**\n\n![Anne Hathaway](https:\/\/raw.githubusercontent.com\/aangfanboy\/liyana\/master\/images-and-figures\/pins_tb_example.jpg)","fecdc8ee":"* In outputs, there should be folder named *projector_tensorboard*, that folder has two files named **feature_vecs.tsv** and **metadata.tsv**, download them.\n* Go [this](https:\/\/projector.tensorflow.org\/) website, press **Load** in left, upload **feature_vecs.tsv** in **step 1** and upload **metadata.tsv** in **step 2**\n* Check *color by* to *class* and check the checkbox that says *Use categorical coloring*\n\nIf you did everything right, you should see a page like this:\n\n![page](https:\/\/raw.githubusercontent.com\/aangfanboy\/liyana\/master\/images-and-figures\/pins_tb_mf_example.jpg)\n\n\nThere are 17472 points that belongs to total 105 different human! And if you check carefully, you will discover the distance between males and females :) Because it is the most basic diversity of human face. Click one of the points and you will see the nearest point to that in the right side of page. Have fun :)","e6c713bb":"In this notebook, you will see a pre-triend arcface model predicting results for every face in [pins face recognition dataset](https:\/\/www.kaggle.com\/hereisburak\/pins-face-recognition\/) dataset. Then, we will compare those results through TensorBoard Projector and understands the idea behind face recognition.\n\nIf you want to train your own ArcFace model, please visit the open source [Liyana Face Analysis Project](https:\/\/github.com\/aangfanboy\/liyana\/)\n\nIf you are interested at face processing(recognition, age-sex-ethnicty detection vs.), i higly recommend you to check [Liyana](https:\/\/github.com\/aangfanboy\/liyana\/)\n\n![Liyana Image](https:\/\/raw.githubusercontent.com\/aangfanboy\/liyana\/master\/images-and-figures\/liyana_1-2-0.png)"}}