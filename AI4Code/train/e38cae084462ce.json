{"cell_type":{"37a5b629":"code","b3d4de72":"code","3d410592":"code","3662d790":"code","d18114c7":"code","d77424e8":"code","aad87b84":"code","77d509e6":"code","c7291fbf":"code","b4968dc5":"code","80aba068":"code","9589dcdd":"code","7dee8df3":"code","baf4968d":"code","99f9212c":"code","ff0b8186":"code","7c1325ff":"code","20d5818c":"code","02a9a6f1":"code","de0d57f1":"code","9773a13e":"code","80f8f487":"markdown","d4862a34":"markdown","08fa30cd":"markdown","4b8e486b":"markdown"},"source":{"37a5b629":"!pip install simpletransformers","b3d4de72":"import os\nimport sys\nimport random\nimport torch\nimport pandas as pd\nimport numpy as np\nfrom tqdm import tqdm","3d410592":"SEED = 42\nos.environ['PYTHONHASHSEED']=str(SEED)\ntorch.manual_seed(SEED)\nnp.random.seed(SEED)\nrandom.seed(SEED)\n\nPREFIX_POI = 'Lengkapi nama tempat'\nPREFIX_STREET = 'Lengkapi nama jalan'\n\ntqdm.pandas()","3662d790":"print('Python version:', sys.version)\nprint('Pandas version:', pd.__version__)\nprint('Numpy version:', np.__version__)\nprint('Torch version:', torch.__version__)","d18114c7":"df_poi_pairs = pd.read_csv(f'\/kaggle\/input\/scl-2021-2-processed-data\/poi_pairs.csv')\ndf_poi_pairs.insert(loc=0, column='prefix', value=PREFIX_POI)\ndf_poi_pairs","d77424e8":"df_street_pairs = pd.read_csv(f'\/kaggle\/input\/scl-2021-2-processed-data\/street_pairs.csv')\ndf_street_pairs.insert(loc=0, column='prefix', value=PREFIX_STREET)\ndf_street_pairs","aad87b84":"df_pairs = pd.concat([df_poi_pairs, df_street_pairs], axis=0)\ndf_pairs.columns = ['prefix', 'input_text', 'target_text']\ndf_pairs['input_text'] = df_pairs['input_text'].apply(str)\ndf_pairs['target_text'] = df_pairs['target_text'].apply(str)\ndf_pairs","77d509e6":"# from sklearn.model_selection import train_test_split\n# df_train, df_val = train_test_split(df_pairs, test_size=0.15)","c7291fbf":"!ls \/kaggle\/input\/scl-2021-2-simpletransformers-t5\/model_t5","b4968dc5":"from simpletransformers.t5 import T5Model, T5Args\n\nmodel_args = T5Args()\nmodel_args.num_train_epochs = 1\nmodel_args.eval_batch_size = 64\nmodel_args.train_batch_size = 64\nmodel_args.learning_rate = 1e-4\nmodel_args.manual_seed = SEED\nmodel_args.output_dir = f'.\/model_t5'\nmodel_args.best_model_dir = f'.\/model_t5\/best_model'\nmodel_args.evaluate_during_training = False\n# model_args.evaluate_during_training_verbose = True\n# model_args.evaluate_during_training_steps = 5000\nmodel_args.use_early_stopping = True\nmodel_args.overwrite_output_dir = True\nmodel_args.early_stopping_patience = 2\nmodel_args.use_multiprocessing = False # https:\/\/github.com\/ThilinaRajapakse\/simpletransformers\/issues\/354\n\n# model = T5Model(\n#     't5',\n#     'panggi\/t5-small-indonesian-summarization-cased',\n#     args=model_args,\n# )\nmodel = T5Model(\n    't5',\n    '\/kaggle\/input\/scl-2021-2-simpletransformers-t5\/model_t5\/checkpoint-10980-epoch-1',\n    args=model_args,\n)","80aba068":"# Train the model\n# model.train_model(df_train)\n# model.train_model(df_pairs)\n\n# Evaluate the model\n# result = model.eval_model(df_val)\n# result","9589dcdd":"df_test = pd.read_csv(f'\/kaggle\/input\/scl-2021-2-ktrain-bilstm-crf\/submission.csv')\n\nsr_label = df_test['POI\/street'].str.split('\/', expand=True)\ndf_test['POI'] = sr_label[0]\ndf_test['POI'] = df_test['POI'].progress_apply(lambda x: f'{PREFIX_POI}: {x}')\ndf_test['street'] = sr_label[1]\ndf_test['street'] = df_test['street'].progress_apply(lambda x: f'{PREFIX_STREET}: {x}')\ndf_test","7dee8df3":"# select non empty POI\npoi_idx = [i for i, poi in enumerate(df_test['POI'].tolist()) if poi != f'{PREFIX_POI}: ']\nstreet_idx = [i for i, poi in enumerate(df_test['street'].tolist()) if poi != f'{PREFIX_STREET}: ']","baf4968d":"poi_preds = model.predict([f'{PREFIX_POI}: {X}' for X in df_test['POI'].tolist() if X != f'{PREFIX_POI}: '])\npoi_preds[:10]","99f9212c":"street_preds = model.predict([f'{PREFIX_STREET}: {X}' for X in df_test['street'].tolist() if X != f'{PREFIX_STREET}: '])\nstreet_preds[:10]","ff0b8186":"# remapping prediction\nfull_poi_preds = ['' for _ in range(df_test.shape[0])]\nfor idx, pred in zip(poi_idx, poi_preds):\n    full_poi_preds[idx] = pred\nfull_poi_preds[:10]","7c1325ff":"# remapping prediction\nfull_street_preds = ['' for _ in range(df_test.shape[0])]\nfor idx, pred in zip(street_idx, street_preds):\n    full_street_preds[idx] = pred\nfull_street_preds[:10]","20d5818c":"df_submission = pd.DataFrame({\n    'id': df_test['id'].tolist(),\n    'POI': full_poi_preds,\n    'street': full_street_preds,\n})\ndf_submission","02a9a6f1":"# https:\/\/stackoverflow.com\/a\/16891418\/11911037\ndef remove_prefix(text, prefix):\n    if text.startswith(prefix):\n        return text[len(prefix):]\n    return text  # or whatever","de0d57f1":"df_submission['POI'] = df_submission['POI'].progress_apply(lambda x: remove_prefix(x, 'Lengkapi nama tempat :'))\ndf_submission['POI'] = df_submission['POI'].progress_apply(lambda x: remove_prefix(x, 'Lengkapi nama tempat:'))\ndf_submission['POI'] = df_submission['POI'].progress_apply(lambda x: remove_prefix(x, 'Lengkapi nama tempat'))\ndf_submission['POI'] = df_submission['POI'].progress_apply(lambda x: remove_prefix(x, ' '))\n\ndf_submission['street'] = df_submission['street'].progress_apply(lambda x: remove_prefix(x, 'Lengkapi nama jalan :'))\ndf_submission['street'] = df_submission['street'].progress_apply(lambda x: remove_prefix(x, 'Lengkapi nama jalan:'))\ndf_submission['street'] = df_submission['street'].progress_apply(lambda x: remove_prefix(x, 'Lengkapi nama jalan'))\ndf_submission['street'] = df_submission['street'].progress_apply(lambda x: remove_prefix(x, ' '))","9773a13e":"df_submission['POI\/street'] = df_submission.apply(lambda row: f\"{row['POI']}\/{row['street']}\", axis=1)\ndel df_submission['POI']\ndel df_submission['street']\ndf_submission.to_csv('submission.csv', index=False)\ndf_submission","80f8f487":"# 2. Dataset","d4862a34":"# 3. Model","08fa30cd":"# 4. Predict","4b8e486b":"# 1. Library"}}