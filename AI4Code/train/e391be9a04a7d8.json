{"cell_type":{"b1397ec5":"code","0b03b686":"code","761c8009":"code","a8696c4e":"code","603e6e08":"code","3e07b96b":"code","5794eb61":"code","54f459ed":"code","3e1274a2":"code","6051dabd":"code","9f09e374":"code","60edff8d":"code","dbc52616":"code","54a7c97a":"code","ee6fda98":"code","dd7724b2":"code","a38a94a8":"code","afabe080":"code","c944eb94":"code","1c2cafb8":"code","1adbbd00":"code","6b33e4d0":"code","99caefa2":"code","d46128f1":"code","06d12964":"code","4f4d05b8":"code","aac8cd81":"code","f17929b7":"code","caad2cb7":"code","9f97ceb0":"code","a29f7b8d":"code","5f54769e":"code","3ecf357a":"code","16f266f5":"code","97babfda":"code","56bce915":"code","a2a6b2f3":"code","790f267b":"code","f85d91ec":"code","20e87cc1":"code","e00081bf":"code","05756db5":"code","b43b8e0a":"code","eee9a67d":"code","dd3f3dd5":"code","9707d71b":"code","6fd9eeb9":"code","f5d55033":"code","ce4b223f":"code","803108e1":"code","4ba1805c":"code","4d9b1ce6":"code","6a2b1c19":"code","9ac5b751":"code","565b6813":"code","096fdba9":"code","7ef1730d":"code","c1290bf6":"code","56a864b7":"code","308194a8":"code","c14f7f02":"code","a0ae6982":"code","d124034e":"code","1f94eefb":"code","ec511ee7":"code","ae2490e9":"code","8c8187e5":"code","4b28a746":"code","743ef87e":"code","220dcbdf":"code","7ebee8e5":"code","6aeed6a1":"code","448392eb":"code","9221a2f5":"code","60bff907":"code","025eb4c4":"code","b7f4337f":"code","a33074a5":"code","b5c652de":"code","42479276":"code","eb196ee9":"code","2d54769c":"code","30415e70":"code","a8e2c8c1":"code","471e1407":"code","cd835d97":"code","e35cca6b":"code","37d3a94c":"code","3cccee79":"code","7d4da478":"code","76de88e1":"code","f871679e":"code","a9c76c85":"code","3f2d1a63":"code","319935d1":"code","3d2baf59":"code","076bbe65":"code","d0810db8":"code","704c4b3d":"code","8c3745e6":"code","840eeb46":"code","4cdbb038":"code","c231fbdc":"code","40b729bb":"code","6d4f14b3":"code","05811c29":"code","c83d3cbd":"code","c2f825c3":"code","e55e83b2":"code","f1029425":"code","5bab1d49":"code","6f52fab1":"code","875f53ce":"code","04a421c7":"code","0647f305":"code","ef4a794a":"code","b9c1a255":"code","fc3b2e67":"code","26ceccfc":"code","7657203a":"code","6c448142":"code","393b7c00":"code","10100085":"code","91f631a5":"code","b3090872":"code","875fa935":"code","c3127e93":"code","d414a830":"code","ea2a5918":"code","5ace213f":"code","811f025e":"code","7a737d27":"code","8a9965ba":"code","8ce35288":"code","89776c1e":"code","920c5fae":"markdown","e7432b7f":"markdown","769a85b3":"markdown","cd8b42a5":"markdown","facab687":"markdown","4f43d97f":"markdown","710e4b27":"markdown","d28ea568":"markdown","a98eb441":"markdown","f06a6f32":"markdown","d8b560f5":"markdown","2400f6c7":"markdown","43fec9fe":"markdown","289d0cfa":"markdown","17e60b97":"markdown","53f87460":"markdown","86246f72":"markdown","45d5e728":"markdown"},"source":{"b1397ec5":"# This Python 3 environment comes with many helpful analytics libraries installed\n# It is defined by the kaggle\/python docker image: https:\/\/github.com\/kaggle\/docker-python\n# For example, here's several helpful packages to load in \n\nimport numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv\nfrom xgboost import XGBRegressor\nimport seaborn as sns\nimport matplotlib.pyplot as plt\nfrom sklearn.preprocessing import LabelEncoder\nfrom sklearn.model_selection import RandomizedSearchCV,cross_val_score\nfrom sklearn.metrics import mean_squared_error\nfrom sklearn.metrics import make_scorer\nfrom sklearn.ensemble import RandomForestRegressor\nfrom itertools import product\nimport re\nimport nltk\nfrom nltk import word_tokenize\nfrom nltk.corpus import stopwords\n\n# Input data files are available in the \"..\/input\/\" directory.\n# For example, running this (by clicking run or pressing Shift+Enter) will list all files under the input directory\n\n# Any results you write to the current directory are saved as output.","0b03b686":"!pip install pymorphy2\n!pip install pymorphy2-dicts\n!pip install DAWG-Python","761c8009":"import pymorphy2","a8696c4e":"sample_submissions=pd.read_csv(\"..\/input\/competitive-data-science-predict-future-sales\/sample_submission.csv\")\nsales_train_df=pd.read_csv(\"..\/input\/competitive-data-science-predict-future-sales\/sales_train.csv\")\ntest_df=pd.read_csv(\"..\/input\/competitive-data-science-predict-future-sales\/test.csv\")\nitems_df=pd.read_csv(\"..\/input\/competitive-data-science-predict-future-sales\/items.csv\")\nshops_df=pd.read_csv(\"..\/input\/competitive-data-science-predict-future-sales\/shops.csv\")\nitem_categories_df=pd.read_csv(\"..\/input\/competitive-data-science-predict-future-sales\/item_categories.csv\")","603e6e08":"sample_submissions.head()","3e07b96b":"sales_train_df.head()","5794eb61":"sales_train_df.info()","54f459ed":"test_df.head()","3e1274a2":"test_df.info()","6051dabd":"sales_train_df.describe()","9f09e374":"test_df.describe()","60edff8d":"print(sales_train_df[\"shop_id\"].nunique())\nprint(test_df[\"shop_id\"].nunique())","dbc52616":"print(sales_train_df[\"item_id\"].nunique())\nprint(test_df[\"item_id\"].nunique())","54a7c97a":"plt.figure(figsize=(20,6))\nsales_train_df[\"item_cnt_day\"].hist(bins=200)","ee6fda98":"plt.figure(figsize=(20,6))\nsales_train_df[\"item_price\"].hist(bins=300)","dd7724b2":"plt.figure(figsize=(20,6))\nsales_train_df[\"shop_id\"].hist(bins=60)","a38a94a8":"plt.figure(figsize=(20,6))\ntest_df[\"shop_id\"].hist(bins=60)","afabe080":"plt.figure(figsize=(20,6))\nsales_train_df[\"item_id\"].hist(bins=1000)","c944eb94":"plt.figure(figsize=(20,6))\ntest_df[\"item_id\"].hist(bins=1000)","1c2cafb8":"nltk.download(\"stopwords\")","1adbbd00":"def text_preprocessing(text):\n  txt=\"\"\n  morph=pymorphy2.MorphAnalyzer()\n  stop_words_ru=stopwords.words(\"russian\")\n  stop_words_eng=stopwords.words(\"english\")\n  stroka=re.sub('[^A-Za-z\u0410-\u042f\u0430-\u044f]+',' ',text)\n  strs=stroka.split(\" \")\n  filtered_strs=[morph.parse(w.lower())[0].normal_form for w in strs if (w not in stop_words_ru and w not in stop_words_eng)]\n  txt=\" \".join(filtered_strs)\n  return txt","6b33e4d0":"'''%%time\nitems_df[\"item_name\"]=items_df[\"item_name\"].apply(lambda x:text_preprocessing(x))'''","99caefa2":"items_df[\"item_name\"]","d46128f1":"sales_train_df=sales_train_df.join(shops_df.set_index(\"shop_id\"),on=\"shop_id\",how=\"left\").join(\nitems_df.set_index(\"item_id\"),on=\"item_id\",how=\"left\").join(item_categories_df.set_index(\"item_category_id\")\n                                                              ,on=\"item_category_id\",how=\"left\")\nsales_train_df.head().T","06d12964":"test_df=test_df.join(shops_df.set_index(\"shop_id\"),on=\"shop_id\",how=\"left\").join(\nitems_df.set_index(\"item_id\"),on=\"item_id\",how=\"left\").join(item_categories_df.set_index(\"item_category_id\")\n                                                              ,on=\"item_category_id\",how=\"left\")\ntest_df.head().T","4f4d05b8":"plt.figure(figsize=(20,6))\nsales_train_df[\"item_category_id\"].hist(bins=84)","aac8cd81":"plt.figure(figsize=(20,6))\ntest_df[\"item_category_id\"].hist(bins=84)","f17929b7":"sns.relplot(x=\"item_price\",y=\"item_cnt_day\",height=9,aspect=1,data=sales_train_df)","caad2cb7":"sales_train_df[sales_train_df.item_cnt_day>2000]","9f97ceb0":"sales_train_df[sales_train_df.item_category_id==9][\"item_cnt_day\"].mean()","a29f7b8d":"sales_train_df[sales_train_df.item_id==11373][\"item_cnt_day\"].mean()","5f54769e":"sales_train_df[(sales_train_df.shop_id==12)&(sales_train_df.item_id==11373)][\"item_cnt_day\"].mean()","3ecf357a":"sales_train_df=sales_train_df[~sales_train_df.isin(sales_train_df[sales_train_df.item_cnt_day>2000])]","16f266f5":"sales_train_df[sales_train_df.item_price>50000]","97babfda":"sales_train_df=sales_train_df[~sales_train_df.isin(sales_train_df[sales_train_df.item_price>50000])]","56bce915":"sns.relplot(x=\"item_price\",y=\"item_cnt_day\",height=9,aspect=1,data=sales_train_df)","a2a6b2f3":"sales_train_df[sales_train_df.item_cnt_day>800]","790f267b":"sales_train_df[sales_train_df.item_id==20949][\"item_cnt_day\"].mean()","f85d91ec":"sales_train_df[(sales_train_df.shop_id==12)&(sales_train_df.item_id==20949)][\"item_cnt_day\"].mean()","20e87cc1":"sales_train_df=sales_train_df[~sales_train_df.isin(sales_train_df[sales_train_df.item_cnt_day>800])]","e00081bf":"sns.relplot(x=\"item_price\",y=\"item_cnt_day\",height=9,aspect=1,data=sales_train_df)","05756db5":"item_id_uniq=pd.unique(sales_train_df[\"item_id\"])","b43b8e0a":"test_unique_items=test_df[~test_df[\"item_id\"].isin(item_id_uniq)]\ntest_unique_items.head()","eee9a67d":"test_unique_items.shape","dd3f3dd5":"test_unique_items[\"item_id\"].nunique()","9707d71b":"sales_train_df.shape","6fd9eeb9":"%%time\ntrain=[]\ncol=[\"date_block_num\",\"shop_id\",\"item_id\"]\nfor i in range(34):\n  sales=sales_train_df[sales_train_df.date_block_num==i]\n  train.append(np.array(list(product([i],sales.shop_id.unique(),sales.item_id.unique())),dtype=\"int16\"))\ntrain=pd.DataFrame(np.vstack(train),columns=col)\ntrain[\"date_block_num\"]=train[\"date_block_num\"].astype(np.int8)\ntrain[\"shop_id\"]=train[\"shop_id\"].astype(np.int8)\ntrain[\"item_id\"]=train[\"item_id\"].astype(np.int16)\nprint(train.head())","f5d55033":"month_df=sales_train_df[[\"date_block_num\",\"shop_id\",\"item_id\",\"item_cnt_day\"]].groupby([\"date_block_num\",\"shop_id\",\"item_id\"]).sum()\nmonth_df.head()","ce4b223f":"date_block_total=month_df.reset_index()\ndate_block_total_group=date_block_total[[\"date_block_num\",\"item_cnt_day\"]].groupby(\"date_block_num\",as_index=False).sum()\nplt.figure(figsize=(20,6))\nsns.barplot(x=\"date_block_num\",y=\"item_cnt_day\",data=date_block_total_group)","803108e1":"date_block_total[\"year\"]=date_block_total.date_block_num.apply(lambda x:((x\/\/12)+2013))\ndate_block_total[\"month\"]=date_block_total.date_block_num.apply(lambda x: (x%12))\ndate_block_total.head()","4ba1805c":"total_month=date_block_total[[\"month\",\"item_cnt_day\"]].groupby(\"month\",as_index=False).sum()\nplt.figure(figsize=(10,10))\nsns.barplot(x=\"month\",y=\"item_cnt_day\",data=total_month)","4d9b1ce6":"total_year=date_block_total[[\"year\",\"item_cnt_day\"]].groupby(\"year\",as_index=False).sum()\nplt.figure(figsize=(6,6))\nsns.barplot(x=\"year\",y=\"item_cnt_day\",data=total_year)","6a2b1c19":"train[\"year\"]=train.date_block_num.apply(lambda x:((x\/\/12)+2013))\ntrain[\"month\"]=train.date_block_num.apply(lambda x: (x%12))\ntrain[\"year\"]=train[\"year\"].astype(np.int16)\ntrain[\"month\"]=train[\"month\"].astype(np.int8)\ntrain.head()","9ac5b751":"test_df=pd.read_csv(\"..\/input\/competitive-data-science-predict-future-sales\/test.csv\")\ntest_df[\"date_block_num\"]=34\ntest_df[\"year\"]=((34\/\/12)+2013)\ntest_df[\"month\"]=(34%12)\ntest_df[\"date_block_num\"]=test_df[\"date_block_num\"].astype(np.int8)\ntest_df[\"shop_id\"]=test_df[\"shop_id\"].astype(np.int8)\ntest_df[\"item_id\"]=test_df[\"item_id\"].astype(np.int16)\ntest_df[\"year\"]=test_df[\"year\"].astype(np.int16)\ntest_df[\"month\"]=test_df[\"month\"].astype(np.int8)\ntest_df.head()","565b6813":"categorical=[\"year\",\"month\"]","096fdba9":"train=train.join(month_df,on=[\"date_block_num\",\"shop_id\",\"item_id\"],how=\"left\")\ntrain[\"item_cnt_day\"]=train[\"item_cnt_day\"].fillna(0).clip(0,20).astype(np.float16)\ntrain.head()","7ef1730d":"train=pd.concat([train,test_df],ignore_index=True,sort=False,keys=col)\ntrain.fillna(0,inplace=True)\ntrain.head()","c1290bf6":"def create_lag_features(df,feature):\n  numeric_features=[]\n  for i in range(1,7):\n    lagged=df.copy()\n    lagged=lagged[[\"date_block_num\",\"shop_id\",\"item_id\",feature]]\n    lagged.columns=[\"date_block_num\",\"shop_id\",\"item_id\",feature+\"_lag_\"+str(i)]\n    numeric_features.append(feature+\"_lag_\"+str(i))\n    lagged[\"date_block_num\"]+=i\n    df=df.join(lagged.set_index([\"date_block_num\",\"shop_id\",\"item_id\"]),on=[\"date_block_num\",\"shop_id\",\"item_id\"],how=\"left\")\n  return df,numeric_features","56a864b7":"%%time\ntrain,n_col=create_lag_features(train,\"item_cnt_day\")\ntrain=train.fillna(0)\nnumeric=n_col","308194a8":"train.tail().T","c14f7f02":"total_cnt_for_items=sales_train_df[[\"date_block_num\",\"item_id\",\"item_cnt_day\"]].groupby([\"date_block_num\",\"item_id\"]).sum()\ntotal_cnt_for_items.columns=[\"total_cnt_for_items\"]\ntotal_cnt_for_items.head()","a0ae6982":"train=train.join(total_cnt_for_items,on=[\"date_block_num\",\"item_id\"],how=\"left\")\ntrain.fillna(0,inplace=True)\ntrain[\"total_cnt_for_items\"]=train[\"total_cnt_for_items\"].astype(np.float16)\ntrain.head().T","d124034e":"%%time\ntrain,n_col=create_lag_features(train,\"total_cnt_for_items\")\ntrain=train.fillna(0)\ntrain=train.drop([\"total_cnt_for_items\"],axis=1)\nnumeric=numeric+n_col","1f94eefb":"train.tail().T","ec511ee7":"total_cnt_for_shops=sales_train_df[[\"date_block_num\",\"shop_id\",\"item_cnt_day\"]].groupby([\"date_block_num\",\"shop_id\"]).sum()\ntotal_cnt_for_shops.columns=[\"total_cnt_for_shops\"]\ntotal_cnt_for_shops.head()","ae2490e9":"sum_cnt_shops=total_cnt_for_shops.reset_index()\ncnt_shops=sum_cnt_shops[[\"shop_id\",\"total_cnt_for_shops\"]].groupby(\"shop_id\",as_index=False).mean()\ncnt_shops=cnt_shops.join(shops_df.set_index([\"shop_id\"]),on=\"shop_id\",how=\"left\")\ncnt_shops.head()","8c8187e5":"plt.figure(figsize=(15,15))\nsns.barplot(x=\"total_cnt_for_shops\",y=\"shop_name\",orient=\"h\",data=cnt_shops)","4b28a746":"cnt_shops.loc[cnt_shops.shop_name == '\u0421\u0435\u0440\u0433\u0438\u0435\u0432 \u041f\u043e\u0441\u0430\u0434 \u0422\u0426 \"7\u042f\"', 'shop_name'] = '\u0421\u0435\u0440\u0433\u0438\u0435\u0432\u041f\u043e\u0441\u0430\u0434 \u0422\u0426 \"7\u042f\"'\ncnt_shops['shop_city'] = cnt_shops['shop_name'].str.split(' ').map(lambda x: x[0])\ncnt_shops.loc[cnt_shops.shop_city == '!\u042f\u043a\u0443\u0442\u0441\u043a', 'shop_city'] = '\u042f\u043a\u0443\u0442\u0441\u043a'\ncnt_shops['shop_type'] = cnt_shops['shop_name'].str.split(' ').map(lambda x: x[1])\ncnt_shops.head()\n","743ef87e":"sum_cnt_shop_city=cnt_shops[[\"shop_city\",\"total_cnt_for_shops\"]].groupby(\"shop_city\",as_index=False).sum()\nplt.figure(figsize=(15,15))\nsns.barplot(x=\"total_cnt_for_shops\",y=\"shop_city\",orient=\"h\",data=sum_cnt_shop_city)","220dcbdf":"sum_cnt_shop_type=cnt_shops[[\"shop_type\",\"total_cnt_for_shops\"]].groupby(\"shop_type\",as_index=False).mean()\nplt.figure(figsize=(15,15))\nsns.barplot(x=\"total_cnt_for_shops\",y=\"shop_type\",orient=\"h\",data=sum_cnt_shop_type)","7ebee8e5":"train=train.join(cnt_shops[[\"shop_id\",\"shop_city\",\"shop_type\"]].set_index([\"shop_id\"]),on=\"shop_id\",how=\"left\")\ntrain.fillna(0,inplace=True)\ntrain[\"shop_city\"]=train[\"shop_city\"].astype(str)\ntrain[\"shop_type\"]=train[\"shop_type\"].astype(str)\ntrain.head().T","6aeed6a1":"categorical=categorical+[\"shop_city\",\"shop_type\"]","448392eb":"train=train.join(total_cnt_for_shops,on=[\"date_block_num\",\"shop_id\"],how=\"left\")\ntrain.fillna(0,inplace=True)\ntrain[\"total_cnt_for_shops\"]=train[\"total_cnt_for_shops\"].astype(np.float16)\ntrain.head().T","9221a2f5":"%%time\ntrain,n_col=create_lag_features(train,\"total_cnt_for_shops\")\ntrain=train.fillna(0)\ntrain=train.drop([\"total_cnt_for_shops\"],axis=1)\nnumeric=numeric+n_col","60bff907":"train.tail().T","025eb4c4":"total_cnt_for_item_categories=sales_train_df[[\"date_block_num\",\"item_category_id\",\"item_cnt_day\"]].groupby([\"date_block_num\",\"item_category_id\"]).sum()\ntotal_cnt_for_item_categories.columns=[\"total_cnt_for_item_categories\"]\ntotal_cnt_for_item_categories.head()","b7f4337f":"sum_cnt_for_item_category=total_cnt_for_item_categories.reset_index()\nsum_cnt_for_item_category=sum_cnt_for_item_category[[\"item_category_id\",\"total_cnt_for_item_categories\"]].groupby(\"item_category_id\",as_index=False).sum()\nsum_cnt_for_item_category=sum_cnt_for_item_category.join(item_categories_df.set_index(\"item_category_id\"),on=[\"item_category_id\"],how=\"left\")\nplt.figure(figsize=(15,15))\nsns.barplot(x=\"total_cnt_for_item_categories\",y=\"item_category_name\",orient=\"h\",data=sum_cnt_for_item_category)","a33074a5":"sum_cnt_for_item_category[\"category\"]=sum_cnt_for_item_category.item_category_name.str.split(\"-\").str[0]\nsum_cnt_for_item_category[\"subcategory\"]=sum_cnt_for_item_category.item_category_name.str.split(\"-\").str[1]\nsum_cnt_for_item_category.head()","b5c652de":"sum_cnt_category=sum_cnt_for_item_category[[\"category\",\"total_cnt_for_item_categories\"]].groupby(\"category\",as_index=False).sum()\nplt.figure(figsize=(15,15))\nsns.barplot(x=\"total_cnt_for_item_categories\",y=\"category\",orient=\"h\",data=sum_cnt_category)","42479276":"sum_cnt_subcategory=sum_cnt_for_item_category[[\"subcategory\",\"total_cnt_for_item_categories\"]].groupby(\"subcategory\",as_index=False).sum()\nplt.figure(figsize=(15,15))\nsns.barplot(x=\"total_cnt_for_item_categories\",y=\"subcategory\",orient=\"h\",data=sum_cnt_subcategory)","eb196ee9":"train=train.join(items_df.set_index([\"item_id\"]),on=[\"item_id\"],how=\"left\")\ntrain=train.join(sum_cnt_for_item_category[[\"item_category_id\",\"category\",\"subcategory\"]].set_index([\"item_category_id\"]),on=[\"item_category_id\"],how=\"left\")\ntrain.fillna(0,inplace=True)\ntrain[\"category\"]=train[\"category\"].astype(str)\ntrain[\"subcategory\"]=train[\"subcategory\"].astype(str)\ntrain.tail().T","2d54769c":"categorical=categorical+[\"category\",\"subcategory\"]","30415e70":"train=train.join(total_cnt_for_item_categories,on=[\"date_block_num\",\"item_category_id\"],how=\"left\")\ntrain.fillna(0,inplace=True)\ntrain[\"total_cnt_for_item_categories\"]=train[\"total_cnt_for_item_categories\"].astype(np.float16)\ntrain.head().T","a8e2c8c1":"%%time\ntrain,n_col=create_lag_features(train,\"total_cnt_for_item_categories\")\ntrain=train.fillna(0)\ntrain=train.drop([\"total_cnt_for_item_categories\"],axis=1)\nnumeric=numeric+n_col","471e1407":"train.tail().T","cd835d97":"train[\"item_name\"]","e35cca6b":"mean_price=sales_train_df[[\"date_block_num\",\"shop_id\",\"item_id\",\"item_price\"]].groupby([\"date_block_num\",\"shop_id\",\"item_id\"]).mean()\nmean_price.columns=[\"mean_price\"]\nmean_price.head()","37d3a94c":"train=train.join(mean_price,on=[\"date_block_num\",\"shop_id\",\"item_id\"],how=\"left\")\ntrain.fillna(0,inplace=True)\ntrain[\"mean_price\"]=train[\"mean_price\"].astype(np.float16)\ntrain.head().T","3cccee79":"%%time\ntrain,n_col=create_lag_features(train,\"mean_price\")\ntrain=train.fillna(0)\ntrain=train.drop([\"mean_price\"],axis=1)\nnumeric=numeric+n_col","7d4da478":"train.tail().T","76de88e1":"mean_price_for_items=sales_train_df[[\"date_block_num\",\"item_id\",\"item_price\"]].groupby([\"date_block_num\",\"item_id\"]).mean()\nmean_price_for_items.columns=[\"mean_price_for_items\"]\nmean_price_for_items.head()","f871679e":"train=train.join(mean_price_for_items,on=[\"date_block_num\",\"item_id\"],how=\"left\")\ntrain.fillna(0,inplace=True)\ntrain[\"mean_price_for_items\"]=train[\"mean_price_for_items\"].astype(np.float16)\ntrain.head().T","a9c76c85":"%%time\ntrain,n_col=create_lag_features(train,\"mean_price_for_items\")\ntrain=train.fillna(0)\ntrain=train.drop([\"mean_price_for_items\"],axis=1)\nnumeric=numeric+n_col","3f2d1a63":"train.tail().T","319935d1":"mean_price_for_item_categories=sales_train_df[[\"date_block_num\",\"item_category_id\",\"item_price\"]].groupby([\"date_block_num\",\"item_category_id\"]).mean()\nmean_price_for_item_categories.columns=[\"mean_price_for_item_categories\"]\nmean_price_for_item_categories.head()","3d2baf59":"train=train.join(mean_price_for_item_categories,on=[\"date_block_num\",\"item_category_id\"],how=\"left\")\ntrain.fillna(0,inplace=True)\ntrain[\"mean_price_for_item_categories\"]=train[\"mean_price_for_item_categories\"].astype(np.float16)\ntrain.head().T","076bbe65":"%%time\ntrain,n_col=create_lag_features(train,\"mean_price_for_item_categories\")\ntrain=train.fillna(0)\ntrain=train.drop([\"mean_price_for_item_categories\"],axis=1)\nnumeric=numeric+n_col","d0810db8":"train.tail().T","704c4b3d":"sales_train_df[\"revenue\"]=sales_train_df[\"item_price\"]*sales_train_df[\"item_cnt_day\"]\ntotal_revenue=sales_train_df[[\"date_block_num\",\"shop_id\",\"revenue\"]].groupby([\"date_block_num\",\"shop_id\"]).sum()\ntotal_revenue.columns=[\"total_shop_revenue\"]\ntotal_revenue.head()","8c3745e6":"train=train.join(total_revenue,on=[\"date_block_num\",\"shop_id\"],how=\"left\")\ntrain[\"total_shop_revenue\"]=train[\"total_shop_revenue\"].astype(np.float32)\ntrain.fillna(0,inplace=True)\ntrain.head().T","840eeb46":"%%time\ntrain,n_col=create_lag_features(train,\"total_shop_revenue\")\ntrain=train.fillna(0.0)\ntrain=train.drop([\"total_shop_revenue\"],axis=1)\nnumeric=numeric+n_col","4cdbb038":"train.tail().T","c231fbdc":"test_df=train[train.date_block_num==34]\ntrain=train[train.date_block_num<34]\ntrain=train[~train[\"date_block_num\"].isin([0,1,2,3,4,5])].reset_index(drop=True)\ntrain.head().T","40b729bb":"test_df.head().T","6d4f14b3":"numeric=numeric+[\"date_block_num\",\"item_cnt_day\"]","05811c29":"'''groups = train.groupby(train.date_block_num).groups\nsorted_groups = [value for (key, value) in sorted(groups.items())]\ncv=[(np.concatenate(sorted_groups[:8]),np.concatenate(sorted_groups[8:])),\n    (np.concatenate(sorted_groups[:16]),np.concatenate(sorted_groups[16:])),\n    (np.concatenate(sorted_groups[:24]),np.concatenate(sorted_groups[24:]))]'''","c83d3cbd":"X_train_categorical=train[categorical]\nX_test_categorical=test_df[categorical]\nX_train_categorical[\"subcategory\"]=X_train_categorical[\"subcategory\"].astype(str)\nX_test_categorical[\"subcategory\"]=X_test_categorical[\"subcategory\"].astype(str)\nX_test_categorical[\"year\"]=X_test_categorical[\"year\"].astype(np.int16)\nX_test_categorical[\"month\"]=X_test_categorical[\"month\"].astype(np.int8)\nX_test_categorical.loc[X_test_categorical.category==\"PC \",\"category\"]=\"\u0418\u0433\u0440\u044b PC \"\nX_test_categorical.loc[X_test_categorical.subcategory==\" \u0413\u0430\u0440\u043d\u0438\u0442\u0443\u0440\u044b\/\u041d\u0430\u0443\u0448\u043d\u0438\u043a\u0438\",\"subcategory\"]=\" \u0410\u043a\u0441\u0435\u0441\u0441\u0443\u0430\u0440\u044b \u0434\u043b\u044f \u0438\u0433\u0440\"","c2f825c3":"for feature in categorical:\n  le=LabelEncoder()\n  print(feature)\n  X_train_categorical[feature]=le.fit_transform(X_train_categorical[feature])\n  X_test_categorical[feature]=le.transform(X_test_categorical[feature])","e55e83b2":"X_train_categorical.head()","f1029425":"X_test_categorical.head()","5bab1d49":"X_train_numeric=train[numeric]\nX_test_numeric=test_df[numeric]","6f52fab1":"X_train_numeric.head().T","875f53ce":"X_test_numeric.head().T","04a421c7":"label_cat_not_num_train=pd.concat([X_train_categorical,X_train_numeric],axis=1)\nlabel_cat_not_num_train.head().T","0647f305":"label_cat_not_num_test=pd.concat([X_test_categorical,X_test_numeric],axis=1)\nlabel_cat_not_num_test.head().T","ef4a794a":"label_cat_not_num_train.shape","b9c1a255":"def downcast_type(df):\n  for feature in categorical:\n    df[feature]=df[feature].astype(np.int8)","fc3b2e67":"downcast_type(label_cat_not_num_train)\nlabel_cat_not_num_train.info()","26ceccfc":"X_train=label_cat_not_num_train[label_cat_not_num_train.date_block_num<=19]\nX_val=label_cat_not_num_train[label_cat_not_num_train.date_block_num>19]\nX_train=X_train.drop([\"date_block_num\"],axis=1)\nX_val=X_val.drop([\"date_block_num\"],axis=1)","7657203a":"y_train=X_train[\"item_cnt_day\"]\ny_val=X_val[\"item_cnt_day\"]\nX_val=X_val.drop([\"item_cnt_day\"],axis=1)\nX_train=X_train.drop([\"item_cnt_day\"],axis=1)","6c448142":"def RMSE(y,predictions):\n  return  np.sqrt(mean_squared_error(y,predictions))\nscorer=make_scorer(RMSE,False)","393b7c00":"rf = RandomForestRegressor(n_estimators=50, max_depth=16,max_features=0.4,min_samples_leaf=10,n_jobs=-1)\nrf.fit(X_train, y_train)","10100085":"predictions = []\nfor tree in rf.estimators_:\n    predictions.append(tree.predict(X_val))","91f631a5":"predictions = np.vstack(predictions)","b3090872":"cum_mean = np.cumsum(predictions, axis=0)\/np.arange(1, predictions.shape[0] + 1)[:, None]","875fa935":"cum_mean","c3127e93":"scores = []\nfor pred in cum_mean:\n    scores.append(np.sqrt(mean_squared_error(y_val,pred)))","d414a830":"plt.figure(figsize=(10, 6))\nplt.plot(scores, linewidth=3)\nplt.xlabel('num_trees')\nplt.ylabel('RMSE');","ea2a5918":"pred=rf.predict(X_val)","5ace213f":"score=np.sqrt(mean_squared_error(y_val,pred))\nscore","811f025e":"y_train=label_cat_not_num_train[\"item_cnt_day\"]\nlabel_cat_not_num_train=label_cat_not_num_train.drop([\"item_cnt_day\"],axis=1)\nlabel_cat_not_num_train=label_cat_not_num_train.drop([\"date_block_num\"],axis=1)\nlabel_cat_not_num_test=label_cat_not_num_test.drop([\"item_cnt_day\"],axis=1)\nlabel_cat_not_num_test=label_cat_not_num_test.drop([\"date_block_num\"],axis=1)","7a737d27":"rf = RandomForestRegressor(n_estimators=50, max_depth=16,max_features=0.4,min_samples_leaf=10,n_jobs=-1)\nrf.fit(label_cat_not_num_train,y_train)","8a9965ba":"predictions=rf.predict(label_cat_not_num_test)","8ce35288":"sample_submissions[\"item_cnt_month\"]=predictions\nsample_submissions.head()","89776c1e":"sample_submissions.to_csv(\"random_forest_lagged_features_6.csv\",index=False)","920c5fae":"Create Features For item_category_id.","e7432b7f":"From this graph, an upward seasonal trend is visible from the first months of the year to the last. And the downward seasonal trend of sales by years from 2013 to 2015.","769a85b3":"From this graph we see that in the dataset there are two points that can be outliers. One with sales over 2000. Another with a price of over 50000.","cd8b42a5":"Create Lag Features For Total Month Cnt","facab687":"From this histogram we can see that most daily sales are in the range close to one.But on some items, sales are 2,000 or higher, and this may be an outlier.","4f43d97f":"Create Features For item_price","710e4b27":"Create Lag Features For Item Id Total Cnt","d28ea568":"We look at the data in the tables","a98eb441":"From this histogram we can see that most of the prices for items are in the range from 0 to about 1000. But there are also items with huge prices from 10000 to 300000. It can be outliers or just items with high price.","f06a6f32":"Create Features For shop_id.","d8b560f5":"It can be seen from these tables that in the training set, shop_id changes from 0 to 59, and on the test set it changes from 2 to 59. Also, item_id on the training set changes from 0 to 22169, and on the test set from 30 to 22167. Therefore, these indices are not match. We\u2019ll check this more carefully.","2400f6c7":"You can try to add pairs (item, shop) to each month and encode them using the median of sales for the category to which this item belongs in the corresponding month. To do this, join all the datasets with each other.","43fec9fe":"Two variable categories and a sibcategory can be extracted from the category name.","289d0cfa":"**Import Library**","17e60b97":"It seems that this point is really an outlier.","53f87460":"Create Lag Features For shop_id.","86246f72":"The graphs show that to build a test set for each shop, we took all all the item-shop pairs that are present in the test dataset. You can build such a dataset from the training set by taking for each month all the unique item-shop pairs present in the test dataset.","45d5e728":"Create Target Variable"}}