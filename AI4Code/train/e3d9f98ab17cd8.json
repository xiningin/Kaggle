{"cell_type":{"ef250d5a":"code","0ce18ce6":"code","d47d46b9":"code","a296f078":"code","95db6e16":"code","4be20f63":"code","2cd3dc99":"code","efa8f38a":"code","d2367b42":"code","bf4263cc":"code","a19c822a":"code","66cf3c38":"code","86be3ea5":"code","9bdc51ea":"code","ab790eca":"code","15afcdb8":"code","0e6384d5":"code","3cabc4bb":"code","c8fe8ce6":"code","b5406f2b":"code","32852704":"code","0afaad9b":"code","098bf5b2":"code","f9135305":"markdown","b511f9cc":"markdown","232c8af6":"markdown","bfca489b":"markdown","0cec43b5":"markdown","221b7965":"markdown","8371e142":"markdown","be7b701a":"markdown","c9b0cfd4":"markdown","026e7183":"markdown","c801add9":"markdown","8002ea62":"markdown","521ef984":"markdown","dae82e35":"markdown","b9738e9c":"markdown","b16d7386":"markdown","362b65f8":"markdown","028c3ac9":"markdown","13099c14":"markdown","e991570b":"markdown","2ed0bbbf":"markdown","f7924b6f":"markdown","a962c2ed":"markdown","b5e107f8":"markdown","30311b57":"markdown","2faa2320":"markdown","97db655e":"markdown","f6dcf9fe":"markdown","121c90bf":"markdown","331963e3":"markdown","96249850":"markdown","3bb44102":"markdown","bfd5bfa4":"markdown","913c4908":"markdown","67503ccd":"markdown","7a88775a":"markdown","39133ea8":"markdown","b06f3a7e":"markdown","62e608ac":"markdown","8abf4ee6":"markdown","f597e5cf":"markdown","2c545f1f":"markdown","16d2f4b4":"markdown"},"source":{"ef250d5a":"import os\n\nimport cv2\nimport numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\nimport matplotlib.pyplot as plt\nimport seaborn as sns","0ce18ce6":"!ls ..\/input\/bms-molecular-translation","d47d46b9":"#From https:\/\/www.kaggle.com\/ihelon\/molecular-translation-exploratory-data-analysis\ndef convert_image_id_2_path(image_id: str) -> str:\n    return \"..\/input\/bms-molecular-translation\/train\/{}\/{}\/{}\/{}.png\".format(\n        image_id[0], image_id[1], image_id[2], image_id \n    )\n\ndef visualize_train_image(image_id, label):\n    plt.figure(figsize=(10, 8))\n    \n    image = cv2.imread(convert_image_id_2_path(image_id))\n    image = cv2.cvtColor(image, cv2.COLOR_BGR2RGB)\n\n    plt.imshow(image)\n    plt.title(f\"{label}\", fontsize=14)\n    plt.axis(\"off\")\n    \n    plt.show()\n    \ntrain_labels = pd.read_csv(\"..\/input\/bms-molecular-translation\/train_labels.csv\")\nindex = 1\nmolecule_image_id = train_labels[\"image_id\"].iloc[index]\nmolecule_InChI = train_labels[\"InChI\"].iloc[index]\n    \nvisualize_train_image(molecule_image_id, molecule_InChI)","a296f078":"train_labels = pd.read_csv(\"..\/input\/bms-molecular-translation\/train_labels.csv\")\ntest_labels = pd.read_csv(\"..\/input\/bms-molecular-translation\/sample_submission.csv\")\nindex = 1\nmolecule_image_id = train_labels[\"image_id\"].iloc[index]\nmolecule_InChI = train_labels[\"InChI\"].iloc[index]\nprint(molecule_InChI)","95db6e16":"!pip install py3Dmol","4be20f63":"import py3Dmol ","2cd3dc99":"#Enter CID here!!!\ncid_for_query = 'cid:124916588'","efa8f38a":"view = py3Dmol.view(width=680, height=300, query=cid_for_query, linked=False)\nview.setStyle({'stick': {}})\nview.setBackgroundColor('#f9f4fb')\nview.show()","d2367b42":"view = py3Dmol.view(width=500, height=1000, query=cid_for_query, viewergrid=(3,1), linked=False)\nview.setStyle({'line': {'linewidth': 1}}, viewer=(0,0))\nview.setStyle({'stick': {}}, viewer=(1,0))\nview.setStyle({'sphere': {}}, viewer=(2,0))\nview.setBackgroundColor('#ebf4fb', viewer=(0,0))\nview.setBackgroundColor('#f9f4fb', viewer=(1,0))\nview.setBackgroundColor('#e1e1e1', viewer=(2,0))\nview.show()","bf4263cc":"#From https:\/\/www.kaggle.com\/ihelon\/molecular-translation-exploratory-data-analysis\ndef convert_image_id_2_path(image_id: str) -> str:\n    return \"..\/input\/bms-molecular-translation\/train\/{}\/{}\/{}\/{}.png\".format(\n        image_id[0], image_id[1], image_id[2], image_id \n    )\n\ndef visualize_train_image(image_id, label):\n    plt.figure(figsize=(10, 8))\n    \n    image = cv2.imread(convert_image_id_2_path(image_id))\n    image = cv2.cvtColor(image, cv2.COLOR_BGR2RGB)\n\n    plt.imshow(image)\n    plt.title(f\"{label}\", fontsize=14)\n    plt.axis(\"off\")\n    \n    plt.show()\n    \ndef visualize_train_image_with_hflip(image_id, label):\n    plt.figure(figsize=(10, 8))\n    \n    image = cv2.imread(convert_image_id_2_path(image_id))\n    image = cv2.cvtColor(image, cv2.COLOR_BGR2RGB)\n    image = cv2.flip(image, 0)\n\n    plt.imshow(image)\n    plt.title(f\"InChI=????\", fontsize=14)\n    plt.axis(\"off\")\n    \n    plt.show()\n    \ndef convert_image_id_2_path_test(image_id: str) -> str:\n    return \"..\/input\/bms-molecular-translation\/test\/{}\/{}\/{}\/{}.png\".format(\n        image_id[0], image_id[1], image_id[2], image_id \n    )\n\ndef visualize_train_image_test(image_id, label):\n    plt.figure(figsize=(10, 8))\n    \n    image = cv2.imread(convert_image_id_2_path_test(image_id))\n    image = cv2.cvtColor(image, cv2.COLOR_BGR2RGB)\n\n    plt.imshow(image)\n    plt.title(f\"{label}\", fontsize=14)\n    plt.axis(\"off\")\n    \n    plt.show()","a19c822a":"index = 1516695\nmolecule_image_id = train_labels[\"image_id\"].iloc[index]\nmolecule_InChI = train_labels[\"InChI\"].iloc[index]\nprint(molecule_InChI)\n    \nvisualize_train_image(molecule_image_id, molecule_InChI)","66cf3c38":"index = 1009387\nmolecule_image_id_test = test_labels[\"image_id\"].iloc[index]\nmolecule_InChI_test = test_labels[\"InChI\"].iloc[index]\nprint(molecule_InChI_test)\n    \nvisualize_train_image_test(molecule_image_id_test, molecule_InChI_test)","86be3ea5":"index = 945\nmolecule_image_id = train_labels[\"image_id\"].iloc[index]\nmolecule_InChI = train_labels[\"InChI\"].iloc[index]\nprint(molecule_InChI)\n    \nvisualize_train_image(molecule_image_id, molecule_InChI)","9bdc51ea":"visualize_train_image_with_hflip(molecule_image_id, molecule_InChI)","ab790eca":"###### Methyl (2S)-2-amino-3-(4-fluorophenyl)sulfanylpropanoate\nview = py3Dmol.view(width=680, height=300, query=\"cid:94054932\", linked=False)\nview.setStyle({'stick': {}})\nview.setBackgroundColor('#f9f4fb')\nview.show()","15afcdb8":"#Methyl (2R)-2-amino-3-(4-fluorophenyl)sulfanylpropanoate\nview = py3Dmol.view(width=680, height=300, query=\"cid:94054933\", linked=False)\nview.setStyle({'stick': {}})\nview.setBackgroundColor('#f9f4fb')\nview.show()","0e6384d5":"shortest_mol_idx = np.argmin(train_labels[\"InChI\"].apply(lambda x: len(x)))\ntrain_labels[\"InChI\"][shortest_mol_idx]","3cabc4bb":"#Methyl (2R)-2-amino-3-(4-fluorophenyl)sulfanylpropanoate\nview = py3Dmol.view(width=680, height=300, query=\"cid:13153\", linked=False)\nview.setStyle({'stick': {}})\nview.setBackgroundColor('#f9f4fb')\nview.show()","c8fe8ce6":"longest_mol_idx = np.argmax(train_labels[\"InChI\"].apply(lambda x: len(x)))\ntrain_labels[\"InChI\"][longest_mol_idx]","b5406f2b":"#Methyl (2R)-2-amino-3-(4-fluorophenyl)sulfanylpropanoate\nview = py3Dmol.view(width=680, height=300, query=\"cid:138197614\", linked=False)\nview.setStyle({'stick': {}})\nview.setBackgroundColor('#f9f4fb')\nview.show()","32852704":"!conda install -c rdkit rdkit -y","0afaad9b":"import rdkit\n\n# https:\/\/www.kaggle.com\/brodzik\/drawing-molecules-with-rdkit-inchi-to-png\n\nmol = rdkit.Chem.inchi.MolFromInchi(train_labels[\"InChI\"][longest_mol_idx])\nd = rdkit.Chem.Draw.rdMolDraw2D.MolDraw2DCairo(512, 512)\nd.drawOptions().useBWAtomPalette()\nd.DrawMolecule(mol)\nd.WriteDrawingText(\"0.png\")\nimg = cv2.imread(\"0.png\", cv2.IMREAD_GRAYSCALE)\nplt.figure(figsize=(20, 20))\nplt.imshow(img, \"gray\")\nplt.show()","098bf5b2":"sns.distplot(train_labels[\"InChI\"].apply(lambda x: len(x)))","f9135305":"<img src=\"https:\/\/raw.githubusercontent.com\/tasotasoso\/kaggle_media\/main\/How_to_check_conformation_of_Structural_formula\/enantiomer1.png\" width=\"700\">","b511f9cc":"So are these two the same thing? No, they are not. No matter how hard we try, we can't superimpose the labels of the vertices.\n\nAtoms are arranged to form a tetrahedron around carbon, which has only single bonds. Depending on the type of bonded atoms, phenomena such as the one we saw above can occur. In this molecule, the carbon marked with * is the [Stereocenter](https:\/\/en.wikipedia.org\/wiki\/Stereocenter), which is the center of this tetrahedron.","232c8af6":"----------------------","bfca489b":"The fact that the atomic symbols have been reversed this time may be problematic, but there are another pitfalls unique to this theme. This is because they are actually two different molecules. Original one is \"Methyl (2S)-2-amino-3-(4-fluorophenyl)sulfanylpropanoate\" and fliped one is \"Methyl (2R)-2-amino-3-(4-fluorophenyl)sulfanylpropanoate\".\n\n## What is Enantiomer?\n\n[Enantiomer](https:\/\/en.wikipedia.org\/wiki\/Enantiomer) is the stereoisomer that are mirror images of each other. They are considered completely different compounds. Not only do they differ geometrically, but they may also have different chemical properties.\n\nSimplifying, it can be described by the following tetrahedron. It's vertices of the tetrahedron are labeled A ~ D. We will think another tetrahedron with a mirrored surface. If you put them side by side, they will look like the figure below.","0cec43b5":"The distribution of the length of InChI is as follows.","221b7965":"### Methyl (2S)-2-amino-3-(4-fluorophenyl)sulfanylpropanoate","8371e142":"\"\u25bc\" may be difficult to understand, but it shows which way the molecules are facing. Compare with the 3D model of a water molecule.\n\n<img src=\"https:\/\/raw.githubusercontent.com\/tasotasoso\/kaggle_media\/main\/How_to_check_conformation_of_Structural_formula\/In%20front%20of%20or%20behind%20page%3F.png\" width=\"800\">\n\nDo you understand? When the molecule is flat on paper, it is written as just a bar line. On the other hand, if the molecule is placed so that it has depth, we use a \"\u25bc\" to indicate this. In this way, it is possible to represent the three-dimensional structure of even complex molecules using only a pen and paper. Also, when considering chemical reaction mechanisms, we use this kind of notation because the 3D structure is one of the very important factor.","be7b701a":"### Methyl (2R)-2-amino-3-(4-fluorophenyl)sulfanylpropanoate","c9b0cfd4":"We can also check comformation on kaggle notebook with py3Dmol.","026e7183":"<img src=\"https:\/\/raw.githubusercontent.com\/tasotasoso\/kaggle_media\/main\/How_to_check_conformation_of_Structural_formula\/search_result.JPG\" width=\"***500***\">","c801add9":"<img src=\"https:\/\/raw.githubusercontent.com\/tasotasoso\/kaggle_media\/main\/How_to_check_conformation_of_Structural_formula\/search_on_pubchem.JPG\" width=\"***500***\">","8002ea62":"### Shortest one","521ef984":"<img src=\"https:\/\/raw.githubusercontent.com\/tasotasoso\/kaggle_media\/main\/How_to_check_conformation_of_Structural_formula\/get_pubchem_cid.JPG\" width=\"***500***\">","dae82e35":"## Flip may cause bad effect?\n\nWe often use vertical and holizontal flip when we try rotation, like following.","b9738e9c":"<a id=\"2\"><\/a> <br>\n# <div class=\"alert alert-block alert-warning\">Why we check 3D model?<\/div> \n\n- Even if we are not familiar with chemical notation, it is easy to understand molecules. \n\nSome elements may be omitted in the skeletal stractual formula, so the molecule you imagine may not be actual. For example, hydrogen bonded to carbon may be omitted, but you can see them in the 3D model (3D models often show almost all of them).\n\n- We can develop intuition for molecular structures and aplly them to ML. \n\nItuition for molecular structures is important for this machine learning theme. For examle, if you do data augmentation, you may end up with different molecules ( see [Points to note for data augmentation with flip](#6) ) by inverting the images blindly. On the other hand, we can also come up with ideas for data augmentation methods that are unique to molecular structural expressions. For example, we can change the angle from which you look at molecules. Also, if you know how to write structural expressions, you may be able to generate images with various structural expressions from InChI(This may be too difficult). In short, rotating the 3D model around is essentially equal to data augmentation.","b16d7386":"## 0. Get InChI for molecule\n\nGet the InChI of the molecule we want to check as follows.","362b65f8":"### test data","028c3ac9":"<a id=\"4\"><\/a> <br>\n# <div class=\"alert alert-block alert-info\">Check 3D molecules on PubChem website<\/div> \n\n\nWe can check the chemical & Structual data by [PubChem](https:\/\/pubchem.ncbi.nlm.nih.gov). First, we get InChI expression from label. Let's take a look at the 3D model of the very first data (above structural formula) of the training data.\n\n<u>Note<\/u> \n\nThe PubChem images shown below was obtained on 3\/3\/2021 from the [official PubChem website](https:\/\/pubchem.ncbi.nlm.nih.gov).","13099c14":"<a id=\"1\"><\/a> <br>\n# <div class=\"alert alert-block alert-info\">Introduction<\/div>","e991570b":"Let's go PubChem site and search the molecure.\n\n## 1. Enter InChI to search box. And search.","2ed0bbbf":"<img src=\"https:\/\/raw.githubusercontent.com\/tasotasoso\/kaggle_media\/main\/How_to_check_conformation_of_Structural_formula\/enantiomer3.png\" width=\"300\">","f7924b6f":"I have also prepared 3D models, so please try turning them around and see if the placement around the stereocenter overlaps.","a962c2ed":"### train data","b5e107f8":"The image given as data is called skeletal formulas. It represents a molecule with several kinds of lines and element symbols.  As an example of a structural formula, here is an example of a simple molecule with two carbons. The first row is the name of the molecule, the second row is the carefully written structural formula, and the third row is the skeletal structural formula like the training data.\n\n<img src=\"https:\/\/raw.githubusercontent.com\/tasotasoso\/kaggle_media\/main\/How_to_check_conformation_of_Structural_formula\/Example%20for%20structural%20formulas.png\" width=\"1000\">\n\n\nDepending on the case, more experienced chemists often write skeletal structural formulas because they require less effort to write. How many lines are written in a bond is the difference between [Bond order](https:\/\/en.wikipedia.org\/wiki\/Bond_order). In skeletal structural formulas, carbon or hydrogen are often omitted from the letters.","30311b57":"It is also possible to view different types of 3D models.","2faa2320":"<a id=\"6\"><\/a> <br>\n# <div class=\"alert alert-block alert-warning\">Points to note for data augmentation with flip<\/div> \n\n## There are some rotated data in dataset\n\nAccording to [Data page](https:\/\/www.kaggle.com\/c\/bms-molecular-translation\/data).\n\n> The images provided (both in the training data as well as the test data) may be rotated to different angles, be at various resolutions, and have different noise levels.\n\nThere are not many, but if we check the data carefully, we can find that there are some rotated data.","97db655e":"<img src=\"https:\/\/raw.githubusercontent.com\/tasotasoso\/kaggle_media\/main\/How_to_check_conformation_of_Structural_formula\/indivisual_molecule.JPG\" width=\"***500***\">","f6dcf9fe":"Here is a summary of the main notations introduced. If you know the correspondence between these notations and the 3D models (or actual molecules), you will be able to understand the data of this competition more clearly.\n\n<img src=\"https:\/\/raw.githubusercontent.com\/tasotasoso\/kaggle_media\/main\/How_to_check_conformation_of_Structural_formula\/Main%20notation%20of%20structural%20formula.png\" width=\"800\">","121c90bf":"Now let's compare \"Methyl (2S)-2-amino-3-(4-fluorophenyl)sulfanylpropanoate\" and \"Methyl (2R)-2-amino-3-(4-fluorophenyl)sulfanylpropanoate\". We can see that they are mirror images of each other, although they are different from the previous figure due to their preparation. Since it is a different molecule, we can see that the sublayers starting with \/m in the InChI string are different.","331963e3":"## 2. Select molecule","96249850":"<img src=\"https:\/\/raw.githubusercontent.com\/tasotasoso\/kaggle_media\/main\/How_to_check_conformation_of_Structural_formula\/enantiomer2.png\" width=\"900\">","3bb44102":"### Longest one","bfd5bfa4":"## 3. Check molecular models\n\nIt may be little hard to tell from the image, but you can check the 3D model in addition to the structural formula. Please click on the link below to check the results.\n[PubChem CID: 124916588](https:\/\/pubchem.ncbi.nlm.nih.gov\/compound\/124916588)","913c4908":"To query molecure's information, we need PubChem CID. We can get like following. ","67503ccd":"Unfortunately, there doesn't seem to be 3D model.","7a88775a":"<a id=\"5\"><\/a> <br>\n# <div class=\"alert alert-block alert-info\">Check 3D models on kaggle notebook<\/div> ","39133ea8":"# Understand dataset with molecular 3D models\n\n## Contents\n\n1. [Introduction](#1)\n1. [Why we check 3D model?](#2)\n1. [About Structual fomula](#3)\n1. [Check 3D molecules on PubChem website](#4)\n1. [Check 3D models on kaggle notebook](#5)\n1. [Points to note for data augmentation with flip](#6)","b06f3a7e":"To solve this problem, we can think of two strategies to start with.\n\n1. Add more rotated data to the training data.\n\n1. Return all test data to the correct (being able to read characters) orientation.\n\nThe strategy1 is a common way, but I expect that some augmentation method may cause bad results. I will explain why.","62e608ac":"<div class=\"alert alert-block alert-warning\">\u2193\u2193\u2193holizontal flip\u2193\u2193\u2193<\/div>","8abf4ee6":"I was curious, so I will focus on the length of InChI. Let's look at the longest and shortest molecules. It's hard to say, but it must be related to the size and complexity of the molecule.","f597e5cf":"We can write 2D model by rdkit.","2c545f1f":"## About this notebook\n\nIn this competiton, we have to detect InChI from [Structual fomula](https:\/\/en.wikipedia.org\/wiki\/Structural_formula) of molecules. You may have learned the structural formulae of simple molecules in school, but in this competition, relatively complex structural formulae will be introduced. Especially since data is given in the form of an image, we may feel free to use standard data augmentation methods like flip, but since molecules are essentially three-dimensional structures, there are pitfalls. To help our understand the characteristics of the data more effectively, we will use 3D model of a molecules to illustrate how to read the given image data.","16d2f4b4":"<a id=\"3\"><\/a> <br>\n# <div class=\"alert alert-block alert-success\">About Structual fomula<\/div> \n\nMolecules are made up of atoms bonded together. A structural formula describes the bonds between atoms. \n\nThere are There are many atoms. Knowing what elements (kinds of atoms) are present is necessary for understanding the structural formula. Check [Periodic table](https:\/\/en.wikipedia.org\/wiki\/Periodic_table) for the types of atoms."}}