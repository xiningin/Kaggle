{"cell_type":{"b2a4928a":"code","7b11a7de":"code","ff9638d2":"code","1a49af64":"code","c924ace2":"code","9f002a41":"code","fac4d9c8":"code","2215bc86":"code","aadb8c43":"code","58358130":"code","a8cc492f":"code","2bbaf81b":"code","854881e3":"code","61521679":"code","0e513d6d":"code","88d30dca":"code","0b1e143f":"code","d6800402":"code","483268eb":"code","0afad23e":"code","e62f8c85":"code","9e71571d":"code","31a54da4":"code","4639ad7f":"code","492a1cd8":"code","a367ef83":"code","f031b943":"code","1ff1d1c1":"code","f8f784d1":"code","0fa3f0db":"markdown","03744aec":"markdown","1fc462e6":"markdown","2e9dc786":"markdown","a5009f2f":"markdown","813565db":"markdown","44c442c8":"markdown"},"source":{"b2a4928a":"# This Python 3 environment comes with many helpful analytics libraries installed\n# It is defined by the kaggle\/python docker image: https:\/\/github.com\/kaggle\/docker-python\n# For example, here's several helpful packages to load in \n\nimport numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\n\n# Input data files are available in the \"..\/input\/\" directory.\n# For example, running this (by clicking run or pressing Shift+Enter) will list all files under the input directory\n\nimport os\nfor dirname, _, filenames in os.walk('\/kaggle\/input'):\n    for filename in filenames:\n        print(os.path.join(dirname, filename))\n\n# Any results you write to the current directory are saved as output.","7b11a7de":"import csv\nimport os\nimport xgboost\n\nimport re\nimport string\nfrom sklearn import ensemble\nfrom sklearn import metrics\n\nimport matplotlib.pyplot as plt\nimport seaborn as sns\n\nimport plotly.express as px\nimport plotly.graph_objs as go\nimport plotly.graph_objects as go\nfrom plotly.subplots import make_subplots\nimport plotly.offline as pyo\npyo.init_notebook_mode()\n\n\nfrom sklearn import preprocessing\nfrom sklearn.metrics import confusion_matrix, roc_auc_score\nfrom sklearn.model_selection import StratifiedKFold, cross_val_score, KFold\nfrom xgboost import XGBClassifier\nimport xgboost as xgb\n\n\ntrain = pd.read_csv(\"..\/input\/covid19-global-forecasting-week-2\/train.csv\")\ntest = pd.read_csv(\"..\/input\/covid19-global-forecasting-week-2\/test.csv\")\ndf_1 = pd.read_csv('https:\/\/raw.githubusercontent.com\/plotly\/datasets\/master\/2014_world_gdp_with_codes.csv')","ff9638d2":"print(train['Date'].min())\nprint(train['Date'].max())\n\nprint(test['Date'].min())\nprint(test['Date'].max())","1a49af64":"train['Date'] = pd.to_datetime(train['Date'])\ntest['Date'] = pd.to_datetime(test['Date'])\n\ntrain['dayofmonth'] = train['Date'].dt.day\ntrain['dayofweek'] = train['Date'].dt.dayofweek\ntrain['month'] = train['Date'].dt.month\ntrain['weekNumber'] = train['Date'].dt.week\ntrain['dayofyear'] = train['Date'].dt.dayofyear\n## added in training set\ntrain['Fatalities_ratio'] = train['Fatalities'] \/ train['ConfirmedCases']\n\n#train['Change_ConfirmedCases'] = train.groupby('Country_Region').ConfirmedCases.pct_change()\n#train['Change_Fatalities'] = train.groupby('Country_Region').Fatalities.pct_change()\n\n## to deal with data wih Province State\ntrain['Change_ConfirmedCases'] = train.groupby(np.where(train['Province_State'].isnull(), train['Country_Region'], train['Province_State'])).ConfirmedCases.pct_change()\ntrain['Change_Fatalities'] = train.groupby(np.where(train['Province_State'].isnull(), train['Country_Region'], train['Province_State'])).Fatalities.pct_change()\n\n## added in Test set\ntest['dayofmonth'] = test['Date'].dt.day\ntest['dayofweek'] = test['Date'].dt.dayofweek\ntest['month'] = test['Date'].dt.month\ntest['weekNumber'] = test['Date'].dt.week\ntest['dayofyear'] = test['Date'].dt.dayofyear","c924ace2":"country_code_list = df_1[['COUNTRY', 'CODE']]\ntrain_join_left = pd.merge(train, country_code_list, left_on='Country_Region', right_on='COUNTRY', how='left')\ntotal_df1 = train_join_left.groupby([\"COUNTRY\",\"CODE\", \"Date\"])[\"ConfirmedCases\", \"Fatalities\"].sum().reset_index()\n\ntotal_df1[\"Date\"] = pd.to_datetime(total_df1[\"Date\"] , format=\"%m\/%d\/%Y\").dt.date\ntotal_df1 = total_df1.sort_values(by=\"Date\").reset_index(drop=True)\nimport datetime\nstart_date = datetime.date(2020,1, 22)\ntotal_df1[\"Date\"] = total_df1[\"Date\"].astype(str)\n\nfig = px.choropleth(total_df1, locations=\"CODE\",\n                    color=\"ConfirmedCases\", \n                    animation_frame=\"Date\",\n                    color_continuous_scale='Blues',\n                    range_color=[0,75000]\n                    #autocolorscale=False,\n                   )\n\n\nfig.update_geos(\n    resolution=50,\n   # showcoastlines=True, coastlinecolor=\"Red\",\n    showland=True, landcolor=\"white\",\n    showocean=True, oceancolor=\"LightBlue\",\n    showlakes=True, lakecolor=\"LightBlue\",\n    showrivers=True, rivercolor=\"LightBlue\"\n)\n\n\n\nlayout = go.Layout(\n    title=go.layout.Title(\n        text=\"Total Confirmed COVID-19 Cases Around The World\",\n        x=0.5\n    ),\n    font=dict(size=12),\n)\n\n\nfig.update_layout(layout\n                 ,height = 500)\nfig.show()","9f002a41":"fig = px.choropleth(total_df1, locations=\"CODE\",\n                    color=\"Fatalities\", \n                    animation_frame=\"Date\",\n                    color_continuous_scale='Greens',\n                    range_color=[0,7000]\n                    #autocolorscale=False,\n                   )\n\nfig.update_geos(\n    resolution=50,\n #   showcoastlines=True, coastlinecolor=\"Red\",\n    showland=True, landcolor=\"white\",\n    showocean=True, oceancolor=\"LightBlue\",\n    showlakes=True, lakecolor=\"LightBlue\",\n    showrivers=True, rivercolor=\"LightBlue\"\n)\n\nlayout = go.Layout(\n    title=go.layout.Title(\n        text=\"Total Fatalities from COVID-19 Around The World\",\n        x=0.5\n    ),\n    font=dict(size=12),\n)\n\nfig.update_layout(layout\n                  , height = 500\n                  #, width = 1000\n                 )\nfig.show()","fac4d9c8":"train.groupby(['Country_Region', 'Province_State'])['ConfirmedCases', 'Fatalities'].mean().reset_index().tail(10)","2215bc86":"cnty_state = train.groupby(['Country_Region','Province_State', 'Date'])['ConfirmedCases', 'Fatalities'].sum().reset_index()\ncnty_state['ratio'] = (cnty_state['Fatalities'] \/ cnty_state['ConfirmedCases']) * 100\ncnty_state.sort_values(\"ratio\", axis = 0, ascending = True, inplace = True, na_position ='first')\ncnty_state.sort_values(\"ratio\", ascending = False).head(10)","aadb8c43":"total_by_date = train.groupby(['Date'])['ConfirmedCases', 'Fatalities'].sum().reset_index().sort_values('Date', ascending = True)\ntotal_by_date['Fatality_ratio'] = total_by_date['Fatalities'] \/ total_by_date['ConfirmedCases']\ntotal_by_date['CC_change_ratio'] = total_by_date['ConfirmedCases'].pct_change()\ntotal_by_date['F_change_ratio'] = total_by_date['Fatalities'].pct_change()\n\nfig = px.line(total_by_date, x=\"Date\", y=\"ConfirmedCases\", title='Total Cases of ')\nfig = px.line(total_by_date, x=\"Date\", y=\"Fatalities\", title='Total Cases of ')\nfig.add_scatter(x=total_by_date['Date'], y=total_by_date['ConfirmedCases'], mode='lines', name=\"Confirmed Cases\", showlegend=True)\nfig.add_scatter(x=total_by_date['Date'], y=total_by_date['Fatalities'], mode='lines', name=\"Fatality\", showlegend=True)\nfig.show()\n","58358130":"fig = px.scatter(total_by_date, x=\"Date\", y=\"ConfirmedCases\")\nfig = px.scatter(total_by_date, x=\"Date\", y=\"Fatalities\")\nfig.add_scatter(x=total_by_date['Date'], y=total_by_date['ConfirmedCases'], mode='lines', name=\"Confirmed Cases\", showlegend=True)\nfig.add_scatter(x=total_by_date['Date'], y=total_by_date['Fatalities'], mode='lines', name=\"Total Fatalities\", showlegend=True)\nfig.show()","a8cc492f":"plt.figure(figsize=(25,15))\n\nexp1= total_by_date['ConfirmedCases'].ewm(span=7, adjust=False).mean()\nexp2= total_by_date['ConfirmedCases'].ewm(span=14, adjust=False).mean()\n\nplt.plot(total_by_date.Date, total_by_date.ConfirmedCases, label='Confirmed Cases')\nplt.plot(total_by_date.Date, exp1, label='Confirmed Cases 7 Days ')\nplt.plot(total_by_date.Date, exp2, label='Confirmed Cases 14 Days ')\nplt.legend(loc='upper left')\nplt.title('Total Confirmed Cases with Exponential Moving Average by 1 week & 2 weeks')\nplt.show()","2bbaf81b":"plt.figure(figsize=(25,15))\n\nexp1_f = total_by_date['Fatalities'].ewm(span=7, adjust=False).mean()\nexp2_f = total_by_date['Fatalities'].ewm(span=14, adjust=False).mean()\n\nplt.plot(total_by_date.Date, total_by_date.Fatalities, label='Total Fatalities')\nplt.plot(total_by_date.Date, exp1_f, label='Confirmed Cases 7 Days ')\nplt.plot(total_by_date.Date, exp2_f, label='Confirmed Cases 14 Days')\nplt.legend(loc='upper left')\nplt.title('Total Fatalities Cases with Exponential Moving Average by 1 week & 2 weeks')\nplt.show()","854881e3":"fig = px.line(total_by_date, x=\"Date\", y=\"CC_change_ratio\", title='Total Cases of ')\nfig = px.line(total_by_date, x=\"Date\", y=\"F_change_ratio\", title='Daily Change by Percentage (Confirmed Case and Fatalities) ')\nfig.add_scatter(x=total_by_date['Date'], y=total_by_date['CC_change_ratio'], mode='lines', name=\"Confirmed Cases % change\", showlegend=True)\nfig.add_scatter(x=total_by_date['Date'], y=total_by_date['F_change_ratio'], mode='lines', name=\"Fatality % change\", showlegend=True)\nfig.show()","61521679":"fig = go.Figure(data=go.Scatter(\n    x=total_by_date['CC_change_ratio'],\n    y=total_by_date['F_change_ratio'],\n    mode='markers',\n    marker=dict(size=[0,10,20,30,40,50,60,70,80, 90,100],\n                color=[0,0.1,0.2,0.3,0.4,0.5,0.6,0.9,1.0])\n))\n\nfig.update_layout(\n    title=\"Bubble plot for change by % for fatalities and confirmed cases\",\n    xaxis_title=\"Confirmed Case % change\",\n    yaxis_title=\"Fatalities % change\",\n    font=dict(\n  #      family=\"Courier New, monospace\",\n        size=15,\n        color=\"#7f7f7f\"\n    )\n)\n\nfig.show()","0e513d6d":"fig = go.Figure(data=go.Scatter(\n    y=total_by_date['CC_change_ratio'],\n    x=total_by_date['F_change_ratio'],\n    mode='markers',\n    marker=dict(size=[0,10,20,30,40,50,60,70,80, 90,100],\n                color=total_by_date['CC_change_ratio'])\n))\n\nfig.update_layout(\n    title=\"Bubble plot for change by % for fatalities and confirmed cases\",\n    yaxis_title=\"Confirmed Case % change\",\n    xaxis_title=\"Fatalities % change\",\n    font=dict(\n  #      family=\"Courier New, monospace\",\n        size=15,\n        color=\"#7f7f7f\"\n    )\n)\nfig.show()","88d30dca":"import plotly.express as px\n#df = px.data.gapminder()\n\nfig = px.scatter(train, x=\"ConfirmedCases\", y=\"Fatalities\",   \n                 color=\"Country_Region\",\n                 hover_name=\"Province_State\", log_x=True, size_max=60)\nfig.show()","0b1e143f":"import plotly.express as px\ndf = px.data.gapminder()\n\nfig = px.scatter(train, x=\"Date\", y=\"ConfirmedCases\",   \n                 color=\"Country_Region\",\n                 hover_name=\"Province_State\"\n                 #, log_x=True, size_max=60\n                )\n                 \nfig.show()","d6800402":"import plotly.express as px\n\nfig = px.scatter(train, y=\"ConfirmedCases\", x=\"Fatalities\",   \n                 color=\"Country_Region\", \n                 log_x=True, size_max=60)\nfig.show()","483268eb":"import plotly.express as px\n\nfig = px.scatter(train.dropna(), y=\"ConfirmedCases\", x=\"Fatalities\",   \n                 color=\"Province_State\",\n                 hover_name=\"Country_Region\", \n                log_x=True, size_max=60\n                )\nfig.show()","0afad23e":"fig = px.bar(train[train['ConfirmedCases'] > 0], x='Country_Region', y='ConfirmedCases',)\nfig.show()","e62f8c85":"plt.figure(figsize=(25,15))\nx = sns.barplot(x=\"Country_Region\", y=\"ConfirmedCases\", data=train[train['ConfirmedCases'] > 0], ci=None)\nx.set_xticklabels(x.get_xticklabels(), rotation=90, horizontalalignment='center')\nplt.title(\"Number of Confirmed Cases by Country between 2020-01-22 - 2020-03-26\", size= 20)\nplt.show()","9e71571d":"plt.figure(figsize=(25,10))\nx = sns.barplot(x=\"Country_Region\", y=\"Fatalities\", data=train[train['Fatalities'] > 0], ci=None)\nx.set_xticklabels(x.get_xticklabels(), rotation=90, horizontalalignment='center')\nplt.title(\"Number of Fatalities by Country between 2020-01-22 - 2020-03-26\", size= 20)\nplt.show()","31a54da4":"train['dayofweek'] = train['Date'].dt.day_name()\n\nplt.figure(figsize=(15,10))\n\nx = sns.barplot(x=\"dayofweek\", y=\"Fatalities\", data=train[train['Country_Region'] == 'Italy'], ci=None)\nx.set_xticklabels(x.get_xticklabels(), rotation=45, horizontalalignment='center')\nplt.title(\"Number of Fatalities by Country between 2020-01-22 - 2020-03-26 in Italy\", size= 20)\nplt.show()","4639ad7f":"plt.figure(figsize=(20,10))\n\nx = sns.barplot(x=\"dayofweek\", y=\"Fatalities\", data=train[train['Country_Region'] == 'US'], ci=None)\nx.set_xticklabels(x.get_xticklabels(), rotation=45, horizontalalignment='center')\nplt.title(\"Number of Fatalities by Country between 2020-01-22 - 2020-03-26 in USA\", size= 20)\n\nplt.show()","492a1cd8":"plt.figure(figsize=(15,10))\n\nx = sns.barplot(x=\"dayofweek\", y=\"Fatalities\", data=train[train['Country_Region'] == 'Iran'], ci=None)\nx.set_xticklabels(x.get_xticklabels(), rotation=45, horizontalalignment='center')\nplt.title(\"Number of Fatalities by Country between 2020-01-22 - 2020-03-26 in IRAN\", size= 20)\n#x.get_xticklabels(rotation=90)\n#plt.xticks(rotation=90)\nplt.show()","a367ef83":"plt.figure(figsize=(15,10))\n\nx = sns.barplot(x=\"dayofweek\", y=\"Fatalities\", data=train[train['Country_Region'] == 'Spain'], ci=None)\nx.set_xticklabels(x.get_xticklabels(), rotation=45, horizontalalignment='center')\nplt.title(\"Number of Fatalities by Country between 2020-01-22 - 2020-03-26 in SPAIN\", size= 20)\nplt.show()","f031b943":"train['dayofweek'] = train['Date'].dt.dayofweek","1ff1d1c1":"from sklearn import preprocessing\nle = preprocessing.LabelEncoder()\nfrom xgboost import XGBRegressor\n\n\ntrain['Country_Region'] = le.fit_transform(train['Country_Region'])\ntrain['Province_State'] = le.fit_transform(train['Province_State'].fillna('0'))\n\ntest['Country_Region'] = le.fit_transform(test['Country_Region'])\ntest['Province_State'] = le.fit_transform(test['Province_State'].fillna('0'))\n\ny1_train = train['ConfirmedCases']\ny2_train = train['Fatalities']\nX_Id = train['Id']\n\nX_train = train.drop(columns=['Id', 'Date','ConfirmedCases', 'Fatalities', 'Fatalities_ratio','Change_ConfirmedCases','Change_Fatalities'])\nX_test  = test.drop(columns=['ForecastId', 'Date'])\n\n\nmodel = xgboost.XGBRegressor(colsample_bytree=0.4,\n                 gamma=0,                 \n                 learning_rate=0.07,\n                 max_depth=3,\n                 min_child_weight=1.5,\n                 n_estimators=10000,                                                                    \n                 reg_alpha=0.75,\n                 reg_lambda=0.45,\n                 subsample=0.6,\n                 seed=42) \n\n\nmodel.fit(X_train, y1_train)\ny1_pred = model.predict(X_test)\n\n\nmodel.fit(X_train, y2_train)\ny2_pred = model.predict(X_test)\n\n\ndf = pd.DataFrame({'ForecastId': test.ForecastId, 'ConfirmedCases': y1_pred, 'Fatalities': y2_pred})\n\n# df.to_csv('submission.csv', index=False)","f8f784d1":"model_xgb_default = XGBRegressor(n_estimators=1000)\nmodel_xgb_default.fit(X_train, y1_train)\ny1_pred_xgb_d = model_xgb_default.predict(X_test)\nmodel_xgb_default.fit(X_train, y2_train)\ny2_pred_xgb_d = model_xgb_default.predict(X_test)\ndf_xgb_d = pd.DataFrame({'ForecastId': test.ForecastId, 'ConfirmedCases': y1_pred_xgb_d, 'Fatalities': y2_pred_xgb_d})\n\n##\ndf_xgb_d.to_csv('submission.csv', index=False)\n","0fa3f0db":"### Grouped by Date and added ratio by running total for visualizations ","03744aec":"## Total Confirmed Cases and Fatalities By Countries On World Map","1fc462e6":"### Exponential Moving Average with 7 days and 14 days average","2e9dc786":"## Training and Fitting the Model","a5009f2f":"## Added new features in train and test sets","813565db":"## Changes ratio between confirmed cases and fatalities","44c442c8":"### Change the day of week (numerical to name) for visualizations"}}