{"cell_type":{"57833e79":"code","92bd1bd4":"code","2c4ef2d9":"code","b3c5d26a":"code","599f0eb8":"code","e3cd0899":"code","e92ae992":"code","09a4e889":"code","a98882ec":"code","62918382":"code","a89ba8da":"code","9e5b47b5":"code","b6519a1c":"code","b5735918":"code","5259dcb0":"code","451610d2":"code","e007f360":"code","2f14bb68":"code","2ef5bd16":"code","0b8cf66e":"code","f835b9d6":"code","8e90160c":"code","9f5897b5":"code","1d25c9a3":"code","9b302104":"code","b99379a3":"code","2c9ef9a9":"code","526411e1":"code","3352d615":"code","11a61f87":"code","df7fc647":"code","f7665853":"code","784e6a05":"code","ddacefb2":"code","f1afc952":"code","7e36cb43":"code","35631642":"code","283be6a8":"code","774abc86":"code","e96db314":"code","8d5cc2c0":"markdown","5465a7e5":"markdown","13b50890":"markdown","a9699831":"markdown","5cb055b7":"markdown","a7880e66":"markdown","1d2c7d59":"markdown","91f60377":"markdown","e575f5c7":"markdown","295616fb":"markdown","c56b64ad":"markdown","57ef8b4a":"markdown","e1d3a40a":"markdown"},"source":{"57833e79":"import glob\nimport numpy as np\nfrom keras.preprocessing.image import load_img,img_to_array\nimport os\nimport matplotlib.pyplot as plt\nimport cv2\nimport pandas as pd\nimport seaborn as sns\nimport sklearn.metrics as metrics\nfrom sklearn.model_selection import cross_val_score\nfrom sklearn.model_selection import train_test_split\nfrom tensorflow.keras.utils import to_categorical","92bd1bd4":"img_size = (224,224)\ndir_name = 'input\/covid19'\nimg_list = glob.glob('..\/' + dir_name + '\/*')\n\nlist_covid = []\nfor img in img_list:\n    temp_img = load_img(img,grayscale=True,target_size=(img_size))\n    temp_img_array = img_to_array(temp_img) \/255\n    list_covid.append(temp_img_array)\nlist_covid = np.array(list_covid)\nlist_covid2 = list_covid.reshape(-1,50176)\ndf_covid=pd.DataFrame(list_covid2)\ndf_covid['label'] = np.full(df_covid.shape[0],2)","2c4ef2d9":"df_covid.shape","b3c5d26a":"img_size = (224,224)\ndir_name2 = 'input\/chest-xray-images-pneumonia-and-covid19\/Chest_xray_image_dataset_covid_19_and_others\/NORMAL'\nimg_list2 = glob.glob('..\/' + dir_name2 + '\/*')\n\nlist_normal = []\nfor img in img_list2[:150]:\n    temp_img = load_img(img,grayscale=True,target_size=(img_size))\n    temp_img_array = img_to_array(temp_img) \/255\n    list_normal.append(temp_img_array)\nlist_normal = np.array(list_normal)\nlist_normal2 = list_normal.reshape(-1,50176)\ndf_normal=pd.DataFrame(list_normal2)\ndf_normal['label'] = np.full(df_normal.shape[0],0)","599f0eb8":"df_normal.shape","e3cd0899":"img_size = (224,224)\ndir_name3 = 'input\/chest-xray-images-pneumonia-and-covid19\/Chest_xray_image_dataset_covid_19_and_others\/PNEUMONIA'\nimg_list3 = glob.glob('..\/' + dir_name3 + '\/*')\n\nlist_others = []\nfor img in img_list3[:150]:\n    temp_img = load_img(img,grayscale=True,target_size=(img_size))\n    temp_img_array = img_to_array(temp_img) \/255\n    list_others.append(temp_img_array)\nlist_others = np.array(list_others)\nlist_others2 = list_others.reshape(-1,50176)\ndf_others=pd.DataFrame(list_others2)\ndf_others['label'] = np.full(df_others.shape[0],1)","e92ae992":"df_others.shape","09a4e889":"f = plt.figure(figsize=(15,7))\nf.suptitle('COVID19',fontsize=20)\nf.subplots_adjust(top=2.35)\nfor i in range(3):\n    sp = f.add_subplot(1,3,i+1)\n    img = cv2.imread(img_list[i])\n    img_gray = cv2.cvtColor(img, cv2.COLOR_RGB2GRAY)\n    plt.tick_params(labelbottom=False,\n                labelleft=False,\n                labelright=False,\n                labeltop=False)\n    plt.imshow(img_gray)\n    plt.gray()\nplt.show()","a98882ec":"f = plt.figure(figsize=(15,7))\nf.suptitle('Other pneumonia',fontsize=20)\nf.subplots_adjust(top=2.25)\nfor i in range(3):\n    sp = f.add_subplot(1,3,i+1)\n    img = cv2.imread(img_list3[i])\n    img_gray = cv2.cvtColor(img, cv2.COLOR_RGB2GRAY)\n    plt.tick_params(labelbottom=False,\n                labelleft=False,\n                labelright=False,\n                labeltop=False)\n    plt.imshow(img_gray)\nplt.gray()\nplt.show()","62918382":"f = plt.figure(figsize=(15,7))\nf.suptitle('Normal',fontsize=20)\nf.subplots_adjust(top=2.4)\nfor i in range(3):\n    sp = f.add_subplot(1,3,i+1)\n    img = cv2.imread(img_list2[i])\n    img_gray = cv2.cvtColor(img, cv2.COLOR_RGB2GRAY)\n    plt.tick_params(labelbottom=False,\n                labelleft=False,\n                labelright=False,\n                labeltop=False)\n    plt.imshow(img_gray)\nplt.gray()\nplt.show()","a89ba8da":"Df = pd.concat([df_covid, df_normal , df_others], ignore_index=True)","9e5b47b5":"x_train, x_test, y_train, y_test = train_test_split(Df.iloc[:,0:-1], Df.iloc[:,-1], test_size=0.20, random_state=0)\n\nX_train = x_train.values.reshape(-1,224,224,1)\nX_test = x_test.values.reshape(-1,224,224,1)\nY_train = to_categorical(y_train)\nY_test = to_categorical(y_test)","b6519a1c":"import os\nimport numpy as np\nimport pandas as pd\nimport seaborn as sns\nimport matplotlib.pyplot as plt\nimport matplotlib.image as mpimg\nimport seaborn as sns\nfrom PIL import Image\nfrom tensorflow.keras.preprocessing import image\nfrom tensorflow.keras.preprocessing.image import load_img, img_to_array\nfrom tensorflow.keras.applications.vgg16 import preprocess_input\nfrom tensorflow.keras.utils import to_categorical\nfrom tensorflow.keras.callbacks import ModelCheckpoint, EarlyStopping\nfrom tensorflow.keras.models import Sequential\nfrom tensorflow.keras.layers import Dense, Dropout, BatchNormalization, Conv2D, MaxPool2D, Flatten\nfrom sklearn.metrics import classification_report, confusion_matrix, accuracy_score","b5735918":"np.random.seed(0)\nmodel = Sequential()\n\nmodel.add(BatchNormalization(input_shape=(224,224,1)))\nmodel.add(Conv2D(16, kernel_size=(3,3), padding='same', activation='relu'))\nmodel.add(MaxPool2D(pool_size=(2,2)))\nmodel.add(Dropout(0.35))\nmodel.add(Flatten())\nmodel.add(Dense(128, activation='relu'))\nmodel.add(Dropout(0.35))\nmodel.add(Dense(3, activation='softmax'))\nmodel.compile(optimizer='adam', loss='categorical_crossentropy', metrics=['accuracy'])","5259dcb0":"model.summary()","451610d2":"model_chkpt = ModelCheckpoint('best_mod.h5', save_best_only=True, monitor='accuracy')\nearly_stopping = EarlyStopping(monitor='loss', restore_best_weights=False, patience=10)","e007f360":"history = model.fit(X_train, Y_train, \n          validation_split=0.20,\n          epochs=10, batch_size=16, shuffle=True, \n          callbacks=[model_chkpt ,early_stopping]\n         )","2f14bb68":"fig, ax = plt.subplots(1,2, figsize=(12, 3))\nax[0].plot(history.history['loss'], color='b', label=\"Training loss\")\nax[0].plot(history.history['val_loss'], color='r', label=\"validation loss\",axes =ax[0])\nlegend = ax[0].legend(loc='best', shadow=True)\n\nax[1].plot(history.history['accuracy'], color='b', label=\"Training accuracy\")\nax[1].plot(history.history['val_accuracy'], color='r',label=\"Validation accuracy\")\nlegend = ax[1].legend(loc='best', shadow=True)","2ef5bd16":"plt.figure()\n\nax = plt.subplot()\n\nax.set_title('Confusion Matrix')\npred = model.predict_classes(X_test)\nY_TEST = np.argmax(Y_test, axis =1)\ncm = metrics.confusion_matrix(Y_TEST,pred)\nclasses=['normal', 'other pneumonia', 'covid19']\nsns.heatmap(cm, annot=True,xticklabels=classes, yticklabels=classes,cmap='Blues')\n\nplt.xlabel('Predicted')\nplt.ylabel('Actual')\nplt.show","0b8cf66e":"from sklearn.metrics import classification_report\nprint(classification_report(Y_TEST, pred))\nprint('normal = 0 , other pneumonia = 1, covid19 = 2')","f835b9d6":"from sklearn.preprocessing import label_binarize\nfrom sklearn.metrics import roc_curve, auc\n\nPRED = to_categorical(pred)\ny = Df['label'].values\n# Binarize the output\ny = label_binarize(y, classes=[0,1,2])\nn_classes = y.shape[1]\n\nfpr = dict()\ntpr = dict()\nroc_auc = dict()\nfor i in range(n_classes):\n       fpr[i], tpr[i], _ = roc_curve(Y_test[:,i], PRED[:,i])\n       roc_auc[i] = auc(fpr[i], tpr[i])","8e90160c":"colors = ['blue', 'red', 'green']\ncls = {0:'normal', 1:'other pneumonia', 2:'covid'}\nfor i, color ,c in zip(range(n_classes), colors, cls.values()):\n    plt.plot(fpr[i], tpr[i], color=color, lw=0.5,\n             label='ROC curve of '+c+ '(AUC = {1:0.2f})'\n             ''.format(i, roc_auc[i]))\nplt.plot([0, 1], [0, 1], 'k--',linestyle='--')\nplt.xlim([-0.05, 1.0])\nplt.ylim([0.0, 1.05])\nplt.xlabel('False Positive Rate')\nplt.ylabel('True Positive Rate')\nplt.title('ROC for multi-class data')\nplt.legend(loc=\"lower right\")\nplt.show()","9f5897b5":"from sklearn.decomposition import PCA\nfrom time import time\n\nn_components = 40\nn_samples=411\nh=224\nw =224\n\nprint(\"Extracting the top %d eigenfaces from %d cases\"\n      % (n_components, x_train.shape[0]))\nt0 = time()\npca = PCA(n_components=n_components, svd_solver='randomized',\n          whiten=True).fit(x_train)\nprint(\"done in %0.3fs\" % (time() - t0))\n\neigenfaces = pca.components_.reshape((n_components, h, w))\n\nprint(\"Projecting the input data on the eigenfaces orthonormal basis\")\nt0 = time()\nX_train_pca = pca.transform(x_train)\nX_test_pca = pca.transform(x_test)\nprint(\"done in %0.3fs\" % (time() - t0))","1d25c9a3":"from sklearn.svm import SVC\nfrom sklearn.model_selection import GridSearchCV\n\nprint(\"Fitting the classifier to the training set\")\nt0 = time()\nparam_grid = {'C': [1, 10, 100,1e3, 5e3, 1e4],\n              'gamma': [0.001, 0.005, 0.01, 0.1], }\nclf = GridSearchCV(\n    SVC(kernel='rbf', class_weight='balanced'), param_grid\n)\nclf = clf.fit(X_train_pca, y_train)\nprint(\"done in %0.3fs\" % (time() - t0))\nprint(\"Best estimator found by grid search:\")\nprint(clf.best_estimator_)","9b302104":"t0 = time()\ny_pred = clf.predict(X_test_pca)\nprint(\"done in %0.3fs\" % (time() - t0))\n\ntarget_names = ['normal','other pneumonia', 'covid']\nn_classes=3\nprint(classification_report(y_test, y_pred, target_names=target_names))\nprint(confusion_matrix(y_test, y_pred, labels=range(n_classes)))","b99379a3":"fig, axes = plt.subplots(3, 8, figsize=(9, 4),\n                         subplot_kw={'xticks':[], 'yticks':[]},\n                         gridspec_kw=dict(hspace=0.1, wspace=0.1))\nfor i, ax in enumerate(axes.flat):\n    ax.imshow(pca.components_[i].reshape(224, 224), cmap='bone')","2c9ef9a9":"from skimage.io import imshow\nloadeigen = eigenfaces[0]\nimshow(loadeigen) ","526411e1":"f = plt.figure(figsize=(15,4))\nf.suptitle('eigenfaces',fontsize=20)\nf.subplots_adjust(top=1)\nfor i in range(5):\n    sp = f.add_subplot(1,5,i+1)\n    plt.tick_params(labelbottom=False,\n                labelleft=False,\n                labelright=False,\n                labeltop=False)\n    loadeigen = eigenfaces[i]\n    imshow(loadeigen) \n    sp.title.set_text('PCA'+str(i+1))\nplt.show()","3352d615":"plt.plot(np.cumsum(pca.explained_variance_ratio_))\nplt.xlabel('number of components')\nplt.ylabel('cumulative explained variance');","11a61f87":"plt.bar([n for n in range(1, len(pca.explained_variance_ratio_)+1)], pca.explained_variance_ratio_)","df7fc647":"pca_2D = PCA(n_components=2).fit_transform(x_train)","f7665853":"pca_2D","784e6a05":"plt.scatter(pca_2D[:,0],pca_2D[:,1], marker=\".\", c=y_train, cmap='jet')\nplt.xlabel(\"PC1\")\nplt.ylabel(\"PC2\")\nplt.show()\n","ddacefb2":"mycolors=[\"r\",\"b\",\"g\"]\nlabelTups = ['normal','other','COVID']\nlabel=y_train\nfor i,mycolor in enumerate(mycolors):\n        plt.scatter(pca_2D[label == i, 0],\n                    pca_2D[label == i, 1], color=mycolor)\n        plt.xlabel(\"PC1\")\n        plt.ylabel(\"PC2\")\n        plt.legend(labelTups, loc='upper right')\nplt.title('PCA(n_component=2)')\nplt.show()","f1afc952":"import pandas as pd\nimport numpy as np\nimport cv2\nfrom keras import backend as K\nfrom keras.preprocessing.image import array_to_img, img_to_array, load_img\nfrom keras.models import load_model\n\nK.set_learning_phase(1) #set learning phase\n\ndef Grad_Cam(input_model, x, layer_name):\n    X = np.expand_dims(x, axis=0)\n    X = X.astype('float32')\n    preprocessed_input = X \/ 255.0\n\n    predictions = model.predict(preprocessed_input)\n    class_idx = np.argmax(predictions[0])\n    class_output = model.output[:, class_idx]\n\n    conv_output = model.get_layer(layer_name).output   \n    grads = K.gradients(class_output, conv_output)[0]  \n    gradient_function = K.function([model.input], [conv_output, grads])  \n\n    output, grads_val = gradient_function([preprocessed_input])\n    output, grads_val = output[0], grads_val[0]\n\n    weights = np.mean(grads_val, axis=(0, 1))\n    cam = np.dot(output, weights)\n\n    cam = cv2.resize(cam, (224, 224), cv2.INTER_LINEAR) \n    cam = np.maximum(cam, 0) \n    cam = cam \/ cam.max()\n\n    jetcam = cv2.applyColorMap(np.uint8(255 * cam), cv2.COLORMAP_JET)  \n    jetcam = cv2.cvtColor(jetcam, cv2.COLOR_BGR2RGB)  \n    jetcam = (np.float32(jetcam) + x \/ 2)   \n\n    return jetcam","7e36cb43":"x = img_to_array(load_img(img_list[0],grayscale=True, target_size=(224,224)))\narray_to_img(x)","35631642":"image = Grad_Cam(model, x, 'conv2d') \narray_to_img(image)","283be6a8":"from sklearn.ensemble import RandomForestClassifier\nestimator = RandomForestClassifier(n_estimators=1000)\nestimator.fit(x_train, y_train)","774abc86":"importances = estimator.feature_importances_\nimportances = importances.reshape(224,224)","e96db314":"plt.matshow(importances, cmap=plt.cm.hot)\nplt.title(\"Pixel importances\")\nplt.tick_params(length=0)\nplt.xticks(color=\"None\")\nplt.yticks(color=\"None\")\nplt.show()","8d5cc2c0":"PCA visualize","5465a7e5":"pixel importance","13b50890":"NORMAL","a9699831":"other PNEUMONIA","5cb055b7":"making Database","a7880e66":"show x-ray","1d2c7d59":"using eigenfaces","91f60377":"multiclass ROC","e575f5c7":"train-validation split","295616fb":"classification report","c56b64ad":"class activation maps","57ef8b4a":"CNN","e1d3a40a":"**COVID**"}}