{"cell_type":{"ad0e7d88":"code","53181bc1":"code","a25264b4":"code","c9cabe00":"code","cea9d8ab":"code","a53ae3e8":"code","6e7a027b":"code","537f1cf6":"code","3729ce5c":"code","dc74d702":"code","75c7fdf9":"code","9aa99c3c":"code","d1539db1":"code","d09818f3":"code","97325bf9":"code","f7275507":"code","443419cb":"markdown","8a1ba635":"markdown","aa563a98":"markdown","a17e86c5":"markdown","d40c50e7":"markdown","7281e23a":"markdown","6af9d667":"markdown","6615b5d4":"markdown","8dd58f13":"markdown","ea158395":"markdown","9b5e9a1a":"markdown","2ab37d85":"markdown","bb53febb":"markdown","c2823f7a":"markdown","878761cd":"markdown"},"source":{"ad0e7d88":"# Loading necessary libraries\n\nimport numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\nfrom sklearn.model_selection import train_test_split\nfrom sklearn.ensemble import RandomForestClassifier\nfrom sklearn.model_selection import train_test_split\nfrom matplotlib import pyplot as plt\n%matplotlib inline\n\n\nimport os\nfor dirname, _, filenames in os.walk('\/kaggle\/input'):\n    for filename in filenames:\n        print(os.path.join(dirname, filename))\n\nimport warnings\nwarnings.filterwarnings(\"ignore\")      ","53181bc1":"# Reading in the data\ndf = pd.read_csv('..\/input\/pima-indians-diabetes-database\/diabetes.csv')\ndf.head()\n","a25264b4":"df.info()","c9cabe00":"# Creating the target and the features column and splitting the dataset into test and train set.\n\nX = df.iloc[:, :-1]\ny = df.iloc[:, -1]\n\nX_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.25, random_state=0)","cea9d8ab":"# Training and fitting a Random Forest Model\nmy_model = RandomForestClassifier(n_estimators=100,\n                                  random_state=0).fit(X_train, y_train)","a53ae3e8":"# Calculating and Displaying importance using the eli5 library\nimport eli5\nfrom eli5.sklearn import PermutationImportance\n\nperm = PermutationImportance(my_model, random_state=1).fit(X_test,y_test)\neli5.show_weights(perm, feature_names = X_test.columns.tolist())","6e7a027b":"# training and fitting a Decision Tree\nfrom sklearn.tree import DecisionTreeClassifier\nfeature_names = [i for i in df.columns]\ntree_model = DecisionTreeClassifier(random_state=0).fit(X_train, y_train)","537f1cf6":"feature_names = ['Pregnancies', 'Glucose', 'BloodPressure', 'SkinThickness', 'Insulin',\n       'BMI', 'DiabetesPedigreeFunction', 'Age']","3729ce5c":"# Let's plot a decision tree source : #https:\/\/www.kaggle.com\/willkoehrsen\/visualize-a-decision-tree-w-python-scikit-learn\n# Since there are a lot of attributes, it is difficult to actually make sense of the decision tree graph in this notebook. \n# It is advised to export it as png and view it.\n\nfrom sklearn import tree\nimport graphviz\n\ntree_graph = tree.export_graphviz(tree_model, out_file=None, feature_names=feature_names,filled = True)\ngraphviz.Source(tree_graph)","dc74d702":"\nfrom pdpbox import pdp, get_dataset, info_plots\n\n# Create the data that we will plot\npdp_goals = pdp.pdp_isolate(model=tree_model, dataset=X_test, model_features=feature_names, feature='Glucose')\n\n# plot it\npdp.pdp_plot(pdp_goals, 'Glucose')\nplt.show()","75c7fdf9":"# Create the data that we will plot\npdp_goals = pdp.pdp_isolate(model=tree_model, dataset=X_test, model_features=feature_names, feature='Insulin')\n\n# plot it\npdp.pdp_plot(pdp_goals, 'Insulin')\nplt.show()","9aa99c3c":"features_to_plot = ['Glucose','Insulin']\ninter1  =  pdp.pdp_interact(model=tree_model, dataset=X_test, model_features=feature_names, features=features_to_plot)\n\npdp.pdp_interact_plot(pdp_interact_out=inter1, feature_names=features_to_plot, plot_type='contour', plot_pdp=True)\nplt.show()","d1539db1":"row_to_show = 10\ndata_for_prediction = X_test.iloc[row_to_show]  # use 1 row of data here. Could use multiple rows if desired\ndata_for_prediction_array = data_for_prediction.values.reshape(1, -1)\n\ntree_model.predict_proba(data_for_prediction_array)","d09818f3":"import shap  # package used to calculate Shap values\n\n# Create object that can calculate shap values\nexplainer = shap.TreeExplainer(tree_model)\n\n# Calculate Shap values\nshap_values = explainer.shap_values(data_for_prediction)","97325bf9":"shap.initjs()\nshap.force_plot(explainer.expected_value[1], shap_values[1], data_for_prediction)","f7275507":"import shap  # package used to calculate Shap values\n\n# Create object that can calculate shap values\nexplainer = shap.TreeExplainer(tree_model)\n\n# calculate shap values. This is what we will plot.\n# Calculate shap_values for all of val_X rather than a single row, to have more data for plot.\nshap_values = explainer.shap_values(X_test)\n\n# Make plot. Index of [1] is explained in text below.\nshap.summary_plot(shap_values[1],X_test)","443419cb":"SHAP values are calculated using the [Shap](https:\/\/github.com\/slundberg\/shap) library which can be installed easily from PyPI or conda. SHAP values interpret the impact of having a certain value for a given feature in comparison to the prediction we\u2019d make if that feature took some baseline value.\n\n\n","8a1ba635":"**We can also visualize the partial dependence of two features at once using 2D Partial plots.**","aa563a98":"## References :\n* [Interpretable Machine Learning: A Guide for Making Black Box Models Explainable.Christoph Molnar](https:\/\/christophm.github.io\/interpretable-ml-book\/)\n* [Machine Learning Explainability Micro Course: Kaggle](https:\/\/www.kaggle.com\/learn\/machine-learning-explainability)","a17e86c5":"# Extracting human understandable insights from any Machine Learning model\n\n![](https:\/\/miro.medium.com\/max\/639\/1*tX9jrdkCZm3jPqG0rWXwOQ.png)\n[Source: interpretable-ml-book](https:\/\/christophm.github.io\/interpretable-ml-book\/terminology.html)\n\nIn his book [\u2018Interpretable Machine Learning\u2019](https:\/\/christophm.github.io\/interpretable-ml-book\/), Christoph Molnar beautifully encapsulates the essence of ML interpretability through this example: Imagine you are a Data Scientist and in your free time you try to predict where your friends will go on vacation in the summer based on their facebook and twitter data you have. Now, if the predictions turn out to be accurate, your friends might be impressed and could consider you to be a magician who could see the future.\n\n\nIf the predictions are wrong, it would still bring no harm to anyone except to your reputation of being a \u201cData Scientist\u201d. Now let\u2019s say it wasn\u2019t a fun project and there were investments involved. Say, you wanted to invest in properties where your friends were likely to holiday. What would happen if the model\u2019s predictions went awry?You would lose money. As long as the model is having no significant impact, it\u2019s interpretability doesn\u2019t matter so much but when there are implications involved based on a model\u2019s prediction, be it financial or social, interpretability becomes relevant.\n\n# Table of Contents\n\n- Importance of interpretability\n- Model Explainability techniques\n- Permutation Importance using ELI5 library\n- Partial Dependence Plots\n- SHAP Values\n- Advanced Uses of SHAP Values\n- SHAP Summary Plots\n\n\n\n## Importance of interpretability\n\nThe question that some of the people often ask is why aren\u2019t we just content with the results of the model and why are we so hell-bent on knowing why a particular decision was made? A lot of this has to do with the impact that a model might have in the real world. For models which are merely meant to recommend movies will have a far less impact than the ones created to predict the outcome of a drug.\n\n![](https:\/\/miro.medium.com\/max\/1000\/0*IWLWbvl2xUJLD-va.png)\n\n[The big picture of explainable machine learning.](https:\/\/christophm.github.io\/interpretable-ml-book\/agnostic.html)","d40c50e7":"The library to be used for plotting PDPs is called  **python partial dependence plot toolbox** or simply [**PDPbox**]. \nPDPs are also calculated after a model has been fit. In our dataset there are a lot of features like Glucose, BLood Pressure, Age etc. We start by considering a single row. \n\nWe proceed by fitting our model and calculating the probability of a person having diabetes which is our target variable. Next, we would choose a variable and continuously alter its value. For instance, we will calculate the outcome if the person's insulin level is 50,100,150 and so on. All these values are then plotted and we get a graph of predicted  vs actual outcome.(https:\/\/pdpbox.readthedocs.io\/en\/latest\/)","7281e23a":"Some of the  [benefits that interpretability](https:\/\/www.kaggle.com\/dansbecker\/use-cases-for-model-insights)  brings along are:\n\n-   **Reliability**\n-   **Debugging**\n-   **Informing feature** **engineering**\n-   **Directing future data collection**\n-   **Informing human decision-making**\n-   **Building** **Trust**\n\n\n# Model Explainability techniques\n\nLet\u2019s discuss a  few  techniques which help in extracting the above insights from a model:\n\n\n## Objective\n\nThe objective of the notebook is to use techniques to explain how different features have different effect on the prediction whether or not a patient has diabetes, based on certain diagnostic measurements.\n\n\n\n","6af9d667":"**Interpretation**\n\n-   The Y-axis represents the change in prediction from what it would be predicted at the baseline or leftmost value.\n-   Blue area denotes the confidence interval\n-   For the \u2018Glucose\u2019 graph, we  observe  that probability of a person having diabetes steeply increases as the glucose level goes beyond 140 and then the probability remains high. \n\n","6615b5d4":"# 4. Advanced Uses of SHAP Values\n\nAggregating  many SHAP values can provide even more detailed insights into the model.\n\n-   **SHAP Summary Plots**\n\nTo get an overview of which features are most important for a model we can plot the SHAP values of every feature for every sample. The summary plot tells which features are most important, and also their range of effects over the dataset.","8dd58f13":"# 2. Partial Dependence Plots\n\nThe partial dependence plot (short PDP or PD plot) shows the marginal effect one or two features have on the predicted outcome of a machine learning model( [J. H. Friedman 2001](https:\/\/statweb.stanford.edu\/~jhf\/ftp\/trebst.pdf)). PDPs show how a feature affects predictions. PDP can show the relationship between the target and the selected features via 1D or 2D plots.\n\n","ea158395":"# 3. SHAP Values\n\nSHAP which stands for **SH**apley **A**dditive ex**P**lanation, helps to break down a prediction to show the impact of each feature. It is based on Shapley values, a technique used in game theory to determine how much each player in a collaborative game has contributed to its success[\u00b9](https:\/\/medium.com\/civis-analytics\/demystifying-black-box-models-with-shap-value-analysis-3e20b536fc80). Normally, getting the trade-off between accuracy and interpretability just right can be a difficult balancing act but SHAP values can deliver both.\n\nSHAP values interpret the impact of having a certain value for a given feature in comparison to the prediction we\u2019d make if that feature  took  some baseline value.\n\nShap values show how much a given feature changed our prediction (compared to if we made that prediction at some baseline value of that feature). Let\u2019s say we wanted to know what was the prediction when the insulin level was 150 instead of some fixed baseline no. If we are able to answer this, we could perform the same steps for other features as follows:\n\n`sum(SHAP values for all features) = pred_for_team - pred_for_baseline_values`","9b5e9a1a":"For every dot:\n\n-   Vertical location shows what feature it is depicting\n-   Color shows whether that feature was high or low for that row of the dataset\n-   Horizontal location shows whether the effect of that value caused a higher or lower prediction.\n\nThe point in the upper left was depicts a person whose glucose level is less thereby reducing the prediction of diabetes by 0.4.\n","2ab37d85":"**Interpretation**\n\nThe above explanation shows features each contributing to push the model output from the base value (the average model output over the training dataset we passed) to the model output. Features pushing the prediction higher are shown in red, those pushing the prediction lower are in blue\n\n-   The base_value here is 0.3576 while our predicted value is 1.\n-   `Glucose`  = 158 has the biggest impact on increasing the prediction, while\n-   `Age`  feature has the biggest effect in decreasing the prediction.","bb53febb":"**Interpretation**\n\n-   The features at the top are most important and at the bottom, the least. For this example, 'Glucose level' is the most important feature which decides whether a person will have diabetes, which also makes sense.\n-   The number after the  **\u00b1**  measures how performance varied from one-reshuffling to the next.\n-   Some weights are negative. This is because in those cases predictions on the shuffled data  were  found to be more accurate than the real data.\n","c2823f7a":"# Conclusion\n\nMachine Learning doesn\u2019t have to be a black box anymore. What use is a good model if we cannot explain the results to others. Interpretability is as important as creating a model.  To achieve wider acceptance among the population, it is crucial that Machine learning systems are able to provide satisfactory explanations for their decisions.  As Albert Einstein said,\u201d **If you can\u2019t explain** it simply, **you** don\u2019t understand it well enough\u201d.\n","878761cd":"# 1. Permutation Importance using ELI5 library\n\nWhat features does a model think are important?  Which features might have a greater impact on the model predictions than the others?  This concept is called feature importance and **Permutation** **Importance** is a technique used widely for calculating feature importance.  It helps us to see when our model produces  counterintuitive  results, and it helps to show the others when our model is working as we\u2019d hope.\n\nPermutation Importance works for many scikit-learn estimators. The idea is simple: Randomly permutate or shuffle a single column in the validation dataset leaving all the other columns intact.  A feature is considered \u201cimportant\u201d if the model\u2019s accuracy drops a lot and causes an increase in error. On the other hand, a feature is considered \u2018unimportant\u2019 if shuffling its values don\u2019t affect the model\u2019s accuracy.\n\n* Permutation importance is useful useful for debugging, understanding your model, and communicating a high-level overview from your model.\n\n* Permutation  importance is calculated  after a model has been fitted. So, let\u2019s train and fit a  **RandomForestClassifier**  model denoted as  **my_model**  on the training data.\n\n* * Permutation Importance is calculated using the **ELI5 library**.  [**ELI5**](https:\/\/github.com\/TeamHG-Memex\/eli5) is a Python library which allows to visualize and debug various Machine Learning models using unified API. It has built-in support for several ML frameworks and provides a way to explain black-box models.\n"}}