{"cell_type":{"eaab519f":"code","a7bf76bf":"code","da619af2":"code","5293b7e3":"code","84257ad0":"code","e85cf727":"code","80da4614":"code","4cc268e6":"code","8010c8a9":"code","ebdd836b":"code","17db9009":"code","407f8ad6":"code","44886fbe":"code","19691d0b":"code","5394aa11":"code","149b7750":"code","5ce7720b":"code","703e1c83":"code","da4ae351":"code","ae10a8be":"code","faed0155":"code","00355061":"code","abcafa35":"code","c348d5a5":"code","eaca045b":"code","2a7de6c1":"code","711a0c9d":"markdown","e36f15cf":"markdown"},"source":{"eaab519f":"import pandas as pd\nimport numpy as np\n#lightgbm\nimport lightgbm as lgb","a7bf76bf":"tourney_result = pd.read_csv('..\/input\/google-cloud-ncaa-march-madness-2020-division-1-mens-tournament\/MDataFiles_Stage1\/MNCAATourneyCompactResults.csv')\ntourney_seed = pd.read_csv('..\/input\/google-cloud-ncaa-march-madness-2020-division-1-mens-tournament\/MDataFiles_Stage1\/MNCAATourneySeeds.csv')","da619af2":"tourney_result = tourney_result.drop(['DayNum', 'WScore', 'LScore', 'WLoc', 'NumOT'], axis=1)\ntourney_result\ntourney_result = pd.merge(tourney_result, tourney_seed, left_on=['Season', 'WTeamID'], right_on=['Season', 'TeamID'], how='left')\ntourney_result.rename(columns={'Seed':'WSeed'}, inplace=True)\ntourney_result = tourney_result.drop('TeamID', axis=1)\ntourney_result = pd.merge(tourney_result, tourney_seed, left_on=['Season', 'LTeamID'], right_on=['Season', 'TeamID'], how='left')\ntourney_result.rename(columns={'Seed':'LSeed'}, inplace=True)\ntourney_result = tourney_result.drop('TeamID', axis=1)\ntourney_result","5293b7e3":"# Get String\ndef get_seed(x):\n    return int(x[1:3])\n\ntourney_result['WSeed'] = tourney_result['WSeed'].map(lambda x: get_seed(x))\ntourney_result['LSeed'] = tourney_result['LSeed'].map(lambda x: get_seed(x))\ntourney_result","84257ad0":"season_result = pd.read_csv('..\/input\/google-cloud-ncaa-march-madness-2020-division-1-mens-tournament\/MDataFiles_Stage1\/MRegularSeasonCompactResults.csv')","e85cf727":"season_win_result = season_result[['Season', 'WTeamID', 'WScore']]\nseason_lose_result = season_result[['Season', 'LTeamID', 'LScore']]\nseason_win_result.rename(columns={'WTeamID':'TeamID', 'WScore':'Score'}, inplace=True)\nseason_lose_result.rename(columns={'LTeamID':'TeamID', 'LScore':'Score'}, inplace=True)\nseason_result = pd.concat((season_win_result, season_lose_result)).reset_index(drop=True)\nseason_result","80da4614":"season_score = season_result.groupby(['Season', 'TeamID'])['Score'].sum().reset_index()\nseason_score","4cc268e6":"tourney_result = pd.merge(tourney_result, season_score, left_on=['Season', 'WTeamID'], right_on=['Season', 'TeamID'], how='left')\ntourney_result.rename(columns={'Score':'WScoreT'}, inplace=True)\ntourney_result = tourney_result.drop('TeamID', axis=1)\ntourney_result = pd.merge(tourney_result, season_score, left_on=['Season', 'LTeamID'], right_on=['Season', 'TeamID'], how='left')\ntourney_result.rename(columns={'Score':'LScoreT'}, inplace=True)\ntourney_result = tourney_result.drop('TeamID', axis=1)\ntourney_result\n#WScoreT is Score in this year","8010c8a9":"tourney_win_result = tourney_result.drop(['Season', 'WTeamID', 'LTeamID'], axis=1)\ntourney_win_result.rename(columns={'WSeed':'Seed1', 'LSeed':'Seed2', 'WScoreT':'ScoreT1', 'LScoreT':'ScoreT2'}, inplace=True)\ntourney_win_result","ebdd836b":"tourney_lose_result = tourney_win_result.copy()\ntourney_lose_result['Seed1'] = tourney_win_result['Seed2']\ntourney_lose_result['Seed2'] = tourney_win_result['Seed1']\ntourney_lose_result['ScoreT1'] = tourney_win_result['ScoreT2']\ntourney_lose_result['ScoreT2'] = tourney_win_result['ScoreT1']\ntourney_lose_result","17db9009":"tourney_win_result['Seed_diff'] = tourney_win_result['Seed1'] - tourney_win_result['Seed2']\ntourney_win_result['ScoreT_diff'] = tourney_win_result['ScoreT1'] - tourney_win_result['ScoreT2']\ntourney_lose_result['Seed_diff'] = tourney_lose_result['Seed1'] - tourney_lose_result['Seed2']\ntourney_lose_result['ScoreT_diff'] = tourney_lose_result['ScoreT1'] - tourney_lose_result['ScoreT2']","407f8ad6":"tourney_win_result['result'] = 1\ntourney_lose_result['result'] = 0\ntourney_result = pd.concat((tourney_win_result, tourney_lose_result)).reset_index(drop=True)\ntourney_result","44886fbe":"test_df = pd.read_csv('..\/input\/google-cloud-ncaa-march-madness-2020-division-1-mens-tournament\/MSampleSubmissionStage1_2020.csv')\ntest_df['Season'] = test_df['ID'].map(lambda x: int(x[:4]))\ntest_df['WTeamID'] = test_df['ID'].map(lambda x: int(x[5:9]))\ntest_df['LTeamID'] = test_df['ID'].map(lambda x: int(x[10:14]))\ntest_df\n","19691d0b":"test_df = pd.merge(test_df, tourney_seed, left_on=['Season', 'WTeamID'], right_on=['Season', 'TeamID'], how='left')\ntest_df.rename(columns={'Seed':'Seed1'}, inplace=True)\ntest_df = test_df.drop('TeamID', axis=1)\ntest_df = pd.merge(test_df, tourney_seed, left_on=['Season', 'LTeamID'], right_on=['Season', 'TeamID'], how='left')\ntest_df.rename(columns={'Seed':'Seed2'}, inplace=True)\ntest_df = test_df.drop('TeamID', axis=1)\ntest_df = pd.merge(test_df, season_score, left_on=['Season', 'WTeamID'], right_on=['Season', 'TeamID'], how='left')\ntest_df.rename(columns={'Score':'ScoreT1'}, inplace=True)\ntest_df = test_df.drop('TeamID', axis=1)\ntest_df = pd.merge(test_df, season_score, left_on=['Season', 'LTeamID'], right_on=['Season', 'TeamID'], how='left')\ntest_df.rename(columns={'Score':'ScoreT2'}, inplace=True)\ntest_df = test_df.drop('TeamID', axis=1)\ntest_df","5394aa11":"test_df['Seed1'] = test_df['Seed1'].map(lambda x: get_seed(x))\ntest_df['Seed2'] = test_df['Seed2'].map(lambda x: get_seed(x))\ntest_df['Seed_diff'] = test_df['Seed1'] - test_df['Seed2']\ntest_df['ScoreT_diff'] = test_df['ScoreT1'] - test_df['ScoreT2']\ntest_df = test_df.drop(['ID', 'Pred', 'Season', 'WTeamID', 'LTeamID'], axis=1)\ntest_df","149b7750":"# data split(Kfold)\n# \u30d1\u30e9\u30e1\u30bf\u30c1\u30e5\u30fc\u30cb\u30f3\u30b0\u306f\u30d9\u30a4\u30ba\u6700\u9069\u5316hyperopt\u306a\u3069\u3092\u7528\u3044\u3066\u884c\u3048\u308b.\n#\u3000\u307e\u305a\u306fCV\u3067\u5e73\u5747\u3092\u63d0\u51fa\u3059\u308b\nfrom sklearn.model_selection import KFold\nfrom sklearn.metrics import log_loss\nfrom sklearn.model_selection import GridSearchCV","5ce7720b":"grid_param ={'n_estimators':[100,500,1000,2000],\n             'max_depth':[4,8,16,32,-1],\n             'num_leaves': [8,16,31],\n             'eta':[0.2,0.1,0.05,0.01],\n            }\n\nX = tourney_result.drop(\"result\", axis = 1)\ny = tourney_result.result\n\nfit_params={'early_stopping_rounds':50, \n            'eval_set' : [(X, y)]\n           }\n\n\n#\u5404\u3005\u306e\u5024\u306e\u8a2d\u5b9a\nscores = []\nbst =  lgb.LGBMClassifier(boosting_type = \"gbdt\",\n    objective=\"binary\")","703e1c83":"# To view the default model params:\nbst.get_params().keys()","da4ae351":"bst_gs_cv = GridSearchCV(estimator=bst, \n                   param_grid=grid_param, \n                   scoring='neg_log_loss',\n                   cv=KFold(n_splits = 5, shuffle = True, random_state = 50), \n                   n_jobs=-1,\n                   verbose=2,\n                   )\nbst_gs_cv.fit(\n            X, \n            y,\n            **fit_params,\n            verbose = 0\n            )\n\nbest_param = bst_gs_cv.best_params_","ae10a8be":"best_param","faed0155":"#\u53cd\u6620\u3055\u305b\u308b\nkf = KFold(n_splits = 5, shuffle = True, random_state = 50)\nparams = {\"objective\": \"binary\", \n          \"seed\": 50, \n          \"verbose\": 0, \n          \"metrics\":\"binary_logloss\",\n          \"eta\": 0.2,\n          \"max_depth\": 4,\n          \"num_leaves\": 8}\nnum_round = 100","00355061":"sub_preds = np.zeros(test_df.shape[0])","abcafa35":"#KFold(n_splits = 5)\u3092\u7528\u3044\u3066\u30c7\u30fc\u30bf\u5206\u3051\u308b\n#\u30e2\u30c7\u30eb\u306e\u4f5c\u6210\nfor tr_id, va_id in kf.split(X):\n    tr_x, va_x  = X.iloc[tr_id], X.iloc[va_id]\n    tr_y, va_y  = y.iloc[tr_id], y.iloc[va_id]\n    lgb_train = lgb.Dataset(tr_x,tr_y)\n    lgb_eval = lgb.Dataset(va_x,va_y)\n    model = lgb.train(params, lgb_train, num_boost_round = num_round,\n                                 valid_names = [\"train\",\"valid\"],valid_sets = [lgb_train, lgb_eval],\n                     early_stopping_rounds=50)\n    \n    #\u30b9\u30b3\u30a2\u78ba\u8a8d\n    va_pred = model.predict(va_x)\n    score = log_loss(va_y, va_pred)\n    scores.append(score)\n    sub_preds += model.predict(test_df)\n    \nsub_preds \/= 5\nprint(f\"logloss:{np.mean(scores):.4f}\")","c348d5a5":"# to submit\nsubmission_df = pd.read_csv('..\/input\/google-cloud-ncaa-march-madness-2020-division-1-mens-tournament\/MSampleSubmissionStage1_2020.csv')\nsubmission_df['Pred'] = sub_preds\nsubmission_df","eaca045b":"submission_df['Pred'].hist()","2a7de6c1":"submission_df.to_csv('submission.csv', index=False)","711a0c9d":"## Introduction\n\n","e36f15cf":"Data preprocessing  is based on [This Kernel.](https:\/\/www.kaggle.com\/ratan123\/march-madness-2020-ncaam-simple-lightgbm-on-kfold)\nThank you!!\n\nMain purpose of this kernel is to build GBDT.\nIf I make a mistake, please let me know in the comments.\n(Sorry for poor English...)\n\n\n\n2020\/3\/9 Attempt to use GridSearch...\n\n2020\/2\/10 more GridSearch"}}