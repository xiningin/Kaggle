{"cell_type":{"751b8ff5":"code","c892ee11":"code","29e1f59b":"code","e36b6fbe":"code","4ec7277e":"code","93853821":"code","18c14f6d":"code","fe2c2a6f":"code","422f45e6":"code","426e06a2":"code","c357fb29":"code","4ca85bf9":"code","457dc568":"code","f93f204f":"code","95e17367":"code","c94c3bb0":"code","e3ced5de":"code","da717132":"code","05c87fd6":"code","958b9730":"code","a188d90a":"code","7b49b58e":"code","8ef88526":"code","4e27316c":"code","a5435a37":"code","c7b72c2a":"code","dd30d64a":"code","2853c395":"code","74c52bcd":"code","5bafa32b":"code","344ae766":"code","9dbad491":"code","cd604e26":"code","ec6b7bf1":"code","11ff16fd":"code","018546f7":"code","7a3bb7cc":"code","0b931781":"code","02b414c5":"code","b9df43e5":"code","a6b348ac":"code","dd2b0fff":"code","b45279a6":"code","d2957a30":"code","e54facbc":"markdown","b2d37457":"markdown","50f6385d":"markdown","7043e87a":"markdown","723397f8":"markdown","39767acc":"markdown","f1099f22":"markdown","132ff424":"markdown","179896c0":"markdown","026084be":"markdown"},"source":{"751b8ff5":"# This Python 3 environment comes with many helpful analytics libraries installed\n# It is defined by the kaggle\/python docker image: https:\/\/github.com\/kaggle\/docker-python\n# For example, here's several helpful packages to load in \n\nimport numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\n\n# Input data files are available in the \"..\/input\/\" directory.\n# For example, running this (by clicking run or pressing Shift+Enter) will list the files in the input directory\nimport glob\nimport shutil\nimport os\nimport gc\nimport pathlib\nprint(os.listdir(\"..\/input\/\"))\n%reload_ext autoreload\n%autoreload 2\n%matplotlib inline\n# Any results you write to the current directory are saved as output.","c892ee11":"from fastai.imports import *\nfrom fastai.transforms import *\nfrom fastai.conv_learner import *\nfrom fastai.model import *\nfrom fastai.dataset import *\nfrom fastai.sgdr import *\nfrom fastai.plots import *","29e1f59b":"torch.cuda.is_available()","e36b6fbe":"torch.backends.cudnn.enabled","4ec7277e":"dog_indexes = []\ncat_indexes = []\ncount = 0\ncat_count = 1\ndog_count = 1","93853821":"for name in os.listdir('..\/input\/dogs-vs-cats-redux-kernels-edition\/train\/'):\n    if 'cat' in name and cat_count <= 8000:\n        cat_indexes.append(name.split('.')[1])\n        cat_count += 1\n    if 'dog' in name and dog_count <= 8000:\n        dog_indexes.append(name.split('.')[1])\n        dog_count += 1\n    if dog_count > 8000 and cat_count > 8000:\n        break","18c14f6d":"print ('Dog!\\n',len(dog_indexes), '\\nCat!\\n', len(cat_indexes))","fe2c2a6f":"cat_val_list = random.sample(cat_indexes, 1200)\ndog_val_list = random.sample(dog_indexes, 1200)","422f45e6":"os.makedirs('..\/working\/dogcats\/valid\/cats\/')\nos.makedirs('..\/working\/dogcats\/valid\/dogs\/')\nos.makedirs('..\/working\/dogcats\/train\/cats\/')\nos.makedirs('..\/working\/dogcats\/train\/dogs\/')\nos.makedirs('..\/working\/dogcats\/test\/')","426e06a2":"train_dir = \"..\/input\/dogs-vs-cats-redux-kernels-edition\/train\/\"\ntest_dir = \"..\/input\/dogs-vs-cats-redux-kernels-edition\/test\/\"\ncat_train_dir = \"..\/working\/dogcats\/train\/cats\/\"\ncat_valid_dir = \"..\/working\/dogcats\/valid\/cats\/\"\ndog_train_dir = \"..\/working\/dogcats\/train\/dogs\/\"\ndog_valid_dir = \"..\/working\/dogcats\/valid\/dogs\/\"\ndogcats_test = \"..\/working\/dogcats\/test\/\"","c357fb29":"PATH = \"..\/working\/dogcats\/\"\nsz=224","4ca85bf9":"for jpgfile in iglob(os.path.join(train_dir, \"cat*.jpg\")):\n    if count >= 8000:\n        break\n    count += 1\n    if jpgfile.split('.')[3] in cat_val_list:\n        shutil.copy(jpgfile, cat_valid_dir)\n    else:\n        shutil.copy(jpgfile, cat_train_dir)\n\ncount = 0\n\nfor jpgfile in iglob(os.path.join(train_dir, \"dog*.jpg\")):\n    if count >= 8000:\n        break\n    count += 1\n    if jpgfile.split('.')[3] in dog_val_list:\n        shutil.copy(jpgfile, dog_valid_dir)\n    else:\n        shutil.copy(jpgfile, dog_train_dir)\n        ","457dc568":"for jpgfile in iglob(os.path.join(test_dir, \"*.jpg\")):\n    shutil.copy(jpgfile, dogcats_test)","f93f204f":"cache_dir = os.path.expanduser(os.path.join('~', '.torch'))\nif not os.path.exists(cache_dir):\n    os.makedirs(cache_dir)\nmodels_dir = os.path.join(cache_dir, 'models')\nif not os.path.exists(models_dir):\n    os.makedirs(models_dir)","95e17367":"!cp ..\/input\/resnet34\/resnet34.pth \/tmp\/.torch\/models\/resnet34-333f7ec4.pth","c94c3bb0":"gc.collect()","e3ced5de":"tfms = tfms_from_model(resnet34, sz, aug_tfms=transforms_side_on, max_zoom=1.1)","da717132":"arch=resnet34","05c87fd6":"data = ImageClassifierData.from_paths(PATH, tfms=tfms, test_name='test')\nlearn = ConvLearner.pretrained(arch, data, precompute=True)","958b9730":"learn.fit(1e-2, 1)","a188d90a":"learn.precompute=False","7b49b58e":"learn.fit(1e-2, 3, cycle_len=1)","8ef88526":"learn.sched.plot_lr()","4e27316c":"gc.collect()","a5435a37":"learn.unfreeze()","c7b72c2a":"lr=np.array([1e-4,1e-3,1e-2])","dd30d64a":"learn.fit(lr, 3, cycle_len=1, cycle_mult=2)","2853c395":"learn.sched.plot_lr()","74c52bcd":"log_preds,y = learn.TTA()\nprobs = np.mean(np.exp(log_preds),0)","5bafa32b":"accuracy_np(probs, y)","344ae766":"preds = np.argmax(probs, axis=1)\nprobs = probs[:,1]","9dbad491":"temp = learn.predict(is_test=True)","cd604e26":"temp.shape","ec6b7bf1":"pred_test = np.argmax(temp, axis=1)","11ff16fd":"pred_test[:20]","018546f7":"probs = np.exp(temp[:,1])","7a3bb7cc":"probs[:10]","0b931781":"os.listdir(f'{PATH}test')[:4]","02b414c5":"submission = pd.DataFrame({'id':os.listdir(f'{PATH}test'), 'label':probs})","b9df43e5":"! rm -rf ..\/working\/dogcats\/","a6b348ac":"submission['id'] = submission['id'].map(lambda x: x.split('.')[0])","dd2b0fff":"submission['id'] = submission['id'].astype(int)","b45279a6":"submission = submission.sort_values('id')","d2957a30":"submission.to_csv('..\/working\/output.csv', index=False)","e54facbc":"**Transfer Learning**","b2d37457":"**Randomly sampling indexes to add images to Validation set. Make changes to validation set if required.**","50f6385d":"**Only moving 8000 images of each class due to size constraints. Make changes if required.**","7043e87a":"**Folders to store the images in format that will allow to run fastai algorithms**","723397f8":"**Begin Training**","39767acc":"**Data Augmentation**","f1099f22":"**Creation of submission CSV**","132ff424":"**Indexes for Validation**","179896c0":"# Important\n\n**I have used only 16000 of the available 25000 images of the training data due to kaggle kernel limitations of Disk space. Please make the necessary changes in the code if you want to train on the complete dataset.**\n\n**I realize this is not a well explained kernel, but I primarily wrote this to verify if it was possible to come up with an end-to-end solution using fastai inside kaggle kernels**","026084be":"**Prediction on Test Data**"}}