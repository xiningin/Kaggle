{"cell_type":{"016a3b09":"code","8898eb29":"code","390114bb":"code","93b36c47":"code","decdc092":"code","f511ba67":"code","6556bbc0":"code","fd62d9cb":"code","98e698d1":"markdown","f13c09de":"markdown","319e8f30":"markdown","a5a8a9a2":"markdown","aa15cf48":"markdown"},"source":{"016a3b09":"import ipywidgets as widgets\n\nimport plotly.graph_objects as go\nfrom plotly.subplots import make_subplots\nimport plotly\n\nimport pandas as pd\nimport numpy as np","8898eb29":"data_dir = '..\/input\/optiver-realized-volatility-prediction\/'\n\ndef preprocessor(stock_id):   \n    file_path_book = data_dir + \"book_train.parquet\/stock_id=\" + str(stock_id)\n    file_path_trade = data_dir + \"trade_train.parquet\/stock_id=\" + str(stock_id)\n    \n    book_df = pd.read_parquet(file_path_book)\n    trade_df = pd.read_parquet(file_path_trade)\n    \n    return book_df, trade_df","390114bb":"def calc_wap1(df):\n    wap = (df['bid_price1'] * df['ask_size1'] + df['ask_price1'] * df['bid_size1']) \/ (df['bid_size1'] + df['ask_size1'])\n    return wap\n\ndef log_return(series):\n    return np.log(series).diff()\n\ndef realized_volatility(series):\n    return np.sqrt(np.sum(series**2))","93b36c47":"train_df = pd.read_csv('..\/input\/optiver-realized-volatility-prediction\/train.csv')\ndf_stock_ids = train_df['stock_id'].unique()\ndf_time_ids = train_df[train_df['stock_id'] == 0].time_id.unique()\nbook_df, trade_df = preprocessor(stock_id=0)","decdc092":"stock_selector = widgets.Dropdown(options=df_stock_ids, description='stock_id')\ntime_selector = widgets.Dropdown(options=df_time_ids, description='time_id')\n\ndef update_stock_data(*args):\n    global book_df, trade_df\n    book_df, trade_df = preprocessor(stock_selector.value)\n    time_selector.options = book_df.time_id.unique()\n    \nstock_selector.observe(update_stock_data, 'value')","f511ba67":"def plot_stock_by_time_plotly(stock_id, time_id, price_shape='hv', volume_shape='hv'):\n    fig = make_subplots(rows=3, cols=1, shared_xaxes=True, row_heights = [3, 1, 1], vertical_spacing=0.04, \n                        subplot_titles=['Price', 'Volume', 'Realized Volatility'])\n    price_colors = ['green', 'lime', 'pink', 'red']\n    \n    # Book data\n    selected_book_data = book_df[book_df.time_id == time_id].copy()\n    selected_book_data['wap1'] = calc_wap1(selected_book_data)\n    size_data = selected_book_data[['bid_size2', 'bid_size1', 'ask_size1', 'ask_size2']]\n\n    x = selected_book_data.seconds_in_bucket\n    for ci, col in enumerate(['bid_price2', 'bid_price1', 'ask_price1', 'ask_price2']):\n        size_info = size_data.iloc[:, ci].astype(str)\n        fig.add_scatter(x=x, y=selected_book_data[col], name=col, legendgroup = 'price', line_shape=price_shape, customdata=size_info, row=1, col=1,\n                        hovertemplate='%{y:.6f}, size: %{customdata}')\n    fig.add_scatter(x=x, y=selected_book_data['wap1'], name='wap1', legendgroup='price', line_shape=price_shape,\n                    line=dict(color='blue', width=0.5), row=1, col=1)\n\n    for ci, col in enumerate(['bid_size2', 'bid_size1', 'ask_size1', 'ask_size2']):\n        fig.add_scatter(x=x, y=selected_book_data[col], name=col, stackgroup='volume', legendgroup='volume', line=dict(width=0),\n                        fillcolor=price_colors[ci], line_shape=volume_shape, row=2, col=1)\n    \n    # Volatility\n    min_periods_for_volty = 20\n    selected_book_data['actual_realzd_volty'] = selected_book_data['wap1'].agg(log_return).expanding(min_periods=min_periods_for_volty).apply(realized_volatility)\n    selected_book_data['weighted_realzd_volty'] = selected_book_data['actual_realzd_volty'] * np.sqrt(600 \/ selected_book_data['seconds_in_bucket'])\n    target = train_df.query('stock_id == @stock_id & time_id == @time_id').target.item()\n\n    fig.add_scatter(x=x, y=selected_book_data['actual_realzd_volty'], name='real_volty', legendgroup='volatility', line_color='blue', row=3, col=1)\n    fig.add_scatter(x=x, y=selected_book_data['weighted_realzd_volty'], name='w_real_volty', legendgroup='volatility', line_color='purple', row=3, col=1)\n    fig.add_scatter(x=[601], y=[target], name='target', legendgroup='volatility', line_color='red', row=3, col=1)\n\n    # Trade data\n    selected_trade_data = trade_df[trade_df.time_id == time_id]\n    x = selected_trade_data.seconds_in_bucket\n    trade_size_info = selected_trade_data.loc[:, 'size'].astype(str)\n    fig.add_scatter(x=x, y=selected_trade_data['price'], name=f'trade_price', mode='markers', line_color='brown', marker_size=6, legendgroup='price',\n                   customdata=trade_size_info, hovertemplate='%{y:.6f}, size: %{customdata}')\n    fig.add_bar(x=x, y=-selected_trade_data['size'], name=f'trade_size', marker_color='brown', legendgroup = 'volume', row=2, col=1, \n                customdata=trade_size_info, hovertemplate='%{customdata}')\n    \n    # Line shape (interpolation) menus\n    menu_x = 1.015\n    def line_shape_menu(traces, options, order):\n        return dict(buttons=[dict(args=[{\"line.shape\": op}, traces], label=op_label, method='restyle') for op, op_label in options],\n                    direction=\"down\", pad={\"r\": 10, \"t\": 0}, showactive=True, x=menu_x, y=0.7-0.4*order, xanchor=\"left\", yanchor=\"top\")\n    updatemenus = [line_shape_menu(traces, [('hv', 'HV (actual)'), ('linear', 'Linear')], i) \n                   for i, traces in enumerate([[0, 1, 2, 3, 4], [5, 6, 7, 8]])]\n    for order, menu_label, in enumerate(['Price interpolation', 'Volume interpolation']):\n        fig.add_annotation(**dict(text=menu_label, x=menu_x, y=0.7-0.4*order, xref='paper', yref='paper', xanchor='left', yanchor=\"top\", yshift=20, showarrow=False))\n    \n    # Title and layout updates\n    book_recs, trade_recs = selected_book_data.shape[0], selected_trade_data.shape[0]\n    fig.update_layout(title=dict(text=f'stock_id={stock_id}, time_id={time_id}  |  book records: {book_recs}, trade_records: {trade_recs}', \n                                 font_size=15, x=0.15, xanchor='left'), \n                      height=600, margin=dict(l=20, r=20, t=40, b=20), legend_tracegroupgap=124,\n                      colorway=price_colors, \n                      updatemenus=updatemenus,\n                      hovermode=\"x unified\", hoverdistance=1\n                     )\n    fig.update_annotations(dict(x=0.01, xanchor='left', font_size=12, ), selector={'x': 0.5})    # Subplot titles moved to the left\n    fig.update_xaxes(range=[-5, 606], title=dict(text='seconds_in_bucket', font_size=10, standoff=0))\n    fig.update_traces(xaxis='x3')\n    fig.show()","6556bbc0":"# This cell is purely for Viewer Mode demonstration of what a chart looks like. \n# Delete it when editing the notebook to remove duplicate chart and speed up plotting.\n\n# This line makes plotly chart visible in Viewer mode, but slows down plotting in kernel:\nplotly.offline.init_notebook_mode(connected=True) \nplot_stock_by_time_plotly(stock_id=0, time_id=5)","fd62d9cb":"# This cell displays the chart along with dropdown lists for selecting stock_id and time_id via ipywidgets.\n# However, it works only when running the kernel, so the outputs are invisible in Viewer Mode\nui1 = widgets.HBox([stock_selector, time_selector])\nout = widgets.interactive_output(plot_stock_by_time_plotly, dict(stock_id=stock_selector, time_id=time_selector));\ndisplay(ui1, out)","98e698d1":"## Plotting function:","f13c09de":"The **Price** subplot is pretty much self-explanatory. Hover to see corresponding volume sizes as well.\n\nOn the **Volume** subplot, above zero are stacked volumes from the book (adding up to a total volume on two closest levels), while the trade sizes are looking in the opposite direction.\n\n**Realized Volatility** is displayed in two ways: \n1. As is, growing monotonously with expanding window (hardcoded minimum values for calculation: 20)\n2. Multiplied by a \u0441oefficient of $\\sqrt{\\frac{600}{seconds\\_in\\_bucket}}$ to adjust for time window duration.\n\n---\nIf you have any suggestions on how to improve this visualization, please share in the comments!","319e8f30":"# Charts","a5a8a9a2":"Here's my attempt to visualize the input data next to its target in a convienient interactive way with **plotly** and **ipywidgets**.\n\nThis notebook requires an active kernel for processing different **stock_id** and **time_id** data, so click \"Copy and Edit\" to play with data selection dropdown lists. I believe it's possible to rewrite the code and acquire preprocessed data with **plotly** dropdown menus instead of **ipywidgets**, but it seems like too much work for now.\n\nEnjoy!","aa15cf48":"# Data preparation"}}