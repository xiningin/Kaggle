{"cell_type":{"3a57fd4b":"code","ca886ce8":"code","fdae3b21":"code","6b283e14":"code","f1f2e75b":"code","89023076":"code","d6cf8f30":"code","7376a69b":"code","f1d0e133":"code","de4b603d":"code","fe521bed":"code","80873355":"code","69035434":"code","f6092971":"code","57d182e7":"code","d9188473":"code","b22c2c6a":"code","2de61066":"code","fb7dc32d":"code","0c32bc59":"code","c905adf2":"code","b3c57ceb":"code","b96744bc":"code","c5ce6361":"code","33353b83":"code","0e9f06b3":"code","20572956":"code","6e9a5183":"code","669965ff":"code","81df29a9":"code","6a13f059":"code","df2bde52":"code","a8d78da9":"code","bfaa7539":"code","a15ea9cc":"code","6e32370a":"code","96f4edd0":"code","83464311":"code","89fc4fc5":"code","c4fb3540":"code","df936129":"code","aa226d0a":"code","fb100110":"code","2dafe57d":"code","479bf2a4":"code","e3478a88":"code","afb41061":"code","78144272":"code","2dc36438":"code","eab67551":"code","b730a2a3":"code","911486d8":"code","61d96e71":"code","4137495d":"code","ecaf7617":"code","15e1abd1":"code","31c7ca28":"code","61ae920e":"code","ee44fd63":"code","a65ad1e8":"code","7a1e69ae":"code","d334a228":"code","929414d5":"markdown","7ea2dec9":"markdown","75ecc916":"markdown","8f6a7f30":"markdown","d78be22e":"markdown","e341682e":"markdown","06d27d9d":"markdown","23c9bb5d":"markdown"},"source":{"3a57fd4b":"import numpy as np\nimport pandas as pd\nimport matplotlib.pyplot as plt","ca886ce8":"def load_data(filename, path='..\/input\/ncaaw-march-mania-2021\/WDataFiles_Stage2\/', **kwargs):\n    return pd.read_csv(f\"{path}\/{filename}\", **kwargs)","fdae3b21":"reg_df = load_data(\"WRegularSeasonDetailedResults.csv\")\ntourney_df = load_data(\"WNCAATourneyDetailedResults.csv\")\n\nreg_df['is_tourney'] = False\ntourney_df['is_tourney'] = True\n\ndf = pd.concat([reg_df, tourney_df]).reset_index(drop=True)","6b283e14":"teams = load_data(\"WTeams.csv\")\nid_to_team = dict(teams[['TeamID', 'TeamName']].values)\ndf[\"WTeamName\"] = df.WTeamID.map(id_to_team)\ndf[\"LTeamName\"] = df.LTeamID.map(id_to_team)","f1f2e75b":"seeds = load_data('WNCAATourneySeeds.csv')\nseeds['seed_num'] = seeds.Seed.apply(lambda x: int(x[1:3]))\n\n\ndf = df.merge(seeds[['Season', 'TeamID', 'seed_num']].rename(columns={'seed_num': 'WTeam_seed', 'TeamID': 'WTeamID'}),\n                how='left', on=['Season', 'WTeamID'])\ndf = df.merge(seeds[['Season', 'TeamID', 'seed_num']].rename(columns={'seed_num': 'LTeam_seed', 'TeamID': 'LTeamID'}),\n                how='left', on=['Season', 'LTeamID'])","89023076":"conf = load_data('WTeamConferences.csv')\n\ndf = df.merge(conf.rename(columns={'ConfAbbrev': 'WTeam_ConfAbbrev', 'TeamID': 'WTeamID'}),\n                how='left', on=['Season', 'WTeamID'])\ndf = df.merge(conf.rename(columns={'ConfAbbrev': 'LTeam_ConfAbbrev', 'TeamID': 'LTeamID'}),\n                how='left', on=['Season', 'LTeamID'])","d6cf8f30":"power_confs = ['acc', 'big_east', 'sec', 'big_ten', 'big_twelve', 'pac_ten', 'pac_twelve']\ndf['WTeam_power_conf'] = df.WTeam_ConfAbbrev.isin(power_confs)\ndf['LTeam_power_conf'] = df.LTeam_ConfAbbrev.isin(power_confs)\n\ndf['diff_power_conf'] = df.WTeam_power_conf.astype(np.int) - df.LTeam_power_conf.astype(np.int)\ndf.diff_power_conf.value_counts()","7376a69b":"# Womens version\ndef get_round(row):\n    season = row['Season']\n    day_num = row['DayNum']\n    if season >= 2017:\n        if day_num <= 136:\n            return 0 # reg season\n        if day_num <= 138:\n            return 1\n        if day_num <= 140:\n            return 2\n        if day_num <= 145:\n            return 3\n        if day_num <= 147:\n            return 4\n        if day_num <= 151:\n            return 5\n        if day_num <= 153:\n            return 6\n    if season >= 2015 and season <= 2016:\n        if day_num <= 136:\n            return 0 # first four\n        if day_num <= 138:\n            return 1\n        if day_num <= 140:\n            return 2\n        if day_num <= 145:\n            return 3\n        if day_num <= 147:\n            return 4\n        if day_num <= 153:\n            return 5\n        if day_num <= 155:\n            return 6\n        \n    if season >= 2003 and season <= 2014:\n        if day_num <= 137:\n            return 0 # first four\n        if day_num <= 139:\n            return 1\n        if day_num <= 141:\n            return 2\n        if day_num <= 146:\n            return 3\n        if day_num <= 148:\n            return 4\n        if day_num <= 153:\n            return 5\n        if day_num <= 155:\n            return 6\n        \n    if season >= 1998 and season <= 2002:\n        if day_num <= 136:\n            return 0 # first four\n        if day_num <= 138:\n            return 1\n        if day_num <= 140:\n            return 2\n        if day_num <= 145:\n            return 3\n        if day_num <= 147:\n            return 4\n        if day_num <= 151:\n            return 5\n        if day_num <= 153:\n            return 6\n    \ndf['round_num'] = None\ndf.loc[df.is_tourney, 'round_num'] = df.loc[df.is_tourney].apply(get_round, axis=1)","f1d0e133":"df['WTeam_won'] = True","de4b603d":"# https:\/\/kenpom.com\/blog\/the-possession\/\n# https:\/\/kenpom.com\/blog\/ratings-glossary\/\nY = 0.475\ndf['W_est_possesions'] = (df.WFGA - df.WOR) + df.WTO + (Y * df.WFTA)\ndf['L_est_possesions'] = (df.LFGA - df.LOR) + df.LTO + (Y * df.LFTA)\n","fe521bed":"df[['W_est_possesions', 'L_est_possesions']].mean(axis=0)","80873355":"df['score_margin'] = df.WScore - df.LScore\ndf['home_court'] = df.WLoc.map({'H': 1.0, 'N': 0.0, 'A': -1.0})\n#df[\"Season_WTeamID\"] = df.apply(lambda row: f\"{row.Season}-{row.WTeamID}\", axis=1)\n#df[\"Season_LTeamID\"] = df.apply(lambda row: f\"{row.Season}-{row.LTeamID}\", axis=1)\ndf['score_margin_per_poss'] = df.score_margin \/ df[['W_est_possesions', 'L_est_possesions']].mean(axis=1)\ndf['log_score_margin_per_poss'] = np.log(df.score_margin_per_poss)\ndf.head()","69035434":"df['W_scoring_off'] = df.WScore \/ df.W_est_possesions\ndf['L_scoring_off'] = df.LScore \/ df.L_est_possesions\n\ndf['W_scoring_off_denom'] = df.W_est_possesions\ndf['L_scoring_off_denom'] = df.L_est_possesions\n","f6092971":"# log(WOR) = log(W_coeff) + log(L_coeff)\n\n#df['W_off_reb_rate'] = df.WOR \/ (df.WOR + df.LDR)\n#df['W_def_reb_rate'] = df.WDR \/ (df.WDR + df.LOR)\n\ndf['W_reb_off'] = df.WOR \/ (df.WOR + df.LDR)\ndf['L_reb_off'] = df.LOR \/ (df.WDR + df.LOR)\n\ndf['W_reb_off_denom'] = (df.WOR + df.LDR)\ndf['L_reb_off_denom'] = (df.WDR + df.LOR)","57d182e7":"df['W_3pt_off_denom'] = df.WFGA3\ndf['L_3pt_off_denom'] = df.LFGA3\n\ndf['W_3pt_off'] = (df.WFGM3 \/ df.W_3pt_off_denom).fillna(0)\ndf['L_3pt_off'] = (df.LFGM3 \/ df.L_3pt_off_denom).fillna(0)","d9188473":"df['W_draw_foul_off'] = df.LPF \/ (df.W_est_possesions + df.L_est_possesions)\ndf['L_draw_foul_off'] = df.WPF \/ (df.W_est_possesions + df.L_est_possesions)\n\ndf['W_draw_foul_off_denom'] = (df.W_est_possesions + df.L_est_possesions)\ndf['L_draw_foul_off_denom'] = (df.W_est_possesions + df.L_est_possesions)","b22c2c6a":"# Weighted decay param\n\nlam = .01\narr= 133 - np.array([0, 66, 126, 133])\nnp.exp(-lam * arr)","2de61066":"from sklearn.linear_model import LinearRegression, SGDRegressor, BayesianRidge, ElasticNet\nfrom sklearn.model_selection import train_test_split\n\nkenpom_ratings = {}\nconsistency_ratings = {}\nall_metrics = ['reb', '3pt', 'draw_foul', 'scoring', 'scoring_weighted']\n\nfor metric in all_metrics:\n    print(metric)\n    weighted = metric.endswith('_weighted')\n    kenpom_ratings[metric] = {}\n    consistency_ratings[metric] = {}\n    for season in range(2010, 2022):\n        print(season)\n\n        season_df = df[(~df.is_tourney) & (df.Season==season)]\n        win_one_hot = pd.get_dummies(season_df.WTeamID)\n        loss_one_hot = pd.get_dummies(season_df.LTeamID)\n        team_ids = list(set(win_one_hot.columns).union(loss_one_hot.columns))\n        \n        win_one_hot = win_one_hot.reindex(columns=team_ids, fill_value=0)\n        loss_one_hot = loss_one_hot.reindex(columns=team_ids, fill_value=0)\n        \n        \n        a1 = pd.concat([\n                win_one_hot.rename(columns={c: f\"{c}_off\" for c in win_one_hot.columns}),\n                loss_one_hot.rename(columns={c: f\"{c}_def\" for c in loss_one_hot.columns})\n            ], axis=1)\n        a1['offense_home_court'] = season_df.home_court\n        a1['offense_won'] = True\n        a1['offense_team'] = season_df.WTeamID\n        a1['defense_team'] = season_df.LTeamID\n        \n        a2 = pd.concat([\n                loss_one_hot.rename(columns={c: f\"{c}_off\" for c in loss_one_hot.columns}),\n                win_one_hot.rename(columns={c: f\"{c}_def\" for c in win_one_hot.columns})\n            ], axis=1)\n        a2['offense_home_court'] = -season_df.home_court\n        a2['offense_won'] = False\n        a2['offense_team'] = season_df.LTeamID\n        a2['defense_team'] = season_df.WTeamID\n        \n        one_hot = pd.concat([a1, a2], axis=0)\n\n        season_df = season_df.join(one_hot)\n        num_teams = len(team_ids)\n\n        features = [f\"{team_id}_off\" for team_id in team_ids] + [f\"{team_id}_def\" for team_id in team_ids] + ['offense_home_court']\n        X = season_df[features]\n        y = np.zeros(len(X))\n        \n        metric_name = metric.replace('_weighted', '')\n        y[season_df.offense_won] = season_df.loc[season_df.offense_won, f'W_{metric_name}_off']\n        y[~season_df.offense_won] = season_df.loc[~season_df.offense_won, f'L_{metric_name}_off']\n        \n        reg = LinearRegression(fit_intercept=False)\n        \n        weights = np.zeros(len(X))\n        weights[season_df.offense_won] = season_df.loc[season_df.offense_won, f'W_{metric_name}_off_denom']\n        weights[~season_df.offense_won] = season_df.loc[~season_df.offense_won, f'L_{metric_name}_off_denom']\n        \n        if weighted:\n            season_end_date = 133\n            weights *= np.exp(-lam * (season_end_date - season_df.DayNum)).values.reshape(-1)\n\n        reg.fit(X, y, sample_weight=weights)\n\n        mean_off_strength = reg.coef_[:num_teams].mean()\n        mean_def_strength = reg.coef_[num_teams:num_teams*2].mean()\n        mean_strengths = np.array([mean_off_strength]*num_teams + [mean_def_strength]*num_teams)\n        kenpom_ratings[metric][season] = {\n            team_id: score\n            for (score, team_id) in zip(reg.coef_[:num_teams*2] - mean_strengths, features[:num_teams*2])\n        }\n        kenpom_ratings[metric][season]['home_court'] = reg.coef_[-1]\n        \n        # Consistency ratings = avg sq residual when trying to predict performance on off or def\n        # Higher rating = less consistent \/ harder to predict\n        residuals = (y - reg.predict(X))\n        season_df['sq_residual'] = residuals * residuals\n        \n        consistency_ratings[metric][season] = {\n            **{f'{k}_off': v for k,v in season_df.groupby(\"offense_team\").sq_residual.mean().to_dict().items()},\n            **{f'{k}_def': v for k,v in season_df.groupby(\"defense_team\").sq_residual.mean().to_dict().items()}\n}\n","fb7dc32d":"for metric in all_metrics:\n    print(metric)\n    for team in ['WTeam', 'LTeam']:\n        for side in ['off', 'def']:\n            df[f'{team}_{metric}_{side}_efficiency'] = df.apply(\n                lambda row: kenpom_ratings[metric][row.Season][f\"{row[f'{team}ID']}_{side}\"], axis=1)\n            df[f'{team}_{metric}_{side}_consistency'] = df.apply(\n                lambda row: consistency_ratings[metric][row.Season][f\"{row[f'{team}ID']}_{side}\"], axis=1)\n    \n    \n    # Positive values = advantage Winning team offense has vs Losing team defense\n    df[f'W_off_L_def_{metric}_efficiency_diff'] = df[f'WTeam_{metric}_off_efficiency'] + df[f'LTeam_{metric}_def_efficiency']\n    # Positive values = advantage Losing team offense has vs Winning team defense\n    df[f'W_def_L_off_{metric}_efficiency_diff'] = df[f'WTeam_{metric}_def_efficiency'] + df[f'LTeam_{metric}_off_efficiency']\n    ","0c32bc59":"df.loc[df.is_tourney, ['W_off_L_def_scoring_efficiency_diff', 'W_def_L_off_scoring_efficiency_diff',\n                       'WTeamName', 'LTeamName', 'WTeam_won']].sort_values(\n'W_off_L_def_scoring_efficiency_diff', ascending=False).head()","c905adf2":"for metric in all_metrics:\n    df[f'WTeam_{metric}_overall_efficiency'] = df[f'WTeam_{metric}_off_efficiency'] - df[f'WTeam_{metric}_def_efficiency']\n    df[f'LTeam_{metric}_overall_efficiency'] = df[f'LTeam_{metric}_off_efficiency'] - df[f'LTeam_{metric}_def_efficiency']\n    df[f'diff_{metric}_overall_efficiency'] = df[f'WTeam_{metric}_overall_efficiency'] - df[f'LTeam_{metric}_overall_efficiency']\n    ","b3c57ceb":"[kenpom_ratings['scoring'][i]['home_court'] for i in range(2010, 2022)]","b96744bc":"metrics = ['WTeam_scoring_overall_efficiency', 'WTeam_scoring_weighted_overall_efficiency']\ndf[df.Season<=2021][[\n    'Season', 'WTeamName', *metrics, 'score_margin_per_poss', 'WTeam_seed'\n]].groupby(['Season', 'WTeamName']).mean().sort_values(metrics, ascending=False).reset_index().head(100)","c5ce6361":"for metric in all_metrics:\n    df[df.is_tourney].plot.scatter(f'W_off_L_def_{metric}_efficiency_diff', 'score_margin_per_poss', s=10)\n    df[df.is_tourney].plot.scatter(f'W_def_L_off_{metric}_efficiency_diff', 'score_margin_per_poss', s=10)","33353b83":"# Calculate team FT percentages\n\nft_temp = df[['Season', 'WTeamID', 'WFTA', 'WFTM']].copy().rename(columns={\n    'WTeamID': 'TeamID',\n    'WFTA': 'FTA',\n    'WFTM': 'FTM',\n})\nft_temp2 = df[['Season', 'LTeamID', 'LFTA', 'LFTM']].copy().rename(columns={\n    'LTeamID': 'TeamID',\n    'LFTA': 'FTA',\n    'LFTM': 'FTM',\n})\n\nft_pcts = pd.concat([ft_temp, ft_temp2]).groupby(['Season', 'TeamID']).apply(lambda group: group.FTM.sum() \/ group.FTA.sum())\n\ndf['WTeam_ft_pct'] = df.apply(lambda row: ft_pcts.loc[row.Season, row.WTeamID], axis=1)\ndf['LTeam_ft_pct'] = df.apply(lambda row: ft_pcts.loc[row.Season, row.LTeamID], axis=1)\ndf['diff_ft_pct'] = df.WTeam_ft_pct - df.LTeam_ft_pct\n","0e9f06b3":"df.WTeam_ft_pct.hist(bins=100)\ndf.LTeam_ft_pct.hist(bins=100)","20572956":"seed_strengths = df[df.LTeam_seed.notnull()].drop_duplicates(\n    subset=['Season', 'LTeamID']).groupby('LTeam_seed').LTeam_scoring_overall_efficiency.mean().to_dict()\n\ndf['seed_strength_diff'] = df.WTeam_seed.map(seed_strengths) - df.LTeam_seed.map(seed_strengths)","6e9a5183":"arr = np.array([0, 1, 2, 3, 4, 5, 6, 7])\nround_decay_lam = .02\nnp.exp(-round_decay_lam * arr)\n\ndf['round_decayed_diff_scoring_overall_efficiency'] = df['diff_scoring_overall_efficiency'] * np.exp(\n    -round_decay_lam * df['round_num'].fillna(0)\n)\n","669965ff":"df['interaction__diff_3pt_overall_efficiency__diff_reb_overall_efficiency'] = (\n    df.diff_reb_overall_efficiency * df.diff_3pt_overall_efficiency\n)\n\ndf['interaction__diff_scoring_weighted_overall_efficiencyy__diff_3pt_overall_efficiency'] = (\n    df.diff_scoring_weighted_overall_efficiency * df.diff_3pt_overall_efficiency\n)\n\ndf['interaction__diff_scoring_weighted_overall_efficiency__diff_reb_overall_efficiency'] = (\n    df.diff_scoring_weighted_overall_efficiency * df.diff_reb_overall_efficiency\n)","81df29a9":"from sklearn.pipeline import Pipeline\nfrom sklearn.impute import SimpleImputer\nfrom sklearn.preprocessing import StandardScaler\nfrom sklearn.linear_model import LogisticRegression, LinearRegression\nfrom sklearn.ensemble import GradientBoostingClassifier, GradientBoostingRegressor\nfrom sklearn.metrics import log_loss\n\nfeatures = [\n    'diff_scoring_weighted_overall_efficiency',\n    'diff_3pt_overall_efficiency',\n    'diff_draw_foul_overall_efficiency'\n]\n\n\n\n\nX = df.loc[:, features].copy()\ny = df.loc[:, 'score_margin'].copy()\n\n\nidxes = np.array(df.index.copy())\nnp.random.seed(42)\nnp.random.shuffle(idxes)\nidxes = idxes[int(len(idxes)\/2): ]\n\nnegate_features = [f for f in features if f.startswith('diff') or f.endswith('diff')]\nX.loc[idxes, negate_features] = -X.loc[idxes, negate_features]\ny.loc[idxes] = -y.loc[idxes]\n\n\n\nX_train = X.loc[df.is_tourney]\ny_train = y.loc[df.is_tourney]\n\n# Eval against 2019 only\nif False:\n    year = 2019\n    X_train = X.loc[(df.is_tourney) & (df.Season!=year)]\n    y_train = y.loc[(df.is_tourney) & (df.Season!=year)]\n    X_test = X.loc[(df.is_tourney) & (df.Season==year)]\n    y_test = y.loc[(df.is_tourney) & (df.Season==year)]\n    \nelse:\n    X_train, X_test, y_train, y_test = train_test_split(X_train, y_train, test_size=0.1, random_state=41)\n\nclf = LinearRegression(fit_intercept=False)\n\npipe = Pipeline([\n    ('imputer', SimpleImputer(missing_values=np.nan, strategy='mean')),\n    ('scaler', StandardScaler()),\n    ('clf', clf)\n])\n\npipe.fit(X_train, y_train)\n\npipe2 = Pipeline([\n    ('scaler', StandardScaler()),\n    ('clf', LogisticRegression(random_state=42))\n])\n\n\npred_train= pipe.predict(X_train)\nconsistency_train = df.loc[X_train.index, ['WTeam_scoring_weighted_off_consistency', 'WTeam_scoring_weighted_def_consistency',\n                       'LTeam_scoring_weighted_off_consistency', 'LTeam_scoring_weighted_def_consistency'\n                      ]].mean(axis=1).values\n\npreds_with_consistency = np.concatenate([\n    pred_train.reshape(-1, 1),\n    (pred_train \/ (consistency_train**1)).reshape(-1, 1)\n], axis=1)\n\npipe2.fit(preds_with_consistency, y_train > 0)\n","6a13f059":"pred_test = pipe.predict(X_test)\nconsistency_test = df.loc[X_test.index, ['WTeam_scoring_weighted_off_consistency', 'WTeam_scoring_weighted_def_consistency',\n                       'LTeam_scoring_weighted_off_consistency', 'LTeam_scoring_weighted_def_consistency'\n                      ]].mean(axis=1).values\n\npreds_with_consistency = np.concatenate([\n    pred_test.reshape(-1, 1),\n    (pred_test \/ (consistency_test**1)).reshape(-1, 1)\n], axis=1)\n\npred_probs = pipe2.predict_proba(preds_with_consistency)\n\nlog_loss(y_test > 0, pred_probs, labels=[False, True])\n\n","df2bde52":"from scipy import stats\n\npred_train= pipe.predict(X_train)\npred_test = pipe.predict(X_test)\n\nsum_errs = np.sum((y_test - pred_test)**2)\nstdev = np.sqrt(1 \/ (len(y_test) - 2) * sum_errs)\n#sum_errs = np.sum((y_train - pred_train)**2)\n#stdev = np.sqrt(1 \/ (len(y_train) - 2) * sum_errs)\n\npred_probs = stats.norm.cdf(pred_test, loc=0, scale=stdev)\npred_probs = stats.t.cdf(pred_test, df=len(y_test)-1, loc=0, scale=stdev)\n\n#pred_probs[1]= 0\nlog_loss(y_test > 0, pred_probs, labels=[False, True])","a8d78da9":"#sorted(list(zip(features, pipe.named_steps['clf'].coef_[0])), key=lambda x: -abs(x[1]))\nsorted(list(zip(features, pipe.named_steps['clf'].coef_)), key=lambda x: -abs(x[1]))","bfaa7539":"old_scores = None","a15ea9cc":"from sklearn.model_selection import cross_validate\nfrom sklearn.linear_model import Lasso\n\nprint(f'Original scores: {old_scores}')\n\ncv_features = [\n# 'diff_scoring_overall_efficiency',\n 'diff_scoring_weighted_overall_efficiency',\n# 'diff_reb_overall_efficiency',\n 'diff_3pt_overall_efficiency',\n 'diff_draw_foul_overall_efficiency',\n#    'diff_power_conf'\n# 'diff_ft_pct',\n# 'round_decayed_diff_scoring_overall_efficiency',\n# 'interaction__diff_3pt_overall_efficiency__diff_reb_overall_efficiency',\n# 'interaction__diff_scoring_weighted_overall_efficiencyy__diff_3pt_overall_efficiency',\n# 'interaction__diff_scoring_weighted_overall_efficiency__diff_reb_overall_efficiency'\n]\n\n\nclf = LinearRegression(fit_intercept=False)\n#clf = Lasso(alpha=0.075, fit_intercept=False)\n#clf = ElasticNet(alpha=0.05, l1_ratio=.5, fit_intercept=False, random_state=0)\n#clf = GradientBoostingRegressor(n_estimators=500, learning_rate=1.0,\n#    max_depth=3, random_state=0)\n\npipe = Pipeline([\n    ('imputer', SimpleImputer(missing_values=np.nan, strategy='mean')),\n    ('scaler', StandardScaler()),\n    ('clf', clf)\n])\n\nfeat_cv = {}\n\n    \nscoring_funcs = ['accuracy', 'neg_log_loss']\nscoring_funcs = ['explained_variance', 'neg_root_mean_squared_error',\n                 'neg_mean_absolute_error', 'neg_mean_squared_error']\n\nfolds = X.loc[df.is_tourney].shape[0]\ncv_results = cross_validate(pipe, X.loc[df.is_tourney, cv_features], y.loc[df.is_tourney],\n                                        cv=folds, scoring=(scoring_funcs))\nold_scores = (cv_results['test_neg_mean_squared_error'].mean(),\n             cv_results['test_neg_root_mean_squared_error'].mean(),\n             cv_results['test_explained_variance'].mean())\nprint(f'New score: {old_scores}')","6e32370a":"# Train production model\nX_train = X.loc[df.is_tourney]\ny_train = y.loc[df.is_tourney]\npipe.fit(X_train, y_train)\n\npred_train= pipe.predict(X_train)\n\nconsistency_train = df.loc[X_train.index, ['WTeam_scoring_weighted_off_consistency', 'WTeam_scoring_weighted_def_consistency',\n                       'LTeam_scoring_weighted_off_consistency', 'LTeam_scoring_weighted_def_consistency'\n                      ]].mean(axis=1).values\n\npreds_with_consistency = np.concatenate([\n    pred_train.reshape(-1, 1),\n    (pred_train \/ (consistency_train**1)).reshape(-1, 1)\n], axis=1)\n\n\n\npipe2.fit(preds_with_consistency, y_train > 0)","96f4edd0":"#ppreds = np.array([preds[i, y_test.iloc[i].astype(int)] for i in range(len(preds))])\nppreds = np.array([pred_probs[i] if y_test.iloc[i] > 0 else 1-pred_probs[i]  for i in range(len(pred_probs))])\n\n\npred_df = df.loc[X_test.index, ['Season', 'WTeamName', 'LTeamName', 'WTeam_seed', 'LTeam_seed']].copy()\npred_df['seed_diff'] = pred_df.WTeam_seed - pred_df.LTeam_seed\npred_df['pred'] = ppreds\npred_df.sort_values('pred')","83464311":"slots = load_data('WNCAATourneySlots.csv') \n#slots = slots[slots.Season==2021]\nseeds = load_data('WNCAATourneySeeds.csv')\nseeds = seeds[seeds.Season==2021]\n\nteams = load_data('WTeams.csv')\n\nslots = slots.merge(seeds.rename(columns={'Seed': 'StrongSeed', 'TeamID': 'StrongTeamID'}),\n                    how='left', on=['StrongSeed'] )\nslots = slots.merge(seeds.rename(columns={'Seed': 'WeakSeed', 'TeamID': 'WeakTeamID'}),\n                    how='left', on=[ 'WeakSeed'] )\n\nslots = slots.merge(teams[['TeamID', 'TeamName']].rename(columns={'TeamID': 'StrongTeamID', 'TeamName': 'StrongTeamName'}), how='left', on=['StrongTeamID'] )\nslots = slots.merge(teams[['TeamID', 'TeamName']].rename(columns={'TeamID': 'WeakTeamID', 'TeamName': 'WeakTeamName'}), how='left', on=['WeakTeamID'] )\n\n# TODO: see who wins the first four\n#slots.loc[[0, 5, 8, 13], ['WeakTeamID']] = [1291, 1277, 1313, 1179]\n\n# Slot names are in order since it's WvX and YvZ in the final four and stronger seeds don't go to double digits\nslots.shape","89fc4fc5":"sub_df = load_data('WSampleSubmissionStage2.csv')\nseason = int(sub_df.ID.iloc[0][:4])\nsub_df['WTeamID'] = sub_df.ID.apply(lambda x: int(x[5:9]))\nsub_df['LTeamID'] = sub_df.ID.apply(lambda x: int(x[10:14]))\n\nmetric_cols = [f'WTeam_{metric}_overall_efficiency' for metric in all_metrics]\nmetric_cols += [f'WTeam_{metric}_{side}_consistency' for metric in all_metrics for side in ['off', 'def']]\n\nmerge_cols = ['WTeamName', 'WTeam_lat', 'WTeam_lng', 'WTeam_preseason_ap_score', 'WTeam_preseason_ap_score_exp'] + metric_cols\nmerge_cols = ['WTeamName'] + metric_cols\nlookup_df = df.loc[df.Season==season, ['WTeamID'] + merge_cols].drop_duplicates()\nlookup_df.head()\n\nsub_df = sub_df.merge(lookup_df, on='WTeamID').merge(\n    lookup_df.rename(columns={c: f'L{c[1:]}' for c in lookup_df.columns}), on='LTeamID'\n)\n\nsub_df.head()","c4fb3540":"for metric in all_metrics:\n    sub_df[f'diff_{metric}_overall_efficiency'] = sub_df[f'WTeam_{metric}_overall_efficiency'] - sub_df[f'LTeam_{metric}_overall_efficiency']\n    ","df936129":"sub_df.head()","aa226d0a":"# team id => list of potential slots\nslots_for_seed = {}\n\n\nstrong_idx_df = slots.set_index('StrongSeed')\nweak_idx_df = slots.set_index('WeakSeed')\n\nfor seed in slots[['StrongTeamID', 'StrongTeamName', 'StrongSeed']].dropna().StrongSeed.tolist() + slots[['WeakTeamID', 'WeakTeamName', 'WeakSeed']].dropna().WeakSeed.tolist():\n    seed_slots = []\n    slot = seed\n    while slot is not None:\n        if slot in strong_idx_df.index:\n            slot = strong_idx_df.loc[slot].Slot\n            seed_slots.append(slot)\n        elif slot in weak_idx_df.index:\n            slot = weak_idx_df.loc[slot].Slot\n            seed_slots.append(slot)\n        else:\n            slot = None\n    slots_for_seed[seed] = seed_slots\n    ","fb100110":"slots_for_seed\nteam_id_to_seed = {**dict(slots.dropna(subset=['StrongTeamName'])[['StrongTeamID', 'StrongSeed']].values),\n                   **dict(slots.dropna(subset=['WeakTeamName'])[['WeakTeamID', 'WeakSeed']].values)}\nteam_id_to_slots = {int(k): slots_for_seed[v] for k,v in team_id_to_seed.items()}","2dafe57d":"def determine_slot(row):\n    slots = set(team_id_to_slots[row['WTeamID']]) & set(team_id_to_slots[row['LTeamID']])\n    return min(slots) # relies on fact slots are named like R3W2","479bf2a4":"sub_df['slot'] = sub_df.apply(determine_slot, axis=1)\nsub_df['round_num'] = sub_df.slot.apply(lambda x: int(x[1]))","e3478a88":"sub_df[features].isnull().mean()","afb41061":"pred_train= pipe.predict(X_train)\npred_eval = pipe.predict(sub_df[features])\n\nsum_errs = np.sum((y_train - pred_train)**2)\nstdev = np.sqrt(1 \/ (len(y_train) - 2) * sum_errs)\n#sum_errs = np.sum((y_train - pred_train)**2)\n#stdev = np.sqrt(1 \/ (len(y_train) - 2) * sum_errs)\n\n#pred_probs = stats.norm.cdf(pred_eval, loc=0, scale=stdev)\n#pred_probs_old = stats.t.cdf(pred_eval, df=len(pred_train)-1, loc=0, scale=stdev)\n\n\n\n\n\nconsistency_eval = sub_df[['WTeam_scoring_weighted_off_consistency', 'WTeam_scoring_weighted_def_consistency',\n                       'LTeam_scoring_weighted_off_consistency', 'LTeam_scoring_weighted_def_consistency'\n                      ]].mean(axis=1).values\n\npreds_with_consistency = np.concatenate([\n    pred_eval.reshape(-1, 1),\n    (pred_eval \/ (consistency_eval**1)).reshape(-1, 1)\n], axis=1)\n\npred_probs = pipe2.predict_proba(preds_with_consistency)[:, 1]\n\n\n\n#pred_probs = pipe2.predict_proba(pred_eval.reshape(-1, 1))[:, 1]\n\n","78144272":"sub_df['Pred'] = pred_probs\nsub_df['pred_margin'] = pred_eval","2dc36438":"temp = sub_df[['WTeamName', 'LTeamName', 'Pred', 'pred_margin']].copy()\ntemp2 = temp.copy()\ntemp2 = temp2.rename(columns = {'WTeamName': 'LTeamName', 'LTeamName': 'WTeamName'})\ntemp2.Pred = 1-temp2.Pred\ntemp2.pred_margin = -temp2.pred_margin\n\ntemp = pd.concat([\n    temp,\n    temp2\n], sort=False)","eab67551":"# Avg margin across possible tourney games\nnew_means2 = temp.groupby('WTeamName').pred_margin.mean().sort_values(ascending=False).to_dict()\nnew_means2","b730a2a3":"#sorted([(k, new_means2[k]-old_means[k]) for k in new_means2 ], key=lambda x: -x[1])","911486d8":"idx = temp[(temp.WTeamName==\"Stanford\") & (temp.LTeamName=='Connecticut')].index[0]\nsub_df.loc[idx, ['WTeamName', 'LTeamName', 'Pred', 'pred_margin']]","61d96e71":"team1 = df[(df.Season==2021) & (df.WTeamName=='Georgetown')].iloc[0]\nteam2 = df[(df.Season==2021) & (df.WTeamName=='Colorado')].iloc[0]","4137495d":"def vegas_to_prob(odds):\n    if odds <= -100:\n        prob = odds \/ (odds - 100)\n    else:\n        prob = 100 \/ (odds + 100)\n    return prob\n\ndef avg_odds(odds, other):\n    return (vegas_to_prob(odds) + (1 - vegas_to_prob(other))) \/ 2\n","ecaf7617":"\n# Score spread prediction contest\nsub_df[['ID', 'pred_margin']].rename(columns={'pred_margin': 'Pred'}).to_csv('submission_spread.csv', index=False)\n\n# SUBMIT!!!!!!!!!!!!!!!!!!!!!!!!!!\nsub_df2 = sub_df.copy()\nsub_df2.loc[1678, 'Pred'] = 0.0 # VT vs. Marquette\nsub_df2[['ID', 'Pred']].to_csv('submission.csv', index=False)\n\nsub_df_risky = sub_df.copy()\nsub_df_risky.loc[1678, 'Pred'] = 1.0  # VT vs. Marquette\nsub_df_risky[['ID', 'Pred']].to_csv('submission_risky.csv', index=False)\n\n\n","15e1abd1":"slots.head()","31c7ca28":"slots\n\nbracket_order = [f'{region}0{num}' for region in ['W', 'X', 'Y', 'Z'] for num in [1, 8, 5, 4, 6, 3, 7, 2]]\nteam_ids = slots.set_index(\"StrongSeed\").loc[bracket_order,\n                                  ['StrongTeamID', 'WeakTeamID']].values.flatten()\n","61ae920e":"preds_matrix = np.zeros((64, 64))\n\nfor i in range(64):\n    for j in range(64):\n        team_i = team_ids[i]\n        team_j = team_ids[j]\n        if team_i < team_j:\n            preds_matrix[i, j] = sub_df[(sub_df.WTeamID==team_i) & (sub_df.LTeamID==team_j)].iloc[0].Pred\n        elif team_i > team_j:\n            preds_matrix[i, j] = 1- sub_df[(sub_df.WTeamID==team_j) & (sub_df.LTeamID==team_i)].iloc[0].Pred\n        else:\n            preds_matrix[i, j] = 0","ee44fd63":"def get_opp_idxes(round_idx, team_idx):\n    num = 2**round_idx\n    opp_num_idxes = 2**(round_idx-1)\n    opp_start_idx = team_idx \/\/ num * num\n    if team_idx - opp_start_idx < opp_num_idxes:\n        opp_start_idx += opp_num_idxes\n        \n    opp_idxes = np.arange(opp_num_idxes) + opp_start_idx\n    return opp_idxes\n    \nget_opp_idxes(6, 1)","a65ad1e8":"arr = np.zeros((64, 7))\narr[:, 0] = 1\n\nfor round_idx in range(1, 7):\n    for team_idx in range(len(arr)):\n        \n        opp_idxes = get_opp_idxes(round_idx, team_idx)\n        \n        opp_preds = preds_matrix[team_idx, opp_idxes]\n        prob_opp = arr[opp_idxes, round_idx-1]\n        \n        # Prob(team is in round) * sum(Prob(opp_i is in round) * Prob(team beats opp_i))\n        prob = arr[team_idx, round_idx-1] * sum(opp_preds * prob_opp)\n        arr[team_idx, round_idx] = prob\n\n\narr.sum(axis=0)","7a1e69ae":"sub_df[features].isna().mean()","d334a228":"sim_df = pd.DataFrame(arr, columns=[f\"prob_win_round_{i}\" for i in range(7)])\nsim_df['TeamID'] = team_ids.astype(int)\nsim_df = sim_df.merge(teams[['TeamID', 'TeamName']], on='TeamID')\nsim_df = sim_df[['TeamName'] + sim_df.columns.tolist()[1:-1]]\n\npd.options.display.float_format = \"{:,.6f}\".format\nsim_df.sort_values('prob_win_round_6', ascending=False)","929414d5":"## Recreate KenPom","7ea2dec9":"### Add conference data","75ecc916":"#### Figure out round teams would meet in","8f6a7f30":"## Train Model","d78be22e":"# Simulation","e341682e":"### Get Round numbers","06d27d9d":"# Prediction time","23c9bb5d":"### Normalize Seed diff"}}