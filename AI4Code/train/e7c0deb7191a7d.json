{"cell_type":{"967aec87":"code","5124cabe":"code","d7e636cc":"code","0ff3faec":"code","afc533be":"code","f7c4bf98":"code","0e5c35c7":"code","cb9b7985":"code","e1a60541":"code","a9dff94b":"code","3ddcd08b":"code","c27b3da5":"code","7650365e":"code","4e31e71c":"code","374255af":"code","42b1264e":"code","1d0a0033":"markdown"},"source":{"967aec87":"import pandas as pd\nimport numpy as np\nimport random\nimport time\nimport gc\nimport os\n\nfrom sklearn.model_selection import KFold, StratifiedKFold\nfrom sklearn.metrics import roc_auc_score, accuracy_score\nfrom sklearn.preprocessing import StandardScaler, RobustScaler, MinMaxScaler\n\nfrom sklearn import svm\nfrom sklearn import tree\nfrom sklearn import impute\nfrom sklearn import ensemble\nfrom sklearn import linear_model\nfrom sklearn import decomposition\n\n\nfrom matplotlib import pyplot as plt\nimport matplotlib as mpl\nimport seaborn as sns\n\nimport xgboost as xgb\nimport lightgbm as lgb\nimport catboost as cat\n\nimport warnings\n\nprint('done!')","5124cabe":"N_SPLITS = 5\nN_ESTIMATORS = 1000\nEARLY_STOPING_ROUND = 200\nVERBOSE = 1000\nSEED = 2021\n\nN_BINS = 20\n\ndef seed_everything(seed = 42):\n    random.seed(seed)\n    os.environ['PYTHONHASHSEED'] = str(seed)\n    np.random.seed(seed)\n    \n    pd.set_option('display.max_rows', None)\n    pd.set_option('display.max_columns', None)\n    pd.set_option('float_format', '{:f}'.format)\n    \n    sns.set_style(\"white\")\n    mpl.rcParams['figure.dpi'] = 600\n    %matplotlib inline\n\nseed_everything(SEED)","d7e636cc":"path = \"..\/input\/tabular-playground-series-sep-2021\/\"\n\ndata = {\n    \"train\" : path + \"train.csv\",\n    \"test\"  : path + \"test.csv\",\n    \"sample\": path + \"sample_solution.csv\"\n}\n\ntrain  = pd.read_csv(data[\"train\"])\ntest   = pd.read_csv(data[\"test\"])\nsample = pd.read_csv(data[\"sample\"])\n\ntrain.head()","0ff3faec":"features = [col for col in train.columns if col not in ('id', 'claim')]\nTARGET   = 'claim'\ntarget   = train[TARGET].copy()\n\nlen(features)","afc533be":"\ntrain[\"n_missing\"] = train[features].isna().sum(axis=1)\ntest[\"n_missing\"]  = test[features].isna().sum(axis=1)\n\nfeatures += ['n_missing']\n\nn_missing = train[\"n_missing\"].copy()","f7c4bf98":"modes = train[features].mode().iloc[0]\n\ntrain[features] = train[features].fillna(modes)\ntest[features]  = test[features].fillna(modes)\n\nscaler = StandardScaler()\n# scaler = RobustScaler()\n# scaler = MinMaxScaler()\n\ntrain[features] = scaler.fit_transform(train[features])\ntest[features]  = scaler.transform(test[features])","0e5c35c7":"train[\"min\"] = train[features].min(axis=1)\ntrain[\"max\"] = train[features].max(axis=1)\ntrain[\"std\"] = train[features].std(axis=1)\ntrain[\"mean\"] = train[features].mean(axis=1)\n\ntest[\"min\"]  = test[features].min(axis=1)\ntest[\"max\"]  = test[features].max(axis=1)\ntest[\"std\"]  = test[features].std(axis=1)\ntest[\"mean\"]  = test[features].mean(axis=1)\n\nfeatures += ['min', 'max', 'mean', 'std']","cb9b7985":"def cross_validate_model(class_name, class_params, train_data, test_data, n_splits=N_SPLITS):\n    \n    X = train_data[features].to_numpy()\n    y = train_data[TARGET]\n    X_test = test_data[features].to_numpy()\n    \n    skf = StratifiedKFold(n_splits=n_splits, shuffle=False)\n    \n    oof_preds, oof_y = [], []\n    \n    test_preds = np.zeros(X_test.shape[0])\n    \n    for i, (train_idx, valid_idx) in enumerate(skf.split(X, y)):\n        xtrain, xvalid = X[train_idx], X[valid_idx]\n        ytrain, yvalid = y[train_idx], y[valid_idx]\n        \n        print(f\"{'-'*10} Fold {i+1} Started {'-'*10}\")\n        \n        clf = class_name(**class_params)\n        \n        clf.fit(xtrain, ytrain)\n        preds = clf.predict_proba(xvalid)\n        \n        oof_preds.extend(preds[:, 1])\n        oof_y.extend(yvalid)\n        \n        test_preds += clf.predict_proba(X_test)[:, 1]\n        \n        roc_score = roc_auc_score(yvalid, preds[:, 1])\n        print(f\"\\n roc : {roc_score}\\n\")\n        \n    roc_score = roc_auc_score(oof_y, oof_preds)\n\n    print(f\"\\n Final ROC AUC : {roc_score}\")\n    \n    return oof_preds, test_preds \/ n_splits\n        \n\n","e1a60541":"xgb_params = {\n    'n_estimators' : 3600,\n    'reg_lambda' : 3,\n    'reg_alpha' : 26,\n    'subsample' : 0.6000000000000001,\n    'colsample_bytree' : 0.6000000000000001,\n    'max_depth' : 9,\n    'min_child_weight' : 5,\n    'gamma' : 13.054739572819486,\n    'learning_rate': 0.01,\n    'tree_method': 'gpu_hist',\n    'booster': 'gbtree',\n    \n    'use_label_encoder' : False \n}\n\nlgbm_params = {\n    \"objective\": \"binary\",\n    \"learning_rate\": 0.008,\n    'device': 'gpu',\n    'n_estimators': 3205,\n    'num_leaves': 184,\n    'min_child_samples': 63,\n    'feature_fraction': 0.6864594334728974,\n    'bagging_fraction': 0.9497327922401265,\n    'bagging_freq': 1,\n    'reg_alpha': 19,\n    'reg_lambda': 19,\n    'gpu_platform_id': 0,\n    'gpu_device_id': 0\n}\n\ncatb_params = {\n    'iterations': 15585, \n    'objective': 'CrossEntropy', \n    'bootstrap_type': 'Bernoulli', \n    'od_wait': 1144, \n    'learning_rate': 0.023575206684596582, \n    'reg_lambda': 36.30433203563295, \n    'random_strength': 43.75597655616195, \n    'depth': 7, \n    'min_data_in_leaf': 11, \n    'leaf_estimation_iterations': 1, \n    'subsample': 0.8227911142845009,\n    'task_type' : 'GPU',\n    'devices' : '0',\n    'verbose' : 0\n}\n","a9dff94b":"lv1_oof = pd.DataFrame()\nlv1_test= pd.DataFrame()","3ddcd08b":"oof_preds, test_preds = cross_validate_model(xgb.XGBClassifier,\n                                            xgb_params,\n                                            train, test,\n                                            N_SPLITS)\n\nlv1_oof['xgb'] = oof_preds\nlv1_test['xgb']= test_preds","c27b3da5":"catb_params['random_state'] = 42\noof_preds, test_preds = cross_validate_model(cat.CatBoostClassifier,\n                                            catb_params,\n                                            train, test,\n                                            N_SPLITS)\nlv1_oof['catb_1'] = oof_preds\nlv1_test['catb_1']= test_preds\n\ncatb_params['random_state'] = 2021\noof_preds, test_preds = cross_validate_model(cat.CatBoostClassifier,\n                                            catb_params,\n                                            train, test,\n                                            N_SPLITS)\nlv1_oof['catb_2'] = oof_preds\nlv1_test['catb_2']= test_preds\n\n","7650365e":"lgbm_params['random_state'] = 42\noof_preds, test_preds = cross_validate_model(lgb.LGBMClassifier,\n                                            lgbm_params,\n                                            train, test,\n                                            N_SPLITS)\nlv1_oof['lgbm_1'] = oof_preds\nlv1_test['lgbm_1']= test_preds\n\n\nlgbm_params['random_state'] = 2021\noof_preds, test_preds = cross_validate_model(lgb.LGBMClassifier,\n                                            lgbm_params,\n                                            train, test,\n                                            N_SPLITS)\nlv1_oof['lgbm_2'] = oof_preds\nlv1_test['lgbm_2']= test_preds\n\n","4e31e71c":"lv1_oof[TARGET] = train[TARGET]\n","374255af":"lv1_oof.to_csv(\"lv1_train.csv\", index=False)\nlv1_test.to_csv(\"lv1_test.csv\", index=False)\n\n","42b1264e":"df = pd.read_csv(\"lv1_train.csv\")\ndf.head()","1d0a0033":"## Data"}}