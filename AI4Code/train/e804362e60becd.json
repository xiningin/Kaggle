{"cell_type":{"05b73559":"code","9ad1f18c":"code","61eb12d5":"code","af23b68b":"code","55be29ee":"code","344d67eb":"code","20db78a9":"code","b583bf10":"code","cf4c0711":"code","ce598464":"code","6bb4b3af":"code","93df0626":"code","ff5dc759":"code","18978030":"code","1f18394f":"code","ee733ca1":"code","b521074e":"code","d22d4d40":"code","c1351cad":"code","1173d99a":"code","51516125":"code","535f679b":"code","96787a3d":"code","020525bd":"code","f73db104":"code","f2fb2cf4":"code","c8cd5099":"code","46c2f87d":"code","39afc45b":"code","72742920":"code","86c9c623":"code","c1ab5997":"markdown","726400ef":"markdown","88487ff8":"markdown","c1755146":"markdown","b62a68ff":"markdown","2487ca6d":"markdown","b6d1d5d3":"markdown","a03d1f5c":"markdown","d745c55f":"markdown","17efadb8":"markdown","b2da1e32":"markdown","071cfd72":"markdown","8e933c24":"markdown","957fd77f":"markdown","fabfb7df":"markdown","782ede71":"markdown","7a6fef1d":"markdown","06bebfde":"markdown","ae78e563":"markdown","2b12190b":"markdown","b826e00c":"markdown","270e4d4d":"markdown","0e1b3ae1":"markdown","145cb9de":"markdown","bc6e0bc9":"markdown","902210a2":"markdown","cb811b84":"markdown","b28ab9d7":"markdown","0f7abaf4":"markdown","4aafc519":"markdown","c844e85a":"markdown","3e6eed23":"markdown"},"source":{"05b73559":"import numpy  as np\nimport pandas as pd\nimport matplotlib.pyplot as plt\nplt.rcParams.update({'font.size': 18})\nplt.style.use('fivethirtyeight')\nimport seaborn as sns\nimport warnings\nwarnings.simplefilter(action='ignore', category=FutureWarning)","9ad1f18c":"train_data = pd.read_csv('..\/input\/ventilator-pressure-prediction\/train.csv',index_col=0)\ntest_data  = pd.read_csv('..\/input\/ventilator-pressure-prediction\/test.csv', index_col=0)\nsample     = pd.read_csv('..\/input\/ventilator-pressure-prediction\/sample_submission.csv')","61eb12d5":"train_data","af23b68b":"train_data.nunique().to_frame()","55be29ee":"test_data.nunique().to_frame()","344d67eb":"train_data.groupby(\"breath_id\")[\"time_step\"].count().unique().item()","20db78a9":"test_data.groupby(\"breath_id\")[\"time_step\"].count().unique().item()   ","b583bf10":"train_data.isnull().sum(axis = 0).to_frame()","cf4c0711":"train_data.time_step.max()","ce598464":"train_data.query('u_out == 0').time_step.max()","6bb4b3af":"breath_one = train_data.query('breath_id == 1').reset_index(drop = True)\nbreath_one","93df0626":"breath_one.nunique().to_frame()","ff5dc759":"breath_one.plot(x=\"time_step\", y=\"u_in\", kind='line',figsize=(12,3), lw=2, title=\"u_in\");\nbreath_one.plot(x=\"time_step\", y=\"u_out\", kind='line',figsize=(12,3), lw=2, title=\"u_out\");\nbreath_one.plot(x=\"time_step\", y=\"pressure\", kind='line',figsize=(12,3), lw=2, title=\"pressure\");","18978030":"train_data.R.value_counts().to_frame()","1f18394f":"train_data.C.value_counts().to_frame()","ee733ca1":"train_data.u_out.value_counts().to_frame()","b521074e":"train_data.pressure.max()","d22d4d40":"plt.figure(figsize = (12,5))\nax = sns.distplot(train_data['pressure'], \n             bins=120, \n             kde_kws={\"clip\":(0,40)}, \n             hist_kws={\"range\":(0,40)},\n             color='darkcyan', \n             kde=False);\nvalues = np.array([rec.get_height() for rec in ax.patches])\nnorm = plt.Normalize(values.min(), values.max())\ncolors = plt.cm.jet(norm(values))\nfor rec, col in zip(ax.patches, colors):\n    rec.set_color(col)\nplt.xlabel(\"Histogram of pressures\", size=14)\nax.set(yticklabels=[])\nplt.show();","c1351cad":"train_data.pressure.median()","1173d99a":"u_out_is_zero = train_data.query(\"u_out == 0\").reset_index(drop = True)\nplt.figure(figsize = (12,5))\nax = sns.distplot(u_out_is_zero['pressure'], \n             bins=120, \n             kde_kws={\"clip\":(0,50)}, \n             hist_kws={\"range\":(0,50)},\n             color='darkcyan', \n             kde=False);\nvalues = np.array([rec.get_height() for rec in ax.patches])\nnorm = plt.Normalize(values.min(), values.max())\ncolors = plt.cm.jet(norm(values))\nfor rec, col in zip(ax.patches, colors):\n    rec.set_color(col)\nplt.xlabel(\"Histogram of pressures (u_out=0)\", size=14)\nax.set(yticklabels=[])\nplt.show();","51516125":"u_out_is_zero.pressure.median()","535f679b":"breath_2 = train_data.query('breath_id == 2').reset_index(drop = True)\nbreath_3 = train_data.query('breath_id == 3').reset_index(drop = True)\nbreath_4 = train_data.query('breath_id == 4').reset_index(drop = True)\nbreath_5 = train_data.query('breath_id == 5').reset_index(drop = True)\nbreath_17 = train_data.query('breath_id == 17').reset_index(drop = True)\nbreath_18 = train_data.query('breath_id == 18').reset_index(drop = True)\nbreath_21 = train_data.query('breath_id == 21').reset_index(drop = True)\nbreath_39 = train_data.query('breath_id == 39').reset_index(drop = True)\n\nfig, axes = plt.subplots(3,3,figsize=(15,15))\nsns.lineplot(data=breath_39, x=\"time_step\", y=\"pressure\", lw=2, ax=axes[0,0])\naxes[0,0].set_title (\"R=5, C=10\", fontsize=18)\naxes[0,0].set(xlabel='')\n#axes[0,0].set(ylim=(0, None))\nsns.lineplot(data=breath_21, x=\"time_step\", y=\"pressure\",  lw=2, ax=axes[0,1])\naxes[0,1].set_title (\"R=20, C=10\", fontsize=18)\naxes[0,1].set(xlabel='')\naxes[0,1].set(ylabel='')\n#axes[0,1].set(ylim=(0, None))\nsns.lineplot(data=breath_18, x=\"time_step\", y=\"pressure\",  lw=2,ax=axes[0,2])\naxes[0,2].set_title (\"R=50, C=10\", fontsize=18)\naxes[0,2].set(xlabel='')\naxes[0,2].set(ylabel='')\n#axes[0,2].set(ylim=(0, None))\nsns.lineplot(data=breath_17, x=\"time_step\", y=\"pressure\",  lw=2,ax=axes[1,0])\naxes[1,0].set_title (\"R=5, C=20\", fontsize=18)\naxes[1,0].set(xlabel='')\n#axes[1,0].set(ylim=(0, None))\nsns.lineplot(data=breath_2, x=\"time_step\", y=\"pressure\",  lw=2,ax=axes[1,1])\naxes[1,1].set_title (\"R=20, C=20\", fontsize=18)\naxes[1,1].set(xlabel='')\naxes[1,1].set(ylabel='')\n#axes[1,1].set(ylim=(0, None))\nsns.lineplot(data=breath_3, x=\"time_step\", y=\"pressure\",  lw=2,ax=axes[1,2])\naxes[1,2].set_title (\"R=50, C=20\", fontsize=18)\naxes[1,2].set(xlabel='')\naxes[1,2].set(ylabel='')\n#axes[1,2].set(ylim=(0, None))\nsns.lineplot(data=breath_5, x=\"time_step\", y=\"pressure\",  lw=2,ax=axes[2,0])\naxes[2,0].set_title (\"R=5, C=50\", fontsize=18)\n#axes[2,0].set(ylim=(0, None))\nsns.lineplot(data=breath_one, x=\"time_step\", y=\"pressure\",  lw=2,ax=axes[2,1])\naxes[2,1].set_title (\"R=20, C=50\", fontsize=18)\naxes[2,1].set(ylabel='')\n#axes[2,1].set(ylim=(0, None))\nsns.lineplot(data=breath_4, x=\"time_step\", y=\"pressure\",  lw=2,ax=axes[2,2])\naxes[2,2].set_title (\"R=50, C=50\", fontsize=18)\naxes[2,2].set(ylabel='')\n#axes[2,2].set(ylim=(0, None))\n\nplt.show();","96787a3d":"zero_time = train_data.query(\"time_step < 0.000001 & u_in < 0.000001\").reset_index(drop = True)\nzero_time_5_10  = zero_time.query(\"R ==  5 & C == 10\").reset_index(drop = True)\nzero_time_5_20  = zero_time.query(\"R ==  5 & C == 20\").reset_index(drop = True)\nzero_time_5_50  = zero_time.query(\"R ==  5 & C == 50\").reset_index(drop = True)\nzero_time_20_10 = zero_time.query(\"R == 20 & C == 10\").reset_index(drop = True)\nzero_time_20_20 = zero_time.query(\"R == 20 & C == 20\").reset_index(drop = True)\nzero_time_20_50 = zero_time.query(\"R == 20 & C == 50\").reset_index(drop = True)\nzero_time_50_10 = zero_time.query(\"R == 50 & C == 10\").reset_index(drop = True)\nzero_time_50_20 = zero_time.query(\"R == 50 & C == 20\").reset_index(drop = True)\nzero_time_50_50 = zero_time.query(\"R == 50 & C == 50\").reset_index(drop = True)\n\nfig, axes = plt.subplots(9,1,figsize=(12,15))\nsns.violinplot(x=zero_time_5_10[\"pressure\"], linewidth=2, ax=axes[0], color=\"indianred\")\naxes[0].set_title (\"R=5, C=10\", fontsize=14)\naxes[0].set(xlim=(3, 8))\nsns.violinplot(x=zero_time_5_20[\"pressure\"], linewidth=2, ax=axes[1], color=\"firebrick\")\naxes[1].set_title (\"R=5, C=20\", fontsize=14)\naxes[1].set(xlim=(3, 8))\nsns.violinplot(x=zero_time_5_50[\"pressure\"], linewidth=2, ax=axes[2], color=\"darkred\" )\naxes[2].set_title (\"R=5, C=50\", fontsize=14)\naxes[2].set(xlim=(3, 8))\nsns.violinplot(x=zero_time_20_10[\"pressure\"], linewidth=2, ax=axes[3], color=\"greenyellow\")\naxes[3].set_title (\"R=20, C=10\", fontsize=14)\naxes[3].set(xlim=(3, 8))\nsns.violinplot(x=zero_time_20_20[\"pressure\"], linewidth=2, ax=axes[4], color=\"olivedrab\")\naxes[4].set_title (\"R=20, C=20\", fontsize=14)\naxes[4].set(xlim=(3, 8))\nsns.violinplot(x=zero_time_20_50[\"pressure\"], linewidth=2, ax=axes[5], color=\"olive\" )\naxes[5].set_title (\"R=20, C=50\", fontsize=14)\naxes[5].set(xlim=(3, 8))\nsns.violinplot(x=zero_time_50_10[\"pressure\"], linewidth=2, ax=axes[6], color=\"steelblue\")\naxes[6].set_title (\"R=50, C=10\", fontsize=14)\naxes[6].set(xlim=(3, 8))\nsns.violinplot(x=zero_time_50_20[\"pressure\"], linewidth=2, ax=axes[7], color=\"cornflowerblue\")\naxes[7].set_title (\"R=50, C=20\", fontsize=14)\naxes[7].set(xlim=(3, 8))\nsns.violinplot(x=zero_time_50_50[\"pressure\"], linewidth=2, ax=axes[8], color=\"midnightblue\" )\naxes[8].set_title (\"R=50, C=50\", fontsize=14)\naxes[8].set(xlim=(3, 8));","020525bd":"zero_time[\"pressure\"].mean()","f73db104":"zero_time[zero_time['pressure']==zero_time['pressure'].min()]","f2fb2cf4":"breath_542 = train_data.query('breath_id == 542').reset_index(drop = True)\nfig, ax = plt.subplots(1, 1, figsize=(12, 4))\nax.plot(breath_542[\"time_step\"],breath_542[\"u_in\"], lw=2, label='u_in')\nax.plot(breath_542[\"time_step\"],breath_542[\"pressure\"], lw=2, label='pressure')\n#ax.set(xlim=(0,1))\nax.legend(loc=\"upper right\")\nax.set_xlabel(\"time_id\", fontsize=14)\nax.set_title(\"breath_id = 542\", fontsize=14)\nplt.show();\n\nbreath_119582 = train_data.query('breath_id == 119582').reset_index(drop = True)\nfig, ax = plt.subplots(1, 1, figsize=(12, 4))\nax.plot(breath_119582[\"time_step\"],breath_119582[\"u_in\"], lw=2, label='u_in')\nax.plot(breath_119582[\"time_step\"],breath_119582[\"pressure\"], lw=2, label='pressure')\n#ax.set(xlim=(0,1))\nax.legend(loc=\"upper right\")\nax.set_xlabel(\"time_id\", fontsize=14)\nax.set_title(\"breath_id = 119582\", fontsize=14)\nplt.show();","c8cd5099":"train_data['u_in_cumsum'] = (train_data['u_in']).groupby(train_data['breath_id']).cumsum()\ntest_data['u_in_cumsum']  = (test_data['u_in']).groupby(test_data['breath_id']).cumsum()","46c2f87d":"breath_928 = train_data.query('breath_id == 928').reset_index(drop = True)\nfig, ax = plt.subplots(1, 1, figsize=(9, 5))\nax.plot(breath_928[\"time_step\"],breath_928[\"u_in\"], lw=2, label='u_in')\nax.plot(breath_928[\"time_step\"],breath_928[\"pressure\"], lw=2, label='pressure')\nax.set(xlim=(0,1))\nax.legend(loc=\"upper right\")\nax.set_xlabel(\"time_id\", fontsize=14)\nplt.show();","39afc45b":"train_data['u_in_shifted'] = train_data.groupby('breath_id')['u_in'].shift(2).fillna(method=\"backfill\")\ntest_data['u_in_shifted']  = test_data.groupby('breath_id')['u_in'].shift(2).fillna(method=\"backfill\")","72742920":"for df in (train_data, test_data):\n    df['u_in_first']  = df.groupby('breath_id')['u_in'].transform('first')\n    df['u_in_mean']   = df.groupby('breath_id')['u_in'].transform('mean')\n    df['u_in_median'] = df.groupby('breath_id')['u_in'].transform('median')\n    df['u_in_last']   = df.groupby('breath_id')['u_in'].transform('last')","86c9c623":"X_train = train_data.drop(['pressure'], axis=1)\ny_train = train_data['pressure']\nfrom sklearn.experimental import enable_hist_gradient_boosting\nfrom sklearn.ensemble     import HistGradientBoostingRegressor\nregressor  =  HistGradientBoostingRegressor(loss=\"least_absolute_deviation\",max_iter=300)\nregressor.fit(X_train, y_train)\nsample[\"pressure\"] = regressor.predict(test_data)\nsample.to_csv('submission.csv',index=False)","c1ab5997":"# Related reading\n* [The People's Ventilator Project](https:\/\/www.peoplesvent.org\/en\/latest\/)\n* [Julienne LaChance, Tom J. Zajdel, Manuel Schottdorf, Jonny L. Saunders, Sophie Dvali, Chase Marshall, Lorenzo Seirup, Daniel A. Notterman, and Daniel J. Cohen \"*PVP1\u2013The People\u2019s Ventilator Project: A fully open, low-cost, pressure-controlled ventilator*\", medRxiv doi:10.1101\/2020.10.02.20206037 October 5 (2020)](https:\/\/www.medrxiv.org\/content\/10.1101\/2020.10.02.20206037v1.full.pdf)\n* [QuickLung ventilator](https:\/\/www.ingmarmed.com\/product\/quicklung\/)","726400ef":"The longest breath is just under 3 seconds.","88487ff8":"Wonderful, it seems not!\n\n# Time\nIn this data the unit of time is seconds. How long does longest breath last?","c1755146":"# A simple submission","b62a68ff":"# All breaths\nWhat values do we have for `R`, which represents how restricted the airway is (in cmH<sub>2<\/sub>O\/L\/S).","2487ca6d":"Note however that in this competition the expiratory phase is not scored, so for practical purposes we are only really interested in the pressure for `u_out=0`, *i.e.* the first second of the experiments:","b6d1d5d3":"The next question is whether we have any missing data or not?","a03d1f5c":"Note that all of the instances of negative pressure occur only in the `R=50` (high restriction) with `C=10` (thick latex) systems.\n# Simple feature engineering\nWe shall add a new feature, which is the [cumulative sum](https:\/\/pandas.pydata.org\/pandas-docs\/stable\/reference\/api\/pandas.DataFrame.cumsum.html) of the `u_in` feature:","d745c55f":"### Descriptive statistics of `u_in`\nAgain inspired by the work of Chun Fu, this time in his notebook [\"*Add last u_in as new feat*\"](https:\/\/www.kaggle.com\/patrick0302\/add-last-u-in-as-new-feat\/) it is found, at least with gradient boosting type models, that providing the estimator with some descriptive statistics regarding `u_in` for the cycle in question seems to help in improving the model","17efadb8":"and for `u_out`, the control input for the exploratory solenoid valve. Either 0 or 1.","b2da1e32":"# Pressure\nAnd now we shall look at the `pressure`. The pressure is measured in cmH<sub>2<\/sub>0, where 1 cmH<sub>2<\/sub>0 is roughly equal to 98 Pascals. The maximum value of the pressure is","071cfd72":"Let us take a quick look at the training data","8e933c24":"which corresponds to around 6,350 Pa.\n\nThe pressures in the training data have the following distribution","957fd77f":"# [Ventilator Pressure Prediction](https:\/\/www.kaggle.com\/c\/ventilator-pressure-prediction): EDA and a simple submission\n\n### Summary\nIn this competition we are provided with 75,450 non-contiguous cycles (each cycle is uniquely labelled with an individual `breath_id`) of the [PVP1 automated ventilator](https:\/\/www.peoplesvent.org\/en\/latest\/) connected to a high-grade test lung ([Quicklung, Ingmar Medical](https:\/\/www.ingmarmed.com\/product\/quicklung\/))  Three different values of the compliance (C) were tested [10,20,50] mL cm H<sub>2<\/sub>O in conjunction with three different values of resistance (R) [5,20,50] cm H<sub>2<\/sub>O\/L\/s, resulting in a total of 9 different lung settings.\n\nA typical breath cycle has the following aspect \n\n![](https:\/\/raw.githubusercontent.com\/Carl-McBride-Ellis\/images_for_kaggle\/main\/PVP1_typical_cycle.png)\n\nA cycle lasts for up to 3 seconds. It is the inspiratory section (from 0-1 seconds) that we model in this competition.\n\nWhen it comes to model evaluation we have to predict the `pressure` 50,300 test cycles, of which 19% are assigned to the Public Leaderboard, and the remaining 81% to the Private Leaderboard.\n\n### Read in the data","fabfb7df":"The valve seems to be activated after 1 seccond.\n# The first breath\n\nLet us select `breath_id=1` and take a look at the features","782ede71":"The thinking behind this feature is that it is reasonable to assume the pressure in the lungs is approximately proportional to how much air has actually been pumped into them. It goes almost without saying that this feature is not useful when breathing out, but given that the expiratory phase is not scored in this competition this should not be too much of a problem.\n\n### Shifting `u_in`\nLet us take a look at the first second of `breath_id=928`, which is an excellent example of an oscillatory experiment","7a6fef1d":"Let us see how many unique values there are in each of these columns","06bebfde":"The average value of PEEP at the beginning of each cycle is","ae78e563":"It can be observed that there is a lag between `u_in` and the resulting `pressure` of around 0.1 seconds. I am sure it is with this in mind that [Chun Fu](https:\/\/www.kaggle.com\/patrick0302) wrote his excellent notebook [\"*Add lag u_in as new feat*\"](https:\/\/www.kaggle.com\/patrick0302\/add-lag-u-in-as-new-feat\/notebook), which introduces a new *shifted* `u_in` feature. Here we shall use a shift of 2 rather than his original shift of 1, which is now more in line with the delay seen:","2b12190b":"and the test data","b826e00c":"We have nine combinations of experiments; `C` can be 10, 20 or 50, and `R` can be 5, 20 or 50. Lets take a quick look at an example of each","270e4d4d":"How many unique values do we have for each feature?","0e1b3ae1":"with a median value of ","145cb9de":"# Positive end-expiratory pressure (PEEP)\nIt is worth noting that even before the experiments start (*i.e.* the `time_step=0` and `u_in=0`) there is a positive pressure in the airway. The system is maintained above atmospheric pressure to promote gas exchange to the lungs.","bc6e0bc9":"Note that not all cycles start with `u_in=0`, and a cycle can even start with the inspiratory solenoid valve set to the maximum value of 100.\n# Negative pressure\nThe minimum value for the pressure where `u_in=0` at `time_step=0` is","902210a2":"and the test data","cb811b84":"now for the values of `C`, the lung attribute indicating how compliant the lung is (in mL\/cmH<sub>2<\/sub>O)","b28ab9d7":"What is the maximum time that the exploratory solenoid valve is set to 0?","0f7abaf4":"We can see that we have over 6 million rows of training data, corresponding to 75,450 breaths, and 50,300 breaths in the test dataset. On average we have 80 time steps of data per breath. Let us check this for the training data","4aafc519":"Both of these breaths have a somewhat unusual aspect","c844e85a":"there is only one value for `R`, one value for `C` for the `breath_id`. \n\nLet us visualize `u_in`, `u_out` and `pressure` with respect to the `time_step`:","3e6eed23":"with a median value of "}}