{"cell_type":{"f179a99f":"code","421e5909":"code","01a93c30":"code","4fb4407e":"code","c4854649":"code","b599e7c5":"code","bced3d75":"code","f22af221":"code","1c3a76d4":"code","79122160":"code","96b5d38d":"code","2b1d8cc5":"code","e2721115":"code","4b648bf7":"code","548174d2":"code","1f998c40":"code","7dd13d5e":"code","aac83d54":"code","070a6158":"code","654fed25":"code","e67591eb":"code","b0e614b5":"code","6b7f454a":"code","81ad285a":"code","15ac50c7":"code","4ef1c4df":"code","f4cba893":"code","44b5798c":"code","764cf011":"code","f1589a6f":"code","a6d0cbcf":"code","cb417405":"code","ffe9ad3a":"code","52c9f3ef":"code","926606e2":"code","bd411f83":"code","ad39255a":"code","249da31d":"code","648923e7":"code","cee8c0bb":"code","1ab57f56":"code","eb64dff4":"code","1d5c3ebe":"code","c467a293":"markdown","a5b22c36":"markdown","665fb050":"markdown","dfcfb6c3":"markdown","0539863a":"markdown","95a9037a":"markdown","a69efdc7":"markdown","b979da1b":"markdown","322f84ba":"markdown","1e652c46":"markdown","784b049b":"markdown","586173e9":"markdown","c8b72188":"markdown","bcc1eced":"markdown","c64fe057":"markdown","d8d1422e":"markdown","88dff6e5":"markdown","9c7fa726":"markdown","c4cce18c":"markdown","847453ee":"markdown","52dfe2c0":"markdown","2c8f36ad":"markdown","2bfbcd07":"markdown","11b0a81f":"markdown","1a93a878":"markdown","f930c34a":"markdown","958ed3c6":"markdown"},"source":{"f179a99f":"import warnings\nwarnings.simplefilter('ignore')\nimport pandas as pd\nimport numpy as np\n%matplotlib inline\nimport matplotlib.pyplot as plt\nimport gc\nimport platform\nimport multiprocessing\nimport seaborn as sns\nimport sys\nfrom tqdm import tqdm\npd.set_option('display.max_columns', 83)\npd.set_option('display.max_rows', 83)\nplt.style.use('seaborn')\nimport os\nimport matplotlib\nimport plotly.plotly as py\nimport plotly.graph_objs as go\nfrom plotly.offline import init_notebook_mode, iplot\nimport cufflinks\nimport plotly\nfor package in [pd, np, sns, matplotlib, plotly]:\n    print(package.__name__, 'version:', package.__version__)\nprint('python version:', platform.python_version())\ninit_notebook_mode()","421e5909":"dtypes = {\n    'Census_OSSkuName':                                     'category',\n    'SkuEdition':                                           'category',\n    'Census_OSEdition':                                     'category',\n    'Platform':                                             'category',\n    'OsVer':                                                'category',\n    'Census_OSInstallLanguageIdentifier':                   'float16',\n    'Census_OSUILocaleIdentifier':                          'int16',\n    'Firewall':                                             'float16',\n    'HasTpm':                                               'int8',\n    'OsBuildLab':                                           'category',\n    'Census_OSBuildNumber':                                 'int16',\n    'OsBuild':                                              'int16',\n    'Processor':                                            'category',\n    'Census_OSArchitecture':                                'category',\n    'Census_OSBranch':                                      'category',\n    'OsPlatformSubRelease':                                 'category',\n    'Census_MDC2FormFactor':                                'category',\n    'Census_PowerPlatformRoleName':                         'category',\n    'Census_ChassisTypeName':                               'category',\n    'HasDetections':                                        'int8'\n}","01a93c30":"def load_dataframe(dataset):\n    usecols = dtypes.keys()\n    if dataset == 'test':\n        usecols = [col for col in dtypes.keys() if col != 'HasDetections']\n    df = pd.read_csv(f'..\/input\/{dataset}.csv', dtype=dtypes, usecols=usecols)\n    return df","4fb4407e":"%%time\nwith multiprocessing.Pool() as pool: \n    train, test = pool.map(load_dataframe, [\"train\", \"test\"])","c4854649":"df = pd.concat([train.drop('HasDetections', axis=1), test])","b599e7c5":"def label_encoder(df, features, keep_original=True, suffix='_label_encoded'):\n    \"\"\"\n    Features should be list\n    \"\"\"\n    for feature in tqdm(features):\n        df[feature + suffix] = pd.factorize(df[feature])[0]\n        if not keep_original:\n            del df[feature]\n    return df","bced3d75":"df['Processor'].value_counts(dropna=False)","f22af221":"df['Census_OSArchitecture'].value_counts(dropna=False)","1c3a76d4":"fig, axes = plt.subplots(nrows=2, ncols=1, figsize=(12,10))\nsns.countplot(x='Processor', hue='HasDetections', data=train, ax=axes[0], order=['x64', 'arm64', 'x86']);\nsns.countplot(x='Census_OSArchitecture', hue='HasDetections', data=train, ax=axes[1], order=['amd64', 'arm64', 'x86']);","79122160":"df = label_encoder(df, ['Processor', 'Census_OSArchitecture'])\ntrain = label_encoder(train, ['Processor', 'Census_OSArchitecture'])\ndf[['Processor_label_encoded', 'Census_OSArchitecture_label_encoded']].corr()","96b5d38d":"train[['Processor_label_encoded', 'Census_OSArchitecture_label_encoded', 'HasDetections']].corr()","2b1d8cc5":"df['OsPlatformSubRelease'].value_counts(dropna=False).head()","e2721115":"df['Census_OSBranch'].value_counts(dropna=False).head()","4b648bf7":"df = label_encoder(df, ['OsPlatformSubRelease', 'Census_OSBranch'])\ntrain = label_encoder(train, ['OsPlatformSubRelease', 'Census_OSBranch'])\ndf[['OsPlatformSubRelease_label_encoded', 'Census_OSBranch_label_encoded']].corr()","548174d2":"df[['OsPlatformSubRelease_label_encoded', 'Census_OSBranch_label_encoded']].corr().columns","1f998c40":"plt.figure(figsize=(14,6))\nsns.countplot(x='OsPlatformSubRelease', hue='HasDetections', data=train);","7dd13d5e":"os_platform_rs4 = train.loc[train['OsPlatformSubRelease'] == 'rs4', 'HasDetections'].value_counts().sort_index().to_dict()\nos_branch_rs4 = train.loc[train['Census_OSBranch'] == 'rs4_release', 'HasDetections'].value_counts().sort_index().to_dict()\nos_platform_rs2 = train.loc[train['OsPlatformSubRelease'] == 'rs2', 'HasDetections'].value_counts().sort_index().to_dict()\nos_branch_rs2= train.loc[train['Census_OSBranch'] == 'rs2_release', 'HasDetections'].value_counts().sort_index().to_dict()\nx = ['OsPlatformSubRelease', 'Census_OSBranch']\ntrace1 = go.Bar(x=x, y=[os_platform_rs4[0] \/ sum(os_platform_rs4.values()), os_branch_rs4[0] \/ sum(os_branch_rs4.values())], name='0 (no detections)', text=[os_platform_rs4[0], os_branch_rs4[0]], textposition=\"inside\")\ntrace2 = go.Bar(x=x, y=[os_platform_rs4[1] \/ sum(os_platform_rs4.values()), os_branch_rs4[1] \/ sum(os_branch_rs4.values())], name='1 (has detections)', text=[os_platform_rs4[1], os_branch_rs4[1]], textposition=\"inside\")\ntrace3 = go.Bar(x=x, y=[os_platform_rs2[0] \/ sum(os_platform_rs2.values()), os_branch_rs2[0] \/ sum(os_branch_rs2.values())], name='0 (no detections)', text=[os_platform_rs2[0], os_branch_rs2[0]], textposition=\"inside\")\ntrace4 = go.Bar(x=x, y=[os_platform_rs2[1] \/ sum(os_platform_rs2.values()), os_branch_rs2[1] \/ sum(os_branch_rs2.values())], name='1 (has detections)', text=[os_platform_rs2[1], os_branch_rs2[1]], textposition=\"inside\")\nfig = plotly.tools.make_subplots(rows=1, cols=2, subplot_titles=('rs4', 'rs2'))\nfig.append_trace(trace1, 1, 1)\nfig.append_trace(trace2, 1, 1)\nfig.append_trace(trace3, 1, 2)\nfig.append_trace(trace4, 1, 2)\nfig['layout'].update(title='rs4 and rs2 comparison', font=dict(size=18), barmode='group')\niplot(fig)","aac83d54":"os_platform_rs3 = train.loc[train['OsPlatformSubRelease'] == 'rs3', 'HasDetections'].value_counts().sort_index().to_dict()\nos_branch_rs3 = train.loc[train['Census_OSBranch'] == 'rs3_release', 'HasDetections'].value_counts().sort_index().to_dict()\nos_branch_rs3_svc = train.loc[train['Census_OSBranch'] == 'rs3_release_svc_escrow', 'HasDetections'].value_counts().sort_index().to_dict()\ntrace1 = go.Bar(x=['OsPlatformSubRelease'], y=[os_platform_rs3[0] \/ sum(os_platform_rs3.values())], name='0 (no detections)', text=os_platform_rs3[0], textposition=\"inside\")\ntrace2 = go.Bar(x=['OsPlatformSubRelease'], y=[os_platform_rs3[1] \/ sum(os_platform_rs3.values())], name='1 (has detections)', text=os_platform_rs3[1], textposition=\"inside\")\ntrace3 = go.Bar(x=['Census_OSBranch'], y=[os_branch_rs3[0] \/ sum(os_branch_rs3.values())], name='0 (no detections)', text=os_branch_rs3[0], textposition=\"inside\")\ntrace4 = go.Bar(x=['Census_OSBranch'], y=[os_branch_rs3[1] \/ sum(os_branch_rs3.values())], name='1 (has detections)', text=os_branch_rs3[1], textposition=\"inside\")\ntrace5 = go.Bar(x=['Census_OSBranch'], y=[os_branch_rs3_svc[0] \/ sum(os_branch_rs3_svc.values())], name='0 (no detections)', text=os_branch_rs3_svc[0], textposition=\"inside\")\ntrace6 = go.Bar(x=['Census_OSBranch'], y=[os_branch_rs3_svc[1] \/ sum(os_branch_rs3_svc.values())], name='1 (has detections)', text=os_branch_rs3_svc[1], textposition=\"inside\")\nfig = plotly.tools.make_subplots(rows=1, cols=3, subplot_titles=('rs3', 'rs3_release', 'rs3_release_svc_escrow'))\nfig.append_trace(trace1, 1, 1)\nfig.append_trace(trace2, 1, 1)\nfig.append_trace(trace3, 1, 2)\nfig.append_trace(trace4, 1, 2)\nfig.append_trace(trace5, 1, 3)\nfig.append_trace(trace6, 1, 3)\nfig['layout'].update(title='rs3 comparison', font=dict(size=18), barmode='group')\niplot(fig)","070a6158":"df['OsVer'].value_counts(dropna=False).head()","654fed25":"df['Platform'].value_counts(dropna=False)","e67591eb":"for i in df['Platform'].value_counts(dropna=False).index:\n    print('Value counts for', i)\n    print(df[df['Platform'] == i]['OsVer'].value_counts().head())\n    print()","b0e614b5":"df = label_encoder(df, ['Platform', 'OsVer'])","6b7f454a":"df[['Platform_label_encoded', 'OsVer_label_encoded']].corr()","81ad285a":"train = label_encoder(train, ['Platform', 'OsVer'])\ntrain[['Platform_label_encoded', 'OsVer_label_encoded', 'HasDetections']].corr()","15ac50c7":"fig, axes = plt.subplots(nrows=2, ncols=2, figsize=(14,10))\nfig.subplots_adjust(wspace=0.2, hspace=0.4)\nplatforms = train['Platform'].value_counts(dropna=False).index\nvalues_to_show = 3\nfor i in range(len(platforms)):\n    sub_df = train[train['Platform'] == platforms[i]]['OsVer'].value_counts(normalize=True, dropna=False).head(values_to_show)\n    sub_df.plot(kind='bar', rot=0, ax=axes[i \/\/ 2,i % 2], fontsize=14).set_xlabel('OsVer', fontsize=14);\n    for j in range(values_to_show):\n        try:\n            axes[i \/\/ 2,i % 2].plot(j, train.loc[(train['Platform'] == platforms[i]) & (train['OsVer'] == sub_df.index[j]), 'HasDetections'].value_counts(True)[1], marker='.', color=\"black\", markersize=24)\n        except:\n            continue\n    axes[i \/\/ 2,i % 2].legend(['Detection rate (%)'])\n    axes[i \/\/ 2,i % 2].set_title(platforms[i], fontsize=18)","4ef1c4df":"df['Census_OSEdition'].value_counts(dropna=False).head()","f4cba893":"df['Census_OSSkuName'].value_counts(dropna=False).head()","44b5798c":"check_values = 5\nfig, axes = plt.subplots(nrows=check_values, ncols=2, figsize=(14,check_values * 4))\nfig.subplots_adjust(wspace=0.2, hspace=0.4)\nfor i in range(check_values):\n    os_edition_value = train['Census_OSEdition'].value_counts(dropna=False).index[i]\n    os_skuname_value = train['Census_OSSkuName'].value_counts(dropna=False).index[i]\n    train.loc[train['Census_OSEdition'] == os_edition_value, 'HasDetections'].value_counts(True).sort_index().plot(kind='bar', rot=0, ax=axes[i, 0]).set_xlabel(os_edition_value, fontsize=16);\n    train.loc[train['Census_OSSkuName'] == os_skuname_value, 'HasDetections'].value_counts(True).sort_index().plot(kind='bar', rot=0, ax=axes[i, 1]).set_xlabel(os_skuname_value, fontsize=16);\n    axes[i, 0].text(x=-0.175, y=0.4, s=train.loc[train['Census_OSEdition'] == os_edition_value, 'HasDetections'].value_counts()[0], fontsize=18, color='white', fontweight='bold');\n    axes[i, 0].text(x=0.825, y=0.4, s=train.loc[train['Census_OSEdition'] == os_edition_value, 'HasDetections'].value_counts()[1], fontsize=18, color='white', fontweight='bold');\n    axes[i, 1].text(x=-0.175, y=0.4, s=train.loc[train['Census_OSSkuName'] == os_skuname_value, 'HasDetections'].value_counts()[0], fontsize=18, color='white', fontweight='bold');\n    axes[i, 1].text(x=0.825, y=0.4, s=train.loc[train['Census_OSSkuName'] == os_skuname_value, 'HasDetections'].value_counts()[1], fontsize=18, color='white', fontweight='bold');\naxes[0, 0].set_title('Census_OSEdition', fontsize=18, fontweight='bold');\naxes[0, 1].set_title('Census_OSSkuName', fontsize=18, fontweight='bold');","764cf011":"train = label_encoder(train, ['Census_OSEdition', 'Census_OSSkuName'], keep_original=True)","f1589a6f":"train[['HasDetections', 'Census_OSEdition_label_encoded', 'Census_OSSkuName_label_encoded']].corr()","a6d0cbcf":"df['Census_OSInstallLanguageIdentifier'].value_counts().head()","cb417405":"df['Census_OSUILocaleIdentifier'].value_counts().head()","ffe9ad3a":"train['Census_OSInstallLanguageIdentifier'].fillna(-1, inplace=True)\ntrain[['Census_OSInstallLanguageIdentifier', 'Census_OSUILocaleIdentifier', 'HasDetections']].corr()","52c9f3ef":"train['Census_OSBuildNumber'].value_counts().head()","926606e2":"train['OsBuild'].value_counts().head()","bd411f83":"train[['Census_OSBuildNumber', 'OsBuild', 'HasDetections']].corr()","ad39255a":"diff = df[df['Census_OSBuildNumber'] != df['OsBuild']].shape[0]\nprint(diff, 'differences ({:<.3f} %)'.format(diff \/ df.shape[0]))","249da31d":"df['Census_PowerPlatformRoleName'].value_counts(dropna=False).head()","648923e7":"df['Census_MDC2FormFactor'].value_counts(dropna=False).head()","cee8c0bb":"df['Census_ChassisTypeName'].value_counts(dropna=False).head()","1ab57f56":"fig, axes = plt.subplots(nrows=2, ncols=1, figsize=(14,10))\nsns.countplot(x='Census_PowerPlatformRoleName', hue='HasDetections', data=train, ax=axes[0], order=train['Census_PowerPlatformRoleName'].value_counts(dropna=False).index.tolist());\nsns.countplot(x='Census_MDC2FormFactor', hue='HasDetections', data=train, ax=axes[1], order=train['Census_MDC2FormFactor'].value_counts(dropna=False).index.tolist());","eb64dff4":"train = label_encoder(train, ['Census_PowerPlatformRoleName', 'Census_MDC2FormFactor', 'Census_ChassisTypeName'], keep_original=True)","1d5c3ebe":"train[['HasDetections', 'Census_PowerPlatformRoleName_label_encoded', 'Census_MDC2FormFactor_label_encoded', 'Census_ChassisTypeName_label_encoded']].corr()","c467a293":"<a id=\"3\"><\/a>\n# OsPlatformSubRelease \/ Census_OSBranch","a5b22c36":"Making a simple label encoding for this two features","665fb050":"And printing out a correlation martix for them within the whole dataset","dfcfb6c3":"Numbers are suspiciously similar.\n\nLets see distribution of OsVer by Platform","0539863a":"Correlation of this features in training datasets along with HasDetections","95a9037a":"The values and detection rate are almost equal for **rs4** and **rs2** in both of this features.\n\nBut **Census_OSBranch** contains more specified information about **rs3** release, which is split in two subcategories.","a69efdc7":"Another example of higly correlated features, but this time we have a little difference in the values. OsPlatformSubRelease has only rs3 release whereas Census_OSBranch contains the same information but splitted into two subcategories of rs3 release: rs3_release and rs3_release_svc_escrow.\n\nAlso Census_OSBranch has 32 different values whilst OsPlatformSubRelease has only 9","b979da1b":"Values in this features are almost the same. One of them can be easily removed, or even both of them.","322f84ba":"The distibution almost the same and correlation with HasDetections as well.\n\nNext doing simple label encoding and building a correlation matrix. First for the whole dataset and then only for training set also including 'HasDetections'","1e652c46":"Not only the numbers but the names of the values looks the same.","784b049b":"Another case of similar numbers. ","586173e9":"<a id=\"9\"><\/a>\n# Census_OSBuildNumber \/ OsBuild","c8b72188":"<a id=\"2\"><\/a>\n# Processor \/ Census_OSArchitecture","bcc1eced":"<a id=\"4\"><\/a>\n# OsVer \/ Platform\n<a id=\"5\"><\/a>\n## Correlation","c64fe057":"And the distribution is almost the same. Again doing label encoding and looking at the correlation.","d8d1422e":"The dataset, provided by Microsoft, containt some features, that are higly correlated with each other and some of them are even completely the same. This kernel is all about this kind of features.\n\n**Content**\n\n* [Loading data](#1)\n* [Processor \/ Census_OSArchitecture](#2)\n* [OsPlatformSubRelease \/ Census_OSBranch](#3)\n* [OsVer \/ Platform:](#4)\n    \n    A. [Correlation](#5)\n    \n    B. [Interaction](#6)\n* [Census_OSEdition \/ Census_OSSkuName](#7)\n* [Census_OSInstallLanguageIdentifier \/ Census_OSUILocaleIdentifier](#8)\n* [Census_OSBuildNumber \/ OsBuild](#9)\n* [Census_PowerPlatformRoleName \/ Census_MDC2FormFactor \/ Census_ChassisTypeName](#10)","88dff6e5":"<a id=\"7\"><\/a>\n# Census_OSEdition \/ Census_OSSkuName","9c7fa726":"Libraries versions been used in this kernel (usefull for results reproducibility)","c4cce18c":"<a id=\"10\"><\/a>\n# Census_PowerPlatformRoleName \/ Census_MDC2FormFactor \/ Census_ChassisTypeName","847453ee":"Distribution of OsVer by Platform is as follows:\n* Windows 10: mostly 10.0.0.0\n* Windows 8: mostly 6.3.0.0\n* Windows 7: mostly 6.1.1.0\n* Windows 2016: only 10.0.0.0","52dfe2c0":"<a id=\"1\"><\/a>\n# Loading data","2c8f36ad":"For now we can see that they are highly correlated","2bfbcd07":"Even though these two features are highly correlated there is some difference in detection rate when they are interracting with each other. As an example you can see that if users OS is Windows 10 and his OS Version is 10.0.0.0 (which is most likely) then the detection rate for the presented dataset is around 0.5. But if the user has Windows 2016 with the same 10.0.0.0 OS Version then detection rate is lower than 0.4.\nAlthough the percentage of such cases is very low it might be worth trying to keep both of thease features or maybe create some new features from their interraction.","11b0a81f":"<a id=\"6\"><\/a>\n## Interaction\nGonna make some plots to see how OS Versions are distributed by Platforms also with respect to a malware detection rate.","1a93a878":"<a id=\"8\"><\/a>\n# Census_OSInstallLanguageIdentifier \/ Census_OSUILocaleIdentifier","f930c34a":"Once again numbers and names look similar","958ed3c6":"Though correlation of this 3 features is not that big"}}