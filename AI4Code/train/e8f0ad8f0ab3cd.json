{"cell_type":{"6db8912f":"code","f5b12aba":"code","ec0c00f4":"code","f98fb448":"code","a7a7b594":"markdown","76f3bdfc":"markdown","bf41a1e7":"markdown","212f8b5a":"markdown","f57b5a00":"markdown","577b11c3":"markdown"},"source":{"6db8912f":"pacman::p_load(sf,sp,stringr,readxl,dplyr,leaflet,leaflet.minicharts)\n\n# leaflet world map url\ntilesURL <- \"http:\/\/server.arcgisonline.com\/ArcGIS\/rest\/services\/Canvas\/World_Light_Gray_Base\/MapServer\/tile\/{z}\/{y}\/{x}\"\n\n# Geo-Spatial Data\nB = read_excel(\"data\/BR.xlsx\")\nB$GDP = B$GDP %>%\n  str_remove(\",\") %>% str_extract(\"^[0-9\\\\.]+\") %>% as.numeric\nG = st_read(\"data\/BRUFE250GC_SIR.shp\")[B$sfid,]\nB = cbind(B, st_centroid(G) %>% st_coordinates)\nnames(B)[12:13] = c('lng','lat')","f5b12aba":"load(\"data\/olist.rdata\")\nO2 = left_join(I[,c(1,4)], S[,c(1,4)]) %>% \n  left_join(O) %>% \n  left_join(C[,c(1,5)]) %>% \n  rename(from=seller_state, to=customer_state)","ec0c00f4":"O2$month = format(O2$order_delivered_customer_date, \"%Y-%m\")\n# table(O2$month)\n\ndx = do.call(rbind, lapply(names(table(O2$month))[6:23], function(m) {\n  df = S10 \n  or = O2  %>% filter(month == m, from%in%s10 | to%in%s10) %>% \n  mutate_at(vars(from,to), factor, levels=sort(s10)) %>% \n  mutate(delay = order_delivered_customer_date > order_estimated_delivery_date)\n  mx = xtabs(~from+to, or)\n  df$Intra = diag(mx)\n  df$Import = colSums(mx) - diag(mx)\n  df$Export = rowSums(mx) - diag(mx)\n  df$total = df$Intra + df$Import + df$Export\n  df$fromSP = mx[\"SP\",]\n  df$toSP = mx[,\"SP\"]\n  df$fromDelay = tapply(or$delay, or$to, mean, na.rm=T)\n  df$toDelay = tapply(or$delay, or$from, mean, na.rm=T)\n  df$month = m\n  df\n  }))\n# summary(dx)\n\n# coloring \nx = c(-Inf,0.05,0.10,0.15,Inf) \ncols = c(\"green\",\"orange\",\"magenta\",\"red\")\ndx$fromColor = cut(dx$fromDelay, x, cols) %>% as.character\ndx$toColor = cut(dx$toDelay, x, cols) %>% as.character\n\n# lng\/lat adjustment\ndx2 = dx %>% \n  mutate_at(vars(lat,latSP), \n            ~ifelse(stCode%in%c(\"DF\",\"GO\"), ., .+0.2) ) %>% \n  mutate_at(vars(lng,lngSP), \n            ~ifelse(stCode%in%c(\"DF\",\"GO\"), .+0.2, .) )","f98fb448":"basemap %>% \n  addFlows(\n    dx$lngSP, dx$latSP, dx$lng, dx$lat, \n    flow=dx$fromSP, color = dx$fromColor, \n    opacity = 0.4, maxThickness = 40, time = dx$month) %>% \n  addFlows(\n    dx2$lng, dx2$lat, dx2$lngSP, dx2$latSP, \n    flow=dx2$toSP, color = dx2$toColor, \n    opacity = 0.4, maxThickness = 40, time = dx2$month) %>% \n  addMinicharts(\n    dx$lng, dx$lat, type = \"pie\", time = dx$month,\n    chartdata = dx[,c(\"Intra\",\"Import\",\"Export\")],\n    colorPalette = c(\"lightgray\", \"purple\", \"green\"),\n    width = 100 * sqrt(dx$total) \/ sqrt(max(dx$total))\n    )","a7a7b594":"Facing the dazzling numbers in general logistics information, what should we do to clarify on this issue? Don't worry! We'll tell you how to observe the number of logistics shipments between regions and the delay time of logistics via R language. The interactive map will let you know everything at a glance! \ud83d\ude03","76f3bdfc":"> Load package and graphics","bf41a1e7":"> Dynamic logistics map of St. Paul","212f8b5a":"> Import the location of customers and vendors","f57b5a00":"We used \"***[Brazilian E-Commerce Public Dataset by Olist](https:\/\/www.kaggle.com\/olistbr\/brazilian-ecommerce)***\" on Kaggle and picked St. Paul as a demonstration.","577b11c3":"![logistics map](https:\/\/cdn-images-1.medium.com\/max\/1200\/1*1R1eAyvAApFc-vs9zQGXnA.gif)"}}