{"cell_type":{"607f1801":"code","449556f1":"code","ce91b3c8":"code","932a04fd":"code","563bdfa0":"code","08b4f893":"code","9ffe3507":"code","5489925c":"code","a83210ab":"code","fcd240f7":"code","6c264f84":"code","f2f0ac2e":"code","2a686eb6":"code","3b3ac2b7":"markdown","002f428f":"markdown","b0f6ae23":"markdown","1d13ae79":"markdown"},"source":{"607f1801":"import requests\nimport pandas as pd\n\nfrom tqdm.notebook import tqdm","449556f1":"def get_restcountries(countries):\n    \"\"\"Retrieve all available fields from restcountries API\n    https:\/\/github.com\/apilayer\/restcountries#response-example\"\"\"\n    \n    api = 'https:\/\/restcountries.eu\/rest\/v2'\n    rdfs = []\n    for country in tqdm(countries):      \n        r = requests.get(f'{api}\/name\/{country}?fullText=true').json()\n        if len(r) != 1:\n            r = requests.get(f'{api}\/name\/{country}?fullText=false').json()\n            if len(r) != 1:\n                try:\n                    alpha3 = {\n                        'Channel Islands': None, #['GGY', 'JEY'],\n                        'Congo (Brazzaville)': 'COG',\n                        'Congo (Kinshasa)': 'COD',\n                        'Czechia': 'CZE',\n                        'Diamond Princess': None,\n                        'Iran': 'IRN',\n                        'Korea, South': 'PRK',\n                        'North Macedonia': 'MKD',\n                        'St Martin': 'MAF',\n                        'Taiwan*': 'TWN',\n                        'Virgin Islands': 'VIR',\n                    }\n                    r = requests.get(f'{api}\/alpha\/{alpha3[country]}')\n                    r = [r.json()] if r.status_code == 200 else []\n                except:\n                    r = []\n        rdf = pd.DataFrame(r)\n        rdf['country'] = country\n        rdfs.append(rdf)\n    return pd.concat(rdfs, sort=False).set_index('country')","ce91b3c8":"def get_datausa():\n    \"\"\"Retrieve population on state level from datausa.io\n    https:\/\/datausa.io\/about\/api\/\"\"\"\n    \n    datausa = pd.DataFrame(requests.get('https:\/\/datausa.io\/api\/data?drilldowns=State&measures=Population&year=latest', headers={'User-Agent': ''}).json()['data'])\n    datausa = datausa[['State', 'Population']]\n    datausa.columns = ['state', 'population']\n    datausa['region'] = 'Americas'\n    datausa['subregion'] = 'Northern America'\n    return datausa.set_index('state')","932a04fd":"# https:\/\/en.wikipedia.org\/wiki\/List_of_Canadian_provinces_and_territories_by_population\nwiki_canada = {\n    'Alberta': 4413146,\n    'British Columbia': 5110917,\n    'Manitoba': 1377517,\n    'New Brunswick': 779993,\n    'Newfoundland and Labrador': 521365,\n    'Nova Scotia': 977457,\n    'Ontario': 14711827,\n    'Prince Edward Island': 158158,\n    'Quebec': 8537674,\n    'Saskatchewan': 1181666,\n}\ncanada = pd.DataFrame({'population': wiki_canada, 'region': 'Americas', 'subregion': 'Northern America'})","563bdfa0":"# https:\/\/en.wikipedia.org\/wiki\/States_and_territories_of_Australia\nwiki_australia = {\n    'Australian Capital Territory': 426709,\n    'New South Wales': 8089526,\n    'Northern Territory': 245869,\n    'Queensland': 5095100,\n    'South Australia': 1751693,\n    'Tasmania': 534281,\n    'Victoria': 6594804,\n    'Western Australia': 2621680,\n}\naustralia = pd.DataFrame({'population': wiki_australia, 'region': 'Oceania', 'subregion': 'Australia and New Zealand'})","08b4f893":"# https:\/\/en.wikipedia.org\/wiki\/List_of_Chinese_administrative_divisions_by_population\nwiki_china = {\n    'Anhui': 62550000,\n    'Beijing': 21710000,\n    'Chongqing': 30750000,\n    'Fujian': 39110000,\n    'Gansu': 26260000,\n    'Guangdong': 111690000,\n    'Guangxi': 48850000,\n    'Guizhou': 35550000,\n    'Hainan': 9170000,\n    'Hebei': 75200000,\n    'Heilongjiang': 37890000,\n    'Henan': 95590000,\n    'Hubei': 59020000,\n    'Hunan': 68600000,\n    'Inner Mongolia': 25290000,\n    'Jiangsu': 80290000,\n    'Jiangxi': 46220000,\n    'Jilin': 27170000,\n    'Liaoning': 43690000,\n    'Ningxia': 6820000,\n    'Qinghai': 5980000,\n    'Shaanxi': 38350000,\n    'Shandong': 100060000,\n    'Shanghai': 24180000,\n    'Shanxi': 36820000,\n    'Sichuan': 83020000,\n    'Tianjin': 15570000,\n    'Tibet': 3370000,\n    'Xinjiang': 24450000,\n    'Yunnan': 48010000,\n    'Zhejiang': 56570000,\n}\nchina = pd.DataFrame({'population': wiki_china, 'region': 'Asia', 'subregion': 'Eastern Asia'})","9ffe3507":"#https:\/\/en.wikipedia.org\/wiki\/Channel_Islands\nwiki_channel_islands = {'Channel Islands': 170499}\nchannel_islands = pd.DataFrame({'population': wiki_channel_islands, 'region': 'Europe', 'subregion': 'Northern Europe'})","5489925c":"# https:\/\/en.wikipedia.org\/wiki\/2020_coronavirus_pandemic_on_cruise_ships\nwiki_diamond_princess = {'Diamond Princess': 3711}\ndiamond_princess = pd.DataFrame({'population': wiki_diamond_princess, 'region': 'Asia', 'subregion': 'Eastern Asia'})","a83210ab":"train = pd.read_csv('\/kaggle\/input\/covid19-global-forecasting-week-4\/train.csv', parse_dates=['Date'])\ntrain.columns = ['id', 'province_state', 'country_region', 'date', 'confirmed', 'fatal']\n\n# use its alternative name otherwise will overlap with US state Georgia\ntrain['country_region'].update(train['country_region'].str.replace('Georgia', 'Sakartvelo'))\n\ntrain['entity'] = train['province_state'].where(~train['province_state'].isna(), train['country_region'])\n\ncountries = train['entity'].unique()\nfeatures = get_restcountries(countries)[['region', 'subregion', 'population']]\n\nfor chunk in [get_datausa(), canada, australia, china, channel_islands, diamond_princess]:\n    features = features.combine_first(chunk)\nfeatures","fcd240f7":"covid = train[['date', 'entity', 'confirmed', 'fatal']].join(features, on='entity')\n\n# gets rid of some data anomalies where cumulative series would drop\ncovid['confirmed'] = covid.groupby('entity')['confirmed'].cummax()\ncovid['fatal'] = covid.groupby('entity')['fatal'].cummax()\n\ncovid[['confirmed', 'fatal', 'population']] = covid[['confirmed', 'fatal', 'population']].fillna(0).astype('int')\ncovid.sample(20)","6c264f84":"covid.groupby('entity').max().pivot_table(index='region', aggfunc='sum', margins=True)","f2f0ac2e":"covid.to_csv('covid.csv', index=False)","2a686eb6":"covid['date'].max()","3b3ac2b7":"# Defining API Calls","002f428f":"# Bringing It All Together","b0f6ae23":"# Sanity Check","1d13ae79":"# Manual Sourcing from Wikipedia"}}