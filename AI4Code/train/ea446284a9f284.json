{"cell_type":{"51e71053":"code","97ccbd0e":"code","19c57fc7":"code","742a0c0d":"code","6757ccf7":"code","a1794617":"code","e7c41501":"markdown","d78e574d":"markdown","07d893f4":"markdown","b7b9e19f":"markdown","5a074a02":"markdown","2b98098e":"markdown","729e2585":"markdown","f44d84b6":"markdown"},"source":{"51e71053":"import numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\nimport pylab as pl # an other interface to matplotlib\nfrom matplotlib.gridspec import GridSpec # more advanced subplots layout\n\n# Loading data\ndf_2017 = pd.read_csv('..\/input\/schengen-visa-stats\/2017-data-for-consulates.csv')\ndf_2018 = pd.read_csv('..\/input\/schengen-visa-stats\/2018-data-for-consulates.csv')\ndf_2017['year'] = 2017\ndf_2018['year'] = 2018\n# adding extra information: the year\ndf = pd.concat([df_2017, df_2018])\nprint(df.columns)","97ccbd0e":"\n\n# Data cleaning\n# dropping data we won't use\ndf.drop(\n    [\n        'Airport transit visas (ATVs) applied for ',\n        ' ATVs issued (including multiple)',\n        'Multiple ATVs issued',\n        'ATVs not issued ',\n        'Not issued rate for ATVs',\n        'Not issued rate for ATVs and uniform visas ',\n        'Not issued rate for uniform visas',\n        'Total ATVs and uniform visas applied for',\n        'Total ATVs and uniform visas issued  (including multiple ATVs, MEVs and LTVs) ',\n        'Total ATVs and uniform visas not issued',\n        'Not issued rate for uniform visas',\n        'Share of MEVs on total number of uniform visas issued',\n\n    ],\n    axis=1,\n    inplace=True\n)\n# renaming columns\ndf.rename(\n    columns={\n        'Schengen State': 'schengen_state',\n        'Country where consulate is located': 'country',\n        'Consulate': 'city',\n        'Uniform visas applied for': 'applications',\n        'Total  uniform visas issued (including MEV) \\n': 'tuv_issued',\n        'Multiple entry uniform visas (MEVs) issued': 'mev_issued',\n        'Total LTVs issued': 'ltv_issued',\n        'Uniform visas not issued': 'tuv_not_issued',\n    },\n    inplace=True\n)\n\n# fixing data format: to string to int\/float when possible (for the fields where it makes sense)\ndef us_format_to_int(value):\n    try:\n        return int(value.replace(',', '')) if isinstance(value, str) else value\n    except ValueError:\n        return np.NaN\n\n\nfor col in ['applications', 'mev_issued', 'tuv_issued', 'ltv_issued', 'tuv_not_issued']:\n    df[col] = df[col].apply(lambda r: us_format_to_int(r))\n\nprint(df.head())","19c57fc7":"# ---- who goes where ? \/ who wants to go where?\ncountry2schengen_state_stats = df.groupby(['schengen_state', 'country']).sum()[['applications', 'mev_issued']].reset_index().sort_values(by=['schengen_state', 'country'])\n# for the two following, we sort by nb of applications since this will be the axis order for our next graph>\n# other possible choice: sort by state\/country name\nschengen_state_stats = df.groupby(['schengen_state']).sum()[['applications', 'mev_issued']].reset_index().sort_values(by=['applications'], ascending=False).reset_index()\ncountry_stats = df.groupby(['country']).sum()[['applications', 'mev_issued']].reset_index().sort_values(by=['applications'], ascending=False).reset_index()\nprint(country2schengen_state_stats)\nprint(schengen_state_stats.head())\nprint(country_stats.head())","742a0c0d":"# we now add an index to our sorted data: this index will be used to ensure everying is displayed in the correct order \n# over the x and y axis through the various graphs (ticks values)\nschengen_state_order2index = {schengen_state_stats.schengen_state[i]: i for i in range(len(schengen_state_stats.schengen_state))}\ncountry2index = {country_stats.country[i]: i for i in range(len(country_stats.country))}\n\ncountry2schengen_state_stats['ss_index'] = country2schengen_state_stats.schengen_state.apply(lambda r: schengen_state_order2index[r])\ncountry2schengen_state_stats['cc_index'] = country2schengen_state_stats.country.apply(lambda r: country2index[r])\nschengen_state_stats['ss_index'] = schengen_state_stats.schengen_state.apply(lambda r: schengen_state_order2index[r])\ncountry_stats['cc_index'] = country_stats.country.apply(lambda r: country2index[r])","6757ccf7":"def plot_visa_counts(country2schengen_state_stats, schengen_state_stats, country_stats, keys=None, extra_margin=9, figsize=(16, 16)):\n    fig = pl.figure(num=None, figsize=figsize, dpi=80, facecolor='w', edgecolor='k')\n\n    gs = GridSpec(4, 4)\n\n    ax_joint = fig.add_subplot(gs[1:4, 0:3])\n\n    ax_joint.set_xticks(range(len(schengen_state_stats.schengen_state)))\n    ax_joint.set_xticklabels(schengen_state_stats.schengen_state, rotation=70)\n    ax_joint.set_yticks(range(len(country_stats.country)))\n    ax_joint.set_yticklabels(country_stats.country)\n    ax_joint.set_xlim(-1, len(schengen_state_stats.schengen_state) + 1)\n    ax_joint.set_ylim(-1 - extra_margin, len(country_stats.country) + 1)\n\n    ax_marg_x = fig.add_subplot(gs[0, 0:3])\n    ax_marg_x.set_xticks(range(len(schengen_state_stats.schengen_state)))\n    ax_marg_x.set_xticklabels(schengen_state_stats.schengen_state)\n    ax_marg_x.set_xlim(-1, len(schengen_state_stats.schengen_state) + 1)\n    ax_marg_y = fig.add_subplot(gs[1:4, 3])\n\n    ax_marg_y.set_yticks(range(len(country_stats.country)))\n    ax_marg_y.set_yticklabels(country_stats.country)\n    ax_marg_y.set_ylim(-1 - extra_margin, len(country_stats.country) + 1)\n\n    keys = ['applications', 'mev_issued'] if keys is None else keys\n    width = 0.7 \/ len(keys)\n    for i, key in enumerate(['applications', 'mev_issued']):\n        # for the size of the dots (s), we use square root: from the doc -> s :\n        # scalar or array_like, shape (n, ), optional\n        # The marker size in points**2. Default is rcParams['lines.markersize'] ** 2.\n        ax_joint.scatter(country2schengen_state_stats['ss_index'], country2schengen_state_stats['cc_index'], s=1 * np.sqrt(country2schengen_state_stats[key]), alpha=0.3)\n        ax_marg_x.bar(schengen_state_stats['ss_index'] + (i-0.5)*width, schengen_state_stats[key], width=width, alpha=0.5, label=key)\n        ax_marg_y.barh(country_stats['cc_index'] + (i-0.5)*width, country_stats[key], height=width, alpha=0.5)\n\n    # Turn off tick labels on marginals\n    pl.setp(ax_marg_x.get_xticklabels(), visible=False)\n    pl.setp(ax_marg_y.get_yticklabels(), visible=False)\n\n    # Set labels on joint\n    ax_joint.set_xlabel('Schengen States')\n    ax_joint.set_ylabel('Applying Countries')\n\n    # Set labels on marginals\n    ax_marg_y.set_xlabel('VISA \/ Schengen state')\n    ax_marg_x.set_ylabel('VISA \/ Applying country')\n    \n    ax_marg_x.legend(loc='upper right')\n    pl.suptitle('Schengen VISA applications and issued (mev)', size=16)\n    pl.tight_layout()\n    pl.show()\n\n\nplot_visa_counts(country2schengen_state_stats, schengen_state_stats, country_stats, keys=None, figsize=(18, 26))\n","a1794617":"schengen_state_stats_small = schengen_state_stats.head(16)\ncountry_stats_small = country_stats.head(16)\ncountry2schengen_state_stats_small = country2schengen_state_stats[country2schengen_state_stats.apply(lambda r: r.cc_index in set(country_stats_small.cc_index) and r.ss_index in set(schengen_state_stats_small.ss_index), axis=1)]\nplot_visa_counts(country2schengen_state_stats_small, schengen_state_stats_small, country_stats_small, keys=None, extra_margin=1)","e7c41501":"Let's prepare the data a bit more to make some graphs. Basically just creating scalar indexes associated with labels (countries, states), easier to work this way for the coming graphs.","d78e574d":"**First graph: too much information?**\n----\n\n**At the center:** for each Schengen state (x) and applying country (x), sorted by number of applications (see previous block), the two circles at the x\/y intersection represents the number of applications (blue) and the number of VISA issued for the given state\/country couple\n\n**top:** VISA applications (blue) and issued VISAs (yellow) per Schengen state\n\n**left:** VISA applications (blue) and issued VISAs (yellow) per Aplying Country","07d893f4":"**Data loading**\n----\n\nI am using the two CSV files and we will keep the year information to see if any VISA applications trends might change over these two years (remember this is only two years so it might be very annecdotal)","b7b9e19f":"**A quick analysis**\n----\nJust a few informations we can take from this graph:\n- **Some schengen states are stricter than other**: top graph, France VS Germany for example: Frances recieves way more applications than Germany does but issues less VISAs\n- **Certain schengen states recieve applications from everywhere, some heavily from just a few country**: France, Germany, Italy or the Netherlands have an important variety of countries applying (even tho you can notice a few differences), while Finland for example mostly recieves applications from Russia.\n- **The same way, certain countries mostly apply at specific schengen state**s: Algeria With France, Belarus with Poland and Lituania, Morocco with Spain and France etc...\n- **Schengen States have heavily different VISA issual rates for a same country of application**: France or Spain rejects a lot of applications coming from China while Germany doesn't, while these 3 states issual rate for russian applications are roughly the same.\n- **Some applications origins are way more likely to be rejected than others**: Algeria has more applications sent overall than Belarus but less are approved. A note: noce how Belarus applies to states with high acceptation ratios and Algeria low acceptation. Then again, who can first, the chicken or the egg? Does Belarus gets a higher ratio of accepted VISA because it applies to high acceptation states (eg Lithuania) or or does Lithuania has a high acceptation rate because most applications come from Belarus, a country with a high acceptation rate? \n\nThese are just a few examples and a lot more can be found by digging into this data.\n\n**IMPORTANT REMINDER**: *the idea here is not to discuss why these relations between certain countires exist (than can be multiple: common history, colonialism, langauge, geographical closeness), simply to point our that a simple graph like that already allows to notice certain patterns of human population mouvement already and such. Same for why certain countries get rejected more \/ why certain couple don't work as well: this graph only gives what's actually happens, not the reason (quotas, application qualities, temporary political tensions, again common history...)*\n","5a074a02":"**Grouping data to look for insights**\n----\n\nWe will first have a look at which coutries (meaning consulates in the given country) applies to which schengen state","2b98098e":"**Let's zoom in**\n----\n\n**Can anyone read anything?** Maybe it's not too bad on a huge display but here it's a little too packed to see any interesting information.\nLet's filter things a bit: the 16 most popular Schengen states and the 16 most common VISA sources.\n\nAGAIN:\n\n**At the center:** for each Schengen state (x) and applying country (x), sorted by number of applications (see previous block), the two circles at the x\/y intersection represents the number of applications (blue) and the number of VISA issued for the given state\/country couple\n\n**top:** VISA applications (blue) and issued VISAs (yellow) per Schengen state\n\n**left:** VISA applications (blue) and issued VISAs (yellow) per Aplying Country","729e2585":"**Basic data cleaning**\n----\n\n3 steps here:\n- removing any data we won't use\n- renaming columns to make the data more easily usable\n- changing data types to ones easier to work with \/ fixing or invalidating bad values (ex: a summary row containing strings with '%' in a numeric column) ","f44d84b6":"**Who wants to go where?**\n----\n\nAnalysing population flux through VISA applications.\n\n*NOTE: given the data provided, this focuses on people that NEED a Visa for their Schengen trip*\n\nThe objective is to see if any trends are able to emerge, such as:\n- Certain VISA country sources looking to visit a specific Schengen states much more than the average\n- Certain Schengen states denying more VISAs from a certain origin than the average etc...\n\nThis is also an example of basic data processing in pandas and a discussing about how much information is too much information on a graph"}}