{"cell_type":{"a023bc75":"code","09f3fef8":"code","425af2b1":"code","bac045e8":"code","88e0ecc0":"code","6d831f2f":"code","c21b07d6":"code","62c0c3df":"code","c4158be7":"code","239099c3":"code","d7a3a63b":"code","5b3f4e5d":"code","627e9220":"code","4b594006":"code","9bb3d7d4":"code","eff90eaa":"code","54c57259":"code","8c40e846":"code","fa6f961a":"code","6d7107b6":"code","872ac0c1":"code","02f58511":"code","7d58e3ed":"markdown","a549b4d1":"markdown","75134452":"markdown","b00eea43":"markdown","f31725b9":"markdown","d8e7c028":"markdown","b77617d8":"markdown","9d7eb389":"markdown","d670a82b":"markdown","02db45a7":"markdown","89b71206":"markdown","258c21c0":"markdown","f6002ab7":"markdown"},"source":{"a023bc75":"import os\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\nbrands = []\ndf = pd.DataFrame()\nfor dirname, _, filenames in os.walk('\/kaggle\/input'):\n    for filename in filenames:\n        b = filename.split('.')\n        #if filename[:7] != 'unclean': # all brands\n        if b[0] == 'audi': # only audy brand\n            brands.append(b[0])\n            x = pd.read_csv(os.path.join(dirname, filename))\n            x['brand'] = b[0]\n            df = df.append(x)\n            print(os.path.join(dirname, filename))","09f3fef8":"from tabulate import tabulate\nimport seaborn as sns, matplotlib.pyplot as plt\nimport warnings\n# ML Algoritmos\nfrom sklearn.ensemble import RandomForestRegressor, GradientBoostingRegressor\nfrom sklearn.tree import DecisionTreeRegressor\nfrom sklearn.linear_model import LinearRegression, LogisticRegression, PoissonRegressor\nfrom sklearn.svm import SVR\nfrom sklearn.naive_bayes import GaussianNB\nfrom sklearn.dummy import DummyRegressor\n\n# ML selecao de dados de treino e teste\nfrom sklearn.model_selection import train_test_split\n# calcular o menor erro medio absoluto entre 2 dados apresentados\nfrom sklearn.metrics import mean_absolute_error\nimport os\n\nwarnings.filterwarnings('ignore')","425af2b1":"def eda(dataset, title='EDA'):\n    print(f'=={title}==')\n    print('INFO \\n')\n    print(tabulate(dataset.info(), headers='keys', tablefmt='psql'))\n    print('\\nHEAD \\n', tabulate(dataset.head(), headers='keys', tablefmt='psql'))\n    print('\\nTAIL \\n', tabulate(dataset.tail(), headers='keys', tablefmt='psql'))\n    print('\\nDESCRIBE \\n', tabulate(dataset.describe(), headers='keys', tablefmt='psql'))\n    print('\\n5 SAMPLES \\n', tabulate(dataset.sample(5), headers='keys', tablefmt='psql'))\n    print('\\nNULLS QTY \\n', dataset.isnull().sum())\n    print('\\nSHAPE \\n', tabulate([dataset.shape], headers=['rows', 'cols'], tablefmt='psql'))","bac045e8":"eda(df)","88e0ecc0":"df = df.fillna(0)\ndf.isnull().sum()","6d831f2f":"models = df['model'].unique()\ntransmissions = df['transmission'].unique()\nfuelTypes = df['fuelType'].unique()","c21b07d6":"def txtToNum(txt, mylist):\n    return list(mylist).index(txt)\n\ndf['brandN'] = df['brand'].apply(lambda field: txtToNum(field, brands))\ndf['modelN'] = df['model'].apply(lambda field: txtToNum(field, models))\ndf['transmissionN'] = df['transmission'].apply(lambda field: txtToNum(field, transmissions))\ndf['fuelTypeN'] = df['fuelType'].apply(lambda field: txtToNum(field, fuelTypes))","62c0c3df":"df.sample(10)","c4158be7":"def correlacao(df, varT, xpoint=-0.5, showGraph=True):\n    corr = df.corr()\n    print(f'\\nFeatures correlation:\\n'\n          f'Target: {varT}\\n'\n          f'Reference.: {xpoint}\\n'\n          f'\\nMain features:')\n    if showGraph:\n        sns.heatmap(corr,\n                    annot=True, fmt='.2f', vmin=-1, vmax=1, linewidth=0.01,\n                    linecolor='black', cmap='RdBu_r'\n                    )\n        plt.title('Correlations between features w\/ target')\n        plt.show()\n\n    corrs = corr[varT]\n    features = []\n    for i in range(0, len(corrs)):\n        if corrs[i] > xpoint and corrs.index[i] != varT:\n            print(corrs.index[i], f'{corrs[i]:.2f}')\n            features.append(corrs.index[i])\n    return features","239099c3":"varT = 'price'\nvarF = correlacao(df, varT, xpoint=0.1, showGraph=True)","d7a3a63b":"print(f'Target: {varT}\\n'\n      f'Features: {list(varF)}')","5b3f4e5d":"# regressor used\ndef mlAlgoritmos():\n    regressores = [\n        DecisionTreeRegressor(),\n        RandomForestRegressor(),\n        SVR(),\n        LinearRegression(),\n        GradientBoostingRegressor(),\n        PoissonRegressor(),\n        DummyRegressor(),\n        LogisticRegression(),\n        GaussianNB()\n    ]\n    return regressores","627e9220":"# choosing best model\ndef melhorModelo(mlData, mlAlgoritmo, varFeatures, varTarget, exibe=False, exibeGrafico=False):\n    # vamos selecionar os dados de treino e testes\n\n    print(f'\\n\\nAnalizing Regressors ML')\n\n    X = mlData[varFeatures]\n    y = mlData[varTarget]\n\n    Xtreino, Xteste, ytreino, yteste = train_test_split(X, y, test_size=0.3, random_state=123)\n\n    # applying regressors\n    reg = []\n    mae = []\n    sco = []\n\n    for regressor in mlAlgoritmo:\n        modelo = regressor\n\n        # training model\n        try:\n            modelo.fit(Xtreino, ytreino)\n            sco.append(modelo.score(Xtreino, ytreino))\n            previsao = modelo.predict(Xteste)\n            mae.append(round(mean_absolute_error(yteste, previsao), 2))\n            reg.append(regressor)\n        except:\n            pass\n\n    meuMae = pd.DataFrame(columns=['Regressor', 'mae', 'score'])\n    meuMae['Regressor'] = reg\n    meuMae['mae'] = mae\n    meuMae['score'] = sco\n    meuMae = meuMae.sort_values(by='mae', ascending=True)\n    if exibe:\n        print(tabulate(meuMae, headers='keys', tablefmt='psql'))\n\n    if exibeGrafico:\n        try:\n            resultado = meuMae.values[0][0].predict(Xteste)\n            ax1 = plt.subplot(322)\n            ax1.set_title('Distribution Prices')\n            sns.distplot(resultado)\n            ax2 = plt.subplot(321)\n            ax2.set_title('Results - Prices')\n            sns.boxplot(resultado)\n        \n\n            ax3 = plt.subplot(312)\n            ax3.set_title('Performance - Regressors ML')\n            g = sns.barplot(x=meuMae['Regressor'], y=meuMae['mae'])\n            g.set_xticklabels(ax3.get_xticklabels(), rotation=30)\n\n            ax4 = plt.subplot(312)\n            ax4.set_title('Performance - Score - Regressors')\n            g = sns.barplot(x=meuMae['Regressor'], y=meuMae['score'])\n            g.set_xticklabels(ax4.get_xticklabels(), rotation=30)\n            plt.show()\n        except:\n            pass\n\n    return meuMae\n","4b594006":"bestML = melhorModelo(mlData=df, mlAlgoritmo=mlAlgoritmos(),\n                               varTarget=varT, varFeatures=varF,\n                               exibe=True, exibeGrafico=False)","9bb3d7d4":"bestML['Regressor'][0] # 0=Decision Tree, 1=Random Forester .... 8=GaussianNB","eff90eaa":"def previsao(dfEscolhida, mlAlgoritmo, varFeatures, valueFeatures, varTarget, desc=''):\n\n    x = dfEscolhida[varFeatures]\n    y = dfEscolhida[varTarget]\n\n    modelo = mlAlgoritmo\n    modelo.fit(x, y)\n\n    previsao = float(modelo.predict([valueFeatures]))\n    cond = ''\n\n    print(f'Summary:\\n'\n          f'Regs analyzed: {len(dfEscolhida)}\\n'\n          f'ML applied: {mlAlgoritmo}\\n'\n          f'Features analyzed:')\n    for i in range(0, len(varFeatures)):\n        print(f' - {varFeatures[i]}: {valueFeatures[i]}')\n        cond += f\" and `{varFeatures[i]}` == {valueFeatures[i]}\"\n    print(f'Condition: {cond[5:]}')\n    print(f\"Predicted value: ${previsao:.2f} \\n\"\n          f\"Avg value: ${dfEscolhida.query(cond[5:])[varTarget].mean():.2f}\\n\\n\")\n\n    variaveis = varFeatures\n    variaveis.append(varTarget)\n    print(\n        tabulate(\n            dfEscolhida.query(cond[5:])[variaveis].head(10).sort_values(by=varTarget, ascending=False),\n            headers='keys', tablefmt='psql'\n        ), f\"\\n{dfEscolhida.query(cond[5:])[varTarget].shape}\")\n","54c57259":"def removeOutliers(out, varTarget):\n    print('\\nRemovendo Outliers')\n    cidgrp = out[varTarget]\n\n    # criando quantis\n    qtl1 = cidgrp.quantile(.25)  # exiba o valor da variavel\n    qtl3 = cidgrp.quantile(.75)\n\n    # calculando a diferenca entre os dois quantis, conhecido como interquartile range\n    iqr = qtl3 - qtl1\n    # print(qtl1, qtl3, iqr)\n\n    # gerando os limites\n    baixo = qtl1 - 1.5 * iqr\n    alto = qtl3 + 1.5 * iqr\n\n    # remover os outliers\n    novodf = pd.DataFrame()\n\n    limites = out[varTarget].between(left=baixo, right=alto, inclusive=True)\n    novodf = pd.concat([novodf, out[limites]])\n\n    # print(novodf[['city','rooms', 'rent amount (R$)']])\n\n    return novodf.copy()","8c40e846":"print('Features trained:')\nprint(f'modelN: ')\nprint(tabulate([range(0, len(brands)), brands], tablefmt='psql'))\nprint(f'transmissionN: ')\nprint(tabulate([range(0, len(transmissions)), transmissions], tablefmt='psql'))\nprint(f'fuelTypeN: ')\nprint(tabulate([range(0, len(fuelTypes)), fuelTypes], tablefmt='psql'))\n","fa6f961a":"# audi Q3 2017\ndf.query(\"brandN == 0 and modelN == 4 and year == 2017 and transmissionN == 1\").sample(10)","6d7107b6":"# example creating condition\n# features name\nvarFeaturesFilters = ['brandN', 'modelN', 'transmissionN', 'year'] \n# features values \nvalueFeaturesFilters = [0, 4,  1, 2017]","872ac0c1":"pricesNoOutliers = removeOutliers(df, varTarget=varT)","02f58511":"previsao(dfEscolhida=pricesNoOutliers, mlAlgoritmo=bestML['Regressor'][1],\n         varFeatures=varFeaturesFilters,\n         valueFeatures=valueFeaturesFilters, varTarget=varT,\n         desc='\\nPredicting price')","7d58e3ed":"Transforming cathegoricals variables (brands, models, transmissions and fueltypes) in arrays numerics","a549b4d1":"This example, best score is decision tree, best MAE is Random. I choose Decision Tree Regressor.","75134452":"ML Regressors list","b00eea43":"Libraries used","f31725b9":"Due by limit memory, I'm set the audi dataset, but only uncomment primary if and comment second if","d8e7c028":"Set possible NaN values by 0","b77617d8":"I wanna predict price of the Audi Q3 2017 with transmission automatic","9d7eb389":"# PREDICT CAR\n\nGenerate predict to car's price","d670a82b":"Choosing the best model (MAE, SCORE","02db45a7":"Function Correlation between var Target and others","89b71206":"See four last columns","258c21c0":"Function to show Explorarion Data Analysis (simple example)","f6002ab7":"Viewing EDA"}}