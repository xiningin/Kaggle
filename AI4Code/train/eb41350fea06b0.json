{"cell_type":{"1be7e240":"code","12473cae":"code","908870ae":"code","3c405e39":"code","6144bb57":"code","11b98d55":"code","5b81ad35":"code","be16e7a6":"code","b8751018":"code","8b0c6631":"code","9241fa86":"code","a92cb5b7":"code","065b8816":"markdown","4136ed8f":"markdown","96e65761":"markdown","aab89d24":"markdown","d613f579":"markdown","d6b1959c":"markdown","e4d05147":"markdown","21bc37c6":"markdown","c0f78370":"markdown","d007d649":"markdown","6b29b29f":"markdown","78b83250":"markdown"},"source":{"1be7e240":"import numpy as np \nimport pandas as pd\npd.options.display.max_rows = None\npd.options.display.max_columns = None\nimport os\n\nfrom fbprophet import Prophet\n\nimport matplotlib.pyplot as plt\nimport warnings\nwarnings.filterwarnings(\"ignore\")","12473cae":"class suppress_stdout_stderr(object):\n    def __init__(self):\n        # Open a pair of null files\n        self.null_fds = [os.open(os.devnull, os.O_RDWR) for x in range(2)]\n        # Save the actual stdout (1) and stderr (2) file descriptors.\n        self.save_fds = (os.dup(1), os.dup(2))\n\n    def __enter__(self):\n        # Assign the null pointers to stdout and stderr.\n        os.dup2(self.null_fds[0], 1)\n        os.dup2(self.null_fds[1], 2)\n\n    def __exit__(self, *_):\n        # Re-assign the real stdout\/stderr back to (1) and (2)\n        os.dup2(self.save_fds[0], 1)\n        os.dup2(self.save_fds[1], 2)\n        # Close the null files\n        os.close(self.null_fds[0])\n        os.close(self.null_fds[1])","908870ae":"train_raw = pd.read_csv('..\/input\/tabular-playground-series-jan-2022\/train.csv', parse_dates = ['date'])\ntest_raw = pd.read_csv('..\/input\/tabular-playground-series-jan-2022\/test.csv', parse_dates = ['date'])\nfull = pd.concat([train_raw, test_raw])","3c405e39":"full['seg'] = (full['country'] + full['store'] + full['product']).astype('category').cat.codes\nseg_count = full['seg'].nunique()","6144bb57":"full = full.replace({'country' : { 'Finland' : 'FI', 'Norway' : 'NO', 'Sweden' : 'SE' }})\n\n#Drop unused columns\nfull = full.drop(['store', 'product'], axis=1)\n\n#Rename columns in accordance with Prophet requirements\nfull.columns = ['row_id', 'ds', 'country' , 'y', 'seg']","11b98d55":"test = full[full['ds'] >= '2019-1-1']\nvalid = full[(full['ds'] >= '2018-1-1') & (full['ds'] < '2019-1-1') ]\ntrain = full[full['ds'] < '2018-1-1']\n\ntest = test.drop('y', axis=1)\nprint(train.shape, valid.shape, test.shape, 'Segments:', seg_count)","5b81ad35":"#Easter holidays\nEaster = pd.DataFrame({\n'holiday': 'Easter',\n'ds': pd.to_datetime(['2015-04-05', '2016-03-27', '2017-04-16', '2018-04-1', '2019-04-21']),\n'lower_window': 0,\n'upper_window': 7,\n})\n    \n#Christmas holidays\nChristmas = pd.DataFrame({\n'holiday': 'Christmas',\n'ds': pd.to_datetime(['2015-12-24', '2016-12-24', '2017-12-24', '2018-12-24', '2019-12-24']),\n'lower_window': -3,\n'upper_window': 4,\n})\n\nadd_holidays = pd.concat([Easter, Christmas])","be16e7a6":"def proph (Train, Valid, Seg):\n    #Local variables\n    TTrain = Train.loc[Train['seg'] == Seg]\n    VValid = Valid.loc[Valid['seg'] == Seg]\n    Country = TTrain.iloc[0]['country']\n\n    #Model\n    m = Prophet(\n                holidays = add_holidays, #Additional Easter and Christmas holidays\n                yearly_seasonality=52,\n                seasonality_mode='multiplicative',\n                )\n    \n    #Built-in country holidays\n    m.add_country_holidays(country_name = Country)\n    \n    #Silent script\n    with suppress_stdout_stderr():\n        m.fit(TTrain[['ds', 'y']])\n        \n    forecast = m.predict(VValid['ds'].to_frame())\n    \n    #Re-index forecast to keep original indexes for every segment\n    forecast_idx = forecast.set_index(VValid.index)\n    return forecast_idx, m, forecast ","b8751018":"result = valid[['ds','seg','y']]\nfor i in range(seg_count):\n    temp, M, Forecast = proph(train, valid, i)\n    result.loc[result['seg'] == i, 'yhat'] = round(temp['yhat'])\n#Calculate SMAPE\nresult['smape'] = 200 * abs(result.yhat - result.y) \/ (abs(result.yhat) + abs(result.y))\n#Calculate percentage error (PE)\nresult['pe'] = 100 * (result.yhat - result.y) \/ result.y\nprint('SMAPE on validation is:', \"%.3f\" % (result['smape'].mean()))","8b0c6631":"for x in range(seg_count):\n    Title1 = 'Real values \/ predictions for segment ' + str(x)\n    Title2 = 'Percentage error for segment ' + str(x)\n    #Plot real values\n    ax = result[result['seg'] == x].set_index('ds')['y'].plot(\n        color = 'gray', figsize=(18, 4),\n        title = Title1, label = 'Real values')\n    #Plot predictions\n    result[result['seg'] == x].set_index('ds')['yhat'].plot(\n        color = 'red', ax=ax, label = 'Predictions')\n    plt.legend(loc=\"upper center\")\n    plt.show()\n    #Plot error\n    ax2 = result[result['seg'] == x].set_index('ds')['pe'].plot(\n        color = 'blue', figsize=(18, 4), title=Title2)\n    plt.show()","9241fa86":"pred = test[['row_id', 'ds','seg']]\nfor i in range(seg_count):\n    temp2, a, b = proph(pd.concat([train, valid]), test, i)\n    pred.loc[pred['seg'] == i, 'yhat'] = round(temp2['yhat'])\nprint('Predictions complete')\npred.head()","a92cb5b7":"sub = pd.read_csv('..\/input\/tabular-playground-series-jan-2022\/sample_submission.csv')\nsub['num_sold'] = pred['yhat']\nsub.to_csv('submission.csv', index = False)","065b8816":"We have 3 contries, 2 stores and 3 products. It means that actually we have 3 x 2 x 3 = 18 segments and have to do all operations 18 times, for each segment.<br>\nHere I create and encode 18 segments (0-17) from ```country```, ```store``` and ```product``` features.","4136ed8f":"Although Prophet has buil-in holdays database, my experience has shown that its effect is not enough for Easter and Christmas holidays. This is why I decided to add these dates once more to get multiplicative effect. Likely Prophet let me do this.<br>\n```lower_window``` and ```upper_window``` parameters set holidays duration from the given date","96e65761":"#### Predictions","aab89d24":"I have to replace conutries names by its prefix to use it in built-in holidays feature in Prophet","d613f579":"In this function I'm setting up the model. Even though Prophet has some hyperparameters to tune after a cople days of playing I decided to use only a couple of them to avoid overfitting.<br>\nYou can read [here](https:\/\/facebook.github.io\/prophet\/docs\/diagnostics.html#hyperparameter-tuning) about parameters that can be tuned","d6b1959c":"#### Submission","e4d05147":"#### Title\nIn this notebook I would like to share my experience with Facebook [Prophet](https:\/\/facebook.github.io\/prophet\/) in TPS2022 competition.<br>\nI never ended up getting any good scores, but maybe this notebook can be useful for those who are interested in Prophet","21bc37c6":"This hidden cell is used to mute Prophet (that is very \"noisy\")","c0f78370":"#### Plots\nCaution, long output","d007d649":"Split validation set from train set. Even though Prophet has uts own cross valdation module I think train data is not enough that's why I wil use 2018 year for validation and all the rest for training and will use simple validation instead of cross validation.","6b29b29f":"#### Data loading and some preparation","78b83250":"#### Validation"}}