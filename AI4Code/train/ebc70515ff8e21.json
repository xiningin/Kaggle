{"cell_type":{"1384b123":"code","3a05c932":"code","93946819":"code","5f2be9bd":"code","464ea171":"code","5e7a21d0":"code","9beda134":"code","63f0eceb":"code","ca4aafdf":"code","ae6e2fb0":"code","19d88995":"code","2b857cf8":"code","af1c64b4":"code","7121732b":"code","9b206d53":"code","aa78e5a5":"code","4a3e9405":"code","39dbcd40":"code","1508d136":"code","296cedd3":"code","18b7adfe":"code","5f0b3fcb":"code","e04001aa":"markdown"},"source":{"1384b123":"import numpy as np\nimport pandas as pd\nimport os\nimport sys\n\nimport tensorflow as tf, tensorflow.keras.backend as K\nfrom tensorflow.keras.models import load_model\nfrom tensorflow.keras.preprocessing.image import ImageDataGenerator\nfrom matplotlib import pyplot as plt\n\nsys.path.insert(0, '\/kaggle\/input\/efficientnet-keras-source-code\/')\nimport efficientnet.tfkeras as efn\n\nprint(tf.__version__)\nprint(tf.keras.__version__)","3a05c932":"train_df = pd.read_csv(\"..\/input\/imet-2020-fgvc7\/train.csv\")\ntrain_df[\"attribute_ids\"]=train_df[\"attribute_ids\"].apply(lambda x:x.split(\" \"))\ntrain_df[\"id\"]=train_df[\"id\"].apply(lambda x:x+\".png\")\n\nprint(train_df.shape)\ntrain_df.head()","93946819":"from sklearn.preprocessing import MultiLabelBinarizer\nmlb = MultiLabelBinarizer()\n\ntrain_df_d = pd.DataFrame(mlb.fit_transform(train_df[\"attribute_ids\"]),columns=mlb.classes_, index=train_df.index)\n\nprint(train_df_d.shape)\ntrain_df_d.head()","5f2be9bd":"train_df_d[:1][['448','2429','782']]","464ea171":"label_names = train_df_d.columns","5e7a21d0":"import gc\n\ndel train_df_d\ngc.collect()","9beda134":"sam_sub_df = pd.read_csv('..\/input\/imet-2020-fgvc7\/sample_submission.csv')\n\nsam_sub_df[\"id\"]=sam_sub_df[\"id\"].apply(lambda x:x+\".png\")\n\nprint(sam_sub_df.shape)\nsam_sub_df.head()","63f0eceb":"img_size = 32","ca4aafdf":"model = load_model('\/kaggle\/input\/keras-imet2020-tpu-train\/model.h5')","ae6e2fb0":"%%time\ntest_datagen = ImageDataGenerator(rescale=1.\/255)\ntest_generator = test_datagen.flow_from_dataframe(  \n        dataframe=sam_sub_df,\n        directory = \"..\/input\/imet-2020-fgvc7\/test\",    \n        x_col=\"id\",\n        target_size = (img_size,img_size),\n        batch_size = 1,\n        shuffle = False,\n        class_mode = None\n        )","19d88995":"%%time\n\ntest_generator.reset()\nprobs = model.predict_generator(test_generator, steps = len(test_generator.filenames))","2b857cf8":"probs.shape","af1c64b4":"probs[0].mean()","7121732b":"threshold = probs[0].mean()\nlabels_01 = (probs > threshold).astype(np.int)\nlabels_01","9b206d53":"labels_01.shape","aa78e5a5":"sub = pd.DataFrame(labels_01, columns = label_names)\n\nprint(sub.shape)\nsub.head()","4a3e9405":"%%time\n\nsub['attribute_ids']=''\nfor col_name in sub.columns:\n    sub.ix[sub[col_name]==1,'attribute_ids']= sub['attribute_ids']+' '+col_name","39dbcd40":"sub.head()","1508d136":"sam_sub_df['id'] = sam_sub_df['id'].str[:-4]\nsam_sub_df.head()","296cedd3":"sam_sub_df['attribute_ids'] = sub['attribute_ids']\nsam_sub_df.head()","18b7adfe":"sam_sub_df.tail()","5f0b3fcb":"sam_sub_df.to_csv(\"submission.csv\",index=False)","e04001aa":"#### Using [pretrained model](https:\/\/www.kaggle.com\/ateplyuk\/keras-imet2020-tpu-train) on TPU for inference "}}