{"cell_type":{"20bb8f1d":"code","ea327685":"code","23f68c76":"code","05c8b6b4":"code","f635ccbb":"code","f0385e10":"code","4ed740f4":"code","dadd5cae":"code","2fb0d802":"code","f821ddf5":"code","3a115f14":"code","ef13b79c":"code","4de3513b":"code","cc754c65":"code","0634d30e":"code","85326302":"code","2206e799":"code","6e239610":"code","683427d2":"code","96745a3f":"code","eb1b336f":"code","5069488b":"code","b8ec1ab7":"code","3af11871":"code","81936cec":"code","f3bcd072":"code","d5a19991":"code","9ff56667":"code","e35161c1":"code","d9658e87":"code","e8727256":"code","5ba660e5":"code","1d6c1734":"code","c3efdd8f":"markdown","5568519e":"markdown","79477d50":"markdown","eb76bd9f":"markdown","a844b223":"markdown"},"source":{"20bb8f1d":"#!pip install -qq fastai --upgrade","ea327685":"from fastai.vision.all import *\nprint(torch.__version__)\nif torch.cuda.is_available():\n    print(torch.cuda.get_device_name(0), torch.cuda.is_available())\n\nimport fastai; print(fastai.__version__)\n!nvcc --version","23f68c76":"import os\nfor root, dirs, files in os.walk('\/kaggle\/input', topdown=False):\n    for name in dirs: print (os.path.join(root, name))","05c8b6b4":"Path.cwd()","f635ccbb":"!tree ..\/input\/ -d","f0385e10":"DATA_DIR = Path(\"..\/input\/cassava-leaf-disease-classification\")\nTRAIN_DIR = DATA_DIR\/\"train_images\"\nTEST_DIR = DATA_DIR\/\"test_images\"\nPath.BASE_PATH = DATA_DIR\nDATA_DIR, TRAIN_DIR, TEST_DIR","4ed740f4":"train_df = pd.read_csv(DATA_DIR\/\"train.csv\")\ntrain_df.head(2)","dadd5cae":"train_df['image_id'] = train_df['image_id'].apply(lambda x: f'train_images\/{x}')\ntrain_df.head(5)","2fb0d802":"idx2lbl = {0:\"Cassava Bacterial Blight (CBB)\",\n          1:\"Cassava Brown Streak Disease (CBSD)\",\n          2:\"Cassava Green Mottle (CGM)\",\n          3:\"Cassava Mosaic Disease (CMD)\",\n          4:\"Healthy\"}\n\ntrain_df['label'].replace(idx2lbl, inplace=True)\ntrain_df.head(5)","f821ddf5":"train_df.label.value_counts()","3a115f14":"TRAIN_DIR.ls()","ef13b79c":"get_image_files(TRAIN_DIR)","4de3513b":"train_df.shape","cc754c65":"# When using file path for inputs when creating datasets from a DataBlock:\ndef get_label(path):\n    fname = path.name\n    row = train_df.loc[train_df.image_id == str(\"train_images\/\" + fname)]\n    value = row.label.values[0]\n    return (value)\n\n# When using pandas datafragme as input\ndef get_x(row): return DATA_DIR \/ row.image_id\ndef get_y(row): return row.label","0634d30e":"get_image_files(TRAIN_DIR)[0:5].map(get_label)","85326302":"datablock = DataBlock(\n    blocks=(ImageBlock, CategoryBlock), \n    get_x=lambda row: DATA_DIR \/ row.image_id, #get_image_files, \n    get_y=lambda row: row.label, #get_label,\n    splitter=RandomSplitter(valid_pct=0.2, seed=42),\n    item_tfms=Resize(460),\n    batch_tfms=[RandomResizedCropGPU(224), *aug_transforms(size = 224, min_scale = 0.75), Normalize.from_stats(*imagenet_stats)]\n)","2206e799":"dls = datablock.dataloaders(train_df)\nlen(dls.train.dataset), len(dls.valid.dataset)","6e239610":"dls.show_batch(figsize=(15,10))","683427d2":"if not os.path.exists('\/root\/.cache\/torch\/hub\/checkpoints\/'):\n        os.makedirs('\/root\/.cache\/torch\/hub\/checkpoints\/')\n!cp '..\/input\/resnet50\/resnet50.pth' '\/root\/.cache\/torch\/hub\/checkpoints\/resnet50-19c8e357.pth'","96745a3f":"learner = cnn_learner(dls, resnet151, loss_func=CrossEntropyLossFlat(), metrics=accuracy)\nprint(\"cbs: \", learner.cbs)\nprint(\"loss: \", learner.loss_func)","eb1b336f":"#learner.lr_find(num_it=100)","5069488b":"! pip install wandb --upgrade -qq","b8ec1ab7":"from fastai.callback.wandb import *\nimport wandb\nrun_name = \"resnet151 5-10 wd+CutMix\"\nsettings = wandb.Settings(silent=\"True\")\nrun = wandb.init(name=run_name, project='Kaggle - Cassava Leaf Disease Classification', settings=settings)","3af11871":"lr = 0.01\nwd = 0.01\nfreeze_epochs = 5\nepochs = 10\n\ncbs = [WandbCallback(), CutMix(1.)]\n#cbs = [WandbCallback()]\n\nlearner.fine_tune(epochs, base_lr = lr, wd=wd, freeze_epochs=freeze_epochs, cbs=cbs)","81936cec":"#learner.summary()","f3bcd072":"get_image_files(TEST_DIR)","d5a19991":"sample_df = pd.read_csv(DATA_DIR\/'sample_submission.csv')\nsample_df.head()","9ff56667":"sample_copy = sample_df.copy()\nsample_copy['image_id'] = sample_copy['image_id'].apply(lambda x: f'test_images\/{x}')\nsample_copy.head()","e35161c1":"test_dl = learner.dls.test_dl(sample_copy)\ntest_dl.show_batch()","d9658e87":"preds, _ = learner.tta(dl=test_dl)\npreds","e8727256":"sample_df['label'] = preds.argmax(dim=-1).numpy()","5ba660e5":"sample_df.head()","1d6c1734":"sample_df.to_csv('submission.csv',index=False)","c3efdd8f":"## Beginner notebook for a baseline using fastai \n\n* [EDA](#EDA)\n* [DataBlock & dataloaders](#section-two)\n* [Training a model](#section-3)\n* [Predict & submit](#submit)","5568519e":"### EDA <a id=\"EDA\"><\/a>","79477d50":"## Creating DataBlock and a dataloader <a id=\"section-two\"><\/a>","eb76bd9f":"## Training  <a id=\"section-3\"><\/a>","a844b223":"## Predict and submit <a id=\"submit\"><\/a>"}}