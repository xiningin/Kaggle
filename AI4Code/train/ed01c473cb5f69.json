{"cell_type":{"b61f5927":"code","3f55f623":"code","fc4f4c5e":"code","4e4e29bc":"code","09d2696e":"code","5c145654":"code","6e8646f7":"code","42576e99":"code","4261ad98":"code","2edc1553":"code","5dc3e7d2":"code","c13bbffe":"code","7df843e7":"code","0338a1ba":"code","1e958c67":"code","98a58cd2":"code","b73ce455":"code","bc2375aa":"code","de8ca1ab":"code","b9442194":"code","9912e021":"markdown","0f94118f":"markdown","10d76e6d":"markdown","526147aa":"markdown","58aa38b5":"markdown"},"source":{"b61f5927":"%matplotlib inline\nimport pandas as pd\nimport datetime as dt\nimport os\nimport numpy as np\nfrom IPython.core.interactiveshell import InteractiveShell\nInteractiveShell.ast_node_interactivity = \"all\"\nimport matplotlib.pyplot as plt\nplt.rcParams['figure.figsize'] = [16, 10]\nplt.rcParams['font.size'] = 14\nimport seaborn as sns\nsns.set_palette(sns.color_palette('tab20', 20))\nimport plotly.offline as py\npy.init_notebook_mode(connected=True)\nimport plotly.graph_objs as go\nfrom igraph import Graph\nimport urllib.request\nfrom tqdm import tqdm\nfrom collections import Counter\nfrom itertools import combinations ","3f55f623":"pd.set_option('display.max_columns', 99)\nplt.rcParams['figure.figsize'] = [16, 10]\nplt.rcParams['font.size'] = 14","fc4f4c5e":"class MetaData():\n    def __init__(self, path='..\/input'):\n        self.path = path\n\n    def Competitions(self, nrows=None):\n        df = pd.read_csv(os.path.join(self.path, 'Competitions.csv'), nrows=nrows)\n        return df.rename(columns={'Id': 'CompetitionId'})\n\n    def TeamMemberships(self, nrows=None):\n        return pd.read_csv(os.path.join(self.path, 'TeamMemberships.csv'), nrows=nrows)\n\n    def Teams(self, nrows=None):\n        df = pd.read_csv(os.path.join(self.path, 'Teams.csv'), nrows=nrows)\n        return df.rename(columns={'Id': 'TeamId'})\n\n    def Users(self, nrows=None):\n        df = pd.read_csv(os.path.join(self.path, 'Users.csv'), nrows=nrows)\n        return df.rename(columns={'Id': 'UserId'})\n\n    def PerformanceTiers(self):\n        df = pd.DataFrame([\n            [0, 'Novice', '#5ac995'],\n            [1, 'Contributor', '#00BBFF'],\n            [2, 'Expert', '#95628f'],\n            [3, 'Master', '#f96517'],\n            [4, 'GrandMaster', '#dca917'],\n            [5, 'KaggleTeam', '#008abb'],\n        ], columns=['PerformanceTier', 'PerformanceTierName', 'PerformanceTierColor'])\n        return df","4e4e29bc":"start = dt.datetime.now()\nmd = MetaData()\n\nusers = md.Users()\ntiers = md.PerformanceTiers()\nusers = users.merge(tiers, on='PerformanceTier')\nusers.shape\nusers.head()","09d2696e":"competitions = md.Competitions()\ncompetitions = competitions[competitions.HostSegmentTitle != 'InClass']\ncompetitions['DeadlineDate'] = pd.to_datetime(competitions.DeadlineDate)\ncompetitions = competitions.sort_values(by='DeadlineDate')\ncompetitions.shape\ncompetitions.tail(2)","5c145654":"teams = md.Teams()\nteams.shape\nteams.head(2)\nmembers = md.TeamMemberships()\nmembers.shape\nmembers.head(2)","6e8646f7":"real_teams = members.groupby('TeamId')[['Id']].count().reset_index()\nreal_teams = real_teams[real_teams.Id > 1]\nreal_teams.columns = ['TeamId', 'TeamSize']\nreal_teams.shape\nreal_teams.head()\nreal_teams.TeamSize.sum(), real_teams.TeamSize.mean()\n\nteam_members = members.merge(real_teams, on='TeamId')\nteam_members.shape\nteam_members.head(3)","42576e99":"YOUR_USER_ID = 18102","4261ad98":"user_ids = team_members.UserId.unique()\nuser_ids = sorted(user_ids)\nlen(user_ids)","2edc1553":"user_edges = {u: Counter() for u in user_ids}\nfor team_id, df in tqdm(team_members.groupby('TeamId')):\n    for a, b in combinations(df.UserId.values, 2):\n        user_edges[a][b] += 1\n        user_edges[b][a] += 1","5dc3e7d2":"degrees = [[u, len(cnt)] for u, cnt in user_edges.items()]\ndegree_df = pd.DataFrame(degrees, columns=['UserId', 'TeamMateDegree'])\ndegree_df = degree_df.merge(users, on='UserId', how='left')\ndegree_df = degree_df.sort_values(by='TeamMateDegree', ascending=False)\ndegree_df['VertexId'] = np.arange(len(degree_df))\ndegree_df.shape\ndegree_df.head(20)\ndegree_df = degree_df.fillna({'PerformanceTierColor': 'grey'})\ndegree_df = degree_df.fillna('')","c13bbffe":"vertex_map = {u: v for u, v in degree_df[['UserId', 'VertexId']].values}","7df843e7":"edges = []\nedge_weights = []\nfor u1, cnt in tqdm(user_edges.items()):\n    for u2, weight in cnt.items(): \n        if u1 < u2:\n            edges.append((vertex_map[u1], vertex_map[u2]))\n            edge_weights.append(weight)","0338a1ba":"g = Graph()\ng.add_vertices(len(user_ids))\ng.add_edges(edges)\ng.vs['UserId'] = degree_df['UserId'].values\ng.vs['UserName'] = degree_df['UserName'].values\ng.es['Weight'] = edge_weights\ng.summary()","1e958c67":"clusters = g.components(mode='WEAK')\nfor sg in clusters.subgraphs():\n    if sg.vcount() > 50:\n        sg.summary()\nfor sg in clusters.subgraphs():\n    if sg.vcount() > 1000:\n        large_cluster = sg","98a58cd2":"graph_layout = large_cluster.layout('fr')\ncoords = np.array(graph_layout.coords)\nlarge_user_coords = pd.DataFrame(coords, columns=['x', 'y'])\nlarge_user_coords['UserId'] = large_cluster.vs['UserId']\n\nlarge_user_coords = large_user_coords.merge(degree_df, on='UserId')","b73ce455":"fig, ax = plt.subplots(figsize=(16, 9))\nplt.scatter(large_user_coords.x, large_user_coords.y, s=np.sqrt(large_user_coords.TeamMateDegree) * 5,\n            c=large_user_coords.PerformanceTierColor.values, alpha=0.5)\nfor e in tqdm(large_cluster.es[:]):\n    u1, u2 = e.source, e.target\n    plt.plot([large_user_coords.loc[u1, 'x'], large_user_coords.loc[u2, 'x']],\n             [large_user_coords.loc[u1, 'y'], large_user_coords.loc[u2, 'y']], 'grey', alpha=0.02)\nplt.title('Kaggle users - Giant Component')\nplt.axis('off')\nfig.savefig('users.png', dpi=600, figsize=(16, 10))\nplt.show();","bc2375aa":"p = 25\ncenter_coords = large_user_coords.copy()\ncenter_coords = center_coords[center_coords.x > np.percentile(center_coords.x, 50 - p)]\ncenter_coords = center_coords[center_coords.x < np.percentile(center_coords.x, 50 + p)]\ncenter_coords = center_coords[center_coords.y > np.percentile(center_coords.y, 50 - p)]\ncenter_coords = center_coords[center_coords.y < np.percentile(center_coords.y, 50 + p)]\ncenter_coords.shape","de8ca1ab":"data = []\nfor e in tqdm(large_cluster.es[:]):\n    u1, u2 = e.source, e.target\n    if u1 in center_coords.index and u2 in center_coords.index:\n        trace = go.Scatter(\n            x = [center_coords.loc[u1, 'x'], center_coords.loc[u2, 'x']],\n            y = [center_coords.loc[u1, 'y'], center_coords.loc[u2, 'y']],\n            mode = 'lines',\n            line=dict(color='grey', width=1),\n            opacity=0.1\n        )\n        data.append(trace)\ndata.append(\n    go.Scatter(\n        y = center_coords['y'],\n        x = center_coords['x'],\n        mode='markers',\n        marker=dict(sizemode='diameter',sizeref=1,\n                    opacity=0.5,\n                    size=np.log(center_coords.TeamMateDegree + 1)*2,\n                    color=center_coords.PerformanceTierColor.values),\n        text=center_coords.DisplayName,\n        hoverinfo = 'text',\n    )\n)\nlayout = go.Layout(\n    autosize=True,\n    title='Center of the top cluster',\n    hovermode='closest',\n    yaxis = dict(showgrid=False, zeroline=False, showline=False, showticklabels=False),\n    xaxis = dict(showgrid=False, zeroline=False, showline=False, showticklabels=False),\n    showlegend=False\n)\nfig = go.Figure(data=data, layout=layout)\npy.iplot(fig, filename='TopCluster')","b9442194":"end = dt.datetime.now()\nprint('Latest run {}.\\nTotal time {}s'.format(end, (end - start).seconds))","9912e021":"## Users\nKaggle has more than 5M registered users.","0f94118f":"## Construct the graph","10d76e6d":"## Actual team members\nMost of the registered users did not participate in competitions. Even if they did they are likely to had only a few submission for a single competition. Only a small portion of users actually teamed up.","526147aa":"## Teams","58aa38b5":"## Competitions\n\nThere were almost 400 competitions (Inclass excluded) hosted on kaggle."}}