{"cell_type":{"6ce31bae":"code","aee1f6b0":"code","291b269f":"code","560f42f9":"code","286075e1":"code","344280b0":"code","ba51db7e":"code","64fbfbce":"code","f59b9931":"code","f434311b":"code","e1e4e6fd":"code","02ff5d2d":"code","399b147a":"code","8a37a3a6":"code","a3ef1ae8":"code","f96cf2b6":"code","c8d257ef":"code","41e01452":"code","2aa291bd":"markdown"},"source":{"6ce31bae":"import os\n\nimport numpy as np\nimport pandas as pd\n\nimport matplotlib.pyplot as plt\nimport matplotlib.animation as animation\n\nfrom IPython.display import Image","aee1f6b0":"states = [\n  'Alabama','Alaska','Arizona','Arkansas','California','Colorado',\n  'Connecticut','Delaware','Florida','Georgia','Hawaii','Idaho','Illinois',\n  'Indiana','Iowa','Kansas','Kentucky','Louisiana','Maine','Maryland',\n  'Massachusetts','Michigan','Minnesota','Mississippi','Missouri','Montana',\n  'Nebraska','Nevada','New Hampshire','New Jersey','New Mexico','New York',\n  'North Carolina','North Dakota','Ohio','Oklahoma','Oregon','Pennsylvania',\n  'Rhode Island','South Carolina','South Dakota','Tennessee','Texas','Utah',\n  'Vermont','Virginia','Washington','West Virginia','Wisconsin','Wyoming']","291b269f":"dates = pd.date_range('2020-01-01', periods=366).astype(str).tolist()\n\nindex = pd.MultiIndex.from_product([dates, states], names=['Date', 'Province_State'])\n\ndata = pd.DataFrame(index=index)\n\nactual = pd.read_csv('\/kaggle\/input\/covid19-models-raw-data\/actuals.csv', index_col='Id')\nactual = actual.loc[actual['Province_State'].isin(states)]\nactual = actual[['Province_State', 'Date', 'Fatalities']].set_index(['Date', 'Province_State'], drop=True)\n\ndata = data.join(actual, on=['Date', 'Province_State'])\n\npred_files = sorted(os.listdir('\/kaggle\/input\/covid19-models-raw-data\/'))\nihme_preds = [f.split('.')[0] for f in pred_files if f.startswith('ihme')]\nlanl_preds = [f.split('.')[0] for f in pred_files if f.startswith('2020')]\n\nfor p in ihme_preds:\n    try:\n        forecast = pd.read_csv(f'\/kaggle\/input\/covid19-models-raw-data\/{p}.csv')[\n            ['location_name', 'date_reported', 'totdea_mean']].rename(columns={'date_reported': 'Date'})\n    except:\n        forecast = pd.read_csv(f'\/kaggle\/input\/covid19-models-raw-data\/{p}.csv')[\n            ['location_name', 'date', 'totdea_mean']].rename(columns={'date': 'Date'})\n\n    forecast = forecast.rename(columns={'totdea_mean': p, 'location_name': 'Province_State'})\n    forecast = forecast.loc[forecast['Province_State'].isin(states)].set_index(['Date', 'Province_State'], drop=True)\n    data = data.join(forecast)\n    \n\nfor p in lanl_preds:\n    try:\n        forecast = pd.read_csv(f'\/kaggle\/input\/covid19-models-raw-data\/{p}.csv')[\n            ['state', 'dates', 'q.50']].rename(columns={'dates': 'Date', 'state': 'Province_State'})\n    except:\n        pass\n\n    new_col = f'lanl_{p.split(\"_\")[0]}'\n    forecast = forecast.rename(columns={'q.50': new_col})\n    forecast = forecast.loc[forecast['Province_State'].isin(states)].set_index(['Date', 'Province_State'], drop=True)\n    data = data.join(forecast)\n\nlanl_preds = [f.split('.')[0] for f in data.columns if f.startswith('lanl')]\n    \ndata = data.reset_index().set_index('Date')\n\nperiods_to_plot = 170\nplot_dates = pd.date_range('2020-03-15', periods=periods_to_plot).astype(str).tolist()","560f42f9":"states_to_plot = ['Arizona', 'California','Florida','Illinois','Massachusetts',\n  'New Jersey','New York','Ohio','Pennsylvania','Texas', 'Washington','Wisconsin']","286075e1":"n = 5\n\ndef moving_average(x, w=n):\n    return np.convolve(x, np.ones(w), 'valid') \/ n","344280b0":"for state in states_to_plot:\n    \n    X = data.loc[(data['Province_State']==state) & (data.index.isin(plot_dates))]\n\n    fig = plt.figure(figsize=(12,8))\n    ax = plt.axes()\n    line, = ax.plot(pd.to_datetime(plot_dates), [np.nan] * len(plot_dates), c='k', label='Actual', linewidth=8)\n\n    def init():  # only required for blitting to give a clean slate.\n        line.set_ydata([np.nan] * len(plot_dates))\n        return line,\n\n    hits = []\n    def animate(e):\n        plt.cla()\n        select = X.index.isin(plot_dates[:e])\n        y = X.loc[select, 'Fatalities'].values\n        y.resize(len(plot_dates))\n        y[y == 0] = np.nan\n        ax.plot(pd.to_datetime(plot_dates[n:]), moving_average(np.diff(y)), c='k', label='Actual', linewidth=8)\n        \n        # IHME\n        hits = []\n        for pred in ihme_preds:\n            if (pred.split('_')[1] in plot_dates[:e]):\n                hits.append(pred)\n        alpha = 1.0\n        for ee, hit in enumerate(reversed(hits)):\n            y = X[hit].values\n            y = moving_average(np.diff(y))\n            y[y == 0] = np.nan\n            ax.plot(pd.to_datetime(plot_dates[n:-n]),  y[:-n], c='g', alpha=alpha, linestyle='--')\n            alpha = alpha * 0.95\n            \n        # LANL\n        hits = []\n        for pred in lanl_preds:\n            if (pred.split('_')[1] in plot_dates[:e]):\n                hits.append(pred)\n        alpha = 1.0\n        for ee, hit in enumerate(reversed(hits)):\n            y = X[hit].values\n            y = moving_average(np.diff(y))\n            y[y == 0] = np.nan\n            ax.plot(pd.to_datetime(plot_dates[n:-n]), y[:-n], c='b', alpha=alpha, linestyle='--')\n            alpha = alpha * 0.85         \n        \n        ax.set_xlim((pd.to_datetime('2020-03-15'), pd.to_datetime('2020-08-31')))\n        \n        fig.autofmt_xdate()\n        ylim = int(np.ceil(X.select_dtypes(include='number').diff().max().max()) \/ 10.0) * 10    # round up to nearest 10\n        ax.set_ylim((0, ylim))\n        ax.grid(False)\n        plt.xticks(rotation=90)\n        plt.suptitle(f'{state} Daily Fatalities', fontsize=24, y=0.99)\n        plt.title(f'IHME (green) and LANL (blue) Predictions\\n5-day moving averages', fontsize=15)\n        \n        return line,\n\n    ani = animation.FuncAnimation(\n        fig, animate, init_func=init, blit=True, save_count=periods_to_plot)\n\n    ani.save(f\"{state}.gif\", writer='imagemagick', fps=4)\n    os.rename(f\"{state}.gif\", f\"{state}.gif.png\")\n    \n    Image(filename=f\"\/kaggle\/working\/{state}.gif.png\")","ba51db7e":"state = \"Arizona\"\nImage(filename=f\"\/kaggle\/working\/{state}.gif.png\")","64fbfbce":"state = \"California\"\nImage(filename=f\"\/kaggle\/working\/{state}.gif.png\")","f59b9931":"state = \"Florida\"\nImage(filename=f\"\/kaggle\/working\/{state}.gif.png\")","f434311b":"state = \"Illinois\"\nImage(filename=f\"\/kaggle\/working\/{state}.gif.png\")","e1e4e6fd":"state = \"Massachusetts\"\nImage(filename=f\"\/kaggle\/working\/{state}.gif.png\")","02ff5d2d":"state = \"New Jersey\"\nImage(filename=f\"\/kaggle\/working\/{state}.gif.png\")","399b147a":"state = \"New York\"\nImage(filename=f\"\/kaggle\/working\/{state}.gif.png\")","8a37a3a6":"state = \"Ohio\"\nImage(filename=f\"\/kaggle\/working\/{state}.gif.png\")","a3ef1ae8":"state = \"Pennsylvania\"\nImage(filename=f\"\/kaggle\/working\/{state}.gif.png\")","f96cf2b6":"state = \"Texas\"\nImage(filename=f\"\/kaggle\/working\/{state}.gif.png\")","c8d257ef":"state = \"Washington\"\nImage(filename=f\"\/kaggle\/working\/{state}.gif.png\")","41e01452":"state = \"Wisconsin\"\nImage(filename=f\"\/kaggle\/working\/{state}.gif.png\")","2aa291bd":"# Plotting COVID-19 Forecasts Through Time\n\nScroll down to the output to see animated graph of IHME predictions vs Actual over time."}}