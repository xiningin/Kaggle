{"cell_type":{"061826bb":"code","02d722f5":"code","a33a0b2a":"code","23e25182":"code","f0e238f6":"code","b000baf6":"code","ea595009":"code","e7ccb88d":"code","46e417cf":"code","443616a8":"code","89b49ab5":"code","cc883442":"code","434cbe2e":"code","6a413ffc":"code","51709420":"code","4ba258ae":"code","09fab3fb":"code","e0c2b86e":"code","c3b8c8a5":"code","70abcac2":"markdown","f0924aed":"markdown","291413bd":"markdown","91cec748":"markdown","d1765733":"markdown","36f92663":"markdown","5d3f56eb":"markdown","1ab775a1":"markdown","4099df33":"markdown","7508e01e":"markdown","3b5ed1da":"markdown","34e59663":"markdown","bd323451":"markdown","3f13e97f":"markdown","bc00d4a7":"markdown","b474bec1":"markdown"},"source":{"061826bb":"## Imports\nimport pandas\nimport numpy as np\nimport geopandas\nimport folium\nimport branca\nimport os\nDATA_FOLDER = os.path.abspath('..\/input\/mapaseleicaosp2016')","02d722f5":"## Leitura de shapefiles das zonas eleitorais\ndef read_zonas():\n    path = os.path.join(DATA_FOLDER, 'zonas_eleitorais_2018_sp.json')\n    with open(path) as f:\n        df = geopandas.read_file(f)\n    return df\ngeodf_zonas = read_zonas()\ngeodf_zonas.head()","a33a0b2a":"## Leitura dos dados de vota\u00e7\u00e3o\ndef read_votacao():\n    path = os.path.join(DATA_FOLDER, 'votacao_partido_munzona_2016_SP.csv')\n    df = pandas.read_csv(path, encoding='latin1', sep=';')\n    return df\ndf_votacao = read_votacao()\ndf_votacao.head()","23e25182":"## Leitura dos dados de detalhe da vota\u00e7\u00e3o\ndef read_detalhe():\n    path = os.path.join(DATA_FOLDER, 'detalhe_votacao_munzona_2016_SP.csv')\n    df = pandas.read_csv(path, encoding='latin1', sep=';')\n    return df\ndf_detalhe = read_detalhe()\ndf_detalhe.head()","f0e238f6":"## M\u00e9todo para resumir as informa\u00e7\u00e3o da elei\u00e7\u00e3o\ndef get_info_resumida(df_votacao, df_detalhe, turno, cargo):\n    cargo_int = {'prefeito': 11, 'vereador': 13}\n    columns = [\n        ('SG_UF', 'uf'),\n        ('NM_MUNICIPIO', 'municipio_nome'),\n        ('CD_MUNICIPIO', 'municipio_id'),\n        ('NR_ZONA', 'zona'),\n        ('NR_PARTIDO', 'partido'),\n        ('QT_VOTOS_NOMINAIS', 'votos_nominais'),\n        ('QT_VOTOS_LEGENDA', 'votos_legenda'),\n    ]\n    rename = {x[0]: x[1] for x in columns}\n    dfA = (\n        df_votacao[\n            (df_votacao['CD_ELEICAO'].isin([220, 221]))\n            &(df_votacao['CD_CARGO']==cargo_int[cargo])\n            &(df_votacao['NR_TURNO']==turno)\n        ]\n        [[x[0] for x in columns]]\n        .rename(columns=rename)\n    )\n    \n    columns_index = ['SG_UF', 'NM_MUNICIPIO', 'CD_MUNICIPIO', 'NR_ZONA']\n    dfB = (\n        df_detalhe[\n            (df_detalhe['CD_ELEICAO'].isin([220, 221]))\n            &(df_detalhe['CD_CARGO']==cargo_int[cargo])\n            &(df_detalhe['NR_TURNO']==turno)\n        ]\n        .set_index(columns_index)\n        [['QT_VOTOS_BRANCOS', 'QT_VOTOS_NULOS', 'QT_ABSTENCOES']]\n        .stack().reset_index()\n        .rename(columns={**rename, **{\n            'level_4': 'partido',\n            0: 'votos_nominais',\n        }})\n    )\n    dfB['votos_legenda'] = 0\n    \n    special_codes = {\n        'QT_VOTOS_BRANCOS': 'B',\n        'QT_VOTOS_NULOS': 'N',\n        'QT_ABSTENCOES': 'A',\n    }\n    \n    dfA['partido'] = dfA['partido'].astype(str)\n    dfB['partido'] = dfB['partido'].apply(lambda x, s=special_codes: s[x])\n    \n    df = pandas.concat([dfA, dfB[dfA.columns]])\\\n        .sort_values(by=['municipio_id', 'zona', 'partido']).reset_index(drop=True)\n    \n    return df","b000baf6":"## Dados de votos para prefeito (primeiro turno)\ndf_prefeito_1t = get_info_resumida(df_votacao, df_detalhe, turno=1, cargo='prefeito')\ndf_prefeito_1t.head()","ea595009":"## Dados de votos para prefeito (segundo turno)\ndf_prefeito_2t = get_info_resumida(df_votacao, df_detalhe, turno=2, cargo='prefeito')\ndf_prefeito_2t.head()","e7ccb88d":"## Dados de votos para vereador\ndf_vereador = get_info_resumida(df_votacao, df_detalhe, turno=1, cargo='vereador')\ndf_vereador.head()","46e417cf":"def create_folium_map(colors, name):\n    mapp = folium.Map((-23.6, -46.95), zoom_start=10)\n    df = geodf_zonas[geodf_zonas['nr_zona'].isin(colors.keys())]\n    folium.GeoJson(\n        df.__geo_interface__,\n        style_function=lambda ft: {\n            'weight': 0.3,\n            'fillOpacity': 0.9,\n            'fillColor': colors.get(ft['properties']['nr_zona']),\n            'color': '#000000',\n        },\n        name=name,\n    ).add_to(mapp)\n    folium.GeoJson(\n        df['geometry'].unary_union.buffer(1e-4).__geo_interface__,\n        style_function=lambda ft: {\n            'weight': 1,\n            'fillOpacity': 0,\n            'fillColor': '',\n            'color': '#000000',\n        },\n        name='Cidade',\n    ).add_to(mapp)\n    folium.LayerControl().add_to(mapp)\n    return mapp","443616a8":"## M\u00e9todo para obter pivot table de votos\ndef pivot_table(data):\n    df = data.copy()\n    df['votos'] = df['votos_nominais'] + df['votos_legenda']\n    pivot = pandas.pivot_table(\n        df,\n        index='zona',\n        columns='partido',\n        values='votos',\n        aggfunc='sum',\n        fill_value=0,\n    )\n    return pivot\n","89b49ab5":"## Plotando para uma combina\u00e7\u00e3o de cidade e partido\ndata_dict = {\n    'prefeito_1t': df_prefeito_1t,\n    'prefeito_2t': df_prefeito_2t,\n    'vereador': df_vereador,\n}\ndef plot_map(cargo, partidos, municipio_id=71072):\n    data = data_dict[cargo]\n    df = pivot_table(data.query('municipio_id=={}'.format(municipio_id)))\n    series = df.loc[:, partidos].sum(axis=1) \/ df.sum(axis=1) * 100\n    colorscale = branca.colormap.linear.Reds_09.scale(0, max(series))\n    colors = series.apply(lambda x: colorscale(x)).to_dict()\n    mapp = create_folium_map(colors, '+'.join(partidos))\n    mapp.add_child(colorscale)\n    return mapp","cc883442":"plot_map('prefeito_1t', ['45'])","434cbe2e":"plot_map('vereador', ['45'])","6a413ffc":"plot_map('prefeito_1t', ['13'])","51709420":"plot_map('vereador', ['13'])","4ba258ae":"plot_map('prefeito_1t', ['A', 'B', 'N'])","09fab3fb":"plot_map('vereador', ['A', 'B', 'N'])","e0c2b86e":"plot_map('prefeito_1t', ['B', 'N'])","c3b8c8a5":"plot_map('vereador', ['B', 'N'])","70abcac2":"### Brancos e nulos no voto para prefeito","f0924aed":"### Brancos, nulos e absten\u00e7\u00f5es no voto para vereador","291413bd":"### Vota\u00e7\u00e3o no PT para prefeito (Haddad)","91cec748":"Esses datasets valem para todas as cidades do estado de S\u00e3o Paulo. Coloquei os c\u00f3digos especiais \"A\", \"B\" e \"N\" no lugar reservado ao n\u00famero do partido para significar absten\u00e7\u00f5es, brancos e nulos, respectivamente. Desse jeito, podemos considerar o conjunto total de eleitores, e n\u00e3o apenas o conjunto de votos v\u00e1lidos.","d1765733":"## Criando mapas\n\nCom esses datasets prontos, o pr\u00f3ximo passo para criar o mapa \u00e9 escolher o que colocar no mapa. Em um mapa, como as coordenadas X-Y j\u00e1 s\u00e3o fixas, a vari\u00e1vel que podemos usar para passar informa\u00e7\u00e3o \u00e9 a cor. Portanto, precisamos escolher um esquema de cores e uma regra para transformar valores em cores. Uma escolha simples \u00e9 mostrar a fra\u00e7\u00e3o de votos em um candidato atrav\u00e9s de uma escala linear de cor. Um pacote que permite fazer isso \u00e9 chamado de `branca`. Para fazer o mapa em si, usamos um pacote chamado `folium`. Ele utiliza uma layer de mapa e permite plotar em cima dessa layer.","36f92663":"Agora podemos criar alguns m\u00e9todos para juntar esses dois datasets e obter um dataset que resume apenas a informa\u00e7\u00e3o que precisamos para fazer os mapas.","5d3f56eb":"## Leitura do resultado das vota\u00e7\u00f5es\n\nO resultado das vota\u00e7\u00f5es pode ser obtido atrav\u00e9s do [Reposit\u00f3rio de Dados Eleitorais do TSE](https:\/\/www.tse.jus.br\/eleicoes\/estatisticas\/repositorio-de-dados-eleitorais-1\/repositorio-de-dados-eleitorais). Queremos dois arquivos da elei\u00e7\u00e3o de 2016, \"Vota\u00e7\u00e3o em partido por munic\u00edpio e zona (formato ZIP)\" e \"Detalhe da apura\u00e7\u00e3o por munic\u00edpio e zona (formato ZIP)\". O primeiro traz a vota\u00e7\u00e3o nos partidos (no caso da elei\u00e7\u00e3o de vereador, esse arquivo agrupa todos os candidatos do mesmo partido), enquanto o segundo traz o n\u00famero de brancos, nulos e absten\u00e7\u00f5es.","1ab775a1":"### Brancos e nulos no voto para vereador","4099df33":"## Alguns exemplos de mapa \n\nAbaixo ser\u00e1 mostrado alguns exemplos de mapas.","7508e01e":"### Vota\u00e7\u00e3o no PSDB para prefeito (Doria)","3b5ed1da":"# Criando mapas das elei\u00e7\u00f5es de 2016\n\nA elei\u00e7\u00e3o municipal de 2020 est\u00e1 chegando. Para entender melhor o que pode acontecer domingo, \u00e9 interessante olhar o que aconteceu em 2016. Atrav\u00e9s de alguns mapas, podemos ver em que lugar da cidade cada candidato se saiu melhor ou pior.","34e59663":"### Brancos, nulos e absten\u00e7\u00f5es no voto para prefeito","bd323451":"## Leitura das shapefiles\n\nPara poder criar um mapa, precisamos ter um contorno da \u00e1rea de cada zona eleitoral. Depois de muito procurar, consegui encontr\u00e1-las para o estado de S\u00e3o Paulo, e salvei em um arquivo disponibilizado aqui. \u00c9 importante falar que em 2018 houve um rezoneamento e esse arquivo j\u00e1 reflete as novas zonas, que s\u00e3o diferentes das que existiam em 2016. Por\u00e9m, apenas algumas zonas sofreram altera\u00e7\u00f5es, e felizmente a cidade de S\u00e3o Paulo n\u00e3o teve nenhuma de suas zonas afetadas. Ent\u00e3o, para o caso da cidade de S\u00e2o Paulo, podemos usar as zonas de 2018 para analisar a elei\u00e7\u00e3o de 2016.","3f13e97f":"Agora, podemos plotar os votos de um partido. Aqui, vamos fazer diferente do que \u00e9 feito normalmente. Ao inv\u00e9s de considerar a porcentagem de votos v\u00e1lidos que cada partido teve, vamos considerar a porcentagem de votos em rela\u00e7\u00e3o ao eleitorado total. Com isso, fica mais vis\u00edvel a grande quantidade de eleitores que n\u00e3o votam.","bc00d4a7":"### Vota\u00e7\u00e3o nos vereadores do PT (candidatos e legenda) ","b474bec1":"### Vota\u00e7\u00e3o nos vereadores do PSDB (candidatos e legenda)"}}