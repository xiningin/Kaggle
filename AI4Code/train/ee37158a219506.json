{"cell_type":{"ad115539":"code","c954ffc7":"code","92769d8f":"code","1df53ae4":"code","e48b6c2e":"code","bcdd8619":"code","01cef912":"code","5ebab1db":"code","877479c0":"code","1ab29ed7":"code","247664f0":"code","e92150d7":"code","44d6c1f6":"code","372a4348":"code","05fef154":"code","62d9fad4":"code","c7a54228":"code","06f7ea6a":"code","413ab746":"code","851c257c":"code","876fcc13":"code","c32c33d5":"code","86199d0a":"code","477be789":"code","3292102b":"code","b2387952":"code","ff2313ea":"markdown","1c7ae93b":"markdown","e39c30e5":"markdown","2e961853":"markdown","b2ded89f":"markdown","b49c5fb3":"markdown","eb7495e3":"markdown","5717c92f":"markdown","c80da4b3":"markdown","4e973efe":"markdown","55b3533d":"markdown","4f5cc822":"markdown","bfb966e6":"markdown","b9aab125":"markdown","35f902c3":"markdown","cf6a4876":"markdown","2a4ad0e1":"markdown","cd0e220e":"markdown","af9cae40":"markdown","957f5299":"markdown","22568fee":"markdown","a90de7cb":"markdown","9263471c":"markdown","1b0df9d8":"markdown","895348e7":"markdown","9a8a03e2":"markdown"},"source":{"ad115539":"# This Python 3 environment comes with many helpful analytics libraries installed\n# It is defined by the kaggle\/python Docker image: https:\/\/github.com\/kaggle\/docker-python\n# For example, here's several helpful packages to load\n\nimport numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\n\n# Input data files are available in the read-only \"..\/input\/\" directory\n# For example, running this (by clicking run or pressing Shift+Enter) will list all files under the input directory\n\n\n\n# You can write up to 5GB to the current directory (\/kaggle\/working\/) that gets preserved as output when you create a version using \"Save & Run All\" \n# You can also write temporary files to \/kaggle\/temp\/, but they won't be saved outside of the current session","c954ffc7":"import shutil\nimport glob\nimport os\nimport cv2\nimport matplotlib.pyplot as plt\nimport numpy as np\nimport tensorflow as tf","92769d8f":"import pandas as pd\ndata = pd.read_csv('\/kaggle\/input\/celeba-dataset\/list_attr_celeba.csv')\ndata.set_index('image_id',inplace = True)\ndata.head()","1df53ae4":"gender = data.Male","e48b6c2e":"raw_train = []\nraw_train_labels = []\nraw_test = []\nraw_test_labels = []","bcdd8619":"def get_images(data,no_of_images,labels,inp,outp):\n    path = '\/kaggle\/input\/celeba-dataset\/img_align_celeba\/img_align_celeba'\n    files = os.listdir(path)\n    mcount, fcount = 0, 0\n    for i in files[inp:outp]:\n        if gender[i] == 1:\n            mcount = mcount + 1\n            if mcount == no_of_images:\n                continue\n        elif gender[i] == -1:\n            gender[i] = 0\n            fcount = fcount + 1\n            if fcount == no_of_images:\n                continue\n        img = cv2.imread(os.path.join(path,i))\n        data.append(img)\n        labels.append(gender[i])\n        if len(data) == 2 * no_of_images:\n            return data, labels\n        if len(data) % 100 == 0:\n            print(len(data),'images')","01cef912":"raw_train,raw_train_labels = get_images(raw_train,2500,raw_train_labels,0,50000)\nraw_test,raw_test_labels = get_images(raw_test,500,raw_test_labels,50000,100000)","5ebab1db":"len(raw_train),len(raw_train_labels),len(raw_test),len(raw_test_labels)","877479c0":"train_data = tf.data.Dataset.from_tensor_slices((raw_train,raw_train_labels))\ntest_data = tf.data.Dataset.from_tensor_slices((raw_test,raw_test_labels))","1ab29ed7":"IMG_SIZE = 160\ndef format_example(image,label):\n    image = tf.cast(image,dtype = tf.float32)\n    image = (image \/ 255) - 1\n    image = tf.image.resize(image,(IMG_SIZE,IMG_SIZE))\n    return image, label\ntrain_data = train_data.map(format_example)\ntest_data = test_data.map(format_example)","247664f0":"BATCH_SIZE = 32\nSHUFFLE_BUFFER_SIZE = 2000\ntrain_data = train_data.shuffle(SHUFFLE_BUFFER_SIZE).batch(BATCH_SIZE)\ntest_data = test_data.shuffle(SHUFFLE_BUFFER_SIZE).batch(BATCH_SIZE)","e92150d7":"IMG_SHAPE = (IMG_SIZE,IMG_SIZE,3)\nbase_model = tf.keras.applications.MobileNetV2(input_shape = IMG_SHAPE,include_top = False,weights = 'imagenet')\nbase_model.trainable = False","44d6c1f6":"for image_batch, label_batch in train_data.take(1):\n    pass\nprint(image_batch.shape)","372a4348":"print(base_model(image_batch).shape)","05fef154":"global_average_layer = tf.keras.layers.GlobalAveragePooling2D()\nprint(global_average_layer(base_model(image_batch)).shape)","62d9fad4":"hidden_layer1 = tf.keras.layers.Dense(256,activation = 'relu')\ndropout1 = tf.keras.layers.Dropout(0.5)\nprint(dropout1(hidden_layer1(global_average_layer(base_model(image_batch)))).shape)","c7a54228":"hidden_layer2 = tf.keras.layers.Dense(128,activation = 'relu')\nprint(hidden_layer2(dropout1(hidden_layer1(global_average_layer(base_model(image_batch))))).shape)","06f7ea6a":"prediction_layer = tf.keras.layers.Dense(1)\nprint(prediction_layer(hidden_layer2(dropout1(hidden_layer1(global_average_layer(base_model(image_batch)))))).shape)","413ab746":"model = tf.keras.Sequential([\n     base_model,\n     global_average_layer,\n     hidden_layer1,\n     dropout1,\n     hidden_layer2,\n     prediction_layer\n])","851c257c":"base_learning_rate = 0.0001\nmodel.compile(optimizer = tf.keras.optimizers.RMSprop(lr = base_learning_rate),\n              loss = 'binary_crossentropy', metrics = ['accuracy'])","876fcc13":"model.summary()","c32c33d5":"num_train = 10000\nnum_test = 2500\ninitial_epochs = 20\nsteps_per_epochs = round(num_train) \/\/  BATCH_SIZE\nvalidation_steps = 4\n\nloss0, accuracy0 = model.evaluate(test_data, steps = validation_steps)","86199d0a":"callbacks = tf.keras.callbacks.ModelCheckpoint('\/kaggle\/working\/best_model.h5',save_best_only = True,monitor = 'val_accuracy',mode = max,verbose = 1)","477be789":"history = model.fit(train_data,epochs = initial_epochs, validation_data = test_data,callbacks = [callbacks])","3292102b":"model.load_weights('best_model.h5')","b2387952":"model.evaluate(test_data)","ff2313ea":"Let's train the model","1c7ae93b":"Now as all these layers are working properly we make a sequential model out of them and name it model","e39c30e5":"Importing necessary libraries","2e961853":"As we are using transfer learning, MobileNetV2 as our base model. \n\nwe pass include top = False as we do not use its last layers which is used to classfy on 1000 classes. We set trainable = False as we donot train the base model because we are using less data.","b2ded89f":"Function for loading images\n\n* Here data is the array of images which are laoded\n* no of images is the no of images we load from the dataset\n* labels are labels for each image respectively\n* inp and outp are the partition in which take take data from. Here for training we take images in between 0 50000 images in files","b49c5fb3":"Here with the help of methods in tf.data.datasets\n\n* we are shuffing the data\n* we making batches out of them","eb7495e3":"Let's calculate steps per epoch and fix validation steps.Let's also how our model performs before training","5717c92f":"Let's use learning rate 0.0001 and rmsprop as optimizer","c80da4b3":"so, that is it. We simply got 87% accuracy approximately. This is power of transfer learning.","4e973efe":"Taking only Male column as only it is useful for our project","55b3533d":"Converting the arrays to tensorflow datasets, as in this format we have various good methods we can use to handle data.","4f5cc822":"Let's add callbacks to save best model weights and load them to evaluate on test set","bfb966e6":"Checking their length","b9aab125":"Let's add a 128 neuron hidden layer as our second layer and Check its output","35f902c3":"Loading the images and labels in raw_train, raw_train_labels. We need to process them before use so the name.","cf6a4876":"Formatting the images\n\n* here we are casting image to float\n* standarding the values between 0 and 1\n* resizing the image to (160,160) ","2a4ad0e1":"Here we check the output shape of the base model","cd0e220e":"Here is the summary of our model","af9cae40":"If you have liked the kernel, Please give upvote.","957f5299":"Let's add a final prediction layer with 1 neuron with sigmoid activation as output layer","22568fee":"Training and test arrays. In the training and test arrays we store images and in the label arrays we store labels","a90de7cb":"So, we got 86.5% percent accuracy on the test set.","9263471c":"Let's add global average pooling layer after the base model, to average its output and make the output feedable to dense layers, and check whether it is working properly by checking its output shape.","1b0df9d8":"Let's add a 256 neuron as our first hidden layer and dropout layer with 0.5 dropout. Check their output.","895348e7":"Reading list_attr_celeba.csv and setting image id as index for easier access when loading images","9a8a03e2":"Let's check the shape of output shape of the image batches in training data."}}