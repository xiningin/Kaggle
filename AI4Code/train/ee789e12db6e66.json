{"cell_type":{"ac6bdf4c":"code","8939d8a8":"code","2e90f25d":"code","52b4a888":"code","7981b6f1":"code","bed13e48":"code","5c893465":"code","dbc38332":"code","ef4474c5":"code","4565ff46":"code","c8ee229e":"code","67e05f3a":"code","436f4192":"code","e0504f48":"code","ce71c8bd":"code","e8df44fa":"code","ad97e583":"code","39d29fe5":"code","fd866674":"code","fa26b976":"code","9da3ee07":"code","c6bae11e":"code","667e7ca5":"code","daa0c3e4":"code","ab049b3b":"code","2dd4ea14":"code","b55eb40b":"code","eb774ba7":"code","35a1a73f":"code","e3268747":"code","7e386725":"code","af56fa07":"code","c9e6a9b4":"code","421d78de":"code","40092f7e":"code","1d4411ee":"code","0d1c381b":"code","2c8297c4":"code","bcbbeedf":"code","68d411e2":"code","4d0704cd":"code","56b58e07":"code","8281bfaf":"code","bef7ad61":"code","687bf2cd":"code","8e821dda":"code","d3b1dd0d":"code","62622767":"code","3c4c0d07":"code","16059f6e":"code","5b080300":"code","78e28611":"code","44feeaad":"code","65b55d09":"code","1af5d4af":"markdown","e74fa25d":"markdown","bc920275":"markdown","9106a988":"markdown","1e407b1b":"markdown","f6dec9d6":"markdown","49ea3e24":"markdown","c655ed06":"markdown","ca8e63fa":"markdown","02c1ce50":"markdown","26e96b01":"markdown","5564866c":"markdown","3d4d6782":"markdown","b86fc5bd":"markdown","90501c7e":"markdown","c562a196":"markdown","609b1cc7":"markdown","018fcd36":"markdown","7906b685":"markdown","b24ea35d":"markdown","f83757f7":"markdown","9d1f7984":"markdown","9eab8f33":"markdown","06b8f1e7":"markdown","70df6392":"markdown","36ecde6f":"markdown","9624e3df":"markdown","bee84ead":"markdown","f4559c06":"markdown","4a6c5a85":"markdown","b7836d42":"markdown","1a9d8317":"markdown","4afa0269":"markdown","72700d8f":"markdown","0cb2134d":"markdown","d35d7756":"markdown","31f366f9":"markdown","17ab767e":"markdown","9be87e24":"markdown","badabcc5":"markdown","9176249a":"markdown","223c443f":"markdown","9d31d0d9":"markdown","11065cc0":"markdown","8704e91b":"markdown","f3d372dc":"markdown","20640016":"markdown","fbfd2880":"markdown","52bf9050":"markdown"},"source":{"ac6bdf4c":"#Importing Libraries\nimport os\nimport pandas as pd\nimport seaborn as sns\nimport numpy as np\nimport matplotlib.pyplot as plt\nimport plotly.express as px\nimport plotly.graph_objects as go\nimport xgboost as xgb\nfrom sklearn.preprocessing import LabelEncoder\nfrom sklearn.model_selection import train_test_split\nfrom sklearn.metrics import mean_squared_error\nimport shap","8939d8a8":"shap.initjs()","2e90f25d":"plt.style.use('Solarize_Light2')","52b4a888":"for dirname, _, filenames in os.walk('\/kaggle\/input'):\n    for filename in filenames:\n        print(os.path.join(dirname, filename))","7981b6f1":"data = pd.read_csv('\/kaggle\/input\/insurance\/insurance.csv')\ndata.head()","bed13e48":"data.info()","5c893465":"plt.figure(figsize=(10,5))\nheatmap = sns.heatmap(data.corr(), annot=True, fmt=\".1f\")\nheatmap.yaxis.set_ticklabels(heatmap.yaxis.get_ticklabels(), rotation=0, ha='right', fontsize=12)\nheatmap.xaxis.set_ticklabels(heatmap.xaxis.get_ticklabels(), rotation=45, ha='right', fontsize=12)\nplt.title('Correlation Matrix', fontsize=18)\nplt.show()","dbc38332":"plt.figure(figsize=(12,5))\nsns.distplot(data['age'], kde=True)\nplt.title('Age Distribution')\nplt.show()","ef4474c5":"plt.figure(figsize=(15,5))\nsns.violinplot(data=data, x='sex', y='age', hue='smoker')\nplt.title(\"Age Distributions Violinplot\")\nplt.show()","4565ff46":"plt.figure(figsize=(15,5))\nsns.violinplot(data=data, x='region', y='age')\nplt.title('Age Distributions Violinplot')\nplt.show()","c8ee229e":"plt.figure(figsize=(15,5))\nsns.catplot(data=data, x='sex', hue='smoker', col='region', kind='count', col_wrap=2)\nplt.suptitle('Patients Sex Distribution \"\" Countplots', fontsize=15)\nplt.subplots_adjust(top=0.9)\nplt.show()","67e05f3a":"fig = px.histogram(data, \n                   x='bmi', \n                   marginal='box', \n                   title='BMI Distribution')\nfig.show()","436f4192":"fig = px.histogram(data, x='bmi', \n                   color='sex', \n                   marginal='box', \n                   title='BMI Distribution Over Patients Sex')\nfig.show()","e0504f48":"fig = px.histogram(data, x='bmi', \n                   color='region', \n                   marginal='box', \n                   title='BMI Distribution Over Patients Region')\nfig.show()","ce71c8bd":"fig = px.histogram(data, x='bmi', \n                   color='smoker', \n                   marginal='box', \n                   title='BMI Distribution Following Smoking Activity')\nfig.show()","e8df44fa":"plt.figure(figsize=(15,5))\nsns.countplot(data=data, x='children')\nplt.title('Number Of Children Countplot')\nplt.show()","ad97e583":"plt.figure(figsize=(15,5))\nsns.countplot(data=data, x='region', hue='children')\nplt.title('Number of Children Distribution Over Regions')\nplt.show()","39d29fe5":"plt.figure(figsize=(15,5))\nsns.countplot(data=data, x='smoker')\nplt.title(\"Smokers' Countplot\")\nplt.show()","fd866674":"plt.figure(figsize=(15,5))\nsns.catplot(data=data,\n            x='smoker', \n            y='age',\n            hue='sex', \n            col='region', \n            kind='box', \n            col_wrap=2)\nplt.suptitle('Smokers Age Distributions', fontsize=15)\nplt.subplots_adjust(top=0.9)\nplt.show()","fa26b976":"plt.figure(figsize=(15,5))\nsns.countplot(data=data, x='region')\nplt.title(\"Regions' Countplot\")\nplt.show()","9da3ee07":"fig = px.histogram(data, \n                   x='charges', \n                   marginal='box', \n                   title='Charges Distribution')\nfig.show()","c6bae11e":"fig = px.density_contour(data, x=\"age\", y=\"charges\",\n                         facet_col=\"sex\",\n                         color='smoker',\n                         marginal_x=\"histogram\",\n                         marginal_y=\"histogram\")\nfig.show()","667e7ca5":"fig = plt.figure(figsize=(11,5))\ng = sns.jointplot(data=data, x='bmi', y='charges', kind='kde', color='g', height=9)\ng.fig.suptitle('Charges as function of BMI', fontsize=15)\ng.fig.subplots_adjust(top=0.95)\nplt.show()","daa0c3e4":"fig = px.scatter(data, x=\"bmi\", y=\"charges\", color=\"smoker\",\n                 size='charges')\nfig.update_layout(title_text='charges = f(bmi)')\nfig.show()","ab049b3b":"fig = go.Figure()\n\nfor n_children in data.children.unique():\n    df = data.loc[data.children == n_children]\n    fig.add_trace(go.Box(\n        y=df.charges.values,\n        name=str(n_children),\n        boxpoints='all',\n        jitter=0.5,\n        whiskerwidth=0.2,\n        #fillcolor=cls,\n        marker_size=2,\n        line_width=1)\n    )\nfig.update_layout(title_text=\"Charges Distribution Over Possible Numbers of Children\")\nfig.show()","2dd4ea14":"fig = go.Figure()\n\nfor region in data.region.unique():\n    df = data.loc[data.region == region]\n    fig.add_trace(go.Box(\n        y=df.charges.values,\n        name=region,\n        boxpoints='all',\n        jitter=0.5,\n        whiskerwidth=0.2,\n        #fillcolor=cls,\n        marker_size=2,\n        line_width=1)\n    )\nfig.update_layout(title_text=\"Charges Distribution Over Regions\")\nfig.show()","b55eb40b":"new_data = data.copy()","eb774ba7":"new_data.loc[new_data['bmi']<25, 'bmi_class'] = 'Normal'\nnew_data.loc[(new_data['bmi']<30) & (new_data['bmi']>=25), 'bmi_class'] = 'Overweight'\nnew_data.loc[(new_data['bmi']<35) & (new_data['bmi']>=30), 'bmi_class'] = 'Class 1'\nnew_data.loc[(new_data['bmi']<40) & (new_data['bmi']>=35), 'bmi_class'] = 'Class 2'\nnew_data.loc[new_data['bmi']>=40, 'bmi_class'] = 'Class 3'","35a1a73f":"new_data.loc[(new_data['age']<31) & (new_data['age']>=18), 'age_class'] = 'Young'\nnew_data.loc[(new_data['age']<51) & (new_data['age']>=31), 'age_class'] = 'Adult'\nnew_data.loc[new_data['age']>=51, 'age_class'] = 'Old'","e3268747":"new_data.head()","7e386725":"bmi_classes_data = new_data.groupby('bmi_class').count()\nfig = px.pie(values=bmi_classes_data['age'].values, names=bmi_classes_data['age'].index,\n             title='BMI Classes Distribution')\nfig.show()","af56fa07":"age_classes_data = new_data.groupby('age_class').count()\nfig = px.pie(values=age_classes_data['age'].values, names=age_classes_data['age'].index,\n             title='Age Classes Distribution')\nfig.show()","c9e6a9b4":"fig = px.histogram(new_data, x='charges', \n                   color='bmi_class', \n                   marginal='box', \n                   title='Charges Distribution Over BMI Classes')\nfig.show()","421d78de":"fig = px.histogram(new_data, x='charges', \n                   color='age_class', \n                   marginal='box', \n                   title='Charges Distribution Over Age Classes')\nfig.show()","40092f7e":"encoder = LabelEncoder()\nnew_data['bmi_class'] = encoder.fit_transform(new_data['bmi_class'])\nnew_data['age_class'] = encoder.fit_transform(new_data['age_class'])\nnew_data['smoker'] = encoder.fit_transform(new_data['smoker'])\nnew_data['region'] = encoder.fit_transform(new_data['region'])\nnew_data['sex'] = encoder.fit_transform(new_data['sex'])","1d4411ee":"new_data['log_charges'] = np.log(new_data['charges'])","0d1c381b":"figure = plt.figure(figsize=(15,5))\nax1 = figure.add_subplot(2,1,1)\ng1 = sns.distplot(new_data['charges'],ax=ax1)\nax2 = figure.add_subplot(2,1,2)\ng2 = sns.distplot(new_data['log_charges'],ax=ax2)\nfigure.suptitle('Log Transformation of Charges Distribution', fontsize=15)\nfigure.tight_layout()\nplt.subplots_adjust(top=0.9)\nplt.show()","2c8297c4":"fig = px.histogram(new_data, \n                   x='charges', \n                   marginal='box', \n                   title='Initial Charges Distribution')\nfig.show()\n\n\nfig = px.histogram(new_data, \n                   x='log_charges', \n                   marginal='box', \n                   title='Log Transformation of Charges Distribution')\nfig.show()","bcbbeedf":"X, y = new_data.drop(columns=['charges', 'log_charges']), new_data['log_charges']\nground_truth = new_data['charges']","68d411e2":"X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=44)","4d0704cd":"model = xgb.XGBRegressor(n_estimators=200,\n                        learning_rate=0.1,\n                        max_depth=10,\n                        colsample_bytree=0.85,\n                        reg_lambda=1)","56b58e07":"model.fit(X_train, y_train)","8281bfaf":"fig, ax = plt.subplots(figsize=(13,5))\nxgb.plot_importance(model, ax=ax, importance_type='cover')\nplt.show()","bef7ad61":"importance_explainer = shap.TreeExplainer(model)","687bf2cd":"shap_values = importance_explainer.shap_values(X_train)","8e821dda":"shap.summary_plot(shap_values, X_train, plot_type=\"bar\")","d3b1dd0d":"shap.summary_plot(shap_values, X_train)","62622767":"for feature in X_train.columns:\n    shap.dependence_plot(feature, shap_values, X_train)","3c4c0d07":"shap.force_plot(importance_explainer.expected_value, shap_values[0,:], X_train.iloc[0,:])","16059f6e":"X_train.iloc[0,:], y_train.iloc[0]","5b080300":"shap.force_plot(importance_explainer.expected_value, shap_values, X_train)","78e28611":"predictions = model.predict(X_test)","44feeaad":"rmse = np.sqrt(mean_squared_error(predictions, y_test))\nprint(f'RMSE: {np.round(rmse, 3)}')","65b55d09":"plt.figure(figsize=(20,6))\nplt.plot(np.arange(len(predictions)), predictions, label='Predictions')\nplt.plot(np.arange(len(y_test)), y_test, color='r', label='Ground Truth')\nplt.ylabel('Log Charges')\nplt.legend()\nplt.show()","1af5d4af":"We can visualize the transformation result with plotly too.","e74fa25d":"## Features Engineering","bc920275":"As we clearly saw in the data analysis, the charges distribution is skewed. For this reason we'll apply a log transformation and train our model(s) on the new target values and retransform predictions later.","9106a988":"## Body Mass Index (BMI)","1e407b1b":"Age Classes:\n\n- `18 to 30`: Young\n- `30 to 50`: Adult\n- `> 50`: Old","f6dec9d6":"**- Dependence Plot**","49ea3e24":"Similar BMI distribution for both males and females patients.","c655ed06":"Body Mass Index classes:\n\n- `18.5 to 24.9`: Normal Weight.\n- `25 to 29.9`: Overweight.\n- `30 to 34.9`: Obesity Class 1.\n- `35 to 39.9`: Obesity Class 2.\n- `>= 40` : Obesity Class 3.","ca8e63fa":"## Features Correlation","02c1ce50":"### Built-in Feature Importance","26e96b01":"The highest BMI values correspond to the highest charges and, as we noticed in a previous plot, smokers are likely to have the highest charges.","5564866c":"We can visualize the effect of more ore even all the samples at once.","3d4d6782":"**- A single Prediction Impact**","b86fc5bd":"- The previous plot shows us 6 features (from a total of 8) each contributing to push the model output from the base value (the average model output over the training dataset we passed) towards 8.72.\n- Features shown in red are influencing the model output by pushing the label higher while the ones shown in blue are pushing the value lower.","90501c7e":"SHAP dependence plots show the effect of a single feature across the whole dataset and are only defined in regions of the input space supported by data.","c562a196":"Southeast region has few more data than the other regions who are equally distributed.","609b1cc7":"## Charges (target variable)","018fcd36":"*NB: We can change the parameters (the scroll menu) near the X-Axis and y-axis to have detailed explanations by feature over different samples.*","7906b685":"## Log Transformation ","b24ea35d":"# Reading Data","f83757f7":"## Features Importances","9d1f7984":"## XGBOOST Model Creation","9eab8f33":"The previous plot show that old patients have more medical charges than adult and young patients.","06b8f1e7":"## Label Encoding","70df6392":"As the previous countplots show, there is an equal distribution of male and female patients. But for smokers and non-smokers, the second type represents a majority, and this is available for both males and females and for all regions (almost 7\/8 of the data is about non smokers patients).","36ecde6f":"The majority of patients suffer from obesity (class 1 + class 2 + class 3 ~ 53%).","9624e3df":"The features importance barplot osf SHAP indicates that \"smoker\" is the most important feature with \"age\", while \"bmi_class\" is the least important one.\nIn addition to the previous plot, we can have this more detailed one too:","bee84ead":"## Smoker","f4559c06":"## Age","4a6c5a85":"Similar distributions over different Regions.","b7836d42":"## Number of Children","1a9d8317":"From the previous plot we can observe that:\n\n- The majority of charges values are concentrated around 10k.\n- The higher the age is, the more charges are.\n- Smokers have more charges than non-smokers.\n- The charges distribution of male and female are similar.","4afa0269":"Most of the patients' BMI is around 30, which is the average index.","72700d8f":"**- Summary Plot**","0cb2134d":"# EDA: Exploratory Data Analysis","d35d7756":"## Sex","31f366f9":"# Regression: XGBOOST","17ab767e":"The majority of patients are adults.","9be87e24":"### SHAP: SHapley Additive exPlanations","badabcc5":"## Predictions","9176249a":"\nHow the importance is calculated: either \u201cweight\u201d, \u201cgain\u201d, or \u201ccover\u201d\n\n* \u201dweight\u201d is the number of times a feature appears in a tree (default importance type).\n\n* \u201dgain\u201d is the average gain of splits which use the feature.\n\n* \u201dcover\u201d is the average coverage of splits which use the feature where coverage is defined as the number of samples affected by the split.","223c443f":"The southeast has higher BMI values than the 3 other regions that have similar BMI distributions.","9d31d0d9":"The majority of data is centered around (BMI=30, Charges=10k).","11065cc0":"## Region","8704e91b":"We can notice that the 3 Obesity Classes have higher values of charges.","f3d372dc":"Following the previous plots, we can say that patients' ages are regularly distributed.","20640016":"We can observe that few are patients that have many children (3 or more) while the majority have no children or 2 at maximum.","fbfd2880":"SHAP is a game theoretic approach to explain the output of any machine learning model. It connects optimal credit allocation with local explanations using the classic Shapley values from game theory and their related extensions. [SHAP Github](https:\/\/github.com\/slundberg\/shap)","52bf9050":"- The goal from this density scatter plot is to identify the impact of each feature on the model's output. Features are ordered following the sum of SHAP value magnitudes across all samples.\n- X-axis is for the SHAP values (impact on model) and y-axis is for the feature values (red indicates high values while blue indicate low values of the feature).\n- From this plot we can notice that high values of \"smoker\" featue (ones, since it's a binary feature) have an important impact on the model output but for fewer samples in comparison with low values of the same feature affecting more samples.\n- We can also observe that \"age\" feature influences, with an uniform distribution, the model output with both its high and low values.\n- As an other example, \"bmi\" feaature has less importance and only its high values influence significantly the model output."}}