{"cell_type":{"f1937ab3":"code","8e6627b4":"code","83c36259":"code","5e5729e7":"code","a8a610db":"code","84db1871":"code","84772ccb":"code","32180ae1":"code","cf1c5acb":"code","43930282":"code","d0a44ea9":"code","06e41ad6":"code","43c4a450":"code","01291f98":"code","efeb4b93":"code","db38d123":"code","a1b5954d":"code","8873e156":"code","7aa938cf":"code","3d7552e2":"code","0b26e6da":"code","b576848b":"code","a1090a94":"code","17713b64":"code","cc8b6827":"code","e22b8ce4":"code","d5d0689d":"code","e66f5629":"code","a8bdae35":"code","981bff2b":"code","ea0696c8":"code","707bef4a":"code","54c0377b":"code","57563cd4":"code","da396e6e":"markdown","651b27e3":"markdown","b6f3becc":"markdown","1f9d7fd3":"markdown","58db43ef":"markdown","151e27a1":"markdown","29973722":"markdown","0c0e2403":"markdown","d55d8c05":"markdown","a69b6c65":"markdown"},"source":{"f1937ab3":"#path\nimport os\nfrom os.path import isdir, join\nfrom pathlib import Path\n\n# Scientific Math \nimport numpy as np\nfrom scipy.fftpack import fft\nfrom scipy import signal\nfrom scipy.io import wavfile\nfrom sklearn.model_selection import train_test_split\n\n# Visualization\nimport matplotlib.pyplot as plt\nimport tensorflow as tf\nimport plotly.offline as py\nimport plotly.graph_objs as go\n\n#Deep learning\nimport tensorflow.keras as keras\nfrom tensorflow.keras.layers import Dense, Dropout, Flatten\nfrom tensorflow.keras import Input, layers\nfrom tensorflow.keras import backend as K\n\nimport random\nimport copy\nimport librosa\n\n%matplotlib inline","8e6627b4":"print(os.listdir(\"..\/input\"))\n","83c36259":"train_audio_path = '..\/input\/train\/audio\/'\nprint(os.listdir(train_audio_path))","5e5729e7":"dirs = [f for f in os.listdir(train_audio_path) if isdir(join(train_audio_path, f))]\ndirs.sort()\nprint('Number of labels: ' + str(len(dirs[1:])))\nprint(dirs)","a8a610db":"all_wav = []\nunknown_wav = []\nlabel_all = []\nlabel_value = {}\ntarget_list = ['yes', 'no', 'up', 'down', 'left', 'right', 'on', 'off', 'stop', 'go']\nunknown_list = [d for d in dirs if d not in target_list and d != '_background_noise_' ]\nprint('target_list : ',end='')\nprint(target_list)\nprint('unknowns_list : ', end='')\nprint(unknown_list)\nprint('silence : _background_noise_')\ni=0;\nbackground = [f for f in os.listdir(join(train_audio_path, '_background_noise_')) if f.endswith('.wav')]\nbackground_noise = []\nfor wav in background : \n    samples, sample_rate = librosa.load(join(join(train_audio_path,'_background_noise_'),wav))\n    samples = librosa.resample(samples, sample_rate, 8000)\n    background_noise.append(samples)\n\nfor direct in dirs[1:]:\n    waves = [f for f in os.listdir(join(train_audio_path, direct)) if f.endswith('.wav')]\n    label_value[direct] = i\n    i = i + 1\n    print(str(i)+\":\" +str(direct) + \" \", end=\"\")\n    for wav in waves:\n        samples, sample_rate = librosa.load(join(join(train_audio_path,direct),wav), sr = 16000)\n        samples = librosa.resample(samples, sample_rate, 8000)\n        if len(samples) != 8000 : \n            continue\n            \n        if direct in unknown_list:\n            unknown_wav.append(samples)\n        else:\n            label_all.append(direct)\n            all_wav.append([samples, direct])","84db1871":"wav_all = np.reshape(np.delete(all_wav,1,1),(len(all_wav)))\nlabel_all = [i for i in np.delete(all_wav,0,1).tolist()]","84772ccb":"#Random pick start point\ndef get_one_noise(noise_num = 0):\n    selected_noise = background_noise[noise_num]\n    start_idx = random.randint(0, len(selected_noise)- 1 - 8000)\n    return selected_noise[start_idx:(start_idx + 8000)]","32180ae1":"max_ratio = 0.1\nnoised_wav = []\naugment = 1\ndelete_index = []\nfor i in range(augment):\n    new_wav = []\n    noise = get_one_noise(i)\n    for i, s in enumerate(wav_all):\n        if len(s) != 8000:\n            delete_index.append(i)\n            continue\n        s = s + (max_ratio * noise)\n        noised_wav.append(s)\nnp.delete(wav_all, delete_index)\nnp.delete(label_all, delete_index)","cf1c5acb":"wav_vals = np.array([x for x in wav_all])\nlabel_vals = [x for x in label_all]\nwav_vals.shape","43930282":"labels = copy.deepcopy(label_vals)\nfor _ in range(augment):\n    label_vals = np.concatenate((label_vals, labels), axis = 0)\nlabel_vals = label_vals.reshape(-1,1)","d0a44ea9":"#knowns audio random sampling\nunknown = unknown_wav\nnp.random.shuffle(unknown_wav)\nunknown = np.array(unknown)\nunknown = unknown[:2000*(augment+1)]\nunknown_label = np.array(['unknown' for _ in range(2000*(augment+1))])\nunknown_label = unknown_label.reshape(2000*(augment+1),1)","06e41ad6":"delete_index = []\nfor i,w in enumerate(unknown):\n    if len(w) != 8000:\n        delete_index.append(i)\nunknown = np.delete(unknown, delete_index, axis=0)","43c4a450":"#silence audio\nsilence_wav = []\nnum_wav = (2000*(augment+1))\/\/len(background_noise)\nfor i, _ in enumerate(background_noise):\n    for _ in range((2000*(augment+1))\/\/len(background_noise)):\n        silence_wav.append(get_one_noise(i))\nsilence_wav = np.array(silence_wav)\nsilence_label = np.array(['silence' for _ in range(num_wav*len(background_noise))])\nsilence_label = silence_label.reshape(-1,1)\nsilence_wav.shape","01291f98":"wav_vals    = np.reshape(wav_vals,    (-1, 8000))\nnoised_wav  = np.reshape(noised_wav,  (-1, 8000))\nunknown       = np.reshape(unknown,   (-1, 8000))\nsilence_wav = np.reshape(silence_wav, (-1, 8000))","efeb4b93":"print(wav_vals.shape)\nprint(noised_wav.shape)\nprint(unknown.shape)\nprint(silence_wav.shape)","db38d123":"print(label_vals.shape)\nprint(unknown_label.shape)\nprint(silence_label.shape)","a1b5954d":"wav_vals = np.concatenate((wav_vals, noised_wav), axis = 0)\nwav_vals = np.concatenate((wav_vals, unknown), axis = 0)\nwav_vals = np.concatenate((wav_vals, silence_wav), axis = 0)","8873e156":"label_vals = np.concatenate((label_vals, unknown_label), axis = 0)\nlabel_vals = np.concatenate((label_vals, silence_label), axis = 0)","7aa938cf":"print(len(wav_vals))\nprint(len(label_vals))","3d7552e2":"train_wav, test_wav, train_label, test_label = train_test_split(wav_vals, label_vals, \n                                                                    test_size=0.2,\n                                                                    random_state = 1993,\n                                                                   shuffle=True)","0b26e6da":"# Parameters\nlr = 0.001\ngenerations = 20000\nnum_gens_to_wait = 250\nbatch_size = 512\ndrop_out_rate = 0.5\ninput_shape = (8000,1)","b576848b":"#For Conv1D add Channel\ntrain_wav = train_wav.reshape(-1,8000,1)\ntest_wav = test_wav.reshape(-1,8000,1)","a1090a94":"label_value = target_list\nlabel_value.append('unknown')\nlabel_value.append('silence')","17713b64":"new_label_value = dict()\nfor i, l in enumerate(label_value):\n    new_label_value[l] = i\nlabel_value = new_label_value","cc8b6827":"#Make Label data 'string' -> 'class num'\ntemp = []\nfor v in train_label:\n    temp.append(label_value[v[0]])\ntrain_label = np.array(temp)\n\ntemp = []\nfor v in test_label:\n    temp.append(label_value[v[0]])\ntest_label = np.array(temp)\n\n#Make Label data 'class num' -> 'One hot vector'\ntrain_label = keras.utils.to_categorical(train_label, len(label_value))\ntest_label = keras.utils.to_categorical(test_label, len(label_value))","e22b8ce4":"print('Train_Wav Demension : ' + str(np.shape(train_wav)))","d5d0689d":"print('Train_Label Demension : ' + str(np.shape(train_label)))","e66f5629":"print('Test_Wav Demension : ' + str(np.shape(test_wav)))","a8bdae35":"print('Test_Label Demension : ' + str(np.shape(test_label)))","981bff2b":"print('Number Of Labels : ' + str(len(label_value)))","ea0696c8":"#Conv1D Model\ninput_tensor = Input(shape=(input_shape))\n\nx = layers.Conv1D(8, 11, padding='valid', activation='relu', strides=1)(input_tensor)\nx = layers.MaxPooling1D(2)(x)\nx = layers.Dropout(drop_out_rate)(x)\nx = layers.Conv1D(16, 7, padding='valid', activation='relu', strides=1)(x)\nx = layers.MaxPooling1D(2)(x)\nx = layers.Dropout(drop_out_rate)(x)\nx = layers.Conv1D(32, 5, padding='valid', activation='relu', strides=1)(x)\nx = layers.MaxPooling1D(2)(x)\nx = layers.Dropout(drop_out_rate)(x)\nx = layers.Conv1D(64, 5, padding='valid', activation='relu', strides=1)(x)\nx = layers.MaxPooling1D(2)(x)\nx = layers.Dropout(drop_out_rate)(x)\nx = layers.Conv1D(128, 3, padding='valid', activation='relu', strides=1)(x)\nx = layers.MaxPooling1D(2)(x)\nx = layers.Flatten()(x)\nx = layers.Dense(256, activation='relu')(x)\nx = layers.Dropout(drop_out_rate)(x)\nx = layers.Dense(128, activation='relu')(x)\nx = layers.Dropout(drop_out_rate)(x)\noutput_tensor = layers.Dense(len(label_value), activation='softmax')(x)\n\nmodel = tf.keras.Model(input_tensor, output_tensor)\n\nmodel.compile(loss=keras.losses.categorical_crossentropy,\n             optimizer=keras.optimizers.Adam(lr = lr),\n             metrics=['accuracy'])\n","707bef4a":"model.summary()","54c0377b":"history = model.fit(train_wav, train_label, validation_data=[test_wav, test_label],\n          batch_size=batch_size, \n          epochs=100,\n          verbose=1)","57563cd4":"plt.plot(history.history['acc'])\nplt.plot(history.history['val_acc'])\nplt.title('model accuracy')\nplt.ylabel('accuracy')\nplt.xlabel('epoch')\nplt.legend(['train', 'test'], loc='upper left')\nplt.show()\n# summarize history for loss\nplt.plot(history.history['loss'])\nplt.plot(history.history['val_loss'])\nplt.title('model loss')\nplt.ylabel('loss')\nplt.xlabel('epoch')\nplt.legend(['train', 'test'], loc='upper left')\nplt.show()","da396e6e":"### Data Augmentation\n\nFor Data Augmentation. I will mix train wav, and same length(1 sec) noise(10%) from '_background_noise_'\n","651b27e3":"### Train!","b6f3becc":"Random sampling from unknown wav data\n","1f9d7fd3":"May Some wav data has different length. So, Delete it","58db43ef":"### Load Data\n\ntarget list is ['yes', 'no', 'up', 'down', 'left', 'right', 'on', 'off', 'stop', 'go']\nunknown list is other\nsilence will be made from '_background_noise_'\n\nTrain data's sampling rate is 16000Hz, but for making lower computation cost, Resample to 8000hz\n\nAfter training, test set also will resample to 8000Hz","151e27a1":"Random sampling from '_background_noise_' \n\nRandom pick background noise \n","29973722":"Concatenate wavs, labels ","0c0e2403":"split wav, label","d55d8c05":"Check Dimensions","a69b6c65":"### Prepare Train"}}