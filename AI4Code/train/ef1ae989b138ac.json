{"cell_type":{"de2b21ff":"code","c3b26f2a":"code","0a68214b":"code","e59d3a1f":"code","fa01af6d":"code","686b4f0c":"code","e3070c04":"code","8e055ea7":"code","165f7aa8":"code","3688e610":"code","4d24c276":"code","565e73ca":"code","79104825":"code","12848d7d":"code","27673ad5":"code","ebc90e08":"code","bb241621":"code","dd3915ee":"code","cce36bff":"code","2d8b4b78":"code","3057b232":"code","b403835f":"code","d3d23fe4":"markdown","e2fdd843":"markdown","547bde86":"markdown","dfc8a9aa":"markdown","47b274d3":"markdown","f849f589":"markdown","4875b534":"markdown","9040e8eb":"markdown","fcaafe11":"markdown","0394ff21":"markdown","860034c4":"markdown","5ae3200a":"markdown","4b6f3f50":"markdown","3e62df68":"markdown","8c88e5d0":"markdown","ec4fcc6d":"markdown","6295bfad":"markdown"},"source":{"de2b21ff":"import xarray as xr\nimport datetime as dt\n\nimport numpy as np\nimport pandas as pd\nfrom scipy.interpolate import griddata\n\nimport matplotlib.gridspec as gridspec\nimport matplotlib.pyplot as plt\nimport matplotlib.pylab as pl\nfrom matplotlib import colors\n\n\n# Input data files are available in the \"..\/input\/\" directory.\n# Any results you write to the current directory are saved as output.","c3b26f2a":"####Cell containing the modifiable fields######\nzone = 'NW'\nyear = 2016\nmonth = 8\npart_month = 3\nind = 15   #index of the chosen 5 min of the decade \nnan_value = -1  #nan value for data (ex : rainfall here)\n\nrain_param = 'rainfall'    #parameter name for rainfall\nmask_param = 'lsm'         #parameter name for land-sea mask (cf meta-data in the mask GRIB file)\n\ndirectory = '\/kaggle\/input\/meteonet\/'\nrain_fname = directory + f'{zone}_rainfall_{str(year)}\/{zone}_rainfall_{str(year)}\/rainfall-{zone}-{str(year)}-{str(month).zfill(2)}\/rainfall-{zone}-{str(year)}-{str(month).zfill(2)}\/rainfall_{zone}_{str(year)}_{str(month).zfill(2)}.{str(part_month)}.npz'\nrain_coords_fname = directory + 'Radar_coords\/Radar_coords\/'+ f'radar_coords_{zone}.npz'\n\nmask_fname = directory + 'Masks\/Masks\/%s_masks.nc' % (zone)\n","0a68214b":"def radar_to_xarray(rain_fname,rain_coords_fname,ind):\n    \n    #load data\n    d = np.load(rain_fname, allow_pickle=True)\n    data = d['data'][ind,:,:]\n    \n    coords = np.load(rain_coords_fname, allow_pickle=True)\n    #it is about coordinates of the center of pixels \n    lat = coords['lats']\n    lon = coords['lons']\n    \n    data = xr.DataArray(data,coords=[lat[:,0],lon[0,:]],dims=['latitude','longitude'])\n    d_radar = data.to_dataset(name = 'rainfall')\n    \n    return d_radar,lat,lon","e59d3a1f":"d_radar,lat,lon = radar_to_xarray(rain_fname,rain_coords_fname,ind)","fa01af6d":"#ori : for original, data to interpolate\nori_data = d_radar\nori_param = rain_param\n#tar : for target, which corresponds to the target grid\ntar_fname = mask_fname\ntar_param = mask_param\n#nan value\nnan_value = -1  #nan value for data (ex : rainfall here)","686b4f0c":"data_to_interpolate = d_radar\ntarget_data = xr.open_dataset(tar_fname) ","e3070c04":"# convert missing data (from value to 'nan')\nnan_data_to_interpolate = data_to_interpolate.where(data_to_interpolate[\"rainfall\"]!=nan_value)  \n#today, with the function above, 2 interpolation methods are implemented for 2D arrays : 'linear' and 'nearest' for nearest neighbors\ninterpolated_data = nan_data_to_interpolate.interp_like(target_data,method='linear')    ","8e055ea7":"#\/!\\#### the plots options depend on the GRIB file structure###\nfig = plt.figure()\nwidths = [3.6,9, 3.6]\nheights = [9, 3.6]\nspec = fig.add_gridspec(ncols=3, nrows=2, width_ratios=widths,\n                         height_ratios=heights)\nax = fig.add_subplot(spec[0,1])\n\n#colorbar definition for rainfall\nif (np.max(data_to_interpolate[ori_param].values) > 65):\n    borne_max = np.max(data_to_interpolate[ori_param].values)\nelse:\n    borne_max = 65 + 10\ncmap = colors.ListedColormap(['silver','white', 'darkslateblue', 'mediumblue','dodgerblue', 'skyblue','olive','mediumseagreen'\n                              ,'cyan','lime','yellow','khaki','burlywood','orange','brown','pink','red','plum'])\nbounds = [-1,0,2,4,6,8,10,15,20,25,30,35,40,45,50,55,60,65,borne_max]\nnorm = colors.BoundaryNorm(bounds, cmap.N)\n\n#data to interpolate with nan\nfig.subplots_adjust(wspace=0, hspace=0)\nlabel = 'Width: {}\\nHeight: {}'.format(widths[1], heights[0])\nax.annotate('', (0.1, 0.5), xycoords='axes fraction', va='center')\nplt.imshow(nan_data_to_interpolate[ori_param].values,cmap=cmap, norm=norm)\nax.set_title('Rainfall (original grid)')\n\n#interpolated data\nax = fig.add_subplot(spec[1,0])\nfig.subplots_adjust(wspace=0, hspace=0)\nlabel = 'Width: {}\\nHeight: {}'.format(widths[0], heights[1])\nax.annotate('', (0.1, 0.5), xycoords='axes fraction', va='center')\nplt.imshow(interpolated_data[ori_param].values,cmap=cmap, norm=norm) \nax.set_title('Rainfall (interpolated on the mask grid)',fontsize = 9.5)\n\n#data with the target grid\nax = fig.add_subplot(spec[1,2])\nfig.subplots_adjust(wspace=0, hspace=0)\nlabel = 'Width: {}\\nHeight: {}'.format(widths[2], heights[1])\nax.annotate('', (0.1, 0.5), xycoords='axes fraction', va='center')\nplt.imshow(target_data[tar_param].values) \nax.set_title('Land-sea mask (original grid)',fontsize = 9.5)","165f7aa8":"####Cell containing the modifiable fields######\ndate = '2016-02-01T00:00:00'    #study date \n\nobs_param = 't'      #observation parameter\n\n#weather model parameters\nmodel = 'arome' #weather model (arome or arpege)\nMODEL = 'AROME' #weather model (AROME or ARPEGE)\nlevel = '2m'      #vertical level (2m, 10m, P_sea_level or PRECIP)\n\ngrid_param = 't2m'   #AROME parameter\ngrid_time_step = 0  #index for the studied time step (index 0 corresponds to 00h00 in each weather model file, cf documentation)","3688e610":"study_date = pd.Timestamp(date)  #study date\nfname = directory +zone+'_Ground_Stations\/'+zone+'_Ground_Stations\/'+zone+'_Ground_Stations_'+str(year)+\".csv\"\ndf =pd.read_csv(fname,parse_dates=[4],infer_datetime_format=True)\nd_sub = df[df['date'] == study_date]","4d24c276":"display(d_sub.head())","565e73ca":"directory_model = directory + zone + '_weather_models_2D_parameters_' + str(study_date.year) + str(study_date.month).zfill(2) + '\/' + str(study_date.year) + str(study_date.month).zfill(2) + '\/'\naro_fname = directory_model + f'{MODEL}\/{level}\/{model}_{level}_{zone}_{study_date.year}{str(study_date.month).zfill(2)}{str(study_date.day).zfill(2)}000000.nc'\n\naro = xr.open_dataset(aro_fname)\ngrid_lat = aro['latitude'].values\ngrid_lon = aro['longitude'].values\ngrid_val = aro[grid_param].values","79104825":"def interpolate_grid_on_points(grid_lat,grid_lon,grid_val,data_obs):\n    \n    #initialisation\n    latlon_grid = []\n    latlon_obs = []\n    val_grid = []\n    \n    #grid data preprocessing\n    for i in range(0,grid_lat.shape[0]):        \n        for j in range(0,grid_lon.shape[0]):\n            #put coordinates (lat,lon) in list of tuples\n            latlon_grid.append([round(grid_lat[i],3),round(grid_lon[j],3)])\n            #put grid values into a list\n            val_grid.append(grid_val[grid_time_step,i,j])\n    grid_latlon = np.array(latlon_grid)\n    grid_val2 = np.array(val_grid)\n\n    #obs data preprocessing : put coordinates (lat,lon) in list of tuples\n    for i in range(0,data_obs.shape[0]):\n        latlon_obs.append([data_obs['lat'].values[i],data_obs['lon'].values[i]])\n    latlon_obs = np.array(latlon_obs)\n    \n    #interpolation\n    grid_val_on_points=griddata(grid_latlon ,grid_val2, latlon_obs,  method='linear')\n    return latlon_obs,grid_val_on_points","12848d7d":"latlon_obs,grid_val_on_points = interpolate_grid_on_points(grid_lat,grid_lon,grid_val,d_sub)","27673ad5":"fig=plt.figure()\ngs = gridspec.GridSpec(4, 4)\n\n#Min and max boundaries about colorbar\nvmin_obs = d_sub[obs_param].min()\nvmax_obs = d_sub[obs_param].max()\nvmin_model_ori= aro.isel(step=grid_time_step)[grid_param].values.min()\nvmax_model_ori= aro.isel(step=grid_time_step)[grid_param].values.max()\nvmin_model_inter=grid_val_on_points.min()\nvmax_model_inter=grid_val_on_points.max()\nvmin=np.min([vmin_obs,vmin_model_ori,vmin_model_inter])\nvmax=np.max([vmax_obs,vmax_model_ori,vmax_model_inter])\n\n#observation data\nax1 = plt.subplot(gs[:2, :2])\nplt.tight_layout(pad=3.0)\nim=ax1.scatter(d_sub['lon'], d_sub['lat'], c=d_sub[obs_param], cmap='jet',vmin=vmin,vmax=vmax)\nax1.set_title('Observation data')\n\n#weather model data (original grid)\nax2 = plt.subplot(gs[:2, 2:])\nax2.pcolor(grid_lon,grid_lat,aro.isel(step=grid_time_step)[grid_param].values,cmap=\"jet\",vmin=vmin,vmax=vmax)\nax2.set_title('Weather model data (original grid)')\n\n#weather model data (interpolated on observation points)\nax3 = plt.subplot(gs[2:4, 1:3])\nax3.scatter(latlon_obs[:,1], latlon_obs[:,0], c=grid_val_on_points, cmap='jet',vmin=vmin,vmax=vmax)\nax3.set_title('Weather model data (interpolated on observation points)')\n\nfig.colorbar(im,ax=[ax1,ax2,ax3]).set_label('Temperature (in K)')\nplt.show()","ebc90e08":"####Cell containing the modifiable fields######\n###obs###\ndate = '2016-05-30T00:00:00'    #study date \nobs_param = 'hu'      #observation parameter\nnpz_param = 'rainfall'   #npz parameter\n\n#rainfall##\nyear = 2016\nmonth = 5\ndecade = 3\nind =  2592  #index of the chosen 5 min of the decade (index 2592 corresponds to 30\/05 at 00h00 for the last decade, cf documentation)\nnan_value = -1  #nan value for data (ex : rainfall here)\n\ndirectory = '\/kaggle\/input\/meteonet\/'\nrain_fname = directory + f'{zone}_rainfall_{str(year)}\/{zone}_rainfall_{str(year)}\/rainfall-{zone}-{str(year)}-{str(month).zfill(2)}\/rainfall-{zone}-{str(year)}-{str(month).zfill(2)}\/rainfall_{zone}_{str(year)}_{str(month).zfill(2)}.{str(part_month)}.npz'\nrain_coords_fname = directory + 'Radar_coords\/Radar_coords\/'+ f'radar_coords_{zone}.npz'","bb241621":"study_date = pd.Timestamp(date)  #study date\nfname = directory +zone+'_Ground_Stations\/'+zone+'_Ground_Stations\/'+zone+'_Ground_Stations_'+str(year)+\".csv\"\ndf =pd.read_csv(fname,parse_dates=[4],infer_datetime_format=True)\nd_sub = df[df['date'] == study_date]","dd3915ee":"display(d_sub.head())","cce36bff":"radar = np.load(rain_fname, allow_pickle=True)\ndata = radar['data'][ind,:,:]\ncoords = np.load(rain_coords_fname, allow_pickle=True)\n#it is about coordinates of the center of pixels\nlat = coords['lats']\nlon = coords['lons']","2d8b4b78":"def interpolate_radar_on_points(grid_lat,grid_lon,grid_val,data_obs):\n    #grid data preprocessing\n    latlon_grid = []\n    latlon_obs = []\n    val_grid = []\n    for i in range(0,grid_lat.shape[0]):        \n        for j in range(0,grid_lon.shape[1]):\n            #put coordinates (lat,lon) in list of tuples\n            latlon_grid.append([grid_lat[i,0],grid_lon[0,j]])\n            #put grid values into a list\n            val_grid.append(grid_val[i,j])\n    grid_latlon = np.array(latlon_grid)\n    grid_val2 = np.array(val_grid)\n    #replace 'missing data' values by nan\n    grid_val2 = grid_val2.astype(np.float64)\n    grid_val2[grid_val2==-1]=np.nan\n\n    #obs data preprocessing : put coordinates (lat,lon) in list of tuples\n    for i in range(0,data_obs.shape[0]):\n        latlon_obs.append([data_obs['lat'].values[i],data_obs['lon'].values[i]])\n    latlon_obs = np.array(latlon_obs)\n\n    #interpolation\n    grid_val_on_points=griddata(grid_latlon ,grid_val2, latlon_obs,  method='linear')\n    return latlon_obs,grid_val_on_points","3057b232":"latlon_obs,grid_val_on_points = interpolate_radar_on_points(lat,lon,data,d_sub)","b403835f":"fig=plt.figure()\ngs = gridspec.GridSpec(4, 4)\n\ndata_with_nan = data.astype(np.float64).copy()\ndata_with_nan[data_with_nan==-1]=np.nan\n\n#colorbar definition for rainfall\nmax_rr = max(np.nanmax(data),np.nanmax(d_sub[obs_param]),np.nanmax(grid_val_on_points))\nif (max_rr > 65):\n    borne_max = np.max(data_to_interpolate[ori_param].values)\nelse:\n    borne_max = 65 + 10\ncmap = colors.ListedColormap(['lavender','darkslateblue', 'mediumblue','dodgerblue', 'skyblue','olive','mediumseagreen'\n                              ,'cyan','lime','yellow','khaki','burlywood','orange','brown','pink','red','plum'])\nbounds = [0,1,4,6,8,10,15,20,25,30,35,40,45,50,55,60,65,borne_max]\nnorm = colors.BoundaryNorm(bounds, cmap.N)\n\n#observation data\nax1 = plt.subplot(gs[:2, :2])\nplt.tight_layout(pad=3.0)\nim=ax1.scatter(d_sub['lon'], d_sub['lat'], c=d_sub[obs_param], cmap = 'jet', s = 10)\nax1.set_title('Observation data : ' +obs_param + ' (%)')\nplt.colorbar(im)\n\n#rainfall data (original grid)\nax2 = plt.subplot(gs[:2, 2:])\nax2.pcolor(lon,lat,data_with_nan,cmap=cmap,norm=norm)\nax2.set_title('Radar : rainfall (original grid)')\n\n#rainfall data (interpolated on observation points)\nax3 = plt.subplot(gs[2:4, 1:3])\nim=ax3.scatter(latlon_obs[:,1], latlon_obs[:,0], c=grid_val_on_points, cmap=cmap,norm=norm, s = 10)\nax3.set_title('Radar : rainfall (interpolated on observation points)')\n\nfig.colorbar(im,ax=[ax2,ax3]).set_label('Rainfall (in 1\/100 mm) \/ NaN : missing values')\nplt.show()","d3d23fe4":"#### Step 1 : put NPZ data into an xarray (values, lat, lon)","e2fdd843":"#### Perform the interpolation\n**\/!\\ if the 'missing data' value is not nan (for example it is -1 for rainfall), it is necessary to convert these values before into nan if you want to use the linear interpolation method, else use the nearest neighbors method**","547bde86":"Load radar data : parameter values, latitudes and longitudes","dfc8a9aa":"Interpolation parameters (fname and parameter for each dataset : data to interpolate and target data):","47b274d3":"Overview of observation data for a given date :","f849f589":"Perform the interpolation:","4875b534":"Load the target data and the data to interpolate:","9040e8eb":"# II - Superimpose data on a grid with punctual data\n\n### Example 1 : 2D AROME data on the 2m level (netCDF file, 0.025\u00b0) to interpolate to ground station observations","fcaafe11":"### Example 2 : radar data (rainfall, NPZ file, 0.01\u00b0) to interpolate to ground station observations","0394ff21":"Plot the different data:","860034c4":"Load AROME data : parameter values, latitudes and longitudes","5ae3200a":"# I - Superimpose 2 grids of different resolutions\n\n## I.1 - 1 netCDF file and 1 radar file\n### Example : rainfall data (NPZ file, 0.01\u00b0) to interpolate to land-sea mask (netCDF file, 0.025\u00b0)\n#### Use xarray to open netCDF files and perform interpolation","4b6f3f50":"Plot the different data:","3e62df68":"Plot the different data:","8c88e5d0":"Perform the interpolation","ec4fcc6d":"# Superimpose data\n\nThe aim of this notebook is to indicate how to superimpose data from different sources (radar, satellite, weather models...).\n\nThere are 2 data categories :\n* data projected on a grid (radar, weather models...)\n* punctual data like observations from ground stations\n\nSo, this notebook provides functions which allow to :\n* superimpose 2 grids of different resolutions\n* superimpose data on a grid with punctual data","6295bfad":"Overview of observation data for a given date :"}}