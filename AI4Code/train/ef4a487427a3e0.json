{"cell_type":{"cd3876d5":"code","acc376fb":"code","e59d55b7":"code","c3856efc":"code","eed179a7":"code","0e691f2a":"code","5674257a":"code","47878ae2":"code","9e6e0f7c":"code","d00f920b":"code","5f9375ad":"code","dddd1e86":"code","589236f4":"code","a20d5296":"code","f1ad6d7f":"code","0e65841f":"code","5ddf0086":"code","5cab7c6c":"code","6baff32f":"code","3237e660":"code","64a9a5d1":"code","bab5d1a2":"code","547dde2f":"code","2a4ea491":"code","eeb810de":"code","d630e7f3":"code","f1c8f274":"code","9aad4efe":"code","b8f549f9":"code","d7029d5c":"code","96b36715":"code","f61b9e07":"code","9d2f2fa1":"code","bb1ee29b":"code","f14e9c09":"markdown","55e866bf":"markdown","ff6fd119":"markdown","ca3671de":"markdown","339e2457":"markdown","0fa5cf68":"markdown","f2ae2a24":"markdown","fc68106b":"markdown","7ce61a38":"markdown","7eed3fcb":"markdown","6602a007":"markdown","551d2214":"markdown","3dbcae75":"markdown","d2fe91eb":"markdown","8d02c42f":"markdown","db7394df":"markdown","2af5339b":"markdown","0c49aa30":"markdown","3cdb9bc8":"markdown","8b769fba":"markdown"},"source":{"cd3876d5":"import os\nimport cv2\nimport random\n","acc376fb":"# Check nvcc version\n!nvcc -V\n# Check GCC version\n!gcc --version","e59d55b7":"%%time\n\nprint(\"this will take around 10 mins\")\n# install dependencies: (use cu101 because colab has CUDA 10.1)\n# !pip install -U torch==1.7.0+cu101 torchvision==0.6.1+cu101 -f https:\/\/download.pytorch.org\/whl\/torch_stable.html\n\n# install mmcv-full thus we could use CUDA operators\n!pip install mmcv-full","c3856efc":"!rm -rf mmdetection\n!git clone --branch v2.7.0 https:\/\/github.com\/open-mmlab\/mmdetection.git\n%cd mmdetection\n\n!pip install -e .\n\n# install Pillow 7.0.0 back in order to avoid bug in colab\n!pip install Pillow==7.0.0","eed179a7":"# Check Pytorch installation\nimport torch, torchvision\nprint(torch.__version__, torch.cuda.is_available())\n\n# Check MMDetection installation\nimport mmdet\nprint(mmdet.__version__)\n\n# Check mmcv installation\nfrom mmcv.ops import get_compiling_cuda_version, get_compiler_version\nprint(get_compiling_cuda_version())\nprint(get_compiler_version())","0e691f2a":"!mkdir checkpoints\n!wget -c http:\/\/download.openmmlab.com\/mmdetection\/v2.0\/mask_rcnn\/mask_rcnn_r50_caffe_fpn_mstrain-poly_3x_coco\/mask_rcnn_r50_caffe_fpn_mstrain-poly_3x_coco_bbox_mAP-0.408__segm_mAP-0.37_20200504_163245-42aa3d00.pth \\\n      -O checkpoints\/mask_rcnn_r50_caffe_fpn_mstrain-poly_3x_coco_bbox_mAP-0.408__segm_mAP-0.37_20200504_163245-42aa3d00.pth","5674257a":"test_anno = \"..\/..\/input\/vinbigdata-1024-image-dataset\/vinbigdata\/test\"\n\nids = os.listdir(test_anno)","47878ae2":"img_infos = []\nfor i, _id in enumerate(ids):\n    if '.png' in _id:\n        img_infos.append({\n                    \"license\": 0,\n                    \"url\": 'null',\n                    \"file_name\": _id,\n                    \"height\": 1024,\n                    \"width\": 1024,\n                    \"date_captured\": 'null',\n                    \"id\": _id\n                })","9e6e0f7c":"img_infos[0]","d00f920b":"import json\nval_anno = '..\/..\/input\/vinbigdata-coco-dataset-with-wbf-3x-downscaled\/vinbigdata-coco-dataset-with-wbf-3x-downscaled\/val_annotations.json'\n\nwith open(val_anno) as f:\n    dd = json.load(f)\n\ndd.keys()\ndd['annotations']=[]\ndd['images']\ndd['images'] = img_infos\nwith open('.\/test_ann.json', 'w') as outfile:\n    json.dump(dd, outfile)","5f9375ad":"val_ids = os.listdir('..\/..\/input\/vinbigdata-coco-dataset-with-wbf-3x-downscaled\/vinbigdata-coco-dataset-with-wbf-3x-downscaled\/val_images')","dddd1e86":"_classes = (\"Aortic_enlargement\", \"Atelectasis\", \"Calcification\", \"Cardiomegaly\", \"Consolidation\", \"ILD\", \"Infiltration\", \"Lung_Opacity\", \"Nodule\/Mass\", \"Other_lesion\", \"Pleural_effusion\", \"Pleural_thickening\", \"Pneumothorax\", \"Pulmonary_fibrosis\")","589236f4":"\n_cfg_options = {\"dataset_type\" : 'CocoDataset',\n\"classes\" : '''(\"Aortic_enlargement\", \"Atelectasis\", \"Calcification\", \"Cardiomegaly\", \"Consolidation\", \"ILD\", \"Infiltration\", \"Lung_Opacity\", \"Nodule\/Mass\", \"Other_lesion\", \"Pleural_effusion\", \"Pleural_thickening\", \"Pneumothorax\", \"Pulmonary_fibrosis\")''',\n\"data.train.img_prefix\" : '..\/..\/input\/vinbigdata-coco-dataset-with-wbf-3x-downscaled\/vinbigdata-coco-dataset-with-wbf-3x-downscaled\/',\n\"data.train.classes\" : '''(\"Aortic_enlargement\", \"Atelectasis\", \"Calcification\", \"Cardiomegaly\", \"Consolidation\", \"ILD\", \"Infiltration\", \"Lung_Opacity\", \"Nodule\/Mass\", \"Other_lesion\", \"Pleural_effusion\", \"Pleural_thickening\", \"Pneumothorax\", \"Pulmonary_fibrosis\")''',\n\"data.train.ann_file\" : '..\/..\/input\/vinbigdata-coco-dataset-with-wbf-3x-downscaled\/vinbigdata-coco-dataset-with-wbf-3x-downscaled\/train_annotations.json',\n\"data.train.type\":'CocoDataset',\n\"data.val.img_prefix\" : '..\/..\/input\/vinbigdata-coco-dataset-with-wbf-3x-downscaled\/vinbigdata-coco-dataset-with-wbf-3x-downscaled\/',\n\"data.val.classes\" : '''(\"Aortic_enlargement\", \"Atelectasis\", \"Calcification\", \"Cardiomegaly\", \"Consolidation\", \"ILD\", \"Infiltration\", \"Lung_Opacity\", \"Nodule\/Mass\", \"Other_lesion\", \"Pleural_effusion\", \"Pleural_thickening\", \"Pneumothorax\", \"Pulmonary_fibrosis\")''',\n\"data.val.ann_file\" : '..\/..\/input\/vinbigdata-coco-dataset-with-wbf-3x-downscaled\/vinbigdata-coco-dataset-with-wbf-3x-downscaled\/val_annotations.json',\n\"data.val.type\" : 'CocoDataset',\n\"data.test.img_prefix\" :  '..\/..\/input\/vinbigdata-1024-image-dataset\/vinbigdata\/test\/',\n\"data.test.classes\" :  '''(\"Aortic_enlargement\", \"Atelectasis\", \"Calcification\", \"Cardiomegaly\", \"Consolidation\", \"ILD\", \"Infiltration\", \"Lung_Opacity\", \"Nodule\/Mass\", \"Other_lesion\", \"Pleural_effusion\", \"Pleural_thickening\", \"Pneumothorax\", \"Pulmonary_fibrosis\")''',\n\"data.test.ann_file\" :  '.\/test_ann.json',\n\"data.test.type\": 'CocoDataset',   \n\"model.roi_head.bbox_head.num_classes\" : '14',\n\"evaluation.metric\" : 'bbox',\n\"work_dir\": \"..\/vinbig_output\",\n\"load_from\" : '.\/checkpoints\/mask_rcnn_r50_caffe_fpn_mstrain-poly_3x_coco_bbox_mAP-0.408__segm_mAP-0.37_20200504_163245-42aa3d00.pth',\n\"total_epochs\" :'1'\n}\n\n\ncfg_op = \"\"\nfor k, v in _cfg_options.items():\n    cfg_op+=f\"{k}='{v}' \"\nprint(cfg_op)\n\n\n","a20d5296":"_cfg_options","f1ad6d7f":"_cfg_options['model.roi_head.bbox_head.num_classes']=14","0e65841f":"from mmdet.apis import inference_detector, init_detector, show_result_pyplot\n# Choose to use a config and initialize the detector\nconfig = 'configs\/faster_rcnn\/faster_rcnn_r50_caffe_fpn_mstrain_1x_coco.py'\n# Setup a checkpoint file to load\ncheckpoint = '..\/..\/input\/vinbig-mmdet-fasterrcnn-base12-epoch\/vinbig_output\/epoch_10.pth'\n# initialize the detector\nmodel = init_detector(config, checkpoint, device='cuda:0', cfg_options=_cfg_options)\nmodel.CLASSES = _classes","5ddf0086":"_id = random.randint(1,1098)\n# Use the detector to do inference\nimg = f'..\/..\/input\/vinbigdata-coco-dataset-with-wbf-3x-downscaled\/vinbigdata-coco-dataset-with-wbf-3x-downscaled\/val_images\/{val_ids[_id]}'\nresult = inference_detector(model, img)\nshow_result_pyplot(model, img, result, score_thr=0.3)","5cab7c6c":"result","6baff32f":"import os\nos.makedirs(\"..\/vinbig_output\")","3237e660":"# !python tools\/train.py .\/configs\/faster_rcnn\/faster_rcnn_r50_caffe_fpn_mstrain_1x_coco.py --cfg-options dataset_type='CocoDataset' classes='(\"Aortic_enlargement\", \"Atelectasis\", \"Calcification\", \"Cardiomegaly\", \"Consolidation\", \"ILD\", \"Infiltration\", \"Lung_Opacity\", \"Nodule\/Mass\", \"Other_lesion\", \"Pleural_effusion\", \"Pleural_thickening\", \"Pneumothorax\", \"Pulmonary_fibrosis\")' data.train.img_prefix='..\/..\/input\/vinbigdata-coco-dataset-with-wbf-3x-downscaled\/vinbigdata-coco-dataset-with-wbf-3x-downscaled\/' data.train.classes='(\"Aortic_enlargement\", \"Atelectasis\", \"Calcification\", \"Cardiomegaly\", \"Consolidation\", \"ILD\", \"Infiltration\", \"Lung_Opacity\", \"Nodule\/Mass\", \"Other_lesion\", \"Pleural_effusion\", \"Pleural_thickening\", \"Pneumothorax\", \"Pulmonary_fibrosis\")' data.train.ann_file='..\/..\/input\/vinbigdata-coco-dataset-with-wbf-3x-downscaled\/vinbigdata-coco-dataset-with-wbf-3x-downscaled\/train_annotations.json' data.train.type='CocoDataset' data.val.img_prefix='..\/..\/input\/vinbigdata-coco-dataset-with-wbf-3x-downscaled\/vinbigdata-coco-dataset-with-wbf-3x-downscaled\/' data.val.classes='(\"Aortic_enlargement\", \"Atelectasis\", \"Calcification\", \"Cardiomegaly\", \"Consolidation\", \"ILD\", \"Infiltration\", \"Lung_Opacity\", \"Nodule\/Mass\", \"Other_lesion\", \"Pleural_effusion\", \"Pleural_thickening\", \"Pneumothorax\", \"Pulmonary_fibrosis\")' data.val.ann_file='..\/..\/input\/vinbigdata-coco-dataset-with-wbf-3x-downscaled\/vinbigdata-coco-dataset-with-wbf-3x-downscaled\/val_annotations.json' data.val.type='CocoDataset' data.test.img_prefix='..\/..\/input\/vinbigdata-coco-dataset-with-wbf-3x-downscaled\/vinbigdata-coco-dataset-with-wbf-3x-downscaled\/' data.test.classes='(\"Aortic_enlargement\", \"Atelectasis\", \"Calcification\", \"Cardiomegaly\", \"Consolidation\", \"ILD\", \"Infiltration\", \"Lung_Opacity\", \"Nodule\/Mass\", \"Other_lesion\", \"Pleural_effusion\", \"Pleural_thickening\", \"Pneumothorax\", \"Pulmonary_fibrosis\")' data.test.ann_file='.\/test_ann.json' data.test.type='CocoDataset' model.roi_head.bbox_head.num_classes='14' evaluation.metric='bbox' work_dir='..\/vinbig_output' load_from='.\/checkpoints\/mask_rcnn_r50_caffe_fpn_mstrain-poly_3x_coco_bbox_mAP-0.408__segm_mAP-0.37_20200504_163245-42aa3d00.pth' total_epochs='1'\n","64a9a5d1":"!python tools\/test.py .\/configs\/faster_rcnn\/faster_rcnn_r50_caffe_fpn_mstrain_1x_coco.py ..\/..\/input\/vinbig-mmdet-fasterrcnn-base12-epoch\/vinbig_output\/epoch_10.pth --cfg-options dataset_type='CocoDataset' classes='(\"Aortic_enlargement\", \"Atelectasis\", \"Calcification\", \"Cardiomegaly\", \"Consolidation\", \"ILD\", \"Infiltration\", \"Lung_Opacity\", \"Nodule\/Mass\", \"Other_lesion\", \"Pleural_effusion\", \"Pleural_thickening\", \"Pneumothorax\", \"Pulmonary_fibrosis\")' data.train.img_prefix='..\/..\/input\/vinbigdata-coco-dataset-with-wbf-3x-downscaled\/vinbigdata-coco-dataset-with-wbf-3x-downscaled\/' data.train.classes='(\"Aortic_enlargement\", \"Atelectasis\", \"Calcification\", \"Cardiomegaly\", \"Consolidation\", \"ILD\", \"Infiltration\", \"Lung_Opacity\", \"Nodule\/Mass\", \"Other_lesion\", \"Pleural_effusion\", \"Pleural_thickening\", \"Pneumothorax\", \"Pulmonary_fibrosis\")' data.train.ann_file='..\/..\/input\/vinbigdata-coco-dataset-with-wbf-3x-downscaled\/vinbigdata-coco-dataset-with-wbf-3x-downscaled\/train_annotations.json' data.train.type='CocoDataset' data.val.img_prefix='..\/..\/input\/vinbigdata-coco-dataset-with-wbf-3x-downscaled\/vinbigdata-coco-dataset-with-wbf-3x-downscaled\/' data.val.classes='(\"Aortic_enlargement\", \"Atelectasis\", \"Calcification\", \"Cardiomegaly\", \"Consolidation\", \"ILD\", \"Infiltration\", \"Lung_Opacity\", \"Nodule\/Mass\", \"Other_lesion\", \"Pleural_effusion\", \"Pleural_thickening\", \"Pneumothorax\", \"Pulmonary_fibrosis\")' data.val.ann_file='..\/..\/input\/vinbigdata-coco-dataset-with-wbf-3x-downscaled\/vinbigdata-coco-dataset-with-wbf-3x-downscaled\/val_annotations.json' data.val.type='CocoDataset' data.test.img_prefix='..\/..\/input\/vinbigdata-1024-image-dataset\/vinbigdata\/test\/' data.test.classes='(\"Aortic_enlargement\", \"Atelectasis\", \"Calcification\", \"Cardiomegaly\", \"Consolidation\", \"ILD\", \"Infiltration\", \"Lung_Opacity\", \"Nodule\/Mass\", \"Other_lesion\", \"Pleural_effusion\", \"Pleural_thickening\", \"Pneumothorax\", \"Pulmonary_fibrosis\")' data.test.ann_file='.\/test_ann.json' data.test.type='CocoDataset' model.roi_head.bbox_head.num_classes='14' evaluation.metric='bbox' work_dir='..\/vinbig_output' load_from='.\/checkpoints\/mask_rcnn_r50_caffe_fpn_mstrain-poly_3x_coco_bbox_mAP-0.408__segm_mAP-0.37_20200504_163245-42aa3d00.pth' total_epochs='1' --out results.pkl\n\n","bab5d1a2":"# !python tools\/analyze_logs.py plot_curve ..\/..\/input\/vinbig-mmdet-fasterrcnn-base12-epoch\/vinbig_output\/None.log.json --keys lr --legend run1","547dde2f":"os.listdir(\".\/\")","2a4ea491":"import pickle\n\nwith open('.\/results.pkl', 'rb') as f:\n    data = pickle.load(f)","eeb810de":"\nimport json\nwith open('.\/test_ann.json', 'rb') as f:\n    ann = json.load(f)","d630e7f3":"import pandas as pd\ntest_df = pd.read_csv('..\/..\/input\/vinbigdata-original-image-dataset\/vinbigdata\/test.csv')","f1c8f274":"file_ids = [file_name.get('file_name').split('.png')[0] for file_name in ann.get('images')]","9aad4efe":"!pip install ensemble_boxes","b8f549f9":"from ensemble_boxes import *","d7029d5c":"ann_with_pred = zip(file_ids, data)\nsubmission_vals = []\nfor _id, preds in ann_with_pred:\n    boxes = []\n    scores = []\n    labels = []\n    width = test_df[test_df.image_id==_id]['width'].iloc[0]\n    height = test_df[test_df.image_id==_id]['height'].iloc[0]  \n    for i, pred in enumerate(preds):\n        if len(pred):\n            for p in pred:\n                box = p[:4]\/1024\n                boxes.append(box)\n                score = p[4].astype(float)\n                scores.append(score)\n                labels.append(i)\n    boxes, scores, labels = weighted_boxes_fusion([boxes], [scores], [labels], iou_thr=0.4, skip_box_thr=0.4)\n    boxes[:, 0] = boxes[:, 0]*height\n    boxes[:, 2] = boxes[:, 2]*height\n    boxes[:, 1] = boxes[:, 1]*width\n    boxes[:, 3] = boxes[:, 3]*width\n    \n    scaled_boxes = boxes.astype(int)\n    labels = labels.astype(int)\n    _id_preds = []\n    if len(scaled_boxes):\n        for i in range(len(scaled_boxes)):\n            _id_preds.append(str(labels[i]))\n            _id_preds.append(str(scores[i].round(2)))\n            _id_preds.append(str(scaled_boxes[i][0]))\n            _id_preds.append(str(scaled_boxes[i][1]))\n            _id_preds.append(str(scaled_boxes[i][2]))\n            _id_preds.append(str(scaled_boxes[i][3]))\n        pred_str = \" \".join(_id_preds)\n    else:\n        pred_str = '14 1 0 0 1 1'\n    submission_vals.append([_id, pred_str])\n\n","96b36715":"df = pd.DataFrame(submission_vals, columns = ['image_id','PredictionString'])","f61b9e07":"df.head()","9d2f2fa1":"len(df)","bb1ee29b":"df.to_csv(\"submission.csv\",index=False)","f14e9c09":"The output of the mmdet network is in the following form:","55e866bf":"# Test Installation","ff6fd119":"Over here I am just replacing the contents of validation annotation file with the list of test images. The annotation key in the dictionary will be an empty list. Rest will be same for the test ann file.","ca3671de":"# Inference On Single Image","339e2457":"The aim of the notebook is run inference on the test dataset using the faster-rcnn model trained for 12 epochs. This is just to show the demo of how to use the mmdet framework for test inference. The accuracy obtained from the submission file created is only 0.027. The mmdet framework can be used to easily train and test multiple models with different backbones, so it will be easier to create ensemble of models for final evaluation.\n","0fa5cf68":"# Preparing test anno file: Coco Format","f2ae2a24":"# Installing MMDET Framework","fc68106b":"# Adding extra config on BaseConfig","7ce61a38":"# Plotting loss curve","7eed3fcb":"# Running Inference on Test Images","6602a007":"MMDET framework gives the option to pass the extra config options as a command line arguments or one can pass the extra config in an dict variable in the function. The function can then merge this dict on the base config.","551d2214":"# Prediction Sample ","3dbcae75":"# Training Notebook Link FasterRCNN\n\nhttps:\/\/www.kaggle.com\/gauravsingh1\/mmdet-pytorch-framework-training-fasterrcnn-base","d2fe91eb":"# WBF on Test Predictions","8d02c42f":"# Creating Submission file","db7394df":"# Downloading Sample Checkpoints","2af5339b":"# Train the model using the python command","0c49aa30":"Feel free to change the id variable to see more predictions","3cdb9bc8":"If you have reached till here, Thanks for your time!!","8b769fba":"# Predicting For All the Test Images"}}