{"cell_type":{"d78a4d0d":"code","bfdd09df":"code","a8519715":"code","b9b1b545":"code","155694d3":"code","fcf5c304":"code","ea82bedd":"code","282f0f75":"code","2f12a683":"code","b2b45814":"code","99ad7dc2":"code","4cfe6e34":"code","688d57f6":"code","ceb60f8d":"code","3b0e38ae":"code","f8f2f6b7":"code","974c6c87":"code","d00854a1":"code","a59e9dd5":"code","c647d35c":"code","8f91a7ff":"code","7fed78d6":"code","d27f5aae":"code","5e6da302":"code","3f3e1f81":"code","a9381529":"code","1bdda7ec":"code","40bfb49b":"code","84f39e68":"code","14e6120e":"code","09e68a38":"code","93121bd9":"markdown","b61ea5d0":"markdown","cf4e4275":"markdown","59414d5f":"markdown","18251e0e":"markdown","f9e76c67":"markdown","d320dce1":"markdown","bc44ea53":"markdown","b11b5fa5":"markdown","525f880a":"markdown","64ab1626":"markdown","0a1cec5e":"markdown","fae5d320":"markdown","afd5ca6c":"markdown","50756959":"markdown","e2b15298":"markdown"},"source":{"d78a4d0d":"import pandas as pd\nimport os.path\nimport PIL\nimport PIL.ImageChops  \nimport PIL.ImageOps\nimport numpy as np\n\nfrom collections import OrderedDict\n\nimport matplotlib as mpl\nimport matplotlib.pyplot as plt\n%matplotlib inline\nmpl.rcParams['figure.figsize'] = [15, 5]","bfdd09df":"def get_path(path):\n    return os.path.join('\/kaggle\/input\/pku-autonomous-driving\/', path)","a8519715":"train_df = pd.read_csv(get_path('train.csv'))","b9b1b545":"train_df.head()","155694d3":"def unpack(group):\n    row = group.iloc[0]\n    result = []\n    data = row['PredictionString']\n    while data:\n        data = data.split(maxsplit=7)\n        result.append(OrderedDict((\n            ('image_id', row['ImageId']),\n            ('model_type', int(data[0])),\n            ('yaw', float(data[1])), \n            ('pitch', float(data[2])), \n            ('roll', float(data[3])), \n            ('x', float(data[4])), \n            ('y', float(data[5])),\n            ('z', float(data[6]))\n        )))\n        data = data[7] if len(data) == 8 else ''\n    return pd.DataFrame(result)","fcf5c304":"unpacked_train_df = train_df.groupby('ImageId', group_keys=False).apply(unpack).reset_index(drop=True)","ea82bedd":"unpacked_train_df.head()","282f0f75":"!cat \/kaggle\/input\/pku-autonomous-driving\/camera\/camera_intrinsic.txt","2f12a683":"def convert_3d_to_2d(x, y, z, fx = 2304.5479, fy = 2305.8757, cx = 1686.2379, cy = 1354.9849):\n    return x * fx \/ z + cx, y * fy \/ z + cy","b2b45814":"unpacked_train_df.groupby('image_id').size().describe()","99ad7dc2":"unpacked_train_df.groupby('image_id').size().hist(bins=44);","4cfe6e34":"len(train_df), len(unpacked_train_df)","688d57f6":"def read_masked_image(image_id, partition='train'):\n    i = PIL.Image.open(get_path('{}_images\/{}.jpg'.format(partition, image_id)))\n    try:\n        m = PIL.Image.open(get_path('{}_masks\/{}.jpg'.format(partition, image_id)))\n        return PIL.Image.composite(m, i, m.convert(mode='L'))\n    except FileNotFoundError:\n        return i","ceb60f8d":"def highlight(df, image_id):\n    df = df[df['image_id'] == image_id]\n    coords = df.apply(lambda row: pd.Series(convert_3d_to_2d(row['x'], row['y'], row['z'])), axis=1).values\n    plt.figure(figsize=(10, 10))\n    plt.imshow(read_masked_image(image_id))\n    plt.plot(coords[:, 0], coords[:, 1], 'ro', alpha=0.8, markersize=10)","3b0e38ae":"s = unpacked_train_df.groupby('image_id').size()\nfor image_id in s[s == 1].index:\n    highlight(unpacked_train_df, image_id)","f8f2f6b7":"highlight(unpacked_train_df, 'ID_001d6829a')","974c6c87":"unpacked_train_df['model_type'].value_counts().sort_index().plot(grid=True);","d00854a1":"unpacked_train_df['model_type'].value_counts().describe()","a59e9dd5":"def find_example(df, column, func):\n    row = df[df[column] == func(df[column])][:1]\n    highlight(row, row['image_id'].iloc[0])\n    return row","c647d35c":"unpacked_train_df['yaw'].hist(bins=100);","8f91a7ff":"unpacked_train_df['pitch'].hist(bins=100);","7fed78d6":"unpacked_train_df['roll'].hist(bins=100);","d27f5aae":"find_example(unpacked_train_df, 'pitch', lambda x: x.min())","5e6da302":"find_example(unpacked_train_df, 'pitch', lambda x: -1.58834)","3f3e1f81":"find_example(unpacked_train_df, 'pitch', lambda x: 1.58841)","a9381529":"submission_df = pd.read_csv(get_path('sample_submission.csv'))","1bdda7ec":"df = unpacked_train_df.rename({'pitch': 'yaw', 'yaw': 'pitch'})","40bfb49b":"columns = ('pitch', 'yaw', 'roll', 'x', 'y', 'z')\nbest_guess = []\nfor c in columns:\n    best_guess.append(df[c].median())\nbest_guess.append(1.0)  # confidence","84f39e68":"submission_df['PredictionString'] = ' '.join(map(str, best_guess))","14e6120e":"submission_df.to_csv('best_guess_submission.csv', index=False)","09e68a38":"submission_df.head()","93121bd9":"There is a one to many relationship: ImageId -> Cars. It's not very convenient to analyze it this way. So lets construct a table, that has a one to one relationship.","b61ea5d0":"# Sanity check with multiple cars","cf4e4275":"# Number of cars per image distribution","59414d5f":"Notice the occlusion here.","18251e0e":"# 3D to 2D","f9e76c67":"# Car models distribution","d320dce1":"# Random submission ","bc44ea53":"## Sanity check on one car images","b11b5fa5":"It's rather straightforward to convert x, y, z to image plane coordinates, but it took me some time to figure this out, so here it is.","525f880a":"According to this distributions \"pitch\" is actually yaw, \"yaw\" is pitch, \"roll\" is roll, but upside down for some reason. More over input is stated as 'model type, yaw, pitch, roll, x, y, z', but output should be 'pitch, yaw, roll, x, y, z and confidence'. Notice the yaw - pitch switch.\n\nLet's take a look at some examples. Feal free to experiment on your own. You'll find out some really weird markup errors.","64ab1626":"Let's define a helper function that will allow us to find some specific examples in the dataset.","0a1cec5e":"Hi everyone! This is my first kaggle notebook, but I hope that you'll find it usefull.\n\nMost significant features:\n* useful train.csv unpacking procedure\n* EDA of full data, not \"first car only\"\n* proper masking and vizualization without alpha hacks\n* x, y, z mapping to image plane\n* baseline submission without ml","fae5d320":"# Unpack train.csv","afd5ca6c":"# Yaw, pitch, roll distributions","50756959":"# Visualization","e2b15298":"Lets simply submit the most likely (independently though) parameters over the train dataset."}}