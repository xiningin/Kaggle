{"cell_type":{"44c59e7c":"code","f83516ae":"code","cb0d011e":"code","6f67e59a":"code","5b8574a1":"code","8caef1f0":"code","74e304df":"code","36d10450":"code","1c208d52":"code","1401b0da":"code","173d3292":"code","40039fa8":"code","5dc8b0c6":"code","f8721914":"code","9c88a0b3":"code","d360b8a6":"code","1e7062da":"code","c1909d22":"code","00ee1901":"code","341783c4":"code","7a12bea5":"code","40f1e1ff":"code","d1720c65":"code","64e62c42":"code","962c78c6":"code","bca4450a":"code","91954fcb":"code","e03ab585":"code","ae50cf9c":"code","8455a679":"code","04c08cfa":"code","7b2d5a89":"code","cbb3d4dc":"code","8496f40f":"code","4831e04a":"markdown","b8b79102":"markdown","a0b1e050":"markdown","d6085376":"markdown","0d404065":"markdown","41fb0ab3":"markdown","280cccc3":"markdown","b077c73f":"markdown","43e99276":"markdown","35773189":"markdown","94d172e1":"markdown","8e35d42f":"markdown","9cd7b757":"markdown","7571ad7d":"markdown","9b84b6df":"markdown","4f8854c8":"markdown","4fb45a1d":"markdown","2791d1ab":"markdown","08a2cd0b":"markdown","2a6c7388":"markdown","7faab23a":"markdown","1fd63166":"markdown","e992ce10":"markdown","f10d371d":"markdown","c4d05164":"markdown","5ae6f20e":"markdown","57eb7c70":"markdown","17014b76":"markdown","3d378a7a":"markdown","c8ffcd31":"markdown","174b0456":"markdown","33d7ced0":"markdown"},"source":{"44c59e7c":"import pandas as pd\nimport numpy as np\nimport seaborn as sns\nimport matplotlib.pyplot as plt\nfrom sklearn.preprocessing import StandardScaler\nfrom sklearn.cluster import KMeans, AffinityPropagation\nimport warnings\nwarnings.filterwarnings(\"ignore\")","f83516ae":"data = pd.read_csv(\"..\/input\/german_credit_data.csv\")","cb0d011e":"data.head()","6f67e59a":"data.drop(data.columns[0], inplace=True, axis=1)\nprint(\"Database has {} obserwations (customers) and {} columns (attributes).\".format(data.shape[0],data.shape[1]))\nprint(\"Missing values in each column:\\n{}\".format(data.isnull().sum()))\nprint(\"Columns data types:\\n{}\".format(data.dtypes))","5b8574a1":"n_unique = data.nunique()\nprint(\"Number of unique values:\\n{}\".format(n_unique))","8caef1f0":"print(\"Unique values in each categorical column:\")\nfor col in data.select_dtypes(include=[object]):\n    print(col,\":\", data[col].unique())","74e304df":"def scatters(data, h=None, pal=None):\n    fig, (ax1, ax2, ax3) = plt.subplots(3,1, figsize=(8,8))\n    sns.scatterplot(x=\"Credit amount\",y=\"Duration\", hue=h, palette=pal, data=data, ax=ax1)\n    sns.scatterplot(x=\"Age\",y=\"Credit amount\", hue=h, palette=pal, data=data, ax=ax2)\n    sns.scatterplot(x=\"Age\",y=\"Duration\", hue=h, palette=pal, data=data, ax=ax3)\n    plt.tight_layout()","36d10450":"scatters(data, h=\"Sex\")","1c208d52":"import scipy.stats as stats\nr1 = sns.jointplot(x=\"Credit amount\",y=\"Duration\", data=data, kind=\"reg\", height=8)\nr1.annotate(stats.pearsonr)\nplt.show()","1401b0da":"sns.lmplot(x=\"Credit amount\",y=\"Duration\", hue=\"Sex\", data=data, palette=\"Set1\", aspect=2)\nplt.show()","173d3292":"sns.lmplot(x=\"Credit amount\",y=\"Duration\", hue=\"Housing\", data=data, palette=\"Set1\", aspect=2)\nplt.show()","40039fa8":"sns.jointplot(\"Credit amount\",\"Duration\", data=data, kind=\"kde\", space=0, color=\"g\",  height=8)\nplt.show()","5dc8b0c6":"n_credits = data.groupby(\"Purpose\")[\"Age\"].count().rename(\"Count\").reset_index()\nn_credits.sort_values(by=[\"Count\"], ascending=False, inplace=True)\n\nplt.figure(figsize=(10,6))\nbar = sns.barplot(x=\"Purpose\",y=\"Count\",data=n_credits)\nbar.set_xticklabels(bar.get_xticklabels(), rotation=60)\nplt.ylabel(\"Number of granted credits\")\nplt.tight_layout()","f8721914":"def boxes(x,y,h,r=45):\n    fig, ax = plt.subplots(figsize=(10,6))\n    box = sns.boxplot(x=x,y=y, hue=h, data=data)\n    box.set_xticklabels(box.get_xticklabels(), rotation=r)\n    fig.subplots_adjust(bottom=0.2)\n    plt.tight_layout()","9c88a0b3":"boxes(\"Purpose\",\"Credit amount\",\"Sex\")","d360b8a6":"boxes(\"Purpose\",\"Duration\",\"Sex\")","1e7062da":"boxes(\"Housing\",\"Credit amount\",\"Sex\",r=0)","c1909d22":"boxes(\"Job\",\"Credit amount\",\"Sex\",r=0)","00ee1901":"boxes(\"Job\",\"Duration\",\"Sex\",r=0)","341783c4":"from mpl_toolkits.mplot3d import Axes3D \nfig = plt.figure(figsize=(10,6))\nax = fig.add_subplot(111, projection='3d')\nax.scatter(data[\"Credit amount\"], data[\"Duration\"], data[\"Age\"])\nax.set_xlabel(\"Credit amount\")\nax.set_ylabel(\"Duration\")\nax.set_zlabel(\"Age\")","7a12bea5":"#Selecting columns for clusterisation with k-means\nselected_cols = [\"Age\",\"Credit amount\", \"Duration\"]\ncluster_data = data.loc[:,selected_cols]","40f1e1ff":"def distributions(df):\n    fig, (ax1, ax2, ax3) = plt.subplots(3,1, figsize=(8,8))\n    sns.distplot(df[\"Age\"], ax=ax1)\n    sns.distplot(df[\"Credit amount\"], ax=ax2)\n    sns.distplot(df[\"Duration\"], ax=ax3)\n    plt.tight_layout()","d1720c65":"distributions(cluster_data)","64e62c42":"cluster_log = np.log(cluster_data)\ndistributions(cluster_log)","962c78c6":"scaler = StandardScaler()\ncluster_scaled = scaler.fit_transform(cluster_log)","bca4450a":"clusters_range = [2,3,4,5,6,7,8,9,10,11,12,13,14]\ninertias =[]\n\nfor c in clusters_range:\n    kmeans = KMeans(n_clusters=c, random_state=0).fit(cluster_scaled)\n    inertias.append(kmeans.inertia_)\n\nplt.figure()\nplt.plot(clusters_range,inertias, marker='o')","91954fcb":"from sklearn.metrics import silhouette_samples, silhouette_score\n\nclusters_range = range(2,15)\nrandom_range = range(0,20)\nresults =[]\nfor c in clusters_range:\n    for r in random_range:\n        clusterer = KMeans(n_clusters=c, random_state=r)\n        cluster_labels = clusterer.fit_predict(cluster_scaled)\n        silhouette_avg = silhouette_score(cluster_scaled, cluster_labels)\n        #print(\"For n_clusters =\", c,\" and seed =\", r,  \"\\nThe average silhouette_score is :\", silhouette_avg)\n        results.append([c,r,silhouette_avg])\n\nresult = pd.DataFrame(results, columns=[\"n_clusters\",\"seed\",\"silhouette_score\"])\npivot_km = pd.pivot_table(result, index=\"n_clusters\", columns=\"seed\",values=\"silhouette_score\")\n\nplt.figure(figsize=(15,6))\nsns.heatmap(pivot_km, annot=True, linewidths=.5, fmt='.3f', cmap=sns.cm.rocket_r)\nplt.tight_layout()","e03ab585":"kmeans_sel = KMeans(n_clusters=3, random_state=1).fit(cluster_scaled)\nlabels = pd.DataFrame(kmeans_sel.labels_)\nclustered_data = cluster_data.assign(Cluster=labels)","ae50cf9c":"import matplotlib.cm as cm\n\nclusterer = KMeans(n_clusters=3, random_state=1)\ncluster_labels = clusterer.fit_predict(cluster_scaled)\nsilhouette_avg = silhouette_score(cluster_scaled, cluster_labels)\nprint(\"For n_clusters =\", 3,\" and seed =\", r,  \"\\nThe average silhouette_score is :\", silhouette_avg)\n\n# Compute the silhouette scores for each sample\nsample_silhouette_values = silhouette_samples(cluster_scaled, cluster_labels)\n\nfig, ax1 = plt.subplots(figsize=(10,6))\n\ny_lower = 10\nfor i in range(3):\n    # Aggregate the silhouette scores for samples belonging to\n    # cluster i, and sort them\n    ith_cluster_silhouette_values = sample_silhouette_values[cluster_labels == i]\n    ith_cluster_silhouette_values.sort()\n\n    size_cluster_i = ith_cluster_silhouette_values.shape[0]\n    y_upper = y_lower + size_cluster_i\n    \n    color = cm.nipy_spectral(float(i) \/ 3)\n    ax1.fill_betweenx(np.arange(y_lower, y_upper),0, ith_cluster_silhouette_values, facecolor=color, edgecolor=\"black\", alpha=0.7)\n    \n    # Label the silhouette plots with their cluster numbers at the middle\n    ax1.text(-0.05, y_lower + 0.5 * size_cluster_i, str(i))\n    \n    # Compute the new y_lower for next plot\n    y_lower = y_upper + 10  # 10 for the 0 samples\n\nax1.get_yaxis().set_ticks([])\nax1.set_title(\"The silhouette plot for various clusters\")\nax1.set_xlabel(\"The silhouette coefficient values\")\nax1.set_ylabel(\"Cluster label\")\n# The vertical line for average silhouette score of all the values\nax1.axvline(x=silhouette_avg, color=\"red\", linestyle=\"--\")\nax1.set_xticks([-0.1, 0, 0.2, 0.4, 0.6, 0.8, 1])","8455a679":"scatters(clustered_data, 'Cluster')","04c08cfa":"grouped_km = clustered_data.groupby(['Cluster']).mean().round(1)\ngrouped_km","7b2d5a89":"preferences = np.arange(-30,-190,-10)\nclusters = []\n\nfor p in preferences:\n    af = AffinityPropagation(preference=p, damping=0.6, max_iter=400, verbose=False).fit(cluster_scaled)\n    labels_af = pd.DataFrame(af.labels_)\n    clusters.append(len(af.cluster_centers_indices_))\n\nplt.figure(figsize=(10,7))\nplt.xlabel(\"Preference\")\nplt.ylabel(\"Number of clusters\")\nplt.plot(preferences,clusters, marker='o')\n","cbb3d4dc":"af = AffinityPropagation(preference=-140, damping=0.6, verbose=False).fit(cluster_scaled)\nlabels_af = pd.DataFrame(af.labels_)\nn_clusters_ = len(af.cluster_centers_indices_)\n\nclustered_data_af = cluster_data.assign(Cluster=labels_af)\nscatters(clustered_data_af,'Cluster')\n\ngrouped_af = clustered_data_af.groupby(['Cluster']).mean().round(1)\n","8496f40f":"grouped_af = clustered_data_af.groupby(['Cluster']).mean().round(1)\ngrouped_af","4831e04a":"A visual control of the first five rows.","b8b79102":"Let's look at the histograms.","a0b1e050":"I will define a function showing clusters on the scatter plot.  ","d6085376":"The plot above indicates that there is no significant difference between men and women.","0d404065":"The general impression is that women tend to be younger than men, however, the top plot shows that there is no clear difference between men and women in terms of amount and duration of the credit. From visual inspection, it seems that there is some positive correlation between duration and amount of credit, what makes sense. \n\nLet\u2019s check the linear correlation between credit amount and duration","41fb0ab3":"Plots above show three created clusters. Two bottom ones show relatively clear separation of clusters, but it is no so evident on the top one. \n\nI will generate now a heatmap plot for easier business interpretation of customer segmentation.  ","280cccc3":"The heatmap above shows silhouette scores for various combinations of random state and number of clusters. The highest scores are for 2 and 3 clusters and they are relatively insensitive to seed. \n\nI will chose 3 clusters to get more insight into data.","b077c73f":"Reading the raw data ","43e99276":"**Clustering with Affinity Propagation**","35773189":"The plot above shows similarly that there is no diference betwen housing categories.\n\nBelow I will show \u201cbusiness\u201d area where granted the biggest amount of credits. ","94d172e1":"In terms of housing category, there is no big difference despite people having \u201cfree\u201d housing tend to take slightly bigger credit amounts.","8e35d42f":"In terms of job category once again there is no difference between men and women, but we can see that job category 3 tends to take bigger credit amounts for longer duration.  \n\nAnd at the end if someone likes 3D plots here you go.","9cd7b757":"Cluster 0 \u2013 high mean of credit amount, long duration, younger customers\n\nCluster 1 \u2013 low mean of credit amount, short duration, younger customers\n\nCluster 2 - low mean of credit amount, short duration, older customers\n\nCluster 3 - high mean of credit amount, middle-time duration, older customers","7571ad7d":"We can see that distributions are right-skewed. To obtain better results we should remove the skewness by logarithmic transformation. After that let's see how they look like.","9b84b6df":"# Bank Customer Segmentation\n\nIn this kernel I will perform segmentation of German bank customers. The first step is to read necessary libraries. We will use: \n* [pandas](https:\/\/pandas.pydata.org\/) - to manipulate data frames\n* [numpy](http:\/\/www.numpy.org\/) - providing linear algebra\n* [seaborm](https:\/\/seaborn.pydata.org\/) - to create nice visualizations\n* [matplotlib](https:\/\/matplotlib.org\/) - basic tools for visualizations\n* [scikit-learn](https:\/\/scikit-learn.org\/stable\/) - machine learning library\n\nFrom sklearn, I will import necessary pre-processing tools and two clustering algorithms: [KMeans](https:\/\/scikit-learn.org\/stable\/modules\/generated\/sklearn.cluster.KMeans.html) and [Affinity Propagation](https:\/\/scikit-learn.org\/stable\/modules\/generated\/sklearn.cluster.AffinityPropagation.html).\n","4f8854c8":"It looks that the first column is simply an index which we can delete. I will check how many missing values are in each column and of what data types they are. ","4fb45a1d":"The plot above shows a linear correlation with Pearson value of 0.62 and very small p-value. That make\u2019s sense because usually, people take bigger credits for longer periods.  Below I will analyse linear regression plots with various categorisations.","2791d1ab":"At the beginning let\u2019s look at scatter plots our 3 numerical variables stratified by sex.","08a2cd0b":"I will check how inertia changes for various number of clusters.","2a6c7388":"Together with decreasing value of preference parameter number of clusters goes down as well and levels for very small preference values. I will check four clusters option. ","7faab23a":"Below I will create silhouette graph for 3 clusters in order to visually depict fit of each point within its own cluster (modified code from scikit-learn doc).","1fd63166":"Indeed, the skewness has been eliminated. \n\nThe next step will be centering and scaling of variables \u2013 it is required by KMeans algorithm.  We will use for that a StandardScaler from sklearn library. ","e992ce10":"The boxplot above indicates that generally there is no difference in credit duration between men and women. We can\u2019t see also clear trend between categories with observations that the shortest duration is for domestic appliances.  It makes sense as it is in agreement with insights from the previous graph (credit amount) \u2013 in this category, there are the lowest amounts of credits.","f10d371d":"The plot above shows that the biggest amounts are taken for vacations\/others, the smallest for domestic appliances. Most of them have outliers on the upper side of the boxes (higher amounts). In most of the cases there is no difference between men and women, despite category vacation\/others. But one must remember that there was very little number of credits granted in this category. ","c4d05164":"I will create a function which plots three histograms - one for each variable. ","5ae6f20e":"The plot above shows that inertia decreases with increasing number of clusters. \n\nThis method allows for assessment of cluster separations and fitting of each observation in its own cluster.  The highest score the better.  I will perform this analysis for various seeds as well.","57eb7c70":"The barplot above shows how many credits were granted for various purposes. Most of credits were granted for car and radio\/TV.\n\nNow I will generate boxplots for detailed analysis of categorical variables.","17014b76":"**Exploratory Data Analysis**\n\nBelow I will define a function which will generate plots for three numeric variables with stratification by selected categorical column.","3d378a7a":"In this algorithm there are two relevant parameters: preference and dumping. It means that we don\u2019t define upfront number of clusters, algorithm itself chooses their number. I will fix dumping and check number of clusters in function of preference parameter.  ","c8ffcd31":"Out of 8 columns 2 contain missing values. Probably these are customers who don\u2019t have one of these two accounts. \n\nGenerally, there are 3 numeric variables and 5 categorical ones.\n\nNow, I will check how many, and what are the possible (unique) values in each categorical column.","174b0456":"Cluster 0 \u2013  lower mean of credit amount, short duration, older customers\n\nCluster 1 \u2013 high mean of credit amount, long duration, middle-aged customers\n\nCluster 2 - lower mean of credit amount, short duration, young customers","33d7ced0":"**Clustering with KMeans**\n\nFor clustering, I will create a subset containing only numerical variables (Age, Credit amount, Duration). "}}