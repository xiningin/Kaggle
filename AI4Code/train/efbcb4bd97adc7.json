{"cell_type":{"b930eecc":"code","3c73e343":"code","a7534931":"code","54574ab3":"code","9b741ff6":"code","85bcf056":"code","94420e52":"code","6049035f":"code","932f60f6":"code","c2a00706":"code","725c45fa":"code","6c8725d1":"code","02c33695":"code","99342476":"code","92d4a038":"code","a1787397":"code","ff06dc68":"code","10b80f2d":"code","4a8675ec":"code","27713c0e":"code","63d1fdaf":"code","653a2694":"code","a7e5aabc":"code","12d7bc33":"code","cfb7e80d":"code","efa7c394":"code","6645d1f7":"code","4f74321c":"code","40052752":"code","f59d4382":"code","8097a087":"code","e68a8aa3":"code","6b66779f":"code","3d882fdc":"code","b3f9c714":"code","9ed04a24":"code","30e69809":"code","023f4d9b":"code","52963fea":"code","601244cd":"code","7576a4b0":"code","e66f2ecb":"code","ac17cfd8":"code","717f0dab":"code","353e15cc":"code","3a7d5654":"code","0d00a88d":"code","fe631425":"code","641fd95e":"code","e08204fb":"code","7dd0dc40":"code","d09f143d":"code","1b414599":"code","d75bc7f3":"markdown","ba15625d":"markdown","9c1bcaf0":"markdown","a4cb783e":"markdown","d3b8c091":"markdown","867f95d1":"markdown","d0fbf91f":"markdown","51408e5b":"markdown","ffc95f17":"markdown","144b8ad7":"markdown","367aaf80":"markdown","4adeade3":"markdown","5e901996":"markdown","99069bd6":"markdown","baf22336":"markdown","0017f97e":"markdown","ee93db1c":"markdown","32536393":"markdown","4313fdff":"markdown","82e2803c":"markdown"},"source":{"b930eecc":"import gc\nimport re\nimport operator \n\nimport numpy as np\nimport pandas as pd\n\nfrom gensim.models import KeyedVectors\n\nfrom sklearn import model_selection\n\nfrom keras.preprocessing.text import Tokenizer\nfrom keras.preprocessing.sequence import pad_sequences\nfrom keras.layers import Embedding, Input, Dense, CuDNNGRU,concatenate, Dropout, Bidirectional,CuDNNLSTM, SpatialDropout1D, Conv1D, GlobalAveragePooling1D, GlobalMaxPooling1D\nfrom keras.optimizers import RMSprop, Adam\nfrom keras.models import Model\nfrom keras.callbacks import EarlyStopping\n\nimport seaborn as sns","3c73e343":"train = pd.read_csv(\"..\/input\/jigsaw-unintended-bias-in-toxicity-classification\/train.csv\")\ntest = pd.read_csv(\"..\/input\/jigsaw-unintended-bias-in-toxicity-classification\/test.csv\")\n\nprint(\"Train shape : \",train.shape)\nprint(\"Test shape : \",test.shape)\n\n\ntrain.head()\n","a7534931":"test.head()","54574ab3":"# Only 13GB of ram available, we gotta be careful !\n\ndf = pd.concat([train[['id','comment_text']], test], axis=0)\ndel(train, test)\ngc.collect()","9b741ff6":"ft_common_crawl = '..\/input\/fasttext-crawl-300d-2m\/crawl-300d-2M.vec'\nembeddings_index = KeyedVectors.load_word2vec_format(ft_common_crawl)","85bcf056":"gc.collect()","94420e52":"def build_vocab(texts):\n    sentences = texts.apply(lambda x: x.split()).values\n    vocab = {}\n    for sentence in sentences:\n        for word in sentence:\n            try:\n                vocab[word] += 1\n            except KeyError:\n                vocab[word] = 1\n    return vocab","6049035f":"def check_coverage(vocab, embeddings_index):\n    known_words = {}\n    unknown_words = {}\n    nb_known_words = 0\n    nb_unknown_words = 0\n    for word in vocab.keys():\n        try:\n            known_words[word] = embeddings_index[word]\n            nb_known_words += vocab[word]\n        except:\n            unknown_words[word] = vocab[word]\n            nb_unknown_words += vocab[word]\n            pass\n\n    print('Found embeddings for {:.3%} of vocab'.format(len(known_words) \/ len(vocab)))\n    print('Found embeddings for  {:.3%} of all text'.format(nb_known_words \/ (nb_known_words + nb_unknown_words)))\n    unknown_words = sorted(unknown_words.items(), key=operator.itemgetter(1))[::-1]\n\n    return unknown_words","932f60f6":"df['comment_text'] = df['comment_text'].apply(lambda x: x.lower())\ngc.collect()","c2a00706":"vocab = build_vocab(df['comment_text'])\noov = check_coverage(vocab, embeddings_index)\noov[:10]","725c45fa":"gc.collect()","6c8725d1":"contraction_mapping = {\"ain't\": \"is not\", \"aren't\": \"are not\",\"can't\": \"cannot\", \"'cause\": \"because\", \"could've\": \"could have\", \"couldn't\": \"could not\", \"didn't\": \"did not\",  \"doesn't\": \"does not\", \"don't\": \"do not\", \"hadn't\": \"had not\", \"hasn't\": \"has not\", \"haven't\": \"have not\", \"he'd\": \"he would\",\"he'll\": \"he will\", \"he's\": \"he is\", \"how'd\": \"how did\", \"how'd'y\": \"how do you\", \"how'll\": \"how will\", \"how's\": \"how is\",  \"I'd\": \"I would\", \"I'd've\": \"I would have\", \"I'll\": \"I will\", \"I'll've\": \"I will have\",\"I'm\": \"I am\", \"I've\": \"I have\", \"i'd\": \"i would\", \"i'd've\": \"i would have\", \"i'll\": \"i will\",  \"i'll've\": \"i will have\",\"i'm\": \"i am\", \"i've\": \"i have\", \"isn't\": \"is not\", \"it'd\": \"it would\", \"it'd've\": \"it would have\", \"it'll\": \"it will\", \"it'll've\": \"it will have\",\"it's\": \"it is\", \"let's\": \"let us\", \"ma'am\": \"madam\", \"mayn't\": \"may not\", \"might've\": \"might have\",\"mightn't\": \"might not\",\"mightn't've\": \"might not have\", \"must've\": \"must have\", \"mustn't\": \"must not\", \"mustn't've\": \"must not have\", \"needn't\": \"need not\", \"needn't've\": \"need not have\",\"o'clock\": \"of the clock\", \"oughtn't\": \"ought not\", \"oughtn't've\": \"ought not have\", \"shan't\": \"shall not\", \"sha'n't\": \"shall not\", \"shan't've\": \"shall not have\", \"she'd\": \"she would\", \"she'd've\": \"she would have\", \"she'll\": \"she will\", \"she'll've\": \"she will have\", \"she's\": \"she is\", \"should've\": \"should have\", \"shouldn't\": \"should not\", \"shouldn't've\": \"should not have\", \"so've\": \"so have\",\"so's\": \"so as\", \"this's\": \"this is\",\"that'd\": \"that would\", \"that'd've\": \"that would have\", \"that's\": \"that is\", \"there'd\": \"there would\", \"there'd've\": \"there would have\", \"there's\": \"there is\", \"here's\": \"here is\",\"they'd\": \"they would\", \"they'd've\": \"they would have\", \"they'll\": \"they will\", \"they'll've\": \"they will have\", \"they're\": \"they are\", \"they've\": \"they have\", \"to've\": \"to have\", \"wasn't\": \"was not\", \"we'd\": \"we would\", \"we'd've\": \"we would have\", \"we'll\": \"we will\", \"we'll've\": \"we will have\", \"we're\": \"we are\", \"we've\": \"we have\", \"weren't\": \"were not\", \"what'll\": \"what will\", \"what'll've\": \"what will have\", \"what're\": \"what are\",  \"what's\": \"what is\", \"what've\": \"what have\", \"when's\": \"when is\", \"when've\": \"when have\", \"where'd\": \"where did\", \"where's\": \"where is\", \"where've\": \"where have\", \"who'll\": \"who will\", \"who'll've\": \"who will have\", \"who's\": \"who is\", \"who've\": \"who have\", \"why's\": \"why is\", \"why've\": \"why have\", \"will've\": \"will have\", \"won't\": \"will not\", \"won't've\": \"will not have\", \"would've\": \"would have\", \"wouldn't\": \"would not\", \"wouldn't've\": \"would not have\", \"y'all\": \"you all\", \"y'all'd\": \"you all would\",\"y'all'd've\": \"you all would have\",\"y'all're\": \"you all are\",\"y'all've\": \"you all have\",\"you'd\": \"you would\", \"you'd've\": \"you would have\", \"you'll\": \"you will\", \"you'll've\": \"you will have\", \"you're\": \"you are\", \"you've\": \"you have\" }","02c33695":"del(vocab,oov)\ngc.collect()","99342476":"def known_contractions(embed):\n    known = []\n    for contract in contraction_mapping:\n        if contract in embed:\n            known.append(contract)\n    return known","92d4a038":"print(\"- Known Contractions -\")\nprint(\"   FastText :\")\nprint(known_contractions(embeddings_index))","a1787397":"def clean_contractions(text, mapping):\n    specials = [\"\u2019\", \"\u2018\", \"\u00b4\", \"`\"]\n    for s in specials:\n        text = text.replace(s, \"'\")\n    text = ' '.join([mapping[t] if t in mapping else t for t in text.split(\" \")])\n    return text","ff06dc68":"df['comment_text'] = df['comment_text'].apply(lambda x: clean_contractions(x, contraction_mapping))","10b80f2d":"vocab = build_vocab(df['comment_text'])\noov = check_coverage(vocab, embeddings_index)\noov[:10]","4a8675ec":"del(vocab,oov)\ngc.collect()","27713c0e":"punct = \"\/-'?!.,#$%\\'()*+-\/:;<=>@[\\\\]^_`{|}~\" + '\"\"\u201c\u201d\u2019' + '\u221e\u03b8\u00f7\u03b1\u2022\u00e0\u2212\u03b2\u2205\u00b3\u03c0\u2018\u20b9\u00b4\u00b0\u00a3\u20ac\\\u00d7\u2122\u221a\u00b2\u2014\u2013&'","63d1fdaf":"def unknown_punct(embed, punct):\n    unknown = ''\n    for p in punct:\n        if p not in embed:\n            unknown += p\n            unknown += ' '\n    return unknown","653a2694":"print(unknown_punct(embeddings_index, punct))","a7e5aabc":"punct_mapping = {\"_\":\" \", \"`\":\" \"}","12d7bc33":"def clean_special_chars(text, punct, mapping):\n    for p in mapping:\n        text = text.replace(p, mapping[p])    \n    for p in punct:\n        text = text.replace(p, f' {p} ')     \n    return text","cfb7e80d":"df['comment_text'] = df['comment_text'].apply(lambda x: clean_special_chars(x, punct, punct_mapping))","efa7c394":"vocab = build_vocab(df['comment_text'])\noov = check_coverage(vocab, embeddings_index)\n","6645d1f7":"oov[:100]","4f74321c":"del(vocab,oov)\ngc.collect()","40052752":"swear_words = [\n    ' 4r5e ',\n    ' 5h1t ',\n    ' 5hit ',\n    ' a55 ',\n    ' anal ',\n    ' anus ',\n    ' ar5e ',\n    ' arrse ',\n    ' arse ',\n    ' ass ',\n    ' ass-fucker ',\n    ' asses ',\n    ' assfucker ',\n    ' assfukka ',\n    ' asshole ',\n    ' assholes ',\n    ' asswhole ',\n    ' a_s_s ',\n    ' b!tch ',\n    ' b00bs ',\n    ' b17ch ',\n    ' b1tch ',\n    ' ballbag ',\n    ' balls ',\n    ' ballsack ',\n    ' bastard ',\n    ' beastial ',\n    ' beastiality ',\n    ' bellend ',\n    ' bestial ',\n    ' bestiality ',\n    ' biatch ',\n    ' bitch ',\n    ' bitcher ',\n    ' bitchers ',\n    ' bitches ',\n    ' bitchin ',\n    ' bitching ',\n    ' bloody ',\n    ' blow job ',\n    ' blowjob ',\n    ' blowjobs ',\n    ' boiolas ',\n    ' bollock ',\n    ' bollok ',\n    ' boner ',\n    ' boob ',\n    ' boobs ',\n    ' booobs ',\n    ' boooobs ',\n    ' booooobs ',\n    ' booooooobs ',\n    ' breasts ',\n    ' buceta ',\n    ' bugger ',\n    ' bum ',\n    ' bunny fucker ',\n    ' butt ',\n    ' butthole ',\n    ' buttmuch ',\n    ' buttplug ',\n    ' c0ck ',\n    ' c0cksucker ',\n    ' carpet muncher ',\n    ' cawk ',\n    ' chink ',\n    ' cipa ',\n    ' cl1t ',\n    ' clit ',\n    ' clitoris ',\n    ' clits ',\n    ' cnut ',\n    ' cock ',\n    ' cock-sucker ',\n    ' cockface ',\n    ' cockhead ',\n    ' cockmunch ',\n    ' cockmuncher ',\n    ' cocks ',\n    ' cocksuck ',\n    ' cocksucked ',\n    ' cocksucker ',\n    ' cocksucking ',\n    ' cocksucks ',\n    ' cocksuka ',\n    ' cocksukka ',\n    ' cok ',\n    ' cokmuncher ',\n    ' coksucka ',\n    ' coon ',\n    ' cox ',\n    ' crap ',\n    ' cum ',\n    ' cummer ',\n    ' cumming ',\n    ' cums ',\n    ' cumshot ',\n    ' cunilingus ',\n    ' cunillingus ',\n    ' cunnilingus ',\n    ' cunt ',\n    ' cuntlick ',\n    ' cuntlicker ',\n    ' cuntlicking ',\n    ' cunts ',\n    ' cyalis ',\n    ' cyberfuc ',\n    ' cyberfuck ',\n    ' cyberfucked ',\n    ' cyberfucker ',\n    ' cyberfuckers ',\n    ' cyberfucking ',\n    ' d1ck ',\n    ' damn ',\n    ' dick ',\n    ' dickhead ',\n    ' dildo ',\n    ' dildos ',\n    ' dink ',\n    ' dinks ',\n    ' dirsa ',\n    ' dlck ',\n    ' dog-fucker ',\n    ' doggin ',\n    ' dogging ',\n    ' donkeyribber ',\n    ' doosh ',\n    ' duche ',\n    ' dyke ',\n    ' ejaculate ',\n    ' ejaculated ',\n    ' ejaculates ',\n    ' ejaculating ',\n    ' ejaculatings ',\n    ' ejaculation ',\n    ' ejakulate ',\n    ' f u c k ',\n    ' f u c k e r ',\n    ' f4nny ',\n    ' fag ',\n    ' fagging ',\n    ' faggitt ',\n    ' faggot ',\n    ' faggs ',\n    ' fagot ',\n    ' fagots ',\n    ' fags ',\n    ' fanny ',\n    ' fannyflaps ',\n    ' fannyfucker ',\n    ' fanyy ',\n    ' fatass ',\n    ' fcuk ',\n    ' fcuker ',\n    ' fcuking ',\n    ' feck ',\n    ' fecker ',\n    ' felching ',\n    ' fellate ',\n    ' fellatio ',\n    ' fingerfuck ',\n    ' fingerfucked ',\n    ' fingerfucker ',\n    ' fingerfuckers ',\n    ' fingerfucking ',\n    ' fingerfucks ',\n    ' fistfuck ',\n    ' fistfucked ',\n    ' fistfucker ',\n    ' fistfuckers ',\n    ' fistfucking ',\n    ' fistfuckings ',\n    ' fistfucks ',\n    ' flange ',\n    ' fook ',\n    ' fooker ',\n    ' fuck ',\n    ' fucka ',\n    ' fucked ',\n    ' fucker ',\n    ' fuckers ',\n    ' fuckhead ',\n    ' fuckheads ',\n    ' fuckin ',\n    ' fucking ',\n    ' fuckings ',\n    ' fuckingshitmotherfucker ',\n    ' fuckme ',\n    ' fucks ',\n    ' fuckwhit ',\n    ' fuckwit ',\n    ' fudge packer ',\n    ' fudgepacker ',\n    ' fuk ',\n    ' fuker ',\n    ' fukker ',\n    ' fukkin ',\n    ' fuks ',\n    ' fukwhit ',\n    ' fukwit ',\n    ' fux ',\n    ' fux0r ',\n    ' f_u_c_k ',\n    ' gangbang ',\n    ' gangbanged ',\n    ' gangbangs ',\n    ' gaylord ',\n    ' gaysex ',\n    ' goatse ',\n    ' God ',\n    ' god-dam ',\n    ' god-damned ',\n    ' goddamn ',\n    ' goddamned ',\n    ' hardcoresex ',\n    ' hell ',\n    ' heshe ',\n    ' hoar ',\n    ' hoare ',\n    ' hoer ',\n    ' homo ',\n    ' hore ',\n    ' horniest ',\n    ' horny ',\n    ' hotsex ',\n    ' jack-off ',\n    ' jackoff ',\n    ' jap ',\n    ' jerk-off ',\n    ' jism ',\n    ' jiz ',\n    ' jizm ',\n    ' jizz ',\n    ' kawk ',\n    ' knob ',\n    ' knobead ',\n    ' knobed ',\n    ' knobend ',\n    ' knobhead ',\n    ' knobjocky ',\n    ' knobjokey ',\n    ' kock ',\n    ' kondum ',\n    ' kondums ',\n    ' kum ',\n    ' kummer ',\n    ' kumming ',\n    ' kums ',\n    ' kunilingus ',\n    ' l3itch ',\n    ' labia ',\n    ' lmfao ',\n    ' lust ',\n    ' lusting ',\n    ' m0f0 ',\n    ' m0fo ',\n    ' m45terbate ',\n    ' ma5terb8 ',\n    ' ma5terbate ',\n    ' masochist ',\n    ' master-bate ',\n    ' masterb8 ',\n    ' masterbat3 ',\n    ' masterbate ',\n    ' masterbation ',\n    ' masterbations ',\n    ' masturbate ',\n    ' mo-fo ',\n    ' mof0 ',\n    ' mofo ',\n    ' mothafuck ',\n    ' mothafucka ',\n    ' mothafuckas ',\n    ' mothafuckaz ',\n    ' mothafucked ',\n    ' mothafucker ',\n    ' mothafuckers ',\n    ' mothafuckin ',\n    ' mothafucking ',\n    ' mothafuckings ',\n    ' mothafucks ',\n    ' mother fucker ',\n    ' motherfuck ',\n    ' motherfucked ',\n    ' motherfucker ',\n    ' motherfuckers ',\n    ' motherfuckin ',\n    ' motherfucking ',\n    ' motherfuckings ',\n    ' motherfuckka ',\n    ' motherfucks ',\n    ' muff ',\n    ' mutha ',\n    ' muthafecker ',\n    ' muthafuckker ',\n    ' muther ',\n    ' mutherfucker ',\n    ' n1gga ',\n    ' n1gger ',\n    ' nazi ',\n    ' nigg3r ',\n    ' nigg4h ',\n    ' nigga ',\n    ' niggah ',\n    ' niggas ',\n    ' niggaz ',\n    ' nigger ',\n    ' niggers ',\n    ' nob ',\n    ' nob jokey ',\n    ' nobhead ',\n    ' nobjocky ',\n    ' nobjokey ',\n    ' numbnuts ',\n    ' nutsack ',\n    ' orgasim ',\n    ' orgasims ',\n    ' orgasm ',\n    ' orgasms ',\n    ' p0rn ',\n    ' pawn ',\n    ' pecker ',\n    ' penis ',\n    ' penisfucker ',\n    ' phonesex ',\n    ' phuck ',\n    ' phuk ',\n    ' phuked ',\n    ' phuking ',\n    ' phukked ',\n    ' phukking ',\n    ' phuks ',\n    ' phuq ',\n    ' pigfucker ',\n    ' pimpis ',\n    ' piss ',\n    ' pissed ',\n    ' pisser ',\n    ' pissers ',\n    ' pisses ',\n    ' pissflaps ',\n    ' pissin ',\n    ' pissing ',\n    ' pissoff ',\n    ' poop ',\n    ' porn ',\n    ' porno ',\n    ' pornography ',\n    ' pornos ',\n    ' prick ',\n    ' pricks ',\n    ' pron ',\n    ' pube ',\n    ' pusse ',\n    ' pussi ',\n    ' pussies ',\n    ' pussy ',\n    ' pussys ',\n    ' rectum ',\n    ' retard ',\n    ' rimjaw ',\n    ' rimming ',\n    ' s hit ',\n    ' s.o.b. ',\n    ' sadist ',\n    ' schlong ',\n    ' screwing ',\n    ' scroat ',\n    ' scrote ',\n    ' scrotum ',\n    ' semen ',\n    ' sex ',\n    ' sh!t ',\n    ' sh1t ',\n    ' shag ',\n    ' shagger ',\n    ' shaggin ',\n    ' shagging ',\n    ' shemale ',\n    ' shit ',\n    ' shitdick ',\n    ' shite ',\n    ' shited ',\n    ' shitey ',\n    ' shitfuck ',\n    ' shitfull ',\n    ' shithead ',\n    ' shiting ',\n    ' shitings ',\n    ' shits ',\n    ' shitted ',\n    ' shitter ',\n    ' shitters ',\n    ' shitting ',\n    ' shittings ',\n    ' shitty ',\n    ' skank ',\n    ' slut ',\n    ' sluts ',\n    ' smegma ',\n    ' smut ',\n    ' snatch ',\n    ' son-of-a-bitch ',\n    ' spac ',\n    ' spunk ',\n    ' s_h_i_t ',\n    ' t1tt1e5 ',\n    ' t1tties ',\n    ' teets ',\n    ' teez ',\n    ' testical ',\n    ' testicle ',\n    ' tit ',\n    ' titfuck ',\n    ' tits ',\n    ' titt ',\n    ' tittie5 ',\n    ' tittiefucker ',\n    ' titties ',\n    ' tittyfuck ',\n    ' tittywank ',\n    ' titwank ',\n    ' tosser ',\n    ' turd ',\n    ' tw4t ',\n    ' twat ',\n    ' twathead ',\n    ' twatty ',\n    ' twunt ',\n    ' twunter ',\n    ' v14gra ',\n    ' v1gra ',\n    ' vagina ',\n    ' viagra ',\n    ' vulva ',\n    ' w00se ',\n    ' wang ',\n    ' wank ',\n    ' wanker ',\n    ' wanky ',\n    ' whoar ',\n    ' whore ',\n    ' willies ',\n    ' willy ',\n    ' xrated ',\n    ' xxx '    \n]","f59d4382":"replace_with_fuck = []\n\nfor swear in swear_words:\n    if swear[1:(len(swear)-1)] not in embeddings_index:\n        replace_with_fuck.append(swear)\n        \nreplace_with_fuck = '|'.join(replace_with_fuck)\nreplace_with_fuck\n        ","8097a087":"def handle_swears(text):\n    text = re.sub(replace_with_fuck, ' fuck ', text)\n    return text","e68a8aa3":"df['comment_text'] = df['comment_text'].apply(lambda x: handle_swears(x))\ngc.collect()","6b66779f":"train = df.iloc[:1804874,:]\ntest = df.iloc[1804874:,:]\n\ntrain.head()","3d882fdc":"del(df)\ngc.collect()","b3f9c714":"train.head()","9ed04a24":"train_orig = pd.read_csv(\"..\/input\/jigsaw-unintended-bias-in-toxicity-classification\/train.csv\")\ntrain_orig.head()","30e69809":"train = pd.concat([train,train_orig[['target']]],axis=1)\ntrain.head()","023f4d9b":"del(train_orig)\ngc.collect()","52963fea":"train['target'] = np.where(train['target'] >= 0.5, True, False)","601244cd":"train_df, validate_df = model_selection.train_test_split(train, test_size=0.1)\nprint('%d train comments, %d validate comments' % (len(train_df), len(validate_df)))","7576a4b0":"MAX_NUM_WORDS = 100000\nTOXICITY_COLUMN = 'target'\nTEXT_COLUMN = 'comment_text'\n\n# Create a text tokenizer.\ntokenizer = Tokenizer(num_words=MAX_NUM_WORDS)\ntokenizer.fit_on_texts(train_df[TEXT_COLUMN])\n\n# All comments must be truncated or padded to be the same length.\nMAX_SEQUENCE_LENGTH = 256\ndef pad_text(texts, tokenizer):\n    return pad_sequences(tokenizer.texts_to_sequences(texts), maxlen=MAX_SEQUENCE_LENGTH)","e66f2ecb":"gc.collect()","ac17cfd8":"EMBEDDINGS_DIMENSION = 300\nembedding_matrix = np.zeros((len(tokenizer.word_index) + 1,EMBEDDINGS_DIMENSION))","717f0dab":"num_words_in_embedding = 0\n\nfor word, i in tokenizer.word_index.items():\n    if word in embeddings_index.vocab:\n        embedding_vector = embeddings_index[word]\n        embedding_matrix[i] = embedding_vector        \n        num_words_in_embedding += 1","353e15cc":"train_text = pad_text(train_df[TEXT_COLUMN], tokenizer)\ntrain_labels = train_df[TOXICITY_COLUMN]\nvalidate_text = pad_text(validate_df[TEXT_COLUMN], tokenizer)\nvalidate_labels = validate_df[TOXICITY_COLUMN]","3a7d5654":"gc.collect()","0d00a88d":"from keras import backend as K\nfrom keras.engine.topology import Layer\nfrom keras import initializers, regularizers, constraints, optimizers, layers\n\ndef dot_product(x, kernel):\n    \"\"\"\n    Wrapper for dot product operation, in order to be compatible with both\n    Theano and Tensorflow\n    Args:\n        x (): input\n        kernel (): weights\n    Returns:\n    \"\"\"\n    if K.backend() == 'tensorflow':\n        return K.squeeze(K.dot(x, K.expand_dims(kernel)), axis=-1)\n    else:\n        return K.dot(x, kernel)\n    \nclass AttentionWithContext(Layer):\n    \"\"\"\n    Attention operation, with a context\/query vector, for temporal data.\n    Supports Masking.\n    Follows the work of Yang et al. [https:\/\/www.cs.cmu.edu\/~diyiy\/docs\/naacl16.pdf]\n    \"Hierarchical Attention Networks for Document Classification\"\n    by using a context vector to assist the attention\n    # Input shape\n        3D tensor with shape: `(samples, steps, features)`.\n    # Output shape\n        2D tensor with shape: `(samples, features)`.\n    How to use:\n    Just put it on top of an RNN Layer (GRU\/LSTM\/SimpleRNN) with return_sequences=True.\n    The dimensions are inferred based on the output shape of the RNN.\n    Note: The layer has been tested with Keras 2.0.6\n    Example:\n        model.add(LSTM(64, return_sequences=True))\n        model.add(AttentionWithContext())\n        # next add a Dense layer (for classification\/regression) or whatever...\n    \"\"\"\n\n    def __init__(self,\n                 W_regularizer=None, u_regularizer=None, b_regularizer=None,\n                 W_constraint=None, u_constraint=None, b_constraint=None,\n                 bias=True, **kwargs):\n\n        self.supports_masking = True\n        self.init = initializers.get('glorot_uniform')\n\n        self.W_regularizer = regularizers.get(W_regularizer)\n        self.u_regularizer = regularizers.get(u_regularizer)\n        self.b_regularizer = regularizers.get(b_regularizer)\n\n        self.W_constraint = constraints.get(W_constraint)\n        self.u_constraint = constraints.get(u_constraint)\n        self.b_constraint = constraints.get(b_constraint)\n\n        self.bias = bias\n        super(AttentionWithContext, self).__init__(**kwargs)\n\n    def build(self, input_shape):\n        assert len(input_shape) == 3\n\n        self.W = self.add_weight((input_shape[-1], input_shape[-1],),\n                                 initializer=self.init,\n                                 name='{}_W'.format(self.name),\n                                 regularizer=self.W_regularizer,\n                                 constraint=self.W_constraint)\n        if self.bias:\n            self.b = self.add_weight((input_shape[-1],),\n                                     initializer='zero',\n                                     name='{}_b'.format(self.name),\n                                     regularizer=self.b_regularizer,\n                                     constraint=self.b_constraint)\n\n        self.u = self.add_weight((input_shape[-1],),\n                                 initializer=self.init,\n                                 name='{}_u'.format(self.name),\n                                 regularizer=self.u_regularizer,\n                                 constraint=self.u_constraint)\n\n        super(AttentionWithContext, self).build(input_shape)\n\n    def compute_mask(self, input, input_mask=None):\n        # do not pass the mask to the next layers\n        return None\n\n    def call(self, x, mask=None):\n        uit = dot_product(x, self.W)\n\n        if self.bias:\n            uit += self.b\n\n        uit = K.tanh(uit)\n        ait = dot_product(uit, self.u)\n\n        a = K.exp(ait)\n\n        # apply mask after the exp. will be re-normalized next\n        if mask is not None:\n            # Cast the mask to floatX to avoid float64 upcasting in theano\n            a *= K.cast(mask, K.floatx())\n\n        # in some cases especially in the early stages of training the sum may be almost zero\n        # and this results in NaN's. A workaround is to add a very small positive number \u03b5 to the sum.\n        # a \/= K.cast(K.sum(a, axis=1, keepdims=True), K.floatx())\n        a \/= K.cast(K.sum(a, axis=1, keepdims=True) + K.epsilon(), K.floatx())\n\n        a = K.expand_dims(a)\n        weighted_input = x * a\n        return K.sum(weighted_input, axis=1)\n\n    def compute_output_shape(self, input_shape):\n        return input_shape[0], input_shape[-1]","fe631425":"sequence_input = Input(shape=(MAX_SEQUENCE_LENGTH,), dtype='int32')\nembedding_layer = Embedding(len(tokenizer.word_index) + 1,\n                            EMBEDDINGS_DIMENSION,\n                            weights=[embedding_matrix],\n                            input_length=MAX_SEQUENCE_LENGTH,\n                            trainable=False)\nx = embedding_layer(sequence_input)\nx = SpatialDropout1D(0.2)(x)\nx = Bidirectional(CuDNNLSTM(128, return_sequences=True))(x)\natt = AttentionWithContext()(x)\n\navg_pool1 = GlobalAveragePooling1D()(x)\nmax_pool1 = GlobalMaxPooling1D()(x)     \n\nx = concatenate([att, avg_pool1, max_pool1])\nx = Dense(256, activation='sigmoid')(x)\nx = Dense(128, activation='sigmoid')(x)\nx = Dense(64, activation='sigmoid')(x)\npreds = Dense(1, activation='sigmoid')(x)\n\n\nmodel = Model(sequence_input, preds)\nmodel.summary()\n","641fd95e":"model.compile(loss='binary_crossentropy',\n              optimizer=Adam(),\n              metrics=['acc'])","e08204fb":"BATCH_SIZE = 1024\nNUM_EPOCHS = 40","7dd0dc40":"model.fit(\n    train_text,\n    train_labels,\n    batch_size=BATCH_SIZE,\n    epochs=NUM_EPOCHS,\n    validation_data=(validate_text, validate_labels),\n    callbacks = [EarlyStopping(monitor='val_loss', mode='min', verbose=1, patience=3)])\n","d09f143d":"submission = pd.read_csv('..\/input\/jigsaw-unintended-bias-in-toxicity-classification\/sample_submission.csv', index_col='id')\nsubmission['prediction'] = model.predict(pad_text(test[TEXT_COLUMN], tokenizer))\nsubmission.reset_index(drop=False, inplace=True)\nsubmission.head()","1b414599":"\nsubmission.to_csv('submission.csv', index=False)","d75bc7f3":"# Import Data\n\nLet's have a little look at the data.","ba15625d":"Convert target to binary flag","9c1bcaf0":"# Model Architecture\n","a4cb783e":"Create our embedding matrix","d3b8c091":"# Predict & Submit","867f95d1":"Split into train\/validation sets","d0fbf91f":"The extra features in the training set must be for analysing the bias. This is going to be an interesting competition with such a metric!","51408e5b":"Looks like punctuation is the next issue here, so let's sort it out.","ffc95f17":"# Import Libraries","144b8ad7":"## Swears\n\nLet's replace any swear words we don't have an embedding for with something we do ;)","367aaf80":"Let's split the data back into train and test","4adeade3":"# Further Preparation","5e901996":"# Embeddings\n\nTo start we'll just take the FastText Common Crawl embeddings. Later, we'll hopefully combine multiple embeddings.","99069bd6":"# Model Training","baf22336":"# Preprocessing Text\n\nAs with most NLP tasks, we will start by using some pre-trained embeddings for our words. This provides us with a numerical representation of our input that we can use for modelling. Mapping words to embeddings isn't always straight forward, however: the data may not be very tidy.\n\nThe first step, then, is to ensure we get as many words mapped to a suitable embedding as possible. To do this, we'll make use of two excellent kernels:\n\n- https:\/\/www.kaggle.com\/christofhenkel\/how-to-preprocessing-when-using-embeddings \n- https:\/\/www.kaggle.com\/theoviel\/improve-your-score-with-text-preprocessing-v2 ","0017f97e":"We will lower() all words, then look up those that do not appear in lower case in the embeddings but do in upper case, and add them.","ee93db1c":"# References\n\nFirst of all, thanks to @taindow for his wonderful kernel https:\/\/www.kaggle.com\/taindow\/simple-cudnngru-python-keras ,\nwhich I used as base.\nIt's a pity that we have only 2h runtime on GPU so i didn't used folds.\n\nI modified NN structure: implemented AttentionWithContext layer, which makes Attention operation with a context\/query vector for temporal data. Also, now there are Bi_LSTM at the start and 4 x Dence layers in the end.\n\nSo now it looks like this:\n\n\n(InputLayer)            (None, 256)                                                   \n__________________________________________________________________________________________________\n(Embedding)         (None, 256, 300)                   \n__________________________________________________________________________________________________\n(SpatialDropout1D) (None, 256, 300)                             \n__________________________________________________________________________________________________\n(Bidirectional LSTM) (None, 256, 256)            \n__________________________________________________________________________________________________\n(AttentionWithContext) (None, 256)                         \n__________________________________________________________________________________________________\n(GlobalAveragePooling1D) (None, 256)                          \n__________________________________________________________________________________________________\n(GlobalMaxPooling1D) (None, 256)                           \n__________________________________________________________________________________________________\n(Concatenate Poolings and Attention)     (None, 768)          \n__________________________________________________________________________________________________\n(Dense)                 (None, 256)                        \n__________________________________________________________________________________________________\n(Dense)                 (None, 128)                                 \n__________________________________________________________________________________________________\n(Dense)                 (None, 64)                                     \n__________________________________________________________________________________________________\n(Dense)                 (None, 1)                  \n\n\n\n### Preprocessing\n\n- https:\/\/www.kaggle.com\/christofhenkel\/how-to-preprocessing-when-using-embeddings \n- https:\/\/www.kaggle.com\/theoviel\/improve-your-score-with-text-preprocessing-v2 \n\n### Model Architecture\n\n-- https:\/\/www.kaggle.com\/tunguz\/bi-gru-cnn-poolings-gpu-kernel-version\n\n### Other\n\n- https:\/\/www.kaggle.com\/dborkan\/benchmark-kernel \n- https:\/\/www.kaggle.com\/c\/jigsaw-unintended-bias-in-toxicity-classification\/discussion\/87245","32536393":"Immediately we see contractions are an issue for FastText (such as \"was not\" -> \"wasn't\"). Let's try and fix this.","4313fdff":"There is a lot of words here that just aren't going to have any embeddings. We could go further and try to correct mispellings, but that is likely a small improvement we can worry about when we're trying to improve the model further.","82e2803c":"Tokenize the text"}}