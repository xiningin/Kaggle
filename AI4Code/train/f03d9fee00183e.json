{"cell_type":{"f8482255":"code","6838735d":"code","b1f255ee":"code","196050cb":"code","156b7c64":"code","ffbedd20":"code","48b1d2e7":"code","aff8589e":"code","5c69dd52":"markdown","6d372680":"markdown"},"source":{"f8482255":"import covid19_tools as cv19\nimport pandas as pd\nimport re\nfrom IPython.core.display import display, HTML\nimport html\n\nMETADATA_FILE = '..\/input\/CORD-19-research-challenge\/metadata.csv'\n\n# Load metadata\nmeta = cv19.load_metadata(METADATA_FILE)\n# Add tags\nmeta, covid19_counts = cv19.add_tag_covid19(meta)\nmeta, riskfac_counts = cv19.add_tag_risk(meta)\n\npd.set_option('display.max_columns', 500)\npd.set_option('display.max_rows', 500)","6838735d":"print('Loading full text for tag_disease_covid19 x risk factor terminology')\nfull_text_risk = cv19.load_full_text(meta[meta.tag_disease_covid19 &\n                                          meta.tag_risk_factors],\n                                     '..\/input\/CORD-19-research-challenge')","b1f255ee":"# Manual list for highlighting\n# Need to look at automated \/ updateable approach to identifying these\nrisk_factors = [\n    'diabetes',\n    'hypertension',\n    'smoking',\n    'cardiovascular disease',\n    'chronic obstructive pulmonary disease',\n    'cerebrovascular disease',\n    'kidney disease',\n    ' age ',\n    ' aged',\n    'blood type',\n    'hepatitis',\n    ' male ',\n    ' female ',\n    ' males ',\n    ' females ',\n    'arrhythmia',\n    ' sex ',\n    ' gender ',\n    'acute respiratory distress syndrome',\n    'sepsis shock',\n    'cardiac injury',\n    'acute kidney injury',\n    'liver dysfunction',\n    'gastrointestinal haemorrhage',\n    'conjunctivitis',\n    'comorbidity',\n    'comorbidities',\n    'co-morbidity',\n    'co-morbidities',\n    ' smoker',\n    'non-smoker'\n]","196050cb":"case_sen_risk_re = [\n    r'\\bOR\\b',\n    r'\\bCI\\b',\n    r'\\bHR\\b' # This is picking up Heart Rate in some papers\n]\ncase_ins_risk_re = [\n    'odds ratio',\n    'risk ratio',\n    'confidence interval',\n    'hazard ratio',\n    'relative risk',\n    'p =',\n    'p=',\n    'p<',\n    'p <',\n    'adjusting for',\n    'adjusted for',\n    'controlling for',\n    'controlled for',\n    'incidence of'\n]\ncase_sen_risk_re = '|'.join(case_sen_risk_re)\ncase_ins_risk_re = '(?i)' + '|'.join(case_ins_risk_re)","156b7c64":"def highlight_numbers(s):\n    match_sequence = re.findall(r'\\d+\\.\\d+', s)\n    for ms in list(set(match_sequence)):\n        s = re.sub(ms, f'<span style=\"background-color:#ddf;\">{ms}<\/span>', s)\n    return s","ffbedd20":"display_output = []\ncsv_data = []\nfor i, item in enumerate(full_text_risk):\n    temp_output = {}\n    \n    doi = meta[meta.sha == item['paper_id']].doi.values[0]\n    temp_output['doi'] = doi\n    doi = html.escape(doi)\n    \n    try:\n        authors = item['metadata']['authors'][0]['last']\n        if len(item['metadata']['authors']) > 1:\n            authors += ' et al'\n    except:\n        authors = 'No author listed'\n    temp_output['authors'] = authors\n    authors = html.escape(authors)\n    \n    title = item['metadata']['title']\n    temp_output['title'] = title\n    title = html.escape(title)\n    \n    publish_time = meta[meta.sha == item['paper_id']].publish_time.values[0]\n    temp_output['publish_time'] = publish_time\n    publish_time = html.escape(publish_time)\n\n    display(HTML(f'Result {i+1}<br><b><i><a href=\"{doi}\">{title}<\/a><\/i>, {authors}<\/b><br>{publish_time}'))\n    output_list = []\n    csv_output_list = []\n    for bt in item['body_text']:\n        sentence_list = bt['text'].split(r'. ')\n        for s in sentence_list:\n            if (len(re.findall(case_sen_risk_re, s)) > 0 or\n                len(re.findall(case_ins_risk_re, s)) > 0):\n                csv_string = s\n                html_string = html.escape(s)\n                for rf in risk_factors:\n                    html_string = re.sub(rf, f'<mark>{rf}<\/mark>', html_string)\n                html_string = highlight_numbers(html_string)\n                output_list.append(html_string)\n                csv_output_list.append(csv_string)\n    if len(output_list) > 0:\n        display(HTML('<ul><li>' + '<\/li><li>'.join(output_list) + '<\/li><\/ul><br><br>'))\n        temp_output['key_passages'] = '\\n'.join(csv_output_list)\n    csv_data.append(temp_output)","48b1d2e7":"risk_factors_df = pd.DataFrame(csv_data)\nrisk_factors_df.head()","aff8589e":"risk_factors_df.to_csv('risk_factors.csv', index=False)","5c69dd52":"# Risk factors summarised\n\nBelow are the key quantitative results extracted from research into Covid-19 risk and prognostic factors:","6d372680":"# COVID-19 Risk factors, prognostic factors\n\nAim is to find risk factor analysis, prognostic factor analysis with quantitative findings (odds ratio, hazard ratio, risk ratio)."}}