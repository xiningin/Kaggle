{"cell_type":{"6513c2bf":"code","569aaad0":"code","3bb4d214":"code","843f12dc":"code","4caca820":"code","0236939e":"code","46d935d5":"code","55d614e4":"code","d660b80d":"code","8b8d05fe":"code","83c24456":"code","011daf8d":"code","165cca56":"code","cbadd289":"code","fab0e3d7":"code","c5de0889":"code","996e4390":"code","e92c682b":"code","f9bbd689":"code","8d319d48":"code","e2d1749d":"code","c8470372":"code","09185617":"code","4e883422":"code","073c2413":"code","55e22bdd":"code","7a4ddd2a":"code","77af3c3c":"code","271b5815":"code","30df37d6":"code","5fbaed3b":"code","c20b9b55":"code","20a5823a":"code","91dc0927":"code","44c32b7d":"code","4474b977":"markdown","2f5a413a":"markdown","fdb6a140":"markdown","83b0a446":"markdown","5824ad3e":"markdown","5812bb9c":"markdown","778f6fe3":"markdown","b6c2be11":"markdown","d71d7a4a":"markdown","25bace6f":"markdown","46a60330":"markdown","d83ce9e8":"markdown","c89d66c3":"markdown","fc82a571":"markdown","e8f5755b":"markdown","1b5ab088":"markdown"},"source":{"6513c2bf":"from decimal import Decimal, ROUND_HALF_UP, ROUND_HALF_EVEN\nimport folium\nimport math\nimport matplotlib.pyplot as plt\nimport numpy as np\nimport os\nimport pandas as pd\nimport rasterio as rio\nimport seaborn as sns\nfrom sklearn.cluster import KMeans\nimport tifffile as tiff ","569aaad0":"def overlay_image_on_puerto_rico_df(df, img, zoom):\n    lat_map=df.iloc[[0]].loc[:,[\"latitude\"]].iat[0,0]\n    lon_map=df.iloc[[0]].loc[:,[\"longitude\"]].iat[0,0]\n    m = folium.Map([lat_map, lon_map], zoom_start=zoom)\n    color={ 'Hydro' : 'lightblue', 'Solar' : 'orange', 'Oil' : 'darkblue', 'Coal' : 'black', 'Gas' : 'lightgray', 'Wind' : 'green' }\n    folium.raster_layers.ImageOverlay(\n        image=img,\n        bounds = [[18.56,-67.32,],[17.90,-65.194]],\n        colormap=lambda x: (1, 0, 0, x),\n    ).add_to(m)\n    \n    for i in range(0,len(df)):\n        popup = folium.Popup(str(df.primary_fuel[i:i+1]))\n        folium.Marker([df[\"latitude\"].iloc[i],df[\"longitude\"].iloc[i]],\n                     icon=folium.Icon(icon_color='red',icon ='bolt',prefix='fa',color=color[df.primary_fuel.iloc[i]])).add_to(m)\n        \n    return m","3bb4d214":"def split_column_into_new_columns(dataframe,column_to_split,new_column_one,begin_column_one,end_column_one):\n    for i in range(0, len(dataframe)):\n        dataframe.loc[i, new_column_one] = dataframe.loc[i, column_to_split][begin_column_one:end_column_one]\n    return dataframe","843f12dc":"power_plants = pd.read_csv('\/kaggle\/input\/ds4g-environmental-insights-explorer\/eie_data\/gppd\/gppd_120_pr.csv')\npower_plants = split_column_into_new_columns(power_plants,'.geo','latitude',50,66)\npower_plants = split_column_into_new_columns(power_plants,'.geo','longitude',31,48)\npower_plants['latitude'] = power_plants['latitude'].astype(float)\na = np.array(power_plants['latitude'].values.tolist()) # 18 instead of 8\npower_plants['latitude'] = np.where(a < 10, a+10, a).tolist() \npower_plants_df = power_plants.sort_values('capacity_mw',ascending=False).reset_index()","4caca820":"power_plants_df.head()","0236939e":"#From https:\/\/www.kaggle.com\/ajulian\/capacity-factor-in-power-plants\n\ntotal_capacity_mw = power_plants_df['capacity_mw'].sum()\nprint('Total Installed Capacity: '+'{:.2f}'.format(total_capacity_mw) + ' MW')\ncapacity = (power_plants_df.groupby(['primary_fuel'])['capacity_mw'].sum()).to_frame()\ncapacity = capacity.sort_values('capacity_mw',ascending=False)\ncapacity['percentage_of_total'] = (capacity['capacity_mw']\/total_capacity_mw)*100\ncapacity.sort_values(by='percentage_of_total', ascending=True)['percentage_of_total'].plot(kind='bar',color=['lightblue', 'green', 'orange', 'black','lightgray','darkblue'])\n","46d935d5":"image = tiff.imread('\/kaggle\/input\/ds4g-environmental-insights-explorer\/eie_data\/s5p_no2\/s5p_no2_20180701T161259_20180707T175356.tif')\noverlay_image_on_puerto_rico_df(power_plants_df,image[:,:,0],8)\n\n#https:\/\/www.kaggle.com\/paultimothymooney\/explore-image-metadata-s5p-gfs-gldas\n#band1: NO2_column_number_density","55d614e4":"lon = []\nlat = []\nNO2 = []\n\nfor i in range(image[:,:,0].shape[0]):\n    for j in range(image[:,:,0].shape[1]):\n        #print(image[:,:,0][i,j])\n        NO2.append(image[:,:,0][i,j])\n        lon.append(i)\n        lat.append(j)\n        \nNO2 = np.array(NO2)\nlon = np.array(lon)\nlat = np.array(lat)","d660b80d":"results = pd.DataFrame(columns=['NO2', 'lat', 'lon'])\nresults = pd.DataFrame({'NO2': NO2\/max(NO2),\n                    'lat': lat\/max(lat),\n                    'lon': lon\/max(lon)})","8b8d05fe":"sns.distplot(results[\"NO2\"])","83c24456":"pred = KMeans(n_clusters=11).fit_predict(results)","011daf8d":"plt.figure()\nsns.heatmap(pred.reshape((148, 475)))","165cca56":"overlay_image_on_puerto_rico_df(power_plants_df, pred.reshape((148, 475)), 8)","cbadd289":"monotonous = KMeans(n_clusters=3).fit_predict(image[:,:,0].reshape(-1, 1))\n#pred = KMeans(n_clusters=2).fit_predict(results[\"NO2\"])\nplt.figure()\nsns.heatmap(monotonous.reshape((148, 475)))","fab0e3d7":"#Note that the color intensity and the high NO2 concentration do not always match.\noverlay_image_on_puerto_rico_df(power_plants_df, monotonous.reshape((148, 475)), 8)","c5de0889":"import os \nimport glob","996e4390":"gldas_files = glob.glob('\/kaggle\/input\/ds4g-environmental-insights-explorer\/eie_data\/gldas\/*')\ngldas_files = sorted(gldas_files)\ngfs_files = glob.glob('\/kaggle\/input\/ds4g-environmental-insights-explorer\/eie_data\/gfs\/*')\ngfs_files = sorted(gfs_files)","e92c682b":"gldas_files_par_day = []\nfor i in range(0,len(gldas_files[6:54]),8):\n    #print(gldas_files[i:i+8])\n    gldas_files_par_day.append(gldas_files[i:i+8])","f9bbd689":"gfs_files_par_day = []\nfor i in range(0,len(gfs_files[3:27]),4):\n    #print(gfs_files[i:i+4])\n    gfs_files_par_day.append(gfs_files[i:i+4])","8d319d48":"image_reglession_u = []\nimage_reglession_v = []\nimage_reglession_speed = []\n\nfor i in range(len(gfs_files_par_day)):\n    gfs_tmp = gfs_files_par_day[i]\n    gldas_tmp = gldas_files_par_day[i]\n    array_wind_u = []\n    array_wind_v = []\n    array_wind_speed = []\n    for j in range(len(gfs_tmp)):\n        gfs_image_u = tiff.imread(gfs_tmp[j])[:,:,3]\n        gfs_image_v = tiff.imread(gfs_tmp[j])[:,:,4]\n        gldas_image1 = tiff.imread(gldas_tmp[2*j])[:,:,11]\n        gldas_image2 = tiff.imread(gldas_tmp[2*j + 1])[:,:,11]\n\n        #fill na by mean\n        gfs_image_u = np.nan_to_num(gfs_image_u, nan=np.nanmean(gfs_image_u))\n        gfs_image_v = np.nan_to_num(gfs_image_v, nan=np.nanmean(gfs_image_v))\n        gldas_image1 = np.nan_to_num(gldas_image1, nan=np.nanmean(gldas_image1))\n        gldas_image2 = np.nan_to_num(gldas_image2, nan=np.nanmean(gldas_image2))\n        \n        \n        gldas_image = (gldas_image1 + gldas_image2)\/2\n        \n        array_wind_u.append(gfs_image_u)\n        array_wind_v.append(gfs_image_v)\n        array_wind_speed.append(gldas_image)\n        \n        image_reglession_u.append(np.nanmean(np.array(array_wind_u), axis=0))\n        image_reglession_v.append(np.nanmean(np.array(array_wind_v), axis=0))\n        image_reglession_speed.append(np.nanmean(np.array(array_wind_speed), axis=0))\n       \nimage_reglession_u = np.nanmean(np.array(image_reglession_u), axis=0)\nimage_reglession_v = np.nanmean(np.array(image_reglession_v), axis=0)\nimage_reglession_speed = np.nanmean(np.array(image_reglession_speed), axis=0)","e2d1749d":"sns.heatmap(image_reglession_u.reshape((148, 475)))","c8470372":"sns.heatmap(image_reglession_v.reshape((148, 475)))","09185617":"sns.heatmap(image_reglession_speed.reshape((148, 475)))","4e883422":"image = tiff.imread('\/kaggle\/input\/ds4g-environmental-insights-explorer\/eie_data\/s5p_no2\/s5p_no2_20180701T161259_20180707T175356.tif')\nlon = []\nlat = []\nNO2 = []\nwind_u = []\nwind_v = []\nwind_speed = []\n\nfor i in range(image[:,:,0].shape[0]):\n    for j in range(image[:,:,0].shape[1]):\n        #print(image[:,:,0][i,j])\n        NO2.append(image[:,:,0][i,j])\n        lon.append(i)\n        lat.append(j)\n        wind_u.append(image_reglession_u.reshape((148, 475))[i,j])\n        wind_v.append(image_reglession_v.reshape((148, 475))[i,j])\n        wind_speed.append(image_reglession_speed.reshape((148, 475))[i,j])\n        \nNO2 = np.array(NO2)\nlon = np.array(lon)\nlat = np.array(lat)\nwind_u = np.array(wind_u)\nwind_v = np.array(wind_v)\nwind_spped = np.array(wind_speed)\n        \nresults_wind = pd.DataFrame(columns=['NO2', 'lat', 'lon', 'wind_u', 'wind_v', 'wind_speed'])\nresults_wind = pd.DataFrame({\n                    'NO2': NO2\/max(NO2),\n                    'lat': lat\/max(lat),\n                    'lon': lon\/max(lon),\n                    'wind_u' : wind_u\/(- min(wind_u)),\n                    'wind_v' : wind_v\/(- min(wind_v)),\n                    'wind_speed': wind_speed\/max(wind_speed)})","073c2413":"pred_wind1 = KMeans(n_clusters=11).fit_predict(results_wind)\nplt.figure()\nsns.heatmap(pred_wind1.reshape((148, 475)))","55e22bdd":"overlay_image_on_puerto_rico_df(power_plants_df, pred_wind1.reshape((148, 475)), 8)","7a4ddd2a":"image_reglession_u = []\nimage_reglession_v = []\n\nfor i in range(len(gfs_files_par_day)):\n    gfs_tmp = gfs_files_par_day[i]\n    gldas_tmp = gldas_files_par_day[i]\n    array_wind_u = []\n    array_wind_v = []\n    for j in range(len(gfs_tmp)):\n        gfs_image_u = tiff.imread(gfs_tmp[j])[:,:,3]\n        gfs_image_v = tiff.imread(gfs_tmp[j])[:,:,4]\n        gldas_image1 = tiff.imread(gldas_tmp[2*j])[:,:,11]\n        gldas_image2 = tiff.imread(gldas_tmp[2*j + 1])[:,:,11]\n\n        #fill na by mean\n        gfs_image_u = np.nan_to_num(gfs_image_u, nan=np.nanmean(gfs_image_u))\n        gfs_image_v = np.nan_to_num(gfs_image_v, nan=np.nanmean(gfs_image_v))\n        gldas_image1 = np.nan_to_num(gldas_image1, nan=np.nanmean(gldas_image1))\n        gldas_image2 = np.nan_to_num(gldas_image2, nan=np.nanmean(gldas_image2))\n        \n        \n        gldas_image = (gldas_image1 + gldas_image2)\/2\n        wind_u = gfs_image_u * gldas_image\n        wind_v = gfs_image_v * gldas_image\n        \n        array_wind_u.append(wind_u)\n        array_wind_v.append(wind_v)\n        \n        image_reglession_u.append(np.nanmean(np.array(array_wind_u), axis=0))\n        image_reglession_v.append(np.nanmean(np.array(array_wind_v), axis=0))\n       \nimage_reglession_u = np.nanmean(np.array(image_reglession_u), axis=0)\nimage_reglession_v = np.nanmean(np.array(image_reglession_v), axis=0)","77af3c3c":"sns.heatmap(image_reglession_u.reshape((148, 475)))","271b5815":"sns.heatmap(image_reglession_v.reshape((148, 475)))","30df37d6":"image = tiff.imread('\/kaggle\/input\/ds4g-environmental-insights-explorer\/eie_data\/s5p_no2\/s5p_no2_20180701T161259_20180707T175356.tif')\nlon = []\nlat = []\nNO2 = []\nwind_u = []\nwind_v = []\n\nfor i in range(image[:,:,0].shape[0]):\n    for j in range(image[:,:,0].shape[1]):\n        #print(image[:,:,0][i,j])\n        NO2.append(image[:,:,0][i,j])\n        lon.append(i)\n        lat.append(j)\n        wind_u.append(image_reglession_u.reshape((148, 475))[i,j])\n        wind_v.append(image_reglession_v.reshape((148, 475))[i,j])\n        \nNO2 = np.array(NO2)\nlon = np.array(lon)\nlat = np.array(lat)\nwind_u = np.array(wind_u)\nwind_v = np.array(wind_v)\n        \nresults_wind = pd.DataFrame(columns=['NO2', 'lat', 'lon', 'wind_u', 'wind_v'])\nresults_wind = pd.DataFrame({\n                    'NO2': NO2\/max(NO2),\n                    'lat': lat\/max(lat),\n                    'lon': lon\/max(lon),\n                    'wind_u' : wind_u\/(- min(wind_u)),\n                    'wind_v' : wind_v\/(- min(wind_v))})\n\n","5fbaed3b":"pred_wind2 = KMeans(n_clusters=11).fit_predict(results_wind)\nplt.figure()\nsns.heatmap(pred_wind2.reshape((148, 475)))","c20b9b55":"overlay_image_on_puerto_rico_df(power_plants_df, pred_wind2.reshape((148, 475)), 8)","20a5823a":"plt.figure()\nsns.heatmap(pred.reshape((148, 475)))","91dc0927":"plt.figure()\nsns.heatmap(pred_wind1.reshape((148, 475)))","44c32b7d":"plt.figure()\nsns.heatmap(pred_wind2.reshape((148, 475)))","4474b977":"### <u>Way1<\/u>","2f5a413a":"## Consideration\n\nConsidering the area made, there are some characteristics like below:\n\n\u30fbThe devided areas seems be stronglly  constrained by coordinates. \n\n\u30fb We have to decide the number of cluster manually.\n\nIt is nice that model more reasonablly devide while data into area if we give the data and coodinates of power plants.\n\nIf we input terrain and weather data to k-means, I think we may get more apposite attribute.","fdb6a140":"### Can we devide only by NO2 density?\n\nIn the first place, NO2 gas is distributes as we image? For example, if NO2 gas is distributed in a circle or a band from the power plant, it seems good to simply cluster at the density of NO2. But if not so, we have to use other data they seems efffect NO2 gas distribution.\n\nFitst, simply we can use k-means to convert no2 density to more monotonous classes. ","83b0a446":"# Devide NO2 map by k-means\n\nI try to generate devided areas by longitude, latitude and average NO2 density in a week.","5824ad3e":"Especially, Coal, Gas and Oil power plants emit NO2 gas. So it may be nice idea that whole data divide into some areas. \n\nIdeally I want to devide whole data into areas as many as power plants in Puerto Rico, but it is difficult. One of the difficulty is that there are some power plants very near each other. \n\n\nIn small divided areas, it would be acceptable to divide the emissions by the amount of electricity generated.","5812bb9c":"### future engineering\n\nI tried flooowing 2 way.\n\nWe can use following three wind propaties: wind_u, wind_v and wind speed. They are given smaller time scale than NO2 gas.\n\n1. just calculate average of wind_u, wind_v and wind speed.\n\n2. make feature using wind_u, wind_v and wind speed. These are calculated by multipling wind speed to wind_u and wind_v.","778f6fe3":"Let's retrieve the data from 7\/1 to 7\/7. And I put data together each day.","b6c2be11":"### Conparison","d71d7a4a":"## Including Wind Data\n\nI tried to make wind feature, and make cluster by k-means.\n\nNO2 gases flowed by wind, and accumulate place where no wind.","25bace6f":"## Snippts","46a60330":"### <u>Way2<\/u>","d83ce9e8":"## Data overview","c89d66c3":"**Power plants and NO2_column_number_density of 20180701-20180707 in Puerto Rico**","fc82a571":"\nAs you can see from this figure, simply clustering seems to be difficult because the NO2 gas concentration is not distribute in a circle or a band from the power plant.\u3000\ud83d\ude05","e8f5755b":"# Classification including wind data.","1b5ab088":"## <u>About this kernel<\/u>\n\nTo calculate marginal emissions factor, I want to attribute emissions to each power plants.\n\n\u203bFor marginal emissions factor, refer https:\/\/www.tmrow.com\/blog\/marginal-emissions-what-they-are-and-when-to-use-them\n\n\nFor calculate reasonable emissions of each power plants, I try to apply k-means to satellite data as one of the typical clustering methods.\n\nIf we devide into small area, we can detect its area(m^2) and gas emission by following fomula:\n\n## Emissions(mol) = NO2_column_number_density(mol\/m^2) * area(m^2)\n\nWhen we get mol of emited gas, we can calculate its weight (such as gram).\n"}}