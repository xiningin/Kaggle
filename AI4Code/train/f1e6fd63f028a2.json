{"cell_type":{"640a8917":"code","9a7439b1":"code","323db3a9":"code","e14b3f3a":"code","66c73678":"code","970f4faf":"code","1042fdd4":"code","e500a20b":"code","8fd8a0a3":"code","e5fe4df3":"code","e66100f7":"code","b0bcfdb7":"code","e726d63d":"code","1f196310":"code","16120ed2":"code","a39a911e":"code","f8db7b56":"code","83a2d7e5":"code","c969cbdc":"code","b8b99275":"code","bf49b04b":"markdown","660bd8df":"markdown","5ffe7687":"markdown","2f6e63db":"markdown"},"source":{"640a8917":"!pip install pydeck","9a7439b1":"from kaggle_secrets import UserSecretsClient\nimport os\nuser_secrets = UserSecretsClient()\nos.environ['MAPBOX_API_KEY']=user_secrets.get_secret(\"mapbox\")","323db3a9":"import pydeck as pdk\nimport pandas as pd\nimport numpy as np\nimport matplotlib.pyplot as plt\nfrom IPython.display import FileLink","e14b3f3a":"covid_df = pd.read_csv('..\/input\/corona-virus-report\/complete_data_new_format.csv')\ncovid_df['Date'] = pd.to_datetime(covid_df['Date'])\ncovid_df = covid_df.sort_values('Date', ascending=False)\ncovid_df['Country_State'] = covid_df.apply(lambda c_row: c_row['Country\/Region']+\n                                         (' {Province\/State}'.format(**c_row) if isinstance(c_row['Province\/State'], str) else ''), \n                                         axis=1)\ncovid_df.head(3)","66c73678":"# show a few days of data\nlat_mean = 48.2323\nlong_mean = -1.415\nview_state = pdk.ViewState(\n    longitude=long_mean,\n    latitude=lat_mean,\n    zoom=3,\n    min_zoom=3,\n    max_zoom=15,\n    pitch=40.5,\n    bearing=-27.36)\nlayer_list = []\nfor i in reversed(range(4)):\n    c_frame_df = covid_df.\\\n        groupby(['Country_State']).\\\n        apply(lambda x: x.sort_values('Date', ascending=False).head(i+1).tail(1)).\\\n        reset_index(drop=True)\n    c_frame_df['Radius'] = c_frame_df['Confirmed'].map(lambda x: 2*np.clip(x, 0, 100000))\n    c_color = [int(255*x) for x in plt.cm.magma((4-i)\/4.0)]\n    c_color[3] = 100\n    layer_list += [pdk.Layer('ScatterplotLayer',\n        c_frame_df,\n        get_position=['Long', 'Lat'],\n        auto_highlight=True,\n        get_radius='Radius',          # Radius is given in meters\n        get_fill_color=c_color,  # Set an RGBA value for fill\n        pickable=True)]\nr = pdk.Deck(layers=layer_list, initial_view_state=view_state)\nr.to_html('covid_history.html')\nFileLink('covid_history.html')","970f4faf":"covid_open_df = pd.read_csv('..\/input\/novel-corona-virus-2019-dataset\/COVID19_open_line_list.csv')\ncovid_open_df['date_confirmation'] = pd.to_datetime(covid_open_df['date_confirmation'], errors='ignore')\ncovid_open_df.sample(5).T","1042fdd4":"view_state = pdk.ViewState(\n    longitude=8,\n    latitude=45.2323,\n    zoom=4,\n    min_zoom=2,\n    max_zoom=15,\n    pitch=40.5,\n    bearing=-27.36)\nhex_layer = pdk.Layer(\n    'HexagonLayer',\n    covid_open_df,\n    get_position=['longitude', 'latitude'],\n    auto_highlight=True,\n    elevation_scale=500,\n    pickable=True,\n    elevation_range=[0, 3000],\n    radius=50000,\n    extruded=True,                 \n    coverage=.5)\nr = pdk.Deck(layers=[hex_layer], initial_view_state=view_state)\nr.to_html('covid_hex.html')","e500a20b":"covid_open_df[covid_open_df['country']=='United Kingdom'].T","8fd8a0a3":"lat_mean = 45.2323\nlong_mean = 9\nview_state = pdk.ViewState(\n    longitude=long_mean,\n    latitude=lat_mean,\n    zoom=6,\n    min_zoom=2,\n    max_zoom=15,\n    pitch=40.5,\n    bearing=-27.36)\n\nconfirmed_layer = pdk.Layer('ScatterplotLayer',     # Change the `type` positional argument here\n    covid_open_df[['longitude', 'latitude', 'additional_information', 'country', 'province', 'city', 'sex', 'age']],\n    get_position=['longitude', 'latitude'],\n    auto_highlight=True,\n    get_radius=10000,          # Radius is given in meters\n    get_fill_color=[180, 0, 200, 140],  # Set an RGBA value for fill\n    pickable=True)\nr = pdk.Deck(layers=[confirmed_layer], initial_view_state=view_state)\nr.to_html('covid_scatter.html')","e5fe4df3":"from IPython.display import FileLink\nFileLink('covid_scatter.html')","e66100f7":"new_df = pd.read_csv('https:\/\/raw.githubusercontent.com\/CSSEGISandData\/COVID-19\/master\/csse_covid_19_data\/csse_covid_19_daily_reports\/03-28-2020.csv')\nnew_df.sample(3)","b0bcfdb7":"count_var = 'Confirmed'\nde_agg = new_df[['Lat', 'Long_', count_var]].\\\n    groupby(['Lat', 'Long_']).\\\n    apply(lambda x: x.sample(x[count_var].sum(), replace=True)).\\\n    reset_index(drop=True)\nde_agg.shape","e726d63d":"view_state = pdk.ViewState(\n    longitude=8,\n    latitude=45.2323,\n    zoom=4,\n    min_zoom=2,\n    max_zoom=15,\n    pitch=40.5,\n    bearing=-27.36)\nhex_layer = pdk.Layer(\n    'HexagonLayer',\n    de_agg[['Lat', 'Long_']],\n    get_position=['Long_', 'Lat'],\n    auto_highlight=True,\n    elevation_scale=100,\n    pickable=True,\n    elevation_range=[0, 3000],\n    radius=10000,\n    extruded=True,                 \n    coverage=.5)\nr = pdk.Deck(layers=[hex_layer], initial_view_state=view_state)\nr.to_html('covid_better_hex.html')\nFileLink('covid_better_hex.html')","1f196310":"grid_view_df = new_df[['Lat', 'Long_']].copy()\ngrid_view_df['value'] = np.sqrt(new_df['Confirmed'])\ngrid_view_df['Color'] = new_df['Confirmed'].map(lambda x: [int(255*c) for c in  plt.cm.magma(x\/10000)])\nview_state = pdk.ViewState(\n    longitude=8,\n    latitude=45.2323,\n    zoom=4,\n    min_zoom=0,\n    max_zoom=15,\n    pitch=40.5,\n    bearing=-0)\ngrid_layer = pdk.Layer(\n    'GridCellLayer',\n    grid_view_df,\n    get_position=['Long_', 'Lat'],\n    get_elevation='value',\n    get_color='Color',\n    auto_highlight=True,\n    elevationScale=2000,\n    pickable=True,\n    extruded=True,\n    material=True,\n    cellSize=20000,\n    coverage=.5)\nr = pdk.Deck(layers=[grid_layer], initial_view_state=view_state)\nr.to_html('covid_gridcell.html')\nFileLink('covid_gridcell.html')","16120ed2":"grid_view_df = new_df[['Lat', 'Long_']].copy()\ngrid_view_df['value'] = np.sqrt(new_df['Confirmed'])\ngrid_view_df['Color'] = new_df['Confirmed'].map(lambda x: [int(255*c) for c in  plt.cm.Wistia(x\/5000)])\nview_state = pdk.ViewState(\n    longitude=-115,\n    latitude=40,\n    zoom=4,\n    min_zoom=0,\n    max_zoom=15,\n    pitch=80,\n    bearing=90)\ngrid_layer = pdk.Layer(\n    'GridCellLayer',\n    grid_view_df,\n    get_position=['Long_', 'Lat'],\n    get_elevation='value',\n    get_color='Color',\n    auto_highlight=True,\n    elevationScale=6000,\n    pickable=True,\n    extruded=True,\n    material=True,\n    cellSize=50000,\n    coverage=.5)\nr = pdk.Deck(layers=[grid_layer], initial_view_state=view_state)\nr.to_html('usa_gridcell.html')\nFileLink('usa_gridcell.html')","a39a911e":"def get_day_df(month, day):\n    date_str = f'{month:02d}-{day:02d}-2020'\n    try:\n        return pd.read_csv(f'https:\/\/raw.githubusercontent.com\/CSSEGISandData\/COVID-19\/master\/csse_covid_19_data\/csse_covid_19_daily_reports\/{date_str}.csv').assign(month=month, day=day, date=date_str)\n    except: \n        return None","f8db7b56":"all_days_list = [get_day_df(month=month, day=day) for month in range(1, 4) for day in range(1, 32)]\nall_days_df = pd.concat([x for x in all_days_list if x is not None], sort=False)\nall_days_df.sample(3)","83a2d7e5":"all_days_df['date'] = pd.to_datetime(all_days_df['date'])\nall_days_df['Last_Update'] = pd.to_datetime(all_days_df['Last_Update'])\nall_days_df = all_days_df.sort_values('date')","c969cbdc":"grid_view_df = all_days_df[['Lat', 'Long_', 'Latitude', 'Longitude', 'date', 'month', 'day']].copy()\ngrid_view_df['value'] = np.sqrt(all_days_df['Confirmed'])\ngrid_view_df['Color'] = all_days_df['Confirmed'].map(lambda x: [int(255*c) for c in  plt.cm.YlOrRd(x\/5000)])\nview_state = pdk.ViewState(\n    longitude=-100,\n    latitude=40,\n    zoom=3,\n    min_zoom=0,\n    max_zoom=15,\n    pitch=45,\n    bearing=0)\n\ngrid_layer = pdk.Layer(\n        'GridCellLayer',\n        data=None,\n        get_position=pos_cols,\n        get_elevation='value',\n        get_color='Color',\n        auto_highlight=True,\n        elevationScale=6000,\n        pickable=True,\n        extruded=True,\n        material=True,\n        cellSize=50000)\n\nr = pdk.Deck(layers=[grid_layer], initial_view_state=view_state)","b8b99275":"import time\nimport ipywidgets\nfrom IPython.display import clear_output\ndisplay_date = ipywidgets.HTML('Date')\ndisplay(display_date)\nr.show()\n# Show the current visualization\n\nfor c_date, c_rows in grid_view_df.query('month==3').groupby(['date']):\n    display_date.value = f'<h1>{c_date}<\/h1>'\n    out_rows = c_rows.copy().reset_index(drop=True).dropna(axis=1, how='all')\n    if 'Lat' in out_rows:\n        pos_cols = ['Long_', 'Lat']\n    else:\n        pos_cols = ['Longitude', 'Latitude']\n    grid_layer.data = out_rows\n    \n    r.update()\n    time.sleep(2)","bf49b04b":"# More Granular Data\nHere we use the open_line_list data and see how that works","660bd8df":"# Time-series Cases","5ffe7687":"# Overview\nSome fun visualizations using deck.gl to show corona cases","2f6e63db":"# Corona Virus Report Data\n"}}