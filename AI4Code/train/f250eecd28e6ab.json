{"cell_type":{"becebbbb":"code","a0338ed1":"code","af643607":"code","da588205":"code","62520e95":"code","efd46225":"code","7b5d5568":"code","c8e8dd56":"code","f4d05993":"code","eead057d":"code","2102bfa9":"code","b3d0c591":"code","6b1fdd98":"code","751a6e74":"code","59cb1e58":"code","8b9d1768":"code","b2fe77f0":"code","fcb37a44":"code","1aa5cb89":"code","7bd068dc":"code","bbf2d028":"code","202309f0":"code","c50693f2":"code","68793400":"code","4f2f58c7":"code","43a4377f":"code","d527b6e3":"markdown","2a1c1112":"markdown","2f025b26":"markdown","18fb72a1":"markdown","4f758643":"markdown","ba912a09":"markdown","254f5301":"markdown","82e7f048":"markdown","1ff2e421":"markdown","37982848":"markdown","02e33c1a":"markdown","0d9830f6":"markdown","5e9e1b3d":"markdown","533224a4":"markdown","a88f5e9b":"markdown","16f9a94b":"markdown","4117b44b":"markdown","09e43247":"markdown","790e169e":"markdown","bb3ceea5":"markdown"},"source":{"becebbbb":"import numpy as np \nimport pandas as pd\nimport tensorflow as tf\nimport os\nimport matplotlib.pyplot as plt\nimport seaborn as sns\nimport pydicom as pyd\nfrom tqdm import tqdm\nfrom sklearn.model_selection import train_test_split\nimport albumentations as A\nimport cv2\nfrom tensorflow.keras.applications import EfficientNetB0\nfrom tensorflow.keras.models import Sequential\nfrom tensorflow.keras.utils import Sequence\nfrom tensorflow.keras import layers","a0338ed1":"images_path = '..\/input\/rsna-pneumonia-detection-challenge\/stage_2_train_images'\ntrain_labels_df = pd.read_csv('..\/input\/rsna-pneumonia-detection-challenge\/stage_2_train_labels.csv')\nlabel_meta_data = pd.read_csv('..\/input\/rsna-pneumonia-detection-challenge\/stage_2_detailed_class_info.csv')","af643607":"train_labels_df.head(10)","da588205":"label_meta_data.head(10)","62520e95":"print('Size of Dataset 1: ',train_labels_df.shape)\nprint('Size of Dataset 2: ',label_meta_data.shape)\nprint('Number of Unique X-Rays in Dataset 1 : ',train_labels_df['patientId'].nunique())\nprint('Number of Unique X-Rays in Dataset 2 : ',label_meta_data['patientId'].nunique())\n","efd46225":"train_labels_df.drop_duplicates(inplace=True)\nlabel_meta_data.drop_duplicates(inplace=True)\nprint('Size of Dataset 1: ',train_labels_df.shape)\nprint('Size of Dataset 2: ',label_meta_data.shape)\nprint('Number of Unique X-Rays in Dataset 1 : ',train_labels_df['patientId'].nunique())\nprint('Number of Unique X-Rays in Dataset 2 : ',label_meta_data['patientId'].nunique())","7b5d5568":"patient_info_df = pd.DataFrame(columns=['age','sex','patientId'])\nfor ix,id_ in tqdm(enumerate(label_meta_data['patientId'])):\n    age=pyd.read_file(os.path.join(images_path,\n                                   id_+'.dcm')).PatientAge\n    sex=pyd.read_file(os.path.join(images_path,\n                 base_feat              id_+'.dcm')).PatientSex\n\n    patient_info_df.loc[ix,'age']=age\n    patient_info_df.loc[ix,'sex']=sex\n    patient_info_df.loc[ix,'patientId'] = id_","c8e8dd56":"# Merging this patient information with the exiting meta data\npatient_info_df = pd.merge(label_meta_data,patient_info_df,on=\"patientId\")\npatient_info_df","f4d05993":"merged_data_info = pd.merge(train_labels_df,patient_info_df,on=\"patientId\")\nmerged_data_info.tail(10)","eead057d":"print(merged_data_info.shape)\nprint(merged_data_info.isna().sum())","2102bfa9":"print('Minimum Age in the dataset:', merged_data_info['age'].min())\nprint('Maximum Age in the dataset', merged_data_info['age'].max())\n\nmerged_data_info.columns = merged_data_info.columns.str.strip()\nmerged_data_info['sex']=merged_data_info['sex'].replace({ 'M' : 0, 'F' : 1  })\nmerged_data_info['label']=merged_data_info['class']\nmerged_data_info['label']=merged_data_info['label'].replace({ 'Normal' : 0, 'Lung Opacity' : 1, 'No Lung Opacity \/ Not Normal' : 2 })\n","b3d0c591":"merged_data_info['age'] = merged_data_info['age'].astype('int64')","6b1fdd98":"merged_data_info.info()","751a6e74":"label_count=label_meta_data['class'].value_counts()\nexplode = (0.01,0.01,0.01)  \n\nfig1, ax1 = plt.subplots(figsize=(5,5))\nax1.pie(label_count.values, explode=explode, labels=label_count.index, autopct='%1.1f%%',\n        shadow=True, startangle=90)\nax1.axis('equal') \nplt.title('Class Distribution')\nplt.show()","59cb1e58":"# lets take a look at our Target Distribution\nlabel_count=merged_data_info['Target'].value_counts()\nexplode = (0.1,0.0)  \n\nfig1, ax1 = plt.subplots(figsize=(5,5))\nax1.pie(label_count.values, explode=explode, labels=['Normal','Pneumonia'], autopct='%1.1f%%',\n        shadow=True, startangle=90)\nax1.axis('equal') \nplt.title('Target Distribution')\nplt.show()","8b9d1768":"r=c=3\nfig= plt.figure(figsize=(15,14))\nfor i in range(1,r*c+1):\n    id_= np.random.choice(merged_data_info['patientId'].values)\n    label_0= np.unique(merged_data_info['Target'][merged_data_info['patientId']==id_])\n    label_1= np.unique(merged_data_info['class'][merged_data_info['patientId']==id_])\n    \n    #read xray\n    img=pyd.read_file(os.path.join(images_path,id_+'.dcm')).pixel_array\n    fig.add_subplot(r,c,i)\n    plt.imshow(img,cmap='gray')\n    if label_0==1:\n        plt.title('Pneumonia Infected'+' | '+label_1)\n    else:\n        plt.title('Normal Xray'+' | '+label_1)\n    plt.xticks([])\n    plt.yticks([])","b2fe77f0":"id_= np.random.choice(merged_data_info[merged_data_info['Target'] == 1]['patientId'].values)\nclass_=merged_data_info['class'][merged_data_info['patientId']==id_]\n\nplt.figure(figsize=(15,10))\ncurrent_axis = plt.gca()\nimg=pyd.read_file(os.path.join(images_path,id_+'.dcm')).pixel_array\nplt.imshow(img,cmap='bone')\n\n\ncurrent_axis = plt.gca()\nboxes=train_labels_df[['x','y','width','height']][merged_data_info['patientId']==id_].values\n\nfor box in boxes:\n    x=box[0]\n    y=box[1]\n    w=box[2]\n    h=box[3]\n    current_axis.add_patch(plt.Rectangle((x, y), w, h, \n                                         color='red', fill=False, linewidth=3))  \n    ","fcb37a44":"sns.countplot(x=merged_data_info['Target'], hue=merged_data_info['sex'])","1aa5cb89":"X = merged_data_info['patientId'].values\ny = tf.keras.utils.to_categorical(merged_data_info['label'].values,num_classes=3)\nX_train, X_val, y_train, y_val = train_test_split(X,y,test_size=0.2)\nprint('Samples in Training Data: ', len(X_train))\nprint('Samples in Validation Data: ', len(X_val))","7bd068dc":"BATCH_SIZE = 32\nHEIGHT = 224\nWIDTH = 224\ndims=(HEIGHT,WIDTH,1)","bbf2d028":"class KustomGenerator(Sequence):\n    def __init__(self,input_data,batch_size=BATCH_SIZE,dims=(HEIGHT,WIDTH,1),is_train=True):\n        self.input_ids=input_data[0]\n        self.input_targets=input_data[1]\n        self.batch_size=batch_size\n        self.dims=dims\n        self.is_train=is_train\n        self.on_epoch_end()\n    \n    def on_epoch_end(self):\n        self.indexes=np.arange(len(self.input_ids))\n        if self.is_train:\n            np.random.shuffle(self.indexes)\n    \n    \n    def __len__(self):\n        return int(len(self.input_ids)\/self.batch_size)\n    \n    def __getitem__(self,index):\n        \n        indexes=self.indexes[index*self.batch_size:(index+1)*self.batch_size]\n        X_ids = [self.input_ids[i] for i in indexes]\n        Y_=[self.input_targets[i] for i in indexes]\n        \n        X=self.__data_generation(X_ids)\n        return X,np.array(Y_)\n\n    def __data_generation(self,input_x):\n        tmp_imgs=np.zeros((self.batch_size,*self.dims))\n        \n        for ix,rows in enumerate(input_x):\n            #Read Image\n            img=pyd.read_file(os.path.join(images_path,input_x[ix]+'.dcm')).pixel_array\n            img_shape=img.shape\n            img=cv2.resize(img,(self.dims[0],self.dims[1]))\n            img=np.expand_dims(img,2)\n            \n            \n            #augmentation\n            #if self.is_train:\n            #    img=self.__augmentation(img)\n                       \n            tmp_imgs[ix]=img.astype('float')\/255.\n            \n        return tmp_imgs\n    \n    def __augmentation(self,image):\n        transform = A.Compose([\n            A.HorizontalFlip(p=0.5),\n            A.VerticalFlip(p=0.5),\n            A.Transpose(p=0.5),])\n        t=transform(image=image)\n        return t['image']","202309f0":"#Get Generator Object\ntrain_gen=KustomGenerator([X_train,y_train])\nval_gen=KustomGenerator([X_val,y_val],is_train=False)","c50693f2":"'''\ninputs = layers.Input(shape=(HEIGHT, WIDTH, 1))\ninp=Input(2)\nx_=Dense(512,activation='relu')(inp)\n\n\nx=layers.Conv2D(3,(5,5),1,padding='same')(inputs)\nx=layers.LayerNormalization()(x)\nx=layers.Activation('relu')(x)\n\nbase_feat = EfficientNetB0(include_top=False, weights='imagenet')\nfor layer in base_feat.layers:\n    layer.trainable=True\n\nbase_feat=base_feat(x)    \nbase_feat=layers.GlobalAveragePooling2D()(base_feat)\noutputs=layers.Dense(3,activation='sigmoid')(x)\n\nmodel = tf.keras.Model(inputs, outputs)\n\nmodel.compile(optimizer=\"adam\", loss=\"binary_crossentropy\", metrics=[\"acc\"])\nmodel.summary()\n'''","68793400":"inputs = layers.Input(shape=(HEIGHT, WIDTH, 1))\nx=layers.Conv2D(3,(5,5),1,padding='same')(inputs)\nx=layers.LayerNormalization()(x)\nx=layers.Activation('relu')(x)\n\nbase_feat = EfficientNetB0(include_top=False, weights='imagenet')(x)\nbase_feat=layers.GlobalAveragePooling2D()(base_feat)\nx=layers.Dense(1024,activation='relu')(base_feat)\noutputs=layers.Dense(3,activation='sigmoid')(x)\n\nmodel = tf.keras.Model(inputs, outputs)\n\nmodel.compile(optimizer=\"adam\", loss=\"binary_crossentropy\", metrics=[\"acc\"])\nmodel.summary()","4f2f58c7":"#Callbacks\n","43a4377f":"EPOCH=10\nmodel.fit(train_gen,steps_per_epoch=train_gen.__len__(),\n          epochs=EPOCH,validation_data=val_gen,\n          validation_steps=val_gen.__len__())","d527b6e3":"> Extracting the age and gender of the patient for all the IDs specified in the detailed info CSV into a separate data frame","2a1c1112":"> This shows that there are no duplicates in the bounding box dataset","2f025b26":"> Merging both the files into a single dataset to make sure that there are no inconsistent patient IDs across both the datasets","18fb72a1":"# Importing the required libraries","4f758643":"> We need to atleast double the positive datasets artificially to make it a balanced data set","ba912a09":"> The stage_2_detailed_class_info CSV contains the following information\n* patientId : For uniquely identifying the patient whose X-ray scan is in the image dataset\n* class : detailed class info wherein there are three categories in picture\n\n1.     Normal : No pneumonia (Target = 0)\n2.     Lung Opacity : Pneumonia (Target = 1)\n3.     No Lung Opacity\/ Not Normal : Inflammation not leading to Pneumonia ( Target = 0)\n","254f5301":"# Reading the input files","82e7f048":"> Its seems the representation of males is slightly greater than females by almost ~2000 datapoints for both positive as well as negative cases","1ff2e421":"> Other than the class description column and the patient ID colummn all the others are of numerical datatype","37982848":"> ","02e33c1a":"> The dataset is available as part of the RSNA Pneumonia Detection Competition in Kaggle itself. The data has been added to this workspace and we are storing the path of the images as well as converting the CSV's into a Pandas Dataframe","0d9830f6":"> The Age can be considered as an continuous input. After removing the white spaces at the beginning and end of string columns, we encode the categorical columns into integers with the following code. The label will be the new classification output column\n* Male : 0\n* Female : 1\n\n* Normal : 0\n* Lung Opacity : 1\n* No Lung Opacity \/ Not Normal : 2","5e9e1b3d":"> Only 22% of the patients have Lung opacity, which shows that the dataset is very much imbalanced. This is based on the unique patientIDs. Out of these patient X-ray scans each image may have one or more bounding boxes.","533224a4":"# Visualization of the Images","a88f5e9b":"> Both datasets have same number of rows - 30,227 but out of which there are only 26,684 unique patient IDs -> which means some patient scans may have more than one bounding box.","16f9a94b":"> The shape of the merged one is the same as the original bounding box dataset and there are no other null values in the other output columns","4117b44b":"> These random set of 9 images show various combinations of Target class and the detailed category","09e43247":"# Target Distribution","790e169e":"> The stage_2_train_labels CSV contains the following information \n* patientId : For uniquely identifying the patient whose X-ray scan is in the image dataset\n* Coordinates of the bounding boxes : The x_min, y_min, width and height of the rectangular boudning boxes that detect inflammation leading to the diagnosis of pneumonia\n* Taeget Class : the categorical output which tells if the patient has pneumonia or not.\n\nNote that if the target is 0, then then the coordinate columns carry NAN values","bb3ceea5":"# Visualization of the areas of inflammation"}}