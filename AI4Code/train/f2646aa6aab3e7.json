{"cell_type":{"199b3d18":"code","7ae32e4f":"code","4eb1004b":"code","70f9838d":"code","11bafb59":"code","a0667b12":"code","9388586a":"code","8f176878":"code","fffba02a":"code","d77500a9":"code","6e63123a":"code","2f31937f":"code","e549b697":"code","670de13f":"code","f4b3ee1d":"code","eff32439":"markdown","c7d0254f":"markdown","833899f3":"markdown","00d6bac9":"markdown","968316aa":"markdown","bf3c7d03":"markdown","028d017e":"markdown","e7d123e6":"markdown","627de964":"markdown"},"source":{"199b3d18":"import pymc3 as pm\nimport numpy as np\nimport matplotlib.pyplot as plt\nplt.style.use('seaborn-darkgrid')\nimport pandas as pd\ndisaster_data = pd.Series([4, 5, 4, 0, 1, 4, 3, 4, 0, 6, 3, 3, 4, 0, 2, 6,\n                           3, 3, 5, 4, 5, 3, 1, 4, 4, 1, 5, 5, 3, 4, 2, 5,\n                           2, 2, 3, 4, 2, 1, 3, np.nan, 2, 1, 1, 1, 1, 3, 0, 0,\n                           1, 0, 1, 1, 0, 0, 3, 1, 0, 3, 2, 2, 0, 1, 1, 1,\n                           0, 1, 0, 1, 0, 0, 0, 2, 1, 0, 0, 0, 1, 1, 0, 2,\n                           3, 3, 1, np.nan, 2, 1, 1, 1, 1, 2, 4, 2, 0, 0, 1, 4,\n                           0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 1])\nyears = np.arange(1851, 1962)\n\ndefense_data = pd.Series([202,311,311,297,195,221,91,161,362,236,291,316,177,115,56,384])\ndefense_data_rush = pd.Series([52,99,167,86,139,245,100,188,57,217,76,86,47,140,145,70])\nweek = np.array([1,2,3,4,5,6,7,8,9,10,12,13,14,15,16,17])","7ae32e4f":"plt.plot(years, disaster_data, 'o', markersize=6);\nplt.ylabel(\"Disaster count\")\nplt.xlabel(\"Year\");","4eb1004b":"with pm.Model() as disaster_model:\n\n    switchpoint = pm.DiscreteUniform('switchpoint', lower=years.min(), upper=years.max(), testval=1900)\n\n    # Priors for pre- and post-switch rates number of disasters\n    early_rate = pm.Exponential('early_rate', 1)\n    late_rate = pm.Exponential('late_rate', 1)\n\n    # Allocate appropriate Poisson rates to years before and after current\n    rate = pm.math.switch(switchpoint >= years, early_rate, late_rate)\n\n    disasters = pm.Poisson('disasters', rate, observed=disaster_data)","70f9838d":"with disaster_model:\n    trace = pm.sample(10000)","11bafb59":"pm.traceplot(trace);","a0667b12":"pm.summary(trace).round(2)","9388586a":"plt.figure(figsize=(10, 8))\nplt.plot(years, disaster_data, '.')\nplt.ylabel(\"Number of accidents\", fontsize=16)\nplt.xlabel(\"Year\", fontsize=16)\n\nplt.vlines(trace['switchpoint'].mean(), disaster_data.min(), disaster_data.max(), color='C1')\naverage_disasters = np.zeros_like(disaster_data, dtype='float')\nfor i, year in enumerate(years):\n    idx = year < trace['switchpoint']\n    average_disasters[i] = (trace['early_rate'][idx].sum() + trace['late_rate'][~idx].sum()) \/ (len(trace) * trace.nchains)\n\nsp_hpd = pm.hpd(trace['switchpoint'])\nplt.fill_betweenx(y=[disaster_data.min(), disaster_data.max()],\n                  x1=sp_hpd[0], x2=sp_hpd[1], alpha=0.5, color='C1');\nplt.plot(years, average_disasters,  'k--', lw=2);","8f176878":"import seaborn as sns\nplt.figure(figsize=(9,7))\nsns.jointplot(trace['early_rate'], trace['late_rate'], kind=\"hex\", color=\"#4CB391\")\nplt.xlabel(\"early_rate\")\nplt.ylabel(\"late_rate\");\nplt.show()","fffba02a":"import pymc3 as pm\nimport numpy as np\nimport matplotlib.pyplot as plt\nplt.style.use('seaborn-darkgrid')\nimport pandas as pd\n\ndefense_data_scoring = pd.Series([27,31,35,30,16,17,18,24,44,30,27,34,26,48,38,56])\ndefense_data = pd.Series([100*52\/105.2, 100*99\/105.5, 100*167\/126.1, 100*86\/119, \n                          100*139\/168.1, 100*245\/112.4, 100*100\/105.2, 100*188\/146.6,\n                          100*57\/123.3, 100*217\/139.8, 100*76\/115, 100*86\/118.1, 100*47\/84.4, 100*140\/119, 100*145\/146.6, 100*70\/105.5])\ndefense_data_pass = pd.Series([202,311,311,297,195,221,91,161,362,236,291,316,177,115,56,384])\ndefense_data_rush = pd.Series([52,99,167,86,139,245,100,188,57,217,76,86,47,140,145,70])\nweek = np.array([1,2,3,4,5,6,7,8,9,10,12,13,14,15,16,17])","d77500a9":"plt.figure(figsize=(11, 6))\nplt.plot(week, defense_data, 'o', markersize=6)\nplt.ylabel(\"100 x Rushing Yards \/ \\n Opponent Average Rush Yards Per Game\", fontsize=16)\nplt.xlabel(\"Week\", fontsize=16)\nplt.title('Buffalo Bills Rushing Defense', fontsize=26);","6e63123a":"with pm.Model() as rushing_model:\n\n    switchpoint = pm.DiscreteUniform('switchpoint', lower=week.min(), upper=week.max(), testval=8)\n\n    # Priors for pre- and post-switch rates number of yards\n    early_rate = pm.Normal('early_rate', mu=100, sigma=50)\n    late_rate = pm.Normal('late_rate', mu=100, sigma=50)\n\n    # Allocate appropriate Poisson rates to years before and after current\n    rate = pm.math.switch(switchpoint >= week, early_rate, late_rate)\n\n    rushing_yards = pm.Poisson('yards', rate, observed=defense_data)","2f31937f":"with rushing_model:\n    trace = pm.sample(10000)","e549b697":"pm.traceplot(trace);","670de13f":"pm.summary(trace).round(2)","f4b3ee1d":"plt.figure(figsize=(11, 6))\nplt.plot(week, defense_data, 'o', markersize=6)\nplt.ylabel(\"(Percent) Rushing Yards \/ \\n Opponent Average Rush Yards Per Game\", fontsize=16)\nplt.xlabel(\"Week\", fontsize=16)\n\nplt.vlines(trace['switchpoint'].mean(), defense_data.min(), defense_data.max(), color='C1')\naverage_yards = np.zeros_like(defense_data, dtype='float')\nfor i, wk in enumerate(week):\n    idx = wk < trace['switchpoint']\n    average_yards[i] = (trace['early_rate'][idx].sum() + trace['late_rate'][~idx].sum()) \/ (len(trace) * trace.nchains)\n\nsp_hpd = pm.hpd(trace['switchpoint'])\nplt.fill_betweenx(y=[defense_data.min(), defense_data.max()],\n                  x1=sp_hpd[0], x2=sp_hpd[1], alpha=0.5, color='C1');\nplt.plot(week, average_yards,  'k--', lw=3);\n\nplt.title('Buffalo Bills Rushing Defense Switchpoint', fontsize=26);","eff32439":"The data predicts a switchpoint between 1885-1894 in the 94% credible interval (see summary table above), with an expected date of 1889.77.  There was susbtantial mining saftey laws passed in 1891, which is the likely cause for the switch (although one should be careful about concluding 'cause' from data alone).  More historical information is available at the U.S. Mine Safety and Health website: https:\/\/www.msha.gov\/about\/history.","c7d0254f":"Now we build the model.\n\nThe prior distributions are:\n* switchpoint $\\sim \\mathcal{U}\\{1851, 1962\\}$\n* early_rate $\\sim Exp[1]$\n* late_rate $\\sim Exp[1]$\n\nWe define the unobserved variable rate, which is a function of the year:\n\\begin{equation}\n  \\text{rate}=\n  \\begin{cases}\n    \\text{early_rate}, & \\text{if}\\ \\text{year} < \\text{switchpoint} \\\\\n    \\text{late_rate}, & \\text{otherwise}\n  \\end{cases}\n\\end{equation}\n\nOur likelihood function in Bayes theorem is a Poisson distribution on the number of disasters, each year.  This can be written as:\n\\begin{equation}\n  \\text{disasters}\\sim \\text{Pois}(\\text{rate}).\n\\end{equation}","833899f3":"First we import our required packages and manually enter the data.","00d6bac9":"Here is the summary of the results.","968316aa":"Let's plot the data.","bf3c7d03":"Here is a plot that shows the disaster rates and switchpoint uncertainty along with the data.","028d017e":"# Buffalo Bills Rushing Defense:","e7d123e6":"The traceplots give an excellent first look at the posterior distributions.","627de964":"# Switchpoint Analysis of Mining Disasters in PYMC3\n\nThis notebook is a tutorial on switchpoint analysis of coal mining disasters adapted from the PYMC3 getting started documentation [https:\/\/docs.pymc.io\/notebooks\/getting_started.html](https:\/\/docs.pymc.io\/notebooks\/getting_started.html).  The goal is to determine when the rate of mining disasters per year decreased, and furthermore if this date corresponds to a date for change in mine saftey rules.  We compare our results from the data to a date for major rule change after we determine the date range predicted from the results.  The before and after give a measure of effectievness for the rule change.\n![image.png](attachment:image.png)"}}