{"cell_type":{"07a1e0c4":"code","04a09d6c":"code","0f936a66":"code","7173f7a9":"code","ac615e63":"code","895662d1":"code","2ca8f3ed":"code","f06bbc62":"code","a31286bf":"code","02edc32e":"code","6570e6bb":"code","8fe8a9cd":"code","f82c0c09":"code","3e1064cf":"code","bd4c1d1d":"code","c4c91cfa":"code","e03411ab":"code","5c40277e":"code","9391746d":"code","02d519cc":"code","03302d06":"code","0f2406d2":"markdown","b1820b80":"markdown","5d673328":"markdown","9a274c2f":"markdown"},"source":{"07a1e0c4":"from sklearn.model_selection import train_test_split\nimport cv2\nimport matplotlib.pyplot as plt\nimport keras\nfrom keras.preprocessing.image import img_to_array","04a09d6c":"import numpy as np\nimport pandas as pd\n\nimport os\nfor dirname, _, filenames in os.walk('\/kaggle\/input'):\n    for filename in filenames:\n        print(os.path.join(dirname, filename))","0f936a66":"train_df=pd.read_csv('..\/input\/plant-pathology-2020-fgvc7\/train.csv')\ntest_df=pd.read_csv('..\/input\/plant-pathology-2020-fgvc7\/test.csv')","7173f7a9":"train_df.head()","ac615e63":"target_df = train_df[['healthy', 'multiple_diseases', 'rust', 'scab']]\ntest_ids = test_df['image_id']","895662d1":"img_size = 224\n\ntrain_imgs = []\n\nfor name in train_df['image_id']:\n    path = '..\/input\/plant-pathology-2020-fgvc7\/images\/' + name + '.jpg'\n    img = cv2.imread(path)\n    image = cv2.resize(img,(img_size,img_size),interpolation=cv2.INTER_AREA)\n    train_imgs.append(image)","2ca8f3ed":"fig, ax = plt.subplots(1, 4, figsize=(15, 15))\nfor i in range(4):\n    ax[i].set_axis_off()\n    ax[i].imshow(train_imgs[i])","f06bbc62":"test_imgs = []\nfor name in test_df['image_id']:\n    path = '..\/input\/plant-pathology-2020-fgvc7\/images\/' + name + '.jpg'\n    img = cv2.imread(path)\n    image = cv2.resize(img,(img_size,img_size),interpolation=cv2.INTER_AREA)\n    test_imgs.append(image)","a31286bf":"fig, ax = plt.subplots(1, 4, figsize=(15, 15))\nfor i in range(4):\n    ax[i].set_axis_off()\n    ax[i].imshow(test_imgs[i])    ","02edc32e":"X_train = np.ndarray(shape=(len(train_imgs), img_size, img_size, 3),dtype = np.float32)\n\nfor i, image in enumerate(train_imgs):\n    X_train[i] = img_to_array(image)\n    X_train[i] = train_imgs[i]\n\nX_train = X_train\/255\nprint('Train Shape: {}'.format(X_train.shape))","6570e6bb":"X_test = np.ndarray(shape=(len(test_imgs), img_size, img_size, 3),dtype = np.float32)\n\nfor i, image in enumerate(test_imgs):\n    X_test[i] = img_to_array(image)\n    X_test[i] = test_imgs[i]\n    \nX_test = X_test\/255\nprint('Test Shape: {}'.format(X_test.shape))","8fe8a9cd":"y_train = train_df.copy()\ndel y_train['image_id']\ny_train.head()","f82c0c09":"X_train, X_val, y_train, y_val = train_test_split(X_train, y_train, test_size=0.2, random_state=42)\n\nX_train.shape, X_val.shape","3e1064cf":"from keras.callbacks import ReduceLROnPlateau\nfrom keras.callbacks import EarlyStopping\nfrom keras.callbacks import ModelCheckpoint\n\nlr_reduce=ReduceLROnPlateau(monitor='val_accuracy',\n                            factor=.5,\n                            patience=5,\n                            min_lr=.000001,\n                            verbose=1)\n\nes_monitor=EarlyStopping(monitor='val_loss',\n                          patience=10)\n\nmdl_check = ModelCheckpoint('best_model.h5', \n                            monitor='accuracy', \n                            verbose=0, \n                            save_best_only=True, \n                            mode='max')","bd4c1d1d":"from tensorflow.keras.applications import EfficientNetB4\nfrom tensorflow.keras.models import Model\nfrom tensorflow.keras.layers import Dense, Dropout, GlobalAveragePooling2D\n\nfrom tensorflow.keras.callbacks import ModelCheckpoint, EarlyStopping, ReduceLROnPlateau\n\nreg = 0.0005\n\nnet = EfficientNetB4(weights= 'imagenet', include_top=False, input_shape= (img_size,img_size,3))\nx = net.output\nx = GlobalAveragePooling2D()(x)\nx = Dense(128, activation=\"relu\")(x)\nx = Dropout(0.5)(x)\nx = Dense(64, activation=\"relu\")(x)\nx = Dense(32, activation=\"relu\")(x)\npredictions = Dense(4, activation= 'softmax')(x)\nmodel = Model(inputs = net.input, outputs = predictions)\n\nmodel.summary()","c4c91cfa":"model.compile(optimizer='adam', loss='categorical_crossentropy', metrics=['accuracy'])","e03411ab":"from keras.preprocessing.image import ImageDataGenerator\n\ndatagen = ImageDataGenerator(rotation_range=45,\n                            shear_range=.25,\n                            zoom_range=.25,\n                            width_shift_range=.25,\n                            height_shift_range=.25,\n                            rescale=1\/255,\n                            brightness_range=[.5,1.5],\n                            horizontal_flip=True,\n                            vertical_flip=True,\n                            fill_mode='nearest')","5c40277e":"history = model.fit_generator(datagen.flow(X_train, y_train, batch_size=24),\n                              epochs = 25,\n                              steps_per_epoch = X_train.shape[0] \/\/ 24,\n                              verbose = 1,\n                              callbacks = [es_monitor,lr_reduce, mdl_check],\n                              validation_data = datagen.flow(X_val, y_val,batch_size=24),\n                              validation_steps = X_val.shape[0] \/\/24)","9391746d":"h = history.history\n\noffset = 5\nepochs = range(offset, len(h['loss']))\n\nplt.figure(1, figsize=(12, 12))\n\nplt.subplot(211)\nplt.xlabel('epochs')\nplt.ylabel('loss')\nplt.plot(epochs, h['loss'][offset:], label='train')\nplt.plot(epochs, h['val_loss'][offset:], label='val')\nplt.legend()\n\nplt.subplot(212)\nplt.xlabel('epochs')\nplt.ylabel('accuracy')\nplt.plot(h[f'accuracy'], label='train')\nplt.plot(h[f'val_accuracy'], label='val')\nplt.legend()\n\nplt.show()","02d519cc":"y_pred = model.predict(X_test)","03302d06":"sub_df = pd.read_csv('..\/input\/plant-pathology-2020-fgvc7\/sample_submission.csv')\nsub_df.loc[:, 'healthy':] = y_pred\nsub_df.to_csv('submission.csv', index=False)\nsub_df.head()","0f2406d2":"**Set Callbacks**","b1820b80":"**Image processing**","5d673328":"**Image Data Augmentation and fit model**","9a274c2f":"**Split training set**"}}