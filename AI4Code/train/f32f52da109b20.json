{"cell_type":{"e47e9796":"code","0db607d6":"code","4cc7927b":"code","11dc23f6":"code","e2054959":"code","634c15ec":"code","59955114":"code","0724554e":"code","691a36f4":"code","aaa1274f":"code","768d8750":"code","bf19f9a5":"code","e184d1ce":"code","8bb58917":"code","6096bdbc":"code","dcdca75b":"code","678dc66f":"code","a0063509":"code","4667b2ac":"code","68c1abec":"code","841b4e0a":"code","60322fa7":"code","57b118e7":"code","578dfa8b":"code","85faf70f":"code","dc01a6ca":"code","fd11e8eb":"code","363db891":"code","60608693":"code","ef101809":"code","a76b64c1":"code","bbbbd656":"code","42dbbaac":"code","9fa29f77":"code","458003fb":"code","6b797caf":"code","83cdddaf":"code","1f9fe542":"code","bd05046f":"code","4d711bc9":"code","c52831bb":"code","e286997d":"code","9075231d":"code","e6589bc9":"code","9c446f64":"code","020c09f5":"code","ed089202":"code","441f1b62":"code","f02102d9":"code","6075e7b9":"markdown","b439e02d":"markdown","7baf2c05":"markdown","e7753712":"markdown","d9025110":"markdown","e5a8f706":"markdown","5ebaf183":"markdown","d040abf0":"markdown","f91bdbf8":"markdown","8115ccd2":"markdown","e8bbb307":"markdown","1379814a":"markdown","80fc0a4c":"markdown","878a1d6f":"markdown","11dd0139":"markdown","6aa168cb":"markdown","ef700ad7":"markdown","88a19257":"markdown","d13ed725":"markdown","26109ab8":"markdown","0f9966cb":"markdown","cf401e81":"markdown","fe0d5c9b":"markdown","5c852ce3":"markdown","67781305":"markdown","f5ac6427":"markdown"},"source":{"e47e9796":"!conda install -c conda-forge --yes hdbscan","0db607d6":"import pandas as pd\nimport numpy as np\nimport seaborn as sns\nimport matplotlib.pyplot as plt\nfrom sklearn.preprocessing import StandardScaler\nfrom sklearn.decomposition import PCA\nfrom sklearn.cluster import KMeans,AgglomerativeClustering,DBSCAN,MeanShift,estimate_bandwidth,AffinityPropagation,SpectralClustering\nfrom sklearn.mixture import GaussianMixture\nfrom scipy.cluster.hierarchy import dendrogram,linkage,ward,complete,single,fcluster\nfrom sklearn.metrics import silhouette_score\nfrom sklearn.manifold import TSNE\nimport umap\nimport hdbscan\nimport warnings\nwarnings.filterwarnings(\"ignore\")","4cc7927b":"def kmeans_cluster_decision(X,point,min_clusters=2,max_clusters=10):\n    inertia = []\n    score = []\n    ticks = []\n    for cluster in range(min_clusters,max_clusters):\n        model = KMeans(n_clusters=cluster)\n        model.fit(X)\n        inertia.append(model.inertia_)\n        score.append(silhouette_score(X,model.labels_))\n        ticks.append(cluster)\n\n    fig,ax = plt.subplots(1,2,figsize=(18,4))\n    sns.lineplot(x=ticks,y=inertia,ax=ax[0]).set_title(\"Inertia vs Clusters\")\n    ax[0].set_xticks(ticks)\n    ax[0].set_xticklabels(ticks)\n    ax[0].plot(point,inertia[point - min_clusters],marker='x',c='r',markersize=6)\n    sns.lineplot(x=ticks,y=score,ax=ax[1]).set_title(\"Sil. Score vs Clusters\")\n    ax[1].set_xticks(ticks)\n    ax[1].set_xticklabels(ticks)\n    ax[1].plot(point,score[point - min_clusters],marker='x',c='r',markersize=6)\n    plt.show()\n\ndef draw_analysis_graphs(labels):\n    fig,ax=plt.subplots(2,3,figsize=(18,14))\n    sns.scatterplot(x='age',y='income',data=dfdata,hue=labels,palette='Paired',ax=ax[0][0])\n    sns.scatterplot(x='age',y='spending',data=dfdata,hue=labels,palette='Paired',ax=ax[0][1])\n    sns.scatterplot(x='spending',y='income',data=dfdata,hue=labels,palette='Paired',ax=ax[0][2])\n    sns.swarmplot(x=labels,y='age',data=dfdata,hue=labels,palette='Paired',ax=ax[1][0])\n    sns.swarmplot(x=labels,y='spending',data=dfdata,hue=labels,palette='Paired',ax=ax[1][1])\n    sns.swarmplot(x=labels,y='income',data=dfdata,hue=labels,palette='Paired',ax=ax[1][2])\n    plt.show()\n\ndef scaler(X):\n    scaler = StandardScaler()\n    X_scaled = scaler.fit_transform(X)\n    return X_scaled","11dc23f6":"dfdata = pd.read_csv('..\/input\/customer-segmentation-tutorial-in-python\/Mall_Customers.csv')\ndfdata.head()","e2054959":"dfdata.describe()","634c15ec":"dfdata.columns = ['id','gender','age','income','spending']\ndfdata.info()","59955114":"plt.figure(figsize=(10,2))\nsns.countplot(y = 'gender',data = dfdata)\nplt.show()","0724554e":"plt.figure(figsize=(10,10))\nsns.pairplot(data = dfdata[['age','income','spending','gender']],hue='gender',diag_kind='kde')\nplt.show()","691a36f4":"plt.figure(figsize=(18,6))\nsns.countplot(x='age',data=dfdata,hue='gender')\nplt.title(\"Age vs Gender Distribution\")\nplt.show()","aaa1274f":"plt.figure(figsize=(18,6))\nsns.countplot(x='income',data=dfdata,hue='gender')\nplt.title(\"Income vs gender distribution\")\nplt.show()","768d8750":"plt.figure(figsize=(18,6))\nsns.countplot(x='spending',data=dfdata,hue='gender')\nplt.title(\"Spending score vs gender distribution\")\nplt.show()","bf19f9a5":"X_scaled = scaler(dfdata[['income','spending','age']])\nkmeans_cluster_decision(X_scaled,6,2,10)","e184d1ce":"model = KMeans(n_clusters=6)\nlabels = model.fit_predict(X_scaled)\nprint(\"Inertia : \",round(model.inertia_,2),\"Silhouette Score : \",round(silhouette_score(X_scaled,labels),2))\ndraw_analysis_graphs(labels)","8bb58917":"X_scaled_ai = scaler(dfdata[['age','income']])\nX_scaled_as = scaler(dfdata[['age','spending']])\nX_scaled_is = scaler(dfdata[['income','spending']])\n","6096bdbc":"kmeans_cluster_decision(X_scaled_ai,3,2,20)","dcdca75b":"model = KMeans(n_clusters=3)\nlabels_ai = model.fit_predict(X_scaled_ai)\nprint(\"Inertia : \",round(model.inertia_,2),\"Silhouette Score : \",round(silhouette_score(X_scaled_ai,labels_ai),2))\ndraw_analysis_graphs(labels_ai)","678dc66f":"kmeans_cluster_decision(X_scaled_as,6,2,20)","a0063509":"model = KMeans(n_clusters=6)\nlabels_as = model.fit_predict(X_scaled_as)\nprint(\"Inertia : \",round(model.inertia_,2),\"Silhouette Score : \",round(silhouette_score(X_scaled_as,labels_as),2))\ndraw_analysis_graphs(labels_as)","4667b2ac":"kmeans_cluster_decision(X_scaled_is,5,2,20)","68c1abec":"model = KMeans(n_clusters=5)\nlabels_is = model.fit_predict(X_scaled_is)\nprint(\"Inertia : \",round(model.inertia_,2),\"Silhouette Score : \",round(silhouette_score(X_scaled_is,labels_is),2))\ndraw_analysis_graphs(labels_is)","841b4e0a":"score = []\nxticks = []\nfor i in range(3,10):\n    model = GaussianMixture(n_components=i).fit(X_scaled_is)\n    labels = model.predict(X_scaled_is)\n    xticks.append(\"i:\" + str(i) + \"c:\" + str(len(np.unique(labels))))\n    score.append(silhouette_score(X_scaled_is,labels))\nplt.figure(figsize=(18,4))\nsns.lineplot(x=range(len(score)),y=score)\nplt.xticks(range(len(score)),xticks,rotation=45)\nplt.show()","60322fa7":"model = GaussianMixture(n_components=5).fit(X_scaled_is)\nlabels_gm = model.predict(X_scaled_is)\nprint(\"Silhouette Score : \",round(silhouette_score(X_scaled_is,labels_gm),2))\ndraw_analysis_graphs(labels_gm)","57b118e7":"pd.crosstab(labels_is,labels_gm)","578dfa8b":"links = linkage(X_scaled_is,method='ward')\nplt.figure(figsize=(20,6))\ndendrogram(links,leaf_rotation=90,leaf_font_size=6)\nplt.show()","85faf70f":"score = []\nfor i in range(1,15):\n    labels_dendro = fcluster(links,t=i,criterion='distance')\n    score.append(silhouette_score(X_scaled_is,labels_dendro))\nplt.figure(figsize=(18,5))\nsns.lineplot(x=range(len(score)),y=score)\nplt.show()","dc01a6ca":"labels_dendro = fcluster(links,t=5,criterion = 'distance')\nprint(\"Silhouette Score : \",round(silhouette_score(X_scaled_is,labels_dendro),2))\ndraw_analysis_graphs(labels_dendro)","fd11e8eb":"score = []\nfor i in range(2,15):\n    labels_agg = AgglomerativeClustering(n_clusters = i).fit(X_scaled_is)\n    score.append(silhouette_score(X_scaled_is,labels_agg.labels_))\nplt.figure(figsize=(18,5))\nsns.lineplot(x=range(len(score)),y=score)\nplt.show()","363db891":"model = AgglomerativeClustering(n_clusters=5).fit(X_scaled_is)\nlabels_agg = model.labels_\nprint(\"Silhouette Score : \",round(silhouette_score(X_scaled_is,labels_agg),2))\ndraw_analysis_graphs(labels_agg)","60608693":"fig,ax=plt.subplots(3,3,figsize=(24,15))\nfor i,eps in enumerate([round(x*0.1,1) for x in range(4,7)]):\n    for j,sample in enumerate(range(6,12,2)):\n        model = DBSCAN(eps=eps,min_samples=sample).fit(X_scaled_is)\n        labels = model.labels_\n        sns.scatterplot(x = 'spending',y='income',hue=labels,data=dfdata,ax=ax[j][i],palette='Paired')\n        title = \"eps: \" + str(eps) + \" min_samples:\" + str(sample)\n        ax[j,i].set_title(title)\nplt.show()","ef101809":"score = []\nxlabels = []\nfor i,eps in enumerate([round(x*0.1,1) for x in range(3,9)]):\n    for j,sample in enumerate(range(6,14)):\n        model = DBSCAN(eps=eps,min_samples=sample).fit(X_scaled_is)\n        labels = model.labels_\n        if len(np.unique(labels)) > 1:\n            score.append(silhouette_score(X_scaled_is,labels))\n        else:\n            score.append(0)\n        xlabels.append('e: ' + str(eps) + ' s: ' + str(sample))\nplt.figure(figsize=(18,5))\nsns.lineplot(x=range(len(score)),y=score)\nplt.xticks(range(len(xlabels)),xlabels,rotation = 90)\nplt.show()","a76b64c1":"score = []\nfor i in [x*0.01 for x in range(1,17)]:\n    bandwidth = estimate_bandwidth(X_scaled_is, quantile=i)\n    model = MeanShift(bandwidth).fit(X_scaled_is)\n    score.append(silhouette_score(X_scaled_is,model.labels_))\nplt.figure(figsize=(18,5))\nsns.lineplot(x=range(len(score)),y=score)\nplt.show()","bbbbd656":"bandwidth = estimate_bandwidth(X_scaled_is, quantile=0.15)\nmodel = MeanShift(bandwidth).fit(X_scaled_is)\nlabels_ms = model.labels_\nprint(\"Silhouette Score : \",round(silhouette_score(X_scaled_is,labels_ms),2))\ndraw_analysis_graphs(labels_ms)","42dbbaac":"selected_columns = ['age','income','spending','genderlabel']\ndfdata['genderlabel'] = dfdata['gender'].replace(['Male','Female'],[0,1])\nX_scaled_all = pd.DataFrame(scaler(dfdata[selected_columns]),columns = selected_columns)","9fa29f77":"score = []\nfor i in range(1,5):\n    pca = PCA(n_components = i).fit(X_scaled_all)\n    score.append(np.sum(pca.explained_variance_ratio_))\nplt.figure(figsize=(10,5))\nsns.lineplot(x=range(len(score)),y=score)\nplt.xticks(range(len(score)),range(1,5))\nplt.show()","458003fb":"score = []\npca_vars = []\nfor i in range(1,5):\n    pca = PCA(n_components = i)\n    X_pca = pca.fit_transform(X_scaled_all)\n    for j in range(3,7):\n        model = KMeans(n_clusters=j).fit(X_pca)\n        score.append(silhouette_score(X_pca,model.labels_))\n        pca_vars.append(\"pca:\" + str(i) + \"c:\" + str(j))\nplt.figure(figsize=(18,6))\nsns.lineplot(x=range(len(score)),y=score)\nplt.xticks(ticks=range(len(score)),labels=pca_vars,rotation=90)\nplt.show()","6b797caf":"pca = PCA(n_components = 3).fit(X_scaled_all)\nX_pca = pca.transform(X_scaled_all)\nsns.heatmap(pca.components_,annot=True,fmt='.1g')\nplt.xticks(range(X_scaled_all.shape[1]),X_scaled_all.columns.values,rotation=45)\nplt.show()","83cdddaf":"model = KMeans(n_clusters=6).fit(X_pca)\nlabels_pca = model.labels_\nscore.append(silhouette_score(X_pca,labels_pca))\nprint(\"Silhouette Score : \",round(silhouette_score(X_pca,labels_pca),2))\ndraw_analysis_graphs(labels_pca)","1f9fe542":"X_scaled = scaler(dfdata[['income','spending','age']])\ntsne = TSNE(n_components=2,perplexity=15,learning_rate=450)\ntsne_result=tsne.fit_transform(X_scaled)","bd05046f":"sns.scatterplot(tsne_result[:,0],tsne_result[:,1])\nplt.show()","4d711bc9":"fig,ax = plt.subplots(1,4,figsize=(24,6))\nsns.scatterplot(tsne_result[:,0],tsne_result[:,1],hue=labels_is,palette = 'Paired',ax = ax[0])\nsns.scatterplot(tsne_result[:,0],tsne_result[:,1],hue=labels_dendro,palette = 'Paired',ax = ax[1])\nsns.scatterplot(tsne_result[:,0],tsne_result[:,1],hue=labels_agg,palette = 'Paired',ax = ax[2])\nsns.scatterplot(tsne_result[:,0],tsne_result[:,1],hue=labels_ms,palette = 'Paired',ax = ax[3])\nplt.show()","c52831bb":"resultset = ['Kmeans','Dendro','Agg','MSA']\ndfResult = pd.DataFrame(zip(labels_is,labels_dendro,labels_agg,labels_ms),columns=resultset)\nfor i in range(len(resultset)):\n    for j in range(i + 1,len(resultset)):\n        print(\"Results for \" + resultset[i] + \" and \" + resultset[j])\n        print(pd.crosstab(dfResult.iloc[:,i],dfResult.iloc[:,j]))","e286997d":"X_scaled = scaler(dfdata[['income','spending','age']])\numap_data = umap.UMAP(n_neighbors=20).fit_transform(X_scaled)\nmodel = hdbscan.HDBSCAN(min_cluster_size=5).fit(umap_data)\nlabels_hdbscan = model.labels_\nprint(\"Silhouette Score : \",round(silhouette_score(X_scaled,labels_hdbscan),2))\nfig,ax = plt.subplots(1,2,figsize=(18,5))\nsns.scatterplot(tsne_result[:,0],tsne_result[:,1],hue=labels_hdbscan,palette = 'Paired',ax=ax[0])\nsns.scatterplot(umap_data[:,0],umap_data[:,1],hue=labels_hdbscan,palette = 'Paired',ax=ax[1])\nplt.show()","9075231d":"pd.crosstab(labels_is,labels_hdbscan)","e6589bc9":"score = []\nfor i in [round(x * 0.1,1) for x in range(5,10)]:\n    model = AffinityPropagation(damping = i,random_state=12).fit(X_scaled_is)\n    score.append(silhouette_score(X_scaled_is,model.labels_))\nplt.figure(figsize=(18,5))\nsns.lineplot(x=range(len(score)),y=score)\nplt.xticks(range(len(score)),[round(x * 0.1,1) for x in range(5,10)])\nplt.show()","9c446f64":"model = AffinityPropagation(damping = 0.7,random_state=12).fit(X_scaled_is)\nlabels_ap = model.labels_\nprint(\"Silhouette Score : \",round(silhouette_score(X_scaled_is,labels_ap),2))\nsns.scatterplot(tsne_result[:,0],tsne_result[:,1],hue=labels_ap,palette = 'Paired')\nplt.show()","020c09f5":"pd.crosstab(labels_is,labels_ap)","ed089202":"score = []\nfor i in range(3,10):\n    model = SpectralClustering(n_clusters=i).fit(X_scaled_is)\n    score.append(silhouette_score(X_scaled_is,model.labels_))\nplt.figure(figsize=(18,4))\nsns.lineplot(x=range(len(score)),y=score)\nplt.xticks(range(len(score)),range(5,10))\nplt.show()","441f1b62":"model = SpectralClustering(n_clusters = 8).fit(X_scaled_is)\nlabels_sc = model.labels_\nprint(\"Silhouette Score : \",round(silhouette_score(X_scaled_is,labels_sc),2))\nsns.scatterplot(tsne_result[:,0],tsne_result[:,1],hue=labels_sc,palette = 'Paired')\nplt.show()","f02102d9":"pd.crosstab(labels_is,labels_sc)","6075e7b9":"- Income distribution changes at 40 and 80. At all classes, females are more frequent visitors","b439e02d":"After KMeans clustering according to **income** and **spending** features, we can we can easily conclude that our 6 clusters consist of the customers below.<br>Low-high values for all features are consistent with our previous graphs.<br>\n**label 0:** low spending  - high income customers <br>\n**label 1:** low spending  - low income customers<br>\n**label 2:** mid spending  - mid income customers<br>\n**label 3:** high spending - high income customers<br>\n**label 4:** high spending - low income customers","7baf2c05":"# Get Data","e7753712":"# Gaussian Mixture Clustering<br>\n- Normal distributed data\n- Consider mean and variance of data for clustering","d9025110":"With **Kmeans**, **Dendrogram**, **Agglomerative Clustering** and **Mean Shift Algorithm** we approximately found same silhouette score with same number of clusters. When we compare them on TSNE graphs, it seems that they are still approximately same. Now, its time to check results via crosstabs.","e5a8f706":"# Spectral Clustering<br>\n- Transformation of data to affinity matrix and clustering via affinity matrix.\n- Good at uneven cluster sizes, convex and non-conves geometry\n- Not scalable\n- Used in image clustering","5ebaf183":"# TSNE Analysis<br>\n- Graph based nonlinear feature elimination tool.\n- Calculate distance based on distance to neighbors.\n- Perplexity (btw 10 - 50) and learning rate (btw 10 - 200) are main hyper parameters. Difficult to find optimum parameters.","d040abf0":"After trials with 2 features, we conclude that clustering with respect to **income** and **spending** works better since inertia and silhouette score is by far the best scores. So, we will continue testing other algorithms by using only **income** and **spending**","f91bdbf8":"   # PCA Analysis<br>\n    - PCA is linear matrix factorization tool for feature elimination. Poor on sparse matrices. Need scaling of data\n    - While performing PCA, its important to hold high explained variance ratio, with experience its better to be between 80% - 90%.","8115ccd2":"- Distribution changes dramatically at ages 25,45 and 55 respectively.\n- Mid aged females are more frequent visitors with respect to mid aged males. But still the distinction is not exact with the graph","e8bbb307":"# Import and Functions","1379814a":"## Analysis of Data","80fc0a4c":"- Gender has no effect on distribution of other features. So, gender is excluded from our feature set.","878a1d6f":"## Features : Age,Income,Spending","11dd0139":"- As expected, Dendro and Aggregated Clustering have same results, since they are same models. \n- The difference between KMeans and Dendrogram are on clusters 0 and 4. \n- Difference between KMeans and MSA is at clusters 1 and 2. \n- Difference between MSA and Aggregated Clustering is at clusters 1 and 2 again.\n- According to scatter plots, we see that there are only 9 customers at cluster borders and they are the reason of difference between clustering algorithms. ","6aa168cb":"# Affinity Propagation<br>\n- Transformation of data to similarities matrix and clustering via similarities (availibilites and responsibilities).\n- damping between 0.5 and 1\n- Good at uneven cluster sizes, convex and non-conves geometry\n- Not scalable\n- Using Graph distance \n- Used in image and biological clustering","ef700ad7":"# UMAP & HDBSCAN<br>\n- Non-linear graphical feature elimination tool. Distance is still calculated via neighbors.\n- n_neighbors is the main hyper parameter.\n- **HDBSCAN**: combine the power of agglomerated clustering and dbscan. More efficient in varying density data.","88a19257":"After KMeans clustering of all three features, with scatterplots and swarmplots above, we can we can easily conclude that our 6 clusters consist of the customers below.<br>Low-high values for all features are consistent with our previous graphs.\n- **label 0:** mid age - low spending  - high income customers\n- **label 1:** young   - high spending - low income customers\n- **label 2:** all age - low spending  - low income customers\n- **label 3:** mid age - high spending - high income customers\n- **label 4:** old     - mid spending  - mid income customers\n- **label 5:** young   - mid spending  - mid income customers","d13ed725":"# Mean Shift Algorithm <br>\n- Not scalable, not good at outliers\n- Number of clusters is not needed\n- Bandwidth is estimated via quantiles\n- Generally used in image classification\n- Used with kmeans clustering generally","26109ab8":"# DBSCAN<br>\n- Good at density based distributions.\n- Hard to decide on correct eps and min_samples.\n- As eps increases, number of clusters decreases. As min_samples increases, number of clusters decreases.\n- Outlier values can be problem\n- Bad at varying density data. Use OPTICS instead.","0f9966cb":"From 2d TSNE graph, it seems that we will have 4-6 clusters.<br>\nI tried perplexity and learning rate manually for perplexity values between 5-50 and learning rate 50-500.","cf401e81":"## Features : [Age,Income],[Age,Spending],[Income,Spending]","fe0d5c9b":"# K-Means Algorithm<br>\n- Easy and simple algorithm\n- Captures only simple and convex shapes. Fails with dense distributions.\n- According to TSNE graph, it seems that we have convex and simple shape. Thats why we expect KMeans to be successful algorithm.\n- Kmodes for categorical data\n- MiniBatch K Means or BIRCH for big data","5c852ce3":"![Density Based Distributions](https:\/\/scikit-learn.org\/stable\/_images\/sphx_glr_plot_cluster_comparison_001.png)","67781305":"- Spending distribution changes at 40,65 and 80 respectively. Low spending males are more frequent visitors, while females are more frequent visitors at other spending values.\n- Assumptions of all clustering algorithms are scaling and normalization of data since we want to give equal chance to all features.\n- We will check the distribution of the data from TSNE graph to have an intuition for number of clusters.\n- After that, we will apply K-Means clustering algorithm to check clusters for all three features in addition to all combinations of two features\n- We will compare the results via inertia and silhouette score.","f5ac6427":"# Agglomerative Hierarchical Algorithm<br>\n- More successful than K-Means for complex shapes.\n- More informative with dendrograms\n- Still fails with complex density based distributions.\n- Connectivity and linkage parameters are important.\n- **Connectivity** : Points in clusters will be connected?\n- **linkage** : ward, single,average and complete. Ward is used generally"}}