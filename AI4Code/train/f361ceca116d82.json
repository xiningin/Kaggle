{"cell_type":{"0a41dfdb":"code","7f468c08":"code","1c8deaf3":"code","f87a4de1":"code","a4937210":"code","04830b0a":"code","ef9b0b70":"code","8fb3b7e9":"code","06da1532":"code","e336d771":"code","7261cdb9":"code","fdbf8dc1":"code","247a8137":"code","66696c5e":"code","18daf9df":"code","23796654":"code","3f72dd0b":"code","ca2816b3":"code","fad49481":"code","a493d49d":"code","85ad664f":"code","bde60aa4":"code","da01a448":"markdown","8e7c42fc":"markdown","5f823ecb":"markdown","94b4d2da":"markdown","52764a1c":"markdown","1f807388":"markdown","17f7a40d":"markdown","9200e91c":"markdown","243915e2":"markdown","1f799523":"markdown","ae947c9a":"markdown","6c9912b8":"markdown","6a565ea6":"markdown","18031e69":"markdown","78a707fd":"markdown","7a87d9ae":"markdown","34c2f0a7":"markdown","1c2498f9":"markdown","e869a628":"markdown","d5faacef":"markdown","a416d1d3":"markdown","5340485e":"markdown","1469566f":"markdown","d67de722":"markdown","a1637ac7":"markdown","b1a8e63f":"markdown","6c65cdfa":"markdown"},"source":{"0a41dfdb":"import numpy as np\nimport pandas as pd","7f468c08":"family_data_w1 = pd.read_csv('\/kaggle\/input\/santa-workshop-tour-2019\/family_data.csv', index_col='family_id')\nsample_sub_w1 = pd.read_csv('\/kaggle\/input\/santa-workshop-tour-2019\/sample_submission.csv', index_col='family_id')","1c8deaf3":"family_data_w2 = pd.read_csv(\"..\/input\/santa-2019-revenge-of-the-accountants\/family_data.csv\", index_col='family_id')\nsample_sub_w2 = pd.read_csv(\"..\/input\/santa-2019-revenge-of-the-accountants\/sample_submission.csv\", index_col='family_id')","f87a4de1":"## from https:\/\/www.kaggle.com\/nickel\/250x-faster-cost-function-with-numba-jit\n#prediction = sample_sub['assigned_day'].values\ndesired_w1 = family_data_w1.values[:, :-1]\nfamily_size_w1 = family_data_w1.n_people.values\npenalties_w1 = np.asarray([\n    [\n        0,\n        50,\n        50 + 9 * n,\n        100 + 9 * n,\n        200 + 9 * n,\n        200 + 18 * n,\n        300 + 18 * n,\n        300 + 36 * n,\n        400 + 36 * n,\n        500 + 36 * n + 199 * n,\n        500 + 36 * n + 398 * n\n    ] for n in range(family_size_w1.max() + 1)\n])","a4937210":"desired_w2 = family_data_w2.values[:, :-1]\nfamily_size_w2 = family_data_w2.n_people.values\npenalties_w2 = np.asarray([\n    [\n        0,\n        50,\n        50 + 9 * n,\n        100 + 9 * n,\n        200 + 9 * n,\n        200 + 18 * n,\n        300 + 18 * n,\n        300 + 36 * n,\n        400 + 36 * n,\n        500 + 36 * n + 199 * n,\n        500 + 36 * n + 398 * n\n    ] for n in range(family_size_w2.max() + 1)\n])","04830b0a":"## from https:\/\/www.kaggle.com\/nickel\/250x-faster-cost-function-with-numba-jit\nfrom numba import njit\n\n@njit()\ndef jited_cost(prediction, desired, family_size, penalties):\n    N_DAYS = 100\n    MAX_OCCUPANCY = 300\n    MIN_OCCUPANCY = 125\n    penalty = 0\n    daily_occupancy = np.zeros(N_DAYS + 1, dtype=np.int64)\n    for i in range(len(prediction)):\n        n = family_size[i]\n        pred = prediction[i]\n        n_choice = 0\n        for j in range(len(desired[i])):\n            if desired[i, j] == pred:\n                break\n            else:\n                n_choice += 1\n        \n        daily_occupancy[pred - 1] += n\n        penalty += penalties[n, n_choice]\n\n    accounting_cost = 0\n    n_out_of_range = 0\n    daily_occupancy[-1] = daily_occupancy[-2]\n    for day in range(N_DAYS):\n        n_next = daily_occupancy[day + 1]\n        n = daily_occupancy[day]\n        n_out_of_range += (n > MAX_OCCUPANCY) or (n < MIN_OCCUPANCY)\n        diff = abs(n - n_next)\n        accounting_cost += max(0, (n-125.0) \/ 400.0 * n**(0.5 + diff \/ 50.0))\n\n    penalty += accounting_cost\n    return np.asarray([penalty, n_out_of_range])","ef9b0b70":"family_data_w1.shape","8fb3b7e9":"family_data_w2.shape","06da1532":"family_data_w1.head()","e336d771":"family_data_w2.head()","7261cdb9":"family_data_w1.isnull().sum()","fdbf8dc1":"family_data_w2.isnull().sum()","247a8137":"family_data_w1.n_people.sum()","66696c5e":"family_data_w2.n_people.sum()","18daf9df":"family_data_w1.n_people.sum()\/300","23796654":"family_data_w2.n_people.sum()\/300","3f72dd0b":"## thanks to https:\/\/www.kaggle.com\/chewzy\/santa-finances-a-closer-look-at-the-costs\n\nimport matplotlib.pyplot as plt\nimport seaborn as sns\nsns.set()\n\nno_of_people = family_data_w1['n_people'].value_counts().sort_index()\n\nplt.figure(figsize=(14,6))\nax = sns.barplot(x=no_of_people.index, y=no_of_people.values)\n\nfor p in ax.patches:\n    ax.annotate(f'{p.get_height():.0f}\\n({p.get_height() \/ sum(no_of_people) * 100:.1f}%)', \n                xy=(p.get_x() + p.get_width()\/2., p.get_height()), ha='center', xytext=(0,5), textcoords='offset points')\n    \nax.set_ylim(0, 1.1*max(no_of_people))\nplt.xlabel('Number of people in family', fontsize=14)\nplt.ylabel('Count', fontsize=14)\nplt.title('Family Size Distribution', fontsize=20)\nplt.show()","ca2816b3":"\nimport matplotlib.pyplot as plt\nimport seaborn as sns\nsns.set()\n\nno_of_people = family_data_w2['n_people'].value_counts().sort_index()\n\nplt.figure(figsize=(14,6))\nax = sns.barplot(x=no_of_people.index, y=no_of_people.values)\n\nfor p in ax.patches:\n    ax.annotate(f'{p.get_height():.0f}\\n({p.get_height() \/ sum(no_of_people) * 100:.1f}%)', \n                xy=(p.get_x() + p.get_width()\/2., p.get_height()), ha='center', xytext=(0,5), textcoords='offset points')\n    \nax.set_ylim(0, 1.1*max(no_of_people))\nplt.xlabel('Number of people in family', fontsize=14)\nplt.ylabel('Count', fontsize=14)\nplt.title('Family Size Distribution', fontsize=20)\nplt.show()","fad49481":"assigned_days_choice_cost_w1 = [] \n\nsample_sub_w1['assigned_day'] = family_data_w1.choice_0\nchoice_0_cost, _ = jited_cost(sample_sub_w1['assigned_day'].values, desired_w1, family_size_w1,penalties_w1)\nassigned_days_choice_cost_w1.append(choice_0_cost)\nprint(\"Choice 1 cost: {}\".format(choice_0_cost))\n\nsample_sub_w1['assigned_day'] = family_data_w1.choice_1\nchoice_1_cost, _ = jited_cost(sample_sub_w1['assigned_day'].values, desired_w1, family_size_w1,penalties_w1)\nassigned_days_choice_cost_w1.append(choice_1_cost)\nprint(\"Choice 2 cost: {}\".format(choice_1_cost))\n\nsample_sub_w1['assigned_day'] = family_data_w1.choice_2\nchoice_2_cost, _ = jited_cost(sample_sub_w1['assigned_day'].values, desired_w1, family_size_w1,penalties_w1)\nassigned_days_choice_cost_w1.append(choice_2_cost)\nprint(\"Choice 3 cost: {}\".format(choice_2_cost))\n\nsample_sub_w1['assigned_day'] = family_data_w1.choice_3\nchoice_3_cost, _ = jited_cost(sample_sub_w1['assigned_day'].values, desired_w1, family_size_w1,penalties_w1)\nassigned_days_choice_cost_w1.append(choice_3_cost)\nprint(\"Choice 4 cost: {}\".format(choice_3_cost))\n\nsample_sub_w1['assigned_day'] = family_data_w1.choice_4\nchoice_4_cost, _ = jited_cost(sample_sub_w1['assigned_day'].values, desired_w1, family_size_w1,penalties_w1)\nassigned_days_choice_cost_w1.append(choice_4_cost)\nprint(\"Choice 5 cost: {}\".format(choice_4_cost))\n\nsample_sub_w1['assigned_day'] = family_data_w1.choice_5\nchoice_5_cost, _ = jited_cost(sample_sub_w1['assigned_day'].values, desired_w1, family_size_w1,penalties_w1)\nassigned_days_choice_cost_w1.append(choice_5_cost)\nprint(\"Choice 6 cost: {}\".format(choice_5_cost))\n\nsample_sub_w1['assigned_day'] = family_data_w1.choice_6\nchoice_6_cost, _ = jited_cost(sample_sub_w1['assigned_day'].values, desired_w1, family_size_w1,penalties_w1)\nassigned_days_choice_cost_w1.append(choice_6_cost)\nprint(\"Choice 7 cost: {}\".format(choice_6_cost))\n\nsample_sub_w1['assigned_day'] = family_data_w1.choice_7\nchoice_7_cost, _ = jited_cost(sample_sub_w1['assigned_day'].values, desired_w1, family_size_w1,penalties_w1)\nassigned_days_choice_cost_w1.append(choice_7_cost)\nprint(\"Choice 8 cost: {}\".format(choice_7_cost))\n\nsample_sub_w1['assigned_day'] = family_data_w1.choice_8\nchoice_8_cost, _ = jited_cost(sample_sub_w1['assigned_day'].values, desired_w1, family_size_w1,penalties_w1)\nassigned_days_choice_cost_w1.append(choice_8_cost)\nprint(\"Choice 9 cost: {}\".format(choice_8_cost))\n\nsample_sub_w1['assigned_day'] = family_data_w1.choice_9\nchoice_9_cost, _ = jited_cost(sample_sub_w1['assigned_day'].values, desired_w1, family_size_w1,penalties_w1)\nassigned_days_choice_cost_w1.append(choice_9_cost)\nprint(\"Choice 10 cost: {}\".format(choice_9_cost))\n\n\n","a493d49d":"plt.figure(figsize = (10,5))\n_ =sns.lineplot(x = list(range(1,11)), y = assigned_days_choice_cost_w1,  marker = \"*\", markersize = 20, color = 'green')\n\nplt.title('Penalty by Choice Number')\nplt.xlabel(\"Choice Number\")\nplt.ylabel(\"Penalty\")","85ad664f":"assigned_days_choice_cost_w2 = []\nsample_sub_w2['assigned_day'] = family_data_w2.choice_0\nchoice_0_cost, _ = jited_cost(sample_sub_w2['assigned_day'].values, desired_w2, family_size_w2,penalties_w2)\nassigned_days_choice_cost_w2.append(choice_0_cost)\nprint(\"Choice 1 cost: {}\".format(choice_0_cost))\n\nsample_sub_w2['assigned_day'] = family_data_w2.choice_1\nchoice_1_cost, _ = jited_cost(sample_sub_w2['assigned_day'].values, desired_w2, family_size_w2,penalties_w2)\nassigned_days_choice_cost_w2.append(choice_1_cost)\nprint(\"Choice 2 cost: {}\".format(choice_1_cost))\n\nsample_sub_w2['assigned_day'] = family_data_w2.choice_2\nchoice_2_cost, _ = jited_cost(sample_sub_w2['assigned_day'].values, desired_w2, family_size_w2,penalties_w2)\nassigned_days_choice_cost_w2.append(choice_2_cost)\nprint(\"Choice 3 cost: {}\".format(choice_2_cost))\n\nsample_sub_w2['assigned_day'] = family_data_w2.choice_3\nchoice_3_cost, _ = jited_cost(sample_sub_w2['assigned_day'].values, desired_w2, family_size_w2,penalties_w2)\nassigned_days_choice_cost_w2.append(choice_3_cost)\nprint(\"Choice 4 cost: {}\".format(choice_3_cost))\n\nsample_sub_w2['assigned_day'] = family_data_w2.choice_4\nchoice_4_cost, _ = jited_cost(sample_sub_w2['assigned_day'].values, desired_w2, family_size_w2,penalties_w2)\nassigned_days_choice_cost_w2.append(choice_4_cost)\nprint(\"Choice 5 cost: {}\".format(choice_4_cost))\n\nsample_sub_w2['assigned_day'] = family_data_w2.choice_5\nchoice_5_cost, _ = jited_cost(sample_sub_w2['assigned_day'].values, desired_w2, family_size_w2,penalties_w2)\nassigned_days_choice_cost_w2.append(choice_5_cost)\nprint(\"Choice 6 cost: {}\".format(choice_5_cost))\n\nsample_sub_w2['assigned_day'] = family_data_w2.choice_6\nchoice_6_cost, _ = jited_cost(sample_sub_w2['assigned_day'].values, desired_w2, family_size_w2,penalties_w2)\nassigned_days_choice_cost_w2.append(choice_6_cost)\nprint(\"Choice 7 cost: {}\".format(choice_6_cost))\n\nsample_sub_w2['assigned_day'] = family_data_w2.choice_7\nchoice_7_cost, _ = jited_cost(sample_sub_w2['assigned_day'].values, desired_w2, family_size_w2,penalties_w2)\nassigned_days_choice_cost_w2.append(choice_7_cost)\nprint(\"Choice 8 cost: {}\".format(choice_7_cost))\n\nsample_sub_w2['assigned_day'] = family_data_w2.choice_8\nchoice_8_cost, _ = jited_cost(sample_sub_w2['assigned_day'].values, desired_w2, family_size_w2,penalties_w2)\nassigned_days_choice_cost_w2.append(choice_8_cost)\nprint(\"Choice 9 cost: {}\".format(choice_8_cost))\n\nsample_sub_w2['assigned_day'] = family_data_w2.choice_9\nchoice_9_cost, _ = jited_cost(sample_sub_w2['assigned_day'].values, desired_w2, family_size_w2,penalties_w2)\nassigned_days_choice_cost_w2.append(choice_9_cost)\nprint(\"Choice 10 cost: {}\".format(choice_9_cost))\n\n\n","bde60aa4":"plt.figure(figsize = (10,5))\n_ =sns.lineplot(x = list(range(1,11)), y = assigned_days_choice_cost_w2,  marker = \"*\", markersize = 20, color = 'green')\n\nplt.title('Penalty by Choice Number')\nplt.xlabel(\"Choice Number\")\nplt.ylabel(\"Penalty\")","da01a448":"Let's check the data's health before we make any optimisation moves.","8e7c42fc":"## Wave 2 Cost Function","5f823ecb":"#### The family_data that we are exploring represents each family in a row. So one family is one row here. Then each family has 10 preferences so 0 to 9 choices are given as columns. The number of people in each family are given by the column n_people. Each family is uniquely identified by a family_id. This is the data we will be using to help Santa!","94b4d2da":"# If maximum people visit everyday how many days would this affair last?","52764a1c":"### Some small changes in the distribution are there.","1f807388":"## Wave 1","17f7a40d":"## Wave 2","9200e91c":"## Santa's special surprise:\n\n1. Tours to his workshop from 100 days before Christmas.\n2. Extra perks for families that don't get their preference.\n3. Ten preferences for visit to each family.\n\n## Santa's constraints:\n\n1. 5000\/6000(wave1\/wave2) Families with variable number of members\n2. 100 Days only\n3. Cost attached to each family's visit must be limited\n4. Total number of people (not families) attending the workshop each day must be between 125 - 300\n5. Every family must be scheduled for one and only one assigned_day.\n\n## Let's lessen Santa's Workload\n\nSanta's accountants have devised a formula of how cost would be calculated which is given below. We need to minimise this cost. This sort of a problem where we need to minimise or maximise a function's value output is known as Optimisation problem in Mathematics","243915e2":"### Choice 2 for all families together is causing the biggest loss to Santa! That's not the same as last time.","1f799523":"# How big are the families?","ae947c9a":"## More Updates coming up soon!","6c9912b8":"## How do we help Santa?","6a565ea6":"### Choice 1 for all families together is causing the biggest loss to Santa by far!","18031e69":"## Wave 1","78a707fd":"## Wave 2","7a87d9ae":"## Wave 2","34c2f0a7":"## Wave 1","1c2498f9":"## Santa Business!","e869a628":"No missing values!","d5faacef":"Let's look at what the data is telling us first!","a416d1d3":"#### Simple Cost Function","5340485e":"## Wave 1 Cost Function","1469566f":"### What would the cost of assigning the same nth choice to each family be?","d67de722":"# Experiments with costs on the basis of choices","a1637ac7":"#### New Faster cost function","b1a8e63f":"## Wave 1","6c65cdfa":"# What is the total number of people visiting?"}}