{"cell_type":{"6c10f0e6":"code","6584ff66":"code","d2498dd1":"code","23574878":"code","9202456b":"code","f4b30e75":"code","988c7e17":"code","583d2580":"code","f631eb33":"code","56ea8178":"code","65a7e29d":"code","90744dcb":"code","1de4d4f2":"code","90cb8ee7":"code","a45a3710":"code","bad89a20":"code","4cb0469d":"code","97e0cbb7":"code","e1e46393":"code","9d1d60aa":"code","80f783ee":"code","d5372448":"code","d204199f":"code","e876b0e2":"code","13c25658":"code","af15032e":"code","e61f8c9b":"code","733cc990":"code","881e7a73":"code","0f9a6bae":"code","68f5109b":"code","6b8355ab":"code","14818f70":"code","4e2bddc5":"code","89a56ead":"code","2bd750fe":"code","7cf0bd2f":"code","405fa3ef":"code","dcc567a6":"code","938aeb8f":"code","88100b59":"code","feeaa37d":"code","fc5f4d00":"code","dbf6b555":"code","2d11ea02":"code","a078391b":"code","55baa08a":"code","e7d896c0":"code","4a0dfa37":"code","d68c7b86":"code","8d68e252":"code","03bbcd27":"code","c4515222":"code","89aa78fe":"code","e60016b8":"code","17413ae8":"code","02543532":"code","d18f8ced":"code","e1bc1f00":"code","6a8b9260":"code","46385b11":"code","90eed196":"code","683a38cd":"code","848cf189":"code","1de791ec":"code","d93538e5":"code","4cc75ead":"code","707ff5e2":"code","f6644d59":"code","d13baaa6":"code","4a0303f4":"code","512a1fdf":"markdown","5473112e":"markdown","ae0da344":"markdown","fc32e1ad":"markdown","37cde6b1":"markdown","c4d8f3c3":"markdown","0b5c5c71":"markdown"},"source":{"6c10f0e6":"import pandas as pd\nimport numpy as np\nfrom sklearn import preprocessing\nimport seaborn as sn\nimport matplotlib.pyplot as plt\nimport lightgbm as lgbm\nimport gc\nimport shap\nfrom hyperopt import hp, tpe, Trials, fmin\nfrom sklearn.model_selection import train_test_split, cross_val_score, GridSearchCV, StratifiedKFold, KFold\nfrom sklearn.metrics import make_scorer, mean_absolute_error","6584ff66":"def mae_score(truth, predictions):\n    return mean_absolute_error(truth, predictions)\n\ndef score(y_test, y_pred):\n    weights = X_test.isholiday.apply(lambda x: 5 if 1 else 1)\n    return np.round(np.sum(weights*abs(y_test-y_pred))\/(np.sum(weights)), 4)\n\ndef wmae_score(truth, predictions):\n    weights = X_train.isholiday.apply(lambda x: 5 if 1 else 1)\n    return np.round(np.sum(weights*abs(truth-predictions))\/(np.sum(weights)), 4)","d2498dd1":"stores = pd.read_csv('..\/input\/wallmart\/stores.csv', sep=',')","23574878":"stores.T.head()","9202456b":"base_treino = pd.read_csv('..\/input\/wallmart\/train.csv', sep=',')","f4b30e75":"base_treino.shape","988c7e17":"base_treino.head()","583d2580":"base_treino[base_treino['IsHoliday'] == True]","f631eb33":"base_feats = pd.read_csv('..\/input\/wallmart\/features.csv', sep=',')","56ea8178":"base_feats.head()","65a7e29d":"base_feats.shape","90744dcb":"base_feats.Store.value_counts()","1de4d4f2":"# stores = pd.read_csv('stores.csv', sep=',')\n# base_treino = pd.read_csv('train.csv', sep=',')\n# base_feats = pd.read_csv('features.csv', sep=',')","90cb8ee7":"base_treino = pd.merge(base_treino, stores, how='left', on = ['Store'])","a45a3710":"base_treino.head()","bad89a20":"base_treino = pd.merge(base_treino, base_feats.drop(['IsHoliday'], axis=1), how='left', on = ['Store','Date'])","4cb0469d":"base_treino.head()","97e0cbb7":"# base_treino['IsHoliday_x'].equals(base_treino['IsHoliday_y'])","e1e46393":"base_treino.dtypes","9d1d60aa":"base_treino['Date'] = pd.to_datetime(base_treino['Date'])","80f783ee":"base_treino.dtypes","d5372448":"base_treino['day'] = base_treino['Date'].dt.day\nbase_treino['month'] = base_treino['Date'].dt.month\nbase_treino['year'] = base_treino['Date'].dt.year","d204199f":"base_treino.head()","e876b0e2":"base_treino[\"Store_char\"] = base_treino[\"Store\"].astype(str) \nbase_treino[\"Dept_char\"] = base_treino[\"Dept\"].astype(str) \nbase_treino[\"Date\"] = base_treino[\"Date\"].astype(str)","13c25658":"base_treino['key'] = base_treino[['Store_char', 'Dept_char', 'Date']].agg('_'.join, axis=1)","af15032e":"base_treino.drop(['Store_char','Dept_char','Date'], axis=1, inplace=True)","e61f8c9b":"holiday = {False: 0, True: 1}\nbase_treino['isholiday'] = base_treino['IsHoliday'].map(holiday)\nbase_treino.drop(['IsHoliday'], axis=1, inplace=True)","733cc990":"tipo = {'A':1, 'B':2, 'C':3}\nbase_treino['type_num'] = base_treino['Type'].map(tipo)\n\n# le = preprocessing.LabelEncoder()\n# base_treino['type_num'] = le.fit_transform(base_treino.Type)","881e7a73":"base_treino.Type.value_counts()","0f9a6bae":"base_treino.type_num.value_counts()","68f5109b":"base_treino.drop(['Type'], axis=1, inplace=True)","6b8355ab":"list(base_treino.columns)","14818f70":"base_treino['rate_cpi_size'] = base_treino['Size'] \/ base_treino['CPI']","4e2bddc5":"base_treino.head()","89a56ead":"base_treino['holiday_type'] = np.nan","2bd750fe":"# Super Bowl 2-Feb-10, 11-Feb-11, 10-Feb-12, 8-Feb-13\nbase_treino.loc[(base_treino['day'] == 2) & (base_treino['month'] == 2) & (base_treino['year'] == 2010), 'holiday_type'] = 1\nbase_treino.loc[(base_treino['day'] == 11) & (base_treino['month'] == 2) & (base_treino['year'] == 2011), 'holiday_type'] = 1\nbase_treino.loc[(base_treino['day'] == 10) & (base_treino['month'] == 2) & (base_treino['year'] == 2012), 'holiday_type'] = 1","7cf0bd2f":"# Labor Day 10-Sep-10, 9-Sep-11, 7-Sep-12, 6-Sep-13\nbase_treino.loc[(base_treino['day'] == 10) & (base_treino['month'] == 9) & (base_treino['year'] == 2010), 'holiday_type'] = 2\nbase_treino.loc[(base_treino['day'] == 9) & (base_treino['month'] == 9) & (base_treino['year'] == 2011), 'holiday_type'] = 2\nbase_treino.loc[(base_treino['day'] == 7) & (base_treino['month'] == 9) & (base_treino['year'] == 2012), 'holiday_type'] = 2","405fa3ef":"# Thanksgiving 26-Nov-10, 25-Nov-11, 23-Nov-12, 29-Nov-13\nbase_treino.loc[(base_treino['day'] == 26) & (base_treino['month'] == 11) & (base_treino['year'] == 2010), 'holiday_type'] = 3\nbase_treino.loc[(base_treino['day'] == 25) & (base_treino['month'] == 11) & (base_treino['year'] == 2011), 'holiday_type'] = 3\nbase_treino.loc[(base_treino['day'] == 23) & (base_treino['month'] == 11) & (base_treino['year'] == 2012), 'holiday_type'] = 3","dcc567a6":"# Christmas 31-Dec-10, 30-Dec-11, 28-Dec-12, 27-Dec-13\nbase_treino.loc[(base_treino['day'] == 31) & (base_treino['month'] == 12) & (base_treino['year'] == 2010), 'holiday_type'] = 4\nbase_treino.loc[(base_treino['day'] == 30) & (base_treino['month'] == 12) & (base_treino['year'] == 2011), 'holiday_type'] = 4\nbase_treino.loc[(base_treino['day'] == 28) & (base_treino['month'] == 12) & (base_treino['year'] == 2012), 'holiday_type'] = 4","938aeb8f":"base_treino.month.value_counts()","88100b59":"base_treino['holiday_type'].value_counts()","feeaa37d":"base_treino.shape","fc5f4d00":"base_treino.head().T","dbf6b555":"base_treino.describe()","2d11ea02":"percent_missing = base_treino.isnull().sum() * 100 \/ len(base_treino)\nmissing_value_df = pd.DataFrame({'column_name': base_treino.columns,\n                                 'percent_missing': percent_missing})","a078391b":"missing_value_df","55baa08a":"corr_matrix = base_treino.drop('key', axis=1).corr()","e7d896c0":"fig, ax = plt.subplots(figsize=(14,8)) \nsn.heatmap(corr_matrix, annot=True, ax=ax)\nplt.show()","4a0dfa37":"cols_to_drop = [\n    'holiday_type',\n    'MarkDown1',\n    'MarkDown2',\n    'MarkDown3',\n    'MarkDown4',\n    'MarkDown5'\n]\n\nbase_treino.drop(cols_to_drop, axis=1, inplace=True)","d68c7b86":"base_treino.head()","8d68e252":"X_train, X_test, y_train, y_test = train_test_split(base_treino.fillna(0).drop(['key','Weekly_Sales'], axis=1),\n                                                    base_treino.Weekly_Sales,\n                                                    test_size = 0.3,\n                                                    random_state = 42)","03bbcd27":"best_mae = 0\nwmae_scorer = make_scorer(wmae_score, greater_is_better=True)\ndef objective(params):\n#     params['n_jobs'] = 10\n    params['boosting_type'] = 'gbdt'\n    params['num_leaves'] = int(params['num_leaves'])\n    params['n_estimators'] = int(params['n_estimators'])\n    params['max_depth'] = 8\n    params['subsample'] = 0.8\n    params['feature_fraction'] = 0.8\n    params['random_state'] = 42\n    \n    best_params['lambda_l1'] = 0.1\n    best_params['lambda_l2'] = 0.1\n    \n    reg = lgbm.LGBMRegressor(**params)\n    \n    global best_mae\n    \n    scores = cross_val_score(reg, X_train, y_train, scoring=wmae_scorer, cv=KFold(5))\n    score_avg = scores.mean()\n    score_std = scores.std()\n    \n    print('WMAE {:.5f} std{:.5f} params {}'.format(score_avg, score_std, params))\n    \n    best_err = score_avg\n    gc.collect()\n    return (score_avg)","c4515222":"space = {\n    'num_leaves': hp.quniform('num_leaves', 2, 20, 2),\n    'n_estimators': hp.quniform('n_estimators', 20, 200, 20),\n    'learning_rate': hp.uniform('learning_rate', 0.01, 0.1),\n}\n\nprint('Hyperopt')\nbest_params = {}\nbest_params = fmin(fn = objective,\n                   space = space,\n                   algo = tpe.suggest,\n                   max_evals = 12)\n\nbest_params['num_leaves'] = int(best_params['num_leaves'])\nbest_params['n_estimators'] = int(best_params['n_estimators'])\n\nbest_params['boosting_type'] = 'gbdt'\nbest_params['max_depth'] = 8\nbest_params['subsample'] = 0.8\nbest_params['feature_fraction'] = 0.8\nbest_params['random_state'] = 42\nbest_params['lambda_l1'] = 0.1\nbest_params['lambda_l2'] = 0.1\n\nreg = lgbm.LGBMRegressor(**best_params)\nprint('Fim de treinamento')","89aa78fe":"reg.fit(X_train, y_train)","e60016b8":"score(y_test, reg.predict(X_test.fillna(0)))","17413ae8":"explainer = shap.TreeExplainer(reg)","02543532":"shap_values = explainer.shap_values(X_train)","d18f8ced":"shap.summary_plot(shap_values, X_train)","e1bc1f00":"base_test = pd.read_csv('..\/input\/wallmart\/test.csv', sep=',')","6a8b9260":"base_test.shape","46385b11":"(115064\/421570)*100","90eed196":"base_test.head()","683a38cd":"base_test[base_test['IsHoliday'] == True]","848cf189":"8928\/29661","1de791ec":"def dataprep(base):\n    stores = pd.read_csv('..\/input\/wallmart\/stores.csv', sep=',')\n    base_feats = pd.read_csv('..\/input\/wallmart\/features.csv', sep=',')\n\n    base_teste = pd.merge(base, stores, how='left', on = ['Store'])\n\n    base_teste = pd.merge(base_teste, base_feats.drop(['IsHoliday'], axis=1), how='left', on = ['Store','Date'])\n\n    base_teste['Date'] = pd.to_datetime(base_teste['Date'])\n   \n    base_teste['day'] = base_teste['Date'].dt.day\n    base_teste['month'] = base_teste['Date'].dt.month\n    base_teste['year'] = base_teste['Date'].dt.year\n\n    base_teste[\"Store_char\"] = base_teste[\"Store\"].astype(str) \n    base_teste[\"Dept_char\"] = base_teste[\"Dept\"].astype(str) \n    base_teste[\"Date\"] = base_teste[\"Date\"].astype(str)\n\n    base_teste['key'] = base_teste[['Store_char', 'Dept_char', 'Date']].agg('_'.join, axis=1)\n\n    base_teste.drop(['Store_char','Dept_char','Date'], axis=1, inplace=True)\n\n    holiday = {False: 0, True: 1}\n    base_teste['isholiday'] = base_teste['IsHoliday'].map(holiday)\n    base_teste.drop(['IsHoliday'], axis=1, inplace=True)\n\n    tipo = {'A':1, 'B':2, 'C':3}\n    base_teste['type_num'] = base_teste['Type'].map(tipo)\n    base_teste.drop(['Type'], axis=1, inplace=True)\n\n    base_teste['rate_cpi_size'] = base_teste['Size'] \/ base_teste['CPI']\n\n    base_teste['holiday_type'] = np.nan\n\n    # Super Bowl 2-Feb-10, 11-Feb-11, 10-Feb-12, 8-Feb-13\n    base_teste.loc[(base_teste['day'] == 10) & (base_teste['month'] == 2) & (base_teste['year'] == 2012), 'holiday_type'] = 1\n    base_teste.loc[(base_teste['day'] == 8) & (base_teste['month'] == 2) & (base_teste['year'] == 2013), 'holiday_type'] = 1\n\n    # Labor Day 10-Sep-10, 9-Sep-11, 7-Sep-12, 6-Sep-13\n    base_teste.loc[(base_teste['day'] == 7) & (base_teste['month'] == 9) & (base_teste['year'] == 2012), 'holiday_type'] = 2\n    base_teste.loc[(base_teste['day'] == 6) & (base_teste['month'] == 9) & (base_teste['year'] == 2013), 'holiday_type'] = 2\n\n    # Thanksgiving 26-Nov-10, 25-Nov-11, 23-Nov-12, 29-Nov-13\n    base_teste.loc[(base_teste['day'] == 23) & (base_teste['month'] == 11) & (base_teste['year'] == 2012), 'holiday_type'] = 3\n    base_teste.loc[(base_teste['day'] == 29) & (base_teste['month'] == 11) & (base_teste['year'] == 2013), 'holiday_type'] = 3\n    \n    # Christmas 31-Dec-10, 30-Dec-11, 28-Dec-12, 27-Dec-13\n    base_teste.loc[(base_teste['day'] == 28) & (base_teste['month'] == 12) & (base_teste['year'] == 2012), 'holiday_type'] = 4\n    base_teste.loc[(base_teste['day'] == 27) & (base_teste['month'] == 12) & (base_teste['year'] == 2013), 'holiday_type'] = 4 \n \n    cols_to_drop = [\n        'holiday_type',\n        'MarkDown1',\n        'MarkDown2',\n        'MarkDown3',\n        'MarkDown4',\n        'MarkDown5'\n    ]\n    base_teste.drop(cols_to_drop, axis=1, inplace=True)\n\n    return base_teste","d93538e5":"backtest = dataprep(base_test)","4cc75ead":"backtest.shape","707ff5e2":"backtest.head()","f6644d59":"ID = []\nID = backtest.key\n\nws = []\nws = reg.predict(backtest.fillna(0).drop('key', axis=1))\n\ndf_test = pd.DataFrame({'Id': ID, 'Weekly_Sales': ws})","d13baaa6":"# df_test.to_csv('submission_7.csv', sep=',', index=False)","4a0303f4":"# df_test.shape","512a1fdf":"## 2. Dataprep","5473112e":"## Shap Values","ae0da344":"## Backtest","fc32e1ad":"## 1. Data Merge","37cde6b1":"## 3. Modelagem","c4d8f3c3":"## An\u00e1lises","0b5c5c71":"## Feature Engineering"}}