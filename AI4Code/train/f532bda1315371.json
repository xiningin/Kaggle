{"cell_type":{"f18519be":"code","a91fa79d":"code","5af7d7ae":"code","5a66fb7d":"code","8ed7e5ec":"code","3cfb26cd":"code","0fbf8f39":"code","324a4c01":"code","abce20ff":"code","b2f2f46d":"code","52e6c6ff":"code","59957c69":"code","d604a3fc":"code","74a1ee49":"code","3cdb6a9a":"code","9f1b9db1":"code","134dd8e0":"code","04693658":"code","de3d4558":"code","5ec567d4":"code","90296a4a":"code","693d10bc":"code","ea11ed27":"code","c712823f":"code","746e2721":"code","bfbe5822":"code","45454d25":"code","5c3353b6":"code","945f9c14":"code","bee4463c":"code","8a678702":"code","3ac0a735":"code","53bed5fd":"code","fcd59649":"markdown","7b81b8f5":"markdown","4ee6cb63":"markdown","152a83c5":"markdown","a3d9c22b":"markdown","a118595d":"markdown","ffa2c23c":"markdown","176123bf":"markdown"},"source":{"f18519be":"from tqdm import tqdm_notebook\nimport torch\nimport fastai\nfrom fastai.text import *\nfastai.__version__","a91fa79d":"train = pd.read_csv('..\/input\/train.csv').fillna(' ')\nvalid = pd.read_csv('..\/input\/valid.csv').fillna(' ')\ntest = pd.read_csv('..\/input\/test.csv').fillna(' ')","5af7d7ae":"pd.concat([train['text'], valid['text'], test['text']]).to_csv(\n    'unlabeled_news.csv', index=None, header=True)","5a66fb7d":"pd.concat([train[['text', 'label']],valid[['text', 'label']]]).to_csv(\n    'train_val.csv', index=None, header=True)\ntest[['text']].to_csv('test.csv', index=None, header=True)","8ed7e5ec":"folder = '.'\nunlabeled_file = 'unlabeled_news.csv'","3cfb26cd":"%%time\ndata_lm = TextLMDataBunch.from_csv(folder, unlabeled_file, text_cols='text')","0fbf8f39":"%%time\nlearn = language_model_learner(data_lm, drop_mult=0.3, arch=AWD_LSTM)","324a4c01":"%%time\nlearn.lr_find(start_lr = slice(10e-7, 10e-5), end_lr=slice(0.1, 10))","abce20ff":"learn.recorder.plot(skip_end=10, suggestion=True)","b2f2f46d":"best_lm_lr = 3e-3 #learn.recorder.min_grad_lr\n# best_lm_lr","52e6c6ff":"%%time\nlearn.fit_one_cycle(1, best_lm_lr)","59957c69":"learn.unfreeze()","d604a3fc":"%%time\nlearn.fit_one_cycle(5, best_lm_lr)","74a1ee49":"learn.predict('I really liked this cat food because', n_words=200)","3cdb6a9a":"learn.save_encoder('amazon_reviews_enc')","9f1b9db1":"train_file, test_file = 'train_val.csv', 'test.csv'","134dd8e0":"data_clas = TextClasDataBunch.from_csv(path=folder, \n                                        csv_name=train_file,\n                                        test=test_file,\n                                        vocab=data_lm.train_ds.vocab, \n                                        bs=64,\n                                        text_cols='text', \n                                        label_cols='label')","04693658":"data_clas.save('ulmfit_data_clas_amazon_reviews')","de3d4558":"learn_clas = text_classifier_learner(data_clas, drop_mult=0.3, arch=AWD_LSTM)\nlearn_clas.load_encoder('amazon_reviews_enc')","5ec567d4":"learn_clas.lr_find(start_lr=slice(10e-7, 10e-5), end_lr=slice(0.1, 10))","90296a4a":"learn_clas.recorder.plot(skip_end=10, suggestion=True)","693d10bc":"best_clf_lr = 3e-3 #learn_clas.recorder.min_grad_lr\n# best_clf_lr","ea11ed27":"learn_clas.fit_one_cycle(1, best_clf_lr)","c712823f":"learn_clas.freeze_to(-2)","746e2721":"learn_clas.fit_one_cycle(1, best_clf_lr)","bfbe5822":"# learn_clas.unfreeze()","45454d25":"learn_clas.fit_one_cycle(5, best_clf_lr)","5c3353b6":"learn_clas.show_results()","945f9c14":"data_clas.add_test(test[\"text\"])","bee4463c":"test_preds, _ = learn_clas.get_preds(DatasetType.Test, ordered=True)","8a678702":"test_pred_df = pd.DataFrame(test_preds.data.cpu().numpy(),\n                            columns=['birds', 'bunny rabbit central', 'cats', 'dogs', 'fish aquatic pets', 'small animals'])\nulmfit_preds = pd.Series(np.argmax(test_pred_df.values, axis=1),\n                        name='label').map({0: 'birds', 1: 'bunny rabbit central', 2: 'cats', 3: 'dogs', 4: 'fish aquatic pets', 5: 'small animals'})\n","3ac0a735":"ulmfit_preds.head()","53bed5fd":"ulmfit_preds.to_csv('ulmfit_predictions.csv', index_label='id', header=True)","fcd59649":"# Reading unlabeled data to train ULMFiT language model","7b81b8f5":"# LM training \n\nHere we resort to the training scheme described by Jeremy Howard, [fast.ai](https:\/\/course.fast.ai\/):\n - finding good initial learning rate\n - training for one epoch\n - unfreezing and more training\n","4ee6cb63":"# Training classification head\n\nHere again we follow Jeremy Howard. \n\n**How to do better:** hyperparam tuning (though it's extremely annoying with such a heavy model), more epochs after unfreezing, check for some live examples of ULMFiT training, different learning rates for different layers etc.","152a83c5":"# Predictions for the test set\n","a3d9c22b":"# Preprocessing\nHere we write all news texts from train, validation and text files into `unlabeled_news.csv` - to train a language model.\n\nThen, we write texts and labels into `train_val.csv` and texts only into `test.csv`.\n\n**How to do better:** go for that big unlabeled set as well.","a118595d":"# Generating some text\n\nIt's always interesting to see whether a LM is able to generate nice text. With LM training improvement (in terms of loss), at some point you'll notice some nice improvement in quality of the generated text.\n\nNo much sense, but at least some structure :) And now with GPT-2 we see that quantitative improvements can also lead to qualital improvements.","ffa2c23c":"# Forming a submission file","176123bf":"# <center> Amazon product reviews classification with ULMFiT. Starter\n\nHere we mostly follow the training scheme described by Jeremy Howard in [fast.ai Lesson 4](https:\/\/course.fast.ai\/videos\/?lesson=4): taking a pretrained language model, fine-tuning it with unlabeled data, then fine-tuning classification head for our particular task.\n\nThis is just a starter. At each step, I also mention how you can do better."}}