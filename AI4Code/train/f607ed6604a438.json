{"cell_type":{"f87d950f":"code","9d176760":"code","ebb3da70":"code","70a76898":"code","f415fb3d":"code","e5a65f1d":"code","d8b290b2":"code","27ec8847":"code","0b42cdf3":"code","be382d12":"code","8a01b542":"code","cf94dd86":"code","c7e78171":"code","0cb49629":"code","a5d45653":"code","7da2b3b8":"code","d9322451":"code","c4f375ff":"code","651bb07e":"code","3b5e4c26":"code","e8159f09":"code","9c8bc99c":"code","ef705e28":"code","1c62315e":"code","27872551":"code","9ab9ddad":"code","d6c68130":"code","7ba9e70f":"code","bb7bb421":"code","016e05d1":"code","adb851aa":"code","a121a1d1":"code","0ac47a7b":"code","da73edba":"code","f439a782":"code","e2144b76":"code","a5c7afdb":"code","3b1bc1ca":"code","c19dba1f":"code","3936e354":"code","af663f48":"markdown","70885654":"markdown","a4e14681":"markdown","972f0979":"markdown","18becd07":"markdown","7029424d":"markdown","add5600e":"markdown","44eaf419":"markdown","1e80113b":"markdown","d7b20267":"markdown","92d3fce1":"markdown","9904adc5":"markdown","668faac3":"markdown","ddca1feb":"markdown","8c20815f":"markdown","38c88db0":"markdown","7cd1b819":"markdown"},"source":{"f87d950f":"import pandas as pd\nimport numpy as np\nimport matplotlib.pyplot as plt\nimport seaborn as sns\nimport warnings\nimport datetime as dt\nwarnings.filterwarnings(\"ignore\", category=DeprecationWarning)\nwarnings.simplefilter(\"ignore\")","9d176760":"customers_raw = pd.read_csv(\"..\/input\/brazilian-ecommerce\/olist_customers_dataset.csv\")\norders_raw = pd.read_csv(\"..\/input\/brazilian-ecommerce\/olist_orders_dataset.csv\", parse_dates = ['order_purchase_timestamp'])\norderItems_raw = pd.read_csv(\"..\/input\/brazilian-ecommerce\/olist_order_items_dataset.csv\")","ebb3da70":"# Check the structure of the data\ncustomers_raw.info()\n# Inspect the data\ncustomers_raw.describe(include='all')","70a76898":"customers = customers_raw[['customer_id', 'customer_unique_id']]\ncustomers.head()","f415fb3d":"# Check the structure of the data\norders_raw.info()\n# Inspect the data\norders_raw.describe(include='all')","e5a65f1d":"orders_raw['order_status'].unique()","d8b290b2":"orders_raw = orders_raw[orders_raw.order_status != 'canceled']\norders_raw['date'] = pd.to_datetime(orders_raw['order_purchase_timestamp']).dt.date","27ec8847":"orders = orders_raw[['order_id', 'customer_id','date']]\norders.head()","0b42cdf3":"orderItems_raw.info()\norderItems_raw.head()","be382d12":"orderItems_raw['order_id'].nunique()","8a01b542":"orderTrans = orderItems_raw.groupby(['order_id']).agg({'price':'sum'}).reset_index()\norderTrans.rename(columns={'price':'revenue'}, inplace = True)\norderTrans","cf94dd86":"orderDetails = pd.merge(orders, orderTrans, on = 'order_id', how = 'left')\norderDetails","c7e78171":"orderCusDetails_raw = pd.merge(customers, orderDetails, on = 'customer_id', how = 'left')\norderCusDetails_raw","0cb49629":"# Testing\norderCusDetails_raw[orderCusDetails_raw['customer_unique_id'] == '12f5d6e1cbf93dafd9dcc19095df0b3d']","a5d45653":"orderCusDetails = orderCusDetails_raw.groupby(['customer_unique_id','date']).agg({'revenue':'sum'}).reset_index()\norderCusDetails","7da2b3b8":"# Testing\norderCusDetails[orderCusDetails['customer_unique_id'] == '12f5d6e1cbf93dafd9dcc19095df0b3d']","d9322451":"orderCusDetails['customer_unique_id'].nunique()","c4f375ff":"df = orderCusDetails.copy()","651bb07e":"print('Min : {}, Max : {}'.format(min(df['date']), max(df['date'])))\nlastDate = max(df['date']) + dt.timedelta(1)\nprint(lastDate)","3b5e4c26":"df1 = df.groupby('customer_unique_id') .agg({'date': lambda x:(lastDate - x.min()).days}).reset_index()\ndf1.rename(columns = {'date':'T'}, inplace = True)\ndf1","e8159f09":"df2 = df.groupby('customer_unique_id').agg({'date': lambda x:(x.max() - x.min()).days}).reset_index()\ndf2.rename(columns = {'date':'recency'}, inplace = True)\ndf2","9c8bc99c":"# Testing\n# df2[df2['customer_unique_id'] == '12f5d6e1cbf93dafd9dcc19095df0b3d']\ndf2[df2['recency'] != 0]","ef705e28":"df3 = df.groupby(['customer_unique_id']).agg({'date': 'count',                                             \n                                             'revenue':'sum'}).reset_index()\ndf3.rename(columns = {'date':'frequency','revenue':'total_monetary'}, inplace = True)\ndf3","1c62315e":"df3['avg_monetary'] = df3['total_monetary'] \/ df3['frequency']\ndf3['frequency'] = df3['frequency'] - 1\ndf3 = df3.drop(columns=['total_monetary'])\ndf3","27872551":"# Testing\n# df3[df3['frequency'] != 0]\ndf3[df3['customer_unique_id'] == '02168ea18740a0fdaaa15f11bebba5db']","9ab9ddad":"df_combined1 = pd.merge(df1, df2, on = 'customer_unique_id', how = 'outer')\ndf_combined2 = pd.merge(df_combined1, df3, on = 'customer_unique_id', how = 'outer')\ndf_combined2","d6c68130":"# Testing\norderCusDetails[orderCusDetails['customer_unique_id'] == 'ff922bdd6bafcdf99cb90d7f39cea5b3']","7ba9e70f":"# Testing\ndf_combined2[df_combined2['recency'] != 0]","bb7bb421":"pip install lifetimes ","016e05d1":"import lifetimes","adb851aa":"from lifetimes import BetaGeoFitter\n\nbgf = BetaGeoFitter(penalizer_coef = 0.001)\nbgf.fit(df_combined2['frequency'], df_combined2['recency'], df_combined2['T'])\nprint(bgf)\nbgf.summary","a121a1d1":"from lifetimes.plotting import plot_frequency_recency_matrix\n\nplot_frequency_recency_matrix(bgf)","0ac47a7b":"from lifetimes.plotting import plot_probability_alive_matrix\n\nplot_probability_alive_matrix(bgf)","da73edba":"t = 1\ndf_combined2['predicted_purchases'] = bgf.conditional_expected_number_of_purchases_up_to_time(t, df_combined2['frequency'], df_combined2['recency'], df_combined2['T'])\ndf_combined2.sort_values(by='predicted_purchases', ascending=False).head()","f439a782":"t = 100 #predict purchases in 100 days\nindividual = df_combined2.iloc[66666]\n# The below function is an alias to `bfg.conditional_expected_number_of_purchases_up_to_time`\nbgf.predict(t, individual['frequency'], individual['recency'], individual['T'])","e2144b76":"returning_customers_summary = df_combined2[(df_combined2['frequency'] > 0) & (df_combined2['avg_monetary'] > 0)]\nreturning_customers_summary.head()","a5c7afdb":"returning_customers_summary[['avg_monetary', 'frequency']].corr()","3b1bc1ca":"from lifetimes import GammaGammaFitter\n\nggf = GammaGammaFitter(penalizer_coef = 0)\nggf.fit(returning_customers_summary['frequency'],\n        returning_customers_summary['avg_monetary'])\nprint(ggf)","c19dba1f":"ggf.conditional_expected_average_profit(\n         returning_customers_summary['frequency'],\n         returning_customers_summary['avg_monetary']).head()","3936e354":"print(\"Expected conditional average profit: %s, Average profit: %s\" % (\n    ggf.conditional_expected_average_profit(\n        df_combined2['frequency'],\n        df_combined2['avg_monetary']\n    ).mean(),\n    df_combined2[df_combined2['frequency']>0]['avg_monetary'].mean()\n))\n","af663f48":"### Visualizing Frequency\/Recency Matrix\n\nwhich computes the expected number of transactions an artificial customer is to make in the next time period, given his or her recency and frequency. ","70885654":"#### Expected Number of Future Purchases for 1 Unit of Time","a4e14681":"# Estimating Customer Lifetime Value Using the Gamma-Gamma Model\n\nThis model assumes that there is no relationship between the monetary value and the purchase frequency. \nIn practice we need to check whether the Pearson correlation between the two vectors is close to 0 in order to use this model.","972f0979":"Combine Orders dataset with OrderItems dataset to get the revenue of each orders ","18becd07":"# Frequency & Recency Analysis using BG\/NBD Model\n\n#### BG\/NBD Model 5 Assumptions:\n1. While active, the number of transactions made by a customer follows a Poisson process with transaction rate . This is equivalent to assuming that the time between transactions is distributed exponential with transaction rate \u03bb\n2. Heterogeneity in  follows a gamma distribution with pdf\n3. After any transaction, a customer becomes inactive with probability p. Therefore, the point at which the customer \u201cdrops out\u201d is distributed across transactions according to a (shifted) geometric distribution with pmf P inactive immediately after jth transaction\n4. Heterogeneity in p follows a beta distribution with pdf\n5. The transaction rate and the dropout probability p vary independently across customers\n\n#### The following nomenclature is used:\n\n**Frequency** represents the number of repeat purchases the customer has made. This means that it\u2019s one less than the total number of purchases. This is actually slightly wrong. It\u2019s the count of time periods the customer had a purchase in. So if using days as units, then it\u2019s the count of days the customer had a purchase on.\n\n**T** represents the age of the customer in whatever time units chosen (weekly, in the above dataset). This is equal to the duration between a customer\u2019s first purchase and the end of the period under study.\n\n**Recency** represents the age of the customer when they made their most recent purchases. This is equal to the duration between a customer\u2019s first purchase and their latest purchase. (Thus if they have made only 1 purchase, the recency is 0.)\n\n**Monetary** represents the average value of a given customer\u2019s purchases. This is equal to the sum of all a customer\u2019s purchases divided by the total number of purchases. Note that the denominator here is different than the frequency described above.\n\n","7029424d":"We can see that if a customer has bought 15 times from us, and their latest purchase was when they were 700 days old, then they are our best customer (bottom-right).\n\nArea around (4,350) - Customers who buy infrequently, but we've seem them recently. They might be dead or just between purchases","add5600e":"# Basic Frequency\/Recency Analysis","44eaf419":"# Objectives\n\nBuild a probabilistic model to predict customer lifetime value for non-contractual business \n\n* Find out who are most likely to buy again \n* Estimate Customer Lifetime Value\n* Calculate expected average profit per customer ","1e80113b":"Since the correlation between monetary and frequency is not strong, we can use Gamma-Gamma model to predict the conditional, expected average lifetime value of customers ","d7b20267":"Filter orders by order_status. Here we will exclude orders with 'canceled' as order_status. We have to consider fraud in real live situation. Since we don't have much information about the status in this dataset, we are going to be inclusive about the orders. \n\nWe will use order_purchase_timestamp as date","92d3fce1":"These are the customers who are probably going to buy again in the next period. ","9904adc5":"# Import Packages and Data Processing \n","668faac3":"# References:\n1. https:\/\/lifetimes.readthedocs.io\/en\/latest\/Quickstart.html#estimating-customer-lifetime-value-using-the-gamma-gamma-model\n2. \u201cCounting Your Customers\u201d the Easy Way: An Alternative to the Pareto\/NBD Model by Fader et al. in 2005. http:\/\/brucehardie.com\/papers\/018\/fader_et_al_mksc_05.pdf\n\n","ddca1feb":"#### Predicting Customer's Future Behavior","8c20815f":"#### Customers Who Will Most Lilely to Buy Again","38c88db0":"#### Probability of Still Being Alive","7cd1b819":"# Data Scource\nBrazilian E-Commerce Public Dataset by Olist \n<br \/> 100,000 Orders with product, customer and reviews info\n<br \/> https:\/\/www.kaggle.com\/olistbr\/brazilian-ecommerce?select=olist_order_items_dataset.csv"}}