{"cell_type":{"962b25ee":"code","1af3ef66":"code","c2c2ec35":"code","f3d2bee9":"code","ae581e9f":"code","56821c4c":"code","138135e7":"code","9246dfdc":"code","d47b9ae9":"code","27a6dee2":"code","ea96af3a":"code","07f70b44":"code","e177eaed":"code","b587886d":"code","bc972451":"code","03669789":"code","194c1da7":"code","547faeab":"code","40f7cc8e":"code","c24a4e21":"code","9f8d3728":"code","401b1645":"code","93b6d045":"markdown","0aeb393d":"markdown","988a83f4":"markdown","82343baf":"markdown","119b886c":"markdown","819f6a87":"markdown","42569faf":"markdown","d2ffa88c":"markdown","aebe12c6":"markdown","926b151b":"markdown","d5e44f8c":"markdown","0b8999d7":"markdown","2594f65e":"markdown"},"source":{"962b25ee":"import numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\nfrom tqdm import tqdm_notebook","1af3ef66":"MODEL_URL = \"https:\/\/github.com\/huggingface\/neuralcoref-models\/releases\/\" \\\n            \"download\/en_coref_md-3.0.0\/en_coref_md-3.0.0.tar.gz\"","c2c2ec35":"!pip install spacy==2.0.12","f3d2bee9":"!pip install {MODEL_URL}","ae581e9f":"!python -m spacy download en_core_web_md","56821c4c":"import en_coref_md\n\nnlp = en_coref_md.load()","138135e7":"test_sent = \"The doctor came in. She held a paper in her hand.\"","9246dfdc":"doc = nlp(test_sent)","d47b9ae9":"doc._.has_coref","27a6dee2":"doc._.coref_clusters","ea96af3a":"doc._.coref_clusters[0].main","07f70b44":"doc._.coref_clusters[0].mentions","e177eaed":"def is_inside(offset, span):\n    return offset >= span[0] and offset <= span[1]\n\ndef is_a_mention_of(sent, pron_offset, entity_offset_a, entity_offset_b):\n    doc = nlp(sent)\n    if doc._.has_coref:\n        for cluster in doc._.coref_clusters:\n            main = cluster.main\n            main_span = main.start_char, main.end_char\n            mentions_spans = [(m.start_char, m.end_char) for m in cluster.mentions \\\n                              if (m.start_char, m.end_char) != main_span]\n            if is_inside(entity_offset_a, main_span) and \\\n                    np.any([is_inside(pron_offset, s) for s in mentions_spans]):\n                return \"A\"\n            elif is_inside(entity_offset_b, main_span) and \\\n                    np.any([is_inside(pron_offset, s) for s in mentions_spans]):\n                return \"B\"\n            else:\n                return \"NEITHER\"\n    else:\n        return \"NEITHER\"","b587886d":"# \"The doctor came in. She held a paper in her hand.\"\nentity_offset_a = test_sent.index(\"doctor\")\nentity_offset_b = test_sent.index(\"paper\")\npron_offset = test_sent.index(\"She\")\n\nis_a_mention_of(test_sent, pron_offset, entity_offset_a, entity_offset_b)","bc972451":"gap_train = pd.read_csv(\"https:\/\/raw.githubusercontent.com\/google-research-datasets\/gap-coreference\/master\/gap-test.tsv\", \n                       delimiter='\\t', index_col=\"ID\")","03669789":"gap_train.head()","194c1da7":"def predict(df):\n    pred = pd.DataFrame(index=df.index, columns=[\"A\", \"B\", \"NEITHER\"]).fillna(False)\n    for i, row in tqdm_notebook(df.iterrows()):\n        pred.at[i, is_a_mention_of(row[\"Text\"], row[\"Pronoun-offset\"], row[\"A-offset\"], row[\"B-offset\"])] = True\n    return pred","547faeab":"train_preds = predict(gap_train)","40f7cc8e":"gap_train[\"NEITHER\"] = np.logical_and(~gap_train[\"A-coref\"], ~gap_train[\"B-coref\"])","c24a4e21":"gap_train[[\"A-coref\", \"B-coref\", \"NEITHER\"]].describe()","9f8d3728":"train_preds.describe()","401b1645":"from sklearn.metrics import classification_report\nprint(classification_report(gap_train[[\"A-coref\", \"B-coref\", \"NEITHER\"]], train_preds[[\"A\", \"B\", \"NEITHER\"]]))","93b6d045":"A small test:","0aeb393d":"## Deciding which entity the pronoun refers to\n\nIn competition data, the position of the entities and the pronoun comes as an offset from the beginning. Let's write a small function that will resolve coreference in a string and decide whether any of detected coreferring entities correspond to given offsets.\n","988a83f4":"## Testing on the dataset ","82343baf":"Great! We found something, let's see what exactly:","119b886c":"We can see that though precision is quite good, we have very low recall. What can be done?\n1. Remove excessive sentenes: if entities and the pronoun are contained in two sentences, we can strip other sentences.\n2. Use neuralcoref's verdicts as a feature for another classifier (we would have to transform verdicts into probabilities anyway).","819f6a87":"To check if any kind of coreference was detected, `has_coref` attribute of the extension (referred to as `_`) is used:","42569faf":"You can get the entity and coreferring pronouns from these clusters by simple indexing. The objects returned are in fact ordinary spacy `span`s.","d2ffa88c":"## A small neuralcoref tutorial\n\nHow does this lib work? Let's find out!\n\nFirst,we need to load the model:","aebe12c6":"You can go to the [website](https:\/\/huggingface.co\/coref\/?text=The%20doctor%20came%20in.%20She%20held%20a%20paper%20in%20her%20hand.) and play with the tool. It outputs cool resolution graphs like this one:\n\n![graph](http:\/\/i66.tinypic.com\/wtbmdi.png)","926b151b":"# Resolving coreference with neuralcoref","d5e44f8c":"There are few out-of-the-box libraries that support or specifically built for coreference resolution. Most wide-known are [CoreNLP](https:\/\/stanfordnlp.github.io\/CoreNLP\/coref.html), [Apache OpenNLP](https:\/\/opennlp.apache.org\/) and [neuralcoref](https:\/\/github.com\/huggingface\/neuralcoref). In this short notebook, we will explore neuralcoref 3.0, a coreference resolution library by Huggingface.\n\nFirst, let's install neuralcoref 3.0. To do this, we need to slightly downgrade spacy (neuralcoref is not compatible with the new cymem version used by the current version of spacy).","0b8999d7":"Using neuralcoref is not really different from using plain spacy.","2594f65e":"Now we need a sentence with coreference. \n\nA boring theoretical reminder: coreference happens when* two different words denote the same entity* in the real world. In this competition, we deal with pronomial coreference. It comes in two flavors:\n1. *Anaphora*, when a pronoun follows a noun: \"John looked at me. He was clearly angry\".\n2. *Cataphora*, when it is vice versa: \"When she opened the door, Jane realized that it was cold outside\"\n\nLet's start with two simple sentences with two anaphoric coreferences:"}}