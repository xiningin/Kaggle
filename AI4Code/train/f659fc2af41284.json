{"cell_type":{"2434e874":"code","8f9abcfb":"code","0bbf80e2":"code","1eea4ac8":"code","82e06e17":"code","1107dfe4":"code","7cc31a39":"code","8a90abe1":"code","a8380530":"code","d1f6da01":"code","d5f7de6f":"code","03a0df33":"code","0c89c9d0":"code","c7815395":"code","9c7aa552":"code","c221b91e":"code","5d6c7084":"code","982707ad":"code","5a36bb80":"code","2b7835e4":"code","50010adb":"code","a026651c":"code","47649393":"code","def953f9":"code","6c6b72e3":"code","09871ea4":"code","d76f94f1":"code","f7142485":"code","7b17a862":"code","c4eec166":"code","90a619c0":"code","e8377063":"code","f89face8":"code","1c2af556":"code","0777178a":"code","84a5e188":"code","4632edd0":"code","e856d4a3":"code","dbaa5d5a":"code","2d4f3d90":"code","6b0db6d8":"code","666f4b39":"code","310a5bbf":"code","87417571":"code","b7dfdef0":"code","8e08e898":"code","694b24c5":"code","2470be30":"code","f2f6d088":"code","7978d4b3":"markdown","00003861":"markdown","e6c8eef0":"markdown","e959a0f9":"markdown","d78789be":"markdown","70af2c4d":"markdown","de475fb3":"markdown","2cae18b0":"markdown","fef5d5fa":"markdown","c413e219":"markdown","e062adeb":"markdown","f7d8b68a":"markdown","5faf43af":"markdown","53d3870d":"markdown","6fa1ef5c":"markdown","8d9529bd":"markdown","5cd7d81f":"markdown","d736b8b9":"markdown","fd299c65":"markdown","6b9c4a74":"markdown","9afb0287":"markdown","0cf7cac5":"markdown","fd7d21f6":"markdown","bd22445b":"markdown","fd11359f":"markdown","d66f66e4":"markdown"},"source":{"2434e874":"import os, time, sys, gc\nfrom tqdm import tqdm_notebook as tqdm\nimport pandas as pd\nimport numpy as np\nimport matplotlib.pyplot as plt\nfrom tqdm.notebook import tqdm\nimport seaborn as sns\nfrom bokeh.plotting import figure, show, output_file\nfrom bokeh.layouts import gridplot, column, layout, row\nfrom bokeh.io import output_notebook, curdoc, push_notebook\nfrom bokeh.models import ColumnDataSource, FixedTicker, PrintfTickFormatter, Select, CustomJS, HoverTool\nfrom scipy.stats.kde import gaussian_kde\nimport colorcet as cc\n#wave analysis\nimport pywt \nfrom statsmodels.robust import mad\nimport statsmodels.api as sm\nimport scipy\nfrom scipy import stats \nfrom scipy import signal\nfrom scipy.signal import hann, hilbert, convolve, butter, deconvolve","8f9abcfb":"for dirname, _, filenames in os.walk('\/kaggle\/input'):\n    for filename in filenames:\n        print(os.path.join(dirname, filename))\nINPUTDIR = '\/kaggle\/input\/liverpool-ion-switching\/'\nINPUTDIR2 = '\/kaggle\/input\/data-without-drift\/'\nNROWS=None","0bbf80e2":"%%time\ndf_train = pd.read_csv(f'{INPUTDIR}\/train.csv', nrows=NROWS, dtype={'time':np.float32, 'signal':np.float32})\ndf_test = pd.read_csv(f'{INPUTDIR}\/test.csv', nrows=NROWS, dtype={'time':np.float32, 'signal':np.float32})\ndf_train_clean = pd.read_csv(f'{INPUTDIR2}\/train_clean.csv', nrows=NROWS, dtype={'time':np.float32, 'signal':np.float32})\ndf_test_clean = pd.read_csv(f'{INPUTDIR2}\/test_clean.csv', nrows=NROWS, dtype={'time':np.float32, 'signal':np.float32})\nsub_df = pd.read_csv(f'{INPUTDIR}\/sample_submission.csv', nrows=NROWS)","1eea4ac8":"print(df_train.columns)\nprint(df_test.columns)\nprint(df_train_clean.columns)\nprint(df_test_clean.columns)\nprint(df_train.shape)\nprint(df_test.shape)","82e06e17":"output_notebook()","1107dfe4":"start = 0\nend = len(df_train)\nres = int(end\/1000000)\nplot_size_and_tools = {'plot_height': 200, 'plot_width': 750,\n                        'tools':['box_zoom', 'reset', 'crosshair','help']}\n\nsource = ColumnDataSource(data=dict(x=list(range(start,end,res)), \n                                    y0=df_train['signal'].values[start:end:res],\n                                    y1=df_train['open_channels'].values[start:end:res]))\n\np1 = figure(title='Train Signal',**plot_size_and_tools)\np1.add_tools(HoverTool())\np1.line('x', 'y0', line_width=1, color = 'red', source=source)\np1.yaxis.axis_label = 'Signal Strength'\np2 = figure(title='Open_Channels',**plot_size_and_tools, x_range=p1.x_range, y_range=p1.y_range)\np2.add_tools(HoverTool())\np2.line('x', 'y1', line_width=1, color = 'black', source=source)\np2.xaxis.axis_label = 'Time'\np2.yaxis.axis_label = 'Opened Channel'\np = gridplot([p1, p2],ncols=1, toolbar_location='right')\nshow(p)","7cc31a39":"gc.collect()","8a90abe1":"start = 0\nend = len(df_train)\nres = int(end\/1000000)\nplot_size_and_tools = {'plot_height': 200, 'plot_width': 750,\n                        'tools':['box_zoom', 'reset', 'crosshair','help']}\n\nsource = ColumnDataSource(data=dict(x=list(range(start,end,res)), \n                                    y0=df_train_clean['signal'].values[start:end:res],\n                                    y1=df_train_clean['open_channels'].values[start:end:res]))\n\np1 = figure(title='Train Signal(w\/o drift)',**plot_size_and_tools)\np1.add_tools(HoverTool())\np1.line('x', 'y0', line_width=1, color = 'orange', source=source)\np1.yaxis.axis_label = 'Signal Strength'\np2 = figure(title='Open_Channels',**plot_size_and_tools, x_range=p1.x_range, y_range=p1.y_range)\np2.add_tools(HoverTool())\np2.line('x', 'y1', line_width=1, color = 'black', source=source)\np2.xaxis.axis_label = 'Time'\np2.yaxis.axis_label = 'Opened Channel'\np = gridplot([p1, p2],ncols=1, toolbar_location='right')\nshow(p)","a8380530":"def low_pass_filter(x, high_cutoff, SAMPLE_RATE):\n    \"\"\"\n    From @randxie https:\/\/github.com\/randxie\/Kaggle-VSB-Baseline\/blob\/master\/src\/utils\/util_signal.py\n    Modified to work with scipy version 1.1.0 which does not have the fs parameter\n    \"\"\"\n    \n    # nyquist frequency is half the sample rate https:\/\/en.wikipedia.org\/wiki\/Nyquist_frequenc\n    nyquist = 0.5 * SAMPLE_RATE\n    norm_high_cutoff = high_cutoff \/ nyquist\n    \n    # Fault pattern usually exists in high frequency band. According to literature, the pattern is visible above 10^4 Hz.\n    sos = butter(10, Wn=[norm_high_cutoff], btype='lowpass', output='sos')\n    filtered_sig = signal.sosfilt(sos, x)\n\n    return filtered_sig","d1f6da01":"start = 3640000\nend = 3830000\nres = int(len(df_train)\/1000000)\nplot_size_and_tools = {'plot_height': 200, 'plot_width': 750,\n                        'tools':['box_zoom', 'reset', 'crosshair','help']}\n\nsource = ColumnDataSource(data=dict(x=list(range(start,end,res)), \n                                    y0=df_train_clean['signal'].values[start:end:res] - df_train_clean['signal'].shift(1).values[start:end:res],\n                                    y1=df_train_clean['open_channels'].values[start:end:res] ))\n\np1 = figure(title='Train Signal(w\/o drift)',**plot_size_and_tools)\np1.add_tools(HoverTool())\np1.line('x', 'y0', line_width=1, color = 'orange', source=source)\np1.yaxis.axis_label = 'Signal Strength'\np2 = figure(title='Open_Channels',**plot_size_and_tools, x_range=p1.x_range, y_range=p1.y_range)\np2.add_tools(HoverTool())\np2.line('x', 'y1', line_width=1, color = 'black', source=source)\np2.xaxis.axis_label = 'Time'\np2.yaxis.axis_label = 'Opened Channel'\np = gridplot([p1, p2],ncols=1, toolbar_location='right')\nshow(p)","d5f7de6f":"start = 3640000\nend = 3830000\nres = int(len(df_train)\/1000000)\nplot_size_and_tools = {'plot_height': 200, 'plot_width': 750,\n                        'tools':['box_zoom', 'reset', 'crosshair','help']}\n\nsource = ColumnDataSource(data=dict(x=list(range(start,end,res)), \n                                    y0= np.abs(np.fft.fft(df_train_clean['signal'].values[start:end:res] - df_train_clean['signal'].shift(1).values[start:end:res])),\n                                    y1=df_train_clean['open_channels'].values[start:end:res] ))\n\np1 = figure(title='Train Signal(w\/o drift)',**plot_size_and_tools)\np1.add_tools(HoverTool())\np1.line('x', 'y0', line_width=1, color = 'orange', source=source)\np2.xaxis.axis_label = 'Freq'\np1.yaxis.axis_label = 'FFT amplitude'\np2 = figure(title='Open_Channels',**plot_size_and_tools, x_range=p1.x_range, )\np2.add_tools(HoverTool())\np2.line('x', 'y1', line_width=1, color = 'black', source=source)\np2.xaxis.axis_label = 'Time'\np2.yaxis.axis_label = 'Opened Channel'\np = gridplot([p1, p2],ncols=1, toolbar_location='right')\nshow(p)","03a0df33":"start = 3640000\nend = 3830000\nres = int(len(df_train)\/1000000)\nplot_size_and_tools = {'plot_height': 200, 'plot_width': 750,\n                        'tools':['box_zoom', 'reset', 'crosshair','help']}\n\nsource = ColumnDataSource(data=dict(x=list(range(start,end,res)), \n                                    y0= low_pass_filter(df_train_clean['signal'].values[start:end:res] - df_train_clean['signal'].shift(1).values[start:end:res],1000 ,40000),\n                                    y1=df_train_clean['open_channels'].values[start:end:res] ))\n\np1 = figure(title='Train Signal(w\/o drift)',**plot_size_and_tools)\np1.add_tools(HoverTool())\np1.line('x', 'y0', line_width=1, color = 'orange', source=source)\np2.xaxis.axis_label = 'Freq'\np1.yaxis.axis_label = 'FFT amplitude'\np2 = figure(title='Open_Channels',**plot_size_and_tools, x_range=p1.x_range, )\np2.add_tools(HoverTool())\np2.line('x', 'y1', line_width=1, color = 'black', source=source)\np2.xaxis.axis_label = 'Time'\np2.yaxis.axis_label = 'Opened Channel'\np = gridplot([p1, p2],ncols=1, toolbar_location='right')\nshow(p)","0c89c9d0":"start = 0\nend = len(df_train)\nres = int(len(df_train)\/1000000)\nplot_size_and_tools = {'plot_height': 200, 'plot_width': 750,\n                        'tools':['box_zoom', 'reset', 'crosshair','help']}\n\nsource = ColumnDataSource(data=dict(x=list(range(start,end,res)), \n                                    y0= low_pass_filter(df_train_clean['signal'].values[start:end:res] - df_train_clean['signal'].shift(1).fillna(0).values[start:end:res],500 ,1000000),\n                                    y1=df_train_clean['open_channels'].values[start:end:res] ))\n\np1 = figure(title='Train Signal(w\/o drift)',**plot_size_and_tools)\np1.add_tools(HoverTool())\np1.line('x', 'y0', line_width=1, color = 'orange', source=source)\np2.xaxis.axis_label = 'Freq'\np1.yaxis.axis_label = 'FFT amplitude'\np2 = figure(title='Open_Channels',**plot_size_and_tools, x_range=p1.x_range, )\np2.add_tools(HoverTool())\np2.line('x', 'y1', line_width=1, color = 'black', source=source)\np2.xaxis.axis_label = 'Time'\np2.yaxis.axis_label = 'Opened Channel'\np = gridplot([p1, p2],ncols=1, toolbar_location='right')\nshow(p)","c7815395":"df_train.index = ((df_train.time * 10_000)).values-1\ndf_train['batch'] = 1+(df_train.index \/\/ 50_0000)\ndf_train['batch'] = df_train['batch'].astype('int16')\ndf_train['sub_batch'] = 1 + (df_train.index  \/\/ 1_000).astype('int32')\ndf_train['batch2'] = df_train['batch'].copy()\ndf_train.loc[df_train[(df_train.index >= 600000)&(df_train.index < 1000000)].index, 'batch2'] = 11\ndf_train.tail(2)","9c7aa552":"df_train_clean.index = ((df_train_clean.time * 10_000)).values-1\ndf_train_clean['batch'] = 1+(df_train_clean.index \/\/ 50_0000)\ndf_train_clean['batch'] = df_train_clean['batch'].astype('int16')\ndf_train_clean['sub_batch'] = 1 + (df_train_clean.index  \/\/ 1_000).astype('int32')\ndf_train_clean['batch2'] = df_train_clean['batch'].copy()\ndf_train_clean.loc[df_train_clean[(df_train_clean.index >= 600000)&(df_train_clean.index < 1000000)].index, 'batch2'] = 11\ndf_train_clean.tail(2)","c221b91e":"palette = [cc.rainbow[i*15] for i in range(13)]\nx = np.linspace(-6,15, 500)\nplot_size_and_tools = {'plot_height': 800, 'plot_width': 700,\n                        'tools':['box_zoom', 'reset', 'crosshair','help']}\np1 = figure(y_range=(-1, 12),  x_range=(-6, 15), toolbar_location='above', **plot_size_and_tools)\nfor i in range(11):\n    pdf = gaussian_kde(df_train[(df_train['open_channels']==i)]['signal'].values)\n    y = pdf(x) + i\n    source = ColumnDataSource(data=dict(x=x, y=y))\n    p1.patch('x', 'y', line_width=1, alpha = 0.6, color=palette[i], source=source, line_color='black')\np1.xaxis.ticker = FixedTicker(ticks=list(range(-5, 15, 1)))\np1.xaxis.axis_label = 'Signal Strength'\np1.yaxis.axis_label = 'Opened Channel'\nshow(p1)","5d6c7084":"palette = [cc.rainbow[i*15] for i in range(13)]\nx = np.linspace(-6,15, 500)\nplot_size_and_tools = {'plot_height': 800, 'plot_width': 700,\n                        'tools':['box_zoom', 'reset', 'crosshair','help']}\np1 = figure(y_range=(0, 11),  x_range=(-6, 15), toolbar_location='above', **plot_size_and_tools)\nfor i in range(10):\n    pdf = gaussian_kde(df_train_clean[(df_train_clean['batch']==1+i)]['signal'].values)\n    y = pdf(x) + i +1\n    source = ColumnDataSource(data=dict(x=x, y=y))\n    p1.patch('x', 'y', line_width=1, alpha = 0.6, color=palette[i], source=source, line_color='black')\np1.xaxis.ticker = FixedTicker(ticks=list(range(-5, 15, 1)))\np1.xaxis.axis_label = 'Signal Strength'\np1.yaxis.axis_label = 'Batch'\nshow(p1)","982707ad":"palette = [cc.rainbow[i*15] for i in range(13)]\nx = np.linspace(-3,15, 500)\nplot_size_and_tools = {'plot_height': 800, 'plot_width': 700,\n                        'tools':['box_zoom', 'reset', 'crosshair','help']}\np1 = figure(y_range=(0, 11),  x_range=(-3, 15), toolbar_location='above', **plot_size_and_tools)\nfor i in range(10):\n    pdf = gaussian_kde(df_train_clean[(df_train_clean['batch']==1+i)]['signal'].values**2)\n    y = pdf(x) + i +1\n    source = ColumnDataSource(data=dict(x=x, y=y))\n    p1.patch('x', 'y', line_width=1, alpha = 0.6, color=palette[i], source=source, line_color='black')\np1.xaxis.ticker = FixedTicker(ticks=list(range(-5, 15, 1)))\np1.xaxis.axis_label = 'Power of Signal Strength'\np1.yaxis.axis_label = 'Batch'\nshow(p1)","5a36bb80":"def select_batch(batch_val,data):\n    \n    if (batch_val != 'All'):\n        selected = data[data['batch']==int(batch_val)].copy()\n    else:\n        selected = data.copy()\n    return selected\n\ndef select_batch2(batch_val, data):\n    \n    if (batch_val != 'All'):\n        selected = df_train[df_train['batch2']==int(batch_val)].copy()\n    else:\n        selected = df_train.copy()\n    return selected\n\npalette = [cc.rainbow[i*20] for i in range(11)]\n\ndef batch_plot(batch_val, data):\n    x=np.linspace(-6,15, 500)\n    # Define Graph\n    plot_size_and_tools = {'plot_height': 400, 'plot_width': 350,\n                            'tools':['box_zoom', 'reset', 'crosshair','help']}\n    p1 = figure(title='Signal vs Channel Batch'+str(batch_val), y_range=(-1, 11),  x_range=(-6, 15), toolbar_location='above', **plot_size_and_tools)\n    p1.add_tools(HoverTool())\n    p1.xaxis.ticker = FixedTicker(ticks=list(range(-5, 15, 1)))\n    p1.xaxis.axis_label = 'Signal Strength'\n    p1.yaxis.axis_label = 'Opened Channel'\n    df = select_batch(batch_val, data)\n    for i in range(11):        \n        if len(df[df['open_channels']==i]) !=0:\n            pdf = gaussian_kde(df[df['open_channels']==i]['signal'].values)\n            y = pdf(x) + i\n            source = ColumnDataSource(data=dict(x=x, y=y))\n            p1.patch(x,y, line_width=1, alpha = 0.6, color=palette[batch_val],  line_color='black')\n        else:\n            continue\n    return p1\n\ndef batch_plot2(batch_val, data):\n    x=np.linspace(-6,15, 500)\n    # Define Graph\n    plot_size_and_tools = {'plot_height': 400, 'plot_width': 350,\n                            'tools':['box_zoom', 'reset', 'crosshair','help']}\n    p1 = figure(title='Signal vs Channel Batch'+str(batch_val), y_range=(-1, 11),  x_range=(-6, 15), toolbar_location='above', **plot_size_and_tools)\n    p1.add_tools(HoverTool())\n    p1.xaxis.ticker = FixedTicker(ticks=list(range(-5, 15, 1)))\n    p1.xaxis.axis_label = 'Signal Strength'\n    p1.yaxis.axis_label = 'Opened Channel'\n    df = select_batch2(batch_val, data)\n    for i in range(11):        \n        if len(df[df['open_channels']==i]) !=0:\n            pdf = gaussian_kde(df[df['open_channels']==i]['signal'].values**2)\n            y = pdf(x) + i\n            source = ColumnDataSource(data=dict(x=x, y=y))\n            p1.patch(x,y, line_width=1, alpha = 0.6, color=palette[batch_val],  line_color='black')\n        else:\n            continue\n    return p1","2b7835e4":"for i in range(1,6):\n    p1 = batch_plot(2*i-1, df_train)\n    p2 = batch_plot(2*i, df_train)\n    p = gridplot([p1, p2],ncols=2, toolbar_location='right')\n    show(p)","50010adb":"for i in range(1,6):\n    p1 = batch_plot(2*i-1, df_train_clean)\n    p2 = batch_plot(2*i, df_train_clean)\n    p = gridplot([p1, p2],ncols=2, toolbar_location='right')\n    show(p)","a026651c":"for i in range(1,6):\n    p1 = batch_plot2(2*i-1, df_train_clean)\n    p2 = batch_plot2(2*i, df_train_clean)\n    p = gridplot([p1, p2],ncols=2, toolbar_location='right')\n    show(p)","47649393":"s = df_train_clean['signal'].values[2000000:2500000]\ny = np.abs(np.fft.fft(s))\nstart = 10\nend = len(s)\nres = 1\nplot_size_and_tools = {'plot_height': 200, 'plot_width': 750,\n                        'tools':['box_zoom', 'reset', 'crosshair','help']}\n\nsource = ColumnDataSource(data=dict(x=list(range(start,end,res)), \n                                    y0=s[start:end:res],\n                                    y1=y[start:end:res]))\n\np1 = figure(title='Train Signal',**plot_size_and_tools)\np1.add_tools(HoverTool())\np1.line('x', 'y0', line_width=1, color = 'red', source=source)\np1.yaxis.axis_label = 'Signal Strength'\np1.xaxis.axis_label = 'Time'\np2 = figure(title='FFT Amplitude',**plot_size_and_tools, x_range=p1.x_range, )\np2.add_tools(HoverTool())\np2.line('x', 'y1', line_width=1, color = 'black', source=source)\np2.xaxis.axis_label = 'Freq'\np2.yaxis.axis_label = 'FFT Amplitude'\np = gridplot([p1, p2],ncols=1, toolbar_location='right')\nshow(p)","def953f9":"s = pd.Series(df_train_clean['signal'].values[2000000:2500000]).rolling(50).mean().fillna(method='bfill')\ny = np.abs(np.fft.fft(s))\nstart = 10\nend = len(s)\nres = 1\nplot_size_and_tools = {'plot_height': 200, 'plot_width': 750,\n                        'tools':['box_zoom', 'reset', 'crosshair','help']}\n\nsource = ColumnDataSource(data=dict(x=list(range(start,end,res)), \n                                    y0=s[start:end:res],\n                                    y1=y[start:end:res]))\n\np1 = figure(title='Rolling 50 Train Signal',**plot_size_and_tools)\np1.add_tools(HoverTool())\np1.line('x', 'y0', line_width=1, color = 'red', source=source)\np1.yaxis.axis_label = 'Signal Strength'\np1.xaxis.axis_label = 'Time'\np2 = figure(title='FFT Amplitude',**plot_size_and_tools, x_range=p1.x_range, )\np2.add_tools(HoverTool())\np2.line('x', 'y1', line_width=1, color = 'black', source=source)\np2.xaxis.axis_label = 'Freq'\np2.yaxis.axis_label = 'FFT Amplitude'\np = gridplot([p1, p2],ncols=1, toolbar_location='right')\nshow(p)","6c6b72e3":"s = df_train_clean['signal'].values[0:500000]\ny = np.abs(np.fft.fft(s))\nstart = 10\nend = len(s)\nres = 1\nplot_size_and_tools = {'plot_height': 200, 'plot_width': 750,\n                        'tools':['box_zoom', 'reset', 'crosshair','help']}\n\nsource = ColumnDataSource(data=dict(x=list(range(start,end,res)), \n                                    y0=s[start:end:res],\n                                    y1=y[start:end:res]))\n\np1 = figure(title='Train Signal',**plot_size_and_tools)\np1.add_tools(HoverTool())\np1.line('x', 'y0', line_width=1, color = 'red', source=source)\np1.yaxis.axis_label = 'Signal Strength'\np1.xaxis.axis_label = 'Time'\np2 = figure(title='FFT Amplitude',**plot_size_and_tools, x_range=p1.x_range, )\np2.add_tools(HoverTool())\np2.line('x', 'y1', line_width=1, color = 'black', source=source)\np2.xaxis.axis_label = 'Freq'\np2.yaxis.axis_label = 'FFT Amplitude'\np = gridplot([p1, p2],ncols=1, toolbar_location='right')\nshow(p)","09871ea4":"s = pd.Series(df_train_clean['signal'].values[0:500000]).rolling(50).mean().fillna(method='bfill')\ny = np.abs(np.fft.fft(s))\nstart = 10\nend = len(s)\nres = 1\nplot_size_and_tools = {'plot_height': 200, 'plot_width': 750,\n                        'tools':['box_zoom', 'reset', 'crosshair','help']}\n\nsource = ColumnDataSource(data=dict(x=list(range(start,end,res)), \n                                    y0=s[start:end:res],\n                                    y1=y[start:end:res]))\n\np1 = figure(title='Rolling 50 Train Signal',**plot_size_and_tools)\np1.add_tools(HoverTool())\np1.line('x', 'y0', line_width=1, color = 'red', source=source)\np1.yaxis.axis_label = 'Signal Strength'\np1.xaxis.axis_label = 'Time'\np2 = figure(title='FFT Amplitude',**plot_size_and_tools, x_range=p1.x_range, )\np2.add_tools(HoverTool())\np2.line('x', 'y1', line_width=1, color = 'black', source=source)\np2.xaxis.axis_label = 'Freq'\np2.yaxis.axis_label = 'FFT Amplitude'\np = gridplot([p1, p2],ncols=1, toolbar_location='right')\nshow(p)","d76f94f1":"s = df_train_clean['signal'].values[0:500000]\ny = np.fft.fft(s)\n#y[:2480]=0\ny[2510:]=0\ns_i = np.abs(np.fft.ifft(y))\nstart = 10\nend = len(s)\nres = 1\nplot_size_and_tools = {'plot_height': 200, 'plot_width': 750,\n                        'tools':['box_zoom', 'reset', 'crosshair','help']}\n\nsource = ColumnDataSource(data=dict(x=list(range(start,end,res)), \n                                    y0=s[start:end:res],\n                                    y1=s_i[start:end:res]))\n\np1 = figure(title='Train Signal',**plot_size_and_tools)\np1.add_tools(HoverTool())\np1.line('x', 'y0', line_width=1, color = 'red', source=source)\np1.yaxis.axis_label = 'Signal Strength'\np1.xaxis.axis_label = 'Time'\np2 = figure(title='IFFT signal',**plot_size_and_tools, x_range=p1.x_range, )\np2.add_tools(HoverTool())\np2.line('x', 'y1', line_width=1, color = 'black', source=source)\np2.xaxis.axis_label = 'Freq'\np2.yaxis.axis_label = 'IFFT Amplitude'\np = gridplot([p1, p2],ncols=1, toolbar_location='right')\nshow(p)","f7142485":"s = df_train_clean['signal'].values[1500000:2000000]\ny = np.abs(np.fft.fft(s))\nstart = 10\nend = len(s)\nres = 1\nplot_size_and_tools = {'plot_height': 200, 'plot_width': 750,\n                        'tools':['box_zoom', 'reset', 'crosshair','help']}\n\nsource = ColumnDataSource(data=dict(x=list(range(start,end,res)), \n                                    y0=s[start:end:res],\n                                    y1=y[start:end:res]))\n\np1 = figure(title='Train Signal',**plot_size_and_tools)\np1.add_tools(HoverTool())\np1.line('x', 'y0', line_width=1, color = 'red', source=source)\np1.yaxis.axis_label = 'Signal Strength'\np1.xaxis.axis_label = 'Time'\np2 = figure(title='FFT Amplitude',**plot_size_and_tools, x_range=p1.x_range, )\np2.add_tools(HoverTool())\np2.line('x', 'y1', line_width=1, color = 'black', source=source)\np2.xaxis.axis_label = 'Freq'\np2.yaxis.axis_label = 'FFT Amplitude'\np = gridplot([p1, p2],ncols=1, toolbar_location='right')\nshow(p)","7b17a862":"s = pd.Series(df_train_clean['signal'].values[1500000:2000000]).rolling(50).mean().fillna(method='bfill')\ny = np.abs(np.fft.fft(s))\nstart = 10\nend = len(s)\nres = 1\nplot_size_and_tools = {'plot_height': 200, 'plot_width': 750,\n                        'tools':['box_zoom', 'reset', 'crosshair','help']}\n\nsource = ColumnDataSource(data=dict(x=list(range(start,end,res)), \n                                    y0=s[start:end:res],\n                                    y1=y[start:end:res]))\n\np1 = figure(title='Rolling 50 Train Signal',**plot_size_and_tools)\np1.add_tools(HoverTool())\np1.line('x', 'y0', line_width=1, color = 'red', source=source)\np1.yaxis.axis_label = 'Signal Strength'\np1.xaxis.axis_label = 'Time'\np2 = figure(title='FFT Amplitude',**plot_size_and_tools, x_range=p1.x_range, )\np2.add_tools(HoverTool())\np2.line('x', 'y1', line_width=1, color = 'black', source=source)\np2.xaxis.axis_label = 'Freq'\np2.yaxis.axis_label = 'FFT Amplitude'\np = gridplot([p1, p2],ncols=1, toolbar_location='right')\nshow(p)","c4eec166":"s1 = pd.Series(df_train_clean['signal'].values[0:500000]).rolling(50).mean().fillna(method='bfill')\ny1 = np.abs(np.fft.fft(s1))\ns4 = pd.Series(df_train_clean['signal'].values[1500000:2000000]).rolling(50).mean().fillna(method='bfill')\ny4 = np.abs(np.fft.fft(s4))\ns5 = pd.Series(df_train_clean['signal'].values[2000000:2500000]).rolling(50).mean().fillna(method='bfill')\ny5 = np.abs(np.fft.fft(s5))\nstart = 10\nend = len(s)\nres = 1\nplot_size_and_tools = {'plot_height': 200, 'plot_width': 750,\n                        'tools':['box_zoom', 'reset', 'crosshair','help']}\n\nsource = ColumnDataSource(data=dict(x=list(range(start,end,res)), \n                                    z0=y1[start:end:res],\n                                    z1=y4[start:end:res],\n                                    z2=y5[start:end:res]))\n\np1 = figure(title='FFT Amplitude',x_range=(start, end\/10),**plot_size_and_tools)\np1.add_tools(HoverTool())\np1.line('x', 'z2', line_width=1, color = 'black', source=source)\np1.line('x', 'z1', line_width=1, color = 'red', source=source)\np1.line('x', 'z0', line_width=1, color = 'yellow', source=source)\np1.yaxis.axis_label = 'FFT Amplitude'\np1.xaxis.axis_label = 'Freq'\n\nshow(p1)","90a619c0":"%%time\naggs = ['max', 'min', 'var', 'mad', 'skew']\n\ndef agg_func(aggs, df):\n    df_agg = pd.DataFrame()\n    for agg in tqdm(aggs):\n        #print(agg)\n        assert agg in ['max', 'min', 'var', 'mad', 'skew'], 'Choose defined aggregation method.'\n        if agg == 'max':\n            df_agg['sub_batch_'+agg] = df.groupby(by='sub_batch')['signal'].max()\n        elif agg == 'min':\n            df_agg['sub_batch_'+agg] = df.groupby(by='sub_batch')['signal'].min()\n        elif agg == 'var':\n            df_agg['sub_batch_'+agg] = df.groupby(by='sub_batch')['signal'].var()\n        elif agg == 'mad':\n            df_agg['sub_batch_'+agg] = df.groupby(by='sub_batch')['signal'].mad()\n        elif agg == 'skew':\n            df_agg['sub_batch_'+agg] = df.groupby(by='sub_batch')['signal'].skew()\n    df_agg['batch'] = df.groupby(by='sub_batch')['batch'].mean().astype('int16').values\n        \n    df_agg = df_agg.reset_index()\n    return df_agg\n\ndf_agg = agg_func(aggs, df_train)\ndf_agg.head(2)","e8377063":"x = df_agg['sub_batch'].values\nplot_size_and_tools = {'plot_height': 100,\n                       #'plot_width': 500,\n                            'tools':['box_zoom', 'reset', 'crosshair','help']}\nfor i, agg in enumerate(aggs):\n    p = figure(title='Statistics for sub batches: '+agg,toolbar_location='above', **plot_size_and_tools, sizing_mode=\"scale_width\")\n    p.add_tools(HoverTool())\n    y = df_agg['sub_batch_'+agg].values\n    p.scatter(x, y, color=palette[i])\n    show(p)","f89face8":"df_agg_clean = agg_func(aggs, df_train_clean)\nx = df_agg_clean['sub_batch'].values\nplot_size_and_tools = {'plot_height': 100,\n                       #'plot_width': 500,\n                            'tools':['box_zoom', 'reset', 'crosshair','help']}\nfor i, agg in enumerate(aggs):\n    p = figure(title='Statistics for sub batches (w\/o data drift): '+agg,toolbar_location='above', **plot_size_and_tools, sizing_mode=\"scale_width\")\n    p.add_tools(HoverTool())\n    y = df_agg_clean['sub_batch_'+agg].values\n    p.scatter(x, y, color=palette[i])\n    show(p)","1c2af556":"start = 0\nend = len(df_test)\nres = int(end\/1000000)\nplot_size_and_tools = {'plot_height': 200, 'plot_width': 750,\n                        'tools':['box_zoom', 'reset', 'crosshair','help']}\n\nsource = ColumnDataSource(data=dict(x=list(range(start,end,res)), \n                                    y0=df_test['signal'].values[start:end:res],\n                                    ))\n\np1 = figure(title='Test Signal',**plot_size_and_tools)\np1.add_tools(HoverTool())\np1.line('x', 'y0', line_width=1, color = 'blue', source=source)\n\nshow(p1)","0777178a":"start = 0\nend = len(df_test)\nres = int(end\/1000000)\nplot_size_and_tools = {'plot_height': 200, 'plot_width': 750,\n                        'tools':['box_zoom', 'reset', 'crosshair','help']}\n\nsource = ColumnDataSource(data=dict(x=list(range(start,end,res)), \n                                    y0=df_test_clean['signal'].values[start:end:res],\n                                    ))\n\np1 = figure(title='Test Signal(w\/o drift)',**plot_size_and_tools)\np1.add_tools(HoverTool())\np1.line('x', 'y0', line_width=1, color = 'purple', source=source)\n\nshow(p1)","84a5e188":"start = 0\nend = len(df_test)\nres = int(end\/1000000)\nplot_size_and_tools = {'plot_height': 200, 'plot_width': 750,\n                        'tools':['box_zoom', 'reset', 'crosshair','help']}\n\nsource = ColumnDataSource(data=dict(x=list(range(start,end,res)), \n                                    y0=df_test_clean['signal'].values[start:end:res]-df_test_clean['signal'].shift(1).fillna(0).values[start:end:res] ,\n                                    ))\n\np1 = figure(title='Test Signal(w\/o drift)',**plot_size_and_tools)\np1.add_tools(HoverTool())\np1.line('x', 'y0', line_width=1, color = 'purple', source=source)\n\nshow(p1)","4632edd0":"start = 0\nend = len(df_train)\nres = int(end\/1000000)\nplot_size_and_tools = {'plot_height': 200, 'plot_width': 750,\n                        'tools':['box_zoom', 'reset', 'crosshair','help']}\n\nsource = ColumnDataSource(data=dict(x=list(range(start,end,res)), \n                                    y0=df_train['signal'].values[start:end:res],\n                                    y1=df_train['open_channels'].values[start:end:res]))\n\np1 = figure(title='Train Signal',**plot_size_and_tools)\np1.add_tools(HoverTool())\np1.line('x', 'y0', line_width=1, color = 'red', source=source)\np1.yaxis.axis_label = 'Signal Strength'\np2 = figure(title='Open_Channels',**plot_size_and_tools, x_range=p1.x_range, y_range=p1.y_range)\np2.add_tools(HoverTool())\np2.line('x', 'y1', line_width=1, color = 'black', source=source)\np2.xaxis.axis_label = 'Time'\np2.yaxis.axis_label = 'Opened Channel'\np = gridplot([p1, p2],ncols=1, toolbar_location='right')\nshow(p)","e856d4a3":"start = 0\nend = len(df_train)\nres = int(end\/1000000)\nplot_size_and_tools = {'plot_height': 200, 'plot_width': 750,\n                        'tools':['box_zoom', 'reset', 'crosshair','help']}\n\nsource = ColumnDataSource(data=dict(x=list(range(start,end,res)), \n                                    y0=df_train_clean['signal'].values[start:end:res],\n                                    y1=df_train_clean['open_channels'].values[start:end:res]))\n\np1 = figure(title='Train Signal(w\/o drift)',**plot_size_and_tools)\np1.add_tools(HoverTool())\np1.line('x', 'y0', line_width=1, color = 'orange', source=source)\np1.yaxis.axis_label = 'Signal Strength'\np2 = figure(title='Open_Channels',**plot_size_and_tools, x_range=p1.x_range, y_range=p1.y_range)\np2.add_tools(HoverTool())\np2.line('x', 'y1', line_width=1, color = 'black', source=source)\np2.xaxis.axis_label = 'Time'\np2.yaxis.axis_label = 'Opened Channel'\np = gridplot([p1, p2],ncols=1, toolbar_location='right')\nshow(p)","dbaa5d5a":"%%time\ndf_test.index = ((df_test.time * 10_000)).values-1\ndf_test['batch'] = 1+(df_test.index \/\/ 50_0000)\ndf_test['batch'] = df_test['batch'].astype('int16')\ndf_test['sub_batch'] = 1 + (df_test.index  \/\/ 1_000).astype('int32')\ndf_test.tail(2)","2d4f3d90":"df_test_clean.index = ((df_test_clean.time * 10_000)).values-1\ndf_test_clean['batch'] = 1+(df_test_clean.index \/\/ 50_0000)\ndf_test_clean['batch'] = df_test_clean['batch'].astype('int16')\ndf_test_clean['sub_batch'] = 1 + (df_test_clean.index  \/\/ 1_000).astype('int32')","6b0db6d8":"df_test_clean['batch'].unique()","666f4b39":"palette = [cc.rainbow[i*15] for i in range(13)]\nx = np.linspace(-6,15, 500)\nplot_size_and_tools = {'plot_height': 400, 'plot_width': 700,\n                        'tools':['box_zoom', 'reset', 'crosshair','help']}\np1 = figure(y_range=(10, 16),  x_range=(-6, 15), toolbar_location='above', **plot_size_and_tools)\nfor i in range(4):\n    pdf = gaussian_kde(df_test[(df_test['batch']==11+i)]['signal'].values)\n    y = pdf(x) + i +11\n    source = ColumnDataSource(data=dict(x=x, y=y))\n    p1.patch('x', 'y', line_width=1, alpha = 0.6, color=palette[i], source=source, line_color='black')\np1.xaxis.ticker = FixedTicker(ticks=list(range(-5, 15, 1)))\np1.xaxis.axis_label = 'Signal Strength'\np1.yaxis.axis_label = 'Batch'\nshow(p1)","310a5bbf":"palette = [cc.rainbow[i*15] for i in range(13)]\nx = np.linspace(-6,15, 500)\nplot_size_and_tools = {'plot_height': 400, 'plot_width': 700,\n                        'tools':['box_zoom', 'reset', 'crosshair','help']}\np1 = figure(y_range=(10, 16),  x_range=(-6, 15), toolbar_location='above', **plot_size_and_tools)\nfor i in range(4):\n    pdf = gaussian_kde(df_test_clean[(df_test_clean['batch']==11+i)]['signal'].values)\n    y = pdf(x) + i +11\n    source = ColumnDataSource(data=dict(x=x, y=y))\n    p1.patch('x', 'y', line_width=1, alpha = 0.6, color=palette[i], source=source, line_color='black')\np1.xaxis.ticker = FixedTicker(ticks=list(range(-5, 15, 1)))\np1.xaxis.axis_label = 'Signal Strength'\np1.yaxis.axis_label = 'Batch'\nshow(p1)","87417571":"%%time\ndf_agg_test = agg_func(aggs, df_test)\ndf_agg_test.tail(2)","b7dfdef0":"x = df_agg_test['sub_batch'].values\nplot_size_and_tools = {'plot_height': 100,\n                       #'plot_width': 500,\n                            'tools':['box_zoom', 'reset', 'crosshair','help']}\nfor i, agg in enumerate(aggs):\n    p = figure(title='Statistics for sub batches: '+agg,toolbar_location='above', **plot_size_and_tools, sizing_mode=\"scale_width\")\n    p.add_tools(HoverTool())\n    y = df_agg_test['sub_batch_'+agg].values\n    p.scatter(x, y, color=palette[i])\n    show(p)","8e08e898":"%%time\ndf_agg_test_clean = agg_func(aggs, df_test_clean)\ndf_agg_test_clean.tail(2)","694b24c5":"x = df_agg_test_clean['sub_batch'].values\nplot_size_and_tools = {'plot_height': 100,\n                       #'plot_width': 500,\n                            'tools':['box_zoom', 'reset', 'crosshair','help']}\nfor i, agg in enumerate(aggs):\n    p = figure(title='Statistics for sub batches: '+agg,toolbar_location='above', **plot_size_and_tools, sizing_mode=\"scale_width\")\n    p.add_tools(HoverTool())\n    y = df_agg_test_clean['sub_batch_'+agg].values\n    p.scatter(x, y, color=palette[i])\n    show(p)","2470be30":"start_tr = 0\nend_tr = len(df_train)\nres_tr = int(end_tr\/1000000)\nstart_te = 0\nend_te = len(df_test)\nres_te = int(end_te\/1000000)\nx1 = df_train['time'].values[start_tr:end_tr:res_tr]\nx2 = df_test['time'].values[start_te:end_te:res_te] \ny1 = df_train['signal'].values[start_tr:end_tr:res_tr]\ny2 = df_test['signal'].values[start_te:end_te:res_te]\nplot_size_and_tools = {'plot_height': 200,\n                       #'plot_width': 700,\n                            'tools':['box_zoom', 'reset', 'crosshair','help']}\n\np1 = figure(title='Signal ',toolbar_location='above', **plot_size_and_tools, sizing_mode=\"scale_width\")\np1.add_tools(HoverTool())\np1.line(x1, y1, color=palette[1], legend_label='Train')\np1.line(x2, y2, color=palette[6], legend_label='Test')\nshow(p1)","f2f6d088":"agg = 'mad'\nx1 = df_agg['sub_batch'].values\nx2 = df_agg_test['sub_batch'].values \ny1 = df_agg['sub_batch_'+agg].values\ny2 = df_agg_test['sub_batch_'+agg].values\nplot_size_and_tools = {'plot_height': 200,\n                       #'plot_width': 700,\n                            'tools':['box_zoom', 'reset', 'crosshair','help']}\n\np1 = figure(title='Statistics for sub batches: '+agg,toolbar_location='above', **plot_size_and_tools, sizing_mode=\"scale_width\")\np1.add_tools(HoverTool())\np1.line(x1, y1, color=palette[1], legend_label='Train')\np1.line(x2, y2, color=palette[6], legend_label='Test')\nshow(p1)\n\n#show(p2)","7978d4b3":"### Plots without data drift","00003861":"#### Batch 4","e6c8eef0":"Batch 5 and 10 have more complicated data distribution, so lets do some FFT analysis to deep dive in this.","e959a0f9":"**The low frequency FFT amplitude for batch 5 seems to be stronger than other batches. Let's check that directly. I guess this is somehow related to the \"Ghost signal\" mentioned [here](https:\/\/www.kaggle.com\/miklgr500\/ghost-drift-and-outliers\/notebook#%22Ghost%22-drift). This maybe another data drift. We need identify what causes this and how to capture the characteristics**","d78789be":"#### Batch 1","70af2c4d":"If you find this notebook is useful, please upvote!!","de475fb3":"## Comparing Train and Test Data","2cae18b0":"#### Data without Drift","fef5d5fa":"### In order to see detail signal of the data, I'd like to demonstrate a useful dashboard by [Bokeh Library](https:\/\/docs.bokeh.org\/en\/latest\/index.html). You can directly panning, zooming in a single graph or make these actions in the graph linked, which enables EDA more efficient. It takes about 2~30 sec to load all the graphs since bokeh graphs keeps data within its graphs so please keep patient.","c413e219":"### Signal and open channels","e062adeb":"# Train Data","f7d8b68a":"You can also see the same graph for different batch, the relationship between signal and open channels seems to be different in different batch.","5faf43af":"#### The Original Data","53d3870d":"# Test Data","6fa1ef5c":"### KDE plots signal vs opened channel","8d9529bd":"Acknowledgment: [Data Without Drift](https:\/\/www.kaggle.com\/cdeotte\/data-without-drift)  \nAfter removing data drift, we can find that there are two types of relationship between signal and open channels. For batch 1~4, 6~9, they have relatively sharpe peaks. For batch 5 and 10, on the other hand, their peaks are broader namely smaller kurtosis.","5cd7d81f":"### Statistical features","d736b8b9":"The batch 11, 13, 14 seem like the distribution of the batch 1~4, 6~9, while the batch 12's distribution resembles that of the batch 5 and 10.","fd299c65":"# EDA","6b9c4a74":"## Import Data","9afb0287":"#### Batch 5","0cf7cac5":"### KDE Plots of the test signal by different batches","fd7d21f6":"The power plot of the signals","bd22445b":"### Plots with data drift","fd11359f":"# Import Libraries","d66f66e4":"Next, let see if there is any signal characteristics in the sub-batches. The sub-batch is 1,000 time step long which is corresponding to 1\/500 of a batch."}}