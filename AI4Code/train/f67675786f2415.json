{"cell_type":{"e8f0a00d":"code","233c8b8d":"code","b7d7aaad":"code","99c3c1df":"code","a82cba5d":"code","f4744aa9":"code","97c6fd73":"code","adc502e7":"code","b4f577ec":"code","ab2070d7":"code","d4b37f53":"code","b3116760":"code","eb2ca93f":"code","b85a3800":"code","17d0252d":"code","79b2d5f0":"code","93310b8f":"code","1b29a88d":"markdown","843e0969":"markdown","07ded89e":"markdown","88301bbb":"markdown","cda25a7c":"markdown","d9be08a7":"markdown","574f3170":"markdown","3f20f8f8":"markdown","4a45d0d7":"markdown","f3262063":"markdown","a1f3517c":"markdown","fdbc0941":"markdown"},"source":{"e8f0a00d":"!pip install pyspark","233c8b8d":"#import libraries\nfrom pyspark import SparkContext\nfrom pyspark.ml.recommendation import ALS\nfrom pyspark.sql import SparkSession ,Row\nfrom pyspark.sql.functions import col\nfrom pyspark.sql import SQLContext\nfrom pyspark.ml.feature import StringIndexer\nfrom pyspark.ml import Pipeline\nfrom pyspark.ml.evaluation import RegressionEvaluator\nfrom pyspark.sql.types import StructType,StructField,IntegerType\nimport matplotlib.pyplot as plt\n%matplotlib inline","b7d7aaad":"appName=\"Collaborative Filtering with PySpark\"\n\n#initialize the spark session\nspark = SparkSession.builder.appName(appName).getOrCreate()\n\n#get sparkcontext from the sparksession\nsc = spark.sparkContext\nsqlContext = SQLContext(sc)","99c3c1df":"df_business = sqlContext.read.json('..\/input\/yelp-dataset\/yelp_academic_dataset_business.json')\ndf_review = sqlContext.read.json('\/kaggle\/input\/yelp-dataset\/yelp_academic_dataset_review.json')","a82cba5d":"df_business = df_business.select(\"business_id\",\"name\", \"stars\", \n                                 \"review_count\", \"attributes\", \n                                 \"categories\", \"city\").withColumnRenamed(\"stars\", \"stars_restaurant\")\n\ndf_business = df_business.filter((df_business['city'] == 'Toronto') & (df_business.categories.contains('Restaurants'))).drop('city')","f4744aa9":"df_review = df_review.join(df_business, on='business_id', how='inner')","97c6fd73":"df_review.select(['business_id', 'user_id', 'stars']).show()","adc502e7":"reviews = df_review.select('stars').collect()\nreview_list = [reviews[i][0] for i in range(len(reviews))]\n\nplt.hist(review_list, bins=[0.5,1.5,2.5,3.5,4.5,5.5], alpha=0.5,\n         histtype='stepfilled', color='steelblue',\n         edgecolor='none')\nplt.ylabel('Frequency')\nplt.xlabel('Rating')\nplt.style.use('seaborn-white')","b4f577ec":"restaurant_reviews = df_business.select('stars_restaurant').collect()\nrestaurant_reviews_list = [restaurant_reviews[i][0] for i in range(len(restaurant_reviews))]\n\n\nplt.hist(restaurant_reviews_list, bins=[0.5,1.5,2.5,3.5,4.5,5.5], alpha=0.5,\n         histtype='stepfilled', color='steelblue',\n         edgecolor='none')\nplt.ylabel('Frequency')\nplt.xlabel('Rating')\nplt.style.use('seaborn-white')","ab2070d7":"restaurant_categories = df_business.select('categories').collect()\nrestaurant_categories_list = [restaurant_categories[i][0] for i in range(len(restaurant_categories))]","d4b37f53":"text = \" \".join(review for review in restaurant_categories_list)","b3116760":"from wordcloud import WordCloud, STOPWORDS, ImageColorGenerator\n\n# eliminate useless words\ntext = text.replace('Restaurants', \"\")\ntext = text.replace('bars', \"\")\ntext = text.replace('food', \"\")\n\n\n# Generate a word cloud image\nwordcloud = WordCloud(background_color=\"white\").generate(text)\n\n# Display the generated image:\n# the matplotlib way:\nplt.figure(figsize=(10,8))\nplt.imshow(wordcloud, interpolation='bilinear')\nplt.axis(\"off\")\nplt.show()","eb2ca93f":"indexer = [StringIndexer(inputCol=column, outputCol=column+\"_index\") for column in ['business_id', 'user_id']]\npipeline = Pipeline(stages=indexer)\ntransformed = pipeline.fit(df_review).transform(df_review)\ntransformed.select(['business_id', 'user_id','business_id_index', 'user_id_index'])","b85a3800":"(training, test) = transformed.randomSplit([0.8, 0.2])","17d0252d":"als=ALS(maxIter=5,\n        regParam=0.09,\n        rank=25,\n        userCol=\"user_id_index\",\n        itemCol=\"business_id_index\",\n        ratingCol=\"stars\",\n        coldStartStrategy=\"drop\",\n        nonnegative=True)\n\nmodel=als.fit(training)","79b2d5f0":"evaluator=RegressionEvaluator(metricName=\"rmse\",labelCol=\"stars\",predictionCol=\"prediction\")\npredictions=model.transform(test)\nrmse=evaluator.evaluate(predictions)\nprint(\"RMSE=\"+str(rmse))","93310b8f":"test = model.recommendForAllUsers(20).filter(col('user_id_index')==30).select(\"recommendations\").collect()\ntopRestaurants = []\nfor item in test[0][0]:        \n    topRestaurants.append(item.business_id_index)\n    \nschema = StructType([StructField(\"business_id_index\",IntegerType(),True)])\nrestaurants = spark.createDataFrame(topRestaurants,IntegerType()).toDF(\"business_id_index\")\n\n\ntransformed\\\n.select(['business_id', 'user_id', 'stars', 'categories'])\\\n.filter(col('user_id_index')==30)\\\n.show()\n\nrestaurants\\\n.join(transformed, on = 'business_id_index', how = 'inner')\\\n.select(['business_id', 'stars', 'categories', 'name'])\\\n.drop_duplicates(subset=['name'])\\\n.show()\n\n","1b29a88d":"## Load Dataset in Apache Spark\n","843e0969":"## Filter Rows and columns\n\n","07ded89e":"## Evaluate RMSE","88301bbb":"## Create ALS model\n","cda25a7c":"## Split Dataset in train and test\n","d9be08a7":"## Exploratory Data Analysis\n\n","574f3170":"## Visualize Recommendations\n\n","3f20f8f8":"Lets make a quick visualisation to the basic elements of our review table.","4a45d0d7":"Quite generous public from Toronto. Most ratings are above 3. Now lets see the the distrubtion of ratings of each restaurants. ","f3262063":"# Recommender system using Pyspark (ALS algorithm)\n---\n\n\n#### Requirements:\n- Python \n- Apache Spark\n\n## Import Libraries and Initialize spark session","a1f3517c":"> ## Convert String to index\n","fdbc0941":"Here were see a more normally distributed curve. Nevertheless most restaurants do pretty well.\nNow lets visualize what are the most popular type of restaurants in Toronto. What kind of food do they serve? We will create a wordcloud. "}}