{"cell_type":{"1c99fe7f":"code","3701e859":"code","a21e5e62":"code","b959bfca":"code","73a43fd8":"code","0d5b55c8":"code","01d1d198":"code","fd1ac544":"code","16d622b5":"code","02901f1b":"code","68d0e447":"markdown","739a58ab":"markdown","046e4d61":"markdown","efccf523":"markdown","f280dd06":"markdown","1ab54889":"markdown","46779348":"markdown","21391f6e":"markdown","9ce0399d":"markdown"},"source":{"1c99fe7f":"import matplotlib.pyplot as plt\nimport numpy as np\nimport pandas as pd\nimport random\nimport tensorflow as tf","3701e859":"# Note: Please set GCP_PROJECT_ID to your own Google Cloud project ID.\nGCP_PROJECT_ID= 'rosbo-personal'\n\nfrom kaggle_secrets import UserSecretsClient\nUserSecretsClient().set_gcloud_credentials(project=GCP_PROJECT_ID)","a21e5e62":"MODEL_PATH = 'gs:\/\/tf-cloud-rosbo-test\/kaggle-example\/20201119-225733\/model'\n\nmodel = tf.keras.models.load_model(MODEL_PATH)","b959bfca":"test = pd.read_csv(\"\/kaggle\/input\/digit-recognizer\/test.csv\")\nx_test = test.values.astype('float32') \/ 255.0\nx_test = x_test.reshape(-1, 28, 28, 1)\nprint(x_test.shape)","73a43fd8":"# Pick a random digit from the test set.\nindex = random.randint(0, x_test.shape[0])\nprint(plt.imshow(x_test[index].reshape(28, 28), cmap=plt.get_cmap('gray')))\n\nprediction = model.predict_classes(x_test[index:index+1])\n\nprint(f'Model prediction: {prediction[0]}')","0d5b55c8":"MODEL_NAME = 'kaggle_example'\n\n!gcloud ai-platform models create $MODEL_NAME --regions=us-central1","01d1d198":"MODEL_VERSION = 'v1'\n!gcloud ai-platform versions create $MODEL_VERSION \\\n    --model $MODEL_NAME \\\n    --origin $MODEL_PATH \\\n    --runtime-version=2.2 \\\n    --framework='tensorflow' \\\n    --python-version=3.7","fd1ac544":"import googleapiclient.discovery\n\ndef predict_json(project, model, instances, version=None):\n\n    service = googleapiclient.discovery.build('ml', 'v1')\n    name = 'projects\/{}\/models\/{}'.format(project, model)\n\n    if version is not None:\n        name += '\/versions\/{}'.format(version)\n\n    response = service.projects().predict(\n        name=name,\n        body={'instances': instances}\n    ).execute()\n\n    if 'error' in response:\n        raise RuntimeError(response['error'])\n\n    return response['predictions']","16d622b5":"# Pick a random digit from the test set.\nindex = random.randint(0, x_test.shape[0])\nprint(plt.imshow(x_test[index].reshape(28, 28), cmap=plt.get_cmap('gray')))\n\nresp = predict_json(GCP_PROJECT_ID, MODEL_NAME, x_test[index:index+1].tolist(), MODEL_VERSION)\n\nprint(f'Model prediction: {np.argmax(resp[0][\"dense_1\"])}')","02901f1b":"!gcloud ai-platform versions delete $MODEL_VERSION --model $MODEL_NAME -q\n!gcloud ai-platform models delete $MODEL_NAME -q","68d0e447":"## Step 6: Make Prediction with your Newly Deployed Model","739a58ab":"## Step 7: Cleanup Google Cloud Resources","046e4d61":"## Step 1: Import Packages","efccf523":"## Step 3: Deploy your Model to the Cloud AI Platform****\n\nIf you have used the [Train Model with TensorCloud notebook](https:\/\/kaggle.com\/rosebv\/train-model-with-tensorflow-cloud) to train your model, the `MODEL_PATH` will be printed in your Cloud training job logs.\n\n![Kapture%202020-11-24%20at%2016.59.29.gif](attachment:Kapture%202020-11-24%20at%2016.59.29.gif)","f280dd06":"## Step 4: Test your Model Locally","1ab54889":"## Step 5: Deploy your Model to the Cloud AI Platform","46779348":"## Step 2: Setup Google Cloud Credentials\n\nThis is necessary to retrieve your trained model from Google Cloud Storage and deploy a model to the Cloud AI platform.\n\n**NOTICE**: The model will be created in your Google Cloud project. **You will be billed ($$$)** for your AI Platform usage. Take a look at the [AI Platform prediction pricing](https:\/\/cloud.google.com\/ai-platform\/prediction\/pricing) for more info.\n\nTo setup your Google Cloud credentials, add the \"Google Cloud SDK\" addon from the \"Add-ons\" menu bar above.\n\n![52xZHgn3Na33F4d.png](attachment:52xZHgn3Na33F4d.png)","21391f6e":"# Test & Deploy TensorFlow Model to AI Platform","9ce0399d":"[Google Cloud AI Platform](https:\/\/cloud.google.com\/ai-platform) allows you to easily deploy your TensorFlow 2 model. Once the model is deployed, you can call the AI Platform Prediction API to scalably generate predictions without having to manage your own infrastructure.\n\nThis notebook will show you how to deploy a model to AI Platform and query the Prediction API.\n\nThe content in this notebook is largely inspired from the [How-to deploy a TensorFlow 2 Models on Cloud AI Platform](https:\/\/blog.tensorflow.org\/2020\/04\/how-to-deploy-tensorflow-2-models-on-cloud-ai-platform.html) but include instructions specific to achieving this on the Kaggle notebook platform."}}