{"cell_type":{"dcf3e0e4":"code","f14bd1fa":"code","f238c38c":"code","fc3e889a":"code","a767211b":"code","173652fb":"code","dfca742d":"code","2282210e":"code","d361704e":"code","bada750b":"code","4064a708":"code","f59ec5b4":"code","701b9e87":"code","2e182ca7":"code","ef5350c7":"code","ca96f672":"code","c93c965e":"code","62f2969e":"code","8b9416e4":"code","124982bc":"code","00318a5c":"code","768ab39d":"code","9404909f":"code","23f508f2":"code","c9b9869c":"code","22632e87":"code","64320593":"code","8180a9f7":"code","2c892214":"code","7b9e9741":"code","fdd4217e":"code","d86c5712":"code","7baeba08":"code","54162852":"code","5abfdc70":"code","b0a8c564":"code","8782f9aa":"markdown","840587f1":"markdown","a50152ee":"markdown","ff0ab7a4":"markdown","51deff84":"markdown","c11d9d0e":"markdown","36c31834":"markdown","acc74930":"markdown"},"source":{"dcf3e0e4":"# This Python 3 environment comes with many helpful analytics libraries installed\n# It is defined by the kaggle\/python docker image: https:\/\/github.com\/kaggle\/docker-python\n# For example, here's several helpful packages to load in \n\nimport numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\n\n# Input data files are available in the \"..\/input\/\" directory.\n# For example, running this (by clicking run or pressing Shift+Enter) will list all files under the input directory\n\nimport os\nfor dirname, _, filenames in os.walk('\/kaggle\/input'):\n    for filename in filenames:\n        print(os.path.join(dirname, filename))\n\n# Any results you write to the current directory are saved as output.","f14bd1fa":"#metric\n\ndef RMSLE(pred,actual):\n        return np.sqrt(np.mean(np.power((np.log(pred+1)-np.log(actual+1)),2)))","f238c38c":"#reading data\ndata = pd.read_csv('..\/input\/covid19-global-forecasting-week-2\/train.csv')\ntest_data = pd.read_csv('..\/input\/covid19-global-forecasting-week-2\/test.csv')\nsubmission = pd.read_csv('..\/input\/covid19-global-forecasting-week-2\/submission.csv')","fc3e889a":"data","a767211b":"data[\"Date\"] = data[\"Date\"].apply(lambda x: x.replace(\"-\",\"\"))\ndata[\"Date\"]  = data[\"Date\"].astype(int)\ntest_data[\"Date\"] = test_data[\"Date\"].apply(lambda x: x.replace(\"-\",\"\"))\ntest_data[\"Date\"]  = test_data[\"Date\"].astype(int)\ndata['key'] = data['Country_Region'].astype('str') + \" \" + data['Province_State'].astype('str')\ntest_data['key'] = test_data['Country_Region'].astype('str') + \" \" + test_data['Province_State'].astype('str')\ndata_train = data","173652fb":"#ammount of states \ndata_train['key'].nunique()","dfca742d":"#last day in test data\ntest_last_day = int(test_data.shape[0]\/294) + int(data_train[data_train.Date<20200319].shape[0]\/294)","2282210e":"test_last_day","d361704e":"#days in test data\ntest_days = np.arange(int(data_train[data_train.Date<20200319].shape[0]\/294), test_last_day, 1)","bada750b":"test_days","4064a708":"#lets create pivot tables\npivot_train = pd.pivot_table(data_train, index='Date', columns = 'key', values = 'ConfirmedCases')\npivot_train_d = pd.pivot_table(data_train, index='Date', columns = 'key', values = 'Fatalities')\nnp_train = pivot_train.to_numpy()\nnp_train_d = pivot_train_d.to_numpy()","f59ec5b4":"data_train[['ConfirmedCases', 'Fatalities']].corr()","701b9e87":"pivot_train.head(10)","2e182ca7":"shift = [0,1,2,3,4,5,6,7]\nfor s in shift:\n    sum = 0\n    for i in range(1,20):\n        sum += np.abs((np_train_d[-i][:]\/(np_train[-i-s][:]+0.0001)-np_train_d[-i-1][:]\/(np_train[-i-1-s][:]+0.0001)).mean())\n    print(sum, s)\n    \n#the best is 0    ","ef5350c7":"mask_deaths = np.zeros_like(np_train[0])\nfor i in range(1,21):\n    mask_deaths += np_train_d[-i]\/(np_train[-i]+0.0001)\nmask_deaths = mask_deaths\/20    ","ca96f672":"mask_deaths[(mask_deaths < 0.5) & (mask_deaths!=0)].mean()","c93c965e":"mask_deaths[(mask_deaths> 0.5)|(mask_deaths<0.005)] = mask_deaths[(mask_deaths < 0.5) & (mask_deaths!=0)].mean()","62f2969e":"mask_mesh = np.meshgrid(mask_deaths, test_days)[0].T.flatten()","8b9416e4":"assert mask_mesh.shape[0] == test_data.shape[0]","124982bc":"Idea: approximation ConfirmedCases for each country by some function\nIf you look at the graphs, you can see three different functions: exponential, linear, sigmoid    \n    ","00318a5c":"as_exponent = [0, 1, 2, 3, 13, 14, 27\n              , 41, 42, 44, 48, 82, 85\n              , 92, 93, 95, 96, 100, 102, 106, 108, 110, 112, 113, 114,\n               122, 125, 130, 131, 132, 134, 137, 138, 139, 143, 145, 148,\n              149, 161, 165, 166, 172\n              , 175, 177, 179, 185, 190, 194, 202\n              , 204, 205, 212, 213, 216, 218\n              , 224, 225, 228, 229, 230, 231, 232, 233, 234, 235, 237, 238,\n              239, 241, 242, 243, 244, 246, 247, 250, 252, 256, 258, 260,\n              261, 264, 266, 269, 272, 273, 274, 284, 285, 286, 288, 289, 290, 291, 292, 293]\nas_linear = [4,5, 7, 9, 10, 17, 18, 19, 22, 24, 25, 26, 29, 30, 32, 33,34, 36, 37, 38, 39, 40, 43, 45, 46, 47, 49, 51, 53, 54, 55, 56, 57,58,60,\n             61,62, 63, 64, 65, 66,\n             67, 68, 69, 70, 71, 72,73, 74,75, 76, 77, 78, 79, 80, 81, 83, 86, 88, 89, 91, 94, 97, 98, 99, 101,103,104, 105, 107, 109, 111, 115, 116, 117, 118,\n             120, 121, 123, 127, 128, 129, 135, 136, 141, 142, 144,\n          146,147,  150, 151, 152, 153, 154, 156, 159, 160, 162, 164, 167, 169, 170, 171,174, 178,\n             180, 182, 183, 184, 186, 187, 188, 189, 191, 192, 195, 196, 197, 198, 200, 201, 203, 207, 208,\n             209, 210, 211, 214, 217, 219, 220, 221, 222, 226, 236, 240, 245, 251, 254, 257, 259, 262, 263, 265, \n             267, 268, 270, 271, 277, 278, 279, 280, 281, 282, 283, 287]\n\nas_sigmoid = [6, 8, 11, 12, 15, 16, 20, 21, 23, 28, 31, 35, 50, 52, 59, 84, 87, 90\n             , 119, 124, 126, 133, 140, 155, 157, 158, 163, 168, 173, 176, 181,\n               193, 199, 206, 215, 223, 227, 248, 249, 253, 255, 276, 275]","768ab39d":"set(as_sigmoid)&set(as_linear) | set(as_sigmoid)&set(as_exponent) | set(as_exponent)&set(as_linear)","9404909f":"def exp(x, a, b, d, p):\n    return d * np.exp(a * x - b) + p\n\n\ndef linear(x, a, b, c):\n    return a*(x-b)+c\n\ndef sigmoid(x, a, b, d, p):\n    return d\/(1 + np.exp(-(a*x-b))) + p","23f508f2":"np_train.shape[0]","c9b9869c":"coefs = []\nfrom scipy.optimize import curve_fit\n\nX = np.arange(45, np_train.shape[0], 1)\n\nfor i in range(np_train.shape[1]):\n    if i in as_exponent:\n        coefs.append(curve_fit(exp,  X, np_train[45:, i],p0 = (0.5, X[0], 2, 0), maxfev=100000)[0])\n    if i in as_linear:\n        coefs.append(curve_fit(linear,  X[10:], np_train[55:, i], p0 = (1,0,0), maxfev=100000)[0])\n    if i in as_sigmoid:\n        coefs.append(curve_fit(sigmoid,  X, np_train[45:, i] , p0 = (1, X[0], np_train[-1, i]\/2,0), maxfev=100000)[0])\n          \n        ","22632e87":"import matplotlib.pyplot as plt\nfor i in as_linear:\n    plt.plot(np_train[45:,i], label = str(i))\n    plt.plot(linear(X, *coefs[i]))\n    plt.legend()\n    plt.show()","64320593":"import matplotlib.pyplot as plt\nfor i in as_sigmoid:\n    plt.plot(np_train[45:,i], label = str(i))\n    plt.plot(sigmoid(X, *coefs[i]))\n    plt.legend()\n    plt.show()","8180a9f7":"import matplotlib.pyplot as plt\nfor i in as_exponent:\n    plt.plot(np_train[45:,i], label = str(i))\n    plt.plot(exp(X, *coefs[i]))\n    plt.legend()\n    plt.show()","2c892214":"ConfirmedCases_test = np.zeros((294, test_days.shape[0]))","7b9e9741":"def new_linear(x, a, b, c):\n    return (a*(x-b)+c)*(a*(x-b)+c>=0)\n\ndef new_sigmoid(x, a, b, d, p):\n    return sigmoid(x, a, b, d, p)*(sigmoid(x, a, b, d, p)>=0)\n\ndef new_epx(x, a, b, d, p):\n    return exp(x, a, b, d, p)*(exp(x, a, b, d, p)>=0)","fdd4217e":"for i in range(np_train.shape[1]):\n    if i in as_exponent:\n        function = new_epx\n    if i in as_linear:\n        function = new_linear\n    if i in as_sigmoid:\n        function = new_sigmoid\n    ConfirmedCases_test[i] = function(test_days, *coefs[i])","d86c5712":"ConfirmedCases_test.flatten().shape[0]","7baeba08":"assert ConfirmedCases_test.flatten().shape[0] == test_data.shape[0]","54162852":"test_data['predict'] = ConfirmedCases_test.flatten()","5abfdc70":"test_data[test_data['Country_Region']=='Russia']","b0a8c564":"submission['ConfirmedCases'] = ConfirmedCases_test.flatten()\nsubmission['Fatalities'] = ConfirmedCases_test.flatten()*mask_mesh\nsubmission.to_csv('submission.csv', index=False)","8782f9aa":"**the number of deaths linearly depends on the number of infected. I will predict only ConfirmedCases and Fatalities = ConfirmedCases*(rate in each country)**","840587f1":"**Now, we can predict ConfirmedCases for test**","a50152ee":"**calculate death rate for each county (province). if no deaths at the moment, then rate = mean around the world**","ff0ab7a4":"**pick the shift between ConfirmedCases and Fatalities: infected people don't die right away**","51deff84":"**I search params for these functions with curve_fit, pre-selecting initial approximations for fast convergence.\nAnd i use only last 19 days for exp. and sigmoid and last 14 days for linear**","c11d9d0e":"**Fix fuctions (remove negative values for train (test data contains 5 last days from train)**","36c31834":"**Idea: approximation ConfirmedCases for each country by some function\nIf you look at the graphs, you can see three different functions:**\n* exponential\n* linear\n* sigmoid    \n\n**Lets pick functions with parameters for each counry**","acc74930":"\n**Let's see how it looks**"}}