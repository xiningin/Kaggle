{"cell_type":{"22bd6235":"code","3e3352c4":"code","a64cb14e":"code","9cd4aa08":"code","0a5de71d":"code","71ed25a8":"code","3ab6b202":"code","c541d39b":"code","7db058e6":"code","a06939af":"code","330b72ad":"code","86f578d3":"markdown","1c67498f":"markdown"},"source":{"22bd6235":"# Modules\nimport numpy as np \nimport pandas as pd\nimport matplotlib.pyplot as plt\nimport seaborn as sns\nimport scipy as sp \n\nimport os\nimport glob\nfrom IPython.display import display,HTML\nimport gc","3e3352c4":"# Preliminary\nCWD = os.getcwd()\nroot_path = lambda path: os.path.join(\"\/kaggle\/input\/cassava-leaf-disease-classification\",path)\npaths = {\n    \"train_tfrecords\" : root_path(\"train_tfrecords\"),\n    \"train_images\" : root_path(\"train_images\"),\n    \"train\" : root_path(\"train.csv\"),\n    \"test_images\" : root_path(\"test_images\"),\n    \"test_tfrecords\" : root_path(\"test_tfrecords\"),\n    \"sample_submission\" : root_path(\"sample_submission.csv\"),\n    \"labels\" : root_path(\"label_num_to_disease_map.json\"),\n}","a64cb14e":"# DATA\n# Have more than 50% data > 3 in labels. labels ~= [0,1,2,3,4]\n\ncassava = pd.read_csv(paths[\"train\"], usecols=[\"image_id\",\"label\"])\ntest_df = pd.read_csv(paths[\"sample_submission\"])\n\nunique_labels = cassava.label.unique()\n\nprint(f\"Shape: {cassava.shape}\")\ndisplay(cassava.head(2))\nplt.show(cassava.hist())\n\n\ntrain_images = [ im.split(\"\/\")[-1] for im \n                in glob.glob( paths[\"train_images\"] + \"\/*.jpg\") ]\n\ntrain_tfrecords = [ rec.split(\"\/\")[-1] for rec\n                   in glob.glob(paths[\"train_tfrecords\"] + \"\/*.tfrec\")]\n\n\n\nwith open(paths[\"labels\"],\"r\") as f:\n    import json\n    labels_dict = json.load(f)","9cd4aa08":"def prepare_df(df=cassava):\n    try:\n        df[\"img_paths\"] = pd.Series(os.path.join(paths[\"train_images\"], img) for img \n                                  in df[\"image_id\"] )\n        df = df.drop(\"image_id\", axis=1)\n    except Exception as e:\n        print(e)\n        \n    return df\n\ncassava = prepare_df(cassava)","0a5de71d":"# example image\nfrom keras.preprocessing.image import load_img, img_to_array\n\nimg = load_img(os.path.join(paths[\"train_images\"],train_images[2]))\nimg_array = np.asarray(img)\n\nprint(\"Image Shapes:\", img_array.shape)\nplt.imshow(img)\n","71ed25a8":"# Keras CNN model\nfrom tensorflow.keras.models import Sequential\nfrom tensorflow.keras.layers import Conv2D, MaxPooling2D, Dense, Flatten, Dropout\nfrom tensorflow.keras.utils import to_categorical\nfrom tensorflow.keras.preprocessing.image import load_img, img_to_array\n\ndef define_model():\n    model = Sequential()\n\n    model.add(Conv2D(32, kernel_size=2, padding=\"same\", input_shape=(600,800,3)))\n    model.add(MaxPooling2D(pool_size=2))\n    model.add(Conv2D(16, kernel_size=2, padding=\"same\"))\n    model.add(MaxPooling2D(pool_size=2))\n    model.add(Conv2D(8, kernel_size=2, padding=\"same\"))\n    model.add(MaxPooling2D(pool_size=2))\n    model.add(Flatten())\n    model.add(Dense(16, activation='relu'))\n    model.add(Dropout(0.2))\n    model.add(Dense(5, activation='softmax'))\n    \n    \n    model.compile(optimizer=\"adam\", \n             loss=\"categorical_crossentropy\",\n             metrics=[\"accuracy\"])\n    \n    return model\n\nmodel = define_model()\nprint(model.summary())","3ab6b202":"from PIL import Image\n\ndef get_features_target(df=cassava, _fraction=0.1):\n    \n    if _fraction:\n        df = df.sample(frac=_fraction)\n        \n    X = np.array([np.asarray(Image.open(img)) for img in df[\"img_paths\"]])\n    y = df[\"label\"].values.reshape((-1,1))\n    return X,y\n    \nX, y = get_features_target(_fraction=0.1)\n\nprint(\"X shape:\",X.shape)\nprint(\"Y shape:\", y.shape)","c541d39b":"# FIT!\nmodel.fit(X,to_categorical(y),\n          batch_size=20,\n          epochs=5,\n         )","7db058e6":"from PIL import Image\n\n\nex = Image.open(cassava.loc[100,\"img_paths\"])\nplt.imshow(ex)\nprint(\"Esta hojita es:\", labels_dict[cassava.loc[100,\"label\"].__str__()])","a06939af":"test_img_paths = [ os.path.join(paths[\"test_images\"],img) for img in test_df[\"image_id\"]]\nx_test = np.array([np.asarray(Image.open(img)) for img in test_img_paths])\ny_test = test_df[\"label\"].values.reshape(1,1)\n\nprint(f\"{x_test.shape}\", f\"{y_test.shape}\")","330b72ad":"preds = model.predict(x_test)\nbest_pred = np.argmax(preds)\ntest_df[\"label\"] = pd.Series(best_pred)\ntest_df.to_csv(\"submission.csv\", index=False, header=True)","86f578d3":"(DataFrames:) df\n\n(vectors:) train_images, train_tfrecords","1c67498f":"(dict:) **paths**"}}