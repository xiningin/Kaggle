{"cell_type":{"ea8ac0a7":"code","095029da":"code","eb9b511a":"code","cb96b24f":"code","14dca005":"code","e2876f4b":"code","2aa6aedf":"code","14ef571c":"code","a52e62ff":"code","d177424f":"code","506cf6e5":"code","30801c10":"code","21a4b076":"code","f671c82e":"code","aa13b85c":"code","f816c51b":"code","c88cf79a":"markdown","32c87303":"markdown","7068628b":"markdown","61a58e4b":"markdown","2b0af204":"markdown","66b1fb41":"markdown"},"source":{"ea8ac0a7":"%reload_ext autoreload\n%autoreload 2\n%matplotlib inline","095029da":"from fastai import *\nfrom fastai.vision import *","eb9b511a":"import warnings\nwarnings.filterwarnings(\"ignore\", category=UserWarning, module=\"torch.nn.functional\")","cb96b24f":"path = Path('..\/input\/siim-isic-melanoma-classification')\npath_512 = Path('..\/input\/siim-isic-melanoma-classification-jpeg512')","14dca005":"np.random.seed(2)\ndata = ImageDataBunch.from_csv(\n            path_512, folder='train512', csv_labels='train.csv', ds_tfms=get_transforms(), label_col=7, size=128, suffix='.jpg', num_workers=0\n        ).normalize(imagenet_stats)","e2876f4b":"data.classes, data.c, len(data.train_ds), len(data.valid_ds), data.batch_size","2aa6aedf":"data.show_batch(rows=3, figsize=(12,9))","14ef571c":"learn = cnn_learner(data, models.resnet34, metrics=AUROC(), model_dir = '\/kaggle\/working')","a52e62ff":"! wget link-to-stage-8.pth","d177424f":"learn.load('stage-8')\nlearn.data = data","506cf6e5":"learn.fit_one_cycle(\n    10, slice(1e-7), callbacks=[callbacks.SaveModelCallback(learn, every='improvement', monitor='auroc', name='stage-9')]\n)","30801c10":"learn.load('stage-9')","21a4b076":"learn.export('\/kaggle\/working\/export.pkl')","f671c82e":"learner = load_learner('\/kaggle\/working')","aa13b85c":"img = open_image(path\/'jpeg\/test\/ISIC_0052060.jpg')\n\n\npred_class,pred_idx,outputs = learner.predict(img)\n\n# Get the probability of malignancy\n\nprob_malignant = float(outputs[1])\n\nprint(pred_class)\nprint(prob_malignant)","f816c51b":"test = os.listdir(path\/'jpeg\/test')\ntest.sort(key=lambda f: int(re.sub('\\D', '', f)))\n\nwith open('\/kaggle\/working\/submission.csv', 'w', newline='') as file:\n    writer = csv.writer(file)\n    writer.writerow(['image_name', 'target'])\n    \n    for image_file in test:\n        image = os.path.join(path\/'jpeg\/test', image_file) \n        image_name = Path(image).stem\n\n        img = open_image(image)\n        pred_class,pred_idx,outputs = learner.predict(img)\n        target = float(outputs[1])\n\n        \n        writer.writerow([image_name, target])","c88cf79a":"As has been pointed out [here](https:\/\/www.kaggle.com\/edkahara\/fast-ai-v3-melanoma-classification#912974), the probability of malignancy will always be `outputs[1]`. This means we may have submitted probabilities that were not the target probabilities in previous versions. This terrible oversight has been corrected. ","32c87303":"# SIIM-ISIC Melanoma Classification\n\nThis is my solution to the [SIIM-ISIC Melanoma Classification](https:\/\/www.kaggle.com\/c\/siim-isic-melanoma-classification) competition using ResNet34.","7068628b":"I set up the `stage-8` model I created in the previous version. I will use this model to attempt to create a better model.","61a58e4b":"In order to make it easier to train,we will use [resized images](https:\/\/www.kaggle.com\/itacdonev\/siim-isic-melanoma-classification-jpeg512) (Thank you [stats](https:\/\/www.kaggle.com\/itacdonev)). Working with the current images in the `jpeg\/train` folder, it would take 5 hours to run one complete epoch (See Version 1) because the images are of different sizes and fastai would need to resize each batch on the fly. If the images are resized beforehand, it will take less time to train, meaning we can run more epochs.","2b0af204":"We will experiment with much lower learning rates.","66b1fb41":"We add a callback called `SaveModelCallback` that will save the best model generated by `fit_one_cycle`."}}