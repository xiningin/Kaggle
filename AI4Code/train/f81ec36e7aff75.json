{"cell_type":{"aa3c0292":"code","322547db":"code","e23c5b5f":"code","1143f9d1":"code","d95b825c":"code","babd0a7b":"code","e388a0ae":"code","3c5f8564":"code","9b712404":"code","ba8d2a9a":"code","eb8933a7":"code","01cab692":"code","d2cf0a28":"code","76210887":"code","c573ccec":"code","d8a9df26":"code","c37ecc80":"code","30c53e96":"code","68b933c2":"code","03a7dadd":"code","ef978e94":"code","5e5d5c3a":"code","a86b8312":"code","588596d5":"code","6c028aaa":"code","d032f2e5":"code","834ca6ab":"code","4bbbed8f":"code","1b53c995":"code","dafe8a49":"code","f442f2b6":"code","47384e05":"code","8366edd0":"code","daed40d0":"code","e44d65c1":"code","1adf31c2":"code","6a9b1258":"code","b578f652":"code","94a44a96":"code","824b2178":"code","363a23da":"code","dcf4fc84":"code","f818d13c":"markdown","a5ae557b":"markdown","bf130404":"markdown","31099e12":"markdown","c21fe1b3":"markdown","db3ff836":"markdown","65ce1e03":"markdown","5b875751":"markdown","8937a056":"markdown","541e7b70":"markdown","fd3f0379":"markdown","dc706644":"markdown","daf14a8a":"markdown","924d6a2d":"markdown","50acfbf9":"markdown","cd9bbd27":"markdown","9ba5b0ee":"markdown","16369b8c":"markdown","b39fee3e":"markdown","1e9f82c1":"markdown","5f0783c2":"markdown","e0453f94":"markdown","68d2023e":"markdown","d2d5213e":"markdown","4d80e5ef":"markdown","337c982a":"markdown","a465e3f8":"markdown","83c5eb42":"markdown","7de598a1":"markdown","dd371fa8":"markdown","39599441":"markdown","bd2c71de":"markdown","ddf0d34f":"markdown","27d01fe0":"markdown","70bc287c":"markdown","05ed0a86":"markdown","5f9a7d6e":"markdown","34ea2b51":"markdown","2c69cfdb":"markdown","3f042b93":"markdown"},"source":{"aa3c0292":"# Disable warnings in Anaconda\nimport warnings\nwarnings.filterwarnings('ignore')\n\nimport numpy as np\nimport pandas as pd\n%matplotlib inline\nimport matplotlib.pyplot as plt\nimport seaborn as sns\nsns.set()","322547db":"from matplotlib import rcParams\nrcParams['figure.figsize'] = 11, 8","e23c5b5f":"def fill_nan(table, method='median'):\n    for col in table:\n        table.fillna(value=table[col].agg(method), inplace=True)\n    return table","1143f9d1":"data = pd.read_csv('..\/input\/credit_scoring_sample.csv')\ndata.head()","d95b825c":"data.describe()","babd0a7b":"data.info()","e388a0ae":"data.isnull().sum(axis=0)","3c5f8564":"data.dtypes","9b712404":"ax = data['SeriousDlqin2yrs'].value_counts().plot.bar(color=['red', 'blue'])\nax.set_xticklabels(ax.get_xticks(), rotation=0)\nax.set(xlabel='values', ylabel='Counts', title='Histogram plot of frequyency by SeriousDlqin2yrs')\n","ba8d2a9a":"ax = data['SeriousDlqin2yrs'].hist(orientation='horizontal', color='red')\nax.set_xlabel(\"number_of_observations\")\nax.set_ylabel(\"unique_value\")\nax.set_title(\"Target distribution\")\n\nprint('Distribution of the target:')\ndata['SeriousDlqin2yrs'].value_counts()\/data.shape[0]","eb8933a7":"independent_columns_names = [x for x in data if x != 'SeriousDlqin2yrs']\nindependent_columns_names","01cab692":"table = fill_nan(data)","d2cf0a28":"X = table[independent_columns_names]\ny = table['SeriousDlqin2yrs']","76210887":"#lower bound\nX[y==1][\"age\"].mean() + 1.65  *X[y==1][\"age\"].std() \/ np.sqrt(len(X[y==1]))","c573ccec":"#upper bound\nX[y==1][\"age\"].mean() - 1.65  *X[y==1][\"age\"].std() \/ np.sqrt(len(X[y==1]))","d8a9df26":"from sklearn.linear_model import LogisticRegression\nfrom sklearn.model_selection import GridSearchCV, StratifiedKFold","c37ecc80":"lr = LogisticRegression(random_state=5, class_weight='balanced')","30c53e96":"parameters = {'C': (0.0001, 0.001, 0.01, 0.1, 1, 10)}","68b933c2":"skf = StratifiedKFold(n_splits=5, shuffle=True, random_state=5)","03a7dadd":"# Your code here\ngridsearch = GridSearchCV(estimator=lr, param_grid=parameters, scoring='roc_auc', cv=skf)\ngridsearch.fit(X, y)","ef978e94":"pd.DataFrame(gridsearch.cv_results_).sort_values(by='mean_test_score', ascending=False)","5e5d5c3a":"gridsearch.best_params_","a86b8312":"# Your code here\npd.DataFrame(gridsearch.cv_results_).sort_values(by='mean_test_score', ascending=False)[\"std_test_score\"][1]","588596d5":"# Your code here\ndisplay(X.head(5))","6c028aaa":"from sklearn.preprocessing import StandardScaler\nimport eli5\nscaler = StandardScaler()\nlr = LogisticRegression(C=0.001)\nX_scaled = scaler.fit_transform(X)\nlr.fit(X_scaled, y)\neli5.show_weights(estimator=lr, feature_names=X.columns.tolist(), feature_filter=lambda x: x != '<BIAS>')","d032f2e5":"list(zip(X.columns.tolist(), lr.coef_[0].tolist()))","834ca6ab":"# Your code here\nlr = LogisticRegression(C=0.001, multi_class='multinomial', solver='lbfgs')\nlr.fit(X_scaled, y)\npd.DataFrame(list(zip(X.columns.tolist(), lr.coef_[0].tolist()))).rename(columns={0:'Features', 1:'Weights'}).set_index('Features').sort_values(by='Weights', ascending=False)","4bbbed8f":"# Your code here\nlr = LogisticRegression(C=0.001, random_state=5, class_weight='balanced')\nlr.fit(X, y)\n\npd.DataFrame({'feat': independent_columns_names,\n              'coef': lr.coef_.flatten().tolist()}).sort_values(by='coef', ascending=False)","1b53c995":"np.exp(lr.coef_ * 20)[0][0]","dafe8a49":"from sklearn.ensemble import RandomForestClassifier","f442f2b6":"rf = RandomForestClassifier(n_estimators=100, n_jobs=-1, random_state=42, \n                            class_weight='balanced')","47384e05":"parameters = {'max_features': [1, 2, 4], 'min_samples_leaf': [3, 5, 7, 9], 'max_depth': [5,10,15]}","8366edd0":"# Your code here\nskf = StratifiedKFold(n_splits=5, shuffle=True, random_state=5)\ngridsearch = GridSearchCV(estimator=rf, param_grid=parameters, cv=skf, scoring='roc_auc', n_jobs=-1)\ngridsearch.fit(X, y)\npd.DataFrame(gridsearch.cv_results_).sort_values(by='mean_test_score', ascending=False)","daed40d0":"gridsearch.best_score_","e44d65c1":"# Your code here\npd.DataFrame({'Features': X.columns, 'Importances':gridsearch.best_estimator_.feature_importances_}).sort_values(by='Importances',ascending=True)","1adf31c2":"from sklearn.ensemble import BaggingClassifier\nfrom sklearn.model_selection import cross_val_score, RandomizedSearchCV\n\nparameters = {'max_features': [2, 3, 4], 'max_samples': [0.5, 0.7, 0.9], \n              'base_estimator__C': [0.0001, 0.001, 0.01, 1, 10, 100]}","6a9b1258":"# Your code here\nbag_clf = BaggingClassifier(base_estimator=LogisticRegression(class_weight='balanced'), n_estimators=100, n_jobs=-1, random_state=42)\nskf = StratifiedKFold(n_splits=5, shuffle=True, random_state=5)\nrandomsearch = RandomizedSearchCV(estimator=bag_clf, param_distributions=parameters, \n                                  scoring='roc_auc', n_jobs=-1, cv=skf, n_iter=20, verbose=True, random_state=1)\nrandomsearch.fit(X, y)","b578f652":"gridsearch = GridSearchCV(estimator=bag_clf, param_grid=parameters, scoring='roc_auc', n_jobs=-1, cv=skf, verbose=True)\ngridsearch.fit(X, y)","94a44a96":"pd.DataFrame(gridsearch.cv_results_)","824b2178":"randomsearch.best_params_","363a23da":"randomsearch.best_score_","dcf4fc84":"pd.DataFrame(randomsearch.cv_results_).sort_values(by='mean_test_score', ascending=False)","f818d13c":"<center>\n<img src=\"https:\/\/habrastorage.org\/files\/fd4\/502\/43d\/fd450243dd604b81b9713213a247aa20.jpg\">\n## Open Machine Learning Course [mlcourse.ai](https:\/\/mlcourse.ai)\n<center>\n\nAuthor: Vitaly Radchenko (@vradchenko). This material is subject to the terms and conditions of the [Creative Commons CC BY-NC-SA 4.0](https:\/\/creativecommons.org\/licenses\/by-nc-sa\/4.0\/) license. Free use is permitted for any non-commercial purpose.","a5ae557b":"Import modules and set up the parameters for bagging:","bf130404":"Check the class balance:","31099e12":"**Question 11.** Fit a bagging classifier with `random_state=42`. For the base classifiers, use 100 logistic regressors and use `RandomizedSearchCV` instead of `GridSearchCV`. It will take a lot of time to iterate over all 54 variants, so set the maximum number of iterations for `RandomizedSearchCV` to 20. Don't forget to set the parameters `cv` and `random_state=1`. What is the best *ROC AUC* you achieve?\n\n1. 80.75%\n2. 80.12%\n3. 79.62%\n4. 76.50%","c21fe1b3":"We will search for the best parameters among the following values:","db3ff836":"In this assignment, you will build models and answer questions using data on credit scoring.\n\nPlease write your code in the cells with the \"Your code here\" placeholder. Then, answer the questions in the [form](https:\/\/docs.google.com\/forms\/d\/1gKt0DA4So8ohKAHZNCk58ezvg7K_tik26d9QND7WC6M\/edit).\n\nLet's start with a warm-up exercise.","65ce1e03":"**Question 9.** What feature has the weakest impact in the Random Forest model?\n\n1. age\n2. NumberOfTime30-59DaysPastDueNotWorse\n3. DebtRatio\n4. NumberOfTimes90DaysLate\n5. NumberOfTime60-89DaysPastDueNotWorse\n6. MonthlyIncome\n7. NumberOfDependents","5b875751":"## Bagging","8937a056":"Great! Let's move on to machine learning.\n\n## Credit scoring problem setup\n\n#### Problem\n\nPredict whether the customer will repay their credit within 90 days. This is a binary classification problem; we will assign customers into good or bad categories based on our prediction.\n\n#### Data description\n\n| Feature | Variable Type | Value Type | Description |\n|:--------|:--------------|:-----------|:------------|\n| age | Input Feature | integer | Customer age |\n| DebtRatio | Input Feature | real | Total monthly loan payments (loan, alimony, etc.) \/ Total monthly income percentage |\n| NumberOfTime30-59DaysPastDueNotWorse | Input Feature | integer | The number of cases when client has overdue 30-59 days (not worse) on other loans during the last 2 years |\n| NumberOfTimes90DaysLate | Input Feature | integer | Number of cases when customer had 90+dpd overdue on other credits |\n| NumberOfTime60-89DaysPastDueNotWorse | Input Feature | integer | Number of cased when customer has 60-89dpd (not worse) during the last 2 years |\n| NumberOfDependents | Input Feature | integer | The number of customer dependents |\n| SeriousDlqin2yrs | Target Variable | binary: <br>0 or 1 | Customer hasn't paid the loan debt within 90 days |\n","541e7b70":"## Logistic regression","fd3f0379":"In order to find the optimal value of `C`, let's apply stratified 5-fold validation and look at the *ROC AUC* against different values of the parameter `C`. Use the `StratifiedKFold` function for this: ","dc706644":"Import the Random Forest classifier:","daf14a8a":"Let's write the function that will replace *NaN* values with the median for each column.","924d6a2d":"Also, we will use the stratified k-fold validation again. You should still have the `skf` variable.","50acfbf9":"Now, we will create a `LogisticRegression` model and use `class_weight='balanced'` to make up for our unbalanced classes.","cd9bbd27":"**Question 12.** Give an interpretation of the best parameters for bagging. Why are these values of `max_features` and `max_samples` the best?\n\n1. For bagging it's important to use as few features as possible;\n2. Bagging works better on small samples;\n3. Less correlation between single models;\n4. The higher the number of features, the lower the loss of information.","9ba5b0ee":"# <center>Assignment # 5 (demo)<\/center>\n## <center>Logistic Regression and Random Forest in the credit scoring problem<\/center>  ","16369b8c":"An increase in debt ratio by one unit leads to the lower probability of delayed repayment.","b39fee3e":"**Question 3.** Perform a *Grid Search* with the scoring metric \"roc_auc\" for the parameter `C`. Which value of the parameter `C` is optimal? \n\n1. 0.0001\n2. 0.001\n3. 0.01\n4. 0.1\n5. 1\n6. 10","1e9f82c1":"Separate the input variable names by excluding the target:","5f0783c2":"**Question 6.** Calculate how much `DebtRatio` affects our prediction using the [softmax function](https:\/\/en.wikipedia.org\/wiki\/Softmax_function). What is its value?\n\n1. 0.38\n2. -0.02\n3. 0.11\n4. 0.24","e0453f94":"Now, read the data:","68d2023e":"Separate the target variable and input features:","d2d5213e":"## Random Forest","4d80e5ef":"**Question 2.** Make an interval estimate of the average age for the customers who delayed repayment at the 90% confidence level. Use the example from the article as reference, if needed. Also, use `np.random.seed(0)` as before. What is the resulting interval estimate?\n\n1. 52.59 \u2013 52.86\n2. 45.71 \u2013 46.13\n3. 45.68 \u2013 46.17\n4. 52.56 \u2013 52.88","337c982a":"**Question 1.** There are 5 jurors in a courtroom. Each of them can correctly identify the guilt of the defendant with 70% probability, independent of one another. What is the probability that the jurors will jointly reach the correct verdict if the final decision is by majority vote?\n\n1. 70.00%\n2. 83.20%\n3. 83.70%\n4. 87.50%","a465e3f8":"Let's set up our environment:","83c5eb42":"Apply the function to replace *NaN* values:","7de598a1":"Let's set up to use logistic regression:","dd371fa8":"Let's try to find the best regularization coefficient, which is the coefficient `C` for logistic regression. Then, we will have an optimal model that is not overfit and is a good predictor of the target variable.","39599441":"3. Feature interpretability;\n","bd2c71de":"## Bootstrapping","ddf0d34f":"## Feature importance\n\n**Question 5.** *Feature importance* is defined by the absolute value of its corresponding coefficient. First, you need to normalize all of the feature values so that it will be valid to compare them. What is the most important feature for the best logistic regression model?\n\n1. age\n2. NumberOfTime30-59DaysPastDueNotWorse\n3. DebtRatio\n4. NumberOfTimes90DaysLate\n5. NumberOfTime60-89DaysPastDueNotWorse\n6. MonthlyIncome\n7. NumberOfDependents","27d01fe0":"One of the important metrics of model quality is the *Area Under the Curve (AUC)*. *ROC AUC* varies from 0 to 1. The closer ROC AUC is to 1, the better the quality of the classification model.","70bc287c":"**Question 8.** How much higher is the *ROC AUC* of the best random forest model than that of the best logistic regression on validation?\n\n1. 4%\n2. 3%\n3. 2%\n4. 1%","05ed0a86":"**Question 7.** Let's see how we can interpret the impact of our features. For this, recalculate the logistic regression with absolute values, that is without scaling. Next, modify the customer's age by adding 20 years, keeping the other features unchanged. How many times will the chance that the customer will not repay their debt increase? You can find an example of the theoretical calculation [here](https:\/\/www.unm.edu\/~schrader\/biostat\/bio2\/Spr06\/lec11.pdf).\n\n1. -0.01\n2. 0.70\n3. 8.32\n4. 0.66","5f9a7d6e":"Look at the variable types:","34ea2b51":"**Question 4.** Can we consider the best model stable? The model is *stable* if the standard deviation on validation is less than 0.5%. Save the *ROC AUC* value of the best model; it will be useful for the following tasks.\n\n1. Yes\n2. No","2c69cfdb":"**Question 10.** What is the most significant advantage of using *Logistic Regression* versus *Random Forest* for this problem?\n\n1. Spent less time for model fitting;\n2. Fewer variables to iterate;\n3. Feature interpretability;\n4. Linear properties of the algorithm.","3f042b93":"Initialize Random Forest with 100 trees and balance target classes:"}}