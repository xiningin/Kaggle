{"cell_type":{"8c0ae6b4":"code","20e0db0a":"code","4e231de6":"code","f2501427":"code","2074364e":"code","ab4a4db8":"code","9adc3300":"code","c426a729":"code","b5393e62":"code","4d47ebf8":"code","d115bc24":"code","b8c712b5":"code","36b13c1d":"code","a1a06634":"code","5ad9bb6f":"markdown","d2c6dc78":"markdown","af68205a":"markdown","552356cf":"markdown","4229f65f":"markdown"},"source":{"8c0ae6b4":"!pip install beautifulsoup4 -q -q","20e0db0a":"from jt_mk_utils import *\nfrom transformers import pipeline\nfrom bs4 import BeautifulSoup\nimport re\nimport numpy as np\nfrom tqdm.notebook import tqdm","4e231de6":"classifier = pipeline(\"sentiment-analysis\", framework=\"pt\", device=0)\n# max tokens evaluated per forum post: long posts are truncated\nclassifier.tokenizer.model_max_length","f2501427":"def get_html_text(s):\n    soup = BeautifulSoup(s, \"html.parser\")\n    # removed quoted text written by others\n    for data in soup([\"style\", \"script\", \"iframe\", \"blockquote\", \"code\"]):\n        data.decompose()\n    txt = soup.get_text()\n    txt = re.sub(r\"\\[quote.*\\[\/quote\\]\", \" \", txt, flags=re.S)\n    txt = txt.strip()\n    return txt","2074364e":"forum_messages = read_forum_messages(index_col=0)\nforum_messages.shape","ab4a4db8":"%%time\ntext = forum_messages.Message.fillna(\"\").apply(get_html_text)","9adc3300":"# V2: sort by length, batches with lower maximum length are quicker\ntext = text.iloc[text.str.len().argsort()]\ntext.shape","c426a729":"batch_size = 100\nbatch_ids = np.arange(len(text)) \/\/ batch_size\nbatch_ids","b5393e62":"dfs = []\nfor batch_id, sub in tqdm(text.groupby(batch_ids)):\n    result = classifier(list(sub), truncation=True)\n    dfs.append(pd.DataFrame(result, index=sub.index))","4d47ebf8":"df = pd.concat(dfs)\ndf.shape","d115bc24":"df.label.value_counts()","b8c712b5":"df.groupby(\"label\").score.agg([\"count\", \"sum\", \"min\", \"mean\", \"max\"])","36b13c1d":"df.sort_index().to_csv(\"forum-messages-sentiment-analysis.csv\")","a1a06634":"_ = \"\"\"\nRe-run to include recently completed competitions:\n\n\tSlug:rsna-miccai-brain-tumor-radiogenomic-classification\n\tSlug:nfl-health-and-safety-helmet-assignment\n\tSlug:ventilator-pressure-prediction\n\tSlug:chaii-hindi-and-tamil-question-answering\n\tSlug:tabular-playground-series-oct-2021\n\tSlug:tabular-playground-series-nov-2021\n\n\"\"\"","5ad9bb6f":"# Run HuggingFace Sentiment Analysis on Forum Posts\n\nThis notebook uses the [Meta Kaggle](https:\/\/www.kaggle.com\/kaggle\/meta-kaggle) dataset and computes a positive\/negative sentiment score for all the Kaggle forum posts using the [HuggingFace Sentiment Analysis Pipeline](https:\/\/huggingface.co\/transformers\/main_classes\/pipelines.html), saving the results for later analysis.\n\n___\n\nSee the follow-up Notebook here: [A Look at Sentiment on the Kaggle Forums](https:\/\/www.kaggle.com\/jtrotman\/a-look-at-sentiment-on-the-kaggle-forums)","d2c6dc78":"#\u00a0Run Pipeline","af68205a":"Check out [A Look at Sentiment on the Kaggle Forums](https:\/\/www.kaggle.com\/jtrotman\/a-look-at-sentiment-on-the-kaggle-forums) to see some ways to use these scores.","552356cf":"#\u00a0Parse HTML","4229f65f":"#\u00a0Save"}}