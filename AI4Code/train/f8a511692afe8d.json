{"cell_type":{"2853fd07":"code","12855c83":"code","d7fc7c6c":"code","5318a9a4":"code","13f59b4e":"code","ee69eb88":"code","2a93dd31":"code","4247bb7e":"code","908ee219":"code","823aba83":"code","3e46d260":"code","023aa5ca":"markdown","f2956fc2":"markdown"},"source":{"2853fd07":"!pip install codecarbon","12855c83":"import os\nimport numpy as np\nimport random\nimport pandas as pd\nimport matplotlib.pyplot as plt\nfrom sklearn.model_selection import StratifiedKFold\nfrom sklearn import preprocessing\nfrom sklearn.metrics import mean_absolute_error, roc_auc_score\nfrom tqdm.notebook import tqdm\nfrom sklearn.ensemble import RandomForestClassifier\nfrom joblib import dump, load\nimport xgboost as xgb\nfrom codecarbon import EmissionsTracker\n\n\nimport warnings\nwarnings.filterwarnings('ignore')","d7fc7c6c":"PATH = '..\/input\/tabular-playground-series-nov-2021'\ntrain = pd.read_csv(os.path.join(PATH, 'train.csv'))\ntest = pd.read_csv(os.path.join(PATH, 'test.csv'))\nsub = pd.read_csv(os.path.join(PATH, 'sample_submission.csv'))","5318a9a4":"train.head()","13f59b4e":"test.head()\n","ee69eb88":"train['target'].value_counts(normalize=True)\n","2a93dd31":"def random_seed(seed=42):\n    random.seed(seed)\n    np.random.seed(seed)\n    os.environ['PYTHONHASHSEED'] = str(seed)","4247bb7e":"columns = [col for col in train.columns if col not in ['id', 'target'] ]","908ee219":"def run_fold(train, test, n_folds, seed):\n    \n    xgb_params= {\n        \"n_estimators\": 20000,\n        \"max_depth\": 9,\n        \"objective\":\"binary:logistic\",\n        \"n_jobs\": 4,\n        \"seed\": seed,\n        'tree_method': \"gpu_hist\",\n        \"gpu_id\": 0,\n        \"eval_metric\": \"auc\", \n        \"subsample\": 0.9503849496446212,\n        \"colsample_bytree\": 0.8386620226451398,\n        \"learning_rate\": 0.010434908598392401,\n        \"reg_lambda\": 4.949388720017554e-08,\n        \"reg_alpha\": 35.063181724411116,\n        \"predictor\": \"gpu_predictor\"\n    }\n    \n    random_seed(seed)\n\n    auc_score = []\n\n    train = train.sample(frac=1).reset_index(drop=True)\n\n    targets = train['target'].values\n\n    kf = StratifiedKFold(n_splits=n_folds, shuffle=True, random_state=seed)    \n        \n    oof = np.zeros((train.shape[0],))\n    test_preds = 0\n\n    for f, (train_idx, val_idx) in tqdm(enumerate(kf.split(train, targets))):\n            df_train, df_val = train.iloc[train_idx][columns], train.iloc[val_idx][columns]\n            train_target, val_target = targets[train_idx], targets[val_idx]\n        \n            model = xgb.XGBClassifier(**xgb_params)\n        \n            model.fit(\n                df_train[columns], \n                train_target,\n                eval_set=[(df_val[columns], val_target)],\n                early_stopping_rounds=133,\n                verbose=1000\n            )\n        \n            oof_tmp = model.predict_proba(df_val[columns])[:,1]\n            test_tmp = model.predict_proba(test[columns])[:,1]   \n        \n            oof[val_idx] = oof_tmp\n            test_preds += test_tmp\/n_folds\n            auc = roc_auc_score(val_target, oof_tmp)\n            auc_score.append(auc)\n            print(f'FOLD: {f} SEED:{seed} AUC: {auc} Mean AUC: {np.mean(auc_score)}')\n    return test_preds, oof","823aba83":"def run_model(train, test, n_folds):\n    _predictions = 0\n    _oof = 0\n    \n    SEED = [42, 43, 1019, 1020, 2019, 2021]\n    \n    for seed in SEED:\n    \n        predictions, oof = run_fold(train, test, n_folds, seed)\n        _predictions +=predictions\/len(SEED)\n        _oof +=oof\/len(SEED)\n        \n    return _predictions, _oof","3e46d260":"if __name__=='__main__':\n    tracker = EmissionsTracker()\n    tracker.start()\n    \n    predictions, oof = run_model(train, test, 5)\n    \n    emissions: float = tracker.stop()\n    print(f\"Carbon Emissions: {emissions} kg\")\n    \n    sub['target'] = predictions\n    sub.to_csv('submission.csv', index=False)","023aa5ca":" ![ Write anything over here ](https:\/\/github.com\/mlco2\/codecarbon\/raw\/master\/docs\/edit\/images\/banner.png) ","f2956fc2":"# **Estimate and track carbon emissions from your compute, quantify and analyze their impact.**\n\n**for more details -> https:\/\/codecarbon.io\/**"}}