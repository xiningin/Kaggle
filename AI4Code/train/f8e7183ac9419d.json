{"cell_type":{"4d4ce9e9":"code","77d6d606":"code","a05cd781":"code","fce88a02":"code","144ae953":"code","82dfb875":"code","52407185":"code","a12bd788":"code","a23aca44":"code","76abb99a":"code","2504062c":"code","e5b72d0c":"code","2fbffd64":"code","b7d1ae18":"code","f7148999":"code","4f3484ad":"code","b6d3c4b0":"code","15fcf1b3":"code","bd33031f":"code","d83c0e33":"code","e4e8d413":"code","d4826291":"code","512f74b9":"code","bd6fd764":"code","9131a3d9":"code","44c17fd0":"code","983ffb0f":"code","d2bb1964":"code","49da90ec":"code","626ad374":"code","0f40c3d3":"code","82606c14":"code","91ed30f4":"code","e4736d13":"code","378fbb26":"code","c8ea949c":"code","294b32da":"code","35571e34":"code","dd5204fb":"code","d797ec27":"code","0bb62285":"code","4e44c1b4":"code","28b8ae51":"code","f270f25e":"code","a3d022e2":"code","40cf8179":"code","460c2929":"code","c7029043":"code","17279501":"code","b680ba62":"code","710c7706":"code","528c4d51":"code","d9b940a5":"code","9961f700":"code","54a89467":"code","b89ee930":"code","1db8ab3c":"code","a084cc8a":"code","a037eea7":"code","d6b28d4a":"code","05f741e1":"code","f5fb4450":"code","d2e76212":"code","10c74d2b":"code","f6c1536f":"code","042c38b2":"code","965cb2f9":"code","ca069b55":"code","af6718d3":"code","668cd5f1":"code","6144ec84":"code","876dffb2":"code","569f4778":"code","eb1d4fe4":"code","482a91f4":"code","25b16eda":"code","390236a8":"code","c390ba05":"code","553f7b01":"code","1c91f1d9":"code","b3070a03":"code","8036a8db":"code","0f3a4fad":"code","286edb77":"code","c1a071b2":"code","ba9c9ac5":"code","67a09348":"code","1466dbeb":"code","edd407c2":"code","8ba63f1b":"code","0d48230b":"code","eedb6ac2":"code","d791c8ed":"code","1859a8d5":"code","508ab0ad":"code","0689d5ab":"code","8bf2ec02":"code","9023ae5e":"code","01213f7f":"code","24f599ee":"code","2d3ebbe0":"code","4d8182e5":"code","adebab0a":"code","89e32b0e":"code","99b105a6":"code","845be2f5":"code","72586987":"code","3da10438":"code","014df02c":"code","c3889a2f":"code","c32b4dc2":"code","de47903f":"code","eb1e2430":"code","e2134243":"code","0c924ce1":"code","ec76e3da":"code","4e8a6676":"code","5f797387":"code","5faca915":"code","4cb1d743":"code","ad75be6a":"code","70444fe5":"code","669ae973":"code","f2b5b94b":"markdown","5fad06ed":"markdown","aaa98158":"markdown","882044c2":"markdown","f342fc79":"markdown","da281dae":"markdown","aa295523":"markdown","2e75ffa1":"markdown","c0cde810":"markdown","0502f5cb":"markdown","1a078e20":"markdown","2966b650":"markdown","5eafadb3":"markdown","119cfcfc":"markdown","84473ed3":"markdown","1bcb83d4":"markdown","e7193bec":"markdown","90b4251b":"markdown","1f832651":"markdown","56349566":"markdown","561af0c8":"markdown","0688953b":"markdown","2f4f69c7":"markdown","56553544":"markdown","75481da4":"markdown","ff1d1cfb":"markdown","1abfd645":"markdown","75436fa6":"markdown","31148a06":"markdown","a39f84ad":"markdown","79c7bdc1":"markdown","8931acd4":"markdown","f750d0f2":"markdown"},"source":{"4d4ce9e9":"import numpy as np\nimport pandas as pd\nimport matplotlib.pyplot as plt\nimport seaborn as sns\nimport gc,os,sys\nimport re\n\nfrom sklearn import metrics, preprocessing\nfrom sklearn.model_selection import StratifiedKFold\nfrom sklearn.decomposition import PCA, KernelPCA\nfrom sklearn.discriminant_analysis import LinearDiscriminantAnalysis as LDA\nfrom sklearn.cluster import KMeans\nfrom tqdm import tqdm\n\nimport warnings\nwarnings.filterwarnings('ignore')\n\nsns.set_style('darkgrid')\n\npd.options.display.float_format = '{:,.3f}'.format\n\nprint(os.listdir(\"..\/input\"))","77d6d606":"# Memory saving function credit to https:\/\/www.kaggle.com\/gemartin\/load-data-reduce-memory-usage\ndef reduce_mem_usage(df):\n    \"\"\" iterate through all the columns of a dataframe and modify the data type\n        to reduce memory usage.\n    \"\"\"\n    start_mem = df.memory_usage().sum() \/ 1024**2\n    \n    for col in df.columns:\n        col_type = df[col].dtype\n        \n        if col_type != object:\n            c_min = df[col].min()\n            c_max = df[col].max()\n            if str(col_type)[:3] == 'int':\n                if c_min > np.iinfo(np.int8).min and c_max < np.iinfo(np.int8).max:\n                    df[col] = df[col].astype(np.int8)\n                elif c_min > np.iinfo(np.int16).min and c_max < np.iinfo(np.int16).max:\n                    df[col] = df[col].astype(np.int16)\n                elif c_min > np.iinfo(np.int32).min and c_max < np.iinfo(np.int32).max:\n                    df[col] = df[col].astype(np.int32)\n                elif c_min > np.iinfo(np.int64).min and c_max < np.iinfo(np.int64).max:\n                    df[col] = df[col].astype(np.int64)  \n            else:\n                if c_min > np.finfo(np.float16).min and c_max < np.finfo(np.float16).max:\n                    df[col] = df[col].astype(np.float16)\n                elif c_min > np.finfo(np.float32).min and c_max < np.finfo(np.float32).max:\n                    df[col] = df[col].astype(np.float32)\n                else:\n                    df[col] = df[col].astype(np.float64)\n        #else:\n            #df[col] = df[col].astype('category')\n\n    end_mem = df.memory_usage().sum() \/ 1024**2\n    print('Memory usage of dataframe is {:.2f} MB --> {:.2f} MB (Decreased by {:.1f}%)'.format(\n        start_mem, end_mem, 100 * (start_mem - end_mem) \/ start_mem))\n    return df","a05cd781":"%%time\ntrain_id = pd.read_csv('..\/input\/train_identity.csv')\ntrain_trn = pd.read_csv('..\/input\/train_transaction.csv')\ntest_id = pd.read_csv('..\/input\/test_identity.csv')\ntest_trn = pd.read_csv('..\/input\/test_transaction.csv')","fce88a02":"train_id = reduce_mem_usage(train_id)\ntrain_trn = reduce_mem_usage(train_trn)\ntest_id = reduce_mem_usage(test_id)\ntest_trn = reduce_mem_usage(test_trn)","144ae953":"print(train_id.shape, test_id.shape)\nprint(train_trn.shape, test_trn.shape)","82dfb875":"[c for c in train_trn.columns if c not in test_trn.columns]","52407185":"fc = train_trn['isFraud'].value_counts(normalize=True).to_frame()\nfc.plot.bar()\nfc.T","a12bd788":"fig,ax = plt.subplots(2, 1, figsize=(16,8))\n\ntrain_trn['_seq_day'] = train_trn['TransactionDT'] \/\/ (24*60*60)\ntrain_trn['_seq_week'] = train_trn['_seq_day'] \/\/ 7\ntrain_trn.groupby('_seq_day')['isFraud'].mean().to_frame().plot.line(ax=ax[0])\ntrain_trn.groupby('_seq_week')['isFraud'].mean().to_frame().plot.line(ax=ax[1])","a23aca44":"import datetime\n\nSTART_DATE = '2017-11-30'\nstartdate = datetime.datetime.strptime(START_DATE, \"%Y-%m-%d\")\ntrain_trn['Date'] = train_trn['TransactionDT'].apply(lambda x: (startdate + datetime.timedelta(seconds=x)))\ntrain_trn['_ymd'] = train_trn['Date'].dt.year.astype(str) + '-' + train_trn['Date'].dt.month.astype(str) + '-' + train_trn['Date'].dt.day.astype(str)\ntrain_trn['_year_month'] = train_trn['Date'].dt.year.astype(str) + '-' + train_trn['Date'].dt.month.astype(str)\ntrain_trn['_weekday'] = train_trn['Date'].dt.dayofweek\ntrain_trn['_hour'] = train_trn['Date'].dt.hour\ntrain_trn['_day'] = train_trn['Date'].dt.day\n\nfig,ax = plt.subplots(4, 1, figsize=(16,12))\n\ntrain_trn.groupby('_weekday')['isFraud'].mean().to_frame().plot.bar(ax=ax[0])\ntrain_trn.groupby('_hour')['isFraud'].mean().to_frame().plot.bar(ax=ax[1])\ntrain_trn.groupby('_day')['isFraud'].mean().to_frame().plot.bar(ax=ax[2])\ntrain_trn.groupby('_year_month')['isFraud'].mean().to_frame().plot.bar(ax=ax[3])","76abb99a":"df = train_trn.groupby(['_ymd'])['isFraud'].agg(['count','mean','sum'])\ndf.sort_values(by='mean',ascending=False)[:10].T","2504062c":"df.sort_values(by='count',ascending=False)[:10].T","e5b72d0c":"# transaction-count X fraud-rate\nplt.scatter(df['count'], df['mean'], s=10)","2fbffd64":"# transaction-count X fraud-count\nplt.scatter(df['count'], df['sum'], s=10)","b7d1ae18":"train_trn['_weekday_hour'] = train_trn['_weekday'].astype(str) + '_' + train_trn['_hour'].astype(str)\ntrain_trn.groupby('_weekday_hour')['isFraud'].mean().to_frame().plot.line(figsize=(16,3))","f7148999":"df = train_trn.groupby('_weekday')['isFraud'].mean().to_frame()\ndf.sort_values(by='isFraud', ascending=False)","4f3484ad":"df = train_trn.groupby('_hour')['isFraud'].mean().to_frame()\ndf.sort_values(by='isFraud', ascending=False).head(10)","b6d3c4b0":"df = train_trn.groupby('_weekday_hour')['isFraud'].mean().to_frame()\ndf.sort_values(by='isFraud', ascending=False).head(10)","15fcf1b3":"train_trn['_amount_qcut10'] = pd.qcut(train_trn['TransactionAmt'],10)\ndf = train_trn.groupby('_amount_qcut10')['isFraud'].mean().to_frame()\ndf.sort_values(by='isFraud', ascending=False)","bd33031f":"# Not all transactions have corresponding identity information.\n#len([c for c in train_trn['TransactionID'] if c not in train_id['TransactionID'].values]) #446307\n\n# Not all fraud transactions have corresponding identity information.\nfraud_id = train_trn[train_trn['isFraud'] == 1]['TransactionID']\nfraud_id_in_trn = [i for i in fraud_id if i in train_id['TransactionID'].values]\nprint(f'fraud data count:{len(fraud_id)}, and in trn:{len(fraud_id_in_trn)}')","d83c0e33":"train_id_trn = pd.merge(train_id, train_trn[['isFraud','TransactionAmt','TransactionID']])\ntrain_id_f0 = train_id_trn[train_id_trn['isFraud'] == 0]\ntrain_id_f1 = train_id_trn[train_id_trn['isFraud'] == 1]\nprint(train_id_f0.shape, train_id_f1.shape)\n\ndef plotHistByFraud(col, bins=20, figsize=(8,3)):\n    with np.errstate(invalid='ignore'):\n        plt.figure(figsize=figsize)\n        plt.hist([train_id_f0[col], train_id_f1[col]], bins=bins, density=True, color=['royalblue', 'orange'])\n        \ndef plotCategoryRateBar(col, topN=np.nan, figsize=(8,3)):\n    a, b = train_id_f0, train_id_f1\n    if topN == topN: # isNotNan\n        vals = b[col].value_counts(normalize=True).to_frame().iloc[:topN,0]\n        subA = a.loc[a[col].isin(vals.index.values), col]\n        df = pd.DataFrame({'normal':subA.value_counts(normalize=True), 'fraud':vals})\n    else:\n        df = pd.DataFrame({'normal':a[col].value_counts(normalize=True), 'fraud':b[col].value_counts(normalize=True)})\n    df.sort_values('fraud', ascending=False).plot.bar(figsize=figsize)","e4e8d413":"plotHistByFraud('id_01')\nplotHistByFraud('id_02')\nplotHistByFraud('id_07')","d4826291":"numid_cols = [f'id_{str(i).zfill(2)}' for i in range(1,12)]\ntrain_id_trn[numid_cols].isna().sum().to_frame().T \/ len(train_id)","512f74b9":"plt.figure(figsize=(10, 5))\nsns.heatmap(train_id_trn[['isFraud','TransactionAmt']+numid_cols].corr(), annot=True, fmt='.2f')","bd6fd764":"train_id_f1[['isFraud'] + numid_cols].head(10)","9131a3d9":"train_id_f0[['isFraud'] + numid_cols].head(10)","44c17fd0":"plotCategoryRateBar('id_15')\nplotCategoryRateBar('id_16')\nplotCategoryRateBar('id_17',10)","983ffb0f":"plotCategoryRateBar('id_19', 20)\nplotHistByFraud('id_19')\nprint('unique count:', train_id['id_19'].nunique())","d2bb1964":"plotCategoryRateBar('id_20', 20)\nplotHistByFraud('id_20')\nprint('unique count:', train_id['id_20'].nunique())","49da90ec":"plotCategoryRateBar('id_23')","626ad374":"plotCategoryRateBar('id_26', 15)\nplotCategoryRateBar('id_28')\nplotCategoryRateBar('id_29')","0f40c3d3":"plotCategoryRateBar('id_31', 20)\n\ntrain_id_f0['_id_31_ua'] = train_id_f0['id_31'].apply(lambda x: x.split()[0] if x == x else 'unknown')\ntrain_id_f1['_id_31_ua'] = train_id_f1['id_31'].apply(lambda x: x.split()[0] if x == x else 'unknown')\nplotCategoryRateBar('_id_31_ua', 10)","82606c14":"plotCategoryRateBar('id_32')\nplotCategoryRateBar('id_33',15)\nplotCategoryRateBar('id_34')\nplotCategoryRateBar('id_35')\nplotCategoryRateBar('id_38')","91ed30f4":"plotCategoryRateBar('DeviceType')\nplotCategoryRateBar('DeviceInfo',10)","e4736d13":"ccols = [f'C{i}' for i in range(1,15)]\ndcols = [f'D{i}' for i in range(1,16)]\nmcols = [f'M{i}' for i in range(1,10)]\nvcols = [f'V{i}' for i in range(1,340)]","378fbb26":"train_trn_f0 = train_trn[train_trn['isFraud'] == 0]\ntrain_trn_f1 = train_trn[train_trn['isFraud'] == 1]\nprint(train_trn_f0.shape, train_trn_f1.shape)\n\ndef plotTrnHistByFraud(col, bins=20, figsize=(8,3)):\n    with np.errstate(invalid='ignore'):\n        plt.figure(figsize=figsize)\n        plt.hist([train_trn_f0[col], train_trn_f1[col]], bins=bins, density=True, color=['royalblue', 'orange'])\n\ndef plotTrnLogHistByFraud(col, bins=20, figsize=(8,3)):\n    with np.errstate(invalid='ignore'):\n        plt.figure(figsize=figsize)\n        plt.hist([np.log1p(train_trn_f0[col]), np.log1p(train_trn_f1[col])], bins=bins, density=True, color=['royalblue', 'orange'])\n        \ndef plotTrnCategoryRateBar(col, topN=np.nan, figsize=(8,3)):\n    a, b = train_trn_f0, train_trn_f1\n    if topN == topN: # isNotNan\n        vals = b[col].value_counts(normalize=True).to_frame().iloc[:topN,0]\n        subA = a.loc[a[col].isin(vals.index.values), col]\n        df = pd.DataFrame({'normal':subA.value_counts(normalize=True), 'fraud':vals})\n    else:\n        df = pd.DataFrame({'normal':a[col].value_counts(normalize=True), 'fraud':b[col].value_counts(normalize=True)})\n    df.sort_values('fraud', ascending=False).plot.bar(figsize=figsize)","c8ea949c":"#START_DATE = '2017-11-30'\nSTART_DATE = '2017-12-01'\nstartdate = datetime.datetime.strptime(START_DATE, \"%Y-%m-%d\")\n\ntrain_date = train_trn['TransactionDT'].apply(lambda x: (startdate + datetime.timedelta(seconds=x)))\ntest_date = test_trn['TransactionDT'].apply(lambda x: (startdate + datetime.timedelta(seconds=x)))\n\nprint('train date:', train_date.min(), '-', train_date.max())\nprint('test  date:', test_date.min(), '-', test_date.max())","294b32da":"plt.figure(figsize=(12,4))\ntrain_trn['TransactionDT'].hist(bins=20)\ntest_trn['TransactionDT'].hist(bins=20)","35571e34":"def appendLagDT(df):\n    df = df.assign(_date_lag = df['TransactionDT'] - df.groupby(['card1','card2'])['TransactionDT'].shift(1))\n    return df\n\ntrain_trn = appendLagDT(train_trn)\ntrain_trn_f0 = train_trn[train_trn['isFraud'] == 0]\ntrain_trn_f1 = train_trn[train_trn['isFraud'] == 1]","dd5204fb":"pd.concat([train_trn_f0['_date_lag'].describe(), \n           train_trn_f1['_date_lag'].describe()], axis=1)","d797ec27":"plotTrnLogHistByFraud('_date_lag')","0bb62285":"plotTrnHistByFraud('TransactionAmt')\nplotTrnLogHistByFraud('TransactionAmt')","4e44c1b4":"amt_desc = pd.concat([train_trn_f0['TransactionAmt'].describe(), train_trn_f1['TransactionAmt'].describe()], axis=1)\namt_desc.columns = ['normal','fraud']\namt_desc","28b8ae51":"def appendLagAmt(df):\n    df = df.assign(_amt_lag = df['TransactionAmt'] - df.groupby(['card1','card2'])['TransactionAmt'].shift(1))\n    df['_amt_lag_sig'] = df['_amt_lag'].apply(lambda x: '0' if np.isnan(x) else '+' if x >=0 else '-')\n    return df\n\ntrain_trn = appendLagAmt(train_trn)\ntrain_trn_f0 = train_trn[train_trn['isFraud'] == 0]\ntrain_trn_f1 = train_trn[train_trn['isFraud'] == 1]","f270f25e":"plotTrnHistByFraud('_amt_lag')\nplotTrnCategoryRateBar('_amt_lag_sig')","a3d022e2":"plotTrnCategoryRateBar('ProductCD')","40cf8179":"cols = ['ProductCD','addr1','addr2','dist1','dist2']\ntrain_trn[cols].head(20)","460c2929":"cols = ['addr1','addr2','dist1','dist2']\nfor f in cols:\n    train_trn[f + '_isna'] = train_trn[f].isna()","c7029043":"pd.crosstab(train_trn['ProductCD'], train_trn['addr1_isna'])","17279501":"pd.crosstab(train_trn['ProductCD'], train_trn['dist1_isna'])","b680ba62":"pd.crosstab(train_trn['ProductCD'], train_trn['dist2_isna'])","710c7706":"train_trn[(train_trn['dist1_isna'] == False) & (train_trn['dist2_isna'] == False)][cols]","528c4d51":"train_trn = pd.concat([train_trn, pd.get_dummies(train_trn[['ProductCD']])], axis=1)\ntrain_trn.head(5)","d9b940a5":"cols = ['ProductCD_W','ProductCD_C','ProductCD_H','ProductCD_R','ProductCD_S','dist1_isna','dist2_isna','addr1_isna','addr2_isna']\ntrain_trn[cols].corr()","9961f700":"train_trn['_amount_max_ProductCD'] = train_trn.groupby(['ProductCD'])['TransactionAmt'].transform('max')\ntrain_trn[['ProductCD','_amount_max_ProductCD']].drop_duplicates().sort_values(by='_amount_max_ProductCD', ascending=False)","54a89467":"cols = [f'card{n}' for n in range(1,7)]\ntrain_trn[cols].isnull().sum()","b89ee930":"train_trn[cols].nunique()","1db8ab3c":"train_trn[cols].head(10)","a084cc8a":"train_trn[train_trn['card4']=='visa']['card1'].hist(bins=50)\ntrain_trn[train_trn['card4']=='mastercard']['card1'].hist(bins=50)","a037eea7":"train_trn[train_trn['card4']=='visa']['card2'].hist(bins=50)\ntrain_trn[train_trn['card4']=='mastercard']['card2'].hist(bins=50)","d6b28d4a":"plotTrnCategoryRateBar('card1', 15)\nplotTrnHistByFraud('card1', bins=30)","05f741e1":"plotTrnCategoryRateBar('card2', 15)\nplotTrnHistByFraud('card2', bins=30)","f5fb4450":"train_trn_f0['_card1_card2'] = train_trn_f0['card1'].astype(str) + '_' + train_trn_f0['card2'].astype(str)\ntrain_trn_f1['_card1_card2'] = train_trn_f1['card1'].astype(str) + '_' + train_trn_f1['card2'].astype(str)\n\nplotTrnCategoryRateBar('_card1_card2', 50, figsize=(15,3))","d2e76212":"plotTrnCategoryRateBar('card3', 10)","10c74d2b":"plotTrnCategoryRateBar('card4')","f6c1536f":"plotTrnCategoryRateBar('card5', 10)","042c38b2":"plotTrnCategoryRateBar('card6')","965cb2f9":"print(len(train_trn))\nprint(train_trn['card1'].nunique(), train_trn['card2'].nunique(), train_trn['card3'].nunique(), train_trn['card5'].nunique())\n\ntrain_trn['card_n'] = (train_trn['card1'].astype(str) + '_' + train_trn['card2'].astype(str) \\\n       + '_' + train_trn['card3'].astype(str) + '_' + train_trn['card5'].astype(str))\nprint('unique cards:', train_trn['card_n'].nunique())","ca069b55":"vc = train_trn['card_n'].value_counts()\nvc[vc > 3000].plot.bar()","af6718d3":"train_trn.groupby(['card_n'])['isFraud'].mean().sort_values(ascending=False)","668cd5f1":"train_trn['addr1'].nunique(), train_trn['addr2'].nunique()","6144ec84":"plotTrnCategoryRateBar('addr1', 20)\nplotTrnHistByFraud('addr1', bins=30)","876dffb2":"train_trn['addr1'].value_counts(dropna=False).to_frame().iloc[:10]","569f4778":"plotTrnCategoryRateBar('addr2', 10)\nprint('addr2 nunique:', train_trn['addr2'].nunique())","eb1d4fe4":"train_trn['addr2'].value_counts(dropna=False).to_frame().iloc[:10]","482a91f4":"plotTrnCategoryRateBar('dist1', 20)","25b16eda":"plotTrnCategoryRateBar('dist2', 20)","390236a8":"train_trn_f0['dist3'] = np.where(train_trn_f0['dist1'].isna(), train_trn_f0['dist2'], train_trn_f0['dist1'])\ntrain_trn_f1['dist3'] = np.where(train_trn_f1['dist1'].isna(), train_trn_f1['dist2'], train_trn_f1['dist1'])\n\nplotTrnCategoryRateBar('dist3', 20)\nplotTrnLogHistByFraud('dist3')","c390ba05":"plotTrnCategoryRateBar('P_emaildomain',10)\nplotTrnCategoryRateBar('R_emaildomain',10)","553f7b01":"train_trn['P_emaildomain'].fillna('unknown',inplace=True)\ntrain_trn['R_emaildomain'].fillna('unknown',inplace=True)\n\ninf = pd.DataFrame([], columns=['P_emaildomain','R_emaildomain','Count','isFraud'])\nfor n in (train_trn['P_emaildomain'] + ' ' + train_trn['R_emaildomain']).unique():\n    p, r = n.split()[0], n.split()[1]\n    df = train_trn[(train_trn['P_emaildomain'] == p) & (train_trn['R_emaildomain'] == r)]\n    inf = inf.append(pd.DataFrame([p, r, len(df), df['isFraud'].mean()], index=inf.columns).T)\n\ninf.sort_values(by='isFraud', ascending=False).head(10)","1c91f1d9":"train_trn_f1['P_emaildomain_prefix'] = train_trn_f1['P_emaildomain'].fillna('unknown').apply(lambda x: x.split('.')[0])\npd.crosstab(train_trn_f1['P_emaildomain_prefix'], train_trn_f1['ProductCD']).T","b3070a03":"train_trn['P_emaildomain_prefix'] = train_trn['P_emaildomain'].apply(lambda x: x.split('.')[0])\nct = pd.crosstab(train_trn['P_emaildomain_prefix'], train_trn['ProductCD'])\nct = ct.sort_values(by='W')[-15:]\nct.plot.barh(stacked=True, figsize=(12,4))","8036a8db":"for i in range(1,15):\n    plotTrnCategoryRateBar(f'C{i}',10)","0f3a4fad":"train_trn[ccols].describe().loc[['count','mean','std','min','max']]","286edb77":"plt.figure(figsize=(10,5))\n\ncorr = train_trn[['isFraud'] + ccols].corr()\nsns.heatmap(corr, annot=True, fmt='.2f')","c1a071b2":"cols = ['TransactionDT','TransactionAmt','isFraud'] + ccols\ntrain_trn[train_trn['card1'] == 9500][cols].head(20)","ba9c9ac5":"cols = ['TransactionDT','TransactionAmt','isFraud'] + ccols\ntrain_trn[train_trn['card1'] == 4774][cols].head(20)","67a09348":"train_trn[train_trn['card1'] == 14770][cols].head(20)","1466dbeb":"for i in range(1,16):\n    plotTrnCategoryRateBar(f'D{i}',10)","edd407c2":"train_trn[dcols].describe().loc[['count','mean','std','min','max']]","8ba63f1b":"plt.figure(figsize=(12,4))\n\nplt.scatter(train_trn_f0['TransactionDT'], train_trn_f0['D1'], s=2)\nplt.scatter(train_trn_f1['TransactionDT'], train_trn_f1['D1'], s=2, c='r')\nplt.scatter(test_trn['TransactionDT'], test_trn['D1'], s=2, c='g')","0d48230b":"plt.figure(figsize=(12,4))\n\n# ref. https:\/\/www.kaggle.com\/kyakovlev\/ieee-columns-scaling\nplt.scatter(train_trn_f0['TransactionDT'], train_trn_f0['D15'], s=2)\nplt.scatter(train_trn_f1['TransactionDT'], train_trn_f1['D15'], s=2, c='r')\nplt.scatter(test_trn['TransactionDT'], test_trn['D15'], s=2, c='g')","eedb6ac2":"plt.figure(figsize=(10,5))\n\ncorr = train_trn[['isFraud'] + dcols].corr()\nsns.heatmap(corr, annot=True, fmt='.2f')","d791c8ed":"fig, ax = plt.subplots(1, 2, figsize=(15, 3))\ntrain_trn.loc[train_trn['isFraud']==0, dcols].isnull().sum(axis=1).to_frame().hist(ax=ax[0], bins=20)\ntrain_trn.loc[train_trn['isFraud']==1, dcols].isnull().sum(axis=1).to_frame().hist(ax=ax[1], bins=20)","1859a8d5":"cols = ['TransactionDT','TransactionAmt','isFraud'] + dcols\ntrain_trn[train_trn['card1'] == 9500][cols].head(20)","508ab0ad":"cols = ['TransactionDT','TransactionAmt','isFraud'] + dcols\ntrain_trn[train_trn['card1'] == 4774][cols].head(20)","0689d5ab":"train_trn[train_trn['card1'] == 14770][cols].head(20)","8bf2ec02":"plotTrnCategoryRateBar('M1')\nplotTrnCategoryRateBar('M2')\nplotTrnCategoryRateBar('M3')\nplotTrnCategoryRateBar('M4')","9023ae5e":"plotTrnCategoryRateBar('M5')\nplotTrnCategoryRateBar('M6')\nplotTrnCategoryRateBar('M7')\nplotTrnCategoryRateBar('M8')\nplotTrnCategoryRateBar('M9')","01213f7f":"for f in ['V1','V14','V41','V65','V88','V107','V305']:\n    plotTrnCategoryRateBar(f)","24f599ee":"vsum0 = train_trn_f0[vcols].sum(axis=1)\nvsum1 = train_trn_f1[vcols].sum(axis=1)\nplt.scatter(train_trn_f0['_ymd'], vsum0, s=5)\nplt.scatter(train_trn_f1['_ymd'], vsum1, s=5, c='r')","2d3ebbe0":"m = train_trn_f1[vcols].describe().T['max']\nm[m >= 10000]","4d8182e5":"plt.scatter(train_trn_f0['_ymd'], train_trn_f0['V160'], s=5)\nplt.scatter(train_trn_f1['_ymd'], train_trn_f1['V160'], s=5, c='r')","adebab0a":"vcols_1 = [f'V{i}' for i in range(1,160)]+[f'V{i}' for i in range(161,340)]\nvsum0 = train_trn_f0[vcols_1].sum(axis=1)\nvsum1 = train_trn_f1[vcols_1].sum(axis=1)\nplt.scatter(train_trn_f0['_ymd'], vsum0, s=5)\nplt.scatter(train_trn_f1['_ymd'], vsum1, s=5, c='r')","89e32b0e":"train_trn[vcols].isnull().sum() \/ len(train_trn)","99b105a6":"train_trn.loc[train_trn['V1'].isnull(), vcols].head(10)","845be2f5":"train_trn.loc[train_trn['V1'].isnull() == False, vcols].head(10)","72586987":"fig, ax = plt.subplots(1, 2, figsize=(15, 3))\ntrain_trn.loc[train_trn['isFraud']==0, vcols].isnull().sum(axis=1).to_frame().hist(ax=ax[0], bins=20)\ntrain_trn.loc[train_trn['isFraud']==1, vcols].isnull().sum(axis=1).to_frame().hist(ax=ax[1], bins=20)","3da10438":"train_trn[vcols].describe().T[['min','max']].T","014df02c":"vcols = [f'V{i}' for i in range(1,340)]\n\npca = PCA()\npca.fit(train_trn[vcols].fillna(-1))\nplt.xlabel('components')\nplt.plot(np.add.accumulate(pca.explained_variance_ratio_))\nplt.show()\n\npca = PCA(n_components=0.99)\nvcol_pca = pca.fit_transform(train_trn[vcols].fillna(-1))\nprint(vcol_pca.ndim)","c3889a2f":"del train_trn_f0,train_trn_f1,train_id_f0,train_id_f1\n\nprint(pd.DataFrame([[val for val in dir()], [sys.getsizeof(eval(val)) for val in dir()]],\n                   index=['name','size']).T.sort_values('size', ascending=False).reset_index(drop=True)[:10])","c32b4dc2":"train_id = pd.read_csv('..\/input\/train_identity.csv')\ntrain_trn = pd.read_csv('..\/input\/train_transaction.csv')\ntest_id = pd.read_csv('..\/input\/test_identity.csv')\ntest_trn = pd.read_csv('..\/input\/test_transaction.csv')\n\nid_cols = list(train_id.columns.values)\ntrn_cols = list(train_trn.drop('isFraud', axis=1).columns.values)\n\nX_train = pd.merge(train_trn[trn_cols + ['isFraud']], train_id[id_cols], how='left')\nX_train = reduce_mem_usage(X_train)\nX_test = pd.merge(test_trn[trn_cols], test_id[id_cols], how='left')\nX_test = reduce_mem_usage(X_test)\n\nX_train_id = X_train.pop('TransactionID')\nX_test_id = X_test.pop('TransactionID')\ndel train_id,train_trn,test_id,test_trn\n\nall_data = X_train.append(X_test, sort=False).reset_index(drop=True)","de47903f":"vcols = [f'V{i}' for i in range(1,340)]\n\nsc = preprocessing.MinMaxScaler()\n\npca = PCA(n_components=2) #0.99\nvcol_pca = pca.fit_transform(sc.fit_transform(all_data[vcols].fillna(-1)))\n\nall_data['_vcol_pca0'] = vcol_pca[:,0]\nall_data['_vcol_pca1'] = vcol_pca[:,1]\nall_data['_vcol_nulls'] = all_data[vcols].isnull().sum(axis=1)\n\nall_data.drop(vcols, axis=1, inplace=True)","eb1e2430":"import datetime\n\nSTART_DATE = '2017-12-01'\nstartdate = datetime.datetime.strptime(START_DATE, \"%Y-%m-%d\")\nall_data['Date'] = all_data['TransactionDT'].apply(lambda x: (startdate + datetime.timedelta(seconds=x)))\nall_data['_weekday'] = all_data['Date'].dt.dayofweek\nall_data['_hour'] = all_data['Date'].dt.hour\nall_data['_day'] = all_data['Date'].dt.day\n\nall_data['_weekday'] = all_data['_weekday'].astype(str)\nall_data['_hour'] = all_data['_hour'].astype(str)\nall_data['_weekday__hour'] = all_data['_weekday'] + all_data['_hour']\n\ncnt_day = all_data['_day'].value_counts()\ncnt_day = cnt_day \/ cnt_day.mean()\nall_data['_count_rate'] = all_data['_day'].map(cnt_day.to_dict())\n\nall_data.drop(['TransactionDT','Date','_day'], axis=1, inplace=True)","e2134243":"all_data['_P_emaildomain__addr1'] = all_data['P_emaildomain'] + '__' + all_data['addr1'].astype(str)\nall_data['_card1__card2'] = all_data['card1'].astype(str) + '__' + all_data['card2'].astype(str)\nall_data['_card1__addr1'] = all_data['card1'].astype(str) + '__' + all_data['addr1'].astype(str)\nall_data['_card2__addr1'] = all_data['card2'].astype(str) + '__' + all_data['addr1'].astype(str)\nall_data['_card12__addr1'] = all_data['_card1__card2'] + '__' + all_data['addr1'].astype(str)\nall_data['_card_all__addr1'] = all_data['_card1__card2'] + '__' + all_data['addr1'].astype(str)","0c924ce1":"all_data['_amount_decimal'] = ((all_data['TransactionAmt'] - all_data['TransactionAmt'].astype(int)) * 1000).astype(int)\nall_data['_amount_decimal_len'] = all_data['TransactionAmt'].apply(lambda x: len(re.sub('0+$', '', str(x)).split('.')[1]))\nall_data['_amount_fraction'] = all_data['TransactionAmt'].apply(lambda x: float('0.'+re.sub('^[0-9]|\\.|0+$', '', str(x))))\nall_data[['TransactionAmt','_amount_decimal','_amount_decimal_len','_amount_fraction']].head(10)","ec76e3da":"cols = ['ProductCD','card1','card2','card5','card6','P_emaildomain','_card_all__addr1']\n#,'card3','card4','addr1','dist2','R_emaildomain'\n\n# amount mean&std\nfor f in cols:\n    all_data[f'_amount_mean_{f}'] = all_data['TransactionAmt'] \/ all_data.groupby([f])['TransactionAmt'].transform('mean')\n    all_data[f'_amount_std_{f}'] = all_data['TransactionAmt'] \/ all_data.groupby([f])['TransactionAmt'].transform('std')\n    all_data[f'_amount_pct_{f}'] = (all_data['TransactionAmt'] - all_data[f'_amount_mean_{f}']) \/ all_data[f'_amount_std_{f}']\n\n# freq encoding\nfor f in cols:\n    vc = all_data[f].value_counts(dropna=False)\n    all_data[f'_count_{f}'] = all_data[f].map(vc)","4e8a6676":"print('features:', all_data.shape[1])","5f797387":"_='''\ncat_cols = ['ProductCD','card1','card2','card3','card4','card5','card6','addr1','addr2','P_emaildomain','R_emaildomain',\n            'M1','M2','M3','M4','M5','M6','M7','M8','M9','DeviceType','DeviceInfo'] + [f'id_{i}' for i in range(12,39)]\n'''\ncat_cols = [f'id_{i}' for i in range(12,39)]\nfor i in cat_cols:\n    if i in all_data.columns:\n        all_data[i] = all_data[i].astype(str)\n        all_data[i].fillna('unknown', inplace=True)\n\nenc_cols = []\nfor i, t in all_data.loc[:, all_data.columns != 'isFraud'].dtypes.iteritems():\n    if t == object:\n        enc_cols.append(i)\n        #df = pd.concat([df, pd.get_dummies(df[i].astype(str), prefix=i)], axis=1)\n        #df.drop(i, axis=1, inplace=True)\n        all_data[i] = pd.factorize(all_data[i])[0]\n        #all_data[i] = all_data[i].astype('category')\nprint(enc_cols)","5faca915":"X_train = all_data[all_data['isFraud'].notnull()]\nX_test = all_data[all_data['isFraud'].isnull()].drop('isFraud', axis=1)\nY_train = X_train.pop('isFraud')\ndel all_data","4cb1d743":"%%time\n\nimport lightgbm as lgb\n\nparams={'learning_rate': 0.01,\n        'objective': 'binary',\n        'metric': 'auc',\n        'num_threads': -1,\n        'num_leaves': 256,\n        'verbose': 1,\n        'random_state': 42,\n        'bagging_fraction': 1,\n        'feature_fraction': 0.85\n       }\n\noof_preds = np.zeros(X_train.shape[0])\nsub_preds = np.zeros(X_test.shape[0])\n\nclf = lgb.LGBMClassifier(**params, n_estimators=3000)\nclf.fit(X_train, Y_train)\noof_preds = clf.predict_proba(X_train, num_iteration=clf.best_iteration_)[:,1]\nsub_preds = clf.predict_proba(X_test, num_iteration=clf.best_iteration_)[:,1]","ad75be6a":"fpr, tpr, thresholds = metrics.roc_curve(Y_train, oof_preds)\nauc = metrics.auc(fpr, tpr)\n\nplt.plot(fpr, tpr, label='ROC curve (area = %.3f)'%auc)\nplt.legend()\nplt.title('ROC curve')\nplt.xlabel('False Positive Rate')\nplt.ylabel('True Positive Rate')\nplt.grid(True)","70444fe5":"# Plot feature importance\nfeature_importance = clf.feature_importances_\nfeature_importance = 100.0 * (feature_importance \/ feature_importance.max())\nsorted_idx = np.argsort(feature_importance)\nsorted_idx = sorted_idx[len(feature_importance) - 50:]\npos = np.arange(sorted_idx.shape[0]) + .5\n\nplt.figure(figsize=(10,12))\nplt.barh(pos, feature_importance[sorted_idx], align='center')\nplt.yticks(pos, X_train.columns[sorted_idx])\nplt.xlabel('Relative Importance')\nplt.title('Variable Importance')\nplt.show()","669ae973":"submission = pd.DataFrame()\nsubmission['TransactionID'] = X_test_id\nsubmission['isFraud'] = sub_preds\nsubmission.to_csv('submission.csv', index=False)","f2b5b94b":"## Identity data\n\nVariables in this table are identity information \u2013 network connection information (IP, ISP, Proxy, etc) and digital signature (UA\/browser\/os\/version, etc) associated with transactions. They're collected by Vesta\u2019s fraud protection system and digital security partners. (The field names are masked and pairwise dictionary will not be provided for privacy protection and contract agreement)\n\nCategorical Features:\n\n- DeviceType\n- DeviceInfo\n- id12 - id38","5fad06ed":"- fraud transaction rate by weekday-hour","aaa98158":"### TransactionAmt","882044c2":"# Load data","f342fc79":"# Data analysis","da281dae":"- fraud transaction rate by weekday, hour, month-day, and year-month","aa295523":"### TransactionDT","2e75ffa1":"### M1 - M9","c0cde810":"- fraud rate by weekday ","0502f5cb":"- fraud transaction rate by day","1a078e20":"- fraud rate by amount-bin","2966b650":"### DeviceType, DeviceInfo","5eafadb3":"## Transaction data\n\n- TransactionDT: timedelta from a given reference datetime (not an actual timestamp)\n- TransactionAMT: transaction payment amount in USD\n- ProductCD: product code, the product for each transaction\n- card1 - card6: payment card information, such as card type, card category, issue bank, country, etc.\n- addr: address\n- dist: distance\n- P_ and (R__) emaildomain: purchaser and recipient email domain\n- C1-C14: counting, such as how many addresses are found to be associated with the payment card, etc. The actual meaning is masked.\n- D1-D15: timedelta, such as days between previous transaction, etc.\n- M1-M9: match, such as names on card and address, etc.\n- Vxxx: Vesta engineered rich features, including ranking, counting, and other entity relations.","119cfcfc":"### dist1, dist2","84473ed3":"### what's target?","1bcb83d4":"- fraud transaction rate by day, and week","e7193bec":"- Dx & card","90b4251b":"### C1 - C14","1f832651":"# Feature engineering","56349566":"### addr1, addr2","561af0c8":"- fraud rate by hour ","0688953b":"### id_01 - id_11","2f4f69c7":"### Vxxx","56553544":"### P_emaildomain, R_emaildomain","75481da4":"### TransactionID","ff1d1cfb":"### isFraud","1abfd645":"- fraud rate by weekday-hour","75436fa6":"### card1 - card6","31148a06":"### D1-D15","a39f84ad":"### ProductCD","79c7bdc1":"### id_12 - id_38","8931acd4":"# Predict","f750d0f2":"- Cx & card"}}