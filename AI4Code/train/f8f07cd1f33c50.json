{"cell_type":{"fd93ed80":"code","ab511e2c":"code","4b97e499":"code","ab79f292":"code","755f060a":"code","97285b74":"code","197c202b":"code","23e93275":"code","34f2cc05":"code","4657417b":"code","ab0034d4":"code","1da52041":"code","be4744d6":"code","7f7da36b":"code","683881c2":"code","2a43f9e0":"code","3989f700":"code","82529252":"code","d00356a7":"code","5b4a0f7c":"code","ab23f712":"markdown","d965f32a":"markdown","60273bc3":"markdown","28da5009":"markdown","fa9b0804":"markdown","f117666f":"markdown","7d669781":"markdown","cef6911e":"markdown","a7c2266b":"markdown","c4ef67ce":"markdown","20fd8ff6":"markdown","2720b44c":"markdown","739b8dd8":"markdown","6473b5c3":"markdown","6dda071c":"markdown","0ccf62c7":"markdown","d89fa131":"markdown"},"source":{"fd93ed80":"import os\nimport re\nfrom collections import defaultdict\nimport pickle\nimport gc\n\nimport numpy as np\nimport pandas as pd\nimport psutil\nfrom pylab import plt, plot, hist, legend, array, arange, zeros, ones, sqrt, where, cm\nimport seaborn as sns\n\n_ = np.seterr(divide='ignore', invalid='ignore')\n\nfrom tqdm import tqdm\n# tqdm.pandas()","ab511e2c":"PATH = '..\/input\/riiid-test-answer-prediction\/'\ncol_dtype = {'row_id': 'int64', \n             'timestamp': 'int64', \n             'user_id': 'int32', \n             'content_id': 'int16', \n             'content_type_id': 'int8',\n             'task_container_id': 'int16', \n             'user_answer': 'int8', \n             'answered_correctly': 'int8', \n             'prior_question_elapsed_time': 'float32', \n             'prior_question_had_explanation': 'boolean',\n             }\nSECPERD = 24*60*60\n\nTARGET = 'answered_correctly'","4b97e499":"Q = pd.read_csv(PATH+'questions.csv', engine='c')","ab79f292":"D = pd.read_csv(PATH+'train.csv', engine='c'#, nrows=700_000\n               )","755f060a":"QN = Q.bundle_id.value_counts()\n\nQN[QN==5].head(20)","97285b74":"qid = 7780\nbid = Q.loc[Q.question_id==qid,'bundle_id'].iloc[0]\nz = Q.loc[Q.question_id==qid,'part'].iloc[0]\n\nprint(D[D.content_id==qid].content_type_id.value_counts(dropna=False))\naa = Q.loc[Q.bundle_id==bid, 'correct_answer']\nnb = len(aa)\n\n\nqii = qid + arange(nb)\nX = D[(D.content_type_id==0) & (D.content_id.isin(qii))]\n\nuagg = X.iloc[-1_000:].groupby(['user_id','task_container_id'])\n\n# xb = X.iloc[-nb:]\n# xb\n\nfor (uid,tcid), xb in iter(uagg):\n    if len(xb)!= nb:\n        logger.warning(f'? {len(xb)} of {nb} records (u={uid},tc={tcid}) ')\n#         continue\n    i = uid\n    co = plt.cm.jet(i%256, alpha=.05)\n    xb.sort_values('content_id', inplace=True)\n    bbcorr = (xb.answered_correctly.values > 0)\n    ii = arange(len(bbcorr))+1\n    plot(ii[~bbcorr], xb.user_answer[~bbcorr], color=co, marker='x', lw=0)\n    plot(ii[bbcorr], xb.user_answer[bbcorr], color=co, marker='o', lw=0)\n    plot(ii, xb.user_answer, color=co, marker=None, lw=5)\n    \nplot(ii, aa, marker='o', ms=30, mec='k', mfc='None', lw=0)    \nplt.xticks(ii, qii)\nplt.box(False)\nplt.title(f'{len(uagg)} answers on bundle {qid}, part {z}');","197c202b":"uagg = X.sort_values('content_id').groupby(['user_id','task_container_id'], as_index=True)\nutn = uagg.row_id.count()\nutn","23e93275":"u_ntc = utn.reset_index().groupby('user_id')['task_container_id'].count()\nu_ntc[u_ntc>1]","34f2cc05":"u_ntc.max()","4657417b":"tcpo = utn.reset_index()['task_container_id'].value_counts().sort_index()\n\ntcpo.rolling(50, 1).sum().plot();","ab0034d4":"mm_utc = uagg['timestamp'].agg(['min','max'])\n\nnp.all(mm_utc['max'] == mm_utc['min'])","1da52041":"b_utc = uagg['answered_correctly'].sum()\nb_utc","be4744d6":"nrep=6\nbagg = b_utc[u_ntc[u_ntc>2].index].droplevel(1).reset_index().groupby('user_id')['answered_correctly']\n\nbrep = pd.concat([bagg.nth(i) for i in range(nrep)], 1)\nbrep.columns=range(nrep)\nbrep","7f7da36b":"plt.errorbar(arange(nrep), brep.mean(), brep.std());\nplt.xlabel('Attempt')\nplt.ylabel(f'Q of {nb}')\nplt.title(f'Progress for bundle {bid}');","683881c2":"brep_ = brep[brep[0]<3]\nplt.errorbar(arange(nrep), brep_.mean(), brep_.std());\nplt.xlabel('Attempt')\nplt.ylabel(f'Q of {nb}')\nplt.title(f'Progress for bundle {bid}');","2a43f9e0":"uaa = uagg.apply(lambda x: None if len(x) < nb else pd.Series(x['user_answer'].values, index=qii, name=x.index[0]))\nuaa","3989f700":"n = uaa.shape[0]\n\nncorr = len(uaa[(uaa == aa.values).all(1)])\n\nncorr\/n","82529252":"((uaa == aa).sum() \/ n).plot(kind='barh'); \nplt.xlim(0,1);\nplt.title('% of correct anser per question');","d00356a7":"traj = np.ones(uaa.shape[1]) * 0\n\nuaa[(uaa == traj).all(1)]","5b4a0f7c":"{i: '{:.2%}'.format(sum((uaa == (np.ones(uaa.shape[1]) * i)).all(1)) \/ n ) for i in range(4) }","ab23f712":"## Always dummy ?\n\nWhether some users click on the same answer option?","d965f32a":"Let's select questions in bundles for stereotype check","60273bc3":"for poor starters only ...","28da5009":"There were such dummy users!\n\nLet's count percentage...","fa9b0804":"Can timestamp differ for a single bundle?","f117666f":"Balls by user and task_container ...","7d669781":"Only 22% of users completed the bundle w\/o errors!","cef6911e":"Random guess answers (probability=0.25) are included!\n\nBut also partitial knowledge...\n\nAbsolute dummies are those who click the same variant.","a7c2266b":"## Conclusion\n\nYou can trace repetition and give higher predictions for repeated measures or craft an additional feature for machine learning!\n\nYou can mark those users or sessions as dummy style, and predict 0.25 - the probability for dummy choice of 4.\n\nBut you must repeat this analysis for every question!","c4ef67ce":"It is interesting, whether tcid is related with order of training for every user?","20fd8ff6":"# Repetitions in Riiid\n\nMany users took tests for multiple times.\n\nBelow you can see effect of repetitions for a single bundle.","2720b44c":"The second variant is more even popular!\n\n... or they may randomised in test presentation software?\n\nKoreans who took TOEIC, write in comments!","739b8dd8":"not all users have data for complete bundle:  they skipped some questions or the data are fragmented\n\n(for the whole dataset it is true)","6473b5c3":"Up to 8 repetitions!","6dda071c":"No!  Bundle of questions is momental in time!\n\nSo we dont know the order ... may be they are randomised, but we assume the order as question_id grows.","0ccf62c7":"## Typical trajectory for 1 bundle","d89fa131":"## Repeats"}}