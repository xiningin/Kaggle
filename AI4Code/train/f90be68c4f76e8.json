{"cell_type":{"10638c32":"code","c81c813e":"code","addf02b4":"code","1438a2e4":"code","98242cc1":"code","eafe7f70":"code","8fd4029f":"code","cd1c0e17":"code","01ce9a13":"code","98086929":"code","3854e5a5":"code","f5905351":"code","1eeff4b9":"code","f3dda897":"code","0346ef9f":"code","36e71cce":"code","64ef692c":"code","0a5080e0":"code","1122ffcb":"markdown","00467d39":"markdown","d0a5c2db":"markdown","ffbe9c9a":"markdown","4c155f82":"markdown","6865cf8c":"markdown","621a454e":"markdown"},"source":{"10638c32":"import numpy as np\nimport pandas as pd\nfrom pathlib import Path\nimport pyarrow.parquet as pq\nfrom sklearn.metrics import r2_score\nfrom sklearn import linear_model\nimport os\nimport pickle\nimport matplotlib.pyplot as plt\n\n\ndata_path=Path('..\/input\/optiver-realized-volatility-prediction')","c81c813e":"def log_return(list_stock_prices):\n    return np.log(list_stock_prices).diff() \n\ndef realized_volatility(series_log_return):\n    return np.sqrt(np.sum(series_log_return**2))\n\ndef realized_volatility_feature(df):\n    df = df.set_index(['seconds_in_bucket'])\n    wap = (df['bid_price1'] * df['ask_size1'] + df['ask_price1'] * df['bid_size1']) \/\\\n                  (df['bid_size1'] + df['ask_size1'])\n    r = log_return(wap).to_numpy(dtype=np.float32)\n    r = r[~np.isnan(r)]\n    return realized_volatility(r)\n\ndef rmspe(y_true, y_pred):\n    return  (np.sqrt(np.mean(np.square((y_true - y_pred) \/ y_true))))\n\ndef compute_metrics(y_true, y_pred):\n    nans = np.isnan(y_true) \n    y_true = y_true[~nans]\n    y_pred = y_pred[~nans]\n    R2 = r2_score(y_true, y_pred)\n    RMSPE = rmspe(y_true, y_pred)\n    return R2, RMSPE\n    ","addf02b4":"!cp ..\/input\/optiver-volatility-by-stock-and-buckett\/train_data.csv .","1438a2e4":"%%time\nif not os.path.isfile(\"train_data.csv\"):\n    columns = ['stock_id','time_id','seconds_in_bucket','bid_price1', 'ask_price1', 'bid_size1', 'ask_size1']\n    book_df = pq.read_table(data_path \/ f\"book_train.parquet\", columns = columns).to_pandas()\\\n        .groupby(['stock_id','time_id'])\\\n        .apply(lambda x: realized_volatility_feature(x))\\\n        .rename('volatility')\n\n    train_df = pd.read_csv(data_path\/f\"train.csv\").set_index(['stock_id','time_id'])['target']\n    train_data_df = pd.concat([book_df, train_df], axis=1).reset_index()\n    train_data_df.to_csv('train_data.csv', index=False)\nelse:\n    train_data_df = pd.read_csv('train_data.csv')\n    \ntrain_data_df.head()","98242cc1":"volatility=[bucket.set_index(\"stock_id\")[\"volatility\"].reindex(np.arange(0,127), method=None) \\\n            for time_id, bucket in train_data_df.groupby('time_id')]\n    \ntarget=[bucket.set_index(\"stock_id\")[\"target\"].reindex(np.arange(0,127), method=None) \\\n            for time_id, bucket in train_data_df.groupby('time_id')]    ","eafe7f70":"x = np.array(volatility)\ny = np.array(target)","8fd4029f":"x.shape, y.shape","cd1c0e17":"reg = linear_model.LinearRegression(fit_intercept=False)\n\nx = np.where(np.isnan(x), np.nanmean(x), x)\ny = np.where(np.isnan(y), np.nanmean(y), y)\n\nntest = 300\nx_train, y_train = x[:-ntest], y[:-ntest]\nx_test, y_test = x[-ntest:], y[-ntest:]\n\nreg.fit(x_train,y_train)\n\ny_pred = reg.predict(x_test)\n\nR2, RMSPE = compute_metrics(y_test.reshape(-1), y_pred.reshape(-1))\nprint(f'Performance on test set: \\nR2={R2:.3f}, RMSPE={RMSPE:.3f}')","01ce9a13":"stock_id = 101\n\n# Plot outputs\nplt.rcParams['figure.figsize'] = (6,6)\nplt.scatter(y_test[:,stock_id], y_pred[:,stock_id],  color='black')\nplt.plot(y_test[:,stock_id], y_test[:,stock_id], color='blue', linewidth=3)\nplt.axis('equal')\nplt.title(f'Stock ID={stock_id}')\nplt.ylabel('True Volatility')\nplt.xlabel('Predicted Volatility')\nplt.grid()\nplt.show()\n\nR2, RMSPE = compute_metrics(y_test[:,stock_id].reshape(-1), y_pred[:,stock_id].reshape(-1))\nprint(f'Performance for stock_id={stock_id}]: \\nR2={R2:.3f}, RMSPE={RMSPE:.3f}')","98086929":"reg.fit(x,y)","3854e5a5":"columns = ['stock_id','time_id','seconds_in_bucket','bid_price1', 'ask_price1', 'bid_size1', 'ask_size1']\nbook_df = pq.read_table(data_path \/ f\"book_test.parquet\", columns = columns).to_pandas()\\\n    .groupby(['stock_id','time_id'])\\\n    .apply(lambda x: realized_volatility_feature(x))\\\n    .rename('volatility')\n\nbook_df","f5905351":"test_df = pd.read_csv(data_path\/f\"test.csv\").set_index(['stock_id','time_id'])['row_id']\ntest_data_df = pd.concat([book_df, test_df], axis=1).reset_index()","1eeff4b9":"test_data_df","f3dda897":"x_test = [bucket.set_index(\"stock_id\")[\"volatility\"].reindex(np.arange(0,127), method=None) \\\n            for time_id, bucket in test_data_df.groupby('time_id')]\nx_test = np.array(x_test)\nx_test = np.where(np.isnan(x_test), np.nanmean(x_test), x_test)\n\ny_test = dict(zip(\n    [time_id for time_id, bucket in test_data_df.groupby('time_id')], \n    reg.predict(x_test)))\n","0346ef9f":"def predict(stock_id, time_id, row_id):\n    #print(stock_id, time_id, row_id)\n    print('time_id', time_id, 'stock_id', stock_id, y_test[time_id][stock_id])\n    return y_test[time_id][stock_id]","36e71cce":"predictions = test_df.reset_index().apply(lambda x: predict(*x), axis=1)","64ef692c":"submission = pd.DataFrame({ 'row_id' : test_data_df['row_id'], 'target' : predictions})\nsubmission.to_csv('submission.csv', index=None)\nsubmission","0a5080e0":"!cat submission.csv","1122ffcb":"## Aggregation along time axis","00467d39":"## Fit all data","d0a5c2db":"## Optiver Realized Volatility Prediction Linear Regression\n\nThis notebook attempts to exploit correlations between current and future stock volatility. There are two types of dependency considered:\n\n - volatility of stock i at time t -> volatility of stock i at time t+10min\n - volatility of stock i at time t -> volatility of stock j at time t+10min\n \nVolatility of stock i at time t denotes the realized volatility of stock i computed using WAP(ask1,bid1) on the first 10 minutes of the time slot in the time bucket t. Shortly: volatility(stock_id=i,time_id=t)\n\nVolatility of stock j at time t+10min denotes the realized volatility of stock j on the last 10 minutes of the time slot in the time bucket t. Shortly: target_volatility(stock_id=j,time_id=t)\n","ffbe9c9a":"## Submission","4c155f82":"## Linear regression","6865cf8c":"## Vectorization","621a454e":"## Visualization for a given stock"}}