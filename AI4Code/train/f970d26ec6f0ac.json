{"cell_type":{"aef7ad0f":"code","8441afa1":"code","306ac7c0":"code","84dcf68d":"code","b2458158":"code","c8f7615a":"code","92d5b07f":"code","00ed17ce":"code","278861e9":"code","f4170693":"code","e0775646":"code","50e82ac0":"code","6c7286d5":"code","b241b7eb":"code","d2c3de3b":"code","6b5af157":"code","92b575b5":"code","f816d090":"code","9320ab63":"code","4a41da5f":"code","20e9ec58":"code","08edcdda":"code","55f6e35c":"code","0a6be9a0":"code","33c86178":"code","39c1f62f":"code","b5175df9":"code","61d2ada2":"code","ea76f41a":"code","0ed793d3":"code","e66767b1":"code","360d0e00":"code","631833b5":"code","63c4f873":"code","99cb1c79":"code","ed8ba1c2":"code","132add27":"markdown","53066497":"markdown","e1b6ca4e":"markdown","53e96495":"markdown","a278709e":"markdown","41a0d30a":"markdown","4d26d6cd":"markdown","4b91775f":"markdown","43470458":"markdown","6ab88aac":"markdown"},"source":{"aef7ad0f":"# This Python 3 environment comes with many helpful analytics libraries installed\n# It is defined by the kaggle\/python Docker image: https:\/\/github.com\/kaggle\/docker-python\n# For example, here's several helpful packages to load\n\n# Input data files are available in the read-only \"..\/input\/\" directory\n# For example, running this (by clicking run or pressing Shift+Enter) will list all files under the input directory\n\nimport os\n# for dirname, _, filenames in os.walk('\/kaggle\/input'):\n#     for filename in filenames:\n#         print(os.path.join(dirname, filename))\n\n# You can write up to 20GB to the current directory (\/kaggle\/working\/) that gets preserved as output when you create a version using \"Save & Run All\" \n# You can also write temporary files to \/kaggle\/temp\/, but they won't be saved outside of the current session","8441afa1":"%matplotlib inline\nimport os\nimport sys\nimport numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\nimport matplotlib.pyplot as plt","306ac7c0":"sys.path.insert(0, '..\/input\/kaggledicom')","84dcf68d":"from collections import namedtuple  \nfrom src.utils import misc\nfrom src.preprocess.dicom_to_dataframe import create_record","b2458158":"import pydicom\nimport seaborn as sns","c8f7615a":"import torch\nimport torchvision\nimport torchvision.transforms as transforms","92d5b07f":"DATA_ROOT = \"..\/input\/vinbigdata-chest-xray-abnormalities-detection\/\"\nTRAIN_DIR = os.path.join(DATA_ROOT, \"train\")\nTEST_DIR = os.path.join(DATA_ROOT, \"test\")","00ed17ce":"colorpal = ['red', 'green', 'blue']","278861e9":"def plot_groupby_info(df):\n    image_group = []\n    for image_id, pd_frame in df.groupby('image_id'):\n        image_group.append(image_id)\n\n    imageAncClass_group = []\n    for pair, pd_frame in df.groupby(['image_id', 'class_name']):\n        imageAncClass_group.append(pair)\n    print(f\"Considering the data with no finding\")\n    print(f\"length of number of image_id vs length of image_id and class_name = {len(image_group), len(imageAncClass_group)}\")\n    return len(imageAncClass_group)\/len(image_group)","f4170693":"train_images = os.listdir(TRAIN_DIR)\nprint(f\"number of image in public test = {len(train_images)}\")\n\ntest_images = os.listdir(TEST_DIR)\nprint(f\"number of image in public test = {len(test_images)}\")","e0775646":"train_df = pd.read_csv(os.path.join(DATA_ROOT,'train.csv')).fillna(-1)\n\ntrain_df.head()","50e82ac0":"print(f\"number of box per image including image with no finding = {plot_groupby_info(train_df)}\")","6c7286d5":"print(f\"total number of row in train dataset {len(train_df)}\")","b241b7eb":"print(f\"number of class = {len(train_df['class_name'].unique())}\")","d2c3de3b":"train_df.class_name.value_counts()\/len(train_df)","6b5af157":"train_df.class_name.value_counts()\\\n    .plot(kind='bar',\n          title='class_name',\n          figsize=(12, 4),\n          color=colorpal[0])","92b575b5":"abnormal_df = train_df[train_df.class_name!= 'No finding']","f816d090":"abnormal_df.head()","9320ab63":"abnormal_df['w'] = abnormal_df['x_max'].copy() - abnormal_df['x_min'].copy()\nabnormal_df['h'] = abnormal_df['y_max'] - abnormal_df['y_min']","4a41da5f":"abnormal_df['area'] = abnormal_df['w']*abnormal_df['h']","20e9ec58":"abnormal_df.head()","08edcdda":"print(f\"number of box in train dataset\/ abnormal df = {len(abnormal_df)} boxes\")","55f6e35c":"print(f\"number of box per image without image with no finding = {plot_groupby_info(abnormal_df)}\")","0a6be9a0":"print(f\"number of average box per abnormal image = {36096\/4394}\")","33c86178":"fig, ax = plt.subplots(figsize=(12, 5))\nsns.distplot(abnormal_df['area'].value_counts(),\n             bins=15,\n             color=colorpal[1])\nax.set_title('Distribution bounding box sizes')\nplt.show()","39c1f62f":"def window_imgs_from_dicom(id, dirname):\n    \n    record = {\n        'ID': id,\n#         'labels': ' '.join(labels),\n#         'n_label': len(labels),\n    }\n    \n    \n    path = '%s\/%s.dicom' % (dirname, id)\n    dicom = pydicom.dcmread(path)\n    record.update(misc.get_dicom_raw(dicom))\n    \n    raw = dicom.pixel_array\n    try:\n        slope = float(record['RescaleSlope'])\n        intercept = float(record['RescaleIntercept'])\n\n        center = misc.get_dicom_value(record['WindowCenter'])\n        width = misc.get_dicom_value(record['WindowWidth'])\n\n        bits= record['BitsStored']\n        pixel = record['PixelRepresentation']\n\n#         print(center, width, bits, pixel)\n        image = misc.rescale_image(raw, slope, intercept, bits, pixel)\n\n        doctor = misc.apply_window(image, center, width)\n        brain = misc.apply_window(image, 40, 80)\n        return raw, image, doctor, brain, record\n    except:\n        return raw,raw,raw,raw, record\n    \n    \ndef create_record(id, dirname):\n\n    raw, image, doctor, brain, record = window_imgs_from_dicom(id, dirname)\n\n    record.update({\n        'raw_max': raw.max(),\n        'raw_min': raw.min(),\n        'raw_mean': raw.mean(),\n        'raw_diff': raw.max() - raw.min(),\n        'doctor_max': doctor.max(),\n        'doctor_min': doctor.min(),\n        'doctor_mean': doctor.mean(),\n        'doctor_diff': doctor.max() - doctor.min(),\n        'brain_max': brain.max(),\n        'brain_min': brain.min(),\n        'brain_mean': brain.mean(),\n        'brain_diff': brain.max() - brain.min(),\n        'brain_ratio': misc.get_windowed_ratio(image, 40, 80),\n    })\n    return record\n","b5175df9":"# Scan has different size","61d2ada2":"# ..\/input\/vinbigdata-chest-xray-abnormalities-detection\/train\/000434271f63a053c4128a0ba6352c7f.dicom\n# ..\/input\/vinbigdata-chest-xray-abnormalities-detection\/train\/0059d21bef1793fa9522e4ec8cae1a1a.dicom\nraw, image, doctor, brain, record = window_imgs_from_dicom('000434271f63a053c4128a0ba6352c7f',TRAIN_DIR)\nprint(f\"shape of individual scan = {raw.shape}\")","ea76f41a":"# ..\/input\/vinbigdata-chest-xray-abnormalities-detection\/train\/000434271f63a053c4128a0ba6352c7f.dicom\n# ..\/input\/vinbigdata-chest-xray-abnormalities-detection\/train\/0059d21bef1793fa9522e4ec8cae1a1a.dicom\nraw, image, doctor, brain, record = window_imgs_from_dicom('0059d21bef1793fa9522e4ec8cae1a1a',TRAIN_DIR)\nprint(f\"shape of individual scan = {raw.shape}\")","0ed793d3":"abnormal_df.describe()","e66767b1":"def imshow(img):\n    img = img \/ 2 + 0.5     # unnormalize\n    npimg = img.numpy()\n    plt.imshow(np.transpose(npimg, (1, 2, 0)))\n    plt.show()\n\n\n# get some random training images\n# dataiter = iter(trainloader)\n# images, labels = dataiter.next()\n\n# show images\n# imshow(torchvision.utils.make_grid(images))\n# print labels\n# print(' '.join('%5s' % classes[labels[j]] for j in range(4)))","360d0e00":"record = create_record('000434271f63a053c4128a0ba6352c7f', TRAIN_DIR)","631833b5":"windows_img = window_imgs_from_dicom('50a418190bc3fb1ef1633bf9678929b3', TRAIN_DIR)","63c4f873":"def get_sample_images(df):\n    classes = df['class_name'].unique()\n    sample = []\n    for i in classes:\n        image_id = df[df.class_name == i].iloc[0].image_id\n#         print(image_id, i)\n        eg = namedtuple('id_img_pair',['id','image_id', 'window_images'])  \n        image_list = window_imgs_from_dicom(image_id, TRAIN_DIR)\n        \n        raw, image, doctor, brain, _ = image_list \n        sample.append(eg(i, image_id, [raw, image, doctor, brain]))\n    return sample","99cb1c79":"samples = get_sample_images(train_df)","ed8ba1c2":"import operator\nfrom functools import reduce #python 3\n\n\ndef imshow(img):\n#     img = img \/ 2 + 0.5     # unnormalize\n    npimg = img.numpy()\n    plt.imshow(np.transpose(npimg, (1, 2, 0)))\n    plt.show()\n\n# imshow(torchvision.utils.make_grid(torch.tensor(images_)))\n\ndef plot_img_list(img_list):\n    # settings\n    h, w = 10, 10        # for raster image\n    nrows, ncols = 1, 4  # array of sub-plots\n    figsize = [6, 8]     # figure size, inches\n\n    # prep (x,y) for extra plotting on selected sub-plots\n    xs = np.linspace(0, 2*np.pi, 60)  # from 0 to 2pi\n    ys = np.abs(np.sin(xs))           # absolute of sine\n\n    # create figure (fig), and array of axes (ax)\n    fig, ax = plt.subplots(nrows=nrows, ncols=ncols, figsize=figsize)\n#     img_list = sample_img_list[0:4]\n    # plot simple raster image on each sub-plot\n    for i, axi in enumerate(ax.flat):\n        # i runs from 0 to (nrows*ncols-1)\n        # axi is equivalent with ax[rowid][colid]\n        img = img_list[i]\n\n        axi.imshow(img, cmap=plt.cm.bone)\n        # get indices of row\/column\n        rowid = i \/\/ ncols\n        colid = i % ncols\n        # write row\/col indices as axes' title for identification\n        axi.set_title(\"Row:\"+str(rowid)+\", Col:\"+str(colid))\n\n    # one can access the axes by ax[row_id][col_id]\n    # do additional plotting on ax[row_id][col_id] of your choice\n\n    plt.tight_layout(True)\n    plt.show()\n\ndef plot_image_windows(df):\n    samples = get_sample_images(df)\n    \n    # settings\n    h, w = 5, 5        # for raster image\n    \n    figsize = [30, 30]     # figure size, inches\n    \n    ncols = 4\n    assert ncols == len(samples[0].window_images), 'incorrect number of window images'\n    \n    nrows = 15\n    assert nrows == len(samples), 'incorrect number of class in samples'\n    img_list = [ sample.window_images for sample in samples ]\n    # flatten list of list of images   \n    \n    img_list = reduce(operator.concat, img_list)\n    assert len(img_list) == ncols*nrows, 'incorrect number of class in samples'\n    \n\n    # prep (x,y) for extra plotting on selected sub-plots\n    xs = np.linspace(0, 2*np.pi, 60)  # from 0 to 2pi\n    ys = np.abs(np.sin(xs))           # absolute of sine\n\n    # create figure (fig), and array of axes (ax)\n    fig, ax = plt.subplots(nrows=nrows, ncols=ncols, figsize=figsize)\n    # plot simple raster image on each sub-plot\n    for i, axi in enumerate(ax.flat):\n        # i runs from 0 to (nrows*ncols-1)\n        # axi is equivalent with ax[rowid][colid]\n        img = img_list[i]\n\n#         axi.imshow(img, cmap=plt.cm.bone)\n        axi.imshow(img, cmap='gray')\n        # get indices of row\/column\n        rowid = i \/\/ ncols\n        colid = i % ncols\n        # write row\/col indices as axes' title for identification\n#         axi.set_title(\"Row:\"+str(rowid)+\", Col:\"+str(colid))\n    \n    # one can access the axes by ax[row_id][col_id]\n    # do additional plotting on ax[row_id][col_id] of your choice\n\n    plt.tight_layout(True)\n    plt.show()\n    return img_list\nsample_img_list = plot_image_windows(train_df)","132add27":"# Plot sample image of every class \n## (15 class as 15 rows)\n## (4 columns as 4 type of windows)","53066497":"# Utils function","e1b6ca4e":"# Average number of class_name and bboxes in an abnormal image\n## From the line below there are approximately (3.5 class_name) per abnormal image\n## AND 8.2 abnormal bboxes per abnormal image\n### Hence one image can contain multiple box of different type","53e96495":"# Check size of bounding box","a278709e":"# TODO: explain the use of different of windows in Xray","41a0d30a":"## more detail about abnormal","4d26d6cd":"# Upvote if you find this useful XD","4b91775f":"# Plot sample image of different class","43470458":"# Train dataset\n## Ratio of different class\n## total number of image in train dataset = 15000\n## total number of image in public test dataset = 3000\n\n## Number of class = 15","6ab88aac":"## helper function to organise dicom data and read image from path"}}