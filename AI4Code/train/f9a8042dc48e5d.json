{"cell_type":{"4bfdc75b":"code","e291735b":"code","8db1265c":"code","1ca488a1":"code","3618d0e1":"code","7c97e52a":"code","66b1200e":"code","70d51d6d":"markdown","6c38490b":"markdown","9367c31f":"markdown","5e0be6be":"markdown"},"source":{"4bfdc75b":"import pandas as pd, numpy as np, time\nfrom sklearn.model_selection import train_test_split\n\ndata = pd.read_csv(\"..\/input\/flights.csv\")\ndata = data.sample(frac = 0.01, random_state=76492)\n\ndata = data[[\"MONTH\",\"DAY\",\"DAY_OF_WEEK\",\"AIRLINE\",\"FLIGHT_NUMBER\",\"DESTINATION_AIRPORT\",\n                 \"ORIGIN_AIRPORT\",\"AIR_TIME\", \"DEPARTURE_TIME\",\"DISTANCE\",\"ARRIVAL_DELAY\"]]\ndata.dropna(inplace=True)\n\ndata[\"ARRIVAL_DELAY\"] = (data[\"ARRIVAL_DELAY\"]>10)*1\n\ncols = [\"AIRLINE\",\"FLIGHT_NUMBER\",\"DESTINATION_AIRPORT\",\"ORIGIN_AIRPORT\"]\nfor item in cols:\n    data[item] = data[item].astype(\"category\").cat.codes +1\n \ntrain, test, y_train, y_test = train_test_split(data.drop([\"ARRIVAL_DELAY\"], axis=1), data[\"ARRIVAL_DELAY\"],\n                                                random_state=10, test_size=0.4)","e291735b":"from sklearn.preprocessing import OneHotEncoder\n\nenc = OneHotEncoder()\nenc.fit(train[\"AIRLINE\"].values.reshape(-1, 1))  \n\nenc.feature_indices_\nairline_onehot = enc.transform(train[\"AIRLINE\"].values.reshape(-1, 1)).toarray()\nairline_onehot_test = enc.transform(test[\"AIRLINE\"].values.reshape(-1, 1)).toarray()","8db1265c":"#airline_onehot_test.shape\nair_oh_df = pd.DataFrame(airline_onehot, columns = [\"A1\",\"A2\",\"A3\",\"A4\",\"A5\",\"A6\",\"A7\",\n                                                    \"A8\",\"A9\",\"A10\",\"A11\",\"A12\",\"A13\",\"A14\"])\nair_oh_test_df = pd.DataFrame(airline_onehot_test, columns = [\"A1\",\"A2\",\"A3\",\"A4\",\"A5\",\"A6\",\"A7\",\n                                                         \"A8\",\"A9\",\"A10\",\"A11\",\"A12\",\"A13\",\"A14\"])\n","1ca488a1":"train2 = pd.concat([train.reset_index(),air_oh_df.reset_index()],axis=1).drop([\"index\",\"MONTH\",\"DAY\",\"DAY_OF_WEEK\",\"AIRLINE\",\"FLIGHT_NUMBER\",\"DESTINATION_AIRPORT\",\"ORIGIN_AIRPORT\"],axis=1)\ntest2  = pd.concat([test.reset_index(),air_oh_test_df.reset_index()],axis=1).drop([\"index\",\"MONTH\",\"DAY\",\"DAY_OF_WEEK\",\"AIRLINE\",\"FLIGHT_NUMBER\",\"DESTINATION_AIRPORT\",\"ORIGIN_AIRPORT\"],axis=1)\n\ntest2","3618d0e1":"import xgboost as xgb\nfrom sklearn import metrics\nfrom sklearn.model_selection import GridSearchCV\nfrom sklearn.preprocessing import OneHotEncoder\n\ndef auc(m, train, test): \n    return (metrics.roc_auc_score(y_train,m.predict_proba(train)[:,1]),\n            metrics.roc_auc_score(y_test,m.predict_proba(test)[:,1]))\n\n# Parameter Tuning\n#model = xgb.XGBClassifier()\nparam_dist = {\"max_depth\": [10,30,50],\n              \"min_child_weight\" : [1,3,6],\n              \"n_estimators\": [200],\n              \"learning_rate\": [0.05,0.1,0.16]}\n#grid_search = GridSearchCV(model, param_grid=param_dist, cv = 3, \n#                                   verbose=10, n_jobs=-1)\n#grid_search.fit(train, y_train)\n\n#grid_search.best_estimator_\n\nstart_time = time.time()\n\nmodel = xgb.XGBClassifier(max_depth=50, min_child_weight=1,  n_estimators=200,\n                          n_jobs=-1 , verbose=1, learning_rate=0.16)\nmodel.fit(train2, y_train)\n\nprint(auc(model, train2, test2))\n\nfinish_time = time.time()\ntotal_time = finish_time - start_time\n\nprint('Elapsed time: ', total_time)","7c97e52a":"import lightgbm as lgb\nfrom sklearn import metrics\nfrom sklearn.model_selection import GridSearchCV\n\ndef auc2(m, train, test): \n    return (metrics.roc_auc_score(y_train,m.predict(train)),\n                            metrics.roc_auc_score(y_test,m.predict(test)))\n\nlg = lgb.LGBMClassifier(silent=False)\n#param_dist = {\"max_depth\": [25,50, 75],\n#              \"learning_rate\" : [0.01,0.05,0.1],\n#              \"num_leaves\": [300,900,1200],\n#              \"n_estimators\": [200]\n#             }\n#grid_search = GridSearchCV(lg, n_jobs=-1, param_grid=param_dist, cv = 3, scoring=\"roc_auc\", verbose=5)\n#grid_search.fit(train,y_train)\n#grid_search.best_estimator_\n\nd_train = lgb.Dataset(train, label=y_train, free_raw_data=False)\nparams = {\"max_depth\": 50, \"learning_rate\" : 0.1, \"num_leaves\": 900,  \"n_estimators\": 300, \n          \"boosting_type\": 'goss', \"max_conflict_rate\": 0.3}\n\n# Sem categoricas\nmodel2 = lgb.train(params, d_train)\nauc2(model2, train, test)\n\n# Com categoricas\ncate_features_name = [\"MONTH\",\"DAY\",\"DAY_OF_WEEK\",\"AIRLINE\",\"DESTINATION_AIRPORT\",\"ORIGIN_AIRPORT\"]\n\nmodel2 = lgb.train(params, d_train, categorical_feature = cate_features_name)\nauc2(model2, train, test)","66b1200e":"import catboost as cb\ncat_features_index = [0,1,2,3,4,5,6]\n\ndef auc(m, train, test): \n    return (metrics.roc_auc_score(y_train,m.predict_proba(train)[:,1]),\n                            metrics.roc_auc_score(y_test,m.predict_proba(test)[:,1]))\n\n#params = {'depth': [4, 7, 10],\n#          'learning_rate' : [0.03, 0.1, 0.15],\n#         'l2_leaf_reg': [1,4,9],\n#         'iterations': [300]}\n#cb = cb.CatBoostClassifier()\n#cb_model = GridSearchCV(cb, params, scoring=\"roc_auc\", cv = 3)\n#cb_model.fit(train, y_train)\n\n# Sem categoricas\nclf = cb.CatBoostClassifier(eval_metric=\"AUC\", depth=10, iterations= 500, l2_leaf_reg= 9, learning_rate= 0.15)\nclf.fit(train,y_train)\nauc(clf, train, test)\n\n# Com categoricas\nclf = cb.CatBoostClassifier(eval_metric=\"AUC\",one_hot_max_size=31, \\\n                            depth=10, iterations= 500, l2_leaf_reg= 9, learning_rate= 0.15)\nclf.fit(train,y_train, cat_features= cat_features_index)\nauc(clf, train, test)","70d51d6d":"# Base de dados: flights delay","6c38490b":"# LGBM","9367c31f":"# XGBoost","5e0be6be":"# CatBoost"}}