{"cell_type":{"c95a7a9c":"code","f1597c52":"code","26aca801":"code","43cf7324":"code","917281ee":"code","ad7d6039":"code","3656dc95":"code","aad5ef45":"code","bf95b6d0":"code","cf1c6780":"code","a5caba8f":"code","3bb537b3":"markdown","7b6483c1":"markdown","2283b809":"markdown","75a9d90a":"markdown","91758953":"markdown","7a9c8711":"markdown","c806d79a":"markdown","052c5c72":"markdown","88e31e20":"markdown","b7d78dfa":"markdown"},"source":{"c95a7a9c":"# Import librairies\n%matplotlib inline \nimport numpy as np\nimport pandas as pd\nimport os\nimport matplotlib.pyplot as plt\nimport statsmodels.api as sm\nplt.style.use('seaborn')\nplt.rcParams['figure.figsize'] = [16, 9]\nfrom statsmodels.tsa import stattools\nfrom statsmodels.graphics.tsaplots import plot_acf, plot_pacf\nfrom timeit import default_timer as timers","f1597c52":"# load the data\npath = \".\/kaggle\/input\/daily-sun-spot-data-1818-to-2019\/\"\nfilename = os.path.join(path,\"sunspot_data.csv\")\ndf = pd.read_csv('\/kaggle\/input\/daily-sun-spot-data-1818-to-2019\/sunspot_data.csv', delimiter=',', na_values=['-1'])\ndf.dataframeName = 'sunspot_data.csv'\ndel(df['Unnamed: 0'])\ndf.columns = ['year', 'month', 'day', 'fraction','sunspots', 'sdt', 'obs','indicator']\ndf.head(-5)\n\n# Add the column time \ndf['time']=df[['year', 'month', 'day']].apply(lambda s: pd.datetime(*s),axis = 1)\n# time column is the index of the dataframe\ndf.index = df['time']\n# replace the Nan by linear interpolation \ndf['sunspots'].interpolate(method='linear', inplace=True)","26aca801":"ts = pd.Series(data=df.sunspots, index=df.index)\n#ts = ts['1900-01-01':]\nts_month = ts.resample('MS').mean()\nts_quarter = ts.resample('Q').mean()\nts_quarter.plot()\nplt.show()","43cf7324":"plot_pacf(ts_quarter,lags=100,title='Sunspots')\nplt.show()","917281ee":"plot_acf(ts_quarter,lags=100,title='Sunspots')\nplt.show()","ad7d6039":"from statsmodels.tsa.stattools import adfuller\ndef printADFTest(serie):\n    result = adfuller(serie, autolag='AIC')\n    print(\"ADF Statistic %F\" % (result[0]))\n    print(f'p-value: {result[1]}')\n    for key, value in result[4].items():\n        print('Critial Values:')\n        print(f'   {key}, {value}')\n    print('\\n')\n\n#d = 0\nprintADFTest(ts_quarter)\n#d = 1 \n#printADFTest(ts_quarter.diff(1).dropna())","3656dc95":"model = sm.tsa.statespace.SARIMAX(ts_quarter, trend='n', order=(3,0,10), seasonal_order=(1,1,0,43))\nresults = model.fit()\nprint(results.summary())\n","aad5ef45":"forecast = results.predict(start = ts_quarter.index[-2], end= ts_quarter.index[-2] + pd.DateOffset(months=240), dynamic= True) \nts_quarter.plot()\nforecast.plot()\nplt.show()","bf95b6d0":"!pip install pmdarima","cf1c6780":"import pmdarima as pm\ngrid_model = pm.auto_arima(ts_quarter, start_p=1, start_q=1,\n                         test='adf',\n                         max_p=4, max_q=4, m=43,\n                         start_P=0, seasonal=True,\n                         d=0, D=1, trace=True,\n                         error_action='ignore',  \n                         suppress_warnings=True, \n                         stepwise=True)\nprint(grid_model.summary())","a5caba8f":"period = 60\nfitted, confint = grid_model.predict(n_periods=period, return_conf_int=True)\nindex_of_fc = pd.date_range(ts_quarter.index[-1], periods = period, freq='Q')\n\n# make series for plotting purpose\nfitted_series = pd.Series(fitted, index=index_of_fc)\nlower_series = pd.Series(confint[:, 0], index=index_of_fc)\nupper_series = pd.Series(confint[:, 1], index=index_of_fc)\n\n# Plot\nplt.plot(ts_quarter)\nplt.plot(fitted_series, color='darkgreen')\nplt.fill_between(lower_series.index, \n                 lower_series, \n                 upper_series, \n                 color='k', alpha=.15)\n\nplt.title(\"SARIMA - Forecast Sunspots\")\nplt.show()","3bb537b3":"## Description of the data \nColumns are :\n* Year\n* Month\n* Day\n* Fraction of the year\n* Total sunspot number\n* Standard deviation\n* Number of observations\n* Indicator : observation has been done or not.\n\n**(-1) stands for NAN**\n\nDaily total sunspot number derived by the formula: R= Ns + 10 * Ng, with Ns the number of spots and Ng the number of groups counted over the entire solar disk.","7b6483c1":"## Time serie creation\n**Data are resample monthly and quarter**","2283b809":"### Find the seasonality (S) ?\nhttps:\/\/en.wikipedia.org\/wiki\/Solar_cycle\n> The solar cycle or solar magnetic activity cycle is a nearly periodic 11-year change in the Sun's activity. \n\nFrom the ACF plot, the first high lag is around 43, so let's take **S=43**\n\n*Remark : we can observe on the global plot of sunspots (ts_quarter.plot()) that the cycles are not regular, between [10.5 , 11.5] years*\n\n\n### Find the order of seasonal differencing (D) ?\n**D=1**, the series has a stable seasonal pattern over time.\n\n### Find the order of the AR term (p) ?\nPACF plot : p = first lag where the value is above the significance level. **p=3**\n\n### Find the order of the MA term (q) ?\nACF plot : q = first lag where the value is above the significance level. **q=10**\n##### How to find the order of the seasonal AR term (P) ?\nACF plot : **P=1**, ACF is positive at lag 43 AND P+Q\u22642\n##### How to find the order of the seasonal MA term (Q) ?\nACF plot : **Q=0** ACF is negative at lag 43 AND P+Q\u22642\n\n## Build the model SARIMA(3,0,10)(1,1,0,43)","75a9d90a":"### Find the order of differencing (d) ?\nThe test of stationarity is significative with non differencing, so d=0","91758953":"# SARIMA - Seasonal Autoregressive Integrated Moving Average\nSARIMA is a seasonal ARIMA\n\nIn order to configure a SARIMA(p,d,q)(P,D,Q)S, two kind of hyperparameters have to be set \n\n#### Trend parameters\n* p: The number of lag observations included in the model, also called the lag order.\n* d: The number of times that the raw observations are differenced, also called the degree of differencing.(The purpose of differencing it to make the time series stationary.)\n* q: The size of the moving average window, also called the order of moving average.\n(The purpose of differencing it to make the time series stationary.)\n\n#### Seasonal parameters\n* P: Seasonal autoregressive order.\n* D: Seasonal order of differencing.\n* Q: Seasonal moving average order.\n* S: The number of time steps for a single seasonal period.\n\n\n## Rules\nThe selection of these parameters comes from the observation of the ACF\/PACF plots.\n\n*(personal point of view : not really straightforward to pick the good parameters)*\n\n##### How to find the order of differencing (d) ?\n> Apply differentiation until the stationarity test is good.\n##### How to find the order of the AR term (p) ?\n> With the Partial Autocorrelation (PACF) plot : p = first lag where the value is above the significance level.\n##### How to find the order of the MA term (q) ?\n> With the Partial Autocorrelation (ACF) plot : q = first lag where the value is above the significance level.\n##### How to find the seasonality (S) ?\n> Directly from the observed data or domain knowledge OR with the Partial Autocorrelation (ACF) plot : S is around the high lag\n##### How to find the order of seasonal differencing (D) ?\n> D=1 if the series has a stable seasonal pattern over time, else D=0 otherwise , AND d+D\u22642\n##### How to find the order of the seasonal AR term (P) ?\n> P\u22651 if the ACF is positive at lag S, else P=0 AND P+Q\u22642\n##### How to find the order of the seasonal MA term (Q) ?\n> Q\u22651 if the ACF is negative at lag S, else Q=0, AND P+Q\u22642\n","7a9c8711":"### plot the forecast","c806d79a":"# Go further ... \n## determine the parameters (p,d,q)(P,D,Q,S) with a grid search\nWe need to install the package pmdarima","052c5c72":"# Sunspots forecasting with SARIMA\n\n## Source of the data \n* The data comes from http:\/\/www.sidc.be\/\n* A full description can be found here http:\/\/www.sidc.be\/silso\/infosndtot\n\n**The data gather the daily total sunspot number from 1818.**","88e31e20":"## Apply these rules on sunspots data\nFirst plot PACF and ACF","b7d78dfa":"## Plot the forecast"}}