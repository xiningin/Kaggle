{"cell_type":{"d45a5bf7":"code","109d8116":"code","929a6dc0":"code","2e660ad0":"code","704395fe":"code","fac921c9":"code","5228f80c":"code","74c6aff0":"code","6a9a7ef9":"code","8d5deb63":"code","a9da86a1":"code","d23c86f9":"code","313a1b21":"code","99550737":"code","490515da":"code","724e3521":"code","ee013fd3":"code","e24b3d45":"code","ab031e1d":"code","2e3efb09":"code","bafbc83c":"code","6d2e2809":"code","85225163":"code","85c1b616":"code","c8c654c9":"code","c343d57b":"code","4aeb7c89":"code","339ffce4":"code","e4e7f633":"code","fadd583d":"code","889ad1ee":"code","8a949913":"code","46242898":"code","2e11a61d":"code","3036c2f6":"code","a5005190":"markdown","9048e76c":"markdown","c7330274":"markdown","6fac80a6":"markdown","cc656236":"markdown","eed42308":"markdown","4e7cf0b7":"markdown","4c123424":"markdown","899afa20":"markdown","0746e792":"markdown","05c8a4b2":"markdown","c833ae75":"markdown","423205ab":"markdown","03c27eae":"markdown","3be35ec4":"markdown","626f2a76":"markdown","710c64c1":"markdown","70c87231":"markdown","5df20487":"markdown","167c5350":"markdown","bb4a51ab":"markdown","6423fae1":"markdown","dd2d38f0":"markdown","1c5c5062":"markdown","9325f230":"markdown","0f510c76":"markdown","b45b0d07":"markdown","6e429d2b":"markdown","b0cdb6a0":"markdown"},"source":{"d45a5bf7":"import numpy as np \nimport pandas as pd \nfrom scipy import spatial\n\nimport warnings\nwarnings.filterwarnings('ignore')\n\nimport re\nimport os\nprint(os.listdir(\"..\/input\"))\n","109d8116":"ratings = pd.read_csv(\"..\/input\/ratings.csv\")\n# links = pd.read_csv(\"..\/input\/links.csv\")\ntags = pd.read_csv(\"..\/input\/tags.csv\")\nmovies = pd.read_csv(\"..\/input\/movies.csv\")","929a6dc0":"print(ratings.shape)\nratings.head(5)","2e660ad0":"pd.options.display.float_format = '{:f}'.format\nratings['rating'].describe()","704395fe":"#number of ratings\nratings['rating'].hist()","fac921c9":"ratings['rating'].plot( kind='box',subplots=True)","5228f80c":"userRatingsAggr = ratings.groupby(['userId']).agg({'rating': [np.size, np.mean]})\nuserRatingsAggr.reset_index(inplace=True)  # To reset multilevel (pivot-like) index\nuserRatingsAggr.head()","74c6aff0":"userRatingsAggr['rating'].describe()","6a9a7ef9":"userRatingsAggr['rating'].plot(kind='box', subplots=True)","8d5deb63":"movieRatingsAggr = ratings.groupby(['movieId']).agg({'rating': [np.size, np.mean]})\nmovieRatingsAggr.reset_index(inplace=True)\nmovieRatingsAggr.head()","a9da86a1":"movieRatingsAggr['rating'].describe()","d23c86f9":"movieRatingsAggr['rating'].plot(kind='box', subplots=True)","313a1b21":"print(tags.shape)\ntags.head(5)","99550737":"print(movies.shape)\nmovies.head(5)","490515da":"movies = movies.merge(movieRatingsAggr, left_on='movieId', right_on='movieId', how='left')  # ['rating']\nmovies.columns = ['movieId', 'title', 'genres', 'rating_count', 'rating_avg']","724e3521":"movies.head(5)","ee013fd3":"def getYear(title):\n    result = re.search(r'\\(\\d{4}\\)', title)\n    if result:\n        found = result.group(0).strip('(').strip(')')\n    else: \n        found = 0\n    return int(found)\n    \nmovies['year'] = movies.apply(lambda x: getYear(x['title']), axis=1)\nmovies.head(10)","e24b3d45":"genresList = [\n  \"Action\",\n  \"Adventure\",\n  \"Animation\",\n  \"Children\",\n  \"Comedy\",\n  \"Crime\",\n  \"Documentary\",\n  \"Drama\",\n  \"Fantasy\",\n  \"Film-Noir\",\n  \"Horror\",\n  \"Musical\",\n  \"Mystery\",\n  \"Romance\",\n  \"Sci-Fi\",\n  \"Thriller\",\n  \"War\",\n  \"Western\",\n  \"(no genres listed)\"\n]\n\ndef setGenresMatrix(genres):\n    movieGenresMatrix = []\n    movieGenresList = genres.split('|')\n    for x in genresList:\n        if (x in movieGenresList):\n            movieGenresMatrix.append(1)\n        else:\n            movieGenresMatrix.append(0) \n    return movieGenresMatrix\n    \nmovies['genresMatrix'] = movies.apply(lambda x: np.array(list(setGenresMatrix(x['genres']))), axis=1)\n\nmovies.head(5)","ab031e1d":"movieRatingsAggr['rating'].describe(percentiles=[0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 0.95, 0.98, 0.99])","2e3efb09":"def setRatingGroup(numberOfRatings):\n    # if (numberOfRatings is None): return 0\n    if (1 <= numberOfRatings <= 10): return 1\n    elif (11 <= numberOfRatings <= 30): return 2\n    elif (31 <= numberOfRatings <= 100): return 3\n    elif (101 <= numberOfRatings <= 300): return 4\n    elif (301 <= numberOfRatings <= 1000): return 5\n    elif (1001 <= numberOfRatings): return 6\n    else: return 0\n\nmovies['ratingGroup'] = movies.apply(lambda x: setRatingGroup(x['rating_count']), axis=1)\nmovies.fillna(0, inplace=True)  # Replace NaN values to zero\nmovies.head(10)","bafbc83c":"stopWords = ['a', 'about', 'above', 'above', 'across', 'after', 'afterwards', 'again', 'against', 'all', 'almost', \n        'alone', 'along', 'already', 'also','although','always','am','among', 'amongst', 'amoungst', 'amount',  'an', 'and', \n        'another', 'any','anyhow','anyone','anything','anyway', 'anywhere', 'are', 'around', 'as',  'at', 'back','be','became', \n        'because','become','becomes', 'becoming', 'been', 'before', 'beforehand', 'behind', 'being', 'below', 'beside', 'besides', \n        'between', 'beyond', 'bill', 'both', 'bottom','but', 'by', 'call', 'can', 'cannot', 'cant', 'co', 'con', 'could', 'couldnt', \n        'cry', 'de', 'describe', 'detail', 'do', 'done', 'down', 'due', 'during', 'each', 'eg', 'eight', 'either', 'eleven','else', \n        'elsewhere', 'empty', 'enough', 'etc', 'even', 'ever', 'every', 'everyone', 'everything', 'everywhere', 'except', 'few', 'fifteen', \n        'fify', 'fill', 'find', 'fire', 'first', 'five', 'for', 'former', 'formerly', 'forty', 'found', 'four', 'from', 'front', 'full', \n        'further', 'get', 'give', 'go', 'had', 'has', 'hasnt', 'have', 'he', 'hence', 'her', 'here', 'hereafter', 'hereby', 'herein', 'hereupon', \n        'hers', 'herself', 'him', 'himself', 'his', 'how', 'however', 'hundred', 'ie', 'if', 'in', 'inc', 'indeed', 'interest', 'into', 'is', 'it', \n        'its', 'itself', 'keep', 'last', 'latter', 'latterly', 'least', 'less', 'ltd', 'made', 'many', 'may', 'me', 'meanwhile', 'might', 'mill', \n        'mine', 'more', 'moreover', 'most', 'mostly', 'move', 'much', 'must', 'my', 'myself', 'name', 'namely', 'neither', 'never', 'nevertheless', \n        'next', 'nine', 'no', 'nobody', 'none', 'noone', 'nor', 'not', 'nothing', 'now', 'nowhere', 'of', 'off', 'often', 'on', 'once', 'one', \n        'only', 'onto', 'or', 'other', 'others', 'otherwise', 'our', 'ours', 'ourselves', 'out', 'over', 'own','part', 'per', 'perhaps', 'please', \n        'put', 'rather', 're', 'same', 'see', 'seem', 'seemed', 'seeming', 'seems', 'serious', 'several', 'she', 'should', 'show', 'side', 'since', \n        'sincere', 'six', 'sixty', 'so', 'some', 'somehow', 'someone', 'something', 'sometime', 'sometimes', 'somewhere', 'still', 'such', 'system', \n        'take', 'ten', 'than', 'that', 'the', 'their', 'them', 'themselves', 'then', 'thence', 'there', 'thereafter', 'thereby', 'therefore', 'therein', \n        'thereupon', 'these', 'they', 'thickv', 'thin', 'third', 'this', 'those', 'though', 'three', 'through', 'throughout', 'thru', 'thus', 'to', \n        'together', 'too', 'top', 'toward', 'towards', 'twelve', 'twenty', 'two', 'un', 'under', 'until', 'up', 'upon', 'us', 'very', 'via', 'was', \n        'we', 'well', 'were', 'what', 'whatever', 'when', 'whence', 'whenever', 'where', 'whereafter', 'whereas', 'whereby', 'wherein', 'whereupon', \n        'wherever', 'whether', 'which', 'while', 'whither', 'who', 'whoever', 'whole', 'whom', 'whose', 'why', 'will', 'with', 'within', 'without', 'would', \n        'yet', 'you', 'your', 'yours', 'yourself', 'yourselves', 'the']\n\ntagsDict = {}\n\nfor index, x in tags.iterrows():\n    wordlist = str(x['tag']).lower().split(' ')\n    movieId = x['movieId']\n    for y in wordlist:\n        if y not in stopWords:\n            if movieId in tagsDict:\n                # if y not in tagsDict[movieId]:  # Switched off (we will get a non unique list)\n                    tagsDict[movieId].append(y)\n            else:\n                tagsDict[movieId] = [y]\n\ntags.apply(lambda x: str(x['tag']).split(' '), axis=1)\nprint(tagsDict[6])","6d2e2809":"titleWordsDict = {}\n\nfor index, x in movies.iterrows():\n    wordlist = str(x['title']).lower().split(' ')\n    movieId = x['movieId']\n    for y in wordlist:\n        if y not in stopWords:\n            if movieId in titleWordsDict:\n                    titleWordsDict[movieId].append(y)\n            else:\n                titleWordsDict[movieId] = [y]","85225163":"# Parameter weights\ngenresSimilarityWeight = 0.8\ntagsSimilarityWeight = 2\ntitleSimilarityWeight = 1\nratingAvgWeight = 0.2\nratingGroupWeight = 0.005\nyearDistanceWeight = 0.1\n\ndef tagsSimilarity(basisMovieID, checkedMovieID, checkType):    \n    # The higher value is the more similar (from 0 to 1) \n    if checkType == 'tag':\n        dictToCheck = tagsDict\n    else:\n        dictToCheck = titleWordsDict\n        \n    counter = 0\n    if basisMovieID in dictToCheck: \n        basisTags = dictToCheck[basisMovieID]\n        countAllTags = len(basisTags)\n        basisTagsDict = {}\n        for x in basisTags:\n            if x in basisTagsDict:\n                basisTagsDict[x] += 1\n            else:\n                basisTagsDict[x] = 1   \n        \n        for x in basisTagsDict:\n            basisTagsDict[x] = basisTagsDict[x] \/ countAllTags\n    else: return 0\n    \n    if checkedMovieID in dictToCheck: \n        checkedTags = dictToCheck[checkedMovieID]\n        checkedTags = set(checkedTags) # Make the list unique\n        checkedTags = list(checkedTags)\n        \n    else: return 0\n    \n    for x in basisTagsDict:\n        if x in checkedTags: counter += basisTagsDict[x]\n    return counter\n    \ndef checkSimilarity(movieId):\n    # print(\"SIMILAR MOVIES TO:\")\n    # print (movies[movies['movieId'] == movieId][['title', 'rating_count', 'rating_avg']])\n    basisGenres = np.array(list(movies[movies['movieId'] == movieId]['genresMatrix']))\n    basisYear = int(movies[movies['movieId'] == movieId]['year'])\n    basisRatingAvg = movies[movies['movieId'] == movieId]['rating_avg']\n    basisRatingGroup = movies[movies['movieId'] == movieId]['ratingGroup']\n    \n    moviesWithSim = movies\n    moviesWithSim['similarity'] = moviesWithSim.apply(lambda x: \n                                                      spatial.distance.cosine(x['genresMatrix'], basisGenres) * genresSimilarityWeight + \n                                                      - tagsSimilarity(movieId, x['movieId'], 'tag') * tagsSimilarityWeight +\n                                                      - tagsSimilarity(movieId, x['movieId'], 'title') * titleSimilarityWeight +\n                                                      abs(basisRatingAvg - x['rating_avg']) * ratingAvgWeight +\n                                                      abs(basisRatingGroup - x['ratingGroup']) * ratingGroupWeight + \n                                                      abs(basisYear - x['year'])\/100 * yearDistanceWeight\n                                                     , axis=1)\n    \n    moviesWithSim = moviesWithSim.loc[(moviesWithSim.movieId != movieId)]\n    return moviesWithSim[['movieId', 'title', 'genres', 'rating_count', 'rating_avg', 'similarity']].sort_values('similarity')\n","85c1b616":"currentMovie = movies.loc[(movies.movieId == 3793)]\ncurrentMovie.head(1)","c8c654c9":"# X-men\nsimilarityResult  = checkSimilarity(3793)\nsimilarityResult.head(5)","c343d57b":"# Lock, Stock & Two Smoking Barrels\nsimilarityResult  = checkSimilarity(2542)\nsimilarityResult.head(5)","4aeb7c89":"# Casino\nsimilarityResult  = checkSimilarity(16)\nsimilarityResult.head(5)","339ffce4":"# Star Wars: Episode IV - A New Hope\nsimilarityResult  = checkSimilarity(260)\nsimilarityResult.head(5)","e4e7f633":"# Iron Man\nsimilarityResult  = checkSimilarity(59315)\nsimilarityResult.head(5)","fadd583d":"# The Good, the Bad and the Ugly\nsimilarityResult  = checkSimilarity(1201)\nsimilarityResult.head(5)","889ad1ee":"# Mega Shark vs. Giant Octopus\nsimilarityResult  = checkSimilarity(73829)\nsimilarityResult.head(5)","8a949913":"# King Kong Escapes (Kingu Kongu no gyakush\u00fb)\nsimilarityResult  = checkSimilarity(92518)\nsimilarityResult.head(5)","46242898":"# Armageddon\nsimilarityResult  = checkSimilarity(1917)\nsimilarityResult.head(5)","2e11a61d":"# Groundhog Day\nsimilarityResult  = checkSimilarity(1265)\nsimilarityResult.head(5)\n\n\n","3036c2f6":"# Cars\nsimilarityResult  = checkSimilarity(45517)\nsimilarityResult.head(5)","a5005190":"### Create genres matrix - one hot encoding\nAt this step I create a \"genresMatrix\" field where every value is a list of binary values (19 elements in every list, for the 19 possible genres).  For example a movie with genres \"Action\", \"Adventure\" and \"Children\" will look like: [1, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0] . This transformation called as \"one hot encoding\".\n\nThis matrix will be very useful to define the similarities between two \"genres\" sets. For this purpose I'm going to compute the Cosine distance between the given arrays. More info: [SciPy spatial.distance.cosine](https:\/\/docs.scipy.org\/doc\/scipy\/reference\/generated\/scipy.spatial.distance.cosine.html)","9048e76c":"# Movie recommendation algorithm\n\nThe algorithm gets a \"movieId\" as input parameter and computes the similarity for every other movie in the dataset. To fine-tuning this process, we can set up weights for the 6 defined similarity attributes at the beginning of the code. At the end we just ordering the result set (the most similar movies will be at the beginning). ","c7330274":"<img style=\"float: left;\" src=\"https:\/\/movieposters2.com\/images\/750888-b.jpg\" width=\"280\" height=\"400\"> \n<span style=\"font-size:200%;margin:20px;\">Iron Man<\/span>","6fac80a6":"<img style=\"float: left;\" src=\"https:\/\/movieposters2.com\/images\/645250-b.jpg\" width=\"280\" height=\"400\">\n<span style=\"font-size:200%;margin:20px;\">Cars<\/span>","cc656236":"### Ratings group by","eed42308":"<img style=\"float: left;\" src=\"https:\/\/movieposters2.com\/images\/641904-b.jpg\" width=\"280\" height=\"400\"> \n<span style=\"font-size:200%;margin:20px;\">Armageddon<\/span>","4e7cf0b7":"**Movie ratings aggregated by movie:**","4c123424":"### Words in movie title\nThe same as the previous \"tags\" processing, but for the words in movie title.","899afa20":"<img style=\"float: left;\" src=\"https:\/\/movieposters2.com\/images\/1125336-b.jpg\" width=\"280\" height=\"400\"> \n<span style=\"font-size:200%;margin:20px;\">X-men<\/span>","0746e792":"![](https:\/\/cdn20.patchcdn.com\/users\/22924509\/20180417\/024653\/styles\/T800x600\/public\/processed_images\/jag_cz_movie_theater_retro_shutterstock_594132752-1523990060-9711.jpg)\n# Description\nIn this kernel I built an item-based movie recommendation algorithm. The algorithm finds the most similar movies to a given movie, therefore it's not a personal recommender system based on former user behaviour.\n\nFirstly I analyzed the dataset and tried to find to most relevant attributes. For example the \"number of rating\" attribute is not so relevant in my opinion, because the dataset contains a lot of popular movies without any rating. To find the best solution, I decided to develop an algorithm that can be fine tuned with weights for each used attrributes. \n\n#### The final list of applied attributes are:\n- Average user ratings\n- Number of user ratings\n- Genres similarity\n- User given tags similarity\n- Title similarity\n- Movie year\n\nAfter that, I prepared the dataset and computed the relevant measurements.  For better performance of \"tag\" and \"title\" words analysis I exluded the most frequent English words from the tags and movie titles.\n\nFinally I created the recommendation algorithm and made some recommendation at the end.  \n\n\n","05c8a4b2":"<img style=\"float: left;\" src=\"https:\/\/movieposters2.com\/images\/744898-b.jpg\" width=\"280\" height=\"400\"> \n<span style=\"font-size:200%;margin:20px;\">Lock, Stock & Two Smoking Barrels<\/span>","c833ae75":"# Load and check data","423205ab":"<img style=\"float: left;\" src=\"https:\/\/images-na.ssl-images-amazon.com\/images\/I\/91BDDsP0clL._RI_SX200_.jpg\" width=\"280\" height=\"400\"> \n<span style=\"font-size:200%;margin:20px;\">The Good, the Bad and the Ugly<\/span>","03c27eae":"**Movie ratings aggregated by user:**","3be35ec4":"<img style=\"float: left;\" src=\"https:\/\/movieposters2.com\/images\/735848-b.jpg\" width=\"280\" height=\"400\">\n<span style=\"font-size:200%;margin:20px;\">Groundhog Day<\/span>","626f2a76":"**Check the distribution of ratings per movie**","710c64c1":"### Tags \nIterate through all the user given tags, split the tags into words, filter the defined stop words (frequent English words) and put the results into a dictionary that indexed by movieId.","70c87231":"# Movie recommendations","5df20487":"### Join movie rating data","167c5350":"### Movies (master data)","bb4a51ab":"<img style=\"float: left;\" src=\"https:\/\/movieposters2.com\/images\/1328176-b.jpg\" width=\"280\" height=\"400\"> \n<span style=\"font-size:200%;margin:20px;\">Casino<\/span>","6423fae1":"### Ratings","dd2d38f0":"### Tags","1c5c5062":"<img style=\"float: left;\" src=\"https:\/\/movieposters2.com\/images\/641096-b.jpg\" width=\"280\" height=\"400\"> \n<span style=\"font-size:200%;margin:20px;\">Mega Shark vs. Giant Octopus<\/span>","9325f230":"<img style=\"float: left;\" src=\"https:\/\/movieposters2.com\/images\/637194-b.jpg\" width=\"280\" height=\"400\"> \n<span style=\"font-size:200%;margin:20px;\">King Kong Escapes (Kingu Kongu no gyakush\u00fb)<\/span>","0f510c76":"<img style=\"float: left;\" src=\"https:\/\/movieposters2.com\/images\/660783-b.jpg\" width=\"280\" height=\"400\"> \n<span style=\"font-size:200%;margin:20px;\">Star Wars: Episode IV - A new hope<\/span>","b45b0d07":"### Get movie years from title","6e429d2b":"### Set rating categories\nBased on the number of user ratings per movie, I have defined 7 rating groups.","b0cdb6a0":"**The desired rating number groups will be:**\n* 0 - not rated movie\n* 1 - count of ratings between 1 - 10\n* 2 - count of ratings between 11 - 30\n* 3 - count of ratings between 31 - 100\n* 4 - count of ratings between 101 - 300\n* 5 - count of ratings between 301 - 1000\n* 6 - count of ratings between 1001 - "}}