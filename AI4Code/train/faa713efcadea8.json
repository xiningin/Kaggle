{"cell_type":{"a00b8192":"code","432f2a4e":"code","57546ac9":"code","484d0408":"code","8987894c":"code","7362d2e7":"code","c8fb1b65":"code","d6b292fa":"code","a840267f":"code","478db2bf":"code","7ce4eade":"code","0dfb826f":"code","47490003":"code","d6aa569f":"code","8c1ea753":"code","64aabdab":"code","3543297e":"code","273639e7":"code","f400314e":"code","c076b7fc":"code","c23db0d1":"code","9ebeb52f":"code","00d25d41":"code","a67ea640":"code","e44ef4c5":"code","8afd0c77":"code","50d29f24":"code","a088e03d":"code","066bbff4":"code","cb76477c":"markdown","5a41d6b6":"markdown","ac4f3308":"markdown","35e15ae3":"markdown","d5ab2357":"markdown","70abdf31":"markdown","a63f0be8":"markdown","35d6db7a":"markdown","592f2032":"markdown","3b15b6de":"markdown","b7f8d200":"markdown","bad4c3b5":"markdown","c8226517":"markdown"},"source":{"a00b8192":"import os\nfrom time import time\nimport datetime as dt\nimport numpy as np\nimport pandas as pd\nimport matplotlib.pyplot as plt","432f2a4e":"input_dir = \"..\/input\"\ntest_dir = os.path.join(input_dir,'cv-machine-learning-gbdts')\ntest_x = pd.read_csv('{}\/test_x.gz'.format(test_dir), index_col=0, compression='gzip')\n\nprint('Number of test instances: {}'.format(test_x.shape))\ntest_x.sample(3)","57546ac9":"test_y = pd.read_csv('{}\/test_y.gz'.format(test_dir), header=None, index_col=0, compression='gzip')\nprint('Number of test instances: {}'.format(test_y.shape))\ntest_y.columns = ['Matched']\n\ntest_y.sample(3)","484d0408":"print('The number of unmatched instances is {}'.format(sum(test_y['Matched']==0)))\nprint('The number of matched instances is {}'.format(sum(test_y['Matched']==1)))","8987894c":"test_y = test_x[['questions_id']].merge(test_y, left_index=True, right_index=True)","7362d2e7":"gbdts_dir = os.path.join(input_dir,'cv-machine-learning-gbdts')\ngbdts_y = pd.read_csv('{}\/predicted_test_y.gz'.format(gbdts_dir), index_col=0, compression='gzip')\ngbdts_y.columns = ['GBDTs_Prob']\n\nprint('Number of GBDTs predicted scores: {}'.format(gbdts_y.shape))\ngbdts_y.head(3)","c8fb1b65":"predicted_scores= test_y.merge(gbdts_y, left_index=True, right_index=True)","d6b292fa":"predicted_scores.sample(3)","a840267f":"clr_dir = os.path.join(input_dir,'cv-machine-learning-conditional-lr')\nprint(os.listdir(clr_dir))","478db2bf":"clr_y = pd.read_csv('{}\/ConditionalLR_predicted_y.csv'.format(clr_dir), index_col=0)\nprint('Number of CLR predicted scores: {}'.format(clr_y.shape))\nclr_y.columns = ['CLR_Prob']\nclr_y.index = predicted_scores.index\nclr_y.head(3)","7ce4eade":"predicted_scores= predicted_scores.merge(clr_y, left_index=True, right_index=True)","0dfb826f":"predicted_scores.head(3)","47490003":"def compute_min_rank(rows, col_name):\n    rows['Rank'] = rows[col_name].rank(ascending=False)\n    rows=rows[rows['Matched']==1]\n    return rows['Rank'].min()","d6aa569f":"def compute_max_rank(rows, col_name):\n    rows['Rank'] = rows[col_name].rank(ascending=False)\n    rows=rows[rows['Matched']==1]\n    return rows['Rank'].max()","8c1ea753":"cut_points = range(1,20+1)\ndef compute_recall(cut_points, ranked_results):\n    cut_results = {'Top K': [],\n                   'GBDTs': [],\n                   'CLR': [],\n                  }\n    for cut_point in cut_points:\n        cut_results['Top K'].append(cut_point)\n        cut_results['GBDTs'].append(ranked_results[ranked_results['GBDTs'] <= cut_point].shape[0])\n        cut_results['CLR'].append(ranked_results[ranked_results['CLR'] <= cut_point].shape[0])\n\n    cut_results = pd.DataFrame(cut_results)\n    cut_results['GBDTs'] = cut_results['GBDTs'] \/ ranked_results.shape[0]\n    cut_results['CLR'] = cut_results['CLR'] \/ ranked_results.shape[0]\n    return cut_results","64aabdab":"min_ranked_results = pd.DataFrame({'GBDTs': predicted_scores.groupby('questions_id').apply(compute_min_rank, col_name='GBDTs_Prob'),\n                                   'CLR': predicted_scores.groupby('questions_id').apply(compute_min_rank, col_name='CLR_Prob'),\n                                   'Matches': predicted_scores.groupby('questions_id')['Matched'].sum(),\n                                   'Recommendations': predicted_scores.groupby('questions_id')['Matched'].count()})\nmin_ranked_results = min_ranked_results[min_ranked_results['Matches'] > 0]","3543297e":"min_ranked_results.sample(5)","273639e7":"min_rank_cut_results = compute_recall(cut_points, min_ranked_results)\nmin_rank_cut_results.set_index('Top K').plot()\nplt.ylabel('At Least One Recall')\nplt.title('At Least One Recall Performance Comparison:\\nConditional Logistic Regression vs GBDTs')\nplt.savefig('min_rank_recommendation_recall.jpg')","f400314e":"max_ranked_results = pd.DataFrame({'GBDTs': predicted_scores.groupby('questions_id').apply(compute_max_rank, col_name='GBDTs_Prob'),\n                                   'CLR': predicted_scores.groupby('questions_id').apply(compute_max_rank, col_name='CLR_Prob'),\n                                   'Matches': predicted_scores.groupby('questions_id')['Matched'].sum(),\n                                   'Recommendations': predicted_scores.groupby('questions_id')['Matched'].count()})\nmax_ranked_results = max_ranked_results[max_ranked_results['Matches'] > 0]","c076b7fc":"max_ranked_results.sample(5)","c23db0d1":"max_rank_cut_results = compute_recall(cut_points, max_ranked_results)\nmax_rank_cut_results.set_index('Top K').plot()\nplt.ylabel('Full Recall')\nplt.title('Full Recall Performance Comparison:\\nConditional Logistic Regression vs GBDTs')\nplt.savefig('max_rank_recommendation_recall.jpg')","9ebeb52f":"predicted_scores['GBDTs_Rank'] = predicted_scores.groupby('questions_id')['GBDTs_Prob'].rank(ascending=False)","00d25d41":"print('The total number of correct original recommendations: {}'.format(predicted_scores[\n    (predicted_scores['Matched']==1)].shape[0]))\n\nprint('The total number of correct ML top-20 recommendations: {}'.format(\n    predicted_scores[((predicted_scores['GBDTs_Rank'] <= 20) & (predicted_scores['Matched']==1))].shape[0]))\n\nprint('The ML top-20 accuracy is {}%'.format(np.round(100 * predicted_scores[\n    ((predicted_scores['GBDTs_Rank'] <= 20) & (predicted_scores['Matched']==1))].shape[0] \/ predicted_scores[(predicted_scores['Matched']==1)].shape[0],1)))","a67ea640":"print('The total number of original recommendations: {}'.format(predicted_scores.shape[0]))\n\nprint('The total number of ML top-20 recommendations: {}'.format(predicted_scores[\n    predicted_scores['GBDTs_Rank'] <= 20].shape[0]))\n\nprint('The decrease in the number of sent recommendations is {} folds: '.format(\n    np.round(predicted_scores.shape[0] \/ predicted_scores[\n    predicted_scores['GBDTs_Rank'] <= 20].shape[0], 1)\n))","e44ef4c5":"predicted_scores = test_x[['answer_user_id', 'emails_date_sent']].merge(\n    predicted_scores, left_index=True, right_index=True)","8afd0c77":"before_ml_counts = predicted_scores.groupby(['answer_user_id', 'emails_date_sent'])['questions_id'].count()\nbefore_ml_counts[before_ml_counts <= 30].hist(bins=30)\nplt.ylabel('Emails')\nplt.title('The mean value is {}'.format(round(before_ml_counts.mean(),1)))\nplt.savefig('before_ml_questions_in_each_email.jpg')","50d29f24":"after_ml_counts = predicted_scores[predicted_scores['GBDTs_Rank'] <= 20\n                ].groupby(['answer_user_id', 'emails_date_sent'])['questions_id'].count()\nafter_ml_counts[after_ml_counts <= 30].hist(bins=30)\nplt.ylabel('Emails')\nplt.title('The mean value is {}'.format(round(after_ml_counts.mean(),1)))\nplt.savefig('after_ml_questions_in_each_email.jpg')","a088e03d":"predicted_scores.to_csv('predicted_scores.csv.gz', compression='gzip')\n\nmin_ranked_results.to_csv('min_ranked_results.csv.gz', compression='gzip')\nmin_rank_cut_results.to_csv('min_rank_cut_results.csv.gz', compression='gzip')\n\nmax_ranked_results.to_csv('max_ranked_results.csv.gz', compression='gzip')\nmax_rank_cut_results.to_csv('max_rank_cut_results.csv.gz', compression='gzip')","066bbff4":"os.listdir()","cb76477c":"# IV. Performance Evaluation #","5a41d6b6":"** 'Max Rank' allows to measure the recall to recover of all relevant matches. **","ac4f3308":"# III. Loading Conditional Logistic Regression Results #","35e15ae3":"** Using the top 20 recommendations from our GBDTs model, we can still maintain a high recall but the volume of recommendations to send out can be reduced significantly by more than 15 times. **","d5ab2357":"** The distribution of the numbers of questions that professionals receive in each email in the test set using the current tag-based recommendation system. **","70abdf31":"** Adding questions_id to test instances to evaluate recommendation performance in next sections **","a63f0be8":"** The distribution of the numbers of questions that professionals receive in each email in the test set using the proposed ML GBDTs model. On average, the recommendations in each email is reduced by half. **","35d6db7a":"# II. Loading Gradient Boosting Decision Trees Results #","592f2032":"** 'Min Rank' allows to measure the recall to recover of at least one relevant match. **","3b15b6de":"## IV.1. Improvement Impacts: Decreases in Recommendation Volumes ##","b7f8d200":"# V. Saving Results #","bad4c3b5":"## IV.1. Performance Comparison ##","c8226517":"# I. Loading the Test Data Set ##"}}