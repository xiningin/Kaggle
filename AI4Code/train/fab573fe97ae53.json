{"cell_type":{"72ae3ea8":"code","4cd240e0":"code","702a8c45":"code","a0ec39c4":"code","a28455b7":"code","23f040b5":"code","06d94a89":"code","14abc6e5":"code","286490b7":"code","fca12871":"code","49ac7c6b":"code","25200c09":"code","ce36f15c":"code","03663385":"code","f7160f3e":"code","91ab7a3d":"code","14d09b4b":"code","403857d9":"code","48428c93":"code","c656c22e":"code","c4096433":"code","7b475577":"code","fd70b8c9":"code","71027b3b":"code","ad5e254f":"code","edb8e11e":"code","56d190f5":"code","e2b444e9":"markdown","1bb27952":"markdown","e9548c4e":"markdown","c84b580c":"markdown","bd7ac4af":"markdown","a0e1ddf2":"markdown","daf884fa":"markdown"},"source":{"72ae3ea8":"import numpy as np\nimport pandas as pd\n\nimport os\n\nfrom sklearn.impute import SimpleImputer\nfrom sklearn.preprocessing import StandardScaler\n\nfrom sklearn.model_selection import StratifiedKFold,KFold\nfrom tqdm import tqdm\nimport numpy as np\nimport pickle\nimport optuna\n\n# Metrics for models evaluation\nfrom sklearn.metrics import roc_auc_score\nfrom functools import partial\n\nimport matplotlib.pyplot as plt\nimport pandas as pd\nimport seaborn as sns","4cd240e0":"!pip install fastai2 --quiet","702a8c45":"!pip install optuna==2.9.1 -U --quiet","a0ec39c4":"from pathlib import Path\n\ninput_path = Path('..\/input\/tabular-playground-series-sep-2021\/')\nTARGET_VAR='claim'\nFOLDS=10\nX_test = pd.read_feather(f\"..\/input\/10-folds-stratified-parquet-feather\/test_stratfold.ft\")","a28455b7":"TARGET_VAR='claim'\nFOLDS=10\nX= pd.read_feather(\"..\/input\/10-folds-stratified-parquet-feather\/train_stratfold.ft\")\n","23f040b5":"from sklearn.preprocessing import StandardScaler\nfrom sklearn.preprocessing import MinMaxScaler\nnum_cols  = [c for c in X.columns if c.startswith(\"f\")] \n\nX[\"nan_count\"] = X.isnull().sum(axis=1)\nX_test[\"nan_count\"] = X_test.isnull().sum(axis=1)\nX['std'] = X[num_cols].std(axis=1)\nX_test['std'] = X_test[num_cols].std(axis=1)\n\nX['mean'] = X[num_cols].mean(axis=1)\nX_test['mean'] = X_test[num_cols].mean(axis=1)\n\nX['kurt'] = X[num_cols].kurtosis(axis=1)\nX_test['kurt'] = X_test[num_cols].kurtosis(axis=1)\n#scaler = StandardScaler()\nuseful_features = [c for c in X.columns if c not in ['id','claim' ,'index','kfold']] \ndef impute(df):\n    for name in useful_features:\n        df[name].fillna(df[name].mean(), inplace = True)\n    return df    \n\nX=impute(X)\nX_test=impute(X_test)\n\nclaim = X[TARGET_VAR]\nids=X['id']\nX = X.drop([\"index\",\"id\",TARGET_VAR,\"kfold\"],axis=1)\nscalar = MinMaxScaler()\nX[:]= scalar.fit_transform(X) \nids_test=X_test['id']\nX_test=X_test.drop([\"index\",\"id\"],axis=1)\nX_test[:]= scalar.transform(X_test)\n#X['min_row'] = X[useful_features].min(axis=1)\n#X['max_row'] = X[useful_features].max(axis=1)\n#X_test['min_row'] = X_test[useful_features].min(axis=1)\n#X_test['max_row'] = X_test[useful_features].min(axis=1)\nuseful_features = [c for c in X.columns if c not in ['id','claim' ,'index','kfold']] \n\nX[TARGET_VAR] = claim\nX['id'] = ids\nX_test['id'] = ids_test","06d94a89":"from fastai.tabular.all import *\nfrom fastai.tabular import * \n\nprocessing_funcs = [ Normalize]","14abc6e5":"#test_df = TabularPandas(testdf, cat_names=None, cont_names=num_cols, procs=processing_funcs, y_names=TARGET_VAR,\n#                                                            #splits= RandomSplitter()(range_of(X)),\n#                                                              y_block = CategoryBlock())\n\nnn_df = TabularPandas(X, cat_names=None, cont_names=useful_features, procs=processing_funcs, y_names=TARGET_VAR,\n                                                             splits= RandomSplitter()(range_of(X)),\n                                                              y_block = CategoryBlock())","286490b7":"nn_df.cont_names","fca12871":"#nn_df.show()","49ac7c6b":"train_dl = nn_df.dataloaders(4096)","25200c09":"#train_dl.show_batch()","ce36f15c":"dls =  train_dl ","03663385":"## Optuna tuning code\n# Callback for Pruning.\n# Approach from https:\/\/github.com\/crcrpar\/fastai-optuna-rossman\/blob\/master\/optimize_rossman.py\nfrom optuna.integration import FastAIPruningCallback  # v1  \n            \ndef objective(trial):\n    # Objective is `exp_rmspe`.\n    n_layers = trial.suggest_int('n_layers', 1, 3)\n    lr = trial.suggest_loguniform(\"lr\" ,3e-3,3e-2)\n    layers = []\n    ps = []\n    for i in range(n_layers):\n        # Number of units\n        n_units = trial.suggest_categorical(\n            'n_units_layer_{}'.format(i), [36,64,120,240])\n        layers.append(n_units)\n        # Dropout ratio\n        p = trial.suggest_discrete_uniform(\n            'dropout_p_layer_{}'.format(i), 0, 1, 0.05)\n        ps.append(p)\n\n    #emb_drop = trial.suggest_discrete_uniform('emb_drop', 0, 1, 0.05)\n    callback_fns = []\n    print(\"layers\",layers,\" lr \",lr)\n    callback_fns.append(\n        partial(FastAIPruningCallback, trial=trial, monitor='RocAucBinary')\n    )\n    learn = tabular_learner(nn_df.dataloaders(), layers=layers, y_range=[0,0.99999999], metrics=[RocAucBinary(),accuracy,error_rate],cbs=[FastAIPruningCallback(trial=trial, monitor=\"error_rate\")])\n\n    res = learn.fit_one_cycle(2, lr, wd=0.2)\n    print(\"AUC : \",learn.recorder.values[-1][2])\n    return learn.recorder.values[-1][2]\n\n#study = optuna.create_study(study_name='fastai-optuna-no-pruning', direction='maximize')\n#study.optimize(objective, n_trials=40)\n#best_trial = study.best_trial","f7160f3e":"params = {'n_layers': 3, 'lr': 0.005739346471274064, 'n_units_layer_0': 36, 'dropout_p_layer_0': 0.5, 'n_units_layer_1': 36, 'dropout_p_layer_1': 0.9, 'n_units_layer_2': 64, 'dropout_p_layer_2': 0.4}\ntab_learn = tabular_learner(nn_df.dataloaders(), y_range=[0,0.99999999],\n                            layers=  [36, 36, 64], \n                            metrics=[RocAucBinary(),accuracy,error_rate])#,accuracy, error_rate, Recall(), Precision()])","91ab7a3d":"tab_learn.model","14d09b4b":"# Learning rate \ntab_learn.lr_find()","403857d9":"#tab_learn.fit(5)\n#tab_learn.fit_one_cycle(8, wd=0.2)\n#tab_learn.fit_one_cycle(8,0.006918309628963471, wd=0.2)\ntab_learn.fit_one_cycle(7 ,params['lr'], wd=0.2)\n# 0.772391\n# 0.03630780577659607\n#0.772036\n# 0.798863 tab_learn.fit_one_cycle(8,  0.005754399299621582, wd=0.2)\n# 0.795943\n# 0.799196 [] default lauers [200,100]\n# 0.800649  [240,62]","48428c93":"tab_learn.recorder.plot_loss()","c656c22e":"test_dl = tab_learn.dls.test_dl(X_test)\ntest_dl.show_batch()","c4096433":"preds, test_labels = tab_learn.get_preds(dl=test_dl)","7b475577":"interpret = ClassificationInterpretation.from_learner(tab_learn)\ninterpret.plot_confusion_matrix()","fd70b8c9":"interpret.print_classification_report()","71027b3b":"final_preds = preds.numpy()[:,1]\n#final_preds = np.argmax(final_preds, axis=1)","ad5e254f":"final_preds","edb8e11e":"def make_submission(name,final_predictions):\n    \"\"\"Makes submission for testing\"\"\"\n    sample_submission = pd.read_csv(f\"{input_path}\/sample_solution.csv\")\n    try:\n        os.remove(f\"submission_{name}.csv\")\n    except (OSError, IOError) as e:    \n        #gulp\n        print(f\"Gulp {name}\")\n    sample_submission[TARGET_VAR] = final_predictions\n    sample_submission.to_csv(f\"submission_{name}.csv\", index=False)","56d190f5":"make_submission(\"fastai_tab\",final_preds) ","e2b444e9":"# FASTAI Pruning with Optuna","1bb27952":"# FAST AI ---->","e9548c4e":"# An attempt to hack and prune fasai tabular NN with optuna (For the fun of it)","c84b580c":"### Selecting number of hidden layers\nhttps:\/\/stats.stackexchange.com\/questions\/181\/how-to-choose-the-number-of-hidden-layers-and-nodes-in-a-feedforward-neural-netw","bd7ac4af":"test = TabularList.from_df(testdf,  path='.')\n\ndata = (TabularList.from_df(traindf, path='.')\n            .split_by_idx(list(range(idx, len(traindf))))\n            .label_from_df(cols=TARGET_VAR)\n            .add_test(test)\n            .databunch())","a0e1ddf2":"# Fit One Cycle\nhttps:\/\/fastai1.fast.ai\/callbacks.one_cycle.html#What-is-1cycle?","daf884fa":"# Test Set predictions"}}