{"cell_type":{"0c798d3c":"code","abb34225":"code","6cdb2e38":"code","b87ae3c7":"code","30624c86":"code","c76da40d":"code","3af351ed":"code","83b6f731":"code","eaf50c0d":"code","2c95e798":"code","de22f3d2":"code","0b1163ea":"code","83c58e6a":"code","96d73699":"code","c2088d00":"code","c9d643b5":"code","e17007a4":"code","6f12a3e0":"code","c446c3aa":"code","73d85f36":"code","66b59a33":"code","16b6d761":"code","5de30180":"code","c67c212d":"code","06a6d089":"code","4398078f":"code","79fe32eb":"code","916e1136":"code","d414cc08":"code","ecf7f54e":"code","d23f1aef":"code","678165c1":"code","b7f81311":"code","ee42c0e2":"code","f808980c":"code","580aeb20":"code","ff6e05dd":"code","a6696763":"code","060f4fa7":"code","7e04d1bd":"code","8f3617f5":"code","c432c50e":"code","9746ed66":"code","bfa0378e":"code","9475fba9":"code","725498ab":"code","125d3c3e":"code","8948412b":"code","073131fb":"code","ebeab66e":"code","b0f2fa1e":"code","fe8f5919":"code","2dc90892":"code","8240d346":"code","b6373ad2":"code","74d25009":"code","d55ec029":"code","d39ef0e4":"code","1f43f98f":"code","1f483b85":"code","690dfbb0":"code","cb3a24a0":"code","3e9ccfe2":"code","a59de55e":"code","87297053":"code","718725a6":"code","3015647a":"code","60cca979":"code","7e9e4fe8":"markdown","6ad1910a":"markdown","06958355":"markdown","64a1999d":"markdown","feac4548":"markdown","bf5839e1":"markdown","d1298a2c":"markdown","f33596e5":"markdown","73fc3a15":"markdown","c528c269":"markdown","0055a334":"markdown","95ecc2cb":"markdown","4a0094c9":"markdown","b4bf7eae":"markdown","9ed96b0a":"markdown","ad6b1840":"markdown","2f1378ad":"markdown","94f8402f":"markdown"},"source":{"0c798d3c":"import pandas as pd\nimport numpy as np\nimport math\nimport matplotlib.pyplot as plt\nimport seaborn as sns\nimport plotly.graph_objs as go\nimport plotly.express as px\nfrom sklearn.pipeline import Pipeline\nfrom sklearn.model_selection import StratifiedShuffleSplit\nfrom sklearn.base import BaseEstimator, TransformerMixin\n\n\nimport warnings\nwarnings.filterwarnings('ignore')","abb34225":"df = pd.read_csv('\/kaggle\/input\/vehicle-dataset-from-cardekho\/Car details v3.csv')\ndf.head()","6cdb2e38":"df.isnull().sum()\/len(df)*100","b87ae3c7":"df = df.dropna()\ndf = df.drop_duplicates()\n\ndf['mileage_kmpl'] = df['mileage'].apply(lambda x: float(x.split()[0]) if type(x)==str else x)\ndf['engine_CC'] = df['engine'].apply(lambda x: int(x.split()[0]) if type(x)==str else x)\n\ndf['max_power'] = df['max_power'].apply(lambda x: x.replace('bhp','') if type(x)==str else x)\ndf['max_power_bhp'] = df['max_power'].apply(lambda x: float(x))\n\ndf.drop(['mileage','max_power', 'engine'],axis=1,inplace=True)","30624c86":"df['brand'] = df['name'].apply(lambda x: x.split()[0])\ndf.drop('name',axis=1,inplace=True)","c76da40d":"def bar_plot(x):\n    fig = go.Figure([go.Bar(\n    x=df[x].value_counts().index, \n    y=df[x].value_counts().values, \n    text=df[x].value_counts().values)])\n    fig.update_traces(texttemplate='%{text:.2s}', textposition='outside')\n    fig.update_layout(title = f'Number of cars per {x}',\n                      xaxis = dict(tickmode = 'linear',dtick = 1))\n    return fig\n\ndef box_plot(x,y):\n    return px.box(df, \n                  x=x, \n                  y=y, \n                  points='all',\n                  title= x + ' & ' + y,\n                  width=800,\n                  height=500)","3af351ed":"bar_plot('brand')","83b6f731":"df['age'] = 2021 - df['year']\ndf.drop('year',axis = 1 , inplace=True)","eaf50c0d":"bar_plot('age')","2c95e798":"fig = px.violin(df, y=\"selling_price\",box=True,points='all')\nfig.show()","de22f3d2":"df = df[df['selling_price']<10000000]","0b1163ea":"fig = px.violin(df, y=\"km_driven\",box=True,points='all')\nfig.show()","83c58e6a":"df = df[df['km_driven']<1000000]","96d73699":"fig = px.violin(df, y=\"mileage_kmpl\",box=True,points='all')\nfig.show()","c2088d00":"fig = px.scatter(df, x=\"km_driven\", y=\"selling_price\", color=\"owner\")\nfig.show()","c9d643b5":"fig = px.scatter(df, x=\"km_driven\", y=\"mileage_kmpl\", color=\"owner\")\nfig.show()","e17007a4":"fig = px.scatter(df, x=\"engine_CC\", y=\"mileage_kmpl\", color=\"fuel\")\nfig.show()","6f12a3e0":"fig = px.scatter(df, x=\"engine_CC\", y=\"max_power_bhp\", color=\"fuel\")\nfig.show()","c446c3aa":"box_plot('fuel','selling_price')","73d85f36":"box_plot('seats','selling_price')","66b59a33":"box_plot('transmission','selling_price')","16b6d761":"box_plot('owner','selling_price')","5de30180":"fig = go.Figure()\nbrands =  df.brand.unique()\n\nfor brand in brands:\n    fig.add_trace(go.Violin(x=df['brand'][df['brand'] == brand],\n                            y=df['selling_price'][df['brand'] == brand],\n                            name=brand,\n                            meanline_visible=True))\n\nfig.show()","c67c212d":"brand_count = df.groupby('brand')['selling_price'].count().sort_values()\nbrands_with_one_occurance = brand_count[brand_count<2].index.tolist()","06a6d089":"df['brand'] = df['brand'].replace(brands_with_one_occurance,'Other')","4398078f":"brands_avg_price = df.groupby('brand')['selling_price'].mean().sort_values(ascending=True).reset_index()\nlabels = np.arange(29)\nbrands_avg_price['label'] = labels","79fe32eb":"data = dict(\n    avg_price=brands_avg_price.selling_price,\n    brand=brands_avg_price.brand)\nfig = px.funnel(data, x='avg_price', y='brand')\nfig.update_layout(title='Avg selling price per car brand', height = 800)\nfig.show()","916e1136":"def func(x):\n    return brands_avg_price[brands_avg_price['brand']==x].label.values[0]","d414cc08":"df['brand_encoded'] = df['brand'].apply(lambda x: func(x))","ecf7f54e":"df = df.drop('brand',axis=1)","d23f1aef":"corr = df.corr()\nplt.figure(figsize=(10,10))\nsns.heatmap(corr,annot=True,cmap=\"RdYlGn\")","678165c1":"corr.selling_price.sort_values()[:-1].plot(kind='barh')","b7f81311":"df['selling_price_M'] = df['selling_price']\/1000000","ee42c0e2":"df.describe().selling_price_M","f808980c":"df['selling_price_cat']= pd.cut(df['selling_price_M'],\n                               bins=[0., 0.42, 0.65, np.inf],\n                               labels=[1, 2, 3])","580aeb20":"df['selling_price_cat'].value_counts()","ff6e05dd":"df = df.reset_index(drop=True)\ndf = df.drop(['selling_price_M','torque'],axis=1)\ny = df['selling_price']\ndf_train = df.drop('selling_price',axis=1)","a6696763":"df_train.head()","060f4fa7":"from sklearn.model_selection import train_test_split\nX_train, X_test, y1, y2 = train_test_split(\n    df_train , pd.concat([df_train[\"owner\"], df_train[\"selling_price_cat\"]], axis=1), \n    stratify=pd.concat([df_train[\"owner\"], df_train[\"selling_price_cat\"]], axis=1),\n    test_size=0.33\n)\n\ny_train = y[X_train.index]\ny_test = y[X_test.index]","7e04d1bd":"X_train = X_train.drop('selling_price_cat',axis=1)\nX_test = X_test.drop('selling_price_cat',axis=1)","8f3617f5":"cat_col = []\nnum_col = []\nfor col in X_train.columns:\n    if X_train[col].dtype == 'O':\n        cat_col.append(col)\n    else:\n        num_col.append(col)\n        \nprint(f'Numerical cols for training: {num_col}','\\n'\n     f'Categorical cols for training: {cat_col}','\\n')","c432c50e":"class Encoder(BaseEstimator, TransformerMixin):\n    def __init__(self, cat_col, num_col):         \n        self.cat_col = cat_col\n        self.num_col = num_col\n        \n    def fit(self,X):\n        return self\n\n    def transform(self,X,y=None):\n        num_cols = X[self.num_col].copy()\n        \n        for column in self.cat_col:\n            dummies = pd.get_dummies(X[column], prefix = column)\n            X = pd.concat([X, dummies], axis=1).drop([column], axis=1)\n            \n        cat_cols = X.drop(self.num_col, axis = 1)\n        \n        X = pd.concat([cat_cols, num_cols], axis = 1)\n    \n        return X","9746ed66":"pipeline = Pipeline([\n        (\"encoder\", Encoder(cat_col,num_col))\n        ])","bfa0378e":"X_train_prep = pipeline.fit_transform(X_train)\nX_test_prep  = pipeline.fit_transform(X_test)","9475fba9":"from sklearn.ensemble import RandomForestRegressor\nfrom sklearn.model_selection import GridSearchCV\n\nparams = [\n    {'n_estimators': [30, 60, 100], \n     'max_features': [0,3, 0.5, 0.7], \n     'min_samples_leaf': [2,3,5], \n     'oob_score':[True]},\n    \n    {'bootstrap': [False], \n     'n_estimators': [30, 60, 100], \n     'max_features': [0,3, 0.5, 0.7],\n     'min_samples_leaf': [2,3,5], \n     'oob_score':[True]},\n  ]","725498ab":"%time\nrf = RandomForestRegressor(random_state=666)\n\ngrid_search = GridSearchCV(rf, params, cv=5,\n                           scoring='neg_mean_squared_error',\n                           return_train_score=True)\ngrid_search.fit(X_train_prep, y_train)","125d3c3e":"grid_search.best_estimator_","8948412b":"m = grid_search.best_estimator_","073131fb":"def rmse(predictions, actuals): \n    return math.sqrt(((predictions - actuals)**2).mean())\n\ndef print_score(m):\n    print('RMSE for training:   ', rmse(m.predict(X_train_prep), y_train))\n    print('R^2 for training:    ', m.score(X_train_prep, y_train))\n    if hasattr(m, 'oob_score_'): \n        print('OoB score:           ', m.oob_score_)\n        \ndef print_test_score(m):\n    print('RMSE for test:   ', rmse(m.predict(X_test_prep), y_test))\n    print('R^2 for test:    ', m.score(X_test_prep, y_test))","ebeab66e":"print_score(m)","b0f2fa1e":"rfr_score = rmse(m.predict(X_test_prep), y_test)\nprint_test_score(m)","fe8f5919":"feature_importance = pd.DataFrame({'Feature' : X_train_prep.columns, 'Importance' : m.feature_importances_})\nfeature_importance.sort_values('Importance', ascending=False, inplace=True)","2dc90892":"fig = go.Figure([go.Bar(\ny=feature_importance.Feature, \nx=feature_importance.Importance, \ntext=feature_importance.Importance,\norientation='h')])\nfig.update_traces(texttemplate='%{text:.2s}', textposition='outside')\nfig.update_layout(title = 'Feature importance RF Regressor')\nfig.show()","8240d346":"rfr_predictions = m.predict(X_test_prep)\n\nplt.scatter(y_test, rfr_predictions)\nplt.xlabel('y')\nplt.ylabel('Predicted')","b6373ad2":"rfr_err_rate = rfr_predictions - y_test\nrfr_err_rate.hist(bins=50)","74d25009":"import xgboost as xgb\n\n\ndtrain = xgb.DMatrix(X_train_prep, label = y_train)\ndtest = xgb.DMatrix(X_test_prep)\n\nparams = {\"max_depth\":2, \"eta\":0.1}\nmodel = xgb.cv(params, dtrain,  num_boost_round=500, early_stopping_rounds=100)","d55ec029":"%time\nm = xgb.XGBRegressor(n_estimators=300, max_depth=2, learning_rate=0.1) #the params were tuned using xgb.cv\nm.fit(X_train_prep, y_train)","d39ef0e4":"model.loc[20:,[\"test-rmse-mean\", \"train-rmse-mean\"]].plot()","1f43f98f":"feature_importance = pd.DataFrame({'Feature' : X_train_prep.columns, 'Importance' : m.feature_importances_})\nfeature_importance.sort_values('Importance', ascending=False, inplace=True)","1f483b85":"fig = go.Figure([go.Bar(\ny=feature_importance.Feature, \nx=feature_importance.Importance, \ntext=feature_importance.Importance,\norientation='h')])\nfig.update_traces(texttemplate='%{text:.2s}', textposition='outside')\nfig.update_layout(title = 'Feature importance XGB Regressor')\nfig.show()","690dfbb0":"m = xgb.XGBRegressor(n_estimators=360, max_depth=2, learning_rate=0.1) #the params were tuned using xgb.cv\nm.fit(X_train_prep, y_train)","cb3a24a0":"print_score(m)","3e9ccfe2":"xgb_score = rmse(m.predict(X_test_prep), y_test)\nprint_test_score(m)","a59de55e":"xgb_preds = m.predict(X_test_prep)\nplt.scatter(y_test,xgb_preds)\nplt.xlabel('y')\nplt.ylabel('Predicted')","87297053":"xgb_err_rate = xgb_preds - y_test\nxgb_err_rate.hist(bins=50)","718725a6":"def model_performance(model):\n    if model == 'XGB':\n        err_rate = xgb_err_rate\n    elif model == 'RF':\n        err_rate = rfr_err_rate\n    errors = abs(err_rate)\n    mape = 100 * np.mean(errors \/ y_test)\n    accuracy = 100 - mape\n    print(f'{model}')\n    print('Accuracy = {:0.2f}%.'.format(accuracy))","3015647a":"model_performance('RF')","60cca979":"model_performance('XGB')","7e9e4fe8":"**Age** and **max_power_bhp** correlate the most with selling_price","6ad1910a":"# Random Forest Regressor","06958355":"Car brands by average selling price","64a1999d":"# Preparation and training","feac4548":"Now the 'selling_price_M' can be dropped. Feature 'torque' won't be used for training.","bf5839e1":"The brand column can be removed now","d1298a2c":"Some brands are present in dataset only once. We'll classify them as **'other'**","f33596e5":"Score functions","73fc3a15":"Removing outliers","c528c269":"Volvo, BMW and Jaguar are the most expensive brands in this dataset.","0055a334":"# EDA","95ecc2cb":"# XGB Regressor","4a0094c9":"Finally, correlation plot","b4bf7eae":"# Model performance","9ed96b0a":"Let's encode the brand feature considering the mean selling_price","ad6b1840":"Removing outliers","2f1378ad":"RF hyperparameter configuration","94f8402f":"Creating a selling price category column for splitting the dataset into train and test"}}