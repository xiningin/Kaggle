{"cell_type":{"4b300737":"code","4e809e8d":"code","be7d6ed3":"code","a96a2c3a":"code","76a47365":"code","32edf610":"code","6f336897":"code","129844be":"code","b7a4ec7c":"code","01e8a363":"code","e902eb5e":"code","1fe1914d":"code","29efe0ef":"code","694549cf":"code","50f1a3cc":"code","b42acb60":"code","6b1fddb2":"code","9d6798db":"code","d508f72d":"code","3a534d1b":"code","b8e08184":"code","5fc3922e":"code","878fee28":"code","1c7179f9":"code","61041efd":"code","c9853ea2":"code","2b5d4a2c":"code","13ec5ebd":"code","b46bbc62":"code","63ebfa02":"code","43fb5559":"code","826f57a0":"code","0df34409":"code","78e25540":"code","baeda1be":"code","1caab029":"code","d163a833":"code","4f410104":"code","3aa4c738":"code","efbcfe01":"code","fb4840fe":"code","aa74eb3d":"code","a9132624":"code","fb998f9f":"code","3cdd5752":"code","c6bb10a6":"code","4a24a8dc":"code","5890e695":"code","12cb5c60":"code","698f7d02":"code","ff26e221":"code","f38faa4a":"code","310675f5":"code","0be52b8f":"code","641c2cd4":"code","9ade1b30":"code","7deec76a":"code","88f6f5c9":"code","f31f9619":"code","fa056127":"code","febc9c8b":"code","b7c82b36":"code","f971294b":"code","9f756fa7":"code","f0326874":"code","16cab923":"code","429624e4":"code","3fe0ff78":"code","07f6f160":"code","768fc97a":"code","ad914210":"code","814b1b57":"code","6c37fd38":"code","d4f0438b":"code","ba00bb68":"code","607f2c8f":"code","4230898b":"markdown","d14debe2":"markdown","8b8d8b07":"markdown","03055a1f":"markdown","9d562330":"markdown","2600cf5e":"markdown","c6329168":"markdown","3000ca30":"markdown","99e25cbc":"markdown","93148093":"markdown","00a8c701":"markdown","36aa15bf":"markdown","1588c43f":"markdown","d5d3a0a5":"markdown","a67fcdcb":"markdown","13a2701d":"markdown","2d13ba22":"markdown","05815e28":"markdown","3d6e7d8a":"markdown","1297afa8":"markdown","02823b72":"markdown","dc62700f":"markdown","b3015035":"markdown","2fe1e01b":"markdown","cb123af8":"markdown","e456cef2":"markdown","30f7a53b":"markdown"},"source":{"4b300737":"import warnings\nwarnings.filterwarnings('ignore')","4e809e8d":"from google.cloud import bigquery\n\n# Create a \"Client\" object\nclient = bigquery.Client()\n\n# Construct a reference to the \"chicago_taxi_trips\" dataset\ndataset_ref = client.dataset(\"chicago_taxi_trips\", project=\"bigquery-public-data\")\n\n# API request - fetch the dataset\ndataset = client.get_dataset(dataset_ref)\n\n# Construct a reference to the \"taxi_trips\" table\ntable_ref = dataset_ref.table(\"taxi_trips\")\n\n# API request - fetch the table\ntable = client.get_table(table_ref)\n\n# Preview the first five lines of the table\nclient.list_rows(table, max_results=5).to_dataframe()","be7d6ed3":"import bq_helper\nfrom bq_helper import BigQueryHelper","a96a2c3a":"bq_assistant = BigQueryHelper(\"bigquery-public-data\", \"chicago_taxi_trips\")","76a47365":"bq_assistant.table_schema(\"taxi_trips\")","32edf610":"def show_amount_of_data_scanned(query):\n    # dry_run lets us see how much data the query uses without running it\n    dry_run_config = bigquery.QueryJobConfig(dry_run=True)\n    query_job = client.query(query, job_config=dry_run_config)\n    print('Data processed: {} GB'.format(round(query_job.total_bytes_processed \/ 10**9, 3)))","6f336897":"query1 = \"\"\"SELECT\n  MAX(fare) AS maximum_fare,\n  MIN(fare) AS minimum_fare,\n  FORMAT('%3.2f', AVG(fare)) AS avg_fare\nFROM\n  `bigquery-public-data.chicago_taxi_trips.taxi_trips`\nWHERE\n  trip_seconds >= 600 AND EXTRACT(YEAR FROM trip_end_timestamp) = 2021\n        \"\"\"\n\nshow_amount_of_data_scanned(query1)","129844be":"query1 = \"\"\"SELECT\n  MAX(fare) AS maximum_fare,\n  MIN(fare) AS minimum_fare,\n  FORMAT('%3.2f', AVG(fare)) AS avg_fare\nFROM\n  `bigquery-public-data.chicago_taxi_trips.taxi_trips`\nWHERE\n  trip_seconds >= 600 AND EXTRACT(YEAR FROM trip_end_timestamp) = 2021\n        \"\"\"\n\nfare = client.query(query1).result().to_dataframe()\nfare","b7a4ec7c":"query2 = \"\"\"SELECT\n            dropoff_community_area,\n  FORMAT('%3.2f', AVG(tips)) AS average_tip,\n  FORMAT('%3.2f', MAX(tips)) AS max_tip\nFROM\n  `bigquery-public-data.chicago_taxi_trips.taxi_trips`\nWHERE dropoff_community_area IS NOT NULL AND EXTRACT(YEAR FROM trip_end_timestamp) = 2021\nGROUP BY\n  dropoff_community_area\nORDER BY\n  average_tip DESC\n        \"\"\"\n\nshow_amount_of_data_scanned(query2)","01e8a363":"query2 = \"\"\"SELECT\n            dropoff_community_area,\n  FORMAT('%3.2f', AVG(tips)) AS average_tip,\n  FORMAT('%3.2f', MAX(tips)) AS max_tip\nFROM\n  `bigquery-public-data.chicago_taxi_trips.taxi_trips`\nWHERE dropoff_community_area IS NOT NULL AND EXTRACT(YEAR FROM trip_end_timestamp) = 2021\nGROUP BY\n  dropoff_community_area\nORDER BY\n  average_tip DESC\n        \"\"\"\n\ntip = client.query(query2).result().to_dataframe()\ntip","e902eb5e":"import pandas as pd\n\nareas_names = pd.read_csv(\"..\/input\/chicagocsv\/chicago_area.csv\", sep=';')\n\nareas_names.columns","1fe1914d":"tip_merged = pd.merge(tip, areas_names, on='dropoff_community_area')","29efe0ef":"columnsTitles = ['dropoff_community_area', 'community_name', 'average_tip', 'max_tip']\n\ntip_merged = tip_merged.reindex(columns=columnsTitles)\n\ntip_merged","694549cf":"pd.plotting.register_matplotlib_converters()\nimport matplotlib.pyplot as plt\n%matplotlib inline\nimport seaborn as sns","50f1a3cc":"plt.figure(figsize=(10,12))\nsns.scatterplot(x=tip['dropoff_community_area'], y=tip['average_tip'])","b42acb60":"full_query1 = \"\"\"SELECT\n            dropoff_community_area, trip_end_timestamp, fare, tips \nFROM\n  `bigquery-public-data.chicago_taxi_trips.taxi_trips`\nWHERE\n  trip_seconds >= 600 AND EXTRACT(YEAR FROM trip_end_timestamp) = 2021\n        \"\"\"\n\nshow_amount_of_data_scanned(full_query1)","6b1fddb2":"full_query1 = \"\"\"SELECT\n            dropoff_community_area, trip_end_timestamp, fare, tips \nFROM\n  `bigquery-public-data.chicago_taxi_trips.taxi_trips`\nWHERE\n  trip_seconds >= 600 AND EXTRACT(YEAR FROM trip_end_timestamp) = 2021\n        \"\"\"\n\nfull = client.query(full_query1).result().to_dataframe()\nfull.head()","9d6798db":"len(full)","d508f72d":"full.describe()","3a534d1b":"missing_values_count = full.isnull().sum()\nmissing_values_count","b8e08184":"full = full.dropna(subset=['fare', 'tips'])","5fc3922e":"missing_values_count = full.isnull().sum()\nmissing_values_count","878fee28":"full","1c7179f9":"full.fare.mean()","61041efd":"full.tips.mean()","c9853ea2":"mean_tips = full.groupby(\"dropoff_community_area\").tips.mean()\nmean_tips","2b5d4a2c":"mean_tips = mean_tips.to_frame()\nmean_tips","13ec5ebd":"mean_tips = mean_tips.rename(columns={\"tips\": \"avg_tips\"})\n\nmean_tips","b46bbc62":"mean_tips.reset_index(level=0, inplace=True)","63ebfa02":"mean_tips.sort_values(by='avg_tips', ascending=False)","43fb5559":"mean_tips = mean_tips.astype({'dropoff_community_area': 'int32'})\nmean_tips = mean_tips.round({'avg_tips': 2})","826f57a0":"mean_tips.sort_values(by='avg_tips', ascending=False)","0df34409":"mean_tips_join = pd.merge(mean_tips, areas_names, on='dropoff_community_area')","78e25540":"columnsTitles = ['dropoff_community_area', 'community_name', 'avg_tips']\n\nmean_tips_join = mean_tips_join.reindex(columns=columnsTitles)","baeda1be":"mean_tips_join.sort_values(by='avg_tips', ascending=False)","1caab029":"mean_tips_join.plot.bar(x='community_name', y='avg_tips', rot=90)\n\nplt.gcf().set_size_inches(20, 10)\n\nplt.title(\"Average Taxi Tips in Chicago, by Community Areas\")\nplt.ylabel(\"Average tips (in dollars)\")\nplt.xlabel(\"Chicago Community Areas\")\n","d163a833":"areas_population = pd.read_csv(\"..\/input\/chicago-community-areas-demographics\/chicago_population.CSV\", sep=';')\n\nareas_population","4f410104":"population = areas_population.transpose()\n\npopulation","3aa4c738":"population.dtypes","efbcfe01":"population = population.rename(columns=population.iloc[0])","fb4840fe":"population = population.iloc[1:]","aa74eb3d":"population","a9132624":"population.index.name = 'dropoff_community_area'\n\npopulation","fb998f9f":"population.reset_index(level=0, inplace=True)\n\npopulation","3cdd5752":"population = population.astype({\"dropoff_community_area\": int, \"population\": int, \"income\": float, \"latinos\": float, \"blacks\": float, \"white\": float, \"asian\": float, \"other\": float,})","c6bb10a6":"sns.regplot(x=population['income'], y=population['white'])","4a24a8dc":"round(population['income'].corr(population['white']), 2)","5890e695":"round(population['income'].corr(population['blacks']), 2)","12cb5c60":"round(population['income'].corr(population['latinos']), 2)","698f7d02":"round(population['income'].corr(population['asian']), 2)","ff26e221":"population_join = pd.merge(mean_tips_join, population, on='dropoff_community_area')","f38faa4a":"population_join","310675f5":"population_join.drop('name', axis=1, inplace=True)","0be52b8f":"population_join","641c2cd4":"print(\"Correlation between income and average taxi tips in community areas of Chicago: {}\".format(round(population_join['income'].corr(population_join['avg_tips']), 2)))","9ade1b30":"print(\"Correlation between percentage of white population and average taxi tips in community areas of Chicago: {}\".format(round(population_join['white'].corr(population_join['avg_tips']), 2)))","7deec76a":"print(\"Correlation between percentage of black population and average taxi tips in community areas of Chicago: {}\".format(round(population_join['blacks'].corr(population_join['avg_tips']), 2)))","88f6f5c9":"print(\"Correlation between percentage of Latino population and average taxi tips in community areas of Chicago: {}\".format(round(population_join['latinos'].corr(population_join['avg_tips']), 2)))","f31f9619":"print(\"Correlation between percentage of Asian population and average taxi tips in community areas of Chicago: {}\".format(round(population_join['asian'].corr(population_join['avg_tips']), 2)))","fa056127":"sns.regplot(x=population_join['white'], y=population_join['avg_tips'])","febc9c8b":"# Construct a reference to the \"chicago_crime\" dataset\ndataset_ref2 = client.dataset(\"chicago_crime\", project=\"bigquery-public-data\")\n\n# API request - fetch the dataset\ndataset2 = client.get_dataset(dataset_ref2)\n\n# Construct a reference to the \"crime\" table\ntable_ref2 = dataset_ref.table(\"crime\")","b7c82b36":"community_query = \"\"\"SELECT\n  community_area,\n  COUNT(*) AS arrests\nFROM `bigquery-public-data.chicago_crime.crime`\n  WHERE arrest = TRUE\n    AND year = 2021\n  GROUP BY\n    community_area\nORDER BY\n  arrests DESC\n        \"\"\"\n\ncommunity = client.query(community_query).result().to_dataframe()\n\ncommunity.head()","f971294b":"community.rename(columns={'community_area': 'dropoff_community_area'}, inplace=True)","9f756fa7":"community.head()","f0326874":"community_join = pd.merge(community, population_join, on='dropoff_community_area')\n\ncommunity_join","16cab923":"community_join = community_join[['dropoff_community_area', 'community_name','arrests','avg_tips','population', 'income', 'latinos', 'blacks', 'white', 'asian', 'other']]\n\ncommunity_join","429624e4":"round(community_join['arrests'].corr(community_join['population']), 2)","3fe0ff78":"round(community_join['arrests'].corr(community_join['income']), 2)","07f6f160":"round(community_join['arrests'].corr(community_join['white']), 2)","768fc97a":"round(community_join['arrests'].corr(community_join['blacks']), 2)","ad914210":"round(community_join['arrests'].corr(community_join['avg_tips']), 2)","814b1b57":"community_join['arrests_pct'] = community_join['arrests']\/community_join['population']*100\n\ncommunity_join","6c37fd38":"round(community_join['arrests_pct'].corr(community_join['avg_tips']), 2)","d4f0438b":"round(community_join['arrests_pct'].corr(community_join['income']), 2)","ba00bb68":"round(community_join['arrests_pct'].corr(community_join['white']), 2)","607f2c8f":"round(community_join['arrests_pct'].corr(community_join['blacks']), 2)","4230898b":"I join two tables and adjust the order of columns.\n\n*Ich mache ein Join von zwei Tabellen und ordne die Spalten neu.*","d14debe2":"Change the **format of values** to make them **easier to read**.\n\n*Ver\u00e4ndere die **Formatierung** der Werte, damit sie **lesbarer** sind.*","8b8d8b07":"# Part 2 \/ Teil 2","03055a1f":"**Merge** two datasets to get **community area names**.\n\n*Zusammenf\u00fcge **2 Datasets**, um die Bezirksnamen zu sehen.*","9d562330":"We see that surprisingly average taxi trips correlate a bit more with population groups in the community area (0.85 in case of whites) than with the income (0.72). The correlation between taxi tips and population groups is even 1% higher than the correlation between income and population groups (0.84).\n\n*Wir sehen \u00fcberraschend, dass Trinkgelder mehr mit Einwohnergruppen als mit dem Einkommen korrelieren.*","2600cf5e":"Create a DataFrame and delete all NaN values in columns \"fare\" and \"tips\".\n\n*Ein DataFrame erstellen und **Zeilen mit NaN-Werten in Spalten \"fare\" und \"tips\" entfernen**.*","c6329168":"# Part 1 \/ Teil 1","3000ca30":"Make a **new column**, a **new index** and sort values **descending**.\n\n*Mache eine **neue Spalte**, ein **neues Index** und **sortiere** die Werte **absteigend**.*","99e25cbc":"The biggest correlation is between the number of arrests and the number of citizens in communities.\n\n*Die gr\u00f6\u00dfte Korrelation ist zwischen die Zahl der Festnahmen und die Zahl der Bewohner.*","93148093":"I create **a new DataFrame** to answer the question about drop-off areas with the highest average tip.\n\n*Ich erstelle **ein neues DataFrame**, um die Frage \u00fcber die Durchnittswerte von Trinkgelder in Bezirken zu beantworten.*","00a8c701":"Now we can **calculate** fares for rides lasting 10 minutes or more **again**.\n\n*Jetzt k\u00f6nnen wir Durchschnittskosten per Fahrt l\u00e4nger als 10 Minuten **neu berechnen**.*","36aa15bf":"**2) Which drop-off areas have the highest average tip in 2021?**\n\n***2) In welchen Zielstadtteilen wird das h\u00f6chste Trinkgeld bezahlt?***","1588c43f":"![](https:\/\/images.unsplash.com\/photo-1521180104672-66e895511a57?ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&ixlib=rb-1.2.1&auto=format&fit=crop&w=1189&q=80)","d5d3a0a5":"# Part 3 \/ Teil 3\n\nIn Part 3 we'll see if there is any correlation between income, population groups and average taxi trips. For this purpose we'll use a dataset on basic demographics in Chicago community areas. Sadly it was last updated 2013 and we cannot rely on it too much, but still it can give us a general picture. \n\n*Im Teil 3 werden wir sehen, ob es eine Korrelation zwichen Trinkgelder, Einkommen und Einwohnergruppen gibt. Daf\u00fcr werden wir eine Tabelle \u00fcber demographische Struktur von Chicagos Stadtbezirken benutzen. Leider ist die Tabelle alt und wurde 2013 erstellt. Es bedeutet, wir k\u00f6nnen sie nicht zu viel vertrauen, aber wir k\u00f6nnen schon mit ihrer Hilfe nach Korrelationen suchen.*","a67fcdcb":"# Part 4 \/ Teil 4\n\nIn this part I'll use Chicago Crime dataset to check is there is any negative correlation between the number of arrests and the level of average tips.\n\n*In diesem Teil werde ich Chicago Crime Datenbank benutzen um zu sehen, ob es eine negative Korrelation zwischen die Zahl der Festnahmen und die H\u00f6he der Trinkgelder gibt.*","13a2701d":"If we calculate the percentage of arrests per community citizens, we'll see that other correlations get more obvious.\n\n*Wenn wir aber den Prozentwert der Festnahmen pro Einwohner berechnen, sehen wir, dass andere Korrelationen deutlicher werden.*","2d13ba22":"We can see the average tips in the **scatterplot**.\n\n*Man kann im **Scatterplot** die Durchschnittswerte von Trinkgelder sehen.*","05815e28":"In this notebook we'll see in which community areas of **Chicago** taxi drivers get **the highest tip**. But let's start by importing necessary tools from **biquery** and **bq_helper** and looking at the description of columns, I'll comment my work in both English and German.\n\n*In diesem Notebook werden wir sehen, in welchen Stadtbezirke von **Chicago** Taxifahrer die h\u00f6chsten **Trinkgelder** kriegen. Aber wir starten mit dem Importieren von Werkzeuge aus **bigquery** und **bq_helper**. Unterwegs mache ich Kommentare auf Deutsch und Englisch*","3d6e7d8a":"Next I read my **csv-file** with **community area names** and **merge** it with the existing dataset.\n\n*Als N\u00e4chstes lese ich meine **CSV-Datei** *mit **Bezirksnamen** und **f\u00fcge** sie meinem DataFrame hinzu.*","1297afa8":"**1) What are the maximum, minimum and average fares for rides lasting 10 minutes or more?** I take data only for the year 2021!\n\n***1) Max. - Min. - und Durchschnittskosten per Fahrt l\u00e4nger als 10 Minuten.*** *Ich benutze nur Daten f\u00fcr das Jahr 2021.*","02823b72":"Create a **bar plot** with **Chicago community area names**.\n\n*Wir k\u00f6nnen jetzt eine **Grafik mit Namen** unserer Bezirke erstellen.*","dc62700f":"We transform the table to make it fit for the join with our existing table.\n\n*Wir transformieren die Tabelle, damit wir sie dann mit unserer Trinkgelder-Tabelle zusammenf\u00fcgen k\u00f6nnen.*","b3015035":"**Resume**: We have seen that the average fare was correctly calculated with an SQL query in the first part of this notebook, because the number of NaN values was small and they didn't influence the result. But **average tips for community areas** have changed as we deleted rows with NaN values. Now **our results are more precise** and it means that our work with Pandas dataframe was not in vain.\n\n*Fazit: Wir haben gesehen, dass die Durcschnittskosten per Fahrt wurden schon per SQL-Abfrage im ersten Teil richtig berechnet, weil die Zahl der NaN-Werten gering war und sie haben keinen Einfluss auf das Endergebnis. Aber **die Durchschnittswerte von Trinkgelder f\u00fcr die einzelnen Zielstadtteilen** haben doch ein bischen **ge\u00e4ndert**, als wir die Zeilen mit NaN-Werten in der \"tips\"-Spalte gel\u00f6scht haben. **Jetzt haben wir die genaueren Ergebnisse** und die M\u00fche hat sich doch gelohnt.*","2fe1e01b":"Check if there is a correlation between income and population groups.\n\n*\u00dcberpr\u00fcfe, ob es eine Korrelation zwischen Einkommen und Einwohnergruppen gibt.*","cb123af8":"We can read about [Community areas in Chicago](https:\/\/en.wikipedia.org\/wiki\/Community_areas_in_Chicago) in Wikipedia. In the community area number 76 (O'Hare) there is an **airport**, that's why tips are higher here. In general the average tips mirror the **socioeconomic situation** in these communities.\n\n*Man kann hier \u00fcber [Community areas in Chicago](https:\/\/en.wikipedia.org\/wiki\/Community_areas_in_Chicago) lesen. Im Community Nummer 76 (O'Hare) gibt es einen **Flughafen**, deswegen kriegen hier die Taxifahrer das h\u00f6chste Trinkgeld. Sonst spiegeln die Trinkgeldwerte die wirtschaftliche und **soziale Situation** der Bezirke wider. *","e456cef2":"I have 2 questions for this dataset:\n1) What are the maximum, minimum and average fares for rides lasting 10 minutes or more?\n\n2) Which drop-off areas have the highest average tip?\n\nI can answer these questions directly with **SQL queries** and I do it based on queries by Paul Mooney (https:\/\/www.kaggle.com\/paultimothymooney\/how-to-query-the-chicago-taxi-dataset) in **Part 1** of this notebook.\n\n**In Part 2** I create a relatively big DataFrame and answer these questions with **Pandas functions**.\n\n*F\u00fcr diese Datenbank habe ich 2 Fragen:*\n\n*1) Max. - Min. - und Durchschnittskosten per Fahrt l\u00e4nger als 10 Minuten.*\n\n*2) In welchen Zielstadtteilen wird das h\u00f6chste Durchschnittstrinkgeld bezahlt?*\n\n*Ich kann diese Fragen direkt per **SQL-Abfragen** beantworten und das mache ich basierend auf Beispiele von Paul Mooney (https:\/\/www.kaggle.com\/paultimothymooney\/how-to-query-the-chicago-taxi-dataset) im **ersten Teil** dieser Arbeit.*\n\n*Im **zweiten Teil** erstelle ich ein relativ gro\u00dfes DataFrame und beantworte diese Fragen mit **Pandas Funktionen**.*","30f7a53b":"Make dtypes usable for the plot.\n\n*Mache dtypes verwendbar f\u00fcr die Grafik.*"}}