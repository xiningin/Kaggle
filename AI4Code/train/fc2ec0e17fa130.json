{"cell_type":{"5c83fb02":"code","3c37ca50":"code","0634d766":"code","cfcad25d":"code","9ad6b43f":"code","7eba502d":"code","ad26064d":"code","864cf7bb":"code","d37beb69":"code","8d86e5e6":"code","28465a1e":"code","4306c999":"code","23ea2e3c":"code","8f4155a4":"code","4de87b45":"code","42fe16cd":"code","d013fc35":"code","e83f7a75":"code","0f042064":"markdown","13413796":"markdown","097be3f7":"markdown","95a55a80":"markdown","8387518c":"markdown","2f640f9e":"markdown","0c8931f6":"markdown","ba5544fa":"markdown","17c19c35":"markdown"},"source":{"5c83fb02":"import os\nimport random\n\nimport numpy as np # linear algebra\nimport pandas as pd # data processing, CSV file I\/O (e.g. pd.read_csv)\nimport lightgbm as lgb\nimport tensorflow as tf\nfrom tensorflow import keras\nfrom tensorflow.keras import Sequential,Model\nfrom tensorflow.keras.preprocessing.image import load_img, ImageDataGenerator\nfrom tensorflow.keras.utils import Sequence\nfrom tensorflow.keras.layers import Dense,Conv2D,Flatten,Dropout, Input, Concatenate, BatchNormalization\nfrom tensorflow.keras.callbacks import EarlyStopping,ReduceLROnPlateau\nfrom tensorflow.keras.optimizers.schedules import ExponentialDecay\nfrom PIL import Image\nfrom sklearn.model_selection import train_test_split, KFold\nimport matplotlib.pyplot as plt\nfrom sklearn.metrics import mean_squared_error\nfrom tqdm.notebook import tqdm\nfrom catboost import CatBoostRegressor","3c37ca50":"def seed_everything():\n    np.random.seed(123)\n    random.seed(123)\n    tf.random.set_seed(123)\n    os.environ[\"TF_CPP_MIN_LOG_LEVEL\"] = '2'\n    os.environ['PYTHONHASHSEED'] = str(123)\n\nseed_everything()","0634d766":"# dataset\n\ntrain_dir = \"\/kaggle\/input\/petfinder-pawpularity-score\/train\/\"\ntest_dir = \"\/kaggle\/input\/petfinder-pawpularity-score\/test\/\"\n\ntrain_table = pd.read_csv(\"\/kaggle\/input\/petfinder-pawpularity-score\/train.csv\")\ntrain_table[\"Id\"] = train_dir + train_table[\"Id\"] + \".jpg\"\n\ntest_table = pd.read_csv(\"\/kaggle\/input\/petfinder-pawpularity-score\/test.csv\")\ntest_table[\"Id\"] = test_dir + test_table[\"Id\"] + \".jpg\"\n\nsample = pd.read_csv(\"\/kaggle\/input\/petfinder-pawpularity-score\/sample_submission.csv\")\ntrain_table","cfcad25d":"test_table[\"Id\"][0]","9ad6b43f":"class MY_GENERATOR(keras.utils.Sequence):\n    def __init__(self, img_pathes, y, batch_size=1, size=(224,224),augmentation=True):\n        self.img_pathes = img_pathes\n        self.y = np.array(y)\n        self.batch_size = batch_size\n        self.size=size\n        self.augmentation = augmentation\n        self.datagen = \"\"\n        self.data_generator()\n        \n    def __len__(self):\n        #return int(len(self.img_pathes) \/ self.batch_size)+1\n        return int(len(self.img_pathes) \/ self.batch_size)\n    def __getitem__(self, idx):\n        b = self.batch_size\n        X_batch = self.img_pathes[idx*b : (1+idx)*b]\n        X_batch = self.load_imgs(X_batch)\n        y_batch = self.y[idx*b : (1+idx)*b]\n        return X_batch, y_batch\n    \n    def on_epoch_end(self):\n        \"\"\"\u30a8\u30dd\u30c3\u30af\u7d42\u4e86\u6642\u306b\u5b9f\u884c\u3002X\u3068Y\u3092\u30b7\u30e3\u30c3\u30d5\u30eb\u3059\u308b\"\"\"\n        ids = np.random.choice(np.arange(len(self.img_pathes)),size=(len(self.img_pathes)), replace=False)\n        self.img_pathes = list([self.img_pathes[i] for i in ids])\n        self.y = np.array(list([self.y[i] for i in ids]))\n    \n    def load_imgs(self, pathes):\n        imgs = []\n        for path in pathes:\n            img = np.array(load_img(path, target_size=self.size))\n            img = self.preprocessing(img)\n            imgs.append(img)\n        return np.array(imgs).astype(np.float32)\n    \n    def preprocessing(self, img):\n        if self.augmentation:\n            img = np.expand_dims(img,0)\n            img = next(self.datagen.flow(img))\n            return img[0]\n        else:\n            return img\n    \n    def data_generator(self):\n        datagen = ImageDataGenerator(\n               #rescale=1.\/255,\n               rotation_range=10,#\u89d2\u5ea6\u3092\u3064\u3051\u308b(\u80cc\u666f\u306b\u6ce8\u610f)~50\u3050\u3089\u3044\u304b\uff1f\n               width_shift_range=10,#\u6a2a\u306b\u30b9\u30e9\u30a4\u30b9\u3053\u308c\u308250\u3050\u3089\u3044\u304b\uff1f\n               height_shift_range=10,#\u7e26\u306b\u30b9\u30e9\u30a4\u30b9\u3053\u308c\u308250\u3050\u3089\u3044\u304b\uff1f\n               shear_range=5,#\u659c\u3081\u306b\u3073\u3088\u30fc\u309330\u3050\u3089\u3044\u304b\u306a\n               zoom_range=0,#\u7279\u6b8a\u3060\u3051\u3069\u3053\u308c\u3050\u3089\u3044\u306e\u307b\u3046\u304c\u3044\u3044\u304b\u3082[1,2]\n               horizontal_flip=True,#\u5de6\u53f3\n               vertical_flip=False, \n               preprocessing_function=tf.keras.applications.mobilenet_v2.preprocess_input\n               )#\u4e0a\u4e0b \u3053\u308c\u306f\u5fae\u5999\u304b\u3082\n        self.datagen = datagen","7eba502d":"train_gen = MY_GENERATOR(train_table[\"Id\"].values, train_table[\"Pawpularity\"].values)\n\nimg = load_img(train_table[\"Id\"].values[100], target_size=(224,224))\nmobilenet_v2_preprocessed_img = tf.keras.applications.mobilenet_v2.preprocess_input(np.array(img))\nplt.figure(figsize=(12,5))\nplt.subplot(1,2,1)\nplt.imshow(img)\nplt.axis(\"off\")\nplt.title(\"original image\")\nplt.subplot(1,2,2)\nplt.imshow(mobilenet_v2_preprocessed_img)\nplt.axis(\"off\")\nplt.title(\"mobilenet_v2.preprocess_input\")\nplt.show()\n\nprint(\"-----ImageDataGenerator-----\")\nimgs = []\nfor i in range(10):\n    tmp = train_gen.preprocessing(img)\n    imgs.append(tmp)\n    \nplt.figure(figsize=(20,6))    \nfor i in range(10):\n    plt.subplot(1,10,i+1)\n    plt.imshow(imgs[i])\n    plt.axis(\"off\")\nplt.show()","ad26064d":"def MobileNet_model():\n    base_model = keras.applications.mobilenet_v2.MobileNetV2(weights=\"imagenet\")\n    base_model.trainable = False\n    avg_pool_name = [l.name for l in base_model.layers][-2]\n    x = base_model.get_layer(avg_pool_name).output\n    x = Dropout(0.2)(x)\n    x = Dense(128, activation=\"relu\")(x)\n    x = Dense(1)(x)\n    model = Model(inputs=base_model.input, outputs=x)\n    model.compile(optimizer=keras.optimizers.Adam(learning_rate=1e-5), loss=\"mean_squared_error\", metrics=[keras.metrics.RootMeanSquaredError()])\n    return model\n\ndef MobileNet_model_no_internet_ver():\n    base_model = keras.models.load_model(\"..\/input\/mobilenetv2-imagenet\/MobileNetV2_imagenet.h5\")\n    base_model.trainable = False\n    avg_pool_name = [l.name for l in base_model.layers][-2]\n    x = base_model.get_layer(avg_pool_name).output\n    x = Dropout(0.2)(x)\n    x = Dense(128, activation=\"relu\")(x)\n    x = Dense(1)(x)\n    model = Model(inputs=base_model.input, outputs=x)\n    model.compile(optimizer=keras.optimizers.Adam(learning_rate=1e-5), loss=\"mean_squared_error\", metrics=[keras.metrics.RootMeanSquaredError()])\n    return model\n\n#model = MobileNet_model()\n#model = MobileNet_model_no_internet_ver()\n#model.summary()","864cf7bb":"def Lunch_Kflod_training(imgs_path, y, model):\n    kfold = KFold(n_splits=5, shuffle=True, random_state=2021)\n    save_model_names = []\n    \n    for i, (train_id, vali_id) in enumerate(kfold.split(imgs_path, y)):\n        #make kfold datasets\n        train_path, y_train = imgs_path[train_id], y[train_id]\n        vali_path, y_vali = imgs_path[vali_id], y[vali_id]\n        #set model\n        model = MobileNet_model_no_internet_ver()\n        early_stopping = EarlyStopping(patience=2, monitor=\"val_root_mean_squared_error\", restore_best_weights=True)\n        model_checkpoint = tf.keras.callbacks.ModelCheckpoint(filepath=f'MV2_checkpoint_fold{i+1}.h5', \n                                           monitor='val_root_mean_squared_error', \n                                           mode = 'min',  save_best_only = True)\n        #set generator\n        train_gen = MY_GENERATOR(train_path, y_train, batch_size=16, augmentation=True)\n        vali_gen = MY_GENERATOR(vali_path, y_vali, batch_size=16, augmentation=True)\n        \n        #training\n        hist = model.fit(train_gen, epochs=20, \n                         validation_data=vali_gen, \n                         callbacks=[early_stopping, model_checkpoint])\n        \n        #evaluate\n        train_eval = model.evaluate(MY_GENERATOR(train_path, y_train, batch_size=16, augmentation=False))\n        vali_eval = model.evaluate(MY_GENERATOR(vali_path, y_vali, batch_size=16, augmentation=False))\n        \n        #plot_history\n        plt.plot(hist.history[\"root_mean_squared_error\"], label=\"root_mean_squared_error\")\n        plt.plot(hist.history[\"val_root_mean_squared_error\"], label=\"val_root_mean_squared_error\", linestyle=\"--\")\n        plt.title(f\"Kfold_{i+1}\\ntrain_RMSE:{train_eval[1]:.3f}\\nvali_RMSE:{vali_eval[1]:.3f}\")\n        plt.legend()\n        plt.show()\n        \n        save_model_names.append(f'MV2_checkpoint_fold{i+1}.h5')\n        \n    return save_model_names","d37beb69":"#save_ft_model_names = Lunch_Kflod_training(train_table[\"Id\"].values, train_table[\"Pawpularity\"].values, model)","8d86e5e6":"def catboost_model():\n    cb_params = {'loss_function' : 'RMSE',\n                 'eval_metric' : 'RMSE',\n                 'iterations' : 777,\n                 'grow_policy' : 'SymmetricTree',\n                 'depth' : 6,#6\n                 'l2_leaf_reg' : 2.0,\n                 'random_strength' : 1.0,\n                 'learning_rate' : 0.05,\n                 'task_type' : 'CPU',\n                 'devices' : '0',\n                 'verbose' : 0,\n                 'random_state': 2021}\n    cb_model = CatBoostRegressor(**cb_params)\n    return cb_model\n\ndef img_yield(pathes, batch_size=8, size=(224,224)):\n    for i in range(len(pathes) \/\/ batch_size):\n        imgs = []\n        batch_pathes = pathes[i*batch_size : (1+i)*batch_size]\n        for path in batch_pathes:\n            img = load_img(path, target_size=size)\n            img = tf.keras.applications.mobilenet_v2.preprocess_input(np.array(img))\n            imgs.append(img)\n        yield np.array(imgs)\n        \ndef RMSE(y_true, y_pred):\n    return np.sqrt(mean_squared_error(y_true, y_pred))\n\ndef Lunch_kflod_catboost(imgs_path, table, y, model_names):\n    kfold = KFold(n_splits=5, shuffle=True, random_state=2021)\n    catmodel_names = []\n    for i, (train_id, vali_id) in enumerate(kfold.split(imgs_path, y)):\n        print(f\"-----fold:{i+1}-----\")\n        #make kfold datasets\n        train_path, train_table, y_train = imgs_path[train_id], table[train_id,:], y[train_id]\n        vali_path, vali_table, y_vali = imgs_path[vali_id], table[vali_id,:], y[vali_id]\n        #get_feature\n        model = keras.models.load_model(model_names[i])\n        ft_model = Model(model.input, model.get_layer([l.name for l in model.layers][-2]).output)\n        train_feature_pred = ft_model.predict(img_yield(train_path))\n        vali_feature_pred = ft_model.predict(img_yield(vali_path))\n        #concat feature and table data\n        X_train = np.hstack([train_feature_pred, train_table])\n        X_vali = np.hstack([vali_feature_pred, vali_table])\n        #catboost training\n        cb_model = catboost_model()\n        cb_model.fit(X_train, y_train)\n        #RMSE score\n        print(\"---train_RMSE_score---\")\n        print(RMSE(y_train, cb_model.predict(X_train)))\n        print(\"---validation_RMSE_score---\")\n        print(RMSE(y_vali, cb_model.predict(X_vali)))\n        \n        #catboost model save\n        cb_model.save_model(f\"cb_model_fold{i+1}.cat\")\n        catmodel_names.append(f\"cb_model_fold{i+1}.cat\")\n    return catmodel_names","28465a1e":"#save_catmodel_names = Lunch_kflod_catboost(train_table[\"Id\"].values, \n#                                           train_table.drop([\"Id\",\"Pawpularity\"],axis=1).values, \n#                                           train_table[\"Pawpularity\"].values, \n#                                           save_ft_model_names)","4306c999":"def test_input_image(pathes):\n    imgs = np.array([np.array(load_img(x, target_size=(224,224))) for x in tqdm(pathes)])\n    imgs = np.array([keras.applications.mobilenet_v2.preprocess_input(x) for x in imgs])\n    return imgs\n\ndef test_kfold(save_ft_model_names, save_catmodel_names):\n    kfold_predict = []\n    imgs = test_input_image(test_table[\"Id\"])\n    for model_name, cat_model_name in zip(save_ft_model_names, save_catmodel_names):\n        model = keras.models.load_model(model_name)\n        ft_model = Model(model.input, model.get_layer([l.name for l in model.layers][-2]).output)\n        cb_model = CatBoostRegressor()\n        cb_model.load_model(cat_model_name)\n        test_feature_pred = ft_model.predict(imgs)\n        X_test = np.hstack([test_feature_pred, test_table.drop(\"Id\",axis=1).values])\n        pred = cb_model.predict(X_test)\n        kfold_predict.append(pred)\n    return kfold_predict","23ea2e3c":"#kfold_predict = test_kfold(save_ft_model_names, save_catmodel_names)\n#kfold_predict","8f4155a4":"model = MobileNet_model_no_internet_ver()\nearly_stopping = EarlyStopping(patience=1, monitor=\"root_mean_squared_error\", restore_best_weights=True)\n#set generator\ntrain_gen = MY_GENERATOR(train_table[\"Id\"].values, train_table[\"Pawpularity\"].values, batch_size=32, augmentation=True)\nhist = model.fit(train_gen, epochs=30, callbacks=[early_stopping])\n\n#plot_history\nplt.plot(hist.history[\"root_mean_squared_error\"], label=\"root_mean_squared_error\")\nplt.legend()\nplt.show()","4de87b45":"### catboost alldata training\nft_model = Model(model.input, model.get_layer([l.name for l in model.layers][-2]).output)\nfeature_pred = ft_model.predict(img_yield(train_table[\"Id\"].values))\nX_train = np.hstack([feature_pred, train_table.drop([\"Id\",\"Pawpularity\"],axis=1).values])\ny_train = train_table[\"Pawpularity\"].values\ncb_model = catboost_model()\ncb_model.fit(X_train, y_train)","42fe16cd":"### test data predict!\ndef test_input_image(pathes):\n    imgs = np.array([np.array(load_img(x, target_size=(224,224))) for x in tqdm(pathes)])\n    imgs = np.array([keras.applications.mobilenet_v2.preprocess_input(x) for x in imgs])\n    return imgs\n\nimgs = test_input_image(test_table[\"Id\"])\ntest_feature_pred = ft_model.predict(imgs)\nX_test = np.hstack([test_feature_pred, test_table.drop(\"Id\",axis=1).values])\npred = cb_model.predict(X_test)\npred","d013fc35":"test_table = pd.read_csv(\"\/kaggle\/input\/petfinder-pawpularity-score\/test.csv\")\nsub = pd.DataFrame()\nsub['Id'] = test_table['Id']\nsub['Pawpularity'] = pred","e83f7a75":"sub.to_csv(\"submission.csv\", index = False)\nsub","0f042064":"# 3.Generator Class\n### using ImageDataGenerator","13413796":"# 2.Datasets","097be3f7":"# All training","95a55a80":"# Thank you read this notebook to the end!","8387518c":"# 5.Training_load_model_K-Fold_ver","2f640f9e":"# 1. Import Library","0c8931f6":"# 4. Model(movilenetV2)","ba5544fa":"# I tried to implement it with MobileNet, which no one seems to do.\n### I'll include an explanatory notebook when I get better results.","17c19c35":"### test Generator"}}