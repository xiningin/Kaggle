{"cell_type":{"233871cf":"code","59012bc5":"code","b470e45b":"code","e3763a65":"code","fcce0309":"code","67f84468":"markdown"},"source":{"233871cf":"import tensorflow as tf\n\ntry:\n    tpu = tf.distribute.cluster_resolver.TPUClusterResolver()\n    print('Running on TPU ', tpu.master())\nexcept ValueError:\n    tpu = None\n\nif tpu:\n    tf.config.experimental_connect_to_cluster(tpu)\n    tf.tpu.experimental.initialize_tpu_system(tpu)\n    strategy = tf.distribute.experimental.TPUStrategy(tpu)\nelse:\n    strategy = tf.distribute.get_strategy()\n\nprint(\"REPLICAS:\", strategy.num_replicas_in_sync)\nprint(\"Job name:\", tpu.get_job_name())\nprint(\"Master:\", tpu.get_master())\nprint(\"Number of accelerators:\", tpu.num_accelerators())","59012bc5":"!pip install tensorflow_datasets","b470e45b":"import tensorflow_datasets as tfds\n\ndef get_dataset(batch_size=200):\n  datasets, info = tfds.load(name='mnist', with_info=True, as_supervised=True,\n                             try_gcs=True)\n  mnist_train, mnist_test = datasets['train'], datasets['test']\n\n  def scale(image, label):\n    image = tf.cast(image, tf.float32) # TPU supports only tf.float32, tf.int32, tf.bfloat16, and tf.bool, uint8 is NOT supported\n    image \/= 255.0\n\n    return image, label\n\n  train_dataset = mnist_train.map(scale).shuffle(10000).batch(batch_size)\n  test_dataset = mnist_test.map(scale).batch(batch_size)\n\n  return train_dataset, test_dataset","e3763a65":"def create_model():\n  return tf.keras.Sequential(\n      [tf.keras.layers.Conv2D(32, 3, activation='relu', input_shape=(28, 28, 1)),\n       tf.keras.layers.Flatten(),\n       tf.keras.layers.Dense(128, activation='relu'),\n       tf.keras.layers.Dense(10)])","fcce0309":"with strategy.scope():\n  model = create_model()\n  model.compile(optimizer='adam',\n                loss=tf.keras.losses.SparseCategoricalCrossentropy(from_logits=True),\n                metrics=['sparse_categorical_accuracy'])\n  \ntrain_dataset, test_dataset = get_dataset()\n\nmodel.fit(train_dataset,\n          epochs=5,\n          validation_data=test_dataset)","67f84468":"This is a sample comes directly from \"Using TPU\" guide: https:\/\/www.tensorflow.org\/guide\/tpu"}}