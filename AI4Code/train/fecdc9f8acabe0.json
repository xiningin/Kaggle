{"cell_type":{"78651777":"code","4aaf75eb":"code","76a20a1c":"code","723e72f8":"code","1b4c2bc4":"code","6c7c243e":"code","9a284530":"code","0ff5517e":"code","9e8ca220":"code","440746cf":"code","959f9056":"code","e7589581":"code","4764253a":"code","e23d7bc2":"code","9fbb6163":"code","8982b9b9":"code","26cb1a59":"code","509ba2eb":"code","9670962f":"code","e7b375fb":"code","33b01582":"code","c5537e35":"code","636c7189":"code","58de3f1b":"code","fd1e5cce":"code","c6d9382f":"code","1803344f":"code","55976ebc":"code","e7f3feec":"code","b6a7a2bb":"markdown","c30cf7d3":"markdown","ec0319f7":"markdown","b8acc52d":"markdown","2f7f0e75":"markdown","dfa995e6":"markdown","cd0d5643":"markdown","4a36b56a":"markdown","41719032":"markdown","759c47e7":"markdown","19dc7b67":"markdown","38d5e891":"markdown","72d1d6b6":"markdown","c86a4147":"markdown","9d8f9a6e":"markdown","f406c573":"markdown","ad3fadf9":"markdown","19507e51":"markdown","ba0cdc0d":"markdown","06b29bcc":"markdown","b77f1a4b":"markdown","02b829a2":"markdown","1ab49671":"markdown","a75723f8":"markdown"},"source":{"78651777":"import pandas as pd\nimport numpy as np\nimport seaborn as sns\nimport matplotlib.pyplot as plt\nimport warnings\nwarnings.filterwarnings(\"ignore\")\nimport os\nprint(os.listdir(\"..\/input\"))\n","4aaf75eb":"file_1994_2003=pd.read_csv('..\/input\/US_births_1994-2003_CDC_NCHS.csv')\nfile_2000_2014=pd.read_csv('..\/input\/US_births_2000-2014_SSA.csv')\nfile1=file_1994_2003.copy()\nfile2=file_2000_2014.copy()\n\nfile1=file1[file1[\"year\"]<2000]\nfile2=file2[file2[\"year\"]>=2000]\nfile=pd.concat([file1, file2], axis=0)","76a20a1c":"file.head(9)","723e72f8":"plt.figure(figsize=(15,4))\nsns.set_style(\"darkgrid\", {\"axes.facecolor\": \"0.9\", 'grid.color': '.6', 'grid.linestyle': '-.'})\ndist1=file.groupby(\"day_of_week\")[\"births\"].mean()\ndist1.plot(kind='bar', rot=0)\nplt.xlabel(\"day_of_week\", fontsize=14, color=\"r\")\nplt.ylabel(\"births\", fontsize=14, color=\"r\")\nplt.xticks(fontsize=12); plt.yticks(fontsize=12)\nplt.title(\"Weekdays' distribution\", fontsize=16, color=\"r\")\nplt.show()","1b4c2bc4":"file.describe()","6c7c243e":"file.info()","9a284530":"plt.figure(figsize=(15,4))\nyear_sum=file.groupby(\"year\")[['births']].sum()\nplt.plot(year_sum, linewidth=3, color=\"r\")\nplt.xlabel(\"Year\", fontsize=12, color=\"r\")\nplt.ylabel(\"Births\", fontsize=12, color=\"r\")\nplt.xticks(range(1994,2015,1), fontsize=12); plt.yticks(fontsize=12)\nplt.title(\"Birth rate 1994-2014\", fontsize=16, color=\"r\")\nplt.show()","0ff5517e":"plt.figure(figsize=(15,4))\nyear_min=file.groupby(\"year\")[['births']].min(); year_max=file.groupby(\"year\")[['births']].max(); year_mean=file.groupby(\"year\")[['births']].mean()\nx=year_mean.index\nplt.plot(year_max, linewidth=3, label=\"Maximum\", color=\"b\")\nplt.plot(year_mean, linewidth=3, label=\"Average\", color=\"g\")\nplt.plot(year_min, linewidth=3, label=\"Minimum\", color=\"r\")\nplt.fill_between(x,year_min[\"births\"], year_max[\"births\"], alpha=0.3, facecolor='yellow')\nplt.xticks(range(1994,2015,1), fontsize=12); plt.yticks(fontsize=12)\nplt.xlabel(\"# of births\", fontsize=12, color=\"r\"); plt.ylabel(\"Years\", fontsize=12, color=\"r\")\nplt.title(\"Range of the birth rate\", fontsize=16, color=\"r\")\nplt.legend(loc='best')\nplt.draw()","9e8ca220":"file['date'] = file[\"year\"].map(str)+ \"-\" + file[\"month\"].map(str)+ \"-\" + file[\"date_of_month\"].map(str)\nfile.head()","440746cf":"ts=file.copy()\nts=pd.DataFrame(ts, columns=['date', 'births'])\nts.tail()","959f9056":"ts['Date']=pd.to_datetime(ts['date'])\nts=ts.set_index(['Date'])\nts.drop(\"date\", axis=1, inplace=True)\nts.head()","e7589581":"sns.set_style(\"whitegrid\")\nmycolors = ['red', 'cyan', 'green', 'orange', 'brown', \\\n            'grey', 'pink', 'olive', 'deeppink', 'steelblue', \\\n            'firebrick', 'mediumseagreen', 'darkred', 'blue', 'MediumVioletRed',\\\n            'darkorange', 'brown', 'purple', 'gold', 'yellow', 'maroon']\nplt.figure(figsize=(20,14))\nfor i, c in enumerate(range(1994,2015)):\n    file_c=file[file[\"year\"]==c]\n    file_c_grouped=file_c.groupby(\"month\")[['births']].mean()\n    x=file_c_grouped.index.tolist()\n    y=file_cy=file_c_grouped['births']\n    plt.plot(x,y, linewidth=2, label=c, color=mycolors[i])\n    plt.text(file.loc[file.year==c, :].shape[0]\/30, file_c_grouped[file_c_grouped.index==12]['births'].mean(), c, fontsize=12, color=mycolors[i])\n    plt.yticks(fontsize=14, color=\"k\")\n    plt.xticks(fontsize=14, color=\"k\")\n    plt.xlabel(\"Months\",fontsize=12, color=\"r\")\n    plt.ylabel(\"Number of births\", fontsize=12, color=\"r\")\n    plt.annotate(\"\", xy=(7, 12800), xytext=(3.7,11800), arrowprops=dict(ec=\"k\", fc=\"k\", lw=4))\n    plt.annotate(\"\", xy=(12,12000), xytext=(9.5, 12800), arrowprops=dict(ec=\"k\", fc=\"k\",  lw=4))\nplt.xticks(fontsize=12); plt.yticks(fontsize=12)\nplt.title(\"Trends of the average birth rates\", fontsize=16, color=\"r\")\nplt.draw()","4764253a":"plt.figure(figsize=(15,4))\nplt.plot(ts, label=\"daily\", color=\"steelblue\")\nplt.plot(ts.resample(\"w\").mean(), label=\"weekly\", color=\"darkred\")\nplt.xticks(fontsize=12); plt.yticks(fontsize=12)\nplt.title(\"Daily vs Weekly\", fontsize=16, color=\"r\")\nplt.xlabel(\"Years\", fontsize=12, color=\"r\"); plt.ylabel(\"Births\", fontsize=12, color=\"r\")\nplt.legend(loc=\"best\", fontsize = 'x-large')\nplt.draw()","e23d7bc2":"plt.figure(figsize=(15,4))\nplt.plot(ts, label=\"daily\", color=\"steelblue\")\nplt.plot(ts.resample(\"M\").mean(), label=\"monthly\", color=\"darkred\")\nplt.xticks(fontsize=12); plt.yticks(fontsize=12)\nplt.title(\"Daily vs Monthly\", fontsize=16, color=\"r\")\nplt.xlabel(\"Years\", fontsize=12, color=\"r\"); plt.ylabel(\"Births\", fontsize=12, color=\"r\")\nplt.legend(loc=\"best\", fontsize = 'x-large')\nplt.draw()","9fbb6163":"month_mean=ts.resample(\"M\").mean()\nplt.figure(figsize=(15,4))\nplt.plot(month_mean, label=\"monthly\", color=\"darkred\")\nplt.xticks(fontsize=12); plt.yticks(fontsize=12)\nplt.title(\"Monthly rates\", fontsize=16, color=\"r\")\nplt.xlabel(\"Years\", fontsize=12, color=\"r\"); plt.ylabel(\"Births\", fontsize=12, color=\"r\")\nplt.legend(loc=\"best\", fontsize = 'x-large')\nplt.draw()","8982b9b9":"print(\"The shape of the original data: \",ts.shape)\nprint(\"The shape of the sampled data: \", month_mean.shape)","26cb1a59":"train=month_mean[:200]\ntest=month_mean[200:]\nprint(\"The shape of training set: \", train.shape)\nprint(\"The shape of testing set: \", test.shape)","509ba2eb":"print(\"The splitting timestamp is after \", train.index[-1])\n","9670962f":"plt.figure(figsize=(15,4))\nplt.plot(train, label=\"train\", color=\"darkred\")\nplt.plot(test, label=\"test\", color=\"darkblue\")\nplt.xticks(fontsize=12); plt.yticks(fontsize=12)\nplt.title(\"Train vs Test\", fontsize=16, color=\"r\")\nplt.xlabel(\"Years\", fontsize=12, color=\"r\"); plt.ylabel(\"Births\", fontsize=12, color=\"r\")\nplt.legend(loc=\"best\", fontsize = 'x-large')\nplt.axvline(pd.to_datetime('2010-09-15'), color='r', linestyle='-', linewidth=2)\nplt.draw()","e7b375fb":"from sklearn.preprocessing import MinMaxScaler\nsc = MinMaxScaler(feature_range = (0, 1))\ntrain_scaled = sc.fit_transform(train)","33b01582":"X_train = []\ny_train = []\nfor i in range(60, 200):\n    X_train.append(train_scaled[i-60:i, 0])\n    y_train.append(train_scaled[i, 0])\nX_train, y_train = np.array(X_train), np.array(y_train)\n\nX_train = np.reshape(X_train, (X_train.shape[0], X_train.shape[1], 1))","c5537e35":"from keras.models import Sequential\nfrom keras.layers import Dense\nfrom keras.layers import LSTM\nfrom keras.layers import Dropout\nregressor = Sequential()\n\nregressor.add(LSTM(units = 50, return_sequences = True, input_shape = (X_train.shape[1], 1)))\nregressor.add(Dropout(rate=0.2))\n\nregressor.add(LSTM(units = 50, return_sequences = True))\nregressor.add(Dropout(rate=0.2))\n\nregressor.add(LSTM(units = 50, return_sequences = True))\nregressor.add(Dropout(rate=0.2))\n\nregressor.add(LSTM(units = 50))\nregressor.add(Dropout(rate=0.2))\n\nregressor.add(Dense(units = 1))\n\nregressor.compile(optimizer = 'adam', loss = 'mean_squared_error')\nnp.random.seed(0)\nregressor.fit(X_train, y_train, epochs = 100, batch_size = 10, verbose=0)","636c7189":"dataset_total = pd.concat((train['births'], test['births']), axis = 0)\ninputs = dataset_total[len(dataset_total) - len(test) - 60:].values\ninputs = inputs.reshape(-1,1)\ninputs = sc.transform(inputs)\nX_test = []\nfor i in range(60, 112):\n    X_test.append(inputs[i-60:i, 0])\nX_test = np.array(X_test)\nX_test = np.reshape(X_test, (X_test.shape[0], X_test.shape[1], 1))\nprediction = regressor.predict(X_test)\nprediction = sc.inverse_transform(prediction)\nprediction = pd.DataFrame(prediction, index=test.index)","58de3f1b":"prediction.head()","fd1e5cce":"plt.figure(figsize=(15,4))\nplt.plot(month_mean[:200], color = 'darkred', label = 'train')\nplt.plot(month_mean[200:], color = 'darkblue', label = 'test')\nplt.plot(prediction, color = 'darkgreen', label = 'Prediction')\nplt.xticks(fontsize=12); plt.yticks(fontsize=12)\nplt.title(\"LSTM PREDICTION\", fontsize=16, color=\"r\")\nplt.xlabel(\"Years\", fontsize=12, color=\"r\"); plt.ylabel(\"# Birth\", fontsize=12, color=\"r\")\nplt.legend()\nplt.show()","c6d9382f":"plt.figure(figsize=(15,4))\nplt.plot(month_mean[200:], color = 'darkblue', label = 'test')\nplt.plot(prediction, color = 'darkgreen', label = 'Prediction')\nplt.title('LSTM PREDICTION: zoomed-in', fontsize=16, color=\"r\")\nplt.xticks(fontsize=12); plt.yticks(fontsize=12)\nplt.xlabel(\"Years\", fontsize=12, color=\"r\"); plt.ylabel(\"# Birth\", fontsize=12, color=\"r\")\nplt.xlim('20100730', '20151231')\nplt.legend(loc=\"best\", fontsize=14)\nplt.show()","1803344f":"from sklearn.metrics import mean_squared_error, mean_absolute_error\n\nprint(\"RMSE is \", np.round(np.sqrt(mean_squared_error(test, prediction))))\nprint(\"MAE is \", np.round(mean_absolute_error(test, prediction)))\nprint(\"loss is \", np.round(regressor.evaluate(X_train ,y_train ,batch_size =10),4))","55976ebc":"def moving_test_window_preds(n_feature_preds):\n    preds_moving=[]\n    moving_test_window=[X_test[0,:].tolist()]\n    moving_test_window=np.array(moving_test_window)\n   \n    for i in range(n_feature_preds):\n        preds_one_step=regressor.predict(moving_test_window)\n        preds_moving.append(preds_one_step[0,0])\n        preds_one_step=preds_one_step.reshape(1,1,1)\n        moving_test_window=np.concatenate((moving_test_window[:,1:,:],preds_one_step), axis= 1)\n    preds_moving=np.array(preds_moving)\n    preds_moving.reshape(1,-1)\n    preds_moving=sc.inverse_transform(preds_moving.reshape(-1,1))\n    return preds_moving","e7f3feec":"plt.figure(figsize=(16,5))\noriginal=ts.resample(\"M\").mean()\nplt.plot(original, color = 'darkred', label = 'original')\nfuture=pd.DataFrame(moving_test_window_preds(36), index=pd.date_range(start=\"20150101\", end=\"20171231\", freq=\"M\"))\nplt.plot(future, color=\"r\", linestyle=\"-.\")\nplt.title('LSTM PREDICTION: future values', fontsize=16, color=\"r\")\nplt.xticks(fontsize=12); plt.yticks(fontsize=12)\nplt.xlabel(\"Years\", fontsize=12, color=\"r\"); plt.ylabel(\"# Birth\", fontsize=12, color=\"r\")\nplt.draw()","b6a7a2bb":"We will train our model on the first 200 points and test if for the rest 52.","c30cf7d3":"## Loading data\n\nWe will combine two datasets to have wider range of dates.","ec0319f7":"From above we can notice that there are no outliers, and all the numbers are integers.\n\nBelow we can see the total number of births in US from 1994 to 2014, inclusive.","b8acc52d":"One can notice that the number of births on weekends is less than that on weekdays.\n\nThe main statistics is as follows:","2f7f0e75":"To evaluate the performance, let's look at Root Mean Square Error (RMSE), Mean Absolute Error (MAE), and evaluate the loss.","dfa995e6":"This kernel is prepared to analyze birth rates in US for 1994-2014 and make predictions based on the given data. It consists of the following parts:<font color='blue'>\n\n\n    \n* Introduction\n\n* Loading Data\n\n* Data exploration\n\n* Feature engineering\n\n* Model (LSTM)\n\n* Prediction\n\n* Summary\n<\/font>\n\n\n","cd0d5643":"The top rows of the combined data is as follows:","4a36b56a":"In our case we will be using 60 as time step i.e. we will look into 2 months of data to predict next months' rates.","41719032":"<img src=\"http:\/\/imgnews.naver.com\/image\/5239\/2014\/10\/10\/192108_image_1_99_20141010162402.jpg\">","759c47e7":"## Introduction\n\nLong Short-Term Memory (LSTM) models are a type of recurrent neural network capable of learning sequences of observations.\nToday we will consider US birth rates from the beginning of 1994 to the end of 2014. We will develope a model with LSTM to forecast birth rates in US for next years.\n\nTwo datasets have been combined to have wider range of dates. The data consists od the following columns:\nyear (1994-2014), month (1-12), date_of_month (1-31), day_of_week (1-7), and births (# of births).\nAfter analyzing data we will create new column which will help us work with time series. Later we will develop a model (LSTM-Long Short Term Memory) to make predictions based on the given data.","19dc7b67":"The top rows of the prediction for the testing time period is as follows:","38d5e891":"In order to work with time series, we should have datetime for the index. So let's consider the number of births along with the time, and later put timeseries as indices of the data.","72d1d6b6":"## Model (LSTM)\n\nNow it's the time to split our data into training and testing sets. We will train the model on the training set and leter check the performance on the test set.\n\nBefore doing that let's plot the time series. After that we can see that we should resample because there are too many points on daily bases. ","c86a4147":"Below we can see the time series plot split into two parts(Training set and Testing set).","9d8f9a6e":"The data for our sequence prediction problem needs to be scaled. We can normalize our dataset using the scikit-learn object MinMaxScaler.","f406c573":"Next we can see the range of the births within each year through the mentioned period.","ad3fadf9":"And here is the combined plot of the testing set, training set and predictions for the testing period.","19507e51":"Not bad!\n\nThe predicted values are quite close to the values in test dataset. Let's zoom-in the right side of the graph to have closer look.","ba0cdc0d":"## Summary\n\nIn this kernel we analyzed the data, having data visualization and feature engineering. As well as we developed LSTM model to predict future values of the birth is US.\n\nNice to see that the prediction rate has an increasing trend for future dates.\n\nHope you enjoyed the process. As always, your comments are appreciated.\n\nI hope you liked this kernel and you will <font color=\"red\">upvote :) <\/font>\n\nThanks!!!","06b29bcc":"## Feature engineering\n\nHere we'll start adding a column combining day, month, year for indexing the time series. ","b77f1a4b":"## Data exploration","02b829a2":"## Prediction\n\nBeing satisfied with the results, let's predict future values. To do so, we will use last 60 records to predict next one, and the newly predicted value will be included in the next timestamp, and so on. One of the drawbacks here is that if we want to predict for a longer period then more predicted values are considered for the new predictions. This will affect the accuracy of the prediction.\n\nLet's predict the US birth rates for the next 36-month period.","1ab49671":"An interesting trend can be seen in the next graph, where the average number of births increases from April to August-September. Then it sharply drops till the end of each year. Also there is slightly but consistant increase in the first month of each year.","a75723f8":"For developing a model, let's consider distribution as of the end date of each month."}}