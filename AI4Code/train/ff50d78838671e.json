{"cell_type":{"d9b65f5c":"code","9c0b6c48":"code","56bf1118":"code","d1907ee4":"code","6ffbeb1f":"code","acc938fe":"code","a9477dd7":"code","099f0cbd":"code","7149449f":"code","9f311090":"code","8af4a984":"code","0604f948":"code","22778789":"code","96b8ce46":"code","1095001e":"code","7a2af88a":"code","702693f8":"code","2e4a405d":"code","f22604bd":"code","8ed37dcb":"code","c72c9956":"code","837759bb":"code","efe11caf":"code","36824fd0":"code","5c00ad3d":"code","995f376b":"code","2c335e58":"code","f252c414":"code","ebf67765":"code","9ee0e0f4":"code","029c6424":"code","54a3c585":"code","eaadf266":"code","7c2e062c":"code","769bdbde":"code","9f6564c6":"code","006b0044":"code","5f4d46e1":"code","b51416df":"code","43fbc165":"code","830d4182":"code","7c234a05":"code","11ea04e1":"code","69382457":"code","c2d3830a":"code","7d527259":"code","b4ba5581":"code","3ed257ad":"code","9be4c9a6":"code","6dadee49":"code","d65cb5dc":"code","aa199958":"code","7bbe2e97":"code","aeb134d0":"code","f48625c3":"code","937dcae2":"code","f057162a":"code","ba1c6f4e":"code","65181e59":"code","4fe01971":"code","5ef27ed2":"code","69e7fbb5":"code","da104bda":"code","3b9bcba0":"code","bac2d164":"code","b0b8f59f":"code","ad7f122a":"code","05dc4d21":"code","53d586fa":"markdown","b33b52bd":"markdown","23fe862b":"markdown","291ef39e":"markdown"},"source":{"d9b65f5c":"dataDir = '\/kaggle\/input\/datathon-belcorp-prueba\/'","9c0b6c48":"import numpy as np\nimport math\nimport pandas as pd","56bf1118":"df_prod = pd.read_csv(dataDir + 'maestro_producto.csv')","d1907ee4":"df_consultora = pd.read_csv(dataDir +  'maestro_consultora.csv')","6ffbeb1f":"df_camp_consultora = pd.read_csv(dataDir +  'campana_consultora.csv')","acc938fe":"df_ventas = pd.read_csv(dataDir + 'dtt_fvta_cl.csv')","a9477dd7":"df_consultora.drop('Unnamed: 0',axis=1,inplace=True)\ndf_camp_consultora.drop('Unnamed: 0',axis=1,inplace=True)\ndf_prod.drop('Unnamed: 0',axis=1,inplace=True)","099f0cbd":"df_historico_camp = df_camp_consultora[['campana','IdConsultora','Flagpasopedido']]","7149449f":"pivot_historico = pd.pivot_table(df_historico_camp, values='Flagpasopedido', index='campana',columns=['IdConsultora'])","9f311090":"dictConsultCamp = pivot_historico.to_dict()","8af4a984":"def getTarget(idConsultora,campana):\n\n  if (campana == 201906):\n    return np.nan\n  \n  year = str(campana)[:-2]\n  cap = str(campana)[-2:]\n\n  if (cap=='18'):\n    nextCampaign = int(str(int(year)+1) + '01')\n  else:\n    nextCampaign = campana +1\n\n  ## If the following campaign exists\n  if not math.isnan(dictConsultCamp[idConsultora][nextCampaign]):\n    return dictConsultCamp[idConsultora][nextCampaign]\n  else:\n    return np.nan","0604f948":"df_camp_consultora['target'] = df_camp_consultora['IdConsultora'].astype(object).combine(df_camp_consultora['campana'],func=getTarget)","22778789":"## Mergeo la info de la consultora\ndf_info_consult = df_camp_consultora.merge(df_consultora,how='left',on='IdConsultora')","96b8ce46":"## Mergeo la info relacionado a ventas\ndf_info_vt = df_ventas.merge(df_prod,how='left',on='idproducto')","1095001e":"df_info_vt['campanaConsultora'] = df_info_vt['campana'].astype(str) + '_' + df_info_vt['idconsultora'].astype(str)","7a2af88a":"df_info_vt_summary = df_info_vt.groupby('campanaConsultora').agg({\n                                             'codigotipooferta': lambda x: x.mode().iat[0],\n                                             'descuento': 'sum',\n                                             'ahorro': 'sum',\n                                             'preciocatalogo': 'sum',\n                                             'realanulmnneto': 'sum',\n                                             'realdevmnneto': 'sum',\n                                             'realuuanuladas': 'sum',\n                                             'realuudevueltas': 'sum',\n                                             'realuufaltantes': 'sum',\n                                             'realuuvendidas': 'sum',\n                                             'realvtamnfaltneto': 'sum',\n                                             'realvtamnneto': 'sum',\n                                             'realvtamncatalogo': 'sum',\n                                             'realvtamnfaltcatalogo': 'sum'\n                                             })","702693f8":"df_info_vt_summary.reset_index(inplace=True)","2e4a405d":"df_info_consult['campanaConsultora']= df_info_consult['campana'].astype(str)  + '_' + df_info_consult['IdConsultora'].astype(str)","f22604bd":"df_info_vt_summary.head(1)","8ed37dcb":"## Mergeo todo\ndf_total = df_info_consult.merge(df_info_vt_summary,on='campanaConsultora',how='left')","c72c9956":"# missingData = df_total.isnull().sum()\n# percentageMissing = missingData \/ df_total.shape[0]","837759bb":"# percentageMissing.to_frame().reset_index().to_csv('percentageMissing.csv')","efe11caf":"# percentageMissing = pd.read_csv('percentageMissing.csv')","36824fd0":"# percentageMissing.drop(columns='Unnamed: 0',axis=1,inplace=True)\n# percentageMissing.rename(columns={'0':'porc'},inplace=True)","5c00ad3d":"## To drop (high missing values)\ndroppable = ['codigocanalorigen','flagcorreovalidad','codigofactura']","995f376b":"# percentageMissing.sort_values(by='porc',ascending=False)[:25]","2c335e58":"df_total[df_total['campana']==201906]['IdConsultora'].unique().shape","f252c414":"df_total.drop(labels=droppable,axis=1,inplace=True)","ebf67765":"# df_total = df_total[~df_total['IdConsultora'].isnull()]","9ee0e0f4":"cat_vars = [c for c in df_total if not pd.api.types.is_numeric_dtype(df_total[c])]","029c6424":"cat_vars","54a3c585":"# 1. Convertir las columnas a tipo \"category\", ignorar la variable dependiente\n# cat_vars = [c for c in df_total if not pd.api.types.is_numeric_dtype(df_total[c])]\n\ncat_vars = ['evaluacion_nuevas',\n 'segmentacion',\n 'geografia',\n 'estadocivil']\n\nfor n,col in df_total.items():\n    if n in cat_vars:\n      df_total[n] = df_total[n].astype('category')\n\n# df_total.dtypes","eaadf266":"for n,col in df_total.items():\n    if pd.api.types.is_categorical_dtype(col):\n        df_total[n] = col.cat.codes+1\n\ndf_total.head(3)","7c2e062c":"imputation_columns = [\n                      'codigotipooferta',\n                      'campanaultimopedido',\n                      'flagsupervisor',\n                      'campanaingreso',\n'preciocatalogo',\n'realvtamnfaltcatalogo',\n'flagdigital',\n'ahorro',\n'realdevmnneto',\n'cantidadlogueos',\n'descuento',\n'realanulmnneto',\n'estadocivil',\n'realuuanuladas',\n'campanaprimerpedido',\n'realuudevueltas',\n'flagcelularvalidado',\n'realuufaltantes',\n'edad',\n'realuuvendidas',\n'flagconsultoradigital',\n'realvtamnfaltneto',\n'realvtamnneto',\n'realvtamncatalogo']\nfor n,col in df_total.items():\n    if n in imputation_columns:\n      df_total[n].fillna((df_total[n].median()), inplace=True)","769bdbde":"percentageMissing = df_total.isnull().mean()","9f6564c6":"# percentageMissing.sort_values(ascending=False)","006b0044":"df_predict = pd.read_csv(dataDir + 'predict_submission.csv')","5f4d46e1":"df_total[df_total['target'].isnull()]['IdConsultora'].value_counts().sort_values(ascending=False)","b51416df":"df_predict['idconsultora'].unique().shape","43fbc165":"df_total['campanaprimerpedido']","830d4182":"df_total.head(1)","7c234a05":"## Hacef funcion para restar mejor\ndf_total['campanaprimerpedido'] = df_total['campana'] - df_total['campanaprimerpedido']\ndf_total['campanaingreso'] = df_total['campana'] - df_total['campanaingreso']\ndf_total['campanaultimopedido'] = df_total['campana'] - df_total['campanaultimopedido']\n","11ea04e1":"df_to_predict = df_total[df_total['target'].isnull()]","69382457":"df_to_predict.shape","c2d3830a":"df_to_predict = df_to_predict.sort_values('campana', ascending=False).drop_duplicates('IdConsultora').sort_index()","7d527259":"df_predict.rename(columns={'idconsultora':'IdConsultora'},inplace=True)","b4ba5581":"df_entry_model = df_predict.merge(df_to_predict,how='left',on='IdConsultora')","3ed257ad":"df_entry_model","9be4c9a6":"df = df_total[~df_total['target'].isnull()]","6dadee49":"dropToTrain = ['campana','IdConsultora','campanaConsultora','Flagpasopedido']","d65cb5dc":"df.drop(columns=dropToTrain,inplace=True)","aa199958":"Y = df['target']\nX = df.drop('target',axis=1)","7bbe2e97":"from sklearn.model_selection import train_test_split\nX_train, X_test, y_train, y_test = train_test_split(X, Y, test_size=0.33, random_state=42)","aeb134d0":"import lightgbm as lgb\ntrain_data = lgb.Dataset(X_train, label=y_train)\ntest_data = lgb.Dataset(X_test, label=y_test)","f48625c3":"parameters = {\n    'application': 'binary',\n    'objective': 'binary',\n    'metric': 'auc',\n    'is_unbalance': 'true',\n    'boosting': 'gbdt',\n    'num_leaves': 31,\n    'feature_fraction': 0.5,\n    'bagging_fraction': 0.5,\n    'bagging_freq': 20,\n    'learning_rate': 0.05,\n    'verbose': 0\n}\n\nmodel = lgb.train(parameters,\n                       train_data,\n                       valid_sets=test_data,\n                       num_boost_round=5000,\n                       early_stopping_rounds=100)","937dcae2":"X = df.drop('target',axis=1)","f057162a":"ids = df_entry_model['IdConsultora'].values","ba1c6f4e":"dropToTrain = ['campana','campanaConsultora','Flagpasopedido']","65181e59":"df_entry_model.drop(columns=dropToTrain,inplace=True)","4fe01971":"df_entry_model.drop('IdConsultora', inplace=True, axis=1)","5ef27ed2":"df_entry_model.drop('flagpasopedido',inplace=True,axis=1)","69e7fbb5":"df_entry_model.drop('target',inplace=True,axis=1)","da104bda":"x = df_entry_model","3b9bcba0":"df_entry_model.columns","bac2d164":"X.columns","b0b8f59f":"y = model.predict(x)","ad7f122a":"y","05dc4d21":"output = pd.DataFrame({'idconsultora': ids, 'flagpasopedido': y})\noutput.to_csv(\"submission.csv\", index=False)","53d586fa":"### Predicting","b33b52bd":"### Construyendo el target","23fe862b":"## Limpiando data","291ef39e":"## Mergeando la data"}}