{"cell_type":{"0e9eb44c":"code","6203e748":"code","e1622e97":"code","70798303":"code","34c741e2":"code","acc9bed6":"code","b0a25267":"code","c6c80847":"code","43ea1186":"code","77f2d202":"code","c5fedaa3":"code","43fba44f":"code","ac150424":"markdown","1e3a02ab":"markdown","b471c17a":"markdown"},"source":{"0e9eb44c":"!git clone https:\/\/github.com\/ceshine\/global-wheat-detection\n%cd global-wheat-detection","6203e748":"!pip install omegaconf pytorch_lightning_spells\n!pip install https:\/\/github.com\/rwightman\/efficientdet-pytorch\/archive\/master.zip","e1622e97":"import cv2\nimport torch\nimport numpy as np\nimport pandas as pd\nimport matplotlib.pyplot as plt\nfrom torch.utils.data import DataLoader\nfrom wheat.dataset import WheatDataset, get_train_transforms\nfrom wheat.model import get_train_efficientdet","70798303":"BASE_DIR = \"\/kaggle\/input\/wheat-dataset-resized-to-512x512\/512\/\"","34c741e2":"df = pd.read_csv(BASE_DIR + \"train.csv\")\nbboxes = np.stack(df[\"bbox\"].apply(lambda x: np.fromstring(x[1:-1], sep=\",\")))\nfor i, col in enumerate([\"x\", \"y\", \"w\", \"h\"]):\n    df[col] = bboxes[:, i]\ndf[\"x2\"] = df[\"x\"] + df[\"w\"]\ndf[\"y2\"] = df[\"y\"] + df[\"h\"]","acc9bed6":"dataset = WheatDataset(\n    df=df, image_dir=BASE_DIR + \"train\/\", \n    transforms=get_train_transforms(image_size=512, cutout=True)\n)","b0a25267":"def sample_aug(idx, dataset):\n    _, ax = plt.subplots(4, 2, figsize=(14, 28))\n    for row in range(4):\n        for col in range(2):\n            img, target = dataset[idx]\n            img = img.transpose(1,2,0).copy()\n            for i in range(len(target[\"bbox\"])):\n                box = target[\"bbox\"][i, (1, 0, 3, 2)].round().astype(int) \n                _ = cv2.rectangle(\n                    img,\n                    (box[0], box[1]),\n                    (box[2], box[3]),\n                    (220, 0, 0), 2)\n            ax[row][col].axis('off')\n            ax[row][col].imshow(img)","c6c80847":"sample_aug(0, dataset)","43ea1186":"sample_aug(5, dataset)","77f2d202":"dataset = WheatDataset(\n    df=df, image_dir=BASE_DIR + \"train\/\",\n    transforms=get_train_transforms(image_size=512, cutout=False),\n    mosaic_p=1.0\n)","c5fedaa3":"sample_aug(0, dataset)","43fba44f":"sample_aug(5, dataset)","ac150424":"### Mosaic\nReferences:\n1. [ultralytics\/yolov5](https:\/\/github.com\/ultralytics\/yolov5\/blob\/831773f5a23926658ee76459ce37550643432123\/utils\/datasets.py#L529)\n2. [shonenkov\/training-efficientdet](https:\/\/www.kaggle.com\/shonenkov\/training-efficientdet)","1e3a02ab":"* [Training Notebook](https:\/\/www.kaggle.com\/ceshine\/wheat-detection-training-efficientdet-public)\n* [Inference Notebook](https:\/\/www.kaggle.com\/ceshine\/effdet-wheat-head-detection-inference-public)","b471c17a":"## Regular Augmentations"}}